<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Flash2Advance USB problems with Linux 2.6 - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>Flash Equipment > Flash2Advance USB problems with Linux 2.6</h2>
<div id="posts">
<div class="post">
    <h4>#20597 - Ingy - Thu May 13, 2004 4:04 pm</h4>
    <div class="postbody"><span class="postbody">I have a Flash2Advance USB link cable and I'm having a lot of trouble getting it to work with Linux 2.6. With kernel 2.4 I used software called if2a (<a class="postlink" href="http://deyv.free.fr/gba/f2a/" target="_blank">http://deyv.free.fr/gba/f2a/</a>) which worked by using the ezusb2131 drivers(<a class="postlink" href="http://ezusb2131.sourceforge.net/" target="_blank">http://ezusb2131.sourceforge.net/</a>).
<br/>
<br/>
However, the ezusb2131 drivers won't compile properly under kernel 2.6 and the guy who wrote them believes that they are now unnecessary - their functionality is apparently replaced by fxload, which I've been playing about with a bit.
<br/>
<br/>
This is the result of trying to load the f2afirm.hex file on to the chip directly:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">ashgrove:/home/ingy/gba/if2a-0.3a# fxload -D /proc/bus/usb/003/019 -I f2afirm.hex -vv
<br/>
microcontroller type: fx
<br/>
single stage:  load on-chip memory
<br/>
open RAM hexfile image f2afirm.hex
<br/>
stop CPU
<br/>
write on-chip, addr 0x0000 len 1008 (0x03f0)
<br/>
write on-chip, addr 0x03f0 len 1008 (0x03f0)
<br/>
write on-chip, addr 0x07e0 len 1008 (0x03f0)
<br/>
write on-chip, addr 0x0bd0 len 1008 (0x03f0)
<br/>
write on-chip, addr 0x0fc0 len 1008 (0x03f0)
<br/>
write on-chip, addr 0x13b0 len 1008 (0x03f0)
<br/>
can't write 1008 bytes external memory at 0x17a0
<br/>
unable to download f2afirm.hex</td> </tr></table><span class="postbody">
<br/>
<br/>
So I try again, using the firmware provided with fxload as a second-stage loader, which apparently allows me to write to external RAM or EEPROM:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">ashgrove:/home/ingy/gba/if2a-0.3a# fxload -D /proc/bus/usb/003/019 -s /usr/share/usb/a3load.hex -I f2afirm.hex -vv
<br/>
microcontroller type: fx
<br/>
1st stage:  load 2nd stage loader
<br/>
open RAM hexfile image /usr/share/usb/a3load.hex
<br/>
stop CPU
<br/>
write on-chip, addr 0x0357 len   23 (0x0017)
<br/>
write on-chip, addr 0x01b5 len  297 (0x0129)
<br/>
write on-chip, addr 0x0080 len  309 (0x0135)
<br/>
write on-chip, addr 0x02de len   71 (0x0047)
<br/>
write on-chip, addr 0x0003 len    3 (0x0003)
<br/>
write on-chip, addr 0x0325 len   50 (0x0032)
<br/>
write on-chip, addr 0x0043 len    3 (0x0003)
<br/>
write on-chip, addr 0x0400 len    4 (0x0004)
<br/>
write on-chip, addr 0x0000 len    3 (0x0003)
<br/>
EOF on hexfile
<br/>
write on-chip, addr 0x036e len   12 (0x000c)
<br/>
... WROTE: 775 bytes, 10 segments, avg 77
<br/>
reset CPU
<br/>
open RAM hexfile image f2afirm.hex
<br/>
2nd stage:  write external memory
<br/>
SKIP on-chip RAM, 1008 bytes at 0x0000
<br/>
SKIP on-chip RAM, 1008 bytes at 0x03f0
<br/>
SKIP on-chip RAM, 1008 bytes at 0x07e0
<br/>
SKIP on-chip RAM, 1008 bytes at 0x0bd0
<br/>
SKIP on-chip RAM, 1008 bytes at 0x0fc0
<br/>
SKIP on-chip RAM, 1008 bytes at 0x13b0
<br/>
write external, addr 0x17a0 len 1008 (0x03f0)
<br/>
write external, addr 0x1b90 len 1008 (0x03f0)
<br/>
EOF on hexfile
<br/>
write external, addr 0x1f80 len  128 (0x0080)
<br/>
stop CPU
<br/>
2nd stage:  write on-chip memory
<br/>
write on-chip, addr 0x0000 len 1008 (0x03f0)
<br/>
write on-chip, addr 0x03f0 len 1008 (0x03f0)
<br/>
write on-chip, addr 0x07e0 len 1008 (0x03f0)
<br/>
write on-chip, addr 0x0bd0 len 1008 (0x03f0)
<br/>
write on-chip, addr 0x0fc0 len 1008 (0x03f0)
<br/>
write on-chip, addr 0x13b0 len 1008 (0x03f0)
<br/>
SKIP external RAM, 1008 bytes at 0x17a0
<br/>
SKIP external RAM, 1008 bytes at 0x1b90
<br/>
EOF on hexfile
<br/>
SKIP external RAM, 128 bytes at 0x1f80
<br/>
... WROTE: 8192 bytes, 9 segments, avg 910
<br/>
reset CPU</td> </tr></table><span class="postbody">
<br/>
<br/>
And that seems to work fine. However, the device soon disappears from /proc/bus/usb/003/, and dmesg gives me this output:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">usb 3-1: USB disconnect, address 19
<br/>
usb 3-1: new full speed USB device using address 20
<br/>
usb 3-1: control timeout on ep0in
<br/>
usb 3-1: device not accepting address 20, error -110
<br/>
usb 3-1: new full speed USB device using address 21
<br/>
usb 3-1: control timeout on ep0in
<br/>
usb 3-1: device not accepting address 21, error -110
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
And I can't access the device again without disconnecting and reconnecting it, presumably wiping the firmware. Now I'm not sure whether those "control timeout on ep0in" messages are down to a problem with the 2.6 usb subsystem, or (more likely, perhaps) because I'm largely unsure as to what I should be doing. Does anyone have experience of this / any ideas as to what I should try next?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#20714 - spooo - Sat May 15, 2004 4:44 pm</h4>
    <div class="postbody"><span class="postbody">Hi,
<br/>
<br/>
I got if2a work with fxload.
<br/>
<br/>
First edit f2afirm.hex, and remove all lines containing "AAAA...".
<br/>
The first one starts with ":10120000AA".
<br/>
The last one starts with ":101FF000AA".
<br/>
Next, plug the f2alinker, and use fxload to upload the cable firmware :
<br/>
<br/>
For instance :
<br/>
lsusb
<br/>
dev=`lsusb|grep -i ezusb|awk '{print "/proc/bus/usb/" $2 "/" $4;}' | cut -d: -f1`                                                                                                    
<br/>
/sbin/fxload -D "$dev" -I f2afirm.hex -vv -t an21
<br/>
<br/>
Now you can see with lsusb that the cable ID has changed from 0547:2131 to 0547:1002.
<br/>
<br/>
For if2a to work, you have to slightly patch it.
<br/>
Modify usb.c line 24, change "firmware_loaded=0" to "firmware_loaded=1".
<br/>
Recompile with "make if2a", then it should work as before (kernel module ezusb2131 is not needed anymore).
<br/>
<br/>
The same change may be applied to original f2a (http://www.emulinks.de/f2a/).
<br/>
<br/>
I'll release an updated version of if2a very soon.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#20720 - twink - Sat May 15, 2004 11:33 pm</h4>
    <div class="postbody"><span class="postbody">thanks for this great post =D, was just trying to figure out how to do this yesterday.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#20722 - Ingy - Sun May 16, 2004 12:42 am</h4>
    <div class="postbody"><span class="postbody">After a quick test with if2a -M and writing a test file to the cartridge, I can conclude that everything is working perfectly again.
<br/>
<br/>
spooo, my hat is off. Thank you!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#21002 - Gnurou - Fri May 21, 2004 2:18 pm</h4>
    <div class="postbody"><span class="postbody">Hi,
<br/>
<br/>
I've just got my f2a USB linker and am trying to use it with Linux 2.6 using these instructions - unfortunately I'm not as lucky as you guys!
<br/>
<br/>
I've modified the firmware and usb.c as described. I'm successful uploading the firmware too. However, once I try flashing nothing happens and all is get is a serie of messages like:
<br/>
<br/>
usb_bulk_write: error writing to bulk endpoint 4: Connection timed out
<br/>
<br/>
Any suggestion/advices? The cardridge is a FlashAdvancePro.
<br/>
<br/>
Thanks in advance.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#21021 - Gnurou - Fri May 21, 2004 6:29 pm</h4>
    <div class="postbody"><span class="postbody">Ok, it was, guess what, just me being plain stupid.
<br/>
<br/>
I didn't know the GBA should be turned OFF when running the program, then turned on when instructed. It was my first try at GBA flashing. So shame on me! ^_^
<br/>
<br/>
I had an extra step to do however. When uploading the modified firmware, hotplug gives the device to the "usbtest" (?) driver. I have to remove it before running if2a, otherwise it claims that the device is busy. I'm on Mandrake 10 here.
<br/>
<br/>
One weird thing still. Betweek every flash, I have to unplug the f2a linker, re-plug it, and reload the firmware. Trying two flashes without unplugging the f2a results in the second run staying still, without any message at all.
<br/>
<br/>
Anyway - my apologies for the useless post. Spoo, thanks for your great work on if2a, with it I can flash my devs from the comfort of my favorite OS!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#21576 - em4853 - Tue Jun 01, 2004 3:39 am</h4>
    <div class="postbody"><span class="postbody">I tried as advised but when i try to run:
<br/>
<br/>
/sbin/lsusb
<br/>
dev=`/sbin/lsusb|grep -i ezusb|awk '{print "/proc/bus/usb/" $2 "/" $4;}' | cut -d: -f1`
<br/>
/sbin/fxload -D "$dev" -I f2afirm.hex -vv -t an21
<br/>
<br/>
i get the error:
<br/>
<br/>
Unknown line at line 58
<br/>
Unknown line at line 2296
<br/>
Unknown line at line 2297
<br/>
Unknown line at line 2298
<br/>
....
<br/>
Unknown line at line 2333
<br/>
Unknown line at line 2334
<br/>
Unknown line at line 2335
<br/>
<br/>
(there are quite a few of those)
<br/>
<br/>
Please tell me any advice you can give!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#29309 - startail - Wed Nov 17, 2004 1:56 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
Problem Solved...
<br/>
usbtest                16524  0 &lt;- Caused the Driver to be locked to the USBTest Modules
<br/>
<br/>
Still have to re-plug, reload firmwire, unload usbtest to be able to flash everything one more time.
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I'm running Fedora 3 with a kompiled kernel of my own of 2.6.9. 
<br/>
It could be so that I'm missing a module or something. Maybe someone can help me out here.
<br/>
<br/>
I did just as show abow and loaded everything. But when running 
<br/>
./if2a -M this is what I see...
<br/>
<br/>
"Please turn OFF then ON your GBA with SELECT and START held down."
<br/>
<br/>
then I just get a prompt again without it connecting to the GBA.
<br/>
<br/>
<br/>
<br/>
Here's a debug log with -vv
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
info: 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
<br/>
post-boot: 0804B970 00B97573 00C03FF4 00B3E57F 00000002 0804B970 00000042 0804B970 00000042 BFFFF820 00B3E75C 00C04460 0804B970 00000042 BFFFF830 00C044A7
<br/>
info: 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
<br/>
Firmware uploaded.
<br/>
Trying address 0x8040000...
<br/>
Trying address 0x8088000...
<br/>
Trying address 0x80d0000...
<br/>
Trying address 0x8118000...
<br/>
Trying address 0x8160000...
<br/>
Trying address 0x81b0000...
<br/>
Trying address 0x81f8000...
<br/>
Trying address 0x8240000...
<br/>
Trying address 0x8288000...
<br/>
Trying address 0x82d0000...
<br/>
Trying address 0x8318000...
<br/>
Trying address 0x8360000...
<br/>
Trying address 0x83b0000...
<br/>
Trying address 0x83f8000...
<br/>
Trying address 0x8440000...
<br/>
Trying address 0x8488000...
<br/>
Trying address 0x84d0000...
<br/>
Trying address 0x8518000...
<br/>
Trying address 0x8560000...
<br/>
Trying address 0x85b0000...
<br/>
Trying address 0x85f8000...
<br/>
Trying address 0x8640000...
<br/>
Trying address 0x8688000...
<br/>
Trying address 0x86d0000...
<br/>
Trying address 0x8718000...
<br/>
Trying address 0x8760000...
<br/>
Trying address 0x87b0000...
<br/>
Trying address 0x87f8000...
<br/>
Trying address 0x8840000...
<br/>
Trying address 0x8888000...
<br/>
Trying address 0x88d0000...
<br/>
Trying address 0x8918000...
<br/>
Trying address 0x8960000...
<br/>
Trying address 0x89b0000...
<br/>
Trying address 0x89f8000...
<br/>
Trying address 0x8a40000...
<br/>
Trying address 0x8a88000...
<br/>
Trying address 0x8ad0000...
<br/>
Trying address 0x8b18000...
<br/>
Trying address 0x8b60000...
<br/>
Trying address 0x8bb0000...
<br/>
Trying address 0x8bf8000...
<br/>
Trying address 0x8c40000...
<br/>
Trying address 0x8c88000...
<br/>
Trying address 0x8cd0000...
<br/>
Trying address 0x8d18000...
<br/>
Trying address 0x8d60000...
<br/>
Trying address 0x8db0000...
<br/>
Trying address 0x8df8000...
<br/>
Trying address 0x8e40000...
<br/>
Trying address 0x8e88000...
<br/>
Trying address 0x8ed0000...
<br/>
Trying address 0x8f18000...
<br/>
Trying address 0x8f60000...
<br/>
Trying address 0x8fb0000...
<br/>
Trying address 0x8ff8000...
<br/>
Trying address 0x9040000...
<br/>
Trying address 0x9088000...
<br/>
Trying address 0x90d0000...
<br/>
Trying address 0x9118000...
<br/>
Trying address 0x9160000...
<br/>
Trying address 0x91b0000...
<br/>
Trying address 0x91f8000...
<br/>
Trying address 0x9240000...
<br/>
Trying address 0x9288000...
<br/>
Trying address 0x92d0000...
<br/>
Trying address 0x9318000...
<br/>
Trying address 0x9360000...
<br/>
Trying address 0x93b0000...
<br/>
Trying address 0x93f8000...
<br/>
Trying address 0x9440000...
<br/>
Trying address 0x9488000...
<br/>
Trying address 0x94d0000...
<br/>
Trying address 0x9518000...
<br/>
Trying address 0x9560000...
<br/>
Trying address 0x95b0000...
<br/>
Trying address 0x95f8000...
<br/>
Trying address 0x9640000...
<br/>
Trying address 0x9688000...
<br/>
Trying address 0x96d0000...
<br/>
Trying address 0x9718000...
<br/>
Trying address 0x9760000...
<br/>
Trying address 0x97b0000...
<br/>
Trying address 0x97f8000...
<br/>
Trying address 0x9840000...
<br/>
Trying address 0x9888000...
<br/>
Trying address 0x98d0000...
<br/>
Trying address 0x9918000...
<br/>
Trying address 0x9960000...
<br/>
Trying address 0x99b0000...
<br/>
Trying address 0x99f8000...
<br/>
Trying address 0x9a40000...
<br/>
Trying address 0x9a88000...
<br/>
Trying address 0x9ad0000...
<br/>
Trying address 0x9b18000...
<br/>
Trying address 0x9b60000...
<br/>
Trying address 0x9bb0000...
<br/>
Trying address 0x9bf8000...
<br/>
Trying address 0x9c40000...
<br/>
Trying address 0x9c88000...
<br/>
Trying address 0x9cd0000...
<br/>
Trying address 0x9d18000...
<br/>
Trying address 0x9d60000...
<br/>
Trying address 0x9db0000...
<br/>
Trying address 0x9df8000...
<br/>
Trying address 0x9e40000...
<br/>
Trying address 0x9e88000...
<br/>
Trying address 0x9ed0000...
<br/>
Trying address 0x9f18000...
<br/>
Trying address 0x9f60000...
<br/>
Trying address 0x9fb0000...
<br/>
Trying address 0x9ff8000...
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Loaded modules are:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
usbtest                16524  0
<br/>
shfs                   48016  3
<br/>
nls_utf8                2176  1
<br/>
vmnet                  27184  0
<br/>
vmmon                  43736  0
<br/>
md5                     4224  1
<br/>
ipv6                  230784  12
<br/>
autofs4                17412  0
<br/>
i2c_dev                 9344  0
<br/>
i2c_core               22416  1 i2c_dev
<br/>
rfcomm                 33948  0
<br/>
l2cap                  22020  5 rfcomm
<br/>
ipt_REJECT              7040  1
<br/>
ipt_state               1920  1
<br/>
ip_conntrack           43412  1 ipt_state
<br/>
iptable_filter          2944  1
<br/>
ip_tables              16640  3 ipt_REJECT,ipt_state,iptable_filter
<br/>
button                  6672  0
<br/>
battery                 8964  0
<br/>
hci_usb                12416  2
<br/>
bluetooth              43268  7 rfcomm,l2cap,hci_usb
<br/>
ac                      4868  0
<br/>
uhci_hcd               29328  0
<br/>
hw_random               5396  0
<br/>
nvidia               3466780  12
<br/>
snd_intel8x0           31016  0
<br/>
snd_ac97_codec         63568  1 snd_intel8x0
<br/>
snd_pcm_oss            49832  0
<br/>
snd_mixer_oss          17920  1 snd_pcm_oss
<br/>
snd_pcm                86664  2 snd_intel8x0,snd_pcm_oss
<br/>
snd_timer              22916  1 snd_pcm
<br/>
snd_page_alloc          9608  2 snd_intel8x0,snd_pcm
<br/>
snd_mpu401_uart         6912  1 snd_intel8x0
<br/>
snd_rawmidi            22820  1 snd_mpu401_uart
<br/>
snd_seq_device          7816  1 snd_rawmidi
<br/>
snd                    51044  9 snd_intel8x0,snd_ac97_codec,snd_pcm_oss,snd_mixer_oss,snd_pcm,snd_timer,snd_mpu401_uart,snd_rawmidi,snd_seq_device
<br/>
soundcore               9056  1 snd
<br/>
8139too                23424  0
<br/>
mii                     4992  1 8139too
<br/>
floppy                 57168  0
<br/>
reiserfs              243796  4
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
messages says:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
Nov 17 13:50:30 tailz kernel: usb 2-2.1: usbfs: process 4291 (if2a) did not claim interface 0 before use
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#29315 - Vince - Wed Nov 17, 2004 7:16 pm</h4>
    <div class="postbody"><span class="postbody">Hello,
<br/>
<br/>
I have had a report on french forums about the same problem as yours on a 2.6.8.1 Mdk kernel. It is interesting you post here because I had been starting to think it was a MDK-related problem.
<br/>
<br/>
Concerning the french person having the problem, we are heading to a HW-related issue (sometimes it works after reboot, most of the time it does not)
<br/>
<br/>
In your special case, first try to remove the usbtest module (where does the quote at the beginning of your post come from ?) and let me know if that improves the situation. I suspect it to stick to your F2A instead of the if2a program since it is a module that is used with EZ-USB devices (as is F2A) to test various aspects of USB on Linux.
<br/>
<br/>
There is also a bug in if2a where we should loop and wait for the F2A reply. Instead, we just test the reply once (around lines 838 or so of if2a.c, see commented source line). The problem is that when the F2A does not reply anything (as this is the case here, see info: field of debug logs), execution continues whereas we should wait for a real reply.
<br/>
<br/>
Cheers,
<br/>
<br/>
Vince</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#29345 - Ingy - Thu Nov 18, 2004 12:13 pm</h4>
    <div class="postbody"><span class="postbody">For the record, I'm getting the same thing with Ubuntu, kernel 2.6.8.1. That is, if2a failing and these kind of messages:
<br/>
<br/>
usbfs: process 4291 (if2a) did not claim interface 0 before use</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#29350 - Vince - Thu Nov 18, 2004 7:03 pm</h4>
    <div class="postbody"><span class="postbody">Howdy,
<br/>
<br/>
The "usbfs: process 4291 (if2a) did not claim interface 0 before use" used to happen on 2.4 kernels as well and is not harmful, unless initialization of USB devices has changed with 2.6 kernels (which I doubt).
<br/>
<br/>
As I said, look for and remove usbtest from your list of modules, this may help solving the problem.
<br/>
<br/>
Vince</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
