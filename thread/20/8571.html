<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>SCSD Fat driver - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>DS Misc > SCSD Fat driver</h2>
<div id="posts">
<div class="post">
    <h4>#71709 - linus - Tue Feb 14, 2006 2:08 am</h4>
    <div class="postbody"><span class="postbody">Who is working on the SCSD fat driver, is it chishm or did cory1492 help out converting it to C. Does anyone know why its not working, when i tried it i couldnt get it to detect my SD card. I had a look at the code and it looked like it was doing the equivilent as before. What are the problems with it?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#71745 - chishm - Tue Feb 14, 2006 5:51 am</h4>
    <div class="postbody"><span class="postbody">The one included in the official FAT lib is what I converted from the ASM code. I haven't got a SC, so I haven't been able to find out why it doesn't work. Play with it all you want, and if you get it working, I wanna here about it :)<br/>_________________<br/><a class="postlink" href="http://chishm.drunkencoders.com" target="_blank">http://chishm.drunkencoders.com</a>
<br/>
<a class="postlink" href="http://dldi.drunkencoders.com" target="_blank">http://dldi.drunkencoders.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#71802 - linus - Tue Feb 14, 2006 5:05 pm</h4>
    <div class="postbody"><span class="postbody">hi ho hi ho its off to work i go...
<br/>
<br/>
well im no expert but i dont even think its the asm functions you replaced. its not detecting my card (and the SCSD_Unlock, SCSD_IsInserted functions were in C).
<br/>
<br/>
Ive replaced those functions with the older ones and instead of disc_Init returning false it just doesnt return, but this is probably down to my crappy glueing in of the old code.
<br/>
<br/>
as i said im no expert im just trying to help out because you dont have a SC, but i was wondering surely 
<br/>
<br/>
old code in SCSD_IsInserted:
<br/>
<br/>
return ((0x9800000 &amp; 0x0300) == 0);
<br/>
<br/>
new code:
<br/>
<br/>
return (0x9800000 &amp; 0x300);
<br/>
<br/>
do the opposite of each other. (ive replaced the defined names to their actual numbers)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#71818 - kevinc - Tue Feb 14, 2006 6:07 pm</h4>
    <div class="postbody"><span class="postbody">Weird, last week I did a quick experiment with my SCSD and cory1492's drivers and did manage to get a directory listing.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#71833 - linus - Tue Feb 14, 2006 7:40 pm</h4>
    <div class="postbody"><span class="postbody">ohhhh really, where is cory's work these days?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#71889 - chishm - Wed Feb 15, 2006 4:04 am</h4>
    <div class="postbody"><span class="postbody">heh, I completely missed that error. That's just what happens when you don't have a device to test on.<br/>_________________<br/><a class="postlink" href="http://chishm.drunkencoders.com" target="_blank">http://chishm.drunkencoders.com</a>
<br/>
<a class="postlink" href="http://dldi.drunkencoders.com" target="_blank">http://dldi.drunkencoders.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#72332 - linus - Fri Feb 17, 2006 7:25 pm</h4>
    <div class="postbody"><span class="postbody">I was wrong when is said this :
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
old code in SCSD_IsInserted:
<br/>
<br/>
return ((0x9800000 &amp; 0x0300) == 0);
<br/>
<br/>
new code:
<br/>
<br/>
return (0x9800000 &amp; 0x300);</td> </tr></table><span class="postbody">
<br/>
<br/>
actually the new code was 
<br/>
<br/>
return (0x9800000 == 0x300);
<br/>
<br/>
but anyway when i replace the old with the new it just doesnt return from disc_Init i havent been able to devote much time to this, but im still looking through every now and again.
<br/>
<br/>
Wheres corys code kev?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#72333 - kevinc - Fri Feb 17, 2006 7:38 pm</h4>
    <div class="postbody"><span class="postbody"><a href="http://www.scdev.org/forum/viewtopic.php?t=1449&amp;postdays=0&amp;postorder=asc&amp;start=0" target="_blank">http://www.scdev.org/forum/viewtopic.php?t=1449&amp;postdays=0&amp;postorder=asc&amp;start=0</a>
<br/>
<br/>
That's what I used; I thought you'd find it given you posted in that thread :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#72334 - linus - Fri Feb 17, 2006 7:43 pm</h4>
    <div class="postbody"><span class="postbody">ah that code... i was just hoping you had something newer than that :) because im pretty sure dma didnt work with it yet, or there was some problem.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#72451 - cory1492 - Sat Feb 18, 2006 5:39 pm</h4>
    <div class="postbody"><span class="postbody">#define sd_comadd (*(vu16*)(0x09800000))
<br/>
if sd_comadd == 0x300 return 1
<br/>
<br/>
looks fine to me with my limited asm knowledge, I dont think card inserted is where the problem is... but here is some info that I just worked out anyway (and changed a bunch of times if you are reading this thread at the moment):
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#define SD_COMS (*(vu16*)(0x09800000))
<br/>
<br/>
    _Unlock(); //does the unlock
<br/>
<br/>
    u32 comstat = SD_COMS;</td> </tr></table><span class="postbody">
<br/>
SD_COMS always returns 0xFCFF or 0b1111110011111111 (whether I specify u16 or u32 for the variable)
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#define SD_COMS (*(vu32*)(0x09800000))
<br/>
<br/>
    _Unlock(); //does the unlock
<br/>
<br/>
    u32 comstat = SD_COMS;</td> </tr></table><span class="postbody">
<br/>
returns 0b11111100111111111111110011111111 (0xFCFFFCFF)
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">    .TEXT
<br/>
.equ sd_comadd,0x9800000
<br/>
    .ALIGN
<br/>
    .GLOBAL com_test
<br/>
    .CODE 32
<br/>
com_test:
<br/>
   ldr   r1,=sd_comadd
<br/>
   ldrh   r0,[r1]
<br/>
   bx   r14
<br/>
    .END</td> </tr></table><span class="postbody">
<br/>
always returns 0xFCFF  (havent figured out where/how that 0x300 comes into play in asm though, which is a big part of my confusion with producing a converted driver - why it is opposite to what this asm tells me:) </span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">   tst   r1,#0x300
<br/>
   moveq   r0,#1
<br/>
   movne   r0,#0</td> </tr></table><span class="postbody">- and for me at least,
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">comstat &amp; 0x300</td> </tr></table><span class="postbody"> always comes up as 0  (0xfcff &amp; 0x300) seems to come up as zero when I printf it.
<br/>
<br/>
0000001100000000 anded with
<br/>
1111110011111111
<br/>
should be
<br/>
0000000000000000
<br/>
<br/>
hence return (0x9800000 == 0xFCFF) should be sufficient
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#define SD_STS_INSERTED      0xFCFF</td> </tr></table><span class="postbody">
<br/>
seems to work great for the startup (it calls and returns fine from inside disk_Init)
<br/>
<br/>
- with this change it is failing at the first read sector (never returns, Im assuming becaus of the &amp; 0x100 being the same problem as above)
<br/>
<br/>
also changing
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#define SD_STS_BUSY         0xFEFF
<br/>
...
<br/>
   while (SD_DATARADD_16 == SD_STS_BUSY);
<br/>
</td> </tr></table><span class="postbody">
<br/>
moves things a little farther, but freezes at the for loop just after the while in ReadSector, and then for some odd reason everything goes haywire (printfs start going in wrong places, it boots out back to disk_init all over again ~ buffer overflow or something?)
<br/>
<br/>
Far as I can tell it is the 32bit reads that are causing the problem, for an unsigned number it seems to always return 32 1's and then restarts the program for some odd reason.
<br/>
<br/>
Trying to reverse this asm is like playing in a sandbox where I dont get anything, not even sand...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#72510 - chishm - Sun Feb 19, 2006 10:13 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>cory1492 wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#define SD_COMS (*(vu16*)(0x09800000))
<br/>
<br/>
    _Unlock(); //does the unlock
<br/>
<br/>
    u32 comstat = SD_COMS;</td> </tr></table><span class="postbody">
<br/>
SD_COMS always returns 0xFCFF or 0b1111110011111111 (whether I specify u16 or u32 for the variable)</span></td> </tr></table><span class="postbody">
<br/>
This is because it will always read 16 bits from 0x09800000 (the vu16* bit). If this gets assigned to an unsigned 32 int, the top 16 bits will be filled with 0.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>cory1492 wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#define SD_COMS (*(vu32*)(0x09800000))
<br/>
<br/>
    _Unlock(); //does the unlock
<br/>
<br/>
    u32 comstat = SD_COMS;</td> </tr></table><span class="postbody">
<br/>
returns 0b11111100111111111111110011111111 (0xFCFFFCFF)
<br/>
</span></td> </tr></table><span class="postbody">
<br/>
This is because you are reading 32 bits from 0x09800000. This behaviour is harder to understand if you aren't familiar with the hardware. Since the GBA cart uses a 16 bit data bus, 32 bit words are transfered in two 16 bit halfwords, starting with the lower halfword. However, the SD register is addressed using only the top address lines. This means the register is viewable at 0x09800000 - 0x09800100 or so (I don't know the exact range, without having an SC SD). So getting back to the 32 bit read, this means both the top and bottom half words are filled with the contents of the register.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>cory1492 wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
hence return (0x9800000 == 0xFCFF) should be sufficient
<br/>
</td> </tr></table><span class="postbody">
<br/>
The register may not have all the other bits set all the time. Therefore it is better to use a bitwise AND rather than a logical equals. ie </span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">return !(*(vu16*)0x09800000 &amp; 0x300);</td> </tr></table><span class="postbody">
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>cory1492 wrote:</b></span></td> </tr> <tr> <td class="quote">[...] freezes at the for loop just after the while in ReadSector, and then for some odd reason everything goes haywire (printfs start going in wrong places, it boots out back to disk_init all over again ~ buffer overflow or something?)</td> </tr></table><span class="postbody">
<br/>
This is quite possibly a stack overflow problem.<br/>_________________<br/><a class="postlink" href="http://chishm.drunkencoders.com" target="_blank">http://chishm.drunkencoders.com</a>
<br/>
<a class="postlink" href="http://dldi.drunkencoders.com" target="_blank">http://dldi.drunkencoders.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#73005 - cory1492 - Wed Feb 22, 2006 9:28 pm</h4>
    <div class="postbody"><span class="postbody">Thanks again chishm, I didnt realize that the same register would repeat itself for a range of addresses. You helped fill a couple small holes in my &amp; logic understanding and gave me a couple new ideas to try and comprehend how the SD comms are mapped to the GBA port. Looks like Im gonna have to have another fit of hopefully productive tests soon.
<br/>
<br/>
Any thoughts on the hangup though? Im not sure why reading a 32bit value off the bus would crash it, I mean, it should be able to do it (even if the data is incorrect) without that kind of problem.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#73152 - tepples - Thu Feb 23, 2006 5:49 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>cory1492 wrote:</b></span></td> </tr> <tr> <td class="quote">Any thoughts on the hangup though? Im not sure why reading a 32bit value off the bus would crash it</td> </tr></table><span class="postbody">
<br/>
Reading 32 bits is the same as two rapid 16-bit reads. Perhaps the hardware can't handle two reads unless they're spaced at least <span style="font-style: italic">x</span> microseconds apart.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
