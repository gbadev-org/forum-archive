<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Mario Kart DS WiFi Connection reverse engeneering? - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>DS Misc > Mario Kart DS WiFi Connection reverse engeneering?</h2>
<div id="posts">
<div class="post">
    <h4>#62237 - sleeper - Mon Nov 28, 2005 4:52 pm</h4>
    <div class="postbody"><span class="postbody">So was anyone crazy enough to look at the communication flow between nintendo and mario kart and started to build a fake server? ;)
<br/>
<br/>
Just curious. (this is not a "you guys should definetly do this and that thread")</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#62274 - zonk - Mon Nov 28, 2005 10:41 pm</h4>
    <div class="postbody"><span class="postbody">I snooped some traffic and it doesn't look complicated.. well.. if i had more time..
<br/>
<br/>
What i got so far:
<br/>
<br/>
#1 It connects via TCP to 'conntest.nintendowifi.net' and does a 'GET / HTTP/1.0'
<br/>
<br/>
#2 resolves mariokartds.available.gs.nintendowifi.net:
<br/>
 UDP to port 27900 : &lt;0x0900000000&gt;mariokart ds&lt;0x00&gt;
<br/>
 Reply:         &lt;0xfefd09000000&gt;
<br/>
<br/>
#3 resolves nas.nintendowifi.net and talks https.(!!!)
<br/>
 Tracing the request is no problem with squid..
<br/>
 ..but IF mariokart verifies the SERVER-SSL-Cert, d'oh.. it will be
<br/>
 almost impossible to get a fake-server working :-/
<br/>
<br/>
#4 gpcm.gs.nintendowifi.net
<br/>
 -&gt; ??
<br/>
<br/>
#5 mariokartds.master.gs.nintendowifi.net
<br/>
<br/>
=&gt; SENDS
<br/>
0000   00 11 24 6e ad 46 00 09 bf 0a 7a 39 08 00 45 00  ..$n.F....z9..E.
<br/>
0010   00 e7 00 24 00 00 80 11 9d 76 c0 a8 01 7b cf 26  ...$.....v...{.&amp;
<br/>
0020   0b 22 c5 ff 6c fc 00 d3 ee b9 03 c4 f4 16 91 6c  ."..l..........l
<br/>
0030   6f 63 61 6c 69 70 30 00 31 39 32 2e 31 36 38 2e  ocalip0.192.168.
<br/>
0040   31 2e 31 32 33 00 6c 6f 63 61 6c 70 6f 72 74 00  1.123.localport.
<br/>
0050   35 30 36 38 37 00 6e 61 74 6e 65 67 00 31 00 73  50687.natneg.1.s
<br/>
0060   74 61 74 65 63 68 61 6e 67 65 64 00 31 00 67 61  tatechanged.1.ga
<br/>
0070   6d 65 6e 61 6d 65 00 6d 61 72 69 6f 6b 61 72 74  mename.mariokart
<br/>
0080   64 73 00 70 75 62 6c 69 63 69 70 00 30 00 70 75  ds.publicip.0.pu
<br/>
0090   62 6c 69 63 70 6f 72 74 00 30 00 6e 75 6d 70 6c  blicport.0.numpl
<br/>
00a0   61 79 65 72 73 00 30 00 6d 61 78 70 6c 61 79 65  ayers.0.maxplaye
<br/>
00b0   72 73 00 30 00 75 6e 6b 6e 6f 77 6e 00 36 30 30  rs.0.unknown.600
<br/>
00c0   37 32 37 36 33 00 75 6e 6b 6e 6f 77 6e 00 30 00  72763.unknown.0.
<br/>
00d0   75 6e 6b 6e 6f 77 6e 00 30 00 75 6e 6b 6e 6f 77  unknown.0.unknow
<br/>
00e0   6e 00 33 00 75 6e 6b 6e 6f 77 6e 00 31 00 00 00  n.3.unknown.1...
<br/>
00f0   00 00 00 00 00 9b e1 50 92                       .......P.
<br/>
<br/>
&lt;= RECV
<br/>
0000   00 09 bf 0a 7a 39 00 11 24 6e ad 46 08 00 45 00  ....z9..$n.F..E.
<br/>
0010   00 38 9b 1a 00 00 68 11 1b 2f cf 26 0b 22 c0 a8  .8....h../.&amp;."..
<br/>
0020   01 7b 6c fc c5 ff 00 24 49 ef fe fd 01 c4 f4 16  .{l....$I.......
<br/>
0030   91 65 74 37 36 47 21 30 30 33 45 43 41 30 30 31  .et76G!003ECA001
<br/>
0040   32 43 35 46 46 00                                2C5FF.
<br/>
<br/>
=&gt; SENDS
<br/>
0000   00 11 24 6e ad 46 00 09 bf 0a 7a 39 08 00 45 00  ..$n.F....z9..E.
<br/>
0010   00 3e 00 25 00 00 80 11 9e 1e c0 a8 01 7b cf 26  .&gt;.%.........{.&amp;
<br/>
0020   0b 22 c5 ff 6c fc 00 2a d5 93 01 c4 f4 16 91 48  ."..l..*.......H
<br/>
0030   45 4c 4c 42 49 77 43 5a 79 31 73 6d 38 30 62 53  ELLBIwCZy1sm80bS
<br/>
0040   53 63 66 64 63 74 56 6e 79 4d 41 00 f0 5a 93 46  ScfdctVnyMA..Z.F
<br/>
0050  
<br/>
<br/>
..and some more..
<br/>
<br/>
after mariokart found the players, connection goes directly between them, the Nintendo-Server isn't used anymore.. 
<br/>
<br/>
UDP is used as Protocoll
<br/>
<br/>
They look like this:
<br/>
0000   00 09 bf 0a 7a 39 00 11 24 6e ad 46 08 00 45 00  ....z9..$n.F..E.
<br/>
0010   00 58 3f bc 00 00 72 11 c7 55 52 e6 2c 7a c0 a8  .X?...r..UR.,z..
<br/>
0020   01 7b cd 90 c5 ff 00 44 1a b1 33 02 00 00 71 08  .{.....D..3...q.
<br/>
0030   00 38 00 00 68 00 be e4 a0 07 fa fb 89 15 38 e7  .8..h.........8.
<br/>
0040   3c ff 10 00 00 00 18 00 00 01 0a 00 00 00 00 00  &lt;...............
<br/>
0050   00 00 00 00 00 00 0f 0f 0f 0f 0f 0f 0f 0f 0f 0f  ................
<br/>
0060   0f 0f 0f 0f 0f 0f                                ......</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#62280 - knight0fdragon - Tue Nov 29, 2005 1:28 am</h4>
    <div class="postbody"><span class="postbody">interesting, the wifi allows direct connectingso perhaps servers arent needed, and some of system could be used to rid of the dreadful random battle</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#62282 - sleeper - Tue Nov 29, 2005 1:34 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>knight0fdragon wrote:</b></span></td> </tr> <tr> <td class="quote">interesting, the wifi allows direct connectingso perhaps servers arent needed, and some of system could be used to rid of the dreadful random battle</td> </tr></table><span class="postbody">
<br/>
<br/>
hmm so the https connection is only between the nintendo server and the ds? Maybe you just let the server assign the players for you and then let the proxy do the stuff where you connect to the players you want...
<br/>
<br/>
interesting...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#62724 - knight0fdragon - Mon Dec 05, 2005 1:12 am</h4>
    <div class="postbody"><span class="postbody">hmm its odd that the localIP being send is the one being used by what I am assuming is your DS, and not the net IP to allow direct connection,  well what did you use to see this, a standard packet sniffer?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#62725 - wintermute - Mon Dec 05, 2005 1:51 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>knight0fdragon wrote:</b></span></td> </tr> <tr> <td class="quote">hmm its odd that the localIP being send is the one being used by what I am assuming is your DS, and not the net IP to allow direct connection,  well what did you use to see this, a standard packet sniffer?</td> </tr></table><span class="postbody">
<br/>
<br/>
Never heard of NAT? :P</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#62726 - knight0fdragon - Mon Dec 05, 2005 2:02 am</h4>
    <div class="postbody"><span class="postbody">yes but even NAT itself has to have some kind of address sent to nintendo to tell the other DS's where its located at</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#62892 - zonk - Tue Dec 06, 2005 7:33 pm</h4>
    <div class="postbody"><span class="postbody">&gt; well what did you use to see this, a standard packet sniffer?
<br/>
<br/>
tcpdump on my linux-router
<br/>
<br/>
<br/>
Well.. sending the local (private) IP may may make sense for nintendo:
<br/>
<br/>
Nintendo can see my pulic ip anyway.. If the DS sends it's private IP, it may help nintendo to distinguish multiple DS's behind one public ip..
<br/>
<br/>
<br/>
I'll setup a fake-DNS and install a squid http(s) proxy to track the https communication in the next few days (..or weeks ;-) )</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#66637 - zigg - Thu Jan 12, 2006 4:14 pm</h4>
    <div class="postbody"><span class="postbody">Is there any evidence that the DS is using or trying to use UPnP to get ports forwarded to it from the router?  I've not been able to find anything explaining how two DS's behind NAT are able to send UDP directly to each other.
<br/>
<br/>
I may try to sniff it myself, but I'd have to sniff from a separate PC; I don't have a router I can sniff from. :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#66649 - derula - Thu Jan 12, 2006 6:11 pm</h4>
    <div class="postbody"><span class="postbody">The public key of the https certificate is 1120 bit of length, which means there will be not a slightest chance (except luck) of finding out the secret key. That is sad. Only to hope that MKDS doesn't validate the cert. Which I doubt.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#66720 - ProdigySim - Fri Jan 13, 2006 5:26 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>zigg wrote:</b></span></td> </tr> <tr> <td class="quote">Is there any evidence that the DS is using or trying to use UPnP to get ports forwarded to it from the router?  I've not been able to find anything explaining how two DS's behind NAT are able to send UDP directly to each other.</td> </tr></table><span class="postbody">Indeed, I too have wondered this.
<br/>
If we knew what port it ran this on, perhaps we could improve connectivity by opening it on our NAT/firewalls.
<br/>
<br/>
EDIT: Or I could read the post and realize that it uses 50687 (from what I can tell)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#66767 - zigg - Fri Jan 13, 2006 12:25 pm</h4>
    <div class="postbody"><span class="postbody">Well, I did kick my ralink card into Monitor mode on my Linux box, and got half of a session (a friend jumped on me in Animal Crossing shortly after my gate opened, heh.)  I say half because the ralink drivers under Linux seem to only monitor broadcast or AP-originating packets.
<br/>
<br/>
I saw a lot of similarities between zonk's stuff above, but most interestingly I noticed about eight SSDP (which I believe UPnP is based on) packets coming from the router just before the connection was opened up and I started getting UDP from my friend's IP address.  I would assume that those SSDP packets came in response to something my DS was doing that I couldn't see, but I could be wrong on that front; they were sent to multicast, which may justbe how UPnP operates, but I'm not really sure.  I need to do some reading.
<br/>
<br/>
The really bizarre part about it all is that Nintendo seems to never talk about UPnP in any of their support materials.  If two people without a working UPnP implementation are trying to get connected, surely Nintendo would have to pass packets for them?  I'm dismayed at the utter lack of information coming from Nintendo on NAT traversal, especially since it seems several people do have trouble with firewalls (the dreaded 80430 error.)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#66815 - M3d10n - Fri Jan 13, 2006 6:23 pm</h4>
    <div class="postbody"><span class="postbody">There is another way to get two computers behind NAT to talk directly to each other without UPnP, with the aid of a server outside a NAT, but I'm not sure if Nintendo does this (one could try disabling the UPnP settings in their router and see what happens - most routers come with that option on by default).
<br/>
<br/>
I've been working with the Torque game engine lately, and their master server implementation can do that. I don't know the specifics (I barely messed with the network components yet), but it's something like both clients connecting to the server, and the server doing some voodoo to "link" the two clients directly, so they can send data directly to each other, without any of it going through the server.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#66820 - zigg - Fri Jan 13, 2006 6:55 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>M3d10n wrote:</b></span></td> </tr> <tr> <td class="quote">I've been working with the Torque game engine lately, and their master server implementation can do that. I don't know the specifics (I barely messed with the network components yet), but it's something like both clients connecting to the server, and the server doing some voodoo to "link" the two clients directly, so they can send data directly to each other, without any of it going through the server.</td> </tr></table><span class="postbody">
<br/>
<br/>
Interesting.  Just before I started getting packets from my friend, I saw packets coming from two distinct hosts at GameSpy.  I assumed they were connection tests, but maybe this is being done here too.
<br/>
<br/>
In any event, I think I have a decent sniffer now, so I'll try again tonight and see if I can break this down.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#66828 - JaJa - Fri Jan 13, 2006 7:32 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>M3d10n wrote:</b></span></td> </tr> <tr> <td class="quote">There is another way to get two computers behind NAT to talk directly to each other without UPnP, with the aid of a server outside a NAT, but I'm not sure if Nintendo does this (one could try disabling the UPnP settings in their router and see what happens - most routers come with that option on by default).</td> </tr></table><span class="postbody">
<br/>
<br/>
I hate UPnP, so have it off and can play MKDS DS fine.
<br/>
I assume the Nintendo server is used for matchmaking and this inital port opening.
<br/>
Then the DS's talk directly to each other.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#66832 - zigg - Fri Jan 13, 2006 7:48 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>JaJa wrote:</b></span></td> </tr> <tr> <td class="quote">I assume the Nintendo server is used for matchmaking and this inital port opening.
<br/>
Then the DS's talk directly to each other.</td> </tr></table><span class="postbody">
<br/>
<br/>
Nintendo's server cannot open a port in someone's NAT router, though.  That's why UPnP is used for some gaming implementations; it can be used to request that port forwarding be set up on the NAT router to forward packets sent to a particular port on to the DS.
<br/>
<br/>
However, I think I may have located a paper on the technique that Torque may use.  <a class="postlink" href="http://www.brynosaurus.com/pub/net/p2pnat/" target="_blank">Peer-to-Peer Communication Across Network Address Translators</a> explains "hole punching".  I'm reading it and it makes sense to me.  The success rates aren't very encouraging, but are probably Good Enough for WFC use.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
