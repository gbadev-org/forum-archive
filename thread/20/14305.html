<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>My background is moving. (Solved) - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>DS Misc > My background is moving. (Solved)</h2>
<div id="posts">
<div class="post">
    <h4>#142648 - HyperHacker - Thu Oct 11, 2007 5:22 am</h4>
    <div class="postbody"><span class="postbody">In HBlank, I do this to create an 8-scanline gradient behing BG0, by hiding BG3 and adjusting the background colour:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void HBlankInterrupt()
<br/>
{
<br/>
   s32 Line;
<br/>
   static bool BG3On = true;
<br/>
<br/>
   //Highlight selected menu option if enabled.
<br/>
   if(HighlightSelOption &amp;&amp; (HighlightLine &gt;= 0))
<br/>
   {
<br/>
      Line = REG_VCOUNT - (HighlightLine - 1);
<br/>
      if((!Line) &amp;&amp; BG3On)
<br/>
      {
<br/>
         videoSetMode(MODE_5_2D | DISPLAY_BG0_ACTIVE);
<br/>
         BG3On = false;
<br/>
      }
<br/>
<br/>
      if((Line &gt;= 0) &amp;&amp; (Line &lt; 8))
<br/>
         BG_PALETTE[0] = SelOptionBG[(Line + HighlightAnim) &amp; 7];
<br/>
      else if((Line &gt;= 8) &amp;&amp; !BG3On)
<br/>
      {
<br/>
         videoSetMode(MODE_5_2D | DISPLAY_BG0_ACTIVE | DISPLAY_BG3_ACTIVE);
<br/>
         BG3On = true;
<br/>
      }
<br/>
   }
<br/>
}</td> </tr></table><span class="postbody">BG0 has a text layer and BG3 has a 16-bit bitmap. When I do this, as I adjust HighlightLine to move the effect up and down the screen, the image on BG3 actually jumps up and down. It looks like instead of skipping 8 lines of BG3 when it's turned off, it actually moves the remaining portion down 8 lines. Is this normal? Is there a better way to hide BG3 so that the background colour can be seen through it?
<br/>
<br/>
Also, when I do this, about 8 pixels of the very top scanline become one of these colours too. Why is that? It looks like for some reason BG3 is off while these are drawn, so the last set background colour (that of the bottom scanline from the effect) is shown. I don't touch the backgrounds in VBlank though, and this is all HBlank is doing, and the effect doesn't reach anywhere near the bottom of the screen.
<br/>
<br/>
[edit] Yep, that's what it's doing alright. If I don't turn BG3 on until halfway down the screen, then the top half, not the bottom, gets shown. What the heck? It's not getting squished either, just 8 pixels are getting cut off the bottom.
<br/>
<br/>
What's even stranger is it looks like the gradient actually takes up about 10 scanlines. O_o<br/>_________________<br/>I'm a PSP hacker now, but I still &lt;3 DS.</span><span class="gensmall"><br/><br/>Last edited by HyperHacker on Fri Oct 12, 2007 3:44 am; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#142649 - DekuTree64 - Thu Oct 11, 2007 6:02 am</h4>
    <div class="postbody"><span class="postbody">Some things to be aware of:
<br/>
<br/>
1. HBlank happens at the END of a line. So a lot of times you have to set up the first line during VBlank.
<br/>
<br/>
2. On GBA, it would take a few scanlines to turn on a BG layer, so you had to use tricks like setting it to display a blank screen map instead of turning it off entirely. Haven't tested if this still happens on DS.
<br/>
<br/>
3. Rotate/scale layers (this includes bitmaps) use accumulators for the current source position, and if you change the position registers, it sets the value of the accumulator, and that is the next pixel it fetches. Text BGs just fetch from screen position + scroll, so changing their scroll registers has a more intuitive effect. So on a rot/scale, if you're 20 lines down the screen, you'll probably want to set the Y position to 20, rather than 0.<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#142651 - HyperHacker - Thu Oct 11, 2007 6:09 am</h4>
    <div class="postbody"><span class="postbody">#1 shouldn't be an issue, since this effect will always be at least 16 lines from the top and 32 from the bottom of the screen. #2 sounds like something that might be worth trying, but can I do it without using up more VRAM? For #3, you're saying it's normal behaviour and I should just tweak the layer's Y position after toggling it and restore it in VBlank?
<br/>
<br/>
I never coded on the GBA, so I don't know a whole lot about the video system.<br/>_________________<br/>I'm a PSP hacker now, but I still &lt;3 DS.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#142653 - DekuTree64 - Thu Oct 11, 2007 7:14 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>HyperHacker wrote:</b></span></td> </tr> <tr> <td class="quote">#2 sounds like something that might be worth trying, but can I do it without using up more VRAM?</td> </tr></table><span class="postbody">
<br/>
For a text layer, no. But since it's a bitmap layer that you're hiding, you could set it to not wrap around, and then scroll it offscreen.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">For #3, you're saying it's normal behaviour and I should just tweak the layer's Y position after toggling it and restore it in VBlank?</td> </tr></table><span class="postbody">
<br/>
Yep<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#142691 - knight0fdragon - Thu Oct 11, 2007 11:32 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>DekuTree64 wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>HyperHacker wrote:</b></span></td> </tr> <tr> <td class="quote">#2 sounds like something that might be worth trying, but can I do it without using up more VRAM?</td> </tr></table><span class="postbody">
<br/>
For a text layer, no. But since it's a bitmap layer that you're hiding, you could set it to not wrap around, and then scroll it offscreen.
<br/>
</span></td> </tr></table><span class="postbody">
<br/>
<br/>
if scrolling off the screen doesnt work, perhaps you can use AND and OR on the 15th bit? maybe that can turn off and on the BG in less scanlines<br/>_________________<br/><a href="http://www.myspace.com/knight0fdragonds" target="_blank">http://www.myspace.com/knight0fdragonds</a>
<br/>
<br/>
MK DS FC: Dragon 330772 075464 
<br/>
AC WW FC: Anthony SamsClub 1933-3433-9458 
<br/>
MPFH: Dragon 0215 4231 1206</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#142697 - tepples - Fri Oct 12, 2007 1:21 am</h4>
    <div class="postbody"><span class="postbody">If you want to turn layers on and off without glitches, try doing so with the window registers.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#142709 - HyperHacker - Fri Oct 12, 2007 3:43 am</h4>
    <div class="postbody"><span class="postbody">Thanks, scrolling it off the screen and back worked. Looks like the glitching in the top left corner is a problem with the routine that loads the image; for some reason those pixels aren't being written correctly. I'll have to look at it when I get the chance.<br/>_________________<br/>I'm a PSP hacker now, but I still &lt;3 DS.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
