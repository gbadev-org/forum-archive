<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>v10 normals are wrong! - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS Misc > v10 normals are wrong!</h2>
<div id="posts">
<div class="post">
    <h4>#175533 - Rexhunter99 - Wed Dec 15, 2010 10:58 pm</h4>
    <div class="postbody"><span class="postbody">I knew that when I converted my floating-point normals to v10 DS format that I'd lose a fair amount of precision, but when I loaded the model up in my viewer app before I put it into my nitro file system and found that the normals weren't lighting the vertices correctly in the lighting system so I flipped on normals and saw that they were all deformed terribly.
<br/>
<br/>
<a href="http://img814.imageshack.us/img814/1402/dsnormals.png">[Images not permitted - Click here to view it]</a>
<br/>
<br/>
I am also packing these three v10s into a 32-bit variable.  But this lack of precision practically kills any use of the lighting system for my purposes.
<br/>
<br/>
It isn't something I am doing that is wrong, I took the macros straight from t he libnds headers.  This is a serious problem...
<br/>
I guess I have to resort to manual, software lit vertices :/<br/>_________________<br/><a class="postlink" href="http://crocfanforum.forumotion.com/programming-f7/croc-ds-he-s-back-t28.htm" target="_blank"></a><a href="http://img411.imageshack.us/img411/4229/dscroclife2.gif">[Images not permitted - Click here to view it]</a> - Move over Mario... Cruise by Crash... Croc Rocks!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#175534 - elhobbs - Thu Dec 16, 2010 12:13 am</h4>
    <div class="postbody"><span class="postbody">I can assure you that the macros in the libnds headers for normals function correctly and produce values that function correctly with the ds hardware lighting as I have used them myself on cquake. The normals that look messed up appear to be contained mostly to the region in your model that is apparently exceeding the ds vertex range limits - based on the error messages in your screenshots. Are you calculating the normals as floating point and converting them to v10 afterwards? Are verifying that the floating point normals are unit length before converting them to v10 format? Can you verify the values before they are converted to ds formats?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#175535 - Rexhunter99 - Thu Dec 16, 2010 6:48 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>elhobbs wrote:</b></span></td> </tr> <tr> <td class="quote">I can assure you that the macros in the libnds headers for normals function correctly and produce values that function correctly with the ds hardware lighting as I have used them myself on cquake.</td> </tr></table><span class="postbody">
<br/>
I know they function correctly, that's why I copied the macros exactly to make sure I was using the same macros as the library does.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>elhobbs wrote:</b></span></td> </tr> <tr> <td class="quote">The normals that look messed up appear to be contained mostly to the region in your model that is apparently exceeding the ds vertex range limits - based on the error messages in your screenshots.</td> </tr></table><span class="postbody">
<br/>
No the normals are messed up all over the model, some of the ones on the thighs of Croc are so small that they just fit into a pixel.  The co-ordinate system limit has no affect on the values, the limit is simply a 16x16x16 volume, my app checks to see if the floating point version of the v16 co-ordinate is outside the bounds and informs the user if they do so the problem can be fixed.  The error messages just say that the x,y,z components of the variable are outside the box, the normals shouldn't be affected because they are unit length and are not affected by the location of the vertice they are assigned to.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>elhobbs wrote:</b></span></td> </tr> <tr> <td class="quote">Are you calculating the normals as floating point and converting them to v10 afterwards?</td> </tr></table><span class="postbody">
<br/>
In 3dsMax I am converting my unit length normals (floats) into v10 signed short integers which I store into my exported mesh file.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>elhobbs wrote:</b></span></td> </tr> <tr> <td class="quote">Are verifying that the floating point normals are unit length before converting them to v10 format?</td> </tr></table><span class="postbody">
<br/>
No need to verify.  Unless I modify the normals manually or scale the node, 3dsMax ensures that the normals are all normalized to unit length.  They never exceed -1.0f or 1.0f
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>elhobbs wrote:</b></span></td> </tr> <tr> <td class="quote">Can you verify the values before they are converted to ds formats?</td> </tr></table><span class="postbody"> Already done so in the 3dsMax export.  I printed the conversions to the Maxscript Listener to make sure they were correct.
<br/>
If i convert a normal which consists of (1.0f, 0.0f, 0.0f) to v10 format I get: (511, 0, 0) just like the DS does.  To further make sure that I am doing everything properly, I then pack all three v10 components into the 32-bit variable and unpack them before printing to make sure that I am unpacking the values correctly.
<br/>
<br/>
This is why I said it shouldn't be anything I've done wrong, I'm checking all my converted data and cross-reffing it with data I converted on the DS.<br/>_________________<br/><a class="postlink" href="http://crocfanforum.forumotion.com/programming-f7/croc-ds-he-s-back-t28.htm" target="_blank"></a><a href="http://img411.imageshack.us/img411/4229/dscroclife2.gif">[Images not permitted - Click here to view it]</a> - Move over Mario... Cruise by Crash... Croc Rocks!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#175536 - elhobbs - Thu Dec 16, 2010 3:30 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">No the normals are messed up all over the model</td> </tr></table><span class="postbody">can you expand on what you mean by that? are they bad in the display list before it reaches the ds or after? before it is converted to display list?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#175538 - ritz - Thu Dec 16, 2010 3:56 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Rexhunter99 wrote:</b></span></td> </tr> <tr> <td class="quote">...but when I loaded the model up in my viewer app before I put it into my nitro file system and found that the normals weren't lighting the vertices correctly in the lighting system so I flipped on normals and saw that they were all deformed terribly.</td> </tr></table><span class="postbody">
<br/>
What does your lit model look like on the actual DS hardware? Perhaps your windows based viewer app is incorrect or is misleading you.
<br/>
If it does look wrong on the DS, show us some of your drawing code... glLight/glNormal/etc calls so we can rule out some more stuff. From a previous post of yours, I'm assuming you do not use display/call lists.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
