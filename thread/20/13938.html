<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Technical discussion on N64 emulation - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>DS Misc > Technical discussion on N64 emulation</h2>
<div id="posts">
<div class="post">
    <h4>#137828 - simonjhall - Thu Aug 16, 2007 12:01 pm</h4>
    <div class="postbody"><span class="postbody">To cut the story short, the idea of N64 emulation on the DS has been gnawing away at me for many months now and I’d just like to sound out some ideas with you guys, basically so you can talk me out of it! I really would like to write a dynamically-recompiling emulator though, since the last emulator I wrote was for work and the focus was not on speed but on ease-of-development (eg it allowed you to run emulated code backwards etc).
<br/>
<br/>
Anyway, my concerns re: N64 emulation on the DS and some thoughts
<br/>
1)	There’s a fat MHz deficit. Emulating a cheap 93MHz processor with a cheap 66MHz part from a different architecture is never going to yield full-speed emulation even if there was no overheard incurred by the emulation (ie a 1:1 mapping from MIPS to ARM instructions and no cost associated with the translation). I do realise that there’s a second processor in the DS but you can’t just push them together and treat them as a single 99MHz processor!
<br/>
<br/>
2)	There’s a floating-point unit in the N64, and there’s no such thing in the DS. Floating-point emulation with integers isn’t going to give good speed.
<br/>
<br/>
3)	The N64 has 250MHz DDR memory, accessed over an 8-bit bus. That sounds like 500 MB/s to me and I’ve never got bandwidth like that out of the DS! However I doubt there are memory accesses every clock cycle and I’m sure a good chunk of that would be taken by rendering (eg framebuffer, texture reads etc) and that wouldn’t be so necessary on the DS due to the 3D hardware. Also if the PSP can emulate an N64 then I’m not so worried about the memory bandwidth being such an issue.
<br/>
<br/>
4)	I seem to remember that the MIPS architecture sports 32 registers (or is it 16?), if so there’s definitely no chance of doing a simple translation of MIPS to ARM since there are only 16 (really 15 + $pc) registers available in ARM mode. This would mean that some kind of register allocation system would be needed (more overhead) and since the N64’s main CPU is a 64-bit processor I’d guess that its registers are 64-bits wide too. Since ARM registers are 32-bits wide two registers would be needed to represent a since N64 register in a recompiling system. Plus additional instructions (and temporary registers too?) would be needed to perform these 64-bit calculations and stitch the results together. More overhead.
<br/>
<br/>
5)	I don’t see the amount of memory available being a problem, assuming the use of a slot-2 card. It’s a shame that the 4MB of main memory can’t fit wholly within the DS internal memory (well you technically could…) but I suppose parts of the memory could be switched in an out.
<br/>
<br/>
6)	The RCP is an interesting one, since I’ve read that it’s a vector processor and emulating this would be a right pain on the DS. However if it’s used just for graphics then hopefully it could just be handle by the 2D/3D hardware.
<br/>
<br/>
7)	There’s the legal angle – I’m scared by what happened with UltraHLE and if that were to happen again there would be no chance I’d even consider writing/releasing it.
<br/>
<br/>
But…it does sound like a fun project.
<br/>
Thoughts?
<br/>
<br/>
PS: non-techy people could we refrain from “OMG N64 would be sooooo cool! Please write it! I’ll love you!”<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#137829 - kusma - Thu Aug 16, 2007 12:06 pm</h4>
    <div class="postbody"><span class="postbody">It sounds extremely tiresome :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#137841 - Ant6n - Thu Aug 16, 2007 3:41 pm</h4>
    <div class="postbody"><span class="postbody">i've been thinking about the same thing too. dynamic recompilation might be the way to go. another way might be a mix of dynamic and static recompilation. emm, something like this: one plays a rom on a magic n64 emulator on pc, after a couple of hours of playing that emulator probably visited most of the code. while playing, the pc emulator recompiles all encountered code to mips. in the end the ds side emulator basicly runs that code, but the moment it jumps to something that wasn't recompiled it either emulates it or recompiles it on the machine. that way one can use all sorts of optimization techniques, that one wouldn't have the time for on the ds.
<br/>
2) who needs exact floating point emulation, anyway. emulating the basic idea of floating point with less accuracy and fewer of this nan,infinity,denormalized etc stuff might work. if there's dynamic recompilation, it might be possible to see what is actually used
<br/>
4) yeah, 32 regs. and yeah wiki says its 64big (gnarg)
<br/>
5) well, one would have all that shared ram and vram to work with, but where would all the recompiled code live? does the n64 run its code from cartridge?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#137850 - simonjhall - Thu Aug 16, 2007 6:36 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Ant6n wrote:</b></span></td> </tr> <tr> <td class="quote">one plays a rom on a magic n64 emulator on pc, after a couple of hours of playing that emulator probably visited most of the code. while playing, the pc emulator recompiles all encountered code to mips.</td> </tr></table><span class="postbody">Yeah I was thinking of something like that too. That'd hide some of the cost of translating the code, but I'd imagine it could be quite hard in practice due to self-modifying code etc. Could be worth a shot..
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">4) yeah, 32 regs. and yeah wiki says its 64big (gnarg)</td> </tr></table><span class="postbody">MIPS is little-endian, right? If so, that's one less thing to worry about!
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">5) well, one would have all that shared ram and vram to work with, but where would all the recompiled code live? does the n64 run its code from cartridge?</td> </tr></table><span class="postbody">I'd love to see the N64 equivalent of gbatek to find this stuff out! I think the cartridge is mapped into the address space, but I don't know if the main CPU can see it. I doubt code is run from ROM tbh, but since the RAM is high-latency (but high-bandwidth) that doesn't seem too good a place to put code either. Maybe there's some on-chip/fast RAM or something?
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">It sounds extremely tiresome :)</td> </tr></table><span class="postbody">This is the curse we, the Nation of Programmers are given when we are born :-p
<br/>
I've seriously thought that it'd be worth losing my memory in order to forget how to program...<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#137861 - Dood77 - Thu Aug 16, 2007 8:31 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>simonjhall wrote:</b></span></td> </tr> <tr> <td class="quote">non-techy people could we refrain from ?OMG N64 would be sooooo cool! Please write it! I?ll love you!?</td> </tr></table><span class="postbody">
<br/>
<br/>
Something tells me you could of picked another word that would fit better than non-techy... :P
<br/>
<br/>
I think ant6n's idea sounds cool, even though I'm pretty sure I hardly have an idea of what he's talking about...
<br/>
<br/>
I'm probably wrong on many levels here... but if you ran a '64 emulator with a dynamic core on the PC, and ran that under some kind of x86 emulator for ARM, and then captured the code produced...? "OMG some1 should make a n64 to ds convreter!!1"
<br/>
<br/>
And as for the legal issues, never call it an emulator, just a debugger, and when it comes time to actually render stuff on the screen, just use some fancy programming to render it, but not actually show it. Like overlay it with a bunch of hex code for debugging. It might also keep stupid people emailing you asking to increase the framerate :)
<br/>
<br/>
EDIT: Oh, and I almost forgot. It seems like this should be possible with HLE, if each game would have to have its own programmed HLE elements. (Like, one game requires NDS-style 2D tiling, but the other needs... something else, I dunno :P)<br/>_________________<br/>If I use a term wrong or something then feel free to correct, I?m not much of a programmer.
<br/>
<span style="font-size: 9px; line-height: normal">
<br/>
Original DS Phat obtained on day of release + flashme v7
<br/>
Supercard: miniSD, Kingston 1GB, Kingston 2GB
<br/>
Ralink chipset PCI NIC
<br/>
</span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#137864 - Ant6n - Thu Aug 16, 2007 8:36 pm</h4>
    <div class="postbody"><span class="postbody">I don't know how much self-modifying code one would expect in a console game, maybe not too much. One would need a pretty good system to be able to take plain memory and differentiate between code (which is potentially already translated), and plain data, anyway; one could double check writes/reads with some array that denotes i.e. for every 8bytes what the type of data is.
<br/>
If a pc emulator 'visits' most executed code, then one could also start making assumptions about the data being processed,  for example the maximum value of arguments/registers (and process them in 32bit), etc
<br/>
(this really is 'starter' talk)
<br/>
also if one is watching emulation, then one could watch which registers are being used how, and build some general hle around it..
<br/>
<br/>
it's always hard to find a gbatek equivalent for other devices; the gba is one of the best documented devices, which makes it much more fun
<br/>
oh yeah, according to gbatek somehwere, if i remember right, the arm9 can be run in both endian formats</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#137869 - ps2aich - Thu Aug 16, 2007 9:13 pm</h4>
    <div class="postbody"><span class="postbody">This <a class="postlink" href="http://strmnnrmn.blogspot.com/" target="_blank">blog</a> may be interesting.
<br/>
<br/>
It talks much about dynarec in the N64 Emulator Daedalus (on PSP).
<br/>
<br/>
It's for sure a technically challenging task ...</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
