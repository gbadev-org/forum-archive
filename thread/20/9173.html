<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Techdemo: Paging & Swapping - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>DS Misc > Techdemo: Paging & Swapping</h2>
<div id="posts">
<div class="post">
    <h4>#78753 - Mighty Max - Sun Apr 09, 2006 2:56 pm</h4>
    <div class="postbody"><span class="postbody">It's me, Ma...Mighty Max :D
<br/>
<br/>
I have made a little Techdemo about using the Arm9 MPU to create a virtual memspace. Several ppl told me that this was impossible/ too complex todo as the MPU is no MMU and does not provide the needed hardware registers (pagetables &amp; fault address register i.e.)
<br/>
<br/>
The uploaded demo will proove that this is at least for data access wrong.
<br/>
<br/>
The demo contains 2 .NDS files. One should be known by all, it's doublec's Tutorial 1 demo. The second, Paging.nds, implements the swapping.
<br/>
<br/>
This is what Paging.nds will do:
<br/>
- Create a 2 MB swap file. (1MB to cascade the buffer &amp; codespace for itself) and 1 MB virtual RAM at the GBA-Cardspace
<br/>
- load the demo1.nds into the GBA-Cardspace
<br/>
- extracts the arm9 binary from the cardspace again and runs it in the controlled environment (start just after MPU init of crt0)
<br/>
- responds to A+B+R+L keypresses when demo1 is running, no matter if demo1 installes IRQ handler itself (unless it changes the keys IRQ yet)
<br/>
<br/>
<br/>
Every access to a paged memory area will cause the access to be relocated. Every access to a hardware register will inform the Paging.nds to react to it.
<br/>
<br/>
<br/>
There are several points i still need working on. About 80% of all instructions that might access the ram are handled, some thumb instructions as well as LD/STM over a page border are not yet done.
<br/>
<br/>
The process locks the GBAMP other FAT devices behind the protection. A emulation of the GBAMP hardware registers should not be a problem.
<br/>
<br/>
<br/>
hrm, looks like my isp has problem with the <a href="http://ftp." target="_blank">ftp.</a> I'll upload the archive as soon as the access is up again. For now, just take a look at the yesterday's testrelease (just bin, return from keypressed info not done) <a href="http://mightymax.org/Stage1.rar" target="_blank">http://mightymax.org/Stage1.rar</a> . It will work on none of the emulators, a read/write-FAT_device (supported by chishm's lib) is needed.
<br/>
<br/>
If any emulator coder wants to have input of what is needed get it running in emulator too, query me.<br/>_________________<br/><a class="postlink" href="http://mightymax.org/gbamp_multiboot.html" target="_blank">GBAMP Multiboot</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#78876 - Mighty Max - Mon Apr 10, 2006 10:22 am</h4>
    <div class="postbody"><span class="postbody">The source is uploaded, <a href="http://www.mightymax.org/PagingRC1.zip" target="_blank">http://www.mightymax.org/PagingRC1.zip</a>
<br/>
<br/>
Have fun.<br/>_________________<br/><a class="postlink" href="http://mightymax.org/gbamp_multiboot.html" target="_blank">GBAMP Multiboot</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#78877 - Dark Knight ez - Mon Apr 10, 2006 10:25 am</h4>
    <div class="postbody"><span class="postbody">Nice project. Good job on pushing the DS's limits. :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#78913 - thoduv - Mon Apr 10, 2006 3:43 pm</h4>
    <div class="postbody"><span class="postbody">It's clearly a great step for the DS homebrew ! WELL DONE MIGHTYMAX ! \o/</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#78923 - JaJa - Mon Apr 10, 2006 4:46 pm</h4>
    <div class="postbody"><span class="postbody">An interesting little tech demo.
<br/>
But does it have any practical use?
<br/>
I mean, i saw you talking to pepsiman in #dsdev today, and you admitted it was very slow.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#78927 - Mighty Max - Mon Apr 10, 2006 5:39 pm</h4>
    <div class="postbody"><span class="postbody">For the most projects it would be much wiser to utilize the fat devices directly to outsource data.
<br/>
<br/>
But i guess it proves that such things are not impossible :D 
<br/>
<br/>
What it could be used for, are on-hardware debugger (trapping access to hw register, cascading it's own code/data against the guest binary) or maybe to run old .nds with gbfs &gt; 4MB on GBAMP (TickleGirl i.e.)<br/>_________________<br/><a class="postlink" href="http://mightymax.org/gbamp_multiboot.html" target="_blank">GBAMP Multiboot</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#78948 - kenny - Mon Apr 10, 2006 9:00 pm</h4>
    <div class="postbody"><span class="postbody">Looks good, but it's kinda... slow...
<br/>
Would it work if i replaced demo1.nds with something like "TickleGirl" that's too big for the GBAMP?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#78986 - Sebbo - Tue Apr 11, 2006 12:39 am</h4>
    <div class="postbody"><span class="postbody">once its optimised i'm sure we could see this being used in DSLinux, or any homebrew OS<br/>_________________<br/>Here's some ideas I have for when I know enough to act on them, or for others to have a look at when they're bored: <a class="postlink" href="http://www.wayne.sebbens.com/ds_ideas.htm" target="_blank">www.wayne.sebbens.com/ds_ideas.htm</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#78994 - quadomatic - Tue Apr 11, 2006 1:23 am</h4>
    <div class="postbody"><span class="postbody">wait, this means that we can run homebrew larger than 4 mb on gbamp?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#79139 - derula - Tue Apr 11, 2006 8:43 pm</h4>
    <div class="postbody"><span class="postbody">As chishm has stated more than once, NDS MP already can execute files larger than 4 MB, TickleGirl just don't work because it tries to read from the GBA slot if it was a GBA flashcard. I don't believe it really, but this is at least what chishm says, and he should actually know it because he wrote it.<br/>_________________<br/><a class="postlink" href="http://www.uglyhorst.de/blog/nerdpunk/" target="_blank">visit my blog. please.</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#79143 - Mighty Max - Tue Apr 11, 2006 9:19 pm</h4>
    <div class="postbody"><span class="postbody">Derula, this is on a complete other level.
<br/>
<br/>
Indeed the MP can load homebrew bigger then 4MB, unless it is in one big block. The software that does so has to be CF/SD aware.
<br/>
<br/>
If the software does not manage this by itself, such method as posted above is the only way to run &gt;4MB monolithic binaries. Except you build a hardware solution for the missing memory space (as the M3/Supercard does)
<br/>
<br/>
As you stated yourself, the GBAMP does not work if there is a GBA Romspace memory needed. (As tickle girl expects it) and this is exactly what the demo method fakes.<br/>_________________<br/><a class="postlink" href="http://mightymax.org/gbamp_multiboot.html" target="_blank">GBAMP Multiboot</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#79168 - quadomatic - Tue Apr 11, 2006 11:45 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Mighty Max wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
As you stated yourself, the GBAMP does not work if there is a GBA Romspace memory needed. (As tickle girl expects it) and this is exactly what the demo method fakes.</td> </tr></table><span class="postbody">
<br/>
<br/>
So this means that GBAMP will now run ANY homebrew? Or is this just a tech demo and it's not quite finalized yet, but once it is it will run any homebrew?
<br/>
<br/>
Regardless, this is awesome Mighty Max, great job, we all REALLY appreciate it!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#79173 - tepples - Wed Apr 12, 2006 12:32 am</h4>
    <div class="postbody"><span class="postbody">Because of the lack of true virtual memory, it's not likely to run at anywhere near full speed. Imagine running a DS emulator on a DS.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#79299 - Mighty Max - Wed Apr 12, 2006 7:14 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>quadomatic wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
So this means that GBAMP will now run ANY homebrew? Or is this just a tech demo and it's not quite finalized yet, but once it is it will run any homebrew?
<br/>
<br/>
Regardless, this is awesome Mighty Max, great job, we all REALLY appreciate it!</td> </tr></table><span class="postbody">
<br/>
<br/>
If you'd include the most binaries instead of "demo1.nds" aou most likely get a "Fatal Page Fault: Access to HW Register", which comes up when the child NDS accesses an unknown access into the registerspace.
<br/>
<br/>
So no, this is really just a demo how to relocate memory accesses / gain the fault address from the cpu-state &amp; faulting opcode. Unfortunally the cp15 of the ds does not support it directly.
<br/>
<br/>
For a complete and useable loader for &gt;4MB monolithic binaries several things are still missing. #1  to #5 on that list would indeed speeding up, speeding up, ... ;) (i guess about 50:1 [instructions/faulting instruction] would be totally possible, but thats still mighty slow.
<br/>
<br/>
Other things to solve would be to prevent the client NDS to set the cp15 registers (Atm it just jumps over the first cp15 inits) and such.
<br/>
<br/>
I most likely won't do much in this direction. It solved its purpose to prove it's possible.
<br/>
<br/>
And thanks :) for the words<br/>_________________<br/><a class="postlink" href="http://mightymax.org/gbamp_multiboot.html" target="_blank">GBAMP Multiboot</a></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
