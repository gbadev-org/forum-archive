<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Linker scripts for compiling patches(Resolved) - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>DS Misc > Linker scripts for compiling patches(Resolved)</h2>
<div id="posts">
<div class="post">
    <h4>#167773 - yellowstar - Thu Mar 26, 2009 10:15 pm</h4>
    <div class="postbody"><span class="postbody">I'm attempting to use custom linker scripts and a custom crt0 to compile a patch.(Normally I'd just use arm-eabi-as with just an assembler patch, but for this hack I need to write to FAT, so I'd like to use libfat and DLDI.) Ld is failing to find _start. I'm using one Makefile for specs similar to chishm's .nds loader, and the main Makefile similar to chishm's .nds loader main Makefile. Ld is defaulting to setting the entry point to 0x02000068. Is there a way to have the linker add labels for the sizes of the .text, .rodata, .itcm/.dtcm sections?
<br/>
&lt;edit&gt;
<br/>
Never mind about the _start issue, I forgot to add a ".global _start" line. Now my asm is being assembled into a separate .text section than it should be, and is being ignored by objcopy...
<br/>
&lt;edit&gt;
<br/>
Text section resolved, now there's that section sizes issue. I'd like to use some standard way for this, if and when I get this hack finished and working properly... For now guess I could write some tool to get the section sizes and update the patch binary.
<br/>
&lt;edit&gt;
<br/>
Section issue resolved with linker script.
<br/>
&lt;/edit&gt;
<br/>
&lt;/edit&gt;
<br/>
&lt;/edit&gt;
<br/>
<br/>
Makefile:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#---------------------------------------------------------------------------------
<br/>
.SUFFIXES:
<br/>
#---------------------------------------------------------------------------------
<br/>
<br/>
ifeq ($(strip $(DEVKITARM)),)
<br/>
$(error "Please set DEVKITARM in your environment. export DEVKITARM=&lt;path to&gt;devkitARM")
<br/>
endif
<br/>
<br/>
include $(DEVKITARM)/ds_rules
<br/>
<br/>
#---------------------------------------------------------------------------------
<br/>
# TARGET is the name of the output
<br/>
# BUILD is the directory where object files &amp; intermediate files will be placed
<br/>
# SOURCES is a list of directories containing source code
<br/>
# INCLUDES is a list of directories containing extra header files
<br/>
# MAXMOD_SOUNDBANK contains a directory of music and sound effect files
<br/>
#---------------------------------------------------------------------------------
<br/>
TARGET      :=   $(shell basename $(CURDIR))
<br/>
BUILD      :=   build
<br/>
SOURCES      :=   source
<br/>
DATA      :=   data  
<br/>
INCLUDES   :=   include
<br/>
<br/>
#---------------------------------------------------------------------------------
<br/>
# options for code generation
<br/>
#---------------------------------------------------------------------------------
<br/>
ARCH   :=   -mthumb -mthumb-interwork
<br/>
<br/>
CFLAGS   :=    -g -Wall -O2\
<br/>
       -march=armv5te -mtune=arm946e-s -fomit-frame-pointer\
<br/>
      -ffast-math \
<br/>
      $(ARCH)
<br/>
<br/>
CFLAGS   +=   $(INCLUDE) -DARM9
<br/>
CXXFLAGS   := $(CFLAGS) -fno-rtti -fno-exceptions
<br/>
<br/>
ASFLAGS   :=   -g $(ARCH)
<br/>
LDFLAGS   =   -specs=$(CURDIR)/../specs/my_arm9.specs -T $(CURDIR)/../specs/my_arm9.ld -g $(ARCH) -Wl,-Map,$(notdir $*.map)
<br/>
<br/>
export OBJCOPY   :=   $(PREFIX)objcopy
<br/>
<br/>
#---------------------------------------------------------------------------------
<br/>
# any extra libraries we wish to link with the project (order is important)
<br/>
#---------------------------------------------------------------------------------
<br/>
LIBS   :=    -lnds9
<br/>
 
<br/>
 
<br/>
#---------------------------------------------------------------------------------
<br/>
# list of directories containing libraries, this must be the top level containing
<br/>
# include and lib
<br/>
#---------------------------------------------------------------------------------
<br/>
LIBDIRS   :=   $(LIBNDS)
<br/>
 
<br/>
#---------------------------------------------------------------------------------
<br/>
# no real need to edit anything past this point unless you need to add additional
<br/>
# rules for different file extensions
<br/>
#---------------------------------------------------------------------------------
<br/>
ifneq ($(BUILD),$(notdir $(CURDIR)))
<br/>
#---------------------------------------------------------------------------------
<br/>
<br/>
export OUTPUT   :=   $(CURDIR)/$(TARGET)
<br/>
<br/>
export VPATH   :=   $(foreach dir,$(SOURCES),$(CURDIR)/$(dir)) \
<br/>
               $(foreach dir,$(DATA),$(CURDIR)/$(dir))
<br/>
<br/>
export DEPSDIR   :=   $(CURDIR)/$(BUILD)
<br/>
<br/>
CFILES      :=   $(foreach dir,$(SOURCES),$(notdir $(wildcard $(dir)/*.c)))
<br/>
CPPFILES   :=   $(foreach dir,$(SOURCES),$(notdir $(wildcard $(dir)/*.cpp)))
<br/>
SFILES      :=   $(foreach dir,$(SOURCES),$(notdir $(wildcard $(dir)/*.s)))
<br/>
BINFILES   :=   $(foreach dir,$(DATA),$(notdir $(wildcard $(dir)/*.*)))
<br/>
 
<br/>
#---------------------------------------------------------------------------------
<br/>
# use CXX for linking C++ projects, CC for standard C
<br/>
#---------------------------------------------------------------------------------
<br/>
ifeq ($(strip $(CPPFILES)),)
<br/>
#---------------------------------------------------------------------------------
<br/>
   export LD   :=   $(CC)
<br/>
#---------------------------------------------------------------------------------
<br/>
else
<br/>
#---------------------------------------------------------------------------------
<br/>
   export LD   :=   $(CXX)
<br/>
#---------------------------------------------------------------------------------
<br/>
endif
<br/>
#---------------------------------------------------------------------------------
<br/>
<br/>
export OFILES   :=   $(addsuffix .o,$(BINFILES)) \
<br/>
         $(CPPFILES:.cpp=.o) $(CFILES:.c=.o) $(SFILES:.s=.o)
<br/>
 
<br/>
export INCLUDE   :=   $(foreach dir,$(INCLUDES),-I$(CURDIR)/$(dir)) \
<br/>
         $(foreach dir,$(LIBDIRS),-I$(dir)/include) \
<br/>
         $(foreach dir,$(LIBDIRS),-I$(dir)/include) \
<br/>
         -I$(CURDIR)/$(BUILD)
<br/>
 
<br/>
export LIBPATHS   :=   $(foreach dir,$(LIBDIRS),-L$(dir)/lib)
<br/>
<br/>
icons = $(wildcard *.bmp)
<br/>
<br/>
ifneq (,$(findstring $(TARGET).bmp,$(icons)))
<br/>
   export GAME_ICON := $(CURDIR)/$(TARGET).bmp
<br/>
else
<br/>
   ifneq (,$(findstring icon.bmp,$(icons)))
<br/>
      export GAME_ICON := $(CURDIR)/icon.bmp
<br/>
   endif
<br/>
endif
<br/>
 
<br/>
.PHONY: $(BUILD) clean
<br/>
 
<br/>
#---------------------------------------------------------------------------------
<br/>
$(BUILD):
<br/>
   @[ -d $@ ] || mkdir -p $@
<br/>
   @make -C specs
<br/>
   @make --no-print-directory -C $(BUILD) -f $(CURDIR)/Makefile
<br/>
 
<br/>
#---------------------------------------------------------------------------------
<br/>
clean:
<br/>
   @echo clean ...
<br/>
   @rm -fr $(BUILD) $(TARGET).elf $(TARGET).bin
<br/>
   @make -C specs clean
<br/>
<br/>
#---------------------------------------------------------------------------------
<br/>
else
<br/>
 
<br/>
#---------------------------------------------------------------------------------
<br/>
# main targets
<br/>
#---------------------------------------------------------------------------------
<br/>
$(OUTPUT).bin : $(OUTPUT).elf
<br/>
   @$(OBJCOPY) -O binary $&lt; $@
<br/>
<br/>
$(OUTPUT).elf : $(OFILES)
<br/>
 
<br/>
#---------------------------------------------------------------------------------
<br/>
%.bin.o   :   %.bin
<br/>
#---------------------------------------------------------------------------------
<br/>
   @echo $(notdir $&lt;)
<br/>
   $(bin2o)
<br/>
 
<br/>
-include $(DEPSDIR)/*.d
<br/>
 
<br/>
#---------------------------------------------------------------------------------------
<br/>
endif
<br/>
#---------------------------------------------------------------------------------------
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
specs/Makefile:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
ifeq ($(strip $(DEVKITARM)),)
<br/>
$(error "Please set DEVKITARM in your environment. export DEVKITARM=&lt;path to&gt;devkitARM)
<br/>
endif
<br/>
<br/>
-include $(DEVKITARM)/ds_rules
<br/>
<br/>
all:
<br/>
   @echo -n Compiling load_crt0...
<br/>
   @$(CC)  -x assembler-with-cpp -marm -mthumb-interwork -c my_arm9_crt0.s -o my_arm9_crt0.o
<br/>
   @echo done.
<br/>
   
<br/>
   @echo -n Rewriting specs file...
<br/>
   @echo '*startfile:' &gt; my_arm9.specs
<br/>
   @echo -n $(shell pwd -W) &gt;&gt; my_arm9.specs
<br/>
   @echo '/../specs/my_arm9_crt0%O%s crti%O%s crtbegin%O%s' &gt;&gt; my_arm9.specs
<br/>
   @echo done.
<br/>
   
<br/>
clean:
<br/>
   @echo Clean...
<br/>
   rm -f my_arm9.specs my_arm9_crt0.o
<br/>
   @echo done.
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
specs/my_arm9_crt0.s:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
@ This is actually from an another patch, this wasn't changed much yet, though that will be needed later.
<br/>
<br/>
.thumb
<br/>
.section .init
<br/>
.align 2
<br/>
<br/>
sections:
<br/>
total_reloc_sections:
<br/>
.word 2
<br/>
<br/>
itcm_dst_addr:
<br/>
.word 0x01004000 @ old dest 0x023ffe00
<br/>
<br/>
itcm_size:
<br/>
.word 0x1e0
<br/>
<br/>
dtcm_dst_addr:
<br/>
.word 0x027e1000
<br/>
<br/>
dtcm_size:
<br/>
.word 0x11c
<br/>
.align 2
<br/>
<br/>
_start:
<br/>
push {r0, r1, r2, r3, r4, r5, r6, r7, lr}
<br/>
ldr r0, section_text_size
<br/>
add r0, r0, pc
<br/>
sub r0, r0, #28
<br/>
<br/>
add r4, pc, #0
<br/>
sub r4, #32
<br/>
add r1, pc, #0
<br/>
add r1, #8
<br/>
str r4, [r1, #48]
<br/>
ldr r4, section_text_size
<br/>
str r4, [r1, #52]
<br/>
mov r4, #0
<br/>
<br/>
add r7, pc, #0
<br/>
sub r7, #48
<br/>
ldr r6, [r7]
<br/>
add r7, #4
<br/>
ldr r5, [r7]
<br/>
<br/>
reloc_loop:
<br/>
ldr r1, [r7]
<br/>
ldr r2, [r7, #4]
<br/>
add r7, #8
<br/>
add r2, r1
<br/>
<br/>
copy_loop:
<br/>
ldr r3, [r0]
<br/>
str r4, [r0]
<br/>
str r3, [r1]
<br/>
add r0, #4
<br/>
add r1, #4
<br/>
cmp r1, r2
<br/>
bne copy_loop
<br/>
<br/>
sub r6, r6, #1
<br/>
bne reloc_loop
<br/>
<br/>
mov r0, #1
<br/>
add r0, r5
<br/>
add r0, #8
<br/>
bx r0  @ Has yet to be removed, won't be needed for this patch.
<br/>
<br/>
.align 2
<br/>
section_text_size: @ In the other patch _start was in the .text section, and was labeled differently.
<br/>
.word 0x5c
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
EDIT:
<br/>
my_arm9.ld is a renamed ds_arm9.ld, and the generated my_arm9.specs looks similar to this:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
*startfile:
<br/>
c:/XxxxxConsoleStuff/RE/handheld/DS/FW/patch/specs/../specs/my_arm9_crt0%O%s crti%O%s crtbegin%O%s
<br/>
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
