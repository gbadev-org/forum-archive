<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Yet another stripped version of dswifilib - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS Misc > Yet another stripped version of dswifilib</h2>
<div id="posts">
<div class="post">
    <h4>#115288 - ttursas - Sun Jan 14, 2007 6:25 pm</h4>
    <div class="postbody"><span class="postbody">I've been using dswifilib in our Wright Flight game, and after making lots of cleanups today,
<br/>
decided to give it back to the community. :) Anyway, this version can only do UDP,
<br/>
but still it works much better for me than the original version. Moved almost all array
<br/>
variables to heap from stack, and fixed a 128KB heap buffer for the traffic.
<br/>
<br/>
<a href="http://www.iki.fi/~vhelin/nintendoDS.html" target="_blank">http://www.iki.fi/~vhelin/nintendoDS.html</a>
<br/>
<br/>
The base dswifilib version for this is hmm... some release from the end of 2006, with some
<br/>
UDP bugfixes.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#115305 - ttursas - Sun Jan 14, 2007 10:33 pm</h4>
    <div class="postbody"><span class="postbody">Seems like dswifilib got a DSLite bugfix, so I'll assimilate the fixes to dswifilib-wf, test it
<br/>
for a while, while developing v0.2.2 of Wright Flight, and release the sources again in
<br/>
a week or so.
<br/>
<br/>
Just today my DSLite crashed twice while testing v0.2.1, but the original blue DS worked
<br/>
fine, so these fixes are welcome. :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#115311 - ttursas - Sun Jan 14, 2007 11:21 pm</h4>
    <div class="postbody"><span class="postbody">Have to add that to me it looks like the ARM7 side of dswifilib was running out of IRQ
<br/>
stack, but without the proper tools it's hard to say. Anyway, I think the IRQ's have 256 byte
<br/>
stacks, and the ARM7 side of dswifilib pulled over 512 bytes from the stack in some
<br/>
situations. And did overflowing happen in the ARM9 IRQs as well? Anyway, using this
<br/>
version you shouldn't get those...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#115603 - Mighty Max - Wed Jan 17, 2007 7:57 pm</h4>
    <div class="postbody"><span class="postbody">The default irq dispatcher from libnds calls the interrupt routines in system mode, thus using the user/system stack.
<br/>
<br/>
The irq stack is only used within the dispatcher itself.<br/>_________________<br/><a class="postlink" href="http://mightymax.org/gbamp_multiboot.html" target="_blank">GBAMP Multiboot</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#115873 - ttursas - Fri Jan 19, 2007 9:46 pm</h4>
    <div class="postbody"><span class="postbody">Thanks for the info!
<br/>
<br/>
As I'm not using libnds, this could really be the reason why I've had so much trouble
<br/>
with dswifilib so far. Anyway, nice to know! :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#116654 - ttursas - Sat Jan 27, 2007 11:00 pm</h4>
    <div class="postbody"><span class="postbody">I finally updated the sources to contain the fixes that were made to dswibilib in Jan 2007.
<br/>
I haven't tested the updated lib that well, because I'm on a sick leave from work.
<br/>
Too much work 1, me 0... :P
<br/>
<br/>
EDIT: Have to change that to: Too much work (getting also work that is not included in my
<br/>
job description), changing and incomplete specs, constant interruptions, and very noisy
<br/>
working enviroment 1, me 0.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#116693 - 0xtob - Sun Jan 28, 2007 12:48 pm</h4>
    <div class="postbody"><span class="postbody">Since I'm having some latency problems with the original wifilib, I want to give your version a shot. For some reason, it doesn't want to connect though. After calling Wifi_AutoConnect(), the first call to Wifi_AssocStatus() returns ASSOCSTATUS_CANNOTCONNECT. The initialization is exactly as in the wifilib examples and the code I'm testing this on works with the original wifilib. Any hints on what might be going wrong here?
<br/>
<br/>
Oh, it turns out the release version works fine, but the debug version has this problem.
<br/>
<br/>
Edit: Disregard the last sentence. I forgot to copy the release version to my libs folder, so I was still using sgstair's version.
<br/>
<br/>
Btw: What were the problems you had with the original wifilib that this version does not have?<br/>_________________<br/><a class="postlink" href="http://blog.dev-scene.com/0xtob" target="_blank">http://blog.dev-scene.com/0xtob</a> | <a class="postlink" href="http://nitrotracker.tobw.net" target="_blank">http://nitrotracker.tobw.net</a> | <a class="postlink" href="http://dsmi.tobw.net" target="_blank">http://dsmi.tobw.net</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#116702 - masscat - Sun Jan 28, 2007 3:23 pm</h4>
    <div class="postbody"><span class="postbody">0xtob:
<br/>
If you are using the inter-arm fifo handler from the dswifi example template then that could be the cause of your latency problems. <a class="postlink" href="http://forum.gbadev.org/viewtopic.php?t=11398" target="_blank">Here</a> is a thread about it.
<br/>
<br/>
Also, if you are using TCP and only sending small amounts of data it will not get sent out immediately. See <a class="postlink" href="http://www.1emulation.com/forums/index.php?showtopic=19428" target="_blank">here</a> for a hack.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#116703 - 0xtob - Sun Jan 28, 2007 3:57 pm</h4>
    <div class="postbody"><span class="postbody">Thanks masscat, the FIFO fix looked like it could solve my problem but unfortunately it doesn't. I already bugged sgstair with this, and even he isn't sure what's causing it.
<br/>
<br/>
In case anyone wants to have a look: I have <a class="postlink" href="http://rafb.net/p/h61cVh96.html" target="_blank">this test code</a> (stripped down version of kaossds) that broadcasts 2 3-byte UDP packets in each frame, which should well be possible with the DS's bandwidth. In practice, packets become more and more delayed after some minutes as the Tx buffer fills up, then it overflows causing packets to get lost. I've been investigating this for several days now and the only "solution" I've found was to only send every three frames.
<br/>
<br/>
Any ideas what might be causing this?<br/>_________________<br/><a class="postlink" href="http://blog.dev-scene.com/0xtob" target="_blank">http://blog.dev-scene.com/0xtob</a> | <a class="postlink" href="http://nitrotracker.tobw.net" target="_blank">http://nitrotracker.tobw.net</a> | <a class="postlink" href="http://dsmi.tobw.net" target="_blank">http://dsmi.tobw.net</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#116704 - masscat - Sun Jan 28, 2007 5:11 pm</h4>
    <div class="postbody"><span class="postbody">Did you do the fifo fix on the arm7 as well?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#116705 - 0xtob - Sun Jan 28, 2007 5:15 pm</h4>
    <div class="postbody"><span class="postbody">Yep, I replaced the arm7 FIFO handler with the same code.<br/>_________________<br/><a class="postlink" href="http://blog.dev-scene.com/0xtob" target="_blank">http://blog.dev-scene.com/0xtob</a> | <a class="postlink" href="http://nitrotracker.tobw.net" target="_blank">http://nitrotracker.tobw.net</a> | <a class="postlink" href="http://dsmi.tobw.net" target="_blank">http://dsmi.tobw.net</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#116706 - ttursas - Sun Jan 28, 2007 5:16 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>0xtob wrote:</b></span></td> </tr> <tr> <td class="quote">Btw: What were the problems you had with the original wifilib that this version does not have?</td> </tr></table><span class="postbody">
<br/>
<br/>
I had two kinds of problems with the original dswifilib: First, sometimes I could send lots
<br/>
of UDP data without any trouble. Or at least dswifilib thought so. In reality no data left the
<br/>
sending DS. Second, sometimes my app would just freeze after sending a couple of UDP
<br/>
packets. Third, ok, this also happened: I could send was it 12 UDP packets and after that
<br/>
sends would fail.
<br/>
<br/>
After moving lots of variables from stack to heap I don't get these anymore. Well, sometimes
<br/>
the app crashes after a while, but otherwise the UDP stuff seems to work.
<br/>
<br/>
And for the record, I'm not using libnds, if that matters.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#118224 - wintermute - Sun Feb 11, 2007 5:45 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>ttursas wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
And for the record, I'm not using libnds, if that matters.</td> </tr></table><span class="postbody">
<br/>
<br/>
As it happens it probably matters rather a lot.
<br/>
<br/>
Your issues with blowing the irq stack with dswifi are entirely due to <span style="font-weight: bold">your</span> interrupt dispatcher.
<br/>
<br/>
The libnds interrupt dispatcher switches to system stack for all interrupt handlers. The irq stack is <span style="font-weight: bold">only</span> used within the dispatcher itself.
<br/>
<br/>
For what it's worth, there were some problems in the libnds dispatcher caused by my misunderstanding of a particular issue. This has since been resolved and it seems like it has also alleviated 0xtob's latency issues.<br/>_________________<br/><a class="postlink" href="http://www.devkitpro.org/" target="_blank">devkitPro - professional toolchains at amateur prices</a>
<br/>
<a class="postlink" href="http://wiki.devkitpro.org/index.php/IRC" target="_blank">devkitPro IRC support</a>
<br/>
<a class="postlink" href="http://davejmurphy.com/" target="_blank">Personal Blog</a></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
