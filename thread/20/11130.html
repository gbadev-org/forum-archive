<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>All this yammering about Threads... - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS Misc > All this yammering about Threads...</h2>
<div id="posts">
<div class="post">
    <h4>#102384 - OOPMan - Wed Sep 13, 2006 2:36 pm</h4>
    <div class="postbody"><span class="postbody">Right, so, it seems like we don't have a proper, universal thread library for homebrew NDS development...
<br/>
<br/>
I searched through the forums and noticed a few threads related topics. The general line was that people had done some thread-related work but not created a complete library...
<br/>
<br/>
So I did a google for "thread library embedded systems" and got some promising results...
<br/>
<br/>
Top of the results was <a class="postlink" href="http://www.sics.se/~adam/pt/" target="_blank">ProtoThreads</a>
<br/>
<br/>
To quote from the website...
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Protothreads are extremely lightweight stackless threads designed for severely memory constrained systems, such as small embedded systems or wireless sensor network nodes. Protothreads provide linear code execution for event-driven systems implemented in C. Protothreads can be used with or without an underlying operating system to provide blocking event-handlers. Protothreads provide sequential flow of control without complex state machines or full multi-threading.
<br/>
<br/>
While protothreads originally were created for memory-constrained embedded systems, it has found many uses as a general purpose library too. Examples include multimedia streaming server software, grid computing research software, and MPEG decoding software for Internet TVs. 
<br/>
<br/>
Read more...
<br/>
<br/>
Main features: 
<br/>
Very small RAM overhead - only two bytes per protothread and no extra stacks 
<br/>
Highly portable - the protothreads library is 100% pure C and no architecture specific assembly code 
<br/>
Can be used with or without an OS 
<br/>
Provides blocking wait without full multi-threading or stack-switching 
<br/>
Freely available under a BSD-like open source license 
<br/>
<br/>
Example applications: 
<br/>
Memory constrained systems 
<br/>
Event-driven protocol stacks 
<br/>
Small embedded systems 
<br/>
Sensor network nodes 
<br/>
Portable C applications 
<br/>
<br/>
For example usages, see the Examples page. 
<br/>
<br/>
The protothreads library is released under an open source BSD-style license that freely allows for both non-commercial and commercial usage. The only requirement is that credit is given. Download the full source code here. 
<br/>
<br/>
Protothreads were created by Adam Dunkels with support from Oliver Schmidt &lt;ol.sc@web.de&gt;</td> </tr></table><span class="postbody">
<br/>
<br/>
So, anyway, I'm downloading ProtoThreads and I'll see whether it passes through devkitARM without a peep...
<br/>
<br/>
Has anyone else come across any good threading libraries that would be appropriate to use on the NDS?
<br/>
<br/>
Why re-invent the wheel, after all :-)<br/>_________________<br/>"My boot, your face..." - Attributed to OOPMan, Emperor of Eroticon VI
<br/>
<br/>
You can find my NDS homebrew projects <a class="postlink" href="http://blog.dev-scene.com/oopman/" target="_blank">here...</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#102386 - kevinc - Wed Sep 13, 2006 3:10 pm</h4>
    <div class="postbody"><span class="postbody">AFAIK that's not threading, it simply runs several short pieces of code sequentially. There's no parallelism there, each piece of code must return voluntarily before the next can run. That's different from true threading, where the thread lib runs pieces of each routine transparently.
<br/>
<br/>
For example, if you have a GUI routine and an X routine in two threads, you'd expect that if the X routine gets stuck in an infinite loop, the GUI routine still runs (or even kills the rogue thread). That wouldn't be possible with protothreads. 
<br/>
<br/>
There's (also AFAIK) another difference to true threading. For example, if some kind of hardware access requires blocking time (for example, writing to FAT), while the hardware is waiting, the thread lib can switch to another thread and move on; with protothreading, the wait time remains.
<br/>
<br/>
/ my (uninformed) 0.02 ?<br/>_________________<br/><a class="postlink" href="http://akzeac.blogspot.com" target="_blank">http://akzeac.blogspot.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#102395 - OOPMan - Wed Sep 13, 2006 4:25 pm</h4>
    <div class="postbody"><span class="postbody">Well, it is listed as proto-threading...
<br/>
<br/>
Even on a single processor thread execution is never actually truly parallel. The various threads are just all executing sequentially but switching very quickly...
<br/>
<br/>
I guess the question is, can the NDS hardware support true threading?
<br/>
<br/>
Given that some people have managed to get threading kind of working, the answer wuld be yes.
<br/>
<br/>
Still, given the lack of a common thread library, I'm guessing there's some problems overall :-(
<br/>
<br/>
<br/>
Anyway, for small pieces of code, Protothreads might well be a better bet than nothing at all...<br/>_________________<br/>"My boot, your face..." - Attributed to OOPMan, Emperor of Eroticon VI
<br/>
<br/>
You can find my NDS homebrew projects <a class="postlink" href="http://blog.dev-scene.com/oopman/" target="_blank">here...</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#102399 - bjoerngiesler - Wed Sep 13, 2006 6:11 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>OOPMan wrote:</b></span></td> </tr> <tr> <td class="quote">I guess the question is, can the NDS hardware support true threading?</td> </tr></table><span class="postbody">
<br/>
<br/>
I'm sure it can, but do we need it? Threads give you less control over what your processor time gets used for, and more overhead (not to mention all the pitfalls with locking etc). Both undesirable, if you ask me, particularly on weak hardware. Much better to do your own scheduling.
<br/>
<br/>
The only *real* benefit of threads (besides being useful as a programming paradigm sometimes) is when you have a multiprocessor system and things actually *can* run in parallel. Which isn't true for the DS.<br/>_________________<br/><a class="postlink" href="http://giesler.biz/~bjoern/en/sw_dsftp.html" target="_blank">DSFTP homepage</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#102400 - neonext - Wed Sep 13, 2006 6:20 pm</h4>
    <div class="postbody"><span class="postbody">porting</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#102403 - sajiimori - Wed Sep 13, 2006 6:47 pm</h4>
    <div class="postbody"><span class="postbody">At work, we have real threads (that are interrupt based), full asymmetric coroutines (which have their own stack), and partial asymmetric coroutines (which don't have a stack).
<br/>
<br/>
"Proto threads" could be called "partial asymmetric coroutines."
<br/>
<br/>
Be careful with real threads -- they introduce a lot of complexity.  We hardly ever use them.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#102411 - knight0fdragon - Wed Sep 13, 2006 9:38 pm</h4>
    <div class="postbody"><span class="postbody">MightyMax did some threading and posted an example of it somewhere on these forums,  but unless it is used for porting, I would recommend just using the IRQs<br/>_________________<br/><a href="http://www.myspace.com/knight0fdragonds" target="_blank">http://www.myspace.com/knight0fdragonds</a>
<br/>
<br/>
MK DS FC: Dragon 330772 075464 
<br/>
AC WW FC: Anthony SamsClub 1933-3433-9458 
<br/>
MPFH: Dragon 0215 4231 1206</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#102413 - OOPMan - Wed Sep 13, 2006 10:18 pm</h4>
    <div class="postbody"><span class="postbody">Real threads are indeed troublesome creatures in many cases, but they still have their uses...
<br/>
<br/>
I read over MightyMax's thread. It's one thing to develop threads for one's own use, however, and quite another to create a general library with a good API...
<br/>
<br/>
IRQs alone will only take you so far (Deadlocks are not fun, I know from experience :-( )
<br/>
<br/>
Anyway, in my quest I uncovered another OSS library that seems to have more potential than ProtoThreads...
<br/>
<br/>
The library in question is <a class="postlink" href="http://www.softsystem.co.uk/MTClib.htm" target="_blank">MTClib</a>
<br/>
<br/>
From the web-page:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">MTClib - MultiThreaded C
<br/>
<br/>
What is MTClib?
<br/>
<br/>
The MTC library is a multithreading library for C and C++ programs that is open source, cross platform and high performance.
<br/>
<br/>
Features
<br/>
Pre-emptively scheduled threads with 32767 priority levels. 
<br/>
Priority inversion protection. 
<br/>
Mutexes. 
<br/>
Semaphores. 
<br/>
Very low overhead, millisecond resolution, callback timers. 
<br/>
Message passing. 
<br/>
Multiple readers, single writer locks. 
<br/>
Barriers. 
<br/>
Thread local heaps for lock free memory management. 
<br/>
Small footprint (typically &lt; 10K code). 
<br/>
Fast context switching - under 2 microseconds on a 200 MHz Pentium. 
<br/>
Floating point context save (where supported by the target). 
<br/>
Fully instrumented source with logging capability. 
<br/>
100% ANSI C90 source with a single, small, platform/compiler adaptation module. 
<br/>
Lightweight ANSI C++ 99 class wrappers. 
<br/>
Platform independent. 
<br/>
Ideal for embedded systems.
<br/>
<br/>
What's in the package?
<br/>
<br/>
The package consists of the library sources, pre-built libraries, C/C++ header files, example C and C++ applications and projects or makefiles for the following target/compiler combinations:
<br/>
32-bit DOS, DJGPP (version 2.03 or later) and gcc 4.0. 
<br/>
32-bit DOS, OpenWatcom C++ version 1.04. 
<br/>
16-bit DOS, Microsoft Visual C++ 1.52c or BorlandC++ 3.1. 
<br/>
16-bit DOS, OpenWatcom C++ version 1.04. 
<br/>
Win32, Microsoft Visual C++ 6.0. 
<br/>
Win32, OpenWatcom C++ 1.04. 
<br/>
Win32, BorlandC++ 5.5. 
<br/>
POSIX, Cygwin version 1.5.19 with gcc 3.4. 
<br/>
Mac OS 9 PowerPC target, CodeWarrior 8. 
<br/>
ARM 7, ARM SDT 2.51
<br/>
<br/>
Requirements
<br/>
Supported target: e.g. x86 (e.g. DOS, Windows), PowerPC (Mac OS 9 and X) or ARM7. 
<br/>
A host system compatible with the chosen compiler e.g. Windows 98, Me, 2000, XP or Mac OS 9, X. 
<br/>
10 MB of free disk space. 
<br/>
Suitable ANSI C90 compiler.
<br/>
<br/>
Limitations of use
<br/>
The MTC library is open source, shareware.
<br/>
The library may be freely used by, or incorporated into products of, any individual for personal and private use or for their sole business without further restriction or charge.
<br/>
Companies, organisations or governments must first obtain a license to use the library.
<br/>
Any person, organisation or company intending to sell or redistribute for profit, products containing the library or any part thereof must first obtain a licence.
<br/>
In no case may the library or any part thereof be re-badged, re-sold or used in a system to deprive anyone of life, liberty or livelihood.</td> </tr></table><span class="postbody">
<br/>
<br/>
What's interesting here is that they already support the ARM7. Given that most ARM architecture is supposed to be pretty uniform across the various lines and taking into account the fact that the source is supplied, it might well be possible to develop a proper MT library for the ARM9 using this as a base...
<br/>
<br/>
I'm going to take a look at it and see what comes of it...<br/>_________________<br/>"My boot, your face..." - Attributed to OOPMan, Emperor of Eroticon VI
<br/>
<br/>
You can find my NDS homebrew projects <a class="postlink" href="http://blog.dev-scene.com/oopman/" target="_blank">here...</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#102501 - OOPMan - Thu Sep 14, 2006 6:37 pm</h4>
    <div class="postbody"><span class="postbody">Well, MTClib looks like it might well be portable...
<br/>
<br/>
Most of the library is basic C, with only a small amount that is platform specific. The developers have even provided a skeleton.c file which provides a framework for writing the necessary platform specific code...
<br/>
<br/>
A quick and dirty attempt to get it compiling under devkitARM wasn't ultra-successful though...
<br/>
<br/>
It choked while processing the ARM7 platform-specific code, specifically during a section containing some inline assembler code. 
<br/>
<br/>
Well, I'm gonna tweak it about a little more and contact the developers and see if they have any ideas...<br/>_________________<br/>"My boot, your face..." - Attributed to OOPMan, Emperor of Eroticon VI
<br/>
<br/>
You can find my NDS homebrew projects <a class="postlink" href="http://blog.dev-scene.com/oopman/" target="_blank">here...</a></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
