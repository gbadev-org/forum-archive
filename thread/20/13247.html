<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>DSM Files - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS Misc > DSM Files</h2>
<div id="posts">
<div class="post">
    <h4>#129209 - JaJa - Sun May 20, 2007 6:09 pm</h4>
    <div class="postbody"><span class="postbody">Okay. Someone recently mentioned this new file format that Moonshell may be extended to support (not too sure about that, but there is a stand alone player).
<br/>
<br/>
You can find a windows encoder and the nds binary here:
<br/>
<a href="http://mdxonline.dyndns.org/archives/2007/05/dsmplay_ver05.shtml" target="_blank">http://mdxonline.dyndns.org/archives/2007/05/dsmplay_ver05.shtml</a>
<br/>
<br/>
However, linux and mac users have once again been left without an encoder.
<br/>
<br/>
I had a look and this format appears to use mpeg1 video and a heavily downsampled audio track encoded with True Audio.
<br/>
<br/>
The binaries for encoding included with DSMplay are:
<br/>
<br/>
Mencoder - appears to be used to spit out the wav file that is used by ssrc and to get info on the file.
<br/>
<br/>
ffmpeg - used to encode the mpeg1 video
<br/>
<br/>
ssrc_hp - Shibatch Sample Rate converter, this is used to downsample (and dither and such) the wav spat out from mencoder.
<br/>
<br/>
ttaenc - true audio encoder. used to create true audio stream from the downsampled wav.
<br/>
<br/>
Unfortunately ssrc fails with an 'unknown error 1' on my G3 ibook under Tiger (maybe someone can try running it under Linux or Intel Tiger?), so I haven't been able to generate the streams (let alone think of combining them).
<br/>
<br/>
The encoder uses the following commands to prepare the streams:
<br/>
<br/>
ffmpeg -t 1 -v 1 -y -vcodec mpeg1video -qscale 4 -acodec mp3 -ab 160 -i &lt;input file&gt; &lt;input file&gt;.ffmpeg.mpg
<br/>
ffmpeg -v 1 -y -vcodec mpeg1video -qscale 4 -acodec mp3 -ab 160 -i &lt;input file&gt; &lt;input file&gt;.ffmpeg.mpg
<br/>
mencoder -v &lt;input file&gt;.ffmpeg.mpg -noautosub -ovc copy -af format=s16le,resample=48000:1:2,channels=2,volume=0:1 -oac pcm -of rawaudio -o &lt;input file&gt;.dsm1.wav
<br/>
ssrc_hp --rate 32768 --dither 0 --bits 8 --normalize --pdf 2 --twopass &lt;input file&gt;.dsm1.wav &lt;input file&gt;.dsm2.wav
<br/>
ttaenc -e &lt;inpute file&gt;.dsm2.wav
<br/>
<br/>
Of course I have since whipped out my hex editor to try and decipher the container format (it's quite simple actually). Details of the header to follow in my next post.<br/>_________________<br/>LAWL HOOGE
<br/>
<a class="postlink" href="http://www.pageofrandom.wordpress.com/" target="_blank">My Blog</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#129218 - tepples - Sun May 20, 2007 6:47 pm</h4>
    <div class="postbody"><span class="postbody">Is this any better than DPG?<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#129221 - JaJa - Sun May 20, 2007 6:55 pm</h4>
    <div class="postbody"><span class="postbody">Okay onto the header.
<br/>
<br/>
Once again the first 36bytes contain the offset (in bytes) of various things in the file. The audio file starts straight after this header. All this data is based on a 30 second sample of Death Note episode 12 (created using mencoder &lt;death note ep&gt; -enpos 30 -oac copy -ovc copy &lt;output&gt;) encoded with the dsmenc.exe file included with DSMplay 0.41 (he released 0.5 today, haven't seen if there are any changes in the output). 
<br/>
<br/>
Hex                                             Decimal Value      What it is
<br/>
<span style="color: red">44 53 4D 31</span> 	   D S M 1		<span style="color: green">dsm header</span>
<br/>
<span style="color: red">B8 C7 11 00</span>	   1,165,240 	       <span style="color: green">video data</span>
<br/>
<span style="color: red">00 66 FC 00</span>	   16,541,184 	       <span style="color: green">video data bytes</span>
<br/>
<span style="color: red">B8 2D 0E 01</span>	   17,706,424	      <span style="color: green">video seek table data</span>
<br/>
<span style="color: red">88 04 00 00</span>	    1,160		  <span style="color: green">video seek table data bytes</span>
<br/>
<span style="color: red">24 00 00 00</span> 	    36		            <span style="color: green">audio data</span>
<br/>
<span style="color: red">14 C7 11 00</span>	    1,165,076	        <span style="color: green">audio data bytes</span>
<br/>
<span style="color: red">38 C7 11 00</span>	    1,165,112	        <span style="color: green">audio seek table data</span>
<br/>
<span style="color: red">80 00 00 00</span>	     128		<span style="color: green">audio seek table data bytes</span>
<br/>
<br/>
(I apologize for the mess, I can't do tabs or even multiple spaces! So I'll upload my crappy text document with the same annotations later. To help I'll write the hex in red, the decimal in black and the right most column in green.)
<br/>
<br/>
After this 36 bytes the audio stream starts.
<br/>
<br/>
<span style="color: red">54 54 42 31</span>	T T B 1		<span style="color: green">true audio version tag</span>
<br/>
<span style="color: red">02 00 00 00</span>	2		   <span style="color: green">number of channels</span>
<br/>
<span style="color: red">08 00 00 00</span>	8		   <span style="color: green">bits</span>
<br/>
<span style="color: red">50 0F 00 00</span>	3,920		<span style="color: green">hz</span>
<br/>
<span style="color: red">00 10 00 00</span>	4,096		<span style="color: green">frame length in samples</span>
<br/>
<span style="color: red">EE 00 00 00</span> 	238		<span style="color: green">frame count</span>
<br/>
<span style="color: red">80 04 00 00</span>	1,152		<span style="color: green">???</span>
<br/>
<br/>
I only got this far in the stream. After this it's a bunch of zeros (in my sample file) and then some data after a few hundred bytes (maybe my sample is silent at the start?). Next I looked at the video stream.
<br/>
<br/>
Mpeg1video (I assume) file header..
<br/>
<br/>
<span style="color: red">CF 02 00 00</span> 	719		<span style="color: green">frames</span>			signed 32
<br/>
<span style="color: red">00 01 00 00</span>	256		<span style="color: green">h-width</span>			signed 32
<br/>
<span style="color: red">90 00 00 00</span>	144		<span style="color: green">v-height</span>			signed 32
<br/>
<span style="color: red">00 08 00 00</span>	32,768	      <span style="color: green">sample rate</span>		signed 32
<br/>
<span style="color: red">20 13 00 00</span>	25,900	<span style="color: green">??</span>				signed 32
<br/>
<span style="color: red">00 00 00 00</span>	0		<span style="color: green">??</span>				signed 32
<br/>
<br/>
Again only the first few bytes of the stream (the stream is some 16mbytes) but I feel it shows the important bits.
<br/>
<br/>
Now, this new format has seek tables. I had a look and they simply seem to indicate how many bytes in the file to jump.
<br/>
<br/>
audio seek table..
<br/>
<br/>
<span style="color: red">10 00 00 00</span>	16          ???
<br/>
<span style="color: red">0F 00 00 00</span>	15           ???
<br/>
<span style="color: red">00 00 00 00</span> 	0            ???
<br/>
<span style="color: red">00 00 00 00</span>	0            ???
<br/>
<span style="color: blue">00 00 01 00</span>	65,536	signed 16bit?? 			1	+65,491
<br/>
<span style="color: red">64 C2 00 00</span>	49,764	bytes skip audio stream?		+81,160
<br/>
<span style="color: blue">00 00 02 00</span>	131,072							2	+65,536
<br/>
<span style="color: red">64 FF 01 00</span>	130,924								+85,796
<br/>
<span style="color: blue">00 00 03 00</span>	196,608							3	+65,536
<br/>
<span style="color: red">90 4E 03 00</span>	216,720								+85,476
<br/>
<span style="color: blue">00 00 04 00</span>	262,144							4	+65,536
<br/>
<span style="color: red">74 9C 04 00</span>	302,196								+86,216
<br/>
<span style="color: blue">00 00 05 00</span>	327,680							5	+65,536
<br/>
<span style="color: red">3C ED 05 00</span>	388,412								+86,388
<br/>
<span style="color: blue">00 00 06 00</span>	393,216							6	+65,536
<br/>
<span style="color: red">B0 3E 07 00</span>	474,800
<br/>
<span style="color: blue">00 00 07 00</span>	458,752							7	+65,536
<br/>
<span style="color: red">6C 70 08 00</span>	553,068
<br/>
<span style="color: blue">00 00 08 00</span>	524,288							8
<br/>
<span style="color: red">34 8B 09 00</span>	625,460
<br/>
<span style="color: blue">00 00 09 00</span>	589,824							9
<br/>
<span style="color: red">48 AB 0A 00</span>	699,208
<br/>
<span style="color: blue">00 00 0A 00</span>	655,360							10
<br/>
<span style="color: red">48 D1 0B 00</span>	774,472
<br/>
<span style="color: blue">00 00 0B 00</span>	720,896							11
<br/>
<span style="color: red">44 13 0D 00</span>	856,900
<br/>
<span style="color: blue">00 00 0C 00</span>	786,432							12
<br/>
<span style="color: red">14 56 0E 00</span>	939,540
<br/>
<span style="color: blue">00 00 0D 00</span>	851,968							13
<br/>
<span style="color: red">88 90 0F 00</span>	1,020,040
<br/>
<span style="color: blue">00 00 0E 00</span>	917,504							14
<br/>
<span style="color: red">D0 C4 10 00</span>	1,098,960
<br/>
<br/>
That's the full audio seek table. The numbers on the right are the amount of to add the the decimal in on the same line to get to the next value. There appears to be a 16bit signed int (indicating some kind of 'sync point' maybe?) and a 32bit signed int, which is the number of bytes in the file to skip (I think). I have colored the 16bit ints in blue and the 32bit ones in red.
<br/>
<br/>
Next post is the video seek table.<br/>_________________<br/>LAWL HOOGE
<br/>
<a class="postlink" href="http://www.pageofrandom.wordpress.com/" target="_blank">My Blog</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#129226 - JaJa - Sun May 20, 2007 7:15 pm</h4>
    <div class="postbody"><span class="postbody">The video seek table appears to follow a similar format (value then number of bytes to skip) although both values are 32bit ints (I think).
<br/>
No idea what the first 16 bytes represent though, in either table.
<br/>
<br/>
video seek table..
<br/>
<br/>
<span style="color: red">05 00 00 00</span>	5			<span style="color: green">??</span>
<br/>
<span style="color: red">09 00 00 00</span>	144			<span style="color: green">??</span>
<br/>
<span style="color: red">00 00 00 00</span>	0			<span style="color: green">??</span>
<br/>
<span style="color: red">00 00 00 00</span>	0			<span style="color: green">??</span>
<br/>
<span style="color: red">B1 1A 00 00</span>	6,833		<span style="color: green">'syncpoint' number</span>
<br/>
<span style="color: red">AC 5F 00 00</span>	24,492		<span style="color: green">bytes to skip</span>
<br/>
<span style="color: red">62 35 00 00</span>	13,666
<br/>
<span style="color: red">6C BF 00 00</span>	49,004  <span style="color: green">bytes to skip</span>
<br/>
<span style="color: red">14 50 00 00</span>	20,500
<br/>
<span style="color: red">B4 22 01 00</span>	74,420  <span style="color: green">bytes to skip</span>
<br/>
<span style="color: red">C5 6A 00 00</span>	27,333
<br/>
<span style="color: red">8C ED 01 00</span>	126,348  <span style="color: green">bytes to skip</span>
<br/>
<br/>
... this continues for some 1000 bytes which I won't annotate (i'll show last entry though)
<br/>
<br/>
<span style="color: red">24 E9 0E 00</span>	977,188
<br/>
<span style="color: red">74 A5 FA 00</span>	16,426,356 <span style="color: green">bytes to skip</span>
<br/>
<br/>
Notice that in both the seek tables the last entry is a few hundred less than the length of the stream. This is what led me to suspect that it's the number of bytes to skip.
<br/>
<br/>
That's all I have for now. If anyone wants my set of samples, logs, encodes and notes leave a message and I'll upload them to rapidshare.
<br/>
<br/>
The main problems I face now are:
<br/>
<br/>
Trying to find another sample rate converter (probably use sox again) and working out what causes an entry to be made in the audio/video seek tables and how they relate to each other.
<br/>
<br/>
@Tepples; I feel that it looks slightly sharper. The main problem is that a 30 second clip comes out to 17Mbyte! If you look at some of the screen shots on the moonshell website you see a 24 minute anime show comes to 1.1Gbyte, so the format needs some kind of compression (or lower bitrates I guess). It's main additions are the seek tables. This makes seeking through video a lot less painless (in the half hour or so I've played with it).<br/>_________________<br/>LAWL HOOGE
<br/>
<a class="postlink" href="http://www.pageofrandom.wordpress.com/" target="_blank">My Blog</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#129297 - h0t1ce - Mon May 21, 2007 6:24 pm</h4>
    <div class="postbody"><span class="postbody">@JaJa
<br/>
<br/>
Thank you so much for looking into this new video container. Are you planning to make a easy to use script for people to use? if not, do you mind if I try making one once you're done finding how the header, seek tables, etc works?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#129309 - JaJa - Mon May 21, 2007 8:14 pm</h4>
    <div class="postbody"><span class="postbody">Sure, go ahead. I lack the programming skills to write anything (Juhees wrote the headermaker for the dpg file format all that time ago, I just worked out the format and how to make the streams.).
<br/>
<br/>
I just thought it might be fun to try and work out the format.
<br/>
<br/>
Probably not going to have any more time until next weekend to look at the seek tables though.<br/>_________________<br/>LAWL HOOGE
<br/>
<a class="postlink" href="http://www.pageofrandom.wordpress.com/" target="_blank">My Blog</a></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
