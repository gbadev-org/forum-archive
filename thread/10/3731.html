<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>How do i play an audio sample which constantly loops - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>Audio > How do i play an audio sample which constantly loops</h2>
<div id="posts">
<div class="post">
    <h4>#23593 - gbawiz - Thu Jul 15, 2004 10:24 pm</h4>
    <div class="postbody"><span class="postbody">Hello all,
<br/>
<br/>
Can anyone suggest a suitable method for playing an audio sample loop over and over again.
<br/>
I would like to be able to play an audio sample of size 2Kbytes in a continous loop at 22KHZ, how can i do this.
<br/>
<br/>
My past efforts at playing sample loops seems to be hampered by a strange clicking sound.
<br/>
<br/>
When a sample is playing and it reaches it's end, what is the best method of detecting and reseting the sample?
<br/>
<br/>
Cheers!
<br/>
Gbawiz</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#23595 - dagamer34 - Fri Jul 16, 2004 12:03 am</h4>
    <div class="postbody"><span class="postbody">Use a timer to count the time passed and when it is done, simply "play" the sample again.<br/>_________________<br/>Little kids and Playstation 2's don't mix. :(</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#23619 - gbawiz - Fri Jul 16, 2004 9:24 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>dagamer34 wrote:</b></span></td> </tr> <tr> <td class="quote">Use a timer to count the time passed and when it is done, simply "play" the sample again.</td> </tr></table><span class="postbody">
<br/>
<br/>
Yeah, I see what you mean about using the timer to count.
<br/>
Ok, how do you "play" the sample "again"
<br/>
<br/>
Thanks</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#23624 - poslundc - Fri Jul 16, 2004 12:13 pm</h4>
    <div class="postbody"><span class="postbody">How did you play the sample in the first place?
<br/>
<br/>
Do that again.
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#23688 - gbawiz - Sun Jul 18, 2004 10:39 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>poslundc wrote:</b></span></td> </tr> <tr> <td class="quote">How did you play the sample in the first place?
<br/>
<br/>
Do that again.
<br/>
<br/>
Dan.</td> </tr></table><span class="postbody">
<br/>
<br/>
<br/>
Im trying to get a fresh perspective on this without going down the same road, because the method which I'm using doesn't seem to work properly.
<br/>
<br/>
Ok I will give a little clue, I think there is a problem with the DMA switching in my attempts, but would like to hear how others would "play a continuous sample loop"</span><span class="gensmall"><br/><br/>Last edited by gbawiz on Mon Jul 19, 2004 2:42 pm; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#23690 - dagamer34 - Sun Jul 18, 2004 11:23 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>gbawiz wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>poslundc wrote:</b></span></td> </tr> <tr> <td class="quote">How did you play the sample in the first place?
<br/>
<br/>
Do that again.
<br/>
<br/>
Dan.</td> </tr></table><span class="postbody">
<br/>
<br/>
Oh what genius!!
<br/>
<br/>
Im trying to get a fresh perspective on this without going down the same road, because the method which I'm using doesn't seem to work properly.
<br/>
<br/>
Ok I will give a little clue, I think there is a problem with the DMA switching in my attempts, but would like to hear how others would "play a continuous sample loop"</span></td> </tr></table><span class="postbody">
<br/>
<br/>
Yea, do what poslundc said. A little tip though. IF you are using a timer with DMA to keep track of your samples, make sure that you set the timer counting register and the DMA control register to zero before you set them back up again, otherwise you will hear clicking every time you play the sample.
<br/>
<br/>
I'm wondering, if you didn't know how to "play" a sample again for looping, how did you stop it in the first place?<br/>_________________<br/>Little kids and Playstation 2's don't mix. :(</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#23691 - poslundc - Sun Jul 18, 2004 11:40 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>gbawiz wrote:</b></span></td> </tr> <tr> <td class="quote">Oh what genius!!
<br/>
<br/>
Im trying to get a fresh perspective on this without going down the same road, because the method which I'm using doesn't seem to work properly.
<br/>
<br/>
Ok I will give a little clue, I think there is a problem with the DMA switching in my attempts, but would like to hear how others would "play a continuous sample loop"</td> </tr></table><span class="postbody">
<br/>
<br/>
I was perfectly serious. In my mixer, I restart a sample pretty much the same way I start it.
<br/>
<br/>
It occurs to me that perhaps you aren't using a correct framework. A normal mixer runs constantly, switching from buffer to buffer, even if no sound is being played. So starting, stopping or looping a sample is pretty much trivial. You just say what sound the channel is pointing to, and reset the position to the beginning of the sound. The mixer should take care of the rest.
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#23692 - DekuTree64 - Sun Jul 18, 2004 11:44 pm</h4>
    <div class="postbody"><span class="postbody">How long is the sample? The length needs to be a multiple of 16 because the sound DMA actually transfers 16 bytes into the FIFO, not 4, as it seems like it would. The FIFO registers are just the way of sending data into the real buffers. I haven't tested this, but you could probably write to them 4 times consecutively using the CPU and they would play just the same as when the DMA does it.
<br/>
<br/>
Also untested is what actually happens when the length isn't a multiple of 16. I would assume that because the DMA plays forever unless you stop it, that on the last time it gets triggered before your timer interrupt to restart it, it would just read past the end of the sample until it got to the next 16 byte boundary and get whatever data happened to be there, which would most likely not fit smoothly with the end of the sample, and cause a click.
<br/>
<br/>
To fix the problem, just copy the value of the last sample until you get to a multiple of 16, and hopefully it won't cause enough of a delay to still make a click when it restarts.
<br/>
<br/>
EDIT: Dan posted while I was typing. He is right that a mixer is what you really need, my solution is just a quick fix because writing a mixer takes a while.<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#23714 - gbawiz - Mon Jul 19, 2004 2:04 pm</h4>
    <div class="postbody"><span class="postbody">Hello guys,
<br/>
<br/>
Thanks for the assistance :)
<br/>
<br/>
This is something which i have been trying to figure out for quite some time.
<br/>
I have used a method which works like this:
<br/>
<br/>
1. setup dma transfer &amp; counters
<br/>
2. timer 2 counts the number of samples being played by counting the overflows from timer 1 (which is outputing the sample rate).
<br/>
3. when timer 2 overloads after the size of my buffer then it will generate an interrupt.
<br/>
<br/>
The interrupt:
<br/>
This will stop the sample by flipping the enable bit of the DMA.
<br/>
The read and write buffer addresses are swapped and the new sample is mixed into the write buffer.
<br/>
the DMA transfer is restarted and reads from the read buffer.
<br/>
<br/>
--end interrupt ----
<br/>
<br/>
4. the whole process continues.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#23715 - JL - Mon Jul 19, 2004 2:13 pm</h4>
    <div class="postbody"><span class="postbody">I posted a small example application (to gbadev.org) that does exactly what is requested  (play a looping sound without audible clicks using double buffering and which is timed on VBLANK interrupt). It compiles with devkitadv and is written in C/C++ with a considerable amount of comments.
<br/>
<br/>
I haven't seen it up yet, but I guess it will be soon. If anyone is interested in it and can't wait, then drop me a line and I'll send it to you directly.
<br/>
<br/>
Cheers,
<br/>
Niels</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#23716 - poslundc - Mon Jul 19, 2004 2:22 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>gbawiz wrote:</b></span></td> </tr> <tr> <td class="quote">1. setup dma transfer &amp; counters
<br/>
2. timer 2 counts the number of samples being played by counting the overflows from timer 1 (which is outputing the sample rate).
<br/>
3. when timer 2 overloads after the size of my buffer then it will generate an interrupt.
<br/>
<br/>
The interrupt:
<br/>
This will stop the sample by flipping the enable bit of the DMA.
<br/>
The read and write buffer addresses are swapped and the new sample is mixed into the write buffer.
<br/>
the DMA transfer is restarted and reads from the read buffer.
<br/>
<br/>
--end interrupt ----
<br/>
<br/>
4. the whole process continues.</td> </tr></table><span class="postbody">
<br/>
<br/>
You need to remove the sound player from the act of playing a sample. The sound player should be running constantly in the background, examining a global memory location to see if there is a sound to play. If so, then it feeds the sound into your buffer, if not, it feeds zeros into the buffer. Once you have this system set up, you can start, stop, or loop a sound just by changing what is in that memory location. Your program will be much easier to debug once you have a proper sound engine in place.
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#23717 - gbawiz - Mon Jul 19, 2004 2:41 pm</h4>
    <div class="postbody"><span class="postbody">Thanks Dan :)
<br/>
<br/>
I was wondering, do you think that the 'calling of the ISR' can cause a delay which could then appear as a spike or click?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#23720 - poslundc - Mon Jul 19, 2004 4:42 pm</h4>
    <div class="postbody"><span class="postbody">If your player is running at 16 KHz, that would give your ISR exactly 1024 cycles in which to switch the DMA over to the next buffer before a sample must be played. Overhead to enter the ISR shouldn't be more than 50 cycles or so, and on the off chance your ISR is preempted by, say, an HBlank interrupt then that's another 250 cycles (if you are using multiple interrupts). Even in the worst-case scenario you should still have plenty of time to swap the DMA over to your other buffer.
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#23722 - SimonB - Mon Jul 19, 2004 5:12 pm</h4>
    <div class="postbody"><span class="postbody">JL's example code can be found on the main site now...
<br/>
<br/>
<a href="http://gbadev.org/index.php?ID=389" target="_blank">http://gbadev.org/index.php?ID=389</a>
<br/>
<br/>
Simon</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#23750 - dagamer34 - Tue Jul 20, 2004 10:03 pm</h4>
    <div class="postbody"><span class="postbody">That's a really good tutorial. I wish I knew how to make an audio mixer though.<br/>_________________<br/>Little kids and Playstation 2's don't mix. :(</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#23770 - gbawiz - Wed Jul 21, 2004 8:26 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>SimonB wrote:</b></span></td> </tr> <tr> <td class="quote">JL's example code can be found on the main site now...
<br/>
<br/>
<a href="http://gbadev.org/index.php?ID=389" target="_blank">http://gbadev.org/index.php?ID=389</a>
<br/>
<br/>
Simon</td> </tr></table><span class="postbody">
<br/>
<br/>
I have looked at the source code for the example and have figured out how it works.
<br/>
<br/>
The big nuisance is being able to choose the correct buffer size and sample frequency and the table provided is quite invaluable.
<br/>
<br/>
Thanks for providing this JL :)
<br/>
<br/>
Another question which i have is with regards to choosing a proper sample buffer size &amp; frequency.
<br/>
<br/>
I have a simple 50hz sine wave which has been sampled at exactly 22050hz.
<br/>
<br/>
I have set the REG_TM0D equal to (0xffff - 761) which should provide a frequency playback of 22050hz.
<br/>
<br/>
My buffer size is 22050 / 59.72727272 (approx 368 bytes)
<br/>
<br/>
However there is still some clicking noizes.
<br/>
<br/>
Is this frequency of 22050 supported?
<br/>
<br/>
Many thanks
<br/>
Gbawiz</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#23791 - tepples - Wed Jul 21, 2004 5:20 pm</h4>
    <div class="postbody"><span class="postbody">Sample buffers have to be an exact multiple of 16 bytes in size. The sample playback rate 16777216 Hz / 761 = 22046.3 Hz is supported, but if you use it, you'll have to switch buffers on a timer interrupt rather than on vblank. To find those few rates compatible with switching buffers on vblank, use <a class="postlink" href="http://www.pineight.com/gba/samplerates/" target="_blank">this tool</a>.
<br/>
<br/>
In practice, you'll find that many commercial games use 18157.16 Hz or 21024.08 Hz.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#23964 - jdxpolygon - Sun Jul 25, 2004 3:59 pm</h4>
    <div class="postbody"><span class="postbody">Hi
<br/>
<br/>
I haven't really had a chance to look at the source code example yet, I will do shortly, but before that I thought I'd add some of what I've discovered from trying to produce a click-free sound mixer.
<br/>
<br/>
Originally I was working with a sample rate of 16384, because I'd been lead to believe that I had to use a power of 2 sample rate to tie in best with the clock frequency and produce a clean sound. But obviously 16384Hz gave me a lot of clicking. Then I posted here a while ago stating my problems, and I was given the table of suitable sample rates, which at first seemed to work in fixing my mixer (done in assembly by the way), but I think at the time, the two sound buffers I had in memory were not being altered, I'd put in a very short test waveform (a triangular wave) into both buffers (same in each), and once I started using a recommended frequency value, it played very clearly, but once I switched the mixing function back on, it started to sound a bit crackly again - and from recording the output from VBA and analysing it a bit, it seemed like rather than random noise in my mixer output every 60th of a second, it was a tiny little snippet from somewhere else in (what would have been) the correct output, and I presumed that possibly for some reason the start of each 60th of a second of mixed sound seemed to be the equivalent samples from the other sound buffer - and obviously, beforehand, when the buffers were identical, this didn't create a problem. I'm still not entirely sure what happens (and it's a while since I worked on it, I tend to go and work on another element of my project when I get stuck), but I hope looking at the source provided on this site will help.
<br/>
<br/>
J</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#23971 - JL - Sun Jul 25, 2004 7:51 pm</h4>
    <div class="postbody"><span class="postbody">Hi jdxpolygon,
<br/>
<br/>
My sample doesn't really 'mix', it just plays one sample using 2 buffers over and over again. Mixing is necessary when you play more than one sample through the same DAC. Your problem sounds like:
<br/>
<br/>
-Either you're not copying enough (or all?) data in time into your buffers, causing the click every once in a while. If so, look at my sample, it should clear things up. Try putting your triangular wave in my sample and see if it reproduces your click (I hope it doesn't :-) ).
<br/>
<br/>
-If you're really mixing, then maybe your clipping doesn't work as expected? It's easy to mess things up once you're casting data from a short to a char or something like that.
<br/>
<br/>
The way I programmed my mod player was to first start with getting the sample to play continuously without clicking and then using that to play 'tracked' samples. Then I added more channels by building a mixer on top of the looping sound example.
<br/>
<br/>
I hope that puts you in the right direction.
<br/>
Cheers,
<br/>
Niels</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#24150 - Kayamon - Wed Jul 28, 2004 4:00 pm</h4>
    <div class="postbody"><span class="postbody">Just an extra note -
<br/>
<br/>
Make sure your sample buffers are 4-byte aligned. I was getting clicks for quite a while until I figured this one out.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
