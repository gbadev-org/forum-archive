<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Direct sound problem (Turning DMA off) - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>Audio > Direct sound problem (Turning DMA off)</h2>
<div id="posts">
<div class="post">
    <h4>#11601 - DennisBor - Mon Oct 13, 2003 4:43 pm</h4>
    <div class="postbody"><span class="postbody">At the moment, I'm trying to get direct sound to work on the GBA. Well, it works... half :). My sample plays just the way it should, but when it's finished I get noise, infinite...
<br/>
<br/>
I already know what the problem is. After the soundtrack is finished playing, the DMA channel should be turned of. Manually turning it off after playing the soundtrack works, but that's not the way it should work.
<br/>
<br/>
I suppose I need some counter, counting every played sample and if the counter has reached it's limit (end of the soundtrack, total # of samples of the soundtrack) it calls an function DMA.TurnOff().
<br/>
<br/>
Here's my code (don't know if you need it though)
<br/>
<br/>
<span style="font-weight: bold">gba.cpp</span>
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
/**
<br/>
 * Setup direct sound using the given parameters
<br/>
 *
<br/>
 * @param         Parameters            the parameters from which to
<br/>
 *                                 set up directsound
<br/>
 */
<br/>
void CSound::SetDirectSound(unsigned short Parameters)
<br/>
{
<br/>
   // set the direct sound control bits (memory address 0x04000082)
<br/>
   *(unsigned short*)DirectSoundControl = Parameters;
<br/>
}
<br/>
<br/>
/**
<br/>
 * Enable the GBA's sound system
<br/>
 */
<br/>
void CSound::Enable()
<br/>
{
<br/>
   // set bit 7 of the sound memory address 0x04000084 (32-bit value) to 1
<br/>
   *(unsigned long*)0x04000084 = 0x00000080;
<br/>
}
<br/>
<br/>
/**
<br/>
 * Start the Direct Sound
<br/>
 *
<br/>
 * @param         Frequency            sound sample frequency, eg: 22050
<br/>
 *
<br/>
 *               Wavedata            pointer to the wave data
<br/>
 */
<br/>
void CSound::Start(int Frequency, signed char* Wavedata)
<br/>
{
<br/>
   // set the DMA channel 1 address
<br/>
   *(unsigned long*)DMA1SourceAddrLow = (unsigned long)Wavedata;
<br/>
<br/>
   //set the destination address to fifo a address
<br/>
   *(unsigned long*)DMA1DestAddrLow = FIFOChannelALow;
<br/>
<br/>
   *(unsigned long*)DMA1ControlLow = EnableDMA | StartOnEmptyFIFO | WordDMA | DMARepeat;
<br/>
<br/>
   *(unsigned long*)IRQMasterEnable = 1;
<br/>
   *(unsigned short*)IRQEnable = IRQTimer1;
<br/>
<br/>
   // set the timer 1 countdown
<br/>
//   *(unsigned long*)Timer1Count = 65531;
<br/>
   //*(unsigned short*)Timer1 = EnableTimer  | TimerOverflow;
<br/>
<br/>
   *(unsigned short*)Timer0Count = (0xFFFF - 16777216 / Frequency);
<br/>
   *(unsigned short*)Timer0 = EnableTimer;
<br/>
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
<span style="font-weight: bold">main.cpp</span>
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#include "gba.h"
<br/>
#include "gba.cpp"
<br/>
#include "music.h"
<br/>
<br/>
/**
<br/>
 * Our main function
<br/>
 */
<br/>
int main()
<br/>
{
<br/>
   // initialize the GBA class
<br/>
   GBA myGBA;
<br/>
<br/>
   // set the Direct Sound Parameters
<br/>
   myGBA.Sound.SetDirectSound(SoundOutputRatio100 | 
<br/>
      DirectSoundAOutputRatio100 |
<br/>
      DirectSoundAOutputBoth | 
<br/>
      DirectSoundATimer0 | 
<br/>
      DirectSoundAFIFOReset);
<br/>
   
<br/>
   // turn the sound chip on
<br/>
   myGBA.Sound.Enable();
<br/>
<br/>
   // start the soundtrack (at 22050 kHz)
<br/>
   myGBA.Sound.Start(22050, myMusic.Data);
<br/>
<br/>
   // game loop
<br/>
   while(1)
<br/>
   {
<br/>
      // has the start button been pressed?
<br/>
      if (myGBA.Input.KeyPressed(KeypadStart))
<br/>
      {
<br/>
         // turn off the sound DMA channel (1)
<br/>
         DMA.TurnOff(Channel1);
<br/>
      }
<br/>
   }
<br/>
<br/>
   return 0;
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I really hope you guys can help me out![/code]<br/>_________________<br/>I rather have a compiler than a girl... A compiler isn't complaining all the time!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#11603 - sajiimori - Mon Oct 13, 2003 5:36 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
I rather have a compiler than a girl... A compiler isn't complaining all the time!
<br/>
</td> </tr></table><span class="postbody">
<br/>
What compiler do you use??
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
byte a, b;
<br/>
a = b + 1;
<br/>
<br/>
Error: cannot implicitly convert 'int' to 'byte'
<br/>
</td> </tr></table><span class="postbody">
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
void f() { g(); }
<br/>
void g() { puts("blah"); }
<br/>
<br/>
Warning: 'g' was previously declared to return 'int'
<br/>
</td> </tr></table><span class="postbody">
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
std::vector&lt;std::vector&lt;int&gt;&gt; x;
<br/>
<br/>
Error: You want to shift what to the right?  Are you stupid?
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
