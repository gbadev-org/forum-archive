<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Interrupt Problems - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>Audio > Interrupt Problems</h2>
<div id="posts">
<div class="post">
    <h4>#25383 - ProblemBaby - Sat Aug 21, 2004 7:44 pm</h4>
    <div class="postbody"><span class="postbody">It was to expensive to have "real" music so I have decided to make a mod player. I have succeeded to load xm files and I know how I should set up everything.
<br/>
<br/>
The hard part is the GBA stuff... I can play a sample with DMA but when I do a mod player I should manually write to FIFO_x, right?
<br/>
Well I cant get it to work. Here is my interrupt code.
<br/>
Ive not changed any settings from the DMA example, Ive enabled
<br/>
interrupts the function is called but it doesnt play anything.
<br/>
Its very, very bad written cause I just want it to work, optimazation comes later.
<br/>
<br/>
r3: a struct that look like this
<br/>
u32 Active
<br/>
u32 Address
<br/>
u32 Length
<br/>
u32 SampleCounter
<br/>
r2: 0x4000080
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
      LDR r3, =Sound
<br/>
      LDR r2, =REG_SOUNDBASE   
<br/>
      
<br/>
      LDR r1, [r3]
<br/>
      CMP r1, #1
<br/>
      BNE NoSample
<br/>
      
<br/>
      LDR r1, [r3, #12]
<br/>
      LDR r0, [r3, #4]
<br/>
      ADD r0, r0, r1
<br/>
      LDR r0, [r0]
<br/>
      STR r0, [r2, #REG_FIFO_A]
<br/>
      
<br/>
      LDR r1, [r3, #12]
<br/>
      ADD r1, r1, #4
<br/>
      STR r1, [r3, #12]
<br/>
<br/>
      LDR r0, [r3, #8]
<br/>
      CMP r1, r0
<br/>
      BLT NoSample
<br/>
      
<br/>
      MOV r1, #4
<br/>
      STR r1, [r3, #12]
<br/>
      
<br/>
      MOV r1, #0
<br/>
      STR r1, [r3, #0]
<br/>
<br/>
   NoSample:
<br/>
      BX lr
<br/>
</td> </tr></table><span class="postbody">
<br/>
You probably think that this is thumb code, but it isnt. My ARM knowlegde
<br/>
sucks so tips how to improve would also be great!
<br/>
and if you know any tutorial about this topic it also would be nice!
<br/>
<br/>
Thanks in advance!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#25384 - DekuTree64 - Sat Aug 21, 2004 8:34 pm</h4>
    <div class="postbody"><span class="postbody">Normally you don't want to write to the FIFO directly. I've gotten it to work before (in C, not ASM), but it super slow. What you want to do is create a buffer and mix sounds into that as needed, and DMA it to the FIFO. Most people just use a simple double buffer where each buffer is long enough for one frame's worth of samples. You can probably find a table of frequency/buffer size combos that times out perfectly with the time between VBlanks in one of the many mixer posts around here, but the most frequently used is 18157Hz, with a buffer of 304 bytes, and the sound timer set to 64612 (which is 65536 - (16777216 / 18157)). 
<br/>
<br/>
Now, for testing, all you need to do is wait for VBlank, swap the double buffer, and copy in 304 samples from the sound you want to play. 
<br/>
The swap is done just by stopping the DMA, setting the source address to the start of the next buffer, and restarting it.<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#25390 - ProblemBaby - Sat Aug 21, 2004 11:04 pm</h4>
    <div class="postbody"><span class="postbody">Thanks a lot!
<br/>
Ive got it to work Now I just wonder
<br/>
How to play a sample with a another frequency.
<br/>
I can change the timer but if I want to play two with different frequencies at the same time.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#25393 - DekuTree64 - Sat Aug 21, 2004 11:15 pm</h4>
    <div class="postbody"><span class="postbody">Just give me a little more time. After replying to your post earler, I decided to write up a little article series on sound system creation, and I have the first issue just about done. Since so many people will likely be tackling it for this compo, and I won't be able to resist answering all the questions, I may as well do it all in one go and have a nice reference for everyone later.
<br/>
<br/>
Although the first issue doesn't tackle resampling, so I guess I'll give a quick hint now: Use a fixed point position and increment, so you can play them at different speeds. Then add them together and divide by 2 to prevent overflow and you have the basics of a mixer.<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#25394 - ProblemBaby - Sat Aug 21, 2004 11:26 pm</h4>
    <div class="postbody"><span class="postbody">Thanks for the information I solved it.
<br/>
I aint that experienced in Audio so I had to ask that even cause it was quite simple to find out.
<br/>
<br/>
An article serie sounds really nice, Good luck!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#25405 - dagamer34 - Sun Aug 22, 2004 1:26 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>DekuTree64 wrote:</b></span></td> </tr> <tr> <td class="quote">Just give me a little more time. After replying to your post earler, I decided to write up a little article series on sound system creation, and I have the first issue just about done. Since so many people will likely be tackling it for this compo, and I won't be able to resist answering all the questions, I may as well do it all in one go and have a nice reference for everyone later.
<br/>
<br/>
Although the first issue doesn't tackle resampling, so I guess I'll give a quick hint now: Use a fixed point position and increment, so you can play them at different speeds. Then add them together and divide by 2 to prevent overflow and you have the basics of a mixer.</td> </tr></table><span class="postbody">
<br/>
<br/>
I look forward to your article. :)<br/>_________________<br/>Little kids and Playstation 2's don't mix. :(</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#25416 - ProblemBaby - Sun Aug 22, 2004 3:21 pm</h4>
    <div class="postbody"><span class="postbody">I got it to sound good in both no$gba and VBA however on real hardware I got some noise I think it is my scheme that is wrong it goes something like this:
<br/>
<br/>
Main Loop:
<br/>
UpdateSound
<br/>
VBlankIntr
<br/>
DoOtherStuff
<br/>
goto Main Loop
<br/>
<br/>
<br/>
UpdateSound:
<br/>
if Buffer1 is playing write new data to Buffer2
<br/>
if Buffer2 is playing write new data to Buffer1
<br/>
StopDMA
<br/>
if Buffer1 is playing then change SAD to Buffer2
<br/>
if Buffer2 is playing then change SAD to Buffer1
<br/>
StartDMA
<br/>
<br/>
IS it something that I should change, you think?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#25424 - DekuTree64 - Sun Aug 22, 2004 6:24 pm</h4>
    <div class="postbody"><span class="postbody">Hmm, sounds like you're doing things in the wrong order. The buffer swap should be done first thing in your VBlank interrupt, so the time between swaps is always exactly the same. It's usually best to keep the swap and data writing in seperate functions, since the swap is very time-critical but doesn't take very long, and the data writing is not time critical, but takes a long time to do. You can leave the data writing where it is, just the swap needs to be moved.<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
