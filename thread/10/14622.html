<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>audio double buffer via dma - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>Audio > audio double buffer via dma</h2>
<div id="posts">
<div class="post">
    <h4>#146397 - bpoint - Mon Dec 03, 2007 5:02 pm</h4>
    <div class="postbody"><span class="postbody">Hello all,
<br/>
<br/>
I've been going over a lot of the posts in these forums to get an idea of the best way to pipe my mixer's output to the GBA.  Deku's tutorial was actually quite helpful (thanks Deku!).
<br/>
<br/>
It seems the most common methods of swapping buffers is to either set up a separate timer (wasteful?) or to latch onto the VBlank, since it's there already and is most likely already in use.  However, I haven't seen any methods at all anywhere which drive the buffer swapping by having the DMA generate interrupts upon completion.
<br/>
<br/>
Is there some underlying reason why no one uses this method?  I'm currently testing a few things out myself right now, but I'd like to know if anyone's tried this before.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146449 - bpoint - Tue Dec 04, 2007 11:28 am</h4>
    <div class="postbody"><span class="postbody">Well, after a bit of playing around, it seems the word count in the DMAxCNT_L register is ignored when DMA'ing to the sound FIFOs (gbatek mentions this too, even though it's easy to miss).
<br/>
<br/>
If DMA interrupts are enabled, an interrupt is generated after each 16 bytes are DMA'ed to the sound FIFOs (at least using the emulators I tested [VBA, no$gba, and AdvDbg] -- don't know about real hardware).  I guess it would be possible to use the DMA interrupt as a counter, then swap buffers at the right time, but that's still a lot of interrupt overhead for just incrementing a counter.
<br/>
<br/>
...which is, I guess why no one uses this method.  :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146451 - Lick - Tue Dec 04, 2007 12:18 pm</h4>
    <div class="postbody"><span class="postbody">Thanks for this investigation! :)<br/>_________________<br/><a class="postlink" href="http://licklick.wordpress.com" target="_blank">http://licklick.wordpress.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146466 - eKid - Tue Dec 04, 2007 4:50 pm</h4>
    <div class="postbody"><span class="postbody">indeed, each method has its flaws
<br/>
<br/>
-----------------------------------------------------
<br/>
counting dma transfers:
<br/>
<br/>
pros:
<br/>
accurate
<br/>
<br/>
cons:
<br/>
tons of interrupts, huge overhead
<br/>
<br/>
------------------------------------------------
<br/>
resetting with timer (timer can count up from sampling timer):
<br/>
<br/>
pros:
<br/>
accurate
<br/>
<br/>
cons:
<br/>
uses a timer
<br/>
<br/>
-------------------------------------------------
<br/>
resetting at vblank
<br/>
<br/>
pros:
<br/>
in sync with frames (can be done without interrupts)
<br/>
<br/>
cons:
<br/>
inaccurate, playback rate must be tweaked to a certain rate for click free playback.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146470 - kusma - Tue Dec 04, 2007 5:14 pm</h4>
    <div class="postbody"><span class="postbody">I'd like to add the con for the timer solution: Unstable timing for the client-application.
<br/>
<br/>
The accuracy of the resetting-at-vblank can be solved by varying the size of the buffer used at every frame. The variation will be small, so it's not really a problem for buffer-sizes. Just calculate how many samples the hardware has played already with a sub-sample precision, and reset accordingly. It's all very predictable, so buffers can be filled correctly with the same logic. But to be honest, I'm personally not too worried about limiting the sample rates to those who are "click free".</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
