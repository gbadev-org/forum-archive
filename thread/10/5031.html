<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Optimizing - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>Audio > Optimizing</h2>
<div id="posts">
<div class="post">
    <h4>#35951 - ProblemBaby - Sun Feb 13, 2005 3:34 pm</h4>
    <div class="postbody"><span class="postbody">Hi
<br/>
<br/>
Now Ive tried a lot of techniques to mix channels in stereo as fast as possible and I cant get under about 2,8%/channel with a mixing rate of 31536hz but for 32 channels its to much! about 90%.
<br/>
More then 2% is spended at 'Load sample from ROM'
<br/>
and 'Multiplication with Volume'!
<br/>
<br/>
One way to omptimze would be to checn if the increment is lower then 1 and then load a sample only if it have advanced, But is it wort it mose cases? 
<br/>
<br/>
do you have any other ideas how to speed up? decreasing the Loades and Multiplications!
<br/>
<br/>
thanks in advance</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#35989 - DekuTree64 - Sun Feb 13, 2005 10:13 pm</h4>
    <div class="postbody"><span class="postbody">Predictable as it may be, I shall reply :)
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>ProblemBaby wrote:</b></span></td> </tr> <tr> <td class="quote">Now Ive tried a lot of techniques to mix channels in stereo as fast as possible and I cant get under about 2,8%/channel with a mixing rate of 31536hz but for 32 channels its to much! about 90%.
<br/>
More then 2% is spended at 'Load sample from ROM'
<br/>
and 'Multiplication with Volume'!</td> </tr></table><span class="postbody">
<br/>
That's really not half bad, but there's still plenty of room for improvement. Probably around 40-50% is the best you can expect to get for 32 channels.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">One way to omptimze would be to checn if the increment is lower then 1 and then load a sample only if it have advanced, But is it wort it mose cases?</td> </tr></table><span class="postbody">
<br/>
Yes, that will help. Espcially at ~32KHz, you'll probably be using increments less than 1 more often than not.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">do you have any other ideas how to speed up? decreasing the Loades and Multiplications!</td> </tr></table><span class="postbody">
<br/>
Are you using stereo? A classic trick to save on multiplies is to put the left volume in the lower 16 bits of a register, and the right volume in the upper 16 bits. Then you get both multiplies/adds at once. You can also do a similar trick in mono by putting 2 samples into the reg and then multiplying by the single volume.
<br/>
<br/>
The problem with those is that your entire mix has to fit in 16 bits, and if you have an 8-bit sample times a 6-bit volume, you get a 14-bit result. That only leaves room for up to 4 channels (2 more bits), unless you shift down, and if you shift, you have to chop off the bottom bits of the top sample so they don't run into the bottom.
<br/>
<br/>
One possibility is to batch the channels 4 at a time, mixing into temporary buffers, and then add up the temporary buffers with full 32-bit accuracy. It would be a little slow doing 2 passes, but for 32 channels the savings might pay off (although you'd need 528smps*2bytes*2sides*32chns/4at a time=16896 bytes of temporary buffers for 32 stereo channels).
<br/>
<br/>
<br/>
And then there's dynamic code. I'm not too good with it yet, but do look for ways to speed things up by replacing instructions/generating whole loops/etc.<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#35994 - tepples - Sun Feb 13, 2005 10:23 pm</h4>
    <div class="postbody"><span class="postbody">If you're up to 32 channels, many of them music, then you should probably consider some streaming audio compression method.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#35996 - ProblemBaby - Sun Feb 13, 2005 11:09 pm</h4>
    <div class="postbody"><span class="postbody">DekuTree64:
<br/>
<br/>
Yes, Ive checked and seen that samples often is played with a increment lower then 1.
<br/>
Ive also made one other nice speed improvements first it seems like a CpuFastCopy doesnt take much time at all so I copy from ROM to IWRAM and then load it from there thats about 0,7%</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#36068 - ProblemBaby - Mon Feb 14, 2005 8:31 pm</h4>
    <div class="postbody"><span class="postbody">I am a bit confused.
<br/>
When I use CpuFastCopy it looks like it doesnt take time at all but it runs damn slow, are timers stopped when processing BIOS functions or something?
<br/>
<br/>
It works fine in VBA but not in either NG or Real GBA
<br/>
I do a CpuFastSet 8-9 times frame, and copy 1024 bytes!
<br/>
<br/>
Any ideas?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#36107 - Miked0801 - Tue Feb 15, 2005 2:11 am</h4>
    <div class="postbody"><span class="postbody">More than likely, the emulators are doing a local fast assembler version of the functions which don't reflect actual speed on target (Nintendo copyright issues prevent direct inclusion of this code.)  No$GBA allows you to include a ROM BIOS file to reflect actual performace.  Not sure on others.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#36167 - ProblemBaby - Tue Feb 15, 2005 4:59 pm</h4>
    <div class="postbody"><span class="postbody">Miked0801: Thanks a lot for the replay!
<br/>
I fixed so It worked in No$Gba in no time
<br/>
but at real GBA it was 34%=)
<br/>
It felt like magic that copying that much data should take no time!
<br/>
So I will trash that idea..</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
