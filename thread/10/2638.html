<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Strange MOD Header Problem - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>Audio > Strange MOD Header Problem</h2>
<div id="posts">
<div class="post">
    <h4>#14685 - Krakken - Sun Jan 11, 2004 9:33 am</h4>
    <div class="postbody"><span class="postbody">Hey,
<br/>
<br/>
I've just started making myself a MOD player but have come accross a very strange problem. I'll try to explain it as best I can.
<br/>
<br/>
I am trying to load the header of the MOD file into a struct I have made with the help of a file format guide. I have checked and rechecked the guide and all seems well with the header.
<br/>
<br/>
The relevant code I am using is below: 
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
extern const char RES_MOD[];
<br/>
<br/>
<br/>
typedef struct _xSample {
<br/>
    char    cName[22];
<br/>
    ushort  iLength;
<br/>
    char    cFineTune;
<br/>
    uchar   cVolume;
<br/>
    uint    wOffset;
<br/>
} xSample, *pxSample;    
<br/>
<br/>
typedef struct _xMOD {
<br/>
    char    cTitle[20];
<br/>
    xSample xSampleList[15];
<br/>
    char    cPatternCount;
<br/>
    char    cEndPos;
<br/>
    char    cPatternTable[128];
<br/>
} xMOD, *pxMOD;    
<br/>
<br/>
<br/>
xMOD *xmFile = RES_MOD;
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
The first instrument "appears" to load okay with the data shown as:
<br/>
<br/>
<span style="color: darkred">
<br/>
<span style="font-weight: bold">NAME:</span> Dream Guitar 1
<br/>
<span style="font-weight: bold">LENGTH:</span> 16421
<br/>
<span style="font-weight: bold">FINETUNE:</span> 0
<br/>
<span style="font-weight: bold">VOLUME:</span> 64
<br/>
<span style="font-weight: bold">OFFSET:</span> 1917112588
<br/>
</span>
<br/>
<br/>
The problem I have is when loading each subsequent sample. For example the second and third samples load as:
<br/>
<br/>
<span style="color: darkred">
<br/>
<span style="font-weight: bold">NAME:</span> eam Guitar 2  <span style="font-style: italic">(Should Be: "Dream Guitar 2")</span>
<br/>
<span style="font-weight: bold">LENGTH:</span> 16384
<br/>
<span style="font-weight: bold">FINETUNE:</span> 0
<br/>
<span style="font-weight: bold">VOLUME:</span> 0
<br/>
<span style="font-weight: bold">OFFSET:</span> 1394625862
<br/>
</span>
<br/>
<br/>
<span style="color: darkred">
<br/>
<span style="font-weight: bold">NAME:</span> lap Bass  <span style="font-style: italic">(Should Be: "FM Slap Bass")</span>
<br/>
<span style="font-weight: bold">LENGTH:</span> 0
<br/>
<span style="font-weight: bold">FINETUNE:</span> 0
<br/>
<span style="font-weight: bold">VOLUME:</span> 1
<br/>
<span style="font-weight: bold">OFFSET:</span> 1953391980
<br/>
</span>
<br/>
<br/>
As you may have noticed it seems to cut 2 bytes off of each sample struct. To combat this I tried taking away 2 bytes from the sample struct. This produced results where it did the complete opposite and <span style="font-weight: bold">added</span> 2 bytes to each sample struct.
<br/>
<br/>
I have no idea why it won't work. Can anyone help? This is what i'm following:
<br/>
<a href="http://www.wotsit.org/search.asp?page=5&amp;s=music" target="_blank">http://www.wotsit.org/search.asp?page=5&amp;s=music</a> (2nd File Down)
<br/>
<br/>
Thanks, Nat.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#14690 - poslundc - Sun Jan 11, 2004 3:01 pm</h4>
    <div class="postbody"><span class="postbody">How are you "loading" them into the structure? I have sometimes run into very similar problems when trying to directly load arrays of structures that included strings.
<br/>
<br/>
Make sure that your strings are padded to the necessary byte length in your data file. If that fails, try removing the names from your structure and data (which is what I eventually did, and it got it working).
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#14691 - Krakken - Sun Jan 11, 2004 3:29 pm</h4>
    <div class="postbody"><span class="postbody">Hi, 
<br/>
<br/>
Thanks for your reply. I talked with JSensebe on the IRC channel and he explained to me what it almost certainly is.
<br/>
<br/>
You see, the ARM processor, for efficiency, cannot read a variable that is not aligned to an boundry offset of its own size.
<br/>
<br/>
<span style="color: darkred">
<br/>
A "word" (<span style="font-weight: bold">4</span> bytes) can only be placed at memory positions with an offset of a multiple of <span style="font-weight: bold">4</span>: 0, 4, 8, 12, 16 etc.
<br/>
<br/>
A "halfword" (<span style="font-weight: bold">2</span> bytes) is the same but can only be offset on a multiple of <span style="font-weight: bold">2</span>: 0, 2, 4, 6, 8 etc.
<br/>
</span>
<br/>
<br/>
If you look closely at my sample struct:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
typedef struct _xSample { 
<br/>
    char    cName[22]; 
<br/>
    hword   iLength; 
<br/>
    char    cFineTune; 
<br/>
    uchar   cVolume; 
<br/>
    word   wOffset; 
<br/>
} xSample, *pxSample; 
<br/>
</td> </tr></table><span class="postbody">
<br/>
You will see that cName is at byte 0, iLength is at byte 22, cFineTune - byte 24, cVolume - byte 25, wOffset - byte *26* and the size of the struct is *30* bytes.
<br/>
<br/>
The compiler, so that the struct is compatible with the ARM processor, will offset wOffset to byte 28 (therefore making the total size of the struct, 32 bytes) so that it lies on the "<span style="font-weight: bold">word</span>" boundary (0, 4, 8, 12, 16, 20, 24, <span style="font-weight: bold">28</span>) as the processor cannot read byte 26 to get a word value.
<br/>
<br/>
The first thing I tried, was to split wOffset into two "halfwords" wOffset_L and wOffset_H so that both would lie on the "<span style="font-weight: bold">halfword</span>" boundary (0, 2, 4, ... 22, 24, <span style="font-weight: bold">26</span>, <span style="font-weight: bold">28</span>). Unfortunately I overlooked the fact that the struct was only 30 bytes in total. The compiler, again, would be padding that to 32 bytes so that the data could be read by the processor.
<br/>
<br/>
You said you took out the names from the file and struct and it worked. That would have set the struct to (30 - 22) 8 bytes which is compatible with the processor.
<br/>
<br/>
Hope this explains it,
<br/>
Nat.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#14692 - poslundc - Sun Jan 11, 2004 3:39 pm</h4>
    <div class="postbody"><span class="postbody">Yeah, mine wasn't an issue with struct padding; it had something to do with the way the compiler was assigning constant strings to the structures. The struct I had already took alignment into account.
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#15597 - SmileyDude - Sun Jan 25, 2004 11:43 pm</h4>
    <div class="postbody"><span class="postbody">Whenever you find that GCC is sticking in extra padding when you don't want it, you can always put a #pragma pack(0) before the struct declaration, and a #pragma pack(4) at the end to reset it back to normal.  The ARM doesn't like mis-alligned data, but GCC can generate code to access the mis-alligned data.  This is a bit slower, but when you need to read/write to a specific external format, it's probably the best way to go.<br/>_________________<br/>dennis</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
