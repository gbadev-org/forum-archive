<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Code to change square wave volume without reset artifacts - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>Audio > Code to change square wave volume without reset artifacts</h2>
<div id="posts">
<div class="post">
    <h4>#168841 - Dwedit - Thu May 28, 2009 10:07 pm</h4>
    <div class="postbody"><span class="postbody">I've written a new program that sets the GBC Square Wave channels' frequency and volume independently, without using volume envelopes. Normally, you need to reset the waveform in order to change the volume for the square channels.
<br/>
I've written a test program that calculates the exact time it's okay to reset the phase of the wave with no artifacts, then performs the write to change the volume at that time.
<br/>
<br/>
The program itself isn't anything special, it just plays a chord of two square waves repeatedly, but it sounds correct on hardware, and fails miserably on current builds of VBA. I'm about to revise PocketNES to use this method for sound.
<br/>
<br/>
The basic algorithm:
<br/>
You have the Sound Period for the GB channel
<br/>
Multiply it by 16
<br/>
That's your timer frequency (Negate it before you use it as a timer reload value obviously)
<br/>
Add some "fudge" factor to set the initial value of the timer. I'm using 192.
<br/>
Whenever you write to the sound register, set the timer's initial value and restart the sound channel at the same time.  Then you can put the correct reload value in after you've added the fudged initial timer value.
<br/>
When you want to change the sound, enable IRQs for that timer.
<br/>
The interrupt handler for the timer will wait until the exact instant it should rewrite the sound register and timer. If the timer interrupt triggered too late, wait one more waveform before trying again.
<br/>
<br/>
<a class="postlink" href="http://www.dwedit.org/dwedit_board/attachment.php?item=278" target="_blank">Attachment</a><br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
