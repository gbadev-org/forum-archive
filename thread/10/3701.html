<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>When to turn off/on DMA for continuous sound? - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>Audio > When to turn off/on DMA for continuous sound?</h2>
<div id="posts">
<div class="post">
    <h4>#23379 - JL - Sun Jul 11, 2004 10:57 am</h4>
    <div class="postbody"><span class="postbody">Hi guys,
<br/>
<br/>
I have a soundplayer routine that gets called every VSYNC, each call writes new sample data into the buffer that is going to be played. On each call, I stop the DMA and timer, swap the buffers and enable DMA and timer.
<br/>
<br/>
Now, when I play a 'zero-filled' sample (=no sound). I still hear a (although very distant) click. I suspect the switching on/off of the DMA and timer are causing this. Is there a way to avoid this?
<br/>
<br/>
Do I have to use an interrupt to get 'spot-on' vsync timing (I'm now waiting for it in a loop)? Or is there something else I'm missing?
<br/>
<br/>
Cheers,
<br/>
Niels</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#23381 - poslundc - Sun Jul 11, 2004 1:42 pm</h4>
    <div class="postbody"><span class="postbody">You shouldn't ever touch the timer that the sound chip is using as its pulse. That is what is probably causing your click.
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#23394 - JL - Sun Jul 11, 2004 9:26 pm</h4>
    <div class="postbody"><span class="postbody">Hi Dan,
<br/>
<br/>
Thanks for your reply, however, when I comment out stopping the timer the noise still is there. But it doesn't change anything so you're right about not touching the timers. I guess, stopping both the DMA and timer comes from a 'play one single wav' example that I used as starting point.
<br/>
<br/>
The clicking (thumping more, really)  is very distant but I checked some games and they don't have the clicking so it must be something in my code....
<br/>
<br/>
Below, I added the code that is called every vblank. I'm switching the buffers first before copying data into them. Maybe that's the problem (but then, if they're zero-filled that should matter).
<br/>
<br/>
Does anyone see any odd things in my code? 
<br/>
<br/>
Once 'we' get this fixed I intend to put up the sources for download as I can't really find a simple example doing continuous sound on the GBA and most people seem to have trouble with this.
<br/>
<br/>
Grtz,
<br/>
Niels
<br/>
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
void ModPlayer::replay()
<br/>
{   
<br/>
   // stop the sound:
<br/>
//   REG_TM0CNT = 0;
<br/>
   //flip to disable 
<br/>
   REG_DMA1CNT ^= ENABLE_DMA; 
<br/>
   // Set the buffer that was filled out previously and restart the DMA
<br/>
   REG_DMA1SAD = (u32)(buf1Playing ? buf2 : buf1);
<br/>
   //flip to enable 
<br/>
   REG_DMA1CNT ^= ENABLE_DMA; 
<br/>
//   REG_TM0CNT = TIMER_ENABLED;
<br/>
   SampleCounter = 0;   
<br/>
   
<br/>
   // swap
<br/>
   buf1Playing = buf1Playing ? false : true;
<br/>
   
<br/>
   if (buf1Playing)
<br/>
   {
<br/>
      for (int i=0;i&lt;BUFSIZE;i++)
<br/>
      {
<br/>
         
<br/>
         buf2[i] = zeroSound ? 0 : waver[SamplePosition];
<br/>
         SamplePosition++;
<br/>
         if (SamplePosition &gt;= SampleLength)
<br/>
         {
<br/>
            SamplePosition = 0;
<br/>
         }
<br/>
      }
<br/>
   }
<br/>
   else
<br/>
   {
<br/>
      for (int i=0;i&lt;BUFSIZE;i++)
<br/>
      {
<br/>
         buf1[i] = zeroSound ? 0 : waver[SamplePosition];
<br/>
         SamplePosition++;
<br/>
         if (SamplePosition &gt;= SampleLength)
<br/>
         {
<br/>
            SamplePosition = 0;
<br/>
         }
<br/>
      }
<br/>
   }         
<br/>
<br/>
   if(!(KEYS &amp; KEY_START) &amp;&amp;
<br/>
      (prevKeyPress &amp; KEY_START)
<br/>
      )
<br/>
    {
<br/>
      zeroSound = zeroSound ? false: true;
<br/>
      SamplePosition = 0;
<br/>
   }
<br/>
<br/>
   if(!(KEYS &amp; KEY_A) &amp;&amp;
<br/>
      (prevKeyPress &amp; KEY_A)
<br/>
      )
<br/>
    {
<br/>
      waver = (signed char*)waver1;
<br/>
      SampleLength = 6612;
<br/>
      SamplePosition = 0;
<br/>
   }
<br/>
<br/>
   if(!(KEYS &amp; KEY_B) &amp;&amp;
<br/>
      (prevKeyPress &amp; KEY_B)
<br/>
      )
<br/>
    {
<br/>
      waver = (signed char*)waver2;
<br/>
      SampleLength = 242420;
<br/>
      SamplePosition = 0;
<br/>
   }
<br/>
<br/>
   prevKeyPress = KEYS;
<br/>
 
<br/>
   SampleCounter++;
<br/>
<br/>
}
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#23397 - gb_feedback - Sun Jul 11, 2004 10:31 pm</h4>
    <div class="postbody"><span class="postbody">Might be worth asking what BUFSIZE is...<br/>_________________<br/><a class="postlink" href="http://www.bookreader.co.uk/" target="_blank">http://www.bookreader.co.uk/</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#23398 - poslundc - Sun Jul 11, 2004 10:40 pm</h4>
    <div class="postbody"><span class="postbody">Nothing seems glaringly incorrect about it. Are you certain you are
<br/>
<br/>
- Calling it at the right time (ie. at the beginning of VBlank, preferably with an interrupt)
<br/>
- Have the timer set to the correct frequency to match your buffer size
<br/>
<br/>
These are two good sources of error to produce the kind of effect you are describing.
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#23403 - DekuTree64 - Mon Jul 12, 2004 2:29 am</h4>
    <div class="postbody"><span class="postbody">It's probably a slight timing error. There are only a few frequencies that time out perfectly to restart the DMA on VBlank. Tepples made a tool for finding them, which can be found at <a class="postlink" href="http://www.pineight.com/gba/samplerates/" target="_blank">http://www.pineight.com/gba/samplerates/</a>. The most commonly used is 18157Hz with a buffer size of 304 bytes. 
<br/>
I would suggest using that for now, but it is possible to play at any frequency without clicks using a timer interrupt. It is best to keep the mixing synchronized to VBlank though, because it takes a lot of time and could cause problems if it was happening at different places every frame. Then, instead of using a 'double buffer', you get more of a 'circular buffer', and just mix a frame's worth of samples into it on VBlank, and let the timer wrap it back around to the start whenever it hits the end. You do end up running into the end of the buffer half way through mixing sometimes, but you can just mix in two batches if needed.<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#23413 - JL - Mon Jul 12, 2004 10:21 am</h4>
    <div class="postbody"><span class="postbody">Thanks for the hints, I'll try them asap. 
<br/>
<br/>
As for the buffersize, it shouldn't really matter should it? Assuming that the buffers are large enough to accomodate for more than what reasonably can be played in each timeslot and they're totally filled out with zero's then no click should be hearable.
<br/>
<br/>
I'm waiting for the vblank to occur, I might change that into an interrupt routine just to see if that makes any difference.
<br/>
<br/>
I'll keep you guys posted!
<br/>
Niels
<br/>
<br/>
Just for completeness sake, here's my 'init' function.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
<br/>
static int BUFSIZE=132;
<br/>
<br/>
void ModPlayer::replayWav(unsigned char* wav1, unsigned char* wav2)
<br/>
{
<br/>
    // Enable and reset Direct Sound channel A, at full volume, using
<br/>
    // timer 0 to determine frequency
<br/>
    REG_SOUNDCNT_H = SND_OUTPUT_RATIO_100 |
<br/>
                     DSA_OUTPUT_RATIO_100 |
<br/>
                     DSA_OUTPUT_TO_BOTH |
<br/>
                     DSA_TIMER0 |
<br/>
                     DSA_FIFO_RESET;
<br/>
<br/>
   waver1 = wav1;
<br/>
   waver2 = wav2;
<br/>
<br/>
   //enable all sound
<br/>
    REG_SOUNDCNT_X = SND_ENABLED;
<br/>
<br/>
    // Start the DMA transfer.
<br/>
   waver = (signed char*) waver1;
<br/>
    REG_DMA1DAD = (u32)REG_FIFO_A;
<br/>
<br/>
   //write 32 bits into destination every vblank
<br/>
    REG_DMA1CNT = ENABLE_DMA | START_ON_FIFO_EMPTY | WORD_DMA | DMA_REPEAT | DEST_REG_SAME;
<br/>
<br/>
    // Set the timer to overflow at the appropriate frequency and start it
<br/>
   // From forum.gbadev.org:
<br/>
   //
<br/>
   // timer            CPU freq   mix freq   buf size 
<br/>
   // 63408 = 65536 - (16777216 / 7884),     132 
<br/>
    REG_TM0D   = 63408; 
<br/>
<br/>
   // Set the length of the sample and start from zero.
<br/>
   SampleLength = 6612;
<br/>
   SamplePosition = 0;
<br/>
   samples = 16777216 / 7884; // (=2128)
<br/>
<br/>
   // Fill out buf2
<br/>
   for (int i=0;i&lt;BUFSIZE;i++)
<br/>
   {
<br/>
      buf2[i] = waver[SamplePosition];
<br/>
      SamplePosition++;
<br/>
      if (SamplePosition &gt;= SampleLength)
<br/>
      {
<br/>
         SamplePosition = 0;
<br/>
      }
<br/>
   }
<br/>
   // Fill out buf1
<br/>
   for (int i=0;i&lt;BUFSIZE;i++)
<br/>
   {
<br/>
      buf1[i] = waver[SamplePosition];
<br/>
      SamplePosition++;
<br/>
      if (SamplePosition &gt;= SampleLength)
<br/>
      {
<br/>
         SamplePosition = 0;
<br/>
      }
<br/>
   }
<br/>
   SampleCounter = 0;
<br/>
<br/>
   // We start playing from buf2
<br/>
   buf1Playing = false;
<br/>
    REG_DMA1SAD = (u32)buf2;
<br/>
<br/>
   //enable the timer
<br/>
    REG_TM0CNT = TIMER_ENABLED;
<br/>
}
<br/>
<br/>
<br/>
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#23415 - gb_feedback - Mon Jul 12, 2004 12:02 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">As for the buffersize, it shouldn't really matter should it? </td> </tr></table><span class="postbody">
<br/>
I think the point is that the dma transfers 16 bytes at a time, so your buffer length needs to be a multiple of 16, else you can't have an integral number of dma transfers per vblank.<br/>_________________<br/><a class="postlink" href="http://www.bookreader.co.uk/" target="_blank">http://www.bookreader.co.uk/</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#23416 - JL - Mon Jul 12, 2004 12:37 pm</h4>
    <div class="postbody"><span class="postbody">Hi gb_feedback,
<br/>
<br/>
How come the DMA transfers 16 bytes at a time? 
<br/>
<br/>
I specify WORD_DMA in the DMA setup, so I'd expect 32 bits (or 4 bytes if you will) to be transfered each DMA.
<br/>
<br/>
Did I completely overlook something?
<br/>
<br/>
Thnx,
<br/>
Niels</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#23417 - poslundc - Mon Jul 12, 2004 12:38 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>gb_feedback wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">As for the buffersize, it shouldn't really matter should it? </td> </tr></table><span class="postbody">
<br/>
I think the point is that the dma transfers 16 bytes at a time, so your buffer length needs to be a multiple of 16, else you can't have an integral number of dma transfers per vblank.</span></td> </tr></table><span class="postbody">
<br/>
<br/>
O_o
<br/>
<br/>
#1 DMA transfers either 16 or 32 bits at a time, not 16 bytes.
<br/>
<br/>
#2 the buffer needs to be a multiple of 4, not 16... since 4 bytes is how many samples the DMA transfers into the FIFO when it is activated
<br/>
<br/>
#3 The greater impacting factor on buffer size, as DT64 pointed out, is the frequency at which both your mixer and the sound chip run at.
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#23418 - gb_feedback - Mon Jul 12, 2004 1:52 pm</h4>
    <div class="postbody"><span class="postbody">If the DMA is in sound FIFO transfer mode 4 words of data are transferred. The DMA WORD COUNT is ignored.<br/>_________________<br/><a class="postlink" href="http://www.bookreader.co.uk/" target="_blank">http://www.bookreader.co.uk/</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#23419 - poslundc - Mon Jul 12, 2004 2:24 pm</h4>
    <div class="postbody"><span class="postbody">Okay...
<br/>
<br/>
Let's try it this way. The sound FIFO is 4 bytes (1 word) long. Where are the remaining twelve bytes (3 words) transferred to, exactly?
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#23421 - gb_feedback - Mon Jul 12, 2004 2:40 pm</h4>
    <div class="postbody"><span class="postbody">Well. The sound FIFO *input register* is 32 bits wide. The FIFO is 8 words long. When it empties so that there is room for 4 words, a DMA of 4 words is initiated.<br/>_________________<br/><a class="postlink" href="http://www.bookreader.co.uk/" target="_blank">http://www.bookreader.co.uk/</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#23424 - poslundc - Mon Jul 12, 2004 3:28 pm</h4>
    <div class="postbody"><span class="postbody">Ah, interesting! This is not mentioned on most of the GBA audio pages. So then would multiple str statments to the FIFO register be able to fill up to 16 bytes of data in an interrupt-driven mixer? If so, that could vastly change my strategy for mixer/player writing.
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#23425 - gb_feedback - Mon Jul 12, 2004 3:38 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">So then would multiple str statments to the FIFO register be able to fill up to 16 bytes of data in an interrupt-driven mixer? </td> </tr></table><span class="postbody">
<br/>
Logically yes, although I've never tried it. It certainly should cut down on interrupt overhead. I have to admit that I never got on with interrupt driven mixers. Mine kept locking up, and then I figured out just how much time gets lost in all those interrupts. If my mixer had worked first time, I'd still be doing that way I guess. But you must be using assembler, which I've always been too lazy to learn (on this processor). That's got to be a big help!<br/>_________________<br/><a class="postlink" href="http://www.bookreader.co.uk/" target="_blank">http://www.bookreader.co.uk/</a></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
