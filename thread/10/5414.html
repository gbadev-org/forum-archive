<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>sound using interrupts - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>Audio > sound using interrupts</h2>
<div id="posts">
<div class="post">
    <h4>#39669 - nico - Mon Apr 11, 2005 8:17 am</h4>
    <div class="postbody"><span class="postbody">Hi,
<br/>
<br/>
I set up some code for playing sound effects copying the data with the help of interrupts, as I am using the Xport and I need the GBA to react to other interrupts, and as far as I know if using DMA an interrupt is not processed until DMA is finished.
<br/>
However, I only get some crappy noise playing. My idea was to set Timer0 to 1024 mode so it gives a signal of 16.387 or so kHz (I dont remember the exact value).
<br/>
Then, I set the Timer0 counter to 0xfffc, and configured Timer1 so it is called every time Timer0 overflows, namely after 4 cycles. I then update the FIFO_A Register with raw data from an array. 
<br/>
<br/>
Heres the code:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
if(REG_IF &amp; INT_TM0) {
<br/>
        REG_IF = INT_TM0;
<br/>
         
<br/>
        tm0count++;
<br/>
         
<br/>
        REG_SGFIFOA_L = (_test[tm0count*4] &amp; 0xFF) + (_test[tm0count*4+1]&lt;&lt;8 &amp; 0xFF00);
<br/>
        REG_SGFIFOA_H = (_test[tm0count*4+2] &amp; 0xFF) + (_test[tm0count*4+3]&lt;&lt;8 &amp; 0xFF00);
<br/>
                 
<br/>
         }
<br/>
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
and in the main function
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
REG_SGCNT0_H = 0x0b0F;
<br/>
    
<br/>
   REG_SGFIFOA_L = 0;
<br/>
   REG_SGFIFOA_H = 0;
<br/>
   REG_SGCNT1 = 0x0080;
<br/>
   
<br/>
<br/>
    REG_TM0D = 0xfffe;  // interrupt every 4x16.387 kHz
<br/>
    SetTimerMode0(TIME_FREQUENCY_1024 | TIME_ENABLE | TIME_IRQ_ENABLE);
<br/>
    REG_TM1D = 0xd008;
<br/>
    SetTimerMode1(TIME_ENABLE | TM_CASCADE | TIME_IRQ_ENABLE );  
<br/>
<br/>
REG_IME = 0x00;   
<br/>
REG_IE = (INT_TM3 | INT_TM0 | INT_TM1 | INT_CART);    
<br/>
   REG_IF = 0xffff;                                               // Sets all Flags back
<br/>
    REG_IME = 1;                                                   // enables Interrupts
<br/>
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
any idea what the problem is?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#39671 - ampz - Mon Apr 11, 2005 8:39 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>nico wrote:</b></span></td> </tr> <tr> <td class="quote">and as far as I know if using DMA an interrupt is not processed until DMA is finished.</td> </tr></table><span class="postbody">
<br/>
An interrupt is not processed until the previous interrupt is finished either. The difference is that DMA is many times faster than interrupts.
<br/>
Each DMA audio transfer will only take a few CPU cycles, while your interrupt routine will probably take something like 100 cycles.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
