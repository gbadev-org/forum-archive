<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Question about quality - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>Audio > Question about quality</h2>
<div id="posts">
<div class="post">
    <h4>#37139 - ProblemBaby - Mon Mar 07, 2005 11:59 pm</h4>
    <div class="postbody"><span class="postbody">Hi...
<br/>
My player works well but the quality is not enough!
<br/>
Do you have any hints to make it sound better?
<br/>
Right now I mix at 18157hz Ive also tried with 31536hz but it doesnt sound much better.
<br/>
When I listed to the XM in ModPlugTracker with 8-bit, stereo, 19800hz
<br/>
It sounds clear and good except for a static noise but in my player,
<br/>
it sounds like a factory at low notes and someone hammering at high notes=) shouldn't it be possible to make it sound as good as it do in ModPlugTracker with those settings?
<br/>
<br/>
All hints (big or small) are welcome!
<br/>
Thanks in advance</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#37158 - FluBBa - Tue Mar 08, 2005 10:24 am</h4>
    <div class="postbody"><span class="postbody">Are you mixing to a 16bit buffer and then scale it to 8bit, or are you downscaling the samples before you mix them?<br/>_________________<br/>I probably suck, my not is a programmer.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#37165 - kashiwa - Tue Mar 08, 2005 12:16 pm</h4>
    <div class="postbody"><span class="postbody">I think that Interpolation (linear or cubic spline or...) takes much change.
<br/>
How about doing incidentally when scaling it from 16 to 8 bits?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#37166 - ProblemBaby - Tue Mar 08, 2005 12:21 pm</h4>
    <div class="postbody"><span class="postbody">I mix 8 samples a time so I loop through each channel and get 8 samples
<br/>
and then put them in the final buffer.
<br/>
<br/>
To get much speed improvement Ive instead of put each sample in one register I put 2 samples in one register so its like a 16 bit buffer
<br/>
but since I mix 24 channels I also have to shift by 3 after the multiplication
<br/>
to make it not overflow. so its like 11 bit per sample.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#37185 - poslundc - Tue Mar 08, 2005 5:49 pm</h4>
    <div class="postbody"><span class="postbody">A downshift by three corresponds to dividing by 8.
<br/>
<br/>
If you are mixing 24 8-bit samples, you will have to divide by 24 to prevent overflow, not 8.
<br/>
<br/>
At that point, I would strongly recommend clipping your results instead of scaling them, since the volume loss you get when dividing by 24 is bound to be significant.
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#37192 - ProblemBaby - Tue Mar 08, 2005 7:48 pm</h4>
    <div class="postbody"><span class="postbody">Max sample number = 255
<br/>
Max sample volume = 0x40
<br/>
<br/>
so division by 8 is correct in fact it make it possible to mix up to 32 channels, but I dont want to waste memory/speed on eight more channels since I never will use them anyway.
<br/>
<br/>
I dont do the division at the end.
<br/>
First I Shift them with 3 and add them to the register
<br/>
then when all samples is added I Shift with 1 (a little scale)
<br/>
and then clip them..
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>kashiwa wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
I think that Interpolation (linear or cubic spline or...) takes much change. 
<br/>
How about doing incidentally when scaling it from 16 to 8 bits?
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
how do you mean?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#37196 - poslundc - Tue Mar 08, 2005 8:25 pm</h4>
    <div class="postbody"><span class="postbody">Downshifting your sample data before multiplying the volume could easily be causing significant loss of sound quality.
<br/>
<br/>
Observe a random example:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">Sample value S = 151
<br/>
Volume level V = 30
<br/>
<br/>
(S &gt;&gt; 3) * V = 540
<br/>
(S * V) &gt;&gt; 3 = 566</td> </tr></table><span class="postbody">
<br/>
<br/>
In this case, by downshifting early you've suffered a 4.6% loss of precision in the value of your sample.
<br/>
<br/>
I would recommend using the MLA instruction instead to multiply your samples-and-volumes and add them together. Then you can clip them when you're done.
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#37197 - DekuTree64 - Tue Mar 08, 2005 8:28 pm</h4>
    <div class="postbody"><span class="postbody">Mixing more than 4 channels with the 16-bit packing trick will always give you a cut in quality. Ideally, you don't want to shift down at all until the very end. It cuts accuracy and is a pretty big speed hit doing it every sample.
<br/>
According to my experience, the best quality vs. clipping distortion tradeoff with 4-16 channels is to shift down by 2 and clip. Not sure about 24 channels, but would probably still sound better than shifting down by 3.
<br/>
<br/>
What I would suggest for you is mixing 3 batches of 8 channels, and then adding those results up. To get around the overflowing problem, limit your maximum volume to 32. 255smp*8chns*32vol=65280, fits in 16 bits.
<br/>
<br/>
However, if you batch your channels intelligently, you can take all the ones that already have volume less than 32, and you won't have to shift their volumes down at all before mixing. Just shift down one more bit when combining up the batches at the end to get them to the same scale as the chopped batch. Good place for dynamic code.
<br/>
Of course, if you don't have 8 channels (one batch) with volume less than 32, you'll have to chop them all before mixing, but if you had that many channels that loud, you wouldn't be able to make out such fine volume changes very well anyway.
<br/>
<br/>
<br/>
Ok, now I'm inspired to work on my old sound article again. Must get the one on effects finished up tonight so I can get started on mixers. I could go on all day about this stuff :)<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#37210 - ProblemBaby - Tue Mar 08, 2005 10:18 pm</h4>
    <div class="postbody"><span class="postbody">Poslundc:
<br/>
Yes I know thats why I do like..
<br/>
<br/>
((S1 * V) &gt;&gt; 3) + ((S2 * V) &gt;&gt; 3)  + ...
<br/>
and then at the end downsample again.
<br/>
<br/>
I tried skip that thing and just mix 8 channels in once, but it doesnt sound much better, Iam starting to think that Ive coded something wrong.
<br/>
1. Because when I initialize I hear a loud click in the right speaker
<br/>
but not ive I add 16 to the mixingbuffer.
<br/>
2. Because it sounds so strange=), its like someone screaming noise in the same pitches as the notes.
<br/>
<br/>
Do anyone have a player that supports XM in would be interesting to try how it sounds, in someone elses player.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#37211 - ProblemBaby - Tue Mar 08, 2005 10:22 pm</h4>
    <div class="postbody"><span class="postbody">Wait.. Now I saw something intersesting in ModPlugTracker it is a settings called resampling. My player sounds like does if I select no resampling.
<br/>
and it sounds good with the other settings Linear, Cubic spline and high quality. 
<br/>
that was what kashiwa mentioned, but what does it mean???</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#37215 - DekuTree64 - Wed Mar 09, 2005 12:04 am</h4>
    <div class="postbody"><span class="postbody">Yeah, resampling makes a big difference. It will wreck your performance with 24 channels though, so probably best to skip it.
<br/>
<br/>
<br/>
Is the distortion only on the left ear? From your explanation of what you're doing, it looks like you're not clearing the lower bits of the top sample before shifting down, meaning that the least significant bits of the top sample become the MOST significant bits of the bottom (very bad). 
<br/>
<br/>
For example, if you have two 16 bit samples together, both 0x7FFF, it looks like 0x7FFF7FFF. If you just shift down by 3, then you have 0x0FFFEFFF. Looking at them seperately again, now the top is 0x0FFF, and the bottom is 0xEFFF. Different, when they should have been the same. To fix that, you have to clear the bottom bits of the top sample before shifting, like
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">sample &amp;= ~0x00070000;   // Clear bottom 3 bits
<br/>
sample &gt;&gt;= 3;</td> </tr></table><span class="postbody">
<br/>
<br/>
So you get 0x7FFF7FFF &amp; ~0x70000 = 0x7FF87FFF. Shift down 3, and you get 0x0FFF0FFF, now they're the same and good. That extra clearing takes one more cycle for every sample on every channel though, which is a pretty hefty hit with 24 channels. That's why you should aim not to shift down during mixing (in addition to the quality loss).<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#37217 - ProblemBaby - Wed Mar 09, 2005 12:23 am</h4>
    <div class="postbody"><span class="postbody">Yepp Ive done the really important BIC before adding them, its a click noise in the right speaker.
<br/>
<br/>
Ive a little idea. right now I mix at 18157 if I start to mix at 36314 instead
<br/>
but still load as many samples I did with 18157 and in then but a delta value between the two samples, do you think it should work?
<br/>
<br/>
something like:
<br/>
S1, S1+S2/2, S2, S2+S3/2, S3
<br/>
It would be easy and not so slow to implement
<br/>
S is the final mix.
<br/>
<br/>
Do you think it would sound crap or better? its a kind of linear interpolition isnt it?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#37236 - kashiwa - Wed Mar 09, 2005 5:51 am</h4>
    <div class="postbody"><span class="postbody">Yes, that is the linear interpolation.
<br/>
Use only the calculated value if you dont wanna change a sampling rate.
<br/>
ex: (S1+S2)/2, (S2+S3)/2, (S3+S4)/2, ...
<br/>
However, the effect might be thin.
<br/>
---
<br/>
sorry for my unskilled English. I say "AYBABTU.hahaha."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#37322 - tepples - Thu Mar 10, 2005 2:26 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>ProblemBaby wrote:</b></span></td> </tr> <tr> <td class="quote">Wait.. Now I saw something intersesting in ModPlugTracker it is a settings called resampling. My player sounds like does if I select no resampling.</td> </tr></table><span class="postbody">
<br/>
Most sound engines do. I'd suggest composing with "no resampling" turned on and most of the bass (below 500 Hz) EQ'd down so that you can predict what your song is going to sound like on the hardware.
<br/>
<br/>
kashiwa: Your technique looks the same as applying a low-pass filter (namely FIR[0.5 0.5]) to all samples before mixing them; it won't do much.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
