<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Timing and pitch problem - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>Audio > Timing and pitch problem</h2>
<div id="posts">
<div class="post">
    <h4>#22584 - Saint - Thu Jun 24, 2004 5:31 pm</h4>
    <div class="postbody"><span class="postbody">Not really sure whether I'm in the right place here, but anyways.
<br/>
<br/>
I wrote a Direct Sound player with interrupts, extending the version described at audioadvance. Problem is, that program generates interrupts 22050 times per second, but only copies a dword of data every forth frame.
<br/>
<br/>
Sooo, I figured I could save some processing power by setting the timer to take 4 times as long, and then just update the FIFO with every interrupt, but this strangely enough produced a very low-pitched version of the original sound, though with same length as the original audio.
<br/>
<br/>
I'm really no audio wizard, and I have very little previous experience with writing low-level sound code, so is there anyone here who knows what is happening? or better yet, can provide a sollution?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#22587 - poslundc - Thu Jun 24, 2004 6:25 pm</h4>
    <div class="postbody"><span class="postbody">Make sure you are using two separate timers: one for your interrupt and one for the direct sound chip. If you are only using a single timer to clock both the sound chip and the interrupt, you will have to switch to two timers if you want to call your interrupt at a reduced frequency.
<br/>
<br/>
When you start mixing, consider using DMA with double-buffers instead, and setting your interrupt to a much lower frequency so it just has to keep the buffers filled. In practice a mixer running off a double-buffer will be more efficient than a purely interrupt-driven mixer on the GBA, and will be more fault-tolerant of delays if you are using multiple interrupts (such as if you have a critical HBlank ISR or serial communications going on).
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#22588 - Saint - Thu Jun 24, 2004 6:59 pm</h4>
    <div class="postbody"><span class="postbody">Well, that would certainly never have occured to me.
<br/>
<br/>
Thanks a lot!
<br/>
<br/>
As for the DMA and double- buffering, I can see how this would be faster, but how would you go about when the buffer needs re-filling? would you calculate the sound in real-time, or stay "one buffer ahead", calculating a little each frame?
<br/>
<br/>
Also, what about sound effects? are you going to (in the interrupt handler) keep track of where in the double buffer you're currently at, so that you can play an effect instantly by just copying it into that position, or would it be wiser to use a separate handler for those? or is it perhaps better to use a DMA small enough so that all sound effects are simply added the next time the buffer is re-filled, and the buffer is small enough to keep the time difference neglible?
<br/>
<br/>
Anything else I should think of?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#22589 - poslundc - Thu Jun 24, 2004 7:14 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Saint wrote:</b></span></td> </tr> <tr> <td class="quote">As for the DMA and double- buffering, I can see how this would be faster, but how would you go about when the buffer needs re-filling? would you calculate the sound in real-time, or stay "one buffer ahead", calculating a little each frame?</td> </tr></table><span class="postbody">
<br/>
<br/>
The idea behind double-buffering is that while one buffer is being read from, the other buffer is being filled. This prevents erroneous data if your filler gets interrupted, because the data currently being used is coming from a different source.
<br/>
<br/>
You time it so that your interrupt triggers right when the DMA is at the end of one buffer. It can then immediately switch the DMA over to the other buffer, and then mix into the buffer that the DMA just left.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Also, what about sound effects? are you going to (in the interrupt handler) keep track of where in the double buffer you're currently at, so that you can play an effect instantly by just copying it into that position, or would it be wiser to use a separate handler for those? or is it perhaps better to use a DMA small enough so that all sound effects are simply added the next time the buffer is re-filled, and the buffer is small enough to keep the time difference neglible?</td> </tr></table><span class="postbody">
<br/>
<br/>
You've got the right idea. Just turn the sound effect "on", and the next time your mixer runs, you start playing it.
<br/>
<br/>
IIRC, I think my MOD player uses a buffer of 512 bytes, double-buffered to 1K, and then stereo-channeled for a total of 2K. The sound chip is running at 16KHz, so the mixer runs (refilling one of the buffers) at a frequency of 32 Hz, or every 0.031 seconds. I don't think there are many gamers out there who will notice if your sound effect starts 0.031 seconds late, do you?
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#22590 - Saint - Thu Jun 24, 2004 7:23 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>poslundc wrote:</b></span></td> </tr> <tr> <td class="quote">I don't think there are many gamers out there who will notice if your sound effect starts 0.031 seconds late, do you?</td> </tr></table><span class="postbody">
<br/>
<br/>
...Point taken. I'm assuming (since I as I said don't know anything about hardcore sound programming) that when the interrupt tells the DMA to swap buffers, it also calls a function to refill the backbuffer, and that you have some kind of handler for this.
<br/>
<br/>
You've been a great help, I really mean it. Thanks.
<br/>
<br/>
Btw, assuming I wanted to make a player for some format of my own, do you know of any resource sites except for <a href="http://www.wotsit.org?" target="_blank">www.wotsit.org?</a> Or just for audio programming in general? Everybody has tutorials for graphics programming on every system under the sun, but only a select few seems to do their own sound systems.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#22592 - poslundc - Thu Jun 24, 2004 7:46 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Saint wrote:</b></span></td> </tr> <tr> <td class="quote">I'm assuming (since I as I said don't know anything about hardcore sound programming) that when the interrupt tells the DMA to swap buffers, it also calls a function to refill the backbuffer, and that you have some kind of handler for this.</td> </tr></table><span class="postbody">
<br/>
<br/>
If you're doing it as an interrupt it's best to do it all in a single function, since you want it to be running lean and mean. In fact, if you were ever thinking about learning assembly, an interrupt-driven mixer is a good candidate for assembly optimization.
<br/>
<br/>
The very first thing the interrupt should do is switch the DMA over to the other buffer, so no matter how long the mixing takes, the DMA is ready to go as soon as it is needed. (Note that if you implement your double-buffer as a single, continous block of memory you'll only have to stop and restart the DMA every other buffer-swap, when you reach the end of the second buffer.)
<br/>
<br/>
The alternative to interrupt-based mixing is to mix on VBlank, which many other people on the forum choose to do. I prefer to mix on interrupts because I get rounder numbers for my frequencies and buffer sizes, and I have to agonize less over the (admittedly simple enough) math, but there are a few advantages to mixing to VBlank, namely:
<br/>
<br/>
- Don't have to worry about what happens when you conflict with an HBlank ISR
<br/>
- Frees up a timer, for what it's worth
<br/>
- Don't have to wait for an ISR to launch (something like 50-70 cycles in the BIOS, apparently).
<br/>
<br/>
Neither of the first two things are very important to me (I've configured my HBlank ISR to preempt my mixer, and four timers is plenty for me). As for the third, I shrug my shoulders at it, frankly, as my player is still very lean and mean. Plus I'm leaving more VBlank time to do VBlank-related tasks, which is important to me.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Btw, assuming I wanted to make a player for some format of my own, do you know of any resource sites except for <a href="http://www.wotsit.org?" target="_blank">www.wotsit.org?</a> Or just for audio programming in general? Everybody has tutorials for graphics programming on every system under the sun, but only a select few seems to do their own sound systems.</td> </tr></table><span class="postbody">
<br/>
<br/>
Wotsit is where I got all of my specs, I think. Other than that, you can google, search the forums, or post your questions here and we'll try our best to field them. Maybe someone else will be able to suggest additional sites.
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#22593 - tepples - Thu Jun 24, 2004 8:08 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>poslundc wrote:</b></span></td> </tr> <tr> <td class="quote">I don't think there are many gamers out there who will notice if your sound effect starts 0.031 seconds late, do you?</td> </tr></table><span class="postbody">
<br/>
It appears you've never played Beatmania, Pop'n Music, or any other Konami rhythm game. I absolutely <span style="font-style: italic">cannot</span> play the GBC versions of those in an emulator because of all the added audio latency.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#22594 - poslundc - Thu Jun 24, 2004 8:20 pm</h4>
    <div class="postbody"><span class="postbody">Way to rain on my parade, tepples. ;)
<br/>
<br/>
Of course, the emulator you were using probably has a much larger sound buffer. I don't think 0.03 seconds is so bad, but you can always make your buffer smaller if it is becoming a problem. I am using a 512 byte buffer, but I started with a 256 byte buffer, so running at 16 KHz that would mean a maximum latency of 0.0155 seconds. Keep in mind that it's the maximum latency as well: you can probably assume a uniform distrubtion such that it is only 0.005 or so on average.
<br/>
<br/>
Dan (what more can they want?!).</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#22598 - Saint - Thu Jun 24, 2004 9:29 pm</h4>
    <div class="postbody"><span class="postbody">I actually do know some assembly, wrote a few games back in the 90s. I planned to do stuff like that in ASM, but I'm obviously a little rusty, and I haven't gotten to reading up on ARM assembly... yet.
<br/>
<br/>
As for the rest, I don't know much, but I'd agree it's better to use another timer. For one thing, you keep your graphics and sound system a little more separated, which is cleaner, if nothing else.
<br/>
<br/>
Thanks again. Oh, and tepples, thanks for pointing it out, but I don't think I'll be doing a GBA DDR... Should I happen to change my mind, I'll ask you about it =)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#22600 - DekuTree64 - Fri Jun 25, 2004 12:06 am</h4>
    <div class="postbody"><span class="postbody">Actually, you can get near-perfect timing for music when using double buffers. If you make your mixer where you can send the number of samples for it to mix (usually restricted to multiples of at least 4, depending on how your mixer works), then you can calculate up the number of samples per song tick, and mix that many. Then update the song, mix that many more samples, update the song, until the samples/tick is more than what's left of your buffer, and then just mix however many is left, and keep track of how many more it will be until the next song tick for next frame.
<br/>
<br/>
As for sound effects, since most games run at 60 or 30Hz, they don't NEED to be more accurate than one frame's buffer length, because you would expect all the sounds played on a single frame to start at the same time. Makes life easy for us coders^_^<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#22601 - poslundc - Fri Jun 25, 2004 12:44 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>DekuTree64 wrote:</b></span></td> </tr> <tr> <td class="quote">As for sound effects, since most games run at 60 or 30Hz, they don't NEED to be more accurate than one frame's buffer length, because you would expect all the sounds played on a single frame to start at the same time.</td> </tr></table><span class="postbody">
<br/>
<br/>
There's the logic I was lookin' for earlier, folks.
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
