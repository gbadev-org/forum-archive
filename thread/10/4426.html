<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>About to flip out and kill someone... (Krawall) - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>Audio > About to flip out and kill someone... (Krawall)</h2>
<div id="posts">
<div class="post">
    <h4>#29476 - Wriggler - Sat Nov 20, 2004 10:37 pm</h4>
    <div class="postbody"><span class="postbody">Hi guys,
<br/>
<br/>
I'm working on a project with another guy, and he's set up all the audio using the Krawall library and compiling it in HAM. I thought I'd try and be clever, and try to compile the thing in DevkitAdv. I don't think I realised what I was getting myself into!
<br/>
<br/>
I've changed the batch file which we use to make the project, and (after a while) it compiled in devkitadv. I'm not sure if I did it right though, so that could be messing things up.
<br/>
<br/>
Then I replaced the interrupt code with the assembler functions from dovotos tutorial (Day 4 part 2). Well, in fact I've only replaced the VBL one as I have no idea how to set up a timer 0 interrupt!
<br/>
<br/>
Anyways, the end result is a rom that compiles, but when I try to add the interrupts nothing happens at runtime. I'm left with a black screen.
<br/>
<br/>
Here's the first part of sound.c. I hope you can see what I'm trying to do. To be honest, I'm not entirely sure myself so any help would be greatly appreciated.
<br/>
<br/>
Thanks in advance.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
// Global var the intrHandler function.
<br/>
int gl_intr = 0;
<br/>
<br/>
#define INT_TIMER1      0x0010
<br/>
#define INT_TYPE_TIM1   4
<br/>
#define INT_TYPE_VBL    0
<br/>
<br/>
<br/>
/******************************************************************************
<br/>
* Check on the krawall interrupt.
<br/>
******************************************************************************/
<br/>
void IrqVBlank(void)
<br/>
{
<br/>
   gl_intr++;
<br/>
   if (gl_intr == 2)
<br/>
   {
<br/>
      kramWorker();
<br/>
      gl_intr = 0;
<br/>
   }
<br/>
}
<br/>
<br/>
/******************************************************************************
<br/>
* Initalise krawall.
<br/>
******************************************************************************/
<br/>
void initSound(void)
<br/>
{
<br/>
   kragInit(KRAG_INIT_STEREO);
<br/>
<br/>
   //TODO: Replace these HAM interrupts
<br/>
   //ham_StartIntHandler(INT_TYPE_TIM1,&amp;kradInterrupt);
<br/>
   //ham_StartIntHandler(INT_TYPE_VBL,&amp;intrHandler);
<br/>
<br/>
   //Custom Krawall interrupt setup
<br/>
   REG_DISPSTAT = (1&lt;&lt;3);
<br/>
   IRQ_Set(1, IrqVBlank); 
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Cheers,
<br/>
<br/>
Ben</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#29477 - Wriggler - Sat Nov 20, 2004 10:39 pm</h4>
    <div class="postbody"><span class="postbody">Oh, and here's an extract from Dovoto's headers, as I think it's important for understanding what's going on in the above code.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
//Interrupt table
<br/>
u32* IntrTable[14];
<br/>
<br/>
extern void IrqHandler(void);
<br/>
<br/>
//Function to set an interrupt
<br/>
void IRQ_Set(int irq, u32 irq_handle)
<br/>
{
<br/>
   int i;
<br/>
   for(i=0; i&lt;14; i++)   {
<br/>
      if(irq &amp; (1&lt;&lt;(i))) { IntrTable[i] = irq_handle; }
<br/>
   }
<br/>
<br/>
   REG_INTERUPT = IrqHandler;      //This is an assembler function
<br/>
   REG_IME = 0;
<br/>
   REG_IE |= irq;
<br/>
   REG_IME = 1;
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Ben</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#29682 - phantom-inker - Tue Nov 23, 2004 9:32 pm</h4>
    <div class="postbody"><span class="postbody">In addition to regularly calling kramWorker(), you need to bind the timer interrupt to Krawall or you'll get nothing.
<br/>
<br/>
Sound on the GBA is quirky; there are several actors playing simultaneously, so it can be confusing to determine who does what.  Here's a rundown for you:
<br/>
<ul>
<br/>
<li>The audio buffer --- RAM --- The audio buffer is an internal part of Krawall that stores the current chunk of digital audio that is being sent out through the speaker.
<br/>
</li><li>The DMA system --- hardware chip --- The DMA hardware is responsible for actually transferring the data from the audio buffer to the speaker.
<br/>
</li><li>The timer system --- hardware chip --- At regular intervals, when the DMA runs out of data to transfer, a timer must activate and throw an interrupt that resets the DMA transfer to the start of the audio buffer.
<br/>
</li><li>kramWorker --- software --- Mixes chunks of sound together in the audio buffer to ensure that the audio buffer is always full.
<br/>
</li></ul>
<br/>
Krawall manages the audio buffer and DMA, and of course kramWorker() is part of it too. 
<br/>
<br/>
In your code, you've called kragInit() to initialize Krawall, which is good; you're regularly calling kramWorker() to ensure that the buffer is full, which is good (although doing it on an interrupt is bad if you're not careful; see the Krawall documentation to find out why); however, you never set up the timer interrupt, so when the DMA runs out of data to feed to the speaker (after about a second), the audio just stops.
<br/>
<br/>
The sequence you should use is something like this:
<br/>
<ul>
<br/>
<li> Assign timer1 to kradInterrupt, and enable IRQs for timer1.
<br/>
</li><li> Call kragInit().
<br/>
</li><li> Once per frame in your main loop, call kramWorker().  I recommend against doing this in the vertical interrupt handler (but you can do it in a VCOUNT handler if you know what you're doing).
<br/>
</li></ul>
<br/>
If those are correct, then functions like krapPlay() will work fine.
<br/>
<br/>
Heh, and it seems I have foam-at-the-mouth disease in yet another posting... ^^;<br/>_________________<br/>Do you suppose if I put a signature here, anyone would read it?  No?  I didn't think so either.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#29685 - Wriggler - Tue Nov 23, 2004 10:33 pm</h4>
    <div class="postbody"><span class="postbody">Ahhhh, that makes things MUCH clearer now, thank you very much! Right, so I need a bit of restructuring and a new interrupt. Nice one. Cheers mate!
<br/>
<br/>
Ben</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
