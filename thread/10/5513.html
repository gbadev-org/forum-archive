<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Krawall "crunching" - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>Audio > Krawall "crunching"</h2>
<div id="posts">
<div class="post">
    <h4>#40906 - Ultima2876 - Sat Apr 23, 2005 1:57 pm</h4>
    <div class="postbody"><span class="postbody">I've had some problems with Krawall lately. I'm using this code to fade out (to black):
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void fade_to_black(int frames, int sound, u16 blend)
<br/>
   {
<br/>
         int i = 0;
<br/>
         REG_BLDCNT = BLD_DEC | blend;
<br/>
         REG_BLDY = BLD_EVY(0);
<br/>
         for (i = 0; i &lt; frames; i++)
<br/>
         {
<br/>
            if (sound == 1)
<br/>
               {
<br/>
                  kramWorker();
<br/>
                  i++;
<br/>
               }
<br/>
            WaitForVsync();
<br/>
            switch (frames)
<br/>
               {
<br/>
                  case 1: REG_BLDY = BLD_EVY(16 * i / 1); break;
<br/>
                  case 15: REG_BLDY = BLD_EVY(16 * i / 15); break;
<br/>
                  case 30: REG_BLDY = BLD_EVY(16 * i / 30); break;
<br/>
                  case 45: REG_BLDY = BLD_EVY(16 * i / 45); break;
<br/>
                  case 60: REG_BLDY = BLD_EVY(16 * i / 60); break;
<br/>
                  case 75: REG_BLDY = BLD_EVY(16 * i / 75); break;
<br/>
                  case 90: REG_BLDY = BLD_EVY(16 * i / 90); break;
<br/>
                  case 105: REG_BLDY = BLD_EVY(16 * i / 105); break;
<br/>
                  case 120: REG_BLDY = BLD_EVY(16 * i / 120); break;
<br/>
                  case 135: REG_BLDY = BLD_EVY(16 * i / 135); break;
<br/>
                  case 150: REG_BLDY = BLD_EVY(16 * i / 150); break;
<br/>
                  case 165: REG_BLDY = BLD_EVY(16 * i / 165); break;
<br/>
                  case 180: REG_BLDY = BLD_EVY(16 * i / 180); break;
<br/>
                  case 195: REG_BLDY = BLD_EVY(16 * i / 195); break;
<br/>
                  case 210: REG_BLDY = BLD_EVY(16 * i / 210); break;
<br/>
                  case 225: REG_BLDY = BLD_EVY(16 * i / 225); break;
<br/>
                  case 240: REG_BLDY = BLD_EVY(16 * i / 240); break;
<br/>
                  case 255: REG_BLDY = BLD_EVY(16 * i / 255); break;
<br/>
               }
<br/>
            }
<br/>
      REG_BLDY = BLD_EVY(16);
<br/>
   }</td> </tr></table><span class="postbody">
<br/>
<br/>
However, when I'm fading with sound, the sound sometimes "crunches", making a horrible crunching noise, or fuzz. This seems to be completely random, as sometimes it works perfectly, others it onl crunches a tiny bit, and sometimes it even crunches horribly the whole way through the fade.
<br/>
<br/>
Is there any solution to this? (using High Quality mode in Krawall makes no difference) Is there a more efficient way to fade to black while providing a number of frames to fade over (the number of frames will only ever be 1 or a multiple of 15). Do you think it is my fade function using too much CPU time?
<br/>
<br/>
Thanks.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#40913 - Lord Graga - Sat Apr 23, 2005 2:29 pm</h4>
    <div class="postbody"><span class="postbody">You should allways have kramWorker() in an interrupt. Try that.
<br/>
<br/>
The whole(switch) statement looks horribly ineffective, both codewise and speedwise. Not that it matters when you are only doing so little, but it's sort of bad style :P</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#40922 - Ultima2876 - Sat Apr 23, 2005 3:54 pm</h4>
    <div class="postbody"><span class="postbody">Yeah, I know, I don't like the switch either. It actually used to just be a:
<br/>
<br/>
REG_BLDY = BLD_EVY(16 * i / frames);
<br/>
<br/>
but I thought that would be slower due to dividing by a variable. Should I just change it back?
<br/>
<br/>
I'll try that with the interrupt, by the way =P</span><span class="gensmall"><br/><br/>Last edited by Ultima2876 on Sat Apr 23, 2005 4:05 pm; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#40924 - Quirky - Sat Apr 23, 2005 3:58 pm</h4>
    <div class="postbody"><span class="postbody">Check your .map file or use objdump on the elf - I think you'll find that non-shifting divides by a constant pull in the (slowish) newlib divide routine anyway. That has been my experience anyway. 
<br/>
<br/>
I wouldn't worry about speed in this case though, as you aren't doing much per-frame. Only be concerned if you wanted to keep your rom size down (for multiboot say) by not using unecessary lib calls.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#41933 - kusma - Tue May 03, 2005 12:12 pm</h4>
    <div class="postbody"><span class="postbody">you could easily store the reciprocals in a lut here, and use a table-lookup + a multiply.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
