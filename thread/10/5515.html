<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>XM instruments - solved! - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>Audio > XM instruments - solved!</h2>
<div id="posts">
<div class="post">
    <h4>#40923 - Quirky - Sat Apr 23, 2005 3:54 pm</h4>
    <div class="postbody"><span class="postbody">I've implemented a basic XM player that does mostly what I need - play some MIDI files converted to XM using modplug tracker - but I have a couple of doubts regarding samples and instruments...
<br/>
<br/>
In Mods, the samples are stored at the default rate of 8363 Hz for C4 (or C2, or "middle C"). In the XM format, things are a bit more complex; you have an 'instrument' that contains samples. For example you have instrument 1 - "Strings" - that may have the samples "String.1" "String.2" etc. Each sample has a signed byte finetune value and relative note value. Then in the pattern, you have an entry that would be "note 64, instrument 1".
<br/>
<br/>
In order for the track to sound correct, I have to offset the given pattern note by the sample's relative note - I only seem to need sample 1 in each instrument (??). But occasionaly it sounds wonky and I imagine it's because of the one sample fudge. 
<br/>
<br/>
For example, note 64 (E 4)comes up in the pattern, the sample has a relative note of 10, so I play note 64+10 = 74 (or 'D 5'). I have a LUT that uses equal temperament semitones (C4 = 261.1Hz) converted to the increment value for the mixer. 
<br/>
The table is built externally using:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">table[i] = ((note_in_hz*default_sample_freq/middle_C_in_hz)&lt;&lt;12 ) / mixer_freq</td> </tr></table><span class="postbody">
<br/>
where mixer_freq = 18157
<br/>
middle_C = 261.6
<br/>
default_sample_freq = 8363
<br/>
note_in_hz = the frequency of this note (0-127 on the midi scale)
<br/>
<br/>
<br/>
My question is: why are there multiple samples in each instrument? And how does the finetune value fit in? I imagine that it's something like "If the note is in the range of a sample, then play that sample, else play the next higher up sample" and so on - so rather than offsetting the pattern note by 10, I would play the sample that covers that range.  But I haven't found any docs that really explain it. Can anyone shed some light on the subject?
<br/>
<br/>
EDIT: Well it seems that Modplug Tracker adds in extra samples that aren't actually used - it groups them together in the Windows program and just outputs the group to the XM file whether the samples are used or not. Fair enough. 
<br/>
<br/>
And the finetune is straightforward too: I saw Deku's post lower down where he interpolates between 2 notes, copied the idea, and BAM! everything sounds spot on. Wonderful.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#50329 - pan69 - Mon Aug 08, 2005 7:19 am</h4>
    <div class="postbody"><span class="postbody">It's good that you post your findings. I think more people should do things like this instead of writing elaborated tutorials for the beginners which we don't need. This stuff is valuable!
<br/>
<br/>
So cheers to you!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#54454 - thegamefreak0134 - Mon Sep 19, 2005 5:22 pm</h4>
    <div class="postbody"><span class="postbody">Ahhh... MIDI files are so fun to work with. Yes, I believe you are right about the multiple sample per instrument thingy. A typical XG midi card (refering to the most common, the MS wavetable) has several samples per instrument I guess because it sounds wierd (or "wonky" as you put it) when you modify one sample too much for the note. The best way to figure out the changes is to fire up your favorite sequencer and play all the notes for each instrument listening for the changes.
<br/>
<br/>
Also note that with some MIDI formats of sound it is possible to include your own samples.
<br/>
<br/>
You are writing a MIDI player for the GBA correct? This sounds awesome, and I would like to see it when finished.
<br/>
<br/>
If I soundwrong on a subject, please tell me. I work with midi almost constantly, but i still may be shakey on the basics of the hardware.<br/>_________________<br/>What if the hokey-pokey really is what it's all about?
<br/>
<br/>
[url=http:/www.darknovagames.com/index.php?action=recruit&amp;clanid=1]Support Zeta on DarkNova![/url]</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
