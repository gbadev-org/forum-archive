<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>DMA Sound Loop Works on emulator, & doesnt work in real - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>Audio > DMA Sound Loop Works on emulator, & doesnt work in real</h2>
<div id="posts">
<div class="post">
    <h4>#4294 - rome - Wed Mar 26, 2003 6:52 pm</h4>
    <div class="postbody"><span class="postbody">my GBA dma routine loop sound works perfectly in Virtual Game Boy emulator (sounds play in loop), but when i pass the rom to flash cartridge and play it on real GBA hardware, the sound runs and dont return the Cursor to play the same sound (loop the sound). can anyone help me?
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
<br/>
void InterruptProcess(void)
<br/>
{ 
<br/>
    // timer 1 irq will be triggered when sound reaches the end
<br/>
   if(REG_IF &amp; INT_TIMER1) 
<br/>
   {
<br/>
      // reset the sound source DMA transfer
<br/>
      REG_DM1SAD   = (unsigned long)p_data;
<br/>
   }
<br/>
   REG_IF |= REG_IF; 
<br/>
} 
<br/>
<br/>
<br/>
int main (void) 
<br/>
{ 
<br/>
<br/>
  REG_INTERUPT = (u32)&amp;InterruptProcess;
<br/>
<br/>
   // len keep the file size in bytes   
<br/>
   len = GetFileSize(0);
<br/>
   // p_data keep the pointer to data
<br/>
   p_data = (char *)GetFileData(0);
<br/>
<br/>
    //play a mono sound at 16khz
<br/>
//uses timer 0 as sampling rate source
<br/>
//uses timer 1 to count the samples played in order to stop the sound 
<br/>
REG_SGCNT0_H=0x0b0F; //enable DS A&amp;B + fifo reset + use timer0 + max volume to L and R
<br/>
REG_SGCNT1=0x0080; //turn sound chip on
<br/>
<br/>
REG_DM1SAD=(unsigned long)p_data; //dma1 source
<br/>
REG_DM1DAD=0x040000a0; //write to FIFO A address
<br/>
REG_DM1CNT_H=0xB640; //DMA enabled + starton fifo req + 32 bit + repeat + increment source, leave dest (FIFO dest)
<br/>
<br/>
REG_TM1D=0xFFFF - len; //0xffff-the number of samples to play
<br/>
REG_TM1CNT=0xC4;  // init timer cascade and generate irq
<br/>
<br/>
REG_IE=0x10; //enable irq for timer 1
<br/>
REG_IME=1; //master enable interrupts
<br/>
<br/>
REG_TM0D=0xFBE8; //16khz playback freq
<br/>
REG_TM0CNT=0x0080; //enable timer0 at 16 khz
<br/>
    
<br/>
while (1)
<br/>
 {
<br/>
 }
<br/>
}
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#4298 - tepples - Wed Mar 26, 2003 8:23 pm</h4>
    <div class="postbody"><span class="postbody">The GBA hardware ignores writes to an active DMA channel.  In order to reset DM1SAD on hardware, you have to first turn off the DMA channel, change the source address, and then turn the DMA channel back on.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#4299 - rome - Wed Mar 26, 2003 8:48 pm</h4>
    <div class="postbody"><span class="postbody">oh yeah! great tip! thank you so much tepples!
<br/>
now it works perfectly, in emulator and real GBA hardware</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#9094 - Daikath - Mon Jul 28, 2003 1:29 pm</h4>
    <div class="postbody"><span class="postbody">Ive got another problem, it works on an emulator (though not as it should do but thats not the most imprtant problem right now). but when I play it on the actual hardware it doesnt do anything.
<br/>
<br/>
This is my code
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">/ Sound.c AGBmain Entry point is contained here (main program loop)
<br/>
<br/>
#include &lt;gba.h&gt;
<br/>
#include "soundregisters.h"
<br/>
#include "stdlib.h"
<br/>
extern const u8 sound[];
<br/>
<br/>
u16 counter;
<br/>
void WaitforVsync()
<br/>
{
<br/>
  while (REG_VCOUNT != 160);
<br/>
  while (REG_VCOUNT != 161);
<br/>
   counter++;
<br/>
   if (counter == 152)
<br/>
   {
<br/>
      counter = 0;
<br/>
   }
<br/>
}
<br/>
<br/>
<br/>
void AgbMain(void)
<br/>
{
<br/>
   SetVideoMode(MODE1 | OBJ_ENABLE | OBJ_MAP_1D);
<br/>
   REG_SOUNDCNT_L = 0;
<br/>
   REG_SOUNDCNT_H = SND_OUTPUT_RATIO_100 |
<br/>
                 DSA_OUTPUT_RATIO_100 |
<br/>
                 DSA_OUTPUT_TO_BOTH |
<br/>
                 DSA_TIMER0 |
<br/>
                 DSA_FIFO_RESET;
<br/>
   REG_SOUNDCNT_X = SND_ENABLED;
<br/>
   
<br/>
   
<br/>
REG_DMA1SAD = (u32)(sound);
<br/>
REG_DMA1DAD = (u32)REG_FIFO_A;
<br/>
REG_DMA1CNT = ENABLE_DMA | START_ON_FIFO_EMPTY | WORD_DMA | DMA_REPEAT | 0x40;
<br/>
<br/>
   REG_TM0D   = TIMER_INTERVAL;
<br/>
   REG_TM0CNT = TIMER_ENABLED;
<br/>
   
<br/>
<br/>
   while(1)
<br/>
   {
<br/>
      
<br/>
      WaitforVsync();
<br/>
   }
<br/>
}
<br/>
<br/>
//end of entry point
<br/>
<br/>
<br/>
</td> </tr></table><span class="postbody"><br/>_________________<br/>?There are no stupid questions but there are a LOT of inquisitive idiots.?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#9104 - DekuTree64 - Mon Jul 28, 2003 4:09 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Daikath wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">REG_DMA1DAD = (u32)REG_FIFO_A;
<br/>
</td> </tr></table><span class="postbody"></span></td> </tr></table><span class="postbody">
<br/>
Should be 
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">REG_DMA1DAD = (u32)&amp; REG_FIFO_A;
<br/>
</td> </tr></table><span class="postbody">
<br/>
I think that will fix it^^
<br/>
<br/>
EDIT: had to put a space betweer the &amp; and the R, cause it turned into a trademark thing...<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
