<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Playing MOD files - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>Audio > Playing MOD files</h2>
<div id="posts">
<div class="post">
    <h4>#36803 - gbawiz - Wed Mar 02, 2005 12:10 am</h4>
    <div class="postbody"><span class="postbody">Hello,
<br/>
I have now been able to produce some mod music from my GBA playing mod files.
<br/>
I have a question about the pattern jumping and speed.
<br/>
<br/>
When the modplayer encounters a row which states the effect as 'jump to order 'n' ' Do I jump on next tick or next row?
<br/>
A similar problem occurs when using 'pattern break'
<br/>
<br/>
The GBA vblank rate is 60hz and setting the speed at the default speed of 6 ticksdelay is too fast and have to adjust to 7 which is too slow, I believe the mod files I have are based on the 50hz setting.
<br/>
<br/>
How do I implement the speed set command?
<br/>
i.e if the speed is set below 31 then I just use that number as the tickdelay but when above 31 it is considered to be a BPM setting.
<br/>
How is this converted into an appropriate tickdelay or using 60hz.
<br/>
<br/>
Thanks</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#36807 - DekuTree64 - Wed Mar 02, 2005 1:17 am</h4>
    <div class="postbody"><span class="postbody">Yay, lots of easy questions (which are also good ones since nobody seems to document such specific little details...).
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>gbawiz wrote:</b></span></td> </tr> <tr> <td class="quote">When the modplayer encounters a row which states the effect as 'jump to order 'n' ' Do I jump on next tick or next row?</td> </tr></table><span class="postbody">
<br/>
Should jump on the next row. The way I do it is with a 'next row' variable, which is normally set to row+1, and then have the effect change that.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">The GBA vblank rate is 60hz and setting the speed at the default speed of 6 ticksdelay is too fast and have to adjust to 7 which is too slow</td> </tr></table><span class="postbody">
<br/>
Yep, that's a tricky problem, but can be solved.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">How do I implement the speed set command?</td> </tr></table><span class="postbody">
<br/>
if (param &lt; 32) speed = param;
<br/>
else tempo = param;
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">How is this converted into an appropriate tickdelay or using 60hz.</td> </tr></table><span class="postbody">
<br/>
songHz = tempo*2/5
<br/>
<br/>
Then to solve the problem above of getting the timing right, you need to decouple the song ticking from the VBlank, and do it based on samples played. Once you have the song Hz there, you only need to divide by the VBlank frequency, 60Hz, to get the song updates per frame. THen multiply by the samples per frame (304 if you're using 18157Hz) to get the samples per MOD tick:
<br/>
<br/>
samplesPerTick = songHz * 304 / 60
<br/>
<br/>
Then you just mix samplesPerTick samples, update the MOD, mix that many more, and so on.
<br/>
<br/>
Check my <a class="postlink" href="http://deku.gbadev.org/program/sound4.html" target="_blank">article</a> for a detailed explanation.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Thanks</td> </tr></table><span class="postbody">
<br/>
You're welcome :) One of these days I might finish that article with all the details on these things. The player sounds fine on almost all MODs, just that I haven't tackled my old most hated (and feared) effect glissando, and I won't be able to live with myself if I admit defeat to it and leave it unsupported like I have in the past.
<br/>
And just to note incase you read the article and start to get ideas, the player turned out to sound pretty bad when sliding Hz frequencies, so I switched it to use periods all the time. Could still be done with Hz by making the frequencies fixed-point, but not really worth it, and it was pretty trivial to change it.<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#36872 - gbawiz - Wed Mar 02, 2005 6:55 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Then to solve the problem above of getting the timing right, you need to decouple the song ticking from the VBlank, and do it based on samples played. Once you have the song Hz there, you only need to divide by the VBlank frequency, 60Hz, to get the song updates per frame. THen multiply by the samples per frame (304 if you're using 18157Hz) to get the samples per MOD tick:</td> </tr></table><span class="postbody">
<br/>
<br/>
samplesPerTick = songHz * 304 / 60
<br/>
<br/>
Then you just mix samplesPerTick samples, update the MOD, mix that many more, and so on.
<br/>
<br/>
<br/>
The setup which I have just now is every vblank, the tick is incremented.
<br/>
If it reaches the modspeed (default 6) then the row is updated and tick reset to 0.
<br/>
<br/>
this plays the mod but it can be too fast even when the speed is correct, this being due to the 60hz GBA vlblank instead of the 50hz.
<br/>
Deku, you mentioned you need to decouple the song ticking from the VBlank.
<br/>
Does this mean that you use a timer to update the mod, instead of the VBLANK?
<br/>
<br/>
Thanks again for advice :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#36882 - tepples - Wed Mar 02, 2005 9:39 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>gbawiz wrote:</b></span></td> </tr> <tr> <td class="quote">Deku, you mentioned you need to decouple the song ticking from the VBlank.
<br/>
Does this mean that you use a timer to update the mod, instead of the VBLANK?</td> </tr></table><span class="postbody">
<br/>
Not necessarily. In GSM Player, the decode destination is always 160 samples (per the GSM Full Rate spec), but the playback source is always 304 samples (for 18 kHz playback). It uses an extra buffer to hold a block of decoded data.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#36890 - gbawiz - Thu Mar 03, 2005 1:25 am</h4>
    <div class="postbody"><span class="postbody">Hello,
<br/>
<br/>
About the speed and tempo,
<br/>
if the defaults are set as speed 6 and tempo 125, which one will be used?
<br/>
i.e. are both speed and tempo settings needed/used, or just one if so which one?
<br/>
I was wondering if for example I set the speed to zero, will the song still play at the specified tempo?
<br/>
<br/>
Thanks again in advance</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#36895 - tepples - Thu Mar 03, 2005 3:31 am</h4>
    <div class="postbody"><span class="postbody">song_hz is always based on tempo; speed determines only the number of ticks per row.
<br/>
<br/>
If you don't want to fool around with ring-buffering techniques, then compose all your songs with speed=150 and have the engine assume speed=150. I used a technique like this for <a class="postlink" href="http://www.pineight.com/gba/#tod" target="_blank">TOD</a>'s music engine.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#37038 - gbawiz - Sat Mar 05, 2005 2:49 pm</h4>
    <div class="postbody"><span class="postbody">Hello,
<br/>
I have been looking at this method of updating the mixbuffer for a mod player but find that I run into problems.
<br/>
The sound is grainy and it extends the time taken, past the vblank duration.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void sndupdate()
<br/>
{
<br/>
   unsigned int samplesleft=BUFFERSIZE;
<br/>
   while(samplesleft &gt; 0){
<br/>
<br/>
      if(sam_until_modtick == 0 &amp;&amp; modstate==ACTIVE){
<br/>
         mod_update();
<br/>
         sam_until_modtick=sam_per_modtick;
<br/>
      }//endif
<br/>
<br/>
      if(sam_until_modtick &lt; samplesleft &amp;&amp; modstate==ACTIVE){
<br/>
         mixer(cur_mixbuf,sam_until_modtick);
<br/>
         samplesleft-=sam_until_modtick;
<br/>
         sam_until_modtick=0;
<br/>
      }//endif
<br/>
<br/>
      else{
<br/>
         mixer(cur_mixbuf,samplesleft);
<br/>
         sam_until_modtick-=samplesleft;
<br/>
         samplesleft=0;
<br/>
      }//endelse
<br/>
<br/>
   }//endwhile
<br/>
<br/>
}//end sndupdate procedure</td> </tr></table><span class="postbody">
<br/>
<br/>
Before, I just updated modtick on every VBLANK. and called the mixing routine also every VBLANK to mix the full buffersize (304).
<br/>
The above has no lengthy calculations and should not make much difference to the outcome of the modplayer, what am I doing wrong?
<br/>
<br/>
Thanks in advance</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
