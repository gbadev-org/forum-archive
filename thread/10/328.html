<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>my simple DMA sound routine doesn?t work ; ( why??? - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>Audio > my simple DMA sound routine doesn?t work ; ( why???</h2>
<div id="posts">
<div class="post">
    <h4>#2016 - rome - Mon Jan 27, 2003 7:55 pm</h4>
    <div class="postbody"><span class="postbody">here a simple code to play a song on the gba. this code just set DMA and play (dont stop to playing)
<br/>
but i cant heard anything.... what?s wrong on this code??? anybody can help me? thanks!
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#define u32 unsigned int
<br/>
#define u16 unsigned short
<br/>
#define s8  char
<br/>
<br/>
<br/>
<br/>
////////////////////////////////////////////////////////////////////////////////
<br/>
// Gunfire.h
<br/>
////////////////////////////////////////////////////////////////////////////////
<br/>
const s8 GunfireRawAudio[] =
<br/>
{
<br/>
      2,   4,   0,  -4,  ... this song continues... 
<br/>
                           (of course i wont list here)
<br/>
};
<br/>
<br/>
#define SOUND_FREQ 22050
<br/>
<br/>
#define GBA_FREQ 16777216  //GBA runs at 16,7 MHz
<br/>
<br/>
<br/>
// master registers
<br/>
<br/>
#define REG_SOUNDCNT_X *(u32*)0x04000084 // control all hardware chip sound of GBA
<br/>
#define REG_SOUNDCNT_H *(u32*)0x04000082 // control directsound channels
<br/>
#define REG_SOUNDCNT_L *(u32*)0x04000080 // control sound channels 1-4 (NOT USED BY US)
<br/>
<br/>
  // DMA channel 1 register definitions
<br/>
   #define REG_DMA1CNT         *(u32*)0x40000C4 //  control register
<br/>
   #define REG_DMA1SAD         *(u32*)0x40000BC //  source address
<br/>
   #define REG_DMA1DAD         *(u32*)0x40000C0 //  destination address
<br/>
<br/>
   // DMA flags
<br/>
    #define WORD_DMA            0x04000000
<br/>
    #define HALF_WORD_DMA       0x00000000
<br/>
    #define ENABLE_DMA          0x80000000
<br/>
    #define START_ON_FIFO_EMPTY 0x30000000
<br/>
    #define DMA_REPEAT          0x02000000
<br/>
    #define DEST_REG_SAME       0x00400000
<br/>
<br/>
   //  Timer 0 register definitions
<br/>
     #define REG_TM0D            *(u16*)0x4000100
<br/>
     #define REG_TM0CNT          *(u16*)0x4000102
<br/>
<br/>
   //   Timer flags
<br/>
      #define TIMER_ENABLED       0x0080
<br/>
<br/>
    //   FIFO address defines
<br/>
       #define REG_FIFO_A          0x040000A0
<br/>
       #define REG_FIFO_B          0x040000A4
<br/>
<br/>
<br/>
<br/>
<br/>
      //  flags defined
<br/>
        #define SND_ENABLED           0x00000080 // enable sound circuit
<br/>
        #define SND_OUTPUT_RATIO_25   0x0000 // general output sound volume (25 %)
<br/>
        #define SND_OUTPUT_RATIO_50   0x0001 // general output sound volume (25 %)
<br/>
        #define SND_OUTPUT_RATIO_100  0x0002  // general output sound volume (25 %)
<br/>
        #define DSA_OUTPUT_RATIO_50   0x0000  // output sound volume in channel A (25 %)
<br/>
        #define DSA_OUTPUT_RATIO_100  0x0004 // output sound volume in channel A
<br/>
        #define DSA_OUTPUT_TO_RIGHT   0x0100     // set output of channel A in right speaker
<br/>
        #define DSA_OUTPUT_TO_LEFT    0x0200     // set output of channel A in left speaker
<br/>
        #define DSA_OUTPUT_TO_BOTH    0x0300     // set output of channel A in both speakers
<br/>
        #define DSA_TIMER0            0x0000     // tell to GBA use timer0 to DirectSound A
<br/>
        #define DSA_TIMER1            0x0400     // tell to GBA use timer1 to DirectSound A
<br/>
        #define DSA_FIFO_RESET        0x0800     // reset FIFO to DirectSound A
<br/>
        #define DSB_OUTPUT_RATIO_50   0x0000     // flag to output sound volume in channel B (25 %)
<br/>
        #define DSB_OUTPUT_RATIO_100  0x0008     // flag to output sound volume in channel B (25 %)
<br/>
        #define DSB_OUTPUT_TO_RIGHT   0x1000     // set output of channel B in right speaker
<br/>
        #define DSB_OUTPUT_TO_LEFT    0x2000     // set output of channel B in left speaker
<br/>
        #define DSB_OUTPUT_TO_BOTH    0x3000     // set output of channel B in both speakers
<br/>
        #define DSB_TIMER0            0x0000     // tell to GBA use timer0 to DirectSound B
<br/>
        #define DSB_TIMER1            0x4000     // tell to GBA use timer1 to DirectSound B
<br/>
        #define DSB_FIFO_RESET        0x8000     // reset FIFO to DirectSound B
<br/>
<br/>
<br/>
// timer interval to refresh the FIFO
<br/>
#define TIMER_INTERVAL      (0xFFFF - GBA_FREQ/SOUND_FREQ)
<br/>
<br/>
int main(void)
<br/>
{
<br/>
   // enable sound circuit
<br/>
 REG_SOUNDCNT_X = SND_ENABLED;
<br/>
<br/>
<br/>
// we don`t want to mess with sound channels 1-4
<br/>
 REG_SOUNDCNT_L = 0;
<br/>
<br/>
 
<br/>
//  enable and reset Direct Sound channel A, at full volume, using
<br/>
//   Timer 0 to determine frequency
<br/>
REG_SOUNDCNT_H = SND_OUTPUT_RATIO_100 |
<br/>
                                DSA_OUTPUT_RATIO_100 |
<br/>
                                   DSA_OUTPUT_TO_BOTH |
<br/>
                                                   DSA_TIMER0 |
<br/>
                                             DSA_FIFO_RESET;
<br/>
<br/>
<br/>
<br/>
  //  set the timer to overflow at the appropriate frequency and start it
<br/>
    REG_TM0D   = TIMER_INTERVAL;
<br/>
    REG_TM0CNT = TIMER_ENABLED;
<br/>
<br/>
//start the DMA transfer (assume that GunfireRawAudio is a (signed char*)
<br/>
//     pointer to the buffer containing our sound data)
<br/>
<br/>
   REG_DMA1SAD = (u32)(GunfireRawAudio);
<br/>
   REG_DMA1DAD = (u32)REG_FIFO_A;
<br/>
   REG_DMA1CNT = ENABLE_DMA | 
<br/>
              START_ON_FIFO_EMPTY | 
<br/>
                               WORD_DMA | 
<br/>
                              DMA_REPEAT;
<br/>
<br/>
 while (1)
<br/>
 {
<br/>
<br/>
 }
<br/>
   return 0;
<br/>
}
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#2033 - darkcloud - Tue Jan 28, 2003 1:52 am</h4>
    <div class="postbody"><span class="postbody">Your TIMER_INTERVAL isn't being defined as anything.<br/>_________________<br/>Maybe in order to understand mankind, we have to look at the word itself: "Mankind". Basically, it's made up of two separate words - "mank" and "ind". What do these words mean ? It's a mystery, and that's why so is mankind.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#2036 - Splam - Tue Jan 28, 2003 2:34 am</h4>
    <div class="postbody"><span class="postbody">#define TIMER_INTERVAL      (0xFFFF - GBA_FREQ/SOUND_FREQ)
<br/>
<br/>
Just take a look here
<br/>
<br/>
<a href="http://www.belogic.com/gba/directsound.shtml" target="_blank">http://www.belogic.com/gba/directsound.shtml</a>
<br/>
<br/>
See what you might have missed, just ignore the 2nd timer for the sample end interrupt.</span><span class="gensmall"><br/><br/>Last edited by Splam on Tue Jan 28, 2003 2:40 am; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#2037 - darkcloud - Tue Jan 28, 2003 2:37 am</h4>
    <div class="postbody"><span class="postbody">oh lol whoops didn't see that<br/>_________________<br/>Maybe in order to understand mankind, we have to look at the word itself: "Mankind". Basically, it's made up of two separate words - "mank" and "ind". What do these words mean ? It's a mystery, and that's why so is mankind.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#2038 - darkcloud - Tue Jan 28, 2003 2:47 am</h4>
    <div class="postbody"><span class="postbody">ok well i think i learned how to do sound from the same place you did because i have that same code.  I put the code into a function, and I also created a struct called SAMPLE, SAMPLE's a pointer to the sound data, and an int telling how large the sample is.  Here's my function:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
void init_sfx_system(const SAMPLE *pSample, int timeInt)
<br/>
{
<br/>
    // turn on the sound chip
<br/>
    REG_SOUNDCNT_X = SND_ENABLED;
<br/>
<br/>
    // make sure sound channels 1-4 are turned off
<br/>
    REG_SOUNDCNT_L = 0;
<br/>
<br/>
    // set the direct sound output control register
<br/>
    REG_SOUNDCNT_H = SND_OUTPUT_RATIO_100 | // 100% sound output
<br/>
                     DSA_OUTPUT_RATIO_100 | // 100% direct sound A output
<br/>
                     DSA_OUTPUT_TO_BOTH |   // output Direct Sound A to both right and left speakers
<br/>
                     DSA_TIMER0 |           // use timer 0 to determine the playback frequency of Direct Sound A
<br/>
                     DSA_FIFO_RESET;        // reset the FIFO for Direct Sound A
<br/>
                     
<br/>
    REG_TM0D   = timeInt;
<br/>
    REG_TM0CNT = TIMER_ENABLED;
<br/>
    REG_DMA1SAD = (u32)(pSample-&gt;pData);
<br/>
   REG_DMA1DAD = (u32)REG_FIFO_A;
<br/>
    REG_DMA1CNT = ENABLE_DMA | START_ON_FIFO_EMPTY | WORD_DMA | DMA_REPEAT;
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
That's exactly how I do it.<br/>_________________<br/>Maybe in order to understand mankind, we have to look at the word itself: "Mankind". Basically, it's made up of two separate words - "mank" and "ind". What do these words mean ? It's a mystery, and that's why so is mankind.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
