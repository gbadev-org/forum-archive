<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Suggestions for replacement sound engine for OpenPok - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>Audio > Suggestions for replacement sound engine for OpenPok</h2>
<div id="posts">
<div class="post">
    <h4>#146805 - Kyoufu Kawa - Sun Dec 09, 2007 2:31 pm</h4>
    <div class="postbody"><span class="postbody">So yeah, I just came back from the search page and decided to post this.
<br/>
<br/>
OpenPok? started development on a pirated copy of the official Nintendo devkit. I admit this now because we've switched to devkitpro several months ago. The only thing left, besides some glue, is the <span style="font-style: italic">music engine</span>.
<br/>
<br/>
This engine, colloqually known as Sappy, M4A for short, uses converted MIDI files as source data. MIDI file goes in, gets the shit optimized out of it where possible (hello drumloop!), delta timing is replaced with wait commands etc. Instrument banks, here called voice groups, are linked to the song data allowing small sets that can be shared among songs.
<br/>
<br/>
It also plays sound effects by mixing in a second "song" which can have its own voice group.
<br/>
<br/>
OpenPok? plays monster cries like Pok?mon does: generate a short song in RAM and assign a small voice group with only one item to it, that item being the cry.
<br/>
<br/>
Problem is, aside from being illegal, that it's not very friendly to the average hobbyist.
<br/>
<br/>
My question is, what sound playback system can you guys suggest OpenPok? to use? It must be free and allow sound effects, preferably as described above.
<br/>
<br/>
Your assistance is appreciated.
<br/>
<br/>
<br/>
<span style="font-weight: bold">[Subject Fairy was here]</span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#149218 - Kyoufu Kawa - Wed Jan 16, 2008 9:35 pm</h4>
    <div class="postbody"><span class="postbody">I'm serious, you guys...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#149222 - DiscoStew - Wed Jan 16, 2008 10:22 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Kyoufu Kawa wrote:</b></span></td> </tr> <tr> <td class="quote">...aside from being illegal...</td> </tr></table><span class="postbody">
<br/>
<br/>
Wouldn't this be enough to not discuss it? We're glad you made the switch from illegally obtained software to what we all use, but since that sound engine is still part of the Nintendo devkit, discussing it (let alone even having it without permission) could bring about severe consequences to the community if we get involved.
<br/>
<br/>
Just like talking about commercial roms, it would be a very bad idea.<br/>_________________<br/><span style="font-weight: bold">DS</span> - It's all about <span style="font-weight: bold">D</span>isco<span style="font-weight: bold">S</span>tew</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#149280 - Kyoufu Kawa - Thu Jan 17, 2008 8:19 pm</h4>
    <div class="postbody"><span class="postbody">Yeah, I think you misread (part of) my story: I'm looking for something to <span style="font-style: italic">replace that last illegal part</span> with something legal. There's just certain criteria to it.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#149282 - gauauu - Thu Jan 17, 2008 9:46 pm</h4>
    <div class="postbody"><span class="postbody">I find it slightly confusing which parts of your description are just description of how you do it now, and which parts are your criteria for evaluating new engines.
<br/>
<br/>
It seems like most of the audio engines we see for gba (OpenPoke is gba, not DS, right?) are basically mod players.  Does your question imply that a basic mod player with the ability to include sound effects doesn't meet your needs?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#149285 - Kyoufu Kawa - Thu Jan 17, 2008 10:14 pm</h4>
    <div class="postbody"><span class="postbody">You're right. Let me restate this.
<br/>
<br/>
I need a music player for the GBA.
<br/>
<br/>
Most of all, it should be user-friendly.
<br/>
MIDI or MOD doesn't matter much.
<br/>
Sound effect capability is a must.
<br/>
The possibility to fade out the main track and overlay a short jingle would also be cool.*
<br/>
<br/>
Having a central instrument pool like MIDI does is a good thing as opposed to MOD files having their own pools.
<br/>
<br/>
It shouldn't require GBFS or whatever. Just binaries linked into the ROM and called by labelled pointer. What I intend to have is a big list of pointers to all the tracks so you can call them by number and/or #define'd ID.
<br/>
<br/>
* if you ever got an item or monster in the original games, you'll know what I'm going at here.
<br/>
<br/>
Edit: so yeah, it doesn't imply such.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#149287 - gauauu - Thu Jan 17, 2008 10:33 pm</h4>
    <div class="postbody"><span class="postbody">I found that Kusma's Pimpmobile works well. I had to get a couple of tweaks to his standard code from him to make it do sound effects, and it doesn't do any fancy stuff (not sure if it could do your fadeout jingle thing).
<br/>
<br/>
It's smart enough to not include samples from your mod files (XM files, technically) twice if they are the same sample included in multiple files.  So that's good.
<br/>
<br/>
But I'm sure there's a lot else out there that works as well (or better).
<br/>
<br/>
Edit:  I was going to include a link, but I can't seem to find a working one...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#149291 - dantheman - Thu Jan 17, 2008 11:42 pm</h4>
    <div class="postbody"><span class="postbody">The "MOD Players" section of <a href="http://members.iinet.net.au/~freeaxs/gbacomp/" target="_blank">http://members.iinet.net.au/~freeaxs/gbacomp/</a> may help out.  All the code is for DevKitAdv, not DevKitARM, but at least it's a starting point.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#149298 - kusma - Fri Jan 18, 2008 12:49 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>gauauu wrote:</b></span></td> </tr> <tr> <td class="quote">Edit:  I was going to include a link, but I can't seem to find a working one...</td> </tr></table><span class="postbody">
<br/>
Yeah, I'm sorry about that. The site is still <a class="postlink" href="http://pimpmobile.kjip.no/" target="_blank">http://pimpmobile.kjip.no/</a>, but there's some problems with the host's ISP. I'm a bit tempted to move the project to sourceforge.net just for stability's sake.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#149345 - Kyoufu Kawa - Fri Jan 18, 2008 8:14 pm</h4>
    <div class="postbody"><span class="postbody">Well, Pimpmobile sounds good enough. If you (Kusma?) can get the missing features in, which I doubt I could do myself, that'd be great.
<br/>
<br/>
Until then, I'm gonna take a look at that page dantheman linked.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#149351 - kusma - Fri Jan 18, 2008 9:08 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Kyoufu Kawa wrote:</b></span></td> </tr> <tr> <td class="quote">Well, Pimpmobile sounds good enough. If you (Kusma?) can get the missing features in, which I doubt I could do myself, that'd be great.</td> </tr></table><span class="postbody">
<br/>
Sure, what exactly do you want? Will volume-control (which is already kind of there) and pause (which shouldn't be too hard), plus the ability to swap the modules that use the mixer do for the jingle-support? The idea was to just set the volume a step down each frame, and when it reaches zero, you pause, play another module, and resume...
<br/>
Sound effect support is also "kind of" there (you can program the mixer directly), but  I haven't decided yet if I want a "public" interface to that or not. There's already a shared sample-bank (or sample pool) to save space if all modules are converted in one go (you would usually make this a step in your makefile anyway), and there's no requirement for anything special when loading, apart from 32bit alignment of the data in the GBA ROM.
<br/>
<br/>
Oh, and a lot of improvements has happened to the library, but it's not released yet. I never told anyone where to find the SVN before now, but <a class="postlink" href="https://svn.kjip.no/svn/pimpmobile/" target="_blank">here you go</a>. As said before, the server is quite unstable at the moment, so you'll probably give it a few attempts to manage to check it out.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#149406 - Kyoufu Kawa - Sat Jan 19, 2008 8:19 pm</h4>
    <div class="postbody"><span class="postbody">Yeah, in the original the main track just continued to play on mute so if you whistled along you'd stay aligned when the jingle finished. This is not a problem though. Too minor to care.
<br/>
<br/>
Sound effects used to be short pieces of song data, but I guess... prerendering them (by lack of better term) wouldn't cause things to sound very different, and monster cries should be a cakewalk from there.
<br/>
<br/>
What I do somewhat care about is what Pimpmobile is written in. ASM? C? C++?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#149435 - gauauu - Sun Jan 20, 2008 1:08 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>kusma wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
Sound effect support is also "kind of" there (you can program the mixer directly), but  I haven't decided yet if I want a "public" interface to that or not. </td> </tr></table><span class="postbody">
<br/>
<br/>
Just out of curiosity, why wouldn't you make it public?  It seems to be a pretty standard feature for a sound engine....</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#149436 - kusma - Sun Jan 20, 2008 1:26 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>gauauu wrote:</b></span></td> </tr> <tr> <td class="quote">Just out of curiosity, why wouldn't you make it public?  It seems to be a pretty standard feature for a sound engine....</td> </tr></table><span class="postbody">
<br/>
Because a public interface is a bigger support-burden, and before I'd like to tie the interface, I'd prefer having a proper channel-allocator or something. Perhaps I'm just over-thinking things, though...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#149479 - Kyoufu Kawa - Sun Jan 20, 2008 9:53 pm</h4>
    <div class="postbody"><span class="postbody">But what is it written in? ASM, C or C++?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#149480 - thoduv - Sun Jan 20, 2008 10:04 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Kyoufu Kawa wrote:</b></span></td> </tr> <tr> <td class="quote">But what is it written in? ASM, C or C++?</td> </tr></table><span class="postbody">
<br/>
Sources are available.
<br/>
It's pure C, plus an optimized ARM mixer.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#149528 - Kyoufu Kawa - Mon Jan 21, 2008 7:32 pm</h4>
    <div class="postbody"><span class="postbody">Well, thanks and excuse me. That's the answer I was hoping for, and the SVN was unreachable when I tried so I couldn't see.
<br/>
<br/>
Let's try again... nope, nothing but a white screen. I'm willing to blame proxies beyond my control, though. I'll try again when I'm home.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#149545 - DiscoStew - Mon Jan 21, 2008 10:06 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Kyoufu Kawa wrote:</b></span></td> </tr> <tr> <td class="quote">Yeah, I think you misread (part of) my story: I'm looking for something to <span style="font-style: italic">replace that last illegal part</span> with something legal. There's just certain criteria to it.</td> </tr></table><span class="postbody">
<br/>
<br/>
Sorry, my mistake. I think I got more focused on that you told us what that audio engine did, and therefore my "illegal" light came on.<br/>_________________<br/><span style="font-weight: bold">DS</span> - It's all about <span style="font-weight: bold">D</span>isco<span style="font-weight: bold">S</span>tew</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#149614 - Kyoufu Kawa - Tue Jan 22, 2008 8:35 pm</h4>
    <div class="postbody"><span class="postbody">My mistake as well. No harm done?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#149621 - tepples - Tue Jan 22, 2008 9:05 pm</h4>
    <div class="postbody"><span class="postbody">I'll call the Subject Fairy to make things clearer.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#149632 - kusma - Tue Jan 22, 2008 10:40 pm</h4>
    <div class="postbody"><span class="postbody">allright, now the pimpmobile project have been moved to sourceforge. Go <a class="postlink" href="http://sourceforge.net/projects/pimpmobile/" target="_blank">here</a> to find it.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#149636 - Lord Graga - Wed Jan 23, 2008 3:14 am</h4>
    <div class="postbody"><span class="postbody">How come that I see several / and % operators in the code? The compiler started handling them well?
<br/>
What's with all the floating point? :P (1.0 / (SAMPLERATE))
<br/>
<br/>
Oh, and how can this compile into one instruction?
<br/>
<br/>
	/* BEHOLD: the expression of the devil 2.0 (this compiles to one arm-instruction) */
<br/>
	const unsigned int scale = (unsigned int)(((1.0 / (SAMPLERATE)) * (1 &lt;&lt; 6)) * (1LL &lt;&lt; 32));
<br/>
	delta = ((long long)delta * scale + (1ULL &lt;&lt; 31)) &gt;&gt; 32;
<br/>
<br/>
<br/>
*looks around confused and slightly amazed*
<br/>
<br/>
And another one:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
00000018 &lt;__pimp_get_linear_delta&gt;:
<br/>
.....
<br/>
  54:   e3a07102    mov   r7, #-2147483648   ; 0x80000000
<br/>
  58:   e3a08000    mov   r8, #0   ; 0x0
<br/>
  5c:   e0955007    adds   r5, r5, r7
<br/>
  60:   e0a66008    adc   r6, r6, r8
<br/>
  64:   e3a04000    mov   r4, #0   ; 0x0
<br/>
  68:   e1a00006    mov   r0, r6
<br/>
  6c:   e8bd01f0    ldmia   sp!, {r4, r5, r6, r7, r8}
<br/>
.....
<br/>
</td> </tr></table><span class="postbody">
<br/>
Is there something that I am misunderstanding, or couldn't the compiler just skip out setting r7 to 0x80000000 and do adds r5,r5,#0x8000000 instead of offset 5C?</span><span class="gensmall"><br/><br/>Last edited by Lord Graga on Wed Jan 23, 2008 3:26 am; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#149639 - eKid - Wed Jan 23, 2008 3:26 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Lorg Graga wrote:</b></span></td> </tr> <tr> <td class="quote">What's with all the floating point? :P (1.0 / (SAMPLERATE))</td> </tr></table><span class="postbody">
<br/>
It's a constant expression casted to unsigned int...
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Lorg Graga wrote:</b></span></td> </tr> <tr> <td class="quote">/* BEHOLD: the expression of the devil 2.0 (this compiles to one arm-instruction) */
<br/>
const unsigned int scale = (unsigned int)(((1.0 / (SAMPLERATE)) * (1 &lt;&lt; 6)) * (1LL &lt;&lt; 32));
<br/>
delta = ((long long)delta * scale + (1ULL &lt;&lt; 31)) &gt;&gt; 32; </td> </tr></table><span class="postbody">
<br/>
It can probably be done with ARM's multiply long instructions. But I would think there would be at least another instruction to load the 'scale' constant into a register?</span><span class="gensmall"><br/><br/>Last edited by eKid on Thu Jan 24, 2008 3:28 pm; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#149647 - kusma - Wed Jan 23, 2008 10:46 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Lorg Graga wrote:</b></span></td> </tr> <tr> <td class="quote">What's with all the floating point? :P (1.0 / (SAMPLERATE))</td> </tr></table><span class="postbody">
<br/>
As eKid points out, it's all a constant expression that the compiler is allowed to (and does - we've checked the generated assembly) constant-fold.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>eKid wrote:</b></span></td> </tr> <tr> <td class="quote">It can probably be done with ARM's multiply long instructions. But I would think there would be at least another instruction to load the 'scale' constant into a register?</td> </tr></table><span class="postbody">
<br/>
Correct. This isn't a THAT critical function anyway, it's only called maximum once per channel per tick. We just wanted to make sure we didn't do something massively stupid / required to link to the floating-point library. By the way, this code has been scheduled to be refactored a bit, so the mixing-rate can be changed at run-time. Once that's done, it might require a run-time evaluation of that expression each time the sampling-rate is changed. Shouldn't be that big of a deal, IMO.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#149680 - Kyoufu Kawa - Wed Jan 23, 2008 8:37 pm</h4>
    <div class="postbody"><span class="postbody">Downloading...
<br/>
<br/>
Well, this seems interesting. In a good way.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#150240 - Kyoufu Kawa - Thu Jan 31, 2008 10:06 pm</h4>
    <div class="postbody"><span class="postbody">Would you guys attack me if I said "imitation M4A"?</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
