<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>DMA Timing - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>Audio > DMA Timing</h2>
<div id="posts">
<div class="post">
    <h4>#15756 - animension - Thu Jan 29, 2004 5:31 am</h4>
    <div class="postbody"><span class="postbody">Ok, I just spent hours pulling my hair out trying to figure something out. Some info about what I'm doing with a sound renderer:
<br/>
<br/>
1) Set up a sound buffer of 128 bytes x 2 = 256 bytes, and initialize all to 0
<br/>
2) Set up an active buffer flag, initialized to 0
<br/>
3) Set up Timer 0 to (0xFFFF - 1024) // 16384 Hz
<br/>
4) Set up Timer 1 to increment on Timer 0 overflow, initial count (0xFFFF - 128) + Enable IRQ
<br/>
5) Set up Timer 1 IRQ handler to do the following in ARM ASM in roughly 35 cycles:
<br/>
- Store REG_IE state into stack, clear VBL bit, and overwrite REG_IE to disable VBL
<br/>
- Toggle active buffer
<br/>
- If switching to second half, don't reset DMA -- it'll start reading second half on its own
<br/>
- else: disable DMA, reset address to buffer start, enableDMA
<br/>
- Restore REG_IE state from stack, and overwrite REG_IE with previous state
<br/>
- return
<br/>
<br/>
What I've been banging my head against my desk for the last 2-3 hours is this, taken from the logging function of VBA(Win32) for my DMA transfers
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
256 byte sound buffer starts at 0x03000bd8
<br/>
<br/>
DMA2: s=03000bd8 d=040000a4 c=b600 count=00000010
<br/>
DMA2: s=03000be8 d=040000a4 c=b600 count=00000010
<br/>
DMA2: s=03000bf8 d=040000a4 c=b600 count=00000010
<br/>
DMA2: s=03000c08 d=040000a4 c=b600 count=00000010
<br/>
DMA2: s=03000c18 d=040000a4 c=b600 count=00000010
<br/>
DMA2: s=03000c28 d=040000a4 c=b600 count=00000010
<br/>
DMA2: s=03000c38 d=040000a4 c=b600 count=00000010
<br/>
DMA2: s=03000c48 d=040000a4 c=b600 count=00000010
<br/>
DMA2: s=03000c58 d=040000a4 c=b600 count=00000010
<br/>
DMA2: s=03000c68 d=040000a4 c=b600 count=00000010
<br/>
DMA2: s=03000c78 d=040000a4 c=b600 count=00000010
<br/>
DMA2: s=03000c88 d=040000a4 c=b600 count=00000010
<br/>
DMA2: s=03000c98 d=040000a4 c=b600 count=00000010
<br/>
DMA2: s=03000ca8 d=040000a4 c=b600 count=00000010
<br/>
DMA2: s=03000cb8 d=040000a4 c=b600 count=00000010
<br/>
DMA2: s=03000cc8 d=040000a4 c=b600 count=00000010
<br/>
<span style="font-weight: bold">DMA2: s=03000cd8 d=040000a4 c=b600 count=00000010</span>
<br/>
DMA2: s=03000bd8 d=040000a4 c=b600 count=00000010
<br/>
DMA2: s=03000be8 d=040000a4 c=b600 count=00000010
<br/>
DMA2: s=03000bf8 d=040000a4 c=b600 count=00000010
<br/>
DMA2: s=03000c08 d=040000a4 c=b600 count=00000010
<br/>
DMA2: s=03000c18 d=040000a4 c=b600 count=00000010
<br/>
DMA2: s=03000c28 d=040000a4 c=b600 count=00000010
<br/>
DMA2: s=03000c38 d=040000a4 c=b600 count=00000010
<br/>
DMA2: s=03000c48 d=040000a4 c=b600 count=00000010
<br/>
DMA2: s=03000c58 d=040000a4 c=b600 count=00000010
<br/>
DMA2: s=03000c68 d=040000a4 c=b600 count=00000010
<br/>
DMA2: s=03000c78 d=040000a4 c=b600 count=00000010
<br/>
DMA2: s=03000c88 d=040000a4 c=b600 count=00000010
<br/>
DMA2: s=03000c98 d=040000a4 c=b600 count=00000010
<br/>
DMA2: s=03000ca8 d=040000a4 c=b600 count=00000010
<br/>
DMA2: s=03000cb8 d=040000a4 c=b600 count=00000010
<br/>
DMA2: s=03000cc8 d=040000a4 c=b600 count=00000010
<br/>
DMA2: s=03000bd8 d=040000a4 c=b600 count=00000010
<br/>
DMA2: s=03000be8 d=040000a4 c=b600 count=00000010
<br/>
DMA2: s=03000bf8 d=040000a4 c=b600 count=00000010
<br/>
DMA2: s=03000c08 d=040000a4 c=b600 count=00000010
<br/>
DMA2: s=03000c18 d=040000a4 c=b600 count=00000010
<br/>
DMA2: s=03000c28 d=040000a4 c=b600 count=00000010
<br/>
DMA2: s=03000c38 d=040000a4 c=b600 count=00000010
<br/>
DMA2: s=03000c48 d=040000a4 c=b600 count=00000010
<br/>
DMA2: s=03000c58 d=040000a4 c=b600 count=00000010
<br/>
DMA2: s=03000c68 d=040000a4 c=b600 count=00000010
<br/>
DMA2: s=03000c78 d=040000a4 c=b600 count=00000010
<br/>
DMA2: s=03000c88 d=040000a4 c=b600 count=00000010
<br/>
DMA2: s=03000c98 d=040000a4 c=b600 count=00000010
<br/>
DMA2: s=03000ca8 d=040000a4 c=b600 count=00000010
<br/>
DMA2: s=03000cb8 d=040000a4 c=b600 count=00000010
<br/>
DMA2: s=03000cc8 d=040000a4 c=b600 count=00000010
<br/>
<span style="font-weight: bold">DMA2: s=03000cd8 d=040000a4 c=b600 count=00000010</span>
<br/>
DMA2: s=03000bd8 d=040000a4 c=b600 count=00000010
<br/>
DMA2: s=03000be8 d=040000a4 c=b600 count=00000010
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Where the lines are bold is where VBA is telling me that the DMA is transferring 16 bytes of data <span style="font-style: italic">past my buffer</span> onto the FIFO! The problem is that it's not consistently doing it, but VBA does show that it *is* doing it. This is causing some noise to be sent to the FIFO and is extremely annoyying, considering the timer 1 IRQ handler is stopping the DMA within ~15 cycles after the IRQ handler is called when the DMA controller needs to wrap back to the beginning of the buffer. I even changed it so that the controller is stopped first thing (within 4 cycles of entering IRQ handler) and it made no noticable difference. Any suggestions would be most welcome.<br/>_________________<br/>"Beer is proof that God loves us and wants us to be happy."
<br/>
-- Benjamin Franklin</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#15760 - poslundc - Thu Jan 29, 2004 3:07 pm</h4>
    <div class="postbody"><span class="postbody">This might be a silly question, but are you remembering to set REG_IF at the end of your ISR?
<br/>
<br/>
As for what's causing your extra-DMA problem, I'm pretty sure you should be setting your Timer 1's initial count to (0xFFFF - 127), not (0xFFFF - 128). The latter will take 129 sound-chip-cycles to overflow, which may be causing your extra DMA problem.
<br/>
<br/>
For that matter, you should be setting Timer0 to (0xFFFF - 1023) for greatest accuracy. (Or do what I did and just set it to 0xFFFF and set the timer's frequency to 16 KHz instead of full clock speed.)
<br/>
<br/>
Hope this helps,
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#15761 - Lord Graga - Thu Jan 29, 2004 4:09 pm</h4>
    <div class="postbody"><span class="postbody">proslundc: Wouldn't it be the other way around? :P
<br/>
As in:
<br/>
(0xFFFF - 129)
<br/>
<br/>
I don't know much about sound though, sorry if I am wrong :P</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#15763 - poslundc - Thu Jan 29, 2004 5:20 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Lord Graga wrote:</b></span></td> </tr> <tr> <td class="quote">proslundc: Wouldn't it be the other way around? :P
<br/>
As in:
<br/>
(0xFFFF - 129)</td> </tr></table><span class="postbody">
<br/>
<br/>
That would make the interrupt fire every 130 timer-cycles. Remember, the timer value counts <span style="font-weight: bold">up</span> and it triggers on overflow.
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#15766 - Lord Graga - Thu Jan 29, 2004 6:16 pm</h4>
    <div class="postbody"><span class="postbody">heh, that's right, poslundc ;)
<br/>
<br/>
Thanks for pointing it out :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#15772 - animension - Thu Jan 29, 2004 7:47 pm</h4>
    <div class="postbody"><span class="postbody">Oh no... my first "off by one" bug... Something so simple that I should have seen it. That did the trick. Thanks!<br/>_________________<br/>"Beer is proof that God loves us and wants us to be happy."
<br/>
-- Benjamin Franklin</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
