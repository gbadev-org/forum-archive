<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Audio mixer - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>Audio > Audio mixer</h2>
<div id="posts">
<div class="post">
    <h4>#35923 - gbawiz - Sun Feb 13, 2005 12:38 am</h4>
    <div class="postbody"><span class="postbody">Hello,
<br/>
I have a question about the interrupt routine of audio mixers.
<br/>
<br/>
Do the swapping of buffers and the mixing routine have to be done inside the VBLANK interrupt?
<br/>
<br/>
My audio mixing program is running too slow and I cannot find the reason why.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#35924 - tepples - Sun Feb 13, 2005 1:05 am</h4>
    <div class="postbody"><span class="postbody">In a <a class="postlink" href="http://www.pineight.com/gba/samplerates/" target="_blank">vblank-synchronized mixer</a>, the buffer swap has to happen immediately after vblank, but mixing can happen anytime.
<br/>
<br/>
However, if your mixer is taking longer than vblank, it's probably taking too long. Have you compiled it as ARM code with -O3 and put it in IWRAM?<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#35949 - gbawiz - Sun Feb 13, 2005 3:01 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tepples wrote:</b></span></td> </tr> <tr> <td class="quote">In a <a class="postlink" href="http://www.pineight.com/gba/samplerates/" target="_blank">vblank-synchronized mixer</a>, the buffer swap has to happen immediately after vblank, but mixing can happen anytime.
<br/>
<br/>
However, if your mixer is taking longer than vblank, it's probably taking too long. Have you compiled it as ARM code with -O3 and put it in IWRAM?</td> </tr></table><span class="postbody">
<br/>
<br/>
Hello,
<br/>
Thanks tepples,
<br/>
<br/>
My mixer routine is in assembly and is stored in IWRAM which seemed to speed the mixer up a little bit. Im not sure about the -O3 option, does this only work when compiling the C source?
<br/>
<br/>
I have a few questions:
<br/>
<br/>
1.) Can a four channel mixer be written in C source and work perfectly or does it have to be written in assembly?
<br/>
<br/>
2.)Do the mixing routines need to be stored in IWRAM in order for them to work?
<br/>
<br/>
3.)can the compiler affect how fast the code will run?
<br/>
<br/>
I have been trying to get my mixer routine working for some time now and without success.
<br/>
<br/>
I would be grateful for any advice
<br/>
Many thanks</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#35955 - tepples - Sun Feb 13, 2005 4:54 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>gbawiz wrote:</b></span></td> </tr> <tr> <td class="quote">My mixer routine is in assembly and is stored in IWRAM which seemed to speed the mixer up a little bit.</td> </tr></table><span class="postbody">
<br/>
You were one step ahead of me.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Im not sure about the -O3 option, does this only work when compiling the C source?</td> </tr></table><span class="postbody">
<br/>
Yes.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">1.) Can a four channel mixer be written in C source and work perfectly or does it have to be written in assembly?</td> </tr></table><span class="postbody">
<br/>
The mixer from <a class="postlink" href="http://www.pineight.com/gba/#tod" target="_blank">TOD</a> is in C, and it works fine with multiple channels.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">2.)Do the mixing routines need to be stored in IWRAM in order for them to work?</td> </tr></table><span class="postbody">
<br/>
In order for them to work in real time with a decent number of channels at a decent sample rate, you need them to be in zero wait state RAM, and this is IWRAM.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">3.)can the compiler affect how fast the code will run?</td> </tr></table><span class="postbody">
<br/>
Yes. ARM's expensive compiler (if you have to ask, you can't afford it) is rumored to generate faster code than GCC can.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">I have been trying to get my mixer routine working for some time now and without success.</td> </tr></table><span class="postbody">
<br/>
Working, or working in real time? If you just want working, to where you'll make optimizations later, try making a reference implementation in C using the Allegro library.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#35997 - gbawiz - Sun Feb 13, 2005 11:14 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">The mixer from <a class="postlink" href="http://www.pineight.com/gba/#tod" target="_blank">TOD</a> is in C, and it works fine with multiple channels.</td> </tr></table><span class="postbody">
<br/>
<br/>
Thanks,
<br/>
I have looked at the file gbmxr.c and have tried to implement it into my program for testing.
<br/>
One thing Im not sure is about the frequency to play at.
<br/>
i.e I have a sample at 8192hz
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">gbmxr_voices[0].sample_rate=8192 </td> </tr></table><span class="postbody">
<br/>
makes the sample sound awful and really high pitched with noise.
<br/>
<br/>
What number should I try to make the sample sound correct?
<br/>
Thanks again</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#36001 - tepples - Sun Feb 13, 2005 11:47 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>gbawiz wrote:</b></span></td> </tr> <tr> <td class="quote">I have looked at the file gbmxr.c and have tried to implement it into my program for testing.
<br/>
One thing Im not sure is about the frequency to play at.
<br/>
i.e I have a sample at 8192hz
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">gbmxr_voices[0].sample_rate=8192 </td> </tr></table><span class="postbody">
<br/>
makes the sample sound awful and really high pitched with noise.
<br/>
<br/>
What number should I try to make the sample sound correct?
<br/>
Thanks again</span></td> </tr></table><span class="postbody">
<br/>
It uses 16.16 fixed-point sample rates relative to the mixing rate. For example, use the real sample rate * 65536 / 18157 Hz.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#36388 - gbawiz - Fri Feb 18, 2005 5:19 pm</h4>
    <div class="postbody"><span class="postbody">Hello,
<br/>
I have completed my audio mixer and it works fine when I program using 'C' code and install object into IWRAM.
<br/>
One thing which I could not understand is that ASM was supposed to be faster than 'C' yet it turned out to be way too slow when I programmed my stepsample routine in ASM.
<br/>
I Must have left something out.
<br/>
<br/>
Someone mentioned 'wait states'
<br/>
are these something which I would have to learn to create when programming in ASM or are these created by the compiler
<br/>
<br/>
Thanks</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#36392 - poslundc - Fri Feb 18, 2005 6:18 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>gbawiz wrote:</b></span></td> </tr> <tr> <td class="quote">Hello,
<br/>
I have completed my audio mixer and it works fine when I program using 'C' code and install object into IWRAM.
<br/>
One thing which I could not understand is that ASM was supposed to be faster than 'C' yet it turned out to be way too slow when I programmed my stepsample routine in ASM.
<br/>
I Must have left something out.</td> </tr></table><span class="postbody">
<br/>
<br/>
Assembly is neither inherently faster or slower than C. The job of the C compiler is to translate your C code into the most optimal assembly code that it can. Try running GCC with the -S switch and see the intermediary assembly code it generates off of your C code.
<br/>
<br/>
The idea behind programming in assembly directly is that if you are smarter than the compiler, you can generate better code than it can.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Someone mentioned 'wait states'
<br/>
are these something which I would have to learn to create when programming in ASM or are these created by the compiler</td> </tr></table><span class="postbody">
<br/>
<br/>
Wait states are the number of cycles it takes to perform a read or write to memory. Each area of memory on the GBA has its own waitstates. IWRAM has a waitstate of 0, which means a read or write to memory takes only a single cycle. This makes it a very good place to run code out of or put data that you will have to rigorously access, but you only have 32K of it.
<br/>
<br/>
EWRAM and cartridge ROM both take much longer to read data out of. (There are a number of factors that determine whether EWRAM or ROM is the faster of the two, but generally ROM is faster for sequential access and EWRAM is faster for random access.) So if you have a bunch of LDRs in your assembly code pointing to random areas of ROM, it might wind up being much slower than the assembly code generated by your C compiler.
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
