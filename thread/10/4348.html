<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Volume Envelopes - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>Audio > Volume Envelopes</h2>
<div id="posts">
<div class="post">
    <h4>#28766 - ProblemBaby - Fri Nov 05, 2004 6:50 pm</h4>
    <div class="postbody"><span class="postbody">Hi, Iam working with my XM-player and now i want to add support for Volume Envelopes I read this in The XM spec:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
The envelopes are processed once per frame, instead of every frame where
<br/>
   no new notes are read. This is also true for the instrument vibrato and
<br/>
   the fadeout. Since I am so lazy and the tracker is rather self-explaining
<br/>
   I am not going to write any more for the moment.
<br/>
<br/>
   - max x value: 0x144 = 324d (for enveloppe points)
<br/>
   - max y value: 0x40  = 64d  (for enveloppe points)
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
First: What is a frame?
<br/>
Second: To anyone have a nice idea of how to do it without divisions?
<br/>
<br/>
And why, why is max x value 0x144 is that some kind of value that should be known in the tracker world?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#28768 - Lord Graga - Fri Nov 05, 2004 7:35 pm</h4>
    <div class="postbody"><span class="postbody">a frame is one screenupdate. Happends every nearly 1/60th second.
<br/>
<br/>
Where the hell do you divide? :P</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#28781 - tepples - Fri Nov 05, 2004 10:51 pm</h4>
    <div class="postbody"><span class="postbody">The concept of a "frame" in tracked music is not the same as the concept of a "frame" in video programming. In tracked music, a "frame" is a 96th note, of which there are 24 in a "beat" as measured by the Beats Per Minute. For example, for a tempo of 125 beats per minute, there are 125 * 24 = 3000 "frames" per minute, or 50 "frames" per second.
<br/>
<br/>
Only at 150 BPM does the replayer engine run at 60 "frames" per second.
<br/>
<br/>
The Bresenham (divideless) way to approximate a variable rate frame counter for .mod, .s3m, .xm, or .it music is this: Every vblank, add the tempo to an internal counter, and every time the counter passes 150, run envelopes and effects and then subtract 150 from the counter. With a tempo over 150, it may overflow more than once in a frame, so use a 'while' loop rather than an 'if' statement.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#28783 - bertsnks - Fri Nov 05, 2004 11:23 pm</h4>
    <div class="postbody"><span class="postbody">i think he means the envelope delta values that have to be calculated between 2 points</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#28793 - ProblemBaby - Sat Nov 06, 2004 2:56 am</h4>
    <div class="postbody"><span class="postbody">Tepples: Thanks for that information!
<br/>
<br/>
bertsnks: You are right, that was what I also thinked of</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#28794 - tepples - Sat Nov 06, 2004 5:14 am</h4>
    <div class="postbody"><span class="postbody">Envelope delta values can be Bresenham'd as well.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#28797 - ProblemBaby - Sat Nov 06, 2004 12:00 pm</h4>
    <div class="postbody"><span class="postbody">How?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#28801 - tepples - Sat Nov 06, 2004 2:51 pm</h4>
    <div class="postbody"><span class="postbody">For an envelope represented as distance over time, you add distance every frame, and every time it goes over, subtract time and move the volume by 1.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#28925 - bertsnks - Mon Nov 08, 2004 8:04 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tepples wrote:</b></span></td> </tr> <tr> <td class="quote">For an envelope represented as distance over time, you add distance every frame, and every time it goes over, subtract time and move the volume by 1.</td> </tr></table><span class="postbody">
<br/>
<br/>
If you are using the Bresenham algorithm, slopes where the delta y is greater than the delta x can get tricky. Most guides propose to switch x with y, but this is not possible with envelopes since you need the value for the next x. Any hints on speeding this up tepples?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#28926 - tepples - Mon Nov 08, 2004 8:17 pm</h4>
    <div class="postbody"><span class="postbody">Finding the height of the envelope at a given time is exactly the same problem as polygon rasterization, also called scan conversion, but with only one edge rather than two. <a class="postlink" href="http://www.google.com/search?q=scan%20conversion" target="_blank">Use Google</a>.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#28930 - bertsnks - Mon Nov 08, 2004 8:44 pm</h4>
    <div class="postbody"><span class="postbody">ok, thanks for the quick reply :).
<br/>
<br/>
But, doesn't scan conversion for a polygon mean you would need the gradient, and waste a divide? (gradient = dx/dy)
<br/>
<br/>
and correct me if i'm wrong, but doesn't a polygon scan conversion move y wise, while envelopes move x wise?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#28932 - tepples - Mon Nov 08, 2004 9:22 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>bertsnks wrote:</b></span></td> </tr> <tr> <td class="quote">But, doesn't scan conversion for a polygon mean you would need the gradient, and waste a divide? (gradient = dx/dy)</td> </tr></table><span class="postbody">
<br/>
If you're using a DDA scan conversion, yes. However, you can make a table of possible values of dy and then use reciprocal multiplication. Or you can stick a fast (sub 60 cycle) divide algorithm in IWRAM along with your mixer. Or turn the slope of the envelope into a mixed number, add the whole part every frame, and do Bresenham on the fractional part.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">and correct me if i'm wrong, but doesn't a polygon scan conversion move y wise, while envelopes move x wise?</td> </tr></table><span class="postbody">
<br/>
As you said, "Most guides propose to switch x with y".<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#28934 - bertsnks - Mon Nov 08, 2004 9:50 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tepples wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>bertsnks wrote:</b></span></td> </tr> <tr> <td class="quote">But, doesn't scan conversion for a polygon mean you would need the gradient, and waste a divide? (gradient = dx/dy)</td> </tr></table><span class="postbody">
<br/>
If you're using a DDA scan conversion, yes. However, you can make a table of possible values of dy and then use reciprocal multiplication. Or you can stick a fast (sub 60 cycle) divide algorithm in IWRAM along with your mixer. Or turn the slope of the envelope into a mixed number, add the whole part every frame, and do Bresenham on the fractional part.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">and correct me if i'm wrong, but doesn't a polygon scan conversion move y wise, while envelopes move x wise?</td> </tr></table><span class="postbody">
<br/>
As you said, "Most guides propose to switch x with y".</span></td> </tr></table><span class="postbody">
<br/>
<br/>
Ok, those options sound good; but just for the sake of it, i am not understanding the slope with the 'mixed number' method, can you please explain this some more?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#28950 - tepples - Tue Nov 09, 2004 2:41 am</h4>
    <div class="postbody"><span class="postbody">Say you have to increase volume by 13 over a time span of 4 units. Therefore, your slope is 13/4. This is a "slope where the delta y is greater than the delta x", that is, an improper fraction. Break it up using one division (calling BIOS Div should be fast enough, or you can use custom ARM code in IWRAM linked to in the Beginners' FAQ), and you get 3 remainder 1, or 3+1/4. So increase the volume by 3 every tick and then use the Bresenham algorithm to increase by 1 every 4 ticks.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#29003 - Miked0801 - Wed Nov 10, 2004 1:32 am</h4>
    <div class="postbody"><span class="postbody">Or bitwise and 0x03 for mod and shift :)  (for this denominator only I know)</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
