<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Inline Assm Problems - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>Beginners > Inline Assm Problems</h2>
<div id="posts">
<div class="post">
    <h4>#11181 - Twentyfourracing - Sun Sep 28, 2003 2:53 pm</h4>
    <div class="postbody"><span class="postbody">Hello,
<br/>
<br/>
I seem to be having a small problem getting this to compile.
<br/>
I am very new to GBA and GCC. I am trying to us an asm function, 1. for small code space, 2. it's just faster(over all)......?
<br/>
I know you can just use a C type function, but it compiles a little bigger then the asm version.....
<br/>
<br/>
Here is what I am trying to inline.....
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void vblk()
<br/>
{
<br/>
                 __asm volatile( " 
<br/>
                                         mov    r0, #0x4000006
<br/>
                               wait:   ldrh     r1,[r0]
<br/>
                                         cmp      r1, #160
<br/>
                                         bne      wait");
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
<br/>
Thank you.....
<br/>
<br/>
Steve</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#11184 - tepples - Sun Sep 28, 2003 3:48 pm</h4>
    <div class="postbody"><span class="postbody">First of all, whenever you say you have problems, you should always include the error messages verbatim.
<br/>
<br/>
Now, I can see a problem in 'mov'. The ARM architecture doesn't like immediate constants whose bits are spread out across the word.  Try building the constant up in two instructions:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">mov r0, #0x4000000
<br/>
orr r0, r0, #0x00000006</td> </tr></table><span class="postbody">
<br/>
There is a more general solution involving constant pools, but constant pools are tricky to deal with in inline assembly.
<br/>
<br/>
EDIT: minor syntax glitch from not having written any serious ARM assembly language from scratch<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"><br/><br/>Last edited by tepples on Mon Sep 29, 2003 3:49 am; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#11185 - Twentyfourracing - Sun Sep 28, 2003 4:33 pm</h4>
    <div class="postbody"><span class="postbody">Yep....... I think I left it out....Hmmm......
<br/>
<br/>
Here are the error msg's.....
<br/>
<br/>
C:/GBA/test/test.c:80:25: warning: multi-line string literals are deprecated
<br/>
/cygdrive/c/DOCUME~1/ADMINI~1/LOCALS~1/Temp/ccXseucb.s: Assembler messages:
<br/>
/cygdrive/c/DOCUME~1/ADMINI~1/LOCALS~1/Temp/ccXseucb.s:616: Error: Invalid constant
<br/>
<br/>
<br/>
I tried the #0x40000000, orr...... 0x0000006 and it worked..... but I was looking at my .s of the C code  and they have an " mov	r3, #67108864"....? why is that....?
<br/>
<br/>
Here is the C code .s for Ref:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">   .align   2
<br/>
   .global   WaitVblank
<br/>
   .type   WaitVblank,function
<br/>
WaitVblank:
<br/>
   @ args = 0, pretend = 0, frame = 0
<br/>
   @ frame_needed = 1, current_function_anonymous_args = 0
<br/>
   mov   ip, sp
<br/>
   stmfd   sp!, {fp, ip, lr, pc}
<br/>
   sub   fp, ip, #4
<br/>
   mov   r0, r0   @ nop
<br/>
.L3:
<br/>
   mov   r3, #67108864
<br/>
   add   r3, r3, #6
<br/>
   ldrh   r3, [r3, #0]   @ movhi
<br/>
   mov   r3, r3, asl #16
<br/>
   mov   r3, r3, lsr #16
<br/>
   cmp   r3, #159
<br/>
   bls   .L3
<br/>
   ldmea   fp, {fp, sp, pc}
<br/>
.Lfe2:
<br/>
   .size   WaitVblank,.Lfe2-WaitVblank
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Thank you for getting me going with this....
<br/>
<br/>
Steve</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#11186 - Twentyfourracing - Sun Sep 28, 2003 4:37 pm</h4>
    <div class="postbody"><span class="postbody">Dang.......
<br/>
<br/>
<br/>
Hmmm..... did you know <span style="text-decoration: underline">#67108864</span>(Dec) is <span style="font-weight: bold"><span style="text-decoration: underline">0x4000000</span></span>(HEX)
<br/>
<br/>
oh well..... I should look at it better.......
<br/>
<br/>
Thanks again.....</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
