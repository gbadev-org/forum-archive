<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Some help with backgrounds - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>Beginners > Some help with backgrounds</h2>
<div id="posts">
<div class="post">
    <h4>#175593 - SchmendrickSchmuck - Sun Jan 02, 2011 2:53 pm</h4>
    <div class="postbody"><span class="postbody">I'm new to libnds (coming from PAlib...), and I need some help with backgrounds. I have read most of the tutorials, but none that I could find fit my question. For solely educational reasons, I would like to have the following layer setup:
<br/>
<br/>
Top layer 0: Text
<br/>
Layer 1: 8bit drawable bg
<br/>
Layer 2: 3D graphics
<br/>
Layer 3: Tiled bg
<br/>
<br/>
I am not usually one for asking ready written code, but in this case I believe that this is the best way to help me understand the system and make up my own background layer setups. All I'm asking for is a simple main() with this layer setup, as well as some pixel plotting on the 8bit bg. I'd very much appreciate it if someone would take the time to help me out (or point me to a tutorial that discusses it). Thanks in advance.</span><span class="gensmall"><br/><br/>Last edited by SchmendrickSchmuck on Sat Feb 05, 2011 4:12 pm; edited 4 times in total</span></div>    
</div>
<div class="post">
    <h4>#175594 - Dwedit - Sun Jan 02, 2011 6:15 pm</h4>
    <div class="postbody"><span class="postbody">3D graphics must be on hardware layer #0, but the layers are re-arrangeable, so you can put the hardware layers in any priority order you want.<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#175596 - SchmendrickSchmuck - Sun Jan 02, 2011 11:39 pm</h4>
    <div class="postbody"><span class="postbody">I was aware of that, but I'm unsure how exactly to achieve this.
<br/>
<br/>
This piece of code comes after initializing openGL: (using 16bit instead of 8bit for testing purposes)
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">vramSetBankB(VRAM_B_MAIN_BG_0x06000000);
<br/>
bgInit(3, BgType_Bmp16, BgSize_B16_256x256, 0,0);
<br/>
bgSetPriority(0, 2);
<br/>
bgSetPriority(3, 0);</td> </tr></table><span class="postbody">
<br/>
<br/>
After that I test it by filling the screen with green:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">for(int i = 0; i &lt; 256 * 192; i++)
<br/>
   VRAM_B[i] = RGB15(0, 31, 0);</td> </tr></table><span class="postbody">
<br/>
<br/>
But I don't see anything. Am I missing anything?</span><span class="gensmall"><br/><br/>Last edited by SchmendrickSchmuck on Mon Jan 03, 2011 12:15 am; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#175597 - DiscoStew - Mon Jan 03, 2011 12:15 am</h4>
    <div class="postbody"><span class="postbody">If you're gonna use an 8-bit background, then you will need to set up a palette for it, which require setting up another VRAM bank for that. You then write the color values to the palette, and write the index to each palette color via a value between 0 and 255 inclusive to the other bank, which you have set up as the B bank. Because vram writes don't like 8-bit values, you'll have to write in 2 index values at a time.
<br/>
<br/>
But, if you want to write the colors directly with no palette, then use a 16-bit background instead.<br/>_________________<br/><span style="font-weight: bold">DS</span> - It's all about <span style="font-weight: bold">D</span>isco<span style="font-weight: bold">S</span>tew</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#175598 - SchmendrickSchmuck - Mon Jan 03, 2011 12:20 am</h4>
    <div class="postbody"><span class="postbody">Thanks DiscoStew, I figured I needed a palette for 8bit which I don't have ready at the moment, so I changed to 16 bit and updated my post. I also tried hiding the 3D layer in case it would hide the layers below it, but to no avail. Is there a specific video mode I need for 8bit or something? Currently I'm using mode5_3D.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#175600 - sverx - Mon Jan 03, 2011 12:11 pm</h4>
    <div class="postbody"><span class="postbody">Mode 5 3D (or Mode 3 3D) is ok. So you could have:
<br/>
<br/>
BG0: 3D
<br/>
BG1: Text (or Tiled BG)
<br/>
BG2: Tiled BG (or Text)
<br/>
BG3: Bitmapped BG
<br/>
<br/>
and you'll rearrange the order using the BG_PRIORITY(n) where 0&gt;=n&gt;=3, lower values are in front.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#175601 - SchmendrickSchmuck - Mon Jan 03, 2011 12:37 pm</h4>
    <div class="postbody"><span class="postbody">Sverx,
<br/>
That is exactly what I am trying to accomplish, but what I'm doing doesn't seem to work. Below is my entire init code, along with an explanation of what I'm trying to do with every line.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">vramSetBankA(VRAM_A_TEXTURE);   // VRAM A for 3D textures
<br/>
videoSetMode(MODE_5_3D);      // Init video
<br/>
consoleDemoInit();            // Init text on sub screen
<br/>
init_gl_screen();            // Init GL on main screen, code is direct copy of examples
<br/>
<br/>
vramSetBankB(VRAM_B_MAIN_BG);   // VRAM B for bitmap memory
<br/>
int gfxbg = bgInit(3, BgType_Bmp16, BgSize_B16_256x256, 0,0);   // Init bmp bg on layer 3
<br/>
bgSetPriority(0, 2);   // Set 3D layer on layer 2
<br/>
bgSetPriority(3, 0);   // Set bitmap layer on top
<br/>
bgHide(0);            // Hide 3D layer just in case
<br/>
u16* buffer = (u16*)bgGetGfxPtr(gfxbg);
<br/>
for(int i = 0; i &lt; 256 * 192; i++)
<br/>
   buffer[i] = RGB15(0, 31, 0);   // Fill up screen with green
<br/>
// Result remains a black screen</td> </tr></table><span class="postbody">
<br/>
<br/>
I changed part of the code to be the same as some of the bitmap examples, but I still end up with a black screen.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#175603 - sverx - Mon Jan 03, 2011 2:39 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">buffer[i] = RGB15(0, 31, 0) | 0x8000;   // Fill up screen with green</td> </tr></table><span class="postbody">
<br/>
<br/>
16 bits bitmap have an alpha bit that you need to set to actually show the pixel...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#175605 - SchmendrickSchmuck - Mon Jan 03, 2011 4:51 pm</h4>
    <div class="postbody"><span class="postbody">That got me excited for a bit (excuse the pun), but no dice. Anything else it might be? Maybe something outside of the piece of code I posted that could be messing things up?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#175606 - sverx - Mon Jan 03, 2011 5:22 pm</h4>
    <div class="postbody"><span class="postbody">maybe you've still got other layers active on top of this one? Hide the others as well. Then no other idea. Try debugging with DeSmuME...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#175607 - SchmendrickSchmuck - Mon Jan 03, 2011 6:02 pm</h4>
    <div class="postbody"><span class="postbody">I looked at some stuff in DeSmuME, and the only layers I have as visible are layer 0 (3D) and layer 3 (bitmap). There the screen shows as black too.
<br/>
<br/>
My full code (I took out EVERYTHING else, so this might as well be directly inside main()):
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">   
<br/>
vramSetBankA(VRAM_A_TEXTURE);
<br/>
videoSetMode(MODE_5_3D);
<br/>
consoleDemoInit();
<br/>
   
<br/>
vramSetBankB(VRAM_B_MAIN_BG);   // VRAM B for bitmap memory
<br/>
int gfxbg = bgInit(3, BgType_Bmp16, BgSize_B16_256x256, 0,0);   // Init bmp bg on layer 3
<br/>
bgSetPriority(0, 2);   // Set 3D layer on layer 2
<br/>
bgSetPriority(3, 0);   // Set bitmap layer on top
<br/>
<br/>
buffer = (u16*)bgGetGfxPtr(gfxbg);
<br/>
for(int i = 0; i &lt; 256 * 96; i++)
<br/>
   buffer[i] = RGB15(0, 31, 0) | 0x8000;   // Fill up screen with green
<br/>
<br/>
while(1);
<br/>
// Result remains a black screen</td> </tr></table><span class="postbody">
<br/>
I changed 192 to 96 to fill half the screen instead.
<br/>
<br/>
<span style="font-weight: bold">EDIT:</span>
<br/>
I have found <span style="font-style: italic">a</span> solution: Changing the B bank to A made it work, but why can't I use bank B for bitmap layers? And if it is possible, how can I do this?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#175611 - sverx - Tue Jan 04, 2011 11:58 am</h4>
    <div class="postbody"><span class="postbody">Oh, right, I didn't notice that.
<br/>
VRAM_B_MAIN_BG is a synonym of VRAM_B_MAIN_BG_0x06020000, so it's 'the second bank' for BGs.
<br/>
You shoud use VRAM_B_MAIN_BG_0x06000000 instead.
<br/>
<br/>
I made a web page, a while ago, with all these. It's in Italian but I guess it's understandable anyway: <a class="postlink" href="http://wcms.teleion.it/users/cgq/nds/tutorial/vram_modes.html" target="_blank">list of all the modes for all the VRAM banks explained</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#175612 - SchmendrickSchmuck - Tue Jan 04, 2011 12:25 pm</h4>
    <div class="postbody"><span class="postbody">Thanks sverx, that seemed to do the trick. I thought MAIN_BG was always the same as the 0x06000000 address, but I see that that's not the case for banks B, C and D. Thanks again!
<br/>
<br/>
<span style="font-weight: bold">EDIT:</span>
<br/>
I need some more help concerning backgrounds. I'm trying to add a scrolling tiled background to my game, but all I get is garbage. My initializing code:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
videoSetMode(MODE_5_3D);
<br/>
videoSetModeSub(MODE_5_2D);
<br/>
   
<br/>
vramSetBankA(VRAM_A_TEXTURE);            // Sprite/3D textures
<br/>
vramSetBankC(VRAM_C_SUB_BG);            // Sub bg text
<br/>
   
<br/>
Init3D();  // Initializes 3D engine
<br/>
<br/>
vramSetBankE(VRAM_E_MAIN_BG);            // Main bg text/8bit bg. Bank E size == 64kb, enough for 8bit * 256 * 192 + text layer
<br/>
consoleInit(&amp;topScreen, LAYER_MAIN_TEXT, BgType_Text4bpp, BgSize_T_256x256, 3, 0, true, true);   // Map base of 3 (8bit bg = 256 * 192 * 8bit = 48kb = 3 * 16kb)
<br/>
consoleInit(&amp;bottomScreen, LAYER_SUB_TEXT, BgType_Text4bpp, BgSize_T_256x256, 2, 0, false, true);   // Map base of 2 (?)
<br/>
consoleClear();
<br/>
consoleSelect(&amp;topScreen);
<br/>
consoleClear();
<br/>
<br/>
<br/>
vramSetBankB(VRAM_B_MAIN_BG);
<br/>
offset_x = offset_y = 0;
<br/>
scroll_x = 0;
<br/>
scroll_y = 0;
<br/>
<br/>
bg = bgInit(2, BgType_Text8bpp, BgSize_T_512x256, 4, 0);
<br/>
<br/>
dmaCopy(TextBackgroundsTiles, bgGetGfxPtr(bg), sizeof(TextBackgroundsTiles));
<br/>
dmaCopy(TextBackgroundsPal, BG_PALETTE, sizeof(TextBackgroundsPal));
<br/>
   
<br/>
bgTileMap = (u16*)bgGetMapPtr(bg);
<br/>
   
<br/>
for(int iy = 0; iy &lt; screenHeight; iy++)
<br/>
   dmaCopy(&amp;Layer1024x1024Map[iy * mapWidth], &amp;bgTileMap[iy * bgWidth], screenWidth * 2);
<br/>
   
<br/>
tex = LoadTexture((void*)gg_pcx, 128, 128, 0);
<br/>
bgSetPriority(LAYER_MAIN_TEXT, 0);
<br/>
bgSetPriority(LAYER_MAIN_3D, 2);
<br/>
bgSetPriority(2, 1);
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Then in the main game loop (mostly taken from bg scrolling example):
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
   u16* bgLeftHalf = bgTileMap;
<br/>
   u16* bgRightHalf = bgTileMap + 32 * 32;
<br/>
<br/>
   movingHorizontal = false;
<br/>
   movingVertical = false;
<br/>
<br/>
   if(IsKeyDown(KEY_LEFT))
<br/>
   {
<br/>
      offset_x = scroll_x / 8 - 1;
<br/>
      scroll_x--;
<br/>
<br/>
      if(scroll_x &lt; 0) 
<br/>
         scroll_x = 0;
<br/>
      else 
<br/>
         movingHorizontal = true;
<br/>
   }
<br/>
   else if(IsKeyDown(KEY_RIGHT))      
<br/>
   {
<br/>
      offset_x = scroll_x / 8 + screenWidth;
<br/>
      scroll_x++;
<br/>
<br/>
      if(scroll_x &gt;= (mapWidth - screenWidth) * tileWidth) 
<br/>
         scroll_x = (mapWidth - screenWidth) * tileWidth - 1;
<br/>
      else 
<br/>
         movingHorizontal = true;
<br/>
   }
<br/>
<br/>
   if(IsKeyDown(KEY_UP))
<br/>
   {
<br/>
      offset_y = scroll_y / 8 - 1;
<br/>
      scroll_y--;
<br/>
<br/>
      if(scroll_y &lt; 0) 
<br/>
         scroll_y = 0;
<br/>
      else 
<br/>
         movingVertical = true;
<br/>
   }
<br/>
   else if(IsKeyDown(KEY_DOWN))      
<br/>
   {
<br/>
      offset_y = scroll_y / 8 + screenHeight;
<br/>
      scroll_y++;
<br/>
<br/>
      if(scroll_y &gt;= (mapHeight - screenHeight) * tileWidth) 
<br/>
         scroll_y = (mapHeight - screenHeight) * tileWidth - 1;
<br/>
      else 
<br/>
         movingVertical = true;
<br/>
   }
<br/>
<br/>
   if(movingHorizontal)
<br/>
   {
<br/>
      u16* bgTemp = ((offset_x &amp; 63) &gt;= bgWidth) ? bgRightHalf : bgLeftHalf;
<br/>
<br/>
      for(int iy = scroll_y / 8 - 1 ; iy &lt; scroll_y / 8 + screenHeight + 1; iy++)
<br/>
      {   
<br/>
         bgTemp[(offset_x &amp; (bgWidth - 1)) + (iy &amp; (bgHeight - 1)) * 32] = 
<br/>
         Layer1024x1024Map[offset_x + iy * mapWidth];   
<br/>
      }
<br/>
   }
<br/>
   if(movingVertical)
<br/>
   {   
<br/>
      for(int ix = scroll_x / 8 - 1 ; ix &lt; scroll_x / 8 + screenWidth + 1; ix++)
<br/>
      {
<br/>
         u16* bgTemp = ((ix &amp; 63) &gt;= bgWidth) ? bgRightHalf : bgLeftHalf;
<br/>
<br/>
         bgTemp[(ix &amp; (bgWidth - 1)) + (offset_y &amp; (bgHeight - 1))* 32] = 
<br/>
         Layer1024x1024Map[ix + offset_y * mapWidth];   
<br/>
      }
<br/>
   }
<br/>
<br/>
   bgSetScroll(bg, scroll_x, scroll_y);
<br/>
   bgUpdate();
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I am using the tile files from the example: #include &lt;TextBackgrounds.h&gt;
<br/>
<br/>
Result: <a href="http://img191.imageshack.us/img191/9898/screeniey.png" target="_blank">http://img191.imageshack.us/img191/9898/screeniey.png</a>
<br/>
<br/>
Any help would be appreciated</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
