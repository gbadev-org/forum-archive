<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Sprite Palettes @ 4bpp - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>Beginners > Sprite Palettes @ 4bpp</h2>
<div id="posts">
<div class="post">
    <h4>#130252 - biubid_boy - Fri Jun 01, 2007 2:55 pm</h4>
    <div class="postbody"><span class="postbody">Hello everyone.
<br/>
<br/>
I was reading through the TONC section on loading sprites when I noticed that the author used a technique to allow easy access to charblocks by making an array of tiles. (bottom of <a class="postlink" href="http://coranac.com/tonc/text/objbg.htm" target="_blank">this</a> page). So, I tried to do the same to the object palette ram and cut it into 16 palettes, thinking I could simplify things further. So here is my current (unworking) code:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
typedef struct {u32 data[8 ];} palette_4bpp;
<br/>
typedef palette_4bpp obj_pal_mem_4bpp[16];
<br/>
#define obj_pal_4bpp  ((obj_pal_mem_4bpp*)0x5000000)
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
And...
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
memcpy(&amp;obj_pal_4bpp[n], palette, 32);
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Funnily enough, if I use palette entry zero with this code, it works fine, but as soon as go any further, there is no object displayed. This leads me to believe that I have the size of the palette_4bpp struct wrong, but I can figure out why it is wrong. Can anyone lighten things for for me?
<br/>
<br/>
Thanks,
<br/>
Biubid_boy.[/code]</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#130255 - Miked0801 - Fri Jun 01, 2007 3:56 pm</h4>
    <div class="postbody"><span class="postbody">Look at it in no$gba or vboy and see if the palettes are loading and if it's a sprite issue.  The code looks okay to me.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#130262 - Cearn - Fri Jun 01, 2007 5:38 pm</h4>
    <div class="postbody"><span class="postbody">Three things:
<br/>
<br/>
Your palette_4bpp struct is composed of 8 words, for 32 bytes in total. Then you make a type obj_pal_mem_4bpp that's 16 of these palette_4bpp's : each obj_pal_mem_4bpp is 16*32 bytes long. It's essentially a whole 256-color palette long, and obj_pal_4bpp[i] would point to the i'th 256-color palette, rather than the 16-color palettes.
<br/>
<br/>
Second, the object palette starts at 0500:0200, not 0500:0000.
<br/>
<br/>
Third, there are already definitions like the ones you seek in tonclib :). In particular, these ones:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">// === tonc_types.h ===
<br/>
<br/>
typedef u16 PALBANK[16];
<br/>
<br/>
<br/>
// === tonc_memmap.h ===
<br/>
<br/>
//! Background palette matrix.
<br/>
/*! pal_bg_bank[y]      = bank y                ( COLOR[ ] )
<br/>
*   pal_bg_bank[y][x]   = color color y*16+x    ( COLOR )
<br/>
*/
<br/>
#define pal_bg_bank     ((PALBANK*)0x05000000)
<br/>
<br/>
<br/>
//! Object palette matrix. 
<br/>
/*! pal_obj_bank[y]     = bank y                ( COLOR[ ] )
<br/>
*   pal_obj_bank[y][x]  = color y*16+x          ( COLOR )
<br/>
*/
<br/>
#define pal_obj_bank    ((PALBANK*)0x05000200)
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
The thing to remember here is that a pointer to an array typedef (like PALBANK, is essentially a matrix, which is exactly what you want in this case. Now that I think about it, I think that if you add alignment attributes to the typedef, you can fast-copy a palette bank with an assignment:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">typedef u16 PALBANK[16] ALIGN(4);
<br/>
#define pal_obj_bank    ((PALBANK*)0x05000000)
<br/>
<br/>
pal_obj_bank[n]= (PALBANK*)palette;  // copies 16 colors via ldmia/stmia
<br/>
</td> </tr></table><span class="postbody">
<br/>
Note: this'll work even without the alignment flags, but it'd just memcpy() internally for it, which should be quite a bit slower for only 32 bytes.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#130309 - biubid_boy - Sat Jun 02, 2007 2:20 am</h4>
    <div class="postbody"><span class="postbody">Thanks to your code, I got it working! But I had to change certain things...
<br/>
<br/>
Firstly, I think that last piece of code you wrote should be:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
typedef u16 PALBANK[16] ALIGN(4);
<br/>
#define pal_obj_bank    ((PALBANK*)0x05000200) //&lt;- obj_pal instead of bg_pal
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I had some trouble with 'incompatible types in assignment' when I tried:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
pal_obj_bank[n]= (PALBANK*)palette;  // copies 16 colors via ldmia/stmia
<br/>
</td> </tr></table><span class="postbody">
<br/>
In the end I used:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
memcpy(&amp;obj_pal_4bpp[pal_count], palette, 32);
<br/>
</td> </tr></table><span class="postbody">
<br/>
Which seemed to work well.
<br/>
<br/>
And also, I had to change your definition of ALIGN(n) from TONC. I changed:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#define ALIGN(_n)   __attribute__(aligned(_n)))
<br/>
</td> </tr></table><span class="postbody">
<br/>
From the bitmaps page in TONC to:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#define ALIGN(_n)   __attribute__ ((aligned(_n))) //&lt;- extra bracket before align
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Then I had a perfect compile!
<br/>
<br/>
Are these all valid changes or am I over complicating things for myself?
<br/>
Thanks for all the help so far,
<br/>
Biubid_boy.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#130341 - Cearn - Sat Jun 02, 2007 11:02 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>biubid_boy wrote:</b></span></td> </tr> <tr> <td class="quote">Thanks to your code, I got it working! But I had to change certain things...
<br/>
<br/>
Firstly, I think that last piece of code you wrote should be:
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
typedef u16 PALBANK[16] ALIGN(4);
<br/>
#define pal_obj_bank    ((PALBANK*)0x05000200) //&lt;- obj_pal instead of bg_pal
<br/>
</td> </tr></table><span class="postbody">
<br/>
</span></td> </tr></table><span class="postbody">I think there's like a rule on this somewhere: if you correct someone on a typo, you're gonna make the same mistake yourself. 0x05000200 for the object palette, yes.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>biubid_boy wrote:</b></span></td> </tr> <tr> <td class="quote">I had some trouble with 'incompatible types in assignment' when I tried:
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">pal_obj_bank[n]= (PALBANK*)palette;  // copies 16 colors via ldmia/stmia
<br/>
</td> </tr></table><span class="postbody">
<br/>
</span></td> </tr></table><span class="postbody">
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">pal_obj_bank[n]= *(PALBANK*)palette; 
<br/>
</td> </tr></table><span class="postbody">There should have been a dereference there.
<br/>
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>biubid_boy wrote:</b></span></td> </tr> <tr> <td class="quote">And also, I had to change your definition of ALIGN(n) from TONC. I changed:
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#define ALIGN(_n)   __attribute__(aligned(_n)))
<br/>
</td> </tr></table><span class="postbody">
<br/>
From the bitmaps page in TONC to:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#define ALIGN(_n)   __attribute__ ((aligned(_n))) //&lt;- extra bracket before align
<br/>
</td> </tr></table><span class="postbody"></span></td> </tr></table><span class="postbody">I wonder how that mistake got there. Anyway, fixed. Thanks.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
