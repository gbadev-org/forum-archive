<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Mode 4 page flipping question - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>Beginners > Mode 4 page flipping question</h2>
<div id="posts">
<div class="post">
    <h4>#16647 - Musashi - Sat Feb 21, 2004 11:59 pm</h4>
    <div class="postbody"><span class="postbody">I was wondering if anyone could figure out why this code doesn't work.
<br/>
<br/>
    //Loading palettes
<br/>
    palettes[0] = sadfacePalette;
<br/>
<br/>
    //Loading images
<br/>
    images[0] = sadface;
<br/>
    images[1] = happyface;
<br/>
<br/>
    //Setting the mode to 4
<br/>
    SetMode(MODE_4 | BG2_ENABLE);
<br/>
<br/>
    int i,j;
<br/>
    int x,y;
<br/>
<br/>
    //Copy the palette into memory
<br/>
    for(i=0; i &lt; 256; i++) BGPaletteMem[i] = palettes[0][i];
<br/>
<br/>
    for(x=0; x &lt; 120; x++) {
<br/>
        for(y=0; y &lt; 160; y++) {
<br/>
            FrontBuffer[(y)*120+(x)] = images[0][(y)*120+(x)];
<br/>
        }
<br/>
    }
<br/>
<br/>
<br/>
<br/>
    for(x=0; x &lt; 120; x++) {
<br/>
        for(y=0; y &lt; 160; y++) {
<br/>
            BackBuffer[(y)*120+(x)] = images[1][(y)*120+(x)];
<br/>
        }
<br/>
    }
<br/>
<br/>
    waitForKey(KEY_START);
<br/>
    VSynch();
<br/>
    REG_DISPCNT |= BACKBUFFER;
<br/>
    waitForKey(KEY_START);
<br/>
    REG_DISPCNT |= FRONTBUFFER;
<br/>
    waitForKey(KEY_START);
<br/>
<br/>
the waitForKey function.. umm.. waits for a key and I think that's all you need to know. What happens when I run the rom is the first picture (the sad face) displays fine but the second picture overlays the first when I try to switch over to the back buffer. Please Help!
<br/>
-Travis</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#16648 - yaustar - Sun Feb 22, 2004 1:22 am</h4>
    <div class="postbody"><span class="postbody">Shouldn't there be an inifite loop somewhere
<br/>
eg
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">while(1)
<br/>
{
<br/>
//do code
<br/>
}</td> </tr></table><span class="postbody">
<br/>
From what I can guess, You exit the program and that is it...no more flipping
<br/>
<br/>
PS use code tags...;)<br/>_________________<br/>[<a class="postlink" href="http://parabellumgames.no-ip.org" target="_blank">Blog</a>] [<a class="postlink" href="http://yaustar.no-ip.org" target="_blank">Portfolio</a>]</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#16650 - Musashi - Sun Feb 22, 2004 1:44 am</h4>
    <div class="postbody"><span class="postbody">This code is organized much better (and its all here!) but it still has the same problem.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#include "gba.h"
<br/>
#include "keypad.h"
<br/>
#include "dispcnt.h"
<br/>
#include "sadface.h"
<br/>
#include "happyface.h"
<br/>
<br/>
void waitForKey(int key);
<br/>
<br/>
void waitForKey(int key) {
<br/>
    while(*KEYS &amp; key);
<br/>
    *KEYS ^= key;
<br/>
}
<br/>
<br/>
void main() {
<br/>
<br/>
    int i,x,y;
<br/>
<br/>
    //Set the mode and enable background 2
<br/>
    SetMode(MODE_4 | BG2_ENABLE);
<br/>
<br/>
    //Load palette into memory
<br/>
    for(i = 0; i &lt; 256; i++) BGPaletteMem[i] = sadfacePalette[i];
<br/>
<br/>
    //Load the first image into the front buffer
<br/>
    for(x = 0; x &lt; 120; x++) {
<br/>
        for(y = 0; y &lt; 160; y++) {
<br/>
            FrontBuffer[y*120+x] = sadface[y*120+x];
<br/>
        }
<br/>
    }
<br/>
    
<br/>
    //Load the second image into the back buffer
<br/>
    for(x = 0; x &lt; 120; x++) {
<br/>
        for(y = 0; y &lt; 160; y++) {
<br/>
            BackBuffer[y*120+x] = happyface[y*120+x];
<br/>
        }
<br/>
    }
<br/>
    
<br/>
    //wait to push start
<br/>
     waitForKey(KEY_START);
<br/>
     
<br/>
    //switch to the backbuffer
<br/>
    SetMode(MODE_4 | BG2_ENABLE | BACKBUFFER);
<br/>
    while(1);
<br/>
}
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#16652 - yaustar - Sun Feb 22, 2004 2:00 am</h4>
    <div class="postbody"><span class="postbody">Your while loop is doing nothing so it still has the same problem as last time..<br/>_________________<br/>[<a class="postlink" href="http://parabellumgames.no-ip.org" target="_blank">Blog</a>] [<a class="postlink" href="http://yaustar.no-ip.org" target="_blank">Portfolio</a>]</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#16653 - poslundc - Sun Feb 22, 2004 2:48 am</h4>
    <div class="postbody"><span class="postbody">The waitForKey() function loops infinitely until a keypress occurs, so it should work, even if it isn't really good style.
<br/>
<br/>
In any case, I'm not aware of how you could get the image in one buffer to overlay the image of another, not by accident anyway, and especially not if the first image is displaying correctly.
<br/>
<br/>
Do the images use the same palettes? It could be because you aren't copying in the other palette when you switch buffers. Other than that, your image data could be encoded incorrectly.
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#16663 - Musashi - Sun Feb 22, 2004 5:24 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">The waitForKey() function loops infinitely until a keypress occurs, so it should work, even if it isn't really good style. </td> </tr></table><span class="postbody">
<br/>
<br/>
That's what I was shooting for.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Do the images use the same palettes? It could be because you aren't copying in the other palette when you switch buffers. Other than that, your image data could be encoded incorrectly. </td> </tr></table><span class="postbody">
<br/>
<br/>
I'm pretty sure they use the same palette, they're both black and white so it will be pretty close. I also think I used the copy both pictures to one bitmap and get the palette from that trick. I'll try again just to be safe.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">In any case, I'm not aware of how you could get the image in one buffer to overlay the image of another, not by accident anyway, and especially not if the first image is displaying correctly. </td> </tr></table><span class="postbody">
<br/>
<br/>
You underestimate what I can do by accident :o)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#16666 - 628man - Sun Feb 22, 2004 5:47 am</h4>
    <div class="postbody"><span class="postbody">This part is of interest
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void waitForKey(int key) { 
<br/>
    while(*KEYS &amp; key); 
<br/>
    *KEYS ^= key; 
<br/>
} 
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
What is *KEYS? Is that the keyboard register? I think it's READ ONLY, so you can't change it. You have to wait for a press and wait for a release.
<br/>
<br/>
If you wait for a press multiple times in a row, it's likely the key is still down. You have to wait for the release either before or after your function, ie while(!  (*KEYS &amp; key)  );</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#16667 - Musashi - Sun Feb 22, 2004 7:11 am</h4>
    <div class="postbody"><span class="postbody">yeah, its the keyboard register.  That's a good point. The key press thing seems to be working though since I only press it once. I agree its not coded well. The page flipping problem remains though.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#16668 - Musashi - Sun Feb 22, 2004 7:19 am</h4>
    <div class="postbody"><span class="postbody">I reloaded the palette for the second picture and it fixed the problem, mostly. But a little bit of ghosting still occurs. What's up with that?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#16669 - Musashi - Sun Feb 22, 2004 7:31 am</h4>
    <div class="postbody"><span class="postbody">Holy shit finally got it to work, thanks everyone for your help. This forum rocks.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
