<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>sprite rotation issue - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>Beginners > sprite rotation issue</h2>
<div id="posts">
<div class="post">
    <h4>#20506 - tethered - Wed May 12, 2004 8:51 am</h4>
    <div class="postbody"><span class="postbody">hello everyone,
<br/>
<br/>
i'm attempting to do a little hardware sprite rotation, and i'm running into some difficulty. for some reason, when i set the rotation bit in attribute 0, my sprite turns into a single colored box. i've spent hours reading everything i can find on the subject and nothing is very clear about how this works. i think i've done everything i need to do... here's the source, its pretty straight-forward, all in the same function...
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#include "math.h"
<br/>
#include "includes\gba.h"
<br/>
#include "graphics\sprites.pal.c"
<br/>
#include "graphics\ship.raw.c"
<br/>
<br/>
<br/>
OAMEntry sprites[128];
<br/>
pRotData rotData = (pRotData)sprites;
<br/>
<br/>
<br/>
#define PI 3.14159265
<br/>
<br/>
<br/>
int main(void)
<br/>
{
<br/>
    u16 i;
<br/>
    u16* temp;
<br/>
    float f_x = 104, f_y = 64;
<br/>
    float f_thrust = 0.05;
<br/>
    float f_xDisplacement = 0, f_yDisplacement = 0;
<br/>
    float f_angle = 0, f_radian = 0;
<br/>
    float f_sin_array[256], f_cos_array[256];
<br/>
    int pa, pb, pc, pd; // used for sprite rotation
<br/>
    
<br/>
    SetMode(MODE_0 | OBJ_ENABLE | OBJ_MAP_1D);
<br/>
    
<br/>
    // generate SIN array
<br/>
    f_angle = 0;
<br/>
    for (i = 0; i &lt; 256; i++)
<br/>
    {
<br/>
        f_radian = f_angle * (PI / 180);
<br/>
        f_sin_array[i] = sin(f_radian);
<br/>
        f_angle+=1.40625;
<br/>
    }
<br/>
<br/>
    // generate COS array
<br/>
    f_angle = 0;
<br/>
    for (i = 0; i &lt; 256; i++)
<br/>
    {
<br/>
        f_radian = f_angle * (PI / 180);
<br/>
        f_cos_array[i] = cos(f_radian);
<br/>
        f_angle+=1.40625;
<br/>
    }
<br/>
    f_angle = 0;
<br/>
    
<br/>
    // clear any sprite data from the screen
<br/>
    for (i = 0; i &lt; 128; i++)
<br/>
    {
<br/>
        sprites[i].attribute0 = 160;
<br/>
        sprites[i].attribute1 = 240;
<br/>
        sprites[i].attribute2 = 0;
<br/>
    }
<br/>
    
<br/>
    // load palette
<br/>
    for (i = 0; i &lt; 256; i++)
<br/>
        OBJ_PaletteMem[i] = sprite_Palette[i];
<br/>
        
<br/>
    // load sprite data
<br/>
    for (i = 0; i &lt; 512; i++)
<br/>
        OBJ_Data[i] = ((u16*)ship_Bitmap)[i];
<br/>
        
<br/>
    // set ship sprite oam data
<br/>
    sprites[0].attribute0 = COLOR_256 | SQUARE | ROTATION_FLAG | 64;
<br/>
    sprites[0].attribute1 = SIZE_32 | 0 | 104;
<br/>
    sprites[0].attribute2 = 0;
<br/>
        
<br/>
    // game loop
<br/>
    while(1)
<br/>
    {
<br/>
        
<br/>
        if(keyDown(KEY_LEFT))
<br/>
        {
<br/>
            f_angle = f_angle - 1;
<br/>
            if (f_angle &lt; 0)
<br/>
                f_angle = 255;
<br/>
        }
<br/>
        
<br/>
        if(keyDown(KEY_RIGHT))
<br/>
        {
<br/>
            f_angle = f_angle + 1;
<br/>
            if (f_angle &gt; 255)
<br/>
                f_angle = 0;
<br/>
        }
<br/>
        
<br/>
        if(keyDown(KEY_UP))
<br/>
        {
<br/>
            f_xDisplacement = f_xDisplacement + f_sin_array[((int)f_angle)] * f_thrust;
<br/>
            f_yDisplacement = f_yDisplacement + f_cos_array[((int)f_angle)] * f_thrust;
<br/>
        }
<br/>
<br/>
        if(keyDown(KEY_DOWN))
<br/>
        {
<br/>
            // drag = .95
<br/>
            f_xDisplacement = f_xDisplacement * .95;
<br/>
            f_yDisplacement = f_yDisplacement * .95;
<br/>
        }
<br/>
        
<br/>
        // update x and y coords
<br/>
        f_x += f_xDisplacement;
<br/>
        f_y -= f_yDisplacement;
<br/>
        if (f_x &gt; 240 - 32) f_x = 0;
<br/>
        if (f_x &lt; 0) f_x = 240 - 32;
<br/>
        if (f_y &gt; 160 - 32) f_y = 0;
<br/>
        if (f_y &lt; 0) f_y = 160 - 32;
<br/>
        
<br/>
        // update sprite attribs
<br/>
        sprites[0].attribute0 = COLOR_256 | SQUARE | ROTATION_FLAG | ((int)f_y);
<br/>
        sprites[0].attribute1 = SIZE_32 | ((int)f_x);
<br/>
        
<br/>
        // rotate sprite
<br/>
        pa = ((s16)((32) * f_cos_array[((int)f_angle)])) &gt;&gt; 8;
<br/>
        pb = ((s16)((32) * f_sin_array[((int)f_angle)])) &gt;&gt; 8;
<br/>
        pc = ((s16)((32) * -f_sin_array[((int)f_angle)])) &gt;&gt; 8;
<br/>
        pd = ((s16)((32) * f_cos_array[((int)f_angle)])) &gt;&gt; 8;
<br/>
        rotData[0].pa = pa;
<br/>
        rotData[0].pb = pb;
<br/>
        rotData[0].pc = pc;
<br/>
        rotData[0].pd = pd;
<br/>
        
<br/>
        // vdraw . . .
<br/>
        while (REG_VCOUNT &lt; 160);
<br/>
        
<br/>
        // update oam memory
<br/>
        temp = (u16*)sprites;
<br/>
        for (i = 0; i &lt; 512; i++)
<br/>
            OAM_Mem[i] = temp[i];
<br/>
        
<br/>
        // vblank . . .
<br/>
        while (REG_VCOUNT &gt;= 160);
<br/>
<br/>
    }
<br/>
    
<br/>
    return 0;
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
what am i doing wrong? its almost 4am and i'm about to cash out for the night, so i'll let this thread marinate overnight...
<br/>
<br/>
o, also, i know its not the most efficient code in the world right now... like i've said before in other threads, i'm just experimenting now to get a better understanding of the platform... otpimization comes later...
<br/>
<br/>
thanks,
<br/>
<br/>
<br/>
chuck</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#20527 - poslundc - Wed May 12, 2004 2:41 pm</h4>
    <div class="postbody"><span class="postbody">First of all, stop using floats! This is more than a simple optimization; it is a fundamental design issue.
<br/>
<br/>
Meanwhile, all of your rotation paramters are coming out as zero. You can see this from a simple numerical analysis. Take your calculation of pa for example:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">   pa = ((s16)((32) * f_cos_array[((int)f_angle)])) &gt;&gt; 8;</td> </tr></table><span class="postbody">
<br/>
<br/>
You know that f_cos_array will return a value between zero and one. For the moment, lets assume you pass in zero as your angle and get one (the function's maximum) as your cosine.
<br/>
<br/>
You multiply 1 * 32, which yields 32. You now shift right by 8, which is the same as dividing by 256... suddenly you're left with a number less than one (which is zero in integral terms).
<br/>
<br/>
This means no matter what your angle is, you will always get zero as your rotation parameter.
<br/>
<br/>
The rotation attributes are 8.8 fixed-point numbers. If you are at all unsure of what this means, <span style="font-style: italic">please</span> <a class="postlink" href="http://www.google.com/search?q=fixed+point+math" target="_blank">read up on fixed-point math</a>, because you will <span style="font-style: italic">absolutely need it</span> for GBA programming.
<br/>
<br/>
As for making your code work, try the following line instead:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">   pa = (s16)(256.0 * f_cos_array[(int)f_angle]);</td> </tr></table><span class="postbody">
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#20540 - tethered - Wed May 12, 2004 8:24 pm</h4>
    <div class="postbody"><span class="postbody">Point noted about floats and fixed point math. I'm aware of fixed point math but don't have a solid understanding of it as of yet. For the time being, I'm just tryin to feel out the console and gain a better understanding for where things need to be stored in memory, etc. I intend on reading more into some of the fundamental stuff as the need for them arises. 
<br/>
<br/>
I see what you're saying regarding my rotation parameters all coming out as 0. 
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">pa = (s16)(256.0 * f_cos_array[(int)f_angle]);
<br/>
pa = (s16)(256.0 * f_sin_array[(int)f_angle]);
<br/>
pa = (s16)(256.0 * -f_sin_array[(int)f_angle]);
<br/>
pa = (s16)(256.0 * f_cos_array[(int)f_angle]);</td> </tr></table><span class="postbody">
<br/>
<br/>
Using this block of code, however, I get similar results: my ship turns into a single colored box, but now as you change the angles, the colors inside the box change in vertical bands.
<br/>
<br/>
I guess my real problem at this point is that I don't fully understand what data needs to be put where (in registers and memory), and I'm still solidifying my understanding of the more complex areas of C as I go along. And at the same time, the tutorials all seem to be pretty poorly written. For example, The Pern Project... its good if you just need a quick review or to use as a reference, but for someone that has no experience with the console its hard to make any sense out of it... it's all over the place!
<br/>
<br/>
So any advice is welcome. Explanations, links to documentation, anything that will help me continue to move in the right direction.
<br/>
<br/>
<br/>
- Chuck</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#20543 - Cearn - Wed May 12, 2004 9:19 pm</h4>
    <div class="postbody"><span class="postbody">erm, that should be
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
pa = (s16)(256.0 * f_cos_array[(int)f_angle]); 
<br/>
pb = (s16)(256.0 * f_sin_array[(int)f_angle]); 
<br/>
pc = (s16)(256.0 * -f_sin_array[(int)f_angle]); 
<br/>
pd = (s16)(256.0 * f_cos_array[(int)f_angle]); 
<br/>
</td> </tr></table><span class="postbody">
<br/>
, not a four times over. 
<br/>
<br/>
Some additional info about pa-pd. These form a matrix that describes the affine transformation between the screen and texture (=tiles) space. The only thing is that the transformation goes <span style="font-style: italic">from</span> screen <span style="font-style: italic">to</span> texture space, and not the other way round. The matrix you can find at Pern is the other way round. For a full story, see <a class="postlink" href="http://user.chem.tue.nl/jakvijn/tonc/affine.htm" target="_blank">http://user.chem.tue.nl/jakvijn/tonc/affine.htm</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#20545 - tethered - Wed May 12, 2004 9:29 pm</h4>
    <div class="postbody"><span class="postbody">doh!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#20547 - poslundc - Wed May 12, 2004 10:29 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Cearn wrote:</b></span></td> </tr> <tr> <td class="quote">For a full story, see <a class="postlink" href="http://user.chem.tue.nl/jakvijn/tonc/affine.htm" target="_blank">http://user.chem.tue.nl/jakvijn/tonc/affine.htm</a></td> </tr></table><span class="postbody">
<br/>
<br/>
Cearn, that tutorial is awesome! When did you create it? It ought to be FAQ'd!
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#20549 - Cearn - Wed May 12, 2004 11:51 pm</h4>
    <div class="postbody"><span class="postbody">Praise from a master, that's always nice :)
<br/>
I've been working on it for a while now, but kept delaying any formal announcement because there's always one more thing to add. Should be soon now that I finally have a way to test on hardware. Or maybe until I finally get a nice mode7 demo with variable pitch. Or fully switch to devkitARM, dang, there I go again. See what I mean about constant delaying? :P</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#20568 - poslundc - Thu May 13, 2004 4:42 am</h4>
    <div class="postbody"><span class="postbody">Well, it's some good stuff you've got going there. I keep waiting for someone to develop a viable alternative to Pern and gbajunkie that doesn't teach the normal bad habits they do.
<br/>
<br/>
Oh, and I'm hardly a master, I just post a lot. :P
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#20592 - tepples - Thu May 13, 2004 3:43 pm</h4>
    <div class="postbody"><span class="postbody">I could probably write part of a tutorial. I'll bring up another topic about this.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#20645 - NoMis - Fri May 14, 2004 8:29 am</h4>
    <div class="postbody"><span class="postbody">Great tutorial! I never knew how this thing realy work, i just copied the code but now its clear :)</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
