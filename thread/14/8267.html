<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>what's wrong with this short code ? - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>Beginners > what's wrong with this short code ?</h2>
<div id="posts">
<div class="post">
    <h4>#68553 - deltree - Wed Jan 25, 2006 5:50 pm</h4>
    <div class="postbody"><span class="postbody">Hi,
<br/>
I'm having trouble with this code not displaying anything:
<br/>
here we go:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#include &lt;mygba.h&gt;
<br/>
const unsigned short bg_Palette[256],i;
<br/>
const unsigned char bg_Bitmap[38400],j;
<br/>
 int main(void)
<br/>
{
<br/>
   for (i=0;i&lt;256;i++)  {
<br/>
      bg_Palette[i]=i*256;
<br/>
   }
<br/>
   for (j=0;j&lt;38400;j++)  {
<br/>
       bg_Bitmap[j]=j%256;
<br/>
   }
<br/>
    ham_Init();
<br/>
    ham_SetBgMode(4);
<br/>
    ham_LoadBGPal((void*)bg_Palette,256);
<br/>
    ham_LoadBitmap((void*)bg_Bitmap);
<br/>
    ham_FlipBGBuffer();
<br/>
   while(TRUE) { }
<br/>
   return 0;
<br/>
}</td> </tr></table><span class="postbody">
<br/>
this is supposed to display a full screen of regularly increasing color palette, but it doesnt display anything. white only. What is very weird, it's that even the "created with ham" logo doesn"'t display.
<br/>
what's wrong with it ? I'm almost sure it as something to do with types, but I can't figure what</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#68560 - FluBBa - Wed Jan 25, 2006 6:30 pm</h4>
    <div class="postbody"><span class="postbody"><span style="font-style: italic">const</span> makes the array go into ROM, which mean <span style="text-decoration: underline">Read Only</span> Memory.<br/>_________________<br/>I probably suck, my not is a programmer.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#68561 - deltree - Wed Jan 25, 2006 6:33 pm</h4>
    <div class="postbody"><span class="postbody">hi again
<br/>
I removed the "const": it compiles properly,  but i does the same. nothing exept a blanck screen of death.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#include &lt;mygba.h&gt;
<br/>
unsigned short bg_Palette[256],i;
<br/>
unsigned char bg_Bitmap[38400],j;
<br/>
 int main(void)
<br/>
{
<br/>
   for (i=0;i&lt;256;i++)  {
<br/>
      bg_Palette[i]=i*256;
<br/>
   }
<br/>
   for (j=0;j&lt;38400;j++)  {
<br/>
       bg_Bitmap[j]=j%256;
<br/>
   }
<br/>
    ham_Init();
<br/>
    ham_SetBgMode(4);
<br/>
    ham_LoadBGPal((void*)bg_Palette,256);
<br/>
    ham_LoadBitmap((void*)bg_Bitmap);
<br/>
    ham_FlipBGBuffer();
<br/>
   while(TRUE) { }
<br/>
   return 0;
<br/>
}</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#68569 - Miked0801 - Wed Jan 25, 2006 7:30 pm</h4>
    <div class="postbody"><span class="postbody">Your char array bg_Bitmap[38400] more than likely is being placed into IWRAM - which is only 32K in size.  Boom.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#68586 - Cearn - Wed Jan 25, 2006 10:22 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>deltree wrote:</b></span></td> </tr> <tr> <td class="quote">hi again
<br/>
I removed the "const": it compiles properly,  but i does the same. nothing exept a blanck screen of death.
<br/>
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#include &lt;mygba.h&gt;
<br/>
unsigned short bg_Palette[256],i;
<br/>
unsigned char bg_Bitmap[38400],j;
<br/>
 int main(void)
<br/>
{
<br/>
   for (i=0;i&lt;256;i++)  {
<br/>
      bg_Palette[i]=i*256;
<br/>
   }
<br/>
   for (j=0;j&lt;38400;j++)  {
<br/>
       bg_Bitmap[j]=j%256;
<br/>
   }
<br/>
    ham_Init();
<br/>
    ham_SetBgMode(4);
<br/>
    ham_LoadBGPal((void*)bg_Palette,256);
<br/>
    ham_LoadBitmap((void*)bg_Bitmap);
<br/>
    ham_FlipBGBuffer();
<br/>
   while(TRUE) { }
<br/>
   return 0;
<br/>
}</td> </tr></table><span class="postbody"></span></td> </tr></table><span class="postbody">
<br/>
Miked0801 is right: the arrays are killing IWRAM. What exactly is the point of having bg_Palette and bg_Bitmap anyway? You're initializing them first, then copying them to pal RAM and VRAM. Why not initialize those directly? 
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
// These are my own names. There are many like them but these ones are mine.
<br/>
// HAM and libgba will have others, but names are unimportant. What they stand for is.
<br/>
#define pal_bg_mem ((u16*)0x05000000)
<br/>
#define vid_mem ((u16*)0x06000000)
<br/>
<br/>
int ii;
<br/>
<br/>
// fill bg palette directly
<br/>
for(ii=0; ii&lt;256; ii++)
<br/>
   pal_bg_mem[ii]= ii*256;
<br/>
<br/>
// fill VRAM directly (though this has to be done 2 pixels at a time)
<br/>
for(ii=0; ii&lt;240*160; ii += 2)
<br/>
    vid_mem[ii/2]= (ii%256) | ((ii+1)%256)&lt;&lt;8;
<br/>
</td> </tr></table><span class="postbody">
<br/>
Code is untested, but should work.
<br/>
<br/>
Also, <span style="font-weight: bold"><span style="font-style: italic"><a class="postlink" href="http://forum.gbadev.org/viewtopic.php?t=5751" target="_blank">DON'T USE NON-WORD (32bit) TYPES FOR VARIABLES!</a></span></span> It kills performance for absolutely no good reason. Use int if you can, only char/short if you must. Sorry about sounding harsh, but this one just bugs me to no end.
<br/>
<br/>
Aside from that, Having your main loop variables (i,j) as globals is probably a very bad idea. Not just because it has an even bigger performance penalty than using non-words, it's going to be a maintainance nightmare when you're going to mix functions. Keep your loop counters nice and local unless you have a very good reason not to.
<br/>
<br/>
I see you chose to start with HAM. That is great if you want to get some result quickly, but it also hides important details from you so that you can't get a clear idea of what's really going on or what you're actually <span style="font-style: italic">doing</span> when you call HAM's functions. Spend some time browsing non-HAM tutorials as well to get a feel for the hardware. It will be very beneficial in the long run. 
<br/>
<br/>
Oh, and read the <a class="postlink" href="http://forum.gbadev.org/viewtopic.php?t=418" target="_blank">FAQ</a> if you haven't already.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#68689 - deltree - Thu Jan 26, 2006 10:54 am</h4>
    <div class="postbody"><span class="postbody">hi,
<br/>
thanx for the answer, but there are still a few things I don't get.
<br/>
here's the way I mad my program, just adding "main" function, but it doesn't work, a blank white screen again.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#include &lt;mygba.h&gt; 
<br/>
int main(void) 
<br/>
{
<br/>
   #define pal_bg_mem ((u16*)0x05000000)
<br/>
   #define vid_mem ((u16*)0x06000000)
<br/>
   int ii;
<br/>
   // fill bg palette directly
<br/>
   for(ii=0; ii&lt;256; ii++)
<br/>
      pal_bg_mem[ii]= ii*256;
<br/>
   // fill VRAM directly (though this has to be done 2 pixels at a time)
<br/>
   for(ii=0; ii&lt;240*160; ii += 2)
<br/>
      vid_mem[ii/2]= (ii%256) | ((ii+1)%256)&lt;&lt;8;
<br/>
   while(1){ }
<br/>
   return 0;
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
what's wrong with it ? did I implement properly your code ? (i guess no)
<br/>
again, a few question:
<br/>
can you explain the "define" 2 lines ?
<br/>
and this line:
<br/>
vid_mem[ii/2]= (ii%256) | ((ii+1)%256)&lt;&lt;8;
<br/>
I don't understand it. what does the | or &lt;&lt; mean ? I know it's something like "or" and bitshifting, but why using it here ?
<br/>
why don't you initialize background mode? why don't you flip the buffer ?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#68696 - keldon - Thu Jan 26, 2006 12:11 pm</h4>
    <div class="postbody"><span class="postbody">You are not setting the video mode. Try the <a class="postlink" href="http://user.chem.tue.nl/jakvijn/tonc/toc.htm" target="_blank">tonc tutorials</a>.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#68697 - Cearn - Thu Jan 26, 2006 12:19 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>deltree wrote:</b></span></td> </tr> <tr> <td class="quote">hi,
<br/>
thanx for the answer, but there are still a few things I don't get.
<br/>
here's the way I mad my program, just adding "main" function, but it doesn't work, a blank white screen again.
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#include &lt;mygba.h&gt; 
<br/>
int main(void) 
<br/>
{
<br/>
   #define pal_bg_mem ((u16*)0x05000000)
<br/>
   #define vid_mem ((u16*)0x06000000)
<br/>
   int ii;
<br/>
   // fill bg palette directly
<br/>
   for(ii=0; ii&lt;256; ii++)
<br/>
      pal_bg_mem[ii]= ii*256;
<br/>
   // fill VRAM directly (though this has to be done 2 pixels at a time)
<br/>
   for(ii=0; ii&lt;240*160; ii += 2)
<br/>
      vid_mem[ii/2]= (ii%256) | ((ii+1)%256)&lt;&lt;8;
<br/>
   while(1){ }
<br/>
   return 0;
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
what's wrong with it ? did I implement properly your code ? (i guess no)
<br/>
</span></td> </tr></table><span class="postbody">
<br/>
No you didn't. Mostly because there's one thing that I didn't mention explicitly, namely that you need to set the video mode as well. That's what  ham_SetBgMode() does for you. Aside from that, you also need to enable the background that the bitmap uses, but I can't tell if ham_SetBgMode() does that as well, or if it's in hamInit(). 
<br/>
Either way, here's something that 'should' work (modified for use with HAM's own defines from mygba.h).
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#include &lt;mygba.h&gt;
<br/>
<br/>
// From mygba.h
<br/>
//#define MEM_PAL_BG_PTR    (u16*) 0x05000000  // pal_bg_mem
<br/>
//#define MEM_VRAM_PTR      (u16*) 0x06000000   // vid_mem
<br/>
<br/>
int main(void) 
<br/>
{ 
<br/>
    int ii;
<br/>
    ham_Init();
<br/>
    ham_SetBgMode(4);
<br/>
<br/>
    for(ii=0; ii&lt;256; ii++)
<br/>
        (MEM_PAL_BG_PTR)[ii]= ii*256;
<br/>
        
<br/>
    for(ii=0; ii&lt;240*160; ii += 2)
<br/>
        (MEM_VRAM_PTR)[ii/2]= (ii%256) | ((ii+1)%256)&lt;&lt;8;
<br/>
    
<br/>
    while(1);
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
This one is tested and works. At least for the old HAM version that I have. <span style="font-style: italic">mygba.h</span> is absolutely filled with #defines for all possible uses so the things that you need are all in there, but you'd have to find them and know how to use them. 
<br/>
The pointers needed to operate on the palette and VRAM directly are called MEM_PAL_BG_PTR and MEM_VRAM_PTR, which appear around lilne 800 in that file, but I've added them here for convenience. Note that the definitions are actually somewhat flawed. Because in C, the array operator [] has precedence over casts (u16*), you can't use the pointers as arrays directly. That's why I need to use (MEM_VRAM_PTR), rather than just MEM_VRAM_PTR. The extra parentheses should be part of the #defines.
<br/>
<br/>
Instead of calling ham_Init() and ham_SetBgMode(), you can also do 
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">R_DISPCNT= 0;
<br/>
M_DISCNT_BGMODE_SET(4);
<br/>
M_DISCNT_BG2_ON;
<br/>
</td> </tr></table><span class="postbody">
<br/>
or even
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">R_DISPCNT= 0x0400 | 0x0004;
<br/>
</td> </tr></table><span class="postbody">
<br/>
as that's the only thing you really need in terms of initialization here. 0x0400 activates background 2 and 0x0004 sets the video mode. HAM doesn't have #defines for those for some reason, so I'm just using the actual numbers here. Because I don't work with an API, I (have to) know what's really going on underneath to get things working.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>deltree wrote:</b></span></td> </tr> <tr> <td class="quote">again, a few question:
<br/>
can you explain the "define" 2 lines ?</td> </tr></table><span class="postbody">
<br/>
<span style="font-style: italic">#define</span> is a preprocessor directive. 
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#define vid_mem ((u16*)0x06000000)
<br/>
</td> </tr></table><span class="postbody">
<br/>
Means that every time the compiler encounters <span style="font-style: italic">vid_mem</span>, it replaces it with what it's defined as, in this case <span style="font-style: italic">((u16*)0x06000000)</span>. This helps coding because vid_mem is (VIDeo MEMory) says more about what the section is for than 0x06000000 does.
<br/>
C++ has depreciated much of what #define is used for because the common opinion is that #define is EEEvil. Common opinion is correct here, but it's just so damn useful to toss aside. Look in that <span style="font-style: italic">mygba.h</span>, it's full of #defines.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>deltree wrote:</b></span></td> </tr> <tr> <td class="quote">and this line:
<br/>
vid_mem[ii/2]= (ii%256) | ((ii+1)%256)&lt;&lt;8;
<br/>
I don't understand it. what does the | or &lt;&lt; mean ? I know it's something like "or" and bitshifting, but why using it here ?</td> </tr></table><span class="postbody">
<br/>
Because "this has to be done 2 pixels at a time". Or, rather, with at least 16bits at a time. PAL RAM, VRAM and OAM have a restriction that won't let you write in byte-sized chunks to those sections. That's one of the major problems with mode 4: you can't access individual pixels, you have to write two at a time. In this case, (ii%256) is the even pixel, and the shifted one is the odd pixel. The 'OR' combines them into one value. Again, because I work with the hardware directly rather than through an API, I know these things.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>deltree wrote:</b></span></td> </tr> <tr> <td class="quote">why don't you initialize background mode?</td> </tr></table><span class="postbody">
<br/>
Because I have the habit of only giving the code snippets directly required for the topic at hand, rather than fully cut&amp;pastable code. I'm flawed that way, it's been said. 
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>deltree wrote:</b></span></td> </tr> <tr> <td class="quote">why don't you flip the buffer ?</td> </tr></table><span class="postbody">Because I know the hardware enough to know it's not necessary (is this getting old yet? :P ). I'm guessing that ham_LoadBitmap() always writes to the back-page. It is more proper, but not required. If you just want something on screen, what I did is just easier.
<br/>
<br/>
As you seem to be new to C too, you might want to pick up a book or tutorial on that as well. If you don't know your way around the preprocessor, hex, bit-ops and pointers, you're in for a bumpy ride. The GBA isn't really a platform on which you can get a way with not knowing what you're doing. You <span style="font-style: italic">will</span> get smacked down if you don't spend some time on getting comfortable with C (or asm) first.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#70965 - Red XIII - Thu Feb 09, 2006 8:06 pm</h4>
    <div class="postbody"><span class="postbody">EDIT: Ok man,sorry,I just thought that you had solved your problem as the last post was 2 weeks ago... You don't have to act like that.</span><span class="gensmall"><br/><br/>Last edited by Red XIII on Thu Feb 09, 2006 9:23 pm; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#70967 - deltree - Thu Feb 09, 2006 8:25 pm</h4>
    <div class="postbody"><span class="postbody">it was <span style="font-style: italic">my</span> post</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
