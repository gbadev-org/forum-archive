<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>2 sprites color error - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>Beginners > 2 sprites color error</h2>
<div id="posts">
<div class="post">
    <h4>#150998 - Cave Johnson - Sat Feb 16, 2008 6:00 pm</h4>
    <div class="postbody"><span class="postbody">So far in my simple game, ive created 2 sprites, but when i run the game, depending on their priorities, one sprite takes the place of the other and the colors become all gray.  After working on this problem for a week, i think i have narrowed the problem down to a snippet of my main.cpp.
<br/>
<br/>
dopefish is the sprite
<br/>
fish is the class
<br/>
ak47 is the sprite
<br/>
gun is the class
<br/>
<br/>
Heres the code:
<br/>
<br/>
void initSprites(tOAM * oam, SpriteInfo *spriteInfo) 
<br/>
{
<br/>
<br/>
    static const int BYTES_PER_16_COLOR_TILE = 32;
<br/>
    static const int COLORS_PER_PALETTE = 16;
<br/>
    static const int BOUNDARY_VALUE = 32;
<br/>
<br/>
    static const int OFFSET_MULTIPLIER = BOUNDARY_VALUE /
<br/>
                                         sizeof(SPRITE_GFX[0]);
<br/>
    int nextAvailableTileIdx = 0;
<br/>
<br/>
    static const int DOPEFISH_OAM_ID = 1;
<br/>
    assert(DOPEFISH_OAM_ID &lt; SPRITE_COUNT);
<br/>
    SpriteInfo * dopefishInfo = &amp;spriteInfo[DOPEFISH_OAM_ID];
<br/>
    SpriteEntry * dopefish = &amp;oam-&gt;spriteBuffer[DOPEFISH_OAM_ID];
<br/>
<br/>
    dopefishInfo-&gt;oamId = DOPEFISH_OAM_ID;
<br/>
    dopefishInfo-&gt;width = 32;
<br/>
    dopefishInfo-&gt;height = 32; 
<br/>
    dopefishInfo-&gt;angle = 462;
<br/>
    dopefishInfo-&gt;entry = dopefish;
<br/>
<br/>
    dopefish-&gt;posY = 112.5;
<br/>
    assert(!dopefish-&gt;isRotoscale || (dopefishInfo-&gt;oamId &lt;       MATRIX_COUNT));
<br/>
    dopefish-&gt;rsDouble = false;
<br/>
    dopefish-&gt;objMode = OBJMODE_NORMAL;
<br/>
    dopefish-&gt;isMosaic = false;
<br/>
    dopefish-&gt;colMode = OBJCOLOR_16;
<br/>
    dopefish-&gt;objShape = OBJSHAPE_SQUARE;
<br/>
<br/>
    dopefish-&gt;posX = 112.5;                     
<br/>
    dopefish-&gt;rsMatrixIdx = ATTR1_ROTDATA(spriteInfo-&gt;oamId);
<br/>
    dopefish-&gt;objSize = OBJSIZE_32;
<br/>
<br/>
    dopefish-&gt;tileIdx = nextAvailableTileIdx;
<br/>
    nextAvailableTileIdx += dopefishTilesLen / BYTES_PER_16_COLOR_TILE;
<br/>
    dopefish-&gt;objPriority = OBJPRIORITY_1;
<br/>
    dopefish-&gt;objPal = dopefishInfo-&gt;oamId;
<br/>
<br/>
    rotateSprite(&amp;oam-&gt;matrixBuffer[spriteInfo-&gt;oamId],
<br/>
                 dopefishInfo-&gt;angle);
<br/>
<br/>
    static const int AK47_OAM_ID = 0;
<br/>
    assert(AK47_OAM_ID &lt; SPRITE_COUNT);
<br/>
    SpriteInfo * ak47Info = &amp;spriteInfo[AK47_OAM_ID];
<br/>
    SpriteEntry * ak47 = &amp;oam-&gt;spriteBuffer[AK47_OAM_ID];
<br/>
<br/>
    ak47Info-&gt;oamId = AK47_OAM_ID;
<br/>
    ak47Info-&gt;width = 32;
<br/>
    ak47Info-&gt;height = 32; 
<br/>
    ak47Info-&gt;angle = 462;
<br/>
    ak47Info-&gt;entry = ak47;
<br/>
//i placed the ak47 in the middle of nowhere just to see if i could get 
<br/>
//both sprites working
<br/>
    ak47-&gt;posY = 50;
<br/>
    ak47-&gt;isRotoscale = false;
<br/>
    assert(!ak47-&gt;isRotoscale || (ak47Info-&gt;oamId &lt; MATRIX_COUNT));
<br/>
    ak47-&gt;isHidden = false;
<br/>
    ak47-&gt;objMode = OBJMODE_NORMAL;
<br/>
    ak47-&gt;isMosaic = false;
<br/>
    ak47-&gt;colMode = OBJCOLOR_16;
<br/>
    ak47-&gt;objShape = OBJSHAPE_SQUARE;
<br/>
<br/>
    ak47-&gt;posX = 50;
<br/>
    ak47-&gt;objSize = OBJSIZE_32;
<br/>
<br/>
    ak47-&gt;tileIdx = nextAvailableTileIdx;
<br/>
    nextAvailableTileIdx += ak47TilesLen / BYTES_PER_16_COLOR_TILE;
<br/>
    ak47-&gt;objPriority = OBJPRIORITY_0;
<br/>
    ak47-&gt;objPal = ak47Info-&gt;oamId;
<br/>
<br/>
    rotateSprite(&amp;oam-&gt;matrixBuffer[spriteInfo-&gt;oamId],
<br/>
                 ak47Info-&gt;angle);
<br/>
<br/>
dmaCopyHalfWords(SPRITE_DMA_CHANNEL,
<br/>
                 dopefishPal,
<br/>
                 &amp;SPRITE_PALETTE[spriteInfo-&gt;oamId * COLORS_PER_PALETTE],
<br/>
				dopefishPalLen);
<br/>
dmaCopyHalfWords(SPRITE_DMA_CHANNEL,
<br/>
                 dopefishTiles,
<br/>
                 &amp;SPRITE_GFX[dopefish-&gt;tileIdx * OFFSET_MULTIPLIER],
<br/>
                 dopefishTilesLen);
<br/>
<br/>
dmaCopyHalfWords(SPRITE_DMA_CHANNEL,
<br/>
                 ak47Pal,
<br/>
                 &amp;SPRITE_PALETTE[spriteInfo-&gt;oamId * COLORS_PER_PALETTE],
<br/>
		                ak47PalLen);
<br/>
<br/>
dmaCopyHalfWords(SPRITE_DMA_CHANNEL,
<br/>
                 ak47Tiles,
<br/>
                 &amp;SPRITE_GFX[ak47-&gt;tileIdx * OFFSET_MULTIPLIER],
<br/>
                 ak47TilesLen);
<br/>
}
<br/>
<br/>
What am i doing wrong? Thanks.</span><span class="gensmall"><br/><br/>Last edited by Cave Johnson on Tue Feb 19, 2008 3:36 pm; edited 2 times in total</span></div>    
</div>
<div class="post">
    <h4>#151087 - Cave Johnson - Mon Feb 18, 2008 7:12 pm</h4>
    <div class="postbody"><span class="postbody">After messing with the code, i finally got both of the sprites in the game, and the fish sprite is colored correctly, while the gun is all black.  from my messing around it seems that this is do to oam 1 only containing the color black and not being palleted, does this make sense to anyone, and if so, how do i fix it?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#151100 - Cearn - Mon Feb 18, 2008 11:46 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Cave Johnson wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void initSprites(tOAM * oam, SpriteInfo *spriteInfo) 
<br/>
{
<br/>
    [[ other stuff omitted for clarity ]]
<br/>
<br/>
    static const int DOPEFISH_OAM_ID = 0;
<br/>
    
<br/>
    dopefishInfo-&gt;oamId = DOPEFISH_OAM_ID;
<br/>
    dopefish-&gt;objPal = dopefishInfo-&gt;oamId;
<br/>
<br/>
    static const int AK47_OAM_ID = 0;
<br/>
  
<br/>
    SpriteInfo * ak47Info = &amp;spriteInfo[AK47_OAM_ID];
<br/>
    SpriteEntry * ak47 = &amp;oam-&gt;spriteBuffer[AK47_OAM_ID];
<br/>
<br/>
    ak47Info-&gt;oamId = AK47_OAM_ID;
<br/>
    ak47-&gt;objPal = ak47Info-&gt;oamId;
<br/>
<br/>
    dmaCopyHalfWords(SPRITE_DMA_CHANNEL, dopefishPal, &amp;SPRITE_PALETTE[spriteInfo-&gt;oamId * COLORS_PER_PALETTE], dopefishPalLen);
<br/>
<br/>
<br/>
dmaCopyHalfWords(SPRITE_DMA_CHANNEL, ak47Pal, &amp;SPRITE_PALETTE[spriteInfo-&gt;oamId * COLORS_PER_PALETTE], ak47PalLen);
<br/>
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
What am i doing wrong? Thanks.</span></td> </tr></table><span class="postbody">
<br/>
The object use the same OAM ID, so one hides the other (but I guess you already figured that part out). Unless you forced grit to use 16 colors exactly, the palettes used are likely to be 256 colors in length, so even with different oamIds later palettes may override others. To be sure, check which colors are actually in the palette and where.
<br/>
<br/>
Also, [code]-tags makes code keep its formatting.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#151130 - Cave Johnson - Tue Feb 19, 2008 3:45 pm</h4>
    <div class="postbody"><span class="postbody">Ya im sorry that was my fault, i had changed their oam ids and forgot to fix the code in the origional post. Right now the spirte in oam 0(gun) is working fine and the colors perfect, but the fish in oam 1 is all black. I thought i had used 16 color palettes, did i do the grit file wrong
<br/>
<br/>
-W3
<br/>
<br/>
-p
<br/>
<br/>
-gt
<br/>
<br/>
-gB4
<br/>
<br/>
You also said to "check which colors are actually in the palette and where," but being a massive noob, i have no idea how to do that, and google is not helping at all. Thanks for putting up with me.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#151140 - Cearn - Tue Feb 19, 2008 6:07 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Cave Johnson wrote:</b></span></td> </tr> <tr> <td class="quote">Ya im sorry that was my fault, i had changed their oam ids and forgot to fix the code in the origional post. Right now the spirte in oam 0(gun) is working fine and the colors perfect, but the fish in oam 1 is all black. I thought i had used 16 color palettes, did i do the grit file wrong
<br/>
<br/>
-W3
<br/>
<br/>
-p
<br/>
<br/>
-gt
<br/>
<br/>
-gB4</td> </tr></table><span class="postbody">The number of colors that are exported is independent of the bitdepth of the graphics (this is more suitable if you have a single sprite sheet using multiple 16-color palettes). If you want 16 colors exactly, use <span style="font-style: italic">-pn 16</span>, with an optional <span style="font-style: italic">-ps</span> if the colors you want don't start at 0. Alternatively, simply copy 16 colors regardless of how long the exported palette is.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Cave Johnson wrote:</b></span></td> </tr> <tr> <td class="quote">You also said to "check which colors are actually in the palette and where," but being a massive noob, i have no idea how to do that, and google is not helping at all. Thanks for putting up with me.</td> </tr></table><span class="postbody">
<br/>
Open the binary in an emulator that has a palette viewer (DesmuMe and no$gba-debug should do the trick). You can also draw a create a 16x16 256-color sprite that displays all the colors:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
// Use these graphics for a 16x16@8 object to display the full object palette.
<br/>
const u8 palTiles[16*16]= {
<br/>
   0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07,
<br/>
   0x10, 0x11, 0x12, 0x13, 0x14, 0x15, 0x16, 0x17,
<br/>
   0x20, 0x21, 0x22, 0x23, 0x24, 0x25, 0x26, 0x27,
<br/>
   0x30, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37,
<br/>
   0x40, 0x41, 0x42, 0x43, 0x44, 0x45, 0x46, 0x47,
<br/>
   0x50, 0x51, 0x52, 0x53, 0x54, 0x55, 0x56, 0x57,
<br/>
   0x60, 0x61, 0x62, 0x63, 0x64, 0x65, 0x66, 0x67,
<br/>
   0x70, 0x71, 0x72, 0x73, 0x74, 0x75, 0x76, 0x77,
<br/>
   
<br/>
   0x08, 0x09, 0x0A, 0x0B, 0x0C, 0x0D, 0x0E, 0x0F,
<br/>
   0x18, 0x19, 0x1A, 0x1B, 0x1C, 0x1D, 0x1E, 0x1F,
<br/>
   0x28, 0x29, 0x2A, 0x2B, 0x2C, 0x2D, 0x2E, 0x2F,
<br/>
   0x38, 0x39, 0x3A, 0x3B, 0x3C, 0x3D, 0x3E, 0x3F,
<br/>
   0x48, 0x49, 0x4A, 0x4B, 0x4C, 0x4D, 0x4E, 0x4F,
<br/>
   0x58, 0x59, 0x5A, 0x5B, 0x5C, 0x5D, 0x5E, 0x5F,
<br/>
   0x68, 0x69, 0x6A, 0x6B, 0x6C, 0x6D, 0x6E, 0x6F,
<br/>
   0x78, 0x79, 0x7A, 0x7B, 0x7C, 0x7D, 0x7E, 0x7F,
<br/>
   
<br/>
   0x80, 0x81, 0x82, 0x83, 0x84, 0x85, 0x86, 0x87,
<br/>
   0x90, 0x91, 0x92, 0x93, 0x94, 0x95, 0x96, 0x97,
<br/>
   0xA0, 0xA1, 0xA2, 0xA3, 0xA4, 0xA5, 0xA6, 0xA7,
<br/>
   0xB0, 0xB1, 0xB2, 0xB3, 0xB4, 0xB5, 0xB6, 0xB7,
<br/>
   0xC0, 0xC1, 0xC2, 0xC3, 0xC4, 0xC5, 0xC6, 0xC7,
<br/>
   0xD0, 0xD1, 0xD2, 0xD3, 0xD4, 0xD5, 0xD6, 0xD7,
<br/>
   0xE0, 0xE1, 0xE2, 0xE3, 0xE4, 0xE5, 0xE6, 0xE7,
<br/>
   0xF0, 0xF1, 0xF2, 0xF3, 0xF4, 0xF5, 0xF6, 0xF7,
<br/>
   
<br/>
   0x88, 0x89, 0x8A, 0x8B, 0x8C, 0x8D, 0x8E, 0x8F,
<br/>
   0x98, 0x99, 0x9A, 0x9B, 0x9C, 0x9D, 0x9E, 0x9F,
<br/>
   0xA8, 0xA9, 0xAA, 0xAB, 0xAC, 0xAD, 0xAE, 0xAF,
<br/>
   0xB8, 0xB9, 0xBA, 0xBB, 0xBC, 0xBD, 0xBE, 0xBF,
<br/>
   0xC8, 0xC9, 0xCA, 0xCB, 0xCC, 0xCD, 0xCE, 0xCF,
<br/>
   0xD8, 0xD9, 0xDA, 0xDB, 0xDC, 0xDD, 0xDE, 0xDF,
<br/>
   0xE8, 0xE9, 0xEA, 0xEB, 0xEC, 0xED, 0xEE, 0xEF,
<br/>
   0xF8, 0xF9, 0xFA, 0xFB, 0xFC, 0xFD, 0xFE, 0xFF,
<br/>
};
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#151146 - Cave Johnson - Tue Feb 19, 2008 8:49 pm</h4>
    <div class="postbody"><span class="postbody">The palette viewer explained alot. It seems that it is only registering the colors from the gun sprite, but not any from the fish sprite. How do i fix this? I would think that it has something to do with my grit file, but none of the methods you suggested work,  although i am probably doing them wrong. Do you have anyother suggestions, and please explain anything as clearly and in as basic terms as possible, because once again, im a total noob at this stuff. Thanks.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#151148 - Dwedit - Tue Feb 19, 2008 10:14 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
dmaCopyHalfWords(SPRITE_DMA_CHANNEL, dopefishPal, &amp;SPRITE_PALETTE[spriteInfo-&gt;oamId * COLORS_PER_PALETTE], dopefishPalLen);
<br/>
dmaCopyHalfWords(SPRITE_DMA_CHANNEL, ak47Pal, &amp;SPRITE_PALETTE[spriteInfo-&gt;oamId * COLORS_PER_PALETTE], ak47PalLen); 
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I see that you overwrote the same palette memory location twice.  spriteInfo-&gt;oamId doesn't change, so you're overwriting the same memory inside the GBA's palette.  (at least that's what I'm guessing SPRITE_PALETTE is)<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#151180 - Cave Johnson - Wed Feb 20, 2008 4:04 pm</h4>
    <div class="postbody"><span class="postbody">"I see that you overwrote the same palette memory location twice. spriteInfo-&gt;oamId doesn't change, so you're overwriting the same memory inside the GBA's palette. (at least that's what I'm guessing SPRITE_PALETTE is)"  I understand what your saying, and i think that my proglem is that the palette is being overwritten, so i changed
<br/>
<br/>
spriteInfo-&gt;oamId * COLORS_PER_PALETTE], 
<br/>
<br/>
to
<br/>
<br/>
dopefishInfo-&gt;oamId * COLORS_PER_PALETTE], 
<br/>
<br/>
and
<br/>
<br/>
spriteInfo-&gt;oamId * COLORS_PER_PALETTE], 
<br/>
<br/>
to
<br/>
<br/>
ak47Info-&gt;oamId * COLORS_PER_PALETTE], 
<br/>
<br/>
No dice, i still get an all black fish sprite. Is this even what you meant? Thanks.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#151182 - Cearn - Wed Feb 20, 2008 4:46 pm</h4>
    <div class="postbody"><span class="postbody">Yeah, that should be better. Strange that it doesn't work then; are you sure the oamId's of dopefishInfo and ak47Info are different?
<br/>
<br/>
<ul><li>Fill the whole palette with an obnoxiously obvious color (pure green will work). This will show you how many colors are copied over.
<br/>
</li><li>Load <span style="font-weight: bold">one</span> palette instead of both. See which colors are now in the palette and where.
<br/>
</li><li>Repeat the procedure for the other palette.</li></ul>
<br/>
This tells you with certainty if the problem was the copy or the palettes themselves. It should also indicate what would happen when both copies are active.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#151194 - Cave Johnson - Wed Feb 20, 2008 8:17 pm</h4>
    <div class="postbody"><span class="postbody">Im not sure if i did it right, but this is what i did.
<br/>
<br/>
Commented out fish.
<br/>
Ran it in desmume. 
<br/>
Looked at the palette.
<br/>
Repeated only with gun commented out.
<br/>
<br/>
Either way, this did show me that in the palette viewer, the colors for fish were in the second line, while the colors for gun were in the first line, and i assume this means that they are not overwriting eachother.  But when i look at the palette with both sprites in it, the second line that normally contained the fish's colors, were all black. What does this mean? Thanks.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#151342 - Cave Johnson - Sat Feb 23, 2008 8:52 pm</h4>
    <div class="postbody"><span class="postbody">Hizzah!! After changing some of the spriteInfo into dopefishinfo or ak47info respectivly, the problem was fixed. Thanks everyone for helping me. Tepples your still a god.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
