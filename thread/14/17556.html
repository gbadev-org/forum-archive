<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Emulator compatibility - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>Beginners > Emulator compatibility</h2>
<div id="posts">
<div class="post">
    <h4>#176450 - GLaDOS - Fri Jul 29, 2011 5:45 am</h4>
    <div class="postbody"><span class="postbody">According to Dwedit, my game fails to run on NO$GBA but works on VBA. What are the differences between emulators that cause a game to fail on one particular version? How can I fix it?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#176454 - Dwedit - Fri Jul 29, 2011 6:58 am</h4>
    <div class="postbody"><span class="postbody">In the copy I have, some offending code at 080031A4 reads some pointer (03007B70), which is an address within the stack, then clobbers a return address with a zero value.  Then it later tries to return from a function, and returns to address 0, crashing the game.
<br/>
<br/>
What's really weird is that this is all in the Division code generated by the compiler, screwing up the stack and returning to a null address.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
<br/>
080030ec &lt;__aeabi_ldivmod&gt;:
<br/>
 80030ec:   e3530000    cmp   r3, #0
<br/>
 80030f0:   03520000    cmpeq   r2, #0
<br/>
 80030f4:   1a000006    bne   8003114 &lt;__aeabi_ldivmod+0x28&gt;
<br/>
 80030f8:   e3510000    cmp   r1, #0
<br/>
 80030fc:   03500000    cmpeq   r0, #0
<br/>
 8003100:   b3a01102    movlt   r1, #-2147483648   ; 0x80000000
<br/>
 8003104:   b3a00000    movlt   r0, #0
<br/>
 8003108:   c3e01102    mvngt   r1, #-2147483648   ; 0x80000000
<br/>
 800310c:   c3e00000    mvngt   r0, #0
<br/>
 8003110:   ea001463    b   80082a4 &lt;____aeabi_ldiv0_from_arm&gt;
<br/>
 8003114:   e24dd008    sub   sp, sp, #8
<br/>
 8003118:   e92d6000    push   {sp, lr}   @This is strange, why does it save the stack pointer?
<br/>
 800311c:   eb001473    bl   80082f0 &lt;____gnu_ldivmod_helper_from_arm&gt;
<br/>
 8003120:   e59de004    ldr   lr, [sp, #4]
<br/>
 8003124:   e28dd008    add   sp, sp, #8
<br/>
 8003128:   e8bd000c    pop   {r2, r3}
<br/>
 800312c:   e12fff1e    bx   lr   @dies here after it returns to an invalid address.
<br/>
<br/>
...
<br/>
<br/>
0800317c &lt;__gnu_ldivmod_helper&gt;:
<br/>
 800317c:   b5f0         push   {r4, r5, r6, r7, lr}
<br/>
 800317e:   b083         sub   sp, #12
<br/>
 8003180:   1c1d         adds   r5, r3, #0
<br/>
 8003182:   1c14         adds   r4, r2, #0
<br/>
 8003184:   9000         str   r0, [sp, #0]
<br/>
 8003186:   9101         str   r1, [sp, #4]
<br/>
 8003188:   f001 f832    bl   80041f0 &lt;__divdi3&gt;
<br/>
 800318c:   1c06         adds   r6, r0, #0
<br/>
 800318e:   1c0f         adds   r7, r1, #0
<br/>
 8003190:   1c32         adds   r2, r6, #0
<br/>
 8003192:   1c3b         adds   r3, r7, #0
<br/>
 8003194:   1c29         adds   r1, r5, #0
<br/>
 8003196:   1c20         adds   r0, r4, #0
<br/>
 8003198:   f7ff ffca    bl   8003130 &lt;__aeabi_lmul&gt;
<br/>
 800319c:   9a00         ldr   r2, [sp, #0]
<br/>
 800319e:   9b01         ldr   r3, [sp, #4]
<br/>
 80031a0:   1a12         subs   r2, r2, r0
<br/>
 80031a2:   418b         sbcs   r3, r1
<br/>
 80031a4:   9908         ldr   r1, [sp, #32]  @reads the previous stack pointer
<br/>
 80031a6:   600a         str   r2, [r1, #0]
<br/>
 80031a8:   604b         str   r3, [r1, #4]   @clobbers the return address and replaces it with 00000000
<br/>
 80031aa:   b003         add   sp, #12
<br/>
 80031ac:   1c30         adds   r0, r6, #0
<br/>
 80031ae:   1c39         adds   r1, r7, #0
<br/>
 80031b0:   bcf0         pop   {r4, r5, r6, r7}
<br/>
 80031b2:   bc04         pop   {r2}
<br/>
 80031b4:   4710         bx   r2
<br/>
 80031b6:   46c0         nop         ; (mov r8, r8)
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
It appears that NO$GBA and VBA emulate the Push SP instruction differently.  
<br/>
<br/>
VisualBoyAdvance pushes the value 03007B78 onto the stack, and NO$GBA pushes the value 03007B70 onto the stack.  So it clobbers the return address in NO$GBA, but not in VisualBoyAdvance.
<br/>
<br/>
As for why code would push the stack pointer onto the stack, that's up for debate.  Is this a bug in GCC?<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#176456 - GLaDOS - Fri Jul 29, 2011 7:19 am</h4>
    <div class="postbody"><span class="postbody">What about Windows vs Linux version of VBA-M? 
<br/>
<br/>
When I try to run it in my Ubuntu VM, it doesn't crash, but there's tons of graphical glitches and random stuff so it's not actually playable. Someone told me that the Linux version is more accurate than the Windows version.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#177458 - Grieverz - Mon Jun 11, 2012 3:19 pm</h4>
    <div class="postbody"><span class="postbody">I have similar issue, so I won't create new topic.
<br/>
<a href="http://pastie.org/4057436" target="_blank">http://pastie.org/4057436</a> - sourcecode
<br/>
So, this small piece of code does not work on vba 1.7.2, 1.7.1, though it runs ok on no$gba or vba-m (both linux and win). This is compiled with standard recommended TONC makefile and I've tried to change all compilation keys, it uses. I've also tried to change DKP toolchain (versions and base platform win/linux).
<br/>
This is a part of my small project <a href="http://griever.magicteam.net/files/CrackMe_byGriever.gba" target="_blank">http://griever.magicteam.net/files/CrackMe_byGriever.gba</a> - it just adds a few other source and data files, which are (as you can see) not a problem. Guess, the problem is in init code. 
<br/>
How can it be fixed?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#177468 - sgeos - Sat Jun 16, 2012 1:29 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>GLaDOS wrote:</b></span></td> </tr> <tr> <td class="quote">According to Dwedit, my game fails to run on NO$GBA but works on VBA. What are the differences between emulators that cause a game to fail on one particular version?</td> </tr></table><span class="postbody">
<br/>
Different emulators have different accuracy levels and bugs.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>GLaDOS wrote:</b></span></td> </tr> <tr> <td class="quote">How can I fix it?</td> </tr></table><span class="postbody">
<br/>
All final testing should be done on <span style="font-weight: bold">hardware</span>.  If your game works on hardware but not on a given emulator then you should double check your code.  It may have a horrible bug that is magically working for you on hardware.
<br/>
<br/>
If you are 99.9% sure your code is good, your favorite emulator may have a bug so you may wish to use a different emulator when you do not want to test on hardware.  If it works on any particular emulator but not on hardware, your code is simply broken and needs to be fixed.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#177469 - Dwedit - Sat Jun 16, 2012 7:49 pm</h4>
    <div class="postbody"><span class="postbody">Someone bumped this thread, so I might as well post this:
<br/>
<br/>
This is a workaround for NO$GBA's stack bug, when using 64-bit division in your program.  Doesn't fix anything else, just 64-bit division.
<br/>
Copy this to a .s file, and include it in your project.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
 .text
<br/>
 .align
<br/>
 .pool
<br/>
 
<br/>
 .global __aeabi_ldivmod
<br/>
 .global __aeabi_uldivmod
<br/>
<br/>
<br/>
__aeabi_ldivmod:
<br/>
   cmp   r3, #0
<br/>
   cmpeq   r2, #0
<br/>
   bne   0f
<br/>
   cmp   r1, #0
<br/>
   cmpeq   r0, #0
<br/>
   movlt   r1, #-2147483648   @ 0x80000000
<br/>
   movlt   r0, #0
<br/>
   mvngt   r1, #-2147483648   @ 0x80000000
<br/>
   mvngt   r0, #0
<br/>
   b   __aeabi_ldiv0
<br/>
0:
<br/>
   sub   sp, sp, #8
<br/>
   mov r12,sp
<br/>
   push   {r12, lr}
<br/>
   bl   __gnu_ldivmod_helper
<br/>
   ldr   lr, [sp, #4]
<br/>
   add   sp, sp, #8
<br/>
   pop   {r2, r3}
<br/>
   bx   lr
<br/>
<br/>
__aeabi_uldivmod:
<br/>
   cmp   r3, #0
<br/>
   cmpeq   r2, #0
<br/>
   bne   0f
<br/>
   cmp   r1, #0
<br/>
   cmpeq   r0, #0
<br/>
   mvnne   r1, #0
<br/>
   mvnne   r0, #0
<br/>
   b   __aeabi_ldiv0
<br/>
0:
<br/>
   sub   sp, sp, #8
<br/>
   mov r12,sp
<br/>
   push   {r12, lr}
<br/>
   bl   __gnu_uldivmod_helper
<br/>
   ldr   lr, [sp, #4]
<br/>
   add   sp, sp, #8
<br/>
   pop   {r2, r3}
<br/>
   bx   lr
<br/>
</td> </tr></table><span class="postbody"><br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
