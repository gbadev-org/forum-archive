<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>[SOLVED] sprites are acting crazy - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>Beginners > [SOLVED] sprites are acting crazy</h2>
<div id="posts">
<div class="post">
    <h4>#72518 - deltree - Sun Feb 19, 2006 2:23 pm</h4>
    <div class="postbody"><span class="postbody"><span style="color: brown"><span style="font-weight: bold">solution for this problem:</span>
<br/>
<span style="font-style: italic">never define an array without specify the size of it. else, it will work weirdly or not at all.</span></span>
<br/>
--------------------------------------------------------------
<br/>
<br/>
please, help me, I've spent hours on this, and I don't know what's wrong with it:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#include &lt;mygba.h&gt;
<br/>
// Graphics Includes (palette+ship+bullets)
<br/>
#include "gfx/general.pal.c"
<br/>
#include "gfx/tir.raw.c"
<br/>
#include "gfx/vaisseau.raw.c"
<br/>
// sprites
<br/>
u8 player_sprite,bullet_sprite,bullets_sprite[10]; // Sprite object number
<br/>
//positions
<br/>
u16 player_x,player_y,bullets_y[],bullets_x[];
<br/>
//variables
<br/>
int num_bullets=0,press_A=0,vbl_ok=0,i=0;
<br/>
<br/>
void vbl_func()
<br/>
{
<br/>
   vbl_ok=1;
<br/>
   ham_SetObjXY (player_sprite,player_x,player_y);
<br/>
   //move bullets
<br/>
   for (i=0;i&lt;num_bullets;i++)
<br/>
   {
<br/>
      if (bullets_y[i]&gt;10) bullets_y[i]--;
<br/>
      ham_SetObjXY(bullets_sprite[i],bullets_x[i],bullets_y[i]);
<br/>
   }
<br/>
   ham_CopyObjToOAM();
<br/>
} // End of vblFunc()
<br/>
<br/>
int main()
<br/>
{
<br/>
    ham_Init();
<br/>
   ham_SetBgMode(2); // Setup the background mode
<br/>
    ham_LoadObjPal((void*)general_Palette,256);
<br/>
    //create the player
<br/>
   player_x=50;
<br/>
   player_y=60;
<br/>
   player_sprite = ham_CreateObj((void*)vaisseau_Bitmap,OBJ_SIZE_16X16,OBJ_MODE_NORMAL,1,0,0,0,0,0,0,player_x,player_y);
<br/>
   //create the bullet sprite
<br/>
   bullet_sprite=ham_CreateObj((void*)tir_Bitmap,OBJ_SIZE_8X8,OBJ_MODE_NORMAL,1,0,0,0,0,0,0,240,10);
<br/>
   ham_StartIntHandler(INT_TYPE_VBL,(void*)&amp;vbl_func);
<br/>
    while(1)
<br/>
    {
<br/>
      if (vbl_ok==1)
<br/>
      {
<br/>
         vbl_ok=0;
<br/>
         //control the player
<br/>
         if(F_CTRLINPUT_LEFT_PRESSED &amp;&amp; player_x &gt; 0) player_x--;
<br/>
         if(F_CTRLINPUT_UP_PRESSED &amp;&amp; player_y &gt; 0) player_y--;
<br/>
         if(F_CTRLINPUT_DOWN_PRESSED &amp;&amp; player_y &lt; 144) player_y++;
<br/>
         if(F_CTRLINPUT_RIGHT_PRESSED &amp;&amp; player_x &lt; 224) player_x++;
<br/>
         
<br/>
         if(F_CTRLINPUT_A_PRESSED &amp;&amp; num_bullets&lt;10 &amp;&amp; press_A==0)
<br/>
         {
<br/>
            press_A=1;
<br/>
            bullets_x[num_bullets]=player_x;
<br/>
            bullets_y[num_bullets]=player_y;
<br/>
            bullets_sprite[num_bullets]=ham_CloneObj(bullet_sprite,bullets_x[num_bullets],bullets_y[num_bullets]);
<br/>
            num_bullets++;
<br/>
         }
<br/>
         else if(!F_CTRLINPUT_A_PRESSED ) press_A=0;
<br/>
      }
<br/>
    }
<br/>
} // End of main()</td> </tr></table><span class="postbody">
<br/>
the resulting rom is here:
<br/>
<a href="http://superdeltree.free.fr/jeux/devgba/test/shmups.gba" target="_blank">http://superdeltree.free.fr/jeux/devgba/test/shmups.gba</a>
<br/>
<br/>
it behaves properly untils the 5th missile is launched, and after, everything is fucked up. the missile don't move properly, the plane sprite dissapear, then the plane sprite come in place of one missile sprite. Please someone explain me what's wrong...</span><span class="gensmall"><br/><br/>Last edited by deltree on Mon Feb 20, 2006 10:17 am; edited 2 times in total</span></div>    
</div>
<div class="post">
    <h4>#72528 - deltree - Sun Feb 19, 2006 4:17 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#include &lt;mygba.h&gt;
<br/>
// Graphics Includes (palette+ship+bullets)
<br/>
#include "gfx/general.pal.c"
<br/>
#include "gfx/tir.raw.c"
<br/>
#include "gfx/vaisseau.raw.c"
<br/>
// sprites
<br/>
u8 player_sprite;
<br/>
u8 bullets_sprite[]; // Sprite object number
<br/>
//positions
<br/>
int i=0;
<br/>
<br/>
int main()
<br/>
{
<br/>
    ham_Init();
<br/>
   ham_SetBgMode(0); // Setup the background mode
<br/>
    ham_LoadObjPal((void*)general_Palette,256);
<br/>
   player_sprite = ham_CreateObj((void*)vaisseau_Bitmap,OBJ_SIZE_16X16,OBJ_MODE_NORMAL,1,0,0,0,0,0,0,50,100);
<br/>
   //create the bullet sprite
<br/>
   for (i=0;i&lt;10;i++)   {
<br/>
      bullets_sprite[i]=ham_CreateObj((void*)tir_Bitmap,OBJ_SIZE_8X8,OBJ_MODE_NORMAL,1,0,0,0,0,0,0,2+i*10,10);
<br/>
   }
<br/>
   ham_SetObjXY (player_sprite,50,100);
<br/>
   ham_CopyObjToOAM();
<br/>
    while(1)
<br/>
    {
<br/>
    }
<br/>
} // End of main()
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I simplified the code a lot, to check the origin of the problem:
<br/>
this code is only supposed to display 10 bullet sprites aligned, and 1 ship sprite on botton of screen.
<br/>
then, it's supposed to move the ship sprite to (50,100)...
<br/>
but instead, it's the bullet #9 that move at this position!!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#72532 - Cearn - Sun Feb 19, 2006 5:23 pm</h4>
    <div class="postbody"><span class="postbody">That's one interesting demo you got there o_O
<br/>
<br/>
Looking at that and the code from the OP, I think this may be the problem:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>deltree wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">u16 player_x,player_y,bullets_y[],bullets_x[];</td> </tr></table><span class="postbody"></span></td> </tr></table><span class="postbody">
<br/>
Sooo ... how many elements do bullets_y[] and bullets_x[] have exactly? Hint: it's not 10. 
<br/>
<br/>
Don't know if this will solve all the problems, but I'm guessing it'll go a long way. 
<br/>
<br/>
Two other issues you may run into in the future:
<br/>
Having loop counters (<span style="font-style: italic">i</span>) as global variables is probably a bad idea. What if you're calling a function that also uses it in it's own loop? 
<br/>
<br/>
When using unsigned variables, checks with 0 may not work the way you might hope. By definition, they are always positive. 
<br/>
<br/>
And, of course, the usual rant: don't #include code or data. And ints generally work better than bytes and halfwords. :P</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#72540 - deltree - Sun Feb 19, 2006 6:07 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Sooo ... how many elements do bullets_y[] and bullets_x[] have exactly? Hint: it's not 10. </td> </tr></table><span class="postbody">
<br/>
I Thought declaring the array like this would allow me to have as many elements as I needed to have, on the fly.
<br/>
<br/>
Having loop counters (i) as global variables is probably a bad idea. What if you're calling a function that also uses it in it's own loop?
<br/>
<br/>
the i variable, I always use it in the "for" loop, only. I may have multiple function using this variable, why not? exept for interrupt function, that are called whenever...
<br/>
<br/>
thanx a lot for all these tips whatsoever.
<br/>
It's getting so much on my nerves, those types and declares, sometime I just wanna give up.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#72541 - tepples - Sun Feb 19, 2006 6:45 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>deltree wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Sooo ... how many elements do bullets_y[] and bullets_x[] have exactly? Hint: it's not 10. </td> </tr></table><span class="postbody">
<br/>
I Thought declaring the array like this would allow me to have as many elements as I needed to have, on the fly.
<br/>
</span></td> </tr></table><span class="postbody">
<br/>
Nope, the way to do dynamic allocation in C is realloc(). But in an embedded environment, it's probably best to assume the worst case and have a maximum of however many bullets on the screen.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#72550 - Cearn - Sun Feb 19, 2006 8:34 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>deltree wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Sooo ... how many elements do bullets_y[] and bullets_x[] have exactly? Hint: it's not 10. </td> </tr></table><span class="postbody">
<br/>
I Thought declaring the array like this would allow me to have as many elements as I needed to have, on the fly.</span></td> </tr></table><span class="postbody">
<br/>
Sorry, not in this language. Arrays always have a static size. As tepples' said, you can allocate your own memory (don't forget to free it afterwards), but it's slower and you don't have much memory to begin with. 
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>deltree wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>cearn wrote:</b></span></td> </tr> <tr> <td class="quote">Having loop counters (i) as global variables is probably a bad idea. What if you're calling a function that also uses it in it's own loop?
<br/>
</td> </tr></table><span class="postbody">
<br/>
the i variable, I always use it in the "for" loop, only. I may have multiple function using this variable, why not? exept for interrupt function, that are called whenever...</span></td> </tr></table><span class="postbody">
<br/>
Consider what happens here:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">int ii=0;
<br/>
<br/>
void clear_row(int *row, int width)
<br/>
{
<br/>
    for(ii=0; ii&lt;width; ii++)
<br/>
        row[ii]= 0;
<br/>
}
<br/>
<br/>
void clear_matrix(int *matrix, int width, int height)
<br/>
{
<br/>
    for(ii=0; ii&lt;height; ii++)
<br/>
        clear_row(&amp;matrix[ii*height], width);
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
Inside clear_matrix(), <span style="font-style: italic">ii</span> starts as 0, then jumps to clear_row() where it is updated to <span style="font-style: italic">width</span>. When you return to clear_matrix(), the value will still be <span style="font-style: italic">width</span>, and not zero as it should be. Aside from that, being global also means it'll take up memory, which it has to be loaded from and stored into again whenever you use it, which equals slow code. 
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>deltree wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
It's getting so much on my nerves, those types and declares, sometime I just wanna give up.</td> </tr></table><span class="postbody">
<br/>
It can be frustrating if you're used to javascript or something like that, but the power of C (in both speed and compactness) comes from the fact that it is a pretty low level language. The price for that is that you have to be careful and to take care of memory stuff yourself.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#72556 - deltree - Sun Feb 19, 2006 9:29 pm</h4>
    <div class="postbody"><span class="postbody">Thank for the help, it works now.
<br/>
That's a good lesson to learn, next time I won't waste so much time about it.
<br/>
about global variable:
<br/>
I'm perfectly aware of the problem you describe, this is very logic.
<br/>
it's the same as having a "for..." loop inside another one, the variable mustn't have the same name of course.
<br/>
Well, I guess it can avoid mistakes, so I'll do as you said, local, not global.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
