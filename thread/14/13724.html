<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Assets in separate files - some problems - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>Beginners > Assets in separate files - some problems</h2>
<div id="posts">
<div class="post">
    <h4>#135083 - ShannonB - Fri Jul 20, 2007 3:56 am</h4>
    <div class="postbody"><span class="postbody">So in my ongoing quest, aided by TONC, to develop Good Programming Habits (TM) from the start, I'm facing some issues.
<br/>
<br/>
I used to #include my image data in my main.cpp file before compiling.  This, we have concluded, is a Bad Thing (TM).
<br/>
<br/>
I have 3 image data files to deal with:
<br/>
<br/>
test.map.c
<br/>
test.raw.c
<br/>
test.pal.c
<br/>
<br/>
So after reading up, I did the following.
<br/>
<br/>
1) commented out the #includes in my main.cpp
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
//include the sample tileset/map
<br/>
//#include "test.pal.c"
<br/>
//#include "test.raw.c"
<br/>
//#include "test.map.c"
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
2) added the files to be compiled separately in my makefile
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
# --- Project details ---
<br/>
PROJ    := eclipgba
<br/>
EXT     := gba
<br/>
<br/>
CFILES  := main.cpp test.map.c test.pal.c test.raw.c
<br/>
   
<br/>
COBJS   := $(CFILES:.cpp=.o)
<br/>
OBJS    := $(COBJS)
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
3) Declared the arrays that are contained in the external files, in my main.cpp just before my function prototype declarations
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
// ===declarations ===
<br/>
<br/>
extern const unsigned short test_Map[1024];
<br/>
extern const unsigned short test_Palette[256];
<br/>
extern const unsigned char test_Tiles[28416];
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
4) Commented out the declarations of the array types in the external files (since they're already declared in my main.cpp right?  If I declare them twice I get an error?)
<br/>
<br/>
like this...
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
/*
<br/>
 * 32x32 map data
<br/>
 */
<br/>
//const unsigned short 
<br/>
test_Map[1024] = {
<br/>
0x0000, 0x0001, 0x0001, 0x0002, 0x0000, 0x0001, 0x0001, 0x0003, ...etc
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I did the other 2 in the same way, so I'm not going to waste space and copy them here.
<br/>
<br/>
My c++ knowledge may be lacking, but I'm not sure how, after I've declared them, the data actually gets put into them before I use them in my code.  However I can't seem to find any further steps.
<br/>
<br/>
When I compile I get the following error.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
make -f makefile build 
<br/>
makefile:41: target `test.map.c' doesn't match the target pattern
<br/>
makefile:41: target `test.pal.c' doesn't match the target pattern
<br/>
makefile:41: target `test.raw.c' doesn't match the target pattern
<br/>
test.map.c:5: warning: data definition has no type or storage class
<br/>
test.pal.c:2: warning: data definition has no type or storage class
<br/>
test.raw.c:5: warning: data definition has no type or storage class
<br/>
d:/devkitpro/devkitarm/bin/../lib/gcc/arm-eabi/4.1.1/../../../../arm-eabi/bin/ld.exe: address 0x301d890 of eclipgba.elf section .data is not within region iwram
<br/>
collect2: ld returned 1 exit status
<br/>
make: *** [eclipgba.elf] Error 1
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I have a feeling my problem might be with the makefile, but I'm really not sure.  I guess the next thing is to go and do some more work on learning about makefiles?
<br/>
<br/>
Oh, and this was compiling and working correctly before I attempted this.<br/>_________________<br/>"Do you know what the chain of command is? It's the chain I get and beat you with until you understand who's in rutting command here!" -Jayne Cobb</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#135086 - tepples - Fri Jul 20, 2007 4:09 am</h4>
    <div class="postbody"><span class="postbody">"Not within region iwram" likely means you forgot a <span style="font-weight: bold">const</span> somewhere, forcing a big array into .data (in IWRAM) instead of .rodata (in EWRAM or ROM).
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">4) Commented out the declarations of the array types in the external files (since they're already declared in my main.cpp right? If I declare them twice I get an error?) </td> </tr></table><span class="postbody">
<br/>
Which error do you get if you leave them in? I don't know of any penalty for duplicate <span style="font-style: italic">declarations</span> of extern arrays, just duplicate <span style="font-style: italic">definitions</span>.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#135091 - ShannonB - Fri Jul 20, 2007 4:24 am</h4>
    <div class="postbody"><span class="postbody">Ok, I removed the commenting out for the declaration.
<br/>
<br/>
Now my data starts with:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
const unsigned char test_Tiles[28416] = {
<br/>
0xf6, 0xed, 0xd2, 0xd2, 0xd2, 0xd2, 0xd2, 0xd2, 0xd2, 0xb0, 0x01, 0x01, 0x01, 0x01, 0x01,.......................
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Ok, it compiles and works now.  thanks!  Guess my c++ knowledge still sucks.
<br/>
<br/>
I still get an odd message from the makefile, even though it works.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
make -f makefile build 
<br/>
makefile:41: target `test.map.c' doesn't match the target pattern
<br/>
makefile:41: target `test.pal.c' doesn't match the target pattern
<br/>
makefile:41: target `test.raw.c' doesn't match the target pattern
<br/>
copy from `eclipgba.elf' [elf32-littlearm] to `eclipgba.gba' [binary]
<br/>
ROM fixed!
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
'doesn't match the target pattern'?<br/>_________________<br/>"Do you know what the chain of command is? It's the chain I get and beat you with until you understand who's in rutting command here!" -Jayne Cobb</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#135096 - tepples - Fri Jul 20, 2007 4:45 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>ShannonB wrote:</b></span></td> </tr> <tr> <td class="quote">I still get an odd message from the makefile, even though it works.
<br/>
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
make -f makefile build 
<br/>
makefile:41: target `test.map.c' doesn't match the target pattern
<br/>
makefile:41: target `test.pal.c' doesn't match the target pattern
<br/>
makefile:41: target `test.raw.c' doesn't match the target pattern
<br/>
copy from `eclipgba.elf' [elf32-littlearm] to `eclipgba.gba' [binary]
<br/>
ROM fixed!
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
'doesn't match the target pattern'?</span></td> </tr></table><span class="postbody">
<br/>
Could it have something to do with the difference between .cpp and .c?<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#135107 - Ant6n - Fri Jul 20, 2007 6:54 am</h4>
    <div class="postbody"><span class="postbody">On a side note, wouldnt Good Programming Habits (TM) require you to put the definitions in separate header files, i.e.
<br/>
<br/>
test.map.h
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#define test_MapLen 2048
<br/>
extern const unsigned short test_Map[1024];
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
test.pal.h
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#define test_PaletteLen 512
<br/>
extern const unsigned short test_Palette[256];
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
test.raw.h</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#define test_TilesLen 28416
<br/>
extern const unsigned char test_Tiles[28416];
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
of course with #ifdefs etc
<br/>
or maybe put the definintions in the same header, dunno</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#135108 - ShannonB - Fri Jul 20, 2007 7:02 am</h4>
    <div class="postbody"><span class="postbody">Ant6n: I guess.. but wouldn't that just end up defeating the purpose of things?  Now I have 3 more files in my project, with a single line of code in each one?
<br/>
<br/>
Dunno, could we get a ruling on this?  Cearn?  ...Cearn?
<br/>
<br/>
and Tepples, if I change the name of my data files to .cpp instead of .c files, I get the following error:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
make -f makefile build 
<br/>
main.o: In function `main':
<br/>
D:\Projects\eclipgba/main.cpp:147: undefined reference to `test_Palette'
<br/>
D:\Projects\eclipgba/main.cpp:147: undefined reference to `test_Tiles'
<br/>
D:\Projects\eclipgba/main.cpp:147: undefined reference to `test_Map'
<br/>
collect2: ld returned 1 exit status
<br/>
make: *** [eclipgba.elf] Error 1
<br/>
</td> </tr></table><span class="postbody"><br/>_________________<br/>"Do you know what the chain of command is? It's the chain I get and beat you with until you understand who's in rutting command here!" -Jayne Cobb</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#135116 - keldon - Fri Jul 20, 2007 8:33 am</h4>
    <div class="postbody"><span class="postbody">(a) maybe try testMap.cpp or test_map.cpp
<br/>
(b) what you do in a small project may not necessarily be what you do in a larger project. But either way having a header would be the better choice, even if it's for 1 image. Although you could just have one image.h and image.cpp containing the map, palette and data.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#135124 - wintermute - Fri Jul 20, 2007 9:40 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>ShannonB wrote:</b></span></td> </tr> <tr> <td class="quote">Ant6n: I guess.. but wouldn't that just end up defeating the purpose of things?  Now I have 3 more files in my project, with a single line of code in each one?
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
It depends on how the headers are created - personally I prefer to have my data's headers and object files generated from the makefile. You'll see this method used in some of the libnds examples using grit ( currently known as git in r20 )
<br/>
<br/>
If you're doing things manually then there's no particular reason to favour multiple headers over a single header for all your data array prototypes. 
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
and Tepples, if I change the name of my data files to .cpp instead of .c files, I get the following error:
<br/>
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
D:\Projects\eclipgba/main.cpp:147: undefined reference to `test_Palette'
<br/>
</td> </tr></table><span class="postbody"></span></td> </tr></table><span class="postbody">
<br/>
<br/>
add extern to the declarations in the .cpp files
<br/>
<br/>
See <a href="http://www.kuzbass.ru:8086/docs/isocpp/dcl.html" target="_blank">http://www.kuzbass.ru:8086/docs/isocpp/dcl.html</a>
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>isocpp wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
7.1.1 - Storage class specifiers [dcl.stc]
<br/>
<br/>
-6- A name declared in a namespace scope without a
<br/>
storage-class-specifier has external linkage unless it has internal linkage
<br/>
because of a previous declaration and provided it is not declared const.
<br/>
Objects declared const and not explicitly declared extern have internal
<br/>
linkage.
<br/>
</td> </tr></table><span class="postbody"><br/>_________________<br/><a class="postlink" href="http://www.devkitpro.org/" target="_blank">devkitPro - professional toolchains at amateur prices</a>
<br/>
<a class="postlink" href="http://wiki.devkitpro.org/index.php/IRC" target="_blank">devkitPro IRC support</a>
<br/>
<a class="postlink" href="http://davejmurphy.com/" target="_blank">Personal Blog</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#135127 - Cearn - Fri Jul 20, 2007 10:04 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>ShannonB wrote:</b></span></td> </tr> <tr> <td class="quote">2) added the files to be compiled separately in my makefile
<br/>
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
# --- Project details ---
<br/>
PROJ    := eclipgba
<br/>
EXT     := gba
<br/>
<br/>
CFILES  := main.cpp test.map.c test.pal.c test.raw.c
<br/>
   
<br/>
COBJS   := $(CFILES:.cpp=.o)
<br/>
OBJS    := $(COBJS)
<br/>
</td> </tr></table><span class="postbody">
<br/>
</span></td> </tr></table><span class="postbody">
<br/>
<br/>
The COBJS line takes the CFILES list and turns all ".cpp" extensions into ".o" extensions. test.map.c and such do not have a .c extension and are therefore excluded. Renaming to ".cpp" will fix that, but this causes other problems, namely these:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>ShannonB wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">make -f makefile build
<br/>
main.o: In function `main':
<br/>
D:\Projects\eclipgba/main.cpp:147: undefined reference to `test_Palette'
<br/>
D:\Projects\eclipgba/main.cpp:147: undefined reference to `test_Tiles'
<br/>
D:\Projects\eclipgba/main.cpp:147: undefined reference to `test_Map'
<br/>
collect2: ld returned 1 exit status
<br/>
make: *** [eclipgba.elf] Error 1 
<br/>
</td> </tr></table><span class="postbody"></span></td> </tr></table><span class="postbody">
<br/>
<br/>
This is one of those areas where something that works in C, doesn't quite work in C++. In C++, const data is considered static, unless you add an 'extern' declaration in the datafile as well. What this means is that unless you do something like this:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">// foo.cpp : A file with data arrays
<br/>
<br/>
extern const char fooData[];    // External declaration !!
<br/>
<br/>
const char fooData[]= {...};     // Data definition.
<br/>
</td> </tr></table><span class="postbody">
<br/>
fooData will not be visible outside of foo.cpp
<br/>
<br/>
Instead of renaming the datafiles to .cpp, either use pure C for all (only works if there aren't any C++-y things in your code), or split the rules into C and CPP items. C and CPP need different compilation tools anyway, so this might be the way to go here.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
# Makefile Rules for C and C++ code.
<br/>
CFILES   := test.map.c test.raw.c test.pal.c
<br/>
CPPFILES := main.cpp
<br/>
<br/>
COBJS   := $(CFILES:.c=.o)
<br/>
CPPOBJS :=  $(CPPFILES:.c=.o)
<br/>
OBJS    := $(COBJS) $(CPPOBJS)
<br/>
<br/>
CFLAGS   := ...
<br/>
CPPFLAGS := ...
<br/>
<br/>
# etc
<br/>
</td> </tr></table><span class="postbody">
<br/>
Or, instead of altering your current makefile, you can use devkitPro's template makefiles where all of this is already done for you.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>ShannonB wrote:</b></span></td> </tr> <tr> <td class="quote">Ant6n: I guess.. but wouldn't that just end up defeating the purpose of things? Now I have 3 more files in my project, with a single line of code in each one? </td> </tr></table><span class="postbody">
<br/>
The problem with #including data is that it would need recompiling every time you do anything inside main.cpp. But this is only required if the <span style="font-style: italic">definitions</span> of the data are #included. The external thingies are <span style="font-style: italic">declarations</span>, which just tell the compiler that something of a given name exists somewhere in the project. 
<br/>
<br/>
You don't have to have one additional file for each data-file either. If you prefer, you can dump all the declarations into a single file. As Wintermute hinted, <a class="postlink" href="http://www.coranac.com/projects.php#grit" target="_blank">grit</a> can also create the header files for you.
<br/>
<br/>
Note: because of C++'s name-mangling, you need to put extern "C" { ... } around the declarations for the things in the C files, otherwise the linker will look for the wrong names:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">// in main.cpp. I may be off in the syntax a little here.
<br/>
<br/>
extern "C" {
<br/>
#include "test.pal.h"
<br/>
#include "test.raw.h"
<br/>
#include "test.map.h"
<br/>
};
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
