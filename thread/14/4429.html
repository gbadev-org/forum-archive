<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>For Fire Demo Need Help - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>Beginners > For Fire Demo Need Help</h2>
<div id="posts">
<div class="post">
    <h4>#29517 - cba - Sun Nov 21, 2004 10:31 am</h4>
    <div class="postbody"><span class="postbody">Hi,
<br/>
I am a french's noob trying to make a simple fire demo. But after a lot of try, I don't find what I'am doing wrong in my code. 
<br/>
<br/>
Could you help me ?
<br/>
<br/>
Thanks,
<br/>
Cba
<br/>
<br/>
<br/>
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#include "gba.h"
<br/>
#include &lt;stdio.h&gt;
<br/>
#include &lt;stdlib.h&gt;
<br/>
#include &lt;string.h&gt;
<br/>
<br/>
<br/>
#define VCOUNT *(volatile u16*)0x4000006
<br/>
<br/>
//random max
<br/>
#define RAND_MAX 32767
<br/>
volatile s32 RAND_RandomData;
<br/>
<br/>
void SeedRandom(void);
<br/>
void waitForVSync(void);
<br/>
void flipBuffers(void);
<br/>
void Create_Fire_Pal(void);
<br/>
<br/>
s32 RAND(s32 Value);
<br/>
#define twopixel(a,b) ( (u16)( (a&lt;&lt;8) | b ) )
<br/>
u16* videoBuffer   = (u16*) 0x6000000;
<br/>
<br/>
<br/>
int main()
<br/>
{
<br/>
   int x,y;
<br/>
   u16 tabcolor[31];
<br/>
   u8 tabref[240][160];
<br/>
    u16 avg;    //average color
<br/>
    u8 color; //fire color   
<br/>
<br/>
   SetMode(MODE_4 | BG2_ENABLE);
<br/>
<br/>
   Create_Fire_Pal();
<br/>
   
<br/>
   flipBuffers();
<br/>
   
<br/>
   SeedRandom();         
<br/>
<br/>
   u8 white = 128;
<br/>
   
<br/>
   // Then loop
<br/>
   while ( true )
<br/>
   {
<br/>
      // bottom row is withe
<br/>
      for(x=0; x&lt;240; x=x+2)
<br/>
       {          
<br/>
           tabref[x][159] = white;
<br/>
           tabref[x+1][159] = white;
<br/>
           videoBuffer[(159*120)+x/2] = twopixel(tabref[x][159],tabref[x+1][159]);
<br/>
       }      
<br/>
         
<br/>
      for(y=157; y&lt;160; y++)
<br/>
        {
<br/>
            for(x=0; x&lt;240; x+=16)
<br/>
            {
<br/>
                color = (char)rand()%128;     // get a random color
<br/>
                
<br/>
                if(color&gt;64) color = 128; // all or nothing;
<br/>
                if(color&lt;63) color = 0;   // white or black
<br/>
                
<br/>
                // this just makes fatter fire -- horizontal 8-pixel
<br/>
                // wide seed colors. Try changing this to just 4-pixel
<br/>
                // wide seeds and see what happens. 
<br/>
                for (int j=0;j&lt;16;j++ )
<br/>
                {
<br/>
                   tabref[x+j][y]=color;
<br/>
                }
<br/>
<br/>
                videoBuffer[(y*120)+x/2]   = twopixel(tabref[x][y],tabref[x+1][y]);
<br/>
                videoBuffer[(y*120)+x/2+1] = twopixel(tabref[x+2][y],tabref[x+3][y]);
<br/>
                videoBuffer[(y*120)+x/2+2] = twopixel(tabref[x+4][y],tabref[x+5][y]);
<br/>
                videoBuffer[(y*120)+x/2+3] = twopixel(tabref[x+6][y],tabref[x+7][y]);
<br/>
                videoBuffer[(y*120)+x/2+4] = twopixel(tabref[x+8][y],tabref[x+9][y]);
<br/>
                videoBuffer[(y*120)+x/2+5] = twopixel(tabref[x+10][y],tabref[x+11][y]);
<br/>
                videoBuffer[(y*120)+x/2+6] = twopixel(tabref[x+12][y],tabref[x+13][y]);
<br/>
                videoBuffer[(y*120)+x/2+7] = twopixel(tabref[x+14][y],tabref[x+15][y]);
<br/>
            }
<br/>
        }   
<br/>
<br/>
      // then get the uppers val      
<br/>
      for(y=159; y&gt;0; y--)
<br/>
        {
<br/>
            avg = 0;
<br/>
            
<br/>
            for(x=0; x&lt;240; x=x+2)
<br/>
            {
<br/>
               
<br/>
               if ( x!=0 )
<br/>
               {
<br/>
                   avg  = tabref[x][y+1];
<br/>
                   avg += tabref[x-1][y];
<br/>
                   avg += tabref[x][y];
<br/>
                   avg += tabref[x+1][y];                            
<br/>
                   avg = avg/4;                
<br/>
                   if(avg&gt;1) avg -= 1;                   
<br/>
                   if ( avg&gt;128 ) avg=127;
<br/>
                  tabref[x][y] = avg;        
<br/>
               }
<br/>
               else
<br/>
               {
<br/>
                  tabref[x][y]=0;
<br/>
               }
<br/>
                
<br/>
                avg  = tabref[x+1][y+1];
<br/>
                avg += tabref[x+1-1][y];
<br/>
                avg += tabref[x+1][y];
<br/>
                avg += tabref[x+1+1][y];                            
<br/>
                avg = avg/4;                
<br/>
                if(avg&gt;1) avg -= 1;  
<br/>
                
<br/>
                if ( avg&gt;128 ) avg=127;  
<br/>
                                            
<br/>
                  tabref[x+1][y] = avg;                  
<br/>
                
<br/>
                // move "blurred" pixel up by one line
<br/>
                videoBuffer[(y*120)+x/2]   = twopixel(tabref[x][y],tabref[x+1][y]);                              
<br/>
                
<br/>
                //videoBuffer[(y*120)+x/2]   = twopixel(tabref[x][y],white);                                             
<br/>
            }
<br/>
        }      
<br/>
      
<br/>
      flipBuffers();      
<br/>
   }
<br/>
<br/>
return 0;
<br/>
<br/>
}
<br/>
<br/>
<br/>
void Create_Fire_Pal()
<br/>
{
<br/>
    u8 i = 0;
<br/>
    
<br/>
    for (i=0; i&lt;32; i++)
<br/>
    {
<br/>
        BG_PaletteMem[i]     = RGB(i,0,0);     // black to max red
<br/>
        BG_PaletteMem[i+32]  = RGB(31,i,0);    // max red to max yellow
<br/>
        BG_PaletteMem[i+64]  = RGB(31,31,0);   // max yellow
<br/>
        BG_PaletteMem[i+96 ] = RGB(31,31-i,0); // max yellow to red; we just do the opposite of the color eqn above     
<br/>
    }
<br/>
    BG_PaletteMem[ 128 ]=RGB(31,31,31);
<br/>
} 
<br/>
<br/>
void flipBuffers()
<br/>
{
<br/>
  if (REG_DISPCNT &amp; backbuffer)
<br/>
  {
<br/>
    REG_DISPCNT &amp;= ~backbuffer;
<br/>
    videoBuffer = videoBackBuffer;
<br/>
  } else {
<br/>
    REG_DISPCNT |= backbuffer;
<br/>
    videoBuffer = FrontBuffer;
<br/>
  }
<br/>
<br/>
} // fin flipBuffers()
<br/>
<br/>
void waitForVSync()
<br/>
{
<br/>
  volatile u16* vreg = (volatile u16*) 0x04000004;
<br/>
  while (  *vreg &amp; (1 &lt;&lt; 0));
<br/>
  while (!(*vreg &amp; (1 &lt;&lt; 0)));
<br/>
<br/>
} // fin waitForVSync()
<br/>
<br/>
void SeedRandom(void)
<br/>
{
<br/>
RAND_RandomData = VCOUNT;
<br/>
}
<br/>
<br/>
s32 RAND(s32 Value)
<br/>
{
<br/>
RAND_RandomData *= 20077;
<br/>
RAND_RandomData += 12345;
<br/>
<br/>
return ((((RAND_RandomData &gt;&gt; 16) &amp; RAND_MAX) * Value) &gt;&gt; 15);
<br/>
}
<br/>
<br/>
<br/>
</td> </tr></table><span class="postbody"><br/>_________________<br/>Cba</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#29523 - Cearn - Sun Nov 21, 2004 1:32 pm</h4>
    <div class="postbody"><span class="postbody">I was going to mention that it's usually a good idea to trace the bug in a small section of code before posting and give a description of what goes wrong, but seeing the code run I can completely understand why you didn't.
<br/>
The main problem is the definition of tabref[240][160]. Local variables will always go into IWRAM, which is 32kB in size. tabref is 38kB, and therefore swamps your whole work RAM. After that, anything can happen.
<br/>
A solution to this would be to make it a global variable and put it into EWRAM, your gba.h should have a IN_EWRAM definition, or something of the sort, then define tabref as
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
// global scope
<br/>
u8 tabref[240][160] IN_EWRAM;
<br/>
</td> </tr></table><span class="postbody">
<br/>
It won't solve all your problems, but at least it doesn't crash anymore.
<br/>
<br/>
One more thing. I'm sure someone will correct me for this if I'm wrong, but I thought that multidimensional arrays in C were row-based, so the last index would be for adjacent memory. tabref[240][160] would have 240 rows of 160 entries, not 160 rows of 240 entries, meaning you've effectively transposed the screen.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#29525 - cba - Sun Nov 21, 2004 2:16 pm</h4>
    <div class="postbody"><span class="postbody">Thanks a lot I am going to try that<br/>_________________<br/>Cba</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#29627 - cba - Mon Nov 22, 2004 9:20 pm</h4>
    <div class="postbody"><span class="postbody">A very big thanks It is working :) Youpi<br/>_________________<br/>Cba</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
