<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Sprites, animation states and animation frames - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>Beginners > Sprites, animation states and animation frames</h2>
<div id="posts">
<div class="post">
    <h4>#23776 - DialogPimp - Wed Jul 21, 2004 12:07 pm</h4>
    <div class="postbody"><span class="postbody">As my first noob post I'd just like to say thanks to all who have contributed to this forum.  My first project (a Frogger clone) is progressing nicely thanks to lots of searching on these forums, the various tutorials and devkitarm/VC6.
<br/>
<br/>
I'm looking for thoughts from the more experienced about animation and <b style="color:#FFA34F">state</b> systems for sprites.  Whilst not strictly needed for my first project, I'm planning for the future and would like to have a decent framework in place.
<br/>
<br/>
My thinking so far is revolving around a sprite having 1 to n states (climb ladder, walk left, walk right etc), each of which may have one or more frames (eg 4 frames for climbing a ladder), each of which may need to be displayed for n number of game frames/vblanks.
<br/>
<br/>
Add to this the limited amount of VRAM available and (it seems) that DMA'ing in each frame into the relevant OAMData area for that sprite is the way to go.  The excellent document by Tepples would confirm this.
<br/>
<br/>
So, how do the pros handle animation systems like this ?  I was thinking FSM and some sort of LUT ???</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#23781 - poslundc - Wed Jul 21, 2004 1:48 pm</h4>
    <div class="postbody"><span class="postbody">You've done your homework, and you're pretty much dead on.
<br/>
<br/>
If you're working in straight C, the way I do it is by defining a SpriteLibrary structure that basically contains the dictionary definition of a sprite character. This contains, among other things, a pointer to the raw image data of the sprite, things like the sprite's width and size, and information needed to animate the sprite.
<br/>
<br/>
For this animation information, I use another structure called SpriteKeyframe, which simply defines an index into the sprite data and the number of VBlanks to delay before switching to the next frame. (I'd have to check, but I may also include some other information like H/V flipping.) An array of these SpriteKeyframes will define a sequence of animation; an array of these arrays will define a dictionary of different animation sequences for different sprite states, eg. walking, running, jumping, etc. This array is then referenced by my SpriteLibrary record.
<br/>
<br/>
Finally, I use a SpriteEntity record for each of my active character entities in the game. This SpriteEntity is in active memory and references a SpriteLibrary, and contains <b style="color:#FFA34F">state</b> information like where the sprite is positioned, what animation <b style="color:#FFA34F">state</b> it is in, what keyframe, the animation counter, etc. It also contains some relevant hardware information, like where this sprite resides in Sprite VRAM (for purposes of where to DMA the next frame of animation to) and which palette it occupies (assuming 16-colour sprites). I also used to associate it with an OAM entry until I began generating OAM data on the fly.
<br/>
<br/>
Hope this helps,
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#23793 - keldon - Wed Jul 21, 2004 7:56 pm</h4>
    <div class="postbody"><span class="postbody">FSM is the ultimate method of planning; for example (this is not FSM) you can write this:
<br/>
<br/>
VBL 1: write frame 1 to screen
<br/>
VBL 2: (frame 1 drawn) test actions for frame 1 and display results for frame 2
<br/>
VBL 3: (frame 2 drawn) etc.
<br/>
<br/>
This will remind you that when you draw something to the screen; that it will appear by the next frame; also remind yourself that your code after WaitVBL functions will occur after the next VBL frame; so the sequence of events are:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">Enter Code: WaitVBL ()
<br/>
- VBL Occurs: VBLHandler ()
<br/>
- VBL Exits; VBL done
<br/>
Code after waitVBL is executed
<br/>
<br/>
WaitVBL ()
<br/>
- VBL Occurs: VBLHandler ()
<br/>
- VBL Exits; VBL done
<br/>
Code after waitVBL is executed</td> </tr></table><span class="postbody">
<br/>
<br/>
Also for animations you may have more than one sprite making up the animation; so you may, for example have a sprite map instead of just a sprite position. This is no difficult task. If you care creating a 2x2 map; for example with 5 frames then you create a 2x10 map with 5 frames. Now frame one is mapAddress [ 0 ], frame two is mapAddress [ 4 ]; and frame 'x' is mapAddress [ ( x - 1 ) * (2x2) ]
<br/>
<br/>
I personally am unsure of <b style="color:#FFA34F">state</b> machines tutorials, and have limited PC access to create a tutorial on it and upload; not to mention the computer I am doing my update is not at home right now; but I'm sure someone here will write one for you in time.
<br/>
<br/>
---
<br/>
A little on FSA (<b style="color:#FFA34F">Finite</b> <b style="color:#FFA34F">State</b> Automa) using an example.
<br/>
<br/>
Consider the special moves in street fighter; The joypad has the following inputs:
<br/>
d = down
<br/>
f = forward
<br/>
b = back
<br/>
u = up
<br/>
df = down,right etc.
<br/>
HP = high punch
<br/>
<br/>
so to execute a 'fireball' you would have to give the following input:
<br/>
<span style="font-weight: bold">d, df, f, HP</span> - which is basically a quarter circle from down to forward, followed by a punch.
<br/>
<br/>
But how would you go about that in code? Do you wait for the HP and then work your way backward? What if he's in the air? What if he's punching at the current moment?
<br/>
<br/>
Keeping it simple, our starting <b style="color:#FFA34F">state</b> is stationary. Our <b style="color:#FFA34F">Finite</b> <b style="color:#FFA34F">State</b> <b style="color:#FFA34F">Machine</b> consists of nothing.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">( 0 ) &lt;-- start and end <b style="color:#FFA34F">state</b></td> </tr></table><span class="postbody">
<br/>
<br/>
Now let's add a punch function
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">  0 &lt;----|
<br/>
  |      |
<br/>
  |HP    |
<br/>
  |      |
<br/>
  V      |
<br/>
  1 ------</td> </tr></table><span class="postbody">
<br/>
<br/>
How this works is that <b style="color:#FFA34F">state</b> 0 is stationary. When HP is recieved, code is now in <b style="color:#FFA34F">State</b> 1 and executes any necessary code for handling HP from <b style="color:#FFA34F">state</b> 1.
<br/>
<br/>
Now we can add to this FSM. How about we add a 'fireball' since we were talking about it.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">    ----&gt;  0  &lt;-------
<br/>
    |     / \        |
<br/>
    |    /   \d      |
<br/>
    | HP/     v      |
<br/>
    |  /      2      |
<br/>
    | /        \df   |
<br/>
    |/          v    |
<br/>
    v            3   |
<br/>
    1            f\  |
<br/>
                   v |
<br/>
                   4 |
<br/>
                  HP\|
<br/>
                     v
<br/>
                     5</td> </tr></table><span class="postbody">
<br/>
the 'v' letter represents the down arrow. Now in this <b style="color:#FFA34F">finite</b> <b style="color:#FFA34F">state</b> <b style="color:#FFA34F">machine</b> we can execute a punch from the stationary position, but not after pressing down. When down is pressed from <b style="color:#FFA34F">state</b> 0, we then move over to <b style="color:#FFA34F">state</b> 2, from <b style="color:#FFA34F">state</b> 2 if df is recieved then we move over to <b style="color:#FFA34F">state</b> 3; and so forth. eventually at <b style="color:#FFA34F">state</b> 4 when we recieve HP we move on to <b style="color:#FFA34F">state</b> 5.
<br/>
<br/>
At each <b style="color:#FFA34F">state</b> we can perform an operation such duck between <b style="color:#FFA34F">state</b> 0 and 2 when down is recieved.
<br/>
<br/>
---
<br/>
<br/>
The link I have given you (in my later post) is a course which describes this better than I could; but the example I've given shows you how important the concept of <b style="color:#FFA34F">finite</b> <b style="color:#FFA34F">state</b> machines are. Unfortunately some of the files are inaccessable, such as when they ask you to go to specific file directories on the server; we're not allowed to share them files, but I can give you some of my own in a few weeks.</span><span class="gensmall"><br/><br/>Last edited by keldon on Wed Jul 21, 2004 11:27 pm; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#23796 - poslundc - Wed Jul 21, 2004 9:45 pm</h4>
    <div class="postbody"><span class="postbody">Keldon, what you are describing is a game <b style="color:#FFA34F">state</b> loop that can be used to process a <b style="color:#FFA34F">finite</b> <b style="color:#FFA34F">state</b> <b style="color:#FFA34F">machine</b>. It is a good architecture to do it with, but it is not an actual <b style="color:#FFA34F">finite</b> <b style="color:#FFA34F">state</b> <b style="color:#FFA34F">machine</b>, which is basically a set of states, inputs, outputs and a transformation function.
<br/>
<br/>
Most games are probably not very concerned with the issue of single-frame latency, especially since a game running at 60 FPS is running at approximately twice the threshold of human perception of fluid motion.
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#23801 - keldon - Wed Jul 21, 2004 11:02 pm</h4>
    <div class="postbody"><span class="postbody">Oh, my bad I wrote my post wrong; I've corrected it now.
<br/>
<br/>
And here is a course on Language &amp; Communication covering FSA's:
<br/>
<a href="http://www.dcs.qmul.ac.uk/intranet/courses/ug/coursenotes/DCS103/" target="_blank">www.dcs.qmul.ac.uk/intranet/courses/ug/coursenotes/DCS103/</a></span><span class="gensmall"><br/><br/>Last edited by keldon on Thu Jul 22, 2004 8:45 am; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#23806 - DialogPimp - Thu Jul 22, 2004 12:02 am</h4>
    <div class="postbody"><span class="postbody">Thanks for your help - looks like I was moving in the right direction.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#23814 - DialogPimp - Thu Jul 22, 2004 4:03 am</h4>
    <div class="postbody"><span class="postbody">Dan one last question.  Did you decide upon an arbitrary maximum number of SpriteKeyFrames in your implementation ?  I'm obviously wanting to keep all this info const which means I need to define my array sizes up front.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#23815 - sajiimori - Thu Jul 22, 2004 4:12 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
Most games are probably not very concerned with the issue of single-frame latency, especially since a game running at 60 FPS is running at approximately twice the threshold of human perception of fluid motion.
<br/>
</td> </tr></table><span class="postbody">
<br/>
30fps looks fine, but switching to 60fps makes everything look silky smooth and sharp.  Try it sometime -- the difference is striking.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#23816 - sajiimori - Thu Jul 22, 2004 4:22 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
Dan one last question. Did you decide upon an arbitrary maximum number of SpriteKeyFrames in your implementation ? I'm obviously wanting to keep all this info const which means I need to define my array sizes up front.
<br/>
</td> </tr></table><span class="postbody">
<br/>
I can't speak for Dan, but I usually either have a pair of an array and a length, or an array with a termination marker.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
// explicitly store length
<br/>
const int array[] = { 100, 200, 300 };
<br/>
const int length = sizeof(a)/sizeof(*a);
<br/>
<br/>
// use -1 as a terminator
<br/>
const int array[] = { 100, 200, 300, -1 };
<br/>
</td> </tr></table><span class="postbody">
<br/>
When you're using structs, the last field can be an array of unspecified length:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
typedef struct
<br/>
{
<br/>
    int array1[3]; // normal struct member
<br/>
<br/>
    //int array2[]; can't do this because compiler can't
<br/>
    // determine offset of array3
<br/>
<br/>
    int array3[]; // doesn't matter how big this array is
<br/>
    // because there's nothing after it to access.
<br/>
} S;
<br/>
<br/>
const S s = { { 100, 200, 300 }, { 400, 500, 600, -1 } };
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#23817 - DialogPimp - Thu Jul 22, 2004 5:56 am</h4>
    <div class="postbody"><span class="postbody">Mmmph - thanks sajimori.  I read that in a previous post of yours, tried it early on and got build errors galore.  I just went back and tried it again and all was fine, so there's another problem solved.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#23827 - poslundc - Thu Jul 22, 2004 1:38 pm</h4>
    <div class="postbody"><span class="postbody">Saji's got it... I store both the pointer to the array and an integer saying the array length.
<br/>
<br/>
Random example of how it might be done:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">static const Keyframe aniWalk[] = {
<br/>
     (Keyframe){0, 4},   // assume first element is sprite's index,
<br/>
     (Keyframe){1, 4},   // second element is delay to next frame
<br/>
     (Keyframe){2, 4},
<br/>
     (Keyframe){3, 4}
<br/>
};
<br/>
<br/>
static const Keyframe aniJump[] = {
<br/>
     (Keyframe){0, 4},
<br/>
     (Keyframe){4, 3},
<br/>
     (Keyframe){5, 3},
<br/>
     (Keyframe){6, 1},
<br/>
     (Keyframe){0, 4}
<br/>
};
<br/>
<br/>
static const Keyframe *aniFrames[] = {aniWalk, aniJump};
<br/>
static const int aniFrameLengths[] = {4, 5}; // size of the arrays
<br/>
<br/>
const SpriteInfo jumpMan = {
<br/>
          ...
<br/>
     aniFrames,
<br/>
     aniFrameLengths,
<br/>
          ...
<br/>
};</td> </tr></table><span class="postbody">
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
