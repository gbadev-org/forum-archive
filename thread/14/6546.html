<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>PCX2SPRITE - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>Beginners > PCX2SPRITE</h2>
<div id="posts">
<div class="post">
    <h4>#50525 - biubid_boy - Wed Aug 10, 2005 12:26 pm</h4>
    <div class="postbody"><span class="postbody">I'm using Dovoto's PCX2SPRITE and a 256 colour .pcx file (8x32), but whenever I use it in my game, it comes up scrambled and weird coloured. My code is:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#include "gba.h"
<br/>
#include "paddlersbg.h"
<br/>
#include "ball.h"
<br/>
#include "xxx.h"
<br/>
<br/>
void InitializeSprites(void);
<br/>
void CopyOAM(void);
<br/>
void MoveSprite(OAMEntry* sp, int x, int y);
<br/>
void MoveBall(void);
<br/>
void Movepaddleyellow(void);
<br/>
<br/>
OAMEntry sprites[128];
<br/>
<br/>
u16 xball = 30;
<br/>
u16 yball = 50;
<br/>
u16 xpaddleyellow = 10;
<br/>
u16 ypaddleyellow = 10;
<br/>
<br/>
u8 ballDirection = 0;
<br/>
<br/>
u8 xMax = 148;
<br/>
u8 yMax = 144;
<br/>
u8 xMin = 8;
<br/>
u8 yMin = 8;
<br/>
<br/>
int main() {
<br/>
<br/>
   u16 loop;
<br/>
<br/>
   SetMode(MODE_4 | BG2_ENABLE | OBJ_ENABLE | OBJ_MAP_1D);
<br/>
<br/>
   for(loop = 0; loop &lt; 256; loop++) {
<br/>
   OBJ_PaletteMem[loop] = ballPalette[loop];
<br/>
   }
<br/>
<br/>
   for (loop = 0; loop &lt; 256; loop++) {
<br/>
      BG_PaletteMem[loop]=paddlersbgPalette[loop];
<br/>
   }
<br/>
<br/>
   for (loop = 0; loop &lt; (120*160); loop++) {
<br/>
      FrontBuffer[loop] = paddlersbgData[loop] ;
<br/>
   }
<br/>
<br/>
   memcpy( (u16 *)0x06014000, &amp;ballData, sizeof(ballData) );
<br/>
   memcpy( (u16 *)0x06014100, &amp;paddleyellowData, sizeof(paddleyellowData) );
<br/>
<br/>
   sprites[0].attribute0 = COLOR_256 | SQUARE | yball;
<br/>
   sprites[0].attribute1 = SIZE_8 | xball;
<br/>
   sprites[0].attribute2 = 512;
<br/>
<br/>
   sprites[1].attribute0 = COLOR_256 | TALL | ypaddleyellow;
<br/>
   sprites[1].attribute1 = SIZE_32 | xpaddleyellow;
<br/>
   sprites[1].attribute2 = 512 + 8;
<br/>
<br/>
   while(1)
<br/>
   {
<br/>
      MoveBall();
<br/>
      Movepaddleyellow();
<br/>
      MoveSprite(&amp;sprites[0],xball,yball);
<br/>
      MoveSprite(&amp;sprites[1],xpaddleyellow,ypaddleyellow);
<br/>
      WaitForVsync();
<br/>
      CopyOAM();
<br/>
   }
<br/>
<br/>
   return 0;
<br/>
<br/>
}
<br/>
<br/>
void InitializeSprites(void)
<br/>
{
<br/>
   u16 loop;
<br/>
   for(loop = 0; loop &lt; 128; loop++) {
<br/>
      sprites[loop].attribute0 = 160;
<br/>
      sprites[loop].attribute1 = 240;
<br/>
   }
<br/>
}
<br/>
<br/>
void CopyOAM(void)
<br/>
{
<br/>
   u16 loop;
<br/>
   u16* temp;
<br/>
   temp = (u16*)sprites;
<br/>
   for(loop = 0; loop &lt; 128*4; loop++)   {
<br/>
      OAM_Mem[loop] = temp[loop];
<br/>
   }
<br/>
}
<br/>
<br/>
void MoveSprite(OAMEntry* sp, int x, int y)
<br/>
{
<br/>
   sp-&gt;attribute1 = sp-&gt;attribute1 &amp; 0xFE00;
<br/>
   sp-&gt;attribute1 = sp-&gt;attribute1 | x;
<br/>
<br/>
   sp-&gt;attribute0 = sp-&gt;attribute0 &amp; 0xFF00;
<br/>
   sp-&gt;attribute0 = sp-&gt;attribute0 | y;
<br/>
}
<br/>
<br/>
void MoveBall(void) {
<br/>
   if (ballDirection == 0 &amp;&amp; xball &lt; xMax &amp;&amp; yball &lt; yMax) {
<br/>
      xball++;xball++;xball++;
<br/>
      yball++;yball++;
<br/>
   }
<br/>
   if (ballDirection == 0 &amp;&amp; (xball &gt;= xMax || yball &gt;= yMax )) {
<br/>
      if (xball &gt;= xMax) {
<br/>
         ballDirection = 3;
<br/>
      } else {
<br/>
         ballDirection = 1;
<br/>
      }
<br/>
   }
<br/>
<br/>
   if (ballDirection == 1 &amp;&amp; xball &lt; xMax &amp;&amp; yball &gt; yMin) {
<br/>
      xball++;xball++;xball++;
<br/>
      yball--;yball--;
<br/>
   }
<br/>
   if (ballDirection == 1 &amp;&amp; (xball &gt;= xMax || yball &lt;= yMin )) {
<br/>
      if (xball &gt;= xMax) {
<br/>
         ballDirection = 2;
<br/>
      } else {
<br/>
         ballDirection = 0;
<br/>
      }
<br/>
   }
<br/>
<br/>
   if (ballDirection == 2 &amp;&amp; xball &gt; xMin &amp;&amp; yball &gt; yMin) {
<br/>
      xball--;xball--;xball--;
<br/>
      yball--;yball--;
<br/>
   }
<br/>
   if (ballDirection == 2 &amp;&amp; (xball &lt;= xMin || yball &lt;= yMin )) {
<br/>
      if (xball &lt;= xMin) {
<br/>
         ballDirection = 1;
<br/>
      } else {
<br/>
         ballDirection = 3;
<br/>
      }
<br/>
   }
<br/>
<br/>
   if (ballDirection == 3 &amp;&amp; xball &gt; xMin &amp;&amp; yball &lt; yMax) {
<br/>
      xball--;xball--;xball--;
<br/>
      yball++;yball++;
<br/>
   }
<br/>
   if (ballDirection == 3 &amp;&amp; (xball &lt;= xMin  || yball &gt;= yMax)) {
<br/>
      if (xball &lt;= xMin) {
<br/>
         ballDirection = 0;
<br/>
      } else {
<br/>
         ballDirection = 2;
<br/>
      }
<br/>
   }
<br/>
}
<br/>
<br/>
void Movepaddleyellow(void)
<br/>
{
<br/>
   if(keyDown(KEY_DOWN) &amp;&amp; ypaddleyellow &lt; yMax - 24)
<br/>
   {
<br/>
       ypaddleyellow++;ypaddleyellow++;ypaddleyellow++;
<br/>
   }
<br/>
   if(keyDown(KEY_UP) &amp;&amp; ypaddleyellow &gt; yMin)
<br/>
   {
<br/>
       ypaddleyellow--;ypaddleyellow--;ypaddleyellow--;
<br/>
   }
<br/>
}
<br/>
<br/>
</td> </tr></table><span class="postbody">
<br/>
Anyone know why it keeps happening and how to fix it? 
<br/>
<br/>
Thanks for any help,
<br/>
Biubid_boy.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#50547 - Cearn - Wed Aug 10, 2005 5:47 pm</h4>
    <div class="postbody"><span class="postbody">If graphics are scambled and/or garbled, it's often because a) the original bitmap wasn't in the bitdepth you thought it was, or b) the converter doesn't convert to the bitdepth you think it does. It could be that the pcx was 24bpp, and converter took it for 8bpp (which is technically true, as a 24bpp pcx uses 3 color planes), or maybe the converter defaults to 4bpp output. But it's difficult to say without seeing either the image or the exported data. 
<br/>
<br/>
Another possibility is that the sprite attributes aren't set properly.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">   sprites[1].attribute0 = COLOR_256 | TALL | ypaddleyellow; 
<br/>
   sprites[1].attribute1 = SIZE_32 | xpaddleyellow; 
<br/>
   sprites[1].attribute2 = 512 + 8; 
<br/>
</td> </tr></table><span class="postbody"></span></td> </tr></table><span class="postbody">
<br/>
There are two types of tall 32 high sprites: 32x8 and 32x16. One of them uses the size parameter 0x8000 (SIZE_16), the other uses 0xC000 (SIZE_32). Guess which one belongs to 32x8.
<br/>
<br/>
Also, a few words of warning/recommendation for further programming:
<br/>
<ul><li>Do <span style="font-weight: bold">NOT</span> use bytes (s8/u8) or halfwords (s16/u16) for local variables unless you really, really have to. It does not save any memory, and actually reduces the speed of your algorithms. The GBA is a 32bit machine, so words (int/s32/u32) will work faster in pretty much every occasion (<a class="postlink" href="http://forum.gbadev.org/viewtopic.php?t=5751" target="_blank">forum:5751</a>).
<br/>
</li><li>Do <span style="font-weight: bold">NOT</span> #include (graphics) data. That is, don't put data in header files, or include C files that have data in them. Compile the files with data separately and then link them, rather than include everything into main.c and compile that. This way, you'll avoid multiple definition errors, problems with having too much data in one C file, and cut down on compile time because you don't have to recompile the whole project with every little change (<a class="postlink" href="http://forum.gbadev.org/viewtopic.php?t=2605" target="_blank">forum:2605</a>, <a class="postlink" href="http://forum.gbadev.org/viewtopic.php?t=2562" target="_blank">forum:2562</a>, <a class="postlink" href="http://forum.gbadev.org/viewtopic.php?t=3687" target="_blank">forum:3687</a>).
<br/>
</li><li>Multiple ++ or -- statements should be using += or -=. "x++; x++" is both silly and horrible to look at; "x += 2" please.
<br/>
</li><li>Use the <a class="postlink" href="http://www.devkitpro.org" target="_blank">devkitARM</a> toolchain rather than devkitadv, which hasn't been updated in ages. devkitARM is updated often, almost every other week it seems).</li><li>Be careful with memcpy() (<a class="postlink" href="http://forum.gbadev.org/viewtopic.php?t=6461" target="_blank">forum:6461</a>) and sizeof() (<a class="postlink" href="http://forum.gbadev.org/viewtopic.php?t=6496" target="_blank">forum:6496</a>).</li></ul>
<br/>
I'll try to locate a few threads which deal with these problems, but I have to hurry right now. Feel free to search for these points yourself. A number of older tutorials have some horrible coding standards, which you could rather do without. One that don't have these kinds of problems are <a class="postlink" href="http://www.drunkencoders.com/index.php?system_id=2&amp;page=Tutorials" target="_blank">updated pern</a> and *cough* <a class="postlink" href="http://user.chem.tue.nl/jakvijn/tonc/toc.htm" target="_blank">my own</a>, be sure to read those as well. Oh, and read the <a class="postlink" href="http://forum.gbadev.org/viewtopic.php?t=418" target="_blank">FAQ</a>, if you haven't already.
<br/>
<br/>
<span style="font-size: 9px; line-height: normal">ETA: linkies</span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#50647 - biubid_boy - Thu Aug 11, 2005 9:56 am</h4>
    <div class="postbody"><span class="postbody">The sprite I am using is <a href="http://tinypic.com/ac6hwl.jpg">[Images not permitted - Click here to view it]</a>
<br/>
The result I get is <a href="http://tinypic.com/ac6hrc.jpg">[Images not permitted - Click here to view it]</a>.
<br/>
Thanks for any help,
<br/>
Biubid_boy.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#50649 - Cearn - Thu Aug 11, 2005 10:54 am</h4>
    <div class="postbody"><span class="postbody">As I said earlier (well hinted at), for a 8x32 sprite you need SIZE_16, instead of SIZE_32. 
<br/>
The rest is a palette issue. I'm guessing it's because you use ballPalette for the object palette, and the palettes of the ball and paddle are different. There is <span style="font-weight: bold">one</span> palette for all sprites, so your sprite graphics need to use the same palette. Or arrange the palettes in such a way that they can be put in the object palette without conflicting.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#50652 - biubid_boy - Thu Aug 11, 2005 11:43 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">There is one palette for all sprites, so your sprite graphics need to use the same palette. Or arrange the palettes in such a way that they can be put in the object palette without conflicting.</td> </tr></table><span class="postbody">
<br/>
How would i do that exactly?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#50669 - tepples - Thu Aug 11, 2005 4:44 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Cearn wrote:</b></span></td> </tr> <tr> <td class="quote">There is <span style="font-weight: bold">one</span> palette for all sprites, so your sprite graphics need to use the same palette. Or arrange the palettes in such a way that they can be put in the object palette without conflicting.</td> </tr></table><span class="postbody">
<br/>
Specifically, use 4-bit tiles. This gives you 16 independent palettes each of 15 colors.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#50900 - biubid_boy - Sun Aug 14, 2005 11:52 am</h4>
    <div class="postbody"><span class="postbody">Sorry, I can't seem to get it working. Could you tell me where I could find a tutorial for it. (I'm a newb).
<br/>
Thanks for any help,
<br/>
Biubid_boy.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#51991 - biubid_boy - Thu Aug 25, 2005 10:54 am</h4>
    <div class="postbody"><span class="postbody">Anyone?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#51994 - Cearn - Thu Aug 25, 2005 11:12 am</h4>
    <div class="postbody"><span class="postbody">Using the same palette for all graphics:
<br/>
... just .... do it. Create a single bitmap with both the ball and paddles on it and convert the whole thing. Now there's one palette you can use for both sprites.
<br/>
<br/>
Using separate bitmaps with separate palettes:
<br/>
Again, just do it. Let the ball bitmap use palette indices 0-15 (or 0-31 or whatever), let the paddle bitmap use palette entries 16-31. Convert both bitmaps. Copy the first 16 entries for the ball palette to OBJ-palette 0-15, copy entries 16-31 from the paddle palette to OBJ-palette 16-31.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#52287 - biubid_boy - Mon Aug 29, 2005 12:23 pm</h4>
    <div class="postbody"><span class="postbody">I tried the first thing you said, and I got <a class="postlink" href="http://tinypic.com/be7fa0.jpg" target="_blank"> this </a>. 
<br/>
Can you tell me how to fix it?
<br/>
Thanks for any help,
<br/>
Biubid_Boy.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#52296 - Cearn - Mon Aug 29, 2005 1:43 pm</h4>
    <div class="postbody"><span class="postbody">When it comes to colors a screenshot is pretty much useless, the problem lies with the <span style="font-weight: bold">palette</span>.
<br/>
<br/>
Bitmaps can be divided into true-color and palette images; in a palette image, the numbers in the pixels are <span style="font-weight: bold">not</span> actual colors. The colors themselves are stored in a color look-up table (palette), and the pixel-values indicate which color should be displayed for that pixel. Then to change the colors, you change the palette, not the pixels.
<br/>
On the GBA, you have two color tables: one for the backgrounds, one for the objects, each 256 entries long. When you export an image to 16 or 256 colors, the data of the xxxData array are <span style="font-weight: bold">not</span> the actual colors, but just indices. There's usually a xxxPalette array for the actual colors. While a user may expect certain colors to go with a certain image, for paletted bitmap the colors and the pixeldata are completely separate. It's perfectly valid to use the palette of one bitmap as the color-table of another. The basic image is the same, just with different colors. And that's exactly the problem you're having here.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">   for(loop = 0; loop &lt; 256; loop++) { 
<br/>
   OBJ_PaletteMem[loop] = ballPalette[loop]; 
<br/>
   }</td> </tr></table><span class="postbody"></span></td> </tr></table><span class="postbody">
<br/>
This loads the ball's colors, but if the palette of the paddle bitmap had different colors (and apparently it does), you'll get a paddle with ball colors. Because there's only a single palette for all objs, simply loading the paddle palette won't do you any good as in that case the ball would have use the paddle palette. To avoid this, you need to
<br/>
<span style="font-weight: bold">a)</span> Make sure the palettes of both bitmaps are the same, which is guaranteed if they're actually part of the same bitmap. <a class="postlink" href="http://user.chem.tue.nl/jakvijn/files/palette.png" target="_blank">Example</a>. 
<br/>
<span style="font-weight: bold">b)</span> If you must have multiple bitmaps and different palettes, make sure they never fight over the same palette indices. If both use, say, palette ranges 0-16 but expect different colors, you're screwed. Using different palette indices in making the bitmaps (or accounting for the difference in-game) would solve this ... as long as you also load only the part of the palettes that you need. And put them <span style="font-style: italic">exactly</span> where they are needed. 
<br/>
<span style="font-weight: bold">b ii) </span> If you must have multiple bitmaps and different palettes, make sure they never fight over the same palette indices, part two. The color tables can also be interpreted as sixteen 16color palettes. For this, the data in VRAM should be 4 bits per pixel; this makes up the lower nybble of the palette index; the high nybble is taken from the top 4 bits of obj attribute 2. Load the 16 color palettes of different bitmaps into different sub-palettes, set attribute 2 and things should work.
<br/>
Other methods exist too, of course.
<br/>
<br/>
Run demos from the various tutorial sites and check the various VBA viewers (especially palette and tile viewers) to understand what's going on. As for creating bitmaps, make sure you have a bitmap editor that lets you manipulate the palette directly. MS-Paint doesn't qualify for example.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
