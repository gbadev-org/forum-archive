<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Probably a silly mistake... - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>Beginners > Probably a silly mistake...</h2>
<div id="posts">
<div class="post">
    <h4>#39833 - Ultima2876 - Tue Apr 12, 2005 8:18 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void scansep(void)
<br/>
   {
<br/>
      if (hspeed[REG_VCOUNT] == 0)
<br/>
         {
<br/>
            hspeed[REG_VCOUNT] = random(2, 6);
<br/>
         }
<br/>
      hoffset[REG_VCOUNT] += hspeed[REG_VCOUNT];
<br/>
      if (hoffset[REG_VCOUNT] &gt; 256)
<br/>
         {
<br/>
            hoffset[REG_VCOUNT] = 0;
<br/>
            hspeed[REG_VCOUNT] = 0;
<br/>
         }
<br/>
      REG_BG0HOFS = hoffset[REG_VCOUNT];
<br/>
   }</td> </tr></table><span class="postbody">
<br/>
<br/>
This is my Hblank function. It works fine, apart from the fact that the hoffset seems to be resetting prematurely - the effect I'm trying to achieve is one of stars flying by at (pseudo)random speeds. Once a star goes a bit offscreen (to the left - hoffset &gt; 256) the hoffset is reset and the speed of the "new" star is calculated.
<br/>
<br/>
All the REG_VCOUNT stuff is to have it so that every scanline retains its own properties (offset and speed). I have the hoffset and hspeed arrays set up with 256 elements each (I'm going to clear this up once my code is done - if I had too few elements it would cause problems but too many is easy to sort out later).
<br/>
<br/>
The result is that the starts scroll fine, every looks great, until stars start randomly disappearing (their hoffset is being reset to 0). I've been staring at this code for hours and really can't see what's wrong. Other relevant code bits:
<br/>
<br/>
RNG function:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">s32 random(s32 min, s32 max)
<br/>
      {
<br/>
         seed *= 69069;
<br/>
         return min + ((max - min + 1) * (seed &gt;&gt; 16)) / 0x10000; 
<br/>
      }</td> </tr></table><span class="postbody">
<br/>
<br/>
Variables:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">u16 hoffset[256] = { 0, };
<br/>
u8 hspeed[256] = { 0, };
<br/>
u32 seed = 122;</td> </tr></table><span class="postbody">
<br/>
<br/>
If you need screenshots, just ask and I'll grab some. Thanks.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#39834 - poslundc - Tue Apr 12, 2005 8:28 pm</h4>
    <div class="postbody"><span class="postbody">Don't really have time to look at your code indepth, but try pre-calculating your settings for each scanline, storing them in an array, and then just copying the values out during HBlank. This can often make the difference for a number of reasons.
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#39901 - Cearn - Wed Apr 13, 2005 10:26 am</h4>
    <div class="postbody"><span class="postbody">The HBlank is only 272 cycles long; when I try the function no$gba gives me 338 for your function. It depends on compiler flags, code-base, section etc, but chances are the function takes just a leetle too long so REG_VCOUNT might have changed somewhere in the middle of the function, which would be bad. A quick remedy would be to have a temp variable read REG_VCOUNT at the start, but in the end poslundc' suggestion is probably preferable.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#39902 - Ultima2876 - Wed Apr 13, 2005 10:39 am</h4>
    <div class="postbody"><span class="postbody">Excellent, I thought it'd be something like this. That explains it perfectly. Thanks so much, both of you.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
