<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Emulation errors (only appear in new no$gba). - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>Beginners > Emulation errors (only appear in new no$gba).</h2>
<div id="posts">
<div class="post">
    <h4>#68940 - wiz - Fri Jan 27, 2006 2:41 pm</h4>
    <div class="postbody"><span class="postbody">With a bit of help previously I had a "techincally perfect" game rating from no$gba.
<br/>
<br/>
Nothing has changed besides the emulator, as announced on the news page that a new release of nocash is available so being quite happy to upgrade and find any new features.  I had a look at the error log to be satisfied yet again about a "technically perfect" game rating but to shock horror there were <span style="font-weight: bold">thousands</span> of errors!  and telling me my game contains bugs and is unstable.
<br/>
<br/>
help me, what has changed?, why is it now picking up all these new errors :*(
<br/>
<br/>
of course I still need to disable all my code and pin point the problems myself but Im really hoping someone may be aware of anything obvious to look for.
<br/>
<br/>
Thank you!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#68952 - wintermute - Fri Jan 27, 2006 4:22 pm</h4>
    <div class="postbody"><span class="postbody">You could register the homebrew debugger and find the problems that way or  upload your rom somewhere so that someone with the registered version can test for you.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#68988 - Miked0801 - Fri Jan 27, 2006 8:16 pm</h4>
    <div class="postbody"><span class="postbody">I'll take a breeze through the notes and see if anything has changed...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#69583 - wiz - Tue Jan 31, 2006 5:16 pm</h4>
    <div class="postbody"><span class="postbody">Cheers Mike, anything noticed?
<br/>
<br/>
I'll have a look tonight to see if I can discover what is throwing all these errors..  will let you know if I manage it :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#78764 - Cearn - Sun Apr 09, 2006 5:12 pm</h4>
    <div class="postbody"><span class="postbody">* <span style="font-style: italic">uses phoenix down on thread</span> *
<br/>
<br/>
Just saw that I have the same problem with no$gba 2.2b: thousands (tens of thousands) of errors, even right at the start, and a lot more when I enable interrupts. I found these to be the main culprits.
<br/>
<br/>
First, interrupt code that makes advantage of IWRAM mirroring for the main interrupt vector (0300:7FFC-&gt;03FF:FFFC) and/or bios acknowledge register (0300:7FF8-&gt;03FF:FFF8). The latter is an issue for pern, tonc and libgba. A fix would be the following:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">@ ---current code ---
<br/>
@ (InterruptDispatcher.s, irq_handler.asm, single_ints.s):
<br/>
   ldrh    r2, [r3, #-8]
<br/>
   orr     r2, r2, r1
<br/>
   strh    r2, [r3, #-8]
<br/>
<br/>
@ --- suggested replacement: ---
<br/>
   ldr     r0, =0x03007FF8
<br/>
   ldrh    r2, [r0]
<br/>
   orr     r2, r2, r1
<br/>
   strh    r2, [r0]
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
The second problem I found is in the copy-code for multiboot games in the boot code of devkitARM (gba_crt0.s, around line 80), and probably devkit advance and HAM too. The problem here is that it copies the full 256kB into EWRAM, even when the binary itself is much smaller. Guess no$gba doesn't like that. 
<br/>
My current solution is to get the actual size via __ewram_end, though I'm not entirely certain this is the right linkscript variable to use here. There seem to be a lot of them that give the right size in my test cases so it's hard to be sure.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">@---------------------------------------------------------------------------------
<br/>
@ We were started in ROM, silly emulators. :P
<br/>
@ So we need to copy to ExWRAM.
<br/>
@---------------------------------------------------------------------------------
<br/>
<br/>
@ --- current ---
<br/>
   mov   r3, #0x40
<br/>
   lsl   r3, #12            @ r3 = 0x40000
<br/>
   lsl   r2, r3, #7         @ r2 = 0x2000000
<br/>
   mov   r6, r2            @ r6 = 0x2000000
<br/>
   lsl   r1, r2, #2         @ r1 = 0x8000000
<br/>
<br/>
@ --- suggested replacement ---
<br/>
   mov     r2, #2
<br/>
   lsl     r2, r2, #24         @ r2= 0x02000000
<br/>
   ldr     r3, =__ewram_end      @ PONDER: is this right?
<br/>
   sub     r3, r2            @ r3= actual binary size
<br/>
   mov     r6, r2            @ r6= 0x02000000
<br/>
   lsl     r1, r2, #2         @ r1= 0x08000000
<br/>
</td> </tr></table><span class="postbody">
<br/>
There may be a need for an extra EWRAM clear as well. A word-alignment check might be useful too.
<br/>
<br/>
This removed nearly all of my problems with no$. The remaining errors I get have something to do with VBlankIntrWait, but I can't really see what. All I know is that if I remove it I get no errors, and putting it back gives 180/s (just with VBlank irq), or even 14k/s (HBlank irq).
<br/>
<br/>
Note that none of these things seem fatal, but I guess there will be prefectly logical explanations for flagging them. Regardless of that, they do tend to hide any real errors so fixing them might be a good idea.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#79886 - wintermute - Sun Apr 16, 2006 8:19 pm</h4>
    <div class="postbody"><span class="postbody">I mailed Martin about the problems recently and it seems he accidentally made the error reporting stricter than it should have been in the freeware version. 
<br/>
<br/>
I've updated the gba crt0 copy to reflect the size of the binary. Next update of no$gba should fix the rest.
<br/>
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Martin Korth wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
Whoops, I somehow got the freeware version to act "strict". If you select "strict" memory-range-checks in the debug version, then you should get the warnings about bios-bugs there, too. Anyways, you are right, of course the freeware version shouldn't count bios-bugs as game-bugs.
<br/>
<br/>
Many thanks for pointing me on it! Next version should be working again.
<br/>
</td> </tr></table><span class="postbody"><br/>_________________<br/><a class="postlink" href="http://www.devkitpro.org/" target="_blank">devkitPro - professional toolchains at amateur prices</a>
<br/>
<a class="postlink" href="http://wiki.devkitpro.org/index.php/IRC" target="_blank">devkitPro IRC support</a>
<br/>
<a class="postlink" href="http://davejmurphy.com/" target="_blank">Personal Blog</a></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
