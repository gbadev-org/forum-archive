<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Input Problem: Event triggered on KeyUp - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>Beginners > Input Problem: Event triggered on KeyUp</h2>
<div id="posts">
<div class="post">
    <h4>#33437 - simc - Mon Jan 03, 2005 10:52 am</h4>
    <div class="postbody"><span class="postbody">My GBA app has some code that polls buttons looking for a Keydown, on which it returns the buttons pressed.  When the button is held for too long, it also returns when you release the button, but this only occurs on the GBA but doesn't seem to occur in VBA. I'm not sure if it is a problem with my code (most likely) or my GBA.
<br/>
<br/>
Here is the function that should return keys pressed since the last poll.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
// in auxfunctions.c
<br/>
u16 getinput()
<br/>
{
<br/>
    OldInputFromKeyInterrupt = InputFromKeyInterrupt;
<br/>
    InputFromKeyInterrupt = ~KEYS;
<br/>
<br/>
    // we only want keydowns
<br/>
    OldInputFromKeyInterrupt = OldInputFromKeyInterrupt &amp; InputFromKeyInterrupt;
<br/>
        
<br/>
    return (InputFromKeyInterrupt &amp; ~OldInputFromKeyInterrupt);
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
This is for a flashcard app for learning chinese using Practical Chinese Reader. Its should be ready for release after this is fixed. Tell me if it interests you at all :-)
<br/>
<br/>
The binary is available at <a class="postlink" href="http://www.baud-bandit.com/simon/pcr_flash_vol1.zip" target="_blank">http://www.baud-bandit.com/simon/pcr_flash_vol1.zip</a>. I'm going to post the source to this page shortly <a class="postlink" href="http://www.baud-bandit.com/simon/stuff.html" target="_blank">http://www.baud-bandit.com/simon/stuff.html</a>.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#33444 - identitycrisisuk - Mon Jan 03, 2005 2:25 pm</h4>
    <div class="postbody"><span class="postbody">You don't really describe what this function is used for so I can't test holding down a key on this ROM you've put up.
<br/>
<br/>
Generally speaking there's nothing that could go wrong with your GBA, that's the format you want to make sure it works on. No emulation can be 100% perfect all the time I don't think, when I last upgraded VBA it removed some strange bugs that happened with the emulator so try that.<br/>_________________<br/></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">CanIKickIt(YES_YOU_CAN);</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#33561 - simc - Wed Jan 05, 2005 2:14 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
You don't really describe what this function is used for so I can't test holding down a key on this ROM you've put up. 
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
The function reads the state of the keys and compares it to the last time the input was polled by the function using the set difference operator, as shown in the FAQ. Bellow is a slight revision of the code with a redundant line removed which was that when the key is first pressed (but with InputFromKey &amp; ~OldInputFromKey it should only return a 1 for that key in the bit field if the button was pressed since the last time it was polled)
<br/>
<br/>
The problem is that if the button is held for, say, a second,  when it  is released then the program acts as though the button has been pressed once more. 
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
// these are globals
<br/>
u16 InputFromKey=0;
<br/>
u16 OldInputFromKey=~0;
<br/>
<br/>
// ...
<br/>
u16 getinput()
<br/>
{
<br/>
    OldInputFromKey = InputFromKey;
<br/>
    InputFromKey = ~KEYS;
<br/>
<br/>
    return (InputFromKey &amp; ~OldInputFromKey);
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
This is the code that uses the function to poll the buttons:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
 while (1)
<br/>
    {
<br/>
<br/>
        answer(nextcard);
<br/>
        while (!(getinput() &amp; KEY_B))
<br/>
        {
<br/>
        }
<br/>
        flipBuffersOnVblank();
<br/>
<br/>
        nextcard = findNextCard();
<br/>
        question(nextcard);
<br/>
        while (!(getinput() &amp; KEY_B))
<br/>
        {
<br/>
        }
<br/>
        flipBuffersOnVblank();
<br/>
    }
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
Generally speaking there's nothing that could go wrong with your GBA, that's the format you want to make sure it works on. No emulation can be 100% perfect all the time I don't think, when I last upgraded VBA it removed some strange bugs that happened with the emulator so try that.
<br/>
</td> </tr></table><span class="postbody">
<br/>
Well, perhaps i've put too much faith in VBA since I did most of my development on it before my flashcard arrived :-). I have tried the latest VBA beta as well as BA, neither can recreate the problem.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#33568 - tepples - Wed Jan 05, 2005 4:33 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>simc wrote:</b></span></td> </tr> <tr> <td class="quote">My GBA app has some code that polls buttons looking for a Keydown, on which it returns the buttons pressed.  When the button is held for too long, it also returns when you release the button, but this only occurs on the GBA but doesn't seem to occur in VBA.
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">InputFromKeyInterrupt</td> </tr></table><span class="postbody"></span></td> </tr></table><span class="postbody">
<br/>
If you're using the key interrupt, you may be falling victim to different implementations of the key interrupt on the GBA vs. VBA. When you press a button, the GBA generates anywhere from one to ten interrupts based on contact bounce and then stops generating interrupts until you release and press the button again (or unless the contact bounces), but VBA generates one interrupt per vblank. Does the problem go away on hardware if you hold the button down harder?<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#33582 - sajiimori - Wed Jan 05, 2005 8:17 pm</h4>
    <div class="postbody"><span class="postbody">If you don't have a specific need for the interrupt, just read the key register.  There are fewer ways things can go wrong.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#33586 - tepples - Wed Jan 05, 2005 8:30 pm</h4>
    <div class="postbody"><span class="postbody">Right. I see the key interrupt as useful for only four main things: <ol type="1"><li>to wake the system from sleep mode, </li><li>to wake the CPU from low-power mode in simple applications such as PogoShell or a book reader, </li><li>to obtain a more precise key-down time in a fighting game or a music game, or </li><li>to obtain a random seed from vcount (which may not work on the Game Boy Player). </li></ol> In a drill and practice app, the closest reason I can see is reason 2.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#33594 - poslundc - Wed Jan 05, 2005 10:20 pm</h4>
    <div class="postbody"><span class="postbody">I'd also consider using it to provide a soft-reset for the game (usually A+B+Start+Select).
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
