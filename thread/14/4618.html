<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Loading 512x256 Text BG Problem - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>Beginners > Loading 512x256 Text BG Problem</h2>
<div id="posts">
<div class="post">
    <h4>#31617 - Celeryface - Mon Dec 13, 2004 2:54 am</h4>
    <div class="postbody"><span class="postbody">Hey there,
<br/>
<br/>
I'm loading in a text bg of <b style="color:#FFA34F">512x256</b> in Mode 0 in CharBlockBase 0 and ScreenBlockBase 28. I use the following code to load in the map data, tiles and palette.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
DMAFastCopy( (void*)menubg_pal_Palette, (void*)BGPaletteMem, 256, DMA_16NOW );
<br/>
<br/>
// Copy the tile images into the tile memory.
<br/>
DMAFastCopy( (void*)menubg_Tiles, (void*)CharBaseBlock(0), 13248/4, DMA_32NOW );
<br/>
<br/>
<br/>
for( loopY = 0; loopY &lt; 32; loopY++ )
<br/>
{
<br/>
<br/>
        for( loopX = 0; loopX &lt; 64; loopX++ )
<br/>
        {
<br/>
<br/>
            bg0map[n16++] = menubg_Map[(loopY * 32) + (loopX - 32) + 32*32];
<br/>
<br/>
        } // end for loopX
<br/>
<br/>
} // end for loopY
<br/>
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
The map shows up in the map viewer with all the tiles filled in (64x32), but the map data doesn't look how it's suppose to. Can anyone spot where I'm going wrong in my code?
<br/>
<br/>
Thanks in advance. :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#31620 - DekuTree64 - Mon Dec 13, 2004 3:54 am</h4>
    <div class="postbody"><span class="postbody">I don't quite understand why you're adding (xLoop-32) + 32*32 to the source map, instead of just xLoop, but I think your problem is that xLoop goes from 0 to 64. The larger screens are layed out kind of funny, split into 256x256 blocks, so they're always 32 tiles wide, even for the larger screens. 
<br/>
For a <b style="color:#FFA34F">512x256</b>, you have basically 2 regular 256x256 screens side by side. Instead of copying 64 tiles across, you copy the left 32 tiles of your source map into one block, and the right 32 into the next block. 
<br/>
In code, something like this:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">   // Left 32 tiles to screen block 28
<br/>
for(y = 0; y &lt; 32; y++)
<br/>
{
<br/>
   for(x = 0; x &lt; 32; x++)
<br/>
   {
<br/>
      bg0map[y*32 + x] = menubg_Map[y*64 + x];
<br/>
   }
<br/>
}
<br/>
<br/>
   // Right 32 tiles to screen block 29 (+32*32 tiles)
<br/>
for(y = 0; y &lt; 32; y++)
<br/>
{
<br/>
   for(x = 0; x &lt; 32; x++)
<br/>
   {
<br/>
      bg0map[y*32 + x + 32*32] = menubg_Map[y*64 + (x+32)];
<br/>
   }
<br/>
}</td> </tr></table><span class="postbody"><br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#31643 - Celeryface - Mon Dec 13, 2004 12:35 pm</h4>
    <div class="postbody"><span class="postbody">Thanks a lot, that worked! :)
<br/>
<br/>
I referred to the CowBite formula for <b style="color:#FFA34F">512x256</b> background loading but wasn't too sure how to implement it. Now I see how it's done. Thanks again :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#31645 - Celeryface - Mon Dec 13, 2004 2:04 pm</h4>
    <div class="postbody"><span class="postbody">Now that I have that background loaded, I want to load another background into BG1 -- a 256x256 background.
<br/>
<br/>
So far I can't get both backgrounds loaded in at the same time, as I think I'm  putting in too much tile data. Can you guys spot or suggest what I can do to fix this problem?
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
DMAFastCopy( (void*)bgs_pal_Palette, (void*)BGPaletteMem, 256, DMA_16NOW );
<br/>
<br/>
// Copy the tile data into the tile memory.
<br/>
DMAFastCopy( (void*)menubg_Tiles, (void*)CharBaseBlock(0), 13248/4, DMA_32NOW );
<br/>
<br/>
// Copy the map data into background 0.
<br/>
Load512x256_TextBG(menubg_Map, bg0map);
<br/>
    
<br/>
// Load the game background into background 1.
<br/>
    
<br/>
// Copy the tile data into the tile memory.
<br/>
DMAFastCopy( (void*)gamebg_Tiles, (void*)CharBaseBlock(1), 44096/4, DMA_32NOW );
<br/>
    
<br/>
    // Copy the map data into background 1.
<br/>
    Load256x256_TextBG( gamebg_Map, bg1map );
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
So far only 1 background will display properly. Am I loading the tiles to the wrong CharBaseBlocks, or am I loading too many tiles?
<br/>
<br/>
Thanks in advance</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#31649 - identitycrisisuk - Mon Dec 13, 2004 2:40 pm</h4>
    <div class="postbody"><span class="postbody">What Screen Base Blocks are you using to store map data? Really need to know that to see what could be overlapping. I don't know off the top of my head how many tiles fit into a Char base block.<br/>_________________<br/></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">CanIKickIt(YES_YOU_CAN);</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#31650 - Celeryface - Mon Dec 13, 2004 2:46 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>identitycrisisuk wrote:</b></span></td> </tr> <tr> <td class="quote">What Screen Base Blocks are you using to store map data? Really need to know that to see what could be overlapping. I don't know off the top of my head how many tiles fit into a Char base block.</td> </tr></table><span class="postbody">
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
unsigned short* bg0map = (unsigned short*)ScreenBaseBlock(28);
<br/>
unsigned short* bg1map = (unsigned short*)ScreenBaseBlock(31);
<br/>
<br/>
REG_BG0CNT = BG_COLOR256 | TEXTBG_SIZE_512x256 | ( 28 &lt;&lt; SCREEN_SHIFT ) | WRAPAROUND | ( 0 &lt;&lt; CHAR_SHIFT );
<br/>
<br/>
// Setup background 1
<br/>
REG_BG1CNT = BG_COLOR256 | TEXTBG_SIZE_256x256 | ( 31 &lt;&lt; SCREEN_SHIFT ) | WRAPAROUND | ( 1 &lt;&lt; CHAR_SHIFT );
<br/>
<br/>
SetMode( 0 | OBJ_ENABLE | OBJ_MAP_1D | BG0_ENABLE  );
<br/>
    
<br/>
// Load the menu background into background 0.
<br/>
<br/>
// Copy the palette into the background palette memory.
<br/>
DMAFastCopy( (void*)bgs_pal_Palette, (void*)BGPaletteMem, 256, DMA_16NOW );
<br/>
<br/>
// Copy the tile data into the tile memory.
<br/>
DMAFastCopy( (void*)menubg_Tiles, (void*)CharBaseBlock(0), 13248/4, DMA_32NOW );
<br/>
<br/>
// Copy the map data into background 0.
<br/>
Load512x256_TextBG(menubg_Map, bg0map);
<br/>
    
<br/>
// Load the game background into background 1.
<br/>
    
<br/>
// Copy the tile data into the tile memory.
<br/>
DMAFastCopy( (void*)gamebg_Tiles, (void*)CharBaseBlock(1), 44096/4, DMA_32NOW );
<br/>
    
<br/>
// Copy the map data into background 1.
<br/>
Load256x256_TextBG( gamebg_Map, bg1map );
<br/>
<br/>
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#31652 - identitycrisisuk - Mon Dec 13, 2004 2:53 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Celeryface wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">SetMode( 0 | OBJ_ENABLE | OBJ_MAP_1D | BG0_ENABLE  );</td> </tr></table><span class="postbody"></span></td> </tr></table><span class="postbody">
<br/>
<br/>
I believe this line is your problem. The simple ones are always the best :)<br/>_________________<br/></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">CanIKickIt(YES_YOU_CAN);</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#31654 - Celeryface - Mon Dec 13, 2004 3:04 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>identitycrisisuk wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Celeryface wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">SetMode( 0 | OBJ_ENABLE | OBJ_MAP_1D | BG0_ENABLE  );</td> </tr></table><span class="postbody"></span></td> </tr></table><span class="postbody">
<br/>
<br/>
I believe this line is your problem. The simple ones are always the best :)</span></td> </tr></table><span class="postbody">
<br/>
<br/>
You mean I'm only enabling background 0? If so, yeah I'm doing that on purpose :) Is that a problem?
<br/>
<br/>
I load both backgrounds in but I only want to show the first one until I enter another "area" of program. I would then turn off BG0 and enable BG1. To see if BG1 loaded properly, I just view it in the Map Viewer and view its tiles in Tile Viewer in VBA.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#31657 - identitycrisisuk - Mon Dec 13, 2004 3:12 pm</h4>
    <div class="postbody"><span class="postbody">Ah right, well in VBA the tiles should be there no matter what if they are loaded correctly but I don't know if a map will be shown if it is disabled.<br/>_________________<br/></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">CanIKickIt(YES_YOU_CAN);</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#31660 - Celeryface - Mon Dec 13, 2004 3:54 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>identitycrisisuk wrote:</b></span></td> </tr> <tr> <td class="quote">Ah right, well in VBA the tiles should be there no matter what if they are loaded correctly but I don't know if a map will be shown if it is disabled.</td> </tr></table><span class="postbody">
<br/>
<br/>
Hmm. When I enabled BG1 and BG0, I get the same result. It seems that BG0 is referencing some of BG1 and as well as its own tiles.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#31664 - identitycrisisuk - Mon Dec 13, 2004 4:13 pm</h4>
    <div class="postbody"><span class="postbody">It could possibly be something to do with whatever you have used to create your maps, maybe it has tried to get rid of some tile redundancy or something and combines tiles shared by two maps. I think I'm pretty much at the end of my knowledge on the subject though, mods - help!<br/>_________________<br/></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">CanIKickIt(YES_YOU_CAN);</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#31666 - Celeryface - Mon Dec 13, 2004 4:26 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>identitycrisisuk wrote:</b></span></td> </tr> <tr> <td class="quote">It could possibly be something to do with whatever you have used to create your maps, maybe it has tried to get rid of some tile redundancy or something and combines tiles shared by two maps. I think I'm pretty much at the end of my knowledge on the subject though, mods - help!</td> </tr></table><span class="postbody">
<br/>
<br/>
I used GIMP to convert the graphics over. They were originally bitmaps, so they probably are using way too many tiles. Any recommendations for creating backgrounds/maps from bitmaps?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#31671 - Cearn - Mon Dec 13, 2004 5:36 pm</h4>
    <div class="postbody"><span class="postbody">1 screenblock is 0x0800 = 2048 bytes
<br/>
1 charblock is 0x4000 = 16384 bytes
<br/>
<br/>
memory use (add 0x06000000 for VRAM)
<br/>
screenblock 28: 0xe000 - 0xe7ff
<br/>
screenblock  31: 0xf800 - 0xffff
<br/>
<br/>
menu tiles: 13248= 0x33c0 bytes
<br/>
copy menu tiles to charblock 0 fills: 0x0000 - 0x33c0
<br/>
<br/>
game tiles: 44096= 0xac40 bytes
<br/>
copy game tiles to charblock 1 fills: 0x4000-0xec40
<br/>
<br/>
That should blast screenblock 28 and a good deal of 29 out of the water. Also, 0xac40 bytes is 1378 4bit tiles, when you can only access 1024. 8bit tiles would be ok, though. 
<br/>
<br/>
So yeah, you probably have way too many tiles. If the bitmaps aren't too complex, you could try to weed out the duplicates (I think gfx2gba or MapEd could help you there, but I may be wrong); did this just yesterday and saw my tileset shrink from 1044 to 644. If the bitmap is too complex to be reduced, you might have to start thinking about dynamic loading.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#31675 - Celeryface - Mon Dec 13, 2004 6:40 pm</h4>
    <div class="postbody"><span class="postbody">Thanks for the info :)
<br/>
<br/>
I'll see if MapED can reduced the amount of tiles. I used gfx2gba to convert it over, and it did reduce some of the tiles. If MapED doesn't work, then I'll just make another background.
<br/>
<br/>
Thanks! :)
<br/>
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Cearn wrote:</b></span></td> </tr> <tr> <td class="quote">1 screenblock is 0x0800 = 2048 bytes
<br/>
1 charblock is 0x4000 = 16384 bytes
<br/>
<br/>
memory use (add 0x06000000 for VRAM)
<br/>
screenblock 28: 0xe000 - 0xe7ff
<br/>
screenblock  31: 0xf800 - 0xffff
<br/>
<br/>
menu tiles: 13248= 0x33c0 bytes
<br/>
copy menu tiles to charblock 0 fills: 0x0000 - 0x33c0
<br/>
<br/>
game tiles: 44096= 0xac40 bytes
<br/>
copy game tiles to charblock 1 fills: 0x4000-0xec40
<br/>
<br/>
That should blast screenblock 28 and a good deal of 29 out of the water. Also, 0xac40 bytes is 1378 4bit tiles, when you can only access 1024. 8bit tiles would be ok, though. 
<br/>
<br/>
So yeah, you probably have way too many tiles. If the bitmaps aren't too complex, you could try to weed out the duplicates (I think gfx2gba or MapEd could help you there, but I may be wrong); did this just yesterday and saw my tileset shrink from 1044 to 644. If the bitmap is too complex to be reduced, you might have to start thinking about dynamic loading.</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
