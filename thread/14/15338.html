<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Really Basic BG Question - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>Beginners > Really Basic BG Question</h2>
<div id="posts">
<div class="post">
    <h4>#153906 - Jinroh - Tue Apr 08, 2008 2:36 am</h4>
    <div class="postbody"><span class="postbody">I have a BG that I'm displaying and I'm trying to scroll it, however when I change my camX and camY and put them in the BG_HOFS and BG_VOFS registers my map scrolls like an Insane Man.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">typedef struct
<br/>
{
<br/>
   u16 *tileData; //Pointer To the Tile Data In VRAM
<br/>
   u16 *mapData; //Pointer To the Map Data In VRAM
<br/>
   u8 mosaic; //Enable Mosaic Effect
<br/>
   u8 colourMode; //16 or 256
<br/>
   u8 number; //The Background Number 0-3
<br/>
   u16 size; //The Size of the Background 128x128 256x256 or 512x512
<br/>
   u8 charBaseBlock; //Tell Which Character Base Block To Use
<br/>
   u8 screenBaseBlock; //Tell Which Screen Base Block To Use
<br/>
   u8 wrapAround; //Does The Map Wrap At Edges?
<br/>
   s16 camX; //Map Camera X
<br/>
   s16 camY; //Map Camera Y
<br/>
   s32 rotX; //Rotation Cam X
<br/>
   s32   rotY; //Rotation Cam Y
<br/>
   s16 PA, PB, PC, PD; //Rotation Attributes
<br/>
}Background;
<br/>
<br/>
Background BG;
<br/>
<br/>
void enableBG(Background *bg)
<br/>
{
<br/>
   u16 temp;
<br/>
<br/>
   bg-&gt;tileData = (u16*)CharBaseBlock(bg-&gt;charBaseBlock);
<br/>
   bg-&gt;mapData = (u16*)ScreenBaseBlock(bg-&gt;screenBaseBlock);
<br/>
   temp = bg-&gt;size | (bg-&gt;charBaseBlock &lt;&lt; CHAR_SHIFT) | 
<br/>
      (bg-&gt;screenBaseBlock &lt;&lt; SCREEN_SHIFT) | bg-&gt;colourMode |
<br/>
         bg-&gt;mosaic;
<br/>
<br/>
   switch(bg-&gt;number)
<br/>
   {
<br/>
      case 0:
<br/>
         REG_BG0CNT = temp;
<br/>
         REG_DISPCNT |= BG0ENABLE;
<br/>
         break;
<br/>
<br/>
      case 1:
<br/>
         REG_BG1CNT = temp;
<br/>
         REG_DISPCNT |= BG1ENABLE;
<br/>
         break;
<br/>
<br/>
      case 2:
<br/>
         REG_BG2CNT = temp;
<br/>
         REG_DISPCNT |= BG2ENABLE;
<br/>
         break;
<br/>
<br/>
      case 3:
<br/>
         REG_BG3CNT = temp;
<br/>
         REG_DISPCNT |= BG3ENABLE;
<br/>
         break;
<br/>
   }
<br/>
}
<br/>
<br/>
void updateBG(Background *bg)
<br/>
{
<br/>
                //Just Assume It's not Rotational for now
<br/>
   switch(bg-&gt;number)
<br/>
   {
<br/>
      case 0:
<br/>
         REG_BG0HOFS = bg-&gt;camX;
<br/>
         REG_BG0VOFS = bg-&gt;camY;
<br/>
         break;
<br/>
<br/>
      case 1:
<br/>
         REG_BG1HOFS = bg-&gt;camX;
<br/>
         REG_BG1VOFS = bg-&gt;camY;
<br/>
         break;
<br/>
<br/>
      case 2:
<br/>
         REG_BG2HOFS = bg-&gt;camX;
<br/>
         REG_BG2VOFS = bg-&gt;camY;
<br/>
         break;
<br/>
<br/>
      case 3:
<br/>
         REG_BG3HOFS = bg-&gt;camX;
<br/>
         REG_BG3VOFS = bg-&gt;camY;
<br/>
         break;
<br/>
   }
<br/>
}
<br/>
<br/>
....
<br/>
<br/>
BG.number = 2;
<br/>
   BG.charBaseBlock = 0;
<br/>
   BG.screenBaseBlock = 28;
<br/>
   BG.colourMode = BG_COLOR256;
<br/>
   BG.size = ROTBG_SIZE_256x256;
<br/>
   BG.mosaic = BG_MOSAIC_ENABLE;
<br/>
   BG.camX = 120;
<br/>
   BG.camY = 80;
<br/>
<br/>
   int i = 0;
<br/>
   
<br/>
   enableBG(&amp;BG);
<br/>
<br/>
   for(i = 0; i &lt; 256; i++)
<br/>
      BGPaletteMem[i] = CoolMap_cmap[i];
<br/>
<br/>
   u16 *tilePtr = (u16*)CoolMap_blockgfx;
<br/>
   for(i = 0; i &lt; (sizeof(CoolMap_blockgfx)/2); i++)
<br/>
      BG.tileData[i] = tilePtr[i];
<br/>
<br/>
   for(int y = 0; y &lt; 32; y++)
<br/>
      for(int x = 0; x &lt; 32; x++)
<br/>
         BG.mapData[(y * 32) + x] = (u16)CoolMap_map[y][x];
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I mean it looks like it's scrolling, but it is just waaaay too fast.
<br/>
<br/>
THANKS!<br/>_________________<br/><span style="font-style: italic"><span style="font-weight: bold"><span style="color: gray">The lone Wolf howls, driven by pride he presses on. Knowing not where he goes, but only where he wants to be.
<br/>
~Me~</span></span></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#153909 - Dwedit - Tue Apr 08, 2008 5:29 am</h4>
    <div class="postbody"><span class="postbody">You didn't post any of the code that moves the camera.  You are waiting for vblank...right?<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#153930 - silent_code - Tue Apr 08, 2008 3:18 pm</h4>
    <div class="postbody"><span class="postbody">hope you're using fixed point maths. ;^)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#153950 - Jinroh - Tue Apr 08, 2008 5:42 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">while(1)
<br/>
   {
<br/>
      WaitForVBlank();
<br/>
     
<br/>
      //Wait Until The Screen Is Finished Drawing;
<br/>
     if(KEY_DOWN(KEYDOWN))
<br/>
        BG.camY++;
<br/>
<br/>
     if(KEY_DOWN(KEYUP))
<br/>
        BG.camY--;
<br/>
<br/>
     if(KEY_DOWN(KEYLEFT))
<br/>
        BG.camX--;
<br/>
<br/>
     if(KEY_DOWN(KEYRIGHT))
<br/>
        BG.camX++;
<br/>
<br/>
     updateBG(&amp;BG);
<br/>
   }</td> </tr></table><span class="postbody">
<br/>
<br/>
Camera Movement Code.<br/>_________________<br/><span style="font-style: italic"><span style="font-weight: bold"><span style="color: gray">The lone Wolf howls, driven by pride he presses on. Knowing not where he goes, but only where he wants to be.
<br/>
~Me~</span></span></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#153951 - eKid - Tue Apr 08, 2008 5:47 pm</h4>
    <div class="postbody"><span class="postbody">What does your WaitForVBlank() look like? :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#153954 - Jinroh - Tue Apr 08, 2008 5:54 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void WaitForVBlank()
<br/>
{
<br/>
   #define ScanlineCounter *(volatile u16*)0x4000006 //Counts through the vertical scanlines until we get a blank
<br/>
   while(ScanlineCounter &lt; 160){}
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
Here it is, thanks.<br/>_________________<br/><span style="font-style: italic"><span style="font-weight: bold"><span style="color: gray">The lone Wolf howls, driven by pride he presses on. Knowing not where he goes, but only where he wants to be.
<br/>
~Me~</span></span></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#153956 - silent_code - Tue Apr 08, 2008 5:57 pm</h4>
    <div class="postbody"><span class="postbody">and again... you're scrolling 60 pixel per second - that's fast!
<br/>
use fixed point math instead!
<br/>
<br/>
that means you do an additional shift when assigning the new scroll values to the hw bg. no other changes needed. e.g. "&gt;&gt; 1" will half your scroll rate:</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">    REG_BG0HOFS = (bg-&gt;camX &gt;&gt; 1);
<br/>
    REG_BG0VOFS = (bg-&gt;camY &gt;&gt; 1);</td> </tr></table><span class="postbody">
<br/>
try that!
<br/>
<br/>
EDIT: fixed a dumb typo (per second instead of frame) ;^)</span><span class="gensmall"><br/><br/>Last edited by silent_code on Tue Apr 08, 2008 7:19 pm; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#153957 - eKid - Tue Apr 08, 2008 5:59 pm</h4>
    <div class="postbody"><span class="postbody">Theres your problem. That function will only wait until the vblank period, without checking if it was already in the vblank period. Add
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">while(ScanlineCounter &gt;= 160){} </td> </tr></table><span class="postbody">
<br/>
to the beginning of that function. (You're probably firing hundreds of times during the vblank period).
<br/>
<br/>
Also, polling the VCOUNT register like that really isn't recommended (it uses 100% cpu and eats up the battery). You should be using the SWI that waits for the VBlank interrupt. I'm not sure what setup you have so I can't explain more about that.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#153958 - Jinroh - Tue Apr 08, 2008 6:00 pm</h4>
    <div class="postbody"><span class="postbody">Thanks a plenty for the advice. Will do the changes right quick.<br/>_________________<br/><span style="font-style: italic"><span style="font-weight: bold"><span style="color: gray">The lone Wolf howls, driven by pride he presses on. Knowing not where he goes, but only where he wants to be.
<br/>
~Me~</span></span></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#153960 - Jinroh - Tue Apr 08, 2008 6:25 pm</h4>
    <div class="postbody"><span class="postbody">VBLANK Fix Did the Trick Thanks Guys.<br/>_________________<br/><span style="font-style: italic"><span style="font-weight: bold"><span style="color: gray">The lone Wolf howls, driven by pride he presses on. Knowing not where he goes, but only where he wants to be.
<br/>
~Me~</span></span></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#153974 - Dwedit - Tue Apr 08, 2008 8:57 pm</h4>
    <div class="postbody"><span class="postbody">Don't poll the scanline counter.  Use Libgba/Libnds's code to install an interrupt handler, then use the code from the library to wait for vblank.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
irqInit();
<br/>
irqEnable(IRQ_VBLANK);
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
then to wait for vblank:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
VBlankIntrWait();  //on GBA
<br/>
swiWaitForVBlank(); //on NDS
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Why do it this way?  These use the BIOS functions which switch the GBA into low power mode while it's waiting.  The Scanline polling loop keeps using full power.<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#154081 - Jinroh - Thu Apr 10, 2008 6:38 pm</h4>
    <div class="postbody"><span class="postbody">Thanks Dwedit I figured I'd need an interrupt handler sooner or later for things like Sound, but VBLANKing is another good thing. Thanks.<br/>_________________<br/><span style="font-style: italic"><span style="font-weight: bold"><span style="color: gray">The lone Wolf howls, driven by pride he presses on. Knowing not where he goes, but only where he wants to be.
<br/>
~Me~</span></span></span></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
