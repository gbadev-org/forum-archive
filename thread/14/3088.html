<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>while (REG_VCOUNT < 160); - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>Beginners > while (REG_VCOUNT < 160);</h2>
<div id="posts">
<div class="post">
    <h4>#18100 - ProblemBaby - Sat Mar 20, 2004 1:44 pm</h4>
    <div class="postbody"><span class="postbody">is: while (REG_VCOUNT &lt; 160); 
<br/>
important to do every loop?
<br/>
<br/>
it slows down my program by many 100%
<br/>
<br/>
I dont understand really what it do!
<br/>
cuz the frame is drawn exact the same without it!
<br/>
<br/>
plz tell me what it do, and how I can make it faster or if I can skip it!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#18102 - yaustar - Sat Mar 20, 2004 2:34 pm</h4>
    <div class="postbody"><span class="postbody">It is very important. It basically says "Wait until the frame has stopped being drawn". If you start moving stuff such as sprites in mid frame, you are going to end with misaligned graphics.<br/>_________________<br/>[<a class="postlink" href="http://parabellumgames.no-ip.org" target="_blank">Blog</a>] [<a class="postlink" href="http://yaustar.no-ip.org" target="_blank">Portfolio</a>]</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#18104 - Paul Shirley - Sat Mar 20, 2004 3:23 pm</h4>
    <div class="postbody"><span class="postbody">removed</span><span class="gensmall"><br/><br/>Last edited by Paul Shirley on Sun Mar 28, 2004 8:55 pm; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#18111 - sajiimori - Sat Mar 20, 2004 6:16 pm</h4>
    <div class="postbody"><span class="postbody">If you are not ready to use interrupts just yet, at least change it to REG_VCOUNT != 160.  It will still eat up battery life, but it solves the other problem Paul mentioned.
<br/>
<br/>
Feel free to leave vsync out of your program for a while.  You'll eventually find that you need it, and maybe it'll be informative to come to that conclusion on your own.  ^_^</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#18113 - abilyk - Sat Mar 20, 2004 7:11 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>sajiimori wrote:</b></span></td> </tr> <tr> <td class="quote">If you are not ready to use interrupts just yet, at least change it to REG_VCOUNT != 160.  It will still eat up battery life, but it solves the other problem Paul mentioned.</td> </tr></table><span class="postbody">
<br/>
<br/>
Even this method could allow the loop to run more than once per frame.  If your main loop finishes in less than one scanline (not likely, but possible), REG_VCOUNT will still == 160 and the loop will run again.  I've seen this used:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">while(REG_VCOUNT != 160);
<br/>
while(REG_VCOUNT != 161);</td> </tr></table><span class="postbody">
<br/>
<br/>
VCOUNT values must be 160, then 161, in sequence, to get through both these loops.  You lose a scanline's worth of Vblank, but it guarantees that the loop will only run once per frame.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#18124 - Paul Shirley - Sun Mar 21, 2004 2:59 am</h4>
    <div class="postbody"><span class="postbody">removed</span><span class="gensmall"><br/><br/>Last edited by Paul Shirley on Sun Mar 28, 2004 8:55 pm; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#18126 - abilyk - Sun Mar 21, 2004 3:56 am</h4>
    <div class="postbody"><span class="postbody">Good points, I hadn't thought about those cases.  I agree, using interrupts is a much more efficient and dependable way to do it.  However, some newbies may want to hold off on using interrupts til more comfortable with the system.  That was the case with me.  If so, I'd suggest they do some simple <a class="postlink" href="http://forum.gbadev.org/viewtopic.php?t=2431" target="_blank">profiling</a>, and use what they learn about the behavior of their code (does your non-drawing code eat into vblank?  does your vblank code run short?) to work out a polling check that works for their specific needs.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#18128 - poslundc - Sun Mar 21, 2004 4:40 am</h4>
    <div class="postbody"><span class="postbody">I don't see what's so hard about this.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">while (1)
<br/>
{
<br/>
   // VDraw code
<br/>
   while ((volatile u16)REG_VCOUNT &lt; 160);
<br/>
   // VBlank code
<br/>
   while ((volatile u16)REG_VCOUNT &gt;= 160);
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
Break that.
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#18133 - tepples - Sun Mar 21, 2004 5:20 am</h4>
    <div class="postbody"><span class="postbody">If a GBA game is programmed anything like Super Mario Bros. for NES was, that'll break it. SMB1 (and many other games by the same Nintendo programmers) set the CPU into the 6502's equivalent of a Halt state and just had the NES's vblank interrupt call the game's main loop. The main loop spun until draw time and then set a scroll value after scanline 31.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#18137 - poslundc - Sun Mar 21, 2004 2:40 pm</h4>
    <div class="postbody"><span class="postbody">Tepples, my point was that if you don't want to use the halt/interrupt method it's very easy to set up a loop/hang-based system. Earlier on in the thread people were having trouble doing that.
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#18189 - delbogun - Mon Mar 22, 2004 3:01 pm</h4>
    <div class="postbody"><span class="postbody">How do I do it with interrupts?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#18241 - johnny_north - Tue Mar 23, 2004 12:31 am</h4>
    <div class="postbody"><span class="postbody">I'll give you the basics of how I do it, and then I'll fill you in on the details if you need.
<br/>
<br/>
Download Jeff Frohwein's crt0 and lnkscript <a class="postlink" href="http://www.devrs.com/gba/files/crtls.zip" target="_blank">http://www.devrs.com/gba/files/crtls.zip</a>
<br/>
<br/>
Browse the crt0.s file and uncomment
<br/>
.equ __InterruptSupport, 1
<br/>
.equ __MultipleInterrupts, 1
<br/>
<br/>
When you build your project, assemble the crt0.s to crt0.o and link uning the included lnkscript. Here's what my linker flags look like:
<br/>
<br/>
LDFLAGS = -L $(LIBDIR) -L $(LIBDIR2) -L $(PRJDIR) <span style="font-weight: bold">-T lnkscript</span> -lswi -lAAS -lm -lg -lstdc++ -lgcc <span style="font-weight: bold">-nostartfiles</span> -Wl,-Map,bin.map
<br/>
<br/>
I think the -nosartfiles option forces (devkitadv anyway) to exclude the default crt0.o and lnkscript
<br/>
<br/>
Define the intrupt table as a global in your code:
<br/>
<br/>
void (*IntrTable[])() = {
<br/>
	vbl, // v-blank
<br/>
	0, // h-blank
<br/>
	0, // vcount
<br/>
	0, // timer0
<br/>
	0, // timer1
<br/>
	0, // timer2
<br/>
	0, // timer3
<br/>
	0, // serial
<br/>
	0, // dma0
<br/>
	0,// dma1
<br/>
                0, // dma2
<br/>
	0, // dma3
<br/>
	0, // key
<br/>
	0  // cart
<br/>
};
<br/>
<br/>
Define the vbl function
<br/>
<br/>
void vbl(){
<br/>
//do whatever
<br/>
}
<br/>
<br/>
start the interupt for the vbl in you code somewhere (using defines from gba.h + some bit defines):
<br/>
<br/>
	REG_IME = 0x00;// Disable interrupts 
<br/>
	REG_IE |= BIT0;// Enable V-Blank IRQ. 
<br/>
	REG_DISPSTAT |= BIT3;// Enable Display V-Blank IRQ also.
<br/>
	REG_IME = BIT0;// Enable interrupts 
<br/>
<br/>
Let me know if you have troubles.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#18394 - Cearn - Thu Mar 25, 2004 2:34 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>johnny_north wrote:</b></span></td> </tr> <tr> <td class="quote">I think the -nostartfiles option forces (devkitadv anyway) to exclude the default crt0.o and lnkscript</td> </tr></table><span class="postbody">
<br/>
I think -nostartfiles excludes the default crt0.o (and crtbegin.o and crtend.o for C++), but not the linkscript. That's what -Tlnkscript is for.
<br/>
<br/>
Also, it was my understanding that you should set the proper bit in REG_IF to indicate the interrupt was handled.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
void vbl()
<br/>
{
<br/>
    // blah
<br/>
    REG_IF |= BIT0;
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
And if you want to use the BIOS call for this (VBlankIntrWait (swi 0x05)) you also need to set that bit in the bios check flag at 0x03007ff8 (I think it's called REG_IFCHECKBUFF or something)
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
void vbl()
<br/>
{
<br/>
    // blah
<br/>
    REG_IFCHECKBUFF |= BIT0;
<br/>
    REG_IF |= BIT0;
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
that last one had me going for a while when I tried to get VBlankIntrWait to work.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#18397 - Lupin - Thu Mar 25, 2004 3:08 pm</h4>
    <div class="postbody"><span class="postbody">What is the actual difference between the bios call and normal vblank?
<br/>
<br/>
I once saw an example code that used this way of clearing the IF register:
<br/>
REG_IF |= ~INT_KEYBOARD;
<br/>
<br/>
i think i will take a look at jeffs interrupt handler and try to implement it myself in iwram...<br/>_________________<br/><a class="postlink" href="http://pokeme.shizzle.it/" target="_blank">Team Pokeme</a>
<br/>
<a class="postlink" href="http://lupin.shizzle.it/" target="_blank">My blog and PM ASM tutorials</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#18402 - Cearn - Thu Mar 25, 2004 3:35 pm</h4>
    <div class="postbody"><span class="postbody">Using a normal VBlank you still need to check whether you're already in a VBlank or not (unless you want to put all your code in the VBlank handler of course). Something like
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
// global
<br/>
int in_vblank=0;
<br/>
<br/>
void vbl()
<br/>
{
<br/>
    in_vblank=1;
<br/>
    REG_IF |= BIT0;
<br/>
}
<br/>
<br/>
int main()
<br/>
{
<br/>
    // setup VBlank interrupt
<br/>
<br/>
    while(1)
<br/>
    {
<br/>
        while(in_vblank == 0)  ; // do nothing
<br/>
<br/>
        // do stuff        
<br/>
        in_vblank=0;
<br/>
    }
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
With a the VBlankIntrWait BIOS call the CPU is actually switched off until the interrupt occurs (saving battery power), and you don't have to check for the interrupt yourself. To do it like this it's 
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
void vbl() 
<br/>
{ 
<br/>
    // other vbl stuff
<br/>
<br/>
    // set bit in 0x03007ff8, like GbaTek told us to.
<br/>
    REG_IFCHECKBUFF |= BIT0; 
<br/>
    REG_IF |= BIT0; 
<br/>
} 
<br/>
<br/>
int main()
<br/>
{
<br/>
     // set up VBlank interrupt
<br/>
    while(1)
<br/>
    {
<br/>
        // put CPU on hold until a VBlank occurs
<br/>
        // the part after the three colons is the "clobber list"; 
<br/>
        // swi 5 uses r0 and r1, so you don't want that used in 
<br/>
        // other places. See GCC docs, point 6.34
<br/>
        // Also, if you're in ARM mode, use 0x050000, not 0x05.
<br/>
        asm volatile("swi 0x05" ::: "r0", "r1");
<br/>
        
<br/>
        // do stuff
<br/>
<br/>
    }
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
At least, that's what I <span style="font-style: italic">think</span> people use the VBlank interrupt 
<br/>
and swi 5 for. Plz correct me if I'm wrong.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Lupin wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
I once saw an example code that used this way of clearing the IF register: 
<br/>
REG_IF |= ~INT_KEYBOARD; 
<br/>
</td> </tr></table><span class="postbody">
<br/>
Hmmm, maybe INT_KEYBOARD was already inverted? (i.e., the one bit 0 and the rest 1), otherwise using |= would make little sense.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#18470 - LOst? - Fri Mar 26, 2004 9:28 pm</h4>
    <div class="postbody"><span class="postbody">If I hadn't so hard probelms whith the speed of the GBA, I would do any drawing/scrolling/sprite copying/palette copying during the VBlank interrupt, and then force the main loop to only show a frame when I want, by turning on and off the VBlank.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
