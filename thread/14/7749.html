<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>bit shifting - division - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>Beginners > bit shifting - division</h2>
<div id="posts">
<div class="post">
    <h4>#63323 - ghost Leinad - Mon Dec 12, 2005 12:18 am</h4>
    <div class="postbody"><span class="postbody">I was trying to make a routine for dividing with values other than powers of 2...I couldn't
<br/>
then I found this:
<br/>
<br/>
"Dividing with values other than powers of 2 is trickier and is often not possible"
<br/>
<br/>
then how can I divide if I can't use other than powers of 2??? :S:S:S:S
<br/>
<br/>
I was thinking in using multiplications, but I can't use floating point either :S
<br/>
<br/>
ah, and the "module"??? (I don't know if this is the name, I'm guessin' it :P. You know the number left by the division - It's symbol is %) how do I handle that??
<br/>
<br/>
Tanx in advance<br/>_________________<br/>All human wisdom is summed up in these two words, - 'Wait and hope"
<br/>
****************************************
<br/>
My site <a href="http://www.myth-world.net" target="_blank">www.myth-world.net</a> and <a href="http://www.bmrpg.com" target="_blank">www.bmrpg.com</a> :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#63326 - poslundc - Mon Dec 12, 2005 12:45 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>ghost Leinad wrote:</b></span></td> </tr> <tr> <td class="quote">I was trying to make a routine for dividing with values other than powers of 2...I couldn't
<br/>
then I found this:
<br/>
<br/>
"Dividing with values other than powers of 2 is trickier and is often not possible"
<br/>
<br/>
then how can I divide if I can't use other than powers of 2??? :S:S:S:S</td> </tr></table><span class="postbody">
<br/>
<br/>
You can divide by using C's built-in divide operator (/). Just be aware that it will be dirt, dirt slow if either:
<br/>
1. You're not dividing by a constant value (in other words, dividing by a variable), or
<br/>
2. You have optimizations turned off.
<br/>
<br/>
There are numerous ways to optimize division - most notably, that you can perform simple bitshifts for denominators that are even powers of two - but there's nothing that says you can't do division at all; you just want to avoid it wherever possible because it is so time-consuming.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">I was thinking in using multiplications, but I can't use floating point either :S</td> </tr></table><span class="postbody">
<br/>
<br/>
So use fixed-point instead. A reciprocal lookup table is one of the better optimizations for division.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">ah, and the "module"??? (I don't know if this is the name, I'm guessin' it :P. You know the number left by the division - It's symbol is %) how do I handle that??</td> </tr></table><span class="postbody">
<br/>
<br/>
The remainder of a division, or <span style="font-weight: bold">modulus</span> operator also works fine, but is much trickier to optimize. Again, even powers of two are dead simple: just take the bitwise-AND with the value in question minus one, eg. (x % 32) == (x &amp; 31) for all positive values of x (negative values behave slightly differently). Most other optimizations on modulus are concentrated on finding ways of optimizing division, and then using that to get the remainder. I'm not aware of any optimization specific to modulus without division, though.
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#63329 - ghost Leinad - Mon Dec 12, 2005 1:17 am</h4>
    <div class="postbody"><span class="postbody">oh yes, modulus :P
<br/>
<br/>
yes it is a variable...
<br/>
<br/>
well...look, what I'm trying to do is a score system with four digits, but with just one variable for the four.
<br/>
<br/>
so, I need to obtain the single value per digit. For instance to get the units I make number%10.
<br/>
<br/>
In fact the game is very simple, for now I'm using the / and % operator without problems, I just want to improve the divisions.
<br/>
<br/>
Is there another way to do this? If it is let me know :D<br/>_________________<br/>All human wisdom is summed up in these two words, - 'Wait and hope"
<br/>
****************************************
<br/>
My site <a href="http://www.myth-world.net" target="_blank">www.myth-world.net</a> and <a href="http://www.bmrpg.com" target="_blank">www.bmrpg.com</a> :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#63335 - DekuTree64 - Mon Dec 12, 2005 2:02 am</h4>
    <div class="postbody"><span class="postbody">Dividing by 10 for a score will be optimized to a reciprocal multiply by the compiler, so it will only take a few cycles. The slow thing is when you have variableOrConstant / variable.
<br/>
<br/>
And anyway, even 4 real divides per frame is nothing to worry about. The only time I've really needed a reciprocal table was for texture mapped 3D rendering, which involves several divides per triangle, times a few hundred triangles.<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#63364 - Cearn - Mon Dec 12, 2005 12:18 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>DekuTree64 wrote:</b></span></td> </tr> <tr> <td class="quote">Dividing by 10 for a score will be optimized to a reciprocal multiply by the compiler ...</td> </tr></table><span class="postbody">
<br/>
<br/>
I keep hearing this, but what is this based on? If I try "y=x/10;", where x and y are globals so they won't be optimised out as constants, I still get a call to __divsi3, even at -O3 optimisation. Furthermore, it <span style="font-style: italic">can't</span> be optimized to a reciprocal division unless you know the range of the (variable) numerator to know what the safety limits are. Constant/constant can be done at compile-time, but as soon as you get to variables things will get murky.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>ghost Leinad wrote:</b></span></td> </tr> <tr> <td class="quote">In fact the game is very simple, for now I'm using the / and % operator without problems, I just want to improve the divisions. </td> </tr></table><span class="postbody">
<br/>
If it's not causing problems, then maybe it's not really worth optimising for, see poslundc's <a class="postlink" href="http://www.danposluns.com/gbadev/posprintf/instructions.html" target="_blank">posprintf </a>page for details. Or just use that function to parse the number and be done with it.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#63391 - Miked0801 - Mon Dec 12, 2005 6:06 pm</h4>
    <div class="postbody"><span class="postbody">I don't believe that a /10 will be compiler optimized.  You'd have to do something like:
<br/>
<br/>
const s32 recip = 65536 / 10; // = 6554
<br/>
y = (x * recip) &gt;&gt; 16;
<br/>
<br/>
Which is a hell of a lot faster than divisi3.  But again, for score keeping, this is trivial overhead.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#63393 - kusma - Mon Dec 12, 2005 6:22 pm</h4>
    <div class="postbody"><span class="postbody">a division by a constant can allways be performed with a 64-bit multiply (or multiply-add if you want proper rounding). the same goes for a modulo, except there's a bit more trickery involved. gcc with a decent optimization-level produce this code for you.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#63394 - poslundc - Mon Dec 12, 2005 6:28 pm</h4>
    <div class="postbody"><span class="postbody">I wrote the following test function...
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">int fn(int x)
<br/>
{
<br/>
   return x / 10;
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
... and compiled it against GCC 2.9 (I know; I'm a dinosaur) with level 1 optimizations enabled, and it produced the following ARM code:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">@ Generated by gcc 2.9-arm-000512 for ARM/elf
<br/>
.gcc2_compiled.:
<br/>
.text
<br/>
   .align   0
<br/>
   .global   fn
<br/>
   .type    fn,function
<br/>
fn:
<br/>
   @ args = 0, pretend = 0, frame = 0
<br/>
   @ frame_needed = 1, current_function_anonymous_args = 0
<br/>
   mov   ip, sp
<br/>
   stmfd   sp!, {fp, ip, lr, pc}
<br/>
   sub   fp, ip, #4
<br/>
   ldr   r3, .L3
<br/>
   smull   r2, r3, r0, r3
<br/>
   mov   r0, r0, asr #31
<br/>
   rsb   r0, r0, r3, asr #2
<br/>
   ldmea   fp, {fp, sp, pc}
<br/>
.L4:
<br/>
   .align   0
<br/>
.L3:
<br/>
   .word   1717986919
<br/>
.Lfe1:
<br/>
   .size    fn,.Lfe1-fn</td> </tr></table><span class="postbody">
<br/>
<br/>
So it is clearly doing the peephole-optimization for constant division in this case. When compiling as Thumb code, however, it generated the following even with level 3 optimizations enabled:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">@ Generated by gcc 2.9-arm-000512 for Thumb/elf
<br/>
   .code   16
<br/>
.gcc2_compiled.:
<br/>
.text
<br/>
   .align   2
<br/>
   .globl   fn
<br/>
   .type    fn,function
<br/>
   .thumb_func
<br/>
fn:
<br/>
   push   {lr}
<br/>
   mov   r1, #10
<br/>
   bl   __divsi3
<br/>
   pop   {pc}
<br/>
.Lfe1:
<br/>
   .size    fn,.Lfe1-fn</td> </tr></table><span class="postbody">
<br/>
<br/>
So it seems clear that when compiling for Thumb - which doesn't have access to the MULL family of instructions - reciprocal division for constant values is not considered a valid optimization; only when compiling ARM-targetting code.
<br/>
<br/>
Since the vast majority of GBA code is compiled for Thumb, though, this means I was incorrect in assuming that the peephole optimization would be performed all (or even most) of the time.
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
