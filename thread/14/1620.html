<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>wait for vblank - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>Beginners > wait for vblank</h2>
<div id="posts">
<div class="post">
    <h4>#8286 - Dwedit - Mon Jul 07, 2003 3:03 am</h4>
    <div class="postbody"><span class="postbody">How do you halt the processor until a vblank?
<br/>
<br/>
I know there is a bios call to do it, how do you do bios calls?<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#8750 - Dwedit - Sat Jul 19, 2003 3:01 am</h4>
    <div class="postbody"><span class="postbody">Right now I'm trying this code to wait for a vblank, but it just fails and ends up restating the program:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void VBlankIntrWait()
<br/>
{
<br/>
  asm volatile("mov r2, #0; swi 0x05" ::: "r0", "r1", "r2", "r3");
<br/>
  return;
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
What's the proper way to wait for a vblank? (without counting scanlines in a while loop)<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#8751 - tepples - Sat Jul 19, 2003 3:27 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Dwedit wrote:</b></span></td> </tr> <tr> <td class="quote">Right now I'm trying this code to wait for a vblank, but it just fails and ends up restating the program:
<br/>
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void VBlankIntrWait()
<br/>
{
<br/>
  asm volatile("mov r2, #0; swi 0x05" ::: "r0", "r1", "r2", "r3");
<br/>
  return;
<br/>
}</td> </tr></table><span class="postbody"></span></td> </tr></table><span class="postbody">
<br/>
In order to use VBlankIntrWait(), you have to have an ISR installed.  It <span style="font-weight: bold">must</span> be compiled in ARM (not Thumb) instructions and <span style="font-weight: bold">should</span> be located in IWRAM. To learn how to write an ISR, see the "interrupts" section of your favorite GBA programming tutorial.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#8782 - yaustar - Sat Jul 19, 2003 8:18 pm</h4>
    <div class="postbody"><span class="postbody">go to the pern project by dovoto, he has a chapter on interrupts
<br/>
<br/>
<a href="http://www.thepernproject.com" target="_blank">http://www.thepernproject.com</a><br/>_________________<br/>[<a class="postlink" href="http://parabellumgames.no-ip.org" target="_blank">Blog</a>] [<a class="postlink" href="http://yaustar.no-ip.org" target="_blank">Portfolio</a>]</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#8783 - Dwedit - Sat Jul 19, 2003 8:51 pm</h4>
    <div class="postbody"><span class="postbody">I looked at the pern project's tutorial, it explains how to handle them, but not how to wait for them.  I also looked through some of the sample code on the site, all of the wait vblank functions used a while loop and counted scanlines.  I know that that can't be good for battery life, so I need a routine that halts the processor until the vblank interrupt occurrs.
<br/>
<br/>
I don't know the correct way to call bios functions, and whenever I try to call the bios functions to wait for an interrupt, the program restarts.  I am using Devkitadvance with the ISR from crt0.S, using the Interrupt Table option.<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#8787 - sgstair - Sat Jul 19, 2003 11:56 pm</h4>
    <div class="postbody"><span class="postbody">To use the bios call VblankIntrWait (5), there are 2 things you need to do...
<br/>
First, before you even THINK of calling SWI 5, you need to have a vblank interrupt handler in place, and it has to do something like:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">   mov      r0,#0x04000000
<br/>
   mov      r1,#1
<br/>
   strh   r1,[r0,#-8]      @ store 1 in 03007ff8
<br/>
</td> </tr></table><span class="postbody">
<br/>
That's just code from my handler, if you plan to use the SWI 4 (To wait for other types of interrupts) you need to OR the IF register with the halfword at 0x03007ff8.
<br/>
<br/>
After you have that taken care of, you can call the SWI 5 to wait for vblank and happily conserve your battery power.
<br/>
<br/>
Here's some code to call SWI 5 from ARM mode:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">   asm volatile (
<br/>
      "swi 0x050000 "
<br/>
      : // output
<br/>
      : // input
<br/>
      : "r0","r1","r2","r3","r12","lr"   // Destroy
<br/>
   );</td> </tr></table><span class="postbody">
<br/>
-- also from my handler :)
<br/>
<br/>
Of course you don't have to specify destroy on that many vars, really it doesnt' destroy many at all.  I'm just happier being safe than sorry ;)
<br/>
<br/>
From nocash gbatek:</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Incoming parameters are usually passed through registers R0,R1,R2,R3. Outgoing registers R0,R1,R3 are typically containing either garbage, or return value(s). All other registers (R2,R4-R14) are kept unchanged.
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Hope this helps :)
<br/>
-Stephen<br/>_________________<br/><a class="postlink" href="http://blog.akkit.org/" target="_blank">http://blog.akkit.org/</a> - <a class="postlink" href="http://www.akkit.org/dswifi/" target="_blank">http://www.akkit.org/dswifi/</a></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
