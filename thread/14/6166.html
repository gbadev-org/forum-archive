<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Sprites getting massacred :-/ - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>Beginners > Sprites getting massacred :-/</h2>
<div id="posts">
<div class="post">
    <h4>#46649 - pr0vidence - Tue Jun 28, 2005 5:03 pm</h4>
    <div class="postbody"><span class="postbody">Hey guys, me again.
<br/>
<br/>
Trying to move along in the process of learning, getting stuck again.
<br/>
<br/>
I have a program that SHOULD put a sprite on screen, very simple. again I am following, mostly, the code given on one of the various tutorials out there. As far as I can tell this should work. Somehow, my sprite, which is just an 8x8 pixel smiley face, gets mangled in the copying. I get an 8x8 pixel thing on screen, but it's a mess.
<br/>
<br/>
I am trying to get through it myself and not have you guys hold my hand every step of the way, but it doesn't appear to be going that smoothly :-/ Sorry guys.
<br/>
<br/>
here is what I have:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#include "gba.h"
<br/>
#include "sprite.h"
<br/>
<br/>
OAMEntry sprites[128];
<br/>
<br/>
void InitializeSprites()
<br/>
{
<br/>
   u16 loop;
<br/>
   for(loop=0;loop&lt;128;loop++)
<br/>
   {
<br/>
      sprites[loop].attribute[0]=160;
<br/>
      sprites[loop].attribute[1]=240;
<br/>
   }
<br/>
}
<br/>
<br/>
void WaitForVsync()
<br/>
{
<br/>
   while((volatile u16)REG_VCOUNT != 160){}
<br/>
}
<br/>
<br/>
void CopyOAM()
<br/>
{
<br/>
   u16 loop;
<br/>
   u16* temp;
<br/>
   temp = (u16*)sprites;
<br/>
   for(loop = 0; loop &lt; 128*4; loop++)
<br/>
   {
<br/>
      OAMMem[loop] = temp[loop];
<br/>
   }
<br/>
}
<br/>
<br/>
int main()
<br/>
{
<br/>
   u16 loop;
<br/>
   s16 x=100;
<br/>
   s16 y=60;
<br/>
   
<br/>
   SetMode(MODE_1|OBJ_ENABLE|OBJ_MAP_1D);
<br/>
   
<br/>
   for(loop=0;loop&lt;256;loop++)
<br/>
   {
<br/>
      OBJPaletteMem[loop] = spritePalette[loop];
<br/>
   }
<br/>
   
<br/>
   InitializeSprites();
<br/>
<br/>
   sprites[0].attribute[0]= (COLOR_16|SQUARE|y);
<br/>
   sprites[0].attribute[1]= (SIZE_8|x);
<br/>
   sprites[0].attribute[2]= (0);
<br/>
   
<br/>
   for(loop=0;loop&lt;128;loop++)
<br/>
   {
<br/>
      OBJ_GFXMem[loop] = spriteData[loop];
<br/>
   }
<br/>
   while(1)
<br/>
   {
<br/>
      WaitForVsync();
<br/>
      CopyOAM();
<br/>
   }
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Here is a compiled binary so you can see whats happening:
<br/>
<br/>
<a class="postlink" href="http://www.boomspeed.com/pr0vidence/gba/sprite.gba" target="_blank">www.boomspeed.com/pr0vidence/gba/sprite.gba</a>
<br/>
<br/>
and the sprite header file created by pcx2gba
<br/>
<br/>
<a class="postlink" href="http://www.boomspeed.com/pr0vidence/gba/sprite.h" target="_blank">www.boomspeed.com/pr0vidence/gba/sprite.h</a>
<br/>
<br/>
And finally my little PCX sprite smiley
<br/>
<br/>
<a class="postlink" href="http://www.boomspeed.com/pr0vidence/gba/sprite.pcx" target="_blank">www.boomspeed.com/pr0vidence/gba/sprite.pcx</a>
<br/>
<br/>
thanks for helping me out.
<br/>
<br/>
-pr0v</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#46651 - poslundc - Tue Jun 28, 2005 5:29 pm</h4>
    <div class="postbody"><span class="postbody">In your OAM, you are specifying your sprite as being 16 colours, but the sprite data you've generated from your tool is 256-colour.
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#46653 - pr0vidence - Tue Jun 28, 2005 5:38 pm</h4>
    <div class="postbody"><span class="postbody">Thanks for replying Dan.
<br/>
<br/>
I thought that might have been it, but when I change:
<br/>
<br/>
sprites[0].attribute[0]= (COLOR_16|SQUARE|y);
<br/>
<br/>
to
<br/>
<br/>
sprites[0].attribute[0]= (COLOR_256|SQUARE|y);
<br/>
<br/>
I get the same result, or is there something else that needs to be changed as well?
<br/>
<br/>
-pr0v</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#46660 - strager - Tue Jun 28, 2005 8:33 pm</h4>
    <div class="postbody"><span class="postbody">What is the struct OAMEntry defined as?  That may be part of the problem.
<br/>
<br/>
And it seems that the ROM takes a while to show anything.  This may be my computer, or maybe a defective copy of the ROM, but maybe you should check it out.
<br/>
<span style="font-weight: bold">Edit</span>: I found out that your program is going through a long loop.  Two of them, to be in fact.  Once appear to be in the crt0 script, and the other after your video initialization.  Try downloading the latest version of DevKitARM (r13) and see if that fixes it.
<br/>
<br/>
And your CopyOAM function is well un-optimized.  Here's a faster version:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void CopyOAM(void)
<br/>
{
<br/>
    int cur_oam;
<br/>
    OAMEntry *src = sprites;
<br/>
    OAMEntry *dst = OAMMem;
<br/>
<br/>
    for(cur_oam = 0; cur_oam &lt; 128; cur_oam++)
<br/>
    {
<br/>
        *dst = *src;
<br/>
        src++; dst++;
<br/>
    };
<br/>
};
<br/>
</td> </tr></table><span class="postbody">
<br/>
That <span style="font-style: italic">should</span> work, though I'm not entirely sure.
<br/>
<span style="font-weight: bold">Edit</span>: You could also do something similar to this for InitializeSprites to speed things up (see above edit).</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#46664 - headspin - Tue Jun 28, 2005 10:13 pm</h4>
    <div class="postbody"><span class="postbody">Try using gifs2sprites from <a href="http://www.gbadev.org/tools.php?section=gfx" target="_blank">http://www.gbadev.org/tools.php?section=gfx</a>
<br/>
<br/>
gifs2sprites 16 sprite.h sprite.gif
<br/>
<br/>
For 16 colors...<br/>_________________<br/><a class="postlink" href="http://headsoft.com.au/index.php?category=warhawk" target="_blank">Warhawk DS</a> | <a class="postlink" href="http://headsoft.com.au/index.php?category=mmll" target="_blank">Manic Miner: The Lost Levels</a> | <a class="postlink" href="http://headsoft.com.au/index.php?category=tdg" target="_blank">The Detective Game</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#46723 - pr0vidence - Wed Jun 29, 2005 4:27 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>strager wrote:</b></span></td> </tr> <tr> <td class="quote">What is the struct OAMEntry defined as?  That may be part of the problem.
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
hi strager.
<br/>
<br/>
I am using dovoto's header files, so OAMEntry looks like this:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">typedef struct tagOAMEntry
<br/>
{
<br/>
   u16 attribute[3];
<br/>
   u16 filler;
<br/>
}OAMEntry,*pOAMEntry;
<br/>
<br/>
typedef struct tagRotData
<br/>
{
<br/>
      
<br/>
   u16 filler1[3];
<br/>
   u16 pa;
<br/>
<br/>
   u16 filler2[3];
<br/>
   u16 pb;   
<br/>
      
<br/>
   u16 filler3[3];
<br/>
   u16 pc;   
<br/>
<br/>
   u16 filler4[3];
<br/>
   u16 pd;
<br/>
}RotData,*pRotData;</td> </tr></table><span class="postbody">
<br/>
<br/>
I realise that it takes a while for anything to happen when the ROM loads. I figured that was just part of it. I mean, the things I am asking the GBA to do are fairly simple, even horribly unoptimised it should be pretty quick. I believe I already do have the latest version of devkit, though I can re-download it.
<br/>
<br/>
(after swapping your CopyOAM code with what I had)
<br/>
<br/>
...whoa....it works. Why does this work and not the other? It appears to do much the same thing. though I am obviously mistaken.
<br/>
<br/>
Thanks for your help everyone. Now it's on to basic input. I'm gonna make that sprite move about.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
