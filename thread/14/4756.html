<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Problems with multiboot, interrupts - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>Beginners > Problems with multiboot, interrupts</h2>
<div id="posts">
<div class="post">
    <h4>#33439 - BlackAura - Mon Jan 03, 2005 1:22 pm</h4>
    <div class="postbody"><span class="postbody">I've been playing around with GBA development (I recently got a linker and a flash cart, and playing with real hardware is much more interesting than using an emulator), but I've been having some really weird problems.
<br/>
<br/>
First off, interrupts don't seem to work at all if I'm sending a multiboot image to a real GBA. They work fine in emulators and when burned onto a flash cart, but not when booted over the linker. I'm using Jeff Frohwein's crt0 and linkscript (v1.3), configured with interrupts enabled, using single interrupts.
<br/>
<br/>
Aside from that, I think the flash linker is screwing around with the GBA hardware. Virtually none of my code was working at all until I started calling SWI 01 (reset memory and registers) at startup, to clear everything except IWRAM and EWRAM. Even after that, the graphics don't look right. Some random colour (and not the transparent one) appears as transparent, but with a load of garbage behind it instead of the background colour. It also still does some rather insane stuff - putting in some code to wait for a vblank interrupt to occur (using the interrupt to set a flag) causes the palette to go nearly black, and the graphics to become corrupted. None of those problems show up when I'm using an emulator, or a copy burned to the flash cart.
<br/>
<br/>
Oh, if this helps... I'm using DevKitARM on Linux for the toolchain, Jeff Frohwein's crt0 and link script, a Flash2Advance linker with a Flash2Advance Ultra flash cart, if2a for multiboot loading, and ucon64 for flashing.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#33440 - MumblyJoe - Mon Jan 03, 2005 1:50 pm</h4>
    <div class="postbody"><span class="postbody">Sounds like alot of bizzarre and seperate problems, could I have some more details (what linker version and software) and maybe some of your code (cut your secrets out first!) and I'll see what I can do.<br/>_________________<br/><a class="postlink" href="http://www.hungrydeveloper.com" target="_blank">www.hungrydeveloper.com</a>
<br/>
Version 2.0 now up - guaranteed at least 100% more pleasing!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#33447 - BlackAura - Mon Jan 03, 2005 3:42 pm</h4>
    <div class="postbody"><span class="postbody">The code itself is pretty basic stuff. Or at least, I think it's pretty basic stuff. Source code, and binary (which is / should be multiboot-able):
<br/>
<br/>
<a href="http://files.frashii.com/~sp00nz/Doom/files/BlackAura/gba/code.zip" target="_blank">http://files.frashii.com/~sp00nz/Doom/files/BlackAura/gba/code.zip</a>
<br/>
<a href="http://files.frashii.com/~sp00nz/Doom/files/BlackAura/gba/test.gba" target="_blank">http://files.frashii.com/~sp00nz/Doom/files/BlackAura/gba/test.gba</a>
<br/>
<br/>
It simply sets up the graphics hardware in mode 0, enables one background layer, copies some palette and pattern data into the appropriate place, sets up a simple name table, and then uses interrupts to scroll the screen.
<br/>
<br/>
Running it in an emulator (I've tried NO$GBA and VisualBoyAdvance), it works as expected. As does running it off a flash cart. Oddly, the program I've been using to re-flash the cart has stopped working, and I'm not completely sure why...
<br/>
<br/>
At the moment, the code appears to be running from multiboot, but it's not working correctly. The pattern data is being loaded correctly, but the palette isn't, and the interrupts don't appear to be working. Previously, it was doing all that crazy stuff I mentioned before. Since then, I've yanked the linker cable out and plugged it back in, and it seems to be doing something slightly different now.
<br/>
<br/>
As for software / hardware, I'm using if2a 0.9.2 (on Linux) to load multiboot images, and ucon64 to flash the cart. I have a Flash2Advance USB linker (I don't know what version), using the firmware that comes with if2a, the GBA loader program that comes with if2a (v2.4b), and it reports the flash card as being an F2A-256M ultra-B.
<br/>
<br/>
I haven't tried the Windows software, because I haven't been able to get it to work. Last time I tried, the drivers simply refused to find the linker cable, so it kept coming up as "Unknown Device", or something like that...
<br/>
<br/>
I think there may be something wrong with the software / the hardware / my code / all three, but I have no idea how to track it down. Oh, and I tried a few other multiboot-able game images... None of them work either. Most of them either do nothing, or lock up immediately.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#33449 - dagamer34 - Mon Jan 03, 2005 4:46 pm</h4>
    <div class="postbody"><span class="postbody">As far as I know, the GBA doesn't really clear the RAM like it should when you first start a program. But there must be some garbage in there in the first place though.
<br/>
<br/>
It's probably the flasher itself it you have tried other multiboot images. I would try to find another flashing program (I think F2A cables can use more than one, PowerWriter comes to mind) and see if it works then.<br/>_________________<br/>Little kids and Playstation 2's don't mix. :(</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#33451 - ScottLininger - Mon Jan 03, 2005 5:36 pm</h4>
    <div class="postbody"><span class="postbody">The only thing I've run into that can cause really weird behavior on hardware is failing to declare your registers as volatile...
<br/>
<br/>
But you're doing that, so it must be the interrupt code. Have you tried removing that part from the code entirely, and just executing the bits that make the background appear?
<br/>
<br/>
-Scott</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#33488 - BlackAura - Tue Jan 04, 2005 11:23 am</h4>
    <div class="postbody"><span class="postbody">Just tried it using PowerWriter... Same thing happens. I think the loader program is leaving the GBA in some kind of weird state that seems to break things.
<br/>
<br/>
I tried to get if2a to load a multiboot image directly, but I've been unable to do that so far. It should be able to do it (because the loader is, after all, a multiboot program) but no matter what I do I still get (part of) the loader. It seems that the F2A linker itself is sending the first part of the loader to the GBA, so I might have to hack at the firmware...
<br/>
<br/>
I yanked the interrupt code out of there entirely. It works, but still not correctly. I still get the same palette or image corruption, there's still garbage all over the screen, certain colours still display incorrectly, and it still works perfectly if I write it to the flash cart.
<br/>
<br/>
I'll see if I can grab a digital camera, and take some pictures of it.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#33508 - ScottLininger - Tue Jan 04, 2005 6:53 pm</h4>
    <div class="postbody"><span class="postbody">So does it work correctly if you *don't* make the program a multiboot? You imply that this is the case, but I just wanted to make sure.
<br/>
<br/>
Another question: have you tried downloading somebody else's multiboot program and running that through your flash linker? There are lots of these on the main site. Or my <a class="postlink" href="http://www.thingker.com/gba/thingpong.zip" target="_blank">ThingPong</a> game is multiboot. You could test with that.
<br/>
<br/>
Photos would definitely be interesting to see. Sounds like a really weird problem. :)
<br/>
<br/>
-Scott</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#33559 - BlackAura - Wed Jan 05, 2005 12:26 pm</h4>
    <div class="postbody"><span class="postbody">Yes, it works correctly if I don't make it a multiboot program. Not if I try to boot it as a multiboot program, obviously, but from a flash cart.
<br/>
<br/>
I tried ThingPong, and it works perfectly. There's some garbage on-screen at the beginning, which is probably something left in VRAM by the loader program, but other than that...
<br/>
<br/>
I grabbed the source code and had a look at it... The only difference appears to be that ThingPong doesn't use interrupts, but my code does.
<br/>
<br/>
So, I disabled the interrupt code entirely in crt0, and it works. If I enable interrupt support again, it breaks, even if I don't actually enable interrupts.
<br/>
<br/>
I grabbed some other multiboot programs, and sure enough, programs that use interrupts just do not work (they usually lock up, display corrupted graphics, or do absolutely nothing at all), while programs that do <span style="font-style: italic">not</span> use interrupts work fine.
<br/>
<br/>
So here's the real question... What the hell is happening? It seems that the interrupt handling code in crt0 is screwing things up somewhere when using multiboot, but if that code was faulty <span style="font-style: italic">someone</span> would have noticed it by now. Maybe the loader program is screwing things up? But I really don't see how that could be, because the loader program is gone by the time that code is executed...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#33569 - tepples - Wed Jan 05, 2005 4:37 pm</h4>
    <div class="postbody"><span class="postbody">Have you tried a program such as <a class="postlink" href="http://www.pineight.com/gba/#tod" target="_blank">TOD</a>? It is a multiboot, and it uses the vblank interrupt for power-saving.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#33581 - ScottLininger - Wed Jan 05, 2005 8:11 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>BlackAura wrote:</b></span></td> </tr> <tr> <td class="quote">There's some garbage on-screen at the beginning, which is probably something left in VRAM by the loader program, but other than that...</td> </tr></table><span class="postbody">
<br/>
<br/>
Oh... what Flash Cart are you using? Maybe it's the "loader program" that's hosing up your results. Have you tried it without the loader, and just burned your ROM as the main executable?
<br/>
<br/>
There should be an option to turn off the loader program... Who knows what changes it might be making to your header or how the backswitching works? Might just be the answer.
<br/>
<br/>
-Scott</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#33590 - dagamer34 - Wed Jan 05, 2005 9:24 pm</h4>
    <div class="postbody"><span class="postbody">What KIND of interrupt setup do you have? Single, Multiple, Fast?<br/>_________________<br/>Little kids and Playstation 2's don't mix. :(</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#33629 - BlackAura - Thu Jan 06, 2005 5:13 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Have you tried a program such as TOD? It is a multiboot, and it uses the vblank interrupt for power-saving.</td> </tr></table><span class="postbody">
<br/>
<br/>
Yep. Doesn't work. It locks up on the logo screen, although the logo itself appears to display correctly.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote"> Oh... what Flash Cart are you using? Maybe it's the "loader program" that's hosing up your results. Have you tried it without the loader, and just burned your ROM as the main executable? </td> </tr></table><span class="postbody">
<br/>
<br/>
A Flash2Advance Ultra 256M. I've tried burning to the cart both with and without a loader, and it works. The loader resets the system after you choose something to run anyway, so it seems to clean up after itself pretty well.
<br/>
<br/>
However, when I'm trying to multiboot something, the software (both the official stuff and if2a) first loads the GBA-side client program that is used to flash the cart. It then uses that program to transfer the multiboot image, and starts it from there (presumably by jumping to 0x02000000 - it doesn't reset as the flash cart loader does).
<br/>
<br/>
That loader program leaves garbage in VRAM, and seems to be screwing stuff up. I haven't managed to get any of the software I have to load a multiboot image without first loading the GBA client program.
<br/>
<br/>
I also get the same results if I pull the flash cart out. So it's not a problem with the flash cart, as far as I can tell.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">What KIND of interrupt setup do you have? Single, Multiple, Fast?</td> </tr></table><span class="postbody">
<br/>
<br/>
Single.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
