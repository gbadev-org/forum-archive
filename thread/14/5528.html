<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Rotating sprites - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>Beginners > Rotating sprites</h2>
<div id="posts">
<div class="post">
    <h4>#41100 - ymalik - Mon Apr 25, 2005 3:57 am</h4>
    <div class="postbody"><span class="postbody">Hello,
<br/>
I'm having trouble with rotating a sprite.  I am dealing with one rotating sprite and one regular sprite.  Here is the code to generate the look-up tables:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#include &lt;math.h&gt;
<br/>
#define PI 3.14159265
<br/>
#define DEGREES    360      // Full circle
<br/>
#define FIX_SCALEF 256.0f
<br/>
<br/>
typedef signed long FIXED;
<br/>
FIXED SIN[DEGREES], COS[DEGREES];
<br/>
<br/>
// A really simple (and slow and wasteful) LUT builder
<br/>
// from Cearn's TONC tutorial
<br/>
<br/>
int main()
<br/>
{
<br/>
   int ii;
<br/>
   const double conv= 2*PI/DEGREES;
<br/>
<br/>
   for(ii=0; ii&lt;DEGREES; ii++)
<br/>
   {
<br/>
      SIN[ii]= (FIXED)(sin(conv*ii)*FIX_SCALEF);
<br/>
      COS[ii]= (FIXED)(cos(conv*ii)*FIX_SCALEF);
<br/>
   }
<br/>
<br/>
   printf("#include \"gba.h\"\nFIXED SIN[360] = {");
<br/>
<br/>
   for(ii = 0; ii&lt;DEGREES; ii++)
<br/>
      printf("\n%i,", SIN[ii]);
<br/>
<br/>
   printf("};\n\n");
<br/>
<br/>
   printf("FIXED COS[360] = {");
<br/>
<br/>
   for(ii = 0; ii&lt;DEGREES; ii++)
<br/>
      printf("\n%i,", COS[ii]);
<br/>
<br/>
   printf("};\n");
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
And here's the relevant code from the GBA program:
<br/>
<br/>
OAM structs
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
typedef struct tagOAMEntry
<br/>
{
<br/>
   u16 attribute[3];
<br/>
   u16 filler;
<br/>
}OAMEntry,*pOAMEntry;
<br/>
<br/>
typedef struct tagRotData
<br/>
{
<br/>
<br/>
   u16 filler1[3];
<br/>
   u16 pa;
<br/>
<br/>
   u16 filler2[3];
<br/>
   u16 pb;
<br/>
<br/>
   u16 filler3[3];
<br/>
   u16 pc;
<br/>
<br/>
   u16 filler4[3];
<br/>
   u16 pd;
<br/>
}RotData,*pRotData;
<br/>
<br/>
OAMEntry sprites[128];
<br/>
RotData *rotData = (RotData *) sprites;
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Sprite initializations.  Sprite 0 is the rotating sprite.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
   sprites[0].attribute[0] = COLOR_16 | TALL | ROTATION_FLAG | 12;
<br/>
   sprites[0].attribute[1] = SIZE_8 | ROTDATA(0) | 16;
<br/>
   sprites[0].attribute[2] = 16 | SPRITE_PRIORITY;
<br/>
<br/>
   sprites[4].attribute[0] = COLOR_16 | SQUARE | 240;
<br/>
   sprites[4].attribute[1] = SIZE_16 | 160;
<br/>
   sprites[4].attribute[2] = 0 | SPRITE_PRIORITY;
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
And the code to store the data into the affine matrix
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
      rotData-&gt;pa = COS[angle] &gt;&gt; 8;
<br/>
      rotData-&gt;pb = -SIN[angle] &gt;&gt; 8;
<br/>
      rotData-&gt;pc =  SIN[angle] &gt;&gt; 8;
<br/>
      rotData-&gt;pd =  COS[angle] &gt;&gt; 8;
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Sprite 4 is being generated fine.  Instead of seeing a rotating arrow, I am seeing a rectangle of the same dimensions for sprite 0.
<br/>
<br/>
Thank you,
<br/>
Yasir</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#41110 - Cearn - Mon Apr 25, 2005 8:51 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>ymalik wrote:</b></span></td> </tr> <tr> <td class="quote">Hello,
<br/>
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#define FIX_SCALEF 256.0f
<br/>
<br/>
typedef signed long FIXED;
<br/>
FIXED SIN[DEGREES], COS[DEGREES];
<br/>
<br/>
int main()
<br/>
{
<br/>
   const double conv= 2*PI/DEGREES;
<br/>
<br/>
   for(ii=0; ii&lt;DEGREES; ii++)
<br/>
   {
<br/>
      SIN[ii]= (FIXED)(sin(conv*ii)*FIX_SCALEF);
<br/>
      COS[ii]= (FIXED)(cos(conv*ii)*FIX_SCALEF);
<br/>
   }
<br/>
   // &lt;snip&gt;
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
&lt;snip&gt;
<br/>
<br/>
And the code to store the data into the affine matrix
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
      rotData-&gt;pa = COS[angle] &gt;&gt; 8;
<br/>
      rotData-&gt;pb = -SIN[angle] &gt;&gt; 8;
<br/>
      rotData-&gt;pc =  SIN[angle] &gt;&gt; 8;
<br/>
      rotData-&gt;pd =  COS[angle] &gt;&gt; 8;
<br/>
</td> </tr></table><span class="postbody"></span></td> </tr></table><span class="postbody">
<br/>
<br/>
The generated table is already in .8 fixed format ; when you shift down later the range you put in the affine elements are effectively normal integers in the range [0,1] (in fact, 0 everywhere except possibly at 90? intervals). The GBA still thinks they're .8 fixeds though, and therefore scales it by 256/0 or 256/1. Remove the shifts and it should work.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#41118 - ymalik - Mon Apr 25, 2005 2:35 pm</h4>
    <div class="postbody"><span class="postbody">Much thanks.
<br/>
<br/>
I decided to use a 360 degree lut, even though 512 entry lut makes sense, because I am getting the angles from a GPS satellite, which gives values in 360 degree circles.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
