<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Making my makefile better - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>Beginners > Making my makefile better</h2>
<div id="posts">
<div class="post">
    <h4>#112889 - misterDtD - Thu Dec 21, 2006 5:55 am</h4>
    <div class="postbody"><span class="postbody">I heard makefiles were supposed to make comiling do alot faster, but it doesn't seem faster than using a BATCH file.
<br/>
<br/>
So, is it my makefile, if so how could I make it better?
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">IN= infile
<br/>
OUT= outfile
<br/>
<br/>
CC= arm-eabi-gcc
<br/>
OBJCOPY= arm-eabi-objcopy
<br/>
<br/>
.PHONY : build
<br/>
build: 
<br/>
   $(CC) -mthumb-interwork -marm -c $(IN).c
<br/>
   $(CC) -specs=gba.specs -marm-interwork -marm $(IN).o -o $(IN).elf
<br/>
   $(OBJCOPY) -v -O binary $(IN).elf $(OUT).gba
<br/>
   -@gbafix $(OUT).gba
<br/>
<br/>
.PHONY : clean
<br/>
clean: 
<br/>
   @rm -fv $(IN).o
<br/>
   @rm -fv $(IN).elf
<br/>
<br/>
#EOF</td> </tr></table><span class="postbody">
<br/>
<br/>
~DtD
<br/>
BTW&gt; Can I make certain files compile in ARM code and the rest in THUMB code? because the only function in my program that needs the ARM code is my interrupt function.
<br/>
<br/>
PS&gt; I'm including all my resources (graphics, music, ect.) via "#include" directives, but I heard about linking them in the makefile, how do I do this, is it what's causing the long compile time?
<br/>
<br/>
PS2&gt; I'm new to makefiles, so please explain what you post, don't just post a bunch of make "code".
<br/>
<br/>
PS3&gt; I saw the make file tutorial in the documentation section, but it's for the old version of DevkitAdv</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#112914 - gmiller - Thu Dec 21, 2006 3:37 pm</h4>
    <div class="postbody"><span class="postbody">Your makefile the way I read it will build the code each time you use it even it you do it twice in a row.  The way a makefile "speeds" things up is NOT doing things that do not need to be done.
<br/>
<br/>
The compilation step generates object files from the source files.  The link stage combines the object files into an executable.  Now this is a simplified view but works well for makefiles.
<br/>
<br/>
You should have a compilation step that generates the object file from the source with the appropriate "dependencies" indicated.  This means that if you  use the make file twice in a row the makefile can "figure out" that the compile stage does not need to be done.  Of course the link stage is dependent on the object files.
<br/>
<br/>
The makefile tutorial you mention should apply still, just the names of the utilities to compile and link have changed.
<br/>
<br/>
As a brain dead example without regard to the tools here is a very simple makefile.  The executable will be made up of three object files each of which has a few special headers in it.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
<br/>
I = ../include
<br/>
CC = arm-eabi-gcc
<br/>
LD = arm-eabi-gcc
<br/>
CCFLAGS        = -mthumb
<br/>
<br/>
# Create general rul to convert a .c to a .o
<br/>
# $* = name of current prerequisite
<br/>
.c.o :
<br/>
   $(CC) -c  -g $(CCFLAGS) -I $(I) $*.c
<br/>
<br/>
# Create general rule to convert from .elf to .gba
<br/>
.elf.gba
<br/>
         $(OBJCOPY) -v -O binary $*.elf $*.gba
<br/>
<br/>
# First label is the default target
<br/>
all:    foo.gba
<br/>
<br/>
# since we have a general rul we can just indicate the out:  in form
<br/>
foo.gba:    foo.elf
<br/>
<br/>
# build foo.elf from the object files, $@ = target name, in this case foo.elf
<br/>
foo.elf:     foo.o junk.o special.o
<br/>
       $(CC) -specs=gba.specs -marm-interwork -marm  foo.o junk.o special.o -o $@ 
<br/>
<br/>
# define target foo.o as dependent on foo.c and general.h, use general rule
<br/>
# for .c to .o
<br/>
foo.o:  foo.c general.h
<br/>
<br/>
# junk has two dependencies and used the general rule
<br/>
junk.o: junk.c general.h junk.h
<br/>
<br/>
# special.o has dependencies by also need special steps to build it
<br/>
special.o:  special.c general.h special.h
<br/>
       $(CC) -marm -mthumb-interwork -c $*.c
<br/>
<br/>
# clean needs to remove all the object files and ELF files (maybe .gba?)
<br/>
clean:
<br/>
   rm -f *.o
<br/>
        rm -f *.elf
<br/>
<br/>
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I tried to eye ball this and make sure it was correct as I typed it so I think it is correct.  There are more compact ways of doing this but I find this kind of example easier to follow.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
