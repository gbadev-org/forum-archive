<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Setting up Time Interrupts or WAITs in HAM - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>Beginners > Setting up Time Interrupts or WAITs in HAM</h2>
<div id="posts">
<div class="post">
    <h4>#27116 - AlexL - Mon Oct 04, 2004 12:47 am</h4>
    <div class="postbody"><span class="postbody">Sorry, I know that the answer to this is probably really simple.  
<br/>
<br/>
Is there any way to, in HAM:
<br/>
<br/>
1)  Wait a number of seconds before continuing.
<br/>
2)  Set an interrupt for each x seconds or milisecond, that can be eventually turned off.
<br/>
<br/>
Thanks in advance,
<br/>
AlexL</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#27118 - tepples - Mon Oct 04, 2004 2:40 am</h4>
    <div class="postbody"><span class="postbody">Does HAM let you wait for vblank? If so, call it 60 times to wait for one second.
<br/>
<br/>
And it'd be straightforward to write your own scheduler that triggers an event on every <span style="font-style: italic">n</span>th vblank. Here's some non-HAM-specific pseudocode:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
int go_time = 1;  /* fire the first one immediately */
<br/>
<br/>
while(1)
<br/>
{
<br/>
  wait4vbl();
<br/>
<br/>
  /* and then several blocks of this form */
<br/>
  if(--go_time &lt;= 0)
<br/>
  {
<br/>
    go_time = 600;  /* schedule the next one 10 seconds ahead */
<br/>
    do_something();
<br/>
  }
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
HAMlib may require you to do some initialization, such as installing an ISR, to get wait4vbl() (or whatever HAM calls it) to start working.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#27195 - AlexL - Tue Oct 05, 2004 11:54 pm</h4>
    <div class="postbody"><span class="postbody">I never thought about that!  Yes, HAM has a function that allows you to set a VBL interrupt.  
<br/>
<br/>
<br/>
Thanks,
<br/>
AlexL</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#27196 - sajiimori - Wed Oct 06, 2004 12:02 am</h4>
    <div class="postbody"><span class="postbody">I think tepples just meant waiting for vblank itself, rather than setting up a vblank interrupt.  You can measure time by counting vblanks without using any interrupts.
<br/>
<br/>
Edit: Oh, I guess HAM might make you set one up.  I dunno.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#27281 - tepples - Fri Oct 08, 2004 2:52 am</h4>
    <div class="postbody"><span class="postbody">An implementation of wait4vbl() in terms of BIOS Halt or BIOS IntrWait will probably need an ISR set up, possibly done by the HAMlib init code, but an implementation in terms of polling VCOUNT (and eating the battery) won't.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#27335 - AlexL - Sun Oct 10, 2004 6:20 pm</h4>
    <div class="postbody"><span class="postbody">Basically, what I have done, is set up a function that my program goes to every time there is a VBL.  It adds to a counter, and goes to a different function when the counter reaches a certain point.  Thanks!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#27337 - sajiimori - Sun Oct 10, 2004 7:41 pm</h4>
    <div class="postbody"><span class="postbody">I wonder why so many new GBA programmers have such a strong urge to use a vblank interrupt function to increment a counter for timing.  Somehow this code doesn't intuitively register as a frame counter:</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">while(1)
<br/>
{
<br/>
  wait_for_vblank();
<br/>
  ++timer;
<br/>
}</td> </tr></table><span class="postbody">Oh well, whatever works.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#27398 - tepples - Tue Oct 12, 2004 6:07 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>sajiimori wrote:</b></span></td> </tr> <tr> <td class="quote">I wonder why so many new GBA programmers have such a strong urge to use a vblank interrupt function to increment a counter for timing.</td> </tr></table><span class="postbody">
<br/>
Perhaps they're coming from the NES, where spinning on DISPSTAT was unreliable but implementing wait_for_vblank() in terms of an ISR worked. Or they're trying to emulate a GetCurrentTime() from some OS that comes with a window system (either windows or mac).<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#27421 - sajiimori - Tue Oct 12, 2004 6:40 pm</h4>
    <div class="postbody"><span class="postbody">Well, you can do either of those things without doing any work in a vblank interrupt... assuming your definition of "current time" is measured in game ticks rather than vblanks (which will be the same until a tick takes longer than a vdraw).
<br/>
<br/>
For typical games, I would think you'd want to measure game ticks because they are, by definition, the fundamental unit of time in the game world.
<br/>
<br/>
Anyway, the distinction I'm making is between doing work in an interrupt handler and doing work in the main loop.  A lot of GBA initiates feel that counters have to be incremented in an interrupt handler or they somehow won't be counting correctly.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#27440 - AlexL - Wed Oct 13, 2004 1:45 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>sajiimori wrote:</b></span></td> </tr> <tr> <td class="quote">I wonder why so many new GBA programmers have such a strong urge to use a vblank interrupt function to increment a counter for timing.  Somehow this code doesn't intuitively register as a frame counter:<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">while(1)
<br/>
{
<br/>
  wait_for_vblank();
<br/>
  ++timer;
<br/>
}</td> </tr></table><span class="postbody">Oh well, whatever works.</span></td> </tr></table><span class="postbody">
<br/>
<br/>
Because I don't know how to set up a wait_for_vblank function *embarrassed...*</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#27446 - sgeos - Wed Oct 13, 2004 3:24 am</h4>
    <div class="postbody"><span class="postbody">vsync() is called at the end of every game tick when the game is in an action mode.  This seems like the simplest way of doing things to me:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">framecount_t   g_frames = 0;
<br/>
<br/>
void vsync(void)
<br/>
{
<br/>
   g_frames++;
<br/>
   /* Wait via interrupt or VCOUNT here */
<br/>
   return;
<br/>
}
<br/>
<br/>
inline framecount_t get_elapsed_frames(void)
<br/>
{
<br/>
   return g_frames;
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
As an alternative, you could do this:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">tickcount_t   g_ticks = 0;
<br/>
<br/>
void vsync(void)
<br/>
{
<br/>
   /* Wait via interrupt or VCOUNT here */
<br/>
   return;
<br/>
}
<br/>
<br/>
tickcount_t next_game_tick(void)
<br/>
{
<br/>
   g_ticks++;
<br/>
   vsync();
<br/>
}
<br/>
<br/>
inline tickcount_t get_elapsed_ticks(void)
<br/>
{
<br/>
   return g_ticks;
<br/>
}</td> </tr></table><span class="postbody">
<br/>
I will make a point of cautioning people againt tying game ticks to frames elapsed.  If you pause the game, game ticks will still elapse.  Seiken Densetsu 3 (Secret of Mana 2) for the SNES has this problem- open the ring menu your spell casting timer would keep counting down but the enemies can not do anything!
<br/>
<br/>
-Brendan</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#27449 - sajiimori - Wed Oct 13, 2004 4:02 am</h4>
    <div class="postbody"><span class="postbody">Brendan, your warning seems to amount to: "Don't run updates on components of the system that are not supposed to be updated on the current tick."  You may as well say "don't write bugs."  =)
<br/>
<br/>
In any case, it is highly unlikely that the spell counter bug in SD3 is a symptom of a fundamentally flawed timing system.  I imagine the bug might conceptually be something like this:</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void update_all_entities()
<br/>
{
<br/>
  if(!menu_is_active())
<br/>
  {
<br/>
    update_heroes();
<br/>
    update_monsters();
<br/>
    update_special_effects();
<br/>
  }
<br/>
<br/>
  update_menu_cursors();
<br/>
  update_spell_timers();  // oops!
<br/>
  update_...
<br/>
}</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#27452 - sgeos - Wed Oct 13, 2004 4:49 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>sajiimori wrote:</b></span></td> </tr> <tr> <td class="quote">Brendan, your warning seems to amount to: "Don't run updates on components of the system that are not supposed to be updated on the current tick."  You may as well say "don't write bugs."  =)</td> </tr></table><span class="postbody">
<br/>
In many cases game ticks == frames elapsed.  It therefore makes sense to update them at the same time in many cases.  This is a simple working solution for many problems that could end up causing bugs later.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>sajiimori wrote:</b></span></td> </tr> <tr> <td class="quote">I imagine the bug might conceptually be something like this:
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void update_all_entities() 
<br/>
{ 
<br/>
  if(!menu_is_active()) 
<br/>
  { 
<br/>
    update_heroes(); 
<br/>
    update_monsters(); 
<br/>
    update_special_effects(); 
<br/>
  } 
<br/>
<br/>
  update_menu_cursors(); 
<br/>
  update_spell_timers();  // oops! 
<br/>
  update_... 
<br/>
}</td> </tr></table><span class="postbody"></span></td> </tr></table><span class="postbody">
<br/>
<br/>
The bug could also have been caused by something like this:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">critter-&gt;casting_due = g_frame_count + g_casting_time[critter-&gt;spell];
<br/>
...
<br/>
for (/* All critters */)
<br/>
   if (critter-&gt;casting_due &lt; g_frame_count)
<br/>
      cast(critter-&gt;spell);</td> </tr></table><span class="postbody">
<br/>
Unlike SD2, in SD3 all other action pauses when a spell or special effect is triggered.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>sajiimori wrote:</b></span></td> </tr> <tr> <td class="quote">In any case, it is highly unlikely that the spell counter bug in SD3 is a symptom of a fundamentally flawed timing system.</td> </tr></table><span class="postbody">
<br/>
It could have actually been a symptom of something fundamentally flawed with their development/QA.  There is a spell in the game that ups critical hit ratio.  Due to another bug critical hits don't happen.  Useless spell.  (The theory is that they test the wrong byte; criticals do happen, but I have never seen them.)  I realize games need to get out the door and all, but that could have been caught with a visual check.  Perhaps I'm being overly critical... (bad pun intended)  Although the game has some horribles bugs, I didn't notice any major design flaws.  /me stops ranting.
<br/>
<br/>
-Brendan</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#27455 - sajiimori - Wed Oct 13, 2004 6:10 am</h4>
    <div class="postbody"><span class="postbody">Yeah, those pauses in SD3 really slowed the game down, especially when fighting bosses that were mostly vulnerable to magic.  Angela was my favorite character, but I couldn't stand using her because it made the pace so lethargic.  The graphics sure were great though.
<br/>
<br/>
I still think your warning carries little meaning, because there is no general solution to the problem of things happening when they shouldn't.  You have to describe somehow that certain things don't happen when the menu is up, and it is always possible to make mistakes in the process.
<br/>
<br/>
I personally always make my timers local to the object in question and count down.  It tends to keep errors localized, and it reduces dependancies.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#27497 - sgeos - Thu Oct 14, 2004 5:05 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>sajiimori wrote:</b></span></td> </tr> <tr> <td class="quote">I still think your warning carries little meaning, because there is no general solution to the problem of things happening when they shouldn't.</td> </tr></table><span class="postbody">
<br/>
No, errors will be made.  I guess I'm actually advocating using a vblank frame counter after you realize it's limitations.  It's benefit is ease of implementation and it's "happens automatically so I don't have to think about it"-ness.  It's probably the ideal timer setup for a quick throw away prototype.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>sajiimori wrote:</b></span></td> </tr> <tr> <td class="quote">You have to describe somehow that certain things don't happen when the menu is up, and it is always possible to make mistakes in the process.</td> </tr></table><span class="postbody">
<br/>
If your menu is a subroutine that doesn't call update_game_ticks(), then I think the problem has just been solved.  Nothing above the current routine (in the stack) gets updated.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>sajiimori wrote:</b></span></td> </tr> <tr> <td class="quote">Yeah, those pauses in SD3 really slowed the game down, especially when fighting bosses that were mostly vulnerable to magic.  Angela was my favorite character, but I couldn't stand using her because it made the pace so lethargic.  The graphics sure were great though.</td> </tr></table><span class="postbody">
<br/>
It seems to me that the menus and FX in SD3 were all subroutines that returned to the action rountine.
<br/>
<br/>
Angela was my favorite as well.  I usually like clerics, by Charolette (SP?!) was too silly looking for me.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>sajiimori wrote:</b></span></td> </tr> <tr> <td class="quote">I personally always make my timers local to the object in question and count down.  It tends to keep errors localized, and it reduces dependancies.</td> </tr></table><span class="postbody">
<br/>
From a design standpoint that is a better way of doing things.  The negatives are that it costs more programmer time and is conceptually more complex.  (The less complex version strikes me as an inappropriate simplification.)
<br/>
<br/>
-Brendan</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#27499 - sajiimori - Thu Oct 14, 2004 5:57 am</h4>
    <div class="postbody"><span class="postbody">These cost different amounts of programmer time?</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void set_countdown_timer()
<br/>
{
<br/>
  time_left = duration;
<br/>
}
<br/>
<br/>
void update_countdown_timer()
<br/>
{
<br/>
  if(--time_left &lt;= 0)
<br/>
    do_something_interesting();
<br/>
}
<br/>
<br/>
//-----------
<br/>
<br/>
void set_countup_timer()
<br/>
{
<br/>
  end_time = current_time() + duration;
<br/>
}
<br/>
<br/>
void update_countup_timer()
<br/>
{
<br/>
  if(current_time() &gt;= end_time)
<br/>
    do_something_interesting();
<br/>
}</td> </tr></table><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">If your menu is a subroutine that doesn't call update_game_ticks(), then I think the problem has just been solved. Nothing above the current routine (in the stack) gets updated.</td> </tr></table><span class="postbody">Yes, there are any number of ways to solve a particular problem.  Anyway, it's not always practical to be moving the main loop around like that.  At work we don't do it at all -- there is one main loop, and it is returned to every frame.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#27517 - sgeos - Thu Oct 14, 2004 5:14 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>sajiimori wrote:</b></span></td> </tr> <tr> <td class="quote">These cost different amounts of programmer time? /* SNIP */</td> </tr></table><span class="postbody">
<br/>
I thought you were talking about associating timers with individual objects.  In that case every object needs individual timer code even if it is just a extra struct member and a function call.  Now that I think about it, I don't see any reason to use a global timer.
<br/>
<br/>
Now that I've started to write example code, I realize that using count down timers eliminates the need for a global timer variable altogether.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">struct critter {
<br/>
   /* ... */
<br/>
   timer_t      timer;
<br/>
   timed_event_t   timed_event;
<br/>
   /* ... */
<br/>
};
<br/>
<br/>
<br/>
timer_t set_timer
<br/>
(
<br/>
   struct critter *   p_critter,
<br/>
   timer_t         p_duration,
<br/>
   timed_even_t      p_event
<br/>
)
<br/>
{
<br/>
   p_critter-&gt;timer =      p_duration;
<br/>
   p_critter-&gt;timed_event =   p_event;
<br/>
   return p_critter-&gt;timer;
<br/>
}
<br/>
<br/>
<br/>
timer_t update_timer
<br/>
(
<br/>
   struct critter *p_critter,
<br/>
   EVENT_PARAMS
<br/>
)
<br/>
{
<br/>
   p_critter-&gt;timer -= 1;
<br/>
   if (p_critter-&gt;timer == 0) {
<br/>
      ASSERT(p_critter-&gt;timed_event != NULL);
<br/>
      p_critter-&gt;timed_event(EVENT_PARAMS);
<br/>
   }
<br/>
   return p_critter-&gt;timer;
<br/>
}
<br/>
<br/>
void some_function(void)
<br/>
{
<br/>
   set_timer(critter, duration);
<br/>
   /* ... */
<br/>
   for ( /* All critters */ )
<br/>
      update_timer(critter, EVENT_PARAMS);
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Anyway, it's not always practical to be moving the main loop around like that.  At work we don't do it at all -- there is one main loop, and it is returned to every frame.</td> </tr></table><span class="postbody">
<br/>
In general I think hitting the main loop every frame is the way to go.
<br/>
<br/>
-Brendan</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#27524 - sajiimori - Thu Oct 14, 2004 6:58 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">I thought you were talking about associating timers with individual objects.</td> </tr></table><span class="postbody">I was.  Either the top half or the bottom half of my example would have to be duplicated for each instance of a timer.
<br/>
<br/>
In your case, you have to duplicate the set_timer call every time you want to set one.  You have to duplicate the loop every time you want another set of things that should exist a different timeline (e.g. menu-time versus game-time).  You have to duplicate the event functions, most of which (in practice) will simply set a flag somewhere which will be handled at the appropriate time so execution order can be controlled.  So lastly, you have to duplicate the code that checks the flag that the event function set.
<br/>
<br/>
The point is: you have to duplicate <span style="font-style: italic">something</span> each time you set up a timer and the associated event.  The goal is to minimize the duplication.  You can decide which method results in the least redundancy for you.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
