<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Floating-point math from within interrupt? - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>Beginners > Floating-point math from within interrupt?</h2>
<div id="posts">
<div class="post">
    <h4>#165547 - biolizard89 - Fri Dec 26, 2008 10:43 pm</h4>
    <div class="postbody"><span class="postbody">I'm working on an Xport project which needs to process some data within interrupt code (the Xport triggers a cart interrupt when new data arrives, and it needs to be processed immediately).  The data processing code has a few floating-point operations.  Unfortunately, very weird things happen when the code runs (a variable which is supposed to count up to about 100, one step per interrupt, instead immediately stays constant at a value a bit above 1000).  I found that removing the float code causes it to work again.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
// The GetAnalog function returns a short.
<br/>
<br/>
// This line causes a problem.
<br/>
ir_track_ranges[ir_track_index] = (short)(pow(GetAnalog(ir_track_ir_port)/16.0, -1.078867)*21417.2055);
<br/>
<br/>
// Replacing the above with this line fixes the problem.
<br/>
ir_track_ranges[ir_track_index] = GetAnalog(ir_track_ir_port);
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
The float code works perfectly when I call it outside of an interrupt.  I've tried using both the Xport cart interrupt as well as the VBlank interrupt, same results, both of them have the problem.
<br/>
<br/>
I'm on the Xport version of DevKitAdvance, and since I'm using the Xport, I cannot upgrade to DevKitARM.
<br/>
<br/>
Does anyone know if there are problems with doing floating-point math from within interrupt code, particularly with old versions of DevKitAdvance?  Any ideas on how I could fix this?
<br/>
<br/>
Thanks.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#165548 - Dwedit - Fri Dec 26, 2008 11:20 pm</h4>
    <div class="postbody"><span class="postbody">Lots of possible paths to take here.
<br/>
Does the interrupt use the IRQ stack, or the User stack?  Is a stack getting smashed?
<br/>
Is the floating point code slow enough that it triggers a nested interrupt?<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#165550 - Miked0801 - Sat Dec 27, 2008 7:39 am</h4>
    <div class="postbody"><span class="postbody">My initial thought is your fp code is so slow that it is nesting interrupts.  Any chance of switiching it over to fixed point code?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#165564 - biolizard89 - Sat Dec 27, 2008 8:59 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Miked0801 wrote:</b></span></td> </tr> <tr> <td class="quote">My initial thought is your fp code is so slow that it is nesting interrupts.  Any chance of switiching it over to fixed point code?</td> </tr></table><span class="postbody">
<br/>
Hmm, so I did a benchmark of the code and found that the floating-point algorithm took about 17.1ms to execute.  Since the cart interrupt gets triggered every 5ms, it looks like you are correct, this would probably be the problem.  I implemented a new version which uses a lookup table instead of the float algorithm, and it benchmarked at about 12 microseconds to execute -- I'm amazed at how much faster this is.  So I tried using the table algorithm instead of the float algorithm in the interrupt routine, and now it works!
<br/>
<br/>
Thanks for the help!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#165950 - elyk1212 - Wed Jan 14, 2009 6:45 am</h4>
    <div class="postbody"><span class="postbody">Hey, I am curious what kind of tool/method did you use to benchmark the GBA code.  This info would be very useful to  me.
<br/>
<br/>
Thanks!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#165953 - biolizard89 - Wed Jan 14, 2009 8:50 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>elyk1212 wrote:</b></span></td> </tr> <tr> <td class="quote">Hey, I am curious what kind of tool/method did you use to benchmark the GBA code.  This info would be very useful to  me.
<br/>
<br/>
Thanks!</td> </tr></table><span class="postbody">
<br/>
My Xport logic has a microsecond timer on it, so I just executed the function 10000 times in a for loop, and polled the microsecond timer before and after the loop.  The difference, divided by 10000, was the average execution time of the function.  Not exactly the most accurate benchmark imaginable, but it gave me all the information I needed.
<br/>
<br/>
If your GBA code isn't using some of your GBA hardware timers, you could probably rig up something similar using those.  The Xport worked great for me though.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#165968 - Miked0801 - Wed Jan 14, 2009 7:06 pm</h4>
    <div class="postbody"><span class="postbody">The VCount register can also be used to messure your code in lines.  I forget the translation from lines to cycles or MSeconds, but it' still a valid tool as long as no other interrupts hit you in between readings.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
