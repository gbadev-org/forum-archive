<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Sprite Displaying - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>Beginners > Sprite Displaying</h2>
<div id="posts">
<div class="post">
    <h4>#168409 - semihce - Mon Apr 27, 2009 10:02 pm</h4>
    <div class="postbody"><span class="postbody">Hi guys,
<br/>
<br/>
I am trying to display a sprite on GBA screen. I've done the things that are said in this link
<br/>
<br/>
<a class="postlink" href="http://home.no/neogeo/HOVEDSIDE_INDEX/GBA_HOVEDSIDE_INDEX_ENGELSK/GBA%20HTML%20LEKSJONER%201-5/GBA_Lek4_english.htm" target="_blank">http://home.no/neogeo/HOVEDSIDE_INDEX/GBA_HOVEDSIDE_INDEX_ENGELSK/GBA%20HTML%20LEKSJONER%201-5/GBA_Lek4_english.htm</a>
<br/>
<br/>
But I cant see the sprite on the screen. When I look at "Tools/Tile Viewer", I see my sprite stands there at the address 0x6010000. Why I see my sprite at that address but I cant see it on screen? I merely get a black screen!! Why? Please help me..</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#168413 - semihce - Tue Apr 28, 2009 2:40 pm</h4>
    <div class="postbody"><span class="postbody">I couldnt get answer to my question and I am trying to describe my problem little bit more..
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">int main()
<br/>
{
<br/>
   u16 loop;
<br/>
   s16 x = 10;
<br/>
   s16 y = 50;
<br/>
   
<br/>
   //set mode 1, switch on sprites, set storing of sprite tiles as 1D
<br/>
   SetMode(MODE_1 | OBJ_ENABLE | OBJ_MAP_1D);
<br/>
   
<br/>
   InitializeSprites();   //set all sprites outside the screen (removes unwanted sprites)
<br/>
   
<br/>
   sprites[0].attribute0 = COLOR_256 | TALL | y;  //set 256 colors, shape and y-coordinate
<br/>
   sprites[0].attribute1 = SIZE_64 | x;  //set shape and x-coordinate
<br/>
   sprites[0].attribute2 = 0;   //points to where in VRAM we get the tile data from
<br/>
<br/>
   for(loop = 0; loop &lt; 256; loop++)          //transfer palette data into memory (256 colors)
<br/>
   {
<br/>
      OBJ_PaletteMem[loop] = myPaletteData[loop];
<br/>
   }
<br/>
   
<br/>
   for(loop = 0; loop &lt; 1024; loop++)   //transfer sprite tile data into memory (32x64)
<br/>
   {
<br/>
      OAM_Data[loop] = myTileData[loop];
<br/>
   }
<br/>
   
<br/>
   while(1)  //main loop
<br/>
   {
<br/>
      vsync();  //wait for screen to finish drawing.
<br/>
      CopyOAM();  //copy sprite info (OAM) into OAM memory
<br/>
   }
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
I've written nearly the same code above. I am trying to display a sprite on GBA screen. But I cant see the sprite on the screen altough I see my sprite on "Tools/Tile Viewer" with an address of 0x6010000. I see only a black screen. What can be the reason?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#168430 - Ruben - Wed Apr 29, 2009 3:33 am</h4>
    <div class="postbody"><span class="postbody">Hm, what's vsync defined as? And also, use a #define for the sprite's displacement (negative x/y will overflow into the other bits messing everything up)
<br/>
<br/>
And make u16 loop into a u32/int!!! That's probably one of the most common-yet horrible code issues ever on the GBA.
<br/>
<br/>
EDIT: Also, can you link a binary?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#168438 - semihce - Wed Apr 29, 2009 12:05 pm</h4>
    <div class="postbody"><span class="postbody">Actually, the code I've pasted and the one I used is different. I am using a ready library to display a sprite. For example, to display a sprite I just call the "Lypson_SimpleSpriteObject" class from the library. The code I've used is completely like this:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void init()
<br/>
{
<br/>
   Lypson_VblankCopier::init();
<br/>
   Lypson_Interrupt::enableInterrupts();
<br/>
   
<br/>
   //set all sprites outside the screen (removes unwanted sprites)
<br/>
   Lypson_Sprite::initializeSprites();
<br/>
   
<br/>
   // Set graphics mode
<br/>
   #define SCREENMODE_1    0x1     ///&lt; Enable screen mode 1
<br/>
   #define OBJMAP_1D       0x40    ///&lt; 1D object(sprite) mapping
<br/>
   #define OBJ_ENABLE      0x1000   //Enables sprites
<br/>
   
<br/>
   //set mode 1, switch on sprites, set storing of sprite tiles as 1D
<br/>
   Lypson_Graphics::setMode( SCREENMODE_1 | OBJ_ENABLE | OBJMAP_1D );
<br/>
}
<br/>
<br/>
int main(void)
<br/>
{
<br/>
   init();
<br/>
   
<br/>
   Lypson_SimpleSpriteObject *simpleSprite = new Lypson_SimpleSpriteObject(character_alouette_Bitmap,
<br/>
                                                         character_alouette_Palette,
<br/>
                                                         Lypson_Sprite::Size_32x64,
<br/>
                                                         true);
<br/>
   
<br/>
   while(true)
<br/>
   {
<br/>
      Lypson_Graphics::waitForVblank();
<br/>
      Lypson_Sprite::updateOAMattributes();
<br/>
   }
<br/>
   
<br/>
   Lypson_Error::halt();
<br/>
   return(0);
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
If you look at the code carefully, you'll understand that there is no difference between this code and the code that I gave before.
<br/>
<br/>
Here is a link to the output GBA file.
<br/>
<a class="postlink" href="http://ktuce.ktu.edu.tr/~baysemi/GameRevolution.gba" target="_blank">http://ktuce.ktu.edu.tr/~baysemi/GameRevolution.gba</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#168439 - Ruben - Wed Apr 29, 2009 12:09 pm</h4>
    <div class="postbody"><span class="postbody">From what I see in the binary, your sprite ends up at (192,128), index 127, in 16 colours and every other sprite is actually not disabled nor placed outside the screen. Are you sure you've got the structures set up correctly?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#168441 - semihce - Wed Apr 29, 2009 12:23 pm</h4>
    <div class="postbody"><span class="postbody">What did you mean with "your sprite ends up at (192,128), index 127, in 16 colours". 
<br/>
<br/>
I also want to give a link to the header files:
<br/>
<br/>
<a class="postlink" href="http://ktuce.ktu.edu.tr/~baysemi/character_alouette.pal.h" target="_blank">http://ktuce.ktu.edu.tr/~baysemi/character_alouette.pal.h</a>
<br/>
<a class="postlink" href="http://ktuce.ktu.edu.tr/~baysemi/character_alouette.raw.h" target="_blank">http://ktuce.ktu.edu.tr/~baysemi/character_alouette.raw.h</a>
<br/>
<br/>
In other sprite displaying examples I see that they use 16bit in each pixel of tileData and paletteData. 
<br/>
But I used 16bit paletteData and 8bit tileData, as you can understand from here my tileDatas are indexes to the paletteData.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#168442 - Ruben - Wed Apr 29, 2009 12:29 pm</h4>
    <div class="postbody"><span class="postbody">In short, it's similar to doing this...
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">for(int i = 0 ; i &lt; 128 ; i++) {
<br/>
    OAM_Buffer[i].attr0 = 0;
<br/>
    OAM_Buffer[i].attr1 = 0;
<br/>
    OAM_Buffer[i].attr2 = 0;
<br/>
}
<br/>
<br/>
OAM_Buffer[127].attr0 = OBJ_TALL + 128;
<br/>
OAM_Buffer[127].attr1 = OBJ_SIZE_32 + 192;</td> </tr></table><span class="postbody">
<br/>
<br/>
And that wasn't the declarations I was talking about. I meant the declarations where you define the OAM object structure, the shadow buffer, etc.
<br/>
<br/>
EDIT: Fixed a typo &gt;&gt;'</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#168443 - semihce - Wed Apr 29, 2009 12:41 pm</h4>
    <div class="postbody"><span class="postbody">I am giving the function "Lypson_Sprite::initializeSprites();" which sets all sprites outside the screen..
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">for( int i = 0; i &lt; 128; i++)
<br/>
{
<br/>
   Lypson_Sprite::sprites[i].attribute0 = 160;  //y to &gt; 159 (outside screen -&gt; invisible)
<br/>
   Lypson_Sprite::sprites[i].attribute1 = 240;  //x to &gt; 239 (outside screen -&gt; invisible)
<br/>
   Lypson_Sprite::sprites[i].attribute2 = 0;
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
I hope this is what you want to see..</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#168444 - Ruben - Wed Apr 29, 2009 12:44 pm</h4>
    <div class="postbody"><span class="postbody">Not exactly &gt;&gt;'
<br/>
<br/>
I needed to see the "GBA.h" file or whatever you called it, that defines something like
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">typedef struct __OAM_t {
<br/>
    u16 attr[4];
<br/>
} OAM_t;</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#168445 - Ruben - Wed Apr 29, 2009 12:48 pm</h4>
    <div class="postbody"><span class="postbody">Actually, on further inspection...
<br/>
<br/>
The data in IWRAM is fine.. it's just that you're not copying it to OAM correctly.
<br/>
<br/>
What exactly does Lypson_Sprite::updateOAMattributes() do?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#168446 - semihce - Wed Apr 29, 2009 12:51 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">//This is the way attributes are defined
<br/>
struct Lypson_Sprite_structure {
<br/>
   u16 attribute0;
<br/>
   u16 attribute1;
<br/>
   u16 attribute2;
<br/>
   u16 filler;
<br/>
};
<br/>
<br/>
//This is a struct instance
<br/>
static Lypson_Sprite_structure sprites[128];
<br/>
<br/>
//And this is how it is used
<br/>
Lypson_Sprite::sprites[index].attribute0 = 160;  //y to &gt; 159 (outside screen -&gt; invisible)
<br/>
Lypson_Sprite::sprites[index].attribute1 = 240;  //x to &gt; 239 (outside screen -&gt; invisible)
<br/>
Lypson_Sprite::sprites[index].attribute2 = 0;</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#168447 - Ruben - Wed Apr 29, 2009 12:59 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">//This is a struct instance
<br/>
static Lypson_Sprite_structure sprites[128]; </td> </tr></table><span class="postbody">
<br/>
<br/>
I'm not sure since I don't see your full code, but I get the feeling you wouldn't want to name that static. And also, can you please tell me what Lypson_Sprite::updateOAMattributes() does? As in, the code?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#168448 - semihce - Wed Apr 29, 2009 1:02 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">bool Lypson_Sprite::updateOAMattributes()
<br/>
{
<br/>
   Lypson_Sprite_structure *OAM_memory = (Lypson_Sprite_structure *)OAMmem;
<br/>
   for(int i=0; i&lt;128; i++)
<br/>
      OAM_memory[i] = sprites[i];
<br/>
   return true; // Needed to use this method as an interrupt handler function.
<br/>
}</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#168449 - Ruben - Wed Apr 29, 2009 1:05 pm</h4>
    <div class="postbody"><span class="postbody">Hm, what's OAMmem defined as?
<br/>
<br/>
(Also, I noticed 8-bit copies to palette.. my guess is that you're using memcpy. Please don't use it when copying to the palette memory, as it can only be written to in 16-bit chunks, and memcpy tends to like using 8-bit chunks)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#168450 - semihce - Wed Apr 29, 2009 1:14 pm</h4>
    <div class="postbody"><span class="postbody">Very annoying....
<br/>
<br/>
My code works in VisualHam but it doesnt work when i compile it outside of VisualHam.</span><span class="gensmall"><br/><br/>Last edited by semihce on Wed Apr 29, 2009 3:03 pm; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#168451 - Ruben - Wed Apr 29, 2009 1:16 pm</h4>
    <div class="postbody"><span class="postbody">No, I don't think this is the reason of the problem, otherwise it'd be a colour error, not a memory error. Also, I noticed horribly un-optimized code. Are you using -O2?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#168454 - Cearn - Wed Apr 29, 2009 2:51 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>semihce wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">struct Lypson_Sprite_structure {
<br/>
   u16 attribute0;
<br/>
   u16 attribute1;
<br/>
   u16 attribute2;
<br/>
   u16 filler;
<br/>
}; 
<br/>
<br/>
bool Lypson_Sprite::updateOAMattributes()
<br/>
{
<br/>
   Lypson_Sprite_structure *OAM_memory = (Lypson_Sprite_structure *)OAMmem;
<br/>
   for(int i=0; i&lt;128; i++)
<br/>
      OAM_memory[i] = sprites[i];
<br/>
   return true; // Needed to use this method as an interrupt handler function.
<br/>
}</td> </tr></table><span class="postbody"></span></td> </tr></table><span class="postbody">This unfortunately doesn't work anymore with devkitARMs after r19 due to a change in how structs are aligned in memory and some internal details of memcpy. For details, see <a class="postlink" href="http://www.coranac.com/tonc/text/bitmaps.htm#ssec-data-align" target="_blank">tonc:data alignment</a>. Either force 32-bit alignment on the struct, or use a dedicated copier like memcpy (or DMA). Preferably both.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">struct Lypson_Sprite_structure {
<br/>
   u16 attribute0;
<br/>
   u16 attribute1;
<br/>
   u16 attribute2;
<br/>
   u16 filler;
<br/>
} __attribute__ ((aligned (4)));
<br/>
<br/>
bool Lypson_Sprite::updateOAMattributes()
<br/>
{
<br/>
   memcpy(OAMmem, sprites, 128*sizeof(Lypson_Sprite_structure));
<br/>
   return true;
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
The GBA's palette, VRAM and OAM regions only allow 16-bit or 32-bit writes to them; byte-writes corrupt data. memcpy will copy in 32-bit chunks if both the source and destination are 32-bit aligned and there's more than 16 bytes to copy. If not, it'll do byte-writes, which would be bad.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#168455 - Ruben - Wed Apr 29, 2009 3:01 pm</h4>
    <div class="postbody"><span class="postbody">Ah, Cearn, always making me look like a noobie (which I probably am). :P</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#168462 - sverx - Wed Apr 29, 2009 4:33 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Cearn wrote:</b></span></td> </tr> <tr> <td class="quote">This unfortunately doesn't work anymore with devkitARMs after r19 due to a change in how structs are aligned in memory and some internal details of memcpy.</td> </tr></table><span class="postbody">
<br/>
<br/>
Do you mean structs won't be "automatically" word aligned? :| I really didn't know that... good to know!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#168466 - semihce - Wed Apr 29, 2009 6:13 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Cearn wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>semihce wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">struct Lypson_Sprite_structure {
<br/>
   u16 attribute0;
<br/>
   u16 attribute1;
<br/>
   u16 attribute2;
<br/>
   u16 filler;
<br/>
}; 
<br/>
<br/>
bool Lypson_Sprite::updateOAMattributes()
<br/>
{
<br/>
   Lypson_Sprite_structure *OAM_memory = (Lypson_Sprite_structure *)OAMmem;
<br/>
   for(int i=0; i&lt;128; i++)
<br/>
      OAM_memory[i] = sprites[i];
<br/>
   return true; // Needed to use this method as an interrupt handler function.
<br/>
}</td> </tr></table><span class="postbody"></span></td> </tr></table><span class="postbody">This unfortunately doesn't work anymore with devkitARMs after r19 due to a change in how structs are aligned in memory and some internal details of memcpy. For details, see <a class="postlink" href="http://www.coranac.com/tonc/text/bitmaps.htm#ssec-data-align" target="_blank">tonc:data alignment</a>. Either force 32-bit alignment on the struct, or use a dedicated copier like memcpy (or DMA). Preferably both.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">struct Lypson_Sprite_structure {
<br/>
   u16 attribute0;
<br/>
   u16 attribute1;
<br/>
   u16 attribute2;
<br/>
   u16 filler;
<br/>
} __attribute__ ((aligned (4)));
<br/>
<br/>
bool Lypson_Sprite::updateOAMattributes()
<br/>
{
<br/>
   memcpy(OAMmem, sprites, 128*sizeof(Lypson_Sprite_structure));
<br/>
   return true;
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
The GBA's palette, VRAM and OAM regions only allow 16-bit or 32-bit writes to them; byte-writes corrupt data. memcpy will copy in 32-bit chunks if both the source and destination are 32-bit aligned and there's more than 16 bytes to copy. If not, it'll do byte-writes, which would be bad.</span></td> </tr></table><span class="postbody">
<br/>
<br/>
How can I use memcpy() ?.. 
<br/>
I got this error: "memcopy() is not declared in this scope?".. Should i include any header file?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#168467 - semihce - Wed Apr 29, 2009 6:18 pm</h4>
    <div class="postbody"><span class="postbody">HEYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYY..
<br/>
<br/>
ADDING THIS CODE "__attribute__ ((aligned (4)))" is enough.
<br/>
<br/>
THANK YOU VERY MUCH.. I LOVE GBA FORUM :D:D:D</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#168468 - elhobbs - Wed Apr 29, 2009 6:19 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>semihce wrote:</b></span></td> </tr> <tr> <td class="quote">How can I use memcpy() ?.. 
<br/>
I got this error: "memcopy() is not declared in this scope?".. Should i include any header file?</td> </tr></table><span class="postbody">
<br/>
memcpy != memcopy ;)</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
