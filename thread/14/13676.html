<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>What is going on? - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>Beginners > What is going on?</h2>
<div id="posts">
<div class="post">
    <h4>#134581 - biubid_boy - Sat Jul 14, 2007 9:53 am</h4>
    <div class="postbody"><span class="postbody">I'm creating a set of functions to automatically set up things like loading sprites and backgrounds. It should make programming easier in the future and it tests my knowledge in those areas. But one problem I have is in my load_background function. There seems to be something wrong. Here is my code: (note: It's not finished yet, so there isn't any support for 8bpp etc.)
<br/>
<br/>
background.c
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code"> void load_bg_4bpp(tiledbg *bg, int bg_w, int bg_h, u16 *tiles, u16 tile_size, u16* map, u16 map_size, u16 *pal)
<br/>
{
<br/>
    if(bg_w == 256 &amp;&amp; bg_h == 256) {c_sbb--;} //&lt;--PROBLEM!
<br/>
    
<br/>
    memcpy(BGPaletteMem, pal, 512);
<br/>
    memcpy(SCREEN_BASE_BLOCK(c_sbb), map, map_size);
<br/>
    memcpy(MAP_BASE_BLOCK(c_cbb), tiles, tile_size);
<br/>
<br/>
    ...
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
main.c
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code"> 
<br/>
load_bg_4bpp(&amp;grass, 256, 256, grassTiles, grassTilesLen, grassMap, grassMapLen, grassPal);
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
The problem is, the first expression never evaluates true! I've tried everything I can think of and I can't get it to work. Am I missing something obvious here?
<br/>
Please help,
<br/>
Biubid_boy.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#134582 - keldon - Sat Jul 14, 2007 9:57 am</h4>
    <div class="postbody"><span class="postbody">How can you be sure that it never evaluates to true?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#134583 - biubid_boy - Sat Jul 14, 2007 10:13 am</h4>
    <div class="postbody"><span class="postbody">Because if I take out the if (just "c_sbb--") everything works perfectly. Unfortunately I need this for the function to work correctly.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#134595 - biubid_boy - Sat Jul 14, 2007 2:46 pm</h4>
    <div class="postbody"><span class="postbody">Ok, I really don't know what is going on. Here is my entire code (rearranged in a failed at attempt at making it work).
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void load_bg_4bpp(tiledbg *bg, int bg_w, int bg_h, u16 *tiles, u16 tile_size, u16* map, u16 map_size, u16 *pal)
<br/>
{   
<br/>
    memcpy(BGPaletteMem, pal, 512);
<br/>
    memcpy((u16*)SCREEN_BASE_BLOCK(c_sbb), map, map_size);
<br/>
    memcpy((u16*)MAP_BASE_BLOCK(c_cbb), tiles, tile_size);
<br/>
    
<br/>
    bg-&gt;bpp      = bg_bpp;
<br/>
    bg-&gt;bg_num   = bg_num;
<br/>
    bg-&gt;map_size = map_sizes[bg_w&gt;&gt;8][bg_h&gt;&gt;8];
<br/>
    bg-&gt;cbb      = c_cbb;
<br/>
    bg-&gt;sbb      = c_sbb;
<br/>
    
<br/>
    get_bg_cnt(bg_num) = BG_CONTROL(bg-&gt;bg_num, bg-&gt;cbb, bg-&gt;mosaic, bg-&gt;bpp, bg-&gt;sbb, bg-&gt;wrap, bg-&gt;map_size);
<br/>
    
<br/>
    if (map_sizes[bg_w&gt;&gt;8][bg_h&gt;&gt;8] == 0) {c_sbb--;}
<br/>
    else if(map_sizes[bg_w&gt;&gt;8][bg_h&gt;&gt;8] == 3) {c_sbb -= 4;}
<br/>
    //else {c_sbb-=2;} &lt;- WTF?
<br/>
    
<br/>
    c_cbb++;
<br/>
    bg_num++;
<br/>
}</td> </tr></table><span class="postbody">
<br/>
If I uncomment the else statement, my map suddenly becomes garbage, even when the 'else' code is after 'map-making' code. As far as I can see, as long as I don't call the function twice, that shouldn't matter at all. And yet it screws my maps! :(
<br/>
What is going on?
<br/>
Biubid_boy.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#134955 - Miked0801 - Wed Jul 18, 2007 9:42 pm</h4>
    <div class="postbody"><span class="postbody">A few comments:
<br/>
<br/>
Your variable names are so sparce that I cannot interperate their meaning.  Use better names. c_cbb and s_sbb in particular are causing me problems.  sbb == screen_base_block?
<br/>
Also, you haven't included your globals anywhere.  the above vars are not declared anywhere so I am not sure of their type which may matter.
<br/>
<br/>
map_size and map_sizes are so close in name that I am having trouble telling them appart when glancing as well.
<br/>
<br/>
Asserts may also help when debugging your if statement.  Are you sure that map_sizes[][] returns a value within your expected range each time?  I'm guessing you want a value from 0-3, but again I am guessing as there are no comments the variables are poorly named.
<br/>
<br/>
Too many globals being modified in here therefore there are too many points of failure that are possible.  Are you sure that the globals being modified here aren't causing havoc elsewhere which is causing your corruption?
<br/>
<br/>
Are you reading off the end of your map_sizes[][] array?  I'd drop the &gt;&gt;8 vars into a temp to double check ranges and perhaps assert those values as well just in case. 
<br/>
<br/>
Are you sure that the initial memcpy functions are receiving the correct sizes?  If the sizes are bad (negative or too big) you will get buffer overflows which will cause random behavior - like random code changes causing stuff to work or not (like you describe.)
<br/>
<br/>
Anyways, put some asserts on you input, try to use 0 globals, rename your vars to english, and add a comment or two.  You'll get more exact advice.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#134986 - Cearn - Thu Jul 19, 2007 1:00 am</h4>
    <div class="postbody"><span class="postbody">I'm guessing:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">// --- Parameters ---
<br/>
bg_w        BG width in pixels
<br/>
bg_h        BG height in pixels
<br/>
tiles       Source tile data
<br/>
tile_size   sizeof(tiles)
<br/>
map         Source map data
<br/>
map_size    sizeof(map)
<br/>
<br/>
// ---Globals ---
<br/>
map_sizes   REG_BGxCNT size-bits, based on BG width and height.
<br/>
c_cbb       Char-Base Block reference counter
<br/>
c_sbb       Screen-Base Block reference counter.
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
c_cbb counts up, but c_sbb counts <span style="font-style: italic">down</span>. The latter should probably be updated before you copy into the screenblocks, not afterwards.
<br/>
<br/>
For example:, say c_sbb=31 and you load a 512x512 map into it. The second memcpy will copy into SBB 31 ... <span style="font-style: italic">and</span> 32,33 and 34, none of which exist. Afterwards, c_sbb will decrease by four to make 27, even though 28, 29 and 30 are still unused. 
<br/>
<br/>
Another example: start with c_sbb=31 again and a 256x256 map. This time only SBB 31 is filled, the reference counter is decremented to 30 and everything seems fine. Now add a second map, say 512x512 in size. This fills 4 screen-blocks, starting at 30. In other words, this will overwrite the previously loaded map.
<br/>
<br/>
For decreasing reference counters: Decrement Before (Full-Descending stack). Start with <span style="font-weight: bold">32</span> (not 31).
<br/>
For increasing reference counters: Increment After (Empty-Ascending stack). Start with 0.
<br/>
<br/>
There is also a possibility of overlap between char-blocks if you're not careful. Make sure your tile-size is never over 0x4000.
<br/>
<br/>
Another possibility: I take it map_sizes is intended to get the REG_BGxCNT size-bits (bits 13&amp;14) from the BG-dimensions, and looks something like this:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">const u8 mapsizes[2][2]
<br/>
{
<br/>
   { 0, 1 },    // 256x256 and 512x256
<br/>
   { 2, 3 }     // 256x512 and 512x512
<br/>
};
<br/>
</td> </tr></table><span class="postbody">
<br/>
If so, you're not grabbing the right bits. For a 256x256 map, you're retrieving element [256&gt;&gt;0][256&gt;&gt;8] = [1][1], and not [0][0]. You're off by one in both directions. Shift by 9 instead of 8. Or if you want to be really  1337, use ((bg_h&gt;&gt;8)&amp;2) | (bg_w&gt;&gt;9)&amp;1)  :P. Or forgo the whole thing and use #defines for the sizes. Whatever you choose, hide it behind a function, because it will be mystifying to anyone else.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#134992 - Miked0801 - Thu Jul 19, 2007 1:36 am</h4>
    <div class="postbody"><span class="postbody">Thanks Cearn.  At least you appear to be somewhat familiar with the base code to at least guess at its functionality.  I was shooting in the dark hoping to get something as the code in question is really sparce. :)</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
