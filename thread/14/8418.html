<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>problem with memcpy - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>Beginners > problem with memcpy</h2>
<div id="posts">
<div class="post">
    <h4>#70205 - deltree - Sun Feb 05, 2006 12:52 am</h4>
    <div class="postbody"><span class="postbody">hi
<br/>
I've got a new problem using memcpy:
<br/>
I want to fill the palette for my sprite, here's what i do:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">   
<br/>
   for (i=0;i&lt;256;i++) objpal[i]=roger_Palette[i];
<br/>
</td> </tr></table><span class="postbody">
<br/>
it display that
<br/>
<a href="http://superdeltree.free.fr/images/palette1.jpg">[Images not permitted - Click here to view it]</a>
<br/>
and now I try to do it with memcpy, doing this:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
memcpy( (u16 *)0x06014000, &amp;roger_Bitmap,4096 );
<br/>
</td> </tr></table><span class="postbody">
<br/>
it display that:
<br/>
<a href="http://superdeltree.free.fr/images/palette2.jpg">[Images not permitted - Click here to view it]</a>
<br/>
<br/>
so the problem is that the sprite as his palette messed when I use memcpy, and I don't know why.
<br/>
anyone got a solution ?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#70224 - tepples - Sun Feb 05, 2006 2:49 am</h4>
    <div class="postbody"><span class="postbody">Perhaps the memcpy implementation that you're using assumes that byte writes will always work. Which version of devkitPro are you using?<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#70308 - Cearn - Sun Feb 05, 2006 12:37 pm</h4>
    <div class="postbody"><span class="postbody">Point of interest: using lossy compression (jpeg) images to show graphical problems? Not the best way to go. 
<br/>
<br/>
As far as I know, if the size is larger than 16 and both source and destinations are word aligned, it'll copy via a 4x unrolled loop using word chunks. In all other cases, it uses byte-copies. Which as we all know is bad when it comes to VRAM. I can't be sure if the newlib I got it from is the same one as in devkitPro (because there's no links to where everything comes from), but the problems I've seen with memcpy fit the description.
<br/>
<br/>
The problem could be the alignment. You wouldn't be #including the data files, would you? Compile / link them might fix that problem.
<br/>
<br/>
Still, what you got here doesn't seem like a memcpy problem at all, actually: if it were we'd see doubled pixels, not color changes. Can we actually find the .gba's somewhere? Screenshots doesn't really help in this case.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#70333 - tepples - Sun Feb 05, 2006 6:40 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Cearn wrote:</b></span></td> </tr> <tr> <td class="quote">Still, what you got here doesn't seem like a memcpy problem at all, actually: if it were we'd see doubled pixels, not color changes.</td> </tr></table><span class="postbody">
<br/>
Unless it's the <span style="font-style: italic">palette</span> that's misaligned.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#70337 - deltree - Sun Feb 05, 2006 7:00 pm</h4>
    <div class="postbody"><span class="postbody">when I use visual boy advance, here's what I see from the palette:
<br/>
it looks like this with the good color (for loop):
<br/>
4AF2, 43ED, 5AAE,3A6A....
<br/>
and with the memcpy, it looks like this:
<br/>
4A4A, 4343, 5A5A,3A3A....</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#70341 - Dwedit - Sun Feb 05, 2006 7:47 pm</h4>
    <div class="postbody"><span class="postbody">Your memcpy is doing byte writes, which get expanded to word writes in vram.  So writing 41, 5A would first write 4141, then 5A5A to the palette.  If you use 16 bit or 32 bit writes, it won't double the bytes and overwrite adjacent bytes.
<br/>
<br/>
Your memcpy implementation is unsuitable for GBA programming, go find a better library.<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#70343 - tepples - Sun Feb 05, 2006 8:29 pm</h4>
    <div class="postbody"><span class="postbody">Do you know how to print the address of an array? What is the address of the palette data in your ROM?
<br/>
<br/>
You may have to write your own replacement for memcpy() that understands non-byte-writable memory.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#70767 - Cearn - Wed Feb 08, 2006 5:14 pm</h4>
    <div class="postbody"><span class="postbody">0x0601:4000 is the address of the sprite tiles, what we're interested in are the  addresses of the palette. The source palette, not where you put them in GBA memory, because that's likely to be 0x0500:0200 anyway. Also, what are the types of the arrays you're using?
<br/>
<br/>
We're expecting the problem to be linked to data misalignment, but to be sure we need the source addresses of the arrays -- where the linker actually places the things. The destinations are probably fine. <a class="postlink" href="http://forum.gbadev.org/viewtopic.php?p=64482" target="_blank">Here</a> is a post that might be interesting to read as well.
<br/>
<br/>
As I asked before, are you #including the data files instead of linking them? If so, stop that; compile separately and link them and see if that helps. Or use u32 arrays instead of u16.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
