<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>countdown timer - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>Beginners > countdown timer</h2>
<div id="posts">
<div class="post">
    <h4>#7922 - hnager - Sat Jun 28, 2003 6:55 pm</h4>
    <div class="postbody"><span class="postbody">I'm curious to see if anybody has a countdown timer writen...so, for example, if each level in a game lasts 30 seconds it will count down and show the remaining time (and then hit you with a 'time up' when it expires).
<br/>
<br/>
Do I need to tie in to the interrupts or can it be done other (accurate) ways?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#7931 - tepples - Sat Jun 28, 2003 9:43 pm</h4>
    <div class="postbody"><span class="postbody">It's really quite simple.  Set up variables 'minutes', 'seconds', and 'frame' to hold the time of a play period.  (For basketball, they'd be 12, 0, and 0.)  Every vblank, decrement a 'frame' counter.  When 'frame' reaches 0, decrement a 'seconds' counter and reset the 'frame' counter to 60 (the GBA runs at about 60 frames per second).  When 'seconds' reaches 0, decrement a 'minutes' counter and reset the 'seconds' counter (there are 60 seconds in a minute).  When 'minutes' reaches 0, sound the buzzer; whoever has the most points wins.
<br/>
<br/>
If you want to be cute, you can make your levels 3 seconds long instead of 30 and then make your objectives simpler to match.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#7934 - hnager - Sat Jun 28, 2003 10:29 pm</h4>
    <div class="postbody"><span class="postbody">3 second levels, eh? sounds familiar ;) For some reason I was having trouble with the timer in general - but have since resolved it and have it working on emu and hardware.
<br/>
<br/>
Im actually using a slightly modified version of what'd found int he pern project for a timer (acting more as a wait timer currently) - do most people  simplt increment on vblank/?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#7951 - tepples - Sun Jun 29, 2003 6:33 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>hnager wrote:</b></span></td> </tr> <tr> <td class="quote">do most people simplt increment on vblank/?</td> </tr></table><span class="postbody">
<br/>
Synchronizing the game to the vblank is what I've seen in pretty much every console game since the NES.
<br/>
<br/>
I've seen this question quite a bit. I just added it to the FAQ one minute ago.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#7960 - hnager - Sun Jun 29, 2003 2:37 pm</h4>
    <div class="postbody"><span class="postbody">Just read the editted answer int he FAQ - thanks.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#7961 - hnager - Sun Jun 29, 2003 2:49 pm</h4>
    <div class="postbody"><span class="postbody">I just did a hardware test and it seems as if the timer is running double speed(maybe a little more) - when the gba got to '60' my stopwatch read 25 seconds.
<br/>
<br/>
int elapsed = 0;
<br/>
while(1){
<br/>
    WaitForVsync();
<br/>
        if(!(elapsed++%60)) {
<br/>
             sprintf(tracebuffer, "elapsed= %d", elapsed/60); 
<br/>
             trace(tracebuffer);
<br/>
        }
<br/>
}
<br/>
<br/>
oh, the trace() function just displays that buffer (tracebuffer) to the gba's screen...any idea why this would be running double fast?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#7962 - hnager - Sun Jun 29, 2003 3:38 pm</h4>
    <div class="postbody"><span class="postbody">Changing the above to WaitVBlank() (defined below) it looks to work properly. I believe that I got the WaitForVsync() from the pern project, is it opening up a full horizonal draw for my timer to increment? That would explain the speedy timer.
<br/>
<br/>
void WaitForVsync(){
<br/>
	while((volatile u16)REG_VCOUNT != 160){}
<br/>
}
<br/>
<br/>
void WaitVBlank() { 
<br/>
    while(REG_VCOUNT == 160); 
<br/>
    while (REG_VCOUNT != 160); 
<br/>
}</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#7976 - Quirky - Sun Jun 29, 2003 8:15 pm</h4>
    <div class="postbody"><span class="postbody">I would recommend investigating the bios software interrupt for vblank waiting - it fixes those "is it waiting on the 160th line, or does it skip it?" worries. Plus it saves batteries :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#7977 - hnager - Sun Jun 29, 2003 8:28 pm</h4>
    <div class="postbody"><span class="postbody">saves batteries?
<br/>
<br/>
Thanks for the tip - can you think of any examples flating around?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#7983 - tepples - Sun Jun 29, 2003 9:10 pm</h4>
    <div class="postbody"><span class="postbody">Learn how to write an interrupt service routine (ISR), based on the published tutorials. Then enable the vblank interrupt and use the VblankIntrWait() function in BIOS to wait for a vblank interrupt. This function turns off the GBA CPU's ARM core until the appropriate interrupt happens. This means that during that short time, the ARM core isn't drawing power, and the memory controller isn't drawing power servicing the ARM core's requests.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#7988 - hnager - Mon Jun 30, 2003 1:13 am</h4>
    <div class="postbody"><span class="postbody">I'm not finding much which allows me to write the interrupt in C - from what I understand, inorder to do so I need to link crt0.s - this may be a bit beyond me right now - I get multiple compiler errors when trying to link that file (crt0.o that is). 
<br/>
<br/>
Maybe that's where to start - multiple pern project files include crt0.s, however I can't get them to compile with his makefile.
<br/>
<br/>
thanks.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#8522 - toporny - Sat Jul 12, 2003 11:45 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tepples wrote:</b></span></td> </tr> <tr> <td class="quote">This function turns off the GBA CPU's ARM core until the appropriate interrupt happens. This means that during that short time, the ARM core isn't drawing power, and the memory controller isn't drawing power servicing the ARM core's requests.</td> </tr></table><span class="postbody">
<br/>
<br/>
Well.. Interesing posibility, but what's happen with my modplay routine when i turn off the core of proccesor ?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#8523 - tepples - Sat Jul 12, 2003 11:56 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>toporny wrote:</b></span></td> </tr> <tr> <td class="quote">but what's happen with my modplay routine when i turn off the core of proccesor ?</td> </tr></table><span class="postbody">
<br/>
When Halt(), Stop(), or IntrWait() puts the processor in halt mode, the interrupt controller turns the ARM core back on after the next interrupt. If your music code and mixer are triggered on vblank or a timer, the interrupt will come through, turn on the ARM core, and trigger the code as you'd expect.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
