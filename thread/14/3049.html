<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>sprites and tilebackgrounds - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>Beginners > sprites and tilebackgrounds</h2>
<div id="posts">
<div class="post">
    <h4>#17772 - wox - Sun Mar 14, 2004 5:06 pm</h4>
    <div class="postbody"><span class="postbody">Hi!
<br/>
<br/>
I can get my background to show properly, but when I try to load a sprite into Oam, the tiles at the top of the map gets screwed up
<br/>
I checked tutorial4 from the pern project and it's the same problem
<br/>
both in visualboy advance and in mappy...
<br/>
<br/>
Anyone who have had the same problem?
<br/>
<br/>
thanks for any help
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
int main() 
<br/>
{
<br/>
   int index = 0;
<br/>
   u16 loop;
<br/>
   u16* temp;
<br/>
<br/>
   //compute my Look up tables
<br/>
   for(loop = 0; loop &lt; 360; loop++)
<br/>
   {
<br/>
      SIN[loop] = (FIXED)(sin(RADIAN(loop)) * 256);  //sin and cos are computed and cast to fixed                     //fixed
<br/>
      COS[loop] = (FIXED)(cos(RADIAN(loop)) * 256);
<br/>
   }
<br/>
<br/>
   SetMode(MODE_1 | OBJ_ENABLE | OBJ_MAP_1D);
<br/>
<br/>
<br/>
   bg2.number = 2;            //background number 0-3
<br/>
   bg2.charBaseBlock = 3;
<br/>
   bg2.screenBaseBlock = 23;
<br/>
   bg2.colorMode = BG_COLOR_256;
<br/>
   bg2.size = ROTBG_SIZE_128x128;
<br/>
   bg2.mosiac = 0;
<br/>
   bg2.x_scroll = 120;
<br/>
   bg2.y_scroll = 80;
<br/>
<br/>
   //This call enables the background with the suplied attributes and when it returns
<br/>
   //bg2.mapdata and tiledata will be valid pointers to the correct place
<br/>
   //for the map and tile data in VRAM
<br/>
   
<br/>
   EnableBackground(&amp;bg2);
<br/>
<br/>
   
<br/>
   //Now let us copy in the background tile palette
<br/>
   for(loop = 0; loop &lt; 256; loop++)
<br/>
      BGPaletteMem[loop] =tilesPalette[loop];
<br/>
   //now for the actual tile graphics created by pcx2sprite 
<br/>
   for(loop = 0; loop &lt; tiles_WIDTH * tiles_HEIGHT /2; loop++)
<br/>
      bg2.tileData[loop] =tilesData[loop];
<br/>
<br/>
<br/>
   //now for the map a temp variable is necessary because the map editor saves it as a
<br/>
   //u8 array.  The map data was padded to 64x64 tiles even though our map is not quite 
<br/>
   //that big.
<br/>
   temp = (u16*)test;  
<br/>
   for(loop = 0; loop &lt; 32*32/2; loop++) //64x64 tiles /2 because 16 bit copy
<br/>
      bg2.mapData[loop] = temp[loop];
<br/>
<br/>
   
<br/>
   RotateBackground(&amp;bg2,angle,119,79,zoom);
<br/>
<br/>
<br/>
<br/>
<br/>
   for(loop = 0; loop &lt; 256; loop++)          //load the palette into memory
<br/>
      OBJPaletteMem[loop] = block_redPalette[loop];
<br/>
<br/>
   InitializeSprites();                       //set all sprites off screen (stops artifact)
<br/>
<br/>
    sprites[0].attribute0 = COLOR_256 | SQUARE | 50;   //setup sprite info, 256 colour, shape and y-coord
<br/>
    sprites[0].attribute1 = SIZE_16 | 50;            //size 16x16 and x-coord
<br/>
    sprites[0].attribute2 = 0;                      //pointer to tile where sprite starts
<br/>
<br/>
    for(loop = 0; loop &lt; 128; loop++)               //load sprite image data
<br/>
    {
<br/>
         OAMData[loop] = block_redData[loop];
<br/>
    }
<br/>
<br/>
   InitializeSprites(); 
<br/>
<br/>
   while(1)
<br/>
   {
<br/>
      WaitForVsync();      
<br/>
      CopyOAM();
<br/>
      UpdateBackground(&amp;bg2); //makes any changes to the bg struct get copied inot the apropriate registers
<br/>
   }   
<br/>
<br/>
   return 0; 
<br/>
}
<br/>
<br/>
<br/>
<br/>
/// all the background functions
<br/>
<br/>
void UpdateBackground(Bg* bg)
<br/>
{
<br/>
   switch(bg-&gt;number)
<br/>
   {
<br/>
   case 0:
<br/>
      REG_BG0HOFS = bg-&gt;x_scroll;
<br/>
      REG_BG0VOFS = bg-&gt;y_scroll;
<br/>
      break;
<br/>
   case 1:
<br/>
      REG_BG1HOFS = bg-&gt;x_scroll;
<br/>
      REG_BG1VOFS = bg-&gt;y_scroll;
<br/>
      break;
<br/>
   case 2:
<br/>
      if(!(REG_DISPCNT &amp; MODE_0))//it is a rot background
<br/>
      {
<br/>
         REG_BG2X = bg-&gt;DX;
<br/>
         REG_BG2Y = bg-&gt;DY;
<br/>
         
<br/>
         REG_BG2PA = bg-&gt;PA;
<br/>
         REG_BG2PB = bg-&gt;PB;
<br/>
         REG_BG2PC = bg-&gt;PC;
<br/>
         REG_BG2PD = bg-&gt;PD;
<br/>
      }
<br/>
      else  //it is a text background
<br/>
      {
<br/>
         REG_BG2HOFS = bg-&gt;x_scroll;
<br/>
         REG_BG2VOFS = bg-&gt;y_scroll;
<br/>
      }
<br/>
      break;
<br/>
   case 3:
<br/>
      if(!(REG_DISPCNT &amp; MODE_0))//it is a rot background
<br/>
      {
<br/>
         REG_BG3X = bg-&gt;DX;
<br/>
         REG_BG3Y = bg-&gt;DY;
<br/>
         
<br/>
         REG_BG3PA = bg-&gt;PA;
<br/>
         REG_BG3PB = bg-&gt;PB;
<br/>
         REG_BG3PC = bg-&gt;PC;
<br/>
         REG_BG3PD = bg-&gt;PD;
<br/>
      }
<br/>
      else //it is a text background
<br/>
      {
<br/>
         REG_BG3HOFS = bg-&gt;x_scroll;
<br/>
         REG_BG3VOFS = bg-&gt;y_scroll;
<br/>
      }
<br/>
      break;
<br/>
   default: break;
<br/>
   }
<br/>
}
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
void EnableBackground(Bg* bg)
<br/>
{
<br/>
   u16 temp;
<br/>
<br/>
   bg-&gt;tileData = (u16*)CharBaseBlock(bg-&gt;charBaseBlock);
<br/>
   bg-&gt;mapData = (u16*)ScreenBaseBlock(bg-&gt;screenBaseBlock);
<br/>
   temp = bg-&gt;size | (bg-&gt;charBaseBlock&lt;&lt;CHAR_SHIFT) | (bg-&gt;screenBaseBlock&lt;&lt;SCREEN_SHIFT) 
<br/>
      | bg-&gt;colorMode | bg-&gt;mosiac;
<br/>
<br/>
   switch(bg-&gt;number)
<br/>
   {
<br/>
   case 0:
<br/>
      {
<br/>
         REG_BG0CNT = temp;
<br/>
         REG_DISPCNT |= BG0_ENABLE;
<br/>
      }break;
<br/>
   case 1:
<br/>
      {
<br/>
         REG_BG1CNT = temp;
<br/>
         REG_DISPCNT |= BG1_ENABLE;
<br/>
      }break;
<br/>
   case 2:
<br/>
      {
<br/>
         REG_BG2CNT = temp;
<br/>
         REG_DISPCNT |= BG2_ENABLE;
<br/>
      }break;
<br/>
   case 3:
<br/>
      {
<br/>
         REG_BG3CNT = temp;
<br/>
         REG_DISPCNT |= BG3_ENABLE;
<br/>
      }break;
<br/>
   
<br/>
   default:break;
<br/>
   
<br/>
   }
<br/>
}
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
void RotateBackground(Bg* bg, int angle,int center_x, int center_y, FIXED zoom)
<br/>
{
<br/>
   center_y = (center_y * zoom)&gt;&gt;8;
<br/>
   center_x = (center_x * zoom)&gt;&gt;8;
<br/>
   
<br/>
   bg-&gt;DX = ((bg-&gt;x_scroll&lt;&lt;8)-center_y*SIN[angle]-center_x*COS[angle]);
<br/>
   bg-&gt;DY = ((bg-&gt;y_scroll&lt;&lt;8)-center_y*COS[angle]+center_x*SIN[angle]);
<br/>
   
<br/>
   bg-&gt;PA = (COS[angle]*zoom)&gt;&gt;8;  //cos&amp;sin are LUTs that are .8 fixed numbers
<br/>
   bg-&gt;PB = (SIN[angle]*zoom)&gt;&gt;8;  //zoom is also fixed
<br/>
   bg-&gt;PC = (-SIN[angle]*zoom)&gt;&gt;8;
<br/>
   bg-&gt;PD = (COS[angle]*zoom)&gt;&gt;8;
<br/>
}
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
void InitializeSprites(void)
<br/>
{
<br/>
   int loop;
<br/>
   for(loop = 0; loop &lt; 128; loop++)
<br/>
   {
<br/>
      sprites[loop].attribute0 = 160;  //y to &gt; 159
<br/>
      sprites[loop].attribute1 = 240;  //x to &gt; 239
<br/>
   }
<br/>
}
<br/>
<br/>
///Copy our sprite array to OAM
<br/>
void CopyOAM(void)
<br/>
{
<br/>
   u16 loop;
<br/>
   u16* temp;
<br/>
   temp = (u16*)sprites;
<br/>
   for(loop = 0; loop &lt; 128*4; loop++)
<br/>
   {
<br/>
      OAM[loop] = temp[loop];
<br/>
   }
<br/>
}
<br/>
<br/>
void WaitForVsync(void)
<br/>
{
<br/>
   while(REG_VCOUNT&lt;160); 
<br/>
}
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#17814 - sajiimori - Mon Mar 15, 2004 5:26 am</h4>
    <div class="postbody"><span class="postbody">Can you pare your code down to the smallest piece that has the problem?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#17874 - wox - Tue Mar 16, 2004 12:04 pm</h4>
    <div class="postbody"><span class="postbody">ok the problem is in the rotation function
<br/>
without it everything works ok, except I can't update the map
<br/>
I don't know whats wrong with it, I reduced the code of that function to:
<br/>
<br/>
void RotateBackground(Bg* bg, int angle,int center_x, int center_y, FIXED zoom)
<br/>
{
<br/>
    center_y = 79;
<br/>
    center_x = 119;
<br/>
<br/>
    bg-&gt;DX = 0; 
<br/>
    bg-&gt;DY = 0; 
<br/>
<br/>
    bg-&gt;PA = COS[0]; 
<br/>
    bg-&gt;PB = SIN[0]; 
<br/>
    bg-&gt;PC = -SIN[0]; 
<br/>
    bg-&gt;PD = COS[0]; 
<br/>
}
<br/>
<br/>
just to try and minimize everything that could go wrong with it
<br/>
now it just rotates 0 degrees around the centre of the screen, and don't scroll at all
<br/>
still my background doesn't show properly</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#17880 - poslundc - Tue Mar 16, 2004 2:31 pm</h4>
    <div class="postbody"><span class="postbody">This is important: does the background show up properly if you don't call the RotateBackground() function?
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#17883 - wox - Tue Mar 16, 2004 3:41 pm</h4>
    <div class="postbody"><span class="postbody">then there's no background at all
<br/>
but if I also remove the UpdateBackground call in the while-loop everything works (I guess because UpdateBackground saves undefined values in the rotation registers)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#17892 - sajiimori - Tue Mar 16, 2004 6:30 pm</h4>
    <div class="postbody"><span class="postbody">So you've determined that sprites have nothing to do with it?  What does the screen actually look like?
<br/>
<br/>
I'm not sure of the intent of your new RotateBackground().  Why all the COS[0], SIN[0] and all that?  Those seem like wrong values.  Just put zeros if you want simplicity.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#17936 - wox - Wed Mar 17, 2004 6:51 pm</h4>
    <div class="postbody"><span class="postbody">here's some pictures and the source code
<br/>
<a class="postlink" href="http://medlem.spray.se/wox/" target="_blank">http://medlem.spray.se/wox/</a>
<br/>
<br/>
since I don't really need rotating backgrounds for my first gba game, I'm using plain textbackgrounds now... 
<br/>
just curious why it doesn't work
<br/>
thanks for the replies btw</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
