<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Blocky Text - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>Beginners > Blocky Text</h2>
<div id="posts">
<div class="post">
    <h4>#171570 - Azenris - Sun Nov 29, 2009 9:39 pm</h4>
    <div class="postbody"><span class="postbody">I changed my function from
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">// =================================================================================
<br/>
// SetPalette:
<br/>
void CTileManager::SetPalette(const void *pPalette)
<br/>
{
<br/>
   ASSERT(pPalette != NULL, "Palette pointer is NULL")
<br/>
<br/>
   dmaCopy(pPalette, m_pPalette, MODIFABLE_PALETTE_SIZE[BG_PAL]);
<br/>
   dmaCopy(pPalette, m_pOriginalPalette, MODIFABLE_PALETTE_SIZE[BG_PAL]);
<br/>
}</td> </tr></table><span class="postbody">
<br/>
to
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">// =================================================================================
<br/>
// SetPalette:
<br/>
void CTileManager::SetPalette(const void *pPalette, bool forceAllColours)
<br/>
{
<br/>
   ASSERT(pPalette != NULL, "Palette pointer is NULL")
<br/>
<br/>
   int size = (forceAllColours ? 512 : MODIFABLE_PALETTE_SIZE[BG_PAL]);
<br/>
<br/>
   dmaCopy(pPalette, m_pPalette, size);
<br/>
   dmaCopy(pPalette, m_pOriginalPalette, size);
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
The palettes are pretty much the same during the main menu. (none of which are used) the text colours are unchanged. However the text comes out all blocky. I took some screenshots
<br/>
<br/>
First Way: <a href="http://img35.imageshack.us/img35/9684/normalda.png">[Images not permitted - Click here to view it]</a>
<br/>
Changed Way: <a href="http://img6.imageshack.us/img6/3297/blocky.png">[Images not permitted - Click here to view it]</a><br/>_________________<br/><a class="postlink" href="http://sacredpotion.blogspot.com/" target="_blank"><span style="color: red">My Homebrew Games</span></a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#171571 - Dwedit - Sun Nov 29, 2009 10:00 pm</h4>
    <div class="postbody"><span class="postbody">Looks like 8-bit writes to VRAM.<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#171572 - Azenris - Sun Nov 29, 2009 10:03 pm</h4>
    <div class="postbody"><span class="postbody">you mean when loading the text? I use
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">// =================================================================================
<br/>
// Init_RegTileMap256:
<br/>
int CTextManager::Init_RegTileMap256(int tileOffset, u8 *pTileset, u16 *pMap, u16 *pPalette, const FONT *pFont)
<br/>
{   
<br/>
   ASSERT(pTileset != NULL, "NULL tileset")
<br/>
   ASSERT(pMap != NULL, "NULL mapping")
<br/>
   ASSERT(pPalette != NULL, "NULL palette")
<br/>
<br/>
   // default variables
<br/>
   m_cursor.Set(0, 0);
<br/>
   pFont == NULL ? m_pFont = &amp;Text_Font_Morli : m_pFont = pFont;
<br/>
   drawGlyph = RegTileMap_Write;
<br/>
   eraseArea = RegTileMap_Erase;
<br/>
   m_pPalette = pPalette;
<br/>
   m_pMap = pMap;
<br/>
   m_pTileset = pTileset;
<br/>
   m_tileOffset = tileOffset;
<br/>
   m_tileUsed = m_pFont-&gt;characters;
<br/>
   ClearFrames();
<br/>
<br/>
   // add the palette
<br/>
   dmaCopy(m_pFont-&gt;pPalette, (m_pPalette + TEXT_PALETTE_OFFSET), m_pFont-&gt;paletteColours &lt;&lt; 1);
<br/>
   
<br/>
   // copy the tiledata and offset the palette
<br/>
   u16 offset = ((TEXT_PALETTE_OFFSET - 1) &lt;&lt; 8) + (TEXT_PALETTE_OFFSET - 1);
<br/>
   u16 size = (m_pFont-&gt;characters * m_pFont-&gt;imageSize) / 2;
<br/>
   u16 *dst = (u16*)(m_pTileset + ((m_tileOffset * m_pFont-&gt;imageSize) / 2));
<br/>
   u16 *src = (u16*)m_pFont-&gt;pTileset;
<br/>
<br/>
   // apply the palette offset to both bytes
<br/>
   while (size-- != 0)
<br/>
      *dst++ = *src == 0 ? (*src++) : (*src++) + offset;
<br/>
<br/>
   // set as ready
<br/>
   SetLoaded(true);
<br/>
<br/>
   return m_tileUsed;
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
This code has been working fine till I made the palette change, I can change back and forth always same results.<br/>_________________<br/><a class="postlink" href="http://sacredpotion.blogspot.com/" target="_blank"><span style="color: red">My Homebrew Games</span></a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#171574 - Dwedit - Sun Nov 29, 2009 10:42 pm</h4>
    <div class="postbody"><span class="postbody">That's clearly 16 bit writes there, so that must not be the problem.  The source address is aligned, right?
<br/>
<br/>
Oh yeah, this is a NDS.  Always flush the cache before doing any DMA copies.<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#171575 - Azenris - Mon Nov 30, 2009 12:18 am</h4>
    <div class="postbody"><span class="postbody">i tried adding DC_FlushAll();
<br/>
i tried aligning the source data for the text tileset
<br/>
<br/>
I also put some text on the lower screen and it works fine. Only the upper screen that uses SetPalette function having forceAllColours as true fails to work properly.
<br/>
<br/>
However the SetPalette function is called in the splashscreen, it then goes to the titlescreen then the mainmenu (where the text is for the menu items)
<br/>
<br/>
I decided to call it on the lower screen too at the splashscreen and it causes the text to go blocky.
<br/>
<br/>
Basically if I ever call SetPalette with forceAllColours as true, the text messes up for the rest of the game on which ever screen used it.
<br/>
<br/>
EDIT:
<br/>
The difference in the palettes was an extra few blues (the screen was shades of blue). Normally cut off they were being placed by the fact I forced the whole palette to show.
<br/>
<br/>
Anyway my text was blue and made it look blocky, I changed the colour of the difference in palettes to red and can see red all over my text. Not sure why yet but i feel better knowing im on a track!
<br/>
<br/>
Just letting you know my progress. back to work!
<br/>
<br/>
EDIT:
<br/>
Ok i solved it, it was a silly mistake :( I was only checking the whole 16 bit for 0, when I should have been checking both bytes seperatly and applying the offset if needed. 
<br/>
This mistake caused the text data to have some incorrect data, which meant it pointed to the wrong palette entry, was never a problem before because I used only black background, and the palette entries wernt used till now.
<br/>
<br/>
changed it to below, which is now working
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
   u16 offset_l = (TEXT_PALETTE_OFFSET - 1) &lt;&lt; 8;      // offset only left byte
<br/>
   u16 offset_r = (TEXT_PALETTE_OFFSET - 1);         // offset only right byte
<br/>
<br/>
   u16 size = (m_pFont-&gt;characters * m_pFont-&gt;imageSize) / 2;
<br/>
   u16 *dst = (u16*)(m_pTileset + ((m_tileOffset * m_pFont-&gt;imageSize) / 2));
<br/>
   u16 *src = (u16*)m_pFont-&gt;pTileset;
<br/>
   u16 value = 0;
<br/>
<br/>
   // apply the palette offset to both bytes
<br/>
   while (size-- != 0)
<br/>
   {
<br/>
      value = (*src++);
<br/>
<br/>
      value += ((value &amp; 0xFF) == 0) ? 0 : offset_r;
<br/>
      value += ((value &gt;&gt; 8) == 0) ? 0 : offset_l;
<br/>
<br/>
      *dst++ = value;
<br/>
   }</td> </tr></table><span class="postbody"><br/>_________________<br/><a class="postlink" href="http://sacredpotion.blogspot.com/" target="_blank"><span style="color: red">My Homebrew Games</span></a></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
