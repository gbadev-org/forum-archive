<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>C loops on GBA - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>Beginners > C loops on GBA</h2>
<div id="posts">
<div class="post">
    <h4>#171724 - cy.bear - Thu Dec 17, 2009 5:53 pm</h4>
    <div class="postbody"><span class="postbody">Hi,
<br/>
eventhough i'm not new to programming (not that skilled in c though) loops on the gba are giving me a hard time.
<br/>
<br/>
First thing i don't really understand: I'm using mode 4 on BG2 and want to display an image in fullscreen. (The image was converted using dovoto's pcx2gba, result header file contains 1 palette and 1 (1d) data array).
<br/>
<br/>
I load the palette using:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
   int x, y;
<br/>
   for(x = 0; x &lt; 256; x++)
<br/>
      paletteMem[x] = titlePalette[x];
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
For drawing (fullscreen; 240 x 160 px) I use:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
   for(y = 0; y &lt; 160; y++){
<br/>
      for(x = 0; x &lt; 240/2; x++){
<br/>
         plotPixel(x,y,titleData[y*240/2+x]);
<br/>
      }
<br/>
   }
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I know this works (works really great actually) but i don't see why I have to half the width of my screen. I read somewhere that the GBA writes 2 pixels at once. But that doesn't really make sense as it would only show half of the picture then anyway.
<br/>
The loops say "for each line of all 160 and half of the elements per line draw the specified pixel".
<br/>
<br/>
Does every entry in my data array specify two pixels? how would i draw an uneven number of pixels then?
<br/>
<br/>
Second thing that goes terribly wrong: I want to crete a 2d array as a map. I have tiles of type int defined as tileWall and tileFloor. (Tilesize 16x16px so 15 x 10 for fullscreen).
<br/>
i have a map[][] array (large enough). And supply values mapHeight and mapWidth. To generate the map I use the following code:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
for(y = 0; y &lt; mapHeight; y++){
<br/>
   for(x = 0; x &lt; mapWidth; x++){
<br/>
      if(y == 0 || y == mapHeight-1 || x == 0 || x == mapWidth-1){
<br/>
         // tile is border make it a wall
<br/>
         map[y][x] = tileWall;
<br/>
      } else if(y == 1 || y == (mapHeight -2) || x == 1 || x == (mapWidth -2)){
<br/>
         // tile next to outer border, so it's a floor
<br/>
         map[y][x] = tileFloor;
<br/>
      } else {
<br/>
         // decide randomly if tile is to be wall or floor (about 1/3 walls)
<br/>
         // for now: floor
<br/>
         map[y][x] = tileFloor;
<br/>
      }
<br/>
      
<br/>
   }
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
The map is supposed to look like this * &lt;- wall
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">***************
<br/>
*.............*
<br/>
*.............*
<br/>
*.............*
<br/>
*.............*
<br/>
*.............*
<br/>
*.............*
<br/>
*.............*
<br/>
*.............*
<br/>
***************</td> </tr></table><span class="postbody">
<br/>
<br/>
Yet the output is terribly crippled: <a href="http://img705.imageshack.us/img705/4696/bildschirmfoto20091217u.png">[Images not permitted - Click here to view it]</a>
<br/>
<br/>
I think the drawing code could also be responsible for this result so here it is: </span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">int xOffset = 0;
<br/>
int yOffset = 0;
<br/>
const u16 * graphxData;
<br/>
for(y=0; y &lt; lastMapHeight; y++){
<br/>
   for(x=0; x &lt; lastMapWidth; x++){
<br/>
      switch (map[y][x]){
<br/>
         case tileFloor:   ;
<br/>
                     graphxData = floorData;
<br/>
                     break;
<br/>
         case tileWall:   ;
<br/>
                     graphxData = wallData;
<br/>
                     break;
<br/>
         default:      ;
<br/>
                     graphxData = blankData;
<br/>
                     break;
<br/>
      }
<br/>
      
<br/>
      
<br/>
      int tileData_x, tileData_y;
<br/>
      for(tileData_y = 0; tileData_y &lt; tileHeight; tileData_y++){
<br/>
         for(tileData_x = 0; tileData_x &lt; tileWidth/2; tileData_x++){
<br/>
            plotPixel(tileData_x+xOffset, tileData_y+yOffset, graphxData[tileData_y*tileWidth/2 +tileData_x]);
<br/>
         }
<br/>
      }
<br/>
      xOffset += tileWidth;
<br/>
   }
<br/>
   xOffset = 0;
<br/>
   yOffset += tileHeight;
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
Any ideas about my problem? Any references to tutorials, websites ?
<br/>
I'm glad about everything that can help me.
<br/>
<br/>
Thanks in advance and greetings
<br/>
cy
<br/>
<br/>
PS: Already spent hours searching ;)
<br/>
<br/>
EDIT: Forgot to mention that plotPixel is as simple as this: 
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
void plotPixel(int x,int y, unsigned short int c){
<br/>
   videoBuffer[(y) *120 + (x)] = (c); 
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Just noticed that this also sees lines of 120 which supports the assumption that image data array holds info on 2px width for each entry.</span><span class="gensmall"><br/><br/>Last edited by cy.bear on Thu Dec 17, 2009 6:20 pm; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#171726 - DiscoStew - Thu Dec 17, 2009 6:19 pm</h4>
    <div class="postbody"><span class="postbody">With the format you are using, you are displaying an 8-bit image, which has a palette of up to 256 colors, and each pixel is 1 byte each. The reason why you must write 2 pixels at once is because the VRAM doesn't allow 1-byte writes to it, so you must use 2 byte writes, which means you end up writing 2 pixels each time. The data of the image itself is most likely in the format of 2 bytes per array element, so to ensure that it works, you dividing the width of the array by the element size, which is 2.
<br/>
<br/>
Hope that helps. I'll see what I can do about your other questions later, but for now, I got to study for a final.<br/>_________________<br/><span style="font-weight: bold">DS</span> - It's all about <span style="font-weight: bold">D</span>isco<span style="font-weight: bold">S</span>tew</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#171727 - cy.bear - Thu Dec 17, 2009 6:33 pm</h4>
    <div class="postbody"><span class="postbody">OK, that explains the thing quite good. Thank you.
<br/>
<br/>
Addition to the second Problem: The screenshot shows 2 things i don't really understand.
<br/>
1) every second column of tiles starts drawing at y = 1.
<br/>
2) the rightmost line of walls should be in the last column. The weird thing here is that the conditions for bottom line of walls and for right column of walls are identical (except for x / y of course).
<br/>
<br/>
EDIT:
<br/>
Another screenshot. In this version the thrid case (which should pick a tile randomly) in the map generate code is changed so a black tile is used instead of a floor.
<br/>
<br/>
Result: <a href="http://img171.imageshack.us/img171/4696/bildschirmfoto20091217u.png">[Images not permitted - Click here to view it]</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#171728 - DiscoStew - Thu Dec 17, 2009 8:14 pm</h4>
    <div class="postbody"><span class="postbody">Took me a bit to understand the situation, but I believe a single change will fix this.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">Change
<br/>
   xOffset += tileWidth;
<br/>
to
<br/>
   xOffset += tileWidth / 2;</td> </tr></table><span class="postbody">
<br/>
<br/>
The reasoning behind this is because, as was said before, writing to the videoBuffer can only be done 2 bytes at a time, so therefore, to fix some problems, you divide the width by that much. but, when you increment the xOffset by tileWidth, you are actually incrementing it by a total of 32 pixels instead of 16. Remember, videoBuffer is 2 bytes per element, so 16 * 2 = 32.
<br/>
<br/>
What is happening in your program is that you end up skipping every other horizontal tile because of this, and because the buffer wraps across the screen every 240 pixels (120 bytes), it causes the rest of your tiles being written to be pushed down by 1 pixel, and this is also causing the odd ordering of your tiles (specifically your right wall).
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">This is how it should look like
<br/>
00 01 02 03 04 05 06 07 08 09 10 11 12 13 14
<br/>
<br/>
This is what your program is doing
<br/>
00    01    02    03    04    05    06    07   
<br/>
   08    09    10    11    12    13    14
<br/>
<br/>
but because wrapping over just increments by 1 pixel vertically, it almost looks like this
<br/>
00 08 01 09 02 10 03 11 04 12 05 13 06 14 07</td> </tr></table><span class="postbody">
<br/>
<br/>
So, just make that simple change, and it should look fine.<br/>_________________<br/><span style="font-weight: bold">DS</span> - It's all about <span style="font-weight: bold">D</span>isco<span style="font-weight: bold">S</span>tew</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#171730 - cy.bear - Thu Dec 17, 2009 8:20 pm</h4>
    <div class="postbody"><span class="postbody">wow. You're right, that just fixed it. 
<br/>
Thanks again. 
<br/>
Never would have thought that it was just a single line.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
