<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Timer Routine - Anyone? - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>Beginners > Timer Routine - Anyone?</h2>
<div id="posts">
<div class="post">
    <h4>#160229 - zodiacdagreat - Sat Jul 12, 2008 10:25 am</h4>
    <div class="postbody"><span class="postbody">Um, can someone make me a <span style="font-weight: bold">ASM</span> timer routine for gba that does this - A count down timer, which starts at (User Defined Time - Minutes/Secs) when it reaches 0, it'll set a variable to a certain value. Will the game freeze when the routine is running? Cause I need one that doesn't freeze the game while counting down.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#160230 - silent_code - Sat Jul 12, 2008 10:30 am</h4>
    <div class="postbody"><span class="postbody">You should take a look at timer interrupts. ;^)<br/>_________________<br/><span style="font-size: 9px; line-height: normal"><span style="text-decoration: underline"><span style="font-weight: bold"></span></span> July 5th 08: "<span style="font-weight: bold">Volumetric Shadow Demo</span>" 1.6.0 (final) source released
<br/>
June 5th 08: "<span style="font-weight: bold">Zombie NDS</span>" WIP released!
<br/>
It's all on my page, just click <span style="font-weight: bold">WWW</span> below.</span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#160244 - Miked0801 - Sat Jul 12, 2008 7:41 pm</h4>
    <div class="postbody"><span class="postbody">Again why asm?  If asm, define 4 bytes in memory and set it to user defined minutes * 3600 + user defined seconds * 60.  Decrement once per vblank.  At 0, set your other variable in vblank.  The same code in C is 4 lines or so long.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#160251 - sgeos - Sat Jul 12, 2008 9:19 pm</h4>
    <div class="postbody"><span class="postbody">In this day and age, nobody hand codes assembler unless they really need to.
<br/>
I would write this in C, see what the compiler does with it and then hand optimize it from there if you really need to.
<br/>
I would probably use something like this:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#define TRUE    1
<br/>
#define FALSE   0
<br/>
#define FRAMES_PER_SECOND       60
<br/>
#define FRAMES_PER_MINUTE       3600
<br/>
<br/>
// Max time is 18 minutes, 12 seconds, 15 frames
<br/>
void initializeCountDownAndSetInt
<br/>
(
<br/>
        int *           pActive_Ptr,
<br/>
        unsigned int *  pTimer_Ptr,
<br/>
        int             pMinutes,
<br/>
        int             pSeconds,
<br/>
        int             pFrames
<br/>
)
<br/>
{
<br/>
        *pActive_Ptr = TRUE;
<br/>
        *pTimer_Ptr = pFrames +
<br/>
                FRAMES_PER_SECOND * pSeconds +
<br/>
                FRAMES_PER_MINUTE * pMinutes;
<br/>
}
<br/>
<br/>
void countDownAndSetInt
<br/>
(
<br/>
        int *           pActive_Ptr,
<br/>
        unsigned int *  pTimer_Ptr,
<br/>
        int *           pTarget_Ptr,
<br/>
        int             pTargetValue
<br/>
)
<br/>
{
<br/>
        if ( FALSE == *pActive_Ptr )
<br/>
                return;
<br/>
<br/>
        if ( 0 &lt; *pTimer_Ptr )
<br/>
        {
<br/>
                (*pTimer_Ptr)--;
<br/>
        }
<br/>
        else
<br/>
        {
<br/>
                *pActive_Ptr = FALSE;
<br/>
                *pTarget_Ptr = pTargetValue;
<br/>
        }
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
For what it's worth, this is the PC side scaffolding code I used to test the timer code:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#include &lt;stdio.h&gt;
<br/>
<br/>
// never do this in production code (I was too lazy to create a header)
<br/>
#include "timer.c"
<br/>
// end never do this
<br/>
<br/>
// Max time is 18 minutes, 12 seconds, 15 frames
<br/>
#define MINUTES 1
<br/>
#define SECONDS 2
<br/>
#define FRAMES  15
<br/>
#define PRESET  FALSE
<br/>
#define POSTSET TRUE
<br/>
<br/>
void display_status(int pActive, int pTimer, int pTarget)
<br/>
{
<br/>
        if (pActive)
<br/>
                printf("running @ 0x%04X; target -&gt; %d\n", pTimer, pTarget);
<br/>
        else
<br/>
                printf("stopped @ 0x%04X; target -&gt; %d\n", pTimer, pTarget);
<br/>
}
<br/>
<br/>
int main(void)
<br/>
{
<br/>
        // These need to live somewhere...
<br/>
        int             active;
<br/>
        unsigned int    timer;
<br/>
        int             target = PRESET;
<br/>
<br/>
        // Initialize like this...
<br/>
        initializeCountDownAndSetInt(&amp;active, &amp;timer, MINUTES, SECONDS, FRAMES);
<br/>
<br/>
        // Make sure everything went as planned...
<br/>
        display_status(active, timer, target);
<br/>
<br/>
        // Dummy game loop for testing...
<br/>
        while (active)
<br/>
        {
<br/>
                // Call like this...
<br/>
                countDownAndSetInt(&amp;active, &amp;timer, &amp;target, POSTSET);
<br/>
<br/>
                // Keep tabs on progress...
<br/>
                display_status(active, timer, target);
<br/>
        }
<br/>
<br/>
        // Make sure the timer has stopped...
<br/>
        target = PRESET;
<br/>
        int i;
<br/>
        for (i = 0; i &lt; 3; i++)
<br/>
        {
<br/>
                countDownAndSetInt(&amp;active, &amp;timer, &amp;target, POSTSET);
<br/>
                display_status(active, timer, target);
<br/>
        }
<br/>
        return 0;
<br/>
}</td> </tr></table><span class="postbody">
<br/>
Of course, all of this could be done with structs or even objects if you prefer C++ as a design language.
<br/>
<br/>
If your goal is to learn ASM, I suspect there are some ASM tutorials out there, but I have not looked in ages.
<br/>
<br/>
-Brendan
<br/>
<br/>
<span style="font-weight: bold">EDIT:</span> I botched the max time.  The ceiling is so high there is no need to worry about it.  Related to that, the test display routine should really say 0x%08X instead of 0x%04X.  None of this breaks the code posted.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161363 - zodiacdagreat - Fri Aug 01, 2008 11:15 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">#define TRUE    1
<br/>
#define FALSE   0
<br/>
#define FRAMES_PER_SECOND       60
<br/>
#define FRAMES_PER_MINUTE       3600
<br/>
<br/>
// Max time is 18 minutes, 12 seconds, 15 frames
<br/>
void initializeCountDownAndSetInt
<br/>
(
<br/>
        int *           pActive_Ptr,
<br/>
        unsigned int *  pTimer_Ptr,
<br/>
        int             pMinutes,
<br/>
        int             pSeconds,
<br/>
        int             pFrames
<br/>
)
<br/>
{
<br/>
        *pActive_Ptr = TRUE;
<br/>
        *pTimer_Ptr = pFrames +
<br/>
                FRAMES_PER_SECOND * pSeconds +
<br/>
                FRAMES_PER_MINUTE * pMinutes;
<br/>
}
<br/>
<br/>
void countDownAndSetInt
<br/>
(
<br/>
        int *           pActive_Ptr,
<br/>
        unsigned int *  pTimer_Ptr,
<br/>
        int *           pTarget_Ptr,
<br/>
        int             pTargetValue
<br/>
)
<br/>
{
<br/>
        if ( FALSE == *pActive_Ptr )
<br/>
                return;
<br/>
<br/>
        if ( 0 &lt; *pTimer_Ptr )
<br/>
        {
<br/>
                (*pTimer_Ptr)--;
<br/>
        }
<br/>
        else
<br/>
        {
<br/>
                *pActive_Ptr = FALSE;
<br/>
                *pTarget_Ptr = pTargetValue;
<br/>
        }
<br/>
}</td> </tr></table><span class="postbody">
<br/>
Finally its been so long - it took me quite a while to understand at least to a extent. Um, I have one more request, could you make a same code like this, making it do this:
<br/>
<br/>
-Countdowntime of 3mins
<br/>
-When countdown is done, 0x2022000 is 1
<br/>
-and make this timer routine invisible like it doesn't freeze the game.
<br/>
<br/>
So, with these two , I can compare the differences and make my own. Please help.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
