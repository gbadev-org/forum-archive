<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Background Tiles - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>Beginners > Background Tiles</h2>
<div id="posts">
<div class="post">
    <h4>#170165 - Azenris - Sat Sep 05, 2009 1:00 am</h4>
    <div class="postbody"><span class="postbody">Hello I have the following code
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
REG_BG0CNT = BG_32x32 | BG_COLOR_256 | BG_MAP_BASE(0) | BG_TILE_BASE(1) | BG_PRIORITY(2);
<br/>
REG_BG1CNT = BG_32x32 | BG_COLOR_256 | BG_MAP_BASE(1) | BG_TILE_BASE(3) | BG_PRIORITY(2);
<br/>
REG_BG2CNT = BG_32x32 | BG_COLOR_256 | BG_MAP_BASE(2) | BG_TILE_BASE(5) | BG_PRIORITY(2);
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Have I done this correctly, I was wanting 3 layers, to one screen (using MODE_0_2D) and a tile set
<br/>
of (128 - 16*16 size tiles (512 meta tiles)).
<br/>
<br/>
Later I have the following
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
m_pMain_Map      = BG_MAP_RAM(0);
<br/>
m_pMain_Tileset      = BG_TILE_RAM(1);
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Looking ok so far? :p
<br/>
<br/>
I been looking through some of the libnds files and is has
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#define BG_TILE_BASE(base)       ((base) &lt;&lt; TILE_BASE_SHIFT)
<br/>
#define BG_MAP_BASE(base)        ((base) &lt;&lt; MAP_BASE_SHIFT)
<br/>
<br/>
#define BG_MAP_RAM(base)      ((u16*)(((base)*0x800) + 0x06000000))
<br/>
#define BG_TILE_RAM(base)      ((u16*)(((base)*0x4000) + 0x06000000))
<br/>
<br/>
#define CHAR_BASE_BLOCK(base)      (((base)*0x4000)+ 0x06000000)
<br/>
#define SCREEN_BASE_BLOCK(base)      (((base)*0x800) + 0x06000000)
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
So i use BG_TILE_BASE and BG_MAP_BASE macros when setting up the BG control and BG_MAP_RAM and BG_TILE_RAM
<br/>
when I want to read and write to those locations?
<br/>
<br/>
Basically just wanted to know if I atleast got this bit right and then I can assume the problem
<br/>
lies within another section of my code. TY
<br/>
<br/>
<br/>
EDIT:
<br/>
sorry to ask another question, hope you don't mind. I have
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
void CScreenManager::LoadTileIntoSet(u8 layer, u8 tileIndex, u16 tile)
<br/>
{
<br/>
   // add the tileID into the loaded tiles
<br/>
   m_loadedTiles[layer][tileIndex] = tile;
<br/>
<br/>
   // locate data on this tile
<br/>
   const tileData *pTile = g_pGame-&gt;GetTileData(tile);
<br/>
<br/>
   // locate memory location to write to
<br/>
   u16 *pMemoryLoc = NULL;
<br/>
   if (layer == 0)
<br/>
      pMemoryLoc = m_pMain_Tileset0 + (tileIndex * tile_graphic_size);
<br/>
   else
<br/>
      pMemoryLoc = m_pMain_Tileset1 + (tileIndex * tile_graphic_size);
<br/>
<br/>
   // write it into memory
<br/>
   dmaCopy(pTile-&gt;pGraphics, pMemoryLoc, tile_graphic_size);
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
It basically loads a tile into the tileset. I made some text output to the lower screen on some variables. It showed:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
tileIndex: 0, tile: 159, mem: 6004000
<br/>
tileIndex: 1, tile: 207, mem: 6004200
<br/>
tileIndex: 2, tile: 343, mem: 6004400
<br/>
tileIndex: 3, tile: 337, mem: 6004600
<br/>
tileIndex: 4, tile: 341, mem: 6004800
<br/>
tileIndex: 5, tile: 339, mem: 6004a00
<br/>
tileIndex: 6, tile: 166, mem: 6004c00
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
tile_graphic_size is defined as 256, but the tiles are jumping by 512 bytes.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
pMemoryLoc = m_pMain_Tileset1 + (tileIndex * tile_graphic_size);
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
This decided the writing location, as the index goes up shouldnt it add an additional 256 bytes?
<br/>
<br/>
<br/>
Sorry I posted so many questions lately :/ I am trying on my own too! TY if any helps
<br/>
<br/>
EDIT:
<br/>
its almost 4am, maybe I should sleep im probably doing it all wrong or just not thinking straight!
<br/>
<br/>
EDIT Next day:
<br/>
nevermind I figured it out, i was using u16* instead of u8*. I got my entire screen loading now.<br/>_________________<br/><a class="postlink" href="http://sacredpotion.blogspot.com/" target="_blank"><span style="color: red">My Homebrew Games</span></a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170176 - Azenris - Sat Sep 05, 2009 6:15 pm</h4>
    <div class="postbody"><span class="postbody">Your gonna hate me but I need help, I thought i finally understood it
<br/>
but now im not sure, noone replied before whether I had set it up
<br/>
correct and im unsure where my problem lies.
<br/>
<br/>
I have the following:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
mem m1: 0x6000000 (layer 0 map)
<br/>
mem m2: 0x6000800 (layer 1 map)
<br/>
<br/>
mem t1: 0x6004000 (layer 0 tiles)
<br/>
mem t2: 0x600c000 (layer 1 tiles)
<br/>
</td> </tr></table><span class="postbody">
<br/>
My layer 0 map and tiles all seem to work ok, I can get my BG showing, but
<br/>
the layer 1 stuff isnt working (shows rubbish). I thought it might have been an overlap or
<br/>
some misunderstanding on my part of the whole map and tiles stuff.
<br/>
<br/>
Current I have it setup like
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
REG_BG0CNT = BG_32x32 | BG_COLOR_256 | BG_MAP_BASE(0) | BG_TILE_BASE(1) | BG_PRIORITY(2);
<br/>
REG_BG1CNT = BG_32x32 | BG_COLOR_256 | BG_MAP_BASE(1) | BG_TILE_BASE(3) | BG_PRIORITY(1);
<br/>
REG_BG2CNT = BG_32x32 | BG_COLOR_256 | BG_MAP_BASE(2) | BG_TILE_BASE(5) | BG_PRIORITY(0);
<br/>
<br/>
m_pMain_Tileset0   = (u8*)BG_TILE_RAM(1);
<br/>
m_pMain_Map0      = BG_MAP_RAM(0);
<br/>
m_pMain_Tileset1   = (u8*)BG_TILE_RAM(3);
<br/>
m_pMain_Map1      = BG_MAP_RAM(1);
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I load a tile into the tile set with
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
void CScreenManager::LoadTileIntoSet(u8 layer, u8 tileIndex, u16 tile)
<br/>
{
<br/>
   // add the tileID into the loaded tiles
<br/>
   m_loadedTiles[layer][tileIndex] = tile;
<br/>
<br/>
   // locate data on this tile
<br/>
   const tileData *pTile = g_pGame-&gt;GetTileData(tile);
<br/>
<br/>
   // locate memory location to write to
<br/>
   u8 *pMemoryLoc = NULL;
<br/>
   if (layer == 0)
<br/>
      pMemoryLoc = (u8*)m_pMain_Tileset0 + (tileIndex * tile_graphic_size);
<br/>
   else if (layer == 1)
<br/>
      pMemoryLoc = (u8*)m_pMain_Tileset1 + (tileIndex * tile_graphic_size);
<br/>
<br/>
   // write it into memory
<br/>
   dmaCopy(pTile-&gt;pGraphics, pMemoryLoc, tile_graphic_size);
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
and for the map I do
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
void CScreenManager::LoadTile(u8 layer, u8 location, u16 tile)
<br/>
{
<br/>
   // add the tile into the data array
<br/>
   m_data[location + (layer * SCREEN_SIZE)] = tile;
<br/>
<br/>
   // check the tile isnt blank
<br/>
   if (layer == 0 &amp;&amp; tile == 0)
<br/>
      return;
<br/>
<br/>
   u8 tileIndex = 0;
<br/>
<br/>
   // check if this tile has been loaded into the tile set
<br/>
   // if so the index is retrieved, if not a new index is
<br/>
   // needed to place the new tile
<br/>
   if (TileInSet(layer, tile))
<br/>
   {
<br/>
      tileIndex = GetTileIndex(layer, tile);
<br/>
   }
<br/>
   else
<br/>
   {
<br/>
      tileIndex = GetFreeTileIndex(layer);
<br/>
      LoadTileIntoSet(layer, tileIndex, tile);
<br/>
   }
<br/>
<br/>
   // now the tile can be pointed to by the mapping array
<br/>
   u16 mapPosition = (location * 2) + ((location / SCREEN_X) * SCREEN_TILE_X);
<br/>
   u16 tilePosition = tileIndex * 4;
<br/>
<br/>
   if (layer == 0)
<br/>
   {
<br/>
      m_pMain_Map0[mapPosition] = tilePosition;
<br/>
      m_pMain_Map0[mapPosition+1] = tilePosition + 1;
<br/>
      m_pMain_Map0[mapPosition+SCREEN_TILE_X] = tilePosition + 2;
<br/>
      m_pMain_Map0[mapPosition+SCREEN_TILE_X+1] = tilePosition + 3;
<br/>
   }
<br/>
   else if (layer == 1)
<br/>
   {
<br/>
      m_pMain_Map1[mapPosition] = tilePosition;
<br/>
      m_pMain_Map1[mapPosition+1] = tilePosition + 1;
<br/>
      m_pMain_Map1[mapPosition+SCREEN_TILE_X] = tilePosition + 2;
<br/>
      m_pMain_Map1[mapPosition+SCREEN_TILE_X+1] = tilePosition + 3;
<br/>
   }
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
basically everything for layer 0 is working and the screen is showing
<br/>
fine, my problem comes when I add my layer 1 stuff. Is there a memory overlap or
<br/>
something im doing wrong with the second layer ? :/
<br/>
<br/>
sorry for another question, I really just wanna figure this tiling out!
<br/>
<br/>
 //////////////// EDIT:
<br/>
Never mind, I figured it out, I think I might have to pretend on posting a question that way ill figure it out soon after anyway! Basically when doing the layer 1 I forgot to have transparency to let blank areas show the flooring.
<br/>
<br/>
anyway sorry for spamming. bye!<br/>_________________<br/><a class="postlink" href="http://sacredpotion.blogspot.com/" target="_blank"><span style="color: red">My Homebrew Games</span></a></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
