<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Fixed point math help - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>Beginners > Fixed point math help</h2>
<div id="posts">
<div class="post">
    <h4>#35518 - ymalik - Sun Feb 06, 2005 12:40 am</h4>
    <div class="postbody"><span class="postbody">Hello,
<br/>
I need help on fixed point math.  I don't know if this belongs here, and I couldn't find another topic regarding this.  The fixed-point number is in 18.14 format.
<br/>
<br/>
I have the following program:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#include &lt;string.h&gt;
<br/>
<br/>
#define FIX_SCALEF 16384.0f
<br/>
#define FIX_FRAC_PART(n) ((n)&amp;0x3fff)
<br/>
#define FIX_INT_PART(n) (n&gt;&gt;14)
<br/>
typedef int FIXED;
<br/>
<br/>
int main()
<br/>
{
<br/>
 float num = -130.1234;
<br/>
<br/>
 FIXED fixed = num*FIX_SCALEF;
<br/>
 int int_part, frac_part;
<br/>
<br/>
 frac_part = FIX_FRAC_PART(fixed);
<br/>
 int_part = FIX_INT_PART(fixed);
<br/>
<br/>
 printf("floating point: %f\n", num);
<br/>
 printf("fixed point: %i\n", fixed);
<br/>
 printf("int part: %i\n", int_part);
<br/>
 printf("frac part: %i\n", frac_part);
<br/>
<br/>
 return 0;
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
But it outputs the following:
<br/>
floating point: -130.123398
<br/>
fixed point: -2131941
<br/>
int part: -131
<br/>
frac part: 14363
<br/>
<br/>
And I notice that the integer part is always one more than the original integer part, and the fractional part is always messed up.
<br/>
<br/>
Thanks,
<br/>
Yasir</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#35520 - tepples - Sun Feb 06, 2005 1:30 am</h4>
    <div class="postbody"><span class="postbody">You're dealing with negative numbers. Your way of taking the integer part of a fixed-point number is precisely equivalent to floor(n) of a floating-point number, and your fractional part is n-floor(n). Try taking 16384 minus the fractional part and seeing if it looks any better.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#35521 - ymalik - Sun Feb 06, 2005 2:11 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tepples wrote:</b></span></td> </tr> <tr> <td class="quote"><span style="font-style: italic">Your way</span> of taking the integer part of a fixed-point number is precisely equivalent to floor(n) of a floating-point number, and your fractional part is n-floor(n).</td> </tr></table><span class="postbody">
<br/>
<br/>
What is your way?  I'm following Cearn's fixed point math tutorial.  Also, (16384 - ((n)&amp;0x3fff)) does not give me the right value for the fractional part.
<br/>
<br/>
Thanks,
<br/>
Yasir</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#35524 - tepples - Sun Feb 06, 2005 2:45 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>ymalik wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tepples wrote:</b></span></td> </tr> <tr> <td class="quote"><span style="font-style: italic">Your way</span> of taking the integer part of a fixed-point number is precisely equivalent to floor(n) of a floating-point number, and your fractional part is n-floor(n).</td> </tr></table><span class="postbody">
<br/>
<br/>
What is your way?</span></td> </tr></table><span class="postbody">
<br/>
The / operator rounds toward zero; to take frac(n), do n / 16384. In most cases, division is dog-slow, but GCC recognizes division by a power of 0 and optimizes it. But if you're not displaying a number, you usually want floor(n) or round(n), which is floor(n + float_to_fix(0.5)).
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Also, (16384 - ((n)&amp;0x3fff)) does not give me the right value for the fractional part.</td> </tr></table><span class="postbody">
<br/>
It did for me in Windows 2000's calculator. The fractional part of your number is -0.1234; when I pasted (14363-16384)/16384.0= into calculator I got -0.12335205078125 which is close enough.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#35531 - Cearn - Sun Feb 06, 2005 1:43 pm</h4>
    <div class="postbody"><span class="postbody">Funny thing about divisions and shifts is that division always rounds towards zero, but shifts always rounds to the integer below it. For positive values this will be the same, but for negative values there can be a difference. (-1)/2 is 0, while (-1)&gt;&gt;1 = -1.
<br/>
<br/>
Here are the .14 fixed point values of 130.123398 and -130.123398 in detail:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
130.1234 * 16384 = 2131941.79
<br/>
002087E5                                 // hex
<br/>
0000 0000 0010 0000 1000 0111 1110 0101  // binary
<br/>
0000 0000 1000 0010 : 00 0111 1110 0101  // redistribute to  .14 fixed point
<br/>
0082 : 07E5                              // hex integer vs 'fraction'
<br/>
130  : 2021                              // decimal integer vs 'fraction'
<br/>
divide 'fraction' by 16384
<br/>
130 + 0.1234
<br/>
<br/>
<br/>
-130.1234 * 16384 = -2131941.79
<br/>
FFDF781B                                 // hex
<br/>
1111 1111 1101 1111 0111 1000 0001 1011  // binary
<br/>
1111 1111 0111 1101 : 11 1000 0001 1011  // redistribute to  .14 fixed point
<br/>
FF72 : 381B                              // hex integer vs 'fraction'
<br/>
-131 : 14363                             // decimal integer vs 'fraction'
<br/>
divide 'fraction' by 16384
<br/>
-131 + 0.8766
<br/>
</td> </tr></table><span class="postbody">
<br/>
The final number is still correct, but the fraction is counted from the lower integer (-131), rather than the integer closest to zero (-130).</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#35592 - ymalik - Mon Feb 07, 2005 8:08 pm</h4>
    <div class="postbody"><span class="postbody">I'm having issues with the accuracy in fixed point.  The following program should output a value around 801, but it is outputting 874.  I need to use 18.14 format because I need to have up to 4 decimal places of accuracy.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
typedef int FIXED;
<br/>
#define TO_FIXED(n) ((n)*16384.0f)  
<br/>
<br/>
int main()
<br/>
{
<br/>
 float x = -74.1814, bound_x = -74.5018;
<br/>
 FIXED xf = TO_FIXED(x), bound_xf = TO_FIXED(bound_x);        
<br/>
 FIXED shifted_x = xf - bound_xf;
<br/>
 FIXED dx = TO_FIXED(0.0004);          
<br/>
 FIXED new_x = (shifted_x &lt;&lt; 14) / dx;
<br/>
 int pixel = new_x &gt;&gt; 14;
<br/>
 
<br/>
 printf("pixel: %i\n", pixel);
<br/>
 
<br/>
 return 0;
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Is there anyway to get around this?  Using 0.004 for dx works fine, though.
<br/>
<br/>
Thanks,
<br/>
Yasir</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#35627 - Cearn - Tue Feb 08, 2005 3:27 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>ymalik wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
typedef int FIXED;
<br/>
#define TO_FIXED(n) ((n)*16384.0f)  
<br/>
<br/>
int main()
<br/>
{
<br/>
  float x = -74.1814, bound_x = -74.5018;
<br/>
  FIXED xf = TO_FIXED(x);                 // -1215388 (-0.something)
<br/>
  FIXED bound_xf = TO_FIXED(bound_x);     // -12206637 (-0.something)
<br/>
  FIXED shifted_x = xf - bound_xf;        // 5249 (1481h)
<br/>
  FIXED dx = TO_FIXED(0.0004);            // 6 (+0.5536)
<br/>
  FIXED new_x = (shifted_x &lt;&lt; 14) / dx;   // 5204000h/6 = DAB555h
<br/>
  int pixel = new_x &gt;&gt; 14;                // = 874 (+0.8333)
<br/>
}
<br/>
</td> </tr></table><span class="postbody"></span></td> </tr></table><span class="postbody">
<br/>
The main problem here is the definition of dx. It's a single digit, meaning that ever calculation you do with it will have just <span style="font-weight: bold">one</span> digit of accuracy at best!! No amount of shifting the numerator is going to fix this. In fact, you could have just used shifted_x/ dx, which is 874(+0.8333) as well.
<br/>
On the other hand, it divide beforehand (dx = 1.0/0.0004 = 2500), you have 4 digits of accuracy. 5249*2500 = 13122500 = (800 + 0.934)*16384, which I think is more to your liking.
<br/>
<br/>
The order of evaluation often matters in fixed point math, my mode7c demo shows that quite nicely. Unfortunately, the most accurate order depends very much on what kind of numbers you're dealing with, so there is no one-size-fits-all answer to give. Trace the code, check the numbers at every step and go from there.
<br/>
<br/>
I also found this site with more details about fixed point rounding that might be informative: <a class="postlink" href="http://www.bookofhook.com/Article/GameDevelopment/AnIntroductiontoFixedPoin.html" target="_blank">http://www.bookofhook.com/Article/GameDevelopment/AnIntroductiontoFixedPoin.html</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#35633 - stuleelight - Tue Feb 08, 2005 5:07 pm</h4>
    <div class="postbody"><span class="postbody">What application could be used for floating point number systems as opposed to plain int's?<br/>_________________<br/>^o^</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#35637 - ymalik - Tue Feb 08, 2005 6:44 pm</h4>
    <div class="postbody"><span class="postbody">We are making a GPS device for the GBA.  We are thinking about having the ability to display ESRI shapefiles, and all the vertices are stored as doubles.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#35642 - Miked0801 - Tue Feb 08, 2005 8:17 pm</h4>
    <div class="postbody"><span class="postbody">Heck, world positions of characters should have sub-pixel accuracy in games - else sub-pixel velocities become impossible to handle.  Long live fixed point!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#35682 - ymalik - Wed Feb 09, 2005 3:40 pm</h4>
    <div class="postbody"><span class="postbody">The GBA is not properly reading the fixed point values I have stored in a seperate .c file linked into my program.
<br/>
I have the following types defined:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
typedef int FIXED;
<br/>
<br/>
typedef struct Point_t
<br/>
{
<br/>
 FIXED x;
<br/>
 FIXED y;
<br/>
} Point;
<br/>
<br/>
typedef struct Boundary_t
<br/>
{
<br/>
 Point min;
<br/>
 Point max;
<br/>
} Boundary;
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I have an structure defined in a .c file as Boundary file_bounds = { {-1220637, 668801}, {-1214173, 675083} };
<br/>
However, when I print out the values of the structure in GDB, I get { {-1214457, 668920}, {-1214452, 668925} }.
<br/>
And it's like that for every structure I use.  Why is this happening?  This is really messing up my calculations.
<br/>
[edit]It is also like that for simple arrays.  For example, I have array called offsets that begins with {2, 2}, but when I print out offsets[0], I get 30732, but -19 for offsets[1].[/edit]
<br/>
<br/>
Thanks,
<br/>
Yasir</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#35774 - Miked0801 - Thu Feb 10, 2005 7:38 pm</h4>
    <div class="postbody"><span class="postbody">Weird.  Can you show us how your array is being defined - perhaps it's a 2D array and you're somehow getting a pointer value?  Or your printf is broken.  Strange</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#35795 - ymalik - Thu Feb 10, 2005 11:20 pm</h4>
    <div class="postbody"><span class="postbody">Here is what data.c looks like:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#include "types.h"
<br/>
<br/>
Boundary file_bounds = { {-1220637, 668801}, {-1214173, 675068} };
<br/>
<br/>
short offsets[] = {
<br/>
2,
<br/>
2,
<br/>
4,
<br/>
3,
<br/>
3,
<br/>
2,
<br/>
...
<br/>
}
<br/>
<br/>
Boundary bounds[] = {
<br/>
{ {-1215388, 671377}, {-1215388, 671378} },
<br/>
{ {-1215389, 671378}, {-1215388, 671380} },
<br/>
{ {-1218907, 674629}, {-1218886, 674661} },
<br/>
{ {-1218979, 674527}, {-1218964, 674555} },
<br/>
{ {-1218979, 674429}, {-1218971, 674445} },
<br/>
{ {-1218972, 674435}, {-1218938, 674445} },
<br/>
{ {-1218972, 674445}, {-1218966, 674455} },
<br/>
{ {-1218966, 674444}, {-1218928, 674455} },
<br/>
...
<br/>
}
<br/>
<br/>
Point vertices[] = {
<br/>
{-1215388, 671377},
<br/>
{-1215388, 671378},
<br/>
<br/>
{-1215388, 671378},
<br/>
{-1215389, 671380},
<br/>
<br/>
{-1218907, 674629},
<br/>
{-1218891, 674642},
<br/>
{-1218889, 674645},
<br/>
{-1218886, 674661},
<br/>
<br/>
{-1218964, 674555},
<br/>
{-1218968, 674549},
<br/>
{-1218979, 674527},
<br/>
...
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
The file is compiled and linked to my program.  Here is how I refer to them in the program.  They are global variables:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
extern Boundary file_bounds;
<br/>
extern short offsets[];
<br/>
extern Boundary bounds[];
<br/>
extern Point vertices[];
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I am not using printf; I'm using GDB.  Here are some example values of the variables:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
file_bounds =  {min = {x = -1214457, y = 668920}, max = {x = -1214452, y = 668925}}
<br/>
offsets[0] = 30732
<br/>
bounds[0] = {min = {x = -1214463, y = 669697}, max = {x = -1214475, y = 669692}}
<br/>
vertices[0] = {x = -1218831, y = 673536}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
The strange thing is that when I try to print out some of the variables in the debugger, I get message saying the symbol doesn't exist in the current context, but I have them there.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#35812 - Miked0801 - Fri Feb 11, 2005 1:21 am</h4>
    <div class="postbody"><span class="postbody">Try throwing a const in front of the structures - perhaps the copy to RAM is screwing with things (or something is wiping RAM on you.)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#35857 - ymalik - Fri Feb 11, 2005 3:16 pm</h4>
    <div class="postbody"><span class="postbody">Ok, thanks, that did the trick.  But isn't the structure read from ROM and not brought into RAM?
<br/>
Also, GDB does not recognize some of the variables I have in program--variables that are crucial to my calculations.  It says that they not in the current context, even though I know they are since they are within the same scope as my other variables.  This could be the reason why calculations are so far off.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#35865 - tepples - Fri Feb 11, 2005 5:31 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>ymalik wrote:</b></span></td> </tr> <tr> <td class="quote">Ok, thanks, that did the trick.  But isn't the structure read from ROM and not brought into RAM?</td> </tr></table><span class="postbody">
<br/>
Structures are read directly from ROM only if they're declared const.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Also, GDB does not recognize some of the variables I have in program--variables that are crucial to my calculations.</td> </tr></table><span class="postbody">
<br/>
If they're inner-loop variables, then perhaps they've been optimized out. GCC likes to do that; use -O0 (dash oh zero) to disable optimizations until you've finished stepping through the function.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#35896 - ymalik - Sat Feb 12, 2005 2:03 am</h4>
    <div class="postbody"><span class="postbody">Thanks, you're great.
<br/>
Is this a bug in GCC?  Here's what I had:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
int main()
<br/>
{
<br/>
 FIXED pixel_length = TO_FIXED(0.004);
<br/>
 ...
<br/>
 [loop]
<br/>
 prev_x = swi_div((vertices[vertex_pointer].x - xmin) &lt;&lt; 14, pixel_length);
<br/>
</td> </tr></table><span class="postbody">
<br/>
And pixel_length was being taken out.  So this was a critical value.
<br/>
I'm going to change the operation to use multiplication, though.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
