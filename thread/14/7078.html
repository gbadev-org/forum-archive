<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Interrupt Service Routine - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>Beginners > Interrupt Service Routine</h2>
<div id="posts">
<div class="post">
    <h4>#56258 - Tomik - Fri Oct 07, 2005 2:01 pm</h4>
    <div class="postbody"><span class="postbody">Hi Dudes ;)
<br/>
<br/>
I got a problem with the ISR ! Can somebody help me with that ?
<br/>
Where do I have to put it in the prog.
<br/>
I just want to control for sampling rate and filtering stuff. therefore i need a timer interrupt. i did this, but works not serious.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
main
<br/>
{
<br/>
  //Timer Interrupt  
<br/>
  while
<br/>
  {
<br/>
    //bla bla
<br/>
  }
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
I need a ISR which stops the main whenever it comes ! So do you have a idea for me ??
<br/>
<br/>
Thanks, Thomas</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#56514 - quickcup - Sun Oct 09, 2005 7:06 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
<br/>
my_irq() {
<br/>
<br/>
    if (timer interrupt) {
<br/>
       do timer interrupt stuff
<br/>
    }
<br/>
<br/>
}
<br/>
<br/>
interrupt_handler = my_irq
<br/>
<br/>
main() {
<br/>
   turn on global interrupts
<br/>
   turn on timer interrupt
<br/>
   turn on timer
<br/>
<br/>
   do stuff while waiting to be interrupted {
<br/>
      ...
<br/>
   }
<br/>
}
<br/>
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Well that's the pseudo code anyway.  I'll see if I can find the actual code.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#56637 - Tomik - Mon Oct 10, 2005 8:28 am</h4>
    <div class="postbody"><span class="postbody">Thats what I want. please search the source code for me !!
<br/>
<br/>
Thanks, Thomas</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#56740 - crossraleigh - Tue Oct 11, 2005 12:12 am</h4>
    <div class="postbody"><span class="postbody">It looks like quickcup is describing the way to do it in DevKitAdvance. If you are using devkitARM, libgba will handle the dirty work for you. <a class="postlink" href="http://devkitpro.sourceforge.net/onlinedocs/libgba/a00031.html" target="_blank">Documentation</a> is available. Here is an (untested) example:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void my_interrupt_function()
<br/>
{
<br/>
   // ...
<br/>
}
<br/>
<br/>
int main()
<br/>
{
<br/>
   InitInterrupt();
<br/>
   SetInterrupt(Int_Timer0, my_interrupt_function);
<br/>
   EnableInterrupt(Int_Timer0);
<br/>
   REG_IME = 1;
<br/>
<br/>
   for(;;);
<br/>
<br/>
   return 0;
<br/>
}
<br/>
</td> </tr></table><span class="postbody"><br/>_________________<br/>My world is black and white, but if I blink fast enough, I see it in grayscale.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#57233 - Tomik - Fri Oct 14, 2005 1:42 pm</h4>
    <div class="postbody"><span class="postbody">why doesn?t this jump to my ISR ??
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">u32 ISR(int *yArr);            // Interrupt Service Routine
<br/>
<br/>
int main(void)
<br/>
{   SetMode(MODE_4 | BG2_ENABLE );      // set mode 4
<br/>
   
<br/>
   REG_IME = 0x00;                  // disable all interrupts
<br/>
<br/>
   REG_INTERRUPT = (u32)ISR(yArr);      // point Function (ISR) to Interrupt register   
<br/>
<br/>
   REG_IE = 0x60;
<br/>
<br/>
   REG_TM2D   = 0xFFFF-0x170;         // 368=0x170 ticks is 20ms = 44.5 Hz for xValue shifting
<br/>
   REG_TM2CNT = TM_ON | TM_FREQ_1024;   // Timer enable | 1024 cycle timer (16.xxMHz) -&gt; 61.04us / 16.384kHz
<br/>
   REG_TM3CNT = TM_ON | TM_CASCADE;
<br/>
   EraseScreen();
<br/>
   Logo();
<br/>
   WaitForVblank();
<br/>
   Flip();
<br/>
   Sleep(100);      
<br/>
REG_IME = 0x01;                  // enable all interrupts
<br/>
<br/>
   while(1);
<br/>
}  
<br/>
<br/>
u32 ISR(int *yArr)
<br/>
{
<br/>
   u16 xAxisShift=REG_TM3D; 
<br/>
<br/>
   if(REG_TM3D != xAxisShift) 
<br/>
   { // do something   
<br/>
   xAxisShift= REG_TM3D; 
<br/>
   }
<br/>
   return(0);
<br/>
}
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#57241 - Cearn - Fri Oct 14, 2005 2:37 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Tomik wrote:</b></span></td> </tr> <tr> <td class="quote">why doesn?t this jump to my ISR ??
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">u32 ISR(int *yArr);            // Interrupt Service Routine
<br/>
<br/>
int main(void)
<br/>
{   SetMode(MODE_4 | BG2_ENABLE );      // set mode 4
<br/>
   
<br/>
   REG_IME = 0x00;                  // disable all interrupts
<br/>
<br/>
   REG_INTERRUPT = (u32)ISR(yArr);      // point Function (ISR) to Interrupt register   
<br/>
<br/>
   REG_IE = 0x60;
<br/>
<br/>
   REG_TM2D   = 0xFFFF-0x170;         // 368=0x170 ticks is 20ms = 44.5 Hz for xValue shifting
<br/>
   REG_TM2CNT = TM_ON | TM_FREQ_1024;   // Timer enable | 1024 cycle timer (16.xxMHz) -&gt; 61.04us / 16.384kHz
<br/>
   REG_TM3CNT = TM_ON | TM_CASCADE;
<br/>
   EraseScreen();
<br/>
   Logo();
<br/>
   WaitForVblank();
<br/>
   Flip();
<br/>
   Sleep(100);      
<br/>
REG_IME = 0x01;                  // enable all interrupts
<br/>
<br/>
   while(1);
<br/>
}  
<br/>
<br/>
u32 ISR(int *yArr)
<br/>
{
<br/>
   u16 xAxisShift=REG_TM3D; 
<br/>
<br/>
   if(REG_TM3D != xAxisShift) 
<br/>
   { // do something   
<br/>
   xAxisShift= REG_TM3D; 
<br/>
   }
<br/>
   return(0);
<br/>
}
<br/>
</td> </tr></table><span class="postbody"></span></td> </tr></table><span class="postbody">
<br/>
<br/>
There are many reasons why this won't work
<br/>
<br/>
First of all, isrs don't take arguments or return values. While that doesn't 
<br/>
doesn't mean the couldn't run, they wouldn't do what you'd expect them to do.
<br/>
Secondly, the function that REG_INTERRUPT ( that's 0300:7FFC, right? (or 03FF:FFFC) ) must be ARM code. I suspect that you're using THUMB code for the main file (which you should), so the program would lock up on reaching the isr.
<br/>
Thirdly, while you set REG_IE to catch interrupts, you also need to set different registers to <span style="font-style: italic">fire</span> them. For timers, that's REG_TMxCNT, bit 6.
<br/>
Finally, you also need to acknowledge you've dealt with the interrupt. You do this by setting the appropriate bit in REG_IE while in your isr.
<br/>
<br/>
tonc: <a class="postlink" href="http://user.chem.tue.nl/jakvijn/tonc/interrupts.htm" target="_blank">interrupts</a>, <a class="postlink" href="http://user.chem.tue.nl/jakvijn/tonc/timers.htm" target="_blank">timers</a>. 
<br/>
gbatek: <a class="postlink" href="http://nocash.emubase.de/gbatek.htm#interruptcontrol" target="_blank">interrupts</a>, <a class="postlink" href="http://nocash.emubase.de/gbatek.htm#timers" target="_blank">timers</a>.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#57600 - Tomik - Mon Oct 17, 2005 7:52 am</h4>
    <div class="postbody"><span class="postbody">Thanks, thats why I put it in Beginners !
<br/>
I never did something with interrupts ...
<br/>
... I made everything with the help from <a href="http://www.jharbour.com/gameboy/default.aspx" target="_blank">www.jharbour.com/gameboy/default.aspx</a> and that says I can handle the ISR as a function in C/C++ !! What do you think ??
<br/>
<br/>
Thomas</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#57606 - Tomik - Mon Oct 17, 2005 9:55 am</h4>
    <div class="postbody"><span class="postbody">I read the TONC stuff: it says if I have only one interrupt I dont need ASM !!  Thats right or what is the diff between:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">main
<br/>
{
<br/>
 while(1);
<br/>
}
<br/>
<br/>
ISR{};</td> </tr></table><span class="postbody">
<br/>
<br/>
and 
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
main
<br/>
{
<br/>
 while(1)
<br/>
 {
<br/>
  ISR();
<br/>
 }
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
So i can make the ISR code in C/C++ ... 
<br/>
... will check the other reasons ! Fire interrupt .. etc
<br/>
<br/>
Thomas</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#57607 - Cearn - Mon Oct 17, 2005 10:10 am</h4>
    <div class="postbody"><span class="postbody">Technically, you don't need asm for interrupts, no. Not even for multiple interrupts, actually. I think <a class="postlink" href="http://www.pineight.com/gba/#tod" target="_blank">Tetanus on Drugs]</a> uses multiple interrupts in C, but I may be wrong. However, asm will allow faster interrupts, and you don't have to muck with compiler switches to create ARM code for the main isr.
<br/>
<br/>
The difference between 
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Tomik wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">main() 
<br/>
{ 
<br/>
 while(1); 
<br/>
} 
<br/>
<br/>
ISR{}; </td> </tr></table><span class="postbody">and 
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">main() 
<br/>
{ 
<br/>
 while(1) 
<br/>
 { 
<br/>
  ISR(); 
<br/>
 } 
<br/>
} 
<br/>
</td> </tr></table><span class="postbody"></span></td> </tr></table><span class="postbody">is that in the latter, the ISR() function is just part of the main code flow and so it's really an interrupt (it doesn't interrupt anything after all). An interrupt routine is something that happens outside the normal program, to be called by the OS/BIOS/hardware, only only under certain conditions. An interrupt stops the regular program to do something else for a while, and can do so at any time, no matter what the <span style="font-style: italic">real</span> program is currently doing.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#57609 - Tomik - Mon Oct 17, 2005 10:54 am</h4>
    <div class="postbody"><span class="postbody">that is correct, but in this case there is no other programm !
<br/>
in the wihle() ist only the ISR !! so if the ISR-Function is not longer as the Interrupt fire...  it should be the same function ....
<br/>
<br/>
thanks for your help, I?ll check it out ;)
<br/>
<br/>
Viele gruesse an unsere niederlaendischen freunde .. aus hamburg, der stadt in der "van der vaart" lebt, super spielt und am samstag die rote karte bekommen hat ...
<br/>
<br/>
Thomas</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
