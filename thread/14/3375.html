<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>DevkitARM_r6 and Jeff's LnkScript/crt0.s - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>Beginners > DevkitARM_r6 and Jeff's LnkScript/crt0.s</h2>
<div id="posts">
<div class="post">
    <h4>#20429 - NitroSR - Tue May 11, 2004 5:43 am</h4>
    <div class="postbody"><span class="postbody">I am experimenting with WinterMute's DevkitARM and Jeff's Lnkscript/crt0.s files.  Things are working relatively smooth, until I try to compile my test.c file with the -mthumb option turned on.  Doing so causes my emulator to freeze requiring me to kill the process.  The test.c isn't doing much more than writing some test values to EWRAM so I can make sure it's doing anything, so i don't think it's important.  I have included a copy of the makefile, however.
<br/>
<br/>
What could be causing this freezing?  Have I missed something?
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
<br/>
PREFIX = arm-elf-
<br/>
GCC     = $(PREFIX)gcc
<br/>
AS      = $(PREFIX)as
<br/>
LD      = $(PREFIX)ld
<br/>
OBJCOPY = $(PREFIX)objcopy
<br/>
<br/>
CFLAGS  = -O2 -mthumb-interwork -mthumb
<br/>
LDFLAGS = -T lnkscript
<br/>
ASFLAGS = -mthumb-interwork
<br/>
<br/>
all: test.gba
<br/>
<br/>
crt0.o: crt0.s
<br/>
   $(AS) $(ASFLAGS) crt0.s -o crt0.o
<br/>
<br/>
test.o: test.c
<br/>
   $(GCC) $(CFLAGS) -c test.c -o test.o
<br/>
<br/>
test.elf: test.o crt0.o
<br/>
   $(LD) $(LDFLAGS) test.o crt0.o -o test.elf
<br/>
<br/>
test.gba: test.elf
<br/>
   $(OBJCOPY) -O binary test.elf test.gba
<br/>
<br/>
clean:
<br/>
   rm *.o
<br/>
   rm *.elf
<br/>
   rm *.gba
<br/>
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#20434 - Cearn - Tue May 11, 2004 8:35 am</h4>
    <div class="postbody"><span class="postbody">Have you tried adding -mthumb-interwork -mthumb to the LDFLAGS? For some reason that worked in my case. Also, it might help to put ctr0.o first in the list of the to-link objects; it is boot code after all.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#20446 - NitroSR - Tue May 11, 2004 3:37 pm</h4>
    <div class="postbody"><span class="postbody">It appears as if changing the order of the .o files has resolved the issue.  Apparently the linker priorities based on architecture and thus did not give me any problem with order before.
<br/>
<br/>
Thanks.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#20509 - Dracula-X - Wed May 12, 2004 9:18 am</h4>
    <div class="postbody"><span class="postbody">If I'm not mistaken (you'll have to check with Wintermute) there is some sort of problem using jeff's bog standard crt0. The default crt0's in DevkitARM are proper for the gba.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#20517 - creepy - Wed May 12, 2004 12:43 pm</h4>
    <div class="postbody"><span class="postbody">I had the same problem. Switching the order of the .o files (crt0.o first) also solved the problem. 
<br/>
<br/>
But shouldn't the lnkscript link the crt0.o in? Will try that this evening.
<br/>
<br/>
Another problem I have with this devkit is that I can't link in the standard libs (de math lib in this case). A -lm added to the linker options (and using math.h in the source) gives me a lot of warning messages about the math libs not compiled with thumb-interworking.
<br/>
Disabling thumb-interworking for my object files and crt0.o gives complaints about the crt0.o not being compiled with thumb-interworking.
<br/>
My other devkit (compiled from source with a makefile from <a href="http://www.geocities.com/xgoatboyx/index.html" target="_blank">http://www.geocities.com/xgoatboyx/index.html</a> ) I use in Linux does not have this problem..
<br/>
<br/>
Btw, can the devkitarm_r6 be used without a linkscript or extra crt0.o in Linux? Most of the tutorials use a make.bat which only compiles and links the object files. No references to a lnkscript or crt0.o/s are given. I can confirm that this does not work in Linux with the devkitarm_r6 and my other devkit. In both cases I use Jeff's crt0.s and lnkscript</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#20519 - Cearn - Wed May 12, 2004 1:51 pm</h4>
    <div class="postbody"><span class="postbody">AFAIK the linkscript just links together what you give to it. Whether or not this includes crt0.o depends mainly on whether you invoke <span style="font-weight: bold">ld</span> directly or not. If you use <span style="font-weight: bold">gcc</span>, it'll link standard libs automatically, as well as crt0.o ... unless you use the <span style="font-weight: bold">-nostartfiles</span> option. When using <span style="font-weight: bold">ld</span> directly, you have to write down everything yourself. At least that's how devkit Advance uses it; for devkitARM you need to use <span style="font-weight: bold">-specs=gba.specs</span> or <span style="font-weight: bold">-specs=gba_mb.specs</span> for multiboot programs to link crt0.o into your binary.
<br/>
<br/>
About thumb-interworking:
<br/>
You need this flag to get ARM code to work with THUMB code properly. I'm not exactly sure what can go wrong if you omit it, but using the flag seems to be the Right Thing (TM) to do, so you'd better use it. The reason you don't get many complains from, say, devkit Advance about this is probably because it has all the libraries and boot-files in <span style="font-style: italic">quadruplet</span>!! to account for all possible cases. I can't check right now, but I think devkitARM only has one.
<br/>
<br/>
The standalone crt0.o and lnkscript are usually only used for interrupt support, which in turned off in the default crt0.o. devkitARM uses a different solution to interrupt support, namely a separate interrupt handler (single_ints.s), which can be assembled and linked to the project without messing with crt0.S. It's included in the libgba that you can find in the samples section on devkitARM's homepage. 
<br/>
So with devkitARM there's never any real need to use a separate crt0.o and linkscript, the default (and thus unmentioned) ones will do fine. All you really need to do is use the -specs flags I mentioned earlier (and <span style="font-weight: bold">-mthumb-interwork</span>). At least, that's ow it works on Windows, don't see why the Linux case would be different here.
<br/>
<br/>
Btw, <a class="postlink" href="http://forum.gbadev.org/viewtopic.php?t=2929" target="_blank">http://forum.gbadev.org/viewtopic.php?t=2929</a> is a similar topic to this one, I suggest reading it as well if you haven't already.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#20522 - creepy - Wed May 12, 2004 2:08 pm</h4>
    <div class="postbody"><span class="postbody">Ah, so if I use the -specs option it'll be fine. I could not find this information on <a href="http://www.devkit.tk." target="_blank">www.devkit.tk.</a>
<br/>
<br/>
Also using gcc directly to compile and link my source did not work here without libdga. I didn't want to use that lib.
<br/>
<br/>
I'll try using the -specs option and see if that'll work.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#20524 - Cearn - Wed May 12, 2004 2:35 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>creepy wrote:</b></span></td> </tr> <tr> <td class="quote">I could not find this information on <a href="http://www.devkit.tk." target="_blank">www.devkit.tk.</a> </td> </tr></table><span class="postbody">
<br/>
I know what you mean. The only place it's mentioned right now is in the makefiles of the samples.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#20544 - creepy - Wed May 12, 2004 9:22 pm</h4>
    <div class="postbody"><span class="postbody">Hmm.. great. All examples are written for Windows and use absolute paths. 
<br/>
<br/>
When using the -specs=gba.specs options it complain about not finding an entry symbol
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
arm-elf-ld: warning: cannot find entry symbol cs=gba.specs; defaulting to 00008000
<br/>
</td> </tr></table><span class="postbody">
<br/>
Afcourse the resulting file cannot be used.
<br/>
<br/>
The Makefile I use:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
PREFIX =  arm-elf-
<br/>
GCC     = $(PREFIX)gcc
<br/>
AS      = $(PREFIX)as
<br/>
LD      = $(PREFIX)ld
<br/>
OBJCOPY = $(PREFIX)objcopy
<br/>
                                                                                
<br/>
CFLAGS  = -Wall -O2 -mthumb -mthumb-interwork -mcpu=arm7tdmi -mtune=arm7tdmi
<br/>
LDFLAGS = -specs=gba.specs
<br/>
                                                                                
<br/>
all: test.gba
<br/>
                                                                                
<br/>
.c.o:
<br/>
        $(GCC) $(CFLAGS) -c $&lt;
<br/>
                                                                                
<br/>
test.elf: test.o
<br/>
        $(LD) $(LDFLAGS) test.o -o test.elf
<br/>
                                                                                
<br/>
test.gba: test.elf
<br/>
        $(OBJCOPY) -O binary test.elf test.gba
<br/>
                                                                                
<br/>
clean:
<br/>
        @rm *.o *.elf *.gba
<br/>
</td> </tr></table><span class="postbody">
<br/>
Using crt0.s and lnkscript from Jeff seems to work fine here though, dispite the mentioned troubles with it and this devkit. Haven't tested it with interrupts though.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#20546 - Cearn - Wed May 12, 2004 9:46 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>creepy wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
arm-elf-ld: warning: cannot find entry symbol cs=gba.specs; defaulting to 00008000
<br/>
</td> </tr></table><span class="postbody">
<br/>
Strange that it shouldn't work. Even stranger is that it complains about "cs=gba.specs" and not "specs=gba.specs", as if the "spe" got snipped off somehow.
<br/>
Anyway, what happens if you also include the interworking flag? Or compile with gcc instead of ld? It could be that you also need to set some paths when you use ld.
<br/>
<br/>
I have been able to get a working compile with something like
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
arm-elf-gcc -mthumb-interwork -c first.c
<br/>
arm-elf-gcc -specs=gba.specs -mthumb-interwork -o first.elf first.o
<br/>
arm-elf-objcopy -O binary first.elf first.gba
<br/>
</td> </tr></table><span class="postbody">
<br/>
I'll try if I can break it to reproduce your error.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#20548 - wintermute - Wed May 12, 2004 11:03 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>creepy wrote:</b></span></td> </tr> <tr> <td class="quote">Hmm.. great. All examples are written for Windows and use absolute paths. </td> </tr></table><span class="postbody">
<br/>
<br/>
actually they're not written for windows, the examples will work quite happily in linux if the paths are changed to suit your installation. Absolute paths are used in the makefiles to allow building to take place outside the source directory.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
When using the -specs=gba.specs options it complain about not finding an entry symbol
<br/>
arm-elf-ld: warning: cannot find entry symbol cs=gba.specs; defaulting to 00008000
<br/>
Afcourse the resulting file cannot be used.
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Don't call arm-elf-ld directly use arm-elf-gcc to link. -specs is a gcc switch and doesn't work with ld. Never use ld directly, gcc sets a lot of options which are needed to find libraries. You should also be passing the -mthumb &amp; -mthumb-interwork flags to the linker at this point. These switches tell gcc which set of libraries to link against, it will default to -marm.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
PREFIX =  arm-elf-
<br/>
GCC     = $(PREFIX)gcc
<br/>
AS      = $(PREFIX)as
<br/>
LD      = $(PREFIX)ld     &lt;----- change this to gcc
<br/>
OBJCOPY = $(PREFIX)objcopy
<br/>
                                                                                
<br/>
CFLAGS  = -Wall -O2 -mthumb -mthumb-interwork -mcpu=arm7tdmi -mtune=arm7tdmi
<br/>
LDFLAGS = -specs=gba.specs   &lt;----- add -mthumb -mthumb-interwork here too
<br/>
                                                                                
<br/>
all: test.gba
<br/>
                                                                                
<br/>
.c.o:
<br/>
        $(GCC) $(CFLAGS) -c $&lt;
<br/>
                                                                                
<br/>
test.elf: test.o
<br/>
        $(LD) $(LDFLAGS) test.o -o test.elf
<br/>
                                                                                
<br/>
test.gba: test.elf
<br/>
        $(OBJCOPY) -O binary test.elf test.gba
<br/>
                                                                                
<br/>
clean:
<br/>
        @rm *.o *.elf *.gba
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
Using crt0.s and lnkscript from Jeff seems to work fine here though, dispite the mentioned troubles with it and this devkit. Haven't tested it with interrupts though.</td> </tr></table><span class="postbody">
<br/>
<br/>
the most recent version of devkitARM doesn't have trouble - that was one of the reasons for reverting from binutils 2.15.
<br/>
<br/>
It would have been helpful if you'd directed your questions to the devkitARM mailing list - <a href="http://groups.yahoo.com/group/devkitARM/" target="_blank">http://groups.yahoo.com/group/devkitARM/</a>
<br/>
<br/>
and no, you don't have to have a yahoo account to use the list - read the about page on devkit.tk :)
<br/>
<br/>
edit: aha I see you did - I'll answer there too</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#20575 - creepy - Thu May 13, 2004 8:49 am</h4>
    <div class="postbody"><span class="postbody">Ah, so thats it. Just call gcc to link instead of ld. Thanx.
<br/>
<br/>
Compiling and linking works like a charm now. I'll have to be back @ home to see if the rom works, but I expect that is does.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
