<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Animation Timing - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>Beginners > Animation Timing</h2>
<div id="posts">
<div class="post">
    <h4>#170213 - Azenris - Tue Sep 08, 2009 8:45 pm</h4>
    <div class="postbody"><span class="postbody">Hi,
<br/>
<br/>
I was running a search for animation timing, but I cant seem to dig much up on it, which is weird considering I remember reading something about it on these forums a while back.
<br/>
<br/>
Back when I first made a GBA game I just used my loop cycle, but I want to do it in a better way now.
<br/>
<br/>
Basically I was wonder if you could point me in the direction of any information regarding animation timings for the NDS.
<br/>
<br/>
TY for any help<br/>_________________<br/><a class="postlink" href="http://sacredpotion.blogspot.com/" target="_blank"><span style="color: red">My Homebrew Games</span></a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170216 - gauauu - Tue Sep 08, 2009 10:21 pm</h4>
    <div class="postbody"><span class="postbody">Not sure exactly what you're looking for here.  
<br/>
<br/>
For in-game animations of things like sprites, it makes sense to have each frame of animation last for a certain amount of in-game frames, which are generally synced up with vblank (either 1 vblank per frame, or 2, which makes it 30 fps).
<br/>
<br/>
I could elaborate on that, but it sounds like that's not what you are looking for?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170217 - Azenris - Tue Sep 08, 2009 11:40 pm</h4>
    <div class="postbody"><span class="postbody">So your saying just update the frame every 2 calls to my sprite update (as thats 2 swiWaitForVBlank() calls)
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
void CGame::Run(void)
<br/>
{
<br/>
   m_pScreenManager-&gt;LoadLevel(0);
<br/>
<br/>
   while (m_running)
<br/>
   {
<br/>
      // update the screen manager
<br/>
      m_pScreenManager-&gt;Update();
<br/>
<br/>
      // update the sprite manager
<br/>
      m_pSpriteManager-&gt;Update();
<br/>
<br/>
      // wait for the V blank
<br/>
      swiWaitForVBlank();
<br/>
   }
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
And that wouldnt cause me problems? I just though animation should be based on timers or something. I dunno, guess Ill experiment and see.<br/>_________________<br/><a class="postlink" href="http://sacredpotion.blogspot.com/" target="_blank"><span style="color: red">My Homebrew Games</span></a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170218 - headspin - Tue Sep 08, 2009 11:59 pm</h4>
    <div class="postbody"><span class="postbody">I use a timer to keep track of the milliseconds and do animation based on elapsed time.
<br/>
<br/>
ie. Setup a timer for keeping track of milliseconds
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">TIMER2_DATA = (u16) TIMER_FREQ(1000);
<br/>
TIMER2_CR = (TIMER_ENABLE | TIMER_IRQ_REQ | TIMER_DIV_1);</td> </tr></table><span class="postbody">
<br/>
<br/>
Then in your main loop call an "Update" method to update the current animation.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void Update(int elapsedTime)
<br/>
{
<br/>
   m_lastUpdate += elapsedTime;
<br/>
   
<br/>
   if(m_lastUpdate &gt; 100) // 100 milliseoncds
<br/>
   {
<br/>
      m_lastUpdate = 0;
<br/>
      
<br/>
      // Do animation
<br/>
   }
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
Obviously you need to keep track of the current frame and move the frame forward each call and then also have a "Draw" method based on the current frame.
<br/>
<br/>
Also consider having a "pingpong" type boolean value which allows you to go forward and back through frames instead of just forward. And perhaps consider the use of rand() for jumping to random frames.<br/>_________________<br/><a class="postlink" href="http://headsoft.com.au/index.php?category=warhawk" target="_blank">Warhawk DS</a> | <a class="postlink" href="http://headsoft.com.au/index.php?category=mmll" target="_blank">Manic Miner: The Lost Levels</a> | <a class="postlink" href="http://headsoft.com.au/index.php?category=tdg" target="_blank">The Detective Game</a></span><span class="gensmall"><br/><br/>Last edited by headspin on Wed Sep 09, 2009 2:26 am; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#170219 - DekuTree64 - Wed Sep 09, 2009 12:30 am</h4>
    <div class="postbody"><span class="postbody">I prefer animation based on multiples of the game's frame rate (and consequently, I prefer fixed frame rate games). So you just have a delay counter, decrement it once per frame, and when it hits 0, go to the next frame and reset the delay.
<br/>
<br/>
It's not so friendly on PC games (something I'm debating on my current project) since CRTs are usually flickery at 60Hz so it's better to run at 75-85Hz, which doesn't time out well with a 30fps game... at least my LCD is 60Hz though.
<br/>
<br/>
It also has the problem that there's a huge difference between a delay of 1 and a delay of 2, so sometimes it's hard to avoid things like feet looking like they're sliding on the ground due to stride length versus movement speed.
<br/>
<br/>
But for variable frame rate, something like headspin's timer setup is the way to go. Then use an accumulator sort of thing to update the animation:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void Animation::update(int timeElapsed)
<br/>
{
<br/>
    mTimer += timeElapsed;
<br/>
    while(mTimer &gt;= mDelay)
<br/>
    {
<br/>
        mTimer -= mDelay;
<br/>
        if (++mFrame &gt;= mFrameCount)
<br/>
            mFrame = 0;
<br/>
    }
<br/>
}</td> </tr></table><span class="postbody">
<br/>
Plus you can use mTimer for interpolation between frames if you're doing 3D or vector based graphics.<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170220 - gauauu - Wed Sep 09, 2009 4:40 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Azenris wrote:</b></span></td> </tr> <tr> <td class="quote">So your saying just update the frame every 2 calls to my sprite update (as thats 2 swiWaitForVBlank() calls)</td> </tr></table><span class="postbody">
<br/>
<br/>
Nope, that's not it.  
<br/>
<br/>
First, there are 2 different things with similar terminology, which makes things confusing:  game frames, and animation frames.  A game frame is one time through the main game loop.  And THIS is generally tied to vblank.  Either after each main game loop, swiWaitForVBlank is called (one game frame per vblank) or two vblanks occur for each time through the game loop.
<br/>
<br/>
So one way of timing animations is by saying that each frame of animation lasts, for example, x number of game frames.  In that case, you increment a counter with each game loop, and when it gets to a certain point, you go to the next frame of animation.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
void mainLoop()
<br/>
{
<br/>
    while(1)
<br/>
    {
<br/>
        updateGameLogic();
<br/>
        updateSpriteAnimation(animation);
<br/>
        swiWaitForVBlank();
<br/>
    }
<br/>
}
<br/>
<br/>
void updateSpriteAnimation(Animation * animation)
<br/>
{
<br/>
    animation-&gt;frameCounter++;
<br/>
    if (animation-&gt;frameCounter &gt; animation-&gt;animationDelay)
<br/>
    {
<br/>
        animation-&gt;goToNextAnimationFrame();
<br/>
    }
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
That's way oversimplified, but hopefully you get the drift.  And maybe that's what you're saying you already did and want something more advanced?  
<br/>
<br/>
In this case the animation structure should have all the "brains" of the animation -- what is the next frame, how long to stay on each frame, etc.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170222 - sverx - Wed Sep 09, 2009 8:21 am</h4>
    <div class="postbody"><span class="postbody">IMHO the way to go for a 2D NDS game (maybe it's different with 3D, it is surely different if you're coding a game for a PC) is to calculate everything in screen native FPS, or a fraction (/2, /3, /4 ...)
<br/>
<br/>
So your game will run at 60 frames per second (and what's on screen can change every frame) or a 30 FPS (what's on screen can change every 2 frames) or 20 FPS, or 15 FPS (well, I wouldn't go so slow... ;) )
<br/>
<br/>
Btw if you've got sprite animations with different frame rate (why not? maybe your hero has a very smooth animation and some simple enemies have simple animation...) then you've got to remember that sometimes you've got to show the same frame for the sprite twice or three times...
<br/>
<br/>
Hope you get what I mean...
<br/>
<br/>
Oh, right. Everything should be timed with swiWaitForVBlank() , also because of battery saving reasons.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170224 - Miked0801 - Wed Sep 09, 2009 5:37 pm</h4>
    <div class="postbody"><span class="postbody">Keep in mind you can use fixed point numbers to get fractional animation timings.  Basically, add a fixed point value to your frame every tic and then use the truncated value for the frame to display.  This gets you a lot more control.  It's trivial to do a 1/2/1/2 type timing with this or even frame skip if needed.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170225 - Azenris - Wed Sep 09, 2009 5:46 pm</h4>
    <div class="postbody"><span class="postbody">I went with the using the games fixed fps. Atm its being used for my tile animations (water tiles, convayer belts etc). Will get around to sprite animation soon.
<br/>
<br/>
Thanks for all the info.
<br/>
<br/>
It currently stands at
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
void CScreenManager::Update(void)
<br/>
{
<br/>
   for (int tile = 0; tile &lt; TILES_PER_LEVEL; ++tile)                     // loop all the tiles on the screen
<br/>
   {
<br/>
      if (m_data[tile].tileID != 0)                                 // check its not an empty location
<br/>
      {
<br/>
         const TILE_DATA *pTile = g_pGame-&gt;GetTileData(m_data[tile].tileID);   // locate data on this tile
<br/>
<br/>
         if (pTile-&gt;aniFrames &gt; 1)                                 // check if the tile is animated
<br/>
         {
<br/>
            ++m_data[tile].frameCounter;                           // increase the frame counter
<br/>
<br/>
            if (m_data[tile].frameCounter &gt; pTile-&gt;delay)               // check if the frame needs updating yet
<br/>
            {   
<br/>
               m_data[tile].frameCounter = 0;                        // reset the frame counter
<br/>
<br/>
               if (m_data[tile].frame &gt;= (pTile-&gt;aniFrames - 1))         // update the frame
<br/>
                  m_data[tile].frame = 0;                           // loop the frame to start if needed
<br/>
               else
<br/>
                  ++m_data[tile].frame;                           // increase the frame by 1
<br/>
   
<br/>
               UpdateFrame(tile, m_data[tile].tileID, m_data[tile].frame);   // update the image being displayed
<br/>
            }
<br/>
         }
<br/>
      }
<br/>
   }
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I do however intend to modify it slightly and instead of going through all the m_data, just have a list of animated only tiles, so I'll have less to loop.<br/>_________________<br/><a class="postlink" href="http://sacredpotion.blogspot.com/" target="_blank"><span style="color: red">My Homebrew Games</span></a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170229 - Azenris - Thu Sep 10, 2009 1:02 am</h4>
    <div class="postbody"><span class="postbody">Got my sprites animated now too. Only prob is in my design I cant have the same sprite using diff animation pictures! When I load sprites I only save 1 graphic image and have a reference count to it. For the animation im just changing that picture
<br/>
<br/>
I guess it doesnt matter for things like the cherries, they can just bob up and down together. Maybe I should have an option to load a sprite as special, for things I need running seperate.<br/>_________________<br/><a class="postlink" href="http://sacredpotion.blogspot.com/" target="_blank"><span style="color: red">My Homebrew Games</span></a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170233 - sverx - Thu Sep 10, 2009 10:28 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Miked0801 wrote:</b></span></td> </tr> <tr> <td class="quote">Keep in mind you can use fixed point numbers to get fractional animation timings.</td> </tr></table><span class="postbody">
<br/>
<br/>
Yep. Easy with 1/2 and 1/4, gets a little weird with 1/3, 1/5... ;)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170234 - Dwedit - Thu Sep 10, 2009 1:21 pm</h4>
    <div class="postbody"><span class="postbody">16.16 fixed point is accurate for integer division by 3 for numbers up to 32767, and is accurate for integer division by 5 for numbers up to 16383.
<br/>
<br/>
So that means you would need to add 1/3 32768 times before you see any fixed point rounding errors creeping into the integer part.<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170236 - sverx - Thu Sep 10, 2009 1:56 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Dwedit wrote:</b></span></td> </tr> <tr> <td class="quote">that means you would need to add 1/3 32768 times before you see any fixed point rounding errors creeping into the integer part.</td> </tr></table><span class="postbody">
<br/>
<br/>
True, but it means a 'frame skip' every 9 minutes and 6 seconds at 60 FPS. IMHO I woulnd't use that, I'd use a subcounter.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170246 - Miked0801 - Fri Sep 11, 2009 2:41 pm</h4>
    <div class="postbody"><span class="postbody">Lol - IMHO, a frame skip once every 30 seconds wouldn't be noticable :)
<br/>
<br/>
Subcounter is is basically taking the fractional portion of the fixed and manually setting the values.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
