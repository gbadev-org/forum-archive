<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>No difference in speed when code put in iwram - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>Beginners > No difference in speed when code put in iwram</h2>
<div id="posts">
<div class="post">
    <h4>#19529 - alek - Wed Apr 21, 2004 3:05 pm</h4>
    <div class="postbody"><span class="postbody">I have the sqrt rotine written by KevinW. I've changed it so I can assemble it in GAS. My question is when I write .section iwram is the code put in iwram and if that's the case why doesn't it go faster on hardware.
<br/>
<br/>
here is how I have written it.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
.code 32
<br/>
.section .iwram
<br/>
.align
<br/>
.Global isqr      
<br/>
@ Entry
<br/>
isqr:
<br/>
the function...
<br/>
</td> </tr></table><span class="postbody">
<br/>
If I remove .code 32 and .section .iwram the program doesn't execute slower on hardware. This function is called a lot so why is this.
<br/>
<br/>
Second qustion
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
@ Rounding
<br/>
   IF :DEF:USE_ROUNDING
<br/>
   CMP     r0,r2
<br/>
   ADC     r2,r2,#1
<br/>
   ENDIF
<br/>
</td> </tr></table><span class="postbody">
<br/>
This code is in the same sqrt function. I get the folloiwng errors when I compile my project if I don't remove it
<br/>
<br/>
isqr.s:101: Error: bad instruction `use_rounding'
<br/>
isqr.s:104: Error: bad instruction `endif'
<br/>
<br/>
What should I do?
<br/>
<br/>
Thankfull for any response,</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#19531 - poslundc - Wed Apr 21, 2004 4:08 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>alek wrote:</b></span></td> </tr> <tr> <td class="quote">If I remove .code 32 and .section .iwram the program doesn't execute slower on hardware. This function is called a lot so why is this.</td> </tr></table><span class="postbody">
<br/>
<br/>
Just because a function is called a lot doesn't mean you're necessarily going to tap out the GBA's resources during the VDraw/VBlank period. I could divide using GCC's built-in divide routine if I wanted to instead of a faster, custom method and it wouldn't make any visible difference so long as my program can still keep up with 60 FPS. Do you know for a fact that the <span style="font-style: italic">routine</span> isn't executing any faster on hardware?
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">This code is in the same sqrt function. I get the folloiwng errors when I compile my project if I don't remove it
<br/>
<br/>
isqr.s:101: Error: bad instruction `use_rounding'
<br/>
isqr.s:104: Error: bad instruction `endif'
<br/>
<br/>
What should I do?</td> </tr></table><span class="postbody">
<br/>
<br/>
Either convert the Goldroad directives to their GAS equivalents, or take it out and don't round your results, or leave it in but take out the first and fourth lines to round your results.
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#19534 - tepples - Wed Apr 21, 2004 5:12 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>poslundc wrote:</b></span></td> </tr> <tr> <td class="quote">I could divide using GCC's built-in divide routine if I wanted to instead of a faster, custom method and it wouldn't make any visible difference so long as my program can still keep up with 60 FPS.</td> </tr></table><span class="postbody">
<br/>
More efficient code is nicer on the battery. Code run from RAM is also nicer on the battery.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>alek wrote:</b></span></td> </tr> <tr> <td class="quote">isqr.s:101: Error: bad instruction `use_rounding'
<br/>
isqr.s:104: Error: bad instruction `endif'
<br/>
<br/>
What should I do?</td> </tr></table><span class="postbody">
<br/>
Either convert the Goldroad directives to their GAS equivalents</span></td> </tr></table><span class="postbody">
<br/>
Specifically, you have to rename isqr.s to isqr.S (the capital triggers use of the C preprocessor, which handles #ifdef) and change the conditional lines:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">@ Rounding
<br/>
#ifdef USE_ROUNDING
<br/>
   CMP     r0,r2
<br/>
   ADC     r2,r2,#1
<br/>
#endif
<br/>
</td> </tr></table><span class="postbody"><br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#19553 - alek - Wed Apr 21, 2004 9:09 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>poslundc wrote:</b></span></td> </tr> <tr> <td class="quote">Just because a function is called a lot doesn't mean you're necessarily going to tap out the GBA's resources during the VDraw/VBlank period. I could divide using GCC's built-in divide routine if I wanted to instead of a faster, custom method and it wouldn't make any visible difference so long as my program can still keep up with 60 FPS. Do you know for a fact that the <span style="font-style: italic">routine</span> isn't executing any faster on hardware?</td> </tr></table><span class="postbody">
<br/>
<br/>
Yeah, you are right the program was running in 60fps... I'm doing a three-body problem solver and it was the step size in my Runge-Kutta4 that fooled me...
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tepples wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
Specifically, you have to rename isqr.s to isqr.S (the capital triggers use of the C preprocessor, which handles #ifdef) and change the conditional lines: 
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code"> 
<br/>
@ Rounding 
<br/>
#ifdef USE_ROUNDING 
<br/>
   CMP     r0,r2 
<br/>
   ADC     r2,r2,#1 
<br/>
#endif 
<br/>
</td> </tr></table><span class="postbody">
<br/>
</span></td> </tr></table><span class="postbody">
<br/>
The project compiles now
<br/>
<br/>
Thanks for the help guys I really appreciate it</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#19580 - alek - Thu Apr 22, 2004 10:29 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>alek wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>poslundc wrote:</b></span></td> </tr> <tr> <td class="quote">Just because a function is called a lot doesn't mean you're necessarily going to tap out the GBA's resources during the VDraw/VBlank period. I could divide using GCC's built-in divide routine if I wanted to instead of a faster, custom method and it wouldn't make any visible difference so long as my program can still keep up with 60 FPS. Do you know for a fact that the <span style="font-style: italic">routine</span> isn't executing any faster on hardware?</td> </tr></table><span class="postbody">
<br/>
<br/>
Yeah, you are right the program was running in 60fps... I'm doing a three-body problem solver and it was the step size in my Runge-Kutta4 that fooled me...
<br/>
<br/>
</span></td> </tr></table><span class="postbody">
<br/>
<br/>
I tried it on hardware without the Wait for Vblank function and it runs in about 63fps independent of if I remove the .section .iwram and .code 32 or leave it in... The sqrt function gets called 12 times/loop. Shouldn't it make any difference?
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>isqr readme wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
It goes to show you how much you want to put key algorithms, and important loop code 
<br/>
as ARM in IWRAM as much as possible!
<br/>
<span style="font-weight: bold">If you try to run isqr() from ARM ROM it will be very slow for obvious technical reasons </span>(yet still faster then the BIOS function).
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#19587 - poslundc - Thu Apr 22, 2004 2:26 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tepples wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>poslundc wrote:</b></span></td> </tr> <tr> <td class="quote">I could divide using GCC's built-in divide routine if I wanted to instead of a faster, custom method and it wouldn't make any visible difference so long as my program can still keep up with 60 FPS.</td> </tr></table><span class="postbody">
<br/>
More efficient code is nicer on the battery. Code run from RAM is also nicer on the battery.</span></td> </tr></table><span class="postbody">
<br/>
<br/>
Oh, tepples, only you would visibly notice the battery draining slightly faster. :)
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Specifically, you have to rename isqr.s to isqr.S (the capital triggers use of the C preprocessor, which handles #ifdef) and change the conditional lines:
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">@ Rounding
<br/>
#ifdef USE_ROUNDING
<br/>
   CMP     r0,r2
<br/>
   ADC     r2,r2,#1
<br/>
#endif
<br/>
</td> </tr></table><span class="postbody"></span></td> </tr></table><span class="postbody">
<br/>
<br/>
If you prefer to use the GAS directives instead of the C pre-processor, it's just .ifdef and .endif instead.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">I tried it on hardware without the Wait for Vblank function and it runs in about 63fps independent of if I remove the .section .iwram and .code 32 or leave it in... The sqrt function gets called 12 times/loop. Shouldn't it make any difference?</td> </tr></table><span class="postbody">
<br/>
<br/>
Let's say your optimized square-root function takes 100 cycles, or 1,200 cycles per frame. Then for the sake of argument say that your unoptimized square-root function takes 300 cycles, or 3,600 cycles per frame.
<br/>
<br/>
The GBA has 280,896 cycles per frame. So unless you were within 2,400 cycles of this limit (ie. you were already consuming 99.1% of the CPU's resources before optimizing the square-root routine) you will not notice any visible speed change.
<br/>
<br/>
(Note that I've simplified these numbers for the sake of argument, and there are obviously VDraw/VBlank issues to consider as well.)
<br/>
<br/>
The point is that it may be making a difference by reducing the workload on the CPU, but it won't make your game's loop run any faster so long as you still cycle on the pattern of VDraw/VBlank every 1/60th of a second.
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#19594 - tepples - Thu Apr 22, 2004 4:30 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>poslundc wrote:</b></span></td> </tr> <tr> <td class="quote">Oh, tepples, only you would visibly notice the battery draining slightly faster. :)</td> </tr></table><span class="postbody">
<br/>
It's a LOT easier to notice battery drain on a GBA than on a GBC, especially if your GBA's batteries are at that point where the power light flashes green and red. But if you're really doing only about 12 square roots per frame, and you don't plan to add additional game objects that would need their own square roots, then you probably don't need to pay that much attention to optimizing out every last cycle.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#19611 - alek - Thu Apr 22, 2004 9:41 pm</h4>
    <div class="postbody"><span class="postbody">Ok, I think I understand now.
<br/>
<br/>
Thanks for the help... This forum is really a life saver =)</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
