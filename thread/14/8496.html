<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>another scrolling question - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>Beginners > another scrolling question</h2>
<div id="posts">
<div class="post">
    <h4>#70919 - ion - Thu Feb 09, 2006 3:53 pm</h4>
    <div class="postbody"><span class="postbody">Hi all,
<br/>
<br/>
Q1.
<br/>
Newbie to the game.  have a basic scrolling question.  I've loaded up 2 bgs and now I want to scroll ala parallax.  From looking around I've seen there are 2 ways a)scroll them different speeds and b)using HBlank.
<br/>
<br/>
I'm working on a college project , it's fairly basic.  I know you can use these methods but how would one go about it?
<br/>
<br/>
Q2.
<br/>
I've created a 16*16 sprite and converted with Usenti (hopefully with the right settings).  It's a basic example where I'm loading in the sprite and display it on the screen.
<br/>
I use this routine to use DMA (I know tonc says not to use it but it's just a basic sample so not too worried).  
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void DMAFastCopy(void* source, void* dest, u32 count, u32 mode)
<br/>
{
<br/>
   if (mode == DMA_16NOW || mode == DMA_32NOW)
<br/>
   {
<br/>
      REG_DMA3SAD = (unsigned int)source;
<br/>
      REG_DMA3DAD = (unsigned int)dest;
<br/>
      REG_DMA3CNT = count | mode;
<br/>
   }
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
I understand what mode means but what about count?  if my ship_1.c file contains this: 
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">const unsigned short ship_1Tiles[128]=
<br/>
{
<br/>
   0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
<br/>
   0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0xF300,0xF1F3,
<br/>
........}</td> </tr></table><span class="postbody">
<br/>
<br/>
then what count should I pass to the DMAFastCopy routine.  Likewise for a 256 color palette.  My backgrounds use the same routine and work fine.  The sprite is not displaying at all.
<br/>
<br/>
Q.3
<br/>
When converted with usenti I get a ship_1.h.  here are the contents.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#define ship_1PalLen 512
<br/>
extern const unsigned short ship_1Pal[256];
<br/>
<br/>
#define ship_1TilesLen 256
<br/>
extern const unsigned short ship_1Tiles[128];</td> </tr></table><span class="postbody">
<br/>
<br/>
Why is the ship tiles len define 256 and not 128? is that 256 bytes? why would I need to know that when I'm doing the copying with DMA in 16 or 32bit mode.
<br/>
<br/>
Thanks in advance guys.
<br/>
ION</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#70932 - ion - Thu Feb 09, 2006 4:22 pm</h4>
    <div class="postbody"><span class="postbody">alright well here's a picture of tile mem in VBA which clearly shows the ship tiles are there. maybe it's an OAM entry problem.. any ideas?
<br/>
<br/>
<a href="http://img216.imageshack.us/img216/413/shiptiles5br.png">[Images not permitted - Click here to view it]</a>
<br/>
<br/>
ION</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#70942 - ion - Thu Feb 09, 2006 4:50 pm</h4>
    <div class="postbody"><span class="postbody">oh man I'm such an eejit... I was forgetting to call update_oam() to copy oam to memory..  Oh well. any answers for the other questions?
<br/>
<br/>
ION</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#70955 - ScottLininger - Thu Feb 09, 2006 6:09 pm</h4>
    <div class="postbody"><span class="postbody">I'm not sure what questions you still have. Could you post again with just the questions remaining?
<br/>
<br/>
In general, I recommend getting your code working *without* DMA at first, with a simple FOR or WHILE loop to copy your data around. Then once that's working, you can turn on the DMA and help isolate any problems.
<br/>
<br/>
-Scott</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#70969 - Cearn - Thu Feb 09, 2006 8:26 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>ion wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#define ship_1PalLen 512
<br/>
extern const unsigned short ship_1Pal[256];
<br/>
<br/>
#define ship_1TilesLen 256
<br/>
extern const unsigned short ship_1Tiles[128];</td> </tr></table><span class="postbody"></span></td> </tr></table><span class="postbody">
<br/>
The size of an array depends on the number of array elements, <span style="font-style: italic">and</span> the size of a single element. A byte is, well 1, byte long, short is 2 bytes, int is 4 bytes. So if you have data of a given length, <span style="font-style: italic">n</span> bytes, you'll have <span style="font-style: italic">n</span> elements in a byte array, <span style="font-style: italic">n</span>/2 for a short array and <span style="font-style: italic">n</span>/4 for an int array. The <span style="font-style: italic">foo</span>Len #define always gives the number of bytes, but the array type of <span style="font-style: italic">foo</span> may change.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>ion wrote:</b></span></td> </tr> <tr> <td class="quote">I use this routine to use DMA (I know tonc says not to use it but it's just a basic sample so not too worried).
<br/>
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
void DMAFastCopy(void* source, void* dest, u32 count, u32 mode)
<br/>
{
<br/>
   if (mode == DMA_16NOW || mode == DMA_32NOW)
<br/>
   {
<br/>
      REG_DMA3SAD = (unsigned int)source;
<br/>
      REG_DMA3DAD = (unsigned int)dest;
<br/>
      REG_DMA3CNT = count | mode;
<br/>
   }
<br/>
}</td> </tr></table><span class="postbody"></span></td> </tr></table><span class="postbody">
<br/>
I think you may have misread, I'm fine with DMA (well, mostly: it can muck up interrupts so I use something else these days). Or maybe I wrote it down wrong. Still, there are more useful DMA functions than this though. For starters, removing the <span style="font-style: italic">if</span> may be useful.
<br/>
<br/>
Anyway, the DMA <span style="font-style: italic">count</span> is always the number of chunks you need copied. The chunk size depends on whether you use 16bit or 32bit DMA. Divide the byte-count by 2 or 4, respectively.
<br/>
<br/>
As for the parallax scrolling: the basic idea is to move things that are further away at a lower speed. Basically, something if you're moving at velocity <span style="font-style: italic">v</span>, things that are a distance <span style="font-style: italic">z</span> away move at <span style="font-style: italic">v</span>/<span style="font-style: italic">z</span>. You may want to use fixed numbers for the distances and related calculations. And a division LUT. Don't have any specific example I can point you to, though.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#71957 - ion - Wed Feb 15, 2006 5:09 pm</h4>
    <div class="postbody"><span class="postbody">thanks guys. sorry took so long to get back to you.
<br/>
<br/>
regarding the scrolling question would updating the scrolling offsets at VBlank  suffice or would I need to use HBlank.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#71959 - Cearn - Wed Feb 15, 2006 5:19 pm</h4>
    <div class="postbody"><span class="postbody">That really depends on the kind of parallax you want. You you just need a 2 or 3 layer parallax, extra backgrounds + offsetting at VBlank should be enough. If you want to go for more layers or you've run out of BGs, you'll have to do some HBlank interrupting. It's really up to you here.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#72101 - ion - Thu Feb 16, 2006 1:03 pm</h4>
    <div class="postbody"><span class="postbody">Cheers Cearn.
<br/>
<br/>
I'm just doing basic 2 background parallax.  I've got it working with this god-ugly hacky code:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">       //Update foreground 
<br/>
      bg0_x += 50;
<br/>
      if(bg0_x &gt; (256 * 100))
<br/>
      {
<br/>
         bg0_x = 0;
<br/>
      }
<br/>
<br/>
      //Update background 
<br/>
      bg1_x += 25;
<br/>
      if(bg1_x &gt; (256 * 100))
<br/>
      {
<br/>
         bg1_x = 0;
<br/>
      }
<br/>
      
<br/>
      REG_BG0HOFS = (bg0_x / 100);
<br/>
      REG_BG1HOFS = (bg1_x / 100);</td> </tr></table><span class="postbody">
<br/>
<br/>
Of course I realise it's not the best method but hey it's for a project, it works, and I'm running out of time.  I guess I'll still have to learn Fixed Point for projectiles and collisions.. do I?
<br/>
<br/>
ION</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#72102 - Cearn - Thu Feb 16, 2006 1:27 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>ion wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">... 100s...</td> </tr></table><span class="postbody">
<br/>
Of course I realise it's not the best method but hey it's for a project, it works, and I'm running out of time. I guess I'll still have to learn Fixed Point for projectiles and collisions.. do I? </span></td> </tr></table><span class="postbody">
<br/>
Should work.
<br/>
<br/>
Fixed point isn't so hard by the way. It's just like working in percentages/decimals only in hex. That is, using 0x100 instead of 100 (in the case of .8 fixeds). Just watch out for shifting (hexa)decimal points in multiplying and dividing. Just like you would in standard decimal mults and divs. Fixed points can be used for much more that just projectiles -- anything that might use floats can be replaced with fixeds.
<br/>
<br/>
Btw, you don't have to do the boundary tests: tile-mode background wrap around. Just mask of the final 8 bits ... or not because the GBA will probably do that for you anyway.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
// a #define for the scrolling speed == good idea
<br/>
// You're trying half-pixel movement/frame right?
<br/>
// 50/100 = 1/2 = 128/256
<br/>
#define SCROLL_SPEED 128
<br/>
<br/>
bg0_x += SCROLL_SPEED;
<br/>
bg1_x += SCROLL_SPEED/2;
<br/>
<br/>
// assuming bg0_x, bg1_x are already .8 fixeds
<br/>
REG_BG0HOFS= (bg0_x&gt;&gt;8)&amp;255;
<br/>
REG_BG1HOFS= (bg1_x&gt;&gt;8)&amp;255;
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#72109 - ion - Thu Feb 16, 2006 2:24 pm</h4>
    <div class="postbody"><span class="postbody">cheers again for the reply.  I've stuck in your code to test it out. It seems the background skips every couple of frames.  would it have something to do with my if statements?
<br/>
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">       if(bg0_x &gt; (256 * 100))
<br/>
      {
<br/>
         bg0_x = 0;
<br/>
      }
<br/>
      if(bg1_x &gt; (256 * 100))
<br/>
      {
<br/>
         bg1_x = 0;
<br/>
      }
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
actually when I removed the if(s) the problem disappeared.  is this because you're ANDing &amp;255 i.e. (bg0_x&gt;&gt;8)&amp;255 or is that just masking out the .8 fractional part?
<br/>
<br/>
I'm sorry for all the questions (although this is the beginners forum).</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#72111 - Cearn - Thu Feb 16, 2006 2:51 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>ion wrote:</b></span></td> </tr> <tr> <td class="quote">cheers again for the reply.  I've stuck in your code to test it out. It seems the background skips every couple of frames.  would it have something to do with my if statements?
<br/>
<br/>
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">       if(bg0_x &gt; (256 * 100))
<br/>
      {
<br/>
         bg0_x = 0;
<br/>
      }
<br/>
      if(bg1_x &gt; (256 * 100))
<br/>
      {
<br/>
         bg1_x = 0;
<br/>
      }
<br/>
</td> </tr></table><span class="postbody">
<br/>
</span></td> </tr></table><span class="postbody">
<br/>
Were you using those ifs with the code I showed? That would be bad because I used proper .8 fixeds (1/256 fractions) while these ifs use percentages (1/100 fractions). Mixing them would mean mixing different kinds of fractions without correcting for the difference, which is always a bad idea. If you really want to keep those ifs, you'd have to test against 256*256, not 256*100.
<br/>
<br/>
If time permits it, resize all percentages to use proper fixed point math. Computers don't handle the decimal system particularly well, powers of two are much better. That way you can use AND instead of % and shifts instead of division. The compiler will even do it for you.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>ion wrote:</b></span></td> </tr> <tr> <td class="quote">actually when I removed the if(s) the problem disappeared.  is this because you're ANDing &amp;255 i.e. (bg0_x&gt;&gt;8)&amp;255 or is that just masking out the .8 fractional part?</td> </tr></table><span class="postbody">
<br/>
That's the AND yes. Like I said, tiled backgrounds wrap around, at 256 so everything is modulo 256 == AND 255. Or 512 and mod 512 if you're using the wide backgrounds, but you get the idea.
<br/>
<br/>
You can safely lose the ifs and use AND 255 instead. It's faster, shorter and actually a little safer too.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#72115 - ion - Thu Feb 16, 2006 3:14 pm</h4>
    <div class="postbody"><span class="postbody">cheers man. one other question:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">oam_set_attribute( ship, (OAM_COLOR_256 | OAM_MODE_NORMAL | OAM_SQUARE), 
<br/>
                  OAM_SIZE_16, (tl_id | OAM_PRIORITY(1)) );</td> </tr></table><span class="postbody">
<br/>
<br/>
I use this function to set up my sprite (I'm bulding my own basic library cos my projects is all about learning gba technology/techniques).  My bgs are left as is regarding priority thus bg0 is higher priority than bg1 (according to cowbite).  tl_id is the tile id for the current ships frame of animation.  I think the OAM_PRIORITY(n) is from tonc (although I can't remember).  should calling this function not set display priority behind bg0 and in front of bg1?  cos it's not....
<br/>
<br/>
ION</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#72120 - Cearn - Thu Feb 16, 2006 3:48 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>ion wrote:</b></span></td> </tr> <tr> <td class="quote">My bgs are left as is regarding priority thus bg0 is higher priority than bg1 (according to cowbite). ... Should calling OAM_PRIORITY not set display priority behind bg0 and in front of bg1? cos it's not.... </td> </tr></table><span class="postbody">
<br/>
And it shouldn't.
<br/>
<br/>
There are two things at work here. One is priority and the other, for lack of a better word, is bg/obj <span style="font-weight: bold"><span style="font-style: italic">order</span></span>. Priority is what you set in the bits of attr2 and REG_BGxCNT. Order is the numbering of the bgs or objs themselves. These are not the same. 
<br/>
<br/>
By default, the priority of everything is 0. The bits for priority is zero after all. Within a given priority, the bgs and objs are drawn in order (or rather, reverse order: higher numbers are drawn first, leaving lower bgs/objs ar the front). In the same priority, objs/bgs are layered from front to back as
<br/>
OAM0-OAM127-BG0-BG3. To get different orders (say, bgs in front of sprites), you'd have to up the priority of everything that would normally go in front of it. In your case, what should work is <span style="font-weight: bold">bg0=prio0, the rest prio1</span>.
<br/>
<br/>
There is a problem with mixing backgrounds and sprites of different priorities. I'm not sure how to explain this best, but it comes down to that it's best to you should not put a bg between sprites that have conflicting orders and priorities. For example: oam1/prio0 - bg0/prio0 - oam0/prio1 would give artifacts, but oam0/prio0 - bg0/prio0 - oam1/prio1 would be ok. See <a class="postlink" href="http://nocash.emubase.de/gbatek.htm#lcdobjoamattributes" target="_blank">GBATek:?ttr2</a> for more on this.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#72132 - poslundc - Thu Feb 16, 2006 4:57 pm</h4>
    <div class="postbody"><span class="postbody">I've heard a lot about this problem but never actually seen it... is it only when the conflicting OBJs overlap? Is a BG required to make it happen? What kind of an artifact does it create? Where is the GPU's algorithm failing to take it correctly into account?
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#72136 - ion - Thu Feb 16, 2006 5:07 pm</h4>
    <div class="postbody"><span class="postbody">ok well that makes alot more sense.  since a sprite takes priority over a bg then setting bg0 to prio0 and everything else to prio1 then bg0 will always be displayed above everything else. ok think I got that. now...
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">oam_set_attribute( ship, (OAM_COLOR_256 | OAM_MODE_NORMAL | OAM_SQUARE), 
<br/>
                  OAM_SIZE_16, (tl_id) | OAM_PRIORITY(1) );</td> </tr></table><span class="postbody">
<br/>
I've set up the two bgs as you said and call this but still my ship is being displayed on top of bg0.  in OAM viewer in VBA my ships priority is 0. should not (tl_id) | OAM_PRIORITY(1)  correctly setup the priority using the this macro (it just shifts the priority like 1 &lt;&lt; 10).</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#72138 - Cearn - Thu Feb 16, 2006 5:13 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>poslundc wrote:</b></span></td> </tr> <tr> <td class="quote">I've heard a lot about this problem but never actually seen it... is it only when the conflicting OBJs overlap? Is a BG required to make it happen? What kind of an artifact does it create? Where is the GPU's algorithm failing to take it correctly into account?
<br/>
<br/>
Dan.</td> </tr></table><span class="postbody">
<br/>
Cool, I found it again.
<br/>
<a class="postlink" href="http://forum.gbadev.org/viewtopic.php?t=3502" target="_blank">http://forum.gbadev.org/viewtopic.php?t=3502</a>
<br/>
Try the demo that's linked to and select the first option in the menu. The text is sprites and shows through the overlapping background.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#72139 - Cearn - Thu Feb 16, 2006 5:17 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>ion wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
I've set up the two bgs as you said and call this but still my ship is being displayed on top of bg0. In OAM viewer in VBA my ships priority is 0. Should not (tl_id) | OAM_PRIORITY(1)  correctly setup the priority using the this macro (it just shifts the priority like 1 &lt;&lt; 10).</td> </tr></table><span class="postbody">
<br/>
Should have worked. Maybe you're unsetting it somewhere else? Block out all the other code and check. Don't forget to still update to the real OAM of course.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#72140 - ion - Thu Feb 16, 2006 5:19 pm</h4>
    <div class="postbody"><span class="postbody">sorry sorry sorry... weird but my code is working now... anyway.  I think this thread has ran it's course so thanks a million for the help. on to the enemies now...
<br/>
<br/>
ION</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
