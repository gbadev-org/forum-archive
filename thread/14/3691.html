<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>FIXED multiplication - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>Beginners > FIXED multiplication</h2>
<div id="posts">
<div class="post">
    <h4>#23311 - ProblemBaby - Fri Jul 09, 2004 7:17 pm</h4>
    <div class="postbody"><span class="postbody">If I multiply two FIXED values i Get a value
<br/>
but when I multiply the same thing but negative I dont get this relation
<br/>
x == -y
<br/>
it differs, why and how can I fix that I dont want to make if-tests in my FixedMul-function.
<br/>
<br/>
now my function looks like this:
<br/>
((a * b) &gt;&gt; 8)
<br/>
<br/>
Its very important for me to fix this...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#23315 - jma - Fri Jul 09, 2004 8:13 pm</h4>
    <div class="postbody"><span class="postbody">You are using an unsigned shift instead of a signed one, mose likely.
<br/>
<br/>
Jeff<br/>_________________<br/><a href="mailto:massung@gmail.com">massung@gmail.com</a>
<br/>
<a href="http://www.retrobyte.org" target="_blank">http://www.retrobyte.org</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#23317 - ProblemBaby - Fri Jul 09, 2004 8:25 pm</h4>
    <div class="postbody"><span class="postbody">um how?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#23320 - poslundc - Fri Jul 09, 2004 8:53 pm</h4>
    <div class="postbody"><span class="postbody">If your variables are declared as unsigned (eg. u16 or u32) then it will perform a logical (unsigned) shift instead of an arithmetic (signed) shift. Use s16 or s32 instead.
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#23321 - ProblemBaby - Fri Jul 09, 2004 9:24 pm</h4>
    <div class="postbody"><span class="postbody">What but the other told me not to do it...
<br/>
this is my code
<br/>
<br/>
typedef signed int FIXED;
<br/>
<br/>
FIXED v1, v2;
<br/>
<br/>
v1 = 4238829;
<br/>
v2 = 2348823;
<br/>
<br/>
s1 = (v1*v2)&gt;&gt;8;
<br/>
s2 = (v1*-v2)&gt;&gt;8;
<br/>
<br/>
if (s1 == -s2) // this is not true.. s2 = -s1 - 1
<br/>
{
<br/>
<br/>
}</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#23322 - jma - Fri Jul 09, 2004 9:44 pm</h4>
    <div class="postbody"><span class="postbody">Uh... I hate to break it to you, but those numbers are huge. The largest fixed point number (assuming 24.8 fp math) you can get is 16777215. And 4238829 * 2348823 = 9956259048267 which is well outside the 32-bit range (so your shift croaks).
<br/>
<br/>
Jeff<br/>_________________<br/><a href="mailto:massung@gmail.com">massung@gmail.com</a>
<br/>
<a href="http://www.retrobyte.org" target="_blank">http://www.retrobyte.org</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#23325 - ProblemBaby - Fri Jul 09, 2004 10:18 pm</h4>
    <div class="postbody"><span class="postbody">Remember that
<br/>
4238829 and 2348823 are fixed.
<br/>
<br/>
it would be
<br/>
16557,92578125
<br/>
and
<br/>
9175,08984375
<br/>
with 24.8</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#23326 - jma - Fri Jul 09, 2004 10:45 pm</h4>
    <div class="postbody"><span class="postbody">Quite right, but you still get the same problem:
<br/>
  16557 * 9175 = 151910475 &gt; 0xFFFFFF (24-bit)
<br/>
<br/>
Hell, maybe I am just thinking too fast (been a long day at work), but just try plugging in smaller numbers and see if it works.
<br/>
<br/>
Jeff<br/>_________________<br/><a href="mailto:massung@gmail.com">massung@gmail.com</a>
<br/>
<a href="http://www.retrobyte.org" target="_blank">http://www.retrobyte.org</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#23328 - poslundc - Fri Jul 09, 2004 11:51 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>ProblemBaby wrote:</b></span></td> </tr> <tr> <td class="quote">Remember that
<br/>
4238829 and 2348823 are fixed.
<br/>
<br/>
it would be
<br/>
16557,92578125
<br/>
and
<br/>
9175,08984375
<br/>
with 24.8</td> </tr></table><span class="postbody">
<br/>
<br/>
Okay, here's the thing. You've got an s32, and you want to split it up into 24 bits of integer and 8 bits of fraction.
<br/>
<br/>
You do that with your first number (16,557.whatever) and it is stored internally as a 32-bit value: 4238829.
<br/>
<br/>
Your second number (9175.whatever) is stored internally as 2348823.
<br/>
<br/>
You perform the multiplication and get 9956259048267 internally. It requires 44 bits to represent that number (45 signed), which is more than the 32 you've got in your s32 variable.
<br/>
<br/>
You've got some options. You can downshift your variables beforehand if you don't mind losing precision on your result. Alternatively, you can use the long long datatype to do 64-bit multiplication. It isn't cheap on the processor, though, so you don't want to be doing it unless your application really requires that kind of precision with numbers that large.
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#23340 - ProblemBaby - Sat Jul 10, 2004 2:58 am</h4>
    <div class="postbody"><span class="postbody">Well yeah they are too big
<br/>
but that isnt the point the point is why:
<br/>
<br/>
for example
<br/>
<br/>
a = (56 * 56) &lt;&lt; 8;
<br/>
b = (56 * -56) &lt;&lt; 8;
<br/>
<br/>
a == -b // this should be true but it isnt</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#23342 - poslundc - Sat Jul 10, 2004 4:21 am</h4>
    <div class="postbody"><span class="postbody">You're right, that code should work if both variables are signed and 32 bits.
<br/>
<br/>
So there is probably something in the context you are using it in that is making it not work. Can you post the actual code, including where the variables are defined and how you are performing the test and checking the result?
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
