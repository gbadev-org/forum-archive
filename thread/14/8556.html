<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>shoot em up - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>Beginners > shoot em up</h2>
<div id="posts">
<div class="post">
    <h4>#71566 - deltree - Mon Feb 13, 2006 2:25 pm</h4>
    <div class="postbody"><span class="postbody">hi,
<br/>
I'm trying to create a shoot em up, but I have a few problems with speed:
<br/>
when I shoot, the more bullet and missile there are on the screen, the slower the game is, because it multiply the collisions test and the move of the bullets.
<br/>
The fewer enemies, the quicker is is, on the opposite.
<br/>
<br/>
so, my question: how to remain at constant speed? creating artificial pauses, when an enemy die?
<br/>
shorting the pause when more bullets are shot?
<br/>
<br/>
for now, here's what I do: when the bullets are not shot , I only put them in a part of the screen where you can't see them. same thing with dead enemies. so the game continue at constant speed.
<br/>
<br/>
should I delete them, and recreate them when needed?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#71572 - tepples - Mon Feb 13, 2006 2:41 pm</h4>
    <div class="postbody"><span class="postbody">Are you sorting your ships and bullets by x or y value and only comparing those that are close to each other?<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#71576 - deltree - Mon Feb 13, 2006 3:19 pm</h4>
    <div class="postbody"><span class="postbody">I make the hit test with every bullets and every enemy.
<br/>
<br/>
-64 hit test (8 enemy+8 bullets) 
<br/>
- 16 moves(idem)
<br/>
-8 hit test(enemy+plane)
<br/>
-1 move (plane)
<br/>
<br/>
I know it's wrong, and I can optimize it a lot, but still, it's not my question for now.
<br/>
I know I'll have to optimize hit test, but for now, the global speed is correct, even with all those hittests.
<br/>
I wanted to know how to keep the game speed constant.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#71634 - tepples - Mon Feb 13, 2006 8:44 pm</h4>
    <div class="postbody"><span class="postbody">To keep the game speed constant, you'll need to install a vblank interrupt service routines that notifies the main thread as to how many vblanks have taken place. (There are roughly 60 vblanks in a second.) Then run your game logic every 1 vblank, every 2 vblanks, or every 3 vblanks.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#71821 - deltree - Tue Feb 14, 2006 6:32 pm</h4>
    <div class="postbody"><span class="postbody">For now, I'm running the game logic outside the vblank, in the main loop.
<br/>
<br/>
with All the tests and move I need to do, I think the vblank interrupt will not be quick enough to move all the sprites in a decent time, will it ?
<br/>
<br/>
if I understood well, the vblank function will execute the code 60 times per seconds, when the "while" main loop will execute your code at a very much higher frequency, (the main CPU frequency) Am I right?
<br/>
<br/>
also, what is the smarter solution for bullets: recreate the sprite when shot, and delete it when it's out of the screen?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#71853 - Palamon - Tue Feb 14, 2006 10:10 pm</h4>
    <div class="postbody"><span class="postbody">I think what tepples meant was :
<br/>
<br/>
Instead of having your main loop pause at the end for a fixed amount of time
<br/>
like with some really large for loops and such.
<br/>
<br/>
So for small amount of objects to process, you don't see a difference
<br/>
<br/>
ie:
<br/>
<br/>
do main game loop (which takes say 0.01 sec per object)
<br/>
pause for 1 sec. (or what ever 100,000 increments of a for loop take)
<br/>
do main game loop again
<br/>
<br/>
so for 10 objects, it will take 1.1 sec
<br/>
and for 15 objects, 1.15 sec
<br/>
not much of a difference
<br/>
<br/>
but when you get to 100 objects, it takes 2 sec, double the time
<br/>
<br/>
So as your main game loop takes longer, the fixed pause doesn't shorten it's pause to compensate
<br/>
<br/>
<br/>
by setting a counter to count the vblanks, and have a vblank interupt to increment it, you can time your main game loops like so
<br/>
<br/>
while(1)
<br/>
{
<br/>
reset vblank counter to zero
<br/>
<br/>
do main game loop functions
<br/>
<br/>
while vblank &lt; 60 {}
<br/>
<br/>
}//end of main game loop 
<br/>
<br/>
this way, if your main game loop stuff takes 2 vblanks, (ie 10 objects)
<br/>
the pause waits for 58 vblanks
<br/>
<br/>
so the total game loop time is 60 vblanks
<br/>
<br/>
if your main game loop stuff takes 40 vblanks, (like 50 - 100) objects)
<br/>
the pause waits for 20 vblanks
<br/>
<br/>
so the total game loop time is still 60 vblanks
<br/>
<br/>
and if your main game loop takes over 60 vblanks, it doesn't pause at all, and then you will notice some slow down.
<br/>
<br/>
<br/>
I hope this makes it a bit clearer, at least in theory anyways.
<br/>
<br/>
<br/>
btw, I haven't quite mastered this technique yet though, I still have a few problems getting it to work on the emulator, but I think it's because I was using a timer interupt instead of vblank.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#71855 - tepples - Tue Feb 14, 2006 10:13 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>deltree wrote:</b></span></td> </tr> <tr> <td class="quote">For now, I'm running the game logic outside the vblank, in the main loop.</td> </tr></table><span class="postbody">
<br/>
True, but if your main code takes longer than about 200,000 cycles, it'll overflow into the vblank, and there will be slowdown.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">with All the tests and move I need to do, I think the vblank interrupt will not be quick enough to move all the sprites in a decent time, will it ?</td> </tr></table><span class="postbody">
<br/>
If you build up a list of copies to OAM and VRAM during draw time, you can then perform that list during vblank time. Every single NES game did this, and so do most GBA games.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">if I understood well, the vblank function will execute the code 60 times per seconds, when the "while" main loop will execute your code at a very much higher frequency, (the main CPU frequency) Am I right?</td> </tr></table><span class="postbody">
<br/>
Yes.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">also, what is the smarter solution for bullets: recreate the sprite when shot, and delete it when it's out of the screen?</td> </tr></table><span class="postbody">
<br/>
Yes, but the details depend on your architecture so far. I still maintain that sorting your bullets by x or y coordinate is likely to open up huge speedups for your collision search algorithms.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#71856 - Quirky - Tue Feb 14, 2006 10:13 pm</h4>
    <div class="postbody"><span class="postbody">You use it like a metronome to check how many ticks go by or wait until the next tick. Here is my attempt to explain it:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#define FRAME_RATE 2
<br/>
volatile int frames = 0;
<br/>
void
<br/>
vblank_handler()
<br/>
{
<br/>
  frames++;
<br/>
}
<br/>
<br/>
int
<br/>
main()
<br/>
{
<br/>
  while(1)
<br/>
  {
<br/>
    do_stuff();
<br/>
    while(frames &lt; FRAME_RATE) {
<br/>
      VBlankIntrWait();
<br/>
    }
<br/>
    frames = 0
<br/>
  }
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
So there your vblank routine does not much, just lets us know in the main thread that it has happened. With that code, if your logic takes too long, then you don't wait for as many vblanks, if it takes less time then you do wait for vblanks and everything runs at a constant rate. The worst that can happen is your logic takes waaaay too long, but then that doesn't have a solution with the vblank.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#71935 - deltree - Wed Feb 15, 2006 12:48 pm</h4>
    <div class="postbody"><span class="postbody">ok, I understand the vblank trick now.
<br/>
<br/>
<br/>
there's something  I'm still wondering about:
<br/>
If I need to sort the array of enemy position, it's quite a long procedure.
<br/>
will I need to sort the enemy array every loop? I wonder if it's really shorter than doing all the collision detection...
<br/>
<br/>
how to do the sorting of the array quickly and properly?[/b]</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#71948 - keldon - Wed Feb 15, 2006 2:57 pm</h4>
    <div class="postbody"><span class="postbody">Merge sort is good, however I think that for certain amounts of elements one of the other algorithms are good as merge sort is always N log2 N
<br/>
<br/>
Also you can partition your objects by sectors; i.e. dividing the screen into 8/16 sectors where some objects belong to both.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#71977 - waruwaru - Wed Feb 15, 2006 8:03 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>deltree wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
will I need to sort the enemy array every loop? I wonder if it's really shorter than doing all the collision detection...[/b]</td> </tr></table><span class="postbody">
<br/>
<br/>
After you sort your array once, whenever you add/remove/move an enemy, you can try to keep the array sorted so you don't have to re-sort the entire array.  For example, if you have an array with 10 enemies, and it's sorted already.  When you move enemy 5 for a small distance, then you probably only need to check against enemy 4 and 6 (and other nearby enemies).  If you move a larger distance, then you can sort enemy 1-5 or 5-10.  You can even keep 2 arrays, one sorted base on X coord and another on Y coord, that way if your bullets fly horizontally only, it's probably better to check against the array sorted base on X coords.  Depending how your enemy moves, you can implement different algorithms.  Run some tests with different methods and find the fastest one.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
