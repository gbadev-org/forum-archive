<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Can't Add To A Pointer - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>Beginners > Can't Add To A Pointer</h2>
<div id="posts">
<div class="post">
    <h4>#72259 - tonkinfash - Fri Feb 17, 2006 6:43 am</h4>
    <div class="postbody"><span class="postbody">I am trying to substitute the multiplication by 240 by using bit shifts, but GCC won't let me add a cast integer to a pointer. It says 'invalid operands to binary +'.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
static unsigned short *pointer;
<br/>
unsigned int offset;
<br/>
<br/>
pointer = VIDEO_BUFFER;
<br/>
<br/>
y &lt;&lt;= 4;
<br/>
offset = y;
<br/>
y &lt;&lt;= 1;
<br/>
offset += y;
<br/>
y &lt;&lt;= 1;
<br/>
offset += y;
<br/>
y &lt;&lt;= 1;
<br/>
offset += y;
<br/>
offset &gt;&gt;= 1;
<br/>
pointer += (unsigned short *) offset;
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#72261 - tepples - Fri Feb 17, 2006 6:47 am</h4>
    <div class="postbody"><span class="postbody">Bit shifts to replace multiplication by 240 won't buy you much on ARM7TDMI, the CPU architecture used in the Game Boy Advance system, because ARM7TDMI has a fast multiplier.
<br/>
<br/>
What are you planning to use a bitmap mode for?<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#72263 - gauauu - Fri Feb 17, 2006 6:57 am</h4>
    <div class="postbody"><span class="postbody">why are you casting offset to a pointer?  When adding or subtracting to a pointer, you use a pointer and an integer.  The resulting pointer is the original moved by the integer times the size of the object pointed for.
<br/>
<br/>
For example, if I have:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
int dummy = 9;  //give x somewhere to point
<br/>
<br/>
int * x = &amp;dummy;
<br/>
int offset  = 3;
<br/>
<br/>
x += offset;
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Then x will point to a memory location (3 * sizeof(int))  beyond dummy.  Or, in other words, point to a spot "3 integers later".
<br/>
<br/>
edit:  yuck...sorry for the messed up tags.  phpBB's tag javascript drives me crazy.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#72265 - DekuTree64 - Fri Feb 17, 2006 7:03 am</h4>
    <div class="postbody"><span class="postbody">Remove the cast. You can add an integer to a pointer, but not a pointer to a pointer.
<br/>
<br/>
And yes, bitshifting won't get you a whole lot, especially in THUMB mode. You'll save a couple cycles in ARM though, if you do it like this instead of that long shifting sequence:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">pointer += (y &lt;&lt; 8) - (y &gt;&gt; 4);</td> </tr></table><span class="postbody"><br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#72271 - poslundc - Fri Feb 17, 2006 8:11 am</h4>
    <div class="postbody"><span class="postbody">If it's more efficient to multiply by a constant using shifting and adding, the optimizing compiler will usually do it for you.
<br/>
<br/>
On the other hand, if you wind up multiplying by the wrong number because your code is all obfuscated, the compiler won't be able to detect that for you.
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#72391 - LOst? - Sat Feb 18, 2006 6:40 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>DekuTree64 wrote:</b></span></td> </tr> <tr> <td class="quote">Remove the cast. You can add an integer to a pointer, but not a pointer to a pointer.
<br/>
<br/>
And yes, bitshifting won't get you a whole lot, especially in THUMB mode. You'll save a couple cycles in ARM though, if you do it like this instead of that long shifting sequence:
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">pointer += (y &lt;&lt; 8) - (y &gt;&gt; 4);</td> </tr></table><span class="postbody"></span></td> </tr></table><span class="postbody">
<br/>
<br/>
I must ask a question DekuTree64, even if it hasn't to do with this topic, it has to do with C optimations.
<br/>
<br/>
I have always wondered if this code:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
index = y &lt;&lt; 8;
<br/>
index -= y &gt;&gt; 4;
<br/>
pointer += index;
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
... will be optimized the same way as this code:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">pointer += (y &lt;&lt; 8) - (y &gt;&gt; 4);</td> </tr></table><span class="postbody"><br/>_________________<br/><span style="font-style: italic">Exceptions are fun</span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#72397 - gladius - Sat Feb 18, 2006 8:07 am</h4>
    <div class="postbody"><span class="postbody">Lost: Depends on the compiler and whether you use the index variable later on.  But usually yes, they would end up optimizing to the exact same thing.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#72404 - DekuTree64 - Sat Feb 18, 2006 9:17 am</h4>
    <div class="postbody"><span class="postbody">I tend not to trust compilers in general when it comes to optimizing. I think doing the calculation all on one line like that looks a lot nicer, and if the compiler wastes an extra cycle or two making a temp variable (or doing a real multiply instead of optimizing to shifts, for that matter), it's probably wasting a lot more cycles than that elsewhere, making the first one insignificantly wasteful :)
<br/>
<br/>
Besides, if you know what assembly code you want the compiler to generate, and have to screw around compiling and checking the output to coax it into doing it right, you might as well just write the assembly yourself in the first place.<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#72439 - tepples - Sat Feb 18, 2006 4:45 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>DekuTree64 wrote:</b></span></td> </tr> <tr> <td class="quote">Besides, if you know what assembly code you want the compiler to generate, and have to screw around compiling and checking the output to coax it into doing it right, you might as well just write the assembly yourself in the first place.</td> </tr></table><span class="postbody">
<br/>
Unless you're trying to use the game logic for both a GBA version and a PC version, such as if you're prototyping on the PC or if you're making a PC demo to promote a commercial GBA game.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
