<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>VBA running at uber-speeds... - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>Beginners > VBA running at uber-speeds...</h2>
<div id="posts">
<div class="post">
    <h4>#27656 - mr_square - Mon Oct 18, 2004 1:22 pm</h4>
    <div class="postbody"><span class="postbody">Sorry, not quite sure which forum this should go in...
<br/>
<br/>
Running my rom via VBA at home, its fine. I implemented DMA which sped it up loads, but I got it back to a fairly reasonable speed by having a counter in my main method that only executes the code once every 3 v-blanks.
<br/>
<br/>
Trying it via VBA in my uni department though, the same code runs stupidly fast. I tried sending it to a friend via MSN and he said it was far too fast too. Whats going on? Using the throttle settings on VBA doesnt help either, as it just makes it go all jerky :(</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#27657 - FluBBa - Mon Oct 18, 2004 1:50 pm</h4>
    <div class="postbody"><span class="postbody">How exactly do you check that 3 vblanks has occured?
<br/>
Are you using the BIOS call? It might be that you have the old (pre release) BIOS at your home, that one allways waits for a new VBlank no matter what you put in r1.<br/>_________________<br/>I probably suck, my not is a programmer.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#27658 - mr_square - Mon Oct 18, 2004 2:00 pm</h4>
    <div class="postbody"><span class="postbody">Like this:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
while(1)
<br/>
{ 
<br/>
<br/>
animTimer++;
<br/>
<br/>
   if(animTimer%3 == 0)
<br/>
   {
<br/>
<br/>
   ....execute code here.....
<br/>
<br/>
   }
<br/>
<br/>
waitforVsync()
<br/>
}
<br/>
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I've sort of fixed it now by changing it to "if animtimer%7 == 0", but its a bit odd. I'm thinking its a problem with my home PC, although thats the fastest of all the ones I tried the code on! :\</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#27671 - Lord Graga - Mon Oct 18, 2004 7:24 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">while(1){ 
<br/>
   animTimer++;
<br/>
   if(animTimer&amp;4){
<br/>
      amimTimer = 0;
<br/>
      DoStuff();
<br/>
   }
<br/>
   waitforVsync();
<br/>
}</td> </tr></table><span class="postbody">This is a lot faster :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#27672 - sajiimori - Mon Oct 18, 2004 7:41 pm</h4>
    <div class="postbody"><span class="postbody">Graga, your code is not equivalent because it resets the timer.  Also, the compiler will automatically convert to bitwise-AND when possible.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#27673 - poslundc - Mon Oct 18, 2004 7:48 pm</h4>
    <div class="postbody"><span class="postbody">Also, it will cycle every 4 times instead of every 3.
<br/>
<br/>
Also, if you want to correctly emulate the modulus operator (although it works in this case because you manually reset the counter to zero) it should be value &amp; 3, not value &amp; 4. (x % y == x &amp; (y - 1) where y is an even power of two.)
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#27674 - sajiimori - Mon Oct 18, 2004 8:17 pm</h4>
    <div class="postbody"><span class="postbody">In other words, test your code. :P</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#27676 - sgeos - Mon Oct 18, 2004 9:53 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>mr_square wrote:</b></span></td> </tr> <tr> <td class="quote">Using the throttle settings on VBA doesnt help either, as it just makes it go all jerky :(</td> </tr></table><span class="postbody">
<br/>
Is sound enabled?  Some emulators are unable to speed throttle if sound is disabled.
<br/>
<br/>
Have you tested on hardware?
<br/>
<br/>
-Brendan</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#27680 - allenu - Mon Oct 18, 2004 11:50 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>mr_square wrote:</b></span></td> </tr> <tr> <td class="quote">Like this:
<br/>
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
while(1)
<br/>
{ 
<br/>
<br/>
animTimer++;
<br/>
<br/>
   if(animTimer%3 == 0)
<br/>
   {
<br/>
<br/>
   ....execute code here.....
<br/>
<br/>
   }
<br/>
<br/>
waitforVsync()
<br/>
}
<br/>
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I've sort of fixed it now by changing it to "if animtimer%7 == 0", but its a bit odd. I'm thinking its a problem with my home PC, although thats the fastest of all the ones I tried the code on! :\</span></td> </tr></table><span class="postbody">
<br/>
<br/>
Just a thought, but it may be more accurate for your code to update your counter in a V-sync interrupt service routine instead.  Depending on how long your code takes to execute, you might miss a V-sync.  I'm not sure how heavy duty the processing you're doing, and at the moment it may be fine, but it is certainly possible for you to miss a V-sync if your processing takes too long.  
<br/>
<br/>
Actually, I'm not sure if this would be related to your problem, but it's good to know.
<br/>
<br/>
Allen</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#27682 - sajiimori - Tue Oct 19, 2004 1:17 am</h4>
    <div class="postbody"><span class="postbody">IMO, you should only do things in the vblank interrupt if they should be done even when the game is lagging.  I mean, it would look odd if the game started to lag due to a CPU shortage but some animations continued to run full-speed.
<br/>
<br/>
An example of something that should be done unconditionally would be sprite flickering for the poor-man's transparency effect.  You wouldn't want to lose the illusion of transparency if you went over your available CPU cycles.
<br/>
<br/>
Erm... this thread seems to really want to diverge for some reason.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#27683 - allenu - Tue Oct 19, 2004 1:37 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>sajiimori wrote:</b></span></td> </tr> <tr> <td class="quote">IMO, you should only do things in the vblank interrupt if they should be done even when the game is lagging.  I mean, it would look odd if the game started to lag due to a CPU shortage but some animations continued to run full-speed.
<br/>
<br/>
An example of something that should be done unconditionally would be sprite flickering for the poor-man's transparency effect.  You wouldn't want to lose the illusion of transparency if you went over your available CPU cycles.
<br/>
<br/>
Erm... this thread seems to really want to diverge for some reason.</td> </tr></table><span class="postbody">
<br/>
<br/>
Yeah, you're right.  If he's doing something that requires three *separately rendered* frames to be displayed before executing that code, then the ISR is not a good idea.  I was thinking more along the lines of something time-based that requires updating every 1/20th of a second.  In my case, I just added some sound mixing code to the VSYNC ISR as I require that to be done every displayed frame regardless of the rendering speed.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#27684 - sajiimori - Tue Oct 19, 2004 1:40 am</h4>
    <div class="postbody"><span class="postbody">Oh yeah, sound is the perfect example.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
