<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>flickering in mode 3 - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>Beginners > flickering in mode 3</h2>
<div id="posts">
<div class="post">
    <h4>#115613 - meth - Wed Jan 17, 2007 10:37 pm</h4>
    <div class="postbody"><span class="postbody">hi!
<br/>
Im quite new to programming gba and have tested a line drawing routine which runs perfect. But when clearing the screen every frame its just flickering and too slow!
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
void WaitForVblank(void)
<br/>
{
<br/>
   while(! (REG_DISPSTAT &amp; DISPSTAT_VB));
<br/>
   while(REG_DISPSTAT &amp; DISPSTAT_VB);
<br/>
}
<br/>
<br/>
void ClrScreen(void)
<br/>
{
<br/>
   int i;
<br/>
   for(i = 0; i &lt; SCREEN_HEIGHT * SCREEN_WIDTH; i++)
<br/>
      FrontBuffer[i] = 0;
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
and the mainloop:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
   while(1)
<br/>
   {
<br/>
      WaitForVblank();
<br/>
      ClrScreen();
<br/>
      DrawLine(x1,4,x2=72,y2=75,32-1); //x1, y1, x2, y2, color
<br/>
      
<br/>
      if(x1 &gt; SCREEN_WIDTH) 
<br/>
         x1 = 1;
<br/>
      x1++;
<br/>
   }
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Can someone please help here? In the pern Project one example with rotating a box is used, and that one is running quite good, and uses the same code (without any double buffering etc).
<br/>
<br/>
<br/>
ps I am using VisualBoy Advance version 1.7.1</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#115617 - Miked0801 - Wed Jan 17, 2007 10:57 pm</h4>
    <div class="postbody"><span class="postbody">A few iedas.
<br/>
<br/>
1. Are you compiling optimized?
<br/>
2. What is FrontBuffer declared as?  If it's a u8, then your clear routine will be real slow.  If it's u16, then you are clearing too much screen with your loop.  Either way, DmaClear would be much better.
<br/>
3. Don't assign x2 and y2 every tic inside the draw command, place it outside the while loop and only assign them once.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#115619 - meth - Wed Jan 17, 2007 11:22 pm</h4>
    <div class="postbody"><span class="postbody">thanks for the tip to change the values to outside the loop! 
<br/>
<br/>
for compiling Im using this script:
<br/>
gcc -o source.elf source.c -lm
<br/>
objcopy -O binary source.elf source.bin
<br/>
<br/>
the frontbuffer has this define (from regs.h)
<br/>
#define FrontBuffer	((u16*)0x6000000)
<br/>
<br/>
how could I clear too much? My idea was to clear the whole screen (even if thats not optimized in this caze), but am I clearing more than that?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#115625 - Miked0801 - Thu Jan 18, 2007 12:29 am</h4>
    <div class="postbody"><span class="postbody">Nah, if it's declared that way, it is fine (for what it is).  DmaClear or DmaCopy would still be much better.
<br/>
<br/>
To compile optimized,  add a '-O3' to your command line.  You should also get used to having warnings turned on with -Wall and -W (treat warnings as errors) on as well.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#115657 - thegamefreak0134 - Thu Jan 18, 2007 6:16 am</h4>
    <div class="postbody"><span class="postbody">I would actually advise against the warning flags, as I've had some warnings show up inlibraries I've imported (warnings mind, not actual errors) and fixing something you didn't even write is particularly difficult to do.
<br/>
<br/>
By "flickery" do you mean to say that the clear leaves artifacts on the screen? (This is rather hard to describe if you haven't seen it, but it looks like it takes it an awfully long time to draw one frame, or can be described as "tearing lines" going from the top to the bottom of the screen.) If so, this just means that your routine cannot complete the entire screen's worth of work in the same ammount of time it takes the GBA to draw one frame. In short, your routine is too slow.
<br/>
<br/>
DMA of some sort is really your friend, and TONC has some very nice macros to make this type of copy simple and painless. Basically, a DMA copy is done in hardware, unlike your for loop, which is handled by software. Using it will clear the screen and give you CPU time to spare.
<br/>
<br/>
We also have some issues to clear up with your WaitForVSync loop, but I'll let someone else yell at you for that, I don't have the proper routine in front of me at the moment.
<br/>
<br/>
-thegamefreak
<br/>
<br/>
PS: This is normal. Learning is a normal part of life.<br/>_________________<br/>What if the hokey-pokey really is what it's all about?
<br/>
<br/>
[url=http:/www.darknovagames.com/index.php?action=recruit&amp;clanid=1]Support Zeta on DarkNova![/url]</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#115658 - tepples - Thu Jan 18, 2007 6:42 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Miked0801 wrote:</b></span></td> </tr> <tr> <td class="quote">To compile optimized, add a '-O3' to your command line.</td> </tr></table><span class="postbody">
<br/>
I used to use -O3, but when a GCC upgrade caused my C code to overflow IWRAM due to more aggressive unrolling in the newer version, I switched to -O2 for a better balance among size, speed, and compilation time.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Miked0801 wrote:</b></span></td> </tr> <tr> <td class="quote">You should also get used to having warnings turned on with -Wall and -W (treat warnings as errors) on as well.</td> </tr></table><span class="postbody">
<br/>
Actually, -Wextra (for which -W is now an alias) enables a set of warnings that -Wall does not. The switch that treats warnings as errors is -Werror. (Source: <a class="postlink" href="http://gcc.gnu.org/onlinedocs/gcc/Warning-Options.html" target="_blank">GCC Manual: Warning Options</a>)
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>thegamefreak0134 wrote:</b></span></td> </tr> <tr> <td class="quote">I would actually advise against the warning flags, as I've had some warnings show up inlibraries I've imported (warnings mind, not actual errors) and fixing something you didn't even write is particularly difficult to do.</td> </tr></table><span class="postbody">
<br/>
What specific library gives you warnings when you arm-eabi-gcc -Wall -O2?
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>thegamefreak0134 wrote:</b></span></td> </tr> <tr> <td class="quote">In short, your routine is too slow.
<br/>
<br/>
DMA of some sort is really your friend</td> </tr></table><span class="postbody">
<br/>
For copies, yes; for clears, CpuFastSet() is faster.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#115695 - meth - Thu Jan 18, 2007 1:16 pm</h4>
    <div class="postbody"><span class="postbody">thanks to all of you! Will try out what I've learned!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#115696 - keldon - Thu Jan 18, 2007 1:19 pm</h4>
    <div class="postbody"><span class="postbody">Sometimes it's much better (and quicker) to go back and start from the beginning rather than spend hours trying to fix the problem. Maybe follow the <a class="postlink" href="http://user.chem.tue.nl/jakvijn/tonc/" target="_blank">tonc gba tutorials</a> and when you approach bitmaps you will have the right method!</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
