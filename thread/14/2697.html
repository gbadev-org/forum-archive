<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>AAS_SetConfig = crash - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>Beginners > AAS_SetConfig = crash</h2>
<div id="posts">
<div class="post">
    <h4>#15174 - LOst? - Sun Jan 18, 2004 4:43 pm</h4>
    <div class="postbody"><span class="postbody">As soon as I call AAS_SetConfig, from the AAS examples, VisualBoy Advance sends me back to the BIOS bootscreen, even when I've set "Skip BIOS".
<br/>
<br/>
Well, I can't use AAS, because AAS_SetConfig must be called, but whenever I call it = reboots.
<br/>
<br/>
What can be wrong?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#15208 - jd - Mon Jan 19, 2004 2:58 am</h4>
    <div class="postbody"><span class="postbody">I assume the pre-compiled examples work ok? Have you made any modifications to the examples before recompiling them? Are you using the makefile provided to recompile the examples? Do you get any errors during compilation?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#15245 - LOst? - Mon Jan 19, 2004 10:04 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>jd wrote:</b></span></td> </tr> <tr> <td class="quote">I assume the pre-compiled examples work ok? Have you made any modifications to the examples before recompiling them? Are you using the makefile provided to recompile the examples? Do you get any errors during compilation?</td> </tr></table><span class="postbody">
<br/>
<br/>
I use a bat file to compile it. I use my own code, and not the example. I use the crt0.s provided by AAS</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#15252 - jd - Tue Jan 20, 2004 2:06 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>LOst? wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
I use a bat file to compile it. I use my own code, and not the example. I use the crt0.s provided by AAS</td> </tr></table><span class="postbody">
<br/>
<br/>
I see. I recommend using a modified version of the makefile provided if possible. If you want to carry on using a bat file, you should check that it does everything the makefile would do. The main things to make sure you're doing are compiling with interworking enabled, linking to libAAS.a and linking in the assembled output from Conv2AAS. I'd recommend sticking to the original example code to begin with to minimise potential problems.
<br/>
<br/>
EDIT: There's a .bat file for compiling one of the examples in the post linked below. Hopefully it should be helpful when adapting the .bat file you're using to compile your project.
<br/>
<a class="postlink" href="http://forum.gbadev.org/viewtopic.php?p=11307#11307" target="_blank">http://forum.gbadev.org/viewtopic.php?p=11307#11307</a>
<br/>
<br/>
If that doesn't help you get it working and your .bat file isn't too long you could post it here and I'll do my best to help. (Or email it to me if you prefer.)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#15290 - LOst? - Tue Jan 20, 2004 2:01 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>jd wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>LOst? wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
I use a bat file to compile it. I use my own code, and not the example. I use the crt0.s provided by AAS</td> </tr></table><span class="postbody">
<br/>
<br/>
<br/>
<a class="postlink" href="http://forum.gbadev.org/viewtopic.php?p=11307#11307" target="_blank">http://forum.gbadev.org/viewtopic.php?p=11307#11307</a>
<br/>
</span></td> </tr></table><span class="postbody">
<br/>
<br/>
That's the bat file I used</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#15306 - LOst? - Tue Jan 20, 2004 7:21 pm</h4>
    <div class="postbody"><span class="postbody">Do you have any idea how I can fix this error?
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
LibAAS/libAAS.a(AAS_Main.o): In function `AAS_DoWork':
<br/>
AAS_Main.o(.text+0x466): undefined reference to `_call_via_r3'
<br/>
AAS_Main.o(.text+0x47c): undefined reference to `_call_via_r3'
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I don't know where to find this "_call_via_r3"</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#15315 - Miked0801 - Tue Jan 20, 2004 8:25 pm</h4>
    <div class="postbody"><span class="postbody">That's in your devkit's Lib.  Check your linking.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#15338 - jd - Wed Jan 21, 2004 12:20 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>LOst? wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
I don't know where to find this "_call_via_r3"</td> </tr></table><span class="postbody">
<br/>
<br/>
What version of devkitadv are you using? The bat file I posted has been tested to work on devkitadv-r5-beta-3 with the example code. It might be best if you tried this first to rule out any other possible problems.
<br/>
<br/>
Assuming you made some changes to accomodate your code, posting the version of the .bat file you're using would be helpful.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#15350 - LOst? - Wed Jan 21, 2004 6:55 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>jd wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>LOst? wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
I don't know where to find this "_call_via_r3"</td> </tr></table><span class="postbody">
<br/>
<br/>
What version of devkitadv are you using? The bat file I posted has been tested to work on devkitadv-r5-beta-3 with the example code. It might be best if you tried this first to rule out any other possible problems.
<br/>
<br/>
Assuming you made some changes to accomodate your code, posting the version of the .bat file you're using would be helpful.</span></td> </tr></table><span class="postbody">
<br/>
<br/>
I'm using an one year old devkitadv, and a new bat file from the pern project:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
@echo off
<br/>
set CFILES= main.cpp gba.cpp
<br/>
set OFILES= main.o gba.o
<br/>
<br/>
set GAME= z
<br/>
set DEVDIR= C:\devkitadv
<br/>
<br/>
PATH=%DEVDIR%\bin
<br/>
<br/>
set LIBDIR= %DEVDIR%\lib\gcc-lib\arm-agb-elf\3.0.2\interwork
<br/>
set LIBDIR2= %DEVDIR%\arm-agb-elf\lib\interwork
<br/>
set INCDIR= %DEVDIR%\lib\gcc-lib\arm-agb-elf\3.0.2\include
<br/>
set INCDIR2= %DEVDIR%\arm-agb-elf\include
<br/>
<br/>
set CFLAGS= -I. -I%INCDIR% -I%INCDIR2% -c -g -O2 -Wall -fverbose-asm -mthumb-interwork -LLibAAS
<br/>
set LDFLAGS= -L%LIBDIR% -L%LIBDIR2% -T LinkScript -lstdc++ -lgcc -lc -LLibAAS -lAAS
<br/>
<br/>
conv2aas AAS_Data
<br/>
<br/>
as -mthumb-interwork -o AAS_Data.o AAS_Data.s
<br/>
<br/>
as crt0.s -o crt0.o
<br/>
<br/>
gcc %CFILES% %CFLAGS%
<br/>
<br/>
ld -o %GAME%.elf crt0.o crtbegin.o crtend.o AAS_Data.o %OFILES% %LDFLAGS% 
<br/>
objcopy -v -O binary %game%.elf %game%.gba
<br/>
del %OFILES%
<br/>
del *.elf
<br/>
pause
<br/>
gbafix %game%.gba
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
James Daniels, Apex Designs
<br/>
</td> </tr></table><span class="postbody">
<br/>
Hey, I didn't see you're the main man behind AAS x.x
<br/>
I've downloaded parts of devkitadv-r5-beta-3, but I can't use it because I use standard library functions like memcpy, etc... And downloading those will take hours on a slow modem. Therefore, I can't use "make", and to make AAS compatible with the old compilator, I've tried to write my own interrupt handler. I have no idea if AAS will work with it, I haven't come so far yet.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#15398 - jd - Thu Jan 22, 2004 12:49 am</h4>
    <div class="postbody"><span class="postbody">Ok, I've edited the bat file you posted. I haven't tested this but it might fix the problems you've been experiencing:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
@echo off
<br/>
set CFILES= main.cpp gba.cpp
<br/>
set OFILES= main.o gba.o
<br/>
<br/>
set GAME= z
<br/>
set DEVDIR= C:\devkitadv
<br/>
<br/>
PATH=%DEVDIR%\bin
<br/>
<br/>
set LIBDIR= %DEVDIR%\lib\gcc-lib\arm-agb-elf\3.0.2\interwork
<br/>
set LIBDIR2= %DEVDIR%\arm-agb-elf\lib\interwork
<br/>
set INCDIR= %DEVDIR%\lib\gcc-lib\arm-agb-elf\3.0.2\include
<br/>
set INCDIR2= %DEVDIR%\arm-agb-elf\include
<br/>
<br/>
set CFLAGS= -I. -I%INCDIR% -I%INCDIR2% -c -g -O2 -Wall -fverbose-asm -mthumb-interwork -ILibAAS
<br/>
set LDFLAGS= -L%LIBDIR% -L%LIBDIR2% -mthumb-interwork -Tlnkscript -lstdc++ -lgcc -lc -LLibAAS -lAAS
<br/>
<br/>
conv2aas AAS_Data
<br/>
<br/>
as -mthumb-interwork -o AAS_Data.o AAS_Data.s
<br/>
<br/>
as crt0.s -o crt0.o
<br/>
<br/>
gcc %CFILES% %CFLAGS%
<br/>
<br/>
ld -o %GAME%.elf crt0.o crtbegin.o crtend.o AAS_Data.o %OFILES% %LDFLAGS% 
<br/>
objcopy -v -O binary %game%.elf %game%.gba
<br/>
del %OFILES%
<br/>
del *.elf
<br/>
pause
<br/>
gbafix %game%.gba
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I've switched the link script to use the one that comes with AAS ("lnkscript" rather than "LinkScript"). You might need to copy the one from the AAS example folder if you haven't already. It's possible this change will cause problems with the other libraries because they require different symbol names. (Unfortunately devkitadv's default link script was changed a while ago so AFAIK it's currently not possible to make a library that works on all versions. To work around this I've made a lnkscript that includes both the old and the new symbol names. If you need this (i.e. you start getting complaints for the c++ libraries when you make the changes described above) then let me know and I'll email it to you.
<br/>
<br/>
I also added "-ILibAAS" to the CFLAGS line so that the compiler will be able to find the header files.
<br/>
<br/>
By the way, I did spot a couple of quirks that you might consider looking at:
<br/>
<br/>
1) devkitadv compiles ARM code in ROM by default. This is a really bad combination - I strongly suggest compiling most of your code as thumb in ROM (use the -mthumb option). Performance critical code works best as ARM code in IWRAM. Other combinations are possible but not very useful IMHO.
<br/>
<br/>
2) You currently compiling your code as O2 - I suggest using O3. Some people regard this mode as buggy, but the problems they encounter are almost always due to not declaring registers as volatile, which is technically a bug in their code rather than in the compiler. The only genuine issue I've run into with O3 is with thumb code where very long loops can cause the compiler to use a bl instruction which corrupts lr but the compiler fails to take this into account. This can be fixed using "-ffixed-r14". I found this bug in gcc 2.95 and 3.2 so it might have been fixed in more recent versions.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>LOst? wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
Hey, I didn't see you're the main man behind AAS x.x
<br/>
I've downloaded parts of devkitadv-r5-beta-3, but I can't use it because I use standard library functions like memcpy, etc... And downloading those will take hours on a slow modem. Therefore, I can't use "make", and to make AAS compatible with the old compilator, I've tried to write my own interrupt handler. I have no idea if AAS will work with it, I haven't come so far yet.</td> </tr></table><span class="postbody">
<br/>
<br/>
I see. I mainly use an older, Cygwin-based version of devkitadv and AAS works fine with that without any modifications. You shouldn't need to write a new interrupt handler to get it to work. Older versions of devkitadv also come with make.
<br/>
<br/>
AAS does come with a special crt0.s that includes a modified interrupt handler, but you only need to use this if you've got other CPU intensive interrupts in your code - if you haven't, then any interrupt handler should work.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#15401 - tepples - Thu Jan 22, 2004 2:44 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>jd wrote:</b></span></td> </tr> <tr> <td class="quote">Older versions of devkitadv also come with make.</td> </tr></table><span class="postbody">
<br/>
I have MinGW and DevKit Advance R5 beta 3 co-installed. I use MinGW's make to build my projects on both sides, and I use MinGW's C compiler to build PC-side data conversion tools.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#15426 - LOst? - Thu Jan 22, 2004 2:19 pm</h4>
    <div class="postbody"><span class="postbody">I get this problem:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
ld: unrecognised emulation mode: thumb-interwork
<br/>
Supported emulations: armelf_agb armelf armcoff armaoutl
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Maybe someone knows what's wrong?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#15439 - jd - Thu Jan 22, 2004 7:25 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>LOst? wrote:</b></span></td> </tr> <tr> <td class="quote">I get this problem:
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
ld: unrecognised emulation mode: thumb-interwork
<br/>
Supported emulations: armelf_agb armelf armcoff armaoutl
<br/>
</td> </tr></table><span class="postbody">
<br/>
</span></td> </tr></table><span class="postbody">
<br/>
<br/>
I was under the impression that ld was just an alias for gcc, but after a bit of experimentation it seems that's not the case. If you use gcc to link instead then the error should go away. You should also add "-nostartfiles" because you're already manually linking in crt0, crtbegin and crtend. (I'm not sure you need crtbegin and crtend, so try removing them if the adjusted .bat file below doesn't fix the problems.)
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
@echo off
<br/>
set CFILES= main.cpp gba.cpp
<br/>
set OFILES= main.o gba.o
<br/>
<br/>
set GAME= z
<br/>
set DEVDIR= C:\devkitadv
<br/>
<br/>
PATH=%DEVDIR%\bin
<br/>
<br/>
set LIBDIR= %DEVDIR%\lib\gcc-lib\arm-agb-elf\3.0.2\interwork
<br/>
set LIBDIR2= %DEVDIR%\arm-agb-elf\lib\interwork
<br/>
set INCDIR= %DEVDIR%\lib\gcc-lib\arm-agb-elf\3.0.2\include
<br/>
set INCDIR2= %DEVDIR%\arm-agb-elf\include
<br/>
<br/>
set CFLAGS= -I. -I%INCDIR% -I%INCDIR2% -c -g -O2 -Wall -fverbose-asm -mthumb-interwork -ILibAAS
<br/>
set LDFLAGS= -L%LIBDIR% -L%LIBDIR2% -mthumb-interwork -nostartfiles -Tlnkscript -lstdc++ -lgcc -lc -LLibAAS -lAAS
<br/>
<br/>
conv2aas AAS_Data
<br/>
<br/>
as -mthumb-interwork -o AAS_Data.o AAS_Data.s
<br/>
<br/>
as crt0.s -o crt0.o
<br/>
<br/>
gcc %CFILES% %CFLAGS%
<br/>
<br/>
gcc -o %GAME%.elf crt0.o crtbegin.o crtend.o AAS_Data.o %OFILES% %LDFLAGS%
<br/>
objcopy -v -O binary %game%.elf %game%.gba
<br/>
del %OFILES%
<br/>
del *.elf
<br/>
pause
<br/>
gbafix %game%.gba
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#15460 - LOst? - Thu Jan 22, 2004 10:29 pm</h4>
    <div class="postbody"><span class="postbody">James Daniels, you did it. It works!
<br/>
<br/>
It works, hurray!
<br/>
<br/>
Now, I have the sync problem, because I use my own interrupt handler. This will be fixed then I use your crt0.s, I believe. Thank you again. *runs away happy*</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#15493 - jd - Fri Jan 23, 2004 4:33 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>LOst? wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
It works, hurray!
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Great. I'm glad to have been some help.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>LOst? wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
Now, I have the sync problem, because I use my own interrupt handler. This will be fixed then I use your crt0.s, I believe.
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
If by "the sync problem" you mean clicking noises then the problem is caused by not responding to Timer 1 interrupts quickly enough. The crt0.s included with AAS does have a special mode that gives priority to Timer 1 interrupts so that other interrupts can't hog the CPU and cause a click. However, this mode has to be enabled by uncommenting a line in crt0.s and you also have to explicitly call AAS_DoWork at least 50 times a second (I recommend doing it each VBL). AASExample2 shows how to do all this.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
