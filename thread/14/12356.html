<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>New! And some coding I'm stuck on...! - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>Beginners > New! And some coding I'm stuck on...!</h2>
<div id="posts">
<div class="post">
    <h4>#117463 - neilio - Sun Feb 04, 2007 11:39 pm</h4>
    <div class="postbody"><span class="postbody">Hi, just thought I'd introduce myself! A couple of weeks ago I got the crazy idea in my head that I wanted to make a vertical scrolling shoot-em-up, no doubt inspired by countless internet Flash games. I first looked at developing on the PC and then released that GBA development would be much more suited to me! So I've been following some tutorials on The Pern Project and quickly dabbled with devkitARM and BoycottAdvance.
<br/>
<br/>
I've got a small amount of basic C experience, and I knocked up this based on one of the Pern tutorials &gt;
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
//program to paint the screen one whole colour
<br/>
//user can increase or decrease saturation of either red, green or blue
<br/>
//the A button toggles between the colours
<br/>
//the UP and DOWN buttons change the saturation of the current colour
<br/>
<br/>
#include &lt;gba.h&gt;
<br/>
<br/>
// Update the screen with a new colour
<br/>
void ScrRefresh(int rwrite,int gwrite, int bwrite)
<br/>
{
<br/>
    unsigned char x,y;
<br/>
<br/>
    for(x = 0; x &lt; SCREEN_WIDTH; x++)   
<br/>
        for(y = 0; y &lt; SCREEN_HEIGHT; y++)  
<br/>
            VideoBuffer [x+ y * SCREEN_WIDTH] = RGB16(rwrite,gwrite,bwrite); 
<br/>
}
<br/>
<br/>
///////////////// C code entry (main())/////////////////////
<br/>
int main()
<br/>
{
<br/>
<br/>
    int red;
<br/>
    int green;
<br/>
    int blue;
<br/>
    int satchange;  //change saturation of current colour up or down
<br/>
    int scrchange;  //flag to control whether screen refreshes or not... 0 - no change, 1 - change
<br/>
    int colmode; //value will choose colour being changed... 0 - change red, 1 - change green, 2 - change blue
<br/>
<br/>
    red=0;
<br/>
    green=0;
<br/>
    blue=0;
<br/>
    satchange=0;
<br/>
    scrchange=0;
<br/>
    colmode=0; //default to red
<br/>
<br/>
    SetMode(MODE_3 | BG2_ENABLE);    
<br/>
<br/>
    ScrRefresh(red,green,blue);
<br/>
<br/>
    while(1)
<br/>
    {
<br/>
        if(!(REG_KEYS &amp; KEY_A))  //if A button is pressed then released, colour mode should change 0&gt;1&gt;2&gt;0&gt;1&gt;2&gt;0...etc
<br/>
        {
<br/>
	    while(!(REG_KEYS &amp; KEY_A))
<br/>
	    {
<br/>
            }
<br/>
<br/>
	    if(colmode&lt;2)
<br/>
	    {
<br/>
                colmode++;
<br/>
	    }
<br/>
<br/>
	    if(colmode=2)
<br/>
	    {
<br/>
	        colmode=0;
<br/>
	    }
<br/>
        }  
<br/>
<br/>
        if(!(REG_KEYS &amp; KEY_UP))  //increase saturation of current colour on UP press
<br/>
        {
<br/>
            satchange++;
<br/>
            scrchange=1;
<br/>
        }
<br/>
<br/>
        if(!(REG_KEYS &amp; KEY_DOWN))  //decrease saturation of current colour on DOWN press
<br/>
        {
<br/>
            satchange--;
<br/>
            scrchange=1;
<br/>
        }
<br/>
<br/>
        if(colmode=0)  //change red value if mode is set to 0
<br/>
	{
<br/>
	    red=red+satchange;
<br/>
<br/>
	    if(red&gt;31)
<br/>
            {
<br/>
	    red=31;
<br/>
	    }
<br/>
<br/>
    	    if(red&lt;0)
<br/>
	    {
<br/>
            red=0;
<br/>
	    }
<br/>
<br/>
	    satchange=0;
<br/>
	}
<br/>
<br/>
        if(colmode=1)  //change green value if mode is set to 0
<br/>
	{
<br/>
	    green=green+satchange;
<br/>
<br/>
	    if(green&gt;31)
<br/>
	    {
<br/>
            green=31;
<br/>
	    }
<br/>
<br/>
    	    if(green&lt;0)
<br/>
	    {
<br/>
            green=0;
<br/>
	    }
<br/>
<br/>
	    satchange=0;
<br/>
	}
<br/>
<br/>
        if(colmode=2)  //change blue value if mode is set to 0
<br/>
	{
<br/>
	    blue=blue+satchange;
<br/>
<br/>
	    if(blue&gt;31)
<br/>
	    {
<br/>
            blue=31;
<br/>
	    }
<br/>
<br/>
    	    if(blue&lt;0)
<br/>
	    {
<br/>
              blue=0;
<br/>
	    }
<br/>
<br/>
	    satchange=0;
<br/>
	}
<br/>
<br/>
<br/>
<br/>
        if(scrchange=1)  //if button has been pressed and colour changed, update the screen
<br/>
        {
<br/>
            ScrRefresh(red,green,blue);
<br/>
            scrchange=0;
<br/>
        }
<br/>
<br/>
<br/>
    }  
<br/>
 }//end main
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I hope you can follow it, I wasn't intending for it to be a work of art. Please forgive me on the structure of it!
<br/>
<br/>
Basically, I'm having the problem that once compiled and running, it's not doing what I want it to do! The A button doesn't change which colour component is being changed (in Boycott Advance, it's stuck on green). The UP and DOWN buttons change the saturation of green, so it's 33% working I guess.
<br/>
<br/>
Can anybody point out where this is going wrong? Cheers!<br/>_________________<br/>I'd like to think this signature is under development, but it isn't.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#117465 - keldon - Mon Feb 05, 2007 12:16 am</h4>
    <div class="postbody"><span class="postbody">Hopefully you are coding with indents! But anyway you should really try to start 'small', instead of trying to begin with a space shooter why not try making something simple like pong.
<br/>
<br/>
I've probably directed people thousands of times; in fact ...
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>keldon wrote:</b></span></td> </tr> <tr> <td class="quote">There was a page written by (I think)Geoff Frohwein about what order you should choose when deciding what games to begin making. e.g. 1: pong clone, 2: tetris clone, 3: Mario vs Luigi clone etc., but I have no idea where I found it or why I can't find it again.</td> </tr></table><span class="postbody">
<br/>
<br/>
I wish I could find that page, although you may also want to go back to the <a class="postlink" href="http://www.coranac.com/tonc/text/" target="_blank">tonc gba tutorials</a> and learn more about tile modes, trying out demos as you go along and then try the following:
<br/>
 - 1: a simple game where you have a 10x10 grid and you simply move your character within it
<br/>
 - 2: continue with game #1 and add some boxes that your character must navigate to; each time you reach your target you respawn another
<br/>
 - 3: follow on from game #2, but this time you will not only ensure that you do not spawn where your character already is, but your player has a tail. This means that if your player moves to the right that his tail follows behind (like snakes)
<br/>
 - 4: make snakes!
<br/>
<br/>
Once you have made snakes you can take your next challenge at tetris; now don't be deceived, tetris can be more complicated than snakes if you want it to feel 'right'.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#117468 - neilio - Mon Feb 05, 2007 12:23 am</h4>
    <div class="postbody"><span class="postbody">Thanks, the quoting messed up the indents on the program... I'd be completly lost if i didn't!
<br/>
<br/>
I'll have to check out the Tonc tutorials, always good to get a second opinion on these things - thanks for the advice!<br/>_________________<br/>I'd like to think this signature is under development, but it isn't.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#117472 - sgeos - Mon Feb 05, 2007 1:11 am</h4>
    <div class="postbody"><span class="postbody">I have an HSB library for the GBA.  Do you want it?
<br/>
<br/>
-Brendan</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#117487 - wintermute - Mon Feb 05, 2007 2:30 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>keldon wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
<br/>
I've probably directed people thousands of times; in fact ...
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>keldon wrote:</b></span></td> </tr> <tr> <td class="quote">There was a page written by (I think)Geoff Frohwein about what order you should choose when deciding what games to begin making. e.g. 1: pong clone, 2: tetris clone, 3: Mario vs Luigi clone etc., but I have no idea where I found it or why I can't find it again.</td> </tr></table><span class="postbody">
<br/>
<br/>
I wish I could find that page
<br/>
</span></td> </tr></table><span class="postbody">
<br/>
<br/>
I believe the page you're talking about was on gamedev.net. Unfortunately they're down for maintainence right now so I can't find the page either.<br/>_________________<br/><a class="postlink" href="http://www.devkitpro.org/" target="_blank">devkitPro - professional toolchains at amateur prices</a>
<br/>
<a class="postlink" href="http://wiki.devkitpro.org/index.php/IRC" target="_blank">devkitPro IRC support</a>
<br/>
<a class="postlink" href="http://davejmurphy.com/" target="_blank">Personal Blog</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#117495 - tepples - Mon Feb 05, 2007 3:46 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>keldon wrote:</b></span></td> </tr> <tr> <td class="quote"> - 1: a simple game where you have a 10x10 grid and you simply move your character within it</td> </tr></table><span class="postbody">
<br/>
On a <a class="postlink" href="http://en.wikipedia.org/wiki/Plane_%28mathematics%29" target="_blank">plane</a>, right?
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote"> - 2: continue with game #1 and add some boxes that your character must navigate to; each time you reach your target you respawn another
<br/>
 - 3: follow on from game #2, but this time you will not only ensure that you do not spawn where your character already is, but your player has a tail. This means that if your player moves to the right that his tail follows behind (like snakes)
<br/>
 - 4: make snakes!</td> </tr></table><span class="postbody">
<br/>
So you have the plane, and you have the <a class="postlink" href="http://en.wikipedia.org/wiki/Snake_%28video_game%29" target="_blank">snakes</a>. But where do you get the <a class="postlink" href="http://en.wikipedia.org/wiki/Snakes_on_a_Plane" target="_blank">Samuel L. Jackson</a>?
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
<br/>
Once you have made snakes you can take your next challenge at tetris; now don't be deceived, tetris can be more complicated than snakes if you want it to feel 'right'.</td> </tr></table><span class="postbody">
<br/>
You're right. By the time you've read everything in the <a class="postlink" href="http://www.tetrisconcept.com/wiki/index.php/Glossary" target="_blank">TCWiki glossary</a>, you see that Tetris franchise is more complicated than some clone developers think.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#117521 - neilio - Mon Feb 05, 2007 10:28 am</h4>
    <div class="postbody"><span class="postbody">Looking up on Tonc I found out something about reading in the button register at the beginning of the main loop cycle and comparing previous/current states of buttons... I'm going to give that a try and see if I can fix up my program with that, looks a lot better than just reading the button register straight out.<br/>_________________<br/>I'd like to think this signature is under development, but it isn't.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#117531 - neilio - Mon Feb 05, 2007 12:31 pm</h4>
    <div class="postbody"><span class="postbody">I've made some changes and it's working now:
<br/>
1) The colour mode is now changed only when the A button is released
<br/>
2) The way the colour mode is incremented and looped has been changed
<br/>
3) The If statements for changing the saturation of the selected colour have been replaced with a Switch statement
<br/>
<br/>
There's still some work to be done to make the code tidier and shorter, but it's working now and the user can select any one of 32,000+ colours as the screen colour... though quite why you'd want to, I don't know. I was just doing it to get used to programming in C again!
<br/>
<br/>
Here's the code (I've used the key handling procedures from Tonc in the header file by the way):
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
//program to paint the screen one whole colour
<br/>
//user can increase or decrease saturation of either red, green or blue
<br/>
//the A button toggles between the colours
<br/>
//the UP and DOWN buttons change the saturation of the current colour
<br/>
<br/>
#include &lt;gba.h&gt;
<br/>
<br/>
// Globals to hold the key state
<br/>
u16 key_curr=0, key_prev=0;
<br/>
<br/>
// Update the screen with a new colour
<br/>
void ScrRefresh(int rwrite,int gwrite, int bwrite)
<br/>
{
<br/>
    unsigned char x,y;
<br/>
<br/>
    for(x = 0; x &lt; SCREEN_WIDTH; x++)   
<br/>
        for(y = 0; y &lt; SCREEN_HEIGHT; y++)  
<br/>
            VideoBuffer [x+ y * SCREEN_WIDTH] = RGB16(rwrite,gwrite,bwrite); 
<br/>
}
<br/>
<br/>
///////////////// C code entry (main())/////////////////////
<br/>
int main()
<br/>
{
<br/>
    int red;
<br/>
    int green;
<br/>
    int blue;
<br/>
    int satchange;  //change saturation of current colour up or down
<br/>
    int scrchange;  //flag to control whether screen refreshes or not... 0 - no change, 1 - change
<br/>
    int colmode; //value will choose colour being changed... 0 - change red, 1 - change green, 2 - change blue
<br/>
<br/>
    red=0;
<br/>
    green=0;
<br/>
    blue=0;
<br/>
    satchange=0;
<br/>
    scrchange=0;
<br/>
    colmode=0; //default to red
<br/>
 
<br/>
    SetMode(MODE_3 | BG2_ENABLE);    
<br/>
 
<br/>
    ScrRefresh(red,green,blue);
<br/>
<br/>
    while(1)
<br/>
    {
<br/>
   key_poll();
<br/>
<br/>
        if(key_released(KEY_A))  //if A button is pressed then released, colour mode should change 0&gt;1&gt;2&gt;0&gt;1&gt;2&gt;0...etc
<br/>
        {
<br/>
       colmode++;
<br/>
<br/>
       if(colmode&gt;2)
<br/>
       {
<br/>
      colmode=0;
<br/>
       }
<br/>
        } 
<br/>
<br/>
        if(key_is_down(KEY_UP))  //increase saturation of current colour on UP press
<br/>
        {
<br/>
            satchange++;
<br/>
            scrchange=1;
<br/>
        }
<br/>
 
<br/>
        if(key_is_down(KEY_DOWN))  //decrease saturation of current colour on DOWN press
<br/>
        {
<br/>
            satchange--;
<br/>
            scrchange=1;
<br/>
        }
<br/>
<br/>
   switch(colmode)  //changes saturation of currently selected colour
<br/>
   {
<br/>
       case 0:
<br/>
      red=red+satchange;
<br/>
      satchange=0;
<br/>
      break;
<br/>
       case 1:
<br/>
      green=green+satchange;
<br/>
      satchange=0;
<br/>
      break;
<br/>
       case 2:
<br/>
      blue=blue+satchange;
<br/>
      satchange=0;
<br/>
      break;      
<br/>
   }
<br/>
<br/>
   // following if statements stop colour variables being outside RGB boundaries
<br/>
<br/>
   if(red&gt;31)
<br/>
        {
<br/>
       red=31;
<br/>
   }
<br/>
<br/>
       if(red&lt;0)
<br/>
   {
<br/>
            red=0;
<br/>
   }
<br/>
<br/>
   if(green&gt;31)
<br/>
   {
<br/>
            green=31;
<br/>
   }
<br/>
<br/>
       if(green&lt;0)
<br/>
   {
<br/>
            green=0;
<br/>
   }
<br/>
<br/>
   if(blue&gt;31)
<br/>
   {
<br/>
            blue=31;
<br/>
   }
<br/>
<br/>
       if(blue&lt;0)
<br/>
   {
<br/>
            blue=0;
<br/>
   }
<br/>
<br/>
<br/>
        if(scrchange=1)  //if button has been pressed and colour changed, update the screen
<br/>
        {
<br/>
            ScrRefresh(red,green,blue);
<br/>
            scrchange=0;
<br/>
        }      
<br/>
    }  
<br/>
 }//end main
<br/>
</td> </tr></table><span class="postbody"><br/>_________________<br/>I'd like to think this signature is under development, but it isn't.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#117551 - Cearn - Mon Feb 05, 2007 4:30 pm</h4>
    <div class="postbody"><span class="postbody">Also interesting: using an array to store the R,G,B values instead of variables. Then you can do something like this:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">int shades[3]= {0, 0, 0};
<br/>
<br/>
... stuff ... 
<br/>
<br/>
if( key_is_down(KEY_UP | KEY_DOWN) )
<br/>
{
<br/>
    if( shades[colmode]&gt;0 &amp;&amp; key_is_down(KEY_DOWN) )
<br/>
        shades[colmode]--;
<br/>
    else if( shades[colmode]&lt;31 &amp;&amp; key_is_down(KEY_UP) )
<br/>
        shades[colmode]++;
<br/>
<br/>
    ScrRefresh(RGB16(shades[0], shades[1], shades[2]));
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
This would replace everything from the KEY_UP test on down in the main loop. Additionally, it's always a good idea to have some sort of timing for the main loop like waiting for the VBlank. It's not really necessary here because your ScrRefresh() takes three frames, but it's still something to think about for later.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#117671 - neilio - Tue Feb 06, 2007 2:44 pm</h4>
    <div class="postbody"><span class="postbody">Thanks, it's really good to see an example of code that's been 'optimized' (in the C program sense, not compiling). Hopefully I'll try applying that kind of logic in future when writing code.
<br/>
<br/>
I'll give the VBlank timing a try so I can get used to using it, and I want to do a little more with this program before I move on to sprites and tiled backgrounds.<br/>_________________<br/>I'd like to think this signature is under development, but it isn't.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#117705 - Miked0801 - Tue Feb 06, 2007 7:48 pm</h4>
    <div class="postbody"><span class="postbody">Nasty bug in your last if:
<br/>
<br/>
if(scrchange=1)  //if button has been pressed and colour changed, update the screen 
<br/>
<br/>
Will always return TRUE and assing scrchange to 1.  Here's a quick pass to make your code a bit more readable (in my opinion).  It uses constants and enums to make the code closer to english.  It also minimizes a lot other code calling.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#define COLOR_MIN_SATURATION  0
<br/>
#define COLOR_MAX_SATURATION  31
<br/>
<br/>
typedef enum
<br/>
{
<br/>
   COLOR_FIRST,
<br/>
<br/>
   COLOR_RED = COLOR_FIRST,
<br/>
   COLOR_GREEN,
<br/>
   COLOR_BLUE,
<br/>
<br/>
   COLOR_MAX,
<br/>
} COLOR_TYPE;
<br/>
<br/>
int main(void) 
<br/>
{ 
<br/>
   u32 colors[COLOR_MAX];
<br/>
   COLOR_TYPE colmode; //value will choose colour being changed... 0 - change red, 1 - change green, 2 - change blue 
<br/>
   s32 satchange;  //change saturation of current colour up or down 
<br/>
<br/>
   colors[COLOR_RED] = 0;
<br/>
   colors[COLOR_GREEN] = 0;
<br/>
   colors[COLOR_BLUE] = 0;
<br/>
<br/>
   satchange = 0; 
<br/>
<br/>
   colmode = COLOR_RED; //default to red 
<br/>
  
<br/>
   SetMode(MODE_3 | BG2_ENABLE);    
<br/>
  
<br/>
   // I would change this function to accept the colors array directly.  Cleaner to code with
<br/>
   ScrRefresh(colors); 
<br/>
<br/>
   while(1) 
<br/>
   { 
<br/>
      key_poll(); 
<br/>
<br/>
      if(key_released(KEY_A))  //if A button is pressed then released, colour mode should change 0&gt;1&gt;2&gt;0&gt;1&gt;2&gt;0...etc 
<br/>
      { 
<br/>
         colmode++; 
<br/>
<br/>
         if(colmode &gt;= COLOR_MAX) 
<br/>
         { 
<br/>
            colmode = COLOR_FIRST; 
<br/>
         } 
<br/>
      } 
<br/>
<br/>
      if(key_is_down(KEY_UP))  //increase saturation of current colour on UP press 
<br/>
      { 
<br/>
         if(color[colMode] &lt; COLOR_MAX_SATURATION)
<br/>
         {
<br/>
            satchange++; 
<br/>
         }
<br/>
      } 
<br/>
  
<br/>
      if(key_is_down(KEY_DOWN))  //decrease saturation of current colour on DOWN press 
<br/>
      { 
<br/>
         if(color[colMode] &gt; COLOR_MIN_SATURATION)
<br/>
         {
<br/>
            satchange--; 
<br/>
         }
<br/>
      } 
<br/>
<br/>
      if(satchange)
<br/>
      {
<br/>
         color[colMode] += satchange;
<br/>
         satchange = 0;
<br/>
<br/>
         // Assume Refresh takes the array now
<br/>
         ScrRefresh(colors); 
<br/>
      }      
<br/>
   }  
<br/>
}//end main 
<br/>
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Untested/uncompiled, but it gets my points across.  I dropped the scrChange var as you don't need it, but it could easily be added back in if you had other stuff going on.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#117706 - sgeos - Tue Feb 06, 2007 8:05 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Miked0801 wrote:</b></span></td> </tr> <tr> <td class="quote">Nasty bug in your last if:
<br/>
<br/>
if(scrchange=1)  //if button has been pressed and colour changed, update the screen </td> </tr></table><span class="postbody">
<br/>
Everyone has probably been hit by this.  To avoid the above bug, you can write test cases like this:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">if (1 = variable)</td> </tr></table><span class="postbody">
<br/>
The compiler will complain that you can't set 1 to variable, then you can fix it:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">if (1 == variable)</td> </tr></table><span class="postbody">
<br/>
Admittedly, the mental exercise is often enough to avoid such bugs in the first place.
<br/>
<br/>
-Brendan</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#117731 - neilio - Wed Feb 07, 2007 12:26 am</h4>
    <div class="postbody"><span class="postbody">So I should have been using ==... doh! Should have known better, that's why the screen was refreshing constantly.
<br/>
<br/>
I've put in the code for Vblank waiting and I've now got a white line box on the screen, drawn on top of the coloured background. Since the box is flickering when the screen is being refreshed constantly (ie up/down button held down), I'm assuming this is because the routines for writing the pixels take longer to write the pixels than Vblank does?<br/>_________________<br/>I'd like to think this signature is under development, but it isn't.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#117747 - sgeos - Wed Feb 07, 2007 2:34 am</h4>
    <div class="postbody"><span class="postbody">A complete mode 3 screen refresh can not be done every frame.
<br/>
The framerate should drop, but I'd do something like this:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">writePixelsToBufferInRAM();
<br/>
waitForVblank();
<br/>
dmaPixelsToVram();</td> </tr></table><span class="postbody">
<br/>
You might need/want to spread the DMA across 2 frames.  I don't think that you can refresh in one frame even using DMA, but I might be wrong.
<br/>
<br/>
-Brendan</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#117753 - tepples - Wed Feb 07, 2007 3:15 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>sgeos wrote:</b></span></td> </tr> <tr> <td class="quote">I don't think that you can refresh in one frame even using DMA</td> </tr></table><span class="postbody">
<br/>
Copying from EWRAM to VRAM happens at 4 cycles per 2-byte pixel. This comes out to 153600 cycles for a full screen copy, or 55 percent of the frame time.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#117757 - sgeos - Wed Feb 07, 2007 4:02 am</h4>
    <div class="postbody"><span class="postbody">How far into V-Draw is that?  I guess what I really want to know is, can DMA be for a full screen refresh in optimum conditions?  Even so, you are left with 45% of the frame to write to the frame buffer (using brute force, this is impossible) and do everything else (sprites, sound, ai).  Would sound DMA get in the way?
<br/>
<br/>
I think a 30 FPS interlaced structure might work:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">writeToPixelRAMBuffer(); 
<br/>
waitForVblank(); 
<br/>
dmaPixels();
<br/>
updateGameState();
<br/>
writeToOamRAMBuffer();
<br/>
waitForVblank(); 
<br/>
dmaOam();</td> </tr></table><span class="postbody">
<br/>
Although writeToPixelRAMBuffer() might want to be spread across 2 frames.
<br/>
<br/>
<span style="font-weight: bold">EDIT:</span>  V-Draw takes longer than 55% of a frame- ie, DMA finishes faster than the video controller so it should work.  DMA should remain ahead of the video controller as long as it is started at least 1232 (one scanline) cycles before V-Draw begins.  It should lag behind the video controller (ie, update VRAM for the next frame) as long as it starts after 153600 (DMA) + 1232 (one scanline) cycles before V-Blank begins; it can start on or after scanline 35.
<br/>
<br/>
-Brendan</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#117808 - Miked0801 - Wed Feb 07, 2007 7:32 pm</h4>
    <div class="postbody"><span class="postbody">Sounds about right.  This is how I did my first ever GBA scroll routine way back when.  Using 15-bit color mode, I refreshed the whole screen every time the position changed by starting the DMA redraw with a vcount interrupt.  It worked, but it wasn't practical for a full game :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#117810 - neilio - Wed Feb 07, 2007 8:19 pm</h4>
    <div class="postbody"><span class="postbody">Since I'm going to be downloading the program to EWRAM by a multiboot cable, I'll need to leave space between the beginning of the EWRAM 'display buffer' and the end of the program. Since the size required for the screen is 75kB (240 * 160 * 2 bytes/pixel) I assume starting the RAM buffer somewhere about 0202:0000 hex would be fine?<br/>_________________<br/>I'd like to think this signature is under development, but it isn't.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#117812 - wintermute - Wed Feb 07, 2007 8:36 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>neilio wrote:</b></span></td> </tr> <tr> <td class="quote">Since I'm going to be downloading the program to EWRAM by a multiboot cable, I'll need to leave space between the beginning of the EWRAM 'display buffer' and the end of the program. Since the size required for the screen is 75kB (240 * 160 * 2 bytes/pixel) I assume starting the RAM buffer somewhere about 0202:0000 hex would be fine?</td> </tr></table><span class="postbody">
<br/>
<br/>
There are a couple of ways you can handle this, the most convenient is just to use malloc to allocate a buffer. Some of the newlib standard functions can get a bit heavy though so it depends on how much space you need for the rest of your code and variable space ( malloc adds around 32k iirc).
<br/>
<br/>
The other way is to use the address of the end of your application defined by the devkitARM linkscripts. Use this code to get that address
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
extern unsigned char __end__[];
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
You may need to align this value for use with DMA but it should be much safer than just randomly choosing an arbitrary constant address.<br/>_________________<br/><a class="postlink" href="http://www.devkitpro.org/" target="_blank">devkitPro - professional toolchains at amateur prices</a>
<br/>
<a class="postlink" href="http://wiki.devkitpro.org/index.php/IRC" target="_blank">devkitPro IRC support</a>
<br/>
<a class="postlink" href="http://davejmurphy.com/" target="_blank">Personal Blog</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#117816 - sgeos - Wed Feb 07, 2007 9:17 pm</h4>
    <div class="postbody"><span class="postbody">Seems like mode 4 (indexed bitmap mode) might make for a good data size/quality trade off.  I don't know if you are in a position to deal with indexed images.
<br/>
<br/>
-Brendan</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#117831 - neilio - Wed Feb 07, 2007 11:44 pm</h4>
    <div class="postbody"><span class="postbody">Got the EWRAM pixel buffer set up now and have almost got the DMA transfer into the video RAM, except that not all of the pixels are transferring... only about 7/8ths are transferred.
<br/>
<br/>
Because the DMA count in its register is 16 bits, I can set up to FFFF for the count (FFFF * 32 bits for the DMA register = 2097120 bits moved?). Now, the whole of the pixel data is 614400 bits (240 * 160 * 2 (bytes) * 8 (bits per byte)  = 614400?)... so I must have got something wrong somewhere!
<br/>
<br/>
I've tried moving the pixel RAM buffer forward in EWRAM but the same still happens. If anyone can correct me on this I'd much appreciate it! Apologies for keeping on asking questions...
<br/>
<br/>
This is the DMA routine I'm using:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void DmaPixels(void *dst, const void *src, u16 count)
<br/>
{
<br/>
    REG_DMA0CNT = 0; // shut off any previous transfer
<br/>
    REG_DMA0SAD = src;
<br/>
    REG_DMA0DAD = dst;
<br/>
    REG_DMA0CNT = count | DMA_32NOW;
<br/>
}</td> </tr></table><span class="postbody"><br/>_________________<br/>I'd like to think this signature is under development, but it isn't.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#117832 - gmiller - Thu Feb 08, 2007 12:25 am</h4>
    <div class="postbody"><span class="postbody">You might try a 16 bit transfer instead of a 32 bit if your data is not aligned on a 4 byte boundary.  I had problems with OAM transfers using DMA and I corrected it by using the alignment directives to force my local copy to a 4 byte aligned address.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#117836 - neilio - Thu Feb 08, 2007 12:36 am</h4>
    <div class="postbody"><span class="postbody">Sorry to sound dumb but how would you go about aligning data?<br/>_________________<br/>I'd like to think this signature is under development, but it isn't.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#117843 - gmiller - Thu Feb 08, 2007 1:44 am</h4>
    <div class="postbody"><span class="postbody">I use the following:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
<br/>
#define ALIGN(m)   __attribute__((aligned (m)))
<br/>
<br/>
//create an array of 128 sprites equal to OAM
<br/>
static Sprite sprites[128] ALIGN (4);
<br/>
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#117849 - sgeos - Thu Feb 08, 2007 2:06 am</h4>
    <div class="postbody"><span class="postbody">Why not use devkitpro's dmaCopy?
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#include &lt;gba_dma.h&gt;
<br/>
dmaCopy(src, dst, size);</td> </tr></table><span class="postbody">
<br/>
<br/>
-Brendan</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#118289 - neilio - Sun Feb 11, 2007 10:16 pm</h4>
    <div class="postbody"><span class="postbody">Thanks for the help, the program now works pretty much as I wanted it to. I'll add some more features but in slow time (such as showing the BGR value of the colour as text).
<br/>
<br/>
I've also been working with sprites, with the aid of Usenti for converting graphics I now have a little character sprite that can fall from sky and jump up in the air (with basic acceleration included) and lands on/falls off platforms reasonably well. Unfortunately there's no background yet, so I'll work on that next.
<br/>
<br/>
I've also made an Xboo cable...cheap and simple, but it's really great to be able to see what you've done on a real Game Boy - makes programming something all the more rewarding!
<br/>
<br/>
P.S. On second look, backgrounds are slightly confusing... can anybody point me in the direction of good tutorial/example codes other than Pern/Tonc?<br/>_________________<br/>I'd like to think this signature is under development, but it isn't.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
