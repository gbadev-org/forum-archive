<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Sprites being overwritten - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>Beginners > Sprites being overwritten</h2>
<div id="posts">
<div class="post">
    <h4>#49269 - blacksun - Wed Jul 27, 2005 11:31 pm</h4>
    <div class="postbody"><span class="postbody">I have a little tic-tac-toe game that uses 2 different sprites.  I have a function that when the user presses A the X sprite will be placed and when B is pressed the O sprite is placed.  This works for the most part.  However, when the user inputs two of the same sprites at the beginning the rest of the sprites placed will be of that sprite.  Their tile index changes accordingly though.  I have the X sprite at 512 and O at 514 because they are 8x8, 256 color in Mode 3.
<br/>
<br/>
Another problem is if the O sprite is added first, then an X sprite is added, it swaps the images but keeps the index the same.
<br/>
<br/>
So here is the code that I have for these two functions.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void AddSprite(int x, int y, int type)
<br/>
{
<br/>
   u16 i;
<br/>
<br/>
   int index = numOfSprites - 1;
<br/>
   u16 spriteIndex;
<br/>
<br/>
   sprites[index].attribute0 = COLOR_256 | SQUARE | y;
<br/>
   sprites[index].attribute1 = SIZE_8 | x;
<br/>
<br/>
   if(type == 1)
<br/>
   {
<br/>
      spriteIndex = 512;
<br/>
<br/>
      for(i = (index) * xDim * X_FRAMES; i &lt; (xDim * X_FRAMES) * (index) + (xDim * X_FRAMES); i++)
<br/>
               OAMData3[i] = xData[i - (index) * xDim * X_FRAMES];
<br/>
<br/>
   }
<br/>
   else if(type == 2)
<br/>
   {
<br/>
      spriteIndex = 514;
<br/>
<br/>
      for(i = (index) * oDim * O_FRAMES; i &lt; (oDim * O_FRAMES) * (index) + (oDim * O_FRAMES); i++)
<br/>
         OAMData3[i] = oData[i - (index) * oDim * O_FRAMES];
<br/>
<br/>
   }
<br/>
<br/>
    sprites[index].attribute2 = spriteIndex;
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
numOfSprites is a global variable that updates before the sprite is added.
<br/>
<br/>
OAMData3 is the address 0x6014000</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#49300 - Cearn - Thu Jul 28, 2005 9:15 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>blacksun wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">OAMData3 is the address 0x6014000</td> </tr></table><span class="postbody"></span></td> </tr></table><span class="postbody">It's good that you added this remark, as this isn't actually OAM data at all, but the part of VRAM that houses object tiles. Anyhoo ...
<br/>
<br/>
I have a feeling that updating the graphics is off. I'm assuming that xData and oData contain the sprites, and that numOfSprites is updated after every placement, right? This code:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>blacksun wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">      for(i = (index) * xDim * X_FRAMES; i &lt; (xDim * X_FRAMES) * (index) + (xDim * X_FRAMES); i++) 
<br/>
               OAMData3[i] = xData[i - (index) * xDim * X_FRAMES]; </td> </tr></table><span class="postbody"></span></td> </tr></table><span class="postbody">
<br/>
is equivalent to (the simpler and clearer)
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">int nn= xDim*X_FRAMES;
<br/>
for(i=0; i&lt;nn; i++)
<br/>
   OAMData3[i+index*nn]= xData[i];
<br/>
</td> </tr></table><span class="postbody">
<br/>
And you have this in both 1 and 2 types. What this does is fill successive tiles in VRAM after each call. OAM (the stuff at 0x0700:0000 and the sprites array) merely points to the tiles you want to use. Since you only use 512 and 514, you'll always just use the first two 8bpp tiles. That is to say, the tiles that are filled in the <span style="font-weight: bold">first</span> two calls of AddSprite; the rest are pretty much ignored.
<br/>
<br/>
Remove the tile-writing from AddSprite and fill both tiles at startup. (And perhaps rename OAMData3, 0x0601:4000 is not part of OAM and can only lead to confusion (Oh, and don't use halfwords for local variables, ints are faster))</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#49319 - tepples - Thu Jul 28, 2005 5:17 pm</h4>
    <div class="postbody"><span class="postbody">The name "OAMData3" for sprite cel VRAM comes from some old and deprecated tutorial. Here's my own macro that may help you understand better:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#define SPR_VRAM(x) ((u32 *)(0x06010000 | ((x) &lt;&lt; 5)))
<br/>
</td> </tr></table><span class="postbody">
<br/>
Thus, the locations in sprite cel VRAM in question would be SPR_VRAM(512) and SPR_VRAM(514).<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#49334 - blacksun - Thu Jul 28, 2005 9:39 pm</h4>
    <div class="postbody"><span class="postbody">Wow, I'm shocked I even got anything working.  With your suggestions and looking at other examples, I finally got my act together.  Thanks a bunch you two.  
<br/>
<br/>
This is how it looks like now for all those who are interested.
<br/>
<br/>
Here is the new InitSprites function that sets up the SpriteData
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
void InitSprites()
<br/>
{
<br/>
   int i;
<br/>
    
<br/>
   int xn = xDim * X_FRAMES;
<br/>
   int on = oDim * O_FRAMES;
<br/>
<br/>
   for(i = 0; i &lt; xn; i++)
<br/>
      SpriteData3[i] = xData[i];
<br/>
<br/>
   for(i = 0; i &lt; on; i++)
<br/>
      SpriteData3[i+xn] = oData[i];
<br/>
   
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Renamed OAMData3 to SpriteData3 (with memory loc at 0x6014000) for a more accurate representation of the address.
<br/>
<br/>
So now all I have to do is access those tiles:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
void AddSprite(int x, int y, int type)
<br/>
{
<br/>
   int i;
<br/>
<br/>
   int index = numOfSprites - 1;
<br/>
<br/>
   sprites[index].attribute0 = COLOR_256 | SQUARE | y;
<br/>
   sprites[index].attribute1 = SIZE_8 | x;
<br/>
<br/>
   if(type == 1)
<br/>
      sprites[index].attribute2 = 512;
<br/>
   else if(type == 2)
<br/>
      sprites[index].attribute2 = 514;
<br/>
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Then just copy the sprites array into OAM memory (0x7000000) and it works.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
