<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>background display problem (solved) - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>Beginners > background display problem (solved)</h2>
<div id="posts">
<div class="post">
    <h4>#172704 - zelbo - Thu Feb 25, 2010 11:47 pm</h4>
    <div class="postbody"><span class="postbody">Up til now, i've been using one function per background, but i'm trying to organize my code a bit better, since at some point i will be needing stuff like this to be more reusable. All of my sample maps are currently predefined constants, eventually they're going to be built on the fly.
<br/>
<br/>
the old way, that works:
<br/>
in display.cpp:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">int drawTerrain()
<br/>
{
<br/>
   int bgMap = bgInit(TERRAIN_LAYER, BgType_Text4bpp, BgSize_T_512x512, BG_TERRAIN_MB, BG_MAIN_TB);
<br/>
   dmaCopy(testmap3, bgGetMapPtr(bgMap), sizeof(testmap3));
<br/>
   return bgMap;
<br/>
}</td> </tr></table><span class="postbody">
<br/>
called from game.cpp with:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">bgTerrain = drawTerrain();
<br/>
</td> </tr></table><span class="postbody">
<br/>
I've got a copy of the whole mess for each background layer (terrain, items, fog of war)
<br/>
<br/>
now i'm trying to do something like this:
<br/>
display.cpp:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">int setBackground(int layer, const unsigned short* map, int mapbase, int tilebase)
<br/>
{
<br/>
   int background = bgInit(layer, BgType_Text4bpp, BgSize_T_512x512, mapbase, tilebase);
<br/>
   dmaCopy(map, bgGetMapPtr(background), sizeof(map));
<br/>
   return background;
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
game.cpp
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">bgTerrain = setBackground(TERRAIN_LAYER, testmap3, BG_TERRAIN_MB, BG_MAIN_TB);</td> </tr></table><span class="postbody">
<br/>
also tried:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">int setBackground(int layer, const unsigned short map[4096], int mapbase, int tilebase)
<br/>
</td> </tr></table><span class="postbody">
<br/>
both of my attemps at changing it compile without error, but when i run it, i just get a purple background (my clear color), except for two tiles in the upper left corner of the screen (???). I imagine this is why i need to start using containers for my arrays.
<br/>
Oh, and i initialize my backgrounds with this:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void initBackground()
<br/>
{
<br/>
   int bg = bgInit(TERRAIN_LAYER, BgType_Text4bpp, BgSize_T_512x512, BG_TERRAIN_MB, BG_MAIN_TB);
<br/>
   dmaCopy(bgTiles, bgGetGfxPtr(bg), sizeof(bgTiles));
<br/>
   dmaCopy(bgPal, BG_PALETTE, sizeof(bgPal));
<br/>
}</td> </tr></table><span class="postbody">
<br/>
which could probably be done differently. haven't messed with bgSetTileBase much yet.
<br/>
<br/>
Any ideas?</span><span class="gensmall"><br/><br/>Last edited by zelbo on Fri Feb 26, 2010 5:22 am; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#172706 - Azenris - Fri Feb 26, 2010 12:29 am</h4>
    <div class="postbody"><span class="postbody">sizeof(map) would give you the size of the pointer. which isn't what you want. I think.<br/>_________________<br/><a class="postlink" href="http://sacredpotion.blogspot.com/" target="_blank"><span style="color: red">My Homebrew Games</span></a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#172707 - zelbo - Fri Feb 26, 2010 12:34 am</h4>
    <div class="postbody"><span class="postbody">ok, so you think it would work if i just changed the sizeof(map) to whatever the size actually is? I don't currently plan on changing the size of my maps, i'm pretty happy with 64x64 tiles. or maybe i need to pass that in to start with...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#172710 - sajiimori - Fri Feb 26, 2010 2:24 am</h4>
    <div class="postbody"><span class="postbody">Try this:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">struct Map
<br/>
{
<br/>
  unsigned short array[4096];  // Maybe use a 2D array instead?
<br/>
};
<br/>
<br/>
int setBackground(int layer, const Map&amp; map, int mapbase, int tilebase);</td> </tr></table><span class="postbody">
<br/>
Then sizeof(map) will give the correct result.
<br/>
<br/>
In plain C, pass a const Map* instead, and use sizeof(*map).</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#172712 - zelbo - Fri Feb 26, 2010 4:36 am</h4>
    <div class="postbody"><span class="postbody">Interesting. I've fixed it for now by using a constant that represents the size of a map, since they're all the same, and i don't plan on changing them anytime soon. But i might try your method, sajiimori. I need to get in the habit of wrapping things. Haven't quite focused on that yet, but i do plan on using more containers for things like arrays.
<br/>
As for making it 2D, i'm still undecided about that. My first sample maps were copies of dovoto's smileyface map from the all in one example that i made some changes to, so i've just been working with 1D arrays and doing some math when needed. I guess the math would be a bit of a slow-down, but thats only during level loads, so i'm not sure how much of an impact that has on everything. Do you think 2D arrays would be better?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#172725 - sajiimori - Fri Feb 26, 2010 8:03 pm</h4>
    <div class="postbody"><span class="postbody">2D arrays aren't magic -- memory is 1D no matter what you do.  Transforming between 2D and 1D indices requires the same math either way, so use whichever you prefer.  I just like using 2D arrays when my data is conceptually 2D.
<br/>
<br/>
(But come to think of it, GBA background data is sometimes kinda 4D, when it's a 2D array of 2D screen blocks, rather than being linear.)</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
