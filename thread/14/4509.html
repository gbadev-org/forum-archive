<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Hblanks - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>Beginners > Hblanks</h2>
<div id="posts">
<div class="post">
    <h4>#30407 - mr_square - Wed Dec 01, 2004 12:09 am</h4>
    <div class="postbody"><span class="postbody">Hi all. I'm currently looking at manipulating my background scroll values during the Hblank period to produce a typical wave'y effect (specifically I'm trying to make some water look as if it is flowing)
<br/>
<br/>
I've read up on some of the topics on here, but I'm still a bit confused about how to actually manipulate stuff during the hblank period. From what I can gather, REG_VCOUNT increases after each horizontal line, until it gets to 160, at which point its not drawing to the screen and you can manipulate everything freely.
<br/>
<br/>
I currently wait for a VSync using:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
while((volatile u16)REG_VCOUNT != 160)
<br/>
    {
<br/>
        AAS_DoWork();
<br/>
    }
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
(I'm using the AAS audio mixer, which is the function being called there). 
<br/>
<br/>
To calculate an Hblank would you just do something like 
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">while((volatile u16)REG_VCOUNT &lt; 160)</td> </tr></table><span class="postbody">
<br/>
and then alter the scroll values depending on which hBlank you were on?
<br/>
<br/>
That seems a bit simple, so I'm sure it can't be right (it certainly doesn't do anything when I try it in my code). Also, I hear people saying you need to specifically enable hblank interrupts - how do you do this? I assumed it was all just automatically tied to REG_VCOUNT.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#30411 - identitycrisisuk - Wed Dec 01, 2004 1:04 am</h4>
    <div class="postbody"><span class="postbody">Hi, strangely enough I was looking at doing the same effect myself the other day, to make my fog background layer wibble. I didn't get it working as I started to get slowdown (on hardware!) and thought it was finally time to optimise my crappy background scrolling (which I think I've got now). I was following some interrupt stuff, which wasn't too bad though to make it really of much use you need to write an interrupt handler, which a lot of people seem to say should be in asm :s
<br/>
<br/>
So anyway, this is what I've got:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">int offset = 0;
<br/>
<br/>
void IrqHandler(void)
<br/>
{
<br/>
   int temp = offset &amp; 7;
<br/>
   ++offset;
<br/>
   REG_BG1HOFS = temp;
<br/>
   REG_IF = REG_IF;
<br/>
}</td> </tr></table><span class="postbody">
<br/>
IrqHandler is what you do each HBlank, that's just something really nasty that will make your background look all jaggerdy. offset is a global. You need the REG_IF = REG_IF at the end, even though it looks a bit pointless.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">REG_IRQ_HANDLER = IrqHandler;
<br/>
REG_DISPSTAT = (1&lt;&lt;4);
<br/>
REG_IE = (1&lt;&lt;1);
<br/>
REG_IME = 1;</td> </tr></table><span class="postbody">
<br/>
This is before I enter my main loop, first you set the IRQ_HANDLER register to point to the function you are using to handle interrupts. I didn't actually have this defined and had to add it, if you're in the same boat it's:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#define REG_IRQ_HANDLER   (*(fp*)0x3007FFC)</td> </tr></table><span class="postbody">
<br/>
Where fp is:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">typedef void (*fp)(void);</td> </tr></table><span class="postbody">
<br/>
The REG_DISPSTAT thing is where you say you want to enable HBlank interrupts erm, and so is RE_IE from what I can get from the Register spec list I have at the moment. I know there's a differerence and you do need both. Then REG_IME is the master interrupts enable option type thingy. That code works, seems to look horrible on emulator but looks okay on hardware, not quite sure why....<br/>_________________<br/></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">CanIKickIt(YES_YOU_CAN);</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#30422 - mr_square - Wed Dec 01, 2004 2:21 am</h4>
    <div class="postbody"><span class="postbody">Wow - thanks man, that helped a lot, and I understand some foreign code that I didn't before, which is nice. In case anyone is interested:
<br/>
<br/>
<br/>
I'm using the AAS Audio Mixer, which provides its own interrupt handler function, so it seems that REG_IRQ_HANDLER is already loaded up with a pointer to that funtion. I just added an 'if' statement in the function to check if it was the HBlank interrupt that was being detected, and then added identityCrisis' code to do the wibbly background effect.
<br/>
<br/>
<br/>
REG_DISPSTAT = (1&lt;&lt;4); 
<br/>
REG_IE = (1&lt;&lt;1); 
<br/>
REG_IME = 1;
<br/>
<br/>
These lines gave me some grief, as they screwed up the sound completely, but I figured that they were probably overwriting settings that the AAS mixer had already set them up with. I just 'or'ed the current values of the registers with those new ones, and everything works perfectly :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#30459 - identitycrisisuk - Wed Dec 01, 2004 11:55 am</h4>
    <div class="postbody"><span class="postbody">Kewl, glad to be of help. Should have thought that you'd already have interrupts on if you're using sound. If it's that easy to write your own interrupt handling on top of AAS's I might have to try it sometime, it would take me a long time to learn enough ASM to write a very optimised audio mixer and interrupt handler. You probably don't need the REG_IME = 1 line at all now and you're right about ORing together the other ones.
<br/>
<br/>
The example I looked at had VBlank interrupts as well, which is probably a good idea to have in, that way you can set variables for effects each time a whole screen has been drawn, my way is a bit hacky. I'm guessing for a really nice water effect you'd use values from a sin/cos table. If I get round to doing it properly I'd need to add these values to REG_BG1HOFS as the background is also moving. I think REG_BG1HOFS is read only though so I'd have to put my data into some other variable.<br/>_________________<br/></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">CanIKickIt(YES_YOU_CAN);</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
