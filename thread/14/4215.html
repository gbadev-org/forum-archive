<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Getting a build to work - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>Beginners > Getting a build to work</h2>
<div id="posts">
<div class="post">
    <h4>#27509 - SmegPlaza - Thu Oct 14, 2004 1:15 pm</h4>
    <div class="postbody"><span class="postbody">Hi,
<br/>
<br/>
I've tried posting in the Coding forum but, apart from some really good help from DiscoStew, I've had a limited response. So I'm trying here...
<br/>
<br/>
I've got DevKitARM R8 and am trying to set up a build of mixed C and assembler files, using the GCC, AS and LD tools (as opposed to a trivial build with one C file, compiled and linked by a single call to GCC).
<br/>
<br/>
I can get compilation and assembly to work fine, but linking seems to be a problem...
<br/>
<br/>
Here's a much simplified version of my makefile (if it doesn't work, go back to basics right ?!):
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">PATH=C:\temp\stuff\gba\devkitarm\arm-elf
<br/>
TOOLPATH=$(PATH)\bin
<br/>
LIBPATH=$(PATH)\lib\interwork
<br/>
<br/>
CC=$(TOOLPATH)\gcc.exe
<br/>
CFLAGS=-c -mthumb-interwork
<br/>
<br/>
LINK=$(TOOLPATH)\ld.exe  
<br/>
LFLAGS=-L$(LIBPATH) -marmelf 
<br/>
<br/>
main.elf: main.o 
<br/>
   $(LINK) $(LFLAGS) -omain.elf main.o $(LIBPATH)\crt0.o $(LIBPATH)\libc.a 
<br/>
<br/>
main.o: main.c
<br/>
   $(CC) $(CFLAGS) -omain.o main.c</td> </tr></table><span class="postbody">
<br/>
<br/>
As I said, compiling is fine.
<br/>
Linking throws up the following errors though:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">C:\temp\stuff\gba\devkitarm\arm-elf\lib\interwork\crt0.o(.text+0xdc): In function `start':
<br/>
: undefined reference to `_init'
<br/>
C:\temp\stuff\gba\devkitarm\arm-elf\lib\interwork\crt0.o(.text+0xfc): In function `start':
<br/>
: undefined reference to `_fini'</td> </tr></table><span class="postbody">
<br/>
<br/>
I'm obviously missing some vital piece of info...
<br/>
Can anyone tell me where I'm going wrong please ???
<br/>
<br/>
Thanks in advance,
<br/>
Smeg</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#27512 - Lord Graga - Thu Oct 14, 2004 2:41 pm</h4>
    <div class="postbody"><span class="postbody">first of all, don't point your TOOLPATH to devkiarm/arm-elf/bin, but devkitarm/bin.
<br/>
<br/>
second, try to add: --specs=gba.specs to your linking stage.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#27521 - sajiimori - Thu Oct 14, 2004 6:36 pm</h4>
    <div class="postbody"><span class="postbody">Anybody who reads one of Coding/C++/Beginners will probably read all of them, so there's no need to make extra threads.  There's no "trick" for getting responses, besides having a question that people know the answer to.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#27522 - DiscoStew - Thu Oct 14, 2004 6:37 pm</h4>
    <div class="postbody"><span class="postbody">By the look on those linking errors, it seems that you are trying to compile and link C++ code with a C compiler/linker. I've had that problem before, which means you probably have <span style="font-weight: bold">int main(void)</span> as your entry point. Changing it to <span style="font-weight: bold">int AgbMain(void)</span> should fix those 2 linking problems.
<br/>
I PMed you on things you asked about, which should allow you to try the Makefile I posted in the last thread.<br/>_________________<br/><span style="font-weight: bold">DS</span> - It's all about <span style="font-weight: bold">D</span>isco<span style="font-weight: bold">S</span>tew</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#27538 - Cearn - Fri Oct 15, 2004 12:42 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>SmegPlaza wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">PATH=C:\temp\stuff\gba\devkitarm\arm-elf
<br/>
TOOLPATH=$(PATH)\bin
<br/>
LIBPATH=$(PATH)\lib\interwork
<br/>
<br/>
CC=$(TOOLPATH)\gcc.exe
<br/>
CFLAGS=-c -mthumb-interwork
<br/>
<br/>
LINK=$(TOOLPATH)\ld.exe  
<br/>
LFLAGS=-L$(LIBPATH) -marmelf
<br/>
</td> </tr></table><span class="postbody">
<br/>
</span></td> </tr></table><span class="postbody">
<br/>
If I try to rewrite my (working) makefiles to use these commands I get the same undefined _init and _fini as you do. I got rid of these errors by linking with gba_crt0.o instead of ctr0.o, but only got more mystifing errors in return.
<br/>
<br/>
The thing about linking with ld directly is that you have to specify each and every detail of the linking process yourself. You can save yourself a world of hurt by using gcc instead, which chooses the right directories, start-up files and libraries for you. You will have to tell it that you're building a GBA binary by using either <span style="font-weight: bold">-specs=gba.specs</span> (one hyphen) or <span style="font-weight: bold">-specs=gba_mb.specs</span> for a multiboot game. Also, like Graga said, it might be better to use the commands in devkitarm/bin instead of devkitarm/arm-elf/bin. Note that these all have the 'arm-elf-' prefix, though.
<br/>
<br/>
The makefile will then look something like
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
# if you attach the BINDIR to the system apth, you won't have 
<br/>
# to define and use it here anymore
<br/>
BINDIR = c:/temp/stuff/gba/devkitarm/bin
<br/>
CROSS = arm-elf-
<br/>
<br/>
CC = $(BINDIR)/$(CROSS)gcc
<br/>
LD = $(BINDIR)/$(CROSS)gcc
<br/>
OBJCOPY = $(BINDIR)/$(CROSS)objcopy
<br/>
<br/>
CFLAGS = -c -mthumb-interwork
<br/>
LDFLAGS = -specs=gba.specs
<br/>
<br/>
# --- convert to GBA rom ---
<br/>
main.gba : main.elf
<br/>
   $(OBJCOPY) -v -O binary main.elf main.gba
<br/>
   gbafix main.gba
<br/>
<br/>
# --- link ---
<br/>
main.elf: main.o
<br/>
   $(LD) $(LDFLAGS) -o main.elf main.o
<br/>
<br/>
# --- compile ---
<br/>
main.o: main.c 
<br/>
   $(CC) $(CFLAGS) -o main.o main.c
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#27576 - wintermute - Fri Oct 15, 2004 11:15 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>DiscoStew wrote:</b></span></td> </tr> <tr> <td class="quote">By the look on those linking errors, it seems that you are trying to compile and link C++ code with a C compiler/linker. I've had that problem before, which means you probably have <span style="font-weight: bold">int main(void)</span> as your entry point. Changing it to <span style="font-weight: bold">int AgbMain(void)</span> should fix those 2 linking problems.
<br/>
I PMed you on things you asked about, which should allow you to try the Makefile I posted in the last thread.</td> </tr></table><span class="postbody">
<br/>
<br/>
those two linking problems have nothing to do with the name of the main function. They're entirely due to not specifying all the required object files when linking.
<br/>
<br/>
The simplest way is to use arm-elf-gcc as the linker and use the -specs switch.
<br/>
<br/>
For a cart image use -specs=gba.specs
<br/>
<br/>
for a multboot image use -specs=gba_mb.specs</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#27584 - DiscoStew - Sat Oct 16, 2004 1:33 am</h4>
    <div class="postbody"><span class="postbody">I've had problems with the undefined references to "_init" and "_fini" before, and changing the entry point name from "int main(void)" to "int AgbMain(void)" had fix those problems for me in an old project of mine. I only suggested that change because it had worked for me. If that isn't meant to fix those problems, what does using "AgbMain" instead of "main" do?<br/>_________________<br/><span style="font-weight: bold">DS</span> - It's all about <span style="font-weight: bold">D</span>isco<span style="font-weight: bold">S</span>tew</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#27601 - wintermute - Sat Oct 16, 2004 6:46 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>DiscoStew wrote:</b></span></td> </tr> <tr> <td class="quote">I've had problems with the undefined references to "_init" and "_fini" before, and changing the entry point name from "int main(void)" to "int AgbMain(void)" had fix those problems for me in an old project of mine. I only suggested that change because it had worked for me. If that isn't meant to fix those problems, what does using "AgbMain" instead of "main" do?</td> </tr></table><span class="postbody">
<br/>
<br/>
it names your main function AgbMain instead of main :P
<br/>
<br/>
DevkitAdvance was patched so that AgbMain inserts code to call global constructors. With DevkitARM this is done by the crt0 and specs files instead.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
