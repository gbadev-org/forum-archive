<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Collision help? - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>Beginners > Collision help?</h2>
<div id="posts">
<div class="post">
    <h4>#97329 - lostgame - Wed Aug 09, 2006 7:07 am</h4>
    <div class="postbody"><span class="postbody">Again, I have a small ball ('char' in this case), in which I want to collide with solid blocks.
<br/>
<br/>
I declared an array with several x and y coordinates for blocks.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">u16 blockx[5] = {40,64,80,104,128};
<br/>
u16 blocky[5] = {32,128,64,96,16};</td> </tr></table><span class="postbody">
<br/>
<br/>
I ask if the ball(char), is in the collision by returning a value, 'canmove'.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">while(1)
<br/>
   {
<br/>
   u8 a;
<br/>
   
<br/>
   for (a=1; a&lt;=5; a++)
<br/>
<br/>
   {
<br/>
           if( (col(blockx[a]+1,blocky[a]+1,8,8,xchar,ychar,16,16))==1  ||  (col(blockx[a]-1,blocky[a]-1,8,8,xchar,ychar,16,16))==1 )
<br/>
                canmove=0;
<br/>
<br/>
           else
<br/>
<br/>
         canmove=1;
<br/>
         
<br/>
   }
<br/>
<br/>
   if(canmove=1){
<br/>
      Movechar();
<br/>
      MoveSprite(&amp;sprites[0],xchar,ychar);
<br/>
   }
<br/>
<br/>
      
<br/>
      WaitForVsync();
<br/>
      CopyOAM();
<br/>
   }</td> </tr></table><span class="postbody">
<br/>
<br/>
As you can see, I wrote a method called 'col', which is here:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">int col(int o1x,int o1y,int o1w,int o1h,int o2x,int o2y,int o2w,int o2h)
<br/>
{
<br/>
  if (o1x+o1w &gt; o2x &amp;&amp; o2x+o2w &gt; o1x &amp;&amp; o1y+o1h &gt; o2y &amp;&amp; o2y+o2h &gt; o1y)
<br/>
    return 1;
<br/>
  else
<br/>
    return 0;
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
It makes so much sense it hurts, yet, predictably, fails.
<br/>
<br/>
The ball goes straight through the blocks, like they're not even there.
<br/>
<br/>
What's going on?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#97330 - sajiimori - Wed Aug 09, 2006 7:23 am</h4>
    <div class="postbody"><span class="postbody">Array indexes in C start with 0, not 1.  The maximum index of an array with 5 elements is 4.
<br/>
<br/>
Every pass through your 'a' loop is writing a value to canmove.  That means every pass except the last one is useless.
<br/>
<br/>
Simplify your code by carrying x,y pairs in structs instead of separately.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">struct Vector
<br/>
{
<br/>
  u16 x;
<br/>
  u16 y;
<br/>
};
<br/>
<br/>
struct Vector blocks[] =
<br/>
{
<br/>
  { 40, 32 },
<br/>
  ...
<br/>
};</td> </tr></table><span class="postbody">
<br/>
Write an isSolid function that takes a position and returns true if it's filled by a block.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">bool isSolid(const Vector* v);</td> </tr></table><span class="postbody">
<br/>
That will make your task simple.
<br/>
<br/>
Needless to say, this post doesn't cover everything there is to be said.  It just covers the most crucial things for starters.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#97352 - Optihut - Wed Aug 09, 2006 11:36 am</h4>
    <div class="postbody"><span class="postbody">"if(canmove=1)"
<br/>
<br/>
This should either be "if (canmove)" or "if (canmove==1)". Right now it assigns the value 1 to the variable canmove and is always true.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#97393 - dj-ceejay - Wed Aug 09, 2006 3:38 pm</h4>
    <div class="postbody"><span class="postbody">An easy mistake to make if you've come from another language like BASIC.<br/>_________________<br/>Fruit Machine Games:
<br/>
<a class="postlink" href="http://www.fmsoftware.info/" target="_blank">http://www.fmsoftware.info/</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#97398 - lostgame - Wed Aug 09, 2006 4:06 pm</h4>
    <div class="postbody"><span class="postbody">Okay, now I have another problem.
<br/>
<br/>
That code makes it so if it sees collision <span style="font-style: italic">anywhere</span>, it can't move at all-even in the opposite direction of the block it's colliding with.
<br/>
<br/>
<span style="font-weight: bold">sajiimori</span>, I fixed that array index problem, and <span style="font-weight: bold">Optihut</span>, I also fixed the "canmove" variable.
<br/>
<br/>
Like I said, it works-but as soon as you hit it, from any side, the character won't move anymore.
<br/>
<br/>
Also, like <span style="font-weight: bold">sajiimori</span> said, it's only hitting the last block and i'm not sure what I'm doing wrong.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#97407 - Optihut - Wed Aug 09, 2006 4:42 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>lostgame wrote:</b></span></td> </tr> <tr> <td class="quote">Also, like <span style="font-weight: bold">sajiimori</span> said, it's only hitting the last block and i'm not sure what I'm doing wrong.</td> </tr></table><span class="postbody">
<br/>
<br/>
The "else" command overwrites canmove during the execution of the loop when the condition is not met.
<br/>
So you need to exit the for loop when canmove is set to 0. IIRC, this can be done with "break;"
<br/>
Alternatively you could remove the "else" part and write "canmove = 1;" before the for loop.
<br/>
<br/>
As for no movement at all, I guess you could use another variable to store the direction of the collision in order to program something that would allow you to still be able to move in the opposite direction.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#97422 - dj-ceejay - Wed Aug 09, 2006 5:44 pm</h4>
    <div class="postbody"><span class="postbody">Another reason we need a reliable debugging with code step through for GBA &amp; NDS.<br/>_________________<br/>Fruit Machine Games:
<br/>
<a class="postlink" href="http://www.fmsoftware.info/" target="_blank">http://www.fmsoftware.info/</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#97426 - lostgame - Wed Aug 09, 2006 6:07 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Optihut wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>lostgame wrote:</b></span></td> </tr> <tr> <td class="quote">Also, like <span style="font-weight: bold">sajiimori</span> said, it's only hitting the last block and i'm not sure what I'm doing wrong.</td> </tr></table><span class="postbody">
<br/>
<br/>
The "else" command overwrites canmove during the execution of the loop when the condition is not met.
<br/>
So you need to exit the for loop when canmove is set to 0. IIRC, this can be done with "break;"
<br/>
Alternatively you could remove the "else" part and write "canmove = 1;" before the for loop.
<br/>
<br/>
As for no movement at all, I guess you could use another variable to store the direction of the collision in order to program something that would allow you to still be able to move in the opposite direction.</span></td> </tr></table><span class="postbody">
<br/>
<br/>
*phew*
<br/>
<br/>
This is much more complicated than I thought...
<br/>
<br/>
In a bit, I will upload all the code so you can see where I've screwed up.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#97435 - sajiimori - Wed Aug 09, 2006 7:05 pm</h4>
    <div class="postbody"><span class="postbody">Lostgame, one thing to consider is what "canmove" means to you.  To me, it sounds like if it's false, the thing can't move at all.
<br/>
<br/>
What you probably want is to know whether an object can move to a particular place.
<br/>
<br/>
If you're satisfied with the definition that an object can move to a place if that place does not overlap anything solid, then the isSolid function is all you need.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void tryMove(Vector* myPos, const Vector* dest)
<br/>
{
<br/>
  if(!isSolid(dest))
<br/>
    *myPos = *dest;
<br/>
}</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#97496 - lostgame - Thu Aug 10, 2006 4:14 am</h4>
    <div class="postbody"><span class="postbody">Alright, thanks you guys, with a little bit of my previous game coding knowledge, I was able to get it to work.
<br/>
<br/>
First off, I fixed the actual collision checking statement, which, in and of itself, was fundimentally flawed.
<br/>
<br/>
Here's what it looks like now:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">if (o2x+o2w &gt; o1x &amp;&amp; o1x+o1w &gt; o2x &amp;&amp; o2y+o2h &gt; o1y &amp;&amp; o1y+o1h &gt; o2y)</td> </tr></table><span class="postbody">
<br/>
<br/>
Then I added a prevx and prevy variable, and we all know how that works.
<br/>
<br/>
I am working on making the blocks load from seperate files, like levels, so far I modified it so it has a structure that loads the following values:
<br/>
<br/>
x,y,width,height,tile_number,solid
<br/>
<br/>
My plan is to have these files read from an external file. I will then develop a little program for Windows in C++ that will allow you to design your own levels based on a simple tile placement method, assigning these values as you go.
<br/>
<br/>
For the time being, it will simply be in an external file such as ".lev". I will make a block that if you touch, it will move to the next level.
<br/>
<br/>
*sighs*
<br/>
<br/>
Thank you for all your help, now that I have passed the major stumbling block, I know most everything else I will need to know.
<br/>
<br/>
Thanks again, guys, I'm happy to be back in the Game Boy Advance development scene.
<br/>
<br/>
Expect a demo within the week!
<br/>
<br/>
*insert retarded smiley here*
<br/>
<br/>
=P</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#97514 - Ultima2876 - Thu Aug 10, 2006 6:17 am</h4>
    <div class="postbody"><span class="postbody">Same lostgame from sws2b? =p</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#97592 - lostgame - Thu Aug 10, 2006 5:58 pm</h4>
    <div class="postbody"><span class="postbody">Yes. =P</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#98090 - lostgame - Sun Aug 13, 2006 5:11 am</h4>
    <div class="postbody"><span class="postbody">Sorry for the double post, I just had news and an edit doesn't show the "new stuff" icon.
<br/>
<br/>
I put it all into a struct, added gravity, proper collision and a camera for scrolling. You can now walk along the tops of the blocks, and jump from block to block.
<br/>
<br/>
Basically, I have a [very] simple platforming engine. JJFtails of SWS2B has also assisted.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#98117 - Optihut - Sun Aug 13, 2006 10:07 am</h4>
    <div class="postbody"><span class="postbody">Great to hear you're making progress! My own game making ambitions are still in the planning stages, unfortunately.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#98149 - lostgame - Sun Aug 13, 2006 5:19 pm</h4>
    <div class="postbody"><span class="postbody">Thanks, <span style="font-weight: bold">Optihut</span>!
<br/>
<br/>
My only concern is memory management.
<br/>
<br/>
Is there any way to see how much of the GBA's RAM and procesor is being used in VisualBoyAdvance?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#98150 - tepples - Sun Aug 13, 2006 5:34 pm</h4>
    <div class="postbody"><span class="postbody">You can see how much processor is being <span style="font-style: italic">un-</span>used by using the VCOUNT register, one of the GBA's built-in timers. Read VCOUNT before and after your VBlankIntrWait() call, subtract them, and write the result to the screen.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#98157 - sajiimori - Sun Aug 13, 2006 7:13 pm</h4>
    <div class="postbody"><span class="postbody">There might be an easy way to check static EWRAM usage in DevKitARM, but I don't know much about it, so one hack that's likely to work is calling malloc at the beginning of main (then freeing the allocation).  I'd expect the address of the block to be the end of the static allocations.
<br/>
<br/>
Checking dynamic EWRAM usage (again, with no DevKitARM knowledge) basically involves wrapping malloc/free with your own functions that keep track of how much is currently allocated.
<br/>
<br/>
Checking stack usage is easy: Make a function that has a single local variable, take its address, and that's the top of the stack.
<br/>
<br/>
Some knowledge of DevKitARM is required to check static IWRAM usage.  If the linkscript produces a symbol at the end of the static allocations, you can declare it (as anything, like an int) and take its address to find how much is being used.  I'd expect the linkscript to produce such a symbol, but I don't know what the author called it.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#98162 - keldon - Sun Aug 13, 2006 7:40 pm</h4>
    <div class="postbody"><span class="postbody">Hmmm, that technique may not work because if you first allocate X bytes, and then later free it, then who is to say that the next allocated piece of memory will not be placed there.
<br/>
<br/>
They could use a round robin type allocation but it is still not definate. And there is still the chance of the next allocation is not at the end of the memory.
<br/>
<br/>
But you can make a define that will call your own malloc/free function instead in your debug mode that will count the size of the allocations. And what you can do to keep track of the data size for when you free memory is to store an extra 2 bytes before your allocation with the size, and get your malloc to return the byte after that.
<br/>
<br/>
Or maybe there is another way, and maybe your memory usage may allow sajimori's suggestion to work without any problems.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#98185 - sajiimori - Sun Aug 13, 2006 11:08 pm</h4>
    <div class="postbody"><span class="postbody">I don't understand your objection.  I'm just talking about making one allocation at startup, then freeing it, just to find out where the beginning of the heap is, which is virtually always at the end of the static data section (for the region that contains the heap, which is EWRAM for most configurations).
<br/>
<br/>
Or are you objecting to the method of tracking dynamic allocations?
<br/>
<br/>
Edit: Upon re-reading your post, it's more clear that you're objecting to my method of tracking dynamic memory usage.  I'm not sure what you think is wrong with it, since all I suggested was wrapping malloc and free.  Since I didn't suggest a mechanism for doing the actual tracking, it makes little sense to say the unspoken mechanism doesn't work.  ;)
<br/>
<br/>
Anyway, if you're going to prefix your allocations with a size, you'd better make it a multiple of 4 bytes.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#98189 - keldon - Sun Aug 13, 2006 11:44 pm</h4>
    <div class="postbody"><span class="postbody">Oh, I thought you meant the dynamic allocations. Sorry my bad, I really had to read that twice to see that for some reason. And even then what on earth was I thinking, I must have got lost somewhere.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#98208 - tepples - Mon Aug 14, 2006 1:59 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>lostgame wrote:</b></span></td> </tr> <tr> <td class="quote">Is there any way to see how much of the GBA's RAM and procesor is being used in VisualBoyAdvance?</td> </tr></table><span class="postbody">
<br/>
Yes. Use the tool <span style="font-weight: bold">arm-eabi-nm</span> (called <span style="font-weight: bold">arm-elf-nm</span> on my machine[1]):
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">E:\gbadev\tod&gt;arm-elf-nm -n tod.elf
<br/>
<br/>
00080000 ? _stack
<br/>
02000000 A __text_start
<br/>
02000000 T _start
<br/>
020000c0 t rom_header_end
<br/>
020000c4 T __boot_method
<br/>
020000c5 T __slave_number
<br/>
020000e0 T start_vector
<br/>
02000126 t DoEWRAMClear
<br/>
02000130 t SkipEWRAMClear
<br/>
[ several lines omitted ]
<br/>
02007994 r hirescostable
<br/>
02008198 R _ctype_
<br/>
0200829c R _global_impure_ptr
<br/>
0200842c d __CTOR_LIST__
<br/>
02008430 d __CTOR_END__
<br/>
02008434 d __DTOR_LIST__
<br/>
02008438 d __DTOR_END__
<br/>
0200843c d __JCR_END__
<br/>
0200843c d __JCR_LIST__
<br/>
02008440 r __EH_FRAME_BEGIN__
<br/>
02008440 r __FRAME_END__
<br/>
02008444 A __iwram_lma
<br/>
0200873c A __data_lma
<br/>
02008b8c A __eheap_start
<br/>
02008b8c A __end__
<br/>
02008b8c A __ewram_end
<br/>
02008b8c A __ewram_lma
<br/>
02008b8c A __ewram_overlay_end
<br/>
02008b8c A __ewram_overlay_lma
<br/>
02008b8c A __ewram_overlay_start
<br/>
02008b8c A __ewram_start
<br/>
02008b8c A __iwram_overlay_lma
<br/>
02008b8c A __load_start_ewram0
<br/>
[overlays omitted]
<br/>
02008b8c A __load_stop_iwram9
<br/>
02008b8c A __sbss_end
<br/>
02008b8c A __sbss_start
<br/>
02008b8c A _end
<br/>
[contents of IWRAM omitted]
<br/>
</td> </tr></table><span class="postbody">
<br/>
So it appears you can do something with the _end symbol to see how much RAM your program is using. If you are using appended data, you'll have to take that into account too. I'm not sure if the default link script supports safe interaction between malloc() and appended data frameworks such as GBFS.
<br/>
<br/>
<span style="font-size: 9px; line-height: normal">[1] I'm still on devkitARM R18 because devkitARM R19 has had known bugs in its handling of memory regions in GBA mode. PM me if those have been definitively resolved.</span><br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#98293 - wintermute - Mon Aug 14, 2006 2:43 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tepples wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
<br/>
<br/>
[1] I'm still on devkitARM R18 because devkitARM R19 has had known bugs in its handling of memory regions in GBA mode. PM me if those have been definitively resolved.[/size]</td> </tr></table><span class="postbody">
<br/>
<br/>
Try and keep up 
<br/>
<br/>
<a href="http://www.devkitpro.org/index.php?action=fullnews&amp;id=116" target="_blank">http://www.devkitpro.org/index.php?action=fullnews&amp;id=116</a><br/>_________________<br/><a class="postlink" href="http://www.devkitpro.org/" target="_blank">devkitPro - professional toolchains at amateur prices</a>
<br/>
<a class="postlink" href="http://wiki.devkitpro.org/index.php/IRC" target="_blank">devkitPro IRC support</a>
<br/>
<a class="postlink" href="http://davejmurphy.com/" target="_blank">Personal Blog</a></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
