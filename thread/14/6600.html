<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>code in IW_RAM - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>Beginners > code in IW_RAM</h2>
<div id="posts">
<div class="post">
    <h4>#51155 - wiz - Tue Aug 16, 2005 9:10 pm</h4>
    <div class="postbody"><span class="postbody">Hello!
<br/>
<br/>
Well this week I be mostly coding... stuff in IW_RAM
<br/>
<br/>
I read about this, and tried it, and wow! it does make functions a lot faster..
<br/>
<br/>
I seem to be getting a lot of errors to do with "relocation truncated" when Im trying to pass a pointer to a test function from a function in IW_RAM, why could this be?
<br/>
<br/>
Heres a test I made:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void TESTER(s8 *stuff)
<br/>
{
<br/>
   stuff[0] = 0;
<br/>
}
<br/>
<br/>
s8 stuff[40];
<br/>
<br/>
<br/>
IN_IWRAM void Test()
<br/>
{
<br/>
   u8 t;
<br/>
   TESTER((s8*)stuff);
<br/>
}
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#51157 - strager - Tue Aug 16, 2005 9:28 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>wiz wrote:</b></span></td> </tr> <tr> <td class="quote">I seem to be getting a lot of errors to do with "relocation truncated" when Im trying to pass a pointer to a test function from a function in IW_RAM, why could this be?</td> </tr></table><span class="postbody">
<br/>
<br/>
I get the same errors when using the Krawall library.  I haven't found any way to prevent the errors, but turning multiboot on fixes it (odd it would... maybe because it cannot branch into that range?).</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#51158 - tepples - Tue Aug 16, 2005 9:46 pm</h4>
    <div class="postbody"><span class="postbody">You need to use long_call when calling between ROM and RAM. <a class="postlink" href="http://www.google.com/search?q=gba+long_call" target="_blank">Google is your friend</a>.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#51159 - Quirky - Tue Aug 16, 2005 9:48 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">IN_IWRAM void Test()
<br/>
{
<br/>
   u8 t;
<br/>
   TESTER((s8*)stuff);
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
How is IN_IWRAM defined? You need a long_call attribute in there:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#define IN_IWRAM __attribute__ ((section (".iwram"), long_call))</td> </tr></table><span class="postbody">
<br/>
<br/>
For example try changing the comment here:
<br/>
<br/>
in main.c
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#define IN_IWRAM __attribute__ ((section (".iwram"), long_call))
<br/>
//#define IN_IWRAM __attribute__ ((section (".iwram")))
<br/>
<br/>
void test(void) IN_IWRAM;
<br/>
int main(void)
<br/>
{
<br/>
  test();
<br/>
  while(1)
<br/>
  {
<br/>
  }
<br/>
  return 0;
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
in test.c
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
//#define IN_IWRAM __attribute__ ((section (".iwram")))
<br/>
#define IN_IWRAM __attribute__ ((section (".iwram"), long_call))
<br/>
<br/>
IN_IWRAM void test(){}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
It's important that they are in different files or it will work without problems.
<br/>
<br/>
EDIT: tepples beat me to it. My answer got full marks though ;)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#51163 - wiz - Tue Aug 16, 2005 10:09 pm</h4>
    <div class="postbody"><span class="postbody">Hi, and many thanks for the fast replies
<br/>
<br/>
it seems to be defined correctly:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#define IN_IWRAM __attribute__ ((section (".iwram"), long_call))</td> </tr></table><span class="postbody">
<br/>
<br/>
the problem is only happening when I pass a pointer to an array, its fine when passing variables.
<br/>
<br/>
please note that Im calling a normal function <span style="font-weight: bold">from</span> the function thats in IN_IWRAM (if that makes any difference)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#51172 - wiz - Tue Aug 16, 2005 10:53 pm</h4>
    <div class="postbody"><span class="postbody">To add to my previous reply:
<br/>
<br/>
I have changed my compiler settings and removed the statement "-mthumb" from the compiler line in my batch file.
<br/>
<br/>
I then called the function using the following FarCall macro:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#define FarCall(FUNCTION) \
<br/>
    ({ \
<br/>
        typeof (FUNCTION) *volatile _POINTER; \
<br/>
        \
<br/>
        _POINTER = &amp;(FUNCTION); \
<br/>
    }) </td> </tr></table><span class="postbody">
<br/>
<br/>
and now its working!  however Im now even more confused :S
<br/>
<br/>
is it better to compile without the  -mthumb ?  I have no idea what it means heh :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#51174 - tepples - Tue Aug 16, 2005 11:04 pm</h4>
    <div class="postbody"><span class="postbody">Any code that goes in IWRAM should be compiled as ARM. Any code that goes in EWRAM or ROM should be compiled as Thumb.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#51217 - wiz - Wed Aug 17, 2005 8:43 am</h4>
    <div class="postbody"><span class="postbody">ah right so thats what it is, 
<br/>
<br/>
so its correct to say code placed IN_IWRAM needs to be compiled differently (like Quirky mentioned something about being in its own file)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#51264 - Quirky - Wed Aug 17, 2005 8:02 pm</h4>
    <div class="postbody"><span class="postbody">ARM is 32-bit code, THUMB is 16-bit and uses a different instruction set. The advantage of THUMB is as tepples mentioned, faster from ROM, plus (I find) it tends to generate smaller binaries, as on average 1 arm instruction tends to be equivalent to a touch 1.75 thumb ones.
<br/>
<br/>
I mentioned the second file there so that you would see the relocation error, it manages to sort out the the location if the functions are in the same compilation unit.
<br/>
<br/>
To get arm compilation flags, I tend to do the following in a Makefile:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
%.o : %.arm.c
<br/>
  $(GCC) $(CFLAGS) -marm -mthumb-interwork -c -o $@ $&lt;
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Though I've also seen the cute trick of having $(CFLAGS-$&lt;) which lets you do things like:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
CFLAGS-interrupt.c=-marm -mthumb-interwork
<br/>
CFLAGS-needs_oomph.c= -O3
<br/>
.....
<br/>
<br/>
%.o : %.c
<br/>
  $(GCC) $(CFLAGS) $(INCLUDES) $(CFLAGS-$&lt;) -c -o $@ $&lt;
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
As for problems calling from code in RAM to code in ROM - I get the same error here... hmmm a puzzler... The only way I see is to place the ROM code in the same .c as the IN_IWRAM code that calls it.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
