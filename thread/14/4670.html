<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Strange sprite problems with -O3 Tag - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>Beginners > Strange sprite problems with -O3 Tag</h2>
<div id="posts">
<div class="post">
    <h4>#32374 - identitycrisisuk - Tue Dec 21, 2004 5:17 pm</h4>
    <div class="postbody"><span class="postbody">I'm getting problems after starting to compile code in DevKitARM with the -O3 tag. I've checked for the standard mistakes listed in the FAQ and I have my Vcount and key registers set up as volatile but it's likely I need it for some other things I haven't thought of.
<br/>
<br/>
The problem is only with my sprites, the backgrounds seem to be fine as they are only loaded once at the beginning but the sprites are DMA transferred in each time a different frame of animation is needed so the OAM data should always be pointing to the same place in VRAM.
<br/>
<br/>
Looking at the VBA debug stuff the problem seems to be in a few areas, firstly using the tile viewer I can see that the sprites section is filled with nonsense, kinda like when you use map data as tiles by mistake. If I leave it on Automatic update I can see that sometimes the right sprite appears to be in VRAM but only for a brief second and then it's back to nonsense again. On top of this the OAM data seems to change too, later entries I don't use seem to change position, size etc. and my sprites move too, sometimes ending up at 0, 0 and becoming 8x8 instead of 32x32.
<br/>
<br/>
All in all a bit of a scary prospect but at least it must be with the sprites since the backgrounds and gamelogic seem fine. I've also checked that it is the same on VBA and hardware, which it is. I'm guessing my problems might be with more registers needing to be made volatile or perhaps I'm relying on some data to be initialised as zero when in non optimised mode. Any suggestions?<br/>_________________<br/></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">CanIKickIt(YES_YOU_CAN);</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#32391 - pan69 - Wed Dec 22, 2004 8:12 am</h4>
    <div class="postbody"><span class="postbody">Can it be an alignment problem? Maybe some struct's gets missaligned because of the -O3 compiler switch.
<br/>
<br/>
- Pan</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#32396 - FluBBa - Wed Dec 22, 2004 10:59 am</h4>
    <div class="postbody"><span class="postbody">I've seen DMA start code mangled by -O3, often the assembler code writes to the start register before source and/or destination register, thus screwing up the transfer.<br/>_________________<br/>I probably suck, my not is a programmer.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#32401 - identitycrisisuk - Wed Dec 22, 2004 11:36 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>FluBBa wrote:</b></span></td> </tr> <tr> <td class="quote">I've seen DMA start code mangled by -O3, often the assembler code writes to the start register before source and/or destination register, thus screwing up the transfer.</td> </tr></table><span class="postbody">
<br/>
<br/>
Ooh, that sounds like a possibility, there's a way around that isn't there by using an asm command? I've not used any asm yet, I know that the preferred way of doing it is putting it into a separate .s file but is this something I might get away with having a single asm command in the midst of some C++ code? Both my OAM data transfer and sprite loading are done by DMA3 so it fits the things that are going wrong.
<br/>
<br/>
Not sure about the alignment idea, could you be more specific? Do you mean some things might need the ALIGN4 tag at its declaration or that I might be relying on the offset of some variables within the struct?I don't think I do anything like that at the moment, I have my map and sprite data with ALIGN4, don't really know what else needs it.<br/>_________________<br/></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">CanIKickIt(YES_YOU_CAN);</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#32419 - isildur - Wed Dec 22, 2004 3:54 pm</h4>
    <div class="postbody"><span class="postbody">If you need a DMA3 function that writes to the registers with a single stmia instruction, here is mine:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
<br/>
.GLOBAL Dma3A
<br/>
<br/>
.section .iwram, "xw", %progbits
<br/>
.arm
<br/>
.align 2
<br/>
<br/>
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
<br/>
@
<br/>
@ void Dma3A(u32 flgs, u32 srcAddress, u32 dstAddress, u32 Count)
<br/>
<br/>
Dma3A:
<br/>
   
<br/>
    orr r3, r3, r0, lsl #16
<br/>
    ldr   r0, =0x040000d4
<br/>
    stmia   r0, {r1-r3}
<br/>
    bx   lr
<br/>
<br/>
    .pool
<br/>
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
This should prevent -O3 from messing it up.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#32421 - identitycrisisuk - Wed Dec 22, 2004 4:31 pm</h4>
    <div class="postbody"><span class="postbody">I've tried to write something like that on my own but it doesn't seem to be working, I've gone for the inline C method. Here's my code:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void SafeDMA3(u32 from, u32 to, u32 ctrl)
<br/>
{
<br/>
   asm volatile ("   ldr   a1, =0x040000d4\n\
<br/>
                     stmia   a1, {r0-r2}\n");
<br/>
}</td> </tr></table><span class="postbody">
<br/>
And I'd use it like:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">SafeDMA3((u32)SpriteData, (u32)VRAM, SPRITE_ENTRIES|DMA_16NOW);</td> </tr></table><span class="postbody">
<br/>
Anything blindingly wrong with that? Sorry, I know little to no ASM. It seemed to be copying some sprite data into tile data when I tried to use it to copy the OAM data so it's obviously doing something but not quite right.<br/>_________________<br/></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">CanIKickIt(YES_YOU_CAN);</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#32458 - tepples - Thu Dec 23, 2004 1:50 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>identitycrisisuk wrote:</b></span></td> </tr> <tr> <td class="quote">Here's my code:
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void SafeDMA3(u32 from, u32 to, u32 ctrl)
<br/>
{
<br/>
   asm volatile ("   ldr   a1, =0x040000d4\n\
<br/>
                     stmia   a1, {r0-r2}\n");
<br/>
}</td> </tr></table><span class="postbody">
<br/>
And I'd use it like:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">SafeDMA3((u32)SpriteData, (u32)VRAM, SPRITE_ENTRIES|DMA_16NOW);</td> </tr></table><span class="postbody">
<br/>
Anything blindingly wrong with that? Sorry, I know little to no ASM. It seemed to be copying some sprite data into tile data when I tried to use it to copy the OAM data so it's obviously doing something but not quite right.</span></td> </tr></table><span class="postbody">
<br/>
AAS uses something like this to do DMA3.
<br/>
<br/>
But three things: First of all, you're only supposed to use r0-r3 and ip without saving them beforehand; otherwise the calling function gets confused. Easy fix:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void SafeDMA3(u32 from, u32 to, u32 ctrl)
<br/>
{
<br/>
   asm volatile ("   ldr   r3, =0x040000d4\n\
<br/>
                     stmia   r3, {r0-r2}\n");
<br/>
}</td> </tr></table><span class="postbody">
<br/>
Second, you have to remember to divide the length by 2 or 4 when using 16-bit or 32-bit DMA respectively. Finally, the 'VRAM' macro in GBA header files usually means the address of the part of VRAM containing background tile data. Here's a macro to find the address of sprite cel data starting at a given tile number (copying from the latest version of my custom header):
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#define SPR_VRAM(x) ((u32 *)(0x06010000 | ((x) &lt;&lt; 5)))</td> </tr></table><span class="postbody">
<br/>
Some of the confusion may be due to a faulty tutorial that incorrectly used "OAMData" as a name for sprite cel VRAM.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#32542 - identitycrisisuk - Thu Dec 23, 2004 7:12 pm</h4>
    <div class="postbody"><span class="postbody">Kay, finally got that assembler DMA copy working, tested it without the -O3 tag to make sure it worked (should have done that a lot earlier). Sprites seem okay but I've now lost all my background tiles, the maps seem to be updated (from what I can recognise of the funny coloured tiles where my maps are in the tile viewer) so it just looks like the tiles aren't loaded in, this only happens once whereas the update of sprites and map data is much more frequent.
<br/>
<br/>
I'll have a trawl through my code and see if there's anything more that could possibly do with a volatile tag. Also, I think I remember this from a thread a while back - if I'm copying data from arrays with DMA_16NOW do I need to put ALIGN16 after the declaration instead of ALIGN4? At the moment they all have ALIGN4.
<br/>
<br/>
Sorry to keep on bugging you about this, would be nice to get it working though. It's weird, I can't seem to find any source code for other tutorials with sprites, BGs etc. that will compile with -O3, They all have weird problems similar to mine without modifications. Means I don't really have a cast iron example that I can look at and say right this works with -O3, what does it do that mine doesn't and vice versa.<br/>_________________<br/></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">CanIKickIt(YES_YOU_CAN);</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#32559 - tepples - Thu Dec 23, 2004 9:36 pm</h4>
    <div class="postbody"><span class="postbody">All macros referring to memory-mapped registers (anything in the 0x04000000 region, or cart bankswitch registers in the 0x08000000 region) need a volatile tag.
<br/>
<br/>
ALIGN4 refers to bytes, so you can use ALIGN4 with DMA_32NOW.
<br/>
<br/>
To solve your background loading problem, you might need to load your tiles, set the palette, wait for 30 vblanks (so that you can pause the game and check the tile viewer), and <span style="font-style: italic">then</span> load sprite cels.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
