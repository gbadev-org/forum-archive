<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Game data saving with libfat - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>Beginners > Game data saving with libfat</h2>
<div id="posts">
<div class="post">
    <h4>#156992 - mca - Sat May 17, 2008 5:08 pm</h4>
    <div class="postbody"><span class="postbody">Hi,
<br/>
<br/>
I have a problem saving game data with libfat.
<br/>
<br/>
I use 
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">   /* Initialize libfat */
<br/>
   fatInitDefault();
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
and later on in the game 
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">/*Save GAME Data */
<br/>
void saveGame(){
<br/>
   FILE* datei = fopen("./game.sav", "w");
<br/>
   fwrite(&amp;game_save_data, sizeof(game_save_data), 1, datei);
<br/>
   fclose(datei); 
<br/>
};</td> </tr></table><span class="postbody">
<br/>
<br/>
where game_save_data is a structure holding profile information about 4 players.
<br/>
<br/>
When I inspect the SDHC card afterwards, there is no file created on it in the directory where the game.nds file resides.
<br/>
<br/>
What went wrong? Is there a code example of saving data with libfat?
<br/>
<br/>
Thanks...
<br/>
mca</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#157005 - tepples - Sat May 17, 2008 7:12 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>On the <a class="postlink" href="http://chishm.drunkencoders.com/libfat/" target="_blank">libfat page</a>, chishm wrote:</b></span></td> </tr> <tr> <td class="quote">Both fatInit and fatInitDefault return true if the library was successfully initialised and false otherwise.</td> </tr></table><span class="postbody">
<br/>
Have you made sure that fatInitDefault() returns true (that is, not 0) and that 'datei' is not a null pointer?
<br/>
<br/>
(For those reading at home, 'Datei' is German for 'file', unrelated to the maker of GnM.)<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#157006 - yellowstar - Sat May 17, 2008 7:21 pm</h4>
    <div class="postbody"><span class="postbody">Try removing that forward-slash. You can also try removing both the slash and the period.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#157016 - mca - Sat May 17, 2008 8:22 pm</h4>
    <div class="postbody"><span class="postbody">fatInitDefault returns true. So it is initializing as it should.
<br/>
<br/>
Removing both the period and the slash is working fine.
<br/>
.sav file is saved to root directory of the card. 
<br/>
Is there a way of storing it in the same directory as the game.nds file?
<br/>
<br/>
Would a '\' (Backslash) work?
<br/>
<br/>
Thanks...
<br/>
mca</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#157019 - Dwedit - Sat May 17, 2008 8:33 pm</h4>
    <div class="postbody"><span class="postbody">Currently there's no reliable way to tell what directory a program was launched from.  Often people just hardcode a directory name into their program, but that's an ugly solution.<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#157021 - tepples - Sat May 17, 2008 8:46 pm</h4>
    <div class="postbody"><span class="postbody">It's ugly, but it's similar to what Windows does. Windows provides a function called <a class="postlink" href="http://msdn.microsoft.com/en-us/library/bb762181.aspx" target="_blank">SHGetFolderPath()</a> that exposes the paths of special folders for programs to store their data, such as "Application Data" and "My Documents". Likewise, DS homebrew has a de-facto standard, where programs store their data in subfolders of "/data". For example, a program called <a class="postlink" href="http://www.pineight.com/lj/" target="_blank">Lockjaw</a> might store data in a file called "/data/lockjaw/lj-scores.txt".<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#157022 - mca - Sat May 17, 2008 8:48 pm</h4>
    <div class="postbody"><span class="postbody">ok, going for the root directory...
<br/>
<br/>
My next problem is that saving doesn't work (NDS game crashes) while playing sound with playsound() from libnds.
<br/>
is there an criteria to see, when an sound has ended to play.
<br/>
Something like 
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">while(unnamable_soundregister &amp; stillPlays){}</td> </tr></table><span class="postbody">
<br/>
<br/>
as an pause loop.
<br/>
<br/>
Thanks...
<br/>
mca</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#157043 - Dwedit - Sun May 18, 2008 6:30 am</h4>
    <div class="postbody"><span class="postbody">Don't stick stuff in the root directory, it has a limited number of files in FAT16.  Long file names highly aggravate the problem.<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#157048 - mca - Sun May 18, 2008 12:15 pm</h4>
    <div class="postbody"><span class="postbody">ok, i got saving working occasionally.
<br/>
<br/>
In what state (display, sound, sprites, irq, timers...) should the Nintendo DS be, when saving with 'fopen' and 'fwrite'?
<br/>
<br/>
I can't figure out what crashes the machine sometimes. Are there any recommendations?
<br/>
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void saveGame(){
<br/>
   FILE* file = fopen("fat1:game.sav", "wb");
<br/>
   game_save_data.profile_container_save = p_container;
<br/>
   fwrite(&amp;game_save_data, sizeof(game_save_data), 1, file);
<br/>
   fclose(file); 
<br/>
};</td> </tr></table><span class="postbody">
<br/>
<br/>
Thanks...
<br/>
mca</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#157050 - kusma - Sun May 18, 2008 3:26 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>mca wrote:</b></span></td> </tr> <tr> <td class="quote">I can't figure out what crashes the machine sometimes. Are there any recommendations?
<br/>
</td> </tr></table><span class="postbody">
<br/>
Verify that fopen() doesn't return NULL.
<br/>
<br/>
On a more general note, fwrite'ing structs isn't recommended, as it makes the saved data extremely unportable (just changing some build-options might break compatibility). And just think about the pain that occurs every time you want to add a field to the structure :P</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
