<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Pointer Confusion - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>Beginners > Pointer Confusion</h2>
<div id="posts">
<div class="post">
    <h4>#171806 - vladimirsan - Fri Dec 25, 2009 10:34 am</h4>
    <div class="postbody"><span class="postbody">Hello While I'm not new to programming I'm not very familiar with "GBA Style" programming. 
<br/>
<br/>
I'm using the Tonc tutorial to learn GBA programming (I cheeked the HAM book before using  Tonc). I don't understand this piece of code...
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#define fooSize ...
<br/>
const u16 fooData[]= { ... };
<br/>
<br/>
// copy via u16 array (the de facto standard)
<br/>
u16 *dst= (u16*)vid_mem, *src= (u16*)fooData;
<br/>
for(ii=0; ii&lt;fooSize/2; ii++)
<br/>
    dst[ii]= src[ii];
<br/>
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
It's located in <a class="postlink" href="http://www.coranac.com/tonc/text/bitmaps.htm#ssec-data-align" target="_blank">http://www.coranac.com/tonc/text/bitmaps.htm#ssec-data-align</a>
<br/>
<br/>
I don't understand why he used fooSize/2 if both fooData and dst  elements  are 16 bits long
<br/>
<br/>
In a previous chapter is this code
<br/>
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
// An array representing a 240x160@16 bitmap, converted 
<br/>
// to an array by some graphics conversion tool.
<br/>
const u8 fooBitmap[240*160*2]= 
<br/>
{
<br/>
    // Maaaaany, many lines of data.
<br/>
}
<br/>
<br/>
int main()
<br/>
{
<br/>
    REG_DISPCNT= DCNT_MODE3 | DCNT_BG2;
<br/>
<br/>
    u16 *src= (u16*)fooBitmap;  // Cast source to u16-array
<br/>
<br/>
    // Copy 240x160 pixels to VRAM (YARLY!)
<br/>
    int ii;
<br/>
    for(ii=0; ii&lt;240*160; ii++)
<br/>
        vid_mem[ii]= src[ii];
<br/>
<br/>
    return 0;
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<a class="postlink" href="http://www.coranac.com/tonc/text/first.htm" target="_blank">http://www.coranac.com/tonc/text/first.htm</a>
<br/>
<br/>
<br/>
I thought that there he didn't put the *2 because he is casting  fooBitmap to a u16 which is bigger than u8.
<br/>
<br/>
I've looked everywhere and I think that I got more confused every minute hahahahah please help</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#171807 - Pete_Lockwood - Fri Dec 25, 2009 12:42 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>vladimirsan wrote:</b></span></td> </tr> <tr> <td class="quote">I don't understand why he used fooSize/2 if both fooData and dst  elements  are 16 bits long</td> </tr></table><span class="postbody">
<br/>
It's because fooSize is the size in <span style="font-style: italic">bytes</span> not in U16s, as noted in the text immediately below: "Both these routines copy fooSize bytes from fooData to..."
<br/>
<br/>
One could argue that this isn't excessively clear in the code but at the same time an experienced C programmer would probably just infer this from the fact that src and dst are being cast from "something" to 16 bit pointers and subsequently the loop's bounds are being halved.
<br/>
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">I thought that there he didn't put the *2 because he is casting fooBitmap to a u16 which is bigger than u8.</td> </tr></table><span class="postbody">
<br/>
Correct.  src there is a 16 bit pointer so although it's pointing to something that was originally allocated as a lump of 8 bit stuff, incrementing src will move 16 bits at a time.
<br/>
<br/>
<br/>
You're basically heading in the right direction but you missed the fact that the first piece said fooSize was size in bytes.<br/>_________________<br/>It's not an illusion, it just looks like one.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#171808 - kusma - Fri Dec 25, 2009 1:00 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>vladimirsan wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
In a previous chapter is this code
<br/>
<br/>
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
// An array representing a 240x160@16 bitmap, converted 
<br/>
// to an array by some graphics conversion tool.
<br/>
const u8 fooBitmap[240*160*2]= 
<br/>
{
<br/>
    // Maaaaany, many lines of data.
<br/>
}
<br/>
<br/>
int main()
<br/>
{
<br/>
    REG_DISPCNT= DCNT_MODE3 | DCNT_BG2;
<br/>
<br/>
    u16 *src= (u16*)fooBitmap;  // Cast source to u16-array
<br/>
<br/>
    // Copy 240x160 pixels to VRAM (YARLY!)
<br/>
    int ii;
<br/>
    for(ii=0; ii&lt;240*160; ii++)
<br/>
        vid_mem[ii]= src[ii];
<br/>
<br/>
    return 0;
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<a class="postlink" href="http://www.coranac.com/tonc/text/first.htm" target="_blank">http://www.coranac.com/tonc/text/first.htm</a>
<br/>
</span></td> </tr></table><span class="postbody">
<br/>
This code is simply broken, as an u8 array might not be 16 bit aligned, so accessing it through a 16 bit pointer has a good chance of being misaligned. Even if alignment were forced by compiler directives, it would still violate the strict-aliasing rules of C99 and C++ (which are assumed on GCC even for pre-C99 when compiling with -O3).</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#171809 - vladimirsan - Fri Dec 25, 2009 1:05 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Pete_Lockwood wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
It's because fooSize is the size in <span style="font-style: italic">bytes</span> not in U16s, as noted in the text immediately below: "Both these routines copy fooSize bytes from fooData to..."
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Thanks a lot...It took me some time to figure that out (even after reading your explanation) ahahaha....I realize now that I really to study more C if I really want to do serious GBA programming.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#172007 - Erik Carrick - Fri Jan 08, 2010 9:24 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>kusma wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>vladimirsan wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
In a previous chapter is this code
<br/>
<br/>
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
// An array representing a 240x160@16 bitmap, converted 
<br/>
// to an array by some graphics conversion tool.
<br/>
const u8 fooBitmap[240*160*2]= 
<br/>
{
<br/>
    // Maaaaany, many lines of data.
<br/>
}
<br/>
<br/>
int main()
<br/>
{
<br/>
    REG_DISPCNT= DCNT_MODE3 | DCNT_BG2;
<br/>
<br/>
    u16 *src= (u16*)fooBitmap;  // Cast source to u16-array
<br/>
<br/>
    // Copy 240x160 pixels to VRAM (YARLY!)
<br/>
    int ii;
<br/>
    for(ii=0; ii&lt;240*160; ii++)
<br/>
        vid_mem[ii]= src[ii];
<br/>
<br/>
    return 0;
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<a class="postlink" href="http://www.coranac.com/tonc/text/first.htm" target="_blank">http://www.coranac.com/tonc/text/first.htm</a>
<br/>
</span></td> </tr></table><span class="postbody">
<br/>
This code is simply broken, as an u8 array might not be 16 bit aligned, so accessing it through a 16 bit pointer has a good chance of being misaligned. Even if alignment were forced by compiler directives, it would still violate the strict-aliasing rules of C99 and C++ (which are assumed on GCC even for pre-C99 when compiling with -O3).</span></td> </tr></table><span class="postbody">
<br/>
<br/>
I too was assuming this only. The code is indeed incomplete<br/>_________________<br/><a class="postlink" href="http://www.craftsadvisor.com" target="_blank">craft ideas</a> | <a class="postlink" href="http://www.theinfosage.com" target="_blank">india news</a></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
