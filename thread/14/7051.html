<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Hblank function wierdness (again.. speed related?) - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>Beginners > Hblank function wierdness (again.. speed related?)</h2>
<div id="posts">
<div class="post">
    <h4>#55955 - Ultima2876 - Tue Oct 04, 2005 10:01 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">CODE_IN_IWRAM void hblank_select(void)
<br/>
   {
<br/>
      if(REG_VCOUNT &lt; 40)
<br/>
         {
<br/>
            ((u16*)0x070003E2)[0] = hsetting[REG_VCOUNT + GBA];
<br/>
            ((u16*)0x070003EA)[0] = hsetting1[REG_VCOUNT + GBA];
<br/>
            ((u16*)0x070003F2)[0] = hsetting2[REG_VCOUNT + GBA];
<br/>
         }
<br/>
      else if(REG_VCOUNT == 150)
<br/>
         {
<br/>
            if(frameclock != 1)
<br/>
               {
<br/>
                  REG_BG3HOFS = message_scrollamount;
<br/>
               }
<br/>
         }
<br/>
      else if(REG_VCOUNT == 161)
<br/>
         {
<br/>
            REG_BG3HOFS = 0;
<br/>
         }
<br/>
      if(hblank_func == HBLANK_STARS)
<br/>
         {
<br/>
            REG_BG0HOFS = hoffset[REG_VCOUNT];
<br/>
            return;
<br/>
         }
<br/>
      return;
<br/>
   }</td> </tr></table><span class="postbody">
<br/>
<br/>
Is there anything in here that would be particularly slow, and that I should steer away from in my hblank function? I say so, because at a seemingly random time, the REG_VCOUNT = 161 code doesn't execute, and the whole of BG3 scrolls for a frame, then fixes itself again, making it flash oddly every so often. Also, it only seems to do this on hardware... am I right that it could be a speed issue? Or any other suggestions?
<br/>
<br/>
Thanks =P</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#55965 - poslundc - Wed Oct 05, 2005 12:25 am</h4>
    <div class="postbody"><span class="postbody">There is nothing overtly wrong with it, but are you setting the interrupt acknowledge bit somewhere else? This is the kind of thing that might work okay on an emulator but not on hardware.
<br/>
<br/>
Also, any stuff done when REG_VCOUNT &gt;= 160 should really be done as part of your VBlank routine rather than an HBlank ISR, as it's only increasing the size of your function unnecessarily.
<br/>
<br/>
Are you compiling it as ARM code?
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#56050 - Ultima2876 - Wed Oct 05, 2005 7:59 pm</h4>
    <div class="postbody"><span class="postbody">I'm fairly sure I'm not setting that bit anywhere else, and it's compiling to ARM code.
<br/>
<br/>
About the REG_VCOUNT &gt; 160... I did actually have it setting REB_BG0HOFS to 0 immidiately after my WaitForVsync();, but that didn't seem to fix it so I tried putting it explicitly in the Hblank function...
<br/>
<br/>
Any more ideas? =/</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#56052 - poslundc - Wed Oct 05, 2005 8:18 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Ultima2876 wrote:</b></span></td> </tr> <tr> <td class="quote">I'm fairly sure I'm not setting that bit anywhere else,</td> </tr></table><span class="postbody">
<br/>
<br/>
So... set it then.
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#56054 - Ultima2876 - Wed Oct 05, 2005 8:20 pm</h4>
    <div class="postbody"><span class="postbody">Do I have to set it in more than one place? I thought you just set it in your interrupt handler then clear it when you're done.. unless I have it set up completely wrong. Cheers =P</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#56056 - poslundc - Wed Oct 05, 2005 8:26 pm</h4>
    <div class="postbody"><span class="postbody">You must set the HBlank bit in REG_IF at the end of your interrupt.
<br/>
<br/>
REG_IF = 2;
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#56130 - Ultima2876 - Thu Oct 06, 2005 2:09 pm</h4>
    <div class="postbody"><span class="postbody">OH! I remember reading that in TONC. Thanks a lot for that... dunno if it'll solve the problem, as I can't seem to reproduce it reliably now. X_x;</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#56139 - Cearn - Thu Oct 06, 2005 4:38 pm</h4>
    <div class="postbody"><span class="postbody">if you're using tonc's or libgba's interrupt handler, acknowledging the interrupt is indeed done for you. This is probably not the issue, but have you checked whether the the routine is actually in iwram? I remember having some problems with that in the past when having ROM / IWRAM in the same file (or am I thinking about calling IWRAM from ROM when the routines are in the same file? oh well, check anyway).
<br/>
<br/>
What is going to matter, even if it is just a little, is that you have multiple references to REG_VCOUNT. All registers are volatile, which basically means that the optimiser should keep its hand off. which means that the thing is loaded every time you reference it, which is not something you want to do inside an HBlank interrupt. It's probably better to load it into a local variable and check that instead of using REG_VCOUNT directly. You're also wasting a few instructions (and registers) by accessing OAM in three casts. GCC constructs the addresses for each case rather than using offsets, even when you're accessing consecutive memory. Using structs instead would be a little faster and cleaner.
<br/>
<br/>
Can't see why the code as is would be slow enough for a misfire, even running all the cases would probably take less than a hundred cycles, and an hblank lasts 272. Of course, the overhead for the main isr reduces the amount you can use, but still.
<br/>
Are you using DMA near the VBlank somewhere? Those could mess up interrupts too.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#56375 - Ultima2876 - Sat Oct 08, 2005 7:40 am</h4>
    <div class="postbody"><span class="postbody">Ah. DMA in Vblank is a very good point. The only thing I use DMA for is the CopyOAM thing, and sure enough that happens right at the start of every Vblank. I'm pretty sure that'll be it. Excellent, I can sort that out fairly easily. =P
<br/>
<br/>
And thanks a lot for all those optimisation tips aswell. I'll be sure to use them.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
