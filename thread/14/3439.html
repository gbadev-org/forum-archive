<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Two questions: peter teichman and fixed point math - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>Beginners > Two questions: peter teichman and fixed point math</h2>
<div id="posts">
<div class="post">
    <h4>#21026 - alek - Fri May 21, 2004 7:55 pm</h4>
    <div class="postbody"><span class="postbody">Hi.
<br/>
<br/>
I have two questions:
<br/>
Peter teichman writes:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
/* if you need both quotient and reminder */
<br/>
extern __value_in_regs udiv_t FDIV(unsigned int a, unsigned int b);
<br/>
extern __value_in_regs div_t FDIVS(int a, int b);
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
for his division routine what does 
<br/>
__value_in_regs udiv_t and
<br/>
__value_in_regs div_t
<br/>
mean?
<br/>
what should be there instead?
<br/>
<br/>
My second question:
<br/>
I got this fixed point multiplication code from tepples
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
@ int fixmul(int a, int b)
<br/>
    .ARM
<br/>
    .ALIGN
<br/>
    .GLOBL fixmul
<br/>
<br/>
fixmul:
<br/>
  smull r1, r2, r0, r1     @ r2:r1 = (long long)r0 * r1
<br/>
  mov r0, r2, lsl #16      @ r0 = r2 &lt;&lt; 16
<br/>
  orr r0, r0, r1, lsr #16  @ r0 |= (unsigned int)r1 &gt;&gt; 16
<br/>
  bx lr                    @ return r0
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
what changes do I need to do to get it to work with 20:12 fixed point numbers.
<br/>
<br/>
Thanks.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#21029 - Miked0801 - Fri May 21, 2004 10:41 pm</h4>
    <div class="postbody"><span class="postbody">The val_in_regs thing didn't work with my version of GCC so I returned one of the values through arguments.
<br/>
<br/>
TO make the assembly work with 20:12, you'd need to change the lsl #16 to lsl #20 and the lsr #16 to lsr #12.
<br/>
<br/>
Someone else confirm please?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#21030 - alek - Fri May 21, 2004 10:45 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Miked0801 wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
<br/>
TO make the assembly work with 20:12, you'd need to change the lsl #16 to lsl #20 and the lsr #16 to lsr #12.
<br/>
<br/>
Someone else confirm please?</td> </tr></table><span class="postbody">
<br/>
<br/>
I've already tried that and unless I'm doing something else wrong that change doesn't work...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#21037 - tepples - Sat May 22, 2004 2:15 am</h4>
    <div class="postbody"><span class="postbody">You might have to play with the values until you get them right. Try rigging up a text interface that multiplies two numbers and then prints the hex result. You'll quickly learn how many bits you are off.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#21042 - alek - Sat May 22, 2004 9:07 am</h4>
    <div class="postbody"><span class="postbody">I did what tepples said and found out that I should change 
<br/>
lsl#16 to lsl#12   and
<br/>
lsr#16 to lsr#20
<br/>
<br/>
I got it wrong before I meant 12:20 fixed point numbers so Miked0801 was right:)
<br/>
<br/>
But when I put it in my project it freaks out...
<br/>
<br/>
I change
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
f[1]=setup[mode][number].a12*Divfx(power3(r12),Mulfx(m2,(u[4]-u[0])))+
<br/>
         setup[mode][number].a13*Divfx(power3(r31),Mulfx(m3,(u[8]-u[0])));</td> </tr></table><span class="postbody">
<br/>
<br/>
where
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#define BITS 20
<br/>
#define FACTOR 1048576
<br/>
#define Mulfx(x,y) (((long long)y * x)&gt;&gt;BITS)      // Multiply a fixed by a fixed
<br/>
#define Divfx(x,y) (((long long)y*FACTOR) / (x))    //Divide a fixed by a fixed
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
with
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
f[1]=setup[mode][number].a12*Divfx(power3(r12),fixmul(m2,(u[4]-u[0])))+
<br/>
         setup[mode][number].a13*Divfx(power3(r31),fixmul(m3,(u[8]-u[0])));
<br/>
</td> </tr></table><span class="postbody">
<br/>
where
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
@ int fixmul(int a, int b)
<br/>
    .ARM
<br/>
    .ALIGN
<br/>
    .GLOBL fixmul
<br/>
<br/>
fixmul:
<br/>
  smull r1, r2, r0, r1     @ r2:r1 = (long long)r0 * r1
<br/>
  mov r0, r2, lsl #12      @ r0 = r2 &lt;&lt; 16
<br/>
  orr r0, r0, r1, lsr #20  @ r0 |= (unsigned int)r1 &gt;&gt; 16
<br/>
  bx lr  
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#21062 - alek - Sat May 22, 2004 5:45 pm</h4>
    <div class="postbody"><span class="postbody">it seems like the fixmul version only freaks out in special cases but I can't find the values for when it goes from working to freaking out... shouldn't the fixmul and Mulfx behave the same way?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#21064 - alek - Sat May 22, 2004 7:20 pm</h4>
    <div class="postbody"><span class="postbody">I got it to work but I had to change some other numbers... I still don't understand why it didn't work before... Why doesn't the fixmul and Mulfx posted above work precisley the same?</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
