<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Visual Studio and Apex Audio System; undefined references... - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>Beginners > Visual Studio and Apex Audio System; undefined references...</h2>
<div id="posts">
<div class="post">
    <h4>#27716 - [Titan] - Tue Oct 19, 2004 11:44 pm</h4>
    <div class="postbody"><span class="postbody">Hi all,
<br/>
<br/>
I'm trying to get  Apex Audio System to work in my project, but somehow I can't link the library to the rest of my program.
<br/>
I'm using MSVS 6.0 as development environment, and the folowing makefile:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code"># ------------------------------------------
<br/>
# Title:      Default Makefile for use in VC++
<br/>
# File:          Dune2.mak
<br/>
# Revision:     01/06/2002
<br/>
# 
<br/>
# Author:      Benjamin D. Hale
<br/>
# Orignally by:         Jaap Suter
<br/>
# Contributed to by:    Christer Andersson
<br/>
# 
<br/>
# Info:              This file is contains the make-instructions
<br/>
#         for the project. Replace DEVDIR with the appropriate
<br/>
#                       base directory for devkitadv. After you make the 
<br/>
#                       needed modifications here rename this file to
<br/>
#                       &lt;project_name&gt;.mak so Visual C++ does not get
<br/>
#                       confused.
<br/>
# -------------------------------------------
<br/>
<br/>
# -------------------------------------------
<br/>
# Project name definition makes this whole thing 
<br/>
# a lot easier to use. Only two total modifications
<br/>
# (other than what .o files will be needed)
<br/>
# should be needed to get this working with your
<br/>
# compiler and Visual C++. Replace "Default" with
<br/>
# your project's name.
<br/>
<br/>
# -------------------------------------------
<br/>
<br/>
PROJECT = AASExample
<br/>
<br/>
# -------------------------------------------
<br/>
# Define some directories;
<br/>
# -------------------------------------------
<br/>
<br/>
# -------------------------------------------
<br/>
# Base Directory for gcc arm-agb-elf replace with 
<br/>
# wherever you put your gba devkitadv files.
<br/>
# -------------------------------------------
<br/>
<br/>
DEVDIR  = D:\GBA\DevkitAdv
<br/>
<br/>
# -------------------------------------------
<br/>
# Source directory (where your project's source files are located.)
<br/>
# -------------------------------------------
<br/>
<br/>
SRCDIR  = D:\GBA\projects\AAS\
<br/>
<br/>
# -------------------------------------------
<br/>
# Compiler Directories for binaries, includes and libs.
<br/>
# -------------------------------------------
<br/>
<br/>
CMPDIR  = $(DEVDIR)\bin
<br/>
LIBDIR  = $(DEVDIR)\lib\gcc-lib\arm-agb-elf\3.0.2\interwork
<br/>
LIBDIR2 = $(DEVDIR)\arm-agb-elf\lib\interwork
<br/>
LIBDIR3 = $(SRCDIR)\LibAAS
<br/>
INCDIR  = $(DEVDIR)\lib\gcc-lib\arm-agb-elf\3.0.2\include
<br/>
INCDIR2 = $(DEVDIR)\arm-agb-elf\include
<br/>
INCDIR3 = $(SRCDIR)\LibAAS
<br/>
<br/>
# -------------------------------------------
<br/>
# END of directory defines
<br/>
# -------------------------------------------
<br/>
<br/>
# -------------------------------------------
<br/>
# Define what extensions we use;
<br/>
# -------------------------------------------
<br/>
.SUFFIXES : .cpp .c .s
<br/>
<br/>
# -------------------------------------------
<br/>
# Define the flags for the compilers;
<br/>
# -------------------------------------------
<br/>
CFLAGS  = -I $(INCDIR3) -I $(INCDIR2) -I $(INCDIR) -I $(SRCDIR) -mthumb-interwork -c -g -O3 -Wall -fverbose-asm
<br/>
SFLAGS  = -I $(INCDIR2) -I $(INCDIR) -mthumb-interwork 
<br/>
LDFLAGS = -L $(LIBDIR3) -L $(LIBDIR) -L $(LIBDIR2) -T LinkScript -l AAS
<br/>
<br/>
# -------------------------------------------
<br/>
# Define the list of all O files;
<br/>
# Just follow the syntax shown to add any 
<br/>
# other objects your project may need to
<br/>
# compile properly. You will need to add 
<br/>
# files to this part to make it work with 
<br/>
# your project add a \ to the end of all o
<br/>
# files except the last one. Like below.
<br/>
# -------------------------------------------
<br/>
<br/>
O_FILES          = \
<br/>
                   crt0.o \
<br/>
               AAS_Data.o \
<br/>
               AASExample.o 
<br/>
<br/>
# -------------------------------------------
<br/>
# There should be no need to modify anything
<br/>
# below here.
<br/>
# -------------------------------------------
<br/>
<br/>
# -------------------------------------------
<br/>
# Define the final dependecy;
<br/>
# -------------------------------------------
<br/>
all : $(PROJECT).gba
<br/>
<br/>
# -------------------------------------------
<br/>
# Define the copy from .elf to .bin file
<br/>
# -------------------------------------------
<br/>
$(PROJECT).gba : $(PROJECT).elf
<br/>
   $(CMPDIR)\objcopy -O binary $(PROJECT).elf $(PROJECT).gba
<br/>
   -@echo ------------------------------------------ 
<br/>
   -@echo Done 
<br/>
   -@echo ------------------------------------------ 
<br/>
<br/>
$(PROJECT).elf : $(O_FILES)
<br/>
   $(CMPDIR)\ld $(LDFLAGS) -o $(PROJECT).elf $(O_FILES) -lstdc++ -lc -lgcc
<br/>
   -@echo ------------------------------------------ 
<br/>
   -@echo Linking Done 
<br/>
   -@echo ------------------------------------------ 
<br/>
<br/>
AAS_Data.o::
<br/>
   conv2aas AAS_Data
<br/>
   $(CMPDIR)\as $(SFLAGS) -o $@ AAS_Data.s
<br/>
# -------------------------------------------
<br/>
# Define each compile;
<br/>
# -------------------------------------------
<br/>
{$(SRCDIR)}.cpp.o::
<br/>
   $(CMPDIR)\gcc  $(CFLAGS) $&lt; 
<br/>
   -@echo ------------------------------------------ 
<br/>
   -@echo CPP-Sources Compiled 
<br/>
   -@echo ------------------------------------------ 
<br/>
<br/>
{$(SRCDIR)}.c.o::
<br/>
   $(CMPDIR)\gcc  $(CFLAGS) $&lt;
<br/>
   -@echo ------------------------------------------
<br/>
   -@echo C-sources Compiled
<br/>
   -@echo ------------------------------------------
<br/>
<br/>
# -------------------------------------------
<br/>
# Define each assemble;
<br/>
# -------------------------------------------
<br/>
{$(SRCDIR)}.s.o:
<br/>
   $(CMPDIR)\as $(SFLAGS) $(SRCDIR)\$*.s -o$@
<br/>
   -@echo ------------------------------------------ 
<br/>
   -@echo ASM-Sources Compiled 
<br/>
   -@echo ------------------------------------------ 
<br/>
   
<br/>
# -------------------------------------------
<br/>
# Any problems with getting this working email
<br/>
# questions to <a href="mailto:whatzdat_pimp@hotmail.com">whatzdat_pimp@hotmail.com</a> .
<br/>
# This was tested on devkitadv r4 and Visual C++ 6
<br/>
# on a p3 450/512mb/Windows XP Pro.
<br/>
# -------------------------------------------
<br/>
# EOF;</td> </tr></table><span class="postbody">
<br/>
<br/>
this has worked without problems until I tried to link a library to my project.
<br/>
My source file, linkscript and crt0.s come directly from "example2" from AAS. The directory structure is exactly the same as in the sample. Yet when I try to build my project, I get the following error:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">--------------------Configuration: AASExample - Win32 Debug--------------------
<br/>
Microsoft (R) Program Maintenance Utility   Version 6.00.8168.0
<br/>
Copyright (C) Microsoft Corp 1988-1998. All rights reserved.
<br/>
 conv2aas AAS_Data
<br/>
/---------------------------------------------\
<br/>
| Conv2AAS v1.07        WAV, RAW &amp; MOD -&gt; AAS |
<br/>
| Copyright (c) 2003, Apex Designs            |
<br/>
\---------------------------------------------/
<br/>
Adding WAV Ambulance.wav...Done!
<br/>
Adding RAW Boom.raw...Done!
<br/>
Adding MOD CreamOfTheEarth.mod...4 channels...Done!
<br/>
song_length:27 last_pattern:27
<br/>
Writing AAS_SampleData (Unique:18 Actual:18 Length:123780)...Done!
<br/>
Writing AAS_PatternData (Unique:66 Actual:112 Length:16896)...Done!
<br/>
 D:\GBA\DevkitAdv\bin\as -I D:\GBA\DevkitAdv\arm-agb-elf\include -I D:\GBA\DevkitAdv\lib\gcc-lib\arm-agb-elf\3.0.2\include -mthumb-interwork -o AAS_Data.o AAS_Data.s
<br/>
 D:\GBA\DevkitAdv\bin\ld -L D:\GBA\projects\AAS\LibAAS -L D:\GBA\DevkitAdv\lib\gcc-lib\arm-agb-elf\3.0.2\interwork -L D:\GBA\DevkitAdv\arm-agb-elf\lib\interwork -T LinkScript -l AAS -o AASExample.elf crt0.o  AAS_Data.o  AASExample.o -lstdc++ -lc -lg
<br/>
cc
<br/>
crt0.o: In function `jump_intr_AAS':
<br/>
crt0.o(.iwram+0x108): undefined reference to `AAS_FastTimer1InterruptHandler'
<br/>
AASExample.o: In function `AgbMain':
<br/>
D:/GBA/projects/AAS/AASExample.c:53: undefined reference to `AAS_SetConfig'
<br/>
D:/GBA/projects/AAS/AASExample.c:56: undefined reference to `AAS_ShowLogo'
<br/>
D:/GBA/projects/AAS/AASExample.c:63: undefined reference to `AAS_MOD_Play'
<br/>
D:/GBA/projects/AAS/AASExample.c:77: undefined reference to `AAS_SFX_Play'
<br/>
D:/GBA/projects/AAS/AASExample.c:84: undefined reference to `AAS_SFX_Play'
<br/>
D:/GBA/projects/AAS/AASExample.c:79: undefined reference to `AAS_SFX_Stop'
<br/>
AASExample.o:D:/GBA/projects/AAS/AASExample.c:16: undefined reference to `AAS_DoWork'
<br/>
NMAKE : fatal error U1077: 'D:\GBA\DevkitAdv\bin\ld' : return code '0x1'
<br/>
Stop.
<br/>
Error executing NMAKE.
<br/>
<br/>
AASExample.gba - 1 error(s), 0 warning(s)</td> </tr></table><span class="postbody">
<br/>
<br/>
As you can see, it is able to find the library (there's no error indicating the library could not be found) but somehow it's not able to find any of the library's functions.
<br/>
<br/>
What am I doing wrong here? Any suggestions?
<br/>
<br/>
t.i.a.
<br/>
<br/>
<span style="font-size: 7px; line-height: normal">/me get's back to banging his head against the wall...</span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#27724 - DiscoStew - Wed Oct 20, 2004 1:45 am</h4>
    <div class="postbody"><span class="postbody">Have you tried using 'gcc' instead  of 'ld' for linking your object files? I had this same problem some time back in this thread "<a class="postlink" href="http://forum.gbadev.org/viewtopic.php?t=3477" target="_blank">Mixing 8ad and Apex</a>", but with the help of jd and tepples, using gcc for the linker fixed those problems. Using 'gcc' actually calls 'ld' at that point of linking, but 'gcc' handles those in-between things that using plain 'ld' doesn't.<br/>_________________<br/><span style="font-weight: bold">DS</span> - It's all about <span style="font-weight: bold">D</span>isco<span style="font-weight: bold">S</span>tew</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#27732 - jd - Wed Oct 20, 2004 5:20 am</h4>
    <div class="postbody"><span class="postbody">GCC has an unusual quirk that libraries have to be specified after the object files on the command line. You should remove "-l AAS" from LDFLAGS and add it at the linking phase so the line becomes:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
$(CMPDIR)\ld $(LDFLAGS) -o $(PROJECT).elf $(O_FILES) -lstdc++ -lc -lgcc -l AAS
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
As DiscoStew pointed out, linking with ld can cause problems as it doesn't automatically link in everything you need - but, judging by the messages you're getting, it looks as though you've already worked around those issues. (But linking with gcc would shorten your makefile.)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#27743 - [Titan] - Wed Oct 20, 2004 9:28 am</h4>
    <div class="postbody"><span class="postbody">argh.. I can't believe it was that simple &gt;_&lt;
<br/>
<br/>
I still use LD to link (it works now, so no need to change it). And after adding -lAAS to the very end of the command line for LD. The Undefined references to the AAS library were gone. Only to be replaced by undefined references caused by the library itself (the same as DiscoStew had ("undefined reference to `_call_via_r3' "). That was solved by placing -lgcc at the end of the commandline. The complete command for LD now looks like this:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">$(PROJECT).elf : $(O_FILES)
<br/>
   $(CMPDIR)\ld $(LDFLAGS) -o $(PROJECT).elf $(O_FILES) -lstdc++ -lc -lAAS -lgcc
<br/>
   -@echo ------------------------------------------ 
<br/>
   -@echo Linking Done 
<br/>
   -@echo ------------------------------------------ </td> </tr></table><span class="postbody">
<br/>
And I've removed -lAAS from the LDFLAGS.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">------------------------------------------
<br/>
Linking Done
<br/>
------------------------------------------
<br/>
 D:\GBA\DevkitAdv\bin\objcopy -O binary AASExample.elf AASExample.gba
<br/>
------------------------------------------
<br/>
Done
<br/>
------------------------------------------
<br/>
<br/>
AASExample.gba - 0 error(s), 0 warning(s)</td> </tr></table><span class="postbody">
<br/>
Now that's what I wanted to see, Thanks guys!
<br/>
<br/>
/me is off to play around with aas a bit, and integrate it in my real project ^_^</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#27749 - [Titan] - Wed Oct 20, 2004 2:03 pm</h4>
    <div class="postbody"><span class="postbody">Next problem ^_^;;
<br/>
<br/>
I've integrated AAS in my project (and yes, it compiles) and everything works fine, until I start to play a MOD, then the screen starts shaking to the beat of the music (pretty cool effect, but it becomes quite annoying).
<br/>
<br/>
Now the question is, is this a feature, or is it a bug (made by me)?
<br/>
<br/>
A little info on the structure of my program:
<br/>
-Initialize game
<br/>
 -set all OAM data
<br/>
 -set AAS settings
<br/>
-Extract level
<br/>
-Copy Tile palette+tiles
<br/>
-Copy sprite palette + sprites
<br/>
-Set background + display mode (mode 2, background2, objects on)
<br/>
-Start timer 3 (for FPS counter)
<br/>
-Main program loop
<br/>
 -Get input
<br/>
 -Wait for VSync
<br/>
 -fill BG 2
<br/>
 -determine new values for Affine registers
<br/>
 -do FPS counting
<br/>
-end of program
<br/>
<br/>
The only DMA copy I use, is AAS_DoDMA3. In crt0.s, multiple interrupts are enabled, and in my interrupt handler, AAS_Timer1InterruptHandler() is called whenever there's a timer 1 interrupt. (sound plays perfect btw)
<br/>
The controls are like this:
<br/>
A/B : zoom
<br/>
up/down/left/right : move the map
<br/>
left/right shoulder button : rotate map
<br/>
start/select : play/stop music
<br/>
<br/>
I've uploaded a small demo <a class="postlink" href="http://www.ouden.org/zips/Dune.zip" target="_blank">here</a> (124KB)
<br/>
The screen only starts to shake when the music is playing, and the shaking is directly connected to the music playing (a different track results in a different shaking pattern).
<br/>
And please, don't pay too much attention to my 5-minutes-well-spent-isometric-engine (or 5mwsie for short) it still needs a lot of work.
<br/>
<br/>
Any suggestions are welcome, thanks in advance!
<br/>
<br/>
<br/>
Off to write my own .VOC to AAS converter in the meantime ^_^</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#27763 - jd - Wed Oct 20, 2004 8:39 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>[Titan] wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
The screen only starts to shake when the music is playing, and the shaking is directly connected to the music playing (a different track results in a different shaking pattern).
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
AAS supports two interrupt handling methods:
<br/>
<br/>
1) <span style="font-style: italic">The easier way.</span> Just make sure that a timer 1 interrupt results in a call to AAS_Timer1InterruptHandler(). This is the method used in AASExample.
<br/>
<br/>
2) <span style="font-style: italic">The harder way.</span> Use the custom "AAS_MultipleInterrupts" mode in the included crt0.s. (This will give timer 1 interrupts priority and automatically call AAS_FastTimer1InterruptHandler() (not AAS_Timer1InterruptHandler()) when a timer 1 interrupt occurs.) You will also need to set up AAS_IntrTable[] to point to the routines that handle all the other interrupts. Additionally, you need to call AAS_DoWork() at least 50 times per second - the recommended way to do this is by putting it in your VBlank handler. This is the method used in AASExample2.
<br/>
<br/>
It's hard to say without seeing the source code, but it looks as though the problem you're getting is caused by AAS interrupting your code during the "Wait for VSync" phase. To fix this, you'll have to switch to method (2) above. However, since you don't seem to have a VBlank handler in your game, you've got two options:
<br/>
<br/>
1) <span style="font-style: italic">The hacky way.</span> Call AAS_DoWork() immediately before your "Wait for VSync" step. Note that outside of the main game you still need to call AAS_DoWork() at least 50 times per second, so you'll need to switch to calling it during a VBlank interrupt or something similar in those cases.
<br/>
<br/>
2) <span style="font-style: italic">The neater way.</span> Change your game so that does all the time critical stuff (updating backgrounds etc.) in the VBlank interrupt rather than in the main code, and call AAS_DoWork() at the end of that interrupt.</span><span class="gensmall"><br/><br/>Last edited by jd on Thu Oct 21, 2004 12:12 am; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#27768 - [Titan] - Wed Oct 20, 2004 9:47 pm</h4>
    <div class="postbody"><span class="postbody">The hacky way did the trick. I first tried using the VBlank interrupt and call AAS_DoWork() whenever a VBlank interrupt occurred, but all it did was cut my framerate in half.  Putting AAS_DoWork() right under the WaitForVBlank()  did nothing to the framerate, but the bouncing was still there. And finally, putting AAS_DoWork() right before WaitForVBlank fixed it all. The framerate is still at 60 FPS, and the shaking screen has disappeared. Thanks!
<br/>
<br/>
The only time critical code in my program is setting the Affine Registers, placing the right tiles in the right place, and putting the sprites at the right place. That's not that terribly CPU intensive so I guess that won't be much of a problem.
<br/>
I just did some cpu measuring (using the vcount register ^_^) and AAS_DoWork() takes about 6-8 lcd lines to complete (2.6% - 3.5% CPU load), the background filling takes a steady 62 lines to complete (27.2% CPU load) but hasn't been optimized yet. At the moment, that leaves 158 lines (69.3% CPU load) unused for command processing and A.I. Both of them are not time critical (as if the player would ever notice that his unit reacts 3 frames after he pressed a button ^_^).
<br/>
<br/>
Anyway, thanks for your help, I appreciate it.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#27771 - jd - Thu Oct 21, 2004 12:21 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>[Titan] wrote:</b></span></td> </tr> <tr> <td class="quote">I just did some cpu measuring (using the vcount register ^_^) and AAS_DoWork() takes about 6-8 lcd lines to complete (2.6% - 3.5% CPU load),</td> </tr></table><span class="postbody">
<br/>
<br/>
I should point out that 1/6 of the time you should find that AAS_DoWork() will return virtually instantly (as it only really needs to be called 50 times a second, and will return immediately if it is called more often than that) - so the average CPU usage would be 5/6 of the figure you measured.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>[Titan] wrote:</b></span></td> </tr> <tr> <td class="quote">Anyway, thanks for your help, I appreciate it.</td> </tr></table><span class="postbody">
<br/>
<br/>
No problem. I'm glad it's all working now.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
