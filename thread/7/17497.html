<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Compiler isn't compiling the way I'd expect. - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>C/C++ > Compiler isn't compiling the way I'd expect.</h2>
<div id="posts">
<div class="post">
    <h4>#176023 - sverx - Tue Mar 22, 2011 12:23 pm</h4>
    <div class="postbody"><span class="postbody">I'm not sure C/C++ section is the correct one, but this isn't exactly an ASM question so I guess it could be placed here... ok, let's go on ;)
<br/>
<br/>
I've been very curious lately to see how the compiler works on some C code I'm writing, thus I added that <span style="font-style: italic">--save-temps</span> to the command line and I started reading the output .s files. But they already made me think twice that the compiler is doing kind of strange things.
<br/>
<br/>
For instance I've got an array of structs and I need to initialize (at value=0xFFFF) the 5th, 6th, 7th, 8th element of the struct (they're all u16) at a given index of the array. The compiler does this (comments are mine):
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">   ldr   r1, .L37+8   @ this loads the start point + 8 for the off.
<br/>
   lsl   r3, r0, #4   @
<br/>
   add   r1, r1, r3   @ makes r1 point to the element to change
<br/>
   mov   r2, r1       @ copy to r2  -???-
<br/>
   mov   r3, #1       @
<br/>
   neg   r3, r3       @ these 2 lines sets r3 to -1 
<br/>
   add   r2, r2, #8   @ add 8 to r2 -???-
<br/>
   strh   r3, [r1, #8]
<br/>
   strh   r3, [r2, #2]
<br/>
   strh   r3, [r2, #4]
<br/>
   strh   r3, [r2, #6]
<br/>
</td> </tr></table><span class="postbody">
<br/>
The question is: why is it using r2? It couldn't just use one register and the 4 different offsets?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#176024 - Quirky - Tue Mar 22, 2011 1:36 pm</h4>
    <div class="postbody"><span class="postbody">What's the C code that you're using and the optimisation flags? I can't reproduce this with -Os and the following code:
<br/>
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
struct test {
<br/>
   short null0;
<br/>
   short null1;
<br/>
   short null2;
<br/>
   short null3;
<br/>
   short a;
<br/>
   short b;
<br/>
   short c;
<br/>
   short d;
<br/>
};
<br/>
<br/>
extern struct test *t;
<br/>
<br/>
void set_to_ff(void)
<br/>
{
<br/>
   t-&gt;a = -1;
<br/>
   t-&gt;b = -1;
<br/>
   t-&gt;c = -1;
<br/>
   t-&gt;d = -1;
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
That gives the following thumb:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
   ldr   r3, .L3
<br/>
   ldr   r2, [r3]
<br/>
   mov   r3, #1
<br/>
   neg   r3, r3
<br/>
   strh   r3, [r2, #8]
<br/>
   strh   r3, [r2, #10]
<br/>
   strh   r3, [r2, #12]
<br/>
   strh   r3, [r2, #14]
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#176025 - sverx - Tue Mar 22, 2011 1:47 pm</h4>
    <div class="postbody"><span class="postbody">extract from the code:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">typedef struct node {
<br/>
  unsigned short int m;
<br/>
  unsigned short int n;
<br/>
  unsigned short int o;
<br/>
  unsigned short int p;
<br/>
<br/>
  unsigned short int a;
<br/>
  unsigned short int b;
<br/>
  unsigned short int c;
<br/>
  unsigned short int d;
<br/>
} node;
<br/>
<br/>
node Set[4096];
<br/>
<br/>
(...)
<br/>
<br/>
Set[n].a=0xFFFF;
<br/>
Set[n].b=0xFFFF;
<br/>
Set[n].c=0xFFFF;
<br/>
Set[n].d=0xFFFF;</td> </tr></table><span class="postbody">
<br/>
<br/>
flags are </span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">-g -Wall -O2 -fomit-frame-pointer -ffast-math --save-temps -mthumb -mthumb-interwork -march=armv5te -mtune=arm946e-s </td> </tr></table><span class="postbody">
<br/>
<br/>
your code looks like what I'd expected to see... :|</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#176026 - Quirky - Wed Mar 23, 2011 9:11 am</h4>
    <div class="postbody"><span class="postbody">This is interesting. If you have this code:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
void set_to_ff(int n)
<br/>
{
<br/>
   Set[n].a=0xFFFF;
<br/>
   Set[n].b=0xFFFF;
<br/>
   Set[n].c=0xFFFF;
<br/>
   Set[n].d=0xFFFF;
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Then the thumb output has the extra additions that you mention, like this:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
   ldr   r2, .L3         @ r2 = Set
<br/>
   lsl   r0, r0, #4      @ r0 = n * 16
<br/>
   mov   r3, #1
<br/>
   neg   r3, r3          @ r3 = 0xffff:ffff
<br/>
   add   r0, r0, #8      @ r0 += 8
<br/>
   strh   r3, [r0, r2]    @ *(r2 + r0) = 0xffff
<br/>
   add   r0, r2, r0      @ r0 = Set + (n * 16 + 8)
<br/>
   strh   r3, [r0, #2]    @ *r0 = 0xffff, ... etc.
<br/>
   strh   r3, [r0, #4]
<br/>
   strh   r3, [r0, #6]
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
When you provide a pointer alias to the n'th entry, you get better code:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
void set_to_ff(int n)
<br/>
{
<br/>
   struct test *s = &amp;Set[n];
<br/>
   s-&gt;a=0xFFFF;
<br/>
   s-&gt;b=0xFFFF;
<br/>
   s-&gt;c=0xFFFF;
<br/>
   s-&gt;d=0xFFFF;
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
This is the thumb:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
   ldr   r3, .L3         @ r3 = Set
<br/>
   lsl   r0, r0, #4      @ r0 = n * 16
<br/>
   add   r0, r3, r0      @ r0 = Set + n * 16
<br/>
   mov   r3, #1
<br/>
   neg   r3, r3          @ r3 = 0xffff:ffff
<br/>
   strh   r3, [r0, #8]    @ r0[8] = 0xffff ... etc.
<br/>
   strh   r3, [r0, #10]
<br/>
   strh   r3, [r0, #12]
<br/>
   strh   r3, [r0, #14]
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
The 2nd snippet is more idiomatic C IMO, since it has a less copy-paste look to it.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#176027 - sverx - Wed Mar 23, 2011 9:37 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quirky wrote:</b></span></td> </tr> <tr> <td class="quote">This is interesting.</td> </tr></table><span class="postbody">
<br/>
Indeed. Looks like it's not really performing well, IMHO. BTW it's very interesting that its behavior can be changed simply declaring a pointer to the n'th entry and using that. It's a good workaround.
<br/>
<br/>
Another strange thing I've seen is that other one:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">   ldr   r2, .L5        @ load array address
<br/>
   lsr   r3, r0, #3     @ calculate the element I need
<br/>
   ldrb   r3, [r2, r3]  @ load the element
<br/>
   mov   r2, #7         @
<br/>
   and   r0, r0, r2     @ calculate the bit I want to take
<br/>
   asr   r3, r3, r0     @ shift it to the LSB
<br/>
   mov   r0, r3         @  copy r3 to r0 -???-
<br/>
   mov   r3, #1         @
<br/>
   and   r0, r0, r3     @  clear other bits 
<br/>
   bx   lr</td> </tr></table><span class="postbody">
<br/>
this extracts a requested bit from a byte array (returns 0 or 1).
<br/>
Why is it copying r3 to r0? Couldn't simply load 1 to r0 and AND it with r3?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#176028 - Quirky - Wed Mar 23, 2011 12:28 pm</h4>
    <div class="postbody"><span class="postbody">I wouldn't obsess too much over these things. In most cases you can write C code that helps the compiler (like the pointer thing), in other cases you're better off having clearer code. If you hit a bottleneck, optimise there, but only after profiling to see where the slowdowns are.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#176029 - sverx - Wed Mar 23, 2011 1:26 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quirky wrote:</b></span></td> </tr> <tr> <td class="quote">I wouldn't obsess too much over these things.</td> </tr></table><span class="postbody">
<br/>
Of course. It's just curiosity, and it may teach me some interesting things, actually. BTW I switched to using a pointer to the n'th element, as in your example, and the resulting asm code didn't change at all. I guess it's because the code I pasted is actually part of a more complex function, even if there's just a simple <span style="font-style: italic">if</span> before that part.
<br/>
Thanks! :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#176030 - Miked0801 - Wed Mar 23, 2011 7:17 pm</h4>
    <div class="postbody"><span class="postbody">Let the compiler do the compiling.  It's hard enough to code without worrying about the little details.  Yes, it's interesting to see how the compiler does things, and yes, quite often it doesn them a bit sub-optimally, but as long as it works, a little inefficiency around the edges isn't going to cause much harm.  A profile will show you where your efforts will be better spent.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#176032 - sverx - Thu Mar 24, 2011 8:59 am</h4>
    <div class="postbody"><span class="postbody">Actually, how do you guys profile? Which are the tools I could use, beside from building my own profiling routines? (I know it's OT but YOU triggered it ;) )</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#176033 - Quirky - Thu Mar 24, 2011 9:27 am</h4>
    <div class="postbody"><span class="postbody">For GBA, you can profile using Visual Boy Advance and gprof.
<br/>
<br/>
I've not profiled DS code natively. The tools just aren't there. I get the parts I want to profile compiling for Linux and then use its gprof.
<br/>
<br/>
There's also the old skool profiling technique using colored bands. Set BG_PALETTE[0] to red at the start of a section you want to make faster, then black at the end. The red band shows how long the function took to execute in terms of horizontal lines on the screen. The challenge is to try and make the red band smaller.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#176034 - sverx - Thu Mar 24, 2011 9:36 am</h4>
    <div class="postbody"><span class="postbody">Actually I'm 'profiling' saving the VCOUNT at the beginning and at the end of the section and printing those at the end, which is kind of changing the palette color 0 but easier to read ;)
<br/>
This of course doesn't tell me how many times a function has been called and how long the elaboration required in each single function, so I think I really can't call 'profiling' what I'm doing now... but the problem is that I found no tools (on DS) to do what I'd like to, that's why I was wondering...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#176053 - Miked0801 - Mon Mar 28, 2011 6:00 pm</h4>
    <div class="postbody"><span class="postbody">The pay version of No$ has a nice, non-intrusive profiler built in.  Failing that, you get to do it old school - use a timer at the highest resolution and record the start and stop time in the functions use wish to profile, store them over time and compare vs the entire gameloop's time to get a feel for overall percentage of time per gameloop in a funciton.
<br/>
<br/>
For DS, you can use the hardware timers if they are available.  They have a very high precision.  Next up would be the VCOUNT register with a decent resolution.  Keep in mind that profiling of this sort is instrusive and will slow down your game and can skew your profile results if you aren't careful to omit profile overhead from your results.  It also burns some RAM for use in storing the various hueristics.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#176059 - sverx - Tue Mar 29, 2011 1:07 pm</h4>
    <div class="postbody"><span class="postbody">Thank you :)</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
