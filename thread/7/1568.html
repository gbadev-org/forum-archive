<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>thumb compilation - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>C/C++ > thumb compilation</h2>
<div id="posts">
<div class="post">
    <h4>#8010 - johnny_north - Mon Jun 30, 2003 6:35 pm</h4>
    <div class="postbody"><span class="postbody">I?ve been having difficulties compiling my code thumb mode. I?ve developed a sizable project and it compiles and runs fine in arm using DevKit R4 and C++. When I began to compile in thumb, I was getting errors that I suspected were related to C++, but now I not so sure. After ripping up my make file and separating the rules to compile each C++ file separately, I began to notice several distinct errors. 
<br/>
<br/>
First, code in .cpp files compiles fine except when a member function calls another member function of the same class. In these cases I can force the compiler to accept the code and compile in thumb only if I add ?inline? to the function definition. Of course, I don?t always want this to happen, and most of the time I would rather the code branch to, rather that inline the called function. Anyone have an idea about this?
<br/>
<br/>
Second, some inline assembly code calling the swi lz77 decompression is causing an error: ?invalid swi instruction?. The swi compiles fine in arm though.
<br/>
<br/>
Third, it appears that files that have mixed C/C++ (i.e. files with mixed class scoped and file scoped functions) also produce errors, although I haven?t thoroughly explored this problem yet.	 
<br/>
<br/>
I?m using the following cpp flags:
<br/>
CFLAGS  = -I $(INCDIR2) -I $(INCDIR) -I $(PRJDIR) -mthumb-interwork ?mthumb -mlong-calls -c -g -Wall -fverbose-asm
<br/>
<br/>
Any suggestions would be appreciated.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#8016 - tepples - Mon Jun 30, 2003 8:03 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>johnny_north wrote:</b></span></td> </tr> <tr> <td class="quote">First, code in .cpp files compiles fine except when a member function calls another member function of the same class. In these cases I can force the compiler to accept the code and compile in thumb only if I add ?inline? to the function definition. Of course, I don?t always want this to happen, and most of the time I would rather the code branch to, rather that inline the called function. Anyone have an idea about this?</td> </tr></table><span class="postbody">
<br/>
I can't really help you unless you paste the full text of the error messages.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Second, some inline assembly code calling the swi lz77 decompression is causing an error: ?invalid swi instruction?. The swi compiles fine in arm though.</td> </tr></table><span class="postbody">
<br/>
ARM: swi 0xnn0000
<br/>
Thumb: swi 0xnn<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#8039 - johnny_north - Tue Jul 01, 2003 4:21 am</h4>
    <div class="postbody"><span class="postbody">The following error is fixed when I add "inline" to void InitBGs(). The same error happens when any function call another function from the same class.
<br/>
<br/>
background.cpp: In member function `void Background::StoryStart()':
<br/>
background.cpp:420: Unrecognizable insn:
<br/>
(call_insn 205 204 206 (parallel[ 
<br/>
            (call (mem:SI (symbol_ref:SI ("^_ZN10Background7InitBGsEh")) 0)
<br/>
                (const_int 0 [0x0]))
<br/>
            (use (const_int 1 [0x1]))
<br/>
            (clobber (reg:SI 14 lr))
<br/>
        ] ) -1 (nil)
<br/>
    (expr_list:REG_DEAD (reg:SI 0 r0)
<br/>
        (expr_list:REG_DEAD (reg:SI 1 r1)
<br/>
            (expr_list:REG_UNUSED (reg:SI 14 lr)
<br/>
                (nil))))
<br/>
    (expr_list (use (reg:SI 1 r1))
<br/>
        (expr_list (use (reg:SI 0 r0))
<br/>
            (nil))))
<br/>
background.cpp:420: Internal compiler error in extract_insn, at recog.c:2218</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#8041 - johnny_north - Tue Jul 01, 2003 4:40 am</h4>
    <div class="postbody"><span class="postbody">Compiling in thumb doesn't seem to work with the interupt table either:
<br/>
<br/>
void (*IntrTable[])() = {
<br/>
	vbl, // v-blank
<br/>
	0, // h-blank
<br/>
	0, // vcount
<br/>
	0, // timer0
<br/>
	0,// timer1
<br/>
	timer2, // timer2
<br/>
	0, // timer3
<br/>
	0, // serial
<br/>
	0, // dma0
<br/>
	MP, // dma1
<br/>
	0, // dma2
<br/>
	0, // dma3
<br/>
	0, // key
<br/>
	0  // cart
<br/>
};
<br/>
<br/>
The (main.cpp:12: Unrecognizable insn:) part refers to the only global instance of a class declaration.
<br/>
<br/>
main.cpp: In function `void _GLOBAL__I_IntrTable()':
<br/>
main.cpp:12: Unrecognizable insn:
<br/>
(call_insn 20 19 26 (parallel[ 
<br/>
            (call (mem:SI (symbol_ref:SI ("^^_Z41__static_initialization_and_destruction_0ii")) 0)
<br/>
                (const_int 0 [0x0]))
<br/>
            (use (const_int 1 [0x1]))
<br/>
            (clobber (reg:SI 14 lr))
<br/>
        ] ) -1 (nil)
<br/>
    (expr_list:REG_DEAD (reg:SI 0 r0)
<br/>
        (expr_list:REG_DEAD (reg:SI 1 r1)
<br/>
            (expr_list:REG_UNUSED (reg:SI 14 lr)
<br/>
                (nil))))
<br/>
    (expr_list (use (reg:SI 1 r1))
<br/>
        (expr_list (use (reg:SI 0 r0))
<br/>
            (nil))))
<br/>
main.cpp:12: Internal compiler error in extract_insn, at recog.c:2218</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#8104 - johnny_north - Wed Jul 02, 2003 3:59 am</h4>
    <div class="postbody"><span class="postbody">Ok, it appears that the compiler option -mlong-calls was causing me to add the inline statement.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
