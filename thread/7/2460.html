<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Interrupt not responding... - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>C/C++ > Interrupt not responding...</h2>
<div id="posts">
<div class="post">
    <h4>#13240 - Burre - Tue Dec 09, 2003 6:55 pm</h4>
    <div class="postbody"><span class="postbody">First of all thanks for helping out last time (with the makefile trouble).  Seemed like there was a version conflict between the linkerskripts and not an error within the makefile.
<br/>
<br/>
Now to the question at hand...
<br/>
<br/>
As I mentioned before I'm swapping from HAM to DKA andhave therefor been forced to manually rebuild some wrappers/API that HAM provided.
<br/>
<br/>
Right now I'm trying to get interrupt working.
<br/>
<br/>
I have Jeff's crt0.S, but I've disabled his IRQ-handler to build one my self.
<br/>
<br/>
This is my code:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
/* irqapi.cpp */
<br/>
<br/>
/***************************
<br/>
 * Includes                *
<br/>
 ***************************/
<br/>
#include "irqapi.h"
<br/>
<br/>
/***************************
<br/>
 * Functions               *
<br/>
 ***************************/
<br/>
u32 IntrTable[14]; // Function-table
<br/>
<br/>
/*****************************************************
<br/>
 Function: SetupIRQ()
<br/>
 *****************************************************/
<br/>
void SetupIRQ()
<br/>
{
<br/>
    // Disable interrupts
<br/>
    REG_IME = 0;
<br/>
<br/>
    // Set interrupt proc address (IRQHandler)
<br/>
    REG_INTERUPT = (u32)&amp;HandleIRQ;
<br/>
<br/>
    // Enable interrupts
<br/>
    REG_IME = 1;
<br/>
}
<br/>
<br/>
/*****************************************************
<br/>
 Function: HandleIRQ()
<br/>
 *****************************************************/
<br/>
void HandleIRQ()
<br/>
{
<br/>
   
<br/>
    void (*funcPtr)();
<br/>
<br/>
    // Disable interrupts
<br/>
    REG_IME = 0;
<br/>
<br/>
    if(REG_IF &amp; BIT0) == BIT0)
<br/>
    {
<br/>
        // Call Vblank func
<br/>
        funcPtr = (void(*)())IntrTable[0];
<br/>
        (*funcPtr)();
<br/>
<br/>
        // Reset interrupt (by writing to reg)
<br/>
        REG_IF |= BIT0;
<br/>
    }
<br/>
<br/>
    /* Continuing the same way with all IRQ */
<br/>
<br/>
    }
<br/>
<br/>
    // Enable interrupts
<br/>
    REG_IME = 1;
<br/>
}
<br/>
<br/>
/*****************************************************
<br/>
 Function: StartIntHandler(u16 type, u32* func)
<br/>
 *****************************************************/
<br/>
void StartIntHandler(u16 type, u32* func)
<br/>
{
<br/>
    // Disable interrupts
<br/>
    REG_IME = 0;
<br/>
<br/>
    switch(type)
<br/>
    {
<br/>
     case INT_TYPE_VBL:
<br/>
        // Enable V-Blank IRQ.
<br/>
        M_INTENA_VBL_ENABLE; // Macro, tested and working
<br/>
<br/>
        // Enable Display V-Blank IRQ also.
<br/>
        REG_DISPSTAT |= BIT3;
<br/>
<br/>
        // Set IRQ func
<br/>
        IntrTable[0] = (u32)&amp;func;
<br/>
     break;
<br/>
<br/>
     /* And so fourth for all IRQ */
<br/>
<br/>
     default:
<br/>
     break;
<br/>
    }
<br/>
<br/>
    // Enable interrupts
<br/>
    REG_IME = 1;
<br/>
}
<br/>
<br/>
/*****************************************************
<br/>
 Function: StopIntHandler(u16 type)
<br/>
 *****************************************************/
<br/>
void StopIntHandler(u16 type)
<br/>
{
<br/>
    // Disable interrupts
<br/>
   REG_IME = 0;
<br/>
<br/>
    switch(type)
<br/>
    {
<br/>
     case INT_TYPE_VBL:
<br/>
        M_INTENA_VBL_DISABLE; // Macro, tested and working
<br/>
     break;     default:
<br/>
<br/>
     /* And so fourth for all IRQ */
<br/>
<br/>
     break;
<br/>
    }
<br/>
<br/>
    // Enable interrupts
<br/>
    REG_IME = 1;
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I know that this issue has been adressed before, but I've read all the prevous threads I could find on the forum and the do not contradict my method. Still, it will not work.
<br/>
<br/>
I've also checked the Cowbite spec and followed the instructions within. I've paid extra attention to the "algorithm" described below:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
So, the basic model for setting up interrupts is:
<br/>
<br/>
1. Place the address for your interrupt code at 0x03007FFC.
<br/>
<br/>
2. Turn on the interrupts you wish to use
<br/>
- 0x04000004 (REG_STAT) tells which interrupts the LCD will send
<br/>
- 0x04000200 (REG_IE) masks which interrupts the BIOS will actually
<br/>
service(?) I presume that both of REG_STAT and REG_IE must have the correct
<br/>
bits set for anything to work.
<br/>
- 0x04000208 (REG_IME) Turns all interrupts on or off.
<br/>
<br/>
3. When the interrupt is reached, the code at the address at 0x3007FFC gets
<br/>
loaded into the CPU. To prevent unwanted errors/behavior, the first thing
<br/>
this code should do is disable interrupts.
<br/>
<br/>
4. To determine what interrupt this is, check the flags in 0x04000202
<br/>
(REG_IF). Unset the flag by writing a 1 to that bit.
<br/>
<br/>
5. Once finished with the service routine, reenable interrupts and execute
<br/>
a BX LR (*Not* a SUBS PC, LR #4, which is what the BIOS does). The BIOS
<br/>
will then take over and return your program to where execution left off.
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
In my main-file I have a call to StartIntHandler(INT_TYPE_VBL,(u32*)&amp;start_screen_vbl_func) to set it up for VBL IRQ. 
<br/>
<br/>
I've tested my code both in VBA and stepped it through in Insight (5.1.1) using mixed source mode (ASM and C combo) and it does what I expect it to, except that it never make any calls to HandleIRQ().
<br/>
<br/>
<br/>
Please help.<br/>_________________<br/>"The best optimizer is between your ears..."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#13306 - evil saltine - Wed Dec 10, 2003 10:31 pm</h4>
    <div class="postbody"><span class="postbody">Maybe change
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">REG_INTERUPT = (u32)&amp;HandleIRQ;</td> </tr></table><span class="postbody">
<br/>
to
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">REG_INTERUPT = (u32)HandleIRQ;</td> </tr></table><span class="postbody">
<br/>
<br/>
I'm not sure.. I think just the name of the function gives the address.. I'm probably wrong but I remember that that's how it worked before.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#13307 - sajiimori - Wed Dec 10, 2003 11:09 pm</h4>
    <div class="postbody"><span class="postbody">They're equivalent.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#13345 - Burre - Thu Dec 11, 2003 3:34 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>evil saltine wrote:</b></span></td> </tr> <tr> <td class="quote">Maybe change
<br/>
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">REG_INTERUPT = (u32)&amp;HandleIRQ;</td> </tr></table><span class="postbody">
<br/>
to
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">REG_INTERUPT = (u32)HandleIRQ;</td> </tr></table><span class="postbody">
<br/>
<br/>
I'm not sure.. I think just the name of the function gives the address.. I'm probably wrong but I remember that that's how it worked before.</span></td> </tr></table><span class="postbody">
<br/>
<br/>
It should work. I think I've already checked it in the debugger. It must be something else. Can't figure out what...<br/>_________________<br/>"The best optimizer is between your ears..."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#13354 - tom - Thu Dec 11, 2003 6:41 pm</h4>
    <div class="postbody"><span class="postbody">you're compiling that stuff as arm code, aren't you ?
<br/>
HandleIRQ needs to be an arm function, the other functions can be arm or thumb.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#13386 - Burre - Fri Dec 12, 2003 10:22 am</h4>
    <div class="postbody"><span class="postbody">I've tried to compile all the code as -marm -mthumb-interworking but that didn't help.
<br/>
<br/>
Secondly why does it need to be arm? I know that the interrupt adress is 32bit but HandleIRQs adress should return a 32bit value anyhow, or?<br/>_________________<br/>"The best optimizer is between your ears..."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#13387 - tom - Fri Dec 12, 2003 11:17 am</h4>
    <div class="postbody"><span class="postbody">afaik the bios expects the function whose address is stored in REG_INTERUPT to be an arm function - it doesn't do a modeswitch.
<br/>
<br/>
read more in gbatek.txt (and forget the cowbite specs=).</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
