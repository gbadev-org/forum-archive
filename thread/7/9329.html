<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Setting sprite image without overwriting the rest of attrs - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>C/C++ > Setting sprite image without overwriting the rest of attrs</h2>
<div id="posts">
<div class="post">
    <h4>#80493 - MaxCantor - Sat Apr 22, 2006 9:20 pm</h4>
    <div class="postbody"><span class="postbody">Hey guys.  I'm writing a set_sprite_image() function, and I'm trying to figure out how to code it so that it ONLY sets the size, shape, tile and palette bits in the OAM entry.  I've been working with the TONC library.
<br/>
<br/>
Right now, this code works:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">oe_set_attr( sprite,
<br/>
   shape,
<br/>
   fsize,
<br/>
   OE_A2_16C( palette ) | tile );</td> </tr></table><span class="postbody">
<br/>
<br/>
<br/>
However, that's one of the TONC functions, and it overwrites the entire entry (i.e., setting the image also resets the position).
<br/>
<br/>
I'm using a couple of macros that come with TONC, but things aren't working out.  These are the definitions of the TONC macros:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">// bit field set and get routines
<br/>
#define BF_MSK(_x, _name)        ( ((_x)&lt;&lt;_name##_SHIFT) &amp; _name##_MASK )
<br/>
#define BF_UNMSK(_x, _name)      ( ((_x) &amp; _name##_MASK)&gt;&gt;_name##_SHIFT )
<br/>
#define BF_INS(_dst, _x, _name)  (_dst = ((_dst)&amp;~_name##_MASK) | BF_MSK(_x,_name) )
<br/>
<br/>
// Create bitfield:
<br/>
// attr |= BF_MSK(id, OE_A2_ID);
<br/>
attr2 |= (id&lt;&lt;OE_A2_ID_SHIFT) &amp; OE_A2_ID_MASK;
<br/>
<br/>
// Retrieve bitfield:
<br/>
// id= BF_UNMSK(attr2, OE_A2_ID);
<br/>
id= (attr2 &amp; OE_A2_ID_MASK)&gt;&gt;OE_A2_ID_SHIFT;
<br/>
<br/>
// Insert bitfield:
<br/>
// BF_INS(attr2, id, OE_A2_ID);
<br/>
attr= (attr&amp;~OE_A2_ID_MASK) | ((id&lt;&lt;OE_A2_ID_SHIFT) &amp; OE_A2_ID_MASK);</td> </tr></table><span class="postbody">
<br/>
<br/>
And finally, here's my code that isn't working:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">   sprite-&gt;attr0 |= BF_MSK(shape, OE_A0_SHAPE);
<br/>
   sprite-&gt;attr1 |= BF_MSK(fsize, OE_A1_SIZE);
<br/>
   sprite-&gt;attr2 = OE_A2_BUILD( tile, palette, 0 );</td> </tr></table><span class="postbody">
<br/>
<br/>
I know that the attr2 build macro works because I've used it in my code before, but something just isn't happening with the bitfield mask macros.  I've also tried this:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">   BF_INS( sprite-&gt;attr0, shape, OE_A0_SHAPE );
<br/>
   BF_INS( sprite-&gt;attr1, fsize, OE_A1_SIZE );</td> </tr></table><span class="postbody">
<br/>
<br/>
But it didn't work either.  Any hints...?  Thanks, all!
<br/>
<br/>
<span style="font-weight: bold">EDIT</span>: Nevermind - I e-mailed Cearn (he wrote Tonc) and he figured it out.  The existing BF_ macros expect plain numbers, but my "shape" and "fsize" variables were already bitshifted earlier on in my code.  These macros will work with pre-shifted values:
<br/>
<br/>
#define BF_MSK2(_x, _name)      ( (_x) &amp; _name##_MASK )
<br/>
#define BF_INS2(_y, _x, _name)  (_y = ((_y)&amp;~_name##_MASK) |
<br/>
BF_MSK2(_x,_name) )</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
