<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>delete vs. delete[]? - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>C/C++ > delete vs. delete[]?</h2>
<div id="posts">
<div class="post">
    <h4>#156686 - tepples - Mon May 12, 2008 8:24 pm</h4>
    <div class="postbody"><span class="postbody">There is a difference between <span style="font-weight: bold">delete</span> and <span style="font-weight: bold">delete[]</span> because there is a difference between <span style="font-weight: bold">new T</span> and <span style="font-weight: bold">new T[count]</span>: the C++ language support library needs to know how many destructors to call. But why is there a difference between <span style="font-weight: bold">new T</span> and <span style="font-weight: bold">new T[1]</span>?<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#156696 - Bania - Mon May 12, 2008 9:17 pm</h4>
    <div class="postbody"><span class="postbody">This is array, but only one with one element. I don't know how it looks in memory (difference between array and normal var). That operator new[count] is overloaded for array and there is nonsens if you wanna to make a array with one element.<br/>_________________<br/>Sorry for my level of English :)</span><span class="gensmall"><br/><br/>Last edited by Bania on Fri Jun 13, 2008 2:46 pm; edited 2 times in total</span></div>    
</div>
<div class="post">
    <h4>#156697 - keldon - Mon May 12, 2008 9:25 pm</h4>
    <div class="postbody"><span class="postbody">Well technically it's still an array by design; just consider the following (and passing 1)...
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">My_Class* create_array ( int size )
<br/>
{
<br/>
   return new My_Class[size];
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
... so although the object occupies the same user memory as a pointer that is [just] allocating a <span style="font-weight: bold">new My_Class</span>, the memory manager should not handle it like a <span style="font-weight: bold">new My_Class</span> as your design expects arrays.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#156699 - kusma - Mon May 12, 2008 10:07 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tepples wrote:</b></span></td> </tr> <tr> <td class="quote">the C++ language support library needs to know how many destructors to call.</td> </tr></table><span class="postbody">
<br/>
But how does it know that? "delete[] array;" doesn't include any info on the allocation itself - so I guess the an extra integer must be allocated at the beginning of the array, storing the size of the array. Or something of that sort, perhaps? Just a loose theory, though.
<br/>
<br/>
edit: ...and it seems that <a class="postlink" href="http://www.parashift.com/c++-faq-lite/freestore-mgmt.html#faq-16.14" target="_blank">the c++ faq lite agrees with me</a>.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#156721 - silent_code - Tue May 13, 2008 9:16 am</h4>
    <div class="postbody"><span class="postbody">i guess some sort of heap header structure would store the size. ;^)<br/>_________________<br/><span style="font-size: 9px; line-height: normal"><span style="text-decoration: underline"><span style="font-weight: bold"></span></span> July 5th 08: "<span style="font-weight: bold">Volumetric Shadow Demo</span>" 1.6.0 (final) source released
<br/>
June 5th 08: "<span style="font-weight: bold">Zombie NDS</span>" WIP released!
<br/>
It's all on my page, just click <span style="font-weight: bold">WWW</span> below.</span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#156729 - simonjhall - Tue May 13, 2008 12:25 pm</h4>
    <div class="postbody"><span class="postbody">Alright, similar problem to this delete/delete[] thing.
<br/>
I've got this memory allocator that is basically used like this:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">MyClass *xyz = new(my_allocator(10 * sizeof(MyClass))) MyClass[10];</td> </tr></table><span class="postbody">
<br/>
<br/>
This works hunky-dorey on GCC. The problem is with Visual C++ (2005).
<br/>
<br/>
Let's say my_allocator returns a pointer to 0x1000 and the size of my class is sixteen bytes, ie I've asked to allocate 160 bytes. This means that the pointer returned will be valid from 0x1000 to 0x10a0.
<br/>
<br/>
However when I use VC, the address that gets assigned to xyz is 0x1004. The lower four bytes contain the number of elements I've allocated.
<br/>
<br/>
When it comes to deleting the data I would do this:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">for (int count = 0; count &lt; 10; count+)
<br/>
   xyz-&gt;~MyClass();
<br/>
my_deallocator(xyz);</td> </tr></table><span class="postbody">
<br/>
<br/>
Again, this works fine with GCC.
<br/>
But with VC xyz points to a piece of data within the buffer I've allocated, so I end up freeing 0x1004 rather than 0x1000. To top it off, if I access the last element in the array (element 9) I'll be reading/writing into memory that I don't own.
<br/>
<br/>
What am I doing wrong? What should I be doing? I'm not mega-cool with C++ as I'm a C programmer instead. Go easy.<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#156738 - silent_code - Tue May 13, 2008 2:12 pm</h4>
    <div class="postbody"><span class="postbody">@ simon:
<br/>
<br/>
i haven't seen such an "allocation scheme" (i really mean the way you use these elements), but then, what *have* i seen so far?
<br/>
that is indeed something interesting. maybe investigating some ASM output from the compiler would help? i have no idea.
<br/>
this would be one of those cases, that i wish i had metter debugging tools at hand. :^C
<br/>
good luck finding out what makes the allocation drift. ;^)<br/>_________________<br/><span style="font-size: 9px; line-height: normal"><span style="text-decoration: underline"><span style="font-weight: bold"></span></span> July 5th 08: "<span style="font-weight: bold">Volumetric Shadow Demo</span>" 1.6.0 (final) source released
<br/>
June 5th 08: "<span style="font-weight: bold">Zombie NDS</span>" WIP released!
<br/>
It's all on my page, just click <span style="font-weight: bold">WWW</span> below.</span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#156741 - sniper - Tue May 13, 2008 3:15 pm</h4>
    <div class="postbody"><span class="postbody">delete[] xyz is only an information that an array was allocated e.g. new xyz[..].
<br/>
<br/>
Most newer C++ compilers doesn't need this info anymore. 
<br/>
so delete xyz  and delete [] xyz has the same result.
<br/>
<br/>
Also you do not need to add the number of allocated elements like delete [10] xyz &lt;- this is wrong.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#156756 - elyk1212 - Tue May 13, 2008 7:29 pm</h4>
    <div class="postbody"><span class="postbody">Kusma, Have you checked out C++ FAQ Lite?  It is one of the best free resources for C++.
<br/>
<br/>
This FAQ referrers to your follow up question *almost* directly:
<br/>
<a href="http://www.parashift.com/c++-faq-lite/freestore-mgmt.html#faq-16.14" target="_blank">http://www.parashift.com/c++-faq-lite/freestore-mgmt.html#faq-16.14</a>
<br/>
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
Most newer C++ compilers doesn't need this info anymore. 
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I would still say it's a pretty good idea to use though (delete []).  This will help with object deconstruction in the case of an array of objects created on the heap.  But anyhow, check out the C++ FAQ for more details.    Really handy! :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#156757 - sajiimori - Tue May 13, 2008 7:41 pm</h4>
    <div class="postbody"><span class="postbody">simonjhall,
<br/>
<br/>
In general, you shouldn't implement any versions of 'new' that require additional information to be provided when 'delete' is called: all 'delete' should have to know is the pointer and whether it's an array.
<br/>
<br/>
With that restriction in mind, you'll probably want to wrap the array of MyClass in an object that knows how it was allocated:</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">template&lt;class T, int kSize, class Allocator&gt;
<br/>
class Wrapper
<br/>
{
<br/>
  // implement 'new' and 'delete' here, in terms of Allocator.
<br/>
<br/>
  MyClass array[kSize];
<br/>
};
<br/>
</td> </tr></table><span class="postbody">If you need kSize to be a variable, you'll have to store the size as a data member and allocate a variable sized struct.
<br/>
<br/>
sniper, where did you hear that delete[] is no longer necessary?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#156792 - sniper - Tue May 13, 2008 11:45 pm</h4>
    <div class="postbody"><span class="postbody">sajiimori yes you are right.
<br/>
If you use delete instead of delete[] only the first destructor is called. So you should use delete [].
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#include &lt;iostream&gt;
<br/>
using namespace std;
<br/>
<br/>
class x
<br/>
{
<br/>
    static int count;
<br/>
public:
<br/>
    x()
<br/>
    {
<br/>
        cout&lt;&lt;"constructor"&lt;&lt;count++&lt;&lt;endl;
<br/>
    }
<br/>
<br/>
    ~x()
<br/>
    {
<br/>
        cout&lt;&lt;"destructor"&lt;&lt;--count&lt;&lt;endl;
<br/>
    }
<br/>
};
<br/>
<br/>
int x::count = 0;
<br/>
<br/>
<br/>
int main()
<br/>
{
<br/>
    x *y;
<br/>
    cout&lt;&lt;"delete[]:"&lt;&lt;endl;
<br/>
    y = new x[3];
<br/>
    delete [] y;
<br/>
<br/>
    cout&lt;&lt;"\ndelete:"&lt;&lt;endl;
<br/>
    y = new x[3];
<br/>
    delete y;
<br/>
<br/>
    return 0;
<br/>
}</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#156805 - tepples - Wed May 14, 2008 12:53 am</h4>
    <div class="postbody"><span class="postbody">In the ideal situation that I imagine, <span style="font-weight: bold">new T</span> would have been an alias for <span style="font-weight: bold">new T[1]</span>, storing 1 in the allocation's header. Then <span style="font-weight: bold">delete dave</span> could be made an alias for <span style="font-weight: bold">delete[] dave</span>. But then that <a class="postlink" href="http://everything2.com/e2node/Because%2520that%2520would%2520make%2520sense" target="_blank">would have made sense</a>.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#156830 - pepsiman - Wed May 14, 2008 1:34 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tepples wrote:</b></span></td> </tr> <tr> <td class="quote">In the ideal situation that I imagine, <span style="font-weight: bold">new T</span> would have been an alias for <span style="font-weight: bold">new T[1]</span>, storing 1 in the allocation's header.</td> </tr></table><span class="postbody">
<br/>
You cannot pass arguments to the constructor with <span style="font-weight: bold">new T[1]</span>.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#156836 - PeterM - Wed May 14, 2008 4:56 pm</h4>
    <div class="postbody"><span class="postbody">Simon,
<br/>
<br/>
We had a similar problem with our allocation stuff in work. Unfortunately I can't remember the details of how we fixed it.
<br/>
<br/>
Custom array news/deletes are a real pain.
<br/>
<br/>
Give me a shout if you still need help and I'll see what I can dig up.
<br/>
<br/>
Pete<br/>_________________<br/><a href="http://aaiiee.wordpress.com/" target="_blank">http://aaiiee.wordpress.com/</a></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
