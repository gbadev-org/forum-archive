<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>memory management or what? - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>C/C++ > memory management or what?</h2>
<div id="posts">
<div class="post">
    <h4>#12906 - maximAL - Sun Nov 30, 2003 2:51 pm</h4>
    <div class="postbody"><span class="postbody">one thing that puzzles me is the (non existent?) memory management of the GBA. i mean, what actually happens when i "new" an object? where is the memory allocated? and more important: what happens, when i delete the object? is the memory really available again? and what about memory fragmentation?
<br/>
i read several times, that you'd have to right your one memory manager for that so i'm wondering what happens when you don't ?!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#12908 - NoMis - Sun Nov 30, 2003 3:10 pm</h4>
    <div class="postbody"><span class="postbody">i just began with that stuff so i can't be sure that i'm right or not. If i use g++ the new and delete functions seems to work properly. if you use gcc i think you need to include the appropriate C libraries and initialize the heap, so the new and delete functions know where and how much memory they can allocate. if you use C instead of C++ use malloc. i know an article on the internet wich explains how to initialize the functions but the link is broken. But i downloaded the html file once so if you send me your email address i can send you this thing.
<br/>
<br/>
NoMis</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#12909 - NoMis - Sun Nov 30, 2003 3:18 pm</h4>
    <div class="postbody"><span class="postbody">and here is an intressting articel at gamasutra about memory and ressource managemend on the GBA.
<br/>
<br/>
<a href="http://www.gamasutra.com/features/20010509/baptista_01.htm" target="_blank">http://www.gamasutra.com/features/20010509/baptista_01.htm</a>
<br/>
<br/>
NoMis</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#12912 - ampz - Sun Nov 30, 2003 4:04 pm</h4>
    <div class="postbody"><span class="postbody">I recommend you use alloca whenever possible.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#12913 - maximAL - Sun Nov 30, 2003 4:08 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>NoMis wrote:</b></span></td> </tr> <tr> <td class="quote">and here is an intressting articel at gamasutra about memory and ressource managemend on the GBA.
<br/>
<br/>
<a href="http://www.gamasutra.com/features/20010509/baptista_01.htm" target="_blank">http://www.gamasutra.com/features/20010509/baptista_01.htm</a>
<br/>
<br/>
NoMis</td> </tr></table><span class="postbody">
<br/>
<br/>
i think i allready read this article and as far as i can see it says that you have to implement your own memory manager...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#12919 - sajiimori - Sun Nov 30, 2003 7:01 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
memory management of the GBA
<br/>
</td> </tr></table><span class="postbody">
<br/>
Memory management is not the responsibility of the GBA.  It's the responsibility of the C library and the application.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
what actually happens when i "new" an object? where is the memory allocated?
<br/>
</td> </tr></table><span class="postbody">
<br/>
Normally, IWRAM is allocated using malloc.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
what happens, when i delete the object? is the memory really available again?
<br/>
</td> </tr></table><span class="postbody">
<br/>
Yup.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
and what about memory fragmentation?
<br/>
</td> </tr></table><span class="postbody">
<br/>
Malloc will "try" to find the best fit for new allocations, but fragmentation can happen anyway.  Sometimes you can reduce it greatly by allocating things in the right order.  Figure out what will generally be freed first, and allocate those things last.  If you use that scheme without fail, the heap will be a bit more like a stack (last in, first out).
<br/>
<br/>
Write your own allocator if you're dissatisfied with the results you get from using the standard one.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#12923 - tom - Sun Nov 30, 2003 10:31 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>sajiimori wrote:</b></span></td> </tr> <tr> <td class="quote">If you use that scheme without fail, the heap will be a bit more like a stack (last in, first out).</td> </tr></table><span class="postbody">
<br/>
<br/>
if you do this you can aswell write your own stack based memory manager. you can also implement kind of "save-points" that allow you to restore the heap to a certain state (that is, all memory allocated after that point is freed).</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#12926 - ampz - Mon Dec 01, 2003 1:13 pm</h4>
    <div class="postbody"><span class="postbody">... Or you can use the already available stack allocator alloca..</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#12931 - Burton Radons - Mon Dec 01, 2003 3:32 pm</h4>
    <div class="postbody"><span class="postbody">malloc allocates from EWRAM, not IWRAM, at least with DevKit Advance.  The same recommendations as always apply; try to avoid many little allocations, make your program memory usage as stable and predictable as possible to avoid in-the-field crashing, and check the return value.
<br/>
<br/>
The stack is in IWRAM and grows from the end of it to the beginning.  So, if you use too much of it and have too much permanent IWRAM usage, you'll overwrite the permanent IWRAM or even start writing into EWRAM.  Here's a macro to sanity check it:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#define CheckStackUsage() \
<br/>
    do { \
<br/>
        extern char __bss_end; /* End of the IWRAM load area. */ \
<br/>
        char end [0]; /* Stack end pointer. */ \
<br/>
        \
<br/>
        Assert (end &gt;= &amp;__bss_end, "Stack overrun."); \
<br/>
    } while (0)
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I would recommend putting that in all large-stack-usage functions for debug builds, just to be safe.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#12936 - sajiimori - Mon Dec 01, 2003 7:57 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
malloc allocates from EWRAM, not IWRAM
<br/>
</td> </tr></table><span class="postbody">
<br/>
D'oh...I've been staying up too late.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#13008 - ampz - Wed Dec 03, 2003 2:16 pm</h4>
    <div class="postbody"><span class="postbody">"malloc allocates from EWRAM, not IWRAM"
<br/>
<br/>
Uh, malloc allocates memory where you tell it to allocate memory. It's all in the linker script. The same goes for the stack.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#13025 - Touchstone - Wed Dec 03, 2003 10:25 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>ampz wrote:</b></span></td> </tr> <tr> <td class="quote">"malloc allocates from EWRAM, not IWRAM"
<br/>
<br/>
Uh, malloc allocates memory where you tell it to allocate memory. It's all in the linker script. The same goes for the stack.</td> </tr></table><span class="postbody">
<br/>
I'm sure the original post meant that malloc allocates from EWRAM <span style="font-style: italic">by default</span> in DevKit Advance.<br/>_________________<br/>You can't beat our meat</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#13029 - sajiimori - Wed Dec 03, 2003 11:17 pm</h4>
    <div class="postbody"><span class="postbody">Yeah, that's why he said "at least with DevKit Advance", because DevKit Advance provides a customized linkscript.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#20824 - hzx - Tue May 18, 2004 1:34 pm</h4>
    <div class="postbody"><span class="postbody">Is it possible to use a C compiler (namely, DevKitAdvance) with the builtin memory management functions turned off? What I need is the pure compilation of my code (including my own memory management functions) into a raw binary, with the starting point at 0x0800000, just like Goldroad produces it.<br/>_________________<br/>.hzx</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#20835 - Lupin - Tue May 18, 2004 3:49 pm</h4>
    <div class="postbody"><span class="postbody">You can "turn them off" by not using them - it works :)<br/>_________________<br/><a class="postlink" href="http://pokeme.shizzle.it/" target="_blank">Team Pokeme</a>
<br/>
<a class="postlink" href="http://lupin.shizzle.it/" target="_blank">My blog and PM ASM tutorials</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#20837 - hzx - Tue May 18, 2004 5:00 pm</h4>
    <div class="postbody"><span class="postbody">No, no, you got me wrong. I mean I would like to have a compiler without any pre-run memory management, like code relocation, RAM fillup, etc.  (crt0.S stuff).  I would like to have a pure binary instead of an elf executable (just like the Goldroad assembler produces), as the result.<br/>_________________<br/>.hzx</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#20845 - Miked0801 - Tue May 18, 2004 6:31 pm</h4>
    <div class="postbody"><span class="postbody">Huh?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#20849 - sajiimori - Tue May 18, 2004 6:35 pm</h4>
    <div class="postbody"><span class="postbody">Most of the tutorials tell you how to change an .elf to a raw binary:
<br/>
<br/>
objcopy -O binary game.elf game.gba
<br/>
<br/>
If you don't want crt0.o, then don't link it in.  The gcc and g++ front ends link it in automatically, so use ld directly.  Note that you'll have to replace some of its functionality.  You might want to start with the complete crt0.S and remove the parts you don't want.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
