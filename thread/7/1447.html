<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>prob: faulty blit/drawing func's in mode 4 - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>C/C++ > prob: faulty blit/drawing func's in mode 4</h2>
<div id="posts">
<div class="post">
    <h4>#7283 - Vector - Fri Jun 13, 2003 7:04 pm</h4>
    <div class="postbody"><span class="postbody">Hey all, 
<br/>
<br/>
maybe i just missed something really stupid but i have a question. i have C code that compiles for devkitadv and runs when i use literals in the functions, but when i added a "bitmap" structure, and pass it by pointer to the functions, i don't get anything on screen.
<br/>
<br/>
here is the structure:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
typedef struct {
<br/>
  (u16*) bmp;
<br/>
  int w;
<br/>
  int h;
<br/>
} bitmap;
<br/>
</td> </tr></table><span class="postbody">
<br/>
i used malloc() to get memory for the bmp, but the problem lies elsewhere because it even breaks when i just set the bmp ptr to video memory.
<br/>
<br/>
i modified putpixel() from
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
void putpixel(int x, y, u16 color)
<br/>
{
<br/>
  videobuffer[y*120 + x] = color;
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
to:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
void putpixel(bitmap* bmp, int x, y, u16 color)
<br/>
{
<br/>
  bmp-&gt;bmp[bmp-&gt;w*y + x] = color;
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
now when I do:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
bitmap* videobuffer;
<br/>
videobuffer-&gt;bmp = (16*)0x6000000;
<br/>
videobuffer-&gt;w = 120;   // mode 4, so write 2 pixels at once :-(
<br/>
videobuffer-&gt;h = 160;
<br/>
putpixel(videobuffer, 10, 10,  0xf0f);
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
the bitmap implementation was the only thing i changed. mode 4 is already set up, with the palette loaded (vba shows the palette loaded in memory, but still only a blank screen.
<br/>
<br/>
anyone know whats wrong?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#7285 - niltsair - Fri Jun 13, 2003 7:59 pm</h4>
    <div class="postbody"><span class="postbody">You're most probably busting the available IWRAM (32k).
<br/>
<br/>
If you really need to use an array this big(37.5k), put it in EWRAM(256k) or like it was discussed elsewhere, possibly in sprite tile memory (better access speed) haven't tested it but should work.
<br/>
<br/>
And about your function it's so simple that you should use a #define instead, to save on function calling overhead (which mean speed gain).
<br/>
<br/>
#define putpixel(bitmap* bmp, int x, y, u16 color)  bmp-&gt;bmp[bmp-&gt;w*y + x] = color;</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#7292 - Cyberman - Sat Jun 14, 2003 2:56 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
bitmap* videobuffer; 
<br/>
videobuffer-&gt;bmp = (16*)0x6000000; 
<br/>
videobuffer-&gt;w = 120;   // mode 4, so write 2 pixels at once :-( 
<br/>
videobuffer-&gt;h = 160; 
<br/>
putpixel(videobuffer, 10, 10,  0xf0f);
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Umm... 
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">videobuffer-&gt;bmp = (u16 *) 0x06000000;</td> </tr></table><span class="postbody">
<br/>
<br/>
The compilor might be thinking you are doing this with your code.
<br/>
<br/>
16 * 0x06000000 is the same thing as assigning
<br/>
0x60000000; You are addressing way out of the GBA's memory range. :)
<br/>
<br/>
Other small details, in Mode four your pixels are byte sized.. your put method will not work properly or the way you will think they will.  You can access this in a per byte mode or word or long but 1 pixel = 1 byte.. you can access IRAM and WRAM as this, and for 8 bits per pixel mode you really shouldn't access it any other way.  unless you are drawing a line or something (even then because of endianess one should take that into account).'
<br/>
<br/>
<br/>
Cyb</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#7381 - Vector - Mon Jun 16, 2003 5:15 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>niltsair wrote:</b></span></td> </tr> <tr> <td class="quote">You're most probably busting the available IWRAM....If you really need an array this big(37.5k)</td> </tr></table><span class="postbody">
<br/>
There is no array! videobuffer, as declared later, was simply a pointer to 0x6000000. Perhaps my choice to use dovoto's variable name instead of "videoptr" was misleading. Sorry :-)
<br/>
But thanks for the idea about using a #define for putpixel(), thats inline, so it replaces function calls with the actual code right?
<br/>
<br/>
Cyb, I don't understand. doesn't </span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code"> (u16*) 0x6000000</td> </tr></table><span class="postbody"> evaluate to "u16 pointer to memory address 0x6000000" which is the same as "unsigned short int pointer to 0x6000000" ? So if the compiler replaces u16 with unsigned short int, it can't interpret (u16*) 0x6000000 as "16 * 0x6000000" right?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#7388 - niltsair - Mon Jun 16, 2003 8:12 pm</h4>
    <div class="postbody"><span class="postbody">[quote="Vector"]</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>niltsair wrote:</b></span></td> </tr> <tr> <td class="quote">You're most probably busting the available IWRAM....If you really need an array this big(37.5k)</td> </tr></table><span class="postbody">
<br/>
There is no array! videobuffer, as declared later, was simply a pointer to 0x6000000. Perhaps my choice to use dovoto's variable name instead of "videoptr" was misleading. Sorry :-)
<br/>
But thanks for the idea about using a #define for putpixel(), thats inline, so it replaces function calls with the actual code right?[/code]
<br/>
It works like macro. It'll replace the macro call with the actual code like you said.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Cyb, I don't understand. doesn't <table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code"> (u16*) 0x6000000</td> </tr></table><span class="postbody"> evaluate to "u16 pointer to memory address 0x6000000" which is the same as "unsigned short int pointer to 0x6000000" ? So if the compiler replaces u16 with unsigned short int, it can't interpret (u16*) 0x6000000 as "16 * 0x6000000" right?</span></td> </tr></table><span class="postbody">
<br/>
<br/>
Yes, but in your code you wrote (16*) instead of (u16*)</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
