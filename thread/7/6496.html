<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Function Data Passing, Sprite Image Errors... pointers. - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>C/C++ > Function Data Passing, Sprite Image Errors... pointers.</h2>
<div id="posts">
<div class="post">
    <h4>#50034 - justinGBA - Thu Aug 04, 2005 6:39 pm</h4>
    <div class="postbody"><span class="postbody">I'm haveing some trouble with setting up a sprite class, the problem lies in what i believe is the passing of the array of data.  Without the information being classed up it all works fine, so if anyone can take at look at this code, and maybe point out what im doing wrong...
<br/>
<br/>
Here are some of my defines i use...
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
//define object attribute memory state address 
<br/>
#define SpriteMem ((unsigned short*)0x7000000) 
<br/>
//define object attribute memory image address 
<br/>
#define SpriteData ((unsigned short*)0x6010000)
<br/>
//define object attribute memory palette address 
<br/>
#define SpritePaletteMemoryPointer ((unsigned short*)0x5000200) 
<br/>
<br/>
#define OBJ_MAP_2D 0x0 
<br/>
#define OBJ_MAP_1D 0x40 
<br/>
#define OBJ_ENABLE 0x1000 
<br/>
//attribute0 stuff 
<br/>
#define ROTATION_FLAG        0x100 
<br/>
#define SIZE_DOUBLE        0x200 
<br/>
#define MODE_NORMAL         0x0 
<br/>
#define MODE_TRANSPARENT    0x400 
<br/>
#define MODE_WINDOWED        0x800 
<br/>
#define MOSAIC            0x1000 
<br/>
#define COLOR_16            0x0000 
<br/>
#define COLOR_256            0x2000 
<br/>
#define SQUARE              0x0 
<br/>
#define TALL                0x4000 
<br/>
#define WIDE                0x8000 
<br/>
//attribute1 stuff 
<br/>
#define ROTDATA(n)        ((n) &lt;&lt; 9) 
<br/>
#define HORIZONTAL_FLIP    0x1000 
<br/>
#define VERTICAL_FLIP        0x2000 
<br/>
#define SIZE_8              0x0 
<br/>
#define SIZE_16             0x4000
<br/>
#define SIZE_32             0x8000 
<br/>
#define SIZE_64             0xC000 
<br/>
//Attribute2 stuff 
<br/>
#define PRIORITY(n)        ((n) &lt;&lt; 10) 
<br/>
#define PALETTE(n)        ((n) &lt;&lt; 12) 
<br/>
<br/>
typedef struct tagSprite 
<br/>
{ 
<br/>
    unsigned short attribute0; 
<br/>
    unsigned short attribute1; 
<br/>
    unsigned short attribute2; 
<br/>
    unsigned short attribute3;
<br/>
   }Sprite,*pSprite; 
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
here is the working block of code...
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
//format of data...
<br/>
//const unsigned short airplaneData[] ={ ... }
<br/>
<br/>
DMAFastCopy((void*)airplanePalette, (void*)SpritePaletteMemoryPointer, 
<br/>
            256, DMA_16NOW);
<br/>
<br/>
//copy the tiles into sprite tile mem
<br/>
DMAFastCopy((void*)airplaneData, (void*)SpriteData, sizeof(airplaneData), DMA_32NOW);
<br/>
   
<br/>
   Sprite mySprite;
<br/>
   int sY = 126;
<br/>
   int sX = 240 / 2 - 16;
<br/>
   int sVelX = 1;
<br/>
   int anim = 0;
<br/>
   mySprite.attribute2 = anim*32;               //tileIndex
<br/>
   mySprite.attribute0 = COLOR_256 | sY;      //color mode, y pos
<br/>
   mySprite.attribute1 = SIZE_32 | sX;         //spriteSize, x pos
<br/>
<br/>
DMAFastCopy((void*)&amp;mySprite, (void*)SpriteMem, sizeof(mySprite), DMA_32NOW);
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
So that chunk of code works fine, no issues at all.  So i know my DMAFastCopy function works.  So here is the sprite class code that doesnt.
<br/>
<br/>
Sprite Header...
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#ifndef GBASPRITE_H
<br/>
#define GBASPRITE_H
<br/>
<br/>
#include "gba.h"
<br/>
<br/>
class gbaSprite  {
<br/>
   public:
<br/>
      gbaSprite(const unsigned short spriteTiles[], int width, int height, int totalFrames);
<br/>
      ~gbaSprite();
<br/>
      
<br/>
      void Activate();
<br/>
      void UpdateOAM();
<br/>
      
<br/>
      void LoadAnimationStates(char* statename, unsigned short startFrame, unsigned short endFrame);
<br/>
      void SetAnimationLoop(unsigned short startFrame, unsigned short endframe);
<br/>
      void SetAnimationLoop(char* stateName);
<br/>
      void SetFrame(unsigned short);
<br/>
      unsigned short GetFrame();
<br/>
      
<br/>
      int posX;
<br/>
      int posY;
<br/>
      int velX;
<br/>
      int velY;
<br/>
      
<br/>
   private:
<br/>
      Sprite sprite;
<br/>
      int currentFrame;
<br/>
      int totalFrames;
<br/>
      int indexOffset;
<br/>
};
<br/>
<br/>
#endif
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Sprite Cpp...
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#include "gbaSprite.h"
<br/>
<br/>
gbaSprite::gbaSprite(const unsigned short spriteTiles[], int width, int height, int Frames)  {
<br/>
   posX = 200;
<br/>
   posY = 126;
<br/>
   velX = 0;
<br/>
   velY = 0;
<br/>
   currentFrame = 0;
<br/>
   totalFrames = Frames;
<br/>
   indexOffset = height;
<br/>
   
<br/>
   sprite.attribute2 = 0*32;               //tileIndex
<br/>
   sprite.attribute0 = COLOR_256 | posY;      //color mode, y pos
<br/>
   //if( width == 8 &amp;&amp; height == 8)
<br/>
   //   sprite.attribute1 = SIZE_8 | posX;         //spriteSize, x pos
<br/>
   //if( width == 16 &amp;&amp; height == 16)
<br/>
   //   sprite.attribute1 = SIZE_16 | posX;         //spriteSize, x pos
<br/>
   //if( width == 32 &amp;&amp; height == 32)
<br/>
      sprite.attribute1 = SIZE_32 | posX;         //spriteSize, x pos
<br/>
   
<br/>
   DMAFastCopy((void*)spriteTiles, (void*)SpriteData, sizeof(spriteTiles), DMA_32NOW);
<br/>
   
<br/>
   DMAFastCopy((void*)&amp;sprite, (void*)SpriteMem, sizeof(sprite), DMA_32NOW);
<br/>
}
<br/>
<br/>
<br/>
void gbaSprite::UpdateOAM()  {
<br/>
   //Updates the OAM data from our private sprite memory
<br/>
   DMAFastCopy((void*)&amp;sprite, (void*)SpriteMem, sizeof(sprite), DMA_32NOW);
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
<br/>
Guess:
<br/>
It appears of if it is copying data over, but for some reason it seams to copy in data missing a chunk of the sprite...  Just guessing...  The first method displays the airplane fine, colorkeyed and all.  The class, displays the arplane with the bottom half f the tale on the top half of the sprite rect, and the top half of the plane on the bottom half of the sprite rect. However it is colorkeyed properly.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#50094 - Cearn - Fri Aug 05, 2005 9:11 am</h4>
    <div class="postbody"><span class="postbody">sizeof()
<br/>
<br/>
sizeof() is an operator that is resolved at compile time and should be thought of as a way of getting the number of bytes a variable<span style="font-weight: bold">type</span> uses, not the actual variable. That's the size in <span style="font-weight: bold">bytes</span> and the size of the <span style="font-weight: bold">type</span>.
<br/>
<br/>
sizeof(sprite) will probably give a value of 8: 4x u16 attributes. I think it'll give something larger if you ever plan on using virtual functions, but maybe wrong there. sizeof(spriteTiles) will give you the size of spriteTiles, which is actually a <span style="font-weight: bold">pointer</span>, so it will give the size of a pointer which is 4. I.e., not the size of the whole array. sizeof() and arrays have a funny relationship: if you pass the array-name directly, it'll give the size of the array (but <span style="font-style: italic">only</span> if it can actually see it at compile time); the array-declaration works as a sort of type declaration then. In all other cases, you'll end up with the size of the pointer, which is generally useless. There are a number of threads on the use of sizeof() around, feel free to check them out too.
<br/>
<br/>
Also, remember that the count in DMA is the number of transfers, not the number of bytes if you do use sizeof(), divide by four somewhere. If you want to copy variables, you can also use the assignment operator ('='), rather than a function. That's what it's there for after all. And there's no need to cast to (void*); everything casts to that implicitly.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#50132 - justinGBA - Fri Aug 05, 2005 7:25 pm</h4>
    <div class="postbody"><span class="postbody">Cool. It works, now. i never would of guessed that the sizeof() was a problem.  I just pass the size to the sprite class now.
<br/>
<br/>
But that leaves me with one more question... if i know that the current sprite tile is 1536 in size... how can i use this number to offset the sprite tile Memory in the gba?
<br/>
<br/>
so my airplane is an array of 1536 unsigned shorts.
<br/>
Would i convert that to bytes or bits, then logical or it on to the devine for where sprite memory starts?  if so how?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#50338 - Cearn - Mon Aug 08, 2005 9:00 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>justinGBA wrote:</b></span></td> </tr> <tr> <td class="quote">Cool. It works, now. i never would of guessed that the sizeof() was a problem.  I just pass the size to the sprite class now.</td> </tr></table><span class="postbody">
<br/>
For a single sprite you don't need to use DMAFastCopy, just use '='. For small-length copies (~32 bytes?) anything else is pretty much a waste of time. 
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
Sprite s1, s2; // two sprites
<br/>
...
<br/>
s1= s2; // copy sprite s2 to sprite s1</td> </tr></table><span class="postbody">
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>justinGBA wrote:</b></span></td> </tr> <tr> <td class="quote">But that leaves me with one more question... if i know that the current sprite tile is 1536 in size... how can i use this number to offset the sprite tile Memory in the gba?
<br/>
<br/>
so my airplane is an array of 1536 unsigned shorts.
<br/>
Would i convert that to bytes or bits, then logical or it on to the devine for where sprite memory starts?  if so how?</td> </tr></table><span class="postbody">
<br/>
Don't quite understand that last part here. What do you need the offset for, and what does "devine" mean? ("device" doesn't make much sense in this context either)
<br/>
Anyway, the 1536 you mention is 1536 shorts (halfwords), sizes are usually given in byte-units, so that'd be 1536*2= 3072. So the sprite takes up 3072 bytes of VRAM. The rest of VRAM is still free to use, just grab a tile-aligned address (32 byte boundaries) and go.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
