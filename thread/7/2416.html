<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>odd bitfield behaviour... - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>C/C++ > odd bitfield behaviour...</h2>
<div id="posts">
<div class="post">
    <h4>#12957 - maximAL - Tue Dec 02, 2003 4:41 pm</h4>
    <div class="postbody"><span class="postbody">i just experienced that my bitfields do some really strange things O_o
<br/>
take this simple example:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
struct Bla
<br/>
{
<br/>
   vu8 A1:4;
<br/>
   vu8 A2:4;
<br/>
   vu8 B1:4;
<br/>
   vu8 B2:4;
<br/>
}__attribute__((packed));
<br/>
//...
<br/>
Bla *Blubb=(Bla*)0x7000000;
<br/>
Blubb-&gt;A1=1;
<br/>
</td> </tr></table><span class="postbody">
<br/>
actually, this should result in 0x0001, right? but it always sets 0x0101! this happens with all values, they are somehow "duplicated" into both bytes!?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#12960 - tepples - Tue Dec 02, 2003 6:11 pm</h4>
    <div class="postbody"><span class="postbody">I see you're trying to write to OAM. Byte writes do not work properly with palette memory, VRAM, or OAM, and GCC may be generating byte writes for bitfield code. I'd suggest not using bitfields because they have an even more sinister downside, namely that different versions of a compiler may lay out bitfields in different ways. If you're trying to write to OAM, use macros to build up values.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#12963 - maximAL - Tue Dec 02, 2003 7:28 pm</h4>
    <div class="postbody"><span class="postbody">hmm, if thats all, i'll simply use a shadow register to manipulate the values und copy it over in one piece.
<br/>
<br/>
edit:
<br/>
mmmkay, i think i got a serious problem here...using bitfields always seems to produce crap. i simply used a second object of the same type, set the bits und copied it via a pointer to the proper register - but obviously the data always gets fucked up in some weird way?! strange, because i think i tried this some time ago and it seemed to work...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#12969 - sajiimori - Tue Dec 02, 2003 9:40 pm</h4>
    <div class="postbody"><span class="postbody">Bitfields in structs are not guaranteed to be packed in the smallest possible space.  For instance, a struct with 2 fields of 4 bits each might not be packed into a single byte.  Go with tepples' suggestion and use macros.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#12971 - maximAL - Tue Dec 02, 2003 9:47 pm</h4>
    <div class="postbody"><span class="postbody">the __attribute__((packed)) should ensure that it is packed right...should
<br/>
is it worth trying the DevKitAdv r5 beta 3? at the moment i'm still using the r4...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#12973 - sajiimori - Tue Dec 02, 2003 10:03 pm</h4>
    <div class="postbody"><span class="postbody">AFAIK, the 'packed' attribute only suppresses padding of subword-sized (e.g. char, short) fields to word boundaries.  Besides, if it happened to work on only one version of DevkitAdvance, that would only prove tepples' point that you can't rely on bitfields to be arranged in any particular order.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
