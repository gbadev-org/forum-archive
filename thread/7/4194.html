<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Putting a C++ member function into IWRAM - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>C/C++ > Putting a C++ member function into IWRAM</h2>
<div id="posts">
<div class="post">
    <h4>#27319 - gb_feedback - Sat Oct 09, 2004 2:24 pm</h4>
    <div class="postbody"><span class="postbody">First a short intro:
<br/>
I'm using a fairly old version of devkitadv via Visual Studio 6 to develop.
<br/>
I prefer to use C++ normally as I'm used to it, but also have several working apps for the GBA which use C.
<br/>
I'm currently writing another pogoshell plug-in / standalone application for displaying GIF files. This is supposed to handle animated GIFs too and is intended to work at a reasonable speed. I'm using a full-screen short excerpt from an animated movie at 12 fps as a sample. Currently it works functionally but is too slow.
<br/>
So I intended to transfer the speed critical part, to IWRAM as I have so many times before.
<br/>
However previously I have been using C for this, as in the following example:
<br/>
<br/>
In the header file
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code"> #define CODE_IN_IWRAM __attribute__ ((section (".iwram"), long_call))
<br/>
extern void ResetGba(void) CODE_IN_IWRAM; </td> </tr></table><span class="postbody">
<br/>
<br/>
In the .c file which is compiled for ARM (and interworking):
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code"> CODE_IN_IWRAM void ResetGba(void)
<br/>
{
<br/>
...
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
When calling this from the THUMB (and interworking) compiled module:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code"> ...
<br/>
   ResetGba();
<br/>
... </td> </tr></table><span class="postbody">
<br/>
<br/>
And this has always worked fine. Now, for this new project, I have been using C++, so I tried:-
<br/>
<br/>
In the header file:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code"> #define CODE_IN_IWRAM __attribute__ ((section (".iwram"), long_call))
<br/>
<br/>
class CGif
<br/>
{
<br/>
...
<br/>
public:
<br/>
   bool GifDecompressImage (GIFINFO* gifInfo)  CODE_IN_IWRAM;
<br/>
...
<br/>
};</td> </tr></table><span class="postbody">
<br/>
<br/>
In the .cpp file which is compiled for ARM (and interworking):
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">CODE_IN_IWRAM bool CGif::GifDecompressImage (GIFINFO* gifInfo)
<br/>
{
<br/>
...
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
When calling this from the THUMB (and interworking) compiled module:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
...
<br/>
   m_gifFunc.GifDecompressImage (&amp;m_gifInfo);
<br/>
...</td> </tr></table><span class="postbody">
<br/>
<br/>
<br/>
Well, as you've realised by now, it doesn't work - just crashes (goes off and executes at some non-existant address).
<br/>
<br/>
I realise I've got a lot of work ahead to sort this out as my understanding of ARM assembly code and GCC are minimal (I've just been using them for the results!). But it would be nice to know before I start if anyone else has moved a C++ class member function into IWRAM and successfully called it, or am I asking the impossible?
<br/>
Remember, the code worked just before I moved the function into IWRAM...
<br/>
<br/>
Any ideas, guys?<br/>_________________<br/><a class="postlink" href="http://www.bookreader.co.uk/" target="_blank">http://www.bookreader.co.uk/</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#27324 - sajiimori - Sat Oct 09, 2004 6:00 pm</h4>
    <div class="postbody"><span class="postbody">If you don't end up finding a direct solution, you could always make the member function be a wrapper for a plain C function.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#27325 - gb_feedback - Sat Oct 09, 2004 6:47 pm</h4>
    <div class="postbody"><span class="postbody">Thanks for the reply. I was going to wait till I'd fully tracked this down before I posted again. The problem with the wrapper is that the data is so nicely buried in the class that to make a C function would have spoiled the 'elegance' (such as it is). But you're right basically. I would just have re-written the whole thing in C and swallowed my pride. However I've been single stepping through the program with no$gba and noticed that it crashes close to my dma clearScreen routine. I just 'ifed' that out of the code, and, low and behold, it sprang into life.
<br/>
<br/>
No idea yet why my clearScreen suddenly failed, but the conclusion is at least that the basic approach to moving a C++ member function into IWRAM, outlined in the original question does at least work. Might be useful to someone...<br/>_________________<br/><a class="postlink" href="http://www.bookreader.co.uk/" target="_blank">http://www.bookreader.co.uk/</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#27326 - sajiimori - Sat Oct 09, 2004 7:49 pm</h4>
    <div class="postbody"><span class="postbody">I'm glad you've got it figured out.
<br/>
<br/>
The class is still well-encapsulated if the plain C function is file static.  The interface needn't show any signs of trickery, unless the wrapper method absolutely has to be inlined.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#27395 - tepples - Tue Oct 12, 2004 5:47 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>sajiimori wrote:</b></span></td> </tr> <tr> <td class="quote">The class is still well-encapsulated if the plain C function is file static.</td> </tr></table><span class="postbody">
<br/>
But then of course you can't compile the ROM code as Thumb instructions and the IWRAM code as ARM instructions, as the current version of GCC doesn't have any mechanism to specify both Thumb and ARM instructions in one module.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#27400 - sajiimori - Tue Oct 12, 2004 6:47 am</h4>
    <div class="postbody"><span class="postbody">...
<br/>
<br/>
Make a friend class!!  lol</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#27408 - wintermute - Tue Oct 12, 2004 1:28 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>sajiimori wrote:</b></span></td> </tr> <tr> <td class="quote">...
<br/>
<br/>
Make a friend class!!  lol</td> </tr></table><span class="postbody">
<br/>
<br/>
there's no reason why you can't put some member functions in separate source files.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#27420 - sajiimori - Tue Oct 12, 2004 6:27 pm</h4>
    <div class="postbody"><span class="postbody">Oh yeah.  I'm so confused! ;_;   lol</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
