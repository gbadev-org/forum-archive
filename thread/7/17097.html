<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>getting funky results from movement checker - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>C/C++ > getting funky results from movement checker</h2>
<div id="posts">
<div class="post">
    <h4>#172412 - zelbo - Fri Feb 05, 2010 2:21 am</h4>
    <div class="postbody"><span class="postbody">i probably need to start from scratch on this one. since i'm just working with hard-coded maps for now, i built a function to read the map and build an array of tile information (passable, block line of sight...) to be used in my movement checker. Maybe i should just read the map value and evaluate each tile from that? I'm planning to implement a bitset for this, but i'm not sure i need it. Anyway, i forgot to ever call this function after i made it, so i went and made a bunch of changes trying to fix it when it didnt work. I've tried to backtrack, but now it is acting very strange.
<br/>
At first, it would not stop my character from moving at all, and the checkspace function was returning 0 all the time. So i changed the else condition of my array builder to be false, which should make all movement impossible. But it makes just a couple of seemingly random tiles and an entire row towards the middle of the map impassable. It does return values now, and i'm trying to use those to track down what i screwed up (maybe my formula on converting a 1D array to a 2D array?) I know i'm doing something very wrong, but am having trouble pin-pointing it. Any help would be very appreciated.
<br/>
the map is a u16 array, the list array is of type "tile" currently defined in monster.h because that's where it 'works', i know i need to move it:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">struct tile// does not belong in monster.h - how to move it but keep everything working?
<br/>
{
<br/>
// pointer to object or int ID, something to find what is on the tile for pickup item or fight monster...
<br/>
bool passable; // default not passable
<br/>
bool blockLOS; // default block line of sight
<br/>
int type;
<br/>
};</td> </tr></table><span class="postbody">
<br/>
Here is the temporary flag array in main.cpp:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void tempBuildList() // just until we get some actual level generation set up, then build list and map at same time
<br/>
{ // use list as map? or map as list...
<br/>
   int iz, iy, ix, i = 0;
<br/>
<br/>
   for(iz = 0; iz &lt; 3; iz++)
<br/>
   {
<br/>
      for(iy = 0; iy &lt; 64; iy++)
<br/>
      {
<br/>
         for(ix = 0; ix &lt; 64; ix++)
<br/>
         {
<br/>
            i = ix + (iy * 64);// n = x + (y * w)
<br/>
            list[iz][iy][ix].type = map2_64x64[i];
<br/>
            if (map2_64x64[i] == 4)
<br/>
            {
<br/>
               list[iz][iy][ix].passable = false;
<br/>
            }
<br/>
            else
<br/>
            {
<br/>
               // this should be true - trying false to see what happens.
<br/>
               list[iz][iy][ix].passable = false;
<br/>
            }
<br/>
            
<br/>
            
<br/>
         }
<br/>
      }
<br/>
   }
<br/>
   
<br/>
}</td> </tr></table><span class="postbody">
<br/>
invoking the checkSpace method of the player object in main.cpp:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">         i = player-&gt;checkSpace(direction, list);
<br/>
         switch (i)
<br/>
         {
<br/>
            case (0):
<br/>
               player-&gt;moveMonster(direction);
<br/>
               //direction = D_NONE;
<br/>
               break;
<br/>
            case (1):
<br/>
               // combat?
<br/>
               //direction = D_NONE;
<br/>
               break;
<br/>
            case (2):
<br/>
               // bump
<br/>
               //direction = D_NONE;
<br/>
               break;
<br/>
            case (3): 
<br/>
               // swim?
<br/>
               //direction = D_NONE;
<br/>
               break;
<br/>
            case (4): 
<br/>
               // open?
<br/>
               //direction = D_NONE;
<br/>
               break;
<br/>
            default: // nothing there, go for it!
<br/>
               player-&gt;moveMonster(direction);
<br/>
               break;
<br/>
         }</td> </tr></table><span class="postbody">
<br/>
the checkSpace function in monster.cpp:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">   int Monster::checkSpace(int direction, tile plist[3][64][64])
<br/>
   {
<br/>
   // potentials
<br/>
   int potX = 0;
<br/>
   int potY = 0;
<br/>
   // 0=none 1=Creature 2=Wall 3=Water 4=Door
<br/>
   int obstacle = 0;
<br/>
   /*
<br/>
      1) check creature array for monsters
<br/>
         fight?
<br/>
      2) check terrain array for walls/water/door
<br/>
         bump head/ swim? / open?
<br/>
   */
<br/>
      switch (direction)
<br/>
      { // first figure out what square we're looking at
<br/>
         case (D_UP):
<br/>
            potX = this-&gt;x;
<br/>
            potY = this-&gt;y - 1;
<br/>
            break;
<br/>
         case (D_RIGHT):
<br/>
            potX = this-&gt;x + 1;
<br/>
            potY = this-&gt;y;
<br/>
            break;
<br/>
         case (D_DOWN):
<br/>
            potX = this-&gt;x;
<br/>
            potY = this-&gt;y + 1;
<br/>
            break;
<br/>
         case (D_LEFT):
<br/>
            potX = this-&gt;x - 1;
<br/>
            potY = this-&gt;y;
<br/>
            break;
<br/>
         default:
<br/>
            potX = this-&gt;x;
<br/>
            potY = this-&gt;y;
<br/>
            break;
<br/>
      }
<br/>
      
<br/>
      if (plist[0][potY][potX].passable)
<br/>
      {
<br/>
         obstacle = 0;
<br/>
      }
<br/>
      else
<br/>
      {
<br/>
         obstacle = plist[0][potY][potX].type;
<br/>
      }
<br/>
<br/>
      return obstacle;
<br/>
   }
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Let me know if you need more information. I'd also be willing to email a copy of my entire project folder or the .nds file upon request.
<br/>
<br/>
One thing i just noticed is that in struct tile "type" is defined as an int, but my map units are u16, but it doesn't seem like that should be causing the strange results i'm getting, should it? Gar, i wish i had internet access at my dev machine, this whole process would be so much easier...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#172419 - sgeos - Fri Feb 05, 2010 8:24 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">i probably need to start from scratch on this one.</td> </tr></table><span class="postbody">
<br/>
My thoughts are just rewrite it.  You are familiar with the <a class="postlink" href="http://en.wikipedia.org/wiki/Pareto_principle" target="_blank">Pareto Principle (AKA 80-20 Rule)</a>, right?  If you can identify a problem module, chances are you will be better off just discarding it.  Use the experience gained writing it the first time to do a decent job on next iteration, rewriting from scratch, unless you have very good reasons not to do so.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#172433 - zelbo - Fri Feb 05, 2010 11:27 pm</h4>
    <div class="postbody"><span class="postbody">I hadn't heard of that one, but now that i've read it, the concept sounds familiar.
<br/>
At this point, i think i need to get a better handle on my map structure, then i'm going to implement a "look" command. If all goes well with that, i should be able to get the movement checker working without too much trouble.
<br/>
I guess i don't really need to muck with it now, but i wonder what is causing such strange results. i've noticed a couple of spots that wont let me move, but only when the map is scrolled all the way to the right or left. If it scrolls just a little either way, there is nothing blocking my movement on these mystery spots, neither where it was or where it should have scrolled to, but the line in the middle is still there.
<br/>
So i'm going to rewrite it, but now i'm very curious, i will probably come back to it later and try to figure it out.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#172451 - zelbo - Sat Feb 06, 2010 11:15 pm</h4>
    <div class="postbody"><span class="postbody">Ok, so i've realized something. I'm using a map that is 64 tiles tall by 64 tiles wide, but it is basically split into quarters for putting it into mapbase memory, so the formula n=x+(y*w) doesn't work here.
<br/>
Even though i'm not going to be using this particular function, i think i still need to deal with x and y in 1d arrays. Now i either need to figure out a new formula to deal with this, or cut my map size down. Since i'd really like to stick with 64x64 if i can, i think i'm going to be doing some math on paper for this.
<br/>
While this helps me to understand why it's not working the way it should, i still don't think this explains the behavior i've been getting from it.
<br/>
<br/>
maybe something like n=x+(y*w)+(q*1024) where q can be 0 to 3?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#172456 - elwing - Sun Feb 07, 2010 8:14 pm</h4>
    <div class="postbody"><span class="postbody">that said, why don't you use a 32x32 map? 64x64 is prolly too small for a game map so you'll need scrolling anyway... 32x32 leads to smaller map and you avoid the screenblocks management problem...</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
