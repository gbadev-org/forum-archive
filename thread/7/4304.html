<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>fixed point macro - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>C/C++ > fixed point macro</h2>
<div id="posts">
<div class="post">
    <h4>#28367 - sgeos - Sat Oct 30, 2004 6:26 am</h4>
    <div class="postbody"><span class="postbody">Is there any reason not to use something like this <span style="font-weight: bold">for constants</span>?
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">typedef unsigned long   u32;
<br/>
typedef u32      FIXED;
<br/>
<br/>
/***   TOFIXED(a,b)
<br/>
 *
<br/>
 *   a = floating point value
<br/>
 *   b = fixed point fractional component
<br/>
 */
<br/>
#define TOFIXED(a,b)   (  (FIXED)  (((float)a) * (1 &lt;&lt; (b)))  )
<br/>
<br/>
const FIXED table[] = {TOFIXED(1.5, 8), ...};
<br/>
x *= TOFIXED(4/3, SOME_RESOLUTION);
<br/>
x /= ...</td> </tr></table><span class="postbody">
<br/>
<br/>
-Brendan</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#28369 - allenu - Sat Oct 30, 2004 6:37 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>sgeos wrote:</b></span></td> </tr> <tr> <td class="quote">Is there any reason not to use something like this <span style="font-weight: bold">for constants</span>?
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I'm not sure what you're asking here.  It looks like you are trying to convert a floating point value to a fixed-point (24.8) format using a macro for convenience.  If so, your macro looks like it should work and if it's convenient for you, go for it.  I don't see any problems with it.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#28383 - poslundc - Sat Oct 30, 2004 3:28 pm</h4>
    <div class="postbody"><span class="postbody">Well, there's one sneaky problem with it, that you actually identify with your example:
<br/>
<br/>
((float)a)
<br/>
<br/>
... should probably be
<br/>
<br/>
((float)(a))
<br/>
<br/>
In the example you give:
<br/>
<br/>
TOFIXED(4/3, SOME_RESOLUTION);
<br/>
<br/>
It will actually generate what you want, because it comes out as:
<br/>
<br/>
((float)4/3) == 1.333...
<br/>
<br/>
But in, say for example, the following situation:
<br/>
<br/>
TOFIXED(4/3+1/2, SOME_RESOLUTION);
<br/>
<br/>
It will give you the same answer, because:
<br/>
<br/>
((float)4/3+1/2) == 1.333... + 0 == 1.333...
<br/>
<br/>
You should enclose the a in its own parentheses, and rely on yourself to cast numbers to float if you want to do manual division, eg.
<br/>
<br/>
TOFIXED((float)4/3, SOME_RESOLUTION); or
<br/>
TOFIXED(4.0/3, SOME_RESOLUTION);
<br/>
<br/>
For the record, I like to precalculate my fixed-point constants and load them manually into my program so I can see what they look like, rather than letting the precompiler do the work for me. To each his own.
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#28488 - Cearn - Mon Nov 01, 2004 9:50 am</h4>
    <div class="postbody"><span class="postbody">On a side note ...
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>sgeos wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">typedef unsigned long   u32;
<br/>
typedef u32      FIXED;
<br/>
</td> </tr></table><span class="postbody"></span></td> </tr></table><span class="postbody">
<br/>
Do <span style="font-weight: bold">not</span> use unsigned numbers for fixed points. The fixed point notation is an integer representation of real numbers; these can be both positive or negative, so they should be signed.
<br/>
Most of the time it won't really matter, but when converting between types or shifting down it will. For example, you'd really want a 16bit "-1" (0xffff) to turn into a 32bit "-1" (0xffffffff), and not "65535" (0x0000ffff), which is what would happen using unsigned shorts.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#28493 - poslundc - Mon Nov 01, 2004 3:04 pm</h4>
    <div class="postbody"><span class="postbody">Ooh, very good point. I've been nailed on that one a couple of times in the past when doing highly mathematical stuff (like my Mode 7 engine).
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#28495 - ampz - Mon Nov 01, 2004 6:22 pm</h4>
    <div class="postbody"><span class="postbody">That is assuming you are working with signed numbers (which is not allways the case).
<br/>
For unsigned math there is no reason to use signed numbers, and you gain one bit of precision by using unsigned.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#28608 - Cearn - Wed Nov 03, 2004 10:11 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>ampz wrote:</b></span></td> </tr> <tr> <td class="quote">That is assuming you are working with signed numbers (which is not always the case).
<br/>
For unsigned math there is no reason to use signed numbers, and you gain one bit of precision by using unsigned.</td> </tr></table><span class="postbody">
<br/>
Fair enough, if you're absolutely sure all your calculations will be positive and you need the extra bit, then by all means use unsigned numbers. But remember that a simple subtraction of unsigned values get give negative results (5 - 8 = -3). From a purely mathematical viewpoint, FIXEDs should be signed; you can always go to unsigned afterwards if you know exactly what you're doing.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
