<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>GCC is afraid of efficient memory access - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>C/C++ > GCC is afraid of efficient memory access</h2>
<div id="posts">
<div class="post">
    <h4>#11654 - tepples - Wed Oct 15, 2003 4:35 am</h4>
    <div class="postbody"><span class="postbody">I wasn't sure whether to put this in the C++ section or the ASM section, but here goes:
<br/>
<br/>
One limitation of gcc version 3.2.2 (DevKit Advance R5 Beta 3) is that it does *not* like to LDMIA from memory to variables, even when LDMIA would be obviously the best answer. Instead, it generates successive LDR instructions, wasting cycles on address generation.
<br/>
<br/>
Test case: Compile this to assembly language with
<br/>
arm-agb-elf-gcc -Wall -O3 -marm -mthumb-interwork -S ldmia.c -o ldmia.s
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
/* ldmia_test() **************************
<br/>
   XORs successive pairs of ints in src, placing the result in dst.
<br/>
   Reads 2*n ints (8*n bytes) from src and stores n ints (4*n bytes) to dst.
<br/>
*/
<br/>
void ldmia_test(unsigned int *dst, const unsigned int *src, unsigned int len)
<br/>
{
<br/>
  /* force variables into ascending-ordered registers */
<br/>
  register unsigned int x;
<br/>
  register unsigned int y asm("ip");
<br/>
<br/>
  for(; len &gt; 0; len--)
<br/>
  {
<br/>
    /* GCC *should* emit an LDMIA instruction that pulls in
<br/>
       both x and y.  */
<br/>
    x = *src++;
<br/>
    y = *src++;
<br/>
    *dst++ = x ^ y;
<br/>
  }
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
results in
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
   .file   "ldmia.c"
<br/>
   .text
<br/>
   .align   2
<br/>
   .global   ldmia_test
<br/>
   .type   ldmia_test,function
<br/>
ldmia_test:
<br/>
   @ Function supports interworking.
<br/>
   @ args = 0, pretend = 0, frame = 0
<br/>
   @ frame_needed = 0, uses_anonymous_args = 0
<br/>
   @ link register save eliminated.
<br/>
   cmp   r2, #0
<br/>
   @ lr needed for prologue
<br/>
   bxeq   lr
<br/>
.L6:
<br/>
   ldr   r3, [r1], #4
<br/>
   ldr   ip, [r1], #4
<br/>
   subs   r2, r2, #1
<br/>
   eor   r3, r3, ip
<br/>
   str   r3, [r0], #4
<br/>
   bxeq   lr
<br/>
   b   .L6
<br/>
.Lfe1:
<br/>
   .size   ldmia_test,.Lfe1-ldmia_test
<br/>
   .ident   "GCC: (GNU) 3.2.2 (DevKit Advance R5 Beta 3)"
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Can't this
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
   ldr   r3, [r1], #4
<br/>
   ldr   ip, [r1], #4
<br/>
</td> </tr></table><span class="postbody">
<br/>
be replaced with this?
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
   ldmia   ip!, {r3, ip}
<br/>
</td> </tr></table><span class="postbody">
<br/>
And how would I get GCC to generate LDMIA instructions without resorting to inline assembly language? I still can't get my head around how to specify pre- and post-conditions of inline assembly.
<br/>
<br/>
I've also had problems coaxing GCC into using register FP to hold a variable.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#11656 - Burton Radons - Wed Oct 15, 2003 6:18 am</h4>
    <div class="postbody"><span class="postbody">This is a code generation bug, since it does know how to do it:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
void ldmia_test (unsigned int *dst, const unsigned int *src, unsigned int len)
<br/>
{
<br/>
    unsigned int x;
<br/>
    unsigned int y;
<br/>
<br/>
    for(; len &gt; 0; len--)
<br/>
    {
<br/>
        /* GCC *should* emit an LDMIA instruction that pulls in
<br/>
        both x and y.  */
<br/>
        x = src [0];
<br/>
        y = src [1];
<br/>
        *dst++ = x ^ y;
<br/>
        src += 2;
<br/>
    }
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Doing this makes it generate the right code:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
ldmia_test:
<br/>
    @ args = 0, pretend = 0, frame = 0
<br/>
    @ frame_needed = 0, uses_anonymous_args = 0
<br/>
    @ link register save eliminated.
<br/>
    cmp r2, #0
<br/>
    @ lr needed for prologue
<br/>
    moveq   pc, lr
<br/>
.L536:
<br/>
    ldmia   r1, {r3, ip}
<br/>
    eor r3, r3, ip
<br/>
    subs    r2, r2, #1
<br/>
    str r3, [r0], #4
<br/>
    add r1, r1, #8
<br/>
    moveq   pc, lr
<br/>
    b   .L536
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I'll report it; however, I don't know if it can be fixed at the point the code generator gets it.  It's clearly missing a pattern that skips certain garbage it doesn't like in the middle.
<br/>
<br/>
And just a note, if you want to force registers to multiple variables, explicitly indicate both of them because the allocation scheme might change.  You so very much do not want this kind of bug in your code.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#11661 - Paul Shirley - Wed Oct 15, 2003 2:11 pm</h4>
    <div class="postbody"><span class="postbody">removed</span><span class="gensmall"><br/><br/>Last edited by Paul Shirley on Sun Mar 28, 2004 8:49 pm; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#11682 - tepples - Wed Oct 15, 2003 8:50 pm</h4>
    <div class="postbody"><span class="postbody">Thanks for all the tips.
<br/>
<br/>
I guess it's just a bug that GCC doesn't see
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
a = x[0];
<br/>
x++;
<br/>
b = x[0];
<br/>
x++;
<br/>
</td> </tr></table><span class="postbody">
<br/>
as equivalent to
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
a = x[0];
<br/>
b = x[1];
<br/>
x += 2;
<br/>
</td> </tr></table><span class="postbody">
<br/>
instead making the second fragment faster.
<br/>
<br/>
This change shaved a few cycles off my draw function's inner loop. Another operation to avoid on ARM is repeatedly shifting a variable (e.g. bits &gt;&gt;= 8); instead, use bits, bits &gt;&gt; 8, bits &gt;&gt; 16, bits &gt;&gt; 24.
<br/>
<br/>
I've boiled down my findings to a general guideline: For fastest ARM code with GCC, make as few modifications to temporary variables as possible.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#11689 - poslundc - Thu Oct 16, 2003 12:16 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tepples wrote:</b></span></td> </tr> <tr> <td class="quote">I've boiled down my findings to a general guideline: For fastest ARM code with GCC, make as few modifications to temporary variables as possible.</td> </tr></table><span class="postbody">
<br/>
<br/>
That's useful advice. Were your tests strictly on ARM code, or Thumb as well?
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#11703 - tepples - Thu Oct 16, 2003 5:54 am</h4>
    <div class="postbody"><span class="postbody">ARM only. I've never written a program that needed more than a couple kilobytes of heavily optimized ARM code, so I haven't had to resort to optimizing generation of Thumb code yet.  I would guess that because of fewer registers and the lack of a shift during register-fetch phase, some of this may not apply.
<br/>
<br/>
That said, I did get my full-screen mode 4 environment mapper (your stereotypical "lens" or "tunnel" effect) up to 24 fps at 240x160 pixels on hardware.  I could of course go to 60fps and beyond easily by halving horizontal resolution and interlacing vertically. (Beyond is useful when I want to add sound to a demo, or when I want to precompute stuff for the next shot.)<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
