<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Weird GCC optimization bug? [solved] - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>C/C++ > Weird GCC optimization bug? [solved]</h2>
<div id="posts">
<div class="post">
    <h4>#178116 - asoggytoaster - Mon Oct 28, 2013 2:56 am</h4>
    <div class="postbody"><span class="postbody">I'm not sure how many people are still around to view this and provide input but I thought I'd post it anyway. Now, I know that this isn't the optimal way of doing this, but <a class="postlink" href="http://pastebin.com/YagHSBkM" target="_blank">http://pastebin.com/YagHSBkM</a> in that code snippet, I created a struct with bit-fields to access the various values of the display control register at 4000000h.
<br/>
<br/>
I don't have a problem with bit juggling,I have a macro display_set_mode() that will set the register value without using the bitfields, instead it relies on the .raw member of the struct. but, to the point.. 
<br/>
<br/>
If you look carefully at the assembly generated by the compiler,  you'll notice that lines 64-65 of the paste are consistent with line 56. Then lines 66-69 are consistent with line 58. The compiler optimized line 57 out of existence, which in this instance is kinda bad because line 57 sets the display mode. 
<br/>
<br/>
Now, when optimization is completely disabled, the compiler will generate code that functions as expected. But, when any optimization is turned on at all, line 57 disappears. Has anyone seen anything like this before?</span><span class="gensmall"><br/><br/>Last edited by asoggytoaster on Mon Oct 28, 2013 5:05 am; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#178117 - Dwedit - Mon Oct 28, 2013 4:28 am</h4>
    <div class="postbody"><span class="postbody">Did you forget to make it volatile?  You need to declare the pointer as volatile if it's a memory-mapped register, otherwise GCC thinks it's regular memory and will skip unnecessary writes.
<br/>
<br/>
Or in other words, something like this:
<br/>
<br/>
#define display_control_register (*(volatile display_control_reg_t *)BASE_REG)<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#178118 - asoggytoaster - Mon Oct 28, 2013 4:47 am</h4>
    <div class="postbody"><span class="postbody">Oops. Yes, that seems to be where I made the oversight. I'm working with vim and have quite a few files open - I did make the other register pointers volatile, I guess I just forgot to mark this one that way. Thanks for the help!</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
