<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>end of rom address - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>C/C++ > end of rom address</h2>
<div id="posts">
<div class="post">
    <h4>#43573 - _Dan - Tue May 24, 2005 8:42 pm</h4>
    <div class="postbody"><span class="postbody">Hello. :)
<br/>
<br/>
How would I get the address of the end of the rom?
<br/>
<br/>
I'm guessing it's something similar to the code for accessing video,
<br/>
video = (unsigned short *)0x6000000;
<br/>
but with the rom length or something.
<br/>
<br/>
The reason for this is to access data appended to the rom after compilation. Is it okay to do this? (there is no special format the rom's end has to be in or anything?)
<br/>
<br/>
Thanks.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#43581 - DekuTree64 - Tue May 24, 2005 9:58 pm</h4>
    <div class="postbody"><span class="postbody">You could probably do it with some linkscript magic, by making an extra section at the end (like .rodata, .irwam, etc) with only one label in it and use that as your end marker. Probably not the best option though.
<br/>
<br/>
I think the way most file systems (such as tepples' GBFS) do it is with a magic string. Just make something like "@#$Dan's file system header%^&amp;", or anything else you want that you would consider long enough and strange enough that the odds of it appearing anywhere else in the ROM by coincidence are so slim you don't have to worry about it.
<br/>
Then in your data appending tool, put that string before all your file data. 
<br/>
In the GBA code, search for the string and you have your data start.<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#43591 - tepples - Tue May 24, 2005 11:54 pm</h4>
    <div class="postbody"><span class="postbody">Correct. GBFS uses a linear search from the address you specify in find_first_gbfs_file() to the end of ROM space. You can slightly speed up the search by passing an address known to be near the end of your ROM. In general, use the following command:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">nm -n mygame.elf</td> </tr></table><span class="postbody">
<br/>
For devkitARM, the symbol is <span style="font-weight: bold">_end</span>, and code will look roughly like the following (untested):
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">extern const char _end[];
<br/>
const GBFS_FILE *dat;
<br/>
<br/>
int main(void)
<br/>
{
<br/>
Â  dat = find_first_gbfs_file(_end);
<br/>
}</td> </tr></table><span class="postbody"><br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#43685 - Steve++ - Wed May 25, 2005 6:36 pm</h4>
    <div class="postbody"><span class="postbody">The magic string shouldn't be able to start just anywhere, otherwise the filesystem will be testing each byte for the beginning of the filesystem. Instead, the magic string should be aligned by some large boundary. I think 1KB is large enough. That's 1024 searches per MB.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#43743 - tepples - Thu May 26, 2005 3:39 am</h4>
    <div class="postbody"><span class="postbody">GBFS does use a 256 byte stride when linear-searching for the magic string, as documented in its manual. I selected 256 bytes as a compromise between the low overhead requirements of .mb and the high speed requirements of .gba.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#43783 - _Dan - Thu May 26, 2005 8:14 pm</h4>
    <div class="postbody"><span class="postbody">Great, thanks for the help. The magic string is a good idea.
<br/>
<br/>
BUT it would probably be quicker if I could specify the location (or at least have some idea where in memory to start looking).
<br/>
<br/>
I read somewhere it is something like:
<br/>
<br/>
0x8000000 + ROMSIZE
<br/>
Where ROMSIZE is the size before files have been appended.
<br/>
<br/>
To get the location of the end.
<br/>
If I appended my data to the rom, then to access the first element:
<br/>
<br/>
unsigned char *filedata = (unsigned char *)(0x8000000 + ROMSIZE);
<br/>
filedata[0]; // first element of appended data
<br/>
<br/>
Is this correct?
<br/>
<br/>
Also, is it the same 0x8000000 location for both multiboot and normal roms?
<br/>
<br/>
Thanks.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#43789 - tepples - Thu May 26, 2005 8:24 pm</h4>
    <div class="postbody"><span class="postbody">For multiboot programs, the starting location will be 0x02000000. For ROM programs, it'll be 0x08000000. However, ROMSIZE isn't known until link time, and only some link scripts echo it back to a symbol that a program can use. I am pretty sure it has something to do with the _end symbol, but I haven't tested it.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#43796 - _Dan - Thu May 26, 2005 8:48 pm</h4>
    <div class="postbody"><span class="postbody">Thanks. :)
<br/>
Presumably I could set the ROMSIZE to some random number, compile, and then to change it to the correct value either edit the rom or recompile.
<br/>
I'll have a search for the _end thing.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#47810 - Mucca - Wed Jul 13, 2005 8:27 pm</h4>
    <div class="postbody"><span class="postbody">I dont get, why dont you just use the symbols of any data that you link. Am I missing something here? Compile all raw binary files to .o using objcopy, and simply use the symbol:
<br/>
<br/>
extern const char _binary_myfile_bin_start
<br/>
<br/>
ok, not exactly that name, it depends on which objcopy you use and how you use it (check the name and type of the symbols by running nm.exe on the .o file). Heck IIRC the bin2o tool lets you define your own symbol name. Have a look in the devr's FAQ.
<br/>
<br/>
edit: oops dead thread. Should have opened my eyes</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
