<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>C/C++ Optimization trick: Returning two ints from a function - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>C/C++ > C/C++ Optimization trick: Returning two ints from a function</h2>
<div id="posts">
<div class="post">
    <h4>#176998 - Dwedit - Fri Nov 18, 2011 8:15 pm</h4>
    <div class="postbody"><span class="postbody">According to the Arm Procedure Call Standard, there is only one efficient way to return values greater than 32-bits from a function, and that is to use 64-bit integers.  A struct that consists of two int values will not work, since it will force the compiler to use the stack.
<br/>
<br/>
So here's an example of how to efficiently return two ints from a function:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
typedef unsigned int u32;
<br/>
typedef unsigned long long u64;
<br/>
<br/>
typedef union
<br/>
{
<br/>
   u64 doubleword;
<br/>
   struct
<br/>
   {
<br/>
      u32 a;
<br/>
      u32 b;
<br/>
   } words;
<br/>
} doubleword;
<br/>
<br/>
#define ReturnTwoInts(a,b) \
<br/>
   {\
<br/>
      doubleword dw;\
<br/>
      dw.words.a = (a);\
<br/>
      dw.words.b = (b);\
<br/>
      return dw.doubleword;\
<br/>
   }
<br/>
<br/>
#define AssignToTwoInts(c,a,b) \
<br/>
   {\
<br/>
      doubleword dw;\
<br/>
      dw.doubleword = (c);\
<br/>
      (a) = dw.words.a;\
<br/>
      (b) = dw.words.b;\
<br/>
   }
<br/>
<br/>
u64 ExampleFunction(u32 a, u32 b)
<br/>
{
<br/>
   a+=4;
<br/>
   b+=4;
<br/>
   ReturnTwoInts(a,b);
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
When you want to call ExampleFunction, you can just use something like "AssignToTwoInts(ExampleFunction(a,b),a,b)".
<br/>
<br/>
ExampleFunction gives this assembly code:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
ExampleFunction:
<br/>
   add   r0, r0, #4
<br/>
   add   r1, r1, #4
<br/>
   bx   lr
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
If you look at the assembly code for this example function, you can see that despite creating a temporary union value and assigning variables to it, the compiler simply returns the two ints as r0 and r1.  r0 and r1 also happen to be the first two int arguments to a function, so you can make fast functions that taken in two ints, do something, then return the next two ints to use.
<br/>
<br/>
Additionally, the compiler is also smart enough to properly handle inlining the function that returns two integers.
<br/>
<br/>
Compile this at at least -O1, otherwise you get really bad code.
<br/>
<br/>
<br/>
I also tried other ways to build and separate a 64 bit value, but only the union/struct method seemed to generate good code.  Bit shifting didn't work very well.<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#177009 - Miked0801 - Mon Nov 21, 2011 5:45 pm</h4>
    <div class="postbody"><span class="postbody">Thanks for this.  I've been reading the latest ARM docs and it does state that this is completely legal and normal.  I just hadn't figured out how to get the compiler to do it regularly.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
