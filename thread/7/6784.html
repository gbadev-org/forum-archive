<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Improving a 3D engine?s performance - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>C/C++ > Improving a 3D engine?s performance</h2>
<div id="posts">
<div class="post">
    <h4>#53316 - Nacho - Wed Sep 07, 2005 1:45 pm</h4>
    <div class="postbody"><span class="postbody">Hello there! I?m coding a simple 3D engine using plain C and VHam as a compiling toolchain. So far I?ve managed to raster an affine textured triangle that rotates on its own Y-axis using mode 3 but it?s very very slow! That?s why I decided to come here so that you can suggest me some kind of optimization I should look into so I can speed this thing up a little bit.
<br/>
<br/>
Some information I think you might want to know about the code:
<br/>
* Everything is done in fixed point arithmetic using a 16.16 format.
<br/>
* The only place that a division is performed is inside the fixed point division function:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
inline FIXP1616
<br/>
FIXP1616_Div(FIXP1616 n1,FIXP1616 n2)
<br/>
{
<br/>
   return ((n1&lt;&lt;8)/(n2&gt;&gt;8));
<br/>
} /* End FIXP1616_Div() */
<br/>
</td> </tr></table><span class="postbody">
<br/>
* The modulus operator is not used at all.
<br/>
<br/>
All input and suggestions will be highly appreciated. Also, if you need to have access to certain parts of the code just ask me and I?ll post it here.
<br/>
<br/>
Thanks in advance for your help!
<br/>
<br/>
--Nacho</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#53321 - ribrdb2 - Wed Sep 07, 2005 2:47 pm</h4>
    <div class="postbody"><span class="postbody">maybe you should profile it and figure out what needs to be optimized. That's how I usually optimize my 3d engines.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#53341 - Miked0801 - Wed Sep 07, 2005 6:36 pm</h4>
    <div class="postbody"><span class="postbody">The division occurs how often?  Usually once per scanline for texturing.
<br/>
<br/>
1. Quick fix - use the built it GBA Div function instead of /.  This will x2 - x3 the speed of the divide.
<br/>
2. Consider grabbing an optimized ARM divider instead.  Jeff F. has one on his site.  That makes it go another 50% faster.
<br/>
3. Make a HUGE 1/X lookup table and multiply by that instead of dividing.  This makes the division a non-factor.
<br/>
<br/>
!!!0. Profle your code so you know where the slow downs are occuring.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#53378 - Royale00 - Thu Sep 08, 2005 1:39 am</h4>
    <div class="postbody"><span class="postbody">I wouldnt recommend mode 3 for any kind of 3d rendering as you only get one framebuffer in hardware. Depending on how far you want your engine to progress in features I would suggest mode 4 which provides 2 framebuffers and is color indexed. As far as coding goes use a look up table for divisions as Mike said and if you use mode 4 you can get away with writing multiple pixels at once because of the bus width to the vram. You may also want to unroll loops and code some of them in assembler but again its all about what you want to do with your engine.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#53387 - Nacho - Thu Sep 08, 2005 2:29 am</h4>
    <div class="postbody"><span class="postbody">Thanks for answering to my post!
<br/>
<br/>
@ ribrdb2: Thanks for your suggestion. I?ve never used any kind of profiler for GBA, so which one do you suggest?
<br/>
<br/>
@ Miked0801: Thanks for your advice on alternatives to the division operator. I?ve searched for Jeff?s optimized ARM divider but the link seems to be broken ( www-test.cirrus.com/en/pubs/ presentation/ep9312pres-epf-1.pdf ). Can you post it here?
<br/>
<br/>
@ Royale00: Thanks for your advice. I made a mistake in my original post by saying that I was using mode 3 when actually I?m using mode 4. You said that in mode 4 multiple pixels can be written at once because of the bus width to VRAM. Does the memset function take advantage of that or should I roll out my own implementation?
<br/>
<br/>
Thanks again for your replies!
<br/>
<br/>
--Nacho</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#53388 - crossraleigh - Thu Sep 08, 2005 2:39 am</h4>
    <div class="postbody"><span class="postbody"><a class="postlink" href="http://www.peter-teichmann.de/adiv1e.html" target="_blank">http://www.peter-teichmann.de/adiv1e.html</a><br/>_________________<br/>My world is black and white, but if I blink fast enough, I see it in grayscale.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#53485 - Miked0801 - Thu Sep 08, 2005 6:35 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
Does the memset function take advantage of that or should I roll out my own implementation? 
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Please tell me you are not calling memset to write pixels.  Please tell me you are instead doing this yourself in either assembly or hand-optimized C code.  If you are using memset, this will be bottleneck #1 to fix.  Check the archives as we've posted highly optimized assembler pixel/line drawers in the past.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#53520 - Quirky - Thu Sep 08, 2005 11:19 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Nacho wrote:</b></span></td> </tr> <tr> <td class="quote"> I?ve never used any kind of profiler for GBA, so which one do you suggest?
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
<br/>
gprof works with VBA. I used it on my own flat shaded poly 3D engine, here is more or less my main.c:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#ifdef ENABLE_PROFILING
<br/>
#include "vba.h"
<br/>
#endif
<br/>
<br/>
int main(void)
<br/>
{
<br/>
#ifdef ENABLE_PROFILING
<br/>
  monstartup(0x0800045c, 0x080155a8);
<br/>
#endif
<br/>
  initialise_gba();
<br/>
  while (1) {
<br/>
    // intro sequence
<br/>
    start();
<br/>
    // everything else..
<br/>
    main_loop();
<br/>
<br/>
#ifdef ENABLE_PROFILING
<br/>
    moncleanup();
<br/>
#endif
<br/>
  }
<br/>
  return 0;
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Then I add <span style="font-style: italic">-pg -DENABLE_PROFILING</span> to my CFLAGS when I want to profile the code. The code addresses for profiling are project depednent, take them from a map/objdump file. make clean all and ready to go. Play the game normally on VBA, make sure it passes through moncleanup() when you want to end profiling. For my game, I exit the main_loop() function when it is game over. Get killed == end profiling. Simple.
<br/>
<br/>
You need to link in libvba from <a href="http://vba.ngemu.com/downloads.shtml" target="_blank">http://vba.ngemu.com/downloads.shtml</a>
<br/>
<br/>
The output is gmon.out that contains the profiling data. Use <span style="font-style: italic">gprof mygame.elf</span> and it produces a big load of info on calls, time taken and stuff. From here you can see what takes the longest. In my case a nasty C scanline routine was a bottle neck, so I coded it in arm with an unrolled str loop and placed in iwram.
<br/>
<br/>
That (unfortunately) had the effect of moving the routine out of the memory range profiled, but the noticeable speed up made the decision justified. Even if you don't fancy coding in assembler, the profiling will help to see which routines are called most often and then you can decide to either ditch some of them if not needed or improve them if they are vital. HTH.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#53544 - Nacho - Fri Sep 09, 2005 2:17 am</h4>
    <div class="postbody"><span class="postbody">Thanks for the replies!
<br/>
<br/>
@ crossraleigh: Thanks for the link! I have already downloaded a set of optimized functions from here: <a href="http://www.gbadev.org/index.php?ID=109" target="_blank">http://www.gbadev.org/index.php?ID=109</a> but thanks anyway for the link!
<br/>
<br/>
@ Miked0801: As a matter of fact, yes, I?m using memset in the flat shaded rendering functions. I undestand that it could be optimized by using ASM, but how can I optimize it in C? In any case, the function that gets called to render a textured triangle works on a pixel by pixel basis (because of the interpolation), so I should look for the bottlenecks in that function elsewhere. Nonetheless, I?m interested in the optimization of the memset function so I can speed up the flat shaded renderer. Thanks for your suggestion, I have been checking the archives and found the SWI library I mentioned above. I?ll check during the weekend for the pixel and line drawers. Thanks again for your help!
<br/>
<br/>
@ Quirky: Thanks for telling me about gprof and how to use it. I?ll try it in the weekend and let you know about the results from the profiling tests. Do you have a binary file with a demo of your flat shaded 3D engine?
<br/>
<br/>
Thanks again for all your help!
<br/>
<br/>
--Nacho</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#53555 - DekuTree64 - Fri Sep 09, 2005 4:19 am</h4>
    <div class="postbody"><span class="postbody">Generally you'll want to do straight pointer arithmetic instead of function calls in your inner loops. Something like:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">u16 *lineBuffer = screen + yTop*SCREEN_WIDTH;
<br/>
u16 *lineBufferEnd = screen + yBottom*SCREEN_WIDTH;
<br/>
<br/>
while(lineBuffer &lt; lineBufferEnd)
<br/>
{
<br/>
    u16 *dest = lineBuffer + FIXED_TO_INT(xStart);
<br/>
    u16 *end = lineBuffer + FIXED_TO_INT(xEnd);
<br/>
    while (dest &lt; end)
<br/>
        *dest++ = color;
<br/>
<br/>
    xStart += xStartInc;
<br/>
    xEnd += xEndInc;
<br/>
<br/>
    lineBuffer += SCREEN_WIDTH;
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
<br/>
Oh, and you only need to divide once per triangle for affine texturing, not every scanline. The u and v gradients will (theoretically) always come out to be the same on each scanline.
<br/>
<br/>
Another nice thing about that is then you don't even need to interpolate the u/v values down the right side of the triangle, because they're not needed. You only need the left edge starting values, and the constant gradients to add after plotting each pixel.<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#53682 - Nacho - Sat Sep 10, 2005 4:23 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quirky wrote:</b></span></td> </tr> <tr> <td class="quote"> The code addresses for profiling are project depednent, take them from a map/objdump file.</td> </tr></table><span class="postbody">
<br/>
<br/>
How do I create the map/objdump file? I?ve been searching in the forum but all I couldn?t find the answer (there were many questions regarding the creation of a map file for nintendo ds, though). Can I determine those addresses with the memory viewer included in Visual Boy Advance?
<br/>
<br/>
Thanks in advance!
<br/>
<br/>
--Nacho</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#53694 - tepples - Sat Sep 10, 2005 6:36 pm</h4>
    <div class="postbody"><span class="postbody">The line of your batch file or makefile that calls objcopy will generally have the form 'arm-elf-objcopy -O binary game.elf game.gba'. Find the name of the elf file and then run
<br/>
<br/>
<span style="font-weight: bold">arm-elf-nm -n game.elf</span><br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#53708 - Nacho - Sat Sep 10, 2005 9:28 pm</h4>
    <div class="postbody"><span class="postbody">Tepples, thanks for replying. I?m a little bit lost with all this stuff so I?m going to bother you again with my questions. I?m using VHAM as a compiler toolchan so the elf file is automatically created whenever I compile the project. Unfortunately, the arm-elf-nm file is not included in VHAM?s installation but I managed to get it from DevKitAdvance. I ran the command <span style="font-weight: bold">arm-elf-nm -n Raster3D.elf</span> and it displayed a very long list of memory addresses and names but the problem is that I can only see the last part because Win32?s console allows me to scroll only a few lines above. How can I solve this? Is it possible to compile the project so that I can see the memory layout in Visual Boy Advance?
<br/>
<br/>
Thanks again for your help!
<br/>
<br/>
--Nacho</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#53726 - tepples - Sun Sep 11, 2005 7:31 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Nacho wrote:</b></span></td> </tr> <tr> <td class="quote">I ran the command <span style="font-weight: bold">arm-elf-nm -n Raster3D.elf</span> and it displayed a very long list of memory addresses and names but the problem is that I can only see the last part because Win32?s console allows me to scroll only a few lines above. How can I solve this?</td> </tr></table><span class="postbody">
<br/>
Read <a class="postlink" href="http://www.isu.edu/departments/comcom/unix/workshop/io.html" target="_blank">this page</a>, especially "Redirecting output".<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#53741 - Quirky - Sun Sep 11, 2005 11:09 am</h4>
    <div class="postbody"><span class="postbody">I use -Wl,-Map,game.map at link time to create the file game.map. It doesn't actually matter that much, just so long as you get your code that you want to profile in the range. You can probably make a decent guess from the size of your gba file:
<br/>
<br/>
ls -l myfile.gba | awk '{printf "0x%x\n",0x08000000+$5}'</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#53752 - Nacho - Sun Sep 11, 2005 3:35 pm</h4>
    <div class="postbody"><span class="postbody">tepples, thanks for the link. I redirected the output to a file named dump.out and found out that the upper and lower memory values are 0x08000218 and 0x0800A780.Then I ran gprof Raster3D.elf from the command prompt and got the following error message:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
BFD: Dwarf Error: Invalid or unhandled FORM value: 14.
<br/>
BFD: Dwarf Error: Invalid or unhandled FORM value: 14.
<br/>
3 [main] gprof 3012 handle_exceptions: Exception: STATUS_ACCESS_VIOLATION
<br/>
677 [main] gprof 3012 open_stackdumpfile: Dumping stack trace to gprof.exe.stackdump
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Maybe I haven't written the right addresses. Here's what I have done to find them so that you can point me out if I have done something wrong:
<br/>
<br/>
* I looked for main's address in dump.out:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
08000218 T main
<br/>
</td> </tr></table><span class="postbody">
<br/>
* I scrolled down the file till I found the last function from the last compiled file (which is vba.s):
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
0800a774 T vbalog
<br/>
0800a780 T ham_EmptyInt
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Are the addresses ok? I also get the following message from VBA whenever I try to run Raster3D.gba:
<br/>
<br/>
<span style="font-weight: bold">Unsupported BIOS function fe called from 0800a776. A BIOS file is needed in order to get the correct behaviour</span>
<br/>
<br/>
After that, I click the OK button and the emulation starts. Thanks again for all your help!!
<br/>
<br/>
--Nacho
<br/>
<br/>
EDIT: I think it's important to say that all the functions are in EWRAM.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#53767 - Quirky - Sun Sep 11, 2005 6:54 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Nacho wrote:</b></span></td> </tr> <tr> <td class="quote">tepples, thanks for the link. I redirected the output to a file named dump.out and found out that the upper and lower memory values are 0x08000218 and 0x0800A780.
<br/>
<br/>
EDIT: I think it's important to say that all the functions are in EWRAM.</td> </tr></table><span class="postbody">
<br/>
<br/>
You need to specify addresses in EWRAM for your profile. 0x02000000 to 0x02040000 ought to do it!
<br/>
<br/>
As for the errors: are you using devkitARM with gcc 4.0?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#53788 - Nacho - Sun Sep 11, 2005 11:31 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quirky wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
You need to specify addresses in EWRAM for your profile. 0x02000000 to 0x02040000 ought to do it!</td> </tr></table><span class="postbody">
<br/>
<br/>
Sorry, I made a mistake in my previous post. I?ve been reading the CowBite specs and found out that 0x08000000 is the beginning of the GAME PAK ROM area. I (wrongly) assumed that, by default, functions were automatically placed in EWRAM by gcc. Nonetheless, now I?m completely lost! Which parameters should I pass to monstartup()? The GAME PAK ROM area? Or should I pass EWRAM?
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quirky wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
As for the errors: are you using devkitARM with gcc 4.0?</td> </tr></table><span class="postbody">
<br/>
<br/>
I?m using VHAM, but only as a compiler toolchain. I downlaoded the latest release of devkitARM because I needed arm-elf-nm.exe.
<br/>
<br/>
Quirky, thanks again for your help!
<br/>
<br/>
--Nacho</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#53795 - tepples - Mon Sep 12, 2005 1:33 am</h4>
    <div class="postbody"><span class="postbody">Excuse me if I haven't understood the whole thread, but if you're trying to make a cart-based game, why exactly are you running code other than a savegame driver from EWRAM instead of ROM? Are you trying to make a multiboot version? Or are you trying to save battery, or allow for pak-swapping?<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#53800 - Nacho - Mon Sep 12, 2005 2:08 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tepples wrote:</b></span></td> </tr> <tr> <td class="quote">Excuse me if I haven't understood the whole thread, but if you're trying to make a cart-based game, why exactly are you running code other than a savegame driver from EWRAM instead of ROM? Are you trying to make a multiboot version? Or are you trying to save battery, or allow for pak-swapping?</td> </tr></table><span class="postbody">
<br/>
<br/>
No, no, I?m not trying to run the code from EWRAM. I had the wrong idea that the code that wasn?t placed in IWRAM went straight into EWRAM and that EWRAM began at 0x08000000. That is, I though that the program?s code could only be placed in IWRAM or EWRAM. After reading Cowbite?s specs I found out that I was wrong. Now, as I?ve stated in my last post, I would like to know which address range should I pass to monstartup() so that I can start profiling my code.
<br/>
<br/>
Thanks for all your help!
<br/>
<br/>
--Nacho</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#53808 - tepples - Mon Sep 12, 2005 3:27 am</h4>
    <div class="postbody"><span class="postbody">To catch all code running in ROM use 0x08000000-0x09FFFFFF.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#53809 - Nacho - Mon Sep 12, 2005 3:34 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tepples wrote:</b></span></td> </tr> <tr> <td class="quote">To catch all code running in ROM use 0x08000000-0x09FFFFFF.</td> </tr></table><span class="postbody">
<br/>
<br/>
I?ve tried it, but I get the same error when executing gprof. Do you mind if I send you the elf file?
<br/>
<br/>
--Nacho</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#53810 - tepples - Mon Sep 12, 2005 3:39 am</h4>
    <div class="postbody"><span class="postbody">I don't know anything about gprof, so please take your gprof questions somewhere else. When I want to profile something that runs in a tight loop, I use internal timers such as VCOUNT.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#53811 - Nacho - Mon Sep 12, 2005 3:52 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tepples wrote:</b></span></td> </tr> <tr> <td class="quote">I don't know anything about gprof, so please take your gprof questions somewhere else. When I want to profile something that runs in a tight loop, I use internal timers such as VCOUNT.</td> </tr></table><span class="postbody">
<br/>
<br/>
Nevermind, thanks anyway for all your help!
<br/>
<br/>
--Nacho</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#53892 - Nacho - Tue Sep 13, 2005 2:56 am</h4>
    <div class="postbody"><span class="postbody">DekuTree64: Seems I?ve been paying too much attention to gprof and I forgot to answer your post. Sorry for that.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>DekuTree64 wrote:</b></span></td> </tr> <tr> <td class="quote">Generally you'll want to do straight pointer arithmetic instead of function calls in your inner loops.</td> </tr></table><span class="postbody">
<br/>
<br/>
Yes, I?m doing pointer arithmetics in the affine texture mapper, but is a loop faster than a call to memset()?
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>DekuTree64 wrote:</b></span></td> </tr> <tr> <td class="quote">Oh, and you only need to divide once per triangle for affine texturing, not every scanline. The u and v gradients will (theoretically) always come out to be the same on each scanline.</td> </tr></table><span class="postbody">
<br/>
<br/>
Yes, I?m only performing divisions at the very beginning of the function to find the gradients. The only operation performed inside the loop is addition.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>DekuTree64 wrote:</b></span></td> </tr> <tr> <td class="quote">Another nice thing about that is then you don't even need to interpolate the u/v values down the right side of the triangle, because they're not needed. You only need the left edge starting values, and the constant gradients to add after plotting each pixel.</td> </tr></table><span class="postbody">
<br/>
<br/>
That?s a cool optimization! I?ll rewrite the renderer using that optimization whenever I get the time!
<br/>
<br/>
Thanks again for your input! Hah, not only you help me out at gamedev.net, but also here =P
<br/>
<br/>
--Nacho</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#53997 - kusma - Wed Sep 14, 2005 1:01 pm</h4>
    <div class="postbody"><span class="postbody">a couple of easy yet effective optimizations/cheats here... not sure how you do things, but my routines got a nice speedup from these.
<br/>
<br/>
- texture-map in 2x1, but rasterize 1x1  ;)
<br/>
- interpolate u and v in one single register, in the format UUuuVVvv
<br/>
 that way you can reorder them to actual texture-offsets by doing (uv &amp; 0xFF00) | (uv &gt;&gt; 24). this compiles to two instructions and only one addition. there are some minor issues with u overflowing into v on wrapping (and oposite), but as this is only one fractional-bit, this is not noticable (hey, it's one 256th of a texel).
<br/>
- unroll your filling-loop heavily. a duffs device is nice to speed things up while still having dynamic fill-length. something like this:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#define ITERATION /* the code to fill one pixel here*/
<br/>
<br/>
register unsigned c = counter &gt;&gt; 4;
<br/>
switch (counter&amp;15)
<br/>
{
<br/>
    do {
<br/>
        ITERATION;
<br/>
        case 15: ITERATION;
<br/>
        case 14: ITERATION;
<br/>
        case 13: ITERATION;
<br/>
        case 12: ITERATION;
<br/>
        case 11: ITERATION;
<br/>
        case 10: ITERATION;
<br/>
        case 9:  ITERATION;
<br/>
        case 8:  ITERATION;
<br/>
        case 7:  ITERATION;
<br/>
        case 6:  ITERATION;
<br/>
        case 5:  ITERATION;
<br/>
        case 4:  ITERATION;
<br/>
        case 3:  ITERATION;
<br/>
        case 2:  ITERATION;
<br/>
        case 1:  ITERATION;
<br/>
        case 0:;
<br/>
    } while (c--);
<br/>
}
<br/>
#undef ITERATION
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#54073 - yamaneko - Thu Sep 15, 2005 10:04 am</h4>
    <div class="postbody"><span class="postbody">kusma , with this texture rootine. How many polygon, filling the screen in mod4, can you display at 30 fps?<br/>_________________<br/>山猫</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#54076 - kusma - Thu Sep 15, 2005 10:47 am</h4>
    <div class="postbody"><span class="postbody">that i'm unsure of. it depends on a lot of factors, like polygon size and width. i can benchmark my filler, but i dont have time for that now ;)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#54564 - Nacho - Tue Sep 20, 2005 1:18 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>kusma wrote:</b></span></td> </tr> <tr> <td class="quote">- texture-map in 2x1, but rasterize 1x1  ;)</td> </tr></table><span class="postbody">
<br/>
<br/>
You mean I should plot every texel twice so that the inner loop performs fewer calculations?
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>kusma wrote:</b></span></td> </tr> <tr> <td class="quote">- unroll your filling-loop heavily. a duffs device is nice to speed things up while still having dynamic fill-length.</td> </tr></table><span class="postbody">
<br/>
<br/>
Great! Thanks! I even didn?t know about the existance of this techinique. I?ll look into it, thanks!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#54661 - kusma - Wed Sep 21, 2005 11:11 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Nacho wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
You mean I should plot every texel twice so that the inner loop performs fewer calculations?
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
well, when you do an 8bit write to vram, it ends up as a 16bit write with both high and low byte set to the 8bit value you wrote. abusing this behavour is a nice way to draw two pixels at the same time in mode4 ;)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#54769 - Nacho - Thu Sep 22, 2005 1:34 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>kusma wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
well, when you do an 8bit write to vram, it ends up as a 16bit write with both high and low byte set to the 8bit value you wrote. abusing this behavour is a nice way to draw two pixels at the same time in mode4 ;)</td> </tr></table><span class="postbody">
<br/>
<br/>
Abusive, yet effective! :) Thanks for the trick!
<br/>
<br/>
I?ve changed my filler?s inner loop (mode 4) so that it makes use of Duff?s device. Here?s the new version:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
      for(iLoopY=iY1;iLoopY&lt;=iY3;iLoopY++,lpDestBuffer=lpAux) {
<br/>
            iCurrX = iXS = FIXP1616_WHOLE_PART(fixpXS);
<br/>
            iXE = FIXP1616_WHOLE_PART(fixpXE);
<br/>
            
<br/>
            lpAux = lpDestBuffer;
<br/>
            lpDestBuffer += (iXS&gt;&gt;1);
<br/>
            iVar = iXE - iXS + 1;
<br/>
            n = (iVar + 7) &gt;&gt; 3;
<br/>
            
<br/>
            if( (IS_ODD(iCurrX) &amp;&amp; IS_ODD(iVar)) ||
<br/>
                (IS_EVEN(iCurrX) &amp;&amp; IS_EVEN(iVar)) ) {
<br/>
                switch((iVar) &amp; 0x07) {
<br/>
                case 0: do{ PUT_EVEN_PIXEL_M4(lpDestBuffer,u8ColorEntry);
<br/>
                case 7:     PUT_ODD_PIXEL_M4(lpDestBuffer,u8ColorEntry);
<br/>
                case 6:     PUT_EVEN_PIXEL_M4(lpDestBuffer,u8ColorEntry);
<br/>
                case 5:     PUT_ODD_PIXEL_M4(lpDestBuffer,u8ColorEntry);
<br/>
                case 4:     PUT_EVEN_PIXEL_M4(lpDestBuffer,u8ColorEntry);
<br/>
                case 3:     PUT_ODD_PIXEL_M4(lpDestBuffer,u8ColorEntry);
<br/>
                case 2:     PUT_EVEN_PIXEL_M4(lpDestBuffer,u8ColorEntry);
<br/>
                case 1:     PUT_ODD_PIXEL_M4(lpDestBuffer,u8ColorEntry);
<br/>
                    } while(--n&gt;0);
<br/>
                } /* End switch */
<br/>
            } /* End if */
<br/>
            else {
<br/>
                switch((iVar) &amp; 0x07) {
<br/>
                case 0: do{ PUT_ODD_PIXEL_M4(lpDestBuffer,u8ColorEntry);
<br/>
                case 7:     PUT_EVEN_PIXEL_M4(lpDestBuffer,u8ColorEntry);
<br/>
                case 6:     PUT_ODD_PIXEL_M4(lpDestBuffer,u8ColorEntry);
<br/>
                case 5:     PUT_EVEN_PIXEL_M4(lpDestBuffer,u8ColorEntry);
<br/>
                case 4:     PUT_ODD_PIXEL_M4(lpDestBuffer,u8ColorEntry);
<br/>
                case 3:     PUT_EVEN_PIXEL_M4(lpDestBuffer,u8ColorEntry);
<br/>
                case 2:     PUT_ODD_PIXEL_M4(lpDestBuffer,u8ColorEntry);
<br/>
                case 1:     PUT_EVEN_PIXEL_M4(lpDestBuffer,u8ColorEntry);
<br/>
                    } while(--n&gt;0);
<br/>
                } /* End switch */
<br/>
            } /* End else */
<br/>
         fixpXS += fixpDXLeft;
<br/>
         fixpXE += fixpDXRight;
<br/>
         lpAux += u8ScreenWidthDiv2;
<br/>
      } /* End for iLoopY */
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#define PUT_EVEN_PIXEL_M4(lpDestBuffer,u8ColorEntry) \
<br/>
    *lpDestBuffer |= u8ColorEntry;
<br/>
#define PUT_ODD_PIXEL_M4(lpDestBuffer,u8ColorEntry) \
<br/>
    *(lpDestBuffer++) |= (u8ColorEntry &lt;&lt; 8);
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
As you can see from the previous snippet, I divided the code in two cases, depending on whether the first pixel to be plotted is even or odd. Is it possible to merge both cases into one? I?m asking because I spent a few hours thinking other approaches but I couldn?t find a way to do it. Thanks!
<br/>
<br/>
--Nacho</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#54797 - Miked0801 - Thu Sep 22, 2005 6:09 pm</h4>
    <div class="postbody"><span class="postbody">Here:
<br/>
<br/>
fillLine()
<br/>
if(firstPixelAddr &amp; 0x01)
<br/>
{
<br/>
    PUT_ODD_PIXEL
<br/>
}
<br/>
<br/>
while(numtofill &gt;&gt; 1)
<br/>
{
<br/>
    write both pixels
<br/>
}
<br/>
<br/>
if(pixelAddr &amp; 0x01)
<br/>
{
<br/>
    writeLast Pixel;
<br/>
}
<br/>
}</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#54853 - Nacho - Fri Sep 23, 2005 2:19 am</h4>
    <div class="postbody"><span class="postbody">Miked0801, thanks for your post but I?m not sure how your pseudocode solves the problem I mentioned. I had to write two different cases since the Duff?s device cares not only if the first pixel is even or odd but also cares about the remaining number of pixels. Do you mind clarifying your pseucode a bit? Thanks again!
<br/>
<br/>
--Nacho</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#54911 - kusma - Fri Sep 23, 2005 3:50 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Nacho wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#define PUT_EVEN_PIXEL_M4(lpDestBuffer,u8ColorEntry) \
<br/>
    *lpDestBuffer |= u8ColorEntry;
<br/>
#define PUT_ODD_PIXEL_M4(lpDestBuffer,u8ColorEntry) \
<br/>
    *(lpDestBuffer++) |= (u8ColorEntry &lt;&lt; 8);
<br/>
</td> </tr></table><span class="postbody">
<br/>
</span></td> </tr></table><span class="postbody">
<br/>
<br/>
this looks like flatshading to me. in that case, i'd rather do 32bit writes direcly.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#54918 - Nacho - Fri Sep 23, 2005 5:20 pm</h4>
    <div class="postbody"><span class="postbody">It is flatshading, indeed! But if I do 32 bit writes, how do I take into account in a clean manner those special cases where the fill length is less than 4 pixels?
<br/>
<br/>
--Nacho
<br/>
<br/>
Edit: I?ve checked my previous posts and found out that I didn?t say I was referring to the flat shader. Sorry :(</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#54920 - Miked0801 - Fri Sep 23, 2005 5:38 pm</h4>
    <div class="postbody"><span class="postbody">if(VramAddr &amp; 0x03)
<br/>
{
<br/>
    // Write individual pixels
<br/>
}
<br/>
else if(remaining run length is &gt;= 4)
<br/>
{
<br/>
    // Write pixels in groups of 4.
<br/>
}
<br/>
else
<br/>
{
<br/>
  // Write last pixels
<br/>
}
<br/>
<br/>
For smaller fills (say less than about 8 pixels across) filling in groups of 2 will be more efficient.  We left ours at 2 pixels as we had lots of smaller polys as opposed to a few large ones.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#55311 - Nacho - Tue Sep 27, 2005 6:04 pm</h4>
    <div class="postbody"><span class="postbody">Ok, I?ll try it during the weekend (this is my mid-term exams? week) and let you know about the results.
<br/>
<br/>
Thanks again for your input!
<br/>
<br/>
--Nacho</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#56392 - Nacho - Sat Oct 08, 2005 12:32 pm</h4>
    <div class="postbody"><span class="postbody">I?ve modified my filler to take advantage of 32 bits writes. I?m posting the inner loop here in case somebody needs it someday:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
      for(iLoopY=iY1;iLoopY&lt;=iY3;iLoopY++,lpusDestBuffer=lpusAuxBuffer,
<br/>
            lpuiDestBuffer=lpuiAuxBuffer) {
<br/>
<br/>
            iXS = FIXP1616_WHOLE_PART(fixpXS);
<br/>
            iXE = FIXP1616_WHOLE_PART(fixpXE);
<br/>
            uiNPixelsToWrite = iXE - iXS + 1;
<br/>
<br/>
            if(MOD_4(iXS)) {
<br/>
                lpusDestBuffer += (iXS&gt;&gt;1);
<br/>
                do {
<br/>
                    PUT_PIXEL_M4(lpusDestBuffer,u8ColorEntry,iXS);
<br/>
                    if(IS_ODD(iXS)) lpusDestBuffer++;
<br/>
                    iXS++; uiNPixelsToWrite--;
<br/>
                } while(uiNPixelsToWrite &amp;&amp; MOD_4(iXS));
<br/>
            } /* End if */
<br/>
<br/>
            if(uiNPixelsToWrite &gt;= 4) {
<br/>
                lpuiDestBuffer += (iXS&gt;&gt;2);
<br/>
                do {
<br/>
                    *lpuiDestBuffer++ = uiColorEntry;
<br/>
                    iXS += 4; uiNPixelsToWrite -= 4;
<br/>
                } while(uiNPixelsToWrite &gt;= 4);
<br/>
            } /* End if */
<br/>
<br/>
            if(uiNPixelsToWrite) {
<br/>
                lpusDestBuffer = lpusAuxBuffer + (iXS&gt;&gt;1);
<br/>
                do {
<br/>
                    PUT_PIXEL_M4(lpusDestBuffer,u8ColorEntry,iXS);
<br/>
                    if(IS_ODD(iXS)) lpusDestBuffer++;
<br/>
                    iXS++; uiNPixelsToWrite--;
<br/>
                } while(uiNPixelsToWrite);
<br/>
            } /* End if */
<br/>
<br/>
         fixpXS += fixpDXLeft;
<br/>
         fixpXE += fixpDXRight;
<br/>
         lpusAuxBuffer += uiScreenWidthDiv2;
<br/>
            lpuiAuxBuffer += uiScreenWidthDiv4;
<br/>
      } /* End for iLoopY */
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
The macros are defined as:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#define PUT_PIXEL_M4(lpusDestBuffer,u8ColorEntry,x) \
<br/>
    *lpusDestBuffer |= IS_EVEN(x) ? (u8ColorEntry) : ((u8ColorEntry) &lt;&lt; 8);
<br/>
#define MOD_4(a)             ((a) &amp; 0x3)
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Thanks again for all your help, I?m learning a lot here!
<br/>
<br/>
--Nacho</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#56669 - Miked0801 - Mon Oct 10, 2005 3:47 pm</h4>
    <div class="postbody"><span class="postbody">What exactly is this code trying to do?  There's no comments and it's playing with so many different variable names that I am a bit confused...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#56744 - Nacho - Tue Oct 11, 2005 12:58 am</h4>
    <div class="postbody"><span class="postbody">Okay, I?ll clarify a bit. The code above is the inner loop of my triangle flat filler function and it rasterizes flat bottom triangles.
<br/>
<br/>
* iY1 and iY3 specify the lines where the rasterization begins and ends, respectively.
<br/>
* lpusDestBuffer and lpuiDestBuffer are used for 16 bit and 32 bit writes, respectively. lpusAuxBuffer and lpuiAuxBuffer store the beginning of the current line that is being rasterized (they?re incremented at the bottom of the loop?s body).
<br/>
* iXS and iXE specify in which column the rasterization begins and ends, respectively. The data is stored in fixed point format in fixpXS and fixpXE and their integral parts are retrieved by FIXP1616_WHOLE_PART().
<br/>
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
            if(MOD_4(iXS)) {
<br/>
                lpusDestBuffer += (iXS&gt;&gt;1);
<br/>
                do {
<br/>
                    PUT_PIXEL_M4(lpusDestBuffer,u8ColorEntry,iXS);
<br/>
                    if(IS_ODD(iXS)) lpusDestBuffer++;
<br/>
                    iXS++; uiNPixelsToWrite--;
<br/>
                } while(uiNPixelsToWrite &amp;&amp; MOD_4(iXS));
<br/>
            } /* End if */
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
The previous snippet deals with those lines that don?t start in a "multiple of 4" pixel. The 16 bit writes pointer is used.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
            if(uiNPixelsToWrite &gt;= 4) {
<br/>
                lpuiDestBuffer += (iXS&gt;&gt;2);
<br/>
                do {
<br/>
                    *lpuiDestBuffer++ = uiColorEntry;
<br/>
                    iXS += 4; uiNPixelsToWrite -= 4;
<br/>
                } while(uiNPixelsToWrite &gt;= 4);
<br/>
            } /* End if */
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
The previous piece of code writes 4 bytes at the time as long as the number of pixels to write is equal or more than 4.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
            if(uiNPixelsToWrite) {
<br/>
                lpusDestBuffer = lpusAuxBuffer + (iXS&gt;&gt;1);
<br/>
                do {
<br/>
                    PUT_PIXEL_M4(lpusDestBuffer,u8ColorEntry,iXS);
<br/>
                    if(IS_ODD(iXS)) lpusDestBuffer++;
<br/>
                    iXS++; uiNPixelsToWrite--;
<br/>
                } while(uiNPixelsToWrite);
<br/>
            } /* End if */
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
This snippet deals with the remaining pixels (3 pixels at most).
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
<br/>
         fixpXS += fixpDXLeft;
<br/>
         fixpXE += fixpDXRight;
<br/>
         lpusAuxBuffer += uiScreenWidthDiv2;
<br/>
            lpuiAuxBuffer += uiScreenWidthDiv4;
<br/>
      } /* End for iLoopY */
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
In this last snippet the start and finish points are incremented with the horizontal gradient and the screen pointers are moved to the following scanline.
<br/>
<br/>
Hope this has clarified things a bit!
<br/>
<br/>
--Nacho</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
