<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>relocation truncated to fit: R_ARM_THM_CALL against symbol.. - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>C/C++ > relocation truncated to fit: R_ARM_THM_CALL against symbol..</h2>
<div id="posts">
<div class="post">
    <h4>#132479 - BrainSlugs83 - Wed Jun 27, 2007 5:01 am</h4>
    <div class="postbody"><span class="postbody">I defined a function to be in IWRAM that I want to run fast by declaring it like this: CODE_IN_IWRAM u16 GetSpriteW(u16 SIdx)
<br/>
<br/>
where CODE_IN_IWRAM is defined as:
<br/>
#define CODE_IN_IWRAM __attribute__((section(".iwram"), long_call))
<br/>
<br/>
but I get this warning (and no output file!):
<br/>
relocation truncated to fit: R_ARM_THM_CALL against symbol `GetSpriteW(unsigned short)' defined in .iwram section in ccfsD2Ij.o
<br/>
<br/>
how can this be fixed?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#132482 - Ant6n - Wed Jun 27, 2007 6:04 am</h4>
    <div class="postbody"><span class="postbody">maybe your iwram is full? do you have tons of stuff there?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#132486 - BrainSlugs83 - Wed Jun 27, 2007 7:11 am</h4>
    <div class="postbody"><span class="postbody">That was the first time I ever tried to put anything there, it was two functions that were both pretty small (&lt;20 lines of C), and they were linker errors -- how would the linker know if I was putting things in IWRAM at runtime anyway?  (but no, I put nothing else in IWRAM.)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#132488 - chishm - Wed Jun 27, 2007 7:27 am</h4>
    <div class="postbody"><span class="postbody">Make sure you put IWRAM code in a separate source file to normal code.<br/>_________________<br/><a class="postlink" href="http://chishm.drunkencoders.com" target="_blank">http://chishm.drunkencoders.com</a>
<br/>
<a class="postlink" href="http://dldi.drunkencoders.com" target="_blank">http://dldi.drunkencoders.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#132489 - BrainSlugs83 - Wed Jun 27, 2007 7:40 am</h4>
    <div class="postbody"><span class="postbody">what's the point of the section attribute if it needs to be in another file?  If it's in another file can't you just pass different compiler args to make it arm code anyway?
<br/>
<br/>
I suppose it makes sense that you would need to compile it to ARM, and put it in IWRAM, as opposed to doing just one or the other... it's too bad there's not a simpler way to do it.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#132496 - Cearn - Wed Jun 27, 2007 9:01 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>BrainSlug83 wrote:</b></span></td> </tr> <tr> <td class="quote">-- how would the linker know if I was putting things in IWRAM at runtime anyway? (but no, I put nothing else in IWRAM.)</td> </tr></table><span class="postbody">All non-const global variables are put in IWRAM unless you takes steps against it. It may be fuller than you know.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>BrainSlugs83 wrote:</b></span></td> </tr> <tr> <td class="quote">what's the point of the section attribute if it needs to be in another file?  If it's in another file can't you just pass different compiler args to make it arm code anyway?
<br/>
<br/>
I suppose it makes sense that you would need to compile it to ARM, and put it in IWRAM, as opposed to doing just one or the other... it's too bad there's not a simpler way to do it.</td> </tr></table><span class="postbody">The attributes are still necessary for the declaration. The caller needs to know that it needs to use a long_call to reach it. 
<br/>
<br/>
The long_call bit is the problem, by the way, not the .iwram attribute. There are two kinds of function calls, 'near' and 'far'. Near-calls can be done with a simple <span style="font-style: italic">bl</span> (branch with link) instruction. Far-calls are outside the offset range of <span style="font-style: italic">bl</span>, and have to be performed by getting the address of the function first and then using <span style="font-style: italic">bx</span> (branch with exchange). The trouble is that GCC assumes that all functions within a file are in the same section and will always use <span style="font-style: italic">bl</span>. This can be overcome by using the <span style="font-weight: bold">-mlong-calls</span> compiler option, which makes all calls far-calls. IIRC, far-calls are implemented as a double-branch, so it will make function calling a little slower though.
<br/>
<br/>
Additionally, is the purpose of GetSpriteW is to get the sprite's width? If so, it's better to make it an inline function instead of an ARM/IWRAM function. The overhead of the call alone is probably greater than the body of the function; especially if it's used multiple times in one function.
<br/>
<br/>
<span style="font-size: 9px; line-height: normal">Oh, and don't use u16 as local variable/parameter types. Use int/u32, unless you really want extra instructions for every data operation you do with them.</span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#132499 - BrainSlugs83 - Wed Jun 27, 2007 9:10 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">-mlong-calls</td> </tr></table><span class="postbody"> sounds nasty, I'm avoiding this one at all costs.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Additionally, is the purpose of GetSpriteW is to get the sprite's width?</td> </tr></table><span class="postbody"> The purpose isn't important -- I just wanted to know how to put a function into IWRAM and chose that one -- and yes, that's what GetSpriteW does -- I'm replacing it with a const LUT eventually though.
<br/>
<br/>
You guys seem to be awefully sure that my IWRAM is full, does that message only show up when IWRAM is full, or could it mean something else?  I'm pretty sure I'm using less than 2KB of global variables, and IWRAM is 32KB big, no?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#132506 - Chano Marrano - Wed Jun 27, 2007 10:31 am</h4>
    <div class="postbody"><span class="postbody"><span style="font-style: italic">Sometimes</span>, when you call an IWRAM function from an EWRAM function, the "relocation truncated to fit" error appears. Move the EWRAM function to IWRAM and you should have no more problems.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#132511 - Cearn - Wed Jun 27, 2007 11:15 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>BrainSlugs83 wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">-mlong-calls</td> </tr></table><span class="postbody"> sounds nasty, I'm avoiding this one at all costs.</span></td> </tr></table><span class="postbody">
<br/>
If you want to be able to call functions from IWRAM, you will need this one.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>BrainSlugs83 wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Additionally, is the purpose of GetSpriteW is to get the sprite's width?</td> </tr></table><span class="postbody"> The purpose isn't important -- I just wanted to know how to put a function into IWRAM and chose that one -- and yes, that's what GetSpriteW does -- I'm replacing it with a const LUT eventually though.</span></td> </tr></table><span class="postbody">
<br/>
Fair enough.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">//! Get object's sizes as a byte array
<br/>
static inline const u8 *obj_get_size(OBJ_ATTR *obj)
<br/>
{   return oam_sizes[obj-&gt;attr0&gt;&gt;14][obj-&gt;attr1&gt;&gt;14];   }
<br/>
<br/>
//! Get object's width
<br/>
static inline int obj_get_width(OBJ_ATTR *obj)
<br/>
{   return obj_get_size(obj)[0];                  }
<br/>
   
<br/>
//! Gets object's height
<br/>
static inline int obj_get_height(OBJ_ATTR *obj)
<br/>
{   return obj_get_size(obj)[1];                  }
<br/>
<br/>
<br/>
const u8 oam_sizes[3][4][2]=
<br/>
{
<br/>
   { { 8, 8}, {16,16}, {32,32}, {64,64} }, 
<br/>
   { {16, 8}, {32, 8}, {32,16}, {64,32} },
<br/>
   { { 8,16}, { 8,32}, {16,32}, {32,64} },
<br/>
};
<br/>
</td> </tr></table><span class="postbody">
<br/>
:)
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>BrainSlugs83 wrote:</b></span></td> </tr> <tr> <td class="quote">You guys seem to be awfully sure that my IWRAM is full, does that message only show up when IWRAM is full, or could it mean something else?  I'm pretty sure I'm using less than 2KB of global variables, and IWRAM is 32KB big, no?</td> </tr></table><span class="postbody">
<br/>
It's not full. But my point was that it's not empty either. The real issue is the long_call thing. The long_call attribute doesn't work for functions within the same file. 
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">// --- File foo.c --------------------------------
<br/>
CODE_IN_IWRAM int ifunc()
<br/>
{
<br/>
    return 42;
<br/>
}
<br/>
<br/>
int rfuncA()
<br/>
{
<br/>
    return ifunc();
<br/>
}
<br/>
<br/>
<br/>
// --- File bar.c --------------------------------
<br/>
<br/>
CODE_IN_IWRAM int ifunc();
<br/>
<br/>
int rfuncB()
<br/>
{
<br/>
    return ifunc();
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
The call from rfuncA fails. The call from rfuncB works fine. The key is that calls between sections should not be in the same file.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#132581 - BrainSlugs83 - Wed Jun 27, 2007 10:50 pm</h4>
    <div class="postbody"><span class="postbody">Thanks, it's starting to make sense now.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
