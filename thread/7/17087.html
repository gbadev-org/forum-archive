<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>malloc: array of pointers - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>C/C++ > malloc: array of pointers</h2>
<div id="posts">
<div class="post">
    <h4>#172305 - Kensai - Fri Jan 29, 2010 9:56 pm</h4>
    <div class="postbody"><span class="postbody">I have to malloc an array of TYPE pointers. Is the following command okay?
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">TYPE** arrayOfPointers = (TYPE**)malloc(numberOfElements*sizeof(TYPE*));</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#172307 - Dwedit - Fri Jan 29, 2010 11:59 pm</h4>
    <div class="postbody"><span class="postbody">Looks good.<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#172405 - ninjalj - Fri Feb 05, 2010 1:00 am</h4>
    <div class="postbody"><span class="postbody">Since you're doing a multiply, I'd recommend calloc, to make good habits. (calloc usually takes care of integer overflows, given a good implementation).</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#172410 - sajiimori - Fri Feb 05, 2010 1:55 am</h4>
    <div class="postbody"><span class="postbody">You mean if you're allocating more than 4 gigabytes?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#172411 - ninjalj - Fri Feb 05, 2010 2:11 am</h4>
    <div class="postbody"><span class="postbody">Yes. For instance, if some day you work on a project where either nelem or elsize are user controlled.
<br/>
<br/>
Just to be clearer: if you _think_ you're allocating nelem*elsize, but in fact you're allocating (nelem*elsize) % SIZE_MAX, leading to DoS or maybe even arbitrary code execution.
<br/>
<br/>
As I said, I only mentioned it to create good habits for future projects.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#172418 - elwing - Fri Feb 05, 2010 8:07 am</h4>
    <div class="postbody"><span class="postbody">I also find calloc clearer when reading the code... it's easier to see that you allocate an array and not just a chunk of memory. but I doubt it change much... ido even think that some platforms possible have that calloc defined as:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#define calloc(a,b) malloc(a*b)</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#172429 - sajiimori - Fri Feb 05, 2010 8:42 pm</h4>
    <div class="postbody"><span class="postbody">calloc initializes the array to 0, which makes me wonder: If you're allocating a 4 GB buffer, shouldn't you take a moment to consider whether you really want the kernel to swap the whole thing in, rather than being in the habit of swapping it all in by default?
<br/>
<br/>
I haven't done much on platforms with virtual memory, so maybe I'm misunderstanding something.
<br/>
<br/>
For what it's worth, this isn't an argument in favor of malloc.  If anything, I'd say neither of them is particularly safe (where "safe" means I'm unlikely to screw it up, and I can look back later and easily determine whether I screwed it up).</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#172432 - kusma - Fri Feb 05, 2010 10:31 pm</h4>
    <div class="postbody"><span class="postbody">Claiming that calloc is safer because of integer overflow on GBAdev.org is just insane. The GBA has 256k of memory, so there's no way the multiplication overflow in reality. Worst case is a DS, where there's 4 megs of RAM. That leaves 20 bits of head-room.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#172435 - Dwedit - Sat Feb 06, 2010 12:21 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>kusma wrote:</b></span></td> </tr> <tr> <td class="quote">Claiming that calloc is safer because of integer overflow on GBAdev.org is just insane. The GBA has 256k of memory, so there's no way the multiplication overflow in reality. Worst case is a DS, where there's 4 megs of RAM. That leaves 20 bits of head-room.</td> </tr></table><span class="postbody">
<br/>
<br/>
I was waiting for someone to point this out.<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#172441 - elwing - Sat Feb 06, 2010 11:38 am</h4>
    <div class="postbody"><span class="postbody">yep, but my argument on calloc being easier to read as "allocating an array" stands :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#172444 - kusma - Sat Feb 06, 2010 1:08 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>sajiimori wrote:</b></span></td> </tr> <tr> <td class="quote">calloc initializes the array to 0, which makes me wonder: If you're allocating a 4 GB buffer, shouldn't you take a moment to consider whether you really want the kernel to swap the whole thing in, rather than being in the habit of swapping it all in by default?
<br/>
<br/>
I haven't done much on platforms with virtual memory, so maybe I'm misunderstanding something.</td> </tr></table><span class="postbody">
<br/>
In THEORY, a calloc-implementation on a platform with an MMU can initialize one page of zeroed out data, and set up all pages to point to the same page with copy-on-write enabled. In reality I don't think there's any widely-used implementations that actually does this.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#172445 - kusma - Sat Feb 06, 2010 1:12 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>elwing wrote:</b></span></td> </tr> <tr> <td class="quote">yep, but my argument on calloc being easier to read as "allocating an array" stands :)</td> </tr></table><span class="postbody">
<br/>
That's not as much an argument as it is a personal preference. I personally think "hmm, why does this array need to be zero-initialized?" when I read code with calloc. So unless the array needs to be zero-initialized, I'm in favor of malloc. "p=calloc(...)" is certanly a tad cleaner than "p=malloc(...); memset(p, 0, ...);".</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#172449 - sajiimori - Sat Feb 06, 2010 8:44 pm</h4>
    <div class="postbody"><span class="postbody">This thread is great -- the actual question was answered so quickly that we can derail it with abandon.  For instance:
<br/>
<br/>
You know what's even easier to read?
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">TYPE* p = new TYPE[numberOfElements];
<br/>
</td> </tr></table><span class="postbody">
<br/>
<span style="font-style: italic">*waits for flamewar*</span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#172452 - ritz - Sun Feb 07, 2010 2:26 am</h4>
    <div class="postbody"><span class="postbody">Or, something like: I like to free up my memory with a lot of beer :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#172465 - Drovor - Mon Feb 08, 2010 4:46 pm</h4>
    <div class="postbody"><span class="postbody">You can have the best of both worlds with placement new....
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
 TYPE* array= (TYPE*) malloc ( sizeof(TYPE) * numberOfElements );
<br/>
 TYPE *t = new (&amp;array[count++]) TYPE( );
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#172468 - sajiimori - Mon Feb 08, 2010 7:31 pm</h4>
    <div class="postbody"><span class="postbody">Heck yeah, that was the most readable and safe example yet.  It reminds of a song, that goes something like:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">std::vector v;
<br/>
v.reserve(numberOfElements);
<br/>
v.push_back(TYPE());</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#172470 - Miked0801 - Mon Feb 08, 2010 10:32 pm</h4>
    <div class="postbody"><span class="postbody">TYPE *array = (TYPE *)0x00000000;
<br/>
<br/>
There - all the space you want :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#172472 - Dwedit - Mon Feb 08, 2010 10:49 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Miked0801 wrote:</b></span></td> </tr> <tr> <td class="quote">TYPE *array = (TYPE *)0x00000000;
<br/>
<br/>
There - all the space you want :)</td> </tr></table><span class="postbody">
<br/>
I tried that, but NO$GBA keeps giving me errors about writing to readonly memory.<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#172473 - sajiimori - Tue Feb 09, 2010 1:51 am</h4>
    <div class="postbody"><span class="postbody">Indeed -- slight correction:
<br/>
<br/>
<span style="font-weight: bold">const</span> TYPE *array = (TYPE *)0x00000000;</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#172492 - Miked0801 - Tue Feb 09, 2010 7:22 pm</h4>
    <div class="postbody"><span class="postbody">TYPE *array = (TYPE *)random();
<br/>
<br/>
;)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#172495 - ritz - Tue Feb 09, 2010 7:42 pm</h4>
    <div class="postbody"><span class="postbody">I hope some new guy doesn't come here looking for code examples on allocating memory. Either a post will appear in the next few days wanting help figuring out their horribly failing program... or they'll just throw in the towel forever :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#172499 - sajiimori - Tue Feb 09, 2010 11:48 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">try
<br/>
{
<br/>
  return allocateMemory();
<br/>
}
<br/>
catch(const Towel&amp; t)
<br/>
{
<br/>
  std::cerr &lt;&lt; "Don't stop believin'!" &lt;&lt; std::endl;
<br/>
  return (void*)std::rand();
<br/>
}</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#172523 - Miked0801 - Wed Feb 10, 2010 8:09 pm</h4>
    <div class="postbody"><span class="postbody">lol - ftw.
<br/>
<br/>
I can't compete with that allocator - best ever.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
