<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>atoi() / string to integer / reading from a battery save - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>C/C++ > atoi() / string to integer / reading from a battery save</h2>
<div id="posts">
<div class="post">
    <h4>#75890 - phoenixj91 - Thu Mar 16, 2006 9:58 pm</h4>
    <div class="postbody"><span class="postbody">I'm writing a simple battery save function for my game. All I need to do is save an integer (hiscore) to SRAM on gameover and read that same integer back when the game initially starts.
<br/>
I have no trouble writing the score to SRAM, the sav file VBA looks fine when I open it in a hex editor. Loading is another issue, however. I'm pretty sure that I'm getting my data from SRAM, but it's not converting into an integer properly. I end up with the same number no matter what the integer is - 10944.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
int LoadInt(u16 offset)
<br/>
{
<br/>
   int  i, temp=0;
<br/>
   char string[7];
<br/>
<br/>
   for(i = 0; i != 7; i++)
<br/>
   {
<br/>
      string[i] = *(u8 *)(SRAM + offset + i);
<br/>
                                temp=(temp*10)+((int)string[i]-48);
<br/>
   }
<br/>
<br/>
   return temp;
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
This function originally used the atoi() function to convert string[] to an integer. I can't afford to include that library in my project, though. So instead I do it on the fly - multiply a temporary number by 10, and adding the individual digits in. The 48 is to compensate for ASCII codes, since 0's ASCII code is 48.
<br/>
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
void SaveInt(u16 offset, int value)
<br/>
{
<br/>
   //Looping variable
<br/>
   int i;
<br/>
   
<br/>
   //Temp string
<br/>
   char string[7];
<br/>
<br/>
   posprintf(string, "%d", value);
<br/>
<br/>
   for(i=0; i &lt; 32768; i++)
<br/>
   {
<br/>
      if(string[i] == NULL)
<br/>
      {
<br/>
         break;
<br/>
      }
<br/>
<br/>
      *(u8 *)(SRAM + offset + i) = string[i];
<br/>
   }
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
My save function, just for completeness.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#75909 - sajiimori - Thu Mar 16, 2006 11:12 pm</h4>
    <div class="postbody"><span class="postbody">I haven't read your code, but why don't you just write the number directly instead of encoding it as a string and decoding it later?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#75914 - phoenixj91 - Thu Mar 16, 2006 11:31 pm</h4>
    <div class="postbody"><span class="postbody">Solved the problem, the loop didn't terminate on a null character but kept going till it hit 7.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#75916 - poslundc - Thu Mar 16, 2006 11:36 pm</h4>
    <div class="postbody"><span class="postbody">The point is still salient, though: why convert to and from a different, less efficient format unnecessarily?
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#75928 - phoenixj91 - Fri Mar 17, 2006 1:24 am</h4>
    <div class="postbody"><span class="postbody">I assumed that was the way SRAM worked, the functions were copied directly from the Saving demo in the Sources section of gbadev</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#75932 - sajiimori - Fri Mar 17, 2006 2:18 am</h4>
    <div class="postbody"><span class="postbody">You're missing the point.  ASCII characters are 8 bit numbers.  SRAM doesn't know if the number 65 "means" the letter 'A' or that the player got to level 65.
<br/>
<br/>
It's pointless to write the number for the ASCII character '6' followed by the number for the ASCII character '5' when you could have just written the number 65.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#75933 - phoenixj91 - Fri Mar 17, 2006 2:26 am</h4>
    <div class="postbody"><span class="postbody">I understand that. I wasn't defending the functions I posted, I was saying that before this thread I had assumed you needed to write to SRAM in chars. I was wrong, though I learned from my mistake ^_-</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#75935 - sajiimori - Fri Mar 17, 2006 3:41 am</h4>
    <div class="postbody"><span class="postbody">You do have to write it in chars -- 8 bit numbers.  That doesn't mean you have to encode it in ASCII!  :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#75942 - phoenixj91 - Fri Mar 17, 2006 4:55 am</h4>
    <div class="postbody"><span class="postbody">So instead of declaring string[] as
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">char string[7]</td> </tr></table><span class="postbody">
<br/>
I'd go
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">u8 string[7]</td> </tr></table><span class="postbody">
<br/>
?[/code]</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#75944 - tepples - Fri Mar 17, 2006 5:13 am</h4>
    <div class="postbody"><span class="postbody">They're the same thing. The type 'char' is equivalent to 'unsigned char' within devkitARM, and 'u8' is typically typedef'd as 'unsigned char'.
<br/>
<br/>
What you want is a more efficient and more reliable format for storing the data. Instead of serializing the data in ASCII form, try serializing it in plain old big-endian binary form[1]:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">/* Caution: untested */
<br/>
<br/>
void SRAM_putInt(size_t offset, u32 data)
<br/>
{
<br/>
  SRAM[offset + 0] = (score &gt;&gt; 24) &amp; 0x00FF;
<br/>
  SRAM[offset + 1] = (score &gt;&gt; 16) &amp; 0x00FF;
<br/>
  SRAM[offset + 2] = (score &gt;&gt; 8) &amp; 0x00FF;
<br/>
  SRAM[offset + 3] = (score &gt;&gt; 0) &amp; 0x00FF;
<br/>
}
<br/>
<br/>
u32 SRAM_getInt(size_t offset)
<br/>
{
<br/>
  u32 result
<br/>
      = (SRAM[offset + 0] &lt;&lt; 24)
<br/>
      | (SRAM[offset + 1] &lt;&lt; 16)
<br/>
      | (SRAM[offset + 2] &lt;&lt; 8)
<br/>
      | (SRAM[offset + 3] &lt;&lt; 0)
<br/>
};
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
<span style="font-size: 9px; line-height: normal">[1] The GBA natively uses little-endian, but serializing in big-endian is easier especially for beginners to understand when reading test.sav in a hex editor.</span><br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#75945 - sajiimori - Fri Mar 17, 2006 5:17 am</h4>
    <div class="postbody"><span class="postbody">No, you're still missing the point.  "Char" does not mean "ASCII character".  It means "8 bit number", as far as C is concerned.  Writing out decimal numbers as sequences of ASCII characters is absurdly complicated compared to just writing binary numbers directly.
<br/>
<br/>
Let me put it this way: If you wanted to write the number 1 to memory, would you write the number 49 because it's the ASCII code for the symbol '1', or would you just write the number 1?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#75956 - phoenixj91 - Fri Mar 17, 2006 6:35 am</h4>
    <div class="postbody"><span class="postbody">I understand the concept, really o_0' !
<br/>
I'm sorry if the terminology I'm using doesn't convey my thoughts, but I get the difference between writing a number and writing the ASCII code for each digit of the number.
<br/>
[EDIT] Thanks a lot for the code, tepples</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#75964 - sajiimori - Fri Mar 17, 2006 7:20 am</h4>
    <div class="postbody"><span class="postbody">Sorry, I was just going by your first reply which implied that you thought I was telling you not to write chars (which I wasn't), and your second reply which implied that you thought the distinction I was making was of type rather than encoding (which it wasn't).  Excuse my misunderstanding.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
