<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Sqrt - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>C/C++ > Sqrt</h2>
<div id="posts">
<div class="post">
    <h4>#56812 - NighTiger - Tue Oct 11, 2005 7:41 pm</h4>
    <div class="postbody"><span class="postbody">Hi guys,
<br/>
I would like to know if there's and where's the funciont sqrt in the devkitARM Pro.
<br/>
tnx</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#56830 - Miked0801 - Tue Oct 11, 2005 9:26 pm</h4>
    <div class="postbody"><span class="postbody">What do you need it for?
<br/>
<br/>
There are some ARM sprt functions out and about, but I was curious...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#56835 - NighTiger - Tue Oct 11, 2005 9:47 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
sf VectorMagnitude (psVector pxVector)
<br/>
{
<br/>
  return ((sf)sqrt (pxVector-&gt;x*pxVector-&gt;x + pxVector-&gt;y*pxVector-&gt;y + pxVector-&gt;z*pxVector-&gt;z));
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
;-)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#56839 - Joat - Tue Oct 11, 2005 10:01 pm</h4>
    <div class="postbody"><span class="postbody">You can always use math.h, but I don't recall if it includes an integer sqrt (which may not matter, dunno if your sf type is signed float, or signed fixed).  There is also a bios sqrt function, and while it's faster than anything in math.h, it's still not great (if you need to do a lot of these fast, google for arm sqrt and you should find a website that has a lot of different implementations, one of which you can stuff into intram).
<br/>
<br/>
If you're just doing one or two per frame, any solution will work.
<br/>
<br/>
Also, if you're comparing distances, you can skip the sqrt entirely and compare the squared distances.<br/>_________________<br/>Joat
<br/>
<a href="http://www.bottledlight.com" target="_blank">http://www.bottledlight.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#56842 - DiscoStew - Tue Oct 11, 2005 10:19 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
@Asm_Sqrt(u32 number) // u32 is an unsigned long
<br/>
Asm_Sqrt:
<br/>
      MOV     r1,#(3 &lt;&lt; 30)
<br/>
      MOV     r2,#(1 &lt;&lt; 30)
<br/>
<br/>
      CMP      r0,r2
<br/>
      SUBHS      r0,r0,r2
<br/>
      ADC      r2,r1,r2,LSL #1
<br/>
<br/>
      CMP      r0,r2,ROR #(2 * 1)
<br/>
      SUBHS      r0,r0,r2,ROR #(2 * 1)
<br/>
      ADC      r2,r1,r2,LSL #1
<br/>
<br/>
      CMP      r0,r2,ROR #(2 * 2)
<br/>
      SUBHS      r0,r0,r2,ROR #(2 * 2)
<br/>
      ADC      r2,r1,r2,LSL #1
<br/>
<br/>
      CMP      r0,r2,ROR #(2 * 3)
<br/>
      SUBHS      r0,r0,r2,ROR #(2 * 3)
<br/>
      ADC      r2,r1,r2,LSL #1
<br/>
<br/>
      CMP      r0,r2,ROR #(2 * 4)
<br/>
      SUBHS      r0,r0,r2,ROR #(2 * 4)
<br/>
      ADC      r2,r1,r2,LSL #1
<br/>
<br/>
      CMP      r0,r2,ROR #(2 * 5)
<br/>
      SUBHS      r0,r0,r2,ROR #(2 * 5)
<br/>
      ADC      r2,r1,r2,LSL #1
<br/>
<br/>
      CMP      r0,r2,ROR #(2 * 6)
<br/>
      SUBHS      r0,r0,r2,ROR #(2 * 6)
<br/>
      ADC      r2,r1,r2,LSL #1
<br/>
<br/>
      CMP      r0,r2,ROR #(2 * 7)
<br/>
      SUBHS      r0,r0,r2,ROR #(2 * 7)
<br/>
      ADC      r2,r1,r2,LSL #1
<br/>
<br/>
      CMP      r0,r2,ROR #(2 * 8)
<br/>
      SUBHS      r0,r0,r2,ROR #(2 * 8)
<br/>
      ADC      r2,r1,r2,LSL #1
<br/>
<br/>
      CMP      r0,r2,ROR #(2 * 9)
<br/>
      SUBHS      r0,r0,r2,ROR #(2 * 9)
<br/>
      ADC      r2,r1,r2,LSL #1
<br/>
<br/>
      CMP      r0,r2,ROR #(2 * 10)
<br/>
      SUBHS      r0,r0,r2,ROR #(2 * 10)
<br/>
      ADC      r2,r1,r2,LSL #1
<br/>
<br/>
      CMP      r0,r2,ROR #(2 * 11)
<br/>
      SUBHS      r0,r0,r2,ROR #(2 * 11)
<br/>
      ADC      r2,r1,r2,LSL #1
<br/>
<br/>
      CMP      r0,r2,ROR #(2 * 12)
<br/>
      SUBHS      r0,r0,r2,ROR #(2 * 12)
<br/>
      ADC      r2,r1,r2,LSL #1
<br/>
<br/>
      CMP      r0,r2,ROR #(2 * 13)
<br/>
      SUBHS      r0,r0,r2,ROR #(2 * 13)
<br/>
      ADC      r2,r1,r2,LSL #1
<br/>
<br/>
      CMP      r0,r2,ROR #(2 * 14)
<br/>
      SUBHS      r0,r0,r2,ROR #(2 * 14)
<br/>
      ADC      r2,r1,r2,LSL #1
<br/>
<br/>
      CMP      r0,r2,ROR #(2 * 15)
<br/>
      SUBHS      r0,r0,r2,ROR #(2 * 15)
<br/>
      ADC      r2,r1,r2,LSL #1
<br/>
<br/>
      BIC     r0,r2,#(3 &lt;&lt; 30)
<br/>
      BX      LR
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
This ASM function is what I use, and it seems pretty fast compared to other sqrt functions<br/>_________________<br/><span style="font-weight: bold">DS</span> - It's all about <span style="font-weight: bold">D</span>isco<span style="font-weight: bold">S</span>tew</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#56927 - IRbaboon - Wed Oct 12, 2005 8:27 am</h4>
    <div class="postbody"><span class="postbody">I personally use the <a class="postlink" href="http://www.work.de/nocash/gbatek.htm#biosfunctionsummary" target="_blank">Sqrt Swi Bios call</a> (0x8h)
<br/>
I'm not sure how fast it is compared to the other functions already listed, but it's hardware-supported so it can't be that bad.<br/>_________________<br/><a href="http://www.paulwagener.nl/host/signature.png">[Images not permitted - Click here to view it]</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#56954 - poslundc - Wed Oct 12, 2005 4:47 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>IRbaboon wrote:</b></span></td> </tr> <tr> <td class="quote">I'm not sure how fast it is compared to the other functions already listed, but it's hardware-supported so it can't be that bad.</td> </tr></table><span class="postbody">
<br/>
<br/>
It's not really "hardware supported". It's just a function Nintendo wrote and placed in fast memory (same speed/bus width as IWRAM). Fast memory is a good thing, but it's marred by a couple of things:
<br/>
<br/>
- Nintendo typically optimizes for space instead of speed, so it's not hard to improve on their routines.
<br/>
<br/>
- There is a significant time cost to entering any of the BIOS routines, where Nintendo's quasi-system-software wastes a bunch of cycles shuffling around memory and registers. While it's not enough to render them useless, it's enough to hurt their value considerably.
<br/>
<br/>
If you've got an ARM assembly function that you know works well and you don't mind it consuming IWRAM, you can easily outperform the BIOS.
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#56985 - NighTiger - Wed Oct 12, 2005 10:01 pm</h4>
    <div class="postbody"><span class="postbody">tnx at all :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#56989 - NighTiger - Wed Oct 12, 2005 10:32 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>DiscoStew wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
@Asm_Sqrt(u32 number)
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
This ASM function is what I use, and it seems pretty fast compared to other sqrt functions</span></td> </tr></table><span class="postbody">
<br/>
<br/>
excuse me Disco, I'm very beginner with assembly.
<br/>
How can I use it?[/code]</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#57166 - SevenString - Fri Oct 14, 2005 1:08 am</h4>
    <div class="postbody"><span class="postbody"><a href="http://www.finesse.demon.co.uk/steven/sqrt.html" target="_blank">http://www.finesse.demon.co.uk/steven/sqrt.html</a>
<br/>
<br/>
<a href="http://www.finesse.demon.co.uk/steven/invsqrt.html" target="_blank">http://www.finesse.demon.co.uk/steven/invsqrt.html</a>
<br/>
<br/>
enjoy
<br/>
<br/>
<br/>
<br/>
btw, those two links were on the first page as
<br/>
<br/>
<span style="font-style: italic"><span style="font-weight: bold">ARM code inverse square root routines</span></span>
<br/>
<br/>
and
<br/>
<br/>
<span style="font-style: italic"><span style="font-weight: bold">ARM code square root routines</span></span>
<br/>
<br/>
when I did a routine google search for <span style="font-style: italic"><span style="font-weight: bold">square root code</span></span>
<br/>
<br/>
<br/>
&lt;SMARTASS&gt;
<br/>
that newfangled internet thing is just amazing, isn't it?  ;)
<br/>
&lt;/SMARTASS&gt;<br/>_________________<br/><span style="font-style: italic">"Artificial Intelligence is no match for natural stupidity."</span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#57463 - SevenString - Sun Oct 16, 2005 5:09 am</h4>
    <div class="postbody"><span class="postbody">The "sqrtf32" function in LIBNDS/math.h returned incorrect results for me.  The fix was to alter the function to shift-left (&lt;&lt;) by 13, NOT 12.  
<br/>
<br/>
Normally, I tend to use tables, or avoid sqrts altogether when I can.  But the problem that led to this discovery was that when using the libnds "glRotatef", the normalization function was not returning a unit vector.  So I had to drill down to find the culprit.
<br/>
<br/>
I'm not sure if this is due to an emulation bug in Ideas, or if this is an actual bug in libnds.  To be honest, I'm too busy coding 3D stuff to bother drilling down into what the HW is actually doing vs. what the emulator may or may not be doing wrong.
<br/>
<br/>
However, if your 3D geometry is warping unpleasantly as you rotate, and you're using glRotatef, you might try altering sqrtf32 to use the &lt;&lt; 13 trick.  However, you'll need to rebuild the libnds source for this to work.
<br/>
<br/>
As a side note, many of the demos looked funky on the Ideas emulator until I recompiled with this "fix".
<br/>
<br/>
** UPDATE... LONG OVERDUE **
<br/>
<br/>
This is NOT a bug in libnds as the glRotatef/sqrtf32 code works fine on the hardware.  In another thread, I describe some build techniques to deal with discrepancies between emulators and hardware.
<br/>
<br/>
<a class="postlink" href="http://forum.gbadev.org/viewtopic.php?t=7368" target="_blank">http://forum.gbadev.org/viewtopic.php?t=7368</a><br/>_________________<br/><span style="font-style: italic">"Artificial Intelligence is no match for natural stupidity."</span></span><span class="gensmall"><br/><br/>Last edited by SevenString on Tue Nov 08, 2005 8:17 pm; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#57660 - Miked0801 - Mon Oct 17, 2005 5:53 pm</h4>
    <div class="postbody"><span class="postbody">Just wanted to add that very often, one does not actually need the magnitude of a vector.  The square of the vector can suffice for many instances.  Consider radius checks.  Comparing the sqaures of the magnitudes works better than the normalized versions.  In addition, many other times the magnitude will "cancel out" depending on the math.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#60297 - jumperwillow - Tue Nov 08, 2005 7:26 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>SevenString wrote:</b></span></td> </tr> <tr> <td class="quote">http://www.finesse.demon.co.uk/steven/sqrt.html
<br/>
<br/>
<a href="http://www.finesse.demon.co.uk/steven/invsqrt.html" target="_blank">http://www.finesse.demon.co.uk/steven/invsqrt.html</a>
<br/>
<br/>
enjoy
<br/>
<br/>
<br/>
<br/>
btw, those two links were on the first page as
<br/>
<br/>
<span style="font-style: italic"><span style="font-weight: bold">ARM code inverse square root routines</span></span>
<br/>
<br/>
and
<br/>
<br/>
<span style="font-style: italic"><span style="font-weight: bold">ARM code square root routines</span></span>
<br/>
<br/>
when I did a routine google search for <span style="font-style: italic"><span style="font-weight: bold">square root code</span></span>
<br/>
<br/>
<br/>
&lt;SMARTASS&gt;
<br/>
that newfangled internet thing is just amazing, isn't it?  ;)
<br/>
&lt;/SMARTASS&gt;</td> </tr></table><span class="postbody">
<br/>
<br/>
Kuods for the links.<br/>_________________<br/>-h</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
