<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>GCC - unnecessary add/sub sp,sp,#4? - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>C/C++ > GCC - unnecessary add/sub sp,sp,#4?</h2>
<div id="posts">
<div class="post">
    <h4>#129374 - Dwedit - Tue May 22, 2007 5:19 am</h4>
    <div class="postbody"><span class="postbody">I'm using the compiler switches "-Os -mthumb -mcpu=arm7tdmi -mtune=arm7tdmi"
<br/>
<br/>
GCC is generating this code for one function:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
print_2_func:
<br/>
   push   {lr}
<br/>
   sub   sp, sp, #4
<br/>
   bl   strmerge_str
<br/>
   bl   text2_str
<br/>
   add   sp, sp, #4
<br/>
   @ sp needed for prologue
<br/>
   pop   {r1}
<br/>
   bx   r1
<br/>
</td> </tr></table><span class="postbody">
<br/>
Why is it unnecessarily adding and subtracting 4 from the stack pointer?
<br/>
<br/>
Also, the adding and subtracting of 4 to and from the stack pointer looks like it's interfering with the compiler's ability to do tail calls.<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#129375 - tepples - Tue May 22, 2007 5:26 am</h4>
    <div class="postbody"><span class="postbody">Are you making sure to -fomit-frame-pointer?<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#129378 - Dwedit - Tue May 22, 2007 5:50 am</h4>
    <div class="postbody"><span class="postbody">Same code regardless of that flag.  -Os supposedly turns on -fomit-frame-pointer.<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#129391 - keldon - Tue May 22, 2007 9:55 am</h4>
    <div class="postbody"><span class="postbody">Oh; I always thought that push decremented SP so it should not stop it from performing tail calls right?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#129427 - Miked0801 - Tue May 22, 2007 7:31 pm</h4>
    <div class="postbody"><span class="postbody">Compilers in general like to add unneeded crap to functions.  The worse the compiler, the more crap that is added.  We have functions that the compiler pushes 2 extra registers that are unused.  Or, the famous subs r0,r0, #1   cmp r0, #0 type stuff.
<br/>
<br/>
If performance is 100% needed on a function, just hand code it and be done with it :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#129433 - Dwedit - Tue May 22, 2007 8:36 pm</h4>
    <div class="postbody"><span class="postbody">I don't care about performance here, I care that I'm using a stack under 512 bytes in size, and the compiler is just destroying it with that crap.<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#129451 - sajiimori - Tue May 22, 2007 10:47 pm</h4>
    <div class="postbody"><span class="postbody">The same philosophy applies, I think.  If you've got a tiny stack, write the code by hand.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#129481 - tepples - Wed May 23, 2007 5:25 am</h4>
    <div class="postbody"><span class="postbody">But then how is one supposed to rewrite the whole of newlib and libfat by hand?<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#129504 - keldon - Wed May 23, 2007 10:03 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tepples wrote:</b></span></td> </tr> <tr> <td class="quote">But then how is one supposed to rewrite the whole of newlib and libfat by hand?</td> </tr></table><span class="postbody">
<br/>
Well that shouldn't be a problem since this only affects you in the case of the <span style="font-style: italic">random stack wastage</span> occurring in within a sets of methods that will create deep nested calls to each other.
<br/>
<br/>
Other than that it wouldn't pose that much of a stack problem providing it's not already at the end of it, right?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#129546 - sajiimori - Wed May 23, 2007 6:12 pm</h4>
    <div class="postbody"><span class="postbody">Indiscriminate use of the standard library seems out of the question with less than 512 bytes of stack.
<br/>
<br/>
Anyway Dwedit, also try -fno-exceptions if you haven't already.  Exception support is another reason GCC might force a frame pointer.  -fomit-frame-pointer is more of a hint than anything; GCC will still use one if it thinks it's necessary.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#129550 - Miked0801 - Wed May 23, 2007 6:28 pm</h4>
    <div class="postbody"><span class="postbody">Which begs the question - what are you doing that only allows a 512 byte stack?  We cameclose to that on GBC with hand coded Z80.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#129553 - Dwedit - Wed May 23, 2007 6:45 pm</h4>
    <div class="postbody"><span class="postbody">It looks like it may be conformance to the "Procedure Call Standard for the ARM Architecture":
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
5.2.1.2 Stack constraints at a public interface
<br/>
The stack must also conform to the following constraint at a public interface:
<br/>
* SP mod 8 = 0. The stack must be double-word aligned.
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
There really should be a way to get rid of that restriction.<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#129559 - sajiimori - Wed May 23, 2007 7:27 pm</h4>
    <div class="postbody"><span class="postbody">Cool, I didn't know that.
<br/>
<br/>
(GCC should just push 2 registers instead of 1 to eliminate the add/sub...)
<br/>
<br/>
Since the calling conventions only apply to C (and languages with C interoperability), again, hand-written code can ignore that restriction, as long as it doesn't call C code.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
