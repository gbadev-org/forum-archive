<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Passing a string as a function argument screws up my palette - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>C/C++ > Passing a string as a function argument screws up my palette</h2>
<div id="posts">
<div class="post">
    <h4>#30100 - JonahB - Sun Nov 28, 2004 6:17 am</h4>
    <div class="postbody"><span class="postbody">I'm working in mode 4 and I'm trying to build a text system for my GBA game. It uses bitmaps to plot the text characters to the background. The function works like this...
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
void draw_text(u16 x, u16 y, const char *str)
<br/>
<br/>
....
<br/>
<br/>
draw_text(30,30,"TEXT");
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Whenever I call draw_text it messes up my sprite data, my sprite palette, and my bg palette. I have done some testing and tracked the bug to the str parameter. Even when I commented out all of the code inside draw_text, it still happened.
<br/>
<br/>
As for the function code itself, it doesnt associate str with the video memory at all. It just reads the string then draws the correct bitmap to the screen.
<br/>
<br/>
Here are some screenshots of whats happening (the "A" is an early test of my text system)
<br/>
<br/>
Good: <a class="postlink" href="http://img34.exs.cx/img34/1466/np_good.jpg" target="_blank">http://img34.exs.cx/img34/1466/np_good.jpg</a>
<br/>
<br/>
Bad: <a class="postlink" href="http://img34.exs.cx/img34/8928/np_bad.jpg" target="_blank">http://img34.exs.cx/img34/8928/np_bad.jpg</a>
<br/>
<br/>
This has been driving me nuts for the past three hours. If someone could please help me out, I would be really greatfull.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#30102 - tepples - Sun Nov 28, 2004 7:04 am</h4>
    <div class="postbody"><span class="postbody">Two words: Unaligned Data.
<br/>
<br/>
How are you declaring the constant data arrays that your program copies into VRAM? Are they aligned to a 4-byte boundary?<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#30104 - JonahB - Sun Nov 28, 2004 7:48 am</h4>
    <div class="postbody"><span class="postbody">I'm using dovoto's pcx-&gt;gba program to convert my image data. Its declared like this:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
const u16 bg_titleData[] = {
<br/>
0x0707, 0x0707, 0x0707, 0x0307, 0x0303, 0x0703, 0x0303, 0x0101, 0x0101, 0x0101, 0x0101, 0x0101, 0x0101, 0x0101, 0x0101, 0x0101, 0x0101, 0x0101, 0x0101, 0x0101, ect...
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Everything works just fine when I dont call the draw_text function. The only thing I can trace it to is the str parameter.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#30118 - tepples - Sun Nov 28, 2004 4:14 pm</h4>
    <div class="postbody"><span class="postbody">const u16? If you use a 32-bit DMA or BIOS CpuFastSet, it'll get screwed up when you copy it to VRAM. Try either using a 16-bit DMA or changing the first line to the following:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">const u16 bg_titleData[] __attribute__ ((aligned (16))) = {</td> </tr></table><span class="postbody">
<br/>
and tell us if it clears up your problem.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#30121 - JonahB - Sun Nov 28, 2004 5:14 pm</h4>
    <div class="postbody"><span class="postbody">WOOHOO!! I was using 32-bit DMA copies to get the data into VRAM. I switched to 16-bit and it works! Thanks!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#30129 - identitycrisisuk - Sun Nov 28, 2004 7:04 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tepples wrote:</b></span></td> </tr> <tr> <td class="quote">const u16? If you use a 32-bit DMA or BIOS CpuFastSet, it'll get screwed up when you copy it to VRAM. Try either using a 16-bit DMA or changing the first line to the following:
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">const u16 bg_titleData[] __attribute__ ((aligned (16))) = {</td> </tr></table><span class="postbody">
<br/>
and tell us if it clears up your problem.</span></td> </tr></table><span class="postbody">
<br/>
<br/>
Sorry to chip in here but when I try and compile things in Visual Studio with the __attribute__ thing in, it flags it as a syntax error - is there something I can do to stop this? I don't use VS to compile my stuff properly, I still use a make.bat file for DevKitAdvance but it's nice to use VS to write the code and compiling the project will save the changes, even if it produces a useless exe. Also, what's the difference between the aligned(16) thing up there and the aligned(4) that you find outputted by graphics programs, should I use one or the other/both/in what situations?<br/>_________________<br/></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">CanIKickIt(YES_YOU_CAN);</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#30130 - sajiimori - Sun Nov 28, 2004 7:21 pm</h4>
    <div class="postbody"><span class="postbody">__attribute__ is a GCC extension.  The GCC docs describe the various attributes and their meanings.
<br/>
<br/>
Did you say you want to compile your GBA ROM using VC++ just because compiling does a "save all"?  Why don't you just "save all"?  Better yet, set up a custom build rule to use your batch file and mark all your .c files to never build.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#30131 - identitycrisisuk - Sun Nov 28, 2004 7:25 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>sajiimori wrote:</b></span></td> </tr> <tr> <td class="quote">__attribute__ is a GCC extension.  The GCC docs describe the various attributes and their meanings.
<br/>
<br/>
Did you say you want to compile your GBA ROM using VC++ just because compiling does a "save all"?  Why don't you just "save all"?  Better yet, set up a custom build rule to use your batch file and mark all your .c files to never build.</td> </tr></table><span class="postbody">
<br/>
<br/>
Well it tells me if I have any errors as well as just saving everything. I'd much rather use VC++ to go straight to them than run a makefile and have to figure out what lines it's talking about.<br/>_________________<br/></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">CanIKickIt(YES_YOU_CAN);</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
