<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>C++ council, should we #ifdef? - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>C/C++ > C++ council, should we #ifdef?</h2>
<div id="posts">
<div class="post">
    <h4>#140634 - keldon - Tue Sep 18, 2007 4:43 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">// somewhere
<br/>
#define OPTION_X 1
<br/>
<br/>
// somewhere else
<br/>
#ifdef OPTION_X
<br/>
   /* some code */
<br/>
#endif</td> </tr></table><span class="postbody">
<br/>
vs
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">// somewhere
<br/>
const BOOL OPTION_X = TRUE;
<br/>
<br/>
// somewhere else
<br/>
   if ( OPTION_X )
<br/>
   {
<br/>
      /* some code */
<br/>
   }</td> </tr></table><span class="postbody">
<br/>
<br/>
What are your thoughts on it?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#140638 - kusma - Tue Sep 18, 2007 5:23 pm</h4>
    <div class="postbody"><span class="postbody">It's not necessarily the same, 'const' doesn't guarantee that a variable isn't changed in C. To quote K&amp;R (section 2.4, page 40);
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">The result is implementation-defined if an attempt is made to change a const.</td> </tr></table><span class="postbody">
<br/>
Some compilers might support it, others might not. Of course, it's bad coding practice to change it.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#140639 - sajiimori - Tue Sep 18, 2007 5:42 pm</h4>
    <div class="postbody"><span class="postbody">Although they are not "the same" as #defines (thankfully), static const values are sometimes truly immutable.  In particular, const integer primitives initialized with compile-time constants are also compile-time constants, and can therefore be used as array sizes and switch cases, among other things.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">static const int kSize = 5;
<br/>
<br/>
// Okay in C++, but not in C.
<br/>
int array[kSize];
<br/>
</td> </tr></table><span class="postbody">
<br/>
Any beginner's C++ book will give some reasons to avoid the preprocessor, of which correct scoping is the most important.</span><span class="gensmall"><br/><br/>Last edited by sajiimori on Tue Sep 18, 2007 5:43 pm; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#140640 - gmiller - Tue Sep 18, 2007 5:42 pm</h4>
    <div class="postbody"><span class="postbody">It might not matter for you but with an #ifdef the code is never emitted by the compiler so your object file could be smaller.  Depending on the compiler and the number of source files involved the const declaration could do the same thing for you.  The #ifdef is guaranteed to either generate code or not the const code is dependent on the compiler.  
<br/>
<br/>
If you absolutely need the space that the code would take up us #ifdef otherwise take your chances.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#140641 - sajiimori - Tue Sep 18, 2007 5:47 pm</h4>
    <div class="postbody"><span class="postbody">Don't "take your chances" -- read the compiler's output.  If you're working on a legacy platform with crappy C++ support, it's better to know so you can stick to older language features.
<br/>
<br/>
That said, modern versions of GCC behave reasonably with regards to static const variables.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#140642 - sajiimori - Tue Sep 18, 2007 5:54 pm</h4>
    <div class="postbody"><span class="postbody">Oops, I didn't read the original post closely enough.  Indeed, #ifdef is a whole other beast.  There are often ways to avoid it using templates, but they tend to be overly complicated for my taste.
<br/>
<br/>
My best suggestion is to condense your #ifdeffery to small areas (preferably configuration files), and keep them away from business logic.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#140848 - Mumbly Juergens - Thu Sep 20, 2007 6:20 am</h4>
    <div class="postbody"><span class="postbody">According to something I read that I can't remember the name of, good compilers will (depending on the optimization flags) remove a section of code that will never be run, as shown in the example in the original post.
<br/>
<br/>
I vote for using constants if your compiler cuts out the code, simply because then you will get warnings and errors for the code in the if block even if it gets cut out later. With an ifdef you could find yourself with code that doesn't work and not find out until you change a define.
<br/>
<br/>
On the other hand, most coders know that an ifdef block is intentionally there to remove unwanted code based on a define, where using an if might confuse some people as it fits right in with other code (also making it harder to spot if you ever start removing them).</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#140878 - tepples - Thu Sep 20, 2007 11:24 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Mumbly Juergens wrote:</b></span></td> </tr> <tr> <td class="quote">According to something I read that I can't remember the name of, good compilers will (depending on the optimization flags) remove a section of code that will never be run, as shown in the example in the original post.</td> </tr></table><span class="postbody">
<br/>
But don't rely on this entirely. I've seen some situations where the G++ toolchain leaves unreachable code behind in the binary. If you want to make sure code is completely removed, use <span style="font-weight: bold">-save-temps</span> and read the input to the assembler.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">I vote for using constants if your compiler cuts out the code, simply because then you will get warnings and errors for the code in the if block even if it gets cut out later.</td> </tr></table><span class="postbody">
<br/>
With a large number of these being "warning: unused variable xyz", right?
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">With an ifdef you could find yourself with code that doesn't work and not find out until you change a define.</td> </tr></table><span class="postbody">
<br/>
But if you change a macro (such as #define HAS_FPU in one project I work on, which among other things switches between sprintf and siprintf), you'll find out when you build the version for another platform that sets the macro the other way and invokes the code that is unused in a given circumstance.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">On the other hand, most coders know that an ifdef block is intentionally there to remove unwanted code based on a define, where using an if might confuse some people as it fits right in with other code (also making it harder to spot if you ever start removing them).</td> </tr></table><span class="postbody">
<br/>
In either case, comments clarify the intent.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
