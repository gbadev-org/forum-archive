<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>GCC optimisation error - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>C/C++ > GCC optimisation error</h2>
<div id="posts">
<div class="post">
    <h4>#90325 - Schultz - Thu Jun 29, 2006 6:40 pm</h4>
    <div class="postbody"><span class="postbody">As I compiled my code with the gcc as follows:
<br/>
<br/>
<span style="font-weight: bold">gcc DMA.c -c -O1</span>
<br/>
<br/>
No mistake were found while running the code.
<br/>
However, when I compiled it such as follows:
<br/>
<br/>
<span style="font-weight: bold">gcc DMA.c -c -O2</span>
<br/>
<br/>
A huge bug took place and when I called my function mem_copy(word *, word *, hword), which was in the above module, the data would not move from source to destiny.
<br/>
<br/>
Futhermore, the game itself and all the other modules appeared to show no mistake as I compiled them even with -O3.
<br/>
<br/>
Provided that the code have not slightly changed, what could the cause of the error regarding optimisation be?
<br/>
<br/>
Thanks in advance.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#90326 - tepples - Thu Jun 29, 2006 6:55 pm</h4>
    <div class="postbody"><span class="postbody">Optimization "bugs" usually happen when you forget a volatile.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#90478 - Schultz - Fri Jun 30, 2006 11:59 am</h4>
    <div class="postbody"><span class="postbody">Volatiles were not forgotten.
<br/>
The module in which the error took place was optimised with -O1, which normally causes errors with volatiles.
<br/>
Futhermore, the module makes only writes to IO addresses and a volatile error happens only as a read takes place.
<br/>
<br/>
Still, I cannot know the cause of the error.
<br/>
The code was the following:
<br/>
<br/>
DMA.h
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#ifndef      __DMA
<br/>
#define      __DMA
<br/>
<br/>
/*
<br/>
   Includes
<br/>
*/
<br/>
#include   "schultz.h"
<br/>
#include   "GBA.h"
<br/>
<br/>
/*
<br/>
   Constants
<br/>
*/
<br/>
/*   DMA registers   */
<br/>
#define      DMA_ENABLED            ( 1 &lt;&lt; 15 )
<br/>
#define      DMA_IRQ_ENABLED            ( 1 &lt;&lt; 14 )
<br/>
#define      DMA_WORD_TRANSFER         ( 1 &lt;&lt; 10 )
<br/>
<br/>
/*
<br/>
   External
<br/>
*/
<br/>
extern   void   DMA_transfer(int, word *, word *, hword, hword);
<br/>
extern   void   mem_copy(word *, word *, hword);
<br/>
<br/>
/*
<br/>
   Inline Functions
<br/>
*/
<br/>
<br/>
#endif
<br/>
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
DMA.c
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#include   "DMA.h"
<br/>
<br/>
void   DMA_transfer(int channel, word *src, word *dest, hword size, hword ctrl) {
<br/>
   DMA_SRC(channel) = src;
<br/>
   DMA_DEST(channel) = dest;
<br/>
   DMA_CNT(channel) = size;
<br/>
   DMA_CTRL(channel) = ctrl;
<br/>
}
<br/>
<br/>
void   mem_copy(word *src, word *dest, hword size) {
<br/>
   DMA_SRC(3) = src;
<br/>
   DMA_DEST(3) = dest;
<br/>
   DMA_CNT(3) = size;
<br/>
   DMA_CTRL(3) = DMA_ENABLED | DMA_WORD_TRANSFER;
<br/>
}
<br/>
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
GBA.h
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#ifndef      __GBA
<br/>
#define      __GBA
<br/>
<br/>
/*
<br/>
   GBA DEFINITIONS
<br/>
   Schultz, die Zahlberer
<br/>
*/
<br/>
<br/>
/*
<br/>
   Defines the GBA hardware.
<br/>
*/
<br/>
<br/>
/*      Definitions   */
<br/>
#include   "schultz.h"
<br/>
<br/>
/*
<br/>
   Memory Units
<br/>
*/
<br/>
#define      W            1
<br/>
#define      KW            1024
<br/>
<br/>
/*
<br/>
   Memory Addresses
<br/>
*/
<br/>
#define      BIOS_ROM         ((word *)   0x00000000)
<br/>
#define      EWRAM            ((word *)   0x02000000)
<br/>
#define      IWRAM            ((word *)   0x03000000)
<br/>
#define      IO            ((word *)   0x04000000)
<br/>
#define      PAL_RAM            ((word *)   0x05000000)
<br/>
#define      VRAM            ((word *)   0x06000000)
<br/>
#define      OAM            ((word *)   0x07000000)
<br/>
#define      CROM            ((word *)   0x08000000)
<br/>
#define      _CROM(i)         ((word *)   0x08000000 + 0x00100000 * (i))
<br/>
<br/>
/*
<br/>
   IO registers
<br/>
*/
<br/>
#define      DISP_CTRL         *((hword *)   (0x04000000))
<br/>
#define      DISP_STAT         *((hword *)   (0x04000004))
<br/>
#define      VCOUNT            *((hword *)   (0x04000006))
<br/>
#define      BG_CTRL(i)         *((hword *)   (0x04000008 + 0x0002 * (i)))
<br/>
#define      BG_HOFFSET(i)         *((hword *)   (0x04000010 + 0x0002 * (i)))
<br/>
#define      BG_VOFFSET(i)         *((hword *)   (0x04000016 + 0x0002 * (i)))
<br/>
#define      BG_ROT(i, a)         *((hword *)   (0x04000020 + 0x0002 * (a) + 0x0010 * ((i) - 2)))
<br/>
#define      BG_X(i)            *((word *)   (0x04000028 + 0x0010 * ((i) - 2)))
<br/>
#define      BG_Y(i)            *((word *)   (0x0400002C + 0x0010 * ((i) - 2)))
<br/>
#define      MOSAIC_CTRL         *((hword *)   (0x0400004C))
<br/>
#define      DMA_SRC(i)         (word *) (*((word *)   (0x040000B0 + 0x000C * (i))))
<br/>
#define      DMA_DEST(i)         (word *) (*((word *)   (0x040000B4 + 0x000C * (i))))
<br/>
#define      DMA_CNT(i)         *((hword *)   (0x040000B8 + 0x000C * (i)))
<br/>
#define      DMA_CTRL(i)         *((hword *)   (0x040000BA + 0x000C * (i)))
<br/>
#define      TIMER_CNT(i)         *((hword *)   (0x04000100 + 0x0004 * (i)))
<br/>
#define      TIMER_CTR(i)         *((hword *)   (0x04000104 + 0x0004 * (i)))
<br/>
#define      KEYPAD            *((volatile hword *)   (0x04000130))
<br/>
#define      KEYPAD_CTRL         *((hword *)   (0x04000132))
<br/>
#define      IE            *((hword *)   (0x04000200))
<br/>
#define      IF            *((hword *)   (0x04000202))
<br/>
#define      WAIT_CTRL         *((hword *)   (0x04000204))
<br/>
#define      IME            *((hword *)   (0x04000208))
<br/>
#define      HALT_CTRL         *((qword *)   (0x04000301))
<br/>
<br/>
#endif
<br/>
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
schultz.h
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#ifndef      __SCHULTZ
<br/>
#define      __SCHULTZ
<br/>
<br/>
/*
<br/>
   SCHULTZ
<br/>
   Schultz, die Zahlberer
<br/>
*/
<br/>
<br/>
/*
<br/>
   Definitions for use with 32 bit ARM 7TDMI chip.
<br/>
*/
<br/>
<br/>
/*
<br/>
   Integer constants
<br/>
*/
<br/>
/*   CPU word   */
<br/>
typedef   unsigned long int   word;
<br/>
<br/>
/*   CPU hword   */
<br/>
typedef unsigned short int   hword;
<br/>
<br/>
/*   CPU quarter word   */
<br/>
typedef   unsigned char      qword;
<br/>
<br/>
/*   fixed point   */
<br/>
typedef   int   real;
<br/>
#define      product(a, b)            ( ( (a) * (b) ) &gt;&gt; 8 )
<br/>
#define      _real(x)            ( (x) &lt;&lt; 8 )
<br/>
<br/>
#endif
<br/>
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
<br/>
That is all there is to it.
<br/>
Can someone please help.
<br/>
I am falling in despair.
<br/>
<br/>
Thanks in advance.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#90484 - kusma - Fri Jun 30, 2006 1:16 pm</h4>
    <div class="postbody"><span class="postbody">declare all memory-mapped hw-registers as volatile.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#90493 - tepples - Fri Jun 30, 2006 2:01 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Schultz wrote:</b></span></td> </tr> <tr> <td class="quote">Volatiles were not forgotten.
<br/>
<br/>
[snip]
<br/>
<br/>
GBA.h
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#ifndef      __GBA
<br/>
#define      __GBA
<br/>
<br/>
// snip
<br/>
<br/>
#define      DMA_SRC(i)         (word *) (*((word *)   (0x040000B0 + 0x000C * (i))))
<br/>
#define      DMA_DEST(i)         (word *) (*((word *)   (0x040000B4 + 0x000C * (i))))
<br/>
#define      DMA_CNT(i)         *((hword *)   (0x040000B8 + 0x000C * (i)))
<br/>
#define      DMA_CTRL(i)         *((hword *)   (0x040000BA + 0x000C * (i)))
<br/>
<br/>
</td> </tr></table><span class="postbody">
<br/>
</span></td> </tr></table><span class="postbody">
<br/>
I don't see any volatiles here.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#90531 - Cearn - Fri Jun 30, 2006 5:23 pm</h4>
    <div class="postbody"><span class="postbody">All mem_copy() and DMA_Transfer() do here is write to the (global) registers once, so the volatility of the things are not the issue. That only matters when you read from or write to them multiple times consecutively. The problem is elsewhere. 
<br/>
<br/>
Your data wouldn't be a byte or halfword array in the same file, would it? (Yes, I am thinking of data alignment)
<br/>
<br/>
Also:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#define      DMA_SRC(i)         (word *) (*((word *)   (0x040000B0 + 0x000C * (i)))) 
<br/>
</td> </tr></table><span class="postbody">
<br/>
Copy-paste error? I can't even get it compiled with the outer (word *).</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#90552 - col - Fri Jun 30, 2006 7:52 pm</h4>
    <div class="postbody"><span class="postbody">After a vague recollection of some technical gotcha, I found this in Gbatek:
<br/>
<br/>
"After changing the Enable bit from 0 to 1, wait 2 clock cycles before accessing any DMA related registers."
<br/>
<br/>
Not sure if this is correct, but if so, maybe the optimiser is treating your two 16 bit registers DMA_CNT and DMA_CTRL as a single 32 bit register, and that is causing some weirdness? if you make them both volatile, this will not happen.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#90557 - Schultz - Fri Jun 30, 2006 8:33 pm</h4>
    <div class="postbody"><span class="postbody">I shall try to assume both of them are volatile.
<br/>
Nevertheless, while programming games for GBA in assembly two months ago, I used to write to both registers at once, causing no mistake.
<br/>
Thanks anyway, it was of great help.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#90568 - sniper - Fri Jun 30, 2006 9:25 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>col wrote:</b></span></td> </tr> <tr> <td class="quote">After a vague recollection of some technical gotcha, I found this in Gbatek:
<br/>
<br/>
"After changing the Enable bit from 0 to 1, wait 2 clock cycles before accessing any DMA related registers."
<br/>
<br/>
Not sure if this is correct, but if so, maybe the optimiser is treating your two 16 bit registers DMA_CNT and DMA_CTRL as a single 32 bit register, and that is causing some weirdness? if you make them both volatile, this will not happen.</td> </tr></table><span class="postbody">
<br/>
<br/>
Yes thats right, the hardware is buggy even the DMA. Take care to handle with it.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#90574 - sajiimori - Fri Jun 30, 2006 10:20 pm</h4>
    <div class="postbody"><span class="postbody">Hey Schultz, isn't the word "Zauberer"?  Just curious -- I don't know German.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#90575 - Cearn - Fri Jun 30, 2006 10:49 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>gcc -S -mthumb -O2 wrote:</b></span></td> </tr> <tr> <td class="quote">	ldr	r3,=0x040000D4
<br/>
	str	r0, [r3]
<br/>
	add	r3, r3, #4
<br/>
	str	r1, [r3]
<br/>
	add	r3, r3, #4
<br/>
	strh	r2, [r3]
<br/>
	ldr	r2,=0x8400
<br/>
	add	r3, r3, #2
<br/>
	strh	r2, [r3]
<br/>
	bx	lr
<br/>
</td> </tr></table><span class="postbody">
<br/>
This is what mem_copy() actually compiles to under devkitadv r5b3 and devkitpro r19a, -O1 and -O2, volatile and non-volatile DMA-regs. As you can see, it's pretty much what you'd expect. The function works fine for me too. The problem is probably how you're using it.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>sajimori wrote:</b></span></td> </tr> <tr> <td class="quote">Hey Schultz, isn't the word "Zauberer"? Just curious -- I don't know German.</td> </tr></table><span class="postbody">Zauberer = wizard/sorcerer
<br/>
Zahl = number
<br/>
Zahlberer= mathemagician? Heh, nice.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
