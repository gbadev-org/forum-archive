<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Headache Array =/ - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>C/C++ > Headache Array =/</h2>
<div id="posts">
<div class="post">
    <h4>#6234 - wiz - Tue May 20, 2003 10:02 am</h4>
    <div class="postbody"><span class="postbody">Hi *again* I feel bad to keep bothering everyone, but I literally have an headache :(
<br/>
<br/>
What is it I'm doing wrong? (in function main, mode 3)
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
u16 TestArray[160][160];
<br/>
<br/>
int x,y;
<br/>
<br/>
for (x = 0; x&lt;160; x++)
<br/>
  for (y = 0; y&lt;160; y++)
<br/>
    TestArray[x][y] = RGB(31,31,31);
<br/>
<br/>
for (x=0; x&lt;160; x++)
<br/>
  for (y=0; y&lt;160; y++)
<br/>
    PlotPixel(x,y,TestArray[x][y]);
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
ok so this should display a white square.. (please ignore other methods of displaying a squre as this is only a test) 
<br/>
<br/>
anything up to [80][80] in the 'first' (init) loop seems to work fine, but theres corruption when making that loop up to 160 (interestingly enough 80 is half of 160)
<br/>
<br/>
what on earth could be the reason for this problem?
<br/>
<br/>
I hate reloading the emulator every time I recompile and need to test a change it takes AGES to load :(
<br/>
<br/>
and incase you need to see pixel function its just:
<br/>
<br/>
void PlotPixel(int x,int y, u16 c)
<br/>
{
<br/>
  videoBuffer[x + (y * 240)] = (c);
<br/>
}
<br/>
<br/>
thanks</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#6237 - niltsair - Tue May 20, 2003 2:18 pm</h4>
    <div class="postbody"><span class="postbody">Mmm, that's a weird one.
<br/>
<br/>
Could we see your 'videoBuffer' Define or Declare?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#6240 - tom - Tue May 20, 2003 2:53 pm</h4>
    <div class="postbody"><span class="postbody">u16 TestArray[160][160]; 
<br/>
<br/>
is this a local variable ?
<br/>
if so, it will never fit into the stack, if it's in iwram...
<br/>
(160 * 160 * 2 = 51200 bytes)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#6245 - Touchstone - Tue May 20, 2003 7:06 pm</h4>
    <div class="postbody"><span class="postbody">Have you made sure you have enough memory to hold a 51kb buffer? IWRAM (where I assume you have your variables and stackframe) is only 32kb.<br/>_________________<br/>You can't beat our meat</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#6254 - wiz - Wed May 21, 2003 1:01 am</h4>
    <div class="postbody"><span class="postbody">I just declared this in main, I guess it is a local variable
<br/>
<br/>
u16 TestArray[160][160];
<br/>
<br/>
whats weird is that if I change it to
<br/>
<br/>
u16 TestArray[260][160];
<br/>
<br/>
I can access the 160x160.. but this obviously is not the solution (but still weird)
<br/>
<br/>
so as you say the array is too big for the memory, how do I change that to fix the problem?  I cant recall reading about this in any of the tutorials I looked at.
<br/>
<br/>
Thanks kindy
<br/>
<br/>
PS the videobuffer is declared as: u16 *videoBuffer = (u16*)0x6000000;</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#6271 - Quirky - Wed May 21, 2003 8:15 am</h4>
    <div class="postbody"><span class="postbody">If you are testing this on VBA, there are some differences to real hardware regarding memory (VBA has more under certain circumstances and won't fall victim to all of your memory errors). On real hardware, going "out of bounds" on the stack has unpredictable results. But the most likely result is that it will crash.
<br/>
<br/>
The best thing to do is rethink why you need to do this and think of a better way to go about it.  If you really must, you can place the array in ewram. It'll fit there.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
__attribute__ ((section (".ewram"))) u16 TestArray[160][160]; 
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
But the lesson to be learned from your test is "placing a giant array in memory just for the hell of it is a silly idea!" :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#6276 - wiz - Wed May 21, 2003 12:05 pm</h4>
    <div class="postbody"><span class="postbody">Thank you for that, I shall try it :)
<br/>
<br/>
The reason for the 160x160 array is that Im porting a game over from the pc.  I render the sprite in a function using pixels and there are 100 frames (at 16x16) for very smooth animation.  I wanted the sprite frames to be on an offscreen buffer so it doesnt use 100 of what is available.
<br/>
<br/>
Then I plan to use one hardware sprite cell, and copy the 16x16 from the buffer according to which cell is needed.  leaving all the other sprites for the rest of the game..
<br/>
<br/>
hopefully that makes sense ;)
<br/>
<br/>
thanks</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#6281 - niltsair - Wed May 21, 2003 2:54 pm</h4>
    <div class="postbody"><span class="postbody">Well, there's 1024 Tiles entry for sprites, if you can spare 400 of them, you could use it to compute your sprite's tiles. When your computation is done, just use DMA top copy it from their current spot to the area used to display them.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#6283 - Touchstone - Wed May 21, 2003 3:32 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>niltsair wrote:</b></span></td> </tr> <tr> <td class="quote">Well, there's 1024 Tiles entry for sprites, if you can spare 400 of them, you could use it to compute your sprite's tiles. When your computation is done, just use DMA top copy it from their current spot to the area used to display them.</td> </tr></table><span class="postbody">
<br/>
<br/>
Or more efficiently, tell the video hardware to use the tile index for your anim frame instead of copy the frame from one place in VRAM to another.<br/>_________________<br/>You can't beat our meat</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#6284 - niltsair - Wed May 21, 2003 3:42 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Touchstone wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>niltsair wrote:</b></span></td> </tr> <tr> <td class="quote">Well, there's 1024 Tiles entry for sprites, if you can spare 400 of them, you could use it to compute your sprite's tiles. When your computation is done, just use DMA top copy it from their current spot to the area used to display them.</td> </tr></table><span class="postbody">
<br/>
<br/>
Or more efficiently, tell the video hardware to use the tile index for your anim frame instead of copy the frame from one place in VRAM to another.</span></td> </tr></table><span class="postbody">
<br/>
<br/>
This is true of not too many Sprite's tiles index need to be changed, else it'll takes some time. I just don't know where exactly changing the indexs become slower than DMA the tiles. 
<br/>
<br/>
But yeah, you probably only have a little amount fo indexs to change, so it would be faster.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#6286 - Touchstone - Wed May 21, 2003 5:31 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>niltsair wrote:</b></span></td> </tr> <tr> <td class="quote">This is true of not too many Sprite's tiles index need to be changed, else it'll takes some time. I just don't know where exactly changing the indexs become slower than DMA the tiles.</td> </tr></table><span class="postbody">
<br/>
<br/>
True.<br/>_________________<br/>You can't beat our meat</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#6287 - Quirky - Wed May 21, 2003 5:50 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>niltsair wrote:</b></span></td> </tr> <tr> <td class="quote">Well, there's 1024 Tiles entry for sprites, if you can spare 400 of them, you could use it to compute your sprite's tiles. When your computation is done, just use DMA top copy it from their current spot to the area used to display them.</td> </tr></table><span class="postbody">
<br/>
<br/>
The only (minor) problem with that is that you can only access VRAM 16 bits at a time, so it would be slower than normal ram. Even more so if you want to use 16 coloured tiles - read four pixels at a time, mask three of them and change your one pixel, write all four back again. Ouch!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#6288 - niltsair - Wed May 21, 2003 6:01 pm</h4>
    <div class="postbody"><span class="postbody">mmm, i suppose he'll want to change a whole tile, tile per tile.
<br/>
<br/>
A good way would be like this :
<br/>
<br/>
u8 WorkTile[8][4];  //work memory space for tile modification
<br/>
DMA3 TileAdr(x), WorkTile, 8 | DMA_32 //Transfer the entire tile
<br/>
...
<br/>
work on WorkTile
<br/>
...
<br/>
DMA3 WorkTile, TileAdr(x), 8 | DMA_32 //Store the tile back
<br/>
<br/>
Take note that each item in WorkTile contain 2 pixels, since in 16colors, they each takes 4bits.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
