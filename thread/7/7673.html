<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Parsing bytecode - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>C/C++ > Parsing bytecode</h2>
<div id="posts">
<div class="post">
    <h4>#62584 - kevinc - Fri Dec 02, 2005 6:26 pm</h4>
    <div class="postbody"><span class="postbody">Hi. I need to write a function for a program that I'm doing, that reads from a file a bunch of "commands" as integers. The commands are very varied, like pause, push something the stack, pop it, add stuff on the stack, and so on.
<br/>
<br/>
The thing is: what is the fastest way of reading the command and choosing what is to be done? 
<br/>
I'm using a big switch list:
<br/>
<br/>
switch(commandId) {
<br/>
case 1: doThis;
<br/>
case 2: doThat;
<br/>
...
<br/>
}, 
<br/>
<br/>
but search is done in linear time (I think) and it's not exactly fast (50+ commands), it's taking about 10% of the time in simple files. And I don't think compiling it in runtime is a good idea (stuff is a little high level, like adding strings) - or secure. I was thinking of creating a function for each command, then put those functions in an array and then call them as:
<br/>
<br/>
functionArray[commandId]();
<br/>
<br/>
or something like that (if that's even possible).
<br/>
<br/>
Any ideas?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#62587 - kusma - Fri Dec 02, 2005 6:33 pm</h4>
    <div class="postbody"><span class="postbody">switch-statements are optimized by the compiler. in this case, you'd basicly get a jump-table.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#62589 - tepples - Fri Dec 02, 2005 6:56 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>kevinc wrote:</b></span></td> </tr> <tr> <td class="quote">The thing is: what is the fastest way of reading the command and choosing what is to be done? 
<br/>
I'm using a big switch list:
<br/>
<br/>
switch(commandId) {
<br/>
case 1: doThis;
<br/>
case 2: doThat;
<br/>
...
<br/>
}, 
<br/>
<br/>
but search is done in linear time (I think)</td> </tr></table><span class="postbody">
<br/>
Sometimes switch is optimized to a jump table, which is done in constant time (apart from cache effects).
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">I was thinking of creating a function for each command, then put those functions in an array and then call them as:
<br/>
<br/>
functionArray[commandId]();</td> </tr></table><span class="postbody">
<br/>
That's called a jump table, and it's very doable. However, if it turns out that GCC is using a jump table for your big switch, then you don't need to make an explicit jump table.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#62651 - MrD - Sat Dec 03, 2005 9:24 pm</h4>
    <div class="postbody"><span class="postbody">Be careful, sometimes large switches can cause your code to not compile.<br/>_________________<br/>Not active on this forum. For Lemmings DS help see its website.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#62756 - kevinc - Mon Dec 05, 2005 2:04 pm</h4>
    <div class="postbody"><span class="postbody">Thanks, I'll start researching jump tables :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#62771 - Vich - Mon Dec 05, 2005 4:54 pm</h4>
    <div class="postbody"><span class="postbody">Yeah, you should choose the array solution! Something like:
<br/>
<br/>
Like:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
<br/>
union FunctionArgument
<br/>
{
<br/>
    int i;
<br/>
    float f;
<br/>
    char c;
<br/>
};
<br/>
<br/>
typedef ArgumentList vector&lt;FunctionArgument&gt; arguments;
<br/>
<br/>
std::vector&lt;void (*)(ArgumentList)&gt; functions; // list of function pointers where the functions accept an ArgumentList as argument
<br/>
<br/>
void PushFunction(ArgumentList list)
<br/>
{
<br/>
    // push code here
<br/>
}
<br/>
<br/>
void PopFunction(ArgumentList list)
<br/>
{
<br/>
    // pop code here
<br/>
}
<br/>
<br/>
void RegisterFunctions()
<br/>
{
<br/>
    functions.push_back(PushFunction);
<br/>
    functions.push_back(PopFunction);
<br/>
}
<br/>
<br/>
int main()
<br/>
{
<br/>
    RegisterFunctions();
<br/>
    ArgumentList no_arguments; // Create an empty arguments list
<br/>
    functions[0](no_arguments); // Call PushFunction without arguments
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
The above code might not be perfect, but I'll try to remember to post some working code later. Hell, I'll even code the system myself, since it's very handy to have :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#62786 - sajiimori - Mon Dec 05, 2005 7:11 pm</h4>
    <div class="postbody"><span class="postbody">Wow, that's ridiculously inefficient.  :P  In real life, you'll want to reuse a single stack to pass arguments instead of creating a new dynamically allocated array for every call.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#62790 - Vich - Mon Dec 05, 2005 7:23 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>sajiimori wrote:</b></span></td> </tr> <tr> <td class="quote">Wow, that's ridiculously inefficient.  :P  In real life, you'll want to reuse a single stack to pass arguments instead of creating a new dynamically allocated array for every call.</td> </tr></table><span class="postbody">
<br/>
<br/>
Of course, but I just created a quick sample that was obvious and simple ;) I didn't have time to think this through, since my boss would have gone like: "shouldn't you be working?".</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#62798 - sajiimori - Mon Dec 05, 2005 8:31 pm</h4>
    <div class="postbody"><span class="postbody">Psh, real life has no place in video game programming!  =P</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#62840 - Vich - Tue Dec 06, 2005 9:44 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>sajiimori wrote:</b></span></td> </tr> <tr> <td class="quote">Psh, real life has no place in video game programming!  =P</td> </tr></table><span class="postbody">
<br/>
<br/>
My life(and my job) ?s video game programming ;)
<br/>
(I'm gameplay programmer, but in my spare time, I like to do some tech code too)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#62864 - kevinc - Tue Dec 06, 2005 4:04 pm</h4>
    <div class="postbody"><span class="postbody">Hmm, now that you mentioned it, which is more practical? A stack using std classes or implement a simpler one?
<br/>
<br/>
I also have to handle a map and I've been wondering whether to use std::map (which uses black/red trees but too many templates to count) or create my simple own using AVL trees :P. Is it worth it?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#62922 - sajiimori - Tue Dec 06, 2005 11:12 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">My life(and my job) ?s video game programming ;)</td> </tr></table><span class="postbody">Cool, me too.  :)
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Hmm, now that you mentioned it, which is more practical? A stack using std classes or implement a simpler one?</td> </tr></table><span class="postbody">You mean like std::stack?  Totally depends on the situation.  Some implementations use a singly linked list and dynamically allocate every link as it's pushed and deallocate it when it's popped.  In code that isn't speed-critical, that might be okay.  The standard interface doesn't seem to include a reserve() method, so there will be allocation every time it grows, regardless of the underlying implementation.
<br/>
<br/>
For anything speed-critical, always check how the standard library stuff is implemented, and replace it if it isn't good enough.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">I also have to handle a map and I've been wondering whether to use std::map (which uses black/red trees but too many templates to count) or create my simple own using AVL trees :P. Is it worth it?</td> </tr></table><span class="postbody">My approach has been the following.  Step 1: See if something simpler than an associative container can be used, and whether the simpler approach is better.  Step 2: Try std::map and see if it's good enough.  Step 3: Replace it if necessary.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
