<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>problems with rotating sprites - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>C/C++ > problems with rotating sprites</h2>
<div id="posts">
<div class="post">
    <h4>#6719 - [squire] - Mon Jun 02, 2003 7:11 am</h4>
    <div class="postbody"><span class="postbody">could someone out there please tell me what i'm doing wrong?
<br/>
boomarang, is a 16x16 pixel sprite, in 16 colours.
<br/>
as soon as i set either the roation bit or double size bit, the sprite will not
<br/>
be displayed, it shows up fine if neither of those 2 bits are set.
<br/>
any ideas anyone?
<br/>
thanks, [squire]
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#include &lt;math.h&gt;
<br/>
#include "headers\gba.h"
<br/>
#include "headers\screenmode.h"
<br/>
#include "headers\sprite.h"
<br/>
#include "boomarang.c"
<br/>
<br/>
#define RADIAN(n) (((float)n)/(float)180*PI)
<br/>
FIXED angle,zoom;
<br/>
FIXED SIN[360],COS[360];
<br/>
<br/>
OAMEntry sprites[128];
<br/>
u16 x,y,z;
<br/>
u16 n,m,i;
<br/>
s16 BoomarangX,BoomarangY;
<br/>
<br/>
void CopyOAM() {
<br/>
   u16* temp;
<br/>
   temp=(u16*)sprites;
<br/>
   for(i=0;i&lt;128*4;i++) OAMmem[i]=temp[i];
<br/>
}
<br/>
<br/>
void InitializeSprites() {
<br/>
   for(i=0;i&lt;128;i++) {
<br/>
      sprites[i].attribute0 = 160;
<br/>
      sprites[i].attribute1 = 240;
<br/>
   }
<br/>
}
<br/>
<br/>
void WaitForVsync() {
<br/>
   while((volatile u16)REG_VCOUNT == 160){}
<br/>
   while((volatile u16)REG_VCOUNT != 160){}
<br/>
}
<br/>
<br/>
void RotateSprite(int rotDataIndex, int angle, FIXED x_scale,FIXED y_scale) {
<br/>
   FIXED pa,pb,pc,pd;
<br/>
<br/>
   pa = ((x_scale) * COS[angle])&gt;&gt;8;    //(do my fixed point multiplies and shift back down)
<br/>
   pb = ((y_scale) * SIN[angle])&gt;&gt;8;
<br/>
   pc = ((x_scale) * -SIN[angle])&gt;&gt;8;
<br/>
   pd = ((y_scale) * COS[angle])&gt;&gt;8;
<br/>
<br/>
   rotData[rotDataIndex].pa = pa;  //put them in my data struct
<br/>
   rotData[rotDataIndex].pb = pb;
<br/>
   rotData[rotDataIndex].pc = pc;
<br/>
   rotData[rotDataIndex].pd = pd;
<br/>
}
<br/>
<br/>
int main() {
<br/>
   //compute my Look up tables
<br/>
   for(i=0;i&lt;360;i++) {
<br/>
      SIN[i]=(FIXED)(sin(RADIAN(i))*256);  //sin and cos are computed and cast to fixed                     //fixed
<br/>
      COS[i]=(FIXED)(cos(RADIAN(i))*256);
<br/>
   }
<br/>
<br/>
   SetMode(MODE_2|OBJ_ENABLE|OBJ_MAP_1D);
<br/>
<br/>
   for(i=0;i!=16;i++) OBJPaletteMem[i+16]=boomarang_Palette[i];
<br/>
<br/>
   InitializeSprites();
<br/>
   BoomarangX=64;BoomarangY=64;
<br/>
   for(i=0;i&lt;(16*16/4);i++) {
<br/>
      OAMdata[i+2560]=boomarang_Char[(i&lt;&lt;1)+1];
<br/>
      OAMdata[i+2560]=(OAMdata[i+2560]&lt;&lt;8)+boomarang_Char[(i&lt;&lt;1)];
<br/>
   }
<br/>
<br/>
   while(1) {
<br/>
      if(BoomarangX&lt;0) x=512+BoomarangX;
<br/>
      else x=BoomarangX;
<br/>
      if(BoomarangY&lt;0) y=256+BoomarangY;
<br/>
      else y=BoomarangY;
<br/>
      RotateSprite(0,180,1,1);
<br/>
      sprites[ 0].attribute0 = COLOR_16|SQUARE|SIZE_DOUBLE|ROTATION_FLAG|y;
<br/>
      sprites[ 0].attribute1 = SIZE_16|ROTDATA(0)|x;
<br/>
      sprites[ 0].attribute2 = PALETTE(1)|160;
<br/>
<br/>
      WaitForVsync();
<br/>
      CopyOAM();
<br/>
   }
<br/>
}
<br/>
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#6740 - syscan - Mon Jun 02, 2003 2:25 pm</h4>
    <div class="postbody"><span class="postbody">in CopyOAM() func, OAMmem is u32 defined in gba.h
<br/>
<br/>
"define OAM  ((u16*)0x7000000)"  instead of OAMmem</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#6753 - [squire] - Mon Jun 02, 2003 3:39 pm</h4>
    <div class="postbody"><span class="postbody">i don't think that's the problem.
<br/>
as OAMmem is defined in gba.h as
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#define OAMmem       ((u16*)0x7000000)</td> </tr></table><span class="postbody">
<br/>
and i don't see why i would have to define the memory address twice.
<br/>
the thing is, the sprite shows fine, if i don't set either the rotation bit or the
<br/>
double size bit.
<br/>
i'm now thinking it may be something to do with it being a 16 colour sprite.
<br/>
<br/>
[squire]</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#6758 - Touchstone - Mon Jun 02, 2003 4:09 pm</h4>
    <div class="postbody"><span class="postbody">What happen if you set the rotation registers to "1:1" mapping? In other words:
<br/>
PA = 0x0100
<br/>
PB = 0
<br/>
PC = 0
<br/>
PD = 0x0100
<br/>
<br/>
Are you sure rotData points to the right place?<br/>_________________<br/>You can't beat our meat</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#6762 - [squire] - Mon Jun 02, 2003 4:50 pm</h4>
    <div class="postbody"><span class="postbody">okay i've got it fixed,
<br/>
my problem was the stupid overlooking of the fact the zoom scaling factor
<br/>
is a fixed number and not a float.
<br/>
so where i call.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
      RotateSprite(0,180,1,1); 
<br/>
</td> </tr></table><span class="postbody">
<br/>
i should have called it as
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
      RotateSprite(0,180,1&lt;&lt;8,1&lt;&lt;8); 
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
i'm such a dumbass.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
