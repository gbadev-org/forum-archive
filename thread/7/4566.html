<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Using "extern" with functions - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>C/C++ > Using "extern" with functions</h2>
<div id="posts">
<div class="post">
    <h4>#31011 - Wriggler - Tue Dec 07, 2004 1:11 am</h4>
    <div class="postbody"><span class="postbody">Ok, this should be something easy that should just work. I'm baffled as to why it doesn't, but it's got to be one of those really obvious mistakes. Hopefully one of you fellas could help me out?
<br/>
<br/>
In bg.h-&gt;
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">extern void initBg();</td> </tr></table><span class="postbody">
<br/>
<br/>
In main.c-&gt;
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#include "bg.h"
<br/>
...
<br/>
initBg();</td> </tr></table><span class="postbody">
<br/>
<br/>
In my makefile-&gt;
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">arm-elf-gcc main.c bg.c -c -g -O2</td> </tr></table><span class="postbody">
<br/>
<br/>
<br/>
...
<br/>
<br/>
However... when linking I get this:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">main.o(.text+0x462): In function `main':
<br/>
c:\...\main.c:22: undefined reference to `initBg'
<br/>
collect2: ld returned 1 exit status</td> </tr></table><span class="postbody">
<br/>
<br/>
What the devil is going on? Surely if I declare something as "extern", that means it's available in all linked files?
<br/>
<br/>
I've also tried compiling them separately (giving main.o and bg.o) and then linking them. However, then I get loads of "multiple definition" errors. And I suppose that's correct, as my headers use "#ifndefine...#define" to set all the globals. If they're compiled separately, they'll both have the full whack included and then we'll get issues at link time.
<br/>
<br/>
I'm so confused. Which is the best way to do it? Compiling both .c into a single .o, or linking many .o's? Why am I getting these silly errors?
<br/>
<br/>
(I'm using DevKitArm if it makes any difference...)
<br/>
<br/>
Thanks in advance,
<br/>
<br/>
Ben</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#31015 - Touchstone - Tue Dec 07, 2004 1:24 am</h4>
    <div class="postbody"><span class="postbody">The obvious question, do you have an implementation of initBg() somewhere? I suppose you do but you haven't stated it in your post so I thought I'd ask. Maybe it's a parameter mismatch?
<br/>
<br/>
Your makefile line compiles both your C files into a binary executable, no? Personally I compile all C files into object files which I link together later, mainly because that's the only way I know how to do it. :)
<br/>
<br/>
If you get the "multiple definition" error that probably means your header file actually implements something, perhaps a variable, and I'm sure you know that that's bad. ifndef/define/endif doesn't save you from that problem regardless of how you compile your code, at least not to my knowledge, because defines are only known to the compiler for each C file that is compiled, and when a new file is compiled all definitions are cleared.<br/>_________________<br/>You can't beat our meat</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#31017 - poslundc - Tue Dec 07, 2004 1:34 am</h4>
    <div class="postbody"><span class="postbody">Try reversing the order of your files on the command line, so it's bg.c then main.c.
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#31026 - sajiimori - Tue Dec 07, 2004 2:21 am</h4>
    <div class="postbody"><span class="postbody">I didn't even know you were allowed to compile and link multiple .c files in one call to gcc. :o</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#31047 - R0d Longfella - Tue Dec 07, 2004 10:29 am</h4>
    <div class="postbody"><span class="postbody">Try: In bg.h-&gt; 
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void initBg(); </td> </tr></table><span class="postbody">
<br/>
<br/>
To my knowledge you're not supposed to use extern with function declarations. So try it without the extern for a change.
<br/>
<br/>
Goodluck!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#31051 - Wriggler - Tue Dec 07, 2004 12:19 pm</h4>
    <div class="postbody"><span class="postbody">Hi guys, thanks for the help.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">The obvious question, do you have an implementation of initBg() somewhere?</td> </tr></table><span class="postbody">
<br/>
<br/>
Yup, it's in there. Sorry I didn't mention it. Parameter's aren't mismatched.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">If you get the "multiple definition" error that probably means your header file actually implements something, perhaps a variable, and I'm sure you know that that's bad.</td> </tr></table><span class="postbody">
<br/>
<br/>
After a quick look at some of my includes, some of them implement global vars (whoops!). I'll fix these when I get back home, but even still bg.h isn't one of those headers.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Try reversing the order of your files on the command line, so it's bg.c then main.c.</td> </tr></table><span class="postbody">
<br/>
<br/>
Tried that, no change unfortunately.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">So try it without the extern for a change</td> </tr></table><span class="postbody">
<br/>
<br/>
That's how I was doing it in the first place, but I was told to use the extern keyword. It doesn't seem to make a difference, as I believe the compiler adds "extern" to function declarations anyway. Can anybody clear this up for me? Are you supposed to use "extern" on function declarations or not?
<br/>
<br/>
The problem might be as above, e.g. those header files defining global variables. Unfortunately I can't check it out at the moment, but will give it a go tonight and report back.
<br/>
<br/>
Thanks again for the help guys.
<br/>
<br/>
Ben</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#31097 - sajiimori - Tue Dec 07, 2004 9:16 pm</h4>
    <div class="postbody"><span class="postbody">I've never seen a difference when putting extern on function declarations.
<br/>
<br/>
Anyway, your original post only shows how you are compiling.  How are you linking?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#31204 - jma - Wed Dec 08, 2004 9:06 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>sajiimori wrote:</b></span></td> </tr> <tr> <td class="quote">I've never seen a difference when putting extern on function declarations.</td> </tr></table><span class="postbody">
<br/>
<br/>
It can make a big difference if you are using <span style="font-weight: bold">extern "C"</span> for name mangling purposes.
<br/>
<br/>
Jeff<br/>_________________<br/><a href="mailto:massung@gmail.com">massung@gmail.com</a>
<br/>
<a href="http://www.retrobyte.org" target="_blank">http://www.retrobyte.org</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#31210 - bertsnks - Wed Dec 08, 2004 10:06 pm</h4>
    <div class="postbody"><span class="postbody">I've had the same problem with code from an asm file compiled to .o, and adding it to my c source. 
<br/>
<br/>
<br/>
extern "C" myfunct(void);
<br/>
<br/>
^^ this made it work.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#31219 - sajiimori - Wed Dec 08, 2004 11:23 pm</h4>
    <div class="postbody"><span class="postbody">*sigh*
<br/>
<br/>
I've never seen a difference when adding <span style="font-weight: bold">only</span> extern on a function declaration.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#31225 - Wriggler - Thu Dec 09, 2004 12:48 am</h4>
    <div class="postbody"><span class="postbody">Sorry about the delay in replying to this thread guys, I'm just trying out a couple more things before I report back...
<br/>
<br/>
*grumble* ...Stupid compiler... ;)
<br/>
<br/>
Thanks to all for the help.
<br/>
<br/>
Ben</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#31227 - jma - Thu Dec 09, 2004 12:54 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>sajiimori wrote:</b></span></td> </tr> <tr> <td class="quote">*sigh*</td> </tr></table><span class="postbody">
<br/>
<br/>
Hehe, I was more teasing than anything. I shoulda put a smiley :)
<br/>
<br/>
Jeff<br/>_________________<br/><a href="mailto:massung@gmail.com">massung@gmail.com</a>
<br/>
<a href="http://www.retrobyte.org" target="_blank">http://www.retrobyte.org</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#31230 - sajiimori - Thu Dec 09, 2004 1:24 am</h4>
    <div class="postbody"><span class="postbody">You can't charm me with your smileys!! ;)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#31234 - poslundc - Thu Dec 09, 2004 2:09 am</h4>
    <div class="postbody"><span class="postbody">For the record, sajimori correctly identified what the most likely problem is, which is that you've changed your compile line to include the new file, but not your linking line. Look for another spot in your makefile where you call either <span style="font-weight: bold">gcc</span> or <span style="font-weight: bold">ld</span> on main.o, and make sure that you are calling it on bg.o as well.
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#31259 - Wriggler - Thu Dec 09, 2004 9:17 am</h4>
    <div class="postbody"><span class="postbody">Hi Dan, thanks for the advice. Fortunately my linking was ok, I did exactly as you described. I finally got the files linking in ok (and did a little dance around the room!), but then I came to another problem.
<br/>
<br/>
All of my globals are now invisible to each of the .c files. Stuff that I can't avoid, like the OAM Copy. For the life of me I can't figure out how I'm supposed to arrange the declarations so that I can use them in all files. At the moment I have a global header, which looks a bit like this:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">extern OAMEntry gSprites[128];</td> </tr></table><span class="postbody">
<br/>
<br/>
This is #included in every source file, so basically each .o I generate will expect OAMEntry to be linked in, right?
<br/>
<br/>
Then in my main.c file, I write this...
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">OAMEntry gSprites[128];</td> </tr></table><span class="postbody">
<br/>
<br/>
...which makes the one "instance" I wish to use. Is that right? Then whenever I change gSprites (in any file), I know that there will only be one version of it? Is that the right theory? Because it's not working! :)
<br/>
<br/>
Cheers guys,
<br/>
<br/>
Ben</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#31260 - sajiimori - Thu Dec 09, 2004 9:36 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">I finally got the files linking in ok...</td> </tr></table><span class="postbody">So what did the problem turn out to be (for future readers who might encounter a similar issue)?</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">This is #included in every source file, so basically each .o I generate will expect OAMEntry to be linked in, right?</td> </tr></table><span class="postbody">The portion of the header you posted looks right.  All references to the array have to be resolved by the linker, but just declaring the array doesn't generate a reference.  You can declare nonexistant extern data without causing problems, as long as you don't try to use it.</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Is that the right theory? Because it's not working! :)</td> </tr></table><span class="postbody">It looks right, so maybe you could give some more information about the error (if there is one) and how you are doing things.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#31314 - poslundc - Thu Dec 09, 2004 11:26 pm</h4>
    <div class="postbody"><span class="postbody">You shouldn't have the extern declaration in the same .c file that also has the actual instance declaration. This should generate a compile-time error if you try it.
<br/>
<br/>
An effective trick to guard against this is to surround your globals in the .h file with the barrier:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#ifndef _MAIN_HEADER_
<br/>
#define _MAIN_HEADER_
<br/>
<br/>
// structures, prototypes, etc.
<br/>
<br/>
#ifndef _MAIN_SOURCE_
<br/>
<br/>
extern int myGlobalVariable;
<br/>
<br/>
#endif
<br/>
#endif</td> </tr></table><span class="postbody">
<br/>
<br/>
... and then in your main.c file define _MAIN_SOURCE_ before including the header file, as follows:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#define _MAIN_SOURCE_
<br/>
#include "main.h"
<br/>
<br/>
...
<br/>
<br/>
int myGlobalVariable;</td> </tr></table><span class="postbody">
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#31315 - sajiimori - Thu Dec 09, 2004 11:37 pm</h4>
    <div class="postbody"><span class="postbody">I disagree.  I think it should be an error if you <span style="font-style: italic">don't</span> have a prior prototype for a non-static function, because it should be assumed that modules include their own headers, and if those headers don't have the prototype then it will be a phantom global.  (I realize that your example wouldn't actually create a phantom global.)
<br/>
<br/>
Our compiler currently gives warnings about such cases, but I've never seen a compiler give an error or warning about having an extern function declaration followed by a non-static definition of that function.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#31342 - poslundc - Fri Dec 10, 2004 7:18 am</h4>
    <div class="postbody"><span class="postbody">I'm confused... was it perhaps unclear that I was responding to Wriggler's most recent post and not yours? I was referring strictly to the definition/sharing of global variables, not prototyping of functions... I am having trouble understand your first paragraph as it relates to this.
<br/>
<br/>
In any case, I think my solution is perhaps a bit hacky, although I think I've seen it used quite often by other programmers as a good way to maintain the 1 C file : 1 header file ratio, and have the header contain all the necessary public information for the module. It more has to do with the quirkiness of C not allowing you to declare a global variable and have an extern reference to it in the same file.
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#31343 - sajiimori - Fri Dec 10, 2004 7:28 am</h4>
    <div class="postbody"><span class="postbody">While I didn't notice you were specifically referring to variables as opposed to functions, my point applies to both.
<br/>
<br/>
I've never seen a compiler complain about having an extern declaration followed by a definition of the same function or variable (which would be annoying and useless), but I have seen one complain about getting a global function definition without first seeing a declaration (which is actually a helpful warning).</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#31376 - poslundc - Fri Dec 10, 2004 5:50 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>sajiimori wrote:</b></span></td> </tr> <tr> <td class="quote">I've never seen a compiler complain about having an extern declaration followed by a definition of the same function or variable (which would be annoying and useless)</td> </tr></table><span class="postbody">
<br/>
<br/>
I agree wholeheartedly, but to the best of my memory every version of GCC I've used does this. The fact that other programs do similar shielding is evidence that I'm not the only one to experience it, either. But yes, it is a positively stupid quirk, considering function prototypes behave in the opposite manner.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">but I have seen one complain about getting a global function definition without first seeing a declaration (which is actually a helpful warning).</td> </tr></table><span class="postbody">
<br/>
<br/>
In practice this shouldn't be as much of a problem, since tradition (and sense) has #includes come before global variable definitions, since the types of those variables may be defined in the #include statements. Even novice programmers seem to naturally abide by this. *shrug*
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#31393 - sajiimori - Fri Dec 10, 2004 7:54 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">I agree wholeheartedly, but to the best of my memory every version of GCC I've used does this.</td> </tr></table><span class="postbody">Hmm... so this gets a warning for you?</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">/*gcc -Wall*/ extern int x; int x;</td> </tr></table><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">In practice this shouldn't be as much of a problem...</td> </tr></table><span class="postbody">The warning helps me when I forget to put 'static' on something I want to be private.  It doesn't see a declaration in the header, so it assumes I meant to either add one or change to 'static', which is always the case.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#31406 - poslundc - Fri Dec 10, 2004 8:59 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>sajiimori wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">I agree wholeheartedly, but to the best of my memory every version of GCC I've used does this.</td> </tr></table><span class="postbody">Hmm... so this gets a warning for you?</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">/*gcc -Wall*/ extern int x; int x;</td> </tr></table><span class="postbody"></span></td> </tr></table><span class="postbody">
<br/>
<br/>
Sadly I am on vacation at the moment at a computer without GCC, so I am unable to test it... :P When I get back I can have a look and see, but it was this reason that caused me to start using those shields in the first place.
<br/>
<br/>
I take it that you are asking because you have observed different results in your compiler... it is quite possible that it was removed from later versions of it; I'm running something, uh, less than 3.x at home.
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#31422 - tepples - Fri Dec 10, 2004 10:25 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>sajiimori wrote:</b></span></td> </tr> <tr> <td class="quote">The warning helps me when I forget to put 'static' on something I want to be private.  It doesn't see a declaration in the header, so it assumes I meant to either add one or change to 'static', which is always the case.</td> </tr></table><span class="postbody">
<br/>
So what does it do for int main(int argc, char **argv)?<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#31423 - sajiimori - Fri Dec 10, 2004 10:27 pm</h4>
    <div class="postbody"><span class="postbody">I'm assuming the compiler has a special case for that, just as it's a special case for the programmer.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
