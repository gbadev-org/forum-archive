<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Tiling Code has me Stumped. - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>C/C++ > Tiling Code has me Stumped.</h2>
<div id="posts">
<div class="post">
    <h4>#35006 - kareemjg - Sat Jan 29, 2005 7:29 am</h4>
    <div class="postbody"><span class="postbody">Okay I've been dreading sending this post.. I've been going over this for about two days and while my mistakes have taught me a lot in that time I still have not managed to solve my problem. The main premise is i'm building an rpg engine for learning sake and I've been doing some hard core disecting of the various turtoial sources.  Now my problem lies in my displaying the map onto the screen.  Which normally should be a easy task.  I have verifed the tiles are in the right memory locations along with the maps. I can see the information in the right address via VBA so I think the problems lies with the code that I have displaying the map memory register.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
<br/>
int main()
<br/>
 {
<br/>
        
<br/>
   //Looping variables
<br/>
   int loop,x,y;
<br/>
   
<br/>
   //Background 0
<br/>
   REG_BG0CNT = BIT02 | BIT07;
<br/>
<br/>
<br/>
   //Mode 0, BG0
<br/>
   SetMode(MODE_0 | BG0_ENABLE);
<br/>
         
<br/>
   //Load the palette into background palette memory      
<br/>
   for (loop = 0; loop &lt; MaxPalColor; loop++)
<br/>
      theScreenPalette[loop] = map_demo000PAL[loop];
<br/>
<br/>
   //Load the tiles into background memory ***HRMM
<br/>
   for (loop = 0; loop &lt; 272; loop++)
<br/>
      theTileMemory[loop] = map_demo000TILE[loop];
<br/>
<br/>
   //Load the map into the VideoBuffer
<br/>
   for (y=0;y&lt;32;y++)
<br/>
   {
<br/>
      for (x=0;x&lt;32;x++)
<br/>
      {
<br/>
         theVideoBuffer[y*32+x]=map_demo000[y*32+x];
<br/>
         
<br/>
      
<br/>
      }
<br/>
   }
<br/>
 
<br/>
  }//end main
<br/>
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Here are my header references in case you are wondering
<br/>
<br/>
#define REG_BG0CNT     	(*(volatile u16*)0x4000008)
<br/>
<br/>
#define BGPaletteMem 	((volatile u8*)0x5000000)
<br/>
static u16* theScreenPalette = (u16*)BGPaletteMem;
<br/>
<br/>
#define BGTileMem	((u16*)0x6004000)
<br/>
static u16* theTileMemory = (u16*)BGTileMem;
<br/>
<br/>
#define VideoBuffer ((volatile u16*)0x6000000)
<br/>
<br/>
---
<br/>
Now from what I see on the VBA my tiles are loading in properly, and my map seems to be there also but the tiles are not right.  I included a picture of what I'm seeing also a link to the full zip code that includes the tiles files with rom. Thanks for taking the time to look at this.  I'm thinking the problem is at my tile loop. The loop is 272 because that is the number in my tiles array.. plus it shows up good when viewing tiles in VBA. I was trying to avoid having to ask for guidance on something that should be so routine.
<br/>
<br/>
<a href="http://www.khova.com/prjsite/downloads/RPGEngine012905.zip" target="_blank">http://www.khova.com/prjsite/downloads/RPGEngine012905.zip</a>
<br/>
<a href="http://www.khova.com/prjsite/downloads/RPGEngine.png" target="_blank">http://www.khova.com/prjsite/downloads/RPGEngine.png</a>
<br/>
<a href="http://www.khova.com/prjsite/downloads/RPGEngine.elf" target="_blank">http://www.khova.com/prjsite/downloads/RPGEngine.elf</a>
<br/>
<br/>
Thanks
<br/>
-kareem</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#35020 - Cearn - Sat Jan 29, 2005 2:34 pm</h4>
    <div class="postbody"><span class="postbody">The tiles are 16-color tiles, while you have your background set up for 256 color tiles. Not setting bit7 of REG_BG0CNT should produce better results. It might be better to use named constants for this stuff rather than raw bit-numbers, that way it's easier to see what you're actualy doing.
<br/>
Even after switching to 16-color mode I still get a strange picture, though, but this appears to be because the map data itself uses palette 0 for some tiles and palette 1 for others. If that was supposed to happen, then nevermind.
<br/>
<br/>
It's probably not a good idea to let GBA programs end, by the way, since there's no operating system to fall back on. That's why you'll often see "while(1);" at the end of main() in demos.
<br/>
<br/>
I also got a slew of compiler warnings because theTileMemory and others were 'defined but never used'
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#define BGPaletteMem ((volatile u8*)0x5000000) 
<br/>
static u16* theScreenPalette = (u16*)BGPaletteMem; 
<br/>
<br/>
#define BGTileMem ((u16*)0x6004000) 
<br/>
static u16* theTileMemory = (u16*)BGTileMem; 
<br/>
</td> </tr></table><span class="postbody">
<br/>
is <span style="font-style: italic">not</span> a good way of doing things, especially in header files. Because of the static keyword, theScreenPalette and theTileMemory variables will appear in every file that includes gba.h. Not only is this a waste of memory (or at least it should be, but apparently GCC will optimize this out), it is also pointless and potentially dangerous. It is dangerous because, since they're non-const, you can change these pointers. And even if you intended to allow this, they will be changed on a file-by-file basis. It is also pointless because the defines themselves already are the pointers that you're looking for. Well, except for the BGPaletteMem one, which should have been defined as a u16* pointer in the first place.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#35026 - kareemjg - Sat Jan 29, 2005 3:28 pm</h4>
    <div class="postbody"><span class="postbody">Thanks Cearn for taking a look at it for me.  I feel kinda ashamed about my sloppy coding but it was points well worth mentioning.  Also thanks on the BIT help because I really was having a hell of a time.  I think the problem was due to a miscaluation of Cowbites formula but now for the light of me I cant figure out what I was thinking.  Just to make sure I understand this.  BIT 2 = 0004 hex = 4 decmial = 0100 in binary.  And 
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
F E D C  B A 9 8  7 6 5 4  3 2 1 0 
<br/>
Z Z V M  M M M M  A C X X  S S P P 
<br/>
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
so that would put us at the S where 
<br/>
Starting address of character tile data
<br/>
          Address = 0x6000000 + S * 0x4000
<br/>
<br/>
So really S = 1 the binary digit.  I was doing my math all wrong thinking that the formula evaulated as (0x6000000 + S) * x4000 so my S would then be one.  But in reality the multi is suppose to be done first where it makes sense now that S is one.  
<br/>
<br/>
Really thanks so much.
<br/>
<br/>
-kareem
<br/>
<br/>
-Microsoft SpellChecker taught me how not to spell.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#35043 - sajiimori - Sat Jan 29, 2005 7:55 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Not only is this a waste of memory (or at least it should be, but apparently GCC will optimize this out), it is also pointless and potentially dangerous.</td> </tr></table><span class="postbody">This caught my eye.  Do you mean GCC should not perform the optimization?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#35055 - Touchstone - Sat Jan 29, 2005 10:54 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>sajiimori wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Not only is this a waste of memory (or at least it should be, but apparently GCC will optimize this out), it is also pointless and potentially dangerous.</td> </tr></table><span class="postbody">
<br/>
This caught my eye.  Do you mean GCC should not perform the optimization?</span></td> </tr></table><span class="postbody">
<br/>
That's not how I interpret his writing. To me it's sounds more like he is a bit surprised, but I don't think he says anything about what the compiler should or should not do.
<br/>
<br/>
Btw, how come you ask?<br/>_________________<br/>You can't beat our meat</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#35059 - Cearn - Sat Jan 29, 2005 11:17 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>sajiimori wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Not only is this a waste of memory (or at least it should be, but apparently GCC will optimize this out), it is also pointless and potentially dangerous.</td> </tr></table><span class="postbody">This caught my eye.  Do you mean GCC should not perform the optimization?</span></td> </tr></table><span class="postbody">
<br/>
Fair enough, I can't quote chapter and verse about this, but I did expect the thing to be just another global variable with it's own symbol, memory location and everything. But when I checked the map file I couldn't find it. I should have realized that it wouldn't create a symbol, because that's the point of having something static, but I didn't. &lt;carl&gt;Moo, moo moo&lt;/carl&gt;. 
<br/>
<br/>
I've take a closer look at things, and this is what appears to be going on:
<br/>
The static variable <span style="font-style: italic">does</span> create its own variable in each file, but <span style="font-style: italic">only</span> if it is also used in each file. Since none of the data CPP files use those static variables, no space is allocated for them. If I add a function that does use, say, theTileMemory, then I do indeed get another definition of that variable in that file too.
<br/>
At least I that would happen if I compile the files separately. In this particular case, all the files are #included into main.cpp (I recall a few threads saying that this is a bad practice, but I can't find those anymore, sorry), so in the end it's just one big file that's being compiled anyway, and there would be only one definition of each static. 
<br/>
(Incidentally, <span style="font-weight: bold">const</span> variables in cpp files are considered static unless preceded by an <span style="font-weight: bold">extern</span> declaration of said variable. A nice little inconsistency with regular C.)
<br/>
<br/>
So in the end it's a little of both. If the static variable is defined (or #included, which is basically the same thing) in multiple files and compiled separately, then it will have a memory location in each of the files that actually uses it too.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#35339 - ImInABand - Thu Feb 03, 2005 7:29 am</h4>
    <div class="postbody"><span class="postbody">i learned tile mode in roughly 4 hours, from scratch.  the only prior knowledge i had was bitmap modes, some sprite tricks, basic programming, and a fw other nifty things i had picked up.
<br/>
<br/>
i pretty much stared at TONC's walkthrough, and modified it to something i understood.  instead of using the for() call to do my mapping, i used the memcpy() command, and a few other things.  use it just like you would for implementing sprite data, just make sure youre putting the correct data in the correct address.
<br/>
<br/>
i know memcpy isnt the best way to go, but it works for me.
<br/>
<br/>
the link to TONC is as follows:
<br/>
<br/>
<a href="http://user.chem.tue.nl/jakvijn/tonc/toc.htm" target="_blank">http://user.chem.tue.nl/jakvijn/tonc/toc.htm</a>
<br/>
<br/>
<br/>
but as far as everything goes, yeah you just needed to declare it as 16 colors, the map is a bit messed up, i tried messing with the map offsets if it produces a map that makes a bit more sense, but i think it was just the map that you programmed that was a bit messed up.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
