<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Trivial stuff on LUTs - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>C/C++ > Trivial stuff on LUTs</h2>
<div id="posts">
<div class="post">
    <h4>#157383 - Polaris - Fri May 23, 2008 6:11 am</h4>
    <div class="postbody"><span class="postbody">So I'm trying to change an objects position along the X and Y axis respectively using the sine and cosine functions. In any other place I wouldn't mind using sin() and cos() to do this, but since those are slow as molasses in the DS I have turned to libnds LUTs.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">int positionX;
<br/>
int positionY;
<br/>
int _stepX = SIN[_angle &amp; SPRITE_ANGLE_MASK] &gt;&gt; 4;
<br/>
int _stepY = COS[_angle &amp; SPRITE_ANGLE_MASK] &gt;&gt; 4;
<br/>
<br/>
_positionX += _stepX; 
<br/>
_positionY += _stepY; </td> </tr></table><span class="postbody">
<br/>
<br/>
That's roughly what i'm doing right now, and ofcourse it doesn't work. What I can't wrap my head around is why. I'm obviously missing a very important detail here. 
<br/>
<br/>
I'm guessing it has something to do with fixed point values because this method works if I use sin() and cos() and the <span style="font-weight: bold">[_angle &amp; SPRITE_ANGLE_MASK] &gt;&gt; 4</span> bit is pretty much littered all over the place as "the thing to do" with the LUTs.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#157385 - simonjhall - Fri May 23, 2008 7:43 am</h4>
    <div class="postbody"><span class="postbody">Just in case you missed it, you know that 'angle' goes from 0-511, right? So 0 = 0 degrees, 511 = 359 degrees?<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#157387 - kusma - Fri May 23, 2008 8:02 am</h4>
    <div class="postbody"><span class="postbody">Just for clarity: 511 = ~359 degrees (or 359.2969...), not 359 exactly</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#157389 - nanou - Fri May 23, 2008 10:19 am</h4>
    <div class="postbody"><span class="postbody">OT: Each "nintendo degree" is almost exactly 2/3 of regular degrees (512x2 = 1024 ~~ 360x3 = 1080.) Like "nintendo seconds" which also tend to be shorter (remember SMB? That timer doesn't show real seconds.)<br/>_________________<br/>- nanou</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#157396 - Polaris - Fri May 23, 2008 3:17 pm</h4>
    <div class="postbody"><span class="postbody">I understand that what goes inside the [] should be a number in the 0-511. But isn't exactly that what the AND'ing with the bit mask doing? Taking what ever _angle has at the moment and triming it so that it is left as something between 0-511. 
<br/>
<br/>
By the way SPRITE_ANGLE_MASK is 0x01FF.
<br/>
<br/>
What fixed point format do the trig luts use? I'm pretty sure that will be of great help.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#157398 - eKid - Fri May 23, 2008 3:50 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Polaris wrote:</b></span></td> </tr> <tr> <td class="quote">What fixed point format do the trig luts use? I'm pretty sure that will be of great help.</td> </tr></table><span class="postbody">
<br/>
They are in 4.12 format.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#157404 - Polaris - Fri May 23, 2008 6:17 pm</h4>
    <div class="postbody"><span class="postbody">OK I think i'm getting this.
<br/>
<br/>
When I do &gt;&gt; 4 on the value returned by the LUTs I am actually turning it into 8.8, right? So if I wanted to add that number to my position, it in turn should also be 8.8, to keep everything in the correct place, right?
<br/>
<br/>
The part that's giving me trouble is what comes after that, which is a bit of topic :( I got my crud pixel plotting function that takes 2 ints as parameters(x and y screen positions) and inside it manages them as regular ints(with no fixed point).
<br/>
<br/>
I tried triming all the stuff to the left of the fixed point by doing &gt;&gt; 8, hoping it would turn the number into a regular int that my function could use properly, but that didn't worked quite right.   
<br/>
<br/>
Is changing the pixel plotting function so it can handle some kind of fixed point the only thing I can do now?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#157408 - strager - Fri May 23, 2008 6:49 pm</h4>
    <div class="postbody"><span class="postbody">The following are effectively equivalent:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">double s = (double)SIN[(int)(SPRITE_ANGLE_MASK * angle / M_PI) &amp; SPRITE_ANGLE_MASK] / (1 &lt;&lt; 12);
<br/>
<br/>
double s = sin(angle);</td> </tr></table><span class="postbody">
<br/>
<br/>
In your original post, _stepX is effectively in the range from -256 (-1 * (1 &lt;&lt; 12) &gt;&gt; 4) to 256, which may be why you don't see it properly.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#157410 - Cearn - Fri May 23, 2008 9:33 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Polaris wrote:</b></span></td> </tr> <tr> <td class="quote">OK I think i'm getting this.
<br/>
<br/>
When I do &gt;&gt; 4 on the value returned by the LUTs I am actually turning it into 8.8, right? So if I wanted to add that number to my position, it in turn should also be 8.8, to keep everything in the correct place, right?
<br/>
<br/>
The part that's giving me trouble is what comes after that, which is a bit of topic :( I got my crud pixel plotting function that takes 2 ints as parameters(x and y screen positions) and inside it manages them as regular ints(with no fixed point).
<br/>
<br/>
I tried trimming all the stuff to the left of the fixed point by doing &gt;&gt; 8, hoping it would turn the number into a regular int that my function could use properly, but that didn't worked quite right.   
<br/>
</td> </tr></table><span class="postbody">
<br/>
Doing &gt;&gt;12 should cut the numbers down to regular ints, yes. However, this won't get you very far by itself because that'll just give either -1, 0 or +1. Usually -1 or 0. These numbers won't be of much use when plotting.
<br/>
<br/>
It might help if you explained what you are trying to do with these numbers; what behaviour you were expecting and what you actually got.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#157419 - Polaris - Sat May 24, 2008 1:31 am</h4>
    <div class="postbody"><span class="postbody">Cearn you are correct. It didn't took me much time to realise I was only getting 0 and -1 out of those results when my object was moving only up, to the left and occasionally in a perfect diagonal upwards, not to mention staying in place some of the time.
<br/>
<br/>
Maybe you can recall the other thread I made, in which I was asking for some help to plot individual pixels in Mode 0. I'm looking into this so I can make a particle system that doesn't use sprites, the first particle effect I was looking to implement was a radial explosion, with each particle having different speed and a random angle when created.
<br/>
<br/>
So to achieve that effect I don't think there is any way around it but to use sine and cosine, so I can make the particle move along a given angle. I already figured out that I don't really need to calculate the sine and cosine on a loop, it would probably work if I calculated the cordinates of a point around the center of the "explosion" when the particle is created, and then with those numbers construct the vector the particle would use to move.
<br/>
<br/>
Using that technique I might be able to get away with using sin() and cos() and a bunch of floats, and with some simple casting to int everthing should work fine. Infact it works fine, already tried it. But I wouldn't be learning anything if I did that, would I?
<br/>
<br/>
Basically what I'm looking for, is the way to achieve the same effect that the math.h functions and floats get me, but using the LUTs. Since the LUTs return fixed point, I was hoping for a way in which I could convert them into regular ints, with a meaningful value for this purpose of course, so I wouldn't need to change the plotting functions I already have.
<br/>
<br/>
I hope this clarified something, because it turned out to be quite long.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#157430 - tepples - Sat May 24, 2008 2:40 am</h4>
    <div class="postbody"><span class="postbody">In order to move at other than specific angles, you'll need to be able to represent positions and velocities that are fractions of a pixel. Programs on the PS1, GBA, and DS typically use <a class="postlink" href="http://en.wikipedia.org/wiki/Fixed-point_arithmetic" target="_blank">fixed-point arithmetic</a> for this. So try storing all your vectors, including positions and velocities, in some fixed-point format.
<br/>
<br/>
<br/>
<span style="font-size: 8px; line-height: normal">Point of terminology: Technically, a position is a point, not a vector, but computer geometry commonly represents a point as as a vector from some origin.</span><br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#157434 - silent_code - Sat May 24, 2008 11:22 am</h4>
    <div class="postbody"><span class="postbody"><span style="font-size: 7px; line-height: normal">i believe, that what distinguishes a point from a vector in computer graphics is the operations you can do on them and that they are always relative to a certain origin, that when moved, will also move the whole vector. think of sub meshes etc. the difference between a cg and a math vector is, that in cg, the origin is implicit. ;^)</span><br/>_________________<br/><span style="font-size: 9px; line-height: normal"><span style="text-decoration: underline"><span style="font-weight: bold"></span></span> July 5th 08: "<span style="font-weight: bold">Volumetric Shadow Demo</span>" 1.6.0 (final) source released
<br/>
June 5th 08: "<span style="font-weight: bold">Zombie NDS</span>" WIP released!
<br/>
It's all on my page, just click <span style="font-weight: bold">WWW</span> below.</span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#157435 - Cearn - Sat May 24, 2008 1:10 pm</h4>
    <div class="postbody"><span class="postbody">Polaris: yes, that helps.
<br/>
<br/>
You're probably removing the fixed-point bits too soon. The calculations should all be done in fixed point arithmetic; only when you finally call the plotter should you shift down to .0 fixed point (i.e., regular ints). For the velocity, you need a sine/cosine value and a speed for that particle to scale the velocity. In floating point, that'd be something like:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">// --- Init ---
<br/>
x= 100;
<br/>
y= 100;
<br/>
v0= drand_minmax(0.125, 2);         // Between 1/8 and 2 px/frame
<br/>
angle= drand_minmax(0, 2*pi);
<br/>
vx = v0*cos(angle);
<br/>
vy = v0*sin(angle);
<br/>
<br/>
// --- Per frame ---
<br/>
x = vx;
<br/>
y += vy;
<br/>
plot(x, y, color);
<br/>
</td> </tr></table><span class="postbody">
<br/>
In fixed point, you still have something like this, but you have to remember where the fixed-point information goes and how it changes with the calculations.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
// Some useful stuff
<br/>
#define ANGLE_COUNT   512
<br/>
<br/>
static inline f32 sinf32(int angle) { return SIN[angle&amp;(ANGLE_COUNT-1)]; }
<br/>
static inline f32 cosf32(int angle) { return COS[angle&amp;(ANGLE_COUNT-1)]; }
<br/>
<br/>
int rand_minmax(int min, int max)
<br/>
{
<br/>
   return (rand()*(max-min)&gt;&gt;15)+min;
<br/>
}
<br/>
<br/>
// --- Init ---
<br/>
x= 100&lt;&lt;8;
<br/>
y= 100&lt;&lt;8;
<br/>
v0= rand_minmax(0x100/8, 0x100*2);   // Between 1/8 and 2 px/frame (Q8)
<br/>
angle= rand_minmax(0, ANGLE_COUNT);
<br/>
<br/>
vx = v0*cosf32(angle)&gt;&gt;12;         // Q8*Q12&gt;&gt;12 -&gt; Q8
<br/>
vy = v0*sin32(angle)&gt;&gt;12;
<br/>
<br/>
// --- Per frame ---
<br/>
x += vx;                     // Q8+Q8 -&gt; Q8
<br/>
y += vy;                     // Q8+Q8 -&gt; Q8
<br/>
<br/>
plot(x&gt;&gt;8, y&gt;&gt;8, color)
<br/>
</td> </tr></table><span class="postbody">
<br/>
<span style="font-size: 8px; line-height: normal">'Points' are real, physical locations in a space. 'Base-vectors' are connections between an arbitrary set of points, forming a coordinate system. 'Coordinates' of a point are the number of steps along the base-vectors needed to reach a given point. 'Vectors' describe distances between points, expressed as differences between the coordinates. You can express base-vectors (<span style="font-weight: bold">u</span>, <span style="font-weight: bold">v</span>, <span style="font-weight: bold">w</span>) of one system (S') in those of another (S). Given the coordinates of point P in S' (<span style="font-weight: bold">x'</span>=(x', y',z')), you can find the coordinates in S (<span style="font-weight: bold">x</span>=(x,y,z)) by scaling the base-vectors of S by the coordinates and adding the results: <span style="font-weight: bold">x</span>=x'?<span style="font-weight: bold">u</span> + y'?<span style="font-weight: bold">v</span> + z'?<span style="font-weight: bold">w</span>. This corresponds to the matrix-vector multiplication <span style="font-weight: bold">x</span>=<span style="font-weight: bold">M</span><span style="font-weight: bold">x'</span>, where <span style="font-weight: bold">M</span> is [ <span style="font-weight: bold">u v w</span> ]. Hence, matrix multiplications can be used to describe coordinate transformations.
<br/>
:)</span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#157460 - Polaris - Sun May 25, 2008 1:02 am</h4>
    <div class="postbody"><span class="postbody">This looks really neat. Just a couple of questions, what exactly is happening here?</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">(rand()*(max-min)&gt;&gt;15)+min;</td> </tr></table><span class="postbody">
<br/>
And why do I need this range? </span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">0x100/8, 0x100*2</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#157480 - Cearn - Sun May 25, 2008 10:14 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Polaris wrote:</b></span></td> </tr> <tr> <td class="quote">This looks really neat. Just a couple of questions, what exactly is happening here?<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">(rand()*(max-min)&gt;&gt;15)+min;</td> </tr></table><span class="postbody"></span></td> </tr></table><span class="postbody">
<br/>
rand() returns a number between 0 and 0x8000 (well technically between 0 and RAND_MAX). Interpreting this as a Q15 (15bit fixed point) number, this represents a range between 0 and 1. Multiply that by <span style="font-style: italic">N</span> and you get a range between 0 and <span style="font-style: italic">N</span> in 15-bit fixed point. Shifting away the fixed-point bits gives a proper [0, <span style="font-style: italic">N</span>) range.
<br/>
   At least, this is how it worked at some time. Apparently RAND_MAX has changed to 0x7FFFFFFF at some point, so this wouldn't quite work an extra shift for the rand(). The reason I'm doing this at all is because the 'standard' way of getting a ranged number (rand()%<span style="font-style: italic">N</span>) requires a very slow modulo. If you require lots of randoms, this can be significant.
<br/>
   Do a search for random on the forum. The matter of getting a random number has come up quite often.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Polaris wrote:</b></span></td> </tr> <tr> <td class="quote">And why do I need this range? <table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">0x100/8, 0x100*2</td> </tr></table><span class="postbody"></span></td> </tr></table><span class="postbody">
<br/>
This was just an example range. You don't <span style="font-style: italic">need</span> to use it, but it is seemed to give decent explosion rates in my test.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#157482 - kusma - Sun May 25, 2008 12:53 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Cearn wrote:</b></span></td> </tr> <tr> <td class="quote">The reason I'm doing this at all is because the 'standard' way of getting a ranged number (rand()%<span style="font-style: italic">N</span>) requires a very slow modulo. If you require lots of randoms, this can be significant.</td> </tr></table><span class="postbody">
<br/>
If you compile the code as ARM (and not THUMB), a long multiply can be used for the modulo (gcc optimizes modulos by constant values like that). If you need many random values, you might want to change the approach anyway. My method of choice is to fill a table of random values with a proper RNG, and use a cheap (and poor) pseudo-rand to pick a random index into that table.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
