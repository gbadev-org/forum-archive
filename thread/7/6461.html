<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>blit - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>C/C++ > blit</h2>
<div id="posts">
<div class="post">
    <h4>#49665 - NighTiger - Mon Aug 01, 2005 12:36 pm</h4>
    <div class="postbody"><span class="postbody">Hi guys,
<br/>
I have a little problem.
<br/>
I have a sprite like SPRW = 2, SPRH = 2 in the position
<br/>
Xpos = 2, Ypos = 2.
<br/>
The screen is SCRW = 10, SCRH = 8.
<br/>
<br/>
To obtain the best performance I would like to use the memcpy function:
<br/>
<br/>
for (y=0; y&lt;SPRW*SPRH; y++)
<br/>
memcpy(&amp;pScrn[((y+Ypos)*SCRW)+Xpos], (pSprt+y), sizeof(pSprt[0]));
<br/>
<br/>
but the result is wrong.
<br/>
What is the correct way?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#49671 - Cearn - Mon Aug 01, 2005 2:54 pm</h4>
    <div class="postbody"><span class="postbody">??? What exactly are you trying to do here? What kind of data have you got? What system are we talking about?
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">for (y=0; y&lt;SPRW*SPRH; y++) 
<br/>
   memcpy(&amp;pScrn[((y+Ypos)*SCRW)+Xpos], (pSprt+y), sizeof(pSprt[0]));</td> </tr></table><span class="postbody">
<br/>
Lesseee, what can go wrong here. <ul><li>You're looping over all pixels (SprW*SprH), rather than over all scanlines, which is more traditional when it comes to blitting.</li><li>What's the bitdepth of the screen? Different bitdepths require different copying styles.
<br/>
</li><li>What's the pitch of the screen (i.e., the width in <span style="font-style: italic">bytes</span>, not in pixels)? It doesn't necessarily have to be the same as the screen width (see also the bitdepth question)
<br/>
</li><li>sizeof(pSprt[0]) gives the size of <span style="font-weight: bold">one</span> pSprt element. What's it's type? Does that correspond to the bitdepth? And even if it does, why use memcpy for a single value, where a simple assignment ('=') would do the same thing (only much, much, <span style="font-style: italic">much</span> quicker)?</li></ul>In most cases you'd do something like this. 
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
BYTE *src= start of source rectangle;
<br/>
BYTE *dst= start of destination rectangle;
<br/>
int src_pitch, dst_pitch, nn; // src pitch, dst pitch, # bytes to copy from src
<br/>
<br/>
// take care of all nasty assignments and safety checks 
<br/>
<br/>
while(height--)  // loop over scanlines to copy
<br/>
{   
<br/>
    memcpy(dst, src, nn);  // copy by scanline, not by single pixels
<br/>
    dst += dst_pitch;
<br/>
    src += src_pitch;
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
A general blit-function for all occasions can be quite nasty due to possibilities with in-byte starts (bpp&lt;8) and alignment problems (like 4byte boundaries for BMPs, etc), care to narrow the cases down a bit?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#49685 - Miked0801 - Mon Aug 01, 2005 6:43 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
for (y=0; y&lt;SPRW*SPRH; y++) 
<br/>
   memcpy(&amp;pScrn[((y+Ypos)*SCRW)+Xpos], (pSprt+y), sizeof(pSprt[0])); 
<br/>
</td> </tr></table><span class="postbody"></span></td> </tr></table><span class="postbody">
<br/>
<br/>
You are so fired for writing a piece of code that looks like that. :)
<br/>
<br/>
1. SPRW == ????
<br/>
2. SPRH == ????
<br/>
3. SCRW == ???
<br/>
...
<br/>
you get the picture.  I can guess you mean sprite width/height and screen width/height - but the numbers you are giving me for those values don't make any sense at all.
<br/>
<br/>
I must admit, I have almost no idea what you are trying to accomplish with that line of, well, whatever that is...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#49754 - NighTiger - Tue Aug 02, 2005 7:38 am</h4>
    <div class="postbody"><span class="postbody">I did make a solution
<br/>
<br/>
  for (y=0; y&lt;SPRH; y++)
<br/>
    memcpy(&amp;FrontBuffer[((y+Ypos)*SCRW)+Xpos], (pSprt+y*SPRW), sizeof(pSprt[0])*SPRW);
<br/>
<br/>
where
<br/>
SPRH = sprite height
<br/>
Ypos = sprite y position
<br/>
Xpos = sprite x position
<br/>
SCRW = screen width
<br/>
<br/>
pSprt = pointer to sprite</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#49960 - Miked0801 - Thu Aug 04, 2005 12:09 am</h4>
    <div class="postbody"><span class="postbody">Good luck when you come back and look at that code a year from now and try to figure out what it's doing.  Please, use descriptive names and comments to save yourself from future doom :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#50276 - NighTiger - Sun Aug 07, 2005 1:25 pm</h4>
    <div class="postbody"><span class="postbody">excuse me guys,
<br/>
have memcpy function something wrong?
<br/>
I use it in my code to make a horizontal line or a fill rect and the color is alway wrong</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#50303 - sajiimori - Sun Aug 07, 2005 11:03 pm</h4>
    <div class="postbody"><span class="postbody">Memcpy might be copying a byte at a time, which does not work if you're writing to VRAM.  I suggest writing your own 16 or 32 bit version.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#50333 - NighTiger - Mon Aug 08, 2005 8:05 am</h4>
    <div class="postbody"><span class="postbody">like, for example:
<br/>
<br/>
memcpy(FrontBuffer, imageData, sizeof(u32));
<br/>
<br/>
???</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#50336 - Cearn - Mon Aug 08, 2005 8:36 am</h4>
    <div class="postbody"><span class="postbody"><a class="postlink" href="http://msdn.microsoft.com/library/default.asp?url=/library/en-us/vccore98/html/_crt_memcpy.asp" target="_blank">memcpy</a>. 
<br/>
(yeah it's the Visual Studio page, but that doesn't matter in this case)
<br/>
<br/>
The third parameter is the number of <span style="font-weight: bold">bytes</span> to copy. sizeof(u32) gives the number of bytes used by the type 'u32', which is 4, which most likely has nothing to do with the amount of bytes of the bitmap's scanline. 
<br/>
In principle, memcpy copies in bytes, but in practice it's often optimised to copy in word-sized chunks (u32 in ARM's case) <span style="font-style: italic">if</span> the occasion allows for it. This is so when there's more than 16 bytes to copy and when both source and destination are word aligned.
<br/>
<br/>
What sajimori is referring to is writing your own memcpy function that copies in (half)word chunks, rather than bytes. Something like this for example:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
// dstv: destination pointer
<br/>
// srcv: source pointer
<br/>
// len: number of halfwords to copy
<br/>
//   (not # of bytes, but the switch is easily made)
<br/>
void memcpy16(const void *dstv, void *srcv, u32 len)
<br/>
{
<br/>
    u16 *dst= (u16*)dstv, *src= (u16*)srcv;
<br/>
    while(len--)
<br/>
        *dst++ = *src++;
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
Various optimisations are possible of course, but this is the basic form. If you must have optimised versions you 're welcome to try <a class="postlink" href="http://user.chem.tue.nl/jakvijn/files/core_asm.s" target="_blank">mine</a>, but they're in assembly so you might want to wait with that.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
