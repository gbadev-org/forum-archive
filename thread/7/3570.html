<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>My timer doesn't want to work. - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>C/C++ > My timer doesn't want to work.</h2>
<div id="posts">
<div class="post">
    <h4>#22268 - expos1994 - Wed Jun 16, 2004 3:52 pm</h4>
    <div class="postbody"><span class="postbody">Hello,
<br/>
<br/>
I needed a wait() function in my game, so the player can have a moment to take in some info.  Well I am using ThePernProject's Wait(seconds) function since it seemed to be somewhat simple.
<br/>
<br/>
Well I added in a for.. loop so it would wait(1) second each time through.  Well a one-second wait doesn't happen.  It just zips through the loop.  I am wondering if I'm doing something dumb, but it seems that the Wait() function resets the timer. And everything should be ok.  Plus, I added this to the end of my main game loop (just on a whim really).  And my game pauses for a second each time through the loop.   So why won't it pause in this for() loop?  Does anyone have any ideas?
<br/>
<br/>
Here's how I define the registers:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#define REG_TM3D          (*(volatile u16*)0x400010C)
<br/>
#define REG_TM3CNT        (*(volatile u16*)0x400010E)
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Here's the Wait() function:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
void Wait(int seconds)
<br/>
{
<br/>
   //Start the timer
<br/>
   REG_TM3CNT = TIME_FREQUENCY_1024 | TIME_ENABLE;
<br/>
   //zero the timer
<br/>
   REG_TM3D = 0;
<br/>
   while(seconds--)
<br/>
   {
<br/>
      while(REG_TM3D &lt;= 16386){} //wait
<br/>
      REG_TM3D = 0; //reset the timmer
<br/>
   }
<br/>
   
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Here's where I call it and it doesn't work:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
void simulate_days(u16 numofdays)
<br/>
{
<br/>
   u16 loop;
<br/>
   u16 loop2;
<br/>
   char day_string[6];
<br/>
   
<br/>
   for (loop = 0; loop &lt; numofdays; loop++)
<br/>
   {
<br/>
      update_date();
<br/>
      if (selecteditem == 6)
<br/>
      {
<br/>
         PlotTextBG3((char *)month[monthno],5,1);  //Prints the date
<br/>
         sprintf(day_string,"%d",day);
<br/>
         if (day &lt; 10) //moves ", 1848" based on the day 
<br/>
         {
<br/>
            PlotTextBG3(day_string,8,1);
<br/>
            PlotTextBG3((", 1948"),9,1);
<br/>
         }else
<br/>
         {
<br/>
            PlotTextBG3(day_string,8,1);
<br/>
            PlotTextBG3((", 1948"),11,1);
<br/>
         }
<br/>
      }
<br/>
      update_food();
<br/>
      WaitForVsync();
<br/>
      Wait(1);
<br/>
   }
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
<br/>
Is there something I'm doing wrong?  I like to think that I can call Wait() how ever many times I need to in this simulate_days() function, but I could be wrong...
<br/>
<br/>
Thanks for any help you can provide.
<br/>
<br/>
--Chris</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#22270 - poslundc - Wed Jun 16, 2004 4:48 pm</h4>
    <div class="postbody"><span class="postbody">Well, you might try reordering your statements like this, although I can't guarantee it'll fix your problem:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">REG_TM3CNT = 0;
<br/>
REG_TM3D = 0;
<br/>
REG_TMCNT = TIME_FREQUENCY_1024 | TIME_ENABLE</td> </tr></table><span class="postbody">
<br/>
<br/>
You may also have to make sure that REG_TM3CNT is declared as volatile in the header file.
<br/>
<br/>
But you should be aware that this is a very bad way to have a delay if you plan on incorporating this into a game at all. You should keep your main loop cycling every VBlank, and just keep track of the number of VBlanks that pass. This lets you operate your main loop as a <a class="postlink" href="http://www.google.com?q=finite+state+machines" target="_blank">finite state machine</a>.
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#22278 - sgeos - Wed Jun 16, 2004 8:13 pm</h4>
    <div class="postbody"><span class="postbody">I agree with Dan.  Counting vblanks is the way to go.  This is still a bad way of doing things, but it might be a little simpler than the timer code:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void vblank(void)
<br/>
{
<br/>
   /* If we are in the vblank, wait for vdraw */
<br/>
   while (*(volatile unsigned short *)0x4000006 &gt; 159)
<br/>
   {
<br/>
      /* wait */
<br/>
   }
<br/>
<br/>
   /* Wait for vblank to begin */
<br/>
   while (*(volatile unsigned short *)0x4000006 &lt; 160)
<br/>
   {
<br/>
      /* wait */
<br/>
   }
<br/>
}
<br/>
<br/>
<br/>
void stall(int frames)
<br/>
{
<br/>
   int i;
<br/>
<br/>
   for (i = 0; i &lt; frames; i++)
<br/>
      vblank();
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
-Brendan</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#22301 - Cearn - Thu Jun 17, 2004 8:25 am</h4>
    <div class="postbody"><span class="postbody">The <a class="postlink" href="http://user.chem.tue.nl/jakvijn/tonc/timers.htm#REG_TMxD" target="_blank">REG_TMxD</a> registers don't quite behave as you might expect. When reading, it gives you the current timer value, when writing to it, it sets the number from which counting starts when you enable it, or when the counter overflows. To fix it, you could either set REG_TMxD to 0x10000-<span style="font-style: italic">n</span>, rather than just <span style="font-style: italic">n</span> and make use of the overflow, or disable/enable the timer after the wait-loop.
<br/>
<br/>
poslundc and sgeos are still right that using vblank is still better, of course, either via a vsync <a class="postlink" href="http://user.chem.tue.nl/jakvijn/tonc/video.htm#vsync1" target="_blank">busy-wait loop</a> or, preferably, with <a class="postlink" href="http://user.chem.tue.nl/jakvijn/tonc/swi.htm#vsync2" target="_blank">interrupts</a>.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#22314 - expos1994 - Thu Jun 17, 2004 2:28 pm</h4>
    <div class="postbody"><span class="postbody">Hey,
<br/>
<br/>
Thanks a lot for all of your help.  My game is working again.
<br/>
<br/>
@poslundc, sgeos: You're right, I should have kept it in my main loop.   I thought it would be easier to branch off the main loop, do this little task, then come back.  It only brought on problems.  I have it working now by keeping track of Vblanks.  Someday I'm going to use interrupts...
<br/>
<br/>
@cearn: Thanks for the tip.  I have since removed the timer from my code.  I will probably reference this at some point in the future.  Thanks also for the links.  I didn't know those tutorials existed.  That's a nice site,  I'm sure it will come in handy.
<br/>
<br/>
Thanks again for the help.
<br/>
<br/>
--Chris</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#49871 - diamondx - Wed Aug 03, 2005 3:38 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>sgeos wrote:</b></span></td> </tr> <tr> <td class="quote">I agree with Dan.  Counting vblanks is the way to go.  This is still a bad way of doing things, but it might be a little simpler than the timer code:
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void vblank(void)
<br/>
{
<br/>
   /* If we are in the vblank, wait for vdraw */
<br/>
   while (*(volatile unsigned short *)0x4000006 &gt; 159)
<br/>
   {
<br/>
      /* wait */
<br/>
   }
<br/>
<br/>
   /* Wait for vblank to begin */
<br/>
   while (*(volatile unsigned short *)0x4000006 &lt; 160)
<br/>
   {
<br/>
      /* wait */
<br/>
   }
<br/>
}
<br/>
<br/>
<br/>
void stall(int frames)
<br/>
{
<br/>
   int i;
<br/>
<br/>
   for (i = 0; i &lt; frames; i++)
<br/>
      vblank();
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
-Brendan</span></td> </tr></table><span class="postbody">
<br/>
<br/>
Hey, I used your code for a tetramino game using HAM, from the <a href="http://www.aaronrogers.com/ham/" target="_blank">http://www.aaronrogers.com/ham/</a> tutorials, but it pauses the entire game, and all I want it to pause is that function. I need it to, when you press right, move 3 pixels right, and not beable to move right for about 200-500 miliseconds. Please help me! Thanks.
<br/>
<br/>
P.S. Im very new to GBA programming and kinda new to C++ programming.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#49872 - tepples - Wed Aug 03, 2005 4:01 am</h4>
    <div class="postbody"><span class="postbody">Here's untested code that shows roughly how to do as you asked:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#define JOY (*(volatile unsigned short)0x04000130)
<br/>
#define JOY_RIGHT 0x0010
<br/>
<br/>
{
<br/>
  unsigned int last_joy = ~0;  /* buttons that were pressed in last frame */
<br/>
  unsigned int countdown = 0;  /* time in vblanks until another press is allowed */
<br/>
<br/>
  while(1)
<br/>
  {
<br/>
    int pressed = ~JOY;  /* buttons that are pressed now */
<br/>
    int just_pressed = pressed &amp; ~last_joy;  /* buttons that just became pressed */
<br/>
<br/>
    if(just_pressed &amp; JOY_RIGHT)
<br/>
    {
<br/>
      if(countdown == 0)
<br/>
      {
<br/>
        countdown = 20;  /* in units of 16.74 ms */
<br/>
        move_cursor_by(3, 0);
<br/>
      }
<br/>
    }
<br/>
<br/>
    /* Do other processing here. */
<br/>
<br/>
    if(countdown &gt; 0)
<br/>
      countdown = 0;
<br/>
    wait_for_vblank();
<br/>
    last_joy = pressed;
<br/>
  }
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
But you said you're trying to make a tetramino game. If you want to know the "right" way to handle auto-repeat with delay in a falling block puzzle game, then look for make_repeats() in the source code for <a class="postlink" href="http://www.pineight.com/gba/#tod" target="_blank">TOD</a>.
<br/>
<br/>
EDIT: correct TOD link<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"><br/><br/>Last edited by tepples on Wed Aug 03, 2005 4:17 am; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#49873 - diamondx - Wed Aug 03, 2005 4:16 am</h4>
    <div class="postbody"><span class="postbody">Thanks. Very helpfull. I think I get it, but in HAM, I dont need to define JOY, do I? Because HAM has F_CTRLINPUT_RIGHT_PRESSED.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
