<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>struct sizes with C++ - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>C/C++ > struct sizes with C++</h2>
<div id="posts">
<div class="post">
    <h4>#2404 - kyp4 - Mon Feb 03, 2003 4:21 am</h4>
    <div class="postbody"><span class="postbody">I am having a problem with structure sizes. I am using C++ with devkitadv. If I define the following structure:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
struct test
<br/>
{
<br/>
    u8 byte;
<br/>
};
<br/>
</td> </tr></table><span class="postbody">
<br/>
The size of the structure (checked by using sizeof() and by making an array and checking the addresses of consecutive elements) is 4 bytes, rather than only 1 byte, which is the sizeof(u8). I then tried various combinations of element types and it seems as though the sizes of structures are always multiples of 4 bytes.
<br/>
Previously to doing this on the GBA I tried it in a Win32 console program and, as I expected it to do, a structure's size is merely the sum if its elements. Is there any reason why structures are always multiples of 4 bytes and is there anyway to tell the compiler not to do this?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#2405 - tepples - Mon Feb 03, 2003 4:35 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>kyp4 wrote:</b></span></td> </tr> <tr> <td class="quote">I then tried various combinations of element types and it seems as though the sizes of structures are always multiples of 4 bytes.</td> </tr></table><span class="postbody">
<br/>
That's a reasonable choice to make on a 32-bit architecture.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Previously to doing this on the GBA I tried it in a Win32 console program</td> </tr></table><span class="postbody">
<br/>
The size of structures is implementation-defined.  MSVC on x86 will compile differently from GCC on x86, which will compile differently from GCC on ARM.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Is there any reason why structures are always multiples of 4 bytes and is there anyway to tell the compiler not to do this?</td> </tr></table><span class="postbody">
<br/>
You could try telling the compiler that you want the structure "packed", using attributes.  To learn how to specify this behavior, read <a class="postlink" href="http://gcc.gnu.org/onlinedocs/gcc-3.2.1/gcc/Type-Attributes.html" target="_blank">this page from the GCC manual</a>.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#2417 - Touchstone - Mon Feb 03, 2003 4:03 pm</h4>
    <div class="postbody"><span class="postbody">Instead of using compilerspecific 'pack'-attributes you could take a look at bitfields. The size of your struct will still be padded to four bytes but the members won't have to be 'properly' aligned.<br/>_________________<br/>You can't beat our meat</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#2431 - tepples - Mon Feb 03, 2003 9:29 pm</h4>
    <div class="postbody"><span class="postbody">Bitfields won't be aligned the same on different compilers either.  That too is implementation-defined behavior.  And though I haven't benchmarked bitfields on ARM, they're dog-slow on x86.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#2439 - Vortex - Tue Feb 04, 2003 12:07 am</h4>
    <div class="postbody"><span class="postbody">There is one more thing to be considered: In C++ (unlike C) the structures are *class* types. That means you can include methods in your struct. As a side effect some compilers may include an invisible "this" pointer when working with structs. My experience is the sizeof() operator returns suprizing results used with struct/class argument in C++, but again that depends on the compiler.
<br/>
<br/>
Since you are not using any OOP I would suggest to include your struct definition in a separate C file and the include it in the C++ file as "extern C". In that way you can be sure the compiler will apply the good old C rules when allocation space for your structure variables.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#2447 - tepples - Tue Feb 04, 2003 4:24 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Vortex wrote:</b></span></td> </tr> <tr> <td class="quote">As a side effect some [C++ language] compilers may include an invisible "this" pointer when working with structs.</td> </tr></table><span class="postbody">
<br/>
There's no <span style="font-style: italic">this</span> pointer stored in a C++ class.  The <span style="font-style: italic">this</span> pointer is a pointer to an object, passed as an implicit argument to each non-static method.  What you're thinking of is the hidden field that points to the class's virtual method jump table (vtable).  A class or struct with no destructor and no other virtual functions won't have a vtable field.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">I would suggest to include your struct definition in a separate C file and the include it in the C++ file as "extern C"</td> </tr></table><span class="postbody">
<br/>
As far as I know, <span style="font-style: italic">extern "C"</span> affects only functions, to make them use C calling conventions: no overloading, no name mangling, and no namespacing. For structs and for everything else other than functions, a compiler ignores <span style="font-style: italic">extern "C"</span>.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#2478 - Vortex - Tue Feb 04, 2003 5:19 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
There's no <span style="font-style: italic">this</span> pointer stored in a C++ class.  The <span style="font-style: italic">this</span> pointer is a pointer to an object, passed as an implicit argument to each non-static method.  What you're thinking of is the hidden field that points to the class's virtual method jump table (vtable).  A class or struct with no destructor and no other virtual functions won't have a vtable field.
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
You are correct, except for one thing: if you don't specify a destructor the compiler will supply a default one for you. I tried this using BC++ a long time ago and the overhead was there regardless of the destructor/virtual methods. Since the C++ compilers are much smarter now I think your statement can be considered 100% correct.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">I would suggest to include your struct definition in a separate C file and the include it in the C++ file as "extern C"
<br/>
As far as I know, <span style="font-style: italic">extern "C"</span> affects only functions, to make them use C calling conventions: no overloading, no name mangling, and no namespacing. For structs and for everything else other than functions, a compiler ignores <span style="font-style: italic">extern "C"</span>.</td> </tr></table><span class="postbody">
<br/>
<br/>
My bad. That only shows how rusty my C++ knoledge is :-)</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
