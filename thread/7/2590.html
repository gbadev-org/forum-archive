<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>"Deconstructing" a struct - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>C/C++ > "Deconstructing" a struct</h2>
<div id="posts">
<div class="post">
    <h4>#14232 - ScottLininger - Sat Jan 03, 2004 1:51 am</h4>
    <div class="postbody"><span class="postbody">Does anyone know of a way to iterate across all members of an arbitrary STRUCT in C? I'd like a function that is able to "deconstruct" the struct at runtime to figure out, for example, what the data type and value of the "2nd member" is.
<br/>
<br/>
It seems to me that simple pointer math isn't an option since the data types within the struct can vary, but I'm hoping there is some clever person out there who can tell me different. I know you can get the memory size of the entire struct, or the memory size of a given member, but ONLY if you know the name of that member.
<br/>
<br/>
Okay, okay, I know you're saying "If you create the struct yourself then you *know* the freaking memory sizes and names already!"
<br/>
<br/>
What I'm trying to do is create a generic library for handling simple multiplayer data exchange (via linkcable) using a struct whose name stays the same project to project but whose content can be totally different. 
<br/>
<br/>
For example, to create a multiplayer pong game, your struct might look like.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
<br/>
typedef struct gamestate {
<br/>
       u8 leftPaddleY;               //updated by GB0
<br/>
       u8 rightPaddleY;             //updated by GB1
<br/>
       u8 ballX;                       //updated by GB0
<br/>
       u8 ballY;                                            //updated by GB0
<br/>
       u32 leftPlayerKeyPressState;               //updated by GB0
<br/>
       u32 rightPlayerKeyPressState;             //updated by GB1 
<br/>
};
<br/>
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Whereas for a battleship game it might look like...
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
<br/>
typedef struct gamestate {
<br/>
       u8 player0GuessX;                   //updated by GB0
<br/>
       u8 player0GuessY;                   //updated by GB0
<br/>
      u8 player1GuessX;                   //updated by GB1
<br/>
      u8 player1GuessY;                   //updated by GB1
<br/>
      u8 Player1Map[10][10];  //updated by GB0
<br/>
       u8 Player2Map[10][10];  //updated by GB1
<br/>
};
<br/>
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I would like to write a generic function that handles all the IO transfers and makes sure that every client GBA has a "current" copy of the gamestate struct, and ensures that only the GBA with "control" of a given member can actually update it.
<br/>
<br/>
I'm working on code that does this manually on a variable-by-variable basis, but I'd love to make it more portable, because right now there's just a lot of recoding when you find your gamestate needs to accommodate more information.
<br/>
<br/>
Thanks in advance...
<br/>
<br/>
Scott</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#14235 - sajiimori - Sat Jan 03, 2004 2:05 am</h4>
    <div class="postbody"><span class="postbody">The C runtime environment (if you could even call it that) doesn't store any type information, so you can't write a function that iterates over the data members of an arbitrary struct.
<br/>
<br/>
You can iterate over the bytes of a struct and transfer those via a link cable.  In a traditional network application you wouldn't normally do that, because the bytewise layout of a struct is totally dependent on the compiler and is not necessarily the same across systems.  But on GBA you can get away with it as long as the exact same ROM is being used on each system.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
// Warning: only works when sending to
<br/>
// exact same executable image.
<br/>
send_struct(SomeStruct* s)
<br/>
{
<br/>
    u8* p = s;
<br/>
    u8* end = p + sizeof(SomeStruct);
<br/>
<br/>
    while(p &lt; end)
<br/>
        send_byte(*p++);
<br/>
}
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
