<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>new / delete - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>C/C++ > new / delete</h2>
<div id="posts">
<div class="post">
    <h4>#47790 - Mucca - Wed Jul 13, 2005 4:31 pm</h4>
    <div class="postbody"><span class="postbody">Hello
<br/>
we're currently in the process of overloading new and delete, using malloc and free, but some of the behaviour of malloc is confusing us, and I was wondering if anyone has some  links to proper documentation (gcc 2.9.5, been looking, me no successful) as to what exactly malloc does. For instance, malloc clearly writes the size (plus 5 or 9) allocated in the four bytes preceeding the space allocated, however the value written there is not exactly the size of the object allocated - more specifically it seems to always be either 5 or 9 larger than the size allocated. Whether it is 5 or 9 is to do with whether malloc allocates an extra four bytes after the space requested. Perhaps there's a compiler flag to prohibit the allocation of these four extra bytes (It could waste a lot of memory when you've got up to 3000 dynamically allocated objects). Finally, what malloc writes directly after the allocated space (including the 4-byte extra piece) is some kind of marker for malloc. Anyone know the format of this marker? This isnt especially important for us, but it interests me nonetheless.
<br/>
<br/>
Oh, and Im not really looking for an answer along the lines of "Don't dynamically allocate memory of gba, its teh baddd!". Just looking for documentation, or even source code of malloc if such a thing is available.
<br/>
<br/>
Please
<br/>
.
<br/>
.
<br/>
.
<br/>
Pretty please
<br/>
.
<br/>
.
<br/>
.
<br/>
with sugar on top</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#47792 - sajiimori - Wed Jul 13, 2005 5:33 pm</h4>
    <div class="postbody"><span class="postbody">malloc is part of the C library so the details depend on which library you are using.  The standard library is not part of GCC.
<br/>
<br/>
The extra memory may partly be for alignment, but some extra space will always be needed for book keeping.  You can reduce overhead by making fewer allocations, e.g. by allocating a block of objects as a pool and then constructing individual objects within that.  This is what some STL containers do, notably std::vector and std::deque.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#47799 - Mucca - Wed Jul 13, 2005 7:27 pm</h4>
    <div class="postbody"><span class="postbody">Well it seems malloc (in the library that we are using) doesn't like allocating sizes which are not a multiple of 8 bytes. Therefore, any space allocated which is not evenly divisible by 8 will have four unused bytes allocated after it, and thus the size written to the four bytes before the space will be 9 larger than the actual size passed to malloc, as opposed to 5 larger when it does divide evenly (why 5 I'm still not sure).
<br/>
<br/>
The marker is still a little confusing but not really important.
<br/>
<br/>
Are there any compiler flags to stop the "multiple of 8" allocation? Is there a good reason for it (speed? reduces fragmentation?)? And shouldn't there be some kind of standards for the implementation of new and malloc? Eg under windows and Visual Studio, malloc will return NULL if no memory is available on the heap, whereas under our setup for gba, malloc will happily allocate addresses above 0x0203ffff, thus I believe overwriting other areas due to the mirroring of memory. Can this behaviour perhaps be controlled with the link script where the stack and heap are defined? Naturally exceptions are out of the question. Oh well.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#47800 - Miked0801 - Wed Jul 13, 2005 7:41 pm</h4>
    <div class="postbody"><span class="postbody">Malloc of larger blocks is a speed/size optimization.  Malloc will also (I believe) store a header just ahead or behind each chunk of memory you request.  This is a lits structure for it's own use.  We do something similiar here :)
<br/>
<br/>
Write your own wrapper for malloc that bounds checks the malloc return if you don't like its behavior or write your own :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#47801 - sajiimori - Wed Jul 13, 2005 7:45 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Are there any compiler flags to stop the "multiple of 8" allocation?</td> </tr></table><span class="postbody">As I said, it's part of the libarary, not the compiler.  I don't know your library's reason for doing 8 byte alignment, but larger allocation units often reduce the overhead from bookkeeping.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">And shouldn't there be some kind of standards for the implementation of new and malloc?</td> </tr></table><span class="postbody">Not really.  Implementation details should be free to change based on the needs of different platforms and applications.  If I don't like glibc's malloc, I can use a different one.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Eg under windows and Visual Studio, malloc will return NULL if no memory is available on the heap, whereas under our setup for gba, malloc will happily allocate addresses above 0x0203ffff, thus I believe overwriting other areas due to the mirroring of memory. Can this behaviour perhaps be controlled with the link script where the stack and heap are defined?</td> </tr></table><span class="postbody">Possibly.  The standard does specify that malloc should return null on failure, so your enviornment isn't meeting that requirement.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Naturally exceptions are out of the question.</td> </tr></table><span class="postbody">Are they?  Well, I wouldn't want to use them on GBA anyway because failure is generally end-of-story -- no late recovery for ROM failures and such.  The game either works or it doesn't, eh?  :)</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
