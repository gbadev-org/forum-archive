<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>How to own yourself [SOLVED. Was: delete not doing it's job] - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>C/C++ > How to own yourself [SOLVED. Was: delete not doing it's job]</h2>
<div id="posts">
<div class="post">
    <h4>#161434 - silent_code - Sun Aug 03, 2008 1:33 pm</h4>
    <div class="postbody"><span class="postbody">This is a fork from <a class="postlink" href="http://forum.gbadev.org/viewtopic.php?t=15624&amp;start=15" target="_blank">the topic over here</a>.
<br/>
<br/>
<br/>
This is used with C / C++ with gcc on the PC, but I guess it's not related to that. Anyways, I haven't tested this on the NDS, yet.
<br/>
<br/>
<br/>
How come that calling delete won't work?
<br/>
<br/>
<br/>
Example 1:
<br/>
<br/>
The button.
<br/>
<br/>
The following is the line used multiple times (exact copy and paste) to create an invisible, clickable button for an interface image. Everything works, besided, that it creates a memory leak.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">      pGUITemp = new CGUI_Button(CTreeEditor::actQuit, vec2(16.0f, 8.0f), black, "");</td> </tr></table><span class="postbody">
<br/>
<br/>
The third of eight calls generates a memory leak in one program, although there is nothing special about it. All the instances of the button class get properly deleted in the exact same way by the exact same code.
<br/>
<br/>
Here's the code for creating and assigning the button to the GUI (proprietary system) hierarchy:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">      pGUITemp = NULL;
<br/>
      pGUITemp = new CGUI_Button(CTreeEditor::actQuit, vec2(16.0f, 8.0f), black, "");
<br/>
<br/>
      if(pGUITemp != NULL)
<br/>
      {
<br/>
         pGUITemp-&gt;setPos(vec2(176.0f, 32.0f));
<br/>
         pGUITemp-&gt;setSize(vec2(32.0f, 32.0f));
<br/>
<br/>
         pGUI-&gt;addChild(pGUITemp);
<br/>
      }</td> </tr></table><span class="postbody">
<br/>
<br/>
The only difference between instances is the position and I am pretty sure that that doesn't affect anything.
<br/>
<br/>
<br/>
Example 2:
<br/>
<br/>
The memory leak tracer test case.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">   // let's create some memory leaks!
<br/>
   int *leak0 = new int[32]; // should not leak!
<br/>
   int *leak1 = new int;
<br/>
   int *leak2 = new int[2];
<br/>
<br/>
   memset(leak0, 0, sizeof(int) * 32);
<br/>
   *leak1 = 1;
<br/>
   memset(leak2, 2, sizeof(int) * 2);
<br/>
<br/>
   delete [] leak0;
<br/>
   leak0 = NULL;
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Now, leak0 won't leak, but if I move the definition / allocation line below leak2, it will!?
<br/>
Why is that?
<br/>
<br/>
<br/>
General info:
<br/>
<br/>
I'm on XP/SP3 (German) - same behaviour on other systems, so I don't think that's the "problem" - and I'm using gcc 3.4.5 with a debug build (no O, no profiling) with a custom memory leak tracer.
<br/>
<br/>
The tracer creates a list of allocations (made with a custom linked list, not std::list {for obvious reasons}) and has the standard new and delete operators overloaded, which will report "anonymous" leaks in addition to custom new and delete operators, which collect file and line information through preprocessor macros.
<br/>
<br/>
std::nothrow placement new is not being overloaded.
<br/>
No new class operators are used.
<br/>
All allocations and deallocations are internally handled with malloc and free and no exceptions are thrown (NULL is returned instead).
<br/>
Sentinels and memory dumps are not supported, yet, but I will expand the system to include these features (it's easy to add to my existing codebase).
<br/>
<br/>
<br/>
The applications terminate with a defined state (success, if I don't call Win32 message dialogs...)
<br/>
<br/>
It's all just standard stuff, I guess. ;^)
<br/>
<br/>
<br/>
Can anybody help me? Maybe point me to some better, free memory leak tracer? Although mine does the job, there are these (I guess) rare and (definitely) weird cases, <span style="font-weight: bold">that just don't make sense (just like the poll!)</span><br/>_________________<br/><span style="font-size: 9px; line-height: normal"><span style="text-decoration: underline"><span style="font-weight: bold"></span></span> July 5th 08: "<span style="font-weight: bold">Volumetric Shadow Demo</span>" 1.6.0 (final) source released
<br/>
June 5th 08: "<span style="font-weight: bold">Zombie NDS</span>" WIP released!
<br/>
It's all on my page, just click <span style="font-weight: bold">WWW</span> below.</span></span><span class="gensmall"><br/><br/>Last edited by silent_code on Tue Aug 05, 2008 8:00 pm; edited 3 times in total</span></div>    
</div>
<div class="post">
    <h4>#161439 - keldon - Sun Aug 03, 2008 7:35 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>silent_code wrote:</b></span></td> </tr> <tr> <td class="quote">Now, leak0 won't leak, but if I move the definition / allocation line below leak2, it will!?
<br/>
Why is that?</td> </tr></table><span class="postbody">
<br/>
Without knowing more details, it just sounds like your leak tracer logic is faulty!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161440 - PeterM - Sun Aug 03, 2008 8:16 pm</h4>
    <div class="postbody"><span class="postbody">I probably don't understand this correctly, but are you deleting leak0, nulling leak0, then trying to memset the memory at leak0?
<br/>
<br/>
That would cause an access violation (writing to a null address).
<br/>
<br/>
BTW, no need to check if a pointer is null after calling "new" (unless you're using Visual C++ 6, yuck...). If the program gets to the code after the "new", it succeeded in allocating the memory. Otherwise it will have thrown a std::bad_alloc.<br/>_________________<br/><a href="http://aaiiee.wordpress.com/" target="_blank">http://aaiiee.wordpress.com/</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161442 - silent_code - Sun Aug 03, 2008 10:39 pm</h4>
    <div class="postbody"><span class="postbody">@ PeterM:
<br/>
<br/>
No and no. ;^D
<br/>
<br/>
1st No: I am allocatin, setting and then deallocating the memory leak0 points to. no further access is being made to the memory location that leak0 points to (that means to NULL, to which the pointer is set after deallocation.) There are no runtime errors either. As I stated, the programs using the tracer and exhibiting that strange behaviour will terminate in a defined state (= not crash.)
<br/>
I guess that one is very clear. :^p
<br/>
<br/>
2nd No: As I have stated above, I overload / overwrite the new and delete operators to NOT throw any exceptions and instead return NULL in case of an allocation fault.
<br/>
<br/>
To my knowledge, exceptions are good for error detection, but I guess not using them is faster (I'm not sure about that one, though.)
<br/>
<br/>
But thanks for trying! :^)
<br/>
<br/>
<br/>
@ keldon: But why would it work for seven buttons created in the exact same way and for one it wouldn't? It's beyond me. Also, the logic is very simple... pass an address from malloc() to a list, then in delete, look for the address in the list and remove the entry.
<br/>
<br/>
<br/>
I do all my news and deletes right from the start. I double checked the code using the memory... nothing is wrong. It's just like in that second example (which is the more interesting one of the two.)
<br/>
<br/>
<br/>
I'll investigate a little further tomorrow after work (when not playing BioShock... ;^D )
<br/>
<br/>
<br/>
Hm, I <span style="font-style: italic">could</span> post the tracer here, after I test it on the NDS... would that help? (Yes?)
<br/>
<br/>
<br/>
<span style="font-weight: bold">Has anyone else experienced such behaviour?</span> Please share!<br/>_________________<br/><span style="font-size: 9px; line-height: normal"><span style="text-decoration: underline"><span style="font-weight: bold"></span></span> July 5th 08: "<span style="font-weight: bold">Volumetric Shadow Demo</span>" 1.6.0 (final) source released
<br/>
June 5th 08: "<span style="font-weight: bold">Zombie NDS</span>" WIP released!
<br/>
It's all on my page, just click <span style="font-weight: bold">WWW</span> below.</span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161444 - keldon - Sun Aug 03, 2008 11:43 pm</h4>
    <div class="postbody"><span class="postbody">I once had a weird problem with my "so blindingly simple it can't possibly go faulty linked list" structure was screwing up when sorting! I honestly couldn't see what could have been going wrong and only realized when I used a standard container - proving my logic to be faulty (which is obviously not an option for you due to standard containers using new/delete; unless you provided a custom allocator).
<br/>
<br/>
Are you displaying logs of when your code is called so that you have a clear idea of what your leak tracer is seeing (to be sure that new and delete are misbehaving)?
<br/>
<br/>
Your second example should not be giving any errors unless your new/delete are not getting called when you expect them to! I personally had no errors in changing the order - although I haven't installed GCC (just reinstalled Windows again and only have one dev env on).</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161448 - koryspansel - Mon Aug 04, 2008 1:30 am</h4>
    <div class="postbody"><span class="postbody">Is it safe to say that this program, with your custom leak tracer, would leak memory on your system?:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
int main(int, char*[])
<br/>
{
<br/>
    // let's create some memory leaks!
<br/>
    int *leak1 = new int;
<br/>
    int *leak2 = new int[2];
<br/>
    int *leak0 = new int[32];
<br/>
<br/>
    memset(leak0, 0, sizeof(int) * 32);
<br/>
    *leak1 = 1;
<br/>
    memset(leak2, 2, sizeof(int) * 2);
<br/>
<br/>
    delete [] leak0;
<br/>
    leak0 = NULL;
<br/>
<br/>
    delete [] leak1;
<br/>
    leak1 = NULL;
<br/>
<br/>
    delete [] leak2;
<br/>
    leak2 = NULL;
<br/>
<br/>
    return 0;
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
And for your custom leak tracer, you define both new &amp; delete and array new &amp; delete?  Can you repro the problem using objects in place of the ints?
<br/>
<br/>
I would have to agree with keldon, you probably have a bug in your code somewhere.  However, one thing you can do to check is replace the ints with an object and print a message in the constructor &amp; destructor.  It won't tell you much, but you can compare it to your leak tracer results to make sure your overloaded news &amp; deletes are being called correctly and at the right times.  Is there an equivalent for CrtDebug on GCC?
<br/>
<br/>
Wrt memory allocation &amp; exceptions, I like to think about it this way.  What does it mean if an exception is thrown or the result is NULL?  And how is this condition going to be handled?  Does it make sense to try and continue on if you have no more memory?  And what if you check the result, and it is NULL?  If you ignore that fact and continue, you've only delayed the problem and possibly made it harder to track down.  Also, most of the cost of an exception, is probably in setting up the try/catch block, but it depends on a variety of factors.  In addition, new may not be the only function that throws an exception, so you're not completely off the hook.
<br/>
<br/>
--
<br/>
Kory</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161449 - sgeos - Mon Aug 04, 2008 2:09 am</h4>
    <div class="postbody"><span class="postbody">Bugs involving pointers can be really confusing until you figure out what is going on.
<br/>
<br/>
Depending on exactly what you are doing, it may not be possible to test all of your code on the PC, but you should test as much of it as possible on the PC.  Not only are the PC side testing tools better, there is a remote chance there is a bug in the implementation.
<br/>
<br/>
My second question is... if you are really leaking, why not try putting the offending code in a function and repeatedly call it until you run out of memory?  Set your GBA/DS down, get lunch and see if it has crashed by the time you get back.
<br/>
<br/>
-Brendan</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161455 - tepples - Mon Aug 04, 2008 4:23 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>koryspansel wrote:</b></span></td> </tr> <tr> <td class="quote">Wrt memory allocation &amp; exceptions, I like to think about it this way.  What does it mean if an exception is thrown or the result is NULL?  And how is this condition going to be handled?  Does it make sense to try and continue on if you have no more memory?  And what if you check the result, and it is NULL?</td> </tr></table><span class="postbody">
<br/>
The article "To New, Perchance to Throw" [<a class="postlink" href="http://www.gotw.ca/publications/mill15.htm" target="_blank">1</a> | <a class="postlink" href="http://www.gotw.ca/publications/mill16.htm" target="_blank">2</a>] explores the implications of operator new failure.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Also, most of the cost of an exception, is probably in setting up the try/catch block, but it depends on a variety of factors.</td> </tr></table><span class="postbody">
<br/>
Like devkitARM, MinGW uses static libstdc++ and static libsupc++. When I researched GNU libstdc++'s iostream bloat some time ago, I used ostringstream as an example. The sizes of the binaries compiled for MinGW (x86) and devkitARM (Thumb) were roughly comparable: about a quarter megabyte each. In one program I wrote using the Allegro library, I found that code and data directly related to exceptions were adding roughly 32 KiB to the binary. But I guess that amount of overhead is a bit less significant on the DS than in a GBA multiboot program.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161460 - silent_code - Mon Aug 04, 2008 8:18 am</h4>
    <div class="postbody"><span class="postbody">Hey, thanks for the replies, guys! (You've got yourself a cherry, Berry! / Nothing new, Jessy Blue.)
<br/>
<br/>
:^D
<br/>
<br/>
<br/>
Oh, yes, btw: I use MinGW.
<br/>
<br/>
@ koryspansel: I will check it out later today (after work).
<br/>
<br/>
@ keldon: That's the point: How do I make sure delete gets called in exactly the place it's been <span style="font-style: italic">called</span>?
<br/>
<br/>
Well, before I overloaded the standard operators, I used std::list, with the same result! (EDIT: Not! It were other errors and leaks not detected by the last version of the tracer!)
<br/>
<br/>
The examples are a bit dumbed down to be to the point and easy, but yeah, it also happens with opjects (see CButton above). Also, I normally check every allocation etc.
<br/>
<br/>
Well, don't do uncatched exceptions result in runtime errors? I don't get any. I also use the C libraries most of the time (all of the time) and only use C++'s object systems for memory semi-"automatic" (with emphasis on the destructor) memory management. I don't think there's a whole lot of exceptions to catch with that, but it's a valid point.
<br/>
Let's just assume I do take care of that. :^)
<br/>
<br/>
I will do some more testing and I'll also add sentinels and memory dumping and see where that leads to. If I don't find it then, I think I might post my tracer for inspection.
<br/>
<br/>
And I'll definitely read that article! Thanks tepples. :^)
<br/>
<br/>
<br/>
Thanks guys! Keep it coming. :^)<br/>_________________<br/><span style="font-size: 9px; line-height: normal"><span style="text-decoration: underline"><span style="font-weight: bold"></span></span> July 5th 08: "<span style="font-weight: bold">Volumetric Shadow Demo</span>" 1.6.0 (final) source released
<br/>
June 5th 08: "<span style="font-weight: bold">Zombie NDS</span>" WIP released!
<br/>
It's all on my page, just click <span style="font-weight: bold">WWW</span> below.</span></span><span class="gensmall"><br/><br/>Last edited by silent_code on Tue Aug 05, 2008 7:44 pm; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#161471 - Miked0801 - Mon Aug 04, 2008 6:12 pm</h4>
    <div class="postbody"><span class="postbody">Perchance, are you doing any new/delete stuff in an interrupt function?  That's a sure fire way to get crazy leaks.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161475 - silent_code - Mon Aug 04, 2008 7:20 pm</h4>
    <div class="postbody"><span class="postbody">Interrupts on the PC under WinXP?
<br/>
I hope that's only available in kernel mode and via ASM! :^D
<br/>
<br/>
Seriously, there is NOTHING exotic about any of my programs. All of them are single threated (except one, but that one doesn't count) - even easy ones exhibit the behaviour.
<br/>
<br/>
I'm on to some more testing, although I'm a bit exhausted...
<br/>
<br/>
"I'll be back."<br/>_________________<br/><span style="font-size: 9px; line-height: normal"><span style="text-decoration: underline"><span style="font-weight: bold"></span></span> July 5th 08: "<span style="font-weight: bold">Volumetric Shadow Demo</span>" 1.6.0 (final) source released
<br/>
June 5th 08: "<span style="font-weight: bold">Zombie NDS</span>" WIP released!
<br/>
It's all on my page, just click <span style="font-weight: bold">WWW</span> below.</span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161484 - keldon - Mon Aug 04, 2008 9:30 pm</h4>
    <div class="postbody"><span class="postbody">Regarding delete getting called, I was directing that statement to the possibility of a class being inherited without a virtual destructor.
<br/>
<br/>
Your example stands out a lot because not much is going on, so there has got to be a fundamental flaw somewhere along the line!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161486 - koryspansel - Mon Aug 04, 2008 9:36 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
Like devkitARM, MinGW uses static libstdc++ and static libsupc++. When I researched GNU libstdc++'s iostream bloat some time ago, I used ostringstream as an example. The sizes of the binaries compiled for MinGW (x86) and devkitARM (Thumb) were roughly comparable: about a quarter megabyte each. In one program I wrote using the Allegro library, I found that code and data directly related to exceptions were adding roughly 32 KiB to the binary. But I guess that amount of overhead is a bit less significant on the DS than in a GBA multiboot program.
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Very true, exceptions aren't free size-wise either.  It was my understanding that exceptions could still be thrown even when disabled (just no valid unwind info), but based on a quick GCC test, this doesn't appear to be the case, it won't even let you compile.  MSVC allows this, but just issues a bunch of warnings.  I'm not exactly sure what happens on the DS, but, in my opinion, an unhandled exception should cause a reset (in final at least, but maybe not debug).  And if you've run out of memory, this seems like a reasonable course of action.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
Well, before I overloaded the standard operators, I used std::list, with the same result! 
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
This definitely makes me think that the bug is in your leak tracer.  I think the best thing to do is assume, for now, that delete (and new) functions correctly.  If delete works and std::list works (it better!), then that would leave the leak tracer.  So, it may be a good idea to try another.  Unfortunately, I don't know of any, but I'm sure Google does.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161487 - silent_code - Mon Aug 04, 2008 9:59 pm</h4>
    <div class="postbody"><span class="postbody">EDIT: Removed relic counter ("n") from s_removeWatch() and changed it's loop termination condition to check for NULL.
<br/>
<br/>
<br/>
Basically, the list IS the tracer!
<br/>
<br/>
And how do you explain the change in the ORDER of allocations? Nothing else has an influence on the memory being leaked or not... that sure is strange.
<br/>
<br/>
<br/>
The interface looks like that:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void *operator new(std::size_t size, const char *fileName, long lineNumber);
<br/>
void *operator new[](std::size_t size, const char *fileName, long lineNumber);
<br/>
<br/>
#define DEBUG_MEMORY_NEW new(__FILE__, __LINE__)
<br/>
#define new DEBUG_MEMORY_NEW
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Here's some code excerpts from the "new" implementation:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void *operator new(std::size_t size, const char *fileName, long lineNumber)
<br/>
{
<br/>
   void *pointer = NULL;
<br/>
   _DEBUG_POINTER((pointer = (void *)malloc(size)), "Out of memory!"); // this checks for NULL and prints an error message in case of an error
<br/>
   s_debug_newWatch((unsigned long)pointer, size, fileName, lineNumber);
<br/>
   return pointer;
<br/>
}
<br/>
<br/>
void *operator new[](std::size_t size, const char *fileName, long lineNumber)
<br/>
{
<br/>
   return operator new(size, fileName, lineNumber);
<br/>
}
<br/>
<br/>
<br/>
// standard versions
<br/>
<br/>
void *operator new(std::size_t size) throw(std::bad_alloc)
<br/>
{
<br/>
   return operator new(size, "Unknown", -1);
<br/>
}
<br/>
<br/>
void *operator new[](std::size_t size) throw(std::bad_alloc)
<br/>
{
<br/>
   return operator new(size, "Unknown", -1);
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
"delete" follows closely:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void operator delete(void *pointer, const char *fileName, long lineNumber)
<br/>
{
<br/>
   if(pointer == NULL)
<br/>
   {
<br/>
      return;
<br/>
   }
<br/>
<br/>
   s_debug_deleteWatch((unsigned long)pointer, fileName, lineNumber);
<br/>
   free(pointer);
<br/>
}
<br/>
<br/>
void operator delete[](void *pointer, const char *fileName, long lineNumber)
<br/>
{
<br/>
   operator delete(pointer, fileName, lineNumber);
<br/>
}
<br/>
<br/>
// only the standard versions are actually used!
<br/>
<br/>
void operator delete(void *pointer) throw()
<br/>
{
<br/>
   operator delete(pointer, "Unknown", -1);
<br/>
}
<br/>
<br/>
void operator delete[](void *pointer) throw()
<br/>
{
<br/>
   operator delete(pointer, "Unknown", -1);
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
<br/>
Beware, watches! (Extra corny joke!)
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">static void s_debug_newWatch(unsigned long address, std::size_t size, const char *fileName, long lineNumber)
<br/>
{
<br/>
   CAllocationInfo *info;
<br/>
<br/>
   _DEBUG_POINTER(info = new (std::nothrow) CAllocationInfo, "New Allocation Info failed!");
<br/>
   info-&gt;address = address;
<br/>
   info-&gt;line = lineNumber;
<br/>
   info-&gt;size = size;
<br/>
<br/>
   strncpy(info-&gt;fileName, fileName, MAX_FILENAME_LENGTH);
<br/>
<br/>
   allocationList.insert(allocationList.pLast, info);
<br/>
}
<br/>
<br/>
static void s_debug_deleteWatch(unsigned long address, const char *fileName, long lineNumber)
<br/>
{
<br/>
   if(allocationList.empty())
<br/>
   {
<br/>
      return;
<br/>
   }
<br/>
<br/>
   for(CAllocationInfo *i = allocationList.pFirst; i != NULL; i = i-&gt;pNext)
<br/>
   {
<br/>
      if(i-&gt;address == address)
<br/>
      {
<br/>
         allocationList.remove(i);
<br/>
         break;
<br/>
      }
<br/>
   }
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
<br/>
That code, with either my own list or std::list behaves THE SAME. (EDIT: No, it doesn't! I mixed up some other bugs with this! &lt;- Stupid!)
<br/>
<br/>
I will try to make a very small demo. (I won't, now what it's solved! Instead I will release it. ;^D )
<br/>
<br/>
And I BET (do not take literally) there is some stupid mistake there... (EDIT: Sure was! I kind of won... something. [Like working software, maybe?])<br/>_________________<br/><span style="font-size: 9px; line-height: normal"><span style="text-decoration: underline"><span style="font-weight: bold"></span></span> July 5th 08: "<span style="font-weight: bold">Volumetric Shadow Demo</span>" 1.6.0 (final) source released
<br/>
June 5th 08: "<span style="font-weight: bold">Zombie NDS</span>" WIP released!
<br/>
It's all on my page, just click <span style="font-weight: bold">WWW</span> below.</span></span><span class="gensmall"><br/><br/>Last edited by silent_code on Tue Aug 05, 2008 7:54 pm; edited 2 times in total</span></div>    
</div>
<div class="post">
    <h4>#161488 - DekuTree64 - Mon Aug 04, 2008 10:21 pm</h4>
    <div class="postbody"><span class="postbody">Does the nothrow new in newWatch bypass your overloaded new operator? I guess it must, or you'd recurse forever...
<br/>
<br/>
I don't see the watch info ever being deleted though. Just the pointer being removed from the list. But that shouldn't be tracked, right? So that wouldn't show up as an entry left in the list at the end...
<br/>
<br/>
What is the purpose of the variable 'n' in the loop in deleteWatch? It seems to just get incremented every time through the loop, but never actually used.
<br/>
<br/>
And I assume allocationList.pLast is a special end entry, and not the last valid entry? Come to think of it, is the entire list exempt from tracking? Otherwise you'd get crazy recursion again, adding a node to the tracking info list every time you add a node to the tracking info list...<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161490 - koryspansel - Mon Aug 04, 2008 10:32 pm</h4>
    <div class="postbody"><span class="postbody">Have you tried replacing new (std::nothrow) with malloc?  Maybe there is some mismatch between overloaded vs. default new/delete calls going on??</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161503 - silent_code - Tue Aug 05, 2008 8:00 am</h4>
    <div class="postbody"><span class="postbody">@ DekuTree64:
<br/>
<br/>
Oh, yeah, "n" is a left-over from previous iterations. Thanks for pointing it out!
<br/>
<br/>
Your assumption is right, new std::nothrow is not being overloaded, so recursion cycles don't happen. It behaves like malloc(), returning NULL on an allocation error.
<br/>
<br/>
The allocation / watch info objects get deleted by removing them from the list.
<br/>
<br/>
pLast is the last valid entry in the list. It's just like std::list.end(). The new entry will be appended to that last one and become pLast. It works as expected.
<br/>
The entire list is not being tracked, what makes the program <span style="font-weight: bold">not</span> go crazy in a runtime error rampage. :^)
<br/>
<br/>
<br/>
@ koryspansel: Yes, I have thought about it, but then, what would I gain? I had to manually call the constructor and destructor, afaIk, and I don't expect the behaviour to change. :^(
<br/>
The problem is, that there are no default new / delete calls (except for new std::nothrow), so I don't see a mismatch. :^(
<br/>
Even when deleting memory with my overloaded operators, that was allocated with new std::nothrow, should be allright. :^\
<br/>
<br/>
<br/>
I appreciate the help, guys. Thanks.<br/>_________________<br/><span style="font-size: 9px; line-height: normal"><span style="text-decoration: underline"><span style="font-weight: bold"></span></span> July 5th 08: "<span style="font-weight: bold">Volumetric Shadow Demo</span>" 1.6.0 (final) source released
<br/>
June 5th 08: "<span style="font-weight: bold">Zombie NDS</span>" WIP released!
<br/>
It's all on my page, just click <span style="font-weight: bold">WWW</span> below.</span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161505 - koryspansel - Tue Aug 05, 2008 10:36 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
pLast is the last valid entry in the list. It's just like std::list.end()
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
end() points to the element AFTER the last :)
<br/>
<br/>
Change:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
for(unsigned long n = 0; i != allocationList.pLast; i = i-&gt;pNext, n++) 
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
to:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
for(unsigned long n = 0; i != NULL; i = i-&gt;pNext, n++) 
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
And get rid of the n :)  Also, there's no need to manually call the constructor/destructor when overriding new/delete, the compiler takes care of that.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161515 - silent_code - Tue Aug 05, 2008 6:30 pm</h4>
    <div class="postbody"><span class="postbody">@ koryspansel:
<br/>
<br/>
You suggested to use malloc &amp; free directly instead of new (std::nothrow) &amp; delete, that's the case when the constructor and destructor would have to be called manually. (Is that assumption right?)
<br/>
<br/>
You are right, end() is the element after the last valid one. I put in my list implementation in a rush, so I replaced all references to end() with pLast... kind of silly, isn't it? :^D
<br/>
<br/>
Thanks for the remark!
<br/>
<br/>
I'm getting somewhere here. Although now I get crahes at program termination. I'll add more debug output to see what exactly is happening.
<br/>
<br/>
<br/>
EDIT:
<br/>
<br/>
OK!
<br/>
<br/>
I have done some more logging and apparently this dumb line was the cause of the error:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">for(CAllocationInfo *i = allocationList.pFirst; i != allocationList.pLast; i = i-&gt;pNext)
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
This one works correctly now:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">for(CAllocationInfo *i = allocationList.pFirst; i != NULL; i = i-&gt;pNext)
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
All because of stupid refactoring. (refactoring != stupid)
<br/>
That caused the pseudo random behaviour... what a noobish mistake. :^D
<br/>
<br/>
<br/>
This case is closed.
<br/>
<br/>
<br/>
THANK YOU VERY MUCH! :^)
<br/>
<br/>
<br/>
PS: In exchange for your help and participation, I will release the tracer (only for newcomers, as the experienced programmers surely don't need my implementation ;^D ) once it's tested on the NDS. :^)<br/>_________________<br/><span style="font-size: 9px; line-height: normal"><span style="text-decoration: underline"><span style="font-weight: bold"></span></span> July 5th 08: "<span style="font-weight: bold">Volumetric Shadow Demo</span>" 1.6.0 (final) source released
<br/>
June 5th 08: "<span style="font-weight: bold">Zombie NDS</span>" WIP released!
<br/>
It's all on my page, just click <span style="font-weight: bold">WWW</span> below.</span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161520 - koryspansel - Tue Aug 05, 2008 8:52 pm</h4>
    <div class="postbody"><span class="postbody">Glad to hear you've got it all sorted out!
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
You suggested to use malloc &amp; free directly instead of new (std::nothrow) &amp; delete, that's the case when the constructor and destructor would have to be called manually. (Is that assumption right?) 
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Well, no, since you're overriding new/delete in the first place the compiler will take care of it.  Inside of new/delete you also don't have any information about the type of object being constructed, maybe it's an int and has no destructor?  And actually, you can't even call the constructor.  The trick is to use the placement new, and the most common use of this, I've seen, is to allocate memory from a pool:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
void* pMem = allocateMemoryFromSomePool();
<br/>
Resource* pRes = new (pMem) Resource;
<br/>
<br/>
...
<br/>
<br/>
pRes-&gt;~Resource();
<br/>
freeMemoryFromSomePool(pRes);
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Besides this, I can't think of a lot of reasons for ever needing to call the ctor/dtor manually.
<br/>
<br/>
--
<br/>
Kory</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161522 - silent_code - Tue Aug 05, 2008 9:59 pm</h4>
    <div class="postbody"><span class="postbody">I really don't get the idea of what you are suggesting...
<br/>
<span style="font-weight: bold">Would you kindly</span> elaborate? ;^)
<br/>
<br/>
My current new / delete call malloc / free internally and when used, constructors and destructors get called automatically. Placement new won't be overwritten. So far it's totally clear.
<br/>
<br/>
But what did you want to say with this?
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>koryspansel wrote:</b></span></td> </tr> <tr> <td class="quote">Have you tried replacing new (std::nothrow) with malloc? Maybe there is some mismatch between overloaded vs. default new/delete calls going on??</td> </tr></table><span class="postbody">
<br/>
Did you mean overloading the std::nothrow placement new in the same manner like the others?
<br/>
Or did you mean to replace the calls to the operator with calls to malloc? (This is how I understood it.) That approach would require manual constructor calling.
<br/>
Btw: I only use std::nothrow in places I don't what to be traced (like in the tracer itself).
<br/>
<br/>
As you probably see I'd like to understand what you want to tell me, but I'm confused. :^)
<br/>
(Also, I'm debugging a multithreated application at the moment - which adds to the state of general confusion. ;^D )<br/>_________________<br/><span style="font-size: 9px; line-height: normal"><span style="text-decoration: underline"><span style="font-weight: bold"></span></span> July 5th 08: "<span style="font-weight: bold">Volumetric Shadow Demo</span>" 1.6.0 (final) source released
<br/>
June 5th 08: "<span style="font-weight: bold">Zombie NDS</span>" WIP released!
<br/>
It's all on my page, just click <span style="font-weight: bold">WWW</span> below.</span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161525 - koryspansel - Tue Aug 05, 2008 11:01 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
<span style="font-weight: bold">Would you kindly</span> elaborate?
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Did I come across as being harsh?  Apologies if so.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
My current new / delete call malloc / free internally and when used, constructors and destructors get called automatically. Placement new won't be overwritten. So far it's totally clear. 
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Sorry about that, didn't mean to add to the confusion.  I was randomly thinking that maybe when you freed your CAllocationInfo objects there was some mismatch between which new/delete was used, but now that I look over the code again, that wouldn't be an issue anyway.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
Or did you mean to replace the calls to the operator with calls to malloc? (This is how I understood it.) That approach would require manual constructor calling. 
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
No, I meant it only for the allocation info.  I was mainly just throwing out ideas to check, grasping at straws if you will.  But, yes if you replaced your global operator new/delete calls with malloc/free you would have to construct/destruct the objects manually.  I guess I should have just said that if you call new/delete the compiler calls the ctor/dtor automatically.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161526 - silent_code - Tue Aug 05, 2008 11:12 pm</h4>
    <div class="postbody"><span class="postbody"><a class="postlink" href="http://www.google.com/search?q=would+you+kindly" target="_blank">Would you kindly</a> play BioShock?
<br/>
<br/>
I hope you get the joke... like by now. :^D
<br/>
<br/>
Ok, then everything is clear.
<br/>
<br/>
I'm going to bed. :^D<br/>_________________<br/><span style="font-size: 9px; line-height: normal"><span style="text-decoration: underline"><span style="font-weight: bold"></span></span> July 5th 08: "<span style="font-weight: bold">Volumetric Shadow Demo</span>" 1.6.0 (final) source released
<br/>
June 5th 08: "<span style="font-weight: bold">Zombie NDS</span>" WIP released!
<br/>
It's all on my page, just click <span style="font-weight: bold">WWW</span> below.</span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161528 - tepples - Tue Aug 05, 2008 11:23 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>silent_code wrote:</b></span></td> </tr> <tr> <td class="quote"><a class="postlink" href="http://www.google.com/search?q=would+you+kindly" target="_blank">Would you kindly</a> play BioShock?</td> </tr></table><span class="postbody">
<br/>
Would you kindly buy me a new PC, an Xbox 360, or a PS3? All I have are an old PC, a DS, a PS2, and a Wii.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161535 - koryspansel - Wed Aug 06, 2008 1:13 am</h4>
    <div class="postbody"><span class="postbody">Ahh I see...haven't played BioShock before, so that would explain it.  Good to know :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161553 - silent_code - Wed Aug 06, 2008 7:56 am</h4>
    <div class="postbody"><span class="postbody">@ tepples:
<br/>
<br/>
All I have is a bunch of (very) old laptops and an old desktop PC, a rather new and fast laptop (which plays Cysis ok), an NGC, a GBA, a SNES and an NDS... :^D
<br/>
No money for a Wii atm. ;^)
<br/>
<br/>
I hear you americanos will get a 360 cut, so that the arcade model (no HDD) will cost "only" 200 USD.<br/>_________________<br/><span style="font-size: 9px; line-height: normal"><span style="text-decoration: underline"><span style="font-weight: bold"></span></span> July 5th 08: "<span style="font-weight: bold">Volumetric Shadow Demo</span>" 1.6.0 (final) source released
<br/>
June 5th 08: "<span style="font-weight: bold">Zombie NDS</span>" WIP released!
<br/>
It's all on my page, just click <span style="font-weight: bold">WWW</span> below.</span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161556 - kusma - Wed Aug 06, 2008 8:32 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>silent_code wrote:</b></span></td> </tr> <tr> <td class="quote">I hear you americanos will get a 360 cut, so that the arcade model (no HDD) will cost "only" 200 USD.</td> </tr></table><span class="postbody">
<br/>
Whut? That's like... 100?... Dead cheap! When will this cut happen?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161573 - silent_code - Wed Aug 06, 2008 6:25 pm</h4>
    <div class="postbody"><span class="postbody">It's scheduled for Sep. 7th.
<br/>
<br/>
Read more about it over <a class="postlink" href="http://news.vgchartz.com/news.php?id=1618" target="_blank">here</a>.<br/>_________________<br/><span style="font-size: 9px; line-height: normal"><span style="text-decoration: underline"><span style="font-weight: bold"></span></span> July 5th 08: "<span style="font-weight: bold">Volumetric Shadow Demo</span>" 1.6.0 (final) source released
<br/>
June 5th 08: "<span style="font-weight: bold">Zombie NDS</span>" WIP released!
<br/>
It's all on my page, just click <span style="font-weight: bold">WWW</span> below.</span></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
