<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Seeking Fixed Point Fractional Power Algorithm - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>C/C++ > Seeking Fixed Point Fractional Power Algorithm</h2>
<div id="posts">
<div class="post">
    <h4>#33136 - sgeos - Fri Dec 31, 2004 3:02 am</h4>
    <div class="postbody"><span class="postbody">Does anybody know of a way to raise a fixed point number to a fractional exponent (without resorting to floating point)?  If anyone is feeling crazy, I'm looking for a function with a prototype that looks something like this:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">FIXED exp_fixed(FIXED p_base, FIXED p_power, FIXED p_frac);</td> </tr></table><span class="postbody">
<br/>
<span style="font-weight: bold">p_base</span> is the base in fixed point format.
<br/>
<span style="font-weight: bold">p_power</span> is the power to raise p_base to.  May have a fractional component.
<br/>
<span style="font-weight: bold">p_frac</span> is the number of bits used for the fractional component of the base.
<br/>
The fractional component of the power is defined by a macro <span style="font-weight: bold">FIXED_POWER_FRAC</span>.
<br/>
<br/>
-Brendan</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#33159 - poslundc - Fri Dec 31, 2004 6:45 am</h4>
    <div class="postbody"><span class="postbody">That's a toughie. You could use the relation:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">y = a^b
<br/>
ln y = b * ln a
<br/>
exp(ln y) = exp(b * ln a)
<br/>
y = exp(b * ln a)</td> </tr></table><span class="postbody">
<br/>
<br/>
Now if it's practical for you to make a LUT for <span style="font-weight: bold">ln</span> that covers the entire domain of "a", and can also make a LUT for <span style="font-weight: bold">e^x</span> that covers the entire domain of (b * <span style="font-weight: bold">ln</span> a), then you'll have a really quick good approximation of your power function.
<br/>
<br/>
If that's not practical given your domains, then you'll probably have to calculate a series to a point of sufficient precision. Time to crack open yer old math books... :P
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#33459 - Miked0801 - Mon Jan 03, 2005 8:44 pm</h4>
    <div class="postbody"><span class="postbody">That about covers it - no built in functions raise items to fractional exponents - out of curiousity, why do you need this?  The only time I run into this are when I'm either doing calculus or some really crazy, in-efficient geometric transformation that should be using vector math.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#33478 - sgeos - Tue Jan 04, 2005 3:23 am</h4>
    <div class="postbody"><span class="postbody">I'd like a function that creates a custom gamma correction table- GBA, SP, DS, GBP/TV, VGA, and Custom.  It looks like I'll have to precompute gamma correction tables and offer global brightness adjustment instead of custom gamma.  (Or just brightness adjustment if I can't figure out the gamma for all the screens.)
<br/>
<br/>
Other than that, a fixed point fractional exponent function would be really cool. =)  Run time <span style="font-style: italic">experience to next</span> functions based on fractional exponential curves.  Sweet. =)
<br/>
<br/>
-Brendan</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#33484 - FluBBa - Tue Jan 04, 2005 10:47 am</h4>
    <div class="postbody"><span class="postbody">Here is the on I used in my emulators (Specificaly PCEAdvance):
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
;----------------------------------------------------------------------------
<br/>
paletteinit;   r0-r3 modified.
<br/>
;called by ui.c:  void map_palette(char gammavalue)
<br/>
;----------------------------------------------------------------------------
<br/>
<br/>
   stmfd sp!,{r4-r7,lr}
<br/>
   mov r7,#0xE0
<br/>
   ldr r6,=MAPPED_RGB
<br/>
   ldr r1,gammavalue   ;gamma value = 0 -&gt; 4
<br/>
   mov r4,#1024      ;pce rgb, r1=R, r2=G, r3=B
<br/>
   sub r4,r4,#2
<br/>
nomap               ;map 0000000gggrrrbbb  -&gt;  0bbbbbgggggrrrrr
<br/>
   and r0,r7,r4,lsl#1   ;Red ready
<br/>
   bl gprefix
<br/>
   mov r5,r0
<br/>
<br/>
   and r0,r7,r4,lsr#2   ;Green ready
<br/>
   bl gprefix
<br/>
   orr r5,r5,r0,lsl#5
<br/>
<br/>
   and r0,r7,r4,lsl#4   ;Blue ready
<br/>
   bl gprefix
<br/>
   orr r5,r5,r0,lsl#10
<br/>
<br/>
   strh r5,[r6,r4]
<br/>
   subs r4,r4,#2
<br/>
   bpl nomap
<br/>
<br/>
   ldmfd sp!,{r4-r7,lr}
<br/>
   bx lr
<br/>
<br/>
;----------------------------------------------------------------------------
<br/>
gprefix
<br/>
   orr r0,r0,r0,lsr#3
<br/>
   orr r0,r0,r0,lsr#6
<br/>
;----------------------------------------------------------------------------
<br/>
gammaconvert;   takes value in r0(0-0xFF), gamma in r1(0-4),returns new value in r0=0x1F
<br/>
;----------------------------------------------------------------------------
<br/>
   rsb r2,r0,#0x100
<br/>
   mul r3,r2,r2
<br/>
   rsbs r2,r3,#0x10000
<br/>
;   subne r2,r2,#0x2a8         ;Tweak for Gamma #4...
<br/>
   rsb r3,r1,#4
<br/>
   orr r0,r0,r0,lsl#8
<br/>
   mul r2,r1,r2
<br/>
   mla r0,r3,r0,r2
<br/>
   mov r0,r0,lsr#13
<br/>
<br/>
   bx lr
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
C-ish version:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
int GammaCorrection(int Luma, int Gamma){
<br/>
     int i = 0x100 - Luma;
<br/>
     i = i * i;
<br/>
     i = 0x10000 - i;
<br/>
     Luma = Luma | (Luma &lt;&lt; 8);
<br/>
     i = i * Gamma;
<br/>
     Luma = (Luma * (4-Gamma)) + i;
<br/>
     Luma = Luma &gt;&gt; 13;
<br/>
     return(Luma);
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Using brightness only lowers the range of the palette and you lose contrast.<br/>_________________<br/>I probably suck, my not is a programmer.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#33936 - phantom-inker - Tue Jan 11, 2005 9:05 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>sgeos wrote:</b></span></td> </tr> <tr> <td class="quote">Does anybody know of a way to raise a fixed point number to a fractional exponent (without resorting to floating point)?</td> </tr></table><span class="postbody">
<br/>
Yes.  I've actually coded up such a thing, and am using it in the game I'm working on.  The code is <span style="font-style: italic">not</span> simple, and ensuring that it remains numerically stable is a challenge.
<br/>
<br/>
I can't give you the code directly; I'm sorry; there'd be a little problem with copyrights ^^;
<br/>
However...  I <span style="font-style: italic">can</span> tell you the basic outline of the code, and where you have to look for the rest of the answers you'll need.
<br/>
<br/>
My power function works like this (in pseudocode):
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
IntPow(x, y) {
<br/>
    if x &lt; 0 then return 0
<br/>
    z = IntLog2(x) * y
<br/>
    return IntPow2(z)
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
IntLog2 computes the base-2 logarithm of an integer x, returning an 8.24 fixed-point number.  IntPow2 computes 2 raised to the zth power, where z is an 8.24 fixed-point number.
<br/>
<br/>
My implementation raises an integer x to a 16.16 fixed-point value y, and returns a result rounded to the nearest integer; if you need fractional bits in x or in the return value, that's not too hard to implement, but you'd better be up to the task of working out the math ;)  There are some nasty issues in IntPow relating to retaining precision; in my version, I implemented it as assembly to ensure that I could keep all 64 bits from the multiplication.
<br/>
<br/>
Now, as for the uglier details of implementing IntLog2 and IntPow2...
<br/>
<br/>
IntLog2 is divided into two halves.  First, you compute the integer portion of the logarithm using repeated shifting (i.e., find the position of the highest 1 bit, and that's the integer portion).  Then, use the algorithm described in Knuth (TAoCP, of course) 1.2.2.25 to take the other bits and compute the fractional portion of the logarithm (the Knuth/Briggs algorithm).  You'll need to pre-compute the additional logarithm table described in the book as well, but that can be easily done in a few lines of code (I just hacked together a Perl script to generate the table).
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
IntLog2(x) {
<br/>
   if x &lt;= 0 then return 0
<br/>
   result = [position of highest 1 bit in x]
<br/>
   x &lt;&lt;= 31 - result
<br/>
   y = [Knuth/Briggs algorithm 1.2.2.25 performed on x]
<br/>
   return (result &lt;&lt; 24) + (y &gt;&gt; 7)
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
IntPow2 is divided into three parts.  First, it breaks apart the fixed-point number into its integer and fractional parts.  Second, it uses algorithm E (Knuth 1.2.2.28, originally discovered by Feynman; note that the book has a typo in it --- it should be x = 1 - x, not x = 1 - e, in step E1) to compute 2^frac(x).  Third, it corrects for rounding (not shown below), and at the same time uses a clever shift to move the decimal point in the result from algorithm E so that the fractional part happens to become the integer part, and returns it.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
IntPow2(x) {
<br/>
   if x &lt;= 0 then return 0
<br/>
   frac = (x &gt;&gt; 24), x &amp;= 0xFFFFFF
<br/>
   if x &gt; 0 {
<br/>
     x &lt;&lt;= 7
<br/>
     y = [Knuth/Feynman algorithm 1.2.2.28 performed on x]
<br/>
     frac++
<br/>
   }
<br/>
   return y &gt;&gt; (31 - frac)
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
The math behind both algorithms is really far too complex to go into full detail here; <span style="font-weight: bold">STUDY</span> the <span style="font-style: italic">Art of Computer Programming, Volume I</span> if you are really planning to do this.
<br/>
<br/>
In reality, I don't use IntPow() directly for computing gamma, because its precision is in the wrong place.  I use a variant, IntFracPow(), that raises a 1.16 fixed-point base to a 16.16 fixed-point power.  This can be performed with a little extra arithmetic, and amounts to a total of four additional instructions compared to IntPow() in my version.
<br/>
<br/>
The code is all semi-ugly, as most deeply mathematical code is, but it runs blazingly fast (especially since I have it in IWRAM).  I can perform several thousand IntPow() calls per frame with plenty of time left over for music and some minimal input-handling, which is plenty for computing gamma tables on the fly --- assuming you cache the results for the actual game after they get computed, that is ;)<br/>_________________<br/>Do you suppose if I put a signature here, anyone would read it?  No?  I didn't think so either.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
