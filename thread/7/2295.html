<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>optimization -O3 and inline asm problems - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>C/C++ > optimization -O3 and inline asm problems</h2>
<div id="posts">
<div class="post">
    <h4>#12174 - johnny_north - Sun Nov 02, 2003 7:28 am</h4>
    <div class="postbody"><span class="postbody">Hello-
<br/>
<br/>
Maybe this question belongs in the asm forum...
<br/>
<br/>
I've been using the mbclient code from over at gba devr's. With no optimizations the code compiles fine, but when I compile at -O3, the compiler gives the following errors:
<br/>
<br/>
/cygdrive/c/WINDOWS/TEMP/cc0c07vF.s: Assembler messages:
<br/>
/cygdrive/c/WINDOWS/TEMP/cc0c07vF.s:1141: Error: Symbol MultiBootWaitCyclesLoop already defined.
<br/>
<br/>
from the code:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">  /* GCC code16 */
<br/>
  asm("mov r2, pc");
<br/>
  asm("lsr r2, #24");
<br/>
<br/>
  // EWRAM
<br/>
  asm("mov r1, #12");
<br/>
  asm("cmp r2, #0x02");
<br/>
  asm("beq MultiBootWaitCyclesLoop");
<br/>
<br/>
  // ROM 4/2 wait
<br/>
  asm("mov r1, #14");
<br/>
  asm("cmp r2, #0x08");
<br/>
  asm("beq MultiBootWaitCyclesLoop");
<br/>
<br/>
  // IWRAM
<br/>
  asm("mov r1, #4");
<br/>
<br/>
  asm("MultiBootWaitCyclesLoop:");
<br/>
  asm("sub r0, r1");
<br/>
  asm("bgt MultiBootWaitCyclesLoop");</td> </tr></table><span class="postbody">
<br/>
<br/>
I'm ignorant when it comes to assembly, but I can see that there's no redefinition - one lable and three branches to that lable. Anyone know what changes I can make to this to get it to assemble properly?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#12175 - johnny_north - Sun Nov 02, 2003 7:37 am</h4>
    <div class="postbody"><span class="postbody">Matter of fact, all inline labes cause an error:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">asm("MultiBootWaitCycles:");</td> </tr></table><span class="postbody">
<br/>
/cygdrive/c/WINDOWS/TEMP/ccBU3dNe.s: Assembler messages:
<br/>
/cygdrive/c/WINDOWS/TEMP/ccBU3dNe.s:1135: Error: Symbol MultiBootWaitCycles already defined.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">asm("MultiBootWait:");</td> </tr></table><span class="postbody">
<br/>
/cygdrive/c/WINDOWS/TEMP/ccd467kb.s: Assembler messages:
<br/>
/cygdrive/c/WINDOWS/TEMP/ccd467kb.s:1135: Error: Symbol MultiBootWait already defined.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">asm("MultiBoot:");</td> </tr></table><span class="postbody">
<br/>
/cygdrive/c/WINDOWS/TEMP/cc43AgC4.s: Assembler messages:
<br/>
/cygdrive/c/WINDOWS/TEMP/cc43AgC4.s:1135: Error: Symbol MultiBoot already defined.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#12180 - DekuTree64 - Sun Nov 02, 2003 5:07 pm</h4>
    <div class="postbody"><span class="postbody">Inline assembly is icky. Try putting it in a pure ASM function in a .s file. Just compile it to a .o with gcc like any other file. It should look something like this:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
.thumb
<br/>
.align 2
<br/>
.global MB
<br/>
MB:
<br/>
push {r4-r7} @if you need more than r0-r3
<br/>
@do stuff
<br/>
pop {r4-r7} @if you pushed them before
<br/>
bx lr
<br/>
</td> </tr></table><span class="postbody"><br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
