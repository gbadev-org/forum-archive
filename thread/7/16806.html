<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Having some trouble with object palette - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>C/C++ > Having some trouble with object palette</h2>
<div id="posts">
<div class="post">
    <h4>#169780 - Bozebo - Mon Aug 03, 2009 3:10 pm</h4>
    <div class="postbody"><span class="postbody">Hi. I am really struggling getting my sprite import system to work.
<br/>
I am aware than the overall code is rather limiting, but I just need to make a basic breakout game for uni and I need to be able to load in the sprites and combine their palettes into the shared palette.
<br/>
Firstly, you can <a class="postlink" href="http://www.bozebo.com/downloads/breakout.zip" target="_blank">download my code</a>. (uses devkitPro, included).
<br/>
Or <a class="postlink" href="http://www.bozebo.com/downloads/breakout_code.zip" target="_blank">just the code</a> if don't want to waste 56MB on devkitPro.
<br/>
<br/>
I had sprites working when I was just testing the pacman sprite tutorial ;)
<br/>
In an attempt to debug it I added some lines of code in main.cpp which fill the palette with a gradient from black to white, repeated to fill. Through that I am rather sure the issue is with the importSprite function in sprites.h, the second half of which checks to see if the colour for each pixel is already in the shared palette, and if so changes the OEMData value to that, if not it finds the first 0 - after transparent and black which are always pos 0 and 1 in the array - and puts it in there, and updates the position in OEMData.
<br/>
<br/>
I am fully aware that adding too many sprites would overload the palette and/or OEMData (especially if the sprites are not first known), so don't flame me for that ^_^ it is just a basic system so I can procure a sample game.
<br/>
<br/>
I have scoured my code and I cannot find out what the issue is, I have been working on this on and off for weeks. Can anybody help?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#169787 - Cearn - Mon Aug 03, 2009 7:08 pm</h4>
    <div class="postbody"><span class="postbody">The main problem is that the code and graphics data is not in the proper format. For 256-color objects, the pixels are 8 bits wide, but the graphics arrays and VRAM (yes VRAM; OAMData doesn't point to OAM, but to VRAM) accesses are 16-bits in size. This is why you see all those gaps in the graphics.
<br/>
<br/>
The next function is a replacement that, although untested, should work. I've modified the interface a bit to weed out unused parts and handled the tile index via a return instead of passing it by reference.
<br/>
<br/>
Note that I'm assuming that the graphic arrays are formatted correctly: with 8 bits per pixel instead of 16. I'm also accounting for the fact that VRAM can not be written to in bytes by saving the saving the color index in a buffer on even pixels and writing two pixels at once on odd pixels.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#define OBJ_GFX      ((u16*)0x06010000)
<br/>
#define OBJ_PALETTE   ((u16*)0x05000200)
<br/>
<br/>
/*!
<br/>
   \param sprGfx   Sprite graphics data.
<br/>
   \param sprPal   Sprite palette data.
<br/>
   \param   size   Size of graphics data in pixels (?)
<br/>
   \note   This only works for 8-bit graphics.
<br/>
*/
<br/>
int importSprite(const void *sprGfx, const u16 *sprPal, 
<br/>
   u32 size)
<br/>
{
<br/>
   int tileId= g_nextTile;
<br/>
   
<br/>
   u8 *srcGfx= (u8*)gfxData;         // Point to source gfx.
<br/>
   u16 *dstGfx= &amp;OBJ_GFX[tileId*64/2];   // OBJ-VRAM destination.
<br/>
   u16 *dstPal= OBJ_PALETTE;         // Object palette pointer.
<br/>
   
<br/>
   u32 buf, color;
<br/>
   u32 i, ipx, palSize=2;
<br/>
   
<br/>
   for(i=0; i&lt;size; i++)         // Loop over all pixels.
<br/>
   {
<br/>
      ipx= srcGfx[i];
<br/>
      if(ipx &gt; 1)
<br/>
      {
<br/>
         color= sprPal[ipx];      // Get pixel color.
<br/>
            
<br/>
         // Search for color.
<br/>
         for(ipx=1; ipx&lt;palSize; ipx++)
<br/>
            if(color == dstPal[ipx])
<br/>
               break;
<br/>
               
<br/>
         // Not found: add new color.
<br/>
         if(ipx==palSize)
<br/>
         {
<br/>
            dstPal[ipx]= color;
<br/>
            palSize++;
<br/>
            //# PONDER: what to do if palSize &gt; 256 ?!?
<br/>
         }
<br/>
      }
<br/>
      
<br/>
      // NOTE: VRAM needs 2-pixel access, so even i store 
<br/>
      // to buffer and odd i actually write to VRAM.
<br/>
      if(i%2)
<br/>
         dstGfx[i/2]= buf | ipx&lt;&lt;8;
<br/>
      else
<br/>
         buf= ipx;
<br/>
   }
<br/>
   
<br/>
   g_nextTile += size/64;
<br/>
<br/>
   return tileID;
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
I would also <span style="font-style: italic">strongly</span> recommend using either devkitPro's libgba or <a class="postlink" href="http://www.coranac.com/tonc/text/toc.htm" target="_blank">Tonc's</a> code library as a basis for GBA code, as much of the headers and functions you find on the web are often incorrect and/or inefficient. For example, the rgb() macro is unsafe (no parentheses around r, g, b), the vSync() function actually waits till the Vdraw instead of the VBlank period and none of the IO registers are volatile. I'd also suggest making use of DKP's template projects instead of batch file constructions. They can take care of new source files automatically, properly handle up-to-date files and do not depend on your platform or folder structure.
<br/>
<br/>
For some general hints: do not use so many magic numbers; it's almost always better to create named constants instead. And if you do use magic numbers, do not use decimal values for bitmasks, which are better represented in hex. If you need an integer for local variables, use int (or s32/u32) and not one of the smaller types. The latter do not lead to lower memory use and are slower as well. And they overflow easier, which can lead to all sorts of bugs. To illustrate what I mean, consider setSprX() :
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void setSprX(u8 id,u8 x){
<br/>
  //empty rightmost 9 bits
<br/>
  sprites[id].attribute1 &amp;= 64512;
<br/>
  //set the x value
<br/>
  sprites[id].attribute1 += x; // |= would also work
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
The constant 64512 is meaningless and in fact also incorrect. 64512 =0xFC00, which is actually the mask for 10 bits, not 9. And to indicate that you want to clear something, it may be better to use ~0x1FF instead. Also, x is supposed to be 9 bits, but u8 is only 8-bit. You're throwing away a bit. This may seem insignificant, but that extra bit is what allows you to place the object partially outside the left side of the screen. A better version would be:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#define ATTR1_X_MASK    0x1FF
<br/>
<br/>
void setSprX(int id, int x)
<br/>
{
<br/>
    sprites[id].attribute1 &amp;= ~ATTR1_X_MASK;       // Clear old X
<br/>
    sprites[id].attribute1 |= (x &amp; ATTR1_X_MASK);  // Insert new X
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I'm sorry if I come off as a bit of a hardass about this, but learning to program for a new platform can be hard enough without all these easily remedied issues getting in the way. These mistakes are not your fault. The unfortunate fact is that most of the GBA tutorials have some pretty poor coding standards and it'd be unfortunate if you'd adopt them. It's best to learn how to do things properly right at the start, instead of having to unlearn bad habits at a later stage.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#169790 - wallacoloo - Mon Aug 03, 2009 7:25 pm</h4>
    <div class="postbody"><span class="postbody">I found another thing that doesn't make sense to me:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">u8 defineSprite(){
<br/>
  spritesDefined ++;
<br/>
  return spritesDefined -= 1;
<br/>
}</td> </tr></table><span class="postbody">
<br/>
This is incrementing spritesDefined by 1, then decrementing it by 1 and returning the value.
<br/>
instead of "return spritesDefined -= 1;", use "return spritesDefined - 1;"
<br/>
<br/>
ATM, this isn't a big deal since you only have 1 sprite. But when you have more than one, I think they'd all have a sprite ID of 0.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#169791 - Bozebo - Mon Aug 03, 2009 7:49 pm</h4>
    <div class="postbody"><span class="postbody">Ah thanks. You've solved the issue and ones that would have confused me later on. Thanks for all the advice too.
<br/>
One thing though, I am not allowed to use a library for the task :( which makes sense. I probably wouldn't have used a library anyway because I am just like that, it's the best way to properly understand what is going on.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
u8 defineSprite(){
<br/>
  spritesDefined ++;
<br/>
  return spritesDefined -= 1;
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
Aha, I can't believe I did that. Thanks for pointing it out &gt;_&lt;</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#169792 - Cearn - Mon Aug 03, 2009 8:17 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Bozebo wrote:</b></span></td> </tr> <tr> <td class="quote">Ah thanks. You've solved the issue and ones that would have confused me later on. Thanks for all the advice too.
<br/>
One thing though, I am not allowed to use a library for the task :( which makes sense. I probably wouldn't have used a library anyway because I am just like that, it's the best way to properly understand what is going on.</td> </tr></table><span class="postbody">
<br/>
Well, you don't have to use the whole library, just yoink whatever you can use. The register #defines and bitflags are usually grouped together in one or two headers. Since you're going to have to get new #defines or at least modify the ones you have now, you might as well just grab the complete and correct sets from existing libraries.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#169809 - Bozebo - Tue Aug 04, 2009 3:31 pm</h4>
    <div class="postbody"><span class="postbody">edit:
<br/>
ignore whats below, I made a stupid mistake:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">u16 *dstGfx = &amp;OAMData[nextTile+(size*64)];</td> </tr></table><span class="postbody">
<br/>
instead of
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">u16 *dstGfx = &amp;OAMData[(nextTile-512)*64];</td> </tr></table><span class="postbody">
<br/>
<br/>
thanks for all your help, it works nicely now
<br/>
<br/>
seeing as you are here.
<br/>
Any advice on the algorithm to calculate bouncing of the ball off the blocks? If there was simply one block it would be easy, but with many near each other I suppose it has to keep track of previous positions and directions so it can loop through the possibilities so as to not get stuck inside a block - I may have the blocks locations define a "bitmap" of where the ball can and cannot be. Hey, at least it's only rectangles and a circle.
<br/>
<br/>
Or I could make a space invaders game.
<br/>
<br/>
-------------------------------------------------------------------------------------
<br/>
<br/>
I have it working (code-wise). But for some reasons the tiles only exist (as far as the hardware and emulator are concerned) as even numbers.
<br/>
So it starts at 512, then the next tile is 514, then 516 and so on. What is that all about? All the tutorials and documentation don't say anything about that, surely it would go 512,513.....
<br/>
<br/>
Because of this there is nothing drawn on the screen, the tileId I have set in OAM is 512, as it should be. But the data itself has ended up in 564. So the leftmost 8x8 block of the 1d mapped sprite is 564, then the next block is numbered 566. It has completely confused me.
<br/>
<br/>
What's up with that?
<br/>
<br/>
edit:
<br/>
here is what the function looks like now:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
u16 nextTile = 512; //the next available tile for objects, mode 4
<br/>
<br/>
//imports sprite palette and data from rom
<br/>
int importSprite(const void *gfxData,const u16 *sprPal,u32 size){
<br/>
  u8 *srcGfx = (u8*)gfxData; //source in rom
<br/>
  u16 *dstGfx = &amp;OAMData[nextTile+(size*64)]; //destination in vram
<br/>
  
<br/>
  u16 colour; //16-bit bgr colour
<br/>
  u16 buf; //buffer so 2 values can be written at once
<br/>
  u32 sourcePix,ipx; //for loop variables
<br/>
  
<br/>
  //loop through every pixel
<br/>
  for(sourcePix=0;sourcePix &lt; size*64;sourcePix++){
<br/>
    ipx = srcGfx[sourcePix]; //get the local palette position
<br/>
    //skip transparent and black palette positions
<br/>
    if(ipx &gt; 1){
<br/>
      colour = sprPal[ipx]; //get pixel colour
<br/>
        
<br/>
      //search for colour in the shared palette
<br/>
      for(ipx = 1;ipx&lt;256;ipx++)
<br/>
        if(colour == OBJPaletteMem[ipx]) //colour is found
<br/>
          break;
<br/>
           
<br/>
      //if not found
<br/>
      if(ipx == 256){
<br/>
        //find first 0 position, after transparent and black
<br/>
        for(ipx = 1;ipx &lt; 256;ipx ++)
<br/>
          //if all colours are full, the logic will fail (256 cols)
<br/>
          if(OBJPaletteMem[ipx] == 0)
<br/>
            break; 
<br/>
        //set the colour
<br/>
        OBJPaletteMem[ipx] = colour;
<br/>
      }
<br/>
    }
<br/>
    
<br/>
    //vram can only be written to in 16 bit; do this for every 2nd pix
<br/>
    if(sourcePix%2){
<br/>
      //add the pixels
<br/>
      dstGfx[sourcePix/2] = buf | ipx&lt;&lt;8;
<br/>
    } else {
<br/>
      //store the pixel data in a buffer until there are 2
<br/>
      buf = ipx;
<br/>
    }
<br/>
  }
<br/>
  
<br/>
  nextTile += size; //increment the next tile
<br/>
  return nextTile - size; //return this sprite's starting tile
<br/>
} 
<br/>
</td> </tr></table><span class="postbody">
<br/>
note:
<br/>
"size" is the number of 8x8 tiles that the sprite uses... though it ends up messing things up because nextTile increments by size, though in some ways needs to be incremented by size*2 - which causes further bugs and issues. not to mention halving the number of possible 8x8 tiles.
<br/>
<br/>
Also, the tile data for objects seems to start at 0x06014000 yet you used 0x06010000, which is correct? Remember I am in mode 4. All the technical documents and tutorials and faqs seem to completely conflict with each other, yet each seem to work if they are followed to the letter individually.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#169810 - Cearn - Tue Aug 04, 2009 3:56 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Bozebo wrote:</b></span></td> </tr> <tr> <td class="quote">I have it working (code-wise). But for some reasons the tiles only exist (as far as the hardware and emulator are concerned) as even numbers.
<br/>
So it starts at 512, then the next tile is 514, then 516 and so on. What is that all about? All the tutorials and documentation don't say anything about that, surely it would go 512,513.....
<br/>
<br/>
Because of this there is nothing drawn on the screen, the tileId I have set in OAM is 512, as it should be. But the data itself has ended up in 564. So the leftmost 8x8 block of the 1d mapped sprite is 564, then the next block is numbered 566. It has completely confused me.
<br/>
<br/>
What's up with that?</td> </tr></table><span class="postbody">
<br/>
<br/>
the basic unit for objects is the 4bpp tile, which is 32 bytes in size. You're using 8bpp tiles, which are 64 bytes wide, which means that the next tile is 64/32=2 away, not just one. See <a class="postlink" href="http://www.coranac.com/tonc/text/regobj.htm#sec-tiles" target="_blank">tonc: obj-tiles</a>.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Bozebo wrote:</b></span></td> </tr> <tr> <td class="quote">Also, the tile data for objects seems to start at 0x06014000 yet you used 0x06010000, which is correct? Remember I am in mode 4. All the technical documents and tutorials and faqs seem to completely conflict with each other, yet each seem to work if they are followed to the letter individually.</td> </tr></table><span class="postbody">
<br/>
Object VRAM starts at 0601:0000. However, in the bitmap video modes, tiles 0 to 511 are not accessible (well, they are, but that part of VRAM is used for the background, not objects). Only 512 and up are usable for objects. 0601:0000 + 512*32 = 0601:4000.
<br/>
<br/>
Also, there was reason why I renamed a few things. For example, OAMData does not lie in OAM, so the name is misleading. The object graphics are in VRAM. For global variables, it's generally a good idea to use an identifier that shows it as such. nextTile is too generic for a global variable; make sure that globals have a very specific name. If you want an example of why generic names for globals can be problematic, go to <a class="postlink" href="http://www.rinkworks.com/stupid/cs_programming.shtml" target="_blank">http://www.rinkworks.com/stupid/cs_programming.shtml</a> and search for "alpha". Lastly, the reason I used a local pointer for OBJPaletteMem was because local names can be shorter (which can make core easier to scan), local variables are faster, and because the actual algorithm (the loop) is now completely independent, meaning that it could be used for other 8-bit situations as well.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
