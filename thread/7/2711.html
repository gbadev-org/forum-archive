<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Performance problems - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>C/C++ > Performance problems</h2>
<div id="posts">
<div class="post">
    <h4>#15285 - qw3rty - Tue Jan 20, 2004 1:14 pm</h4>
    <div class="postbody"><span class="postbody">I have a little problem with the speed of my code.
<br/>
I try to do a raster-scrolling-effect (scroll the even lines to the left, the odd`s to the right)
<br/>
<br/>
My code is fast enough, but as soon I put it into an "if" - statement, like this :
<br/>
<br/>
if (bg0)
<br/>
{
<br/>
   (scroll-code for BG0)
<br/>
}
<br/>
if (bg1)
<br/>
{
<br/>
   (scroll-code for BG1)
<br/>
}
<br/>
.
<br/>
.
<br/>
.
<br/>
<br/>
the code doesn`t run fast enough to switch the scroll-pos depending on the line (the lines scroll randomly to the left/right).
<br/>
<br/>
I don`t get it why this if-statement slows things down (it should have NOTHING to do with my code inside the if ?!)
<br/>
<br/>
This isn`t a real problem though - enabling compiler optimization (-Os is enough) makes it fast enough - but I am curious how to optimize this switch.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#15286 - MumblyJoe - Tue Jan 20, 2004 1:24 pm</h4>
    <div class="postbody"><span class="postbody">I have two suggestions...
<br/>
<br/>
If your test conditions are constants or numbers (not variables) use a switch/case statement instead, I have never really looked into the difference in generated code but I have heard that good compilers can optimise them better.
<br/>
<br/>
Also you could try an if/else instead of an if/if, once again I havent examined the code output but i can imagine if you are only testing two conditions that this would be better.
<br/>
<br/>
could you post what code you use entirely so we could see if there is anything else that may be the cause?<br/>_________________<br/><a class="postlink" href="http://www.hungrydeveloper.com" target="_blank">www.hungrydeveloper.com</a>
<br/>
Version 2.0 now up - guaranteed at least 100% more pleasing!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#15288 - qw3rty - Tue Jan 20, 2004 1:42 pm</h4>
    <div class="postbody"><span class="postbody">I already tried a switch instead of if`s....in fact i replaced the switch with the if`s, cause a friend of mine suggested to try this to speed things up...
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
void scroll_BG_EXT2(TILE_Bg* text1, u8 bg_n) //scrolls BG_n 256pixels left/right (to next screen)
<br/>
{   
<br/>
  s16 x_scroll;
<br/>
  u8 i;
<br/>
  s16 x_scroll_old = text1[0].x_scroll;
<br/>
  if (bg_n == 0)
<br/>
  { 
<br/>
    if (x_scroll_old == 0)
<br/>
    {
<br/>
       for (i = 0; i smaller 256/8;i++)
<br/>
       {
<br/>
          while (REG_VCOUNT != 160)
<br/>
          {
<br/>
                  while ((*DISPSTAT &amp; BIT1) == 0);
<br/>
                  {
<br/>
                          if ((REG_VCOUNT &amp; BIT0) !=0) //even line
<br/>
                          {
<br/>
                                  x_scroll=(i sh_left 3);
<br/>
                          }
<br/>
                          else //odd line
<br/>
                          {
<br/>
                          x_scroll=-(i sh_left 3);
<br/>
                          }
<br/>
                  }        
<br/>
                  REG_BG0HOFS = x_scroll;          
<br/>
           }  
<br/>
           if (REG_VCOUNT == 160)
<br/>
           {
<br/>
                      updateSpritesAnim(); 
<br/>
           }
<br/>
      
<br/>
      }
<br/>
    }
<br/>
    else //screen 2 / x_scroll_old = 256
<br/>
    {
<br/>
       for (i = 256/8; i greater 0;i--)
<br/>
       {
<br/>
          while (REG_VCOUNT != 160)
<br/>
          {
<br/>
                  while ((*DISPSTAT &amp; BIT1) == 0);
<br/>
                  {
<br/>
                          if ((REG_VCOUNT &amp; BIT0) !=0) //even line
<br/>
                          {
<br/>
                                  x_scroll=-(i sh_left 3);
<br/>
                          }
<br/>
                          else //odd line
<br/>
                          {
<br/>
                          x_scroll=+(i sh_left 3);
<br/>
                          }
<br/>
                  }        
<br/>
                  REG_BG0HOFS = x_scroll;         
<br/>
           }  
<br/>
           if (REG_VCOUNT == 160)
<br/>
           {
<br/>
                      updateSpritesAnim(); 
<br/>
           }
<br/>
      
<br/>
      }    
<br/>
       
<br/>
    }
<br/>
   } //if bg_n == 0 end
<br/>
<br/>
.
<br/>
.
<br/>
.
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
err...don`t be to confused about the "smaller" and "sh_left" stuff - the "&gt; / &lt;" keys aren`t working on my keyboard ;)
<br/>
<br/>
I have 3 more if-statements, that are activated for bg1...bg3 with the exact same code (only the REG_BGxOFFSET's are replaced with the proper ones)
<br/>
<br/>
I think I could disable the "if (x_scroll_old == 0)" statement ...[/code]</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#15289 - qw3rty - Tue Jan 20, 2004 1:59 pm</h4>
    <div class="postbody"><span class="postbody">I ereased the if "(x_scroll_old == 0)" switch - resulting in non-functional, STILL to slow code....</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#15291 - ampz - Tue Jan 20, 2004 2:29 pm</h4>
    <div class="postbody"><span class="postbody">Why the "if (bg_n == 0), if (bg_n == 1), if (bg_n == 2), if (bg_n == 3)" ?
<br/>
As far as I can see, this code only scrolls one background at a time.
<br/>
Are thoose if statements just there for added flexibility?
<br/>
<br/>
Your problem is in the scroll code... You wait for HBlank, but you never check that you have left HBlank before you calculate the next scroll value.
<br/>
Also, you may want a check to make sure you start scrolling at the beginning of a frame.
<br/>
<br/>
I'd suggest something like this: (untested code)
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
for (i = 0; i smaller 256/8;i++) { 
<br/>
    while (REG_VCOUNT != 227);           //Wait for the start of a frame.
<br/>
    while (REG_VCOUNT != 160) { 
<br/>
        while ((*DISPSTAT &amp; BIT1) == 1); //Wait until we have left HBlank
<br/>
<br/>
        //Precalculate next scroll value while the current line is drawn
<br/>
        if ((REG_VCOUNT &amp; BIT0) !=0)     //Even line
<br/>
            x_scroll=(i sh_left 3); 
<br/>
        else                             //Odd line
<br/>
            x_scroll=-(i sh_left 3); 
<br/>
        while ((*DISPSTAT &amp; BIT1) != 1); //Wait for HBlank
<br/>
        REG_BG0HOFS = x_scroll;          
<br/>
    }  
<br/>
    updateSpritesAnim(); 
<br/>
} 
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#15292 - qw3rty - Tue Jan 20, 2004 3:14 pm</h4>
    <div class="postbody"><span class="postbody">You`re right, the "if`s" are only for added flexibility...in fact I only use this function to scroll one particular BG (always BG1).
<br/>
<br/>
Now  I see the problem : 
<br/>
I was doing all the work in HBLANK, but could have done the calculation of the offset outside the HBLANK.
<br/>
Actually my code even attempted to scroll the BG multiple times in ONE hblank-phase ;)
<br/>
<br/>
Thanks for the advice :D</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#15294 - qw3rty - Tue Jan 20, 2004 3:31 pm</h4>
    <div class="postbody"><span class="postbody">It`s working now :D
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
void scroll_BG_EXT2(TILE_Bg* text1, u8 bg_n) //scrolls BG_n 256pixels left/right (to next screen)
<br/>
{   
<br/>
  s16 x_scroll;
<br/>
  u8 i;
<br/>
  s16 x_scroll_old = text1[0].x_scroll;
<br/>
  if (bg_n == 0)
<br/>
  { 
<br/>
       for (i = 0; i smaller 256/8;i++)
<br/>
       {
<br/>
          while (REG_VCOUNT != 160)
<br/>
          {
<br/>
                  while ((*DISPSTAT &amp; BIT1) == 0)  // &lt;---removed semicolon (D'OH !)
<br/>
                  {  //&lt;--- are these two {}'s ignored with the semicolon ?
<br/>
                          if ((REG_VCOUNT &amp; BIT0) !=0) //even line
<br/>
                          {
<br/>
                                  x_scroll=(i sh_left 3);
<br/>
                          }
<br/>
                          else //odd line
<br/>
                          {
<br/>
                          x_scroll=-(i sh_left 3);
<br/>
                          }
<br/>
                          while ((*DISPSTAT &amp; BIT1) ==0); // &lt;---added
<br/>
                  }   //&lt;--- are these two {}'s ignored with the semicolon ?      
<br/>
                  REG_BG0HOFS = x_scroll;   
<br/>
                  while ((*DISPSTAT &amp; BIT1) != 0);  // &lt;---added
<br/>
           }  
<br/>
           if (REG_VCOUNT == 160)
<br/>
           {
<br/>
                      updateSpritesAnim(); 
<br/>
           }
<br/>
      
<br/>
        }
<br/>
<br/>
   } //if bg_n == 0 end
<br/>
.
<br/>
.
<br/>
.
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I removed a semicolon (I think the {...} were ignored, correct me if I`m wrong ;)) and added two waits - one for the HBLANK to occur another for the finish of HBLANK ;)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#15307 - ampz - Tue Jan 20, 2004 7:29 pm</h4>
    <div class="postbody"><span class="postbody">Yeah, now you messed it up real good :-)
<br/>
<br/>
If you look at my code... first I wait until we have left HBlank. Then I do the calculation, wait for Hblank, enter the new scroll value, and then I go back waiting for the GBA to leave HBlank.
<br/>
<br/>
You have one "while" more than you need. And the {} should not be there at all.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#15359 - qw3rty - Wed Jan 21, 2004 11:48 am</h4>
    <div class="postbody"><span class="postbody">Thanks for the help ampz :D
<br/>
I think every unnecessary "while" is cut out now...</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
