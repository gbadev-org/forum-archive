<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>How to copy a function from ROM to RAM? - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>C/C++ > How to copy a function from ROM to RAM?</h2>
<div id="posts">
<div class="post">
    <h4>#146368 - brave_orakio - Mon Dec 03, 2007 6:06 am</h4>
    <div class="postbody"><span class="postbody">Is there any way to do it? or just use
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#define CODE_EWRAM __attribute__((section(".ewram")))
<br/>
#define CODE_IN_IWRAM __attribute__((section(".iwram"),long_call))
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Another question would be, does the compiler put a function in RAM as needed when you add the above attribute or does it put it in RAM immediately whether or not the situation calls for it?<br/>_________________<br/>help me</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146369 - tepples - Mon Dec 03, 2007 6:13 am</h4>
    <div class="postbody"><span class="postbody">If the source code specifies that a function shall go in a section, it goes in that section. The linker has no idea whether or not "the situation calls for it".<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146370 - brave_orakio - Mon Dec 03, 2007 6:23 am</h4>
    <div class="postbody"><span class="postbody">I see. Which means that if you declare a function to be in RAM, it stays there? 
<br/>
Is there a way to make this dynamic? Say, I need a specific AI routine but I dont want it to be in RAM all the time. What I want is to put a routine in RAM only when I need it. Maybe remove it afterwards or just let it get overwritten by another routine.<br/>_________________<br/>help me</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146371 - tepples - Mon Dec 03, 2007 6:26 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>brave_orakio wrote:</b></span></td> </tr> <tr> <td class="quote">I see. Which means that if you declare a function to be in RAM, it stays there? 
<br/>
Is there a way to make this dynamic? Say, I need a specific AI routine but I dont want it to be in RAM all the time.</td> </tr></table><span class="postbody">
<br/>
Then you get into "IWRAM overlays". I haven't gone there yet, and I don't think a lot of people understand that part of the devkitARM GBA link script.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146373 - brave_orakio - Mon Dec 03, 2007 6:38 am</h4>
    <div class="postbody"><span class="postbody">Well, not necessarily IWRAM. For IWRAM, I'll probably just place the most common  and costly functions like collision and priority sorting. 
<br/>
<br/>
I was thinking more on EWRAM. But would it be similar to this IWRAM overlaying?<br/>_________________<br/>help me</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146374 - tepples - Mon Dec 03, 2007 6:43 am</h4>
    <div class="postbody"><span class="postbody">EWRAM has a set of overlays that I'm assuming work the same way. But on the GBA, what advantage would code in EWRAM have over code in ROM? They run at comparable speeds (2/2 wait in EWRAM, 3/1 in ROM), unless you're on a SuperCard or a really old Visoly card that only supports 4/2 ROM.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146376 - brave_orakio - Mon Dec 03, 2007 7:08 am</h4>
    <div class="postbody"><span class="postbody">Whoops! That I didn't know. 
<br/>
So there is hardly any performance gained from code in EWRAM and code in ROM? 
<br/>
What would the main function  of EWRAM be in that case? Only for variables then?<br/>_________________<br/>help me</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146387 - tepples - Mon Dec 03, 2007 1:52 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>brave_orakio wrote:</b></span></td> </tr> <tr> <td class="quote">What would the main function  of EWRAM be in that case? Only for variables then?</td> </tr></table><span class="postbody">
<br/>
That, and code that needs to run in RAM because of bus conflict issues (namely code that accesses certain kinds of GBA save chips), and code that needs to run on a machine without a Game Pak inserted (single-cart multiplayer), and code that needs to run from a cart with a "funny" mapper scheme (GBA Movie Player).
<br/>
<br/>
But I'm just waiting for wintermute, who knows the insides of devkitARM better than I do, to step in and clarify the whole overlay bit.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146389 - kusma - Mon Dec 03, 2007 2:32 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tepples wrote:</b></span></td> </tr> <tr> <td class="quote">But I'm just waiting for wintermute, who knows the insides of devkitARM better than I do, to step in and clarify the whole overlay bit.</td> </tr></table><span class="postbody">
<br/>
I'm not sure what you need clarification on, but I've used IWRAM overlays with great success myself. It's a bit undocumented, perhaps I should submit an example to the devkitPro distribution?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146403 - tepples - Mon Dec 03, 2007 8:26 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>kusma wrote:</b></span></td> </tr> <tr> <td class="quote">I've used IWRAM overlays with great success myself. It's a bit undocumented, perhaps I should submit an example to the devkitPro distribution?</td> </tr></table><span class="postbody">
<br/>
That would be great.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146411 - silent_code - Mon Dec 03, 2007 10:52 pm</h4>
    <div class="postbody"><span class="postbody">second that!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146413 - kusma - Mon Dec 03, 2007 11:03 pm</h4>
    <div class="postbody"><span class="postbody">Here's an example for your own needs. I'll look into what I need to do to submit it to the dkp-project.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#include &lt;gba_console.h&gt;
<br/>
#include &lt;gba_video.h&gt;
<br/>
#include &lt;gba_interrupt.h&gt;
<br/>
#include &lt;gba_systemcalls.h&gt;
<br/>
<br/>
#include &lt;stdio.h&gt;
<br/>
<br/>
void overlay1_test() __attribute__((section(".iwram1"), long_call));
<br/>
void overlay2_test() __attribute__((section(".iwram2"), long_call));
<br/>
<br/>
void overlay1_test()
<br/>
{
<br/>
   printf("inside %s\n", __func__);
<br/>
}
<br/>
<br/>
void overlay2_test()
<br/>
{
<br/>
   printf("inside %s\n", __func__);
<br/>
}
<br/>
<br/>
extern unsigned char __iwram_overlay_start[];
<br/>
extern unsigned char __load_start_iwram0[];
<br/>
extern unsigned char __load_stop_iwram0[];
<br/>
extern unsigned char __load_start_iwram1[];
<br/>
extern unsigned char __load_stop_iwram1[];
<br/>
extern unsigned char __load_start_iwram2[];
<br/>
extern unsigned char __load_stop_iwram2[];
<br/>
<br/>
int main()
<br/>
{
<br/>
   irqInit();
<br/>
   irqEnable(IRQ_VBLANK);
<br/>
   consoleInit(0, 4, 0, NULL, 0, 15);
<br/>
   BG_COLORS[0]=RGB8(58,110,165);
<br/>
   BG_COLORS[241]=RGB5(31,31,31);
<br/>
<br/>
   SetMode(MODE_0 | BG0_ON);
<br/>
<br/>
   /* verify that the overlays are indeed overlapping */
<br/>
   printf("overlay1_test: %p\noverlay2_test: %p\n", overlay1_test, overlay2_test);
<br/>
   
<br/>
   /* set overlay 1 and run code from it */
<br/>
   memcpy(__iwram_overlay_start, __load_start_iwram1, (int)__load_stop_iwram1 - (int)__load_start_iwram1);
<br/>
   overlay1_test();
<br/>
   
<br/>
   /* set overlay 2 and run code from it */
<br/>
   memcpy(__iwram_overlay_start, __load_start_iwram2, (int)__load_stop_iwram2 - (int)__load_start_iwram2);
<br/>
   overlay2_test();
<br/>
   
<br/>
   /* back to normal */
<br/>
   memcpy(__iwram_overlay_start, __load_start_iwram0, (int)__load_stop_iwram0 - (int)__load_start_iwram0);
<br/>
   while(1);
<br/>
}
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146434 - brave_orakio - Tue Dec 04, 2007 5:46 am</h4>
    <div class="postbody"><span class="postbody">Ah I see. So it's ok to execute code from ROM then. Thanks for your response tepples and also thank you Kusma for the example of the IWRAM overlay. I'l try it out and experiment with it.<br/>_________________<br/>help me</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146495 - Miked0801 - Tue Dec 04, 2007 10:42 pm</h4>
    <div class="postbody"><span class="postbody">BTW, don't run code from EWRAM unless you really have no other alternative.  2/2 wait states will run just about twice as slow as code in 3/1 land due to the linear way that most code is run.  EWRAM also has a 16-bit bus like ROM so ARM code runs at half speed.  Whenever we want a truely fast routine, we loaded it into IWRAM and compiled it as ARM (or hand asm coded the ARM.)
<br/>
<br/>
For a quick a dirty way to do this, just create a static IWRAM buffer (array) and memcopy the requested code into the buffer.  In essence, this is what crt0 is doing on bootup for you.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146571 - brave_orakio - Thu Dec 06, 2007 3:39 am</h4>
    <div class="postbody"><span class="postbody">Ah yes thank you. By the way, could you guys point me to the document for the code execution wait states? I saw the copy wait states in cowbite specs but not the code execution wait states.<br/>_________________<br/>help me</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146586 - keldon - Thu Dec 06, 2007 11:30 am</h4>
    <div class="postbody"><span class="postbody"><a href="http://nocash.emubase.de/gbatek.htm#dsmemorytimings" target="_blank">http://nocash.emubase.de/gbatek.htm#dsmemorytimings</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146587 - kusma - Thu Dec 06, 2007 12:22 pm</h4>
    <div class="postbody"><span class="postbody">I got the impression that these questions were about GBA, and if so - here's the correct link: <a href="http://nocash.emubase.de/gbatek.htm#gbasystemcontrol" target="_blank">http://nocash.emubase.de/gbatek.htm#gbasystemcontrol</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146848 - brave_orakio - Mon Dec 10, 2007 2:46 am</h4>
    <div class="postbody"><span class="postbody">Thanks guys! I only saw this version of GBATEK today! With both GBA and NDS too!<br/>_________________<br/>help me</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146862 - kusma - Mon Dec 10, 2007 11:18 am</h4>
    <div class="postbody"><span class="postbody">By the way, this is the official GBAtek-site. Any other GBAtek mirror tend to be out-of-date, so update your links ;)</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
