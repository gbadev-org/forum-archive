<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>initializing buffer data - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>C/C++ > initializing buffer data</h2>
<div id="posts">
<div class="post">
    <h4>#67437 - linus - Wed Jan 18, 2006 1:59 am</h4>
    <div class="postbody"><span class="postbody">hello, i have the following bit of code: 
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">    
<br/>
while (length &gt; curPos) {
<br/>
          char *buffer = (char*) malloc(32);
<br/>
          FAT_fread(buffer, 32, 1, fp);
<br/>
          PA_OutputSimpleText(0,0,j++, buffer);
<br/>
          curPos = fp-&gt;curPos;
<br/>
          free(buffer);
<br/>
          //PA_OutputText(0,0,j++,"%d bytes read", result); 
<br/>
} 
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
and everything works fine but the buffer contains the old data - how can i clear it?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#67444 - sajiimori - Wed Jan 18, 2006 4:25 am</h4>
    <div class="postbody"><span class="postbody">Writing to the buffer just before freeing it doesn't make sense, and writing to it after freeing it is undefined in C.
<br/>
<br/>
To understand why, think of malloc as creating a new buffer every time you call it.  The address malloc returns should be considered random, as should the contents of a newly-allocated buffer.
<br/>
<br/>
If malloc happens to return the same address each time through the loop, that should be considered a coincidence.  Relying on such a coincidence will lead to confusion later.
<br/>
<br/>
'calloc' will allocate a block and then fill it with zeroes.  It's just like calling malloc followed by memset.
<br/>
<br/>
All that aside, you should not be using malloc/free here.  Allocating 'buffer' on the stack (by declaring it as a local array) is faster and simpler.  If you must use dynamic allocation, you could at least allocate the buffer once before entering the loop instead of allocating and freeing it repeatedly.
<br/>
<br/>
In general, don't use dynamic allocation unless it makes your program better in a measurable way.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#67506 - linus - Wed Jan 18, 2006 6:47 pm</h4>
    <div class="postbody"><span class="postbody">yeah i see what your saying - and i did expect malloc to return a different memory space everytime, but it didnt.
<br/>
<br/>
this was my original code:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
    while (length &gt; curPos) {
<br/>
          char *buffer[32];
<br/>
          FAT_fread(buffer, 32, 1, fp);
<br/>
          PA_OutputSimpleText(0,0,j++, buffer);
<br/>
          curPos = fp-&gt;curPos;
<br/>
    } 
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
the reason i switched to malloc was to see if it cleared the buffer (which it didnt because i should have been calling calloc). this method doesnt clear every time the buffer is created.
<br/>
<br/>
i dont want to have 
<br/>
<br/>
char *buffer[32] = "    ...  " //32 whitespaces
<br/>
<br/>
but how do i get this effect?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#67513 - sajiimori - Wed Jan 18, 2006 7:44 pm</h4>
    <div class="postbody"><span class="postbody">Careful -- the above declaration creates an array of 32 <span style="font-style: italic">pointers</span> to chars.  Take out the asterisk to create 32 chars.
<br/>
<br/>
Do you want spaces or nulls?  They are different values.
<br/>
<br/>
You can have the compiler generate code to clear the array upon declaration like this:</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">char buffer[32] = { 0 };</td> </tr></table><span class="postbody">
<br/>
You can also make a 'for' loop to iterate over the array and set it to the values you want.  'memset' is a standard library function for that.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#67514 - linus - Wed Jan 18, 2006 7:48 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>sajiimori wrote:</b></span></td> </tr> <tr> <td class="quote">Careful -- the above declaration creates an array of 32 <span style="font-style: italic">pointers</span> to chars.  Take out the asterisk to create 32 chars.
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
oh bumf your right - sorry should have spotted this :S thanks very much for your help. what can i say - im a java programmer lol.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
