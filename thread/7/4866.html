<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Arrays of pointers to image data == black screens? - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>C/C++ > Arrays of pointers to image data == black screens?</h2>
<div id="posts">
<div class="post">
    <h4>#34448 - Kyoufu Kawa - Wed Jan 19, 2005 7:49 pm</h4>
    <div class="postbody"><span class="postbody">Greetings. I'm writing a game (what a surprise) that has several still images. In the first run, these images were loaded to VRAM as needed by three DMA calls. In the second run, I had three arrays listing each picture's tiles, map and palette. This however didn't work and gave me blackness. I suppose this is because I don't know jack about pointers and stuff like that yet so I guess it's just a missing &amp; or something. Third run, which I don't intend to use, has several if clauses, which is as wasteful as the first run. Here's the code. I originally intended to use just one array but this will suffice. I hope one of you guys/gals can show me how to make it go.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#include "pics.h"
<br/>
...
<br/>
const u8 *picTiles[] =
<br/>
{
<br/>
   scene_title_Tiles,
<br/>
   scene_intro_Tiles,
<br/>
   ...
<br/>
   scene_gameover_Tiles
<br/>
};
<br/>
const u16 *picPals[] =
<br/>
{
<br/>
   scene_title_Palette,
<br/>
   scene_intro_Palette,
<br/>
   ...
<br/>
   scene_gameover_Palette
<br/>
};
<br/>
const u16 *picMaps[] =
<br/>
{
<br/>
   scene_title_Map,
<br/>
   scene_intro_Map,
<br/>
   ...
<br/>
   scene_gaemover_Map
<br/>
};
<br/>
<br/>
void ShowPic(u16 picture)
<br/>
{
<br/>
// Third run code
<br/>
//   if(picture==1)
<br/>
//   {
<br/>
//      DmaArrayCopy(3, scene_intro_Tiles, BG_VRAM+0x4000, 32);
<br/>
//      DmaArrayCopy(3, scene_intro_Palette, BG_PLTT, 32);
<br/>
//      DmaArrayCopy(3, scene_intro_Map, BG_VRAM+0x0800, 32);
<br/>
//   }
<br/>
<br/>
// Second run code
<br/>
   DmaArrayCopy(3, picTiles[picture], BG_VRAM+0x4000, 32);
<br/>
  DmaArrayCopy(3, picPals[picture], BG_PLTT, 32);
<br/>
  DmaArrayCopy(3, picMaps[picture], BG_VRAM+0x0800, 32);
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
Thank you for your time.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#34457 - Mucca - Wed Jan 19, 2005 9:49 pm</h4>
    <div class="postbody"><span class="postbody">I assume the pointers within your arrays of pointers (eg scene_title_Tiles) are themselves declared as arrays in pics.h, otherwise array copy wont work (it wouldnt know the size to copy if they were just external symbols in an object file created from raw binary data).
<br/>
Also make sure the background layer you're using has its tile base block set to 2 (because of 0x4000) and screen map offset set to 1 (0x800). Use Visual Boy Advance to check if anything at all is getting copied to VRAM or Palette RAM, and also the background control register. The way you're passing the pointers to the Dma macro seems fine to me.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#34496 - Kyoufu Kawa - Thu Jan 20, 2005 3:22 pm</h4>
    <div class="postbody"><span class="postbody">Well, each image has it's own .c and .o file. pics.h consists mostly of extern const statements. Array sizes are defined for all in this header.
<br/>
<br/>
The background register has been set up correctly, never mind that.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#34499 - Cearn - Thu Jan 20, 2005 3:47 pm</h4>
    <div class="postbody"><span class="postbody">Exactly how would DmaArrayCopy know how much data it needs to copy? I see source and destination, but nothing to do with length. The only way that I could think of is that if you are using the <span style="font-weight: bold">sizeof</span> operator inside it; but that'd only give you the size of the pointer (i.e., 4), not the size of the array. See <a class="postlink" href="http://forum.gbadev.org/viewtopic.php?t=4801" target="_blank">here</a> for a bit more on how sizeof works. If it's not done with sizeof, then how?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#34504 - Mucca - Thu Jan 20, 2005 5:20 pm</h4>
    <div class="postbody"><span class="postbody">In fact you'll know if its a sizeof problem if you look at the memory in VBA and only four bytes are being copied. Probably easiest with palette memory at 0x05000000, as I doubt the first two colours in your palette are black, whereas with tiles the first tile probably should be all zeroes. 
<br/>
<br/>
But if they are declared as arrays with static size in the header file, regardless whats in the c file, then sizeof should return the size of the array. However, if the array is at any stage reinterpreted as a pointer rather than an array, as in your method two, then sizeof will return the size of the pointer not the array. ie
<br/>
<br/>
int getSize(char * ptr){
<br/>
    return sizeof(ptr);
<br/>
}
<br/>
<br/>
main()
<br/>
{
<br/>
char mystr[] = "I am not me";
<br/>
...
<br/>
cout &lt;&lt;sizeof mystr
<br/>
       &lt;&lt;getSize(mystr);
<br/>
<br/>
}
<br/>
<br/>
will output
<br/>
12
<br/>
4
<br/>
<br/>
So, I think third method should work, but not second method. Actually the third method mightn't work either if the arrays are external.
<br/>
Regardless, you should probably start converting everthing to raw binary and using objcopy to convert to object files. Then you get a start, end, and size symbol. The FAQ at devrs details this.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#34512 - Kyoufu Kawa - Thu Jan 20, 2005 7:58 pm</h4>
    <div class="postbody"><span class="postbody">Actually, the third method works fine. It's just very much of a waste.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#35580 - Kyoufu Kawa - Mon Feb 07, 2005 3:40 pm</h4>
    <div class="postbody"><span class="postbody">I'm sorry to bump this but I would like to know how to make the second method work. I considered just copying the data in a for loop but would like to know the opinion(s) of anyone who knows better.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#35583 - Cearn - Mon Feb 07, 2005 4:32 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Kyoufu Kawa wrote:</b></span></td> </tr> <tr> <td class="quote">I'm sorry to bump this but I would like to know how to make the second method work. I considered just copying the data in a for loop but would like to know the opinion(s) of anyone who knows better.</td> </tr></table><span class="postbody">
<br/>
You can't. At least, not directly. Just like Mucca says: "if the array is at any stage reinterpreted as a pointer rather than an array, as in your method two, then sizeof will return the size of the pointer not the array". However, what you could do is build a table with the array sizes as well. Am I correct that DmaArrayCopy is defined like this? 
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#define DmaArrayCopy(  DmaNo, Srcp, Destp, Bit)             \
<br/>
        DmaCopy(       DmaNo, Srcp, Destp, sizeof(Srcp), Bit)
<br/>
</td> </tr></table><span class="postbody">
<br/>
If so, all you need to do after you've build your size table is use DmaCopy instead of DmaArrayCopy, with the right size instead of the sizeof(Srcp). Assuming properly initialized tables picTileSizes, picPalSizes and picMapSizes, it could be something like this:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">    DmaCopy(3, picTiles[picture], BG_VRAM+0x4000, picTileSizes[picture], 32); 
<br/>
    DmaCopy(3, picPals[picture], BG_PLTT, picPalSizes[picture], 32); 
<br/>
    DmaCopy(3, picMaps[picture], BG_VRAM+0x0800, picMapSizes[picture], 32);
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#35593 - Kyoufu Kawa - Mon Feb 07, 2005 8:11 pm</h4>
    <div class="postbody"><span class="postbody">No need to bother with size tables. The tilesets are all the same size, as are the palettes (which are 240 entries per pic btw)
<br/>
<br/>
I'll keep your suggestion(s) in mind, thank you very much.
<br/>
<br/>
<br/>
<br/>
<br/>
I'M DUTCH! HAHAHA!!1</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#35626 - Kyoufu Kawa - Tue Feb 08, 2005 3:26 pm</h4>
    <div class="postbody"><span class="postbody">And it is teh done. Thank you all for your help on this matter.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">u16* thisPal;
<br/>
u16* thisPic;
<br/>
<br/>
thisPal = picPals[picture]; //warning: assignment discards qualifiers from pointer target type
<br/>
thisPic = picTiles[picture]; //warning: assignment from incompatible pointer type
<br/>
<br/>
DmaCopy(3, thisPal, BG_PLTT, 480, 32);
<br/>
DmaCopy(3, thisPic, BG_VRAM+0x4000, 30720, 32);
<br/>
<br/>
//Where 480 == 240 * 2 == 15 strips of 16-bit colors and 30720 == the constant size of my pics.
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Unexpected: this shit's fast enough to do full motion video. I already have a kind of "relative frame indexing" array ready and working.
<br/>
<br/>
...how did Cearn know the definition of DmaArrayCopy, which indeed was DmaCopy(DmaNo,Srcp,Destp,sizeof(Srcp),Bit), including the exact whitespacing? Is it that much of a standard? Or does Cearn have... wouldn't surprise me.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#35628 - Cearn - Tue Feb 08, 2005 3:39 pm</h4>
    <div class="postbody"><span class="postbody">I saw it in darkfader's stuff a very long time ago. Thought it looked familiar so I checked and there it was. 
<br/>
<br/>
Glad to see it all works now :). Btw, if you're wondering why you get those warnings, that's because your arrays are `const u16*', while the pointer is just `u16*'. C doesn't like it when you throw away things like constness and such. Not that it matters in this case of course. An explicit cast should get rid of the warnings.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">thisPal = (u16*)picPals[picture]; 
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#35629 - Kyoufu Kawa - Tue Feb 08, 2005 3:54 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Cearn wrote:</b></span></td> </tr> <tr> <td class="quote">Glad to see it all works now :). Btw, if you're wondering why you get those warnings, that's because your arrays are `const u16*', while the pointer is just `u16*'. C doesn't like it when you throw away things like constness and such. Not that it matters in this case of course. An explicit cast should get rid of the warnings.</td> </tr></table><span class="postbody">Okay, thanks. I'll change that ASAP.
<br/>
<br/>
Y'know, my group intro screen spawns "implicit truncation" warnings, but now I can replace it with a short movie so why bother?</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
