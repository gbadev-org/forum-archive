<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>upperbounded sum - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>C/C++ > upperbounded sum</h2>
<div id="posts">
<div class="post">
    <h4>#51526 - rodolforg - Sun Aug 21, 2005 6:21 am</h4>
    <div class="postbody"><span class="postbody">Hi!
<br/>
Could anyone help me?
<br/>
I have a vector of 4 unsigned bytes and I must sum it with another. The point is the sum must be upperbounded to 0xFF. It means it must not wrap.
<br/>
Example:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">u8* a = {0x00,0xF0,0x00,0xFF};
<br/>
u8* b = {0x00,0x10,0x00,0x01};</td> </tr></table><span class="postbody">
<br/>
a"+"b (u8* sum) should be
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">sum={0x00,0xFF,0x00,0xFF}
<br/>
</td> </tr></table><span class="postbody">
<br/>
How can I do that? Should I use an auxiliar var of 16 bits and check if it's bigger than 0xFF? Or is switching to asm to check overflow flag better?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#51528 - DekuTree64 - Sun Aug 21, 2005 8:20 am</h4>
    <div class="postbody"><span class="postbody">GBA/DS's registers are 32-bit, so you'll just have to do it by hand:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">for(int i = 0; i &lt; 4; i++)
<br/>
{
<br/>
    int tempSum = a[i] + b[i];
<br/>
    if (tempSum &gt; 0xff)
<br/>
        tempSum = 0xff;
<br/>
    sum[i] = tempSum;
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
Boring, but simple enough that a compiler should be able to generate the same code a human would for it anyway. 
<br/>
<br/>
If it's going to be called lots and lots of times, unroll the loop and compile it as ARM. That way there won't be any branching at all.<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#51530 - rodolforg - Sun Aug 21, 2005 10:05 am</h4>
    <div class="postbody"><span class="postbody">Thanks for the second tip, it'll be called a lot of time!
<br/>
How can I force it to ARM? I must implement this function in a separated file to do it? Sorry this dumb question, I searched in the forum, but I'm not so good on it...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#51673 - Miked0801 - Mon Aug 22, 2005 10:46 pm</h4>
    <div class="postbody"><span class="postbody">IF this is DS, there are saturation functions to handle this.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#51679 - gladius - Mon Aug 22, 2005 11:04 pm</h4>
    <div class="postbody"><span class="postbody">To compile as arm, you simply need to pass a different flag into the compiler (-marm instead of -mthumb).  You can give that file a special extension, such as .arm.c and then make a special target for it.
<br/>
<br/>
Or you could do it with some simple assembly, by including this snippet in a .s file.  The C declaration for the function would be:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
void SumByteArray(u8 *a, u8 *b, u8 *sum);
<br/>
</td> </tr></table><span class="postbody">
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
.MACRO sumByte
<br/>
 ldrb r3, [r0], #1
<br/>
 ldrb r4, [r1], #1
<br/>
 add r3, r3, r4
<br/>
 cmp r3, #0xff
<br/>
 movgt r3, #0xff
<br/>
 strb r3, [r2], #1
<br/>
.ENDM
<br/>
<br/>
.GLOBAL SumByteArray
<br/>
SumByteArray:
<br/>
 stmfd sp!, {r4}
<br/>
 sumByte 
<br/>
 sumByte 
<br/>
 sumByte 
<br/>
 sumByte 
<br/>
 ldmfd sp!, {r4}
<br/>
 bx lr
<br/>
</td> </tr></table><span class="postbody">
<br/>
This is fully unrolled, you could make it loop and save some space if you needed to.  Also, you'll want to have the code run from IWRAM if it is speed critical (any ARM code you have should be run from IWRAM).</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#51696 - DekuTree64 - Tue Aug 23, 2005 1:44 am</h4>
    <div class="postbody"><span class="postbody">I'll take that as a challenge, gladius ;)
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">.GLOBAL SumByteArray 
<br/>
SumByteArray:
<br/>
stmfd sp!, {r4-r5}
<br/>
mov r5, #0xff
<br/>
orr r5, r5, #0xff0000
<br/>
ldr r3, [r0], #4
<br/>
ldr r4, [r1], #4
<br/>
<br/>
and r0, r5, r3
<br/>
and r1, r5, r4
<br/>
add r0, r0, r1
<br/>
tst r0, #0xff00
<br/>
orrne r0, r0, #0xff
<br/>
tst r0, #0xff000000
<br/>
orrne r0, r0, #0xff0000
<br/>
and r0, r0, r5
<br/>
<br/>
and r3, r5, r3, lsr #8
<br/>
and r4, r5, r4, lsr #8
<br/>
add r3, r3, r4
<br/>
tst r3, #0xff00
<br/>
orrne r3, r3, #0xff
<br/>
tst r3, #0xff000000
<br/>
orrne r3, r3, #0xff0000
<br/>
and r3, r3, r5
<br/>
<br/>
orr r0, r0, r3, lsl #8
<br/>
str r0, [r2]
<br/>
ldmfd sp!, {r4-r5}
<br/>
bx lr</td> </tr></table><span class="postbody"><br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#51716 - gladius - Tue Aug 23, 2005 4:04 am</h4>
    <div class="postbody"><span class="postbody">:)
<br/>
<br/>
25 instructions for yours versus 27 for mine, and you only have two 32 bit reads and one 32 bit store versus 8 8 bit reads and 4 8 bit writes for my version.
<br/>
<br/>
So, all in all, a nice improvement.  Just one thing to be careful of, the arrays have to be aligned now, and u8 arrays are not aligned by default.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#51732 - rodolforg - Tue Aug 23, 2005 5:31 am</h4>
    <div class="postbody"><span class="postbody">Amazing both of you!
<br/>
So, u8 arrays are not aligned? it explains another issues here ;)
<br/>
And if I use an u32 var to do it? So, there's no problem at all, right?
<br/>
Thank u both</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#51749 - FluBBa - Tue Aug 23, 2005 9:04 am</h4>
    <div class="postbody"><span class="postbody">He he he, I'll beat that Deku..  :P
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">.GLOBAL SumByteArray 
<br/>
SumByteArray:
<br/>
stmfd sp!, {r4-r5}
<br/>
mov r5, #0xff00
<br/>
orr r5, r5, #0xff000000
<br/>
ldr r3, [r0], #4
<br/>
ldr r4, [r1], #4
<br/>
<br/>
and r0, r5, r3,lsl#8
<br/>
and r1, r5, r4,lsl#8
<br/>
adds r0, r0, r1
<br/>
orrcs r0, r0, #0xff000000
<br/>
tst r0, #0xff0000
<br/>
orrne r0, r0, #0xff00
<br/>
and r0, r0, r5
<br/>
<br/>
and r3, r5, r3
<br/>
and r4, r5, r4
<br/>
adds r3, r3, r4
<br/>
orrcs r0, r0, #0xff000000
<br/>
tst r0, #0xff0000
<br/>
orrne r0, r0, #0xff00
<br/>
and r3, r3, r5
<br/>
<br/>
orr r0, r3, r0, lsr #8
<br/>
str r0, [r2]
<br/>
ldmfd sp!, {r4-r5}
<br/>
bx lr</td> </tr></table><span class="postbody"><br/>_________________<br/>I probably suck, my not is a programmer.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#51816 - Miked0801 - Tue Aug 23, 2005 7:17 pm</h4>
    <div class="postbody"><span class="postbody">Use r12 instead of r5 to save a reg push/pop.
<br/>
<br/>
Return the added bytes instead of storing in an array to eliminate the rest of the push pops.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
ldr r2, [r0], #4 
<br/>
ldr r3, [r1], #4 
<br/>
<br/>
mov r12, #0xff00 
<br/>
orr r12, r12, #0xff000000 
<br/>
<br/>
and r0, r12, r2,lsl#8 
<br/>
and r1, r12, r3,lsl#8 
<br/>
adds r0, r0, r1 
<br/>
orrcs r0, r0, #0xff000000 
<br/>
tst r0, #0xff0000 
<br/>
orrne r0, r0, #0xff00 
<br/>
and r0, r0, r12 
<br/>
<br/>
and r2, r12, r2 
<br/>
and r3, r12, r3 
<br/>
adds r2, r2, r3 
<br/>
orrcs r0, r0, #0xff000000 
<br/>
tst r0, #0xff0000 
<br/>
orrne r0, r0, #0xff00 
<br/>
and r2, r2, r12 
<br/>
<br/>
orr r0, r2, r0, lsr #8 
<br/>
<br/>
bx lr
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I may have munged it a bit, but you get the idea :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#52064 - strager - Fri Aug 26, 2005 1:50 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>DekuTree64 wrote:</b></span></td> </tr> <tr> <td class="quote">I'll take that as a challenge...</td> </tr></table><span class="postbody">
<br/>
<br/>
I'm bored, so why not?
<br/>
<br/>
( 12 instructions )
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">@
<br/>
@ void Summit(const u8 *sum1, const u8 *sum2, u8 *dest, u32 size);
<br/>
@ Adds to arrays with an overflow of FF
<br/>
@
<br/>
@ sum1, sum2 - Arrays to add
<br/>
@ dest       - Where to store the result
<br/>
@ size       - Number of elements to add
<br/>
@
<br/>
@ Random notes:
<br/>
@  * The main loop (without counter math) has a steady execution speed,
<br/>
@    regardless of overflow (I hope)
<br/>
@
<br/>
<br/>
.ARM
<br/>
.global Summit
<br/>
<br/>
Summit:
<br/>
<br/>
.start:
<br/>
stmfd sp!, {r4, r5}         @ Push registers
<br/>
<br/>
.loop:
<br/>
ldrb r4, [r0], #1           @ I wish this and the next ins. could be combined (maybe they can...)
<br/>
mov r4, r4, lsl #24         @ Shift it to the left-most byte
<br/>
<br/>
ldrb r5, [r1], #1           @ Now for sum2
<br/>
<br/>
adds r4, r4, r5, lsl #24    @ Add! (if this looks confusing, see below)
<br/>
movcs r4, #0xFF             @ If &gt; FF, set to FF
<br/>
movcc r4, r4, lsr #24       @
<br/>
<br/>
strb r4, [r2], #1           @ Store the result
<br/>
<br/>
subs r3, r3, #1             @ Decrement counter
<br/>
bne .loop                   @ Non-zero loops
<br/>
<br/>
.end:
<br/>
ldmfd sp!, {r4, r5}         @ Pop registers
<br/>
<br/>
bx lr                       @ Return
<br/>
<br/>
@ EOF
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Works on variable sizes and uses 'hardware 8-bit simulation' :)
<br/>
<br/>
Idea: If the two sum tables were interleaved, I could write up a piece of code that has a few less instructions (and probably faster code).</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#52066 - sajiimori - Fri Aug 26, 2005 2:26 am</h4>
    <div class="postbody"><span class="postbody">:)  The goal is not to decrease the number of instructions in the function, but to decrease the number of instructions <span style="font-style: italic">executed</span> (or more precisely, the number of CPU cycles spent).  What you've done is optimize for code size while sacrificing CPU, though that's not necessarily wrong in itself.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#52088 - strager - Fri Aug 26, 2005 12:35 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>sajiimori wrote:</b></span></td> </tr> <tr> <td class="quote">:)  The goal is not to decrease the number of instructions in the function, but to decrease the number of instructions <span style="font-style: italic">executed</span> (or more precisely, the number of CPU cycles spent)...</td> </tr></table><span class="postbody">
<br/>
<br/>
Oh, right...
<br/>
<br/>
(D'oh!)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#52099 - ScottLininger - Fri Aug 26, 2005 5:58 pm</h4>
    <div class="postbody"><span class="postbody">Funny little stream, guys. ;)
<br/>
<br/>
Back to the original question... don't bother optimizing performance until:
<br/>
<br/>
1. You are sure that your logic and structure is working in C.
<br/>
<br/>
2. You see a performance problem
<br/>
<br/>
<br/>
Much better to get your game working first, even if it's slow. I've heard of many failed projects because the programmer gets sidetracked on some unnecessary optimization challenge.
<br/>
<br/>
:)
<br/>
<br/>
Scott</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#52373 - FluBBa - Tue Aug 30, 2005 9:24 am</h4>
    <div class="postbody"><span class="postbody">Strager if you look at Gladius code it only uses 3 instructions for the calculation while yours uses 4 instruction, but if you aim for size you can probably beat it by using C compiled to Thumb code anyway.<br/>_________________<br/>I probably suck, my not is a programmer.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
