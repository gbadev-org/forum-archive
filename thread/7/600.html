<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Debouncing problem - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>C/C++ > Debouncing problem</h2>
<div id="posts">
<div class="post">
    <h4>#3067 - Vortex - Mon Feb 17, 2003 5:04 pm</h4>
    <div class="postbody"><span class="postbody">Hello,
<br/>
<br/>
I have problems with my keypad debouncing code. In 95% of the cases it works just fine. The problem appears when more than one button is pressed. In that case the code seems to repeat one of the pressed code until the same button is pressed again. I will be very gratefull if you can point my error or provide a better debouncing  example.
<br/>
<br/>
Thanks
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
u16 kbd      = 0x03FF;
<br/>
u16 debounce = 0x03FF;
<br/>
<br/>
debounce = kbd = 0x03FF;
<br/>
<br/>
<br/>
while(1)
<br/>
{
<br/>
     u16 keys = *KEYS;
<br/>
<br/>
     if( keys != kbd )
<br/>
   {
<br/>
   debounce &amp;= keys;
<br/>
   kbd = keys;
<br/>
   }
<br/>
     else
<br/>
   {
<br/>
   debounce |= ~kbd;
<br/>
   debounce &amp;= 0x03FF;
<br/>
                }
<br/>
<br/>
     if(!(debounce &amp; KEY_LEFT))         
<br/>
   {
<br/>
                //...
<br/>
<br/>
   }
<br/>
     else if(!(debounce &amp; KEY_RIGHT))         
<br/>
   {
<br/>
                //...
<br/>
   }
<br/>
}
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#3082 - ampz - Mon Feb 17, 2003 10:16 pm</h4>
    <div class="postbody"><span class="postbody">I have no idea what you are trying to accomplish with that piece of code.
<br/>
Whatever it is, it's not keypad debouncing.
<br/>
Looks just weird to me.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#3083 - kyp4 - Mon Feb 17, 2003 10:18 pm</h4>
    <div class="postbody"><span class="postbody">What exactly is keypad debouncing, just out of cuiriosity. I've never heard that term before.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#3084 - Daikath - Mon Feb 17, 2003 10:23 pm</h4>
    <div class="postbody"><span class="postbody">Heh, I rememver you from the mIRC chat :)
<br/>
<br/>
That is indeed not keypas deboucing but tile debouncing. If a player is about to walk to a tile like some piece of stone he cant walk accross it. But it failes if someone presses both up and left when he is touching the stone, now I see the stone I notice that it only handles the events wherein either 4 direction buttons are pressed, maybe if you count 8 it would solve the problem.<br/>_________________<br/>?There are no stupid questions but there are a LOT of inquisitive idiots.?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#3085 - Vortex - Mon Feb 17, 2003 10:33 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>ampz wrote:</b></span></td> </tr> <tr> <td class="quote">I have no idea what you are trying to accomplish with that piece of code.
<br/>
Whatever it is, it's not keypad debouncing.
<br/>
Looks just weird to me.</td> </tr></table><span class="postbody">
<br/>
<br/>
If you have a better idea why don't you share with us ?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#3086 - Daikath - Mon Feb 17, 2003 10:56 pm</h4>
    <div class="postbody"><span class="postbody">Heh, wasn''t from the mIRC chat lol :).<br/>_________________<br/>?There are no stupid questions but there are a LOT of inquisitive idiots.?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#3087 - Paul Shirley - Mon Feb 17, 2003 11:04 pm</h4>
    <div class="postbody"><span class="postbody">removed</span><span class="gensmall"><br/><br/>Last edited by Paul Shirley on Sun Mar 28, 2004 9:41 pm; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#3088 - Vortex - Mon Feb 17, 2003 11:15 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Paul Shirley wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
If you tell us what its meant to do maybe we will. Meanwhile get a better attitude.
<br/>
<br/>
That's certainly not debounce code (not that you need it on a GBA) and its totally broken if its trigger detection (should be pure bitwise ops not conditional).
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
<br/>
Sorry, no offence was intended. 
<br/>
<br/>
My goal was to implement the debouncing as described by Splam:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
Yep, you can debounce the buttons. GBA doesn't have its own. 
<br/>
<br/>
obviously if you know how debounce works ignore this post :) 
<br/>
<br/>
To do it you need to read the register every frame then have a routine that checks it against the previous frames entry. Only if the state has changed (the button has been pressed) do you then set a bit in the "debounce" variable. If the current and previous frames are the same the debounce for that button is cleared. 
<br/>
<br/>
Your main code then reads the debounce variable to see if anything has been pressed, if you want to know if something is being held down you obviously just check the current frames variable. 
<br/>
<br/>
Do this at the start of a frame then make sure to read the debounce and process presses every frame else you'll miss the presses as they only happen once per press and are cleared on the next frame (hence the debounce). 
<br/>
<br/>
-edit- 
<br/>
If you want a sort of in between method so holding a button down still registers but not as often just add a timer to your debounce routine (or use a main game loop timer) if the desired time has passed clear out the debounce variables (last frame one should do it) then the "button pressed" part of the debounce variable will be set again and again etc
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#3089 - Paul Shirley - Tue Feb 18, 2003 1:24 am</h4>
    <div class="postbody"><span class="postbody">removed</span><span class="gensmall"><br/><br/>Last edited by Paul Shirley on Sun Mar 28, 2004 9:41 pm; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#3093 - tepples - Tue Feb 18, 2003 4:26 am</h4>
    <div class="postbody"><span class="postbody">Here's code adapted from TOD that implements autorepeat:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#define JOY  (*(volatile u16 *)0x04000130)
<br/>
#define REPEAT_DELAY  11 /* in frames */
<br/>
#define JOYIDX_RIGHT  4
<br/>
<br/>
char repeatTime[10];
<br/>
<br/>
/* MakeRepeats() ***********************
<br/>
   Autorepeats digital pad motion.  After autoDelay calls, it repeats
<br/>
   a key HZ/autoRate times a second.
<br/>
   'j' must be active HIGH, not active low as on e.g. GBA hardware.
<br/>
*/
<br/>
void MakeRepeats(char *repeatTime, int j, int autoDelay, int autoRate)
<br/>
{
<br/>
  int i;
<br/>
<br/>
  for(i = 0; i &lt; 10; i++)
<br/>
  {
<br/>
    if(j &amp; 0x01)
<br/>
    {
<br/>
      repeatTime[i]++;
<br/>
      if(repeatTime[i] &gt;= autoDelay)
<br/>
        repeatTime[i] -= autoRate;
<br/>
    }
<br/>
    else
<br/>
    {
<br/>
      repeatTime[i] = 0;
<br/>
    }
<br/>
    j &gt;&gt;= 1;
<br/>
  }
<br/>
}
<br/>
<br/>
/* ... */
<br/>
<br/>
GameLoop()
<br/>
{
<br/>
  /* ~JOY converts active-low register contents to active-high */
<br/>
  MakeRepeats(repeatTime, ~JOY, REPEAT_DELAY + 1, 2);
<br/>
  /* ... */
<br/>
  if(repeatTime[JOYIDX_RIGHT] == 1 ||
<br/>
     repeatTime[JOYIDX_RIGHT] == REPEAT_DELAY)
<br/>
  {
<br/>
    /* handle right press */
<br/>
  }
<br/>
}</td> </tr></table><span class="postbody"><br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#3114 - Vortex - Tue Feb 18, 2003 4:24 pm</h4>
    <div class="postbody"><span class="postbody">Thank you, guys for the examples. I really appreciate your help. 
<br/>
<br/>
After some thinking and googling I came with the following code:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
	u16 keys, current, down;
<br/>
	u16 previous = 0;
<br/>
<br/>
                while( game_flag == GAME_CONTINUE )			// Main Loop
<br/>
	{
<br/>
		keys      = *KEYS;
<br/>
		keys      = keys &amp; 0x03FF;
<br/>
		current   = keys;
<br/>
		keys      = keys ^ 0x03FF;
<br/>
		keys      = keys ^ previous;
<br/>
		delta      = keys;
<br/>
		down      = delta &amp; previous;
<br/>
		previous = current ^ 0x03FF;
<br/>
<br/>
		if(down &amp; KEY_LEFT)         
<br/>
		{
<br/>
                                // Do something
<br/>
		}
<br/>
		else if(down &amp; KEY_RIGHT)         
<br/>
                                {
<br/>
                                // Do something 
<br/>
                                }
<br/>
                  }
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Probably this is not the best way but it seems to work.
<br/>
<br/>
Since we are discussing that topic let me ask you one more question:
<br/>
<br/>
Do you see any benefits using interrupt based keypad handling instead of polling ?
<br/>
<br/>
The basic idea is to implement something similar to the PC BIOS keyboard handling, i.e. an interrupt handler which writes keycodes into a circular buffer. The program later consumes these keycodes from the buffer.
<br/>
<br/>
Thanks again</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#3126 - ampz - Tue Feb 18, 2003 7:51 pm</h4>
    <div class="postbody"><span class="postbody">Polling once each frame works well for most applications.
<br/>
Of course, in some special cases perhaps a interrupt might be preferable. It all depends on what you are trying to do.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#3211 - Paul Shirley - Thu Feb 20, 2003 5:21 am</h4>
    <div class="postbody"><span class="postbody">removed</span><span class="gensmall"><br/><br/>Last edited by Paul Shirley on Sun Mar 28, 2004 9:41 pm; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#3241 - ampz - Thu Feb 20, 2003 11:07 pm</h4>
    <div class="postbody"><span class="postbody">For some special case text-input applications it might be practical to use the interrupt...
<br/>
<br/>
Actually, for most applications where you don't care about VBL.
<br/>
(That is, very specific and quite odd applications)
<br/>
<br/>
Consider some application where you have to really conserve battery power, and you only need to do processing when the user provides some keypad input.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#3244 - mbcook - Thu Feb 20, 2003 11:26 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>ampz wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
Consider some application where you have to really conserve battery power, and you only need to do processing when the user provides some keypad input.</td> </tr></table><span class="postbody">
<br/>
<br/>
Which is definatly not most of the things that you'd put on a gameboy. Some kind of other embedded system, yes; but gameboys usually run games, which usually are always doing things.<br/>_________________<br/>--Michael</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#3246 - Paul Shirley - Thu Feb 20, 2003 11:54 pm</h4>
    <div class="postbody"><span class="postbody">removed</span><span class="gensmall"><br/><br/>Last edited by Paul Shirley on Sun Mar 28, 2004 9:41 pm; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#3261 - ampz - Fri Feb 21, 2003 10:26 am</h4>
    <div class="postbody"><span class="postbody">If you want to conserve power, you can put the GBA into sleep-mode (but keep the screen active), and only wakeup each time the user press a key.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#3277 - CoolMan - Fri Feb 21, 2003 5:26 pm</h4>
    <div class="postbody"><span class="postbody">Sounds slow. :)<br/>_________________<br/>Moron! You don't herd chickens with a shotgun!
<br/>
<br/>
--CoolMan</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
