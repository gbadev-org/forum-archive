<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>help on detecting button releases - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>C/C++ > help on detecting button releases</h2>
<div id="posts">
<div class="post">
    <h4>#8683 - immortalninjak - Thu Jul 17, 2003 11:41 pm</h4>
    <div class="postbody"><span class="postbody">Hi,
<br/>
just started out GBA programming and have been playing around with a program that counts how many times you push the buttons and displays it. 
<br/>
It works by incrementing a variable count by one for every button that is pressed during the getinput() method call.
<br/>
However this means that count increases if you just hold on to the buttons. 
<br/>
My question is: is there a simple way disable a buton until it has been released and pressed again?
<br/>
At the moment my solution has been to have an extra variable for each button and an extra method checkre() which is called after getinput()
<br/>
for example for the up button:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
getinput(){
<br/>
       if( up==0){
<br/>
              if(!(*KEYS &amp; KEY_UP)){
<br/>
                           count++;
<br/>
                           up = 1;
<br/>
              }
<br/>
       }
<br/>
}
<br/>
<br/>
checkre(){
<br/>
       if(*KEYS &amp; KEY_UP){
<br/>
                        up = 0;
<br/>
       }
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
any help or opinions would be great thanks</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#8689 - XeroxBoy - Fri Jul 18, 2003 3:45 am</h4>
    <div class="postbody"><span class="postbody">You could just add an else to the if in getinput().</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#8690 - night_ - Fri Jul 18, 2003 3:46 am</h4>
    <div class="postbody"><span class="postbody">I had a quick look and I think the following (untested) code does the job.  I didn't investigate deeper, maybe there are "better" solutions:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">get_input()
<br/>
{ 
<br/>
              if(!(*KEYS &amp; KEY_UP))
<br/>
              { 
<br/>
                           if(!up)
<br/>
                           {
<br/>
                             ++count; 
<br/>
                              up = 1;
<br/>
                           } 
<br/>
              } 
<br/>
              else
<br/>
              {
<br/>
                        up=0;
<br/>
              }
<br/>
}</td> </tr></table><span class="postbody"> [/code]</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#8691 - night_ - Fri Jul 18, 2003 3:47 am</h4>
    <div class="postbody"><span class="postbody">XeroxBoy was one minute faster ;-)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#8692 - XeroxBoy - Fri Jul 18, 2003 3:53 am</h4>
    <div class="postbody"><span class="postbody">p433r me :D</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#8694 - sgeos - Fri Jul 18, 2003 4:06 am</h4>
    <div class="postbody"><span class="postbody">It looks like you've figured it out, but here is the code I use:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#define AGB_KEY_MAX    2
<br/>
#define AGB_KEY_RESET  1
<br/>
<br/>
#define AGB_A       0
<br/>
#define AGB_B       1
<br/>
#define AGB_SELECT  2
<br/>
#define AGB_START   3
<br/>
#define AGB_RIGHT   4
<br/>
#define AGB_LEFT    5
<br/>
#define AGB_UP      6
<br/>
#define AGB_DOWN    7
<br/>
#define AGB_R       8
<br/>
#define AGB_L       9
<br/>
<br/>
unsigned long press[10];
<br/>
unsigned long release[10];
<br/>
<br/>
void key_refresh(void)
<br/>
{
<br/>
  int ctr;
<br/>
<br/>
  for (ctr = 0; ctr &lt; 10; ctr++)
<br/>
  {
<br/>
    if ((*(volatile unsigned short *)0x04000130 &gt;&gt; ctr) &amp; 0x1)
<br/>
    {
<br/>
      if (release[ctr])
<br/>
      {
<br/>
        press[ctr] = 0;
<br/>
        release[ctr] = 0;
<br/>
      }
<br/>
      if (press[ctr])
<br/>
        release[ctr] = 1;
<br/>
    }
<br/>
    else
<br/>
    {
<br/>
      press[ctr]++;
<br/>
      if (press[ctr] &gt; AGB_KEY_MAX)
<br/>
        press[ctr] = AGB_KEY_RESET;
<br/>
    }
<br/>
  }
<br/>
}
<br/>
<br/>
void key_zero(void)
<br/>
{
<br/>
  int ctr;
<br/>
<br/>
  for (ctr = 0; ctr &lt; 10; ctr++)
<br/>
  {
<br/>
    press[ctr] = 0;
<br/>
    release[ctr] = 0;
<br/>
  }
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
The button press code is initiatialized with key_zero().  key_refresh() needs to be called every frame.  You can check to see if a button is pressed or released with:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">if (press[AGB_A])
<br/>
  // Do the A thing
<br/>
if (release[AGB_START])
<br/>
  // Do the start thing</td> </tr></table><span class="postbody">
<br/>
<br/>
You can see how long the button has been held down by looking at the value in press[AGB_pick_a_button].  There is a macro that can be changed that affect how big the press values go, AGB_KEY_MAX.  There is also a macro that affects what happens to the value when it reaches max, AGB_KEY_RESET.
<br/>
<br/>
-Brendan</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#8716 - col - Fri Jul 18, 2003 3:44 pm</h4>
    <div class="postbody"><span class="postbody">this trick won't disable keys, or read key releases, but for counting keypresses and for other stuff you can do :
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
<br/>
//globals, or members of class Keypad
<br/>
u16 newkeys = 0;
<br/>
u16 keys = 0;
<br/>
<br/>
//call this per frame
<br/>
void updateKeys(){
<br/>
    newKeys = KEYS ^ keys &amp; KEYS;
<br/>
    keys = KEYS;
<br/>
}
<br/>
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
can't remember off-hand if KEYS is the inverse of the keypad reg contents:
<br/>
the main thing is that KEYS has a 1 for a key being pressed, and a 0 for not being pressed.
<br/>
<br/>
keys == which buttons are being pressed
<br/>
newKeys == which buttons have been pressed since the last frame
<br/>
<br/>
so to do a count of eg START key presses:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
if(newKeys &amp; KEY_START){
<br/>
    ++startKeyCount;
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I hope this helps
<br/>
<br/>
cheers
<br/>
<br/>
Col</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#8810 - col - Sun Jul 20, 2003 6:14 pm</h4>
    <div class="postbody"><span class="postbody">its easy to adapt the above code to give you key releases:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
<br/>
//globals, or members of class Keypad
<br/>
u16 newkeys = 0;
<br/>
u16 keys = 0;
<br/>
u16 keysReleased = 0;
<br/>
<br/>
//call this per frame
<br/>
void updateKeys(){
<br/>
    newKeys = KEYS ^ keys &amp; KEYS;
<br/>
    keysReleased = KEYS ^ keys &amp; keys;
<br/>
    keys = KEYS;
<br/>
}
<br/>
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
keys == which buttons are being pressed
<br/>
newKeys == which buttons were just pressed
<br/>
keysReleased == which buttons were just released
<br/>
<br/>
<br/>
cheers
<br/>
<br/>
Col</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#8869 - immortalninjak - Tue Jul 22, 2003 3:12 pm</h4>
    <div class="postbody"><span class="postbody">thanks all. 
<br/>
Combined this with a count down and text prog to get a mini game of sorts</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#10318 - whells - Tue Sep 02, 2003 12:13 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>col wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
<br/>
//globals, or members of class Keypad
<br/>
u16 newkeys = 0;
<br/>
u16 keys = 0;
<br/>
u16 keysReleased = 0;
<br/>
<br/>
//call this per frame
<br/>
void updateKeys(){
<br/>
    newKeys = KEYS ^ keys &amp; KEYS;
<br/>
    keysReleased = KEYS ^ keys &amp; keys;
<br/>
    keys = KEYS;
<br/>
}
<br/>
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
keys == which buttons are being pressed
<br/>
newKeys == which buttons were just pressed
<br/>
keysReleased == which buttons were just released
<br/>
<br/>
cheers
<br/>
<br/>
Col</span></td> </tr></table><span class="postbody">
<br/>
<br/>
I have an Question . . . 
<br/>
if i use the code
<br/>
whe i declare th KEYS in Keypad.h
<br/>
<br/>
u16* KEYS = (u16*)0x04000130;
<br/>
<br/>
(originally was →  int* KEYS = (int*)0x4000130)
<br/>
<br/>
After Compiling
<br/>
It still have error,as Follows
<br/>
<br/>
sprite.cpp: In function 'void updateKeys()':
<br/>
sprite.cpp:61 invalid operands of types 'u16' and 'u16*' to binary ' operator&amp;'
<br/>
sprite.cpp:62 cannot convert 'u16*' to 'u16' in assignment 
<br/>
<br/>
Boring... :?<br/>_________________<br/>~ GBA SP~</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#10325 - col - Tue Sep 02, 2003 2:51 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>whells wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
I have an Question . . . 
<br/>
if i use the code
<br/>
whe i declare th KEYS in Keypad.h
<br/>
<br/>
u16* KEYS = (u16*)0x04000130;
<br/>
<br/>
(originally was →  int* KEYS = (int*)0x4000130)
<br/>
<br/>
After Compiling
<br/>
It still have error,as Follows
<br/>
<br/>
sprite.cpp: In function 'void updateKeys()':
<br/>
sprite.cpp:61 invalid operands of types 'u16' and 'u16*' to binary ' operator&amp;'
<br/>
sprite.cpp:62 cannot convert 'u16*' to 'u16' in assignment 
<br/>
<br/>
Boring... :?</td> </tr></table><span class="postbody">
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
//defines for a header file
<br/>
#define KEYS         *(volatile u16*)0x04000130
<br/>
#define readKeys()   (~KEYS)
<br/>
<br/>
//globals, or members of class Keypad 
<br/>
u16 newkeys = 0; 
<br/>
u16 keys = 0; 
<br/>
u16 keysReleased = 0; 
<br/>
<br/>
//call this per frame 
<br/>
void updateKeys(){ 
<br/>
    hwKeys =  readKeys();
<br/>
    newKeys = hwKeys ^ keys &amp; hwKeys; 
<br/>
    keysReleased = hwKeys ^ keys &amp; keys; 
<br/>
    keys = hwKeys; 
<br/>
} 
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
i hope this works for you :)
<br/>
<br/>
Col</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#10327 - tepples - Tue Sep 02, 2003 2:56 pm</h4>
    <div class="postbody"><span class="postbody">Try this
<br/>
<br/>
#define KEYS (*(volatile u16 *)0x04000130)
<br/>
<br/>
Then make sure to read KEYS only <span style="font-style: italic">once</span> per execution of the game loop; otherwise, button bounces will confuse your game logic.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
