<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Strange behaviour with function pointers - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>C/C++ > Strange behaviour with function pointers</h2>
<div id="posts">
<div class="post">
    <h4>#167286 - Kariddi - Sun Mar 08, 2009 1:35 am</h4>
    <div class="postbody"><span class="postbody">Hi.
<br/>
I'm experimenting with NDS programming and , for what i'm trying to do, I need to use some "function pointers".
<br/>
<br/>
What I'm trying to do is loading some code in the RAM , then launching that code by running the "main" of that code using a function pointer.
<br/>
<br/>
This is the code in main:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
   consoleDemoInit();
<br/>
   fatInitDefault();
<br/>
   tableInit();
<br/>
   iprintf("Caricamento programma\n");
<br/>
   load_program(prog_str);
<br/>
   main_f(0, NULL);
<br/>
   iprintf("Fine main\n");
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I have these pointers:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
address** __table = (address**) TABLE_ADDRESS;
<br/>
<br/>
address prog = NULL;
<br/>
main_function main_f = NULL;
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Where __table is a table that should contain addresses of functions that the program I'm loading into ram should be able to use.
<br/>
TABLE_ADDRESS is defined as 0x03000000 (should be Shared WRAM, right?).
<br/>
<br/>
The function that can be called from the loaded program is :
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
void funzione()
<br/>
{
<br/>
   iprintf("It works!!\n");
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
and tableInit() is a function that initializes the table by loading the address of "funzione()" into __table[0] :
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
void tableInit()
<br/>
{
<br/>
   __table[0] = (address*) &amp;funzione;
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
The code of the program I'm loading into the ram simply calls "funzione()" into its main and returns.
<br/>
<br/>
The strange behavior is this:
<br/>
<br/>
When I'm running this program into an emulator everything works like should. (I've tried No$GBA and desmume)
<br/>
The program is loaded into ram, the execution switch to "main_f" (that is the main of the loaded program) "funzione()" is called from the loaded program and shows "It Works!" and then exits.
<br/>
<br/>
When I run this program on REAL hardware (my DS) the result is that when "tableInit()" is called instead of setting __table[0] to the right value it calls "funzione()" (really strange!!)  and then when the execution passes to "main_f" the screen blanks out (probably due to the fact that tableInit() didn't do what it was meant to).
<br/>
<br/>
Do you have any idea why on a real DS this line :
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
__table[0] = (address*) &amp;funzione;
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
instead of setting __table[0] at the right value calls "funzione()"???
<br/>
<br/>
Thanks for your help
<br/>
<br/>
Kariddi</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167288 - Maxxie - Sun Mar 08, 2009 8:20 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Kariddi wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
TABLE_ADDRESS is defined as 0x03000000 (should be Shared WRAM, right?).
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Have you assigned the shared wram to the desired CPU?
<br/>
It's not accessible to both CPUs at the same time. The name might confuse here.
<br/>
<br/>
<a href="http://nocash.emubase.de/gbatek.htm#dsmemorycontrolwram" target="_blank">http://nocash.emubase.de/gbatek.htm#dsmemorycontrolwram</a>
<br/>
<br/>
Beware: the shared wram is used for the arm7 binary.<br/>_________________<br/><a class="postlink" href="http://nintendods.desperate-programmers.com/doku.php?id=wireless_io_map" target="_blank">Trying  to bring more detail into understanding the wireless hardware</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167292 - Dwedit - Sun Mar 08, 2009 8:57 am</h4>
    <div class="postbody"><span class="postbody">I think Main Memory is shared, only issue with using that is the cache, you must invalidate or flush the cache if you want to exchange data that way.  Probably best to use Libnds's FIFO to send messages to the ARM7.<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
