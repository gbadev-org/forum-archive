<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Sizes of enums and type consistency - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>C/C++ > Sizes of enums and type consistency</h2>
<div id="posts">
<div class="post">
    <h4>#132141 - simonjhall - Sat Jun 23, 2007 9:13 pm</h4>
    <div class="postbody"><span class="postbody">Is there any way to force the type and size of an enumation in C, via some compiler option?
<br/>
One thing I noticed in Quake was that the code (compiled with VS) expected four-byte enums (even if they've only got enough entries to warrant a single byte).
<br/>
Also with this MPEG stuff there seems to be a variation between building with ARM and THUMB!
<br/>
<br/>
Ok, so the code has an enum in it,</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">typedef enum {
<br/>
    STATE_BUFFER = 0,
<br/>
    STATE_SEQUENCE = 1,
<br/>
    STATE_SEQUENCE_REPEATED = 2,
<br/>
    STATE_GOP = 3,
<br/>
    STATE_PICTURE = 4,
<br/>
    STATE_SLICE_1ST = 5,
<br/>
    STATE_PICTURE_2ND = 6,
<br/>
    STATE_SLICE = 7,
<br/>
    STATE_END = 8,
<br/>
    STATE_INVALID = 9,
<br/>
    STATE_INVALID_END = 10
<br/>
} mpeg2_state_t;</td> </tr></table><span class="postbody">
<br/>
but at one point (so far) in the code it's taken -1 and casted it to mpeg2_state_t, and returned it as type mpeg2_state_t. Then the code tests to see if the value is negative and does something etc etc.
<br/>
On the PC with Visual Studio I get -1 'correctly' returned.
<br/>
On the DS with gcc -marm I get -1.
<br/>
On the DS with gcc -mthumb I get 255.
<br/>
To handle the thumb version I added a dummy entry into the enumeration with value -1 and then I get a correct -1 back out (rather than 255).
<br/>
<br/>
So same compiler, difference results. Is there any way to get consistent results? I know you shouldn't make assumptions about the size of enumerated types and also their values in undefined cases, but there's gotta be something that can be done so as not to catch out other people porting code!
<br/>
<br/>
Peace.<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#132164 - kusma - Sun Jun 24, 2007 12:35 am</h4>
    <div class="postbody"><span class="postbody">a common fix to that "problem" (I'd say the problem is really the code if it treats enums as something else than what it is, but yeah) is something like this:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
enum some_enum {
<br/>
   SOME_VALUE,
<br/>
   SOME_OTHER_VALUE,
<br/>
   FORCE_DWORD = 0xFFFFFFFF
<br/>
};
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#132185 - simonjhall - Sun Jun 24, 2007 12:12 pm</h4>
    <div class="postbody"><span class="postbody">Yeah, that's what I thought!
<br/>
Seems a bit nasty though and you might not realise that you'd have this problem until a few hours into a fun debug session!
<br/>
<br/>
I still can't understand why there'd be a difference between ARM and THUMB mode though - isn't the front end the same, it's just the code generation that's different?<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#132186 - tepples - Sun Jun 24, 2007 12:39 pm</h4>
    <div class="postbody"><span class="postbody">You can use <a class="postlink" href="http://www.google.com/search?q=compile+time+assertion%20c" target="_blank">compile-time assertions</a> to check whether sizeof(your enum type) is correct.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#132333 - PeterM - Mon Jun 25, 2007 11:24 pm</h4>
    <div class="postbody"><span class="postbody">Somewhat related, I seem to recall that VC++ allows you to forward declare enums (it assumes the size) and pass them around, but GCC doesn't (it needs to know the size).<br/>_________________<br/><a href="http://aaiiee.wordpress.com/" target="_blank">http://aaiiee.wordpress.com/</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#132345 - wintermute - Tue Jun 26, 2007 3:01 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>simonjhall wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
I still can't understand why there'd be a difference between ARM and THUMB mode though - isn't the front end the same, it's just the code generation that's different?</td> </tr></table><span class="postbody">
<br/>
<br/>
I'd have thought so and some test code I just wrote outputs (mpeg2_state_t)-1  as  255 in both arm and thumb mode. Admittedly I'm currently using what will be devkitARM r21 and perhaps you've encountered a bug that was fixed in gcc 4.1.2.<br/>_________________<br/><a class="postlink" href="http://www.devkitpro.org/" target="_blank">devkitPro - professional toolchains at amateur prices</a>
<br/>
<a class="postlink" href="http://wiki.devkitpro.org/index.php/IRC" target="_blank">devkitPro IRC support</a>
<br/>
<a class="postlink" href="http://davejmurphy.com/" target="_blank">Personal Blog</a></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
