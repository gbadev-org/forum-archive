<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Strange register storage class specifer behaviour - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>C/C++ > Strange register storage class specifer behaviour</h2>
<div id="posts">
<div class="post">
    <h4>#871 - I.C.E - Sat Jan 11, 2003 6:51 pm</h4>
    <div class="postbody"><span class="postbody">I was initially just interested in what assember code the compiler turns code like this:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
while(1)
<br/>
   test++;
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I have seen that because of storing test in memory it must be loaded to register and then 1 is added and then stored again into memory.
<br/>
<br/>
Then I remembered that there is the posibility to use the storage class register to advice the compiler to store the variable in question in a register. (by the way, i thought that the compiler usualy does this in such a construct, without explicity tell him to store it in register). I wrote this code instead of the above one:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
{
<br/>
   register u32 test;
<br/>
   while(1)
<br/>
      test++;
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I now used gdb to see what happend and to my astonishment a ASM dump of the loop looks like this:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
0x8000cfc &lt;initStage+776&gt;:   b   0x8000cfc &lt;initStage+776&gt;
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Can anyone explain me why the compiler just done an endless loop?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#876 - Costis - Sat Jan 11, 2003 7:41 pm</h4>
    <div class="postbody"><span class="postbody">Hi,
<br/>
<br/>
The compiler probably has just optimized out the incrementing add as it loops forever not doing anything else. This may be the case if you're using a high optimization level. I don't believe that it will do that if you compile it with -O0.
<br/>
<br/>
Costis</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#879 - I.C.E - Sat Jan 11, 2003 7:51 pm</h4>
    <div class="postbody"><span class="postbody">I was not using any specific otimazion switch. I have now explicit tell the compiler -O0 and the same happens. Maybe the compiler implicit optimize the loop because of using the register storage class?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#1168 - tom - Wed Jan 15, 2003 10:42 am</h4>
    <div class="postbody"><span class="postbody">try something like that:
<br/>
<br/>
[code]
<br/>
volatile int test = 0;
<br/>
<br/>
while(1) test++;
<br/>
[/code]
<br/>
<br/>
the volatile keyword will tell the compiler not to do any optimizations regarding the variable test, that is, its content will always be read from memory and written immediatley back to memory.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#1184 - Vortex - Wed Jan 15, 2003 4:37 pm</h4>
    <div class="postbody"><span class="postbody">There is one more thing - the register keyword is just a hint for the compiler - it can be ignored if for example there are no avaiable registers to be allocated. In that case the declaration will be just a regular auto variable.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#1192 - Touchstone - Wed Jan 15, 2003 5:29 pm</h4>
    <div class="postbody"><span class="postbody">Since you've done an infinte loop it's possible that the compiler just discards the rest of the code in the funktion so therefore it's useless.
<br/>
<br/>
Exactly what are you interested in knowing? Maybe there are other ways to find out.<br/>_________________<br/>You can't beat our meat</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
