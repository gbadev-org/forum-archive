<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Trying to understand what happens during the build process - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>C/C++ > Trying to understand what happens during the build process</h2>
<div id="posts">
<div class="post">
    <h4>#168488 - Tyler24 - Thu Apr 30, 2009 5:35 pm</h4>
    <div class="postbody"><span class="postbody">So, I'm embarking on a project this summer and I really want to understand the internals of the DS, and how to create C code for it, knowing those internals. Right now, I have a basic arm9.c and arm7.c. Both put themselves into infinite while loops as soon as possible, but arm9.c also enables one of the LCDs (effectively turning all the pixels black) so I know that my binary is working properly.
<br/>
<br/>
However, during the compiling process, I specified -specs=ds_arm9.specs and -specs=ds_arm7.specs, respectively. Can somebody give me an idea of what these specification files say, and what they link to? I tried opening them and poking around but didn't really understand much. Are these specification files just mapping out IWRAM and such so that the programmer can specify what methods to copy to fast memory before the main method gets called?
<br/>
<br/>
The working NDS file I have built now consists of ~3kb or so of data, so there's got to be something in there...
<br/>
<br/>
Edit: I see that ds_arm*_crt0.s and ds_arm*_crt0.o is being included into my program. I'm assuming these are the only 4 files? crt0.o doesn't look like it has any data, but crt0.s looks like it tells the DS where it's basic memory locations are and initializes them... or something.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#168489 - Dwedit - Thu Apr 30, 2009 7:40 pm</h4>
    <div class="postbody"><span class="postbody">crt0.o is just a compiled version of crt0.s<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#168491 - sajiimori - Thu Apr 30, 2009 9:04 pm</h4>
    <div class="postbody"><span class="postbody">Well, for starters, the DS has a protection unit that needs to be configured at startup to determine your memory layout and read/write permissions -- that's typically one of the first things that needs to happen, in crt0.  I suspect that's what you're seeing there.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#168492 - Tyler24 - Fri May 01, 2009 12:39 am</h4>
    <div class="postbody"><span class="postbody">Alright, thanks for the responses.
<br/>
<br/>
I've pretty much copied the entire crt0.s file, just rewrote it and made a few small changes in terms of where addresses are and stuff. The crt0.s file and it's addresses differ from where Martin Korth suggested, based on where the retail ROMs place them...
<br/>
<br/>
Anyways, this didn't break anything so I'm assuming it's working. It's kind of hard to determine if the cache and whatnot is working probably now, but that should be evident in the future anyways.
<br/>
<br/>
Still haven't implemented stack addresses and whatnot needed for C, but after looking at how inefficient a lot of compiled C code is, I might just go full blown assembly. Maybe I'll change my mind after I realize how slow progress is :P.
<br/>
<br/>
arm9_main.s:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">@ --------------------------------------------------------------------------------
<br/>
@  main.s - Setups the protection unit, initializes the system.
<br/>
@ --------------------------------------------------------------------------------
<br/>
<br/>
<br/>
<br/>
@ --------------------------------------------------------------------------------
<br/>
@  Crucial assembler information
<br/>
@ --------------------------------------------------------------------------------
<br/>
.arch armv5te
<br/>
.cpu arm946e-s
<br/>
.align 4
<br/>
.arm
<br/>
<br/>
<br/>
<br/>
@ --------------------------------------------------------------------------------
<br/>
@  Global declarations
<br/>
@ --------------------------------------------------------------------------------
<br/>
.global arm9_main
<br/>
<br/>
<br/>
<br/>
@ --------------------------------------------------------------------------------
<br/>
@  Program entry point. Clear caches, define ITCM/DTCM, setup protection unit.
<br/>
@  This code is used courtesy of Sasq; the addresses have been slightly modified.
<br/>
@ --------------------------------------------------------------------------------
<br/>
arm9_main:
<br/>
<br/>
 @ ----------------------------------------
<br/>
 @  Clear instruction and data cache
<br/>
 @  Then wait for write buffer to empty
<br/>
 @ ----------------------------------------
<br/>
 mov r0, #0x00
<br/>
 mcr p15, 0, r0, c7, c5, 0
<br/>
 mcr p15, 0, r0, c7, c6, 0
<br/>
<br/>
 mcr p15, 0, r0, c7, c10, 4
<br/>
<br/>
 @ ----------------------------------------
<br/>
 @  Tell the co-processor where our
<br/>
 @  instruction and data memory caches
<br/>
 @  are located.
<br/>
 @
<br/>
 @  DTCM = 0x0B000000, size = 16kb
<br/>
 @  ITCM = 0x00000000, size = 32kb
<br/>
 @ ----------------------------------------
<br/>
 ldr r0, =0x0B00000A
<br/>
 mcr p15, 0, r0, c9, c1, 0
<br/>
<br/>
 mov r0, #0x00000020
<br/>
 mcr p15, 0, r0, c9, c1, 1
<br/>
<br/>
<br/>
@ --------------------------------------------------------------------------------
<br/>
@  Setup the protection unit similar to how it is for commercial cartridges.
<br/>
@  There are some slight modifications based on what genuine Nintendo cartridges
<br/>
@  use. This table was pulled directly from Martin Korth's documentation.
<br/>
@
<br/>
@  I have not bothered to check/verify R/W-ability for most sections...
<br/>
@ --------------------------------------------------------------------------------
<br/>
@
<br/>
@  Region     Name            Address   Size   Cache WBuf
<br/>
@  -          Background      00000000h 4GB    -     -
<br/>
@  0          I/O &amp; VRAM      04000000h 64MB   -     -
<br/>
@  1         Main Memory     02000000h 4MB    On    On
<br/>
@  2         ARM7-Dedic.   027C0000h 256KB  -     -
<br/>
@  3          GBA Slot        08000000h 128MB  -     -
<br/>
@  4         DTCM            027C0000h 16KB   -     -
<br/>
@  5         ITCM            01000000h 32KB   -     -
<br/>
@  6          BIOS            FFFF0000h 32KB   On    -
<br/>
@  7          Shared Mem      027FF000h 4KB    -     -
<br/>
@ --------------------------------------------------------------------------------
<br/>
<br/>
#define PAGE_4K         (0b01011 &lt;&lt; 1)
<br/>
#define PAGE_8K         (0b01100 &lt;&lt; 1)
<br/>
#define PAGE_16K      (0b01101 &lt;&lt; 1)
<br/>
#define PAGE_32K      (0b01110 &lt;&lt; 1)
<br/>
#define PAGE_64K      (0b00111 &lt;&lt; 1)
<br/>
#define PAGE_128K      (0b10000 &lt;&lt; 1)
<br/>
#define PAGE_256K      (0b10001 &lt;&lt; 1)
<br/>
#define PAGE_512K      (0b10010 &lt;&lt; 1)
<br/>
#define PAGE_1M         (0b10011 &lt;&lt; 1)
<br/>
#define PAGE_2M         (0b10100 &lt;&lt; 1)
<br/>
#define PAGE_4M         (0b10101 &lt;&lt; 1)
<br/>
#define PAGE_8M         (0b10110 &lt;&lt; 1)
<br/>
#define PAGE_16M      (0b10111 &lt;&lt; 1)
<br/>
#define PAGE_32M      (0b11000 &lt;&lt; 1)
<br/>
#define PAGE_64M      (0b11001 &lt;&lt; 1)
<br/>
#define PAGE_128M      (0b11010 &lt;&lt; 1)
<br/>
#define PAGE_256M      (0b11011 &lt;&lt; 1)
<br/>
#define PAGE_512M      (0b11100 &lt;&lt; 1)
<br/>
#define PAGE_1G         (0b11101 &lt;&lt; 1)
<br/>
#define PAGE_2G         (0b11110 &lt;&lt; 1)
<br/>
#define PAGE_4G         (0b11111 &lt;&lt; 1)
<br/>
<br/>
 @ ----------------------------------------
<br/>
 @  Region 0: I/O Registers
<br/>
 @ ----------------------------------------
<br/>
 ldr r0, =(0b11001 &lt;&lt; 1 | 0x04000000 | 1)
<br/>
 mcr p15, 0, r0, c6, c0, 0
<br/>
<br/>
 @ ----------------------------------------
<br/>
 @  Region 1: Main Memory
<br/>
 @ ----------------------------------------
<br/>
 ldr r0, =(0b10101 &lt;&lt; 1 | 0x02000000 | 1)
<br/>
 mcr p15, 0, r0, c6, c1, 0
<br/>
<br/>
 @ ----------------------------------------
<br/>
 @  Region 2: ARM7 Dedicated
<br/>
 @ ----------------------------------------
<br/>
 ldr r0, =(0b10001 &lt;&lt; 1 | 0x027C0000 | 1)
<br/>
 mcr p15, 0, r0, c6, c2, 0
<br/>
<br/>
 @ ----------------------------------------
<br/>
 @  Region 3: GBA Slot
<br/>
 @ ----------------------------------------
<br/>
 ldr r0, =(0b11010 &lt;&lt; 1 | 0x08000000 | 1)
<br/>
 mcr p15, 0, r0, c6, c3, 0
<br/>
<br/>
 @ ----------------------------------------
<br/>
 @  Region 4: DTCM
<br/>
 @
<br/>
 @  Base must be size-aligned, so
<br/>
 @  have to do lsr #15, lsl #15
<br/>
 @ ----------------------------------------
<br/>
 ldr r0, =(0b01101 &lt;&lt; 1 | 0x027C0000 | 1)
<br/>
 mcr p15, 0, r0, c6, c4, 0
<br/>
<br/>
 @ ----------------------------------------
<br/>
 @  Region 5: ITCM
<br/>
 @
<br/>
 @  Base must be size-aligned, so
<br/>
 @  have to do lsr #15, lsl #15
<br/>
 @ ----------------------------------------
<br/>
 ldr r0, =(0b01110 &lt;&lt; 1 | 0x01000000 | 1)
<br/>
 mcr p15, 0, r0, c6, c5, 0
<br/>
<br/>
 @ ----------------------------------------
<br/>
 @  Region 6: BIOS
<br/>
 @ ----------------------------------------
<br/>
 ldr r0, =(0b01110 &lt;&lt; 1 | 0xFFFF0000 | 1)
<br/>
 mcr p15, 0, r0, c6, c6, 0
<br/>
<br/>
 @ ----------------------------------------
<br/>
 @  Region 7: Shared Mem
<br/>
 @ ----------------------------------------
<br/>
 ldr r0, =(0b01011 &lt;&lt; 1 | 0x027FF000 | 1)
<br/>
 mcr p15, 0, r0, c6, c7, 0
<br/>
<br/>
 @ ----------------------------------------
<br/>
 @  Determine which regions have wr-buffer
<br/>
 @  Determine which regions are cached
<br/>
 @ ----------------------------------------
<br/>
 ldr r0, =0b00000010
<br/>
 mcr p15, 0, r0, c3, c0, 0
<br/>
<br/>
 ldr r0, =0b01000010
<br/>
 mcr p15, 0, r0, c2, c0, 0
<br/>
 mcr p15, 0, r0, c2, c0, 1
<br/>
<br/>
 @ ----------------------------------------
<br/>
 @  Set extended access permission regions
<br/>
 @  for instruction and data accesses
<br/>
 @
<br/>
 @  Bits   Privileged  User
<br/>
 @  0000   --       --
<br/>
 @  0001   R/W       --
<br/>
 @  0010   R/W       R
<br/>
 @  0011   R/W       R/W
<br/>
 @  0100   UNP       UNP
<br/>
 @  0101   R       --
<br/>
 @  0110   R       R
<br/>
 @  0111   UNP       UNP
<br/>
 @  1XXX   UNP       UNP
<br/>
 @ ----------------------------------------
<br/>
 ldr r0, =0x36636633
<br/>
 mcr p15, 0, r0, c5, c0, 3
<br/>
<br/>
 ldr r0, =0x36333633
<br/>
 mcr p15, 0, r0, c5, c0, 2
<br/>
<br/>
 @ ----------------------------------------
<br/>
 @  Enable ITCM/DTCM and their caches
<br/>
 @ ----------------------------------------
<br/>
<br/>
#define ITCM_ENABLE   (1&lt;&lt;18)
<br/>
#define DTCM_ENABLE   (1&lt;&lt;16)
<br/>
#define ICACHE_ENABLE   (1&lt;&lt;12)
<br/>
#define DCACHE_ENABLE   (1&lt;&lt;2)
<br/>
#define PROTECT_ENABLE   (1&lt;&lt;0)
<br/>
<br/>
 mrc p15, 0, r0, c1, c0, 0
<br/>
 ldr r1, = 1&lt;&lt;18 | 1&lt;&lt;16 | 1&lt;&lt;12 | 1&lt;&lt;2 | 1&lt;&lt;0
<br/>
 orr r0, r0, r1
<br/>
 mcr p15, 0, r0, c1, c0, 0
<br/>
<br/>
lcd_enable:
<br/>
 mov r0, #0x04000000
<br/>
 mov r2, #0x00020000
<br/>
 mov r3, #0x80
<br/>
<br/>
 str r2, [r0]
<br/>
 str r3, [r0, #0x240]
<br/>
<br/>
freeze:
<br/>
 bl freeze
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#168497 - sajiimori - Fri May 01, 2009 7:39 am</h4>
    <div class="postbody"><span class="postbody">That's cool -- assembly is fun, especially on ARM.  You'll probably get a lot of people telling you to "optimize last", or to use C++ and only hand-code a few small sections, but such advice may very well be missing the point -- it really depends on your goals.
<br/>
<br/>
Much of our codebase compiles down to some pretty crappy assembly... but efficiency is just one of many concerns to balance.  Each hour I spend optimizing the engine is an hour I could've spent doing something else: improving the camera behavior, adding some interesting new AI interactions, making it quicker for artists to preview their work on target, making the object scaling widget easier to use in the level editor, having the build process autogenerate a file that coders have been maintaining by hand, generalizing a game-specific module so it can be used on other projects...
<br/>
<br/>
And those are just the self-motivated tasks; I'm ignoring the need to actually implement features on a schedule, make modifications based on constant design changes, and support other projects who are using your code.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#168505 - Tyler24 - Fri May 01, 2009 11:03 pm</h4>
    <div class="postbody"><span class="postbody">Oh, didn't mean to discredit you by any means... I had to check what darn near every line was doing up in the code about because it was all interacting with the coprocessor... and I have no idea what c0...c15 do off the top of my head. I just hate inefficient things. I can't stand languages like Java, C#, etc. that just suck up memory bandwidth like nobody's business. I decided to switch over to assembly when I saw how much stack pushing and popping was going on when different methods were called... considering each memory cycle requires 8 wait-states (don't quote me on that, I remember seeing it somwhere) or so, multiply that by 8 things to pop and push (*2) and you get 128 cycles wasted for every method call.
<br/>
<br/>
I'm really a beginner as far as the NDS hardware goes, but I'm halfway decent at assembly so I thought I'd give it a go. The GBATek and bottledlight sites have been a lifesaver.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#168507 - Dwedit - Sat May 02, 2009 12:36 am</h4>
    <div class="postbody"><span class="postbody">The stack is usually placed in fast DTCM memory, so there is no 8 cycle penalty for writes and reads.
<br/>
Also, the cache works wonders to hide the memory access penalties, since the cache is hit far more often than it is missed.<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#168511 - sajiimori - Sat May 02, 2009 1:53 am</h4>
    <div class="postbody"><span class="postbody">I was just thinking aloud -- I didn't think you were trying to discredit me.  ^^</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
