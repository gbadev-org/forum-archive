<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Using char* messes up my palette. - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>C/C++ > Using char* messes up my palette.</h2>
<div id="posts">
<div class="post">
    <h4>#5274 - Benny Blanco - Thu Apr 24, 2003 12:24 pm</h4>
    <div class="postbody"><span class="postbody">This I really don't understand.  Everytime I try to set something like <span style="font-weight: bold">char* message</span>, once I compiled, both background and sprite palettes go mental and just end up as hues of red.
<br/>
<br/>
I can't get my head around why this is happening and it's driving me insane.  My deadline is in a week and this really isn't helping.
<br/>
<br/>
Anyone else come across this problem? Any help would be appreciated.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#5277 - funkeejeffou - Thu Apr 24, 2003 1:56 pm</h4>
    <div class="postbody"><span class="postbody">Do you mean that you have your code running well as long as you do not declare your variables as char?
<br/>
Are the char variables INDEPENDANT from those you use for the palette and sprites?
<br/>
Please specify more where you use them and for what?
<br/>
Also, i don't know what your code is supposed to do, but remember that there is the :
<br/>
- char type has values running from -127 to +127
<br/>
- unsigned char from 0 to +255
<br/>
Maybe it could explain your mess if you use them for screen coordinates, because signed char cannot be used to represent the gba screen (240*160).</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#5280 - niltsair - Thu Apr 24, 2003 2:23 pm</h4>
    <div class="postbody"><span class="postbody">Also, when writing to video memory, you need to access it in 16bits. 
<br/>
<br/>
So when you transfer your data, just use your u8 as a u16 pointer, and write half of the number of elements you needed with a 8bits pointer(seeing how you write 2 elements at a time)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#5285 - peebrain - Thu Apr 24, 2003 4:14 pm</h4>
    <div class="postbody"><span class="postbody">Why are you using char's for palette entries anyways?  Each palette entry is 16-bits, XBBBBBGGGGGRRRRR.
<br/>
<br/>
~Sean<br/>_________________<br/><a href="http://www.pbwhere.com" target="_blank">http://www.pbwhere.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#5288 - lordmetroid - Thu Apr 24, 2003 4:54 pm</h4>
    <div class="postbody"><span class="postbody">that's probably why he gets all the hue of red as he describes... Do as I do when codeing for GBA think of everything as memory and bits...
<br/>
So don't use char or whatever but instead u8,u16,etc...
<br/>
<br/>
that makes everything more understandable what you really are doing. and the reader doesn't need to know how many bits are this is it signed, and so on.<br/>_________________<br/>*Spam*
<br/>
Open Solutions for an open mind, <a href="http://www.areta.org" target="_blank">www.areta.org</a>
<br/>
<br/>
Areta is an organization of coders codeing mostly open source project, but there is alot of sections like GBA dev, Language learning communities, RPG communities, etc...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#5289 - Quirky - Thu Apr 24, 2003 4:55 pm</h4>
    <div class="postbody"><span class="postbody">Do you mean that when you assign a "string" stuff goes wrong? I would guess you have borked your message handling in that case and you need to add a 0 terminating value to your char arrays. But as you have been a bit vague, it could be anything.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#5294 - tepples - Thu Apr 24, 2003 6:33 pm</h4>
    <div class="postbody"><span class="postbody">Another possibility is that your palette is in a 'const char *' variable as opposed to a 'const u16 *' or 'const u32 *', and adding the strings has unaligned the palette data.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#5348 - Benny Blanco - Fri Apr 25, 2003 7:46 pm</h4>
    <div class="postbody"><span class="postbody">Hi sorry for being vague.
<br/>
<br/>
Basically, I'm not trying to do anything with the palette using char.
<br/>
My palettes are running fine, as you've all said, I'm using u16 variables to handle them.
<br/>
<br/>
I need to start putting text into my game so imported StaringMonkey's Text.h file.  I put the #include "Text.h" in, compiled and then the colours were all messed up.
<br/>
<br/>
After fiddling around, I tracked the problem to fact that the functions declare char* variables.
<br/>
<br/>
I removed the #include "Text.h" and the palettes went back to normal.
<br/>
So I did another test and just had one line of code:
<br/>
<br/>
char  *message="hello";
<br/>
<br/>
compiled and the palettes went bonkers again.
<br/>
<br/>
My palette code is as follows:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">u16 *palette = (u16 *)0x05000200;
<br/>
u16 *source = (u16 *)spritepal;
<br/>
for (u16 i = 0; i &lt; 256; i++)
<br/>
{
<br/>
    palette[i] = source[i];
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
And cannot for the life of me understand why assigning a char would affect the palette.
<br/>
<br/>
Again, any help would be appreciated.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#5363 - tepples - Sat Apr 26, 2003 3:06 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Benny Blanco wrote:</b></span></td> </tr> <tr> <td class="quote">My palette code is as follows:
<br/>
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">u16 *palette = (u16 *)0x05000200;
<br/>
u16 *source = (u16 *)spritepal;
<br/>
for (u16 i = 0; i &lt; 256; i++)
<br/>
{
<br/>
    palette[i] = source[i];
<br/>
}</td> </tr></table><span class="postbody"></span></td> </tr></table><span class="postbody">
<br/>
How is spritepal declared?<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#5450 - Benny Blanco - Mon Apr 28, 2003 12:12 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tepples wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Benny Blanco wrote:</b></span></td> </tr> <tr> <td class="quote">My palette code is as follows:
<br/>
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">u16 *palette = (u16 *)0x05000200;
<br/>
u16 *source = (u16 *)spritepal;
<br/>
for (u16 i = 0; i &lt; 256; i++)
<br/>
{
<br/>
    palette[i] = source[i];
<br/>
}</td> </tr></table><span class="postbody"></span></td> </tr></table><span class="postbody">
<br/>
How is spritepal declared?</span></td> </tr></table><span class="postbody">
<br/>
<br/>
Hmmm... Interesting, const unsigned char, think that might be the problem?
<br/>
<br/>
I used peebrain's method to create the palette c header file by loading the .pal file (created with gbapal) into bin2c.exe as he does in his gbAmp examples.
<br/>
<br/>
What's the best way to sort this out as I've also noticed that palette values are 8bit values: e.g.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">const unsigned char spritepal[] = {
<br/>
  0x1F,0x7C,0x00,0x54...</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#5451 - niltsair - Mon Apr 28, 2003 1:42 pm</h4>
    <div class="postbody"><span class="postbody">A palette entry should represent a 15bits color. If there's 512 entries of 8 bits in the palette you're fine, the colors are just splitted up in two and by casting it to (u16*) like you did, it should be fine. Else, all of your palette colors a screwed up.
<br/>
<br/>
Unless your palette entry really just contains 128 colors and your sprite's tiles never used a color over 128. Then there's enough data in the palette for that, just run your loop 128 instead of 256.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#5455 - tepples - Mon Apr 28, 2003 5:02 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Benny Blanco wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">const unsigned char spritepal[] = {
<br/>
  0x1F,0x7C,0x00,0x54...</td> </tr></table><span class="postbody"></span></td> </tr></table><span class="postbody">
<br/>
It looks like spritepal[] has become unaligned.  Ideally, it should look like this:</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">const u16 spritepal[] = {
<br/>
  0x7C1F, 0x5400...</td> </tr></table><span class="postbody">
<br/>
If you're going to be DMAing something out of memory, have your binary-to-C-array converter output little-endian 16-bit or little-endian 32-bit data.  Some binary-to-C-array converters can output this format, but I don't know which to recommend.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#6648 - outRider - Sat May 31, 2003 8:51 pm</h4>
    <div class="postbody"><span class="postbody">Hopefully this isn't too late to help you out, but I once had the same problem.
<br/>
<br/>
Declaring a char szString[]; locally on the stack in a function caused palette and image corruption for me too. Declare strings as and global (and const, if they don't change) and the problem should go away.<br/>_________________<br/>outRider</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
