<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>struct with variables being a ceratin bit size. - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>C/C++ > struct with variables being a ceratin bit size.</h2>
<div id="posts">
<div class="post">
    <h4>#19206 - mr_schmoe - Wed Apr 14, 2004 1:56 am</h4>
    <div class="postbody"><span class="postbody">Ok, here's the idea. In pascal, you can define a record (or struct in C) where each member is a certain number of bits. And, I want to do something like that in C. For example you have the struct for the OAM defined as:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">typedef struct tagSprite
<br/>
{
<br/>
        u16 attribute0;
<br/>
        u16 attribute1;
<br/>
        u16 attribute2;
<br/>
        u16 attribute3;
<br/>
}Sprite;</td> </tr></table><span class="postbody">
<br/>
<br/>
And I want the struct to look like this:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">typedef struct tagSprite
<br/>
{
<br/>
        7bits yCoordinate;
<br/>
        1bits rotateflag;
<br/>
        1bits doublesize;
<br/>
        2bits alphablending;
<br/>
        ...
<br/>
        3bits palettenum;
<br/>
}Sprite;</td> </tr></table><span class="postbody">
<br/>
<br/>
And have it still only be 4 bytes long. Is there a way to do that?
<br/>
<br/>
Of course, on the other hand, you could just take the attribute in question and isolate the bits with the info you want, shift it over and there's you data, but that's complicated and I'm not sure exactly on how to do that. If someone out there has the idea, that would work also.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#19208 - sajiimori - Wed Apr 14, 2004 2:18 am</h4>
    <div class="postbody"><span class="postbody">C does support bitfields, but they're not very fast on GCC and they aren't guaranteed to have any particular arrangement (so they might not match hardware, if that's what you're thinking).
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
typedef struct tagSprite 
<br/>
{ 
<br/>
        u16 yCoordinate : 7; 
<br/>
        u16 rotateflag : 1; 
<br/>
        u16 doublesize : 1; 
<br/>
        u16 alphablending : 2; 
<br/>
        ... 
<br/>
        u16 palettenum : 3; 
<br/>
}Sprite;
<br/>
</td> </tr></table><span class="postbody">
<br/>
I'd suggest using plain shifts -- it's not that complicated.  Just a macro for each bitfield.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#19209 - sgeos - Wed Apr 14, 2004 2:30 am</h4>
    <div class="postbody"><span class="postbody">Use bit fields.  Here is some rgb example code that uses bit fields:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">/*** Compile Options
<br/>
 *
<br/>
gcc -Wall -o pack pack.c -fpack-struct
<br/>
 */
<br/>
<br/>
#include &lt;stdio.h&gt;
<br/>
<br/>
#define RGB_T_BIT_DEPTH         5
<br/>
<br/>
typedef unsigned int    rgb_color_t;
<br/>
<br/>
typedef struct rgb_t {
<br/>
        rgb_color_t     red:    RGB_T_BIT_DEPTH;
<br/>
        rgb_color_t     green:  RGB_T_BIT_DEPTH;
<br/>
        rgb_color_t     blue:   RGB_T_BIT_DEPTH;
<br/>
} rgb_t;
<br/>
<br/>
int main(void)
<br/>
{
<br/>
        printf("sizeof( rgb_t ) = %d\n", sizeof( rgb_t ));
<br/>
        return 0;
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
By default, structs are not packed.  That is, data types with at least the required number of bits are used.  The reason is that the code generated for packed structs is slow.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">$ gcc -Wall -o pack pack.c
<br/>
$ ./pack
<br/>
sizeof( rgb_t ) = 4
<br/>
$ gcc -Wall -o pack pack.c -fpack-struct
<br/>
$ ./pack
<br/>
sizeof( rgb_t ) = 2
<br/>
$</td> </tr></table><span class="postbody">
<br/>
<br/>
Notice that you need to tell the compiler to pack the struct with the -fpack-struct command line option.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>sajiimori wrote:</b></span></td> </tr> <tr> <td class="quote">C does support bitfields, but they're not very fast on GCC and they aren't guaranteed to have any particular arrangement...</td> </tr></table><span class="postbody">
<br/>
It is true that they are not guaranteed to have any particular arrangement.  I would test every packed structure data type before using it, but in practice I have found that GCC does not muck with the arrangement.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>sajiimori wrote:</b></span></td> </tr> <tr> <td class="quote">I'd suggest using plain shifts --</td> </tr></table><span class="postbody">
<br/>
I agree.
<br/>
<br/>
-Brendan</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#20935 - TheMikaus - Thu May 20, 2004 6:07 am</h4>
    <div class="postbody"><span class="postbody">Actually they do go in a specific order.  At least with the dev kit I've got.  
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">typedef struct tagSprited
<br/>
{
<br/>
    //at0
<br/>
    unsigned y : 8;
<br/>
<br/>
    unsigned rotation : 1;
<br/>
    unsigned DoubleSize : 1;
<br/>
    unsigned translucent : 1;
<br/>
    unsigned windowed : 1;
<br/>
    unsigned mosaic : 1;
<br/>
    unsigned color_256 : 1;
<br/>
    unsigned tall : 1;
<br/>
    unsigned wide : 1;
<br/>
<br/>
    //at1
<br/>
    unsigned x : 9;
<br/>
    unsigned rotation_index : 3;
<br/>
    unsigned hflip : 1;
<br/>
    unsigned vflip : 1;
<br/>
    unsigned spriteSize:2;
<br/>
    
<br/>
    //at2
<br/>
    unsigned name : 10;
<br/>
    unsigned priority : 2;
<br/>
    unsigned pallette : 4;
<br/>
    
<br/>
    unsigned short at3;
<br/>
    
<br/>
} mSprite;
<br/>
</td> </tr></table><span class="postbody">
<br/>
That's what I use for mine.  Some of the fields might be a bit off (in length)  I don't use it that often, but I use it for the one game I'm doing now.  Works fine.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#20943 - f(DarkAngel) - Thu May 20, 2004 12:05 pm</h4>
    <div class="postbody"><span class="postbody">The memory addressing unit is bytes, and there's no actual instruction for working on bits, as far i know.
<br/>
<br/>
So what is the code generated for this? Bitmasking? (maybe through bic, and) If yes, this'll be a serious sacrifice of speed for size....<br/>_________________<br/>death scream...</span><span class="gensmall"><br/><br/>Last edited by f(DarkAngel) on Thu May 20, 2004 6:29 pm; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#20950 - torne - Thu May 20, 2004 2:57 pm</h4>
    <div class="postbody"><span class="postbody">It generates bit masking code which is pretty damn slow. Also, the fact that it  packs them in some specific order at the moment doesn't mean it will do so in the future; the standard does not guarantee anything, so gcc is free to do whatever it likes.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
