<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>How does the vtable work - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>C/C++ > How does the vtable work</h2>
<div id="posts">
<div class="post">
    <h4>#177139 - Azenris - Sat Dec 17, 2011 8:55 pm</h4>
    <div class="postbody"><span class="postbody">I'm not sure I'm even asking the right question, but here goes.
<br/>
<br/>
Basically I have a bunch of items, they are binaries added to the .nds file. I have different items deriving from a base class CItem.
<br/>
<br/>
CItemExpGain : CItem
<br/>
CItemPotion : CItem
<br/>
etcetc
<br/>
<br/>
This is the code that registers an item - basically puts it into a list.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void CItemManager::Register(const void *pItem)
<br/>
{
<br/>
   CItem *pItemPtr = pItem;
<br/>
   int itemID = pItemPtr-&gt;GetID();
<br/>
   int listSize = m_items.size();
<br/>
   
<br/>
   if (itemID &gt;= listSize)
<br/>
   {
<br/>
      m_items.resize(itemID + 1);
<br/>
      for (int i = listSize; i &lt; (itemID + 1); ++i)
<br/>
         m_items[i] = NULL;
<br/>
   }
<br/>
<br/>
   ASSERT(m_items[itemID] == NULL, "itemID already registered.");
<br/>
<br/>
   m_items[itemID] = pItemPtr;
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
I register at init with
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">Register(Potion_item);
<br/>
Register(BigPotion_item);
<br/>
Register(UltraPotion_item);</td> </tr></table><span class="postbody">
<br/>
<br/>
Not actual code, but for example I did
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
m_items[0]-&gt;Use();
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
It doesn't know whether thats an exp item or potion. I think from what I got at <a href="http://www.parashift.com/c++-faq-lite/virtual-functions.html" target="_blank">http://www.parashift.com/c++-faq-lite/virtual-functions.html</a> a vtable ptr is added to the class. But I'm creating my binaries outside the program.
<br/>
<br/>
Can I achieve what I want or should I scrap this whole process. OR am I confused completely at what I'm doing :D<br/>_________________<br/><a class="postlink" href="http://sacredpotion.blogspot.com/" target="_blank"><span style="color: red">My Homebrew Games</span></a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#177140 - Dwedit - Sat Dec 17, 2011 9:27 pm</h4>
    <div class="postbody"><span class="postbody">A vtable is a bunch of function pointers, so as long as your class is specified correctly in the header file, and the exact same header is used, things should work fine.  The code which creates the object will put in the correct function pointers before your constructor executes.
<br/>
<br/>
What do you mean when you say "I am creating my binaries outside the program"?<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#177141 - Azenris - Sun Dec 18, 2011 12:20 am</h4>
    <div class="postbody"><span class="postbody">A constructor isn't called. I wasn't creating any instances. The item themselves are constant anyway, they don't contain any data that would change.
<br/>
<br/>
If I created an instance for each item isn't that just using memory, reallocating data into RAM I already have.
<br/>
<br/>
What I meant was I had a folder of items:
<br/>
example of a potion: Potion.itm
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
# simple potion item
<br/>
<br/>
type CItemPotion
<br/>
id 75
<br/>
name_english "Potion"
<br/>
desc_english "This simple potion will heal you ~{c:%d}%d~{c:0} hp when used."
<br/>
gfx "gfx_ItemGfx_Potion"
<br/>
maxStack 10
<br/>
sellValue 15
<br/>
weight 0
<br/>
heals 20
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
When I run the make file I have
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
# ---------------------------------------------------------------
<br/>
# items
<br/>
# ---------------------------------------------------------------
<br/>
%.item : %.itm
<br/>
   @rt_itemConv $&lt; -o$@ -lenglish
<br/>
%.item.o : %.item
<br/>
   $(bin2o)
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I was hoping I could get the output so that I could just cast at that location CItem and all the virtual functions work as normal.
<br/>
<br/>
But from what I read my classes will be automatically modified since they are virtual and require a vtable ptr. But because I create them outside the program where the vtable for that object is nobody knows.
<br/>
<br/>
I'm probably trying to do something I shouldn't. Maybe I will find a different way. Perhaps just allocate them in RAM with new having the vtptr set up automatically, even though that feels like I'm wasting memory.
<br/>
<br/>
Tell me if I'm overcomplicating a simple task, I do that sometimes!
<br/>
<br/>
BTW I used to just have a C++ file contain all my items, but I wanted to have an easily modifable textfile for items and not be a C++ file.
<br/>
<br/>
I sound crazy don't I :(<br/>_________________<br/><a class="postlink" href="http://sacredpotion.blogspot.com/" target="_blank"><span style="color: red">My Homebrew Games</span></a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#177142 - Dwedit - Sun Dec 18, 2011 2:48 am</h4>
    <div class="postbody"><span class="postbody">Maybe change the tool to make C++ files instead of .o files?<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#177146 - Azenris - Mon Dec 19, 2011 6:22 pm</h4>
    <div class="postbody"><span class="postbody">Thanks for the suggestions. I may go the route of allocating with new, but including the item through nitrofiles(?). This could also be advantages later if I want to keep certain items out of memory until I need them.
<br/>
<br/>
I could even move the .itm converter within the game and include those in the nitrofiles. Might slow down the game startup, but will speed up compile times and make it so easy to balance items, such as adjusting what they heal etc.
<br/>
<br/>
Anyway, ty.<br/>_________________<br/><a class="postlink" href="http://sacredpotion.blogspot.com/" target="_blank"><span style="color: red">My Homebrew Games</span></a></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
