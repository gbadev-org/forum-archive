<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>2d array on the heap - noob question - answered :) - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>C/C++ > 2d array on the heap - noob question - answered :)</h2>
<div id="posts">
<div class="post">
    <h4>#143698 - mr_munk - Thu Oct 25, 2007 12:22 pm</h4>
    <div class="postbody"><span class="postbody">Hi,
<br/>
<br/>
I Google'd the above and found this solution (which compiles and seems to function fine) but I don't understand what it is actually doing. Could someone fill me in ?
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">int (*my_array)[256] = new int[192][256];</td> </tr></table><span class="postbody">
<br/>
<br/>
Am I right in thinking that my_array is an array of pointers ? 
<br/>
<br/>
If the size of my_array doesn't match the number of rows in the 2d array allocated on the heap this throws a compiler error - why is that ?</span><span class="gensmall"><br/><br/>Last edited by mr_munk on Fri Oct 26, 2007 11:44 am; edited 3 times in total</span></div>    
</div>
<div class="post">
    <h4>#143700 - kusma - Thu Oct 25, 2007 12:48 pm</h4>
    <div class="postbody"><span class="postbody">Yeah, it's an array of pointers - not what you wanted, eyh? :)
<br/>
I usually use normal 1D arrays instead, and calculate the index using a multiplication.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">int *my_array = new int[192 * 256];
<br/>
<br/>
x = 100;
<br/>
y = 50;
<br/>
my_array[x + y * 192] = 0xFF00FF;
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#143701 - mr_munk - Thu Oct 25, 2007 1:00 pm</h4>
    <div class="postbody"><span class="postbody">Thanks for the reply, I am still curious as to how this line of code works though - in particular how do the 256 pointers in my_array in the stack (I think?) become initialised with the addresses of 256 new 2d arrays in the heap?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#143717 - eKid - Thu Oct 25, 2007 3:41 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">int (*my_array)[256] = new int[192][256];</td> </tr></table><span class="postbody">
<br/>
<br/>
this is kind of confusing
<br/>
what i think it is (dont take my answer very seriously):
<br/>
<br/>
"my_array" is declared as 256 int pointers
<br/>
<br/>
" = new int[192][256];" i guess this allocates each pointer (256 of them) with 192 int entries</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#143718 - mr_munk - Thu Oct 25, 2007 4:10 pm</h4>
    <div class="postbody"><span class="postbody">Thanks for your reply, I wonder why the 2nd dimension of the 2d array on the heap has to match the size of the array on the stack ? If the 256 pointers overlay 256 arrays of 196*int each, I would have expected int[<span style="font-weight: bold">256</span>]=new int[<span style="font-weight: bold">256</span>][192] rather than the other way around.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#143721 - Lick - Thu Oct 25, 2007 4:29 pm</h4>
    <div class="postbody"><span class="postbody">I think you should do this: </span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">int **arr_2d = new int[y][x];</td> </tr></table><span class="postbody">
<br/>
<br/>
Note that y is the first index, x is the second. You can think of this as the screen is being divided into scanlines.<br/>_________________<br/><a class="postlink" href="http://licklick.wordpress.com" target="_blank">http://licklick.wordpress.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#143723 - mr_munk - Thu Oct 25, 2007 5:04 pm</h4>
    <div class="postbody"><span class="postbody">Thanks Lick, that code makes sense, although it throws a compiler error for me: 
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">error: cannot convert 'uint (*)[256]' to 'uint**' in initialization</td> </tr></table><span class="postbody">
<br/>
<br/>
generated from:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">uint **lifeBfr = new uint[192][256];//Life buffer</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#143735 - sajiimori - Thu Oct 25, 2007 7:04 pm</h4>
    <div class="postbody"><span class="postbody">Does this help?</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">typedef int Pixel;
<br/>
<br/>
// A scanline is 256 pixels.
<br/>
typedef Pixel Scanline[256];
<br/>
<br/>
// A framebuffer is 192 scanlines.
<br/>
typedef Scanline FrameBuffer[192];
<br/>
<br/>
// A whole 256x192 framebuffer, by value.
<br/>
FrameBuffer fbByValue;
<br/>
Pixel p = fbByValue[line][column];
<br/>
<br/>
// A framebuffer on the heap.
<br/>
// Using it requires an extra dereference.
<br/>
FrameBuffer* fbOnHeap = new FrameBuffer;
<br/>
Pixel p = (*fbOnHeap)[line][column];</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#143738 - Lick - Thu Oct 25, 2007 7:27 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>mr_munk wrote:</b></span></td> </tr> <tr> <td class="quote">Thanks Lick, that code makes sense, although it throws a compiler error for me: 
<br/>
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">error: cannot convert 'uint (*)[256]' to 'uint**' in initialization</td> </tr></table><span class="postbody">
<br/>
<br/>
generated from:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">uint **lifeBfr = new uint[192][256];//Life buffer</td> </tr></table><span class="postbody"></span></td> </tr></table><span class="postbody">
<br/>
<br/>
My bad. I forgot you had to loop through the "outer array" to <span style="font-style: italic">new</span> the "inner arrays".
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">int **arr_2d = new (int *)[192];
<br/>
<br/>
for (i=0; i&lt;192; i++) {
<br/>
Â  arr_2d[0] = new int[256];
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
sajimori: that code is a genius way to explain why 192 goes first.<br/>_________________<br/><a class="postlink" href="http://licklick.wordpress.com" target="_blank">http://licklick.wordpress.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#143747 - sajiimori - Thu Oct 25, 2007 8:22 pm</h4>
    <div class="postbody"><span class="postbody">Note that the difference between my example and the single 1D array approach is merely syntactic: they are both contiguous blocks of memory.
<br/>
<br/>
On the other hand, the loop in Lick's previous example does 192 separate heap allocations, which is overly complex and inefficient.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#143752 - mr_munk - Thu Oct 25, 2007 9:09 pm</h4>
    <div class="postbody"><span class="postbody">Thanks for all the help guys, I'm going to take some time to digest it properly.
<br/>
<br/>
&lt;edit&gt;
<br/>
<br/>
I'm going to hack on this problem for a while rather than bumping this thread, since I don't want to outstay my welcome ;)  
<br/>
<br/>
Sajimori, just so you know, when I try to use typedef to implement a 2d array the following happens.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">typedef int Pixel;
<br/>
typedef Pixel ScanLine[256];
<br/>
typedef ScanLine FrameBuffer[192];</td> </tr></table><span class="postbody">
<br/>
<br/>
generates the following compiler error:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">error: cannot convert 'Pixel (*)[256]' to 'Pixel (*)[192][256]' in initialization</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#143771 - Lick - Thu Oct 25, 2007 10:27 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">typedef int Pixel;
<br/>
typedef Pixel[256] ScanLine;
<br/>
typedef ScanLine[192] FrameBuffer;</td> </tr></table><span class="postbody">
<br/>
<br/>
Does this work?<br/>_________________<br/><a class="postlink" href="http://licklick.wordpress.com" target="_blank">http://licklick.wordpress.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#143773 - sajiimori - Thu Oct 25, 2007 10:32 pm</h4>
    <div class="postbody"><span class="postbody">The typedefs aren't generating that error.  If you'd like to paste the line specified by the complier error, I might be able to spot the problem.  At a glance, it looks like it's trying to convert from a Scanline pointer to a FrameBuffer pointer.
<br/>
<br/>
But it's possible that I've made a mistake!  I don't often use arrays in complicated ways, partly due to their second-class status in C++.
<br/>
<br/>
Structs/classes have first-class status, so I'm inclined to quickly wrap arrays in structs to make them behave more like regular values.  For instance, you can't pass an array by value, but you can pass a struct by value even if it contains an array.
<br/>
<br/>
Edit: Lick, that syntax is incorrect.  :)  Write typedefs like variable declarations, and put the name of the new type where the variable name would go.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#143778 - Lick - Thu Oct 25, 2007 10:55 pm</h4>
    <div class="postbody"><span class="postbody">Oh okay, yeah I lost it. Just recently I started writing C code again. =/<br/>_________________<br/><a class="postlink" href="http://licklick.wordpress.com" target="_blank">http://licklick.wordpress.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#143824 - mr_munk - Fri Oct 26, 2007 11:43 am</h4>
    <div class="postbody"><span class="postbody">Well, I now have two versions of my code (which is a 'game of life engine' that I am trying to optimise, BTW:) Oh! and this isn't coursework - I'm not at University - I want to use it as part of a game.
<br/>
<br/>
The first uses 1d arrays to hold the current and next generation of cells, this benefits from easy use of memcpy (since the array on the heap only uses one pointer) but also takes a performance hit from the extra math to simulate 2d references (partially replaced by LUTS but still to slower than the second.)
<br/>
<br/>
The second program uses 2d arrays which makes the code more efficient and elegant (esp. in regards to using LUT's for modulo functions) but it is hard to  figure out a valid memcpy call for the 2d arrays (since there structure seems to be an array of pointers to arrays and each row array has 2 pointers.)
<br/>
<br/>
Sajimori - I am a relative beginner, so I am sure it is I who has made the mistake ;) For completeness here is the declaration which the error refers to:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">FrameBuffer* fbOnHeap = new FrameBuffer;</td> </tr></table><span class="postbody">
<br/>
<br/>
Thanks to all - I have learned quite a bit in the last day or so thanks to your support :) I will declare this question answered.
<br/>
<br/>
&lt;edit&gt;
<br/>
<br/>
Thanks to Sajimori's comment about the memory layout being contiguous I figured out the (simple) answer to memCpy the 2d arrays. D'oh.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#143870 - sajiimori - Fri Oct 26, 2007 11:46 pm</h4>
    <div class="postbody"><span class="postbody">Nope, it was my mistake after all!  I don't know why it doesn't work, but arrays are truly weird and incongruous with the rest of C++ so I'd just do this:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">struct FrameBuffer { ScanLine lines[192]; };
<br/>
FrameBuffer* fb = new FrameBuffer;
<br/>
</td> </tr></table><span class="postbody">
<br/>
I compiled that and it works fine.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
