<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>GCC is driving me insane. - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>C/C++ > GCC is driving me insane.</h2>
<div id="posts">
<div class="post">
    <h4>#9121 - Domovoi - Mon Jul 28, 2003 6:30 pm</h4>
    <div class="postbody"><span class="postbody">I have a GBA program that compiles just fine. When I insert the following piece of code:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
for (int i=0; i &lt; 5; ++i)
<br/>
{
<br/>
    bg2.tileData[32] = 10;
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
...and compile, I get 5 errors: 
<br/>
<br/>
---
<br/>
<br/>
/cygdrive/c/DOCUME~1/Standard/LOCALS~1/Temp/ccepU2IR.s: Assembler messages:
<br/>
/cygdrive/c/DOCUME~1/Standard/LOCALS~1/Temp/ccepU2IR.s:43: Error: byte or halfword not valid for base register
<br/>
/cygdrive/c/DOCUME~1/Standard/LOCALS~1/Temp/ccepU2IR.s:44: Error: byte or halfword not valid for base register
<br/>
/cygdrive/c/DOCUME~1/Standard/LOCALS~1/Temp/ccepU2IR.s:45: Error: byte or halfword not valid for base register
<br/>
/cygdrive/c/DOCUME~1/Standard/LOCALS~1/Temp/ccepU2IR.s:46: Error: byte or halfword not valid for base register
<br/>
NMAKE : fatal error U1077: 'gcc' : return code '0x1'
<br/>
<br/>
---
<br/>
<br/>
Then I change the for statement to this:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
for (int i=0; i &lt; 4; ++i)
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
...and compile. No problems, compiles just fine.
<br/>
<br/>
Since when is it impossible for an int to be a value larger than 3?
<br/>
<br/>
It gets weirder. When I change it back to i &lt; 5 and comment out the bg2.tiledata line (which, if you look closely, doesn't even -do- anything with the i variable), it suddenly compiles nicely.
<br/>
<br/>
Here's something similar:
<br/>
<br/>
This works fine:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
for (int loop=0; loop &lt; 256*32; ++loop)
<br/>
{
<br/>
    bg1.tileData[loop] = 0;
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
But this, which is the same code, only twice, generates those five errors again:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
for (int loop=0; loop &lt; 256*32; ++loop)
<br/>
{
<br/>
    bg1.tileData[loop] = 0;
<br/>
}
<br/>
for (int loop=0; loop &lt; 256*32; ++loop)
<br/>
{
<br/>
    bg1.tileData[loop] = 0;
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
<br/>
And so does this:
<br/>
<br/>
for (int loop=0; loop &lt; 256*32; ++loop)
<br/>
{
<br/>
    bg1.tileData[loop] = 0;
<br/>
}
<br/>
<br/>
for (int loop=0; loop &lt; 256*32; ++loop)
<br/>
{
<br/>
    bg2.tileData[loop] = 0;
<br/>
}
<br/>
[/code]
<br/>
<br/>
What's going on here? It's impossible for me to loop through my tile data this way. The compiler seems to just randomly decides when I can and can't use a for loop.
<br/>
<br/>
What is this, a plot against me? Is GCC just dodgy? What's going on?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#9123 - Vortex - Mon Jul 28, 2003 7:02 pm</h4>
    <div class="postbody"><span class="postbody">Looks like a data alignment problem. Try to declare your array/structure with 4 byte alignment and compile with no optimization to isolate any optimization problems (-O3 causes problems sometimes).
<br/>
<br/>
Also check the size of the structure. You may want to pad to have a size divisible by 4 (i.e. dword aligned).
<br/>
<br/>
Examples:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
u16 bg3_buffer[ MAP_WIDTH * MAP_HEIGHT ] __attribute__ ((aligned (4))) = { .... }
<br/>
<br/>
<br/>
struct BGControl
<br/>
{
<br/>
   unsigned Priority            : 2;
<br/>
   unsigned CharacterBaseBlock  : 2;
<br/>
   unsigned NotUsed             : 2;
<br/>
   unsigned Mosaic              : 1;
<br/>
   unsigned ColorPalettes       : 1;
<br/>
   unsigned ScreenBaseBlock     : 5;
<br/>
   unsigned DisplayAreaOverflow : 1;
<br/>
   unsigned ScreenSize          : 2;
<br/>
} __attribute__ ((aligned (2),packed));
<br/>
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#9129 - Domovoi - Tue Jul 29, 2003 12:20 am</h4>
    <div class="postbody"><span class="postbody">Hmm... Thanks for the reply... Now if only I knew what all that meant. :-)
<br/>
<br/>
What is data alignment? Why  is GCC having trouble with it? What does 4 byte alignment mean? What does it do? Is there any info I can use to read up on the matter?
<br/>
<br/>
Also, about the optimizations... I'm using GCC in VC++6 with a makefile... I guess the optimizations are toggled there?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#9208 - Vortex - Wed Jul 30, 2003 5:53 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Domovoi wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
What is data alignment? Why  is GCC having trouble with it? What does 4 byte alignment mean? What does it do? Is there any info I can use to read up on the matter?
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
In a nutshell - when the compiler allocates space for your variables (scalars, arrays, structures, etc.) there are two points to consider: starting address and data size. These two aspects depend on the target CPU/architercure - in our case that's ARM, which is a 32-bit processor. 
<br/>
Data alignment is related to how the staring memory address for the variable is assigned. For some oprations (DMA access for example) the staring address should be divisible by 2 (word alignment) or 4 (double word alignment). The same rules apply for the data size of agregate data types (structures/unions). There is an easy way to figure out these two aspects - to see the address of a variable, declare a pointer of that type, assignt it to point to your variable and print pointers value (i.e. the address). Then try to divide that by 4 using a calculator and see if there is any reminder. If there is that means your variable is *not* dword aligned.
<br/>
To get the size of the variable use the sizeof() operator.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Domovoi wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
Also, about the optimizations... I'm using GCC in VC++6 with a makefile... I guess the optimizations are toggled there?</td> </tr></table><span class="postbody">
<br/>
<br/>
Open your makefile and search for -O2 or -O2. Remove temporary any of these flags. The makefile line usualy looks like CFLAGS= ... -O3. If there is no -O2 or -O3 flag in your current makefile, your problem is not optimization related.
<br/>
<br/>
Hope that helps.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#9387 - Domovoi - Sun Aug 03, 2003 8:12 am</h4>
    <div class="postbody"><span class="postbody">Thanks a lot! I had looked around in the makefile before and removed the -O3 bit... Works now. I only wonder... What harmful effect might this have on the code the compiler now generates?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#9390 - tepples - Sun Aug 03, 2003 3:06 pm</h4>
    <div class="postbody"><span class="postbody">-O3 code is generally faster than -O2 code, which is faster than -O code, which is much faster than code without any compiler optimization at all. Try all four options and see which one produces incorrectness.
<br/>
<br/>
-O3 produces incorrectness, and -O2 doesn't: The compiler probably has a bug. <a class="postlink" href="http://gcc.gnu.org/bugs.html" target="_blank">Here's how to report a bug</a>.
<br/>
<br/>
-O or -O2 produces incorrectness, and without optimization doesn't: You likely have a problem in your own code, possibly with respect to pointer aliasing or lack of 'volatile' on a memory-mapped register.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
