<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>GBA ARM CPU instruction set, quick question - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>C/C++ > GBA ARM CPU instruction set, quick question</h2>
<div id="posts">
<div class="post">
    <h4>#167115 - wildex999 - Mon Mar 02, 2009 12:36 am</h4>
    <div class="postbody"><span class="postbody">Hello,
<br/>
I'm trying to code a basic GBA Emulator in C, and I just have a quick question on something that has bothered me a little while.
<br/>
<br/>
I have come to the part where I have to study the ARM technical documents(http://infocenter.arm.com/help/topic/com.arm.doc.ddi0210c/DDI0210B.pdf   page 1-12) and learn the instruction set, and while I get how they work and are set up(And have tried some asm coding using them) I met a kind of wall when it came to disassembling or decoding them when writing an AMR7tdmi cpu emulator.
<br/>
The way I see it the instructions in binary form do not contain a specific opcode that can be directly read to find out wich instruction I'm looking at.
<br/>
Looking at the Instruction set format it seems like one have to figure out what instruction it is by masking and checking pre-set bit patterns.
<br/>
So my question is, is this right? Is there some part I have overlooked?
<br/>
I looked in at some open source emulators, but most people seem to have optimised so much I can not tell what they actually check, or if there's a pattern to it.
<br/>
<br/>
I tried to set up the bit patterns from the ARM documentation:
<br/>
xxxx00xxxxxxxxxxxxxxxxxxxxxxxxxx   Data processing/ PSR Transfer
<br/>
xxxx000000xxxxxxxxxxxxxx1001xxxx   Multiply
<br/>
xxxx00001xxxxxxxxxxxxxxx1001xxxx   Multiply long
<br/>
xxxx00010x00xxxxxxxx00001001xxxx   Single Data Swap
<br/>
xxxx000100101111111111110001xxxx   Branch and Exchange(BX)
<br/>
xxxx000xx0xxxxxxxxxx00001xx1xxxx   Halfword Data Transfer: register offset
<br/>
xxxx01xxxxxxxxxxxxxxxxxxxxxxxxxx   Single Data Transfer
<br/>
xxxx011xxxxxxxxxxxxxxxxxxxx1xxxx   Undefined
<br/>
xxxx100xxxxxxxxxxxxxxxxxxxxxxxxx   Block Data Transfer
<br/>
xxxx101xxxxxxxxxxxxxxxxxxxxxxxxx   Branch
<br/>
xxxx110xxxxxxxxxxxxxxxxxxxxxxxxx   Coprocessor Data Transfer
<br/>
xxxx1110xxxxxxxxxxxxxxxxxxx0xxxx   Coprocessor Data Operation
<br/>
xxxx1110xxxxxxxxxxxxxxxxxxx1xxxx   Coprocessor Register Transfer
<br/>
xxxx1111xxxxxxxxxxxxxxxxxxxxxxxx   Software Interrupt
<br/>
<br/>
Where x is a variable(or undefined) and the numbers are the set bit's for the instructions.
<br/>
Am I right in that checking the bit patterns is the right way to determine the instruction?
<br/>
<br/>
Thanks in advance =)<br/>_________________<br/>EZ Flash III - Flashme V7 - NDS V1 xD - NDS Tunneling, anyone?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167117 - Dwedit - Mon Mar 02, 2009 1:46 am</h4>
    <div class="postbody"><span class="postbody">You can also look at the source code to VisualBoyAdvance to see how they did it.<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167118 - wildex999 - Mon Mar 02, 2009 2:34 am</h4>
    <div class="postbody"><span class="postbody">Ah, thanks, I didn't know vba was open source =D
<br/>
They had EXACTLY the source I needed to look at(armdis.cpp) ^^
<br/>
<br/>
And it does exactly what I was thinking of doing =)
<br/>
<br/>
They list up an outer mask(To figure out the main type of instruction) and then an inner mask to figure out what instruction it is inside the main type.
<br/>
And then check to see if the 32 bit code read in &amp;(and) outer mask equals the inner mask for all possible instructions.
<br/>
<br/>
0x0de00000, 0x00800000, add     &lt;-- add instruction
<br/>
<br/>
0x0de00000 = main mask = data processing
<br/>
0x00800000 = inner mask = add
<br/>
<br/>
From documentation
<br/>
xxxx00xccccxxxxxxxxxxxxxxxxxxxxx Data processing/ PSR Transfer 
<br/>
cccc=opcode(inner mask)
<br/>
<br/>
Thus:
<br/>
0x0de00000 = 1101111000000000000000000000
<br/>
0x00800000 =        100000000000000000000000
<br/>
the opcode for add = 0100
<br/>
<br/>
Example add instruction:
<br/>
00?0100?????????????????????????
<br/>
? = a variable
<br/>
<br/>
<br/>
(I wrote that just to get my own head around it =P)
<br/>
Hm... maybe this will help others later on, I dunno =P
<br/>
<br/>
Anyway, thansk a lot for the help =)
<br/>
If anyone has anything to add(or correct) feel free to post it here. :)<br/>_________________<br/>EZ Flash III - Flashme V7 - NDS V1 xD - NDS Tunneling, anyone?</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
