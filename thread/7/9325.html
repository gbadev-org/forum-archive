<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Compiling in ARM vs Thumb - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>C/C++ > Compiling in ARM vs Thumb</h2>
<div id="posts">
<div class="post">
    <h4>#80482 - Obelix - Sat Apr 22, 2006 6:02 pm</h4>
    <div class="postbody"><span class="postbody">Hi all !
<br/>
<br/>
I'm just using the latest version of devkitarm (R18 with GCC 4.1.0) to compile a small code for GBA, and I have some problems. Maybe someone could help me.
<br/>
<br/>
1 - When I use the -S option to output the assembly code generated by gcc, the extension is .o instead of .s. This is not a big problem, but do you know why ?
<br/>
<br/>
2 - More important : I want to compile C source code in ARM mode.
<br/>
This was working fine in my previous projet with devkitadv. But with devkitarm r18, the assembly code generated is still thumb code.
<br/>
I've tried many different syntax, using "__attribute__ ((section (".iwram"), long_call))", calling my source file "xxx.iwram.c", etc., but nothing work.
<br/>
<br/>
With "__attribute__ ((section (".iwram"), long_call))", 
<br/>
- the assembly code generated contains the line :
<br/>
    .section    .iwram,"ax",%progbits
<br/>
- the map file show the code is in iwram at 0x03000000 adress
<br/>
but the code use the Thumb instruction set !!!
<br/>
<br/>
Do you know if there is another configuration to specifiy ?
<br/>
<br/>
Thanks in advance for your help.
<br/>
--  
<br/>
Philippe<br/>_________________<br/>-- 
<br/>
Philippe aka Obelix</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#80484 - poslundc - Sat Apr 22, 2006 6:51 pm</h4>
    <div class="postbody"><span class="postbody">Putting code in IWRAM does not make it ARM code instead of Thumb code. The type of code and the section of memory it resides in are two distinct and exclusive properties of the code.
<br/>
<br/>
I need to preface my responses with saying I've not worked with DevkitARM so they are just general info... if they don't work, someone with more precise knowledge will have to fill you in.
<br/>
<br/>
1. This is probably if you are using the -o flag to specify the output file name, and then giving that output file name a ".o" extension. At least, that would be my best guess.
<br/>
<br/>
2. You should be able to generate ARM code instead of Thumb code for the files you want to be ARM code by removing the "-mthumb" flag from the GCC command line.
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#80485 - wintermute - Sat Apr 22, 2006 6:53 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Obelix wrote:</b></span></td> </tr> <tr> <td class="quote">Hi all !
<br/>
<br/>
1 - When I use the -S option to output the assembly code generated by gcc, the extension is .o instead of .s. This is not a big problem, but do you know why ?
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
It's because the output file is specified using -o. The -S switch is intended for single files afaik. If you want to see the assembly for all of your files you can use -save-temps in CFLAGS instead. With the standard makefiles all output files will be found in the $BUILD folder.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
2 - More important : I want to compile C source code in ARM mode.
<br/>
This was working fine in my previous projet with devkitadv. But with devkitarm r18, the assembly code generated is still thumb code.
<br/>
I've tried many different syntax, using "__attribute__ ((section (".iwram"), long_call))", calling my source file "xxx.iwram.c", etc., but nothing work.
<br/>
<br/>
With "__attribute__ ((section (".iwram"), long_call))", 
<br/>
- the assembly code generated contains the line :
<br/>
    .section    .iwram,"ax",%progbits
<br/>
- the map file show the code is in iwram at 0x03000000 adress
<br/>
but the code use the Thumb instruction set !!!
<br/>
<br/>
Do you know if there is another configuration to specifiy ?
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
<br/>
You need to specify -marm to use the arm instruction set. Either add a specific rule for the file you wish to compile as arm in your main makefile
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#---------------------------------------------------------------------------------
<br/>
&lt;filename&gt;.o: &lt;filename&gt;.cpp
<br/>
   @echo $(notdir $&lt;)
<br/>
   $(CXX) -MMD -MP -MF $(DEPSDIR)/$*.d $(CXXFLAGS) -marm -mlong-calls -c $&lt; -o $@
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
or, what I should probably do, is add these lines to base_rules - found in the devkitARM folder
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#---------------------------------------------------------------------------------
<br/>
%.iwram.o: %.iwram.cpp
<br/>
   @echo $(notdir $&lt;)
<br/>
   $(CXX) -MMD -MP -MF $(DEPSDIR)/$*.d $(CXXFLAGS) -marm -mlong-calls -c $&lt; -o $@
<br/>
#---------------------------------------------------------------------------------
<br/>
%.iwram.o: %.iwram.c
<br/>
   @echo $(notdir $&lt;)
<br/>
   $(CC) -MMD -MP -MF $(DEPSDIR)/$*.d $(CFLAGS) -marm -c $&lt; -o $@
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
adding -mlong-calls allows for the iwram routines to call functions in rom - you'll get relocation errors on linking if this is necessary.<br/>_________________<br/><a class="postlink" href="http://www.devkitpro.org/" target="_blank">devkitPro - professional toolchains at amateur prices</a>
<br/>
<a class="postlink" href="http://wiki.devkitpro.org/index.php/IRC" target="_blank">devkitPro IRC support</a>
<br/>
<a class="postlink" href="http://davejmurphy.com/" target="_blank">Personal Blog</a></span><span class="gensmall"><br/><br/>Last edited by wintermute on Sun Apr 23, 2006 6:13 pm; edited 2 times in total</span></div>    
</div>
<div class="post">
    <h4>#80507 - Obelix - Sun Apr 23, 2006 1:12 am</h4>
    <div class="postbody"><span class="postbody">Dave &amp; Dan, 
<br/>
<br/>
Many thanks for your ultra-quick answers !!!
<br/>
<br/>
All is fine now.
<br/>
-- 
<br/>
Philippe<br/>_________________<br/>-- 
<br/>
Philippe aka Obelix</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
