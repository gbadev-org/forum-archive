<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>C/C++ trouble - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>C/C++ > C/C++ trouble</h2>
<div id="posts">
<div class="post">
    <h4>#33826 - LOst? - Sun Jan 09, 2005 7:01 pm</h4>
    <div class="postbody"><span class="postbody">I still have some troubles with C/C++ when it comes to dynamically allocated memory (C++), and a temporary allocated array which pointer is returned (C/C++).
<br/>
<br/>
Well, here is the first problem:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
   // According to my C++ book:
<br/>
   char array [18];
<br/>
   sizeof (array [0]);      // &lt;-- Returns 1
<br/>
   sizeof (array);         // &lt;-- Returns 18
<br/>
<br/>
   // My problem:
<br/>
   char array = new char [18];
<br/>
   sizeof (*array);      // &lt;-- Returns 1
<br/>
   sizeof (array);         // Returns 4 and not 18!
<br/>
</td> </tr></table><span class="postbody">
<br/>
How can I get the size of a dynamically allocated array?
<br/>
<br/>
And my other problem (pointer returned for local array):
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
char* CreateArray ()
<br/>
{
<br/>
   char* tmp_array = new char [256];      // This is a local variable right?
<br/>
<br/>
   tmp_array [50] = 'Y';
<br/>
<br/>
   return tmp_array;
<br/>
}
<br/>
<br/>
void main (void)
<br/>
{
<br/>
   char* array = NULL;
<br/>
<br/>
   array = CreateArray ();         // Since the pointer is returned, how do I know the array is still there when it tmp_array was local to the function CreateArray?
<br/>
<br/>
   if (array [50] == 'Y')         // Is the data really left in memory? Is it valid?
<br/>
      ...
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
These things are bugging me so much. I don't have any good C++ book covering up what happens to the memory between functions.
<br/>
<br/>
Help you great C++ people! *bows*</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#33835 - sajiimori - Sun Jan 09, 2005 8:23 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">How can I get the size of a dynamically allocated array?</td> </tr></table><span class="postbody">When you reference a real array directly (i.e. not via a pointer), the compiler can see its size by looking at the declaration.  Since pointers only store an address, the only thing the compiler knows is its type.  The size will always be the size of a pointer.
<br/>
<br/>
(You might say that the compiler should be able to see that you just allocated 18 bytes, but there is no general way for the compiler to know that.  For instance, if you pass a pointer to a function, what size should the compiler assume the array is?  Is it even an array at all, or just a pointer to a single object?  Does it even point to a valid object, or is it a null pointer or garbage?)
<br/>
<br/>
If you want to retain the size, you have to store it seperately.  You can make a class that overloads operator[] to hide all that.</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">This is a local variable right?</td> </tr></table><span class="postbody">The pointer is local (which means it's on the stack), but the array is on the heap.  Heap memory must be explicitly allocated and deallocated (with malloc/free or new/delete).  You return a copy of the pointer to the array, which is fine, and then you store that pointer in another local in main, which is also fine.
<br/>
<br/>
The hard part is making sure you delete the array (by using the delete operator on a pointer to the array) after you're sure nobody is going to use it, but before you lose the last pointer to it.  If you lose the last pointer without deleting the array, you can never delete the array and the memory can't be reclaimed.
<br/>
<br/>
As for books, since I usually recommend mastering plain C before using C++, that also implies that you'd have dynamic memory allocation covered, so a book like "C Primer Plus" covers all that.  Since my favorite C++ books build on C, they will be assuming you know how it works.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#33837 - LOst? - Sun Jan 09, 2005 8:33 pm</h4>
    <div class="postbody"><span class="postbody">Thank you sajiimori! This isn't the first time you have saved my day!
<br/>
<br/>
I kinda knew this a little, but I want to be sure because everytime i'm going to program something that uses this, I get a little bit nervous it will backfire some how.
<br/>
<br/>
And I'm good at NULLing the pointers before and after use of new and delete.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#42295 - PragmaFury - Mon May 09, 2005 3:23 am</h4>
    <div class="postbody"><span class="postbody">This won't work on the GBA, but if you're doing Windows development, there is a platform method called _msize which will return the size of an array allocated on the heap.
<br/>
<br/>
Of course, it will only work if the memory is allocated with malloc, and I certainly wouldn't condone using it, but just FYI.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#42335 - LOst? - Tue May 10, 2005 4:17 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>PragmaFury wrote:</b></span></td> </tr> <tr> <td class="quote">This won't work on the GBA, but if you're doing Windows development, there is a platform method called _msize which will return the size of an array allocated on the heap.
<br/>
<br/>
Of course, it will only work if the memory is allocated with malloc, and I certainly wouldn't condone using it, but just FYI.</td> </tr></table><span class="postbody">
<br/>
<br/>
Thanks, I guess it works for operator new too?</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
