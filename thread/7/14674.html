<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Animations, DMA or ALL in VRAM? - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>C/C++ > Animations, DMA or ALL in VRAM?</h2>
<div id="posts">
<div class="post">
    <h4>#147085 - elyk1212 - Fri Dec 14, 2007 8:19 am</h4>
    <div class="postbody"><span class="postbody">Hey all,
<br/>
<br/>
I wanted to add many frames of animation to my 2D characters on my GBA game (think DK Country, or earthworm Jim)  but I was wondering what recommendations you may have for implementation.
<br/>
<br/>
I can either keep all frames for characters on the screen in VRAM (and simply update the index in OAM), or I can do DMA transfers (or slower memsets) between frames.  This is highly dependent on the size of the sprites, I realize, but I wanted high detail sprites and at least 6 characters (should be) possible on the screen at one time.
<br/>
<br/>
<br/>
Do you think the DMA (or memset) option would be too slow?  I don't have enough differeing characters/frames of animation yet to test this claim, just wondering if experienced folk (industry or otherwise) may have some insight.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#147088 - DiscoStew - Fri Dec 14, 2007 8:29 am</h4>
    <div class="postbody"><span class="postbody">If the animations are simple and are used a lot, loading into VRAM would work well. But for such detailed and fluid animations like DK Country, you'll most likely have to load from ROM.<br/>_________________<br/><span style="font-weight: bold">DS</span> - It's all about <span style="font-weight: bold">D</span>isco<span style="font-weight: bold">S</span>tew</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#147090 - elyk1212 - Fri Dec 14, 2007 8:35 am</h4>
    <div class="postbody"><span class="postbody">So DK probably does it that way then?  I am not surprised since there are so many frames and states (attacking, ducking, walking standing, scratching) all with tons of frames.  
<br/>
<br/>
What I am surprised at is that this still does not significantly bog down the system.  I guess underestimate the GBA.  Perhaps, there is a well capped limit on 'baddies' allowed on the screen at once?
<br/>
<br/>
I suppose the brute force way would be to load at each frame, would this be a good approach?  
<br/>
<br/>
It seems there could be a middle ground (e.g. load common tiles for a state  into VRAM, say walking, standing, etc). Thoughts?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#147112 - ScottLininger - Fri Dec 14, 2007 5:25 pm</h4>
    <div class="postbody"><span class="postbody">I've always had success loading tiles from ROM at render time. Even if this drops your frame rate to 30 or 20 FPS, the end results might be okay for you.
<br/>
<br/>
-Scott<br/>_________________<br/>Some of my <a class="postlink" href="http://www.scottlininger.com/" target="_blank">GBA projects</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#147116 - Kyoufu Kawa - Fri Dec 14, 2007 6:36 pm</h4>
    <div class="postbody"><span class="postbody">Pok?mon copied the required frames as needed, and so does OpenPok</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#147117 - elyk1212 - Fri Dec 14, 2007 6:57 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>ScottLininger wrote:</b></span></td> </tr> <tr> <td class="quote">I've always had success loading tiles from ROM at render time. Even if this drops your frame rate to 30 or 20 FPS, the end results might be okay for you.
<br/>
<br/>
-Scott</td> </tr></table><span class="postbody">
<br/>
<br/>
When you did that, did you use DMA or just memset,etc?  Is there a rule of thumb, e.g. for 'X' many bytes (or Xbytes and N transfers), use DMA, else just use memset?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#147122 - Miked0801 - Fri Dec 14, 2007 7:51 pm</h4>
    <div class="postbody"><span class="postbody">Pretty much every game I worked on used a VRAM double buffer to load stuff from ROM.  That way, we could compress the graphics and load into VRAM outside of the VBlank (at the cost of just over 1/2 of Sprite VRAM to the buffering).  Then just flip the buffer when the time came.  Spyro TEN was the first game in a long time where we actually did some loads without double buffering due to the silly sizes of some of the boss monsters.  As such, there was no compression and we DMA'd during vblank from ROM.  It was plenty fast.
<br/>
<br/>
And never, ever use memset/memcpy for vblank loads.  They are just too Slow for anything beyond simple demos.  For loads smaller than around 40 bytes or so, we just did ldm/stm loads directly via structure assigns.  Larger loads meant Dmas.  The trade-off comes from the need to setup the DMA registers as opposed to directly starting to copy.  Whilst memcpy and even cpufastcopy just have too much overhead in starting up and then loop too much once the copying has begun.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#147127 - tepples - Fri Dec 14, 2007 8:17 pm</h4>
    <div class="postbody"><span class="postbody">Or you can decompress to EWRAM and load them from there.
<br/>
<br/>
On the GBA, DMA freezes the CPU. If you are using the horizontal blank interrupt for raster effects more complicated than a single HDMA channel can provide, or if you're doing multiplayer, a CPU-based copy using an ldm/stm loop has the advantage that it will respond quickly to horizontal blanking or serial interrupts.
<br/>
<br/>
You might find <a class="postlink" href="http://www.pineight.com/gba/managing-sprite-vram.txt" target="_blank">my early white paper on this subject</a> interesting.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#147144 - ScottLininger - Sat Dec 15, 2007 1:01 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>elyk1212 wrote:</b></span></td> </tr> <tr> <td class="quote">When you did that, did you use DMA or just memset,etc?  Is there a rule of thumb, e.g. for 'X' many bytes (or Xbytes and N transfers), use DMA, else just use memset?</td> </tr></table><span class="postbody">
<br/>
<br/>
You know, I think that for my early games I just manually copied stuff with a for loop until I got it working nicely, and then I swapped it out with DMA calls once I knew everything was working.
<br/>
<br/>
In general, I'm a big fan of "get it working now... optimize later."
<br/>
<br/>
-Scott<br/>_________________<br/>Some of my <a class="postlink" href="http://www.scottlininger.com/" target="_blank">GBA projects</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#147303 - brave_orakio - Tue Dec 18, 2007 10:17 am</h4>
    <div class="postbody"><span class="postbody">Miked0801, how do you double buffer VRAM?  Any tutorials or tips on this?<br/>_________________<br/>help me</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#147330 - Miked0801 - Tue Dec 18, 2007 10:55 pm</h4>
    <div class="postbody"><span class="postbody">No tutorial per se.  Here's how it works though:
<br/>
<br/>
You decompress your first image somewhere in VRAM (probably with a VRAM management module you wrote to hande such things.)  When it comes time to load your next image/frame, you decompress your image somewhere else in VRAM.  During VBlank, you point the OAM to the new image and mark the old VRAM as free and usable.  Rinse and repeat.
<br/>
<br/>
Not much more to it that that.  It wastes quite a bit of VRAM space, but frees up (speeds up) the main loop and also frees EWRAM from being a decompression buffer.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#147351 - brave_orakio - Wed Dec 19, 2007 2:03 am</h4>
    <div class="postbody"><span class="postbody">I see, it uses twice the required amount of VRAM compared to copying/overwriting on the fly. I thought maybe you use EWRAM but that would be a lot slower wouldn't it?
<br/>
<br/>
Many thanks for that!<br/>_________________<br/>help me</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#147647 - elyk1212 - Tue Dec 25, 2007 6:34 am</h4>
    <div class="postbody"><span class="postbody">Yeah, thanks guys!  Great ideas.  
<br/>
<br/>
Happy Holidays!</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
