<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>goto vs. nests in timecritical polyfilling code. - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>C/C++ > goto vs. nests in timecritical polyfilling code.</h2>
<div id="posts">
<div class="post">
    <h4>#150304 - Lord Graga - Fri Feb 01, 2008 7:21 pm</h4>
    <div class="postbody"><span class="postbody">Hey all.
<br/>
<br/>
I've been working on a 3d engine for the GBA for a couple of years (on and off), and have decided that it is time to give it a major overhaul so that it can compete with more mature engines.
<br/>
While I should worry the most about structuring my faces and vertices in the most optimal way, I am still playing around with my buggy linear textured polyfiller (which has to be rewritten fully because it sucks and is linear).
<br/>
God damn those massive overheads, there are too many variables that needs to be handled gracefully.
<br/>
<br/>
But, what I want to ask:
<br/>
<br/>
Here is my current inner loop for the polyfiller: 
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">   while(toplength--)
<br/>
   {
<br/>
      int startx = xleft&gt;&gt;8;
<br/>
      int len = (xright&gt;&gt;8) - startx;
<br/>
      if(y &gt;= 0 &amp;&amp; y &lt; 160 &amp;&amp; xright &gt; 0 &amp;&amp; startx &lt; 240) {
<br/>
         unsigned uv = v | (u &lt;&lt; 16);
<br/>
         if(startx &lt; 0) {
<br/>
            uv -= startx*duvx;
<br/>
            len += startx;
<br/>
            startx = 0;
<br/>
         }
<br/>
         if(startx+len &gt; 240) len = 240 - startx;
<br/>
         if(len &gt; 0 ) {
<br/>
            if(startx &amp; 1) {
<br/>
               //Draw first uneven pixel
<br/>
            }
<br/>
            if(len &gt; 0 ) {
<br/>
               //Fill pixels
<br/>
            }
<br/>
         }
<br/>
      }
<br/>
      y++;
<br/>
      if(y &gt; 159) return;
<br/>
<br/>
      xleft += dxleft;
<br/>
      xright += dxright;
<br/>
      u += dug;
<br/>
      v += dvg;
<br/>
   }</td> </tr></table><span class="postbody">
<br/>
I was thinking about doing this:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">   while(toplength--) {
<br/>
      int startx = xleft&gt;&gt;8;
<br/>
      int len = (xright&gt;&gt;8) - startx;
<br/>
      if(len &lt; 1 || y &lt; 0 || y &gt; 159 || xright &lt; 0 || startx &gt; 240)
<br/>
         goto nodraw;
<br/>
<br/>
      unsigned uv = v | (u &lt;&lt; 16);
<br/>
<br/>
      if(startx &lt; 0) {
<br/>
         uv -= startx*duvx;
<br/>
         len += startx;
<br/>
         startx = 0;
<br/>
      }
<br/>
<br/>
      if(startx+len &gt; 240)
<br/>
         len = 240 - startx;
<br/>
<br/>
      if(len &lt; 1 )
<br/>
         goto nodraw;
<br/>
<br/>
      if(startx &amp; 1) {
<br/>
         //Draw first uneven pixel
<br/>
      }
<br/>
<br/>
      if(len &gt; 0 ) {
<br/>
         //Fill Scanline
<br/>
      }
<br/>
nodraw:
<br/>
      
<br/>
      y++;
<br/>
      if(y &gt; 159) return;
<br/>
<br/>
      xleft += dxleft;
<br/>
      xright += dxright;
<br/>
      u += dug;
<br/>
      v += dvg;
<br/>
   }</td> </tr></table><span class="postbody">
<br/>
<br/>
Would this create better or worse code? I am afraid that it could add some complexity to how the program would handle the stack.
<br/>
<br/>
<br/>
Cheers.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#150305 - kusma - Fri Feb 01, 2008 7:42 pm</h4>
    <div class="postbody"><span class="postbody">Are you sure it pays off to optimize for thin polygons? :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#150307 - sajiimori - Fri Feb 01, 2008 7:48 pm</h4>
    <div class="postbody"><span class="postbody">Using 'goto' often ties the optimizer's hands.
<br/>
<br/>
Compare the assembly output -- anything less is like working blindfolded.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#150308 - Lord Graga - Fri Feb 01, 2008 7:53 pm</h4>
    <div class="postbody"><span class="postbody">Well put. I guess the overhead is way more important.
<br/>
<br/>
I think you said something about storing x's, y's, u's and v's as local variables once, or am I wrong? It seems to make sense to me, but it is just such a huge mess to have 16-20 variables (x, y, u, v for top/middle/bottom/left/right) in the air while calculating delta values using dotproducts.
<br/>
Should I be calculating 5 dot products pr. face? (area, u/v horizontal and vertical growths). It takes up shitloads of CPU when I do it like this:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">   int d_u_t = p-&gt;u[top] - p-&gt;u[middle];
<br/>
   int d_v_t = p-&gt;v[top] - p-&gt;v[middle];
<br/>
   int d_u_b = p-&gt;u[bottom] - p-&gt;u[middle];
<br/>
   int d_v_b = p-&gt;v[bottom] - p-&gt;v[middle];
<br/>
<br/>
   int dux = (rcparea * ((ytop - ymiddle) * d_u_b - d_u_t * (ybottom - ymiddle)))&gt;&gt;8;
<br/>
   int dvx = (rcparea * ((ytop - ymiddle) * d_v_b - d_v_t * (ybottom - ymiddle)))&gt;&gt;8;
<br/>
   int duy = (rcparea * (d_u_t * (xbottom - xmiddle) - d_u_b * (xtop - xmiddle)))&gt;&gt;8;
<br/>
   int dvy = (rcparea * (d_v_t * (xbottom - xmiddle) - d_v_b * (xtop - xmiddle)))&gt;&gt;8;</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#150309 - DekuTree64 - Fri Feb 01, 2008 7:57 pm</h4>
    <div class="postbody"><span class="postbody">My rule: If you have to worry about it, just write the assembly yourself.
<br/>
<br/>
But to answer your specific question, it depends on the compiler. Benchmark it, or just look at the assembly output of each version.
<br/>
I would just stick with nesting by default since it theoretically shouldn't make a difference, and the gotos don't simplify the code at all.<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#150310 - Lord Graga - Fri Feb 01, 2008 8:05 pm</h4>
    <div class="postbody"><span class="postbody">I guess I'll go with that and concentrate on building a better program structure using structs for faces and vertices without arrays and linked lists for faces so that I can easely remove faces from the projection list using backface culling before sorting :)
<br/>
<br/>
LG.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#150311 - kusma - Fri Feb 01, 2008 8:17 pm</h4>
    <div class="postbody"><span class="postbody">I usually do some calculations to find a theoretical max performance, and then implement something that's easy to work with. If the performance is way off from the theoretical max, THEN I start worrying about optimizing.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#150327 - Miked0801 - Sat Feb 02, 2008 3:12 am</h4>
    <div class="postbody"><span class="postbody">You can accomplish the same thing as your 2 gotos with a little brace nesting - and teh compiler will understand that better.
<br/>
<br/>
But as speed is king here, you'd be better off with assembler so you can interleave your pixel drawing with your loop management overhead - after you are sure you algorithm is as fast as it can be.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#153578 - SevenString - Wed Apr 02, 2008 7:34 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>kusma wrote:</b></span></td> </tr> <tr> <td class="quote">Are you sure it pays off to optimize for thin polygons? :)</td> </tr></table><span class="postbody">
<br/>
<br/>
+1.
<br/>
<br/>
There's no code shown for "// FILL PIXELS", but I'm guessing that you're already unrolling your scan-line (horizontal) render loop?  This is the most critical part of the poly rendering algorithm, so optimizing in Y will only give marginal improvements (with the exception of the above mentioned thin-in-X polys).
<br/>
<br/>
And if you want slightly better performance beyond unrolling, set some registers with startx, len, uv, and duvx, then hand-tool that most inner loop of the scan-line renderer with a few lines of assembly, preferrably unrolled as well.<br/>_________________<br/><span style="font-style: italic">"Artificial Intelligence is no match for natural stupidity."</span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#153784 - sgeos - Sun Apr 06, 2008 7:24 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>DekuTree64 wrote:</b></span></td> </tr> <tr> <td class="quote">My rule: If you have to worry about it, just write the assembly yourself.</td> </tr></table><span class="postbody">
<br/>
Frankly, I think this is the correct answer.
<br/>
<br/>
-Brendan</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
