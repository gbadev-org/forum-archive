<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>How could I speed up my actor management/scripting system? - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>C/C++ > How could I speed up my actor management/scripting system?</h2>
<div id="posts">
<div class="post">
    <h4>#28953 - Andor - Tue Nov 09, 2004 4:22 am</h4>
    <div class="postbody"><span class="postbody">For my game, I've coded up a actor management/scripting system based on one that I programmed in Visual Basic for my games on the PC. In this system, each actor is an instance of the class cActor, which contains all the variables an actor could ever possibly need, along with all the routines for interpreting the scripts that I feed it.
<br/>
<br/>
However, it appears that my actor management system is terribly slow on the GBA: 12 actors on the screen, doing very little aside from walking around, consume no less than 127 vblanks (~156,464 cpu cycles). I have no idea why this should take so long (aside from the obvious: I'm new to c++, and my code is poorly written =P).
<br/>
<br/>
What's especially slow is when I have one actor read/write to another actor's variables:
<br/>
<br/>
From the Actor's script (stored in a s16 const array):
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">//get the value of variable8 of the Actor whose index = 5.
<br/>
//in other words: me.variable9 = Actors[5].variable1
<br/>
asGetOtherVar, 5, avVariable1, avVariable9,</td> </tr></table><span class="postbody">
<br/>
<br/>
This is the routine that is run by that statement:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void cActorEntity::ActorScript_GetOtherVar(s16 vvar1, s16 vvar2, s16 vvar3)
<br/>
{
<br/>
   s16 ActorIndex, VarToGet, retVariable, retValue;
<br/>
   
<br/>
   if (ActorScript_IsAVariable(vvar1) == 1)      {ActorIndex = ActorScript_GetVariable(vvar1);}
<br/>
      else                     {ActorIndex = vvar1;}
<br/>
<br/>
   //don't get the value of the second vvar - instead, pass the index of the variable desired.
<br/>
   VarToGet = vvar2;
<br/>
   
<br/>
   //don't get the value of the third vvar - instead, pass the index of the variable desired.
<br/>
   retVariable = vvar3;
<br/>
      
<br/>
   retValue = Actors[ActorIndex].ActorScript_GetVariable(VarToGet);
<br/>
   ActorScript_SetVariable(retVariable, retValue);
<br/>
   return;
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
And this is the routine that gets a variable (this is called every time the Actor needs to get the contents of a variable:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">s16 cActorEntity::ActorScript_GetVariable(u16 vartoget)
<br/>
{
<br/>
switch (vartoget)
<br/>
   {
<br/>
      case avTileX : //tileX
<br/>
         return tileX;
<br/>
      case avTileY : //tileY
<br/>
         return tileY;
<br/>
      case avOffsetX : //offsetX
<br/>
         return offsetX;
<br/>
      case avOffsetY : //offsetY
<br/>
         return offsetY;
<br/>
      case avSpriteID : //spriteID
<br/>
         return spriteID;
<br/>
      case avSpriteFrame : //spriteFrame
<br/>
         return spriteFrame;
<br/>
      case avSpriteSize : //spriteSize
<br/>
         return 0; //because you can't read the sprite size. oh well, eh?
<br/>
      case avSpritePalette : //spritePalette
<br/>
         return spritePalette;
<br/>
      case avSpriteAddress : //spriteAddress
<br/>
         return spriteAddress;
<br/>
      case avSpeed : //speed
<br/>
         return speed;
<br/>
      case avScriptID : //scriptID
<br/>
         return scriptID;
<br/>
      case avScriptLine : //scriptLine
<br/>
         return scriptLine;
<br/>
      case avReturnScriptLine : //returnScriptLine
<br/>
         return returnScriptLine;
<br/>
      case avActivateID : //activateID
<br/>
         return activateID;
<br/>
      case avActivateLine : //activateLine
<br/>
         return activateLine;
<br/>
      case avReturnActivateLine : //returnActivateLine
<br/>
         return returnActivateLine;
<br/>
      case avVariable1 : //variable1
<br/>
         return variable1;
<br/>
      case avVariable2 : //variable2
<br/>
         return variable2;
<br/>
      case avVariable3 : //variable3
<br/>
         return variable3;
<br/>
      case avVariable4 : //variable4
<br/>
         return variable4;
<br/>
      case avVariable5 : //variable5
<br/>
         return variable5;
<br/>
      case avVariable6 : //variable6
<br/>
         return variable6;
<br/>
      case avVariable7 : //variable7
<br/>
         return variable7;
<br/>
      case avVariable8 : //variable8
<br/>
         return variable8;
<br/>
      case avVariable9 : //variable9
<br/>
         return variable9;
<br/>
      case avVariable10 : //variable10
<br/>
         return variable10;
<br/>
      case avVariable11 : //variable11
<br/>
         return variable11;
<br/>
      case avVariable12 : //variable12
<br/>
         return variable12;
<br/>
      case avFlag_ActivateN : //flag_activateN
<br/>
         switch (flags &amp; 0x8000)
<br/>
         {
<br/>
            case 0 :
<br/>
               return 0;
<br/>
            default :
<br/>
               return 1;
<br/>
         }
<br/>
      case avFlag_ActivateS : //flag_activateS
<br/>
         switch (flags &amp; 0x4000)
<br/>
         {
<br/>
            case 0 :
<br/>
               return 0;
<br/>
            default :
<br/>
               return 1;
<br/>
         }
<br/>
      case avFlag_ActivateW : //flag_activateW
<br/>
         switch (flags &amp; 0x2000)
<br/>
         {
<br/>
            case 0 :
<br/>
               return 0;
<br/>
            default :
<br/>
               return 1;
<br/>
         }
<br/>
      case avFlag_ActivateE : //flag_activateE
<br/>
         switch (flags &amp; 0x1000)
<br/>
         {
<br/>
            case 0 :
<br/>
               return 0;
<br/>
            default :
<br/>
               return 1;
<br/>
         }
<br/>
      case avFlag_MovingN : //flag_movingN
<br/>
         switch (flags &amp; 0x0800)
<br/>
         {
<br/>
            case 0 :
<br/>
               return 0;
<br/>
            default :
<br/>
               return 1;
<br/>
         }
<br/>
      case avFlag_MovingS : //flag_movingS
<br/>
         switch (flags &amp; 0x0400)
<br/>
         {
<br/>
            case 0 :
<br/>
               return 0;
<br/>
            default :
<br/>
               return 1;
<br/>
         }
<br/>
      case avFlag_MovingW : //flag_movingW
<br/>
         switch (flags &amp; 0x0200)
<br/>
         {
<br/>
            case 0 :
<br/>
               return 0;
<br/>
            default :
<br/>
               return 1;
<br/>
         }
<br/>
      case avFlag_MovingE : //flag_movingE
<br/>
         switch (flags &amp; 0x0100)
<br/>
         {
<br/>
            case 0 :
<br/>
               return 0;
<br/>
            default :
<br/>
               return 1;
<br/>
         }
<br/>
      case avFlag_HFlip : //flag_HFlip
<br/>
         switch (flags &amp; 0x0010)
<br/>
         {
<br/>
            case 0 :
<br/>
               return 0;
<br/>
            default :
<br/>
               return 1;
<br/>
         }
<br/>
      case avFlag_Visible : //flag_Visible
<br/>
         switch (flags &amp; 0x0008)
<br/>
         {
<br/>
            case 0 :
<br/>
               return 0;
<br/>
            default :
<br/>
               return 1;
<br/>
         }
<br/>
      case avFlag_WhichScript : //flag_WhichScript
<br/>
         switch (flags &amp; 0x0004)
<br/>
         {
<br/>
            case 0 :
<br/>
               return 0;
<br/>
            default :
<br/>
               return 1;
<br/>
         }
<br/>
      case avFlag_NoPause : //flag_NoPause
<br/>
         switch (flags &amp; 0x0002)
<br/>
         {
<br/>
            case 0 :
<br/>
               return 0;
<br/>
            default :
<br/>
               return 1;
<br/>
         }
<br/>
      case avFlag_InUse : //flag_InUse
<br/>
         switch (flags &amp; 0x0001)
<br/>
         {
<br/>
            case 0 :
<br/>
               return 0;
<br/>
            default :
<br/>
               return 1;
<br/>
         }
<br/>
   }
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
And for the record, here is the definition of class cActor:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">class cActor {
<br/>
public:
<br/>
   s16 tileX, tileY;
<br/>
   s16 offsetX, offsetY;
<br/>
   u16 spriteAddress;
<br/>
   s16 spriteID, spriteFrame, spriteSize1, spriteSize2, spritePalette;
<br/>
   s16 speed;   
<br/>
   s16 scriptID, scriptLine, returnScriptLine;
<br/>
   s16 activateID, activateLine, returnActivateLine;
<br/>
   s16 variable1, variable2, variable3, variable4;
<br/>
   s16 variable5, variable6, variable7, variable8;
<br/>
   s16 variable9, variable10, variable11, variable12;
<br/>
   u16 flags;
<br/>
   void RunActorScript();
<br/>
   void Activate();
<br/>
   void Deactivate();
<br/>
   s16 ActorScript_GetVariable(u16 vartoget);
<br/>
   void ActorScript_SetVariable(u16 vartoset, s32 value);
<br/>
private:
<br/>
   u8 ActorScript_IsAVariable(s16 vartotest);
<br/>
   void ActorScript_Set(s16 var1, s16 vvar2);
<br/>
   void ActorScript_Add(s16 var1, s16 vvar2, s16 vvar3);
<br/>
   void ActorScript_Sub(s16 var1, s16 vvar2, s16 vvar3);
<br/>
   void ActorScript_Mul(s16 var1, s16 vvar2, s16 vvar3);
<br/>
   void ActorScript_Div(s16 var1, s16 vvar2, s16 vvar3);
<br/>
   void ActorScript_Mod(s16 var1, s16 vvar2, s16 vvar3);
<br/>
   void ActorScript_Inc(s16 var1);
<br/>
   void ActorScript_Dec(s16 var1);
<br/>
   void ActorScript_Rnd(s16 var1, s16 vvar2, s16 vvar3);
<br/>
   void ActorScript_MovA(s16 vvar1, s16 vvar2);
<br/>
   void ActorScript_MovR(s16 vvar1, s16 vvar2);
<br/>
   void ActorScript_Goto(s16 value);
<br/>
   u8 ActorScript_If(s16 vvar1, s16 var2, s16 vvar3);
<br/>
   void ActorScript_SendCmd(s16 var1, s16 vvar2, s16 vvar3, s16 vvar4);
<br/>
   void ActorScript_CallMacro(s16 var1);
<br/>
   void ActorScript_Return();
<br/>
   void ActorScript_GetBlockStatus(s16 vvar1, s16 vvar2, s16 var3);
<br/>
   void ActorScript_SetBlockStatus(s16 vvar1, s16 vvar2, s16 vvar3);
<br/>
   void ActorScript_Spawn(s16 var1);
<br/>
   void ActorScript_Kill(s16 var1);
<br/>
   void ActorScript_SetOtherVar(s16 vvar1, s16 vvar2, s16 vvar3);
<br/>
   void ActorScript_GetOtherVar(s16 vvar1, s16 vvar2, s16 vvar3);
<br/>
   void AdvanceScriptToEndIf();
<br/>
};</td> </tr></table><span class="postbody">
<br/>
<br/>
I would be happy to  post the entire system, but it's over 1400 lines long, and I'm not sure anyone would want to bother looking through it (if I'm wrong, and anyone is interested, I'd be more than happy to post it - it's reasonably well formated and shouldn't be too hard to get through).
<br/>
<br/>
Off the top of anyone's head, am I doing anything wrong - something that might explain why my actor system is so slow?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#28958 - sajiimori - Tue Nov 09, 2004 6:38 am</h4>
    <div class="postbody"><span class="postbody">Start with good style, and speed tends to follow.
<br/>
<br/>
Use meaningful variable names, and don't use magic numbers.
<br/>
<br/>
If you have a big repetitive pattern, like that switch statement, find the common thread and express the core idea concisely.
<br/>
<br/>
In this case, you have 2 seperate sections to the switch: accessors for variables, and accessors for flags.  Each of those can be given a simple, concise definition.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
class Actor
<br/>
{
<br/>
  public:
<br/>
    enum Var
<br/>
    {
<br/>
      VAR_TILE_X,
<br/>
      VAR_TILE_Y,
<br/>
      ...
<br/>
      VAR_MAX
<br/>
    };
<br/>
    
<br/>
    enum Flag
<br/>
    {
<br/>
      FLAG_IN_USE,
<br/>
      FLAG_NO_PAUSE,
<br/>
      ...
<br/>
      FLAG_MAX
<br/>
    };
<br/>
<br/>
    int getVar(Var v) { return vars[v]; }
<br/>
    bool getFlag(Flag f) { return flags &amp; (1 &lt;&lt; f); }
<br/>
<br/>
  private:
<br/>
    s16 vars[VAR_MAX];
<br/>
    u16 flags;
<br/>
};
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#28959 - Andor - Tue Nov 09, 2004 6:59 am</h4>
    <div class="postbody"><span class="postbody">Good style, eh? I'll have to run down to the hardware store and see if I can buy that in bulk.
<br/>
<br/>
Thanks for the suggestion, btw. I hadn't considered declaring an array of variables via an enumeration (I'm not even sure you can do that in VB); I'll go about implementing it and come back with the results.
<br/>
<br/>
If anyone is interested, btw, this is what I have done so far:
<br/>
<a class="postlink" href="http://home.comcast.net/~mithrandel/GBADev/battletest1.gba" target="_blank">http://home.comcast.net/~mithrandel/GBADev/battletest1.gba</a>
<br/>
<br/>
It's a fairly simple (and obviously incomplete) battle engine for an RPG. It may not be much, but I'm fairly proud of it for not knowing anything about GBA dev'ing three weeks ago. =P</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#28962 - allenu - Tue Nov 09, 2004 7:32 am</h4>
    <div class="postbody"><span class="postbody">Looks pretty good so far.  Keep it up!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#28964 - sajiimori - Tue Nov 09, 2004 7:47 am</h4>
    <div class="postbody"><span class="postbody">Good stuff. ^_^  The scripting system will definitely help in the long run.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#29053 - Andor - Wed Nov 10, 2004 10:04 pm</h4>
    <div class="postbody"><span class="postbody">Great! My scripting system now runs ~37% faster, and I'm positive there's still room for improvement. Nevertheless, I think this is good enough for now; I can always revise this particular subsystem later.
<br/>
<br/>
Thanks for your help, sajiimori.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
