<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>gcc -O3 problem - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>C/C++ > gcc -O3 problem</h2>
<div id="posts">
<div class="post">
    <h4>#797 - col - Fri Jan 10, 2003 6:36 pm</h4>
    <div class="postbody"><span class="postbody">hello
<br/>
<br/>
I've recently been having problems with my gba register access code.
<br/>
<br/>
Symptoms are: 
<br/>
<br/>
the game works perfect on emulators, but crashed intermittently on hardware.
<br/>
This was tracked down (thanks to VBA) to illegal word READS from the bios area!
<br/>
<br/>
It turned out that these reads were being caused by some code that uses register defines to WRITE!? to gba registers.
<br/>
<br/>
the registers are all defined in the usual manner
<br/>
#define REG_XXXX *(volatile u32*)0x04000nnn
<br/>
<br/>
After some fiddling i discovered that everything is Aok when only optimising -O2.
<br/>
<br/>
The thing is - I get a noticable performance boost using -O3, and want to keep this switched on, so does anyone know what the problem might be?
<br/>
why does -O3 think that it can optimise a write to a volatile by including a read??
<br/>
<br/>
and how can i switch this behaviour off? any ideas?
<br/>
<br/>
I'm using the latest windoze devkitadv
<br/>
<br/>
<br/>
thanks
<br/>
<br/>
col</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#825 - col - Fri Jan 10, 2003 10:41 pm</h4>
    <div class="postbody"><span class="postbody">after a little detective work, i have discovered that the culprit is
<br/>
<br/>
-finline-functions
<br/>
<br/>
so i can compile using -O2 adding -frename-registers to get -O3 without -finline-functions 
<br/>
<br/>
though why -finline-functions would cause the behaviour i described is beyond me - why would the compiler want to read a register to write to it??
<br/>
<br/>
I'm not using |= &amp;= etc just plain =
<br/>
<br/>
anyone have a clue?
<br/>
<br/>
cheers
<br/>
<br/>
col</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#3094 - mbcook - Tue Feb 18, 2003 4:51 am</h4>
    <div class="postbody"><span class="postbody">I don't know, but I do have an idea. You could basically make wrappers around the functions that are causing problems and put them in one file and compile that at O2. Then put the rest of your source in one (or more) file(s) and compile that at O3. That will keep MOST of your speed bonus, but could make things more confusing.<br/>_________________<br/>--Michael</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#3129 - siaspete - Tue Feb 18, 2003 8:33 pm</h4>
    <div class="postbody"><span class="postbody">Most registers are 16-bit, so try using u16 instead of u32 in that #define.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#3175 - jenswa - Wed Feb 19, 2003 12:52 pm</h4>
    <div class="postbody"><span class="postbody">While we are talking about O3, how to use it in my make.bat file ?
<br/>
<br/>
when i replace the o with o3, i get a lot of 'messages' during compiling.<br/>_________________<br/>It seems this wasn't lost after all.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#3181 - floatstarpx - Wed Feb 19, 2003 2:26 pm</h4>
    <div class="postbody"><span class="postbody">it has to be a capital -O
<br/>
(altho don't get rid of the lower case one either!)
<br/>
add in -O3
<br/>
<br/>
has anyone got any tips for make.bat files? any extra commands to put in the line?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#3184 - jenswa - Wed Feb 19, 2003 2:33 pm</h4>
    <div class="postbody"><span class="postbody">I'll try it home, but i thought i used capital O
<br/>
(i know i wrote little o).
<br/>
<br/>
Most people use crts scripts etc, linkscripts and makefiles,
<br/>
search those files, they contain nice information,
<br/>
but i don't how to put it in make.but, so it's better to set up
<br/>
visual studio with devkitadv and use those scripts.<br/>_________________<br/>It seems this wasn't lost after all.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
