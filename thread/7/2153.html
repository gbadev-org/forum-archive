<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>C++ and Assembly? - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>C/C++ > C++ and Assembly?</h2>
<div id="posts">
<div class="post">
    <h4>#11175 - ken2 - Sun Sep 28, 2003 6:21 am</h4>
    <div class="postbody"><span class="postbody">I use DevKitAdvance and was wondering how to put assembly in along with C code? I know you can do it, I just havent found a tutorial or explanation for it. Probably just my beginner-ness though.
<br/>
<br/>
By Assembly with C code, imean like a program thats mainly C code, but has some assembly code in for doing various stuff. not sure about this ARM command THUMB stuff, haven't done assembly for GBA before, but i've done assembly on another processor before.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#11176 - sajiimori - Sun Sep 28, 2003 6:50 am</h4>
    <div class="postbody"><span class="postbody">You can either use inline assembly (which has some quirks), or use seperate source files that are pure assembly code (which I'd recommend).
<br/>
<br/>
Anything that is so speed-critical that it needs to be in assembly should also be written in 32-bit ARM instructions, and stored in IWRAM.
<br/>
<br/>
Make a .S file for all your assembly stuff, and set it up something like this:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
.section .iwram
<br/>
.arm
<br/>
<br/>
.global function_abc
<br/>
.align 2
<br/>
function_abc:
<br/>
   // do stuff
<br/>
   bx lr
<br/>
<br/>
.global data_xyz
<br/>
.align 2
<br/>
data_xyz:
<br/>
   .word 1234
<br/>
</td> </tr></table><span class="postbody">
<br/>
Then link it in, and you can call the functions from C code.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#11197 - ken2 - Sun Sep 28, 2003 9:11 pm</h4>
    <div class="postbody"><span class="postbody">How would I go about calling the .s file function from C, and also how would I go about linking the .s into my gcc makefile for devkitadvance?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#11200 - NEiM0D - Sun Sep 28, 2003 10:22 pm</h4>
    <div class="postbody"><span class="postbody">Going forth from mr. Sajimori's code comments, here's what you would put in C to use it:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
extern void function_abc(void);
<br/>
extern short data_xyz;
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Cheers.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#11232 - sajiimori - Mon Sep 29, 2003 6:06 pm</h4>
    <div class="postbody"><span class="postbody">"gcc -c" compiles, "gcc -o &lt;outfile&gt; &lt;objfiles&gt;" links.  Nothing new here...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#11275 - torne - Wed Oct 01, 2003 12:21 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>sajiimori wrote:</b></span></td> </tr> <tr> <td class="quote">Anything that is so speed-critical that it needs to be in assembly should also be written in 32-bit ARM instructions, and stored in IWRAM.</td> </tr></table><span class="postbody">
<br/>
<br/>
I wouldn't say that was always true; GCC's Thumb code generation needs work, and you can beat it for performance without needing ARM opcodes if you know what you're doing. =)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#11281 - sajiimori - Wed Oct 01, 2003 2:52 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
GCC's Thumb code generation needs work, and you can beat it for performance without needing ARM opcodes if you know what you're doing.</td> </tr></table><span class="postbody">
<br/>
You're right of course.  My point was that if the code is so speed-critical that you're thinking about hand-coding it in assembly, there's little reason *not* to use 32-bit ARM code and put it in IWRAM (unless you're out of IWRAM, but hand-coded assembly is usually very compact).</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#11285 - torne - Wed Oct 01, 2003 10:34 am</h4>
    <div class="postbody"><span class="postbody">Not everything can be done faster in ARM, especially if you have many clever tricks *grin*. Also, my only GBA code at the moment is for an OS, and I desperately need to reserve almost every last byte of RAM for applications. =)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#11287 - tepples - Wed Oct 01, 2003 2:43 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>torne wrote:</b></span></td> </tr> <tr> <td class="quote">Not everything can be done faster in ARM, especially if you have many clever tricks *grin*</td> </tr></table><span class="postbody">
<br/>
Care to share some of these "clever tricks" in a tutorial about efficient Thumb coding? Or do you prefer to keep them a trade secret for now?<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#11291 - torne - Wed Oct 01, 2003 4:54 pm</h4>
    <div class="postbody"><span class="postbody">*grin* Sounds like a plan. I've been meaning to write some programming tutorial bits for gbadev for a while; the most important being a guide to the ARM procedure call standard (or: Why Can't I Make Calls To Asm Functions From C Work Properly). You (or other people) might want to read the value synthesis macros that I talked about, though, which I wrote in this thread originally (my first posts, too!): <a href="http://forum.gbadev.org/viewtopic.php?t=154" target="_blank">http://forum.gbadev.org/viewtopic.php?t=154</a>
<br/>
<br/>
If you are using non-default wait state settings you will need to tune the macros to make the right tradeoffs, but if you have the default settings it should be fine and guarentees always to be at least as fast as an ldr r0, =whatever instruction. The ARM analogous version of the macros are fairly obvious, though I've not actually written them (not used any significant ARM code in my project yet); I'll write them for my tutorial.
<br/>
<br/>
Note that in ARM it's normally best to access IO registers by loading 0x4000000 into some register then using preindexed offsets to reach them (unless they are beyond 0x40000FF of course). Making this kind of decision through a macro is unfortunately not possible; though it would be possible to make my high-level assembler do it. Not that I've written it yet. =)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#11293 - DekuTree64 - Wed Oct 01, 2003 5:33 pm</h4>
    <div class="postbody"><span class="postbody">Yeah, it does seem like the ASM forum gets a lot of things that could be answered by the APCS. 
<br/>
But I want clever tricks^_^ THUMB is fun, and you can usually get things to time out to where values are in the right regs at the right time so only having 2 ops per instruction doesn't cause problems, but sometimes it's just plain messy. But then if you look at it it almost always takes less actual bytes than ARM, even if you do have to go through a lot of instructions to do something simple.
<br/>
Still, I'd like to hear some stuff from someone with a lot of experience. Just call it an advanced tutorial (for lack of an equivalent, punless word), and then you can make it quick and to-the-point, and be more relaxed while writing it cause anyone reading it should have enough sense not to blindly follow any mistakes you might make from not spending hours on it.<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#11294 - torne - Wed Oct 01, 2003 5:44 pm</h4>
    <div class="postbody"><span class="postbody">I'll spend some time on it soon; right now I'm moving from one room to another in a kind of musical chairs thing at university as they cock up my accomodation arrangements multiple times consecutively. =)
<br/>
<br/>
Once the world is less hectic I'll try and share some tips.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#11785 - Tinyn - Sat Oct 18, 2003 9:59 pm</h4>
    <div class="postbody"><span class="postbody">How would I code some ASM function so that it can accept arguments from a C/C++?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#11787 - tepples - Sat Oct 18, 2003 10:22 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Tinyn wrote:</b></span></td> </tr> <tr> <td class="quote">How would I code some ASM function so that it can accept arguments from a C/C++?</td> </tr></table><span class="postbody">
<br/>
First four arguments are passed in r0-r3. The rest are passed on the stack, as described in <a class="postlink" href="http://www.cs.cornell.edu/Courses/cs414/2003fa/armcallconvention.pdf" target="_blank">ARM-Thumb Procedure Call Standard (PDF)</a>.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#11788 - DekuTree64 - Sat Oct 18, 2003 10:24 pm</h4>
    <div class="postbody"><span class="postbody">Again, this can easily be answered by the APCS. The first up to 4 arguments are passed in r0-r3, and any over that are pushed onto the stack. They go in ascending order from sp/r13, so say you have 7 args, it would go like this:
<br/>
r0-r3 = arg0-arg3, [sp] = arg4, [sp, #4] = arg5, [sp, #8] = arg7.
<br/>
<br/>
edit: Tepples beat me to it^^<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
