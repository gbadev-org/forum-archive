<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Needing help with IO - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>C/C++ > Needing help with IO</h2>
<div id="posts">
<div class="post">
    <h4>#156750 - darkchild - Tue May 13, 2008 6:31 pm</h4>
    <div class="postbody"><span class="postbody">Hey, I just released a game called memorizeME
<br/>
<br/>
Since lots of people enjoyed it.. I've been wanting to make a highscore function...but I ran into a bit of trouble, whenever I try to write something to the file, it crashes, but reading from it works!
<br/>
<br/>
What am I doing wrong here?
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
<br/>
int hiscore=0;
<br/>
void startio(void)
<br/>
{
<br/>
   PA_InitText(1,3);
<br/>
   PA_OutputText(1,0,0, "Starting FAT...");
<br/>
   fatInitDefault();
<br/>
<br/>
   PA_OutputText(1,0,1, "Reading HighScore Data..");
<br/>
   FILE* testRead = fopen ("/memorizeme.dat", "rb"); //rb = read
<br/>
   if (testRead)
<br/>
   {
<br/>
      char buffer[30];
<br/>
      fread(buffer, 30, 1, testRead);
<br/>
      
<br/>
      hiscore = atoi(buffer);
<br/>
   }
<br/>
   else
<br/>
   {
<br/>
      fclose(testRead);
<br/>
      PA_OutputText(1,0,2,"Not present! Now creating...");
<br/>
      FILE* testWrite = fopen ("/memorizeme.dat", "wb"); //wb = create/truncate &amp; write 
<br/>
      fwrite("0", 1, 1, testWrite);
<br/>
      fclose(testWrite);
<br/>
   }
<br/>
   PA_DualResetBg();
<br/>
}
<br/>
<br/>
void updatehighscore(void)
<br/>
{
<br/>
<br/>
   FILE* testwrite = fopen ("memorizeme.dat", "wb"); //wb = create/truncate &amp; write 
<br/>
   char buffer[10];
<br/>
   int n;
<br/>
   n=sprintf (buffer, "%d", hiscore);
<br/>
   fwrite(&amp;buffer, 10, 1, testwrite);
<br/>
   fclose(testwrite);
<br/>
<br/>
}
<br/>
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#156752 - simonjhall - Tue May 13, 2008 6:55 pm</h4>
    <div class="postbody"><span class="postbody">I think the "fclose(testRead)" in the else statement could the line that's causing you grief. If the file opening process failed you won't be returned a valid handle...and you then try to close that. I'd guess that's what's nuking it.
<br/>
<br/>
Just a guess ;-)<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#156758 - darkchild - Tue May 13, 2008 7:52 pm</h4>
    <div class="postbody"><span class="postbody">I don't think that's it...
<br/>
<br/>
it only crashes when you try to <span style="font-weight: bold">write</span> to the file =/</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#156759 - Dwedit - Tue May 13, 2008 7:53 pm</h4>
    <div class="postbody"><span class="postbody">your paths don't match<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#156771 - darkchild - Tue May 13, 2008 9:40 pm</h4>
    <div class="postbody"><span class="postbody">That's because I was trying to vary, thought it was the problem, but with the "\" it still crashes =/</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#156777 - simonjhall - Tue May 13, 2008 10:36 pm</h4>
    <div class="postbody"><span class="postbody">Which is the line that's crashing it then?<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#156808 - darkchild - Wed May 14, 2008 1:14 am</h4>
    <div class="postbody"><span class="postbody">the writing one xD (Fwrite)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#156820 - simonjhall - Wed May 14, 2008 7:41 am</h4>
    <div class="postbody"><span class="postbody">Which one? ;-)
<br/>
In the first one (in the else statement) can you stick in a test to ensure that the fopen worked?
<br/>
In the second one, shouldn't it be fwrite(buffer rather than fwrite(&amp;buffer? buffer is already a pointer - you shouldn't need to dereference it again.<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#156823 - Normmatt - Wed May 14, 2008 8:00 am</h4>
    <div class="postbody"><span class="postbody">why ain't you using fprintf, if you trying to write a string to a file??</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#156841 - darkchild - Wed May 14, 2008 5:58 pm</h4>
    <div class="postbody"><span class="postbody">I am now..
<br/>
<br/>
and I changed the code,
<br/>
<br/>
here's how it is now:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
int hiscore=0;
<br/>
bool fat=true;
<br/>
void startio(void)
<br/>
{
<br/>
   PA_InitText(1,3);
<br/>
   PA_OutputText(1,0,0, "Starting FAT...");
<br/>
   if (fatInitDefault() == false)
<br/>
   {
<br/>
      PA_OutputText(1,0,1, "FAT ERROR!");
<br/>
      PA_WaitFor(Stylus.Newpress || Pad.Held.A || Pad.Held.B || Pad.Held.X || Pad.Held.Y || Pad.Held.Up || Pad.Held.Down || Pad.Held.Left || Pad.Held.Right);
<br/>
      fat = false;
<br/>
   }
<br/>
   if (fat)
<br/>
   {
<br/>
      PA_OutputText(1,0,1, "Reading HighScore Data..");
<br/>
      FILE* testRead = fopen ("/memorizeme.dat", "rb"); //rb = read
<br/>
      if (testRead)
<br/>
      {
<br/>
         char buffer[30];
<br/>
         fread(buffer, 30, 1, testRead);
<br/>
         fclose(testRead);
<br/>
         hiscore = atoi(buffer);
<br/>
      }
<br/>
      else
<br/>
      {
<br/>
         PA_OutputText(1,0,2,"Not present! Now creating...");
<br/>
         FILE* testWrite = fopen ("/memorizeme.dat", "wb"); //wb = create/truncate &amp; write 
<br/>
         fwrite("0", 1, 1, testWrite);
<br/>
         fclose(testWrite);
<br/>
      }
<br/>
      PA_DualResetBg();
<br/>
   }
<br/>
}
<br/>
<br/>
void updatehighscore(void)
<br/>
{
<br/>
   if (fat)
<br/>
   {
<br/>
      FILE* testwrite = fopen ("/memorizeme.dat", "wb"); //wb = create/truncate
<br/>
      fprintf(testwrite, "%d", hiscore);/*
<br/>
      char buffer[10];
<br/>
      int n;
<br/>
      n=sprintf (buffer, "%d", hiscore);
<br/>
      fwrite(&amp;buffer, strlen(buffer), sizeof(buffer), testwrite);*/
<br/>
      fclose(testwrite);
<br/>
   }
<br/>
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
and by the looks of it, he now crashes at this line: (in the updatehighscore function)
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
      FILE* testwrite = fopen ("/memorizeme.dat", "wb"); //wb = create/truncate
<br/>
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#156855 - Dwedit - Wed May 14, 2008 9:04 pm</h4>
    <div class="postbody"><span class="postbody">out of curiosity, is it fat16 and are there lots of files in the root directory?<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#156867 - simonjhall - Wed May 14, 2008 11:07 pm</h4>
    <div class="postbody"><span class="postbody">Can you ensure that there's absolutely nothing else breaking the code, by just sticking in the fopen that you think breaks it in a program with nothing else but the bare minimum?<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#156869 - darkchild - Wed May 14, 2008 11:31 pm</h4>
    <div class="postbody"><span class="postbody">It's FAT32....
<br/>
and OMG! I put the code in main.c before anything else started, and it wrote! :|
<br/>
<br/>
What could be making this? =/</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#156873 - silent_code - Thu May 15, 2008 12:34 am</h4>
    <div class="postbody"><span class="postbody">i get this type of behaviour all the time when working with win32 windows... it's so annoying! the right order of things is *everything* in those cases.
<br/>
i hope you find a solution very soon. :^)
<br/>
<br/>
happy coding!<br/>_________________<br/><span style="font-size: 9px; line-height: normal"><span style="text-decoration: underline"><span style="font-weight: bold"></span></span> July 5th 08: "<span style="font-weight: bold">Volumetric Shadow Demo</span>" 1.6.0 (final) source released
<br/>
June 5th 08: "<span style="font-weight: bold">Zombie NDS</span>" WIP released!
<br/>
It's all on my page, just click <span style="font-weight: bold">WWW</span> below.</span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#156883 - darkchild - Thu May 15, 2008 1:55 am</h4>
    <div class="postbody"><span class="postbody">then what is your advice?
<br/>
<br/>
Should he write as soon as a new highscore is detected BEFORE showing all the GFX?
<br/>
<br/>
(Would these things stop if I were using linux?)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#156885 - yellowstar - Thu May 15, 2008 4:25 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>darkchild wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
void startio(void)
<br/>
{
<br/>
   if (fat)
<br/>
   {
<br/>
      PA_OutputText(1,0,1, "Reading HighScore Data..");
<br/>
      FILE* testRead = fopen ("/memorizeme.dat", "rb"); //rb = read
<br/>
      if (testRead)
<br/>
      {
<br/>
         char buffer[30];
<br/>
         fread(buffer, 30, 1, testRead);
<br/>
         fclose(testRead);
<br/>
         hiscore = atoi(buffer);
<br/>
      }
<br/>
      else
<br/>
      {
<br/>
         PA_OutputText(1,0,2,"Not present! Now creating...");
<br/>
         FILE* testWrite = fopen ("/memorizeme.dat", "wb"); //wb = create/truncate &amp; write 
<br/>
         fwrite("0", 1, 1, testWrite);
<br/>
         fclose(testWrite);
<br/>
      }
<br/>
   }
<br/>
}
<br/>
<br/>
void updatehighscore(void)
<br/>
{
<br/>
   if (fat)
<br/>
   {
<br/>
      FILE* testwrite = fopen ("/memorizeme.dat", "wb"); //wb = create/truncate
<br/>
      fprintf(testwrite, "%d", hiscore);/*
<br/>
      char buffer[10];
<br/>
      int n;
<br/>
      n=sprintf (buffer, "%d", hiscore);
<br/>
      fwrite(&amp;buffer, strlen(buffer), sizeof(buffer), testwrite);*/
<br/>
      fclose(testwrite);
<br/>
   }
<br/>
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
and by the looks of it, he now crashes at this line: (in the updatehighscore function)
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
      FILE* testwrite = fopen ("/memorizeme.dat", "wb"); //wb = create/truncate
<br/>
<br/>
</td> </tr></table><span class="postbody"></span></td> </tr></table><span class="postbody">
<br/>
<br/>
That test string you're trying to write, it's actually 2 bytes long, including the terminating null character. wb/rb is only for binary, you're trying to use text with it. Switch it to just w. And you should check if opening succeeded - I use if(f==NULL)return;(Switch the f to testwrite in your case)
<br/>
<br/>
If that didn't fix it, what exactly is happening? Program hangs, or Red screens of Death?(Red screen with white error message on top)
<br/>
Does the file even get created?
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
(Would these things stop if I were using linux?)
<br/>
</td> </tr></table><span class="postbody">
<br/>
No. silent_code was referring to programming programs for PC, not NDS.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#156901 - simonjhall - Thu May 15, 2008 5:24 pm</h4>
    <div class="postbody"><span class="postbody">Last time I checked, libfat didn't support text mode reading/writing so internally it all defaults to rb/wb.
<br/>
And you really need to pull apart the program into the bare minimum in order to make it crash. Until then you can only guess what line is breaking, as even though a given line may not crash it may break some other part of the program causing the apparent crash at that line.<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#156902 - darkchild - Thu May 15, 2008 5:52 pm</h4>
    <div class="postbody"><span class="postbody">The file got created (when I put in the beginning of main.c for him to write)
<br/>
but whenever I try it somewhere else... crashes! (or hangs, whatever term you prefer)
<br/>
<br/>
@Simonjhall:
<br/>
I made a PA_OutputText for each line in my IO.C (where the IO code is at) and he doesn't get passed the opening one!</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
