<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Implementing state machine? - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>C/C++ > Implementing state machine?</h2>
<div id="posts">
<div class="post">
    <h4>#10831 - Ruiner - Wed Sep 17, 2003 4:35 pm</h4>
    <div class="postbody"><span class="postbody">Everything I have read in gba development says avoid virtual like the plague. But I have always used this kind of algorithm for state machines in my game. 
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
// Class GameState
<br/>
{
<br/>
   public bool m_Active;
<br/>
   public GameState()
<br/>
   public virtual void Update()
<br/>
   public virtual void Close()
<br/>
}
<br/>
<br/>
// Init game state
<br/>
GameState CurrentState;
<br/>
CurrentState = InventoryScreen.GetInstance;
<br/>
    
<br/>
// Game loop
<br/>
{
<br/>
    ProcessInput();
<br/>
    CurrentState.Update();
<br/>
    Flip();
<br/>
}    
<br/>
</td> </tr></table><span class="postbody">
<br/>
My question is that if this is as bad as everyone makes it sound then what is the efficient way of getting around it?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#10832 - niltsair - Wed Sep 17, 2003 4:40 pm</h4>
    <div class="postbody"><span class="postbody">Use function pointers.
<br/>
<a class="postlink" href="http://forum.gbadev.org/viewtopic.php?t=1459&amp;highlight=void%2A+function+pointer" target="_blank">http://forum.gbadev.org/viewtopic.php?t=1459&amp;highlight=void%2A+function+pointer</a>
<br/>
<a class="postlink" href="http://forum.gbadev.org/viewtopic.php?t=1734&amp;highlight=void%2A+function+pointer" target="_blank">http://forum.gbadev.org/viewtopic.php?t=1734&amp;highlight=void%2A+function+pointer</a><br/>_________________<br/>-Inside every large program is a small program struggling to get out. (Hoare's Law of Large Programs)
<br/>
-The man who can smile when things go wrong has thought of someone he can blame it on. (Nixon's Theorem)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#10833 - tom - Wed Sep 17, 2003 6:02 pm</h4>
    <div class="postbody"><span class="postbody">uhh...you know, basically a virtual function results in a call via a pointer, which is pulled out of the object's virtual function table - the difference is, you don't have to mess around with function pointers yourself, instead the compiler will do it for you.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#10834 - sajiimori - Wed Sep 17, 2003 6:13 pm</h4>
    <div class="postbody"><span class="postbody">tom,
<br/>
<br/>
If I recall correctly, the concern was that some compilers for gba do not handle virtuals correctly.  Not sure which ones, as I haven't used C++ on gba...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#10835 - tom - Wed Sep 17, 2003 6:25 pm</h4>
    <div class="postbody"><span class="postbody">sajimori: can't tell neither, i usually use c too, simply because i like it. if there was a bug with virtual functions, this would be a reason not to use them.
<br/>
<br/>
anyway, another reason people often bring up is that virtual function calls are slower than normal element function calls, which is of course true, but then replacing them with handcoded function pointers wouldn't give you anything (except more work=)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#10836 - niltsair - Wed Sep 17, 2003 6:48 pm</h4>
    <div class="postbody"><span class="postbody">No, the problem with virtual function is that is has to look it up in a table first. To my knowledge, function pointer don't generate slowdown (correct me if I'm wrong).<br/>_________________<br/>-Inside every large program is a small program struggling to get out. (Hoare's Law of Large Programs)
<br/>
-The man who can smile when things go wrong has thought of someone he can blame it on. (Nixon's Theorem)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#10837 - Sweex - Wed Sep 17, 2003 6:55 pm</h4>
    <div class="postbody"><span class="postbody">I've been using virtual functions throughout my code and haven't noticed any problems with them yet. As Niltsair pointed out the "problem" with virtual functions is that it will take a little bit of time to look up the correct function from the vtable before calling it. The impact of this is only minimal but you might want to avoid it when you have a lot of calls to virtual functions.
<br/>
<br/>
(Personally I don't care too much about the minimal vtable overhead as it makes programming a lot easier!)<br/>_________________<br/>If everything fails, read the manual: If even that fails, post on forum!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#10839 - sajiimori - Wed Sep 17, 2003 7:26 pm</h4>
    <div class="postbody"><span class="postbody">niltsair,
<br/>
<br/>
You're wrong. ;-)  The added indirection of a function pointer vs a regular function call usually adds 1 or 2 instructions, depending on the architecture.
<br/>
<br/>
Virtuals are usually the same as function pointers, speed wise.  They are the same on x86 when using gcc 3.x, but I don't know about ARM7.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#10841 - niltsair - Wed Sep 17, 2003 7:47 pm</h4>
    <div class="postbody"><span class="postbody">sajiimori -&gt; Yeah, I guessed that there was 1 indirection overhead, which shouldn't lower performance badly. Also, I was hoping that the arm achitecture supported jump statement with one indirection :-)
<br/>
<br/>
But the problem with virtual is that you have to add one step over pointers, to find the actual pointers. Don't know how much of a slow down it is though.<br/>_________________<br/>-Inside every large program is a small program struggling to get out. (Hoare's Law of Large Programs)
<br/>
-The man who can smile when things go wrong has thought of someone he can blame it on. (Nixon's Theorem)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#10842 - torne - Wed Sep 17, 2003 8:30 pm</h4>
    <div class="postbody"><span class="postbody">It depends where your vtable is. Remember, a 32-bit read from ROM takes 8 cycles with default wait state settings, thus, the additional indirection could take that long.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#10847 - col - Wed Sep 17, 2003 10:57 pm</h4>
    <div class="postbody"><span class="postbody">Ruiner, the speed comparison between virtual functions and pointers is a bit of a red herring IMO.
<br/>
<br/>
I would suggest that you don't use classes to represent your states.
<br/>
A simpler and more efficient way is to have each state represented by a function !
<br/>
<br/>
the active state is a pointer to function (or member function depending on the design)
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
<br/>
// Class GameState 
<br/>
{ 
<br/>
   public bool m_Active; 
<br/>
   public GameState() 
<br/>
   public virtual void Update() 
<br/>
   public virtual void Close() 
<br/>
} 
<br/>
<br/>
// Init game state 
<br/>
GameState CurrentState; 
<br/>
CurrentState = InventoryScreen.GetInstance; 
<br/>
    
<br/>
// Game loop 
<br/>
{ 
<br/>
    ProcessInput(); 
<br/>
    CurrentState.Update(); 
<br/>
    Flip(); 
<br/>
}     
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
instead use something like:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
class Game{
<br/>
private:
<br/>
    //declare state as a pointer to member function
<br/>
    (void)(Game::*state)();
<br/>
<br/>
    //state funcions
<br/>
    void inventoryScreen(){
<br/>
        .....
<br/>
    };
<br/>
    void inGame(){
<br/>
        ....
<br/>
        if(pressed inventory key){    //switch state
<br/>
            state = &amp;Game::inventoryScreen;
<br/>
        }
<br/>
    };
<br/>
    void someOtherState(){
<br/>
        ....
<br/>
    };
<br/>
<br/>
public:
<br/>
    update(){ this-&gt;*state(); }; //call via pointer to member func
<br/>
    Game()    :    state(&amp;Game::inGame){
<br/>
    };
<br/>
}
<br/>
<br/>
// Game loop 
<br/>
{ 
<br/>
    ProcessInput(); 
<br/>
    Game.Update(); 
<br/>
    ...
<br/>
} 
<br/>
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
[edit]
<br/>
I forgot to mention, to use pointers to member functions, you need the latest devkitadv.
<br/>
Its just as easy to do the same thing using static member functions and explicitly passing an instance pointer to the state function - you just need a slighlty different pointer syntax.
<br/>
[/edit]
<br/>
<br/>
cheers
<br/>
<br/>
col</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#10875 - Darkain - Thu Sep 18, 2003 8:36 pm</h4>
    <div class="postbody"><span class="postbody">there is nothing rong w/ using virtual functions.  the only problem is in some versions of GCC, it cant handle overriding multiple virtual functions.  what this means is if you got virtual a() in class x and y, and then z inherits from both x and y, and you try to override virtual a(), it would only override it for one, but not both.
<br/>
<br/>
my entire game engine is all based around a class structure with a nice sound vitual table and inheritance.  upon object creation, its base pointer is added to a pointer list, and from there, every instance of the said class is called upon when needed.  this is a great way to handle multiple animations at one time, or multiple classes all accepting key input.  :)<br/>_________________<br/>-=- Darkain Dragoon -=-
<br/>
<a class="postlink" href="http://www.darkain.com" target="_blank">http://www.darkain.com</a>
<br/>
<a class="postlink" href="http://ds.darkain.com/hack" target="_blank">DarkStar</a> for <a class="postlink" href="http://ds.darkain.com" target="_blank">Nintendo DS</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#10877 - sajiimori - Thu Sep 18, 2003 10:26 pm</h4>
    <div class="postbody"><span class="postbody">Sounds like the "Listener" pattern from the GoF.  I really liked using it, but I had some design issues regarding object ownership.
<br/>
<br/>
For instance, if I have Animation objects that "subscribe" to an Animator, who is in charge?  When an Animation is deleted, does it need to unsubscribe, and thus know about Animator?  If so, there's a co-dependency that causes ambiguities in object ownership.
<br/>
<br/>
Maybe that doesn't sound like much of a problem, but it starts getting hairy when the Animation is dependent on a Sprite, and the Sprite has to stop it's Animations when it's destroyed or else the Animation will have a dangling pointer, etc.
<br/>
<br/>
It sort of ruins the whole "encapsulation" part of OO, so I end up making Manager classes (to disambiguate ownership), which just means more code that's unrelated to what I want to do.  Class explosions, maintenance nightmare...
<br/>
<br/>
That's not to say OO doesn't work, but I've definitely stopped trying to adhere to one particular design philosophy.  Now I'm ranting, so I'll leave it at that ;-)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#10919 - KashinKoji - Sat Sep 20, 2003 10:55 am</h4>
    <div class="postbody"><span class="postbody">col took the words right out of my mouth. My entry for the compo is designed in a way that looks almost exactly like his example. 
<br/>
<br/>
I used not just function pointers for game states, but also for individual object states as well, which let me manage the object instantiations really easily with great autonomy and interaction. It was intuitive for me, and the OO approach definitely helps when the project you are working on keeps expanding, but it certainly isn't the only way to go about it I'm sure.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
