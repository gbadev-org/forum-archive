<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Full C++ - with exceptions - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>C/C++ > Full C++ - with exceptions</h2>
<div id="posts">
<div class="post">
    <h4>#2510 - Raz - Wed Feb 05, 2003 12:42 pm</h4>
    <div class="postbody"><span class="postbody">I am trying to get a test project to work using C++ with exceptions supported. Without wanting to start another C++ v. C debate, I am looking to get a makefile together that will:
<br/>
a) compile C++ code (done)
<br/>
b) allow me to use exceptions
<br/>
<br/>
The latter eludes me until now, and I haven't been able to find any pointers (google, etc.) on how to make this work. 
<br/>
<br/>
I have some code that compiles a try|catch arrangement, but on running it in VisualBoyAdvance, it seems to be bombing out. 
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">int main ()
<br/>
{
<br/>
   print ("start\n");
<br/>
   int i = 0;
<br/>
<br/>
   try 
<br/>
   {
<br/>
      print ("throw\n");
<br/>
      throw 1;
<br/>
   }
<br/>
   catch (...)
<br/>
   {
<br/>
      print ("caught\n");
<br/>
   }
<br/>
   
<br/>
   if (i == 1)
<br/>
   {
<br/>
      print ("loop == 1\n");
<br/>
   }
<br/>
   else
<br/>
   {
<br/>
      print ("loop != 1\n");
<br/>
   }
<br/>
<br/>
   while (1);
<br/>
<br/>
   return 0;
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
This generates text in the logging window saying
<br/>
<br/>
start
<br/>
throw
<br/>
start
<br/>
throw
<br/>
...
<br/>
...
<br/>
<br/>
Anyone have any ideas....
<br/>
<br/>
Cheers,
<br/>
- raz</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#2512 - siaspete - Wed Feb 05, 2003 2:42 pm</h4>
    <div class="postbody"><span class="postbody">Hey Raz,
<br/>
<br/>
I get the same thing. Using a simple program that just throws a char*, and tries to catch it, it looks like as soon as execution reaches the "throw", the program resets.
<br/>
<br/>
Perhaps G++ is putting nonsense in the stack?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#2516 - col - Wed Feb 05, 2003 4:37 pm</h4>
    <div class="postbody"><span class="postbody">Is gcc trying to switch the cpu from user mode into a privileged mode? - which is not allowed on the gba! (afair anyone?)
<br/>
<br/>
Check the generated assembly for writes to bits 0-4 of the CPSR (program status register)
<br/>
<br/>
cheers
<br/>
<br/>
col</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#3218 - Raz - Thu Feb 20, 2003 2:40 pm</h4>
    <div class="postbody"><span class="postbody">Ok, I have tried it some more but to no avail... My ARM/ASM skills are zero, so any help is appreciated in making sense of this. I have the following code and translation in ASM:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">int main ()
<br/>
{
<br/>
   try 
<br/>
   {
<br/>
      throw 1;
<br/>
   }
<br/>
   catch (...)
<br/>
   {
<br/>
      while (1);
<br/>
   }
<br/>
   while (1);
<br/>
<br/>
   return 0;
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
This is then translated into the following ASM:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">@ Generated by gcc 3.0.2 (DevKit-Advance) for ARM/elf
<br/>
   .file   "main.cpp"
<br/>
   .code   16
<br/>
   .text
<br/>
   .align   2
<br/>
   .global   main
<br/>
   .thumb_func
<br/>
   .type   main,function
<br/>
main:
<br/>
   push   {r4, r5, r6, r7, lr}
<br/>
   mov   r7, fp
<br/>
   mov   r6, sl
<br/>
   mov   r5, r9
<br/>
   mov   r4, r8
<br/>
   push   {r4, r5, r6, r7}
<br/>
   mov   r7, sp
<br/>
   sub   sp, sp, #48
<br/>
   ldr   r3, .L21
<br/>
   mov   r2, #20
<br/>
   neg   r2, r2
<br/>
   str   r3, [r2, r7]
<br/>
   ldr   r3, .L21+4
<br/>
   add   r2, r2, #4
<br/>
   str   r3, [r2, r7]
<br/>
   mov   r3, #12
<br/>
   neg   r3, r3
<br/>
   str   r7, [r3, r7]
<br/>
   ldr   r3, .L21+8
<br/>
   add   r2, r2, #8
<br/>
   str   r3, [r2, r7]
<br/>
   mov   r3, sp
<br/>
   sub   r2, r7, #4
<br/>
   str   r3, [r2]
<br/>
   mov   r0, r7
<br/>
   sub   r0, r0, #44
<br/>
   bl   _Unwind_SjLj_Register
<br/>
   bl   __gccmain
<br/>
   mov   r0, #4
<br/>
   bl   __cxa_allocate_exception
<br/>
   mov   r3, #1
<br/>
   str   r3, [r0]
<br/>
   mov   r2, #48
<br/>
   neg   r2, r2
<br/>
   ldr   r2, [r2, r7]
<br/>
   str   r3, [r2]
<br/>
   ldr   r1, .L21+12
<br/>
   mov   r2, #0
<br/>
   bl   __cxa_throw
<br/>
.L20:
<br/>
   
<br/>
   .code   16
<br/>
   mov   r3, #36
<br/>
   neg   r3, r3
<br/>
   ldr   r0, [r3, r7]
<br/>
   bl   __cxa_begin_catch
<br/>
.L6:
<br/>
   b   .L6
<br/>
.L22:
<br/>
   .align   2
<br/>
.L21:
<br/>
   .word   __gxx_personality_sj0
<br/>
   .word   .LLSDA0
<br/>
   .word   .L20
<br/>
   .word   _ZTIi
<br/>
.L1:
<br/>
.Lfe1:
<br/>
   .size   main,.Lfe1-main
<br/>
   .section .gcc_except_table,"aw"
<br/>
   .align   2
<br/>
.LLSDA0:
<br/>
   .byte   0xff
<br/>
   .byte   0x0
<br/>
   .byte   0xd
<br/>
   .byte   0x3
<br/>
   .byte   0x2
<br/>
   .byte   0x0
<br/>
   .byte   0x1
<br/>
   .byte   0x1
<br/>
   .byte   0x0
<br/>
   .align   2
<br/>
   .word   0
<br/>
<br/>
   .text
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
What does it all mean (short course in ASM probably!). There are all kinds of references to structures and calls that are exception related, but still the behaviour is not as expected. It may run on GBA hardware, because I run all of this in VBA. 
<br/>
<br/>
Any GBA Gurus about....
<br/>
<br/>
- Raz</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#3222 - col - Thu Feb 20, 2003 5:14 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Raz wrote:</b></span></td> </tr> <tr> <td class="quote">Ok, I have tried it some more but to no avail... My ARM/ASM skills are zero, so any help is appreciated in making sense of this. I have the following code and translation in ASM:
<br/>
...
<br/>
- Raz</td> </tr></table><span class="postbody">
<br/>
<br/>
There aren't any writes to CPSR register in that asm - what about: __cxa_throw
<br/>
__cxa_begin_catch
<br/>
etc...
<br/>
<br/>
maybe one of those functions is the culprit? - it's just as likely to be nothing to do with this though...
<br/>
<br/>
here's another stab in the dark :)
<br/>
What Linkscript are you using? does it set up the gcc exception table properly? 
<br/>
Or is it the table just being left left un-initialised as zeros - which would explain the resets described by siaspete...
<br/>
<br/>
<br/>
cheers
<br/>
<br/>
col.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#3229 - siaspete - Thu Feb 20, 2003 6:50 pm</h4>
    <div class="postbody"><span class="postbody">Hmm, I'm not explicitly using a linkscript, just however DevkitAdvance sets things up. I'll have a mess with it tonight, see if I can do anything about it.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#3464 - Raz - Tue Feb 25, 2003 12:46 pm</h4>
    <div class="postbody"><span class="postbody">Well, I managed to get it to work. Now I'll try to explain what happened but my knowledge isn't very deep. Maybe someone else can supply some details? Using GDB I found it would bail on specific instructions. That got me to start thinking about the whole THUMB/ARM/Interwork thing. 
<br/>
<br/>
So I tried out different combinations of '-mthumb', etc. settings for the compilation step, the link step and using the specific crtbegin.o and crtend.o files. Presto! During trying the different combinations, it would get further through the code, and at one point GDB reported a SIGILL (illegal instruction). A bit like working blind, as I don't ASM, but I guess you have to start somewhere ;) 
<br/>
<br/>
Short answer therefore is to start using only '-mthumb-interwork' for compilation and linking, as well as explicitly picking 'crtbegin.o' and 'crtend.o' files from $devkitadv$\lib\gcc-lib\arm-agb-elf\3.0.2\interwork. It will <span style="text-decoration: underline">not</span> work with '-mthumb' enabled!
<br/>
<br/>
I used to have '-mthumb -mthumb-interwork' as default (copied it from others), no linkscript, no crt0.s, same as siaspete. I am still trying to find out more about it, but for the moment I think it was basically illegal instructions from a clash between ARM and THUMB code. 
<br/>
<br/>
I use:
<br/>
<ul>Lnkscript 1.3 (Frohwein)
<br/>
crt0.S v1.28 (Frohwein) - .equ __CPPSupport, 1 uncommented
<br/>
crtbegin.o/crtend.o - from $devkitadv$\lib\gcc-lib\arm-agb-elf\3.0.2\interwork
<br/>
</ul>
<br/>
<br/>
<span style="text-decoration: underline">Build.bat</span>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">PATH=D:\DevKitAdv\bin
<br/>
<br/>
g++ -g -c -Wall -Werror -O1 -mthumb-interwork -o main.o main.cpp  
<br/>
g++ -g -c -Wall -Werror -O1 -mthumb-interwork -o crt0.o crt0.s 
<br/>
<br/>
g++ -T lnkscript -nostartfiles -mthumb-interwork -o gba.elf crtbegin.o crtend.o crt0.o main.o -Lstdc++ -Lstdsupc++</td> </tr></table><span class="postbody">
<br/>
<br/>
<span style="text-decoration: underline">main.cpp</span>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">//! print - THUMB code - from Forgotten
<br/>
//! http://vboy.emuhq.com/
<br/>
void print(char *s)
<br/>
{
<br/>
   asm volatile("mov r0, %0;"
<br/>
           "swi 0xff;"
<br/>
      : // no output
<br/>
      : "r" (s)
<br/>
      : "r0");
<br/>
}
<br/>
<br/>
<br/>
//! Main entry point
<br/>
int main ()
<br/>
{
<br/>
   print ("start\n");
<br/>
   try
<br/>
   {
<br/>
      print ("throw\n");
<br/>
      int i = 1;
<br/>
      throw i;
<br/>
   }   
<br/>
   catch (...)
<br/>
   {
<br/>
      print ("catch\n");
<br/>
      while(1);   
<br/>
   }
<br/>
<br/>
   print("further\n");
<br/>
   while(1);
<br/>
<br/>
   return 0;
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Well, I am happy that it works. As soon as I understand it better, I will post something more. That will involve some more playing around with it tho... 
<br/>
<br/>
Thanks guys,
<br/>
<br/>
- Raz</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#3492 - mbcook - Wed Feb 26, 2003 12:55 am</h4>
    <div class="postbody"><span class="postbody">May I ask why you need exceptions? I was always tought that they were to help you out when you prompt for the user to inter an int and they type "mary" or when you have to load classes on the fly and you need to be able to catch anything, etc. So on a closed system like the GBA where you know what's going to happen, why would you ever need them?
<br/>
<br/>
Just wondering. I don't do much programming. While I do know OF exections, I've never used.<br/>_________________<br/>--Michael</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#3504 - siaspete - Wed Feb 26, 2003 8:20 am</h4>
    <div class="postbody"><span class="postbody">On a small system like the GBA, memory allocation in particular can fail. "new" should throw an exception on failure, so if it's not supported your app will crash instead of allowing you to catch the exception and put up a sensible error message.
<br/>
<br/>
I also find it a much nicer system to use for signalling errors, as opposed to passing return codes around.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#3511 - Raz - Wed Feb 26, 2003 11:41 am</h4>
    <div class="postbody"><span class="postbody">Exceptions allow you to separate normal code from error handling code. siaspete's memory allocation example is quite good. If you want some background, there is a good article at flipcode (<a class="postlink" href="http://www.flipcode.com/tutorials/tut_exceptions.shtml" target="_blank">http://www.flipcode.com/tutorials/tut_exceptions.shtml</a>). Normally exceptions aren't used on embedded systems or on the GBA, as they increase the size of the executable, etc.
<br/>
<br/>
The real reason why I want to use exceptions is that I want to use CppUnit (<a class="postlink" href="http://cppunit.sourceforge.net/" target="_blank">http://cppunit.sourceforge.net/</a>), a testing framework, to help me develop on the GBA. It isn't really well suited to the GBA, it requires exceptions and streams. 
<br/>
<br/>
- Raz</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#3535 - mbcook - Wed Feb 26, 2003 8:06 pm</h4>
    <div class="postbody"><span class="postbody">Memory problems. DUH. I should have thought of that. Oh well, back to being an idiot for me :)<br/>_________________<br/>--Michael</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#5911 - Jason Wilkins - Mon May 12, 2003 7:28 pm</h4>
    <div class="postbody"><span class="postbody">This is an old post, but I would like to take a look a why this did not work.  It may very well be that it will work out of the box with DevKit Advance R5.<br/>_________________<br/><a href="http://devkitadv.sourceforge.net" target="_blank">http://devkitadv.sourceforge.net</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#6308 - MojoJojo - Thu May 22, 2003 6:55 pm</h4>
    <div class="postbody"><span class="postbody">Exceptions can be used for more than just error handling. They allow you to unroll your stack quickly. Which can be used to speed up certain algorithms, and save space, in certain situations.
<br/>
<br/>
Although you should probably unroll any algorithm that requires much recursion on the GBA.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#6617 - Jason Wilkins - Fri May 30, 2003 5:01 pm</h4>
    <div class="postbody"><span class="postbody">In my recent investigation into some memory allocation problems with C++, the test program someone sent me used exceptions to catch bad_alloc (thrown by new).  It worked perfectly well.  So, if you want exceptions to work, they appear to work just fine in DevKit Advance R5.<br/>_________________<br/><a href="http://devkitadv.sourceforge.net" target="_blank">http://devkitadv.sourceforge.net</a></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
