<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Undefined reference to CpuFastSet - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>C/C++ > Undefined reference to CpuFastSet</h2>
<div id="posts">
<div class="post">
    <h4>#79780 - phoenixj91 - Sat Apr 15, 2006 11:31 pm</h4>
    <div class="postbody"><span class="postbody">I'm trying out the code from Day 4 of the PERN project. I went through and corrected the names of all the register constants, which were almost all incorrect in the tutorial (BGCOLOR_256 instead of BGCOLOR256, for instance). I got everything except for CpuFastSet. Here's what returns when I compile:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
&gt;build.bat
<br/>
main.o(.text+0xba): In function `main':
<br/>
C:\Projects\Chronofox/main.c:14: undefined reference to `CpuFastSet'
<br/>
main.o(.text+0xc6):C:\Projects\Chronofox/main.c:15: undefined reference to `CpuFastSet'
<br/>
collect2: ld returned 1 exit status
<br/>
arm-elf-objcopy: 'Chronofox.elf': No such file
<br/>
ROM fixed!
<br/>
Could Not Find C:\Projects\Chronofox\Chronofox.elf
<br/>
Chronofox compiled successfuly
<br/>
&gt;Exit code: 1
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Here's my code (truncated to the parts that matter):
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
//Main program loop
<br/>
#include "gba.h"
<br/>
#include "functions.h"
<br/>
<br/>
int main(){ //Begin program
<br/>
   initoam(); //Clear sprite memory 
<br/>
   SetMode(MODE_0 | BG2_ENABLE | OBJ_ENABLE | OBJ_MAP_1D); //Set screenmode
<br/>
<br/>
   u16*  vrammap = (u16*)SCREEN_BASE_BLOCK(31);
<br/>
   u16*  vramtiles = (u16*)MAP_BASE_BLOCK(0);
<br/>
   REG_BG2CNT= BG_COLOR_256 | ROTBG_SIZE_128x128 | WRAPAROUND | (31&lt;&lt;SCREEN_SHIFT) | (0 &lt;&lt; CHAR_SHIFT);
<br/>
   CpuFastSet(vrammap,testmap,16*16/4);
<br/>
   CpuFastSet(vramtiles,checker,64/4); //testmap and checker are defined in functions.h
<br/>
<br/>
        while(1){}
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I checked it all out and gba_bios.h is getting included in the project and everything, but the function is still not recognized. Do I have to include an external assembler file in my project or something?
<br/>
Sorry for being clueless ;_;</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#79806 - tepples - Sun Apr 16, 2006 1:51 am</h4>
    <div class="postbody"><span class="postbody">Are you remembering to link in libgba (use option -lgba ) when you build the .elf file? Please list build.bat.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#79808 - phoenixj91 - Sun Apr 16, 2006 1:55 am</h4>
    <div class="postbody"><span class="postbody">build.bat:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">@echo off
<br/>
REM just add  .c file and  .o file to the next two lines 
<br/>
<br/>
set CFILES=main.c 
<br/>
set OFILES=main.o 
<br/>
set STATICO=spriteData.o spritePalette.o
<br/>
<br/>
set GAME=Chronofox
<br/>
set SPECS=gba_mb.specs
<br/>
<br/>
set DEVDIR=C:\Devkitarm
<br/>
<br/>
PATH=%DEVDIR%\bin;%path%
<br/>
<br/>
REM set our paths so the linker knows were to look for the libs
<br/>
set LIBDIR= %DEVDIR%\arm-elf\lib\interwork
<br/>
set LIBDIR2= %DEVDIR%\libgba\lib
<br/>
<br/>
REM set our include directories so the compiler can find our include files
<br/>
set INCDIR= %DEVDIR%\arm-elf\include
<br/>
set INCDIR2= %DEVDIR%\include\gba
<br/>
<br/>
REM the compiler and linker flags
<br/>
set CFLAGS= -I.  -I%INCDIR% -I%INCDIR2% -c -g -O2 -Wall -mcpu=arm7tdmi -mtune=arm7tdmi -fomit-frame-pointer -ffast-math -mthumb -mthumb-interwork 
<br/>
<br/>
set LDFLAGS=  -mthumb -mthumb-interwork -specs=%SPECS% -L%LIBDIR% -L%LIBDIR2%  
<br/>
<br/>
REM Splice and convert the sprites
<br/>
pcx2sprite .\pxart\crfoxsheet1.pcx -i:sprite -w:16 -h:32
<br/>
<br/>
REM Compile the cfiles
<br/>
arm-elf-gcc  %CFILES% %CFLAGS%
<br/>
<br/>
REM link the o files
<br/>
arm-elf-gcc -o %GAME%.elf  %STATICO% %OFILES% %LDFLAGS% 
<br/>
<br/>
REM gcc produces .elf exicutables...objcopy to .gba
<br/>
arm-elf-objcopy -v -O binary %game%.elf %game%.gba
<br/>
<br/>
gbafix %game%.gba
<br/>
<br/>
REM remove all the ofiles
<br/>
del %OFILES%
<br/>
del %game%.elf
<br/>
<br/>
echo %GAME% compiled successfuly
<br/>
C:\projects\gba\vba.exe %GAME%.gba</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#79809 - phoenixj91 - Sun Apr 16, 2006 1:58 am</h4>
    <div class="postbody"><span class="postbody">=-o
<br/>
It worked, thanks a bunch tepples!!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#79895 - phoenixj91 - Sun Apr 16, 2006 11:33 pm</h4>
    <div class="postbody"><span class="postbody">New problem:
<br/>
CpuFastSet doesn't do anything. I only began to get tiles show up after using a for loop instead. Even then, I still had trouble. Here's my code:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">   SetMode(MODE_0 | BG2_ENABLE | OBJ_ENABLE | OBJ_MAP_1D); //Set screenmode
<br/>
<br/>
   u16*  vrammap = (u16*)SCREEN_BASE_BLOCK(31);
<br/>
   u16*  vramtiles = (u16*)MAP_BASE_BLOCK(0);
<br/>
   REG_BG2CNT= BG_COLOR_256 | ROTBG_SIZE_128x128 | WRAPAROUND | (31&lt;&lt;SCREEN_SHIFT) | (0 &lt;&lt; CHAR_SHIFT);
<br/>
<br/>
   //CpuFastSet(vrammap,testmap,sizeof(testmap));
<br/>
   //CpuFastSet(vramtiles,checker,64/4);
<br/>
   //CpuFastSet(BGPaletteMem,bgpalettecopy,sizeof(bgpalettecopy));
<br/>
   int t;
<br/>
   for(t=0;t&lt;3;t++){BGPaletteMem[t]=bgpalettecopy[t];}
<br/>
   for(t=0;t&lt;256;t++){vrammap[t]=testmap[t];}
<br/>
   for(t=0;t&lt;64;t++){vramtiles[t]=checker[t];}
<br/>
</td> </tr></table><span class="postbody">
<br/>
"testmap" is basicly a 256 char array consisting entirely of 0s
<br/>
"bgpalettecopy" is a 3 int long array which looks like this:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">unsigned int bgpalettecopy[3]={RGB16(31,0,0),RGB16(31,31,31),RGB16(0,0,0)};</td> </tr></table><span class="postbody">
<br/>
"checker" is a array of 64 chars forming a checkerboard pattern that should look like this:
<br/>
<a href="http://xs77.xs.to/pics/06161/ch1.gif">[Images not permitted - Click here to view it]</a>
<br/>
However, this all ends up looking like this:
<br/>
<a href="http://xs77.xs.to/pics/06161/scdump.gif">[Images not permitted - Click here to view it]</a>
<br/>
The palette does get loaded successfuly and the map seems to as well (through VBA's map and palette viewer)
<br/>
What am I doing wrong?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#79899 - Cearn - Mon Apr 17, 2006 12:18 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>phoenixj91 wrote:</b></span></td> </tr> <tr> <td class="quote">New problem:
<br/>
CpuFastSet doesn't do anything. I only began to get tiles show up after using a for loop instead. Even then, I still had trouble. Here's my code:
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">   SetMode(MODE_0 | BG2_ENABLE | OBJ_ENABLE | OBJ_MAP_1D); //Set screenmode
<br/>
<br/>
   u16*  vrammap = (u16*)SCREEN_BASE_BLOCK(31);
<br/>
   u16*  vramtiles = (u16*)MAP_BASE_BLOCK(0);
<br/>
   REG_BG2CNT= BG_COLOR_256 | ROTBG_SIZE_128x128 | WRAPAROUND | (31&lt;&lt;SCREEN_SHIFT) | (0 &lt;&lt; CHAR_SHIFT);
<br/>
<br/>
   //CpuFastSet(vrammap,testmap,sizeof(testmap));
<br/>
   //CpuFastSet(vramtiles,checker,64/4);
<br/>
   //CpuFastSet(BGPaletteMem,bgpalettecopy,sizeof(bgpalettecopy));
<br/>
</td> </tr></table><span class="postbody"></span></td> </tr></table><span class="postbody">
<br/>
Actually, CpuFastSet probably does work, the problem is that your source and destination addresses are swapped. 
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">extern void CpuFastSet(void *source, void *dest, u32 mode);
<br/>
</td> </tr></table><span class="postbody">
<br/>
Also, the size should be in words, so you need to divide the sizeof() things by 4. Oh, <a class="postlink" href="http://user.chem.tue.nl/jakvijn/tonc/bitmaps.htm#ssec-data-memcpy" target="_blank">something you should know about sizeof()</a>. 
<br/>
<br/>
You're in mode 0, but setting up REG_BG2CNT as if it were an affine map. What you're actually creating is a 256x256 pixel regular map.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>phoenixj91 wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">   int t;
<br/>
   for(t=0;t&lt;3;t++){BGPaletteMem[t]=bgpalettecopy[t];}
<br/>
   for(t=0;t&lt;256;t++){vrammap[t]=testmap[t];}
<br/>
   for(t=0;t&lt;64;t++){vramtiles[t]=checker[t];}
<br/>
</td> </tr></table><span class="postbody">
<br/>
"testmap" is basically a 256 char array consisting entirely of 0s
<br/>
"bgpalettecopy" is a 3 int long array which looks like this:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">unsigned int bgpalettecopy[3]={RGB16(31,0,0),RGB16(31,31,31),RGB16(0,0,0)};</td> </tr></table><span class="postbody">
<br/>
What am I doing wrong?</span></td> </tr></table><span class="postbody">
<br/>
<br/>
bgpalettecopy is a u32 array, whereas BGPaletteMem is an u16 array. Fine if you're using a loop for copying, not fine if you're using anything else.
<br/>
<br/>
testmap may be a char array, but as far as I can see vrammap isn't (that's u16[]). Fine if you're using zeroes, but not for any real data. Also, 256 is not enough to fill the whole map (because it isn't an affine bg).
<br/>
<br/>
checker may be a char array, but as far as I can see vramtiles isn't (that's u16[]). Fine if you're using zeroes, but not for any real data. Which is this case means that the 0x01's and 0x02's of the charmap will be converted to halfwords and end up as 0x0001's and 0x0002's. Which will be interpreted as 01, 00, 02, 00 by the renderer.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#79907 - phoenixj91 - Mon Apr 17, 2006 1:16 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Cearn wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
Actually, CpuFastSet probably does work, the problem is that your source and destination addresses are swapped. 
<br/>
</td> </tr></table><span class="postbody">
<br/>
Right you are. That was stupid on my part XD
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Cearn wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
Also, the size should be in words, so you need to divide the sizeof() things by 4.
<br/>
</td> </tr></table><span class="postbody">
<br/>
Done:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">   CpuFastSet(testmap,vrammap,sizeof(testmap)/4);
<br/>
   CpuFastSet(checker,vramtiles,sizeof(vramtiles)/4);
<br/>
   CpuFastSet(bgpalettecopy,BGPaletteMem,sizeof(bgpalettecopy)/4);
<br/>
</td> </tr></table><span class="postbody">
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Cearn wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
You're in mode 0, but setting up REG_BG2CNT as if it were an affine map. What you're actually creating is a 256x256 pixel regular map.
<br/>
</td> </tr></table><span class="postbody">
<br/>
So, I would replace the register flag ROTBG_SIZE_128x128 with TEXTBG_SIZE_256x256? I did so and it didn't change much
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Cearn wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
bgpalettecopy is a u32 array, whereas BGPaletteMem is an u16 array. Fine if you're using a loop for copying, not fine if you're using anything else.
<br/>
<br/>
testmap may be a char array, but as far as I can see vrammap isn't (that's u16[]). Fine if you're using zeroes, but not for any real data. Also, 256 is not enough to fill the whole map (because it isn't an affine bg).
<br/>
<br/>
checker may be a char array, but as far as I can see vramtiles isn't (that's u16[]). Fine if you're using zeroes, but not for any real data. Which is this case means that the 0x01's and 0x02's of the charmap will be converted to halfwords and end up as 0x0001's and 0x0002's. Which will be interpreted as 01, 00, 02, 00 by the renderer.</td> </tr></table><span class="postbody">
<br/>
I just fixed all the datatypes.
<br/>
<br/>
Something looked definatley wrong, so I changed checker to an array of 64 u16s propagated entirely with 1s - a solid white square. This was the result:
<br/>
<a href="http://xs77.xs.to/pics/06161/scdump2.gif">[Images not permitted - Click here to view it]</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#79947 - Cearn - Mon Apr 17, 2006 2:11 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>phoenixj91 wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Cearn wrote:</b></span></td> </tr> <tr> <td class="quote">You're in mode 0, but setting up REG_BG2CNT as if it were an affine map. What you're actually creating is a 256x256 pixel regular map.
<br/>
</td> </tr></table><span class="postbody">
<br/>
So, I would replace the register flag ROTBG_SIZE_128x128 with TEXTBG_SIZE_256x256? I did so and it didn't change much
<br/>
</span></td> </tr></table><span class="postbody">
<br/>
No it wouldn't, because they're the same thing :P 
<br/>
ROTBG_SIZE_128x128 and TEXTBG_SIZE_256x256 are both defined as 0, what makes a bg text or affine is the video mode. You'd need either mode 1 or 2 for affine maps.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>phoenixj91 wrote:</b></span></td> </tr> <tr> <td class="quote">Something looked definatley wrong, so I changed checker to an array of 64 u16s propagated entirely with 1s - a solid white square. This was the result:
<br/>
<a href="http://xs77.xs.to/pics/06161/scdump2.gif">[Images not permitted - Click here to view it]</a></td> </tr></table><span class="postbody">
<br/>
I think you may be missing the point. If you've just changed the type, you have something like this, right?
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">const u16 checker[]= { 1, 1, 1, 1 ... };</td> </tr></table><span class="postbody">
<br/>
The point is that you'll still have 0x0001, 0x0001 going into the tiles, what you need is any pattern that'll show up in the memory viewer as "01 01 01 01", not "01 00 01 00", which is what you have now. 
<br/>
<br/>
The problem with the earlier loop-copy was that the destination was in halfwords, but the source in bytes. You need to take a step back and try to understand how any given array would actually appear in memory. Once that's done you'll see what you have to do. The VBA memory viewer can help with this.
<br/>
<br/>
A secondary problem is that the first pixel of your tile is still empty. This is probably because of a data-misalignment. CpuFastSet requires that the addresses are aligned to 4-byte boundaries.
<br/>
<br/>
<a class="postlink" href="http://user.chem.tue.nl/jakvijn/tonc/bitmaps.htm#sec-data" target="_blank">tonc: on data</a>.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#79950 - phoenixj91 - Mon Apr 17, 2006 4:02 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Cearn wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
A secondary problem is that the first pixel of your tile is still empty. This is probably because of a data-misalignment. CpuFastSet requires that the addresses are aligned to 4-byte boundaries.
<br/>
<a class="postlink" href="http://user.chem.tue.nl/jakvijn/tonc/bitmaps.htm#sec-data" target="_blank">tonc: on data</a>.</td> </tr></table><span class="postbody">
<br/>
Thanks for the link, my tile data looks better now:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">__attribute__(( aligned(4) )) u16 checker[64]={
<br/>
   0x0101,0x0101,0x0101,0x0101,0x0101,0x0101,0x0101,0x0101,
<br/>
   0x0101,0x0101,0x0101,0x0101,0x0101,0x0101,0x0101,0x0101,
<br/>
   0x0101,0x0101,0x0101,0x0101,0x0101,0x0101,0x0101,0x0101,
<br/>
   0x0101,0x0101,0x0101,0x0101,0x0101,0x0101,0x0101,0x0101,
<br/>
   0x0101,0x0101,0x0101,0x0101,0x0101,0x0101,0x0101,0x0101,
<br/>
   0x0101,0x0101,0x0101,0x0101,0x0101,0x0101,0x0101,0x0101,
<br/>
   0x0101,0x0101,0x0101,0x0101,0x0101,0x0101,0x0101,0x0101,
<br/>
   0x0101,0x0101,0x0101,0x0101,0x0101,0x0101,0x0101,0x0101
<br/>
};</td> </tr></table><span class="postbody">
<br/>
Though the second half of the tile is still empty. I'll figure that out though.
<br/>
[EDIT]
<br/>
And again, thanks to your TONC tutorials, I realized I was using sizeof() to get the size of the pointer to VRAM and not my tile array "checker".
<br/>
Spiffy little section on data management you've written there :-D !</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
