<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>ewram & sbss question - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>C/C++ > ewram & sbss question</h2>
<div id="posts">
<div class="post">
    <h4>#37715 - edwdig - Tue Mar 15, 2005 7:47 am</h4>
    <div class="postbody"><span class="postbody">What I'm trying to do is allocate an unitialized array of structures within EWRAM.  I'm using DevKitARM_R11, and this is what I'm doing:
<br/>
<br/>
static Sprite Sprites[MAX_SPRITES] __attribute__ ((section (".ewram")));
<br/>
<br/>
If I do this, everything works fine. The downside to this approach being that space for the array is allocated within the ROM image. So I figured I'd change ewram to sbss, which theoretically should have the same result, only with a smaller ROM size.
<br/>
<br/>
When I try to run the game with that change made, the game just doesn't work right. Sprites behavior simply becomes unpredictable. I'm assuming there is some kind of memory usage conflict. No where else in my code do I explicitly use EWRAM. Could it be a stack conflict? I'm also using Krawall - could the conflict be there?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#37726 - wintermute - Tue Mar 15, 2005 12:11 pm</h4>
    <div class="postbody"><span class="postbody">could you paste the output from your mapfile</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#37731 - sasq - Tue Mar 15, 2005 2:18 pm</h4>
    <div class="postbody"><span class="postbody">Maybe the array gets cleared in the ROM-case but not BSS ?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#37763 - edwdig - Wed Mar 16, 2005 12:15 am</h4>
    <div class="postbody"><span class="postbody">I did two builds, with the only difference being whether the struct mentioned before is placed in ewram or sbss. The full map files are 83k. Here are the ewram related sections. A diff shows no differences in the map files other than in this area. I trimmed off the ewram1-9 sections, as there isn't anything in there.
<br/>
<br/>
Map file with data in ewram:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
.ewram          0x02000000     0x6274 load address 0x080f9cf8
<br/>
 *(.ewram)
<br/>
 .ewram         0x02000000     0x3ffc game.thumb.o
<br/>
 .ewram         0x02003ffc     0x2278 krawall-16k-60-medium.lib
<br/>
                0x02004cb2                _private_00066
<br/>
                0x020048ac                _private_00006
<br/>
                0x020050b8                _private_0005d
<br/>
                0x020050b4                _private_0005c
<br/>
                0x020050ba                _private_0005b
<br/>
                0x02006274                . = ALIGN (0x4)
<br/>
                0x080fff6c                __ewram_overlay_lma = (__ewram_lma + SIZEOF (.ewram))
<br/>
<br/>
.sbss           0x02006274        0x0
<br/>
 *(.sbss)
<br/>
                0x02006274                . = ALIGN (0x4)
<br/>
                0x02006274                __ewram_end = .
<br/>
                0x02006274                __ewram_overlay_start = .
<br/>
<br/>
.ewram0         0x02006274        0x0 load address 0x080fff6c
<br/>
 *(.ewram0)
<br/>
                0x02006274                . = ALIGN (0x4)
<br/>
                0x080fff6c                __load_start_ewram0 = LOADADDR (.ewram0)
<br/>
                0x080fff6c                __load_stop_ewram0 = (LOADADDR (.ewram0) + SIZEOF (.ewram0))
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Map file with data in sbss:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
.ewram          0x02000000     0x2278 load address 0x080f9cf8
<br/>
 *(.ewram)
<br/>
 .ewram         0x02000000     0x2278 krawall-16k-60-medium.lib
<br/>
                0x02000cb6                _private_00066
<br/>
                0x020008b0                _private_00006
<br/>
                0x020010bc                _private_0005d
<br/>
                0x020010b8                _private_0005c
<br/>
                0x020010be                _private_0005b
<br/>
                0x02002278                . = ALIGN (0x4)
<br/>
                0x080fbf70                __ewram_overlay_lma = (__ewram_lma + SIZEOF (.ewram))
<br/>
<br/>
.sbss           0x02002278     0x3ffc
<br/>
 *(.sbss)
<br/>
 .sbss          0x02002278     0x3ffc game.thumb.o
<br/>
                0x02006274                . = ALIGN (0x4)
<br/>
                0x02006274                __ewram_end = .
<br/>
                0x02006274                __ewram_overlay_start = .
<br/>
<br/>
.ewram0         0x02006274        0x0 load address 0x080fbf70
<br/>
 *(.ewram0)
<br/>
                0x02006274                . = ALIGN (0x4)
<br/>
                0x080fbf70                __load_start_ewram0 = LOADADDR (.ewram0)
<br/>
                0x080fbf70                __load_stop_ewram0 = (LOADADDR (.ewram0) + SIZEOF (.ewram0))
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#37764 - edwdig - Wed Mar 16, 2005 12:25 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>sasq wrote:</b></span></td> </tr> <tr> <td class="quote">Maybe the array gets cleared in the ROM-case but not BSS ?</td> </tr></table><span class="postbody">
<br/>
<br/>
Just did a quick memset() on the array, and that seems to fix the issue. It really doesn't explain the behavior I was seeing (bullets going straight across the screen would just randomly abruptly stop without being near anything else), but ok, if that makes it work I'll take it.
<br/>
<br/>
I'm really not sure why that makes a difference here though, as this code used to use malloc for about 6 months until I just recently changed it to allocate the memory at compile time. Theoretically malloc should also being giving me uninitialized EWRAM, but yet that worked fine.
<br/>
<br/>
Should sbss be initialized to zero? I would assume it would, since its really still an uninitialized global variable, which C would normally zero init.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
