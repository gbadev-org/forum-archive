<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Getting strange error moving variable into class - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>C/C++ > Getting strange error moving variable into class</h2>
<div id="posts">
<div class="post">
    <h4>#177351 - MisterLogan - Sun Apr 29, 2012 9:48 pm</h4>
    <div class="postbody"><span class="postbody">I am trying to move a variable (u16 MapBuffer[32*32];) declared in main, into a class (Map). So I'm switching from MapBuffer to Map.Buffer.
<br/>
<br/>
When I do this seemingly simple move, my game goes absolutely nuts. Looking through registers in desmume shows the BG3HOFS register is going crazy. The only thing in my code accessing that register is this code:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
bool PlayerClass::CheckPlayerCollision() {
<br/>
   return(true);
<br/>
}
<br/>
<br/>
void PlayerClass::AcceptUserInput(int BG3Main_id) {
<br/>
<br/>
   int gfxOffset=0;
<br/>
   
<br/>
   ///start of animation (loop=0)==========
<br/>
   if(AnimLoop == 0) {
<br/>
      //Accept key presses
<br/>
      scanKeys();
<br/>
      if      (keysHeld() &amp; KEY_RIGHT)   {Input.X =   1;   InputDirection=1;}
<br/>
      else if   (keysHeld() &amp; KEY_DOWN)      {Input.Y =   1;   InputDirection=2;}
<br/>
      else if   (keysHeld() &amp; KEY_LEFT)      {Input.X =  -1;   InputDirection=3;}      
<br/>
      else if   (keysHeld() &amp; KEY_UP)      {Input.Y =  -1;   InputDirection=4;}
<br/>
      
<br/>
      gfxOffset = ((InputDirection*2)-1) * 256*2;
<br/>
      memcpy(pSpriteBase, GhostlyTiles_bin + gfxOffset, 256*2);
<br/>
   }
<br/>
   
<br/>
   ///mid animation (loop=8)===============   
<br/>
   if(AnimLoop == 8){
<br/>
      gfxOffset = ((InputDirection-1)*2) * 256*2;
<br/>
      memcpy(pSpriteBase, GhostlyTiles_bin + gfxOffset, 256*2);
<br/>
   }
<br/>
   
<br/>
   AnimLoop+=1;
<br/>
<br/>
   if(CheckPlayerCollision() == true) {
<br/>
      c_BGPixels.X += Input.X;
<br/>
      c_BGPixels.Y += Input.Y;
<br/>
   }
<br/>
   else {
<br/>
      AnimLoop+=1;
<br/>
   }
<br/>
<br/>
   bgScroll(BG3Main_id, Input.X, Input.Y);
<br/>
   
<br/>
   ///end of animation loop (loop=16)=======
<br/>
   if(AnimLoop == 16) {   
<br/>
      AnimLoop=0;
<br/>
      Input.X=0; 
<br/>
      Input.Y=0;
<br/>
      InputDirection=0;
<br/>
   }
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
This function is called from main using this:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
scanKeys();
<br/>
   if(keysHeld()   &amp;
<br/>
      (KEY_RIGHT   |
<br/>
      KEY_DOWN   |
<br/>
      KEY_LEFT           |
<br/>
      KEY_UP)      || Player.AnimLoop !=0) {Player.AcceptUserInput(BG3Main_id); iprintf("direction pressed\n");} 
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
When I comment this function call out, the error stops.
<br/>
<br/>
MapBuffer/Map.Buffer are being accessed by two functions, but commenting them both out doesn't stop the error.
<br/>
<br/>
So yeah, what the heck is going on here?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#177352 - Dwedit - Sun Apr 29, 2012 10:14 pm</h4>
    <div class="postbody"><span class="postbody">Not enough information here, but I'm guessing memory corruption.<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#177353 - MisterLogan - Sun Apr 29, 2012 10:33 pm</h4>
    <div class="postbody"><span class="postbody">I don't really know what other useful info I can provide besides the entirety of the code. It's not that large I guess.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#include &lt;nds.h&gt;
<br/>
#include &lt;stdio.h&gt;
<br/>
#include &lt;_ansi.h&gt;
<br/>
<br/>
#include "Player.h"
<br/>
#include "NPC.h"
<br/>
#include "Layer1.h"
<br/>
<br/>
#include "GhostlyPal_bin.h"
<br/>
#include "GhostlyTiles_bin.h"
<br/>
<br/>
#define Pal_Size 256
<br/>
#define Map_Size_32x32 2048
<br/>
#define SPRITE_TOP_PRIO      1
<br/>
#define SPRITE_BOTTOM_PRIO   2
<br/>
<br/>
///Type Creations----------------------------------------------------------
<br/>
   class Map{
<br/>
     private:
<br/>
     
<br/>
     public:
<br/>
      u16 Buffer[32*32];
<br/>
   }Map;
<br/>
<br/>
///========================================================================
<br/>
<br/>
<br/>
///Function Prototypes-----------------------------------------------------
<br/>
<br/>
///========================================================================
<br/>
<br/>
//void MapWrap(){
<br/>
//
<br/>
//}
<br/>
<br/>
void initBG(const u16 *pal, const u16 *tiles, const u16 *map, int tilesize, u16 *MapBuffer1, u16 *MapBuffer2) {
<br/>
<br/>
   int i, j;
<br/>
   
<br/>
   ///Palette init
<br/>
   memcpy(BG_PALETTE, pal, Pal_Size);
<br/>
   
<br/>
   ///Tile init
<br/>
    memcpy(BG_TILE_RAM(1), tiles, tilesize);
<br/>
   
<br/>
   ///Map init
<br/>
   for(i=0;i&lt;32;i++){
<br/>
      for(j=0;j&lt;32;j++){
<br/>
         MapBuffer1[(i*32)+j] = map[(i*256)+j];
<br/>
      }
<br/>
   }
<br/>
   for(i=0;i&lt;32;i++){
<br/>
      for(j=0;j&lt;32;j++){
<br/>
         MapBuffer2[(i*32)+j] = map[(i*256)+j+32];
<br/>
      }
<br/>
   }
<br/>
}
<br/>
<br/>
void oamSetBeing(int index, u16* pGFX, int X, int Y, bool Hide)
<br/>
{
<br/>
   oamSet(&amp;oamMain,
<br/>
         index, 
<br/>
         X, Y, //x and y
<br/>
         SPRITE_TOP_PRIO, //priority
<br/>
         0, //palette index for multiple palettes
<br/>
         SpriteSize_16x16, 
<br/>
         SpriteColorFormat_256Color, 
<br/>
         pGFX, //pointer to loaded graphics
<br/>
         0,  //rot/scale matrix index
<br/>
         false, //double size when rot/scale?
<br/>
         Hide, //hide sprite?
<br/>
         false, false, //vflip, hflip?
<br/>
         false  //mosiac?
<br/>
         );
<br/>
         
<br/>
   oamSet(&amp;oamMain,
<br/>
         index+1, //+1 for bottom half offset
<br/>
         X, Y+16, //x and y; +16 for bottom half offset
<br/>
         SPRITE_BOTTOM_PRIO, //priority
<br/>
         0, //palette index for multiple palettes
<br/>
         SpriteSize_16x16, 
<br/>
         SpriteColorFormat_256Color, 
<br/>
         pGFX+128, //pointer to loaded graphics; +128 for bottom sprite offset
<br/>
         0,  //rot/scale matrix index
<br/>
         false, //double size when rot/scale?
<br/>
         Hide, //hide sprite?
<br/>
         false, false, //vflip, hflip?
<br/>
         false  //mosiac?
<br/>
         );
<br/>
}
<br/>
<br/>
//------------------------------------------------------
<br/>
int main() {
<br/>
//------------------------------------------------------
<br/>
<br/>
   consoleDemoInit();
<br/>
<br/>
   ///Variables===============================///
<br/>
<br/>
   int BG3Main_id=0;
<br/>
<br/>
   u16 MapBuffer1[32*32], MapBuffer2[32*32];
<br/>
<br/>
<br/>
   PlayerClass Player;
<br/>
   Player.pSpriteBase = oamAllocateGfx(&amp;oamMain, SpriteSize_16x32, SpriteColorFormat_256Color);
<br/>
//   NPCClass *NPCPool[32], *CurrentNPC;
<br/>
   
<br/>
<br/>
   ///========================================///
<br/>
<br/>
   videoSetMode(MODE_0_2D);
<br/>
   BG3Main_id = bgInit(3, //layer (doesn't work)
<br/>
             BgType_Text8bpp,
<br/>
             BgSize_T_512x256,
<br/>
             0, //Map base
<br/>
             1 //Tile base
<br/>
             );
<br/>
   bgSetPriority(BG3Main_id, 3);
<br/>
    
<br/>
   initBG(Layer_1Pal, Layer_1Tiles, Layer_1Map, sizeof(Layer_1Tiles), MapBuffer1, MapBuffer2);
<br/>
<br/>
   vramSetBankB(VRAM_B_MAIN_SPRITE); //64kb bank
<br/>
   
<br/>
   oamInit(&amp;oamMain, SpriteMapping_1D_32, false);// last argument for extended palette
<br/>
   
<br/>
   memcpy(SPRITE_PALETTE, GhostlyPal_bin, GhostlyPal_bin_size);
<br/>
   memcpy(Player.pSpriteBase, GhostlyTiles_bin, 256*2);
<br/>
   
<br/>
   oamSetBeing(0, //index
<br/>
            Player.pSpriteBase, //pointer to where graphics should be loaded
<br/>
            15*8, 10*8, //x and y in tiles * tile to pixel conversion
<br/>
            false); //hide sprite?
<br/>
   
<br/>
   
<br/>
   ///MAIN LOOP==============================================================================
<br/>
   while(1) {
<br/>
<br/>
   swiWaitForVBlank();
<br/>
   memcpy(BG_MAP_RAM(0), MapBuffer1, Map_Size_32x32);
<br/>
   memcpy(BG_MAP_RAM(1), MapBuffer2, Map_Size_32x32);
<br/>
   bgUpdate();
<br/>
   oamUpdate(&amp;oamMain);
<br/>
   
<br/>
   scanKeys();
<br/>
   if(keysHeld()   &amp;
<br/>
      (KEY_RIGHT   |
<br/>
      KEY_DOWN   |
<br/>
      KEY_LEFT   |
<br/>
      KEY_UP)      || Player.AnimLoop !=0) {Player.AcceptUserInput(BG3Main_id); iprintf("direction pressed\n");} //accepts udlr keypresses, moves the background
<br/>
                                                            //and animates the main player sprite
<br/>
   
<br/>
   
<br/>
   }///======================================================================================
<br/>
<br/>
    return 0;
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
That's main, minus some planning comments up top.
<br/>
<br/>
Playerclass.h is this:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#include &lt;nds.h&gt;
<br/>
#include "Structs.h"
<br/>
<br/>
#ifndef PLAYER_H
<br/>
#define PLAYER_H
<br/>
<br/>
   class PlayerClass {
<br/>
     private:
<br/>
     public:
<br/>
      XY c_BGPixels, c_BGTiles, Input; //counters for tracking, Input is for accepting user input
<br/>
      u16* pSpriteBase; 
<br/>
      int InputDirection;//Right, Down, Left, Up; make this 1,2,3, or 4 depending on which direction player is moving
<br/>
      int AnimLoop;
<br/>
      
<br/>
      void AcceptUserInput (int);
<br/>
      bool CheckPlayerCollision();
<br/>
   };
<br/>
<br/>
#endif
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Structs.h just has xy, which contains (shockingly) int x and y.
<br/>
<br/>
That's everything save some yet unused files (NPC.h) and graphical data.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#177354 - Cearn - Mon Apr 30, 2012 8:55 am</h4>
    <div class="postbody"><span class="postbody">I see two suspicious things here in PlayerClass::AcceptUserInput:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">      if      (keysHeld() &amp; KEY_RIGHT)   {Input.X =   1;   InputDirection=1;}
<br/>
      else if   (keysHeld() &amp; KEY_DOWN)  {Input.Y =   1;   InputDirection=2;}
<br/>
      else if   (keysHeld() &amp; KEY_LEFT)  {Input.X =  -1;   InputDirection=3;}      
<br/>
      else if   (keysHeld() &amp; KEY_UP)   {Input.Y =  -1;   InputDirection=4;} 
<br/>
</td> </tr></table><span class="postbody">
<br/>
You only set one coordinate here without clearing the other. Say you go right, then Input.X==1. then you press up, then Input.Y becomes -1, but Input.X is still 1, so you'd move diagonally. I know you reset the Input coordinates later, but it's still worth looking into.
<br/>
<br/>
Secondly, 
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">   bgScroll(BG3Main_id, Input.X, Input.Y);
<br/>
</td> </tr></table><span class="postbody">
<br/>
Don't you mean c_BGPixels.X and .Y here?
<br/>
<br/>
If that's not it, define "nuts".</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
