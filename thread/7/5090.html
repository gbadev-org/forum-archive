<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Multiboot problems - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>C/C++ > Multiboot problems</h2>
<div id="posts">
<div class="post">
    <h4>#36670 - Vertex - Sun Feb 27, 2005 9:58 pm</h4>
    <div class="postbody"><span class="postbody">Hi!
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#include "gball.h"
<br/>
<br/>
#define MULTIBOOT volatile const u8 __gba_multiboot; 
<br/>
MULTIBOOT
<br/>
<br/>
int main(void)
<br/>
{
<br/>
   u16 c = 0;
<br/>
   
<br/>
   SetMode(MODE_3 | BG2_ENABLE);
<br/>
   for(c = 0; c &lt; 38400; c++)
<br/>
   {
<br/>
      VideoBuffer[c] = (31 &lt;&lt; 10);
<br/>
   }
<br/>
   
<br/>
   while(1);
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
and
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">path=E:\Dev\GBA\DevkitARM\devkitadv-r5-beta-3\bin
<br/>
gcc -Ttext=0x02000000 -o main.elf main.c 
<br/>
objcopy -O binary main.elf main.mb.gba
<br/>
del *.elf
<br/>
pause </td> </tr></table><span class="postbody">
<br/>
<br/>
GCC compile this code correct, but I can't boot this with my GBA. 
<br/>
<br/>
I think, the problem is, that on address 0x02000000 is the instruction "b $020000e4". But on other bootable roms, the istruction is every "b $020000c0".
<br/>
<br/>
I can send my rom with F2APowerWriter correctly and start it, but with my own send-tool, I can only sending roms with "b $020000c0" correctly.
<br/>
<br/>
Can anyone help me?
<br/>
<br/>
cu olli</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#36672 - tepples - Sun Feb 27, 2005 10:04 pm</h4>
    <div class="postbody"><span class="postbody">When you send the 192 byte header, you have to copy the first four bytes out of the ROM.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#36673 - Vertex - Sun Feb 27, 2005 10:30 pm</h4>
    <div class="postbody"><span class="postbody">Ahhhhh, the boatable roms I have test it, have the 192 byte header includet *run against the wall*
<br/>
<br/>
When will update my send tool, do you think, I must send only the 192 byte header + ROM, or do I must send like this:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">const u8 Header [] = {
<br/>
 46,0,0,234,36,255,174,81,105,154,162,33,61,132,130,10, // 16
<br/>
 132,228,9,173,17,36,139,152,192,129,127,33,163,82,190,25, // 16
<br/>
 147,9,206,32,16,70,74,74,248,39,49,236,88,199,232,51, // 16
<br/>
 130,227,206,191,133,244,223,148,206,75,9,193,148,86,138,192, // 16
<br/>
 19,114,167,252,159,132,77,115,163,202,154,97,88,151,163,39,
<br/>
 252,3,152,118,35,29,199,97,3,4,174,86,191,56,132,0,
<br/>
 64,167,14,253,255,82,254,3,111,149,48,241,151,251,192,133,
<br/>
 96,214,128,37,169,99,190,3,1,78,56,226,249,162,52,255,
<br/>
 187,62,3,68,120,0,144,203,136,17,58,148,101,192,124,99,
<br/>
 135,240,60,175,214,37,228,139,56,10,172,114,33,212,248,7,
<br/>
 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,48,49,150,0,0,0,0,0, // 24
<br/>
 0,0,0,0,0,240,0,0
<br/>
};
<br/>
<br/>
typedef struct {
<br/>
  u32 reserve1[5];      //
<br/>
  u8 hs_data;           // 20 ($14) Needed by BIOS
<br/>
  u8 reserve2;          // 21 ($15)
<br/>
  u16 reserve3;         // 22 ($16)
<br/>
  u8 pc;                // 24 ($18) Needed by BIOS
<br/>
  u8 cd[3];             // 25 ($19)
<br/>
  u8 palette;           // 28 ($1c) Needed by BIOS - Palette flash while load
<br/>
  u8 reserve4;          // 29 ($1d) rb
<br/>
  u8 cb;                // 30 ($1e) Needed by BIOS
<br/>
  u8 reserve5;          // 31 ($1f)
<br/>
  u8 *startp;           // 32 ($20) Needed by BIOS
<br/>
  u8 *endp;             // 36 ($24) Needed by BIOS
<br/>
  u8 *reserve6;         // 40 ($28)
<br/>
  u8 *reserve7[3];      // 44 ($2c)
<br/>
  u32 reserve8[4];      // 56 ($38)
<br/>
  u8 reserve9;          // 72 ($48)
<br/>
  u8 reserve10;         // 73 ($49)
<br/>
  u8 reserve11;         // 74 ($4a)
<br/>
  u8 reserve12;         // 75 ($4b)
<br/>
} MBStruct;
<br/>
<br/>
MBStruct mp;
<br/>
<br/>
void SetMultiboot() 
<br/>
{
<br/>
   *(u16 *)MB_CNT = 0;
<br/>
}
<br/>
<br/>
u16 xfer(u16 send)
<br/>
{
<br/>
   *(u16 *)SIOMLT_SEND = send;
<br/>
   *(u16 *)SIOCNT = 0x2083;
<br/>
<br/>
   while(*(vu16 *)SIOCNT &amp; 0x80)
<br/>
   {}
<br/>
   return (*(vu16 *)SIOMULTI1);
<br/>
}
<br/>
<br/>
WaitForGBA()
<br/>
{
<br/>
   u16 i;
<br/>
<br/>
   do
<br/>
   {
<br/>
      i = xfer(0x6202);
<br/>
   }
<br/>
   while (i != 0x7202);
<br/>
<br/>
   i = xfer(0x6100);
<br/>
}
<br/>
<br/>
SendHeader()
<br/>
{
<br/>
   u16 i;
<br/>
<br/>
   xfer((Header[1] &lt;&lt; 8) + Header[0]);
<br/>
   xfer((Header[3] &lt;&lt; 8) + Header[2]);
<br/>
<br/>
   for(i=2; i&lt;96; i++)
<br/>
      xfer((Header[i*2+1] &lt;&lt; 8) + Header[i*2]);
<br/>
<br/>
   i = xfer(0x6202);
<br/>
}
<br/>
<br/>
SendROM()
<br/>
{
<br/>
   u8 palette;
<br/>
   u8 debug = 1;
<br/>
   u16 i;
<br/>
   u16 key;
<br/>
   u32 length;
<br/>
<br/>
   mp.cb = 2;
<br/>
   mp.pc = 0xd1;
<br/>
   mp.startp = (u8 *)&amp;Client [0xc0];
<br/>
   length = sizeof(Client) - 0xc0;
<br/>
   length = (length + 15) &amp; ~15; /* 16 byte units */
<br/>
   if (length &lt; 0x1c0) length = 0x1c0;
<br/>
   mp.endp = (u8 *)&amp;Client [0xc0] + length;
<br/>
<br/>
   palette = 0xc1;
<br/>
   mp.palette = palette;
<br/>
<br/>
   i = xfer(0x6300+palette);
<br/>
   i = xfer(0x6300+palette);
<br/>
<br/>
   mp.cd[0] = i;
<br/>
   mp.cd[1] = 0xff;
<br/>
   mp.cd[2] = 0xff;
<br/>
<br/>
   key = (0x11 + (i &amp; 0xff) + 0xff + 0xff) &amp; 0xff;
<br/>
   mp.hs_data = key;
<br/>
<br/>
   i = xfer(0x6400 | (key &amp; 0xff));
<br/>
<br/>
   // Execute BIOS routine to transfer client binary to slave unit
<br/>
   asm volatile (
<br/>
      " ldr r0,=mp\n"
<br/>
      " mov r1,#1\n"
<br/>
      " swi 0x250000\n"       //NOTE!!!!! Use 0x250000 for ARM C Compiler mode.
<br/>
      :  // Outputs       // 0x25 here will only work for Thumb mode.
<br/>
      :  // Inputs
<br/>
      : "r0","r1","r2","r8","r9","r10","r11","r12"     // Regs crushed &amp; smushed
<br/>
      );
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
cu olli</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#36674 - tepples - Sun Feb 27, 2005 11:31 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Vertex wrote:</b></span></td> </tr> <tr> <td class="quote">Ahhhhh, the boatable roms I have test it, have the 192 byte header includet *run against the wall*
<br/>
<br/>
When will update my send tool, do you think, I must send only the 192 byte header + ROM, or do I must send like this:
<br/>
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">SendHeader()
<br/>
{
<br/>
   u16 i;
<br/>
<br/>
   xfer((Header[1] &lt;&lt; 8) + Header[0]);
<br/>
   xfer((Header[3] &lt;&lt; 8) + Header[2]);
<br/>
<br/>
   for(i=2; i&lt;96; i++)
<br/>
      xfer((Header[i*2+1] &lt;&lt; 8) + Header[i*2]);
<br/>
<br/>
   i = xfer(0x6202);
<br/>
}
<br/>
</td> </tr></table><span class="postbody"></span></td> </tr></table><span class="postbody">
<br/>
The first four bytes of the header sent to the GBA must come from Client[] rather than Header[], as they contain the jump instruction.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
