<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>OO Stages/Scripted Stages - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>Game Design > OO Stages/Scripted Stages</h2>
<div id="posts">
<div class="post">
    <h4>#41211 - sgeos - Tue Apr 26, 2005 1:50 pm</h4>
    <div class="postbody"><span class="postbody">I was pondering OO stages a while back.  While thinking about it, it seemed to me that script based stages would be really neat.  I made a 3D cursor driven prototype that supports the following commands (and variations, like <span style="font-weight: bold">movex</span> <span style="font-style: italic">x</span>):
<br/>
<br/>
<ul><span style="font-weight: bold">move</span> <span style="font-style: italic">x y z</span>
<br/>
<span style="font-weight: bold">setpos</span> <span style="font-style: italic">x y z</span>
<br/>
<span style="font-weight: bold">select</span> <span style="font-style: italic">x y z</span>
<br/>
<span style="font-weight: bold">setselect</span> <span style="font-style: italic">x y z</span>
<br/>
<span style="font-weight: bold">draw</span> <span style="font-style: italic">tile</span>
<br/>
<span style="font-weight: bold">palette</span> <span style="font-style: italic">color</span>
<br/>
<span style="font-weight: bold">script</span> <span style="font-style: italic">name</span></ul>I wrote a simple script for it.  This script can called from other scripts with the <span style="font-style: italic"><span style="font-weight: bold">script room</span></span>.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">draw wall
<br/>
move 1 1 0
<br/>
select -2 -2 0
<br/>
draw floor
<br/>
select 2 2 0
<br/>
move -1 -1 0</td> </tr></table><span class="postbody">
<br/>
It just creates the outline of a wall and resets the selection.  Has anybody else played around with or thought about script based stages?  A point and click tool that autogenerates the required drawing code would clearly have to be made.  Undo and redo could basically be implemented for free.  Patching stages becomes free (write a patch and call it), and each script represtents a stage object.
<br/>
<br/>
It seems to me that for this to be really useful, the scripts need to be able to hold variables and accept parameters.  It seems that I might just want to export the scripts to C functions.  Any thoughts on this and the script based approach in general?
<br/>
<br/>
-Brendan</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#41230 - sajiimori - Tue Apr 26, 2005 6:09 pm</h4>
    <div class="postbody"><span class="postbody">Whoa, you lost me.  Are you talking about map data representation?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#41236 - ScottLininger - Tue Apr 26, 2005 8:15 pm</h4>
    <div class="postbody"><span class="postbody">Brendan,
<br/>
<br/>
I think it's a really interesting idea from a data compression point of view. Of course, it assumes that your map can be described in this way, but if it can, it could really lower your ROM size.
<br/>
<br/>
For example, the iso engine we used for Star Fortress Dendron stored every tile of every map. If an isometric room were described as a series of scripted "walls", you could probably store the maps for a fraction of the cart space...
<br/>
<br/>
One disadvantage of a computer "drawn" wall or floor is the regularity of the tiles. A human artist can take a small tile set and intuitively use them to create surfaces that don't look tiled. But then again, with a properly organized tile set, one might be able to write an algorithm that "breaks up" the tiles using a random seed...
<br/>
<br/>
The other thing I like about it is that once the scripting engine is in place, it would open up interesting possibilities for dynamically created levels. You know, random dungeon generation, etc.
<br/>
<br/>
-Scott</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#41242 - sajiimori - Tue Apr 26, 2005 9:55 pm</h4>
    <div class="postbody"><span class="postbody">Declarative representations ("what it is") are usually simpler and more compact than imperative ones ("how to make it").  In practice, good use of abstraction will tend to make the imperative version look almost like the declarative version.  For instance, here's some well-abstracted imperative code for drawing a circle inside a rectangle:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">drawPicture()
<br/>
{
<br/>
   // drawRect takes the left, right, top, and bottom edges.
<br/>
   drawRect(-1, 1, -1, 1);
<br/>
<br/>
   // drawCircle takes the center and the radius
<br/>
   drawCircle(0, 0, 1);
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
And here's how you might describe that picture declaratively:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">Picture = Circle(0, 0, 1) `onTopOf` Rect(-1, 1, -1, 1)
<br/>
</td> </tr></table><span class="postbody">
<br/>
Note that I'm not implying that the declarative version is shorter.  The first version could have been written like this:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">picture() { rect(-1, 1, -1, 1); circle(0, 0, 1); }
<br/>
</td> </tr></table><span class="postbody">
<br/>
The point is that the declarative version is more like describing data, and that approach will tend to make your representations more natural and concise on average.  The picture <span style="font-style: italic">is</span> a circle <span style="font-style: italic">on top of</span> a rectangle, rather than you <span style="font-style: italic">make</span> the picture by drawing a rectangle <span style="font-style: italic">and then</span> a circle.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#41300 - poslundc - Wed Apr 27, 2005 8:15 am</h4>
    <div class="postbody"><span class="postbody">This seems to me to be analogous the ancient conflict between vector graphics and raster graphics, basically Illustrator vs. Photoshop.
<br/>
<br/>
If the analogy holds, then the answer is simply there's a time and place for both approaches.
<br/>
<br/>
That said, the raster (or, to borrow sajimori's terminology, "declarative") approach makes the most sense for the vast majority of applications on a platform like the GBA, because the data doesn't need to be post-processed in order to work with the hardware. Your tool encodes the data in a compatible format, and you know that you can load it with a constant level of complexity. It is the "simple" way of doing things, and unsurprisingly in most cases simple is best.
<br/>
<br/>
The advantages pointed out for the vector/imperative method are also valid. But I would want to see an application that really <span style="font-style: italic">needs</span> those features before I would trade in the more elegant effectiveness of a straightforward representation.
<br/>
<br/>
To address some more specific points that were made:
<br/>
<br/>
- Undo/redo in the tool seems to me to be a weak case for the "vector" approach. These are features that serve the tool, not the end result. The tool should be working for you, not the other way round.
<br/>
<br/>
- The compression advantage is undeniable. But remember there are other methods of compression as well. Other advantages of the vector approach (such as easy transformations like scaling) are harder to find positive applications for when you are coding for the GBA, where you just need pretty much everything "rendered" already.
<br/>
<br/>
- I've actually used something not wholly dissimilar to this for the random terrain generator I created for my Mode 7 engine at one point. So there clearly are cases where such things are useful. But it should be noted that while the savings were obvious (I didn't have to consume <span style="font-style: italic">any</span> ROM space with maps, just the rules for creating them) the processing time was not negligible, and I had to cut a lot of corners and optimize the crap out of it and even still required an "enter battle" transition effect to kill time while the level was being generated. The lesson is to always bear in mind the target when making such design decisions!
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#41318 - tepples - Wed Apr 27, 2005 3:02 pm</h4>
    <div class="postbody"><span class="postbody"><span style="font-weight: bold">Advanced technique</span>
<br/>
If you're only going to call a given piece of code rarely, but it needs to run quickly when it is called, it might be a good idea to compile the function as ARM and position-independent (-marm -mthumb-interwork -fPIC) so that you can just 1. allocate an array on the stack, 2. copy the code into the array, and 3. execute from the stack. I believe one of the JPEG decoders (by Burton Radons?) does this.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#41327 - sajiimori - Wed Apr 27, 2005 5:11 pm</h4>
    <div class="postbody"><span class="postbody">I wasn't talking about raster versus procedural, but rather procedural versus procedural -- two different kinds of it.  Both kinds are a lot like code, but one is more like imperative code and one is more like functional code.
<br/>
<br/>
I've heard tepples describe the map format used in Super Mario World, and that more closely matches the declarative functional style I'm suggesting.  The map data says what the map is by describing its components, and those components needn't be all the same size with the same properties.
<br/>
<br/>
One of the primary goals when designing such a format is to find the shortest way to describe what you want, and all things being equal, "what it is" tends to be shorter and more direct than "how to make it".
<br/>
<br/>
BTW, stole the idea from "The Haskell School of Expression", which describes a functional declarative graphics library.
<br/>
<br/>
Edit: I agree with Dan about the raster approach being simpler, with an additional qualification.  The eventual goal is to have a ROM binary that meets your requirements, and it's desirable to reduce the effort needed to reach that goal.  Since the volume of tool code often meets or exceeds the volume of engine code, it's reasonable to consider approaches that make tool authoring easier.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#41513 - sgeos - Fri Apr 29, 2005 10:42 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>sajiimori wrote:</b></span></td> </tr> <tr> <td class="quote">Whoa, you lost me.  Are you talking about map data representation?</td> </tr></table><span class="postbody">
<br/>
Yes.  I'm talking about representing maps as a series of cursor, selection and drawing instructions.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>sajiimori wrote:</b></span></td> </tr> <tr> <td class="quote">I've heard tepples describe the map format used in Super Mario World, and that more closely matches the declarative functional style I'm suggesting.  The map data says what the map is by describing its components, and those components needn't be all the same size with the same properties.</td> </tr></table><span class="postbody">
<br/>
I was pondering the object based map formats when I came across the idea of script based map format.  Assuming that one script can call another, and that the called scripts can be passed parameters, then each subscript becomes a new map object.  Even if each cell is unique, once the map object has been created it can be reused an infinite number of time.  First call is "expensive", every further call takes once instruction.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>ScottLininger wrote:</b></span></td> </tr> <tr> <td class="quote">I think it's a really interesting idea from a data compression point of view. Of course, it assumes that your map can be described in this way, but if it can, it could really lower your ROM size.</td> </tr></table><span class="postbody">
<br/>
It is difficult to describe art heavy maps using this approach.  The more unique tiles maps have, the less appropriate it becomes.  Such scripts are going to look like:
<br/>
<ul><span style="font-style: italic">move 1 0 0 
<br/>
draw fountain_of_doom_0
<br/>
move 1 0 0 
<br/>
draw fountain_of_doom_1
<br/>
...
<br/>
move 1 0 0 
<br/>
draw fountain_of_doom_31</span>
<br/>
</ul>Art heavy maps are still appropriate if art heavy objects are reused.  99% of the scripts will be generated by user mouse clicks.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>ScottLininger wrote:</b></span></td> </tr> <tr> <td class="quote">For example, the iso engine we used for Star Fortress Dendron stored every tile of every map. If an isometric room were described as a series of scripted "walls", you could probably store the maps for a fraction of the cart space...</td> </tr></table><span class="postbody">
<br/>
The larger the library of subscripts (generic map objects) becomes, the smaller stages become.
<br/>
<br/>
The map format used it Star Fortress Dendron was the simple brute force format.  Everything considered I think that either a 3D array of conceptual tiles, or a 2D array with a height map is a nicer format.  Harder to put in place (and potentially less flexible), but nicer.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>ScottLininger wrote:</b></span></td> </tr> <tr> <td class="quote">One disadvantage of a computer "drawn" wall or floor is the regularity of the tiles. A human artist can take a small tile set and intuitively use them to create surfaces that don't look tiled. But then again, with a properly organized tile set, one might be able to write an algorithm that "breaks up" the tiles using a random seed...</td> </tr></table><span class="postbody">
<br/>
Keep in mind that there is going to be a human driver behind all stages made with a system like this.  "All look same" can be handled with seed numbers and wieghted lists of tiles.
<br/>
<ul><span style="font-weight: bold">40% <span style="font-style: italic">Floor</span></span>
<br/>
<span style="font-weight: bold">30% <span style="font-style: italic">Rusty Floor</span></span>
<br/>
<span style="font-weight: bold">20% <span style="font-style: italic">Cracked Floor</span></span>
<br/>
<span style="font-weight: bold">10% <span style="font-style: italic">Rubble</span></span></ul>It can be useful to include a NULL tile in certain tables.  (Ie don't draw anything.)  Useful for patching stages.
<br/>
<ul><span style="font-weight: bold">40% <span style="font-style: italic">NULL</span></span>
<br/>
<span style="font-weight: bold">30% <span style="font-style: italic">Leaves</span></span>
<br/>
<span style="font-weight: bold">10% <span style="font-style: italic">Water</span></span>
<br/>
<span style="font-weight: bold">10% <span style="font-style: italic">Acid</span></span>
<br/>
<span style="font-weight: bold">9% <span style="font-style: italic">Flower</span></span>
<br/>
<span style="font-weight: bold">1% <span style="font-style: italic">Carnivorous Flower</span></span></ul>For something really interesting, the map could be seeded with time on every entry. =)  These tables remind me of old role playing games, like Traveller.
<br/>
<br/>
Although they were not part of the prototype, my original design contained weighted tables and multiple draw shapes (circle, arc, square, hollow box, etc).
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>ScottLininger wrote:</b></span></td> </tr> <tr> <td class="quote">The other thing I like about it is that once the scripting engine is in place, it would open up interesting possibilities for dynamically created levels. You know, random dungeon generation, etc.</td> </tr></table><span class="postbody">
<br/>
I had also thought of that.  I think that before one starts randomly generating stages, one wants to get a feel for what the "engine" can do by manually creating stages.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>poslundc wrote:</b></span></td> </tr> <tr> <td class="quote">The advantages pointed out for the vector/imperative method are also valid. But I would want to see an application that really <span style="font-style: italic">needs</span> those features before I would trade in the more elegant effectiveness of a straightforward representation.</td> </tr></table><span class="postbody">
<br/>
Do you want to save on ROM by compressing the map, or save RAM and runtime processing by preprocessing the map?  It really doesn't matter what you end up putting on the cart.  I think the important thing is to have your stages stored in an easy to edit format.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>poslundc wrote:</b></span></td> </tr> <tr> <td class="quote">- Undo/redo in the tool seems to me to be a weak case for the "vector" approach. These are features that serve the tool, not the end result. The tool should be working for you, not the other way round.</td> </tr></table><span class="postbody">Undo/redo is not a case for the "vector" approach.  I just thought it was interesting that an infinite level of undo/redo comes free (in programmer time) with this approach.  To undo, one merely redraws the map from scratch and executes one fewer commands.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>sajiimori wrote:</b></span></td> </tr> <tr> <td class="quote">One of the primary goals when designing such a format is to find the shortest way to describe what you want, and all things being equal, "what it is" tends to be shorter and more direct than "how to make it".</td> </tr></table><span class="postbody">
<br/>
The proposed current format, first decribes "how to make things".  Once you know how to make things, it's a matter of placing orders.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>sajiimori wrote:</b></span></td> </tr> <tr> <td class="quote">Edit: I agree with Dan about the raster approach being simpler, with an additional qualification.  The eventual goal is to have a ROM binary that meets your requirements, and it's desirable to reduce the effort needed to reach that goal.  Since the volume of tool code often meets or exceeds the volume of engine code, it's reasonable to consider approaches that make tool authoring easier.</td> </tr></table><span class="postbody">
<br/>
Undo/redo comes free (in programmer time).  I don't yet have an easy way to handle declared variables and parameters.  Parameters could probably be handled with a stack.
<br/>
<br/>
-Brendan</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#41518 - sgeos - Fri Apr 29, 2005 12:22 pm</h4>
    <div class="postbody"><span class="postbody">The names will probably change, but this is the current list of commands I plan to use.  The following are editor commands that won't be saved when the user enters them:<ul><span style="font-weight: bold">Undo</span>
<br/>
<span style="font-weight: bold">Redo</span>
<br/>
<span style="font-weight: bold">Save</span>
<br/>
<span style="font-weight: bold">SaveAs</span> <span style="font-style: italic">filename</span>
<br/>
<span style="font-weight: bold">Load</span> <span style="font-style: italic">filename</span>
<br/>
<span style="font-weight: bold">New</span> <span style="font-style: italic">x y z</span>
<br/>
<span style="font-weight: bold">Quit</span></ul>The follow are commands that will be saved when the user enters them.  Alternatively, they may be autogenerated by the frontend.<ul><span style="font-weight: bold">Orgin</span>
<br/>
<span style="font-weight: bold">MoveAbsolute</span> <span style="font-style: italic">x y z</span>
<br/>
<span style="font-weight: bold">MoveRelative</span> <span style="font-style: italic">x y z</span>
<br/>
<span style="font-weight: bold">Deselect</span>
<br/>
<span style="font-weight: bold">SelectAbsolute</span> <span style="font-style: italic">x y z</span>
<br/>
<span style="font-weight: bold">SelectRelative</span> <span style="font-style: italic">x y z</span>
<br/>
<span style="font-weight: bold">Unrotate</span>
<br/>
<span style="font-weight: bold">RotateXY</span> <span style="font-style: italic">degrees</span>
<br/>
<span style="font-weight: bold">RotateXZ</span> <span style="font-style: italic">degrees</span>
<br/>
<span style="font-weight: bold">RotateYZ</span> <span style="font-style: italic">degrees</span>
<br/>
<br/>
<span style="font-weight: bold">SetDrawShape</span> <span style="font-style: italic">mode</span>
<br/>
<span style="font-weight: bold">SetDrawAxes</span> <span style="font-style: italic">axes</span>
<br/>
<span style="font-weight: bold">SetDrawIn</span> <span style="font-style: italic">tile</span>
<br/>
<span style="font-weight: bold">SetDrawLine</span> <span style="font-style: italic">tile</span>
<br/>
<span style="font-weight: bold">SetDrawFace</span> <span style="font-style: italic">tile</span>
<br/>
<span style="font-weight: bold">SetDrawOut</span> <span style="font-style: italic">tile</span>
<br/>
<span style="font-weight: bold">SetFont</span> <span style="font-style: italic">font</span>
<br/>
<span style="font-weight: bold">SetPalette</span> <span style="font-style: italic">palette</span>
<br/>
<span style="font-weight: bold">DrawAbsolute</span>
<br/>
<span style="font-weight: bold">DrawFont</span>
<br/>
<br/>
<span style="font-weight: bold">Cut</span> <span style="font-style: italic">tile</span>
<br/>
<span style="font-weight: bold">Copy</span>
<br/>
<span style="font-weight: bold">Paste</span>
<br/>
<span style="font-weight: bold">SeedRNG</span> <span style="font-style: italic">seed</span>
<br/>
<span style="font-weight: bold">SeedRNGTime</span>
<br/>
<span style="font-weight: bold">Script</span> <span style="font-style: italic">name</span></ul>"tile" refers to either a simple tile, or a weighted list.
<br/>
<br/>
Rotation rotates the selection.  Draw shapes will be things like circle, square, arc, etc.  The draw axes determine what plane to draw the shape in.  Something like this would draw a <span style="font-style: italic">pillar</span> of ice.<ul>Select 8 8 8
<br/>
SetDrawAxes XY
<br/>
SetDrawShape Circle
<br/>
Draw Ice</ul>Clearly drawing a cube or a sphere would not pay any attention the to axes.  The shape is drawn using the DrawLine, DrawFace, DrawIn, and DrawOut values.  Not all shapes use all the values.  DrawOut will usually be NULL, but setting it another value would be an easy way to draw something like a circle inside of a square.
<br/>
<br/>
A font is a nifty way of thinking about tiles.  Instead of drawing tiles using the global absolute tileset, one draws tiles using the font.  Something like this would draw a castle room and then a cave room.<ul>SetFont CastleFont
<br/>
Script room
<br/>
Move ...
<br/>
Select ...
<br/>
SetFont CaveFont
<br/>
Script room</ul>The room script uses DrawFont wall and DrawFont floor to do it's job.
<br/>
<br/>
I currently don't have a clean way to <span style="font-style: italic">implement</span> variables and subscript parameters in the PC side tool.  Suggestions are welcome.  The format would probably look something like this.  Parameter based script calls, parameter declaration, variable declaration, and variable assignment respectively:<ul><span style="font-weight: bold">Script</span> <span style="font-weight: bold"><span style="font-style: italic">name</span></span> <span style="font-style: italic">parameters</span>
<br/>
<span style="font-weight: bold">Parameter</span> <span style="font-style: italic">#name</span>
<br/>
<span style="font-weight: bold">Variable</span> <span style="font-style: italic">$name</span>
<br/>
<span style="font-weight: bold">$variablename</span> <span style="font-weight: bold"><span style="font-style: italic">Command</span></span> <span style="font-style: italic">parameters</span>
<br/>
</ul>Parameters are read only and are declared at the top of a script.  All variables and parameters are ints.  Assuming that support for variables is added, creating accessors would be fairly simple.
<br/>
<br/>
Thoughts and feedback in general are welcome.
<br/>
<br/>
-Brendan</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
