<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Re-graphics error again - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>Graphics > Re-graphics error again</h2>
<div id="posts">
<div class="post">
    <h4>#177172 - blessingta@hotmail.co.uk - Wed Jan 11, 2012 1:47 am</h4>
    <div class="postbody"><span class="postbody">I handed in my coursework with the ridiculous graphic bug still in nearly a month ago... and long story short just recently I've gone back to it trying to fix it and I'm still hitting the same barrier.
<br/>
<br/>
Link to the gba executable
<br/>
<br/>
<a href="http://dl.dropbox.com/u/42518274/STUDENT50398201_MAKE_LINE_GAME.gba" target="_blank">http://dl.dropbox.com/u/42518274/STUDENT50398201_MAKE_LINE_GAME.gba</a>
<br/>
<br/>
<br/>
Problem:
<br/>
The sprites will refuse to render randomly, after a series of regular button presses and then randomly decide to turn back on again (the text which indicates what's suppose to be rendered demonstrates this).
<br/>
<br/>
Additional notes:
<br/>
This issue only happens in the game state (others states are fine)
<br/>
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void redcircle_sprites(int i_x_sp,int i_y_sp, int oam_pos)
<br/>
{//2x2 size
<br/>
//priority = layer 0
<br/>
if (!(oam_pos &gt; 0 &amp;&amp; oam_pos &lt; 10))
<br/>
{oam_pos = 1;}
<br/>
<br/>
int i_layer = 0;
<br/>
int i_sprite_shape = 0,i_sprite_size = 1; 
<br/>
int pallete = 3;
<br/>
///////////////////////////////////////
<br/>
///////////ANIMATE_SPRITE/////////////
<br/>
static int sprite_reference;//1;
<br/>
sprite_reference += 4;
<br/>
if (sprite_reference &gt; 9) //9 is the largest sprite
<br/>
{sprite_reference = 1;} //restart frame (loop)
<br/>
///////////////////////////////////////
<br/>
<br/>
   psMy_OAM_Sprites16[oam_pos * 4 + 0] = ((i_sprite_shape&lt;&lt;14)|(0&lt;&lt;7)|(i_y_sp&lt;&lt;0));
<br/>
    psMy_OAM_Sprites16[oam_pos * 4 + 1] = ((i_sprite_size&lt;&lt;14)|(0&lt;&lt;13)|(0&lt;&lt;12)|(0&lt;&lt;8)|(i_x_sp&lt;&lt;0));
<br/>
    psMy_OAM_Sprites16[oam_pos * 4 + 2] = ((pallete&lt;&lt;12)|(i_layer&lt;&lt;10)|(0&lt;&lt;8)|(sprite_reference&lt;&lt;0));
<br/>
    psMy_OAM_Sprites16[oam_pos * 4 + 3] = 0; 
<br/>
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
<br/>
//this is the code I use to clear the screen every frame, which works relatively well.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void clear_sprites()
<br/>
{
<br/>
int ixasm = 0;
<br/>
while (ixasm &lt; 512)
<br/>
{
<br/>
   //do stuff here
<br/>
   psMy_OAM_Sprites16[ixasm] = 0; 
<br/>
   ixasm++;
<br/>
}      
<br/>
}
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#177173 - Dwedit - Wed Jan 11, 2012 2:21 am</h4>
    <div class="postbody"><span class="postbody">I'm seeing tons of bugs here...
<br/>
If you hit any button that isn't start immediately after booting the rom, it proceeds to write a bunch of bytes to an address starting at NULL.  Then it keeps trying to do that at various points in the program.
<br/>
<br/>
From what I can see, it appears to be some sort of Tic-Tac-Toe game.
<br/>
<br/>
If you win, it jumps to address 0 and crashes.<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#177177 - headspin - Thu Jan 12, 2012 10:45 am</h4>
    <div class="postbody"><span class="postbody">Also (0 &lt;&lt; 7) does nothing. You can't bit shift 0. If you need to set a bit use 1. ie. (1 &lt;&lt; 7)<br/>_________________<br/><a class="postlink" href="http://headsoft.com.au/index.php?category=warhawk" target="_blank">Warhawk DS</a> | <a class="postlink" href="http://headsoft.com.au/index.php?category=mmll" target="_blank">Manic Miner: The Lost Levels</a> | <a class="postlink" href="http://headsoft.com.au/index.php?category=tdg" target="_blank">The Detective Game</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#177187 - blessingta@hotmail.co.uk - Sun Jan 15, 2012 12:35 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Dwedit wrote:</b></span></td> </tr> <tr> <td class="quote">I'm seeing tons of bugs here...
<br/>
If you hit any button that isn't start immediately after booting the rom, it proceeds to write a bunch of bytes to an address starting at NULL.  Then it keeps trying to do that at various points in the program.
<br/>
<br/>
From what I can see, it appears to be some sort of Tic-Tac-Toe game.
<br/>
<br/>
If you win, it jumps to address 0 and crashes.</td> </tr></table><span class="postbody">
<br/>
<br/>
Yes it is a tic tac toe "remix" to say. (it deletes the winner's pieces after they are arranged in a line (adds 100 points), then it makes the player use the alternate pieces: the process repeats for five minutes and it displays the final score)
<br/>
<br/>
@Writes to a bunch of bytes
<br/>
It is meant to write to a bunch of bytes because when a key is pressed it is written into an unsigned char which is listen for at various points within the program. IE
<br/>
<br/>
If (A and B pressed) ucKeyMessage = anb_pressed
<br/>
if (B pressed)... 
<br/>
<br/>
here is an updated version with a few more bugs iron out (though issue still persists):
<br/>
<br/>
<a href="http://dl.dropbox.com/u/42518274/STUDENT50398201_MAKE_LINE_GAME.gba" target="_blank">http://dl.dropbox.com/u/42518274/STUDENT50398201_MAKE_LINE_GAME.gba</a>
<br/>
<br/>
Plus here is my project (Its written in fairly tidy way with headerfiles and cfiles being to separate individual components). 
<br/>
<br/>
<a href="http://dl.dropbox.com/u/42518274/STUDENT50398201_MAKE_LINE_GAME.rar" target="_blank">http://dl.dropbox.com/u/42518274/STUDENT50398201_MAKE_LINE_GAME.rar</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#177188 - blessingta@hotmail.co.uk - Sun Jan 15, 2012 12:38 am</h4>
    <div class="postbody"><span class="postbody">the graphics bugs really consumed an unhealthy amount of my time (which is the root course of not having a lot of the other stuff iron out)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#177190 - Cearn - Sun Jan 15, 2012 12:38 pm</h4>
    <div class="postbody"><span class="postbody">Here's a few more random (potential) problems.
<br/>
<br/>
<ul><li>When compiling, there are a few undeclared/undefined variables and functions warnings. Best to get those sorted out.
<br/>
</li><li>Your graphics converter does not output 'const' arrays. <span style="font-weight: bold">THIS IS BAD!</span> Without 'const', the data goes into IWRAM (8000h bytes) instead of ROM. IWRAM is currently filled up to ~0300:7000. If you were to add anymore graphics data, you'd probably run out completely and then you'd really be in trouble.
<br/>
</li><li>The reason the 'Makeline' text goes bad is twofold. First, it starts at tile 33, not 36. Second, there's a empty tile missing after the 'A', which misaligns the letters after it.
<br/>
</li><li>clear_sprites() doesn't actually clear the sprites; it just sets all of them to a 8x8 size sprite with an empty tile. As far as I know, this still counts towards the sprite-pixel limit that each line has. Instead, use something like this:
<br/>
</li></ul></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
// OBJATTR is a struct for sprites located inside &lt;gba_sprites.h&gt;
<br/>
// Please use it instead of just an u16 array, 
<br/>
// and its bit defines instead of magic numbers and shifts.
<br/>
#include &lt;gba_sprites.h&gt;
<br/>
<br/>
void clear_sprites()
<br/>
{
<br/>
   int i;
<br/>
   OBJATTR *oam= (OBJATTR*)psMy_OAM_Sprites16;
<br/>
   
<br/>
   for(i=0; i&lt;128; i++)
<br/>
   {
<br/>
      oam[i].attr0= OBJ_DISABLE;      // This actually disables sprites.
<br/>
      oam[i].attr1= 0;
<br/>
      oam[i].attr2= 0;
<br/>
      oam[i].dummy= 0;
<br/>
   }
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<li>And here's one that might actually be related to the non-random blinking and disappearing of the dots. Inside redcircle_sprites() and bluecircle_sprites(), you're using a static variable to keep track of the animation state, which runs in a {1,5,9} loop. However, becuase it's a static variable, it's effectively shared between all sprites of that type. This means that things get tricky once you have multiple sprites, because the animation states of the different sprites will interfere with eachother. For example with 2 sprites, you'd get 
<br/>
</li></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">sprite 1: 1 9 5 1 ...
<br/>
sprite 2: 5 1 9 5 ...
<br/>
</td> </tr></table><span class="postbody">
<br/>
and with 3 you'd get
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">sprite 1: 1 1 1
<br/>
sprite 2: 5 5 5
<br/>
sprite 3: 9 9 9 ...
<br/>
</td> </tr></table><span class="postbody">
<br/>
The easiest way to fix this would be to store the animation state separately for each dot. Create a Dot struct with color and animation state and use that to define the gameboard. If you condense blue/redcircle_sprites() to a single function that just used a Dot instance to do it's work, you can condense Render_gameboard() to a &lt;5 line for-loop using some simple table lookups for the differences between red and blue.
<br/>
<li>If you have a switch-block where the cases different only by a number/string, it's often simpler to use a lookup table or some arithmetic instead. Example:
<br/>
</li></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">switch(position)
<br/>
{
<br/>
case 1:
<br/>
   x= 30;
<br/>
   y= 40;
<br/>
   break;
<br/>
case 2:
<br/>
   x= 60;
<br/>
   y= 40;
<br/>
   break;
<br/>
<br/>
// ... 7 more cases.
<br/>
<br/>
}
<br/>
<br/>
<br/>
// or, via lookup
<br/>
<br/>
static const int coordinates[9][2]= { {30,40}, {60,40}, ...  };
<br/>
<br/>
x= coordinates[position][0];
<br/>
y= coordinates[position][1];
<br/>
<br/>
<br/>
// or, via arithmatic (note, slow on GBA because of division)
<br/>
<br/>
x= (position-1)%3 * 30 + 30;
<br/>
y= (position-1)/3 * 30 + 40;
<br/>
<br/>
</td> </tr></table><span class="postbody">
<br/>
</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
