<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Making a scrolling background larger than 256x256 - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>Graphics > Making a scrolling background larger than 256x256</h2>
<div id="posts">
<div class="post">
    <h4>#65714 - gs2phateon - Thu Jan 05, 2006 3:49 am</h4>
    <div class="postbody"><span class="postbody">I have been able to make a 256x256 scrolling background without too much difficulty, but I just can't seem to draw a 512x256 sized background.  I'm using Mode 0.  I changed the part that defines the size of the map, and when I run the program, the scrolling area does seem to be the right size (it'll scroll twice as far horizontally as verticall).
<br/>
<br/>
The map itself doesn't seem to have any problems either.  I changed the program to account for the number of tiles, size of the map, and palette, so I don't think the problem lies there.
<br/>
<br/>
The map that actually shows up is a bit difficult to explain.  It's supposed to just read:
<br/>
-------------------------
<br/>
 Hi! My Name is
<br/>
     (my name)          
<br/>
-------------------------
<br/>
The tiles are pretty messed up though.  The words "Hi! My" look OK, except they seem to be missing all the tiles every other row.  The words "Name is" have the same problem, but they are not on the same row as the first two, rather they are right underneath.  Finally, my name is not underneath "Hi! My Name is", but it's sort of mixed in with all the other letters.  It has the same problem of missing every other row of tiles. Do you think it's a map problem, like I should just try and make a new map?  Or is there a bigger part of the code that I may be missing?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#65722 - tepples - Thu Jan 05, 2006 5:45 am</h4>
    <div class="postbody"><span class="postbody">A 512x256 text map is stored as two 256x256 maps side-by-side: 32 rows of 32 tiles for the left half, and then 32 rows of 32 tiles for the right half. The NES and Super NES used the same layout for their 512-pixel-wide maps that the GBA uses.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#65841 - gs2phateon - Fri Jan 06, 2006 1:58 am</h4>
    <div class="postbody"><span class="postbody">Umm, I guess the problem I'm having is pretty hard to explain.  I'll just start with one thing first.  What is happening is that every other row is off maybe about 2 tiles.  I also tried making a 512x512 map.
<br/>
<br/>
For example a straight line that should look like:
<br/>
|
<br/>
|
<br/>
|
<br/>
|
<br/>
|
<br/>
<br/>
Ends up looking like:
<br/>
|
<br/>
xx|
<br/>
|
<br/>
xx|
<br/>
|
<br/>
<br/>
(pretend the x's are the missing tiles)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#66509 - pure_ev1l - Wed Jan 11, 2006 2:08 pm</h4>
    <div class="postbody"><span class="postbody">its easy. I have only been programing for GBA for 4 days now, and I have made my own map editor with infinite size capabilities with some good tools and a gba game that can play any size map with no (visible) loading
<br/>
<br/>
all you need to do is if u move 1 tile left load a line of tiles down the left side off screen....
<br/>
<br/>
the only limittation of it is the fact that I ran out of virtual memory on my comp trying to compile a map bigger than 1024*1024 tiles....
<br/>
<br/>
but if I would have been able to compile it, it would have played.
<br/>
<br/>
if what I'm saying applies to your problem then with a slight grudge I could part with my source code for dynamic loading of an infinite map?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#66547 - tepples - Wed Jan 11, 2006 10:00 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>pure_ev1l wrote:</b></span></td> </tr> <tr> <td class="quote">all you need to do is if u move 1 tile left load a line of tiles down the left side off screen....</td> </tr></table><span class="postbody">
<br/>
And for an illustration of this, run any NES game in Nintendulator and look at the "nametables" (the NES term for maps).
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">the only limittation of it is the fact that I ran out of virtual memory on my comp trying to compile a map bigger than 1024*1024 tiles</td> </tr></table><span class="postbody">
<br/>
That's why you shouldn't output your maps to .c files. Instead, output them to .s files, as the assembler is much more efficient than the C compiler at handling large const arrays.
<br/>
<br/>
But wouldn't such a map (16 bits per tile, 1024 tiles wide, 1024 tiles tall) take half of a 32 Mbit ROM anyway?
<br/>
<br/>
<span style="font-style: italic">Discussion of including assets in a GBA binary continues in <a class="postlink" href="http://forum.gbadev.org/viewtopic.php?t=8115" target="_blank">this topic</a>.</span><br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#90282 - king501 - Thu Jun 29, 2006 7:36 am</h4>
    <div class="postbody"><span class="postbody">Of course, I?m planning to use TONC notes in a very near future, but right now I just would like to understand how to set a 512x512 map using Jharbour?s code source.  Let?s suppose I would like to use a 512x512 background map, what should I add in this code?
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">   //create a pointer to background 0 tilemap buffer
<br/>
    unsigned short* bg0map =(unsigned short*)ScreenBaseBlock(28);
<br/>
<br/>
    //set up background 0
<br/>
	REG_BG0CNT = BG_COLOR256 | TEXTBG_SIZE_256x256 |
<br/>
        (31 &lt;&lt; SCREEN_SHIFT);
<br/>
<br/>
	//set video mode 0 with background 0
<br/>
	SetMode(0 | BG0_ENABLE);
<br/>
<br/>
	//copy the palette into the background palette memory
<br/>
	DMAFastCopy((void*)test_Palette, (void*)BGPaletteMem,
<br/>
        256, DMA_16NOW);
<br/>
<br/>
	//copy the tile images into the tile memory
<br/>
	DMAFastCopy((void*)test_Tiles, (void*)CharBaseBlock(0),
<br/>
        57984/4, DMA_32NOW);
<br/>
<br/>
	//copy the tile map into background 0
<br/>
	DMAFastCopy((void*)test_Map, (void*)bg0map, 512, DMA_32NOW);</td> </tr></table><span class="postbody">
<br/>
<br/>
so far I know that a screenblock is big enough for a 256x256 piece, and that 4 screenblocks are needed for a 512x512 map.
<br/>
<br/>
I tried many possibilities, but in vain. Could someone modify the above code source and adapt it for a 512x512 map? Making comparaison truly help me understanding stuff.
<br/>
<br/>
Thanks!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#90290 - Cearn - Thu Jun 29, 2006 9:35 am</h4>
    <div class="postbody"><span class="postbody"><ul><li>Instead of TEXTBG_SIZE_256x256, use TEXTBG_SIZE_256x512.
<br/>
</li><li>Make sure that the map editor correctly divides the map into 4 screen base blocks (SBB). If not, be prepared to do it manually.</li><li>Put the map data into the screenblock(s) that you told the GBA you were going to use. I'm mentioning this because this isn't the case in the code you posted: bg0map=SBB 28, but REG_BG0CNT indicates SBB 31. Same goes for tile data, of course. Also, make sure that the map and tiles actually fit into BG-VRAM: starting your big map at SBBs 31 means ? of the map is actually in OBJ VRAM and funkyness ensues.</li><li>Should I mention possible alignment problems when you #include data and use 16 or 32 bit copies? Nah, I'll give it a miss this time.</li></ul>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">// Move the useless casts that DMAFastCopy requires to the top
<br/>
u16 *palsrc=  (u16*)test_Palette, *paldst=  (u16*)BGPaletteMem;
<br/>
u16 *tilesrc= (u16*)test_Tiles,   *tiledst= (u16*)CharBaseBlock(0);
<br/>
u16 *mapsrc=  (u16*)test_Map,     *mapdst=  (u16*)ScreenBaseBlock(28);
<br/>
<br/>
REG_BG0CNT= BG_COLOR256 | TEXTBG_SIZE_512x512 | (28&lt;&lt;SCREEN_SHIFT) | (0&lt;&lt;CHAR_SHIFT);
<br/>
REG_DISPCNT= 0 | BG0_ENABLE;
<br/>
<br/>
// Copy stuff via DMA16 (or DMA32, your choice)
<br/>
// Replace 'foo_Size' with the real sizes in bytes.
<br/>
DMAFastCopy(palsrc, paldst, pal_Size/2, DMA_16NOW); 
<br/>
DMAFastCopy(tilesrc, tiledst, tile_Size/2, DMA_16NOW); 
<br/>
DMAFastCopy(mapsrc, mapdst, map_Size/2, DMA_16NOW); 
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#90347 - king501 - Thu Jun 29, 2006 8:35 pm</h4>
    <div class="postbody"><span class="postbody">My head is going to blow up. I?m a slow learner :| Sometime I can understand things pretty quickly, and sometime it seems to be totally impossible. 
<br/>
<br/>
Cearn, I don?t know if you will accept this, but is it possible for you to make me a small zipped program with the minimal defines, minimal functions so I can just focus my attention to what is really required to use a 512x512 map? 
<br/>
<br/>
Sometime learning with little chunk of code is really helpful? 
<br/>
<br/>
I?m trying to learn from TONC (it?s your website, right?), but it?s quite hard for a guy like me to learn from multiple big source files and track down every piece of code to understand the basic. 
<br/>
<br/>
Anyone else wanting to help could be appreciated too.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#90364 - Cearn - Thu Jun 29, 2006 10:34 pm</h4>
    <div class="postbody"><span class="postbody">The size of the background is determined by the two top bits of REG_BGxCNT; (0&lt;&lt;14) means a 256x256p map, (3&lt;&lt;14) means a 512x512p map. In the code you have these are defined as TEXTBG_SIZE_256x256 and TEXTBG_SIZE_512x512, respectively, so when setting REG_BG0CNT use the second one instead of the first and BAM! instant 512x512 map.
<br/>
<br/>
Well, mostly. Even though that would make the bg a 512 by 512 map, you'd still need 3 more screenblocks worth of map-data. And in your case you can't put that data after sbb 31 because that's where the VRAM of objects starts. So you'll have to use another sbb instead. 28 for example. 
<br/>
<br/>
Just create a few easily discernible tiles, and make each of the screenblocks that make up the 512x512 map use those tiles. Load it up in VBA, look at the tile and map viewers and see if you can see the pattern.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>king501 wrote:</b></span></td> </tr> <tr> <td class="quote">but it?s quite hard for a guy like me to learn from multiple big source files and track down every piece of code to understand the basic. </td> </tr></table><span class="postbody">
<br/>
<a class="postlink" href="http://user.chem.tue.nl/jakvijn/files/map512.c" target="_blank">this</a> about as minimal as I'd care to get. Any more and I'm really down to raw hex on everything :P.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#90368 - king501 - Thu Jun 29, 2006 11:09 pm</h4>
    <div class="postbody"><span class="postbody"><span style="font-size: 24px; line-height: normal">THANKS</span> Cearn!! It's too bad I couldn't use a bigger font for thanking you!! haha
<br/>
<br/>
Now I'm really getting the logic behind all this.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#90426 - king501 - Fri Jun 30, 2006 6:12 am</h4>
    <div class="postbody"><span class="postbody">All things considered, even though that I understand more clearly how  screenblocks work now, this part confuses me a little;
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">// Four tiles, one for each screenblock of the 64x64t map
<br/>
TILE testTiles[4]= 
<br/>
{
<br/>
    {{ 0x11111111, 0x0111FF11, 0x011F11F1, 0x011F11F1, 
<br/>
      0x011F11F1, 0x0111FF11, 0x01111111, 0x00000001  }}, 
<br/>
    {{ 0x22222222, 0x0222F222, 0x0222FF22, 0x0222F222, 
<br/>
      0x0222F222, 0x022FFF22, 0x02222222, 0x00000002  }}, 
<br/>
    {{ 0x33333333, 0x033FFF33, 0x03F33333, 0x033F3333, 
<br/>
      0x0333F333, 0x03FFFF33, 0x03333333, 0x00000003  }}, 
<br/>
    {{ 0x44444444, 0x044FFF44, 0x04F44444, 0x044FF444, 
<br/>
      0x04F44444, 0x044FFF44, 0x04444444, 0x00000004  }}
<br/>
};</td> </tr></table><span class="postbody">
<br/>
<br/>
How was it possible for you to draw four 8x8 tiles using only 8 elements per array? Isn?t an 8x8 tile supposed to use an array of 64 elements (64 pixels)?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#90434 - DekuTree64 - Fri Jun 30, 2006 6:39 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>king501 wrote:</b></span></td> </tr> <tr> <td class="quote">How was it possible for you to draw four 8x8 tiles using only 8 elements per array? Isn?t an 8x8 tile supposed to use an array of 64 elements (64 pixels)?</td> </tr></table><span class="postbody">
<br/>
Yep, but each pixel is only 4 bits, and each element in that array is 32 bits, so there are 8 pixels in each element. Also notice that each hex digit has 16 possible values, which happens to correspond to 4 bits, so basically each digit is a pixel.
<br/>
<br/>
You can arrange them vertically like this for a more clear view of each tile:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">TILE testTiles[4]= 
<br/>
{ 
<br/>
    {{ 0x11111111,
<br/>
       0x0111FF11,
<br/>
       0x011F11F1,
<br/>
       0x011F11F1, 
<br/>
       0x011F11F1,
<br/>
       0x0111FF11,
<br/>
       0x01111111,
<br/>
       0x00000001  }}, 
<br/>
...</td> </tr></table><span class="postbody">
<br/>
It will actually appear horizontally flipped from that in the game, because numbers go most-significant to least-significant, but it's still a handy way to 'draw' tiles in code :)<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#90448 - king501 - Fri Jun 30, 2006 7:32 am</h4>
    <div class="postbody"><span class="postbody">I would have never guessed it by myself... Thanks!
<br/>
<br/>
This part almost sounds like the DaVinci Code :P</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#90544 - tepples - Fri Jun 30, 2006 7:24 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>king501 wrote:</b></span></td> </tr> <tr> <td class="quote">This part almost sounds like the DaVinci Code :P</td> </tr></table><span class="postbody">
<br/>
If you turn <span style="font-style: italic">Mona Lisa</span> into a GBA tile set, then it's <span style="font-style: italic">really</span> the Da Vinci Code :-)<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#90594 - king501 - Sat Jul 01, 2006 4:30 am</h4>
    <div class="postbody"><span class="postbody">There's something else I'm not quite sure...
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">typedef unsigned char  u8,  byte;
<br/>
typedef unsigned short u16, hword;
<br/>
typedef unsigned int   u32, word;
<br/>
<br/>
typedef signed char  s8;
<br/>
typedef signed short s16; 
<br/>
typedef signed int   s32;
<br/>
<br/>
typedef struct { u32 data[8];  } TILE;
<br/>
<br/>
typedef TILE     CHARBLOCK[512];
<br/>
typedef u16   SCREENBLOCK[1024];</td> </tr></table><span class="postbody">
<br/>
<br/>
this line;
<br/>
<br/>
typedef TILE     CHARBLOCK[512];
<br/>
<br/>
if I understand well, it's a new type size? so it's 512 * 32 (u32 from TILE structure)?
<br/>
<br/>
and 512*32 = 16 334 (16kb), the size needed for a Char Base Block?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#90631 - Cearn - Sat Jul 01, 2006 11:21 am</h4>
    <div class="postbody"><span class="postbody">Aye, that's exactly it.
<br/>
<br/>
The reason behind the TILE struct and CHARBLOCK typedef is that I can have  the whole of VRAM mapped as a double-indexed array, which would be tile_mem. tile_mem[cbb][tl] is the tile <span style="font-style: italic">tl</span> of charblock <span style="font-style: italic">cbb</span>, which you can either assign a tile to directly (as done in the demo code), or take the address of (&amp;tile_mem[cbb][tl]) and pass to memcpy etc for larger copies. You can do something similar with macros if you like, but actually imposing a memory map over the whole thing feels more natural to me. Just as long as you're not entering tile and screen entry addresses manually.
<br/>
<br/>
<a class="postlink" href="http://user.chem.tue.nl/jakvijn/tonc/objbg.htm#ssec-img-cbb" target="_blank">Leetle more ...</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#91295 - king501 - Thu Jul 06, 2006 4:06 am</h4>
    <div class="postbody"><span class="postbody">Can you tell me if I am right?
<br/>
<br/>
1 tile = 32bytes?
<br/>
<br/>
so we can enter a total of 512 tiles (16384 bytes / 32 bytes) in 1 Char Block?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#91299 - tepples - Thu Jul 06, 2006 4:16 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>king501 wrote:</b></span></td> </tr> <tr> <td class="quote">Can you tell me if I am right?
<br/>
<br/>
1 tile = 32bytes?</td> </tr></table><span class="postbody">
<br/>
Correct in 16 colors.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">so we can enter a total of 512 tiles (16384 bytes / 32 bytes) in 1 Char Block?</td> </tr></table><span class="postbody">
<br/>
A background in a 16-color tiled mode can refer to tiles in one Char Block and the one following it, for a total of 1024.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#91313 - king501 - Thu Jul 06, 2006 7:53 am</h4>
    <div class="postbody"><span class="postbody">so we cannot use 3 char blocks to load graphics tiles and use the 8 last screen blocks only for tile entries?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#91348 - tepples - Thu Jul 06, 2006 4:51 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>king501 wrote:</b></span></td> </tr> <tr> <td class="quote">so we cannot use 3 char blocks to load graphics tiles and use the 8 last screen blocks only for tile entries?</td> </tr></table><span class="postbody">
<br/>
You can set each background at its own Char Block, but a single background can see only 1024 of the 2048 tiles.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
