<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>help!! multiple maps won't work for me!!! - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>Graphics > help!! multiple maps won't work for me!!!</h2>
<div id="posts">
<div class="post">
    <h4>#11848 - goro - Tue Oct 21, 2003 4:45 pm</h4>
    <div class="postbody"><span class="postbody">hi,
<br/>
<br/>
my bg1 seems to scroll perfectly, but bg2 wont budge an inch (or a pixel in this case!) and if I swap the bg numbers (in the struct-fill in main) bg2 scrolls but not bg1. There's obviously a problem with updating multiple backgrounds but I can't find it!!
<br/>
<br/>
here's some of my code...pleaase help!!
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
Bg bg1;
<br/>
Bg bg2;
<br/>
<br/>
void EnableBackground(Bg* bg)
<br/>
{
<br/>
   u16 temp;
<br/>
   bg-&gt;tileData = (u16*)CharBaseBlock(bg-&gt;charBaseBlock);
<br/>
   bg-&gt;mapData = (u16*)ScreenBaseBlock(bg-&gt;screenBaseBlock);
<br/>
   temp = bg-&gt;size | (bg-&gt;charBaseBlock&lt;&lt;CHAR_SHIFT) | (bg-&gt;screenBaseBlock&lt;&lt;SCREEN_SHIFT)
<br/>
      | bg-&gt;colorMode | bg-&gt;mosaic | bg-&gt;wraparound;
<br/>
<br/>
   switch(bg-&gt;number)
<br/>
   {
<br/>
   case 0:
<br/>
      {
<br/>
         REG_BG0CNT = temp;
<br/>
         REG_DISPCNT |= BG0_ENABLE;
<br/>
      }break;
<br/>
   case 1:
<br/>
      {
<br/>
         REG_BG1CNT = temp;
<br/>
         REG_DISPCNT |= BG1_ENABLE;
<br/>
      }break;
<br/>
   case 2:
<br/>
      {
<br/>
         REG_BG2CNT = temp;
<br/>
         REG_DISPCNT |= BG2_ENABLE;
<br/>
      }break;
<br/>
   case 3:
<br/>
      {
<br/>
         REG_BG3CNT = temp;
<br/>
         REG_DISPCNT |= BG3_ENABLE;
<br/>
      }break;
<br/>
<br/>
   default:break;
<br/>
<br/>
   }
<br/>
}
<br/>
<br/>
<br/>
void UpdateBackground(Bg* bg)
<br/>
{
<br/>
   switch(bg-&gt;number)
<br/>
   {
<br/>
   case 0:
<br/>
      REG_BG0HOFS = bg-&gt;x_scroll;
<br/>
      REG_BG0VOFS = bg-&gt;y_scroll;
<br/>
      break;
<br/>
   case 1:
<br/>
      REG_BG1HOFS = bg-&gt;x_scroll;
<br/>
      REG_BG1VOFS = bg-&gt;y_scroll;
<br/>
      break;
<br/>
   case 2:
<br/>
      if(!(REG_DISPCNT &amp; MODE_0))//it is a rot background
<br/>
      {
<br/>
         REG_BG2X = bg-&gt;DX;
<br/>
         REG_BG2Y = bg-&gt;DY;
<br/>
<br/>
         REG_BG2PA = bg-&gt;PA;
<br/>
         REG_BG2PB = bg-&gt;PB;
<br/>
         REG_BG2PC = bg-&gt;PC;
<br/>
         REG_BG2PD = bg-&gt;PD;
<br/>
      }
<br/>
      else  //it is a text background
<br/>
      {
<br/>
         REG_BG2HOFS = bg-&gt;x_scroll;
<br/>
         REG_BG2VOFS = bg-&gt;y_scroll;
<br/>
      }
<br/>
      break;
<br/>
   case 3:
<br/>
      if(!(REG_DISPCNT &amp; MODE_0))//it is a rot background
<br/>
      {
<br/>
         REG_BG3X = bg-&gt;DX;
<br/>
         REG_BG3Y = bg-&gt;DY;
<br/>
<br/>
         REG_BG3PA = bg-&gt;PA;
<br/>
         REG_BG3PB = bg-&gt;PB;
<br/>
         REG_BG3PC = bg-&gt;PC;
<br/>
         REG_BG3PD = bg-&gt;PD;
<br/>
      }
<br/>
      else //it is a text background
<br/>
      {
<br/>
         REG_BG3HOFS = bg-&gt;x_scroll;
<br/>
         REG_BG3VOFS = bg-&gt;y_scroll;
<br/>
      }
<br/>
      break;
<br/>
   default: break;
<br/>
   }
<br/>
}</td> </tr></table><span class="postbody">
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">if(!(*KEYS &amp; KEY_RIGHT))
<br/>
   {
<br/>
      
<br/>
      if ( bg1.x_scroll &lt; 1792 ) // stop scrolling at far right.
<br/>
      {         
<br/>
         if (hero_posx &lt; 100)
<br/>
         {
<br/>
            hero_posx++;
<br/>
            // other stuff
<br/>
         }
<br/>
         else
<br/>
         {
<br/>
         bg2.x_scroll++;
<br/>
         bg1.x_scroll++;
<br/>
         ScrollBg();
<br/>
         
<br/>
         // other stuff
<br/>
         }
<br/>
      }
<br/>
      else
<br/>
      {
<br/>
         hero_posx++;
<br/>
         // other stuff      }
<br/>
      
<br/>
   }</td> </tr></table><span class="postbody">
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">int main(void)
<br/>
{
<br/>
   
<br/>
   u16 loop;
<br/>
   
<br/>
   // Bg initialisation
<br/>
   SetMode( MODE_0 | BG1_ENABLE | BG2_ENABLE | OBJ_MAP_1D | OBJ_ENABLE);
<br/>
<br/>
   bg1.charBaseBlock = 0;
<br/>
   bg1.colorMode = BG_COLOR16;
<br/>
   bg1.mosaic = 0;
<br/>
   bg1.screenBaseBlock = 28;
<br/>
   bg1.size = TEXTBG_SIZE_256x256;
<br/>
   bg1.x_scroll = 8;
<br/>
   bg1.y_scroll = 80;
<br/>
   bg1.number = 1;
<br/>
<br/>
   bg2.charBaseBlock = 16;
<br/>
   bg2.colorMode = BG_COLOR16;
<br/>
   bg2.mosaic = 0;
<br/>
   bg2.screenBaseBlock = 30;
<br/>
   bg2.size = TEXTBG_SIZE_256x256;
<br/>
   bg2.x_scroll = 8;
<br/>
   bg2.y_scroll =80;
<br/>
   bg2.number = 2;
<br/>
<br/>
   EnableBackground(&amp;bg1);
<br/>
   EnableBackground(&amp;bg2);</td> </tr></table><span class="postbody">
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">while(1)
<br/>
   {
<br/>
      
<br/>
      GetInput();    //check for input
<br/>
      WaitForVblank();
<br/>
<br/>
      //waits for the screen to stop drawing
<br/>
      UpdateBackground(&amp;bg2); //make sure registers are updated if anything changes e.g. scrolling
<br/>
      UpdateBackground(&amp;bg1);
<br/>
      
<br/>
      CopyOAM();// Update sprite stuff
<br/>
      
<br/>
<br/>
            
<br/>
      }</td> </tr></table><span class="postbody"></span><span class="gensmall"><br/><br/>Last edited by goro on Wed Oct 22, 2003 1:28 pm; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#11851 - sajiimori - Tue Oct 21, 2003 6:23 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
if(!(REG_DISPCNT &amp; MODE_0))//it is a rot background 
<br/>
</td> </tr></table><span class="postbody">
<br/>
That expression is actually true when you're in mode 0, because MODE_0 is defined as 0 (assuming your defines are the same as everybody else's), and anything bitwise-and'ed with 0 is still 0.
<br/>
<br/>
You probably wanted this:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
#define MODE_FIELD 7
<br/>
if(REG_DISPCNT &amp; MODE_FIELD != MODE_0)
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#11865 - goro - Wed Oct 22, 2003 1:35 pm</h4>
    <div class="postbody"><span class="postbody">MODE_FIELD?
<br/>
<br/>
that is not defined in my gba.h file. I need to define it where?
<br/>
<br/>
I don't think that's the answer because my bg1 scrolls with that code but bg2 will not.
<br/>
<br/>
-(I'm trying to create multi-paralax scrolling.)
<br/>
<br/>
PLEASE HELP!!!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#11869 - niltsair - Wed Oct 22, 2003 3:19 pm</h4>
    <div class="postbody"><span class="postbody">Yes this is the problem.  
<br/>
<br/>
BG1 Scroll because it's doesn't evaluate that predicate. BG2 don't because it evaluate that predicate that always return false the way you setup it.
<br/>
<br/>
MODE_0 = 0 thus making and AND with this value, will yield 0 with everything.
<br/>
<br/>
MODE_FIELD is just a name sajiimori came up with to represent all video mode but Mode_0. Give it another meaningfull name if you want. As fo rthe define, it's right on top of where he's using the value. Just define it wherever you feel like.
<br/>
<br/>
Or, if you already you won't be using any other video mode but 0, thne just remove the would 'if xxxxxxxxxxxxxx' predicate.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">if(!(REG_DISPCNT &amp; MODE_0))//it is a rot background
<br/>
      {
<br/>
         REG_BG2X = bg-&gt;DX;
<br/>
         REG_BG2Y = bg-&gt;DY;
<br/>
<br/>
         REG_BG2PA = bg-&gt;PA;
<br/>
         REG_BG2PB = bg-&gt;PB;
<br/>
         REG_BG2PC = bg-&gt;PC;
<br/>
         REG_BG2PD = bg-&gt;PD;
<br/>
      }
<br/>
      else  //it is a text background
<br/>
      {
<br/>
         REG_BG2HOFS = bg-&gt;x_scroll;
<br/>
         REG_BG2VOFS = bg-&gt;y_scroll;
<br/>
      }
<br/>
<br/>
TO
<br/>
         REG_BG2HOFS = bg-&gt;x_scroll;
<br/>
         REG_BG2VOFS = bg-&gt;y_scroll;  </td> </tr></table><span class="postbody">
<br/>
<br/>
*edit* I didn't paid enough attention, and left the wrong part in the code, changed it to be ok.<br/>_________________<br/>-Inside every large program is a small program struggling to get out. (Hoare's Law of Large Programs)
<br/>
-The man who can smile when things go wrong has thought of someone he can blame it on. (Nixon's Theorem)</span><span class="gensmall"><br/><br/>Last edited by niltsair on Wed Oct 22, 2003 6:42 pm; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#11874 - sajiimori - Wed Oct 22, 2003 6:26 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
that is not defined in my gba.h file. I need to define it where? 
<br/>
</td> </tr></table><span class="postbody">
<br/>
Anywhere before you use it.  You could simply add it to your gba.h.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
I don't think that's the answer because my bg1 scrolls with that code but bg2 will not. 
<br/>
</td> </tr></table><span class="postbody">
<br/>
Perhaps there is another problem as well, but maybe you should actually try to fix this bug before you come back asking for more help.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
MODE_FIELD is just a name sajiimori came up with to represent all video mode but Mode_0.
<br/>
</td> </tr></table><span class="postbody">
<br/>
Actually, it's a mask to isolate the bits that specify the video mode (including mode 0).  We're isolating the low 3 bits, so its value in binary is 111 (or 7 in decimal).
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
Or, if you already you won't be using any other video mode but 0, thne just remove the would 'if xxxxxxxxxxxxxx' predicate.
<br/>
</td> </tr></table><span class="postbody">
<br/>
True, but only if you erase the right part of the code.  The part you left in your example was for modes other than 0.  ;-)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#11895 - goro - Thu Oct 23, 2003 8:44 am</h4>
    <div class="postbody"><span class="postbody">Thanks.
<br/>
<br/>
It wuz exactly what you guys said.
<br/>
<br/>
- Those GBA Junkie tutorials are just so full of bugs!!!
<br/>
<br/>
-But I am a newbie so I guess I should accept some responsibility for not noticing them...
<br/>
<br/>
<br/>
Thanks again guys!!!</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
