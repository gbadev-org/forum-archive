<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>When moving tiles the screen flickers. - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>Graphics > When moving tiles the screen flickers.</h2>
<div id="posts">
<div class="post">
    <h4>#8076 - Archeious - Tue Jul 01, 2003 5:36 pm</h4>
    <div class="postbody"><span class="postbody">I thought the following code would work but I am getting intermitent skipping.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
	while (1) {
<br/>
		RotateBackground(&amp;bg3,angle,119,79,zoom); //set center of screen
<br/>
		inputResponse=process_Input();
<br/>
		WaitForVsync();
<br/>
<br/>
		if (inputResponse &amp; MAP_MOVERIGHT) {
<br/>
			bg3.x_scroll++;
<br/>
			bg3.x_display++;
<br/>
			if (bg3.x_scroll &gt; 151) {
<br/>
				bg3.x_scroll = 136;
<br/>
				x+=2;
<br/>
				REG_DM3SAD = (u32)bg3.mapData+2;
<br/>
				REG_DM3DAD = (u32)bg3.mapData;
<br/>
				REG_DM3CNT = 2048 | DMA_16NOW; // width*height / 2 = 2048
<br/>
				test = (u16*)bg3.mapData;
<br/>
				for (loop=0;loop&lt;=22;loop++) {
<br/>
					test[(loop*32)+16] = myMap-&gt;data[(loop*myMap-&gt;width)+x+32] | (myMap-&gt;data[(loop*myMap-&gt;width)+x+33] &lt;&lt; 8);
<br/>
				}
<br/>
			}
<br/>
		}
<br/>
<br/>
		if (inputResponse &amp; MAP_MOVELEFT) {
<br/>
			bg3.x_scroll--;
<br/>
			bg3.x_display++;
<br/>
			if (bg3.x_scroll &lt; 121) {
<br/>
				bg3.x_scroll = 136;
<br/>
				REG_DM3SAD = (u32)bg3.mapData+4094;
<br/>
				REG_DM3DAD = (u32)bg3.mapData+4096;
<br/>
				REG_DM3CNT = 32*64 | DMA_SOURCE_DECREMENT | DMA_DEST_DECREMENT | DMA_16NOW; // 32 = 8x8/16 bit word
<br/>
			}
<br/>
		} 
<br/>
<br/>
		if (inputResponse &amp; MAP_MOVEDOWN) {
<br/>
			bg3.y_scroll++;	
<br/>
			bg3.y_display++;
<br/>
			if (bg3.y_scroll &gt; 111) {
<br/>
				bg3.y_scroll = 96;
<br/>
				y+=2;
<br/>
				REG_DM3SAD = (u32)bg3.mapData+128;
<br/>
				REG_DM3DAD = (u32)bg3.mapData;
<br/>
				REG_DM3CNT = 32*64 | DMA_16NOW; // 32 = 8x8/16 bit word
<br/>
<br/>
				REG_DM3SAD = (u32)&amp;myMap-&gt;data[((y+22)*myMap-&gt;width)+x];
<br/>
				REG_DM3DAD = (u32)bg3.mapData+(1408); // 22*64
<br/>
				REG_DM3CNT = 32 | DMA_16NOW; // 32 = 8x8/16 bit word
<br/>
<br/>
				REG_DM3SAD = (u32)&amp;myMap-&gt;data[((y+23)*myMap-&gt;width)+x];
<br/>
				REG_DM3DAD = (u32)bg3.mapData+(1472); // 23*64
<br/>
 				REG_DM3CNT = 32 | DMA_16NOW; // 32 = 8x8/16 bit word */
<br/>
				FONT_printU32(y,0,0);
<br/>
			}
<br/>
		}
<br/>
<br/>
		if ((inputResponse &amp; MAP_MOVEUP) &amp;&amp; bg3.y_display &gt; 0) {
<br/>
			bg3.y_scroll--;
<br/>
			bg3.y_display--;
<br/>
			if (bg3.y_scroll &lt; 81) {
<br/>
				bg3.y_scroll = 96;
<br/>
				y+=-2;
<br/>
				REG_DM3SAD = (u32)bg3.mapData+3968;
<br/>
				REG_DM3DAD = (u32)bg3.mapData+4096;
<br/>
				REG_DM3CNT = 32*64 | DMA_SOURCE_DECREMENT | DMA_DEST_DECREMENT | DMA_16NOW; // 32 = 8x8/16 bit word
<br/>
<br/>
				REG_DM3SAD = (u32)&amp;myMap-&gt;data[(y*myMap-&gt;width)+x];
<br/>
				REG_DM3DAD = (u32)bg3.mapData;
<br/>
				REG_DM3CNT = 32 | DMA_16NOW; // 32 = 8x8/16 bit word
<br/>
<br/>
				REG_DM3SAD = (u32)&amp;myMap-&gt;data[((y+1)*myMap-&gt;width)+x];
<br/>
				REG_DM3DAD = (u32)bg3.mapData+64;
<br/>
				REG_DM3CNT = 32 | DMA_16NOW; // 32 = 8x8/16 bit word
<br/>
				FONT_printU32(y,0,0);
<br/>
			}
<br/>
		} 		
<br/>
<br/>
		UpdateBackground(&amp;bg3);
<br/>
<br/>
		CopyOAM();
<br/>
	}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
The bin can be found at <a href="http://www.geocities.com/archeious/netwars.bin" target="_blank">http://www.geocities.com/archeious/netwars.bin</a> is you want to see what is going on.  Any and all help figuring this out would be great.
<br/>
<br/>
Archeious</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#8156 - djei-dot - Thu Jul 03, 2003 11:29 am</h4>
    <div class="postbody"><span class="postbody">Looks like your map is being dynamically loaded the wrong way. I don't know much about dinamically loading maps but you can check out Dovoto's tutorial about this (it's in the Making the Game section).</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#8161 - Quirky - Thu Jul 03, 2003 2:21 pm</h4>
    <div class="postbody"><span class="postbody">It seems to load the graphics 8 pixels too far left, (when "moving right") then jumps the screen to the correct position.
<br/>
<br/>
The problem, I think, is that you do this first:
<br/>
<br/>
RotateBackground(&amp;bg3,angle,119,79,zoom); //set center of screen 
<br/>
then update the scroll registers, 
<br/>
then UpdateBackground(&amp;bg3);  (which is when the new scroll changes take place.)
<br/>
<br/>
So if you reach the "edge" and have to do a change over of tiles, you will go from, say bg3.y_scroll == 82 to 96, then the screen will jump to 79 at the start of the loop.
<br/>
<br/>
Does that make sense? My advice is get out VBA, its map viewer then Insight, GDB, etc and step through to see how it all works one step at a time.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#8176 - Archeious - Thu Jul 03, 2003 9:15 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quirky wrote:</b></span></td> </tr> <tr> <td class="quote">It seems to load the graphics 8 pixels too far left, (when "moving right") then jumps the screen to the correct position.
<br/>
<br/>
The problem, I think, is that you do this first:
<br/>
<br/>
RotateBackground(&amp;bg3,angle,119,79,zoom); //set center of screen 
<br/>
then update the scroll registers, 
<br/>
then UpdateBackground(&amp;bg3);  (which is when the new scroll changes take place.)
<br/>
<br/>
So if you reach the "edge" and have to do a change over of tiles, you will go from, say bg3.y_scroll == 82 to 96, then the screen will jump to 79 at the start of the loop.
<br/>
<br/>
Does that make sense? My advice is get out VBA, its map viewer then Insight, GDB, etc and step through to see how it all works one step at a time.</td> </tr></table><span class="postbody">
<br/>
<br/>
Doesn't make too much sense.   How can I hook GDB up to VBA?  I will look at the map view and see what that is doing.  It looks almost like the DMA transfer are not working  (only happens some of the times).  Anyways thatnbks for hte ideas.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#8183 - Archeious - Thu Jul 03, 2003 10:48 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quirky wrote:</b></span></td> </tr> <tr> <td class="quote">It seems to load the graphics 8 pixels too far left, (when "moving right") then jumps the screen to the correct position.
<br/>
<br/>
The problem, I think, is that you do this first:
<br/>
<br/>
RotateBackground(&amp;bg3,angle,119,79,zoom); //set center of screen 
<br/>
then update the scroll registers, 
<br/>
then UpdateBackground(&amp;bg3);  (which is when the new scroll changes take place.)
<br/>
<br/>
So if you reach the "edge" and have to do a change over of tiles, you will go from, say bg3.y_scroll == 82 to 96, then the screen will jump to 79 at the start of the loop.
<br/>
<br/>
Does that make sense? My advice is get out VBA, its map viewer then Insight, GDB, etc and step through to see how it all works one step at a time.</td> </tr></table><span class="postbody">
<br/>
<br/>
Well I figured it out.  The problem is closey related to wait you mentioned (thanks a ton).  What was happening was the rotateBackground was getting call before the updating of the x and y so the rotation matrix was getting fubar'ed.  I just moved teh function call below the input tests. and everything is running great.  Infinite (not really) map size here I come. 
<br/>
<br/>
BTW I have looked at Dovoto's toots and find them overly complicated.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#8198 - Quirky - Fri Jul 04, 2003 7:55 am</h4>
    <div class="postbody"><span class="postbody">Glad I could help. I had similar problems with my own "infinite engine" - the next part you have to look forward to will be adding non player sprites ;)
<br/>
<br/>
Incidently, setting up gdb is easier than you might think. Download the sdl version of visual boy advance from the VBA homepage, then download the arm-gdb and shared files from the same place (scroll down the list til you find GDB/Insight download). Unzip all that lot where it says then follow the instructions on the VBA FAQ page for running the emulator in debug mode. It took longer for me downloading the files than it did to get the debugger up and running.
<br/>
<br/>
Also, the SDL version has a print-to-console output that is very useful if you can't be arsed with the full debugger or want to "debug" interrupt routines. I don't know how I managed before! :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#8244 - Archeious - Sat Jul 05, 2003 6:33 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quirky wrote:</b></span></td> </tr> <tr> <td class="quote">Glad I could help. I had similar problems with my own "infinite engine" - the next part you have to look forward to will be adding non player sprites ;)
<br/>
<br/>
Incidently, setting up gdb is easier than you might think. Download the sdl version of visual boy advance from the VBA homepage, then download the arm-gdb and shared files from the same place (scroll down the list til you find GDB/Insight download). Unzip all that lot where it says then follow the instructions on the VBA FAQ page for running the emulator in debug mode. It took longer for me downloading the files than it did to get the debugger up and running.
<br/>
<br/>
Also, the SDL version has a print-to-console output that is very useful if you can't be arsed with the full debugger or want to "debug" interrupt routines. I don't know how I managed before! :)</td> </tr></table><span class="postbody">
<br/>
<br/>
:)  I already have my sprite library fleshed out.  Including dynamic memry manager.  I am actually hanging up my gba coding hat for the next little bit.  The artist want a better map/tile editor.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
