<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Clearing back buffer in Mode 4 - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>Graphics > Clearing back buffer in Mode 4</h2>
<div id="posts">
<div class="post">
    <h4>#2002 - krozen - Mon Jan 27, 2003 4:36 pm</h4>
    <div class="postbody"><span class="postbody">Hello,
<br/>
I am writing an application that flips between buffers in mode 4 to produce smooth scrolling. My current function to clear the buffer looks like so         </span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code"> for (i = 0; i&lt;160 ; i++)
<br/>
           {
<br/>
                    for ( j = 0 ; j&lt;120 ; j++)
<br/>
                   {
<br/>
                   theVideoBuffer[((i&lt;&lt;7) - (i&lt;&lt;3)) + j] = ((paletteMem[0]&lt;&lt;8) + paletteMem[0]);
<br/>
                }
<br/>
<br/>
           }</td> </tr></table><span class="postbody">
<br/>
<br/>
It works (sort of!), but it is so slow. Is there any way of just clearing the buffer in one swoop. Can you create a black background, say, and just point the buffer at it, thus clearing it, and then drawing to it? 
<br/>
Thanks for your help!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#2005 - velvetfr - Mon Jan 27, 2003 5:12 pm</h4>
    <div class="postbody"><span class="postbody">Hi,
<br/>
<br/>
yes, can be done quite easily ... by using one of the DMA channel, the destination address would be your screen buffer you want to clear, the source address would point to your pixel value you want to clear the buffer with. You have to set the DMA cntl register to not incrementing the source address, and you should have a nitty clrscr.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#2006 - velvetfr - Mon Jan 27, 2003 5:15 pm</h4>
    <div class="postbody"><span class="postbody">... also, I forgot, you have to set the DMA count register to the number of words or halfwords (depending on the DMA cntl bit you set to) to be the buffer screen size.
<br/>
<br/>
Sorry not to give you any code lines with this, but the main idea is that, so it should be now easy for you (by picking some nitty documentation like gbatek, or CowBytes) to implement.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#2009 - krozen - Mon Jan 27, 2003 5:49 pm</h4>
    <div class="postbody"><span class="postbody">cheers, ill look into that</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#2010 - col - Mon Jan 27, 2003 7:09 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>krozen wrote:</b></span></td> </tr> <tr> <td class="quote">Hello,
<br/>
I am writing an application that flips between buffers in mode 4 to produce smooth scrolling. </td> </tr></table><span class="postbody">
<br/>
<br/>
Is there any particular reason why you're using a bitmapped mode?
<br/>
<br/>
As I'm sure you know, scrolling is free in tile modes and you get layers and effects for free as well.  Its also possible to setup a tile mode so that you can plot pixels to it, this will be slower than plotting to a bitmapped mode, but offsetting that against scrolling in bitmapped mode....
<br/>
<br/>
<br/>
cheers
<br/>
<br/>
col</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#2017 - ampz - Mon Jan 27, 2003 7:57 pm</h4>
    <div class="postbody"><span class="postbody">Why do you need to clear the buffer? just write the new frame into the buffer. No need to clear it before you update it.
<br/>
<br/>
And I agree with 'col', depending you your application a textmode might give you better performance. However, it's quite a bit more complicated than a bitmap mode.
<br/>
<br/>
I really don't understand why Nintendo didn't add hardware scrolling to the bitmap modes... it's a very simple thing to do in hardware (just preload the adr-counter with a constant), but hard to do in software.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#2019 - Splam - Mon Jan 27, 2003 8:34 pm</h4>
    <div class="postbody"><span class="postbody">There is hardware scrolling, just no extra area outside the screen to draw to (like the extra tiles in tile mode) but you can make your own "border" with a window and update a few pixels per frame.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#2022 - ampz - Mon Jan 27, 2003 9:08 pm</h4>
    <div class="postbody"><span class="postbody">The bitmap modes doesn't wrap around. That's means the scaling/rotation reference points can't be used for scrolling.
<br/>
(EDIT)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#2032 - Splam - Tue Jan 28, 2003 1:26 am</h4>
    <div class="postbody"><span class="postbody">Sorry, didn't explain myself very well.  You use the time it takes to scroll the bg through the "border" area to update your other buffer then swap.  Saves moving a whole screen of data each frame.  Do 1/4 of a screen per frame and have a 4 pixel window.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#2048 - krozen - Tue Jan 28, 2003 11:23 am</h4>
    <div class="postbody"><span class="postbody">Hello,
<br/>
That DMA example worked well. Thank you! Im actually writing a pseudo 3-d engine (2.5d?) for my final year project in college. I suppose you could call it a voxel landscape engine, but that term is just thrown around so much. I need to scrolling to draw the new scene to the back buffer , while the other one is being displayed.  I have it all writtin in C at the minute, at it runs smoothly enough.  Im trying to speed it up at the minute by removing as many multiplications and division as i can. I know one is not meant to do this, i shud really open another topic, but does anyone have any ideas for fast mults and divisions. I have everythin working in fixed point math at the minute.
<br/>
Cheers</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#2049 - Quirky - Tue Jan 28, 2003 11:54 am</h4>
    <div class="postbody"><span class="postbody">Don't use divisions. And if you must, use the bios div rather than /. That's the best advice I've read on the subject. This code from devrs.com is an example of how to do integer divide in the bios.. 
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
// Do an integer division using GBA BIOS fast division SWI code.
<br/>
//  by Jeff F., 2002-Apr-27
<br/>
<br/>
 GCC 2.9/3.0 Version
<br/>
<br/>
void FastIntDivide (signed long Numer, signed long Denom, signed long *Result, signed long *Remainder)
<br/>
 {
<br/>
asm volatile
<br/>
  (
<br/>
  " mov   r0,%2   \n"
<br/>
  " mov   r1,%3   \n"
<br/>
  " swi   0x60000       \n"   //NOTE!!!!! Put 6 here for Thumb C Compiler mode.
<br/>
  " ldr   r2,%0   \n"   //          Put 0x60000 there for ARM C Compiler mode.
<br/>
  " str   r0,[r2] \n"
<br/>
  " ldr   r2,%1   \n"
<br/>
  " str   r1,[r2] \n"
<br/>
  : "=m" (Result), "=m" (Remainder) // Outputs
<br/>
  : "r" (Numer), "r" (Denom)        // Inputs
<br/>
  : "r0","r1","r2","r3"             // Regs crushed &amp; smushed
<br/>
  );
<br/>
}
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#2050 - krozen - Tue Jan 28, 2003 12:00 pm</h4>
    <div class="postbody"><span class="postbody">Thank you,
<br/>
I tried to use that code before. But couldnt get it working. How does that function actually return anything, seeing as it is a void? How would i assign the return value of that function to, say, a unsigned integer? Thanks again! :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#2057 - Splam - Tue Jan 28, 2003 3:41 pm</h4>
    <div class="postbody"><span class="postbody">The results are returned in here
<br/>
<br/>
signed long *Result, signed long *Remainder
<br/>
<br/>
so you'd have  signed long Result and signed long Remainder declared in your code and upon calling that routine they are filled.  Upon returning you then just use them as normal   Result and Remainder.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
