<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Problem using GD - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>Graphics > Problem using GD</h2>
<div id="posts">
<div class="post">
    <h4>#37760 - kajic - Tue Mar 15, 2005 11:41 pm</h4>
    <div class="postbody"><span class="postbody">UPDATE2: 
<br/>
I updated the code so that output format and the frameskipping rate can be specified from the terminal. Also added a backup function so that one can easily backup the old animation file when generating another one. 
<br/>
<br/>
UPDATE: 
<br/>
I just came to the bright idea of testing another program to open the gif generated by my program. Guess what? It worked perfectly! Ive been sitting for 6 hours trying to fix an error not there... one thing is for sure, I wont be using Kuickshow anymore. 
<br/>
<br/>
Hi, first of all I hope I am placing the thread in the right forum. I was considering between the Coding, the C/C++, and this one and finally decided this was the one I should use.
<br/>
<br/>
I've made a little program that can generate a series of png images from an animation created by an algorithm. This part works perfectly using some GD functions. Then I decided I wanted a way to create an animated gif directly instead of merging the pngs into a gif using the ImageMagick convert program together with a shell script.
<br/>
Well, sufficient to say I tried and even though I get a lot of data written to the output gif when I try to view it I only see a black image... no animation, no nothing. I am hoping I have done some easy to see mistake in my coding and that someone can point out why I am not getting the desired result. 
<br/>
Btw, the "tool" Im making will be used to make nice sprites for a gba game I am thinking to start on. You might say I could just as easy make the animations with photoshop but the thing is my skills in that area are equal to zero so I trust more in my ability to algorithmically create animations :)
<br/>
Anyway, here is my code... I hope you will find it easy to read/understand! 
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#include&lt;gd.h&gt;
<br/>
#include&lt;stdio.h&gt;
<br/>
#include&lt;stdlib.h&gt;
<br/>
#include&lt;string.h&gt;
<br/>
#include&lt;time.h&gt;
<br/>
<br/>
#define WIDTH 180
<br/>
#define HEIGHT 120
<br/>
#define GIF_NAME "animation.gif"
<br/>
<br/>
<br/>
/* determine if a file exists */
<br/>
<br/>
int fileExists(char *filename) {
<br/>
  /* declare file */
<br/>
  FILE *file;
<br/>
  
<br/>
  /* try to open file */
<br/>
  if ((file = fopen(filename, "r")) == NULL) 
<br/>
    return 0;
<br/>
<br/>
  /* as the file exists we must close it */
<br/>
  fclose(file);
<br/>
  return 1;
<br/>
}
<br/>
<br/>
<br/>
/* add the frame to the gif-animation specified by GIF_NAME. if no such 
<br/>
   animation exists one will be created and before we add the frame the 
<br/>
   header of the gif will be written to the created file */
<br/>
<br/>
void makeGif(gdImagePtr im) {
<br/>
  /* declare output file */
<br/>
  FILE *outFile;
<br/>
<br/>
  /* if there exists no animatione we will create one and write its header */ 
<br/>
  if (!fileExists(GIF_NAME)) { 
<br/>
    /* open file */
<br/>
    outFile = fopen(GIF_NAME, "wb"); 
<br/>
        
<br/>
    /* write the header */
<br/>
    gdImageGifAnimBegin(im, outFile, 0, 0);
<br/>
<br/>
    /* close the file */
<br/>
    fclose(outFile);
<br/>
  }
<br/>
<br/>
  /* open file im append mode */
<br/>
  outFile = fopen(GIF_NAME, "ab");
<br/>
<br/>
  /* add the frame */
<br/>
  gdImageGifAnimAdd(im, outFile, 1, 0, 0, 1, gdDisposalNone, NULL);
<br/>
<br/>
  /* close the file */
<br/>
  fclose(outFile);
<br/>
}
<br/>
<br/>
<br/>
/* terminate the gif-animation specified by GIF_NAME. this is done 
<br/>
   by adding a semicolon to the end of the file. */
<br/>
<br/>
void closeGif() {
<br/>
  /* declare output file */
<br/>
  FILE *outFile;
<br/>
<br/>
  /* open file in append mode */
<br/>
  outFile = fopen(GIF_NAME, "ab");  
<br/>
<br/>
  gdImageGifAnimEnd(outFile);
<br/>
}
<br/>
<br/>
<br/>
/* save the frame at im to a png-file */
<br/>
<br/>
void makePng(gdImagePtr im, int frame) {
<br/>
  /* declare output file */
<br/>
  FILE *outFile;
<br/>
<br/>
  char frameName[11];
<br/>
  frameName[0] = '\0';
<br/>
  
<br/>
  /* convert frame int to string */
<br/>
  sprintf(frameName, "%d", frame);
<br/>
<br/>
  /* append the extension */
<br/>
  strcat(frameName, ".png\0");
<br/>
<br/>
  /* open output file */
<br/>
  outFile = fopen(frameName, "wb");
<br/>
<br/>
  /* output the image */
<br/>
  gdImagePng(im, outFile);
<br/>
<br/>
  /* close file */
<br/>
  fclose(outFile);
<br/>
}
<br/>
<br/>
<br/>
/* if the current frame shouldnt be skipped we can either call 
<br/>
   upon makePng for it to create the frame OR makeGif so that 
<br/>
   the frame can be added to the gif-animation specified by 
<br/>
   GIF_NAME */
<br/>
<br/>
void makeFile(gdImagePtr im, char *type, int frame, int frameSkipping) {
<br/>
  /* check if the frame we are at should be outputed */
<br/>
  if (frame % (frameSkipping+1))
<br/>
    return;
<br/>
<br/>
  /* check what type of image we want to output */
<br/>
  if (!strcmp(type, "gif"))
<br/>
    makeGif(im);
<br/>
  else if (!strcmp(type, "png"))
<br/>
    makePng(im, frame);
<br/>
}
<br/>
<br/>
<br/>
/* sets the given pixel in the frame im to the given color */
<br/>
<br/>
void putPixel(gdImagePtr im, int x_pos, int y_pos, int red, int green, int blue) {
<br/>
  /* put the pixel to the image */
<br/>
  gdImageSetPixel(im, x_pos, y_pos, gdImageColorResolve(im, red, green, blue));
<br/>
}
<br/>
<br/>
<br/>
/* draws a line from from_x, from_t to to_x, to_y */
<br/>
<br/>
void drawLine(gdImagePtr im, int from_x, int from_y, int to_x, int to_y, int red, int green, int blue) {
<br/>
  /* draw the line */
<br/>
  gdImageLine(im, from_x, from_y, to_x, to_y, gdImageColorResolve(im, red, green, blue));
<br/>
}
<br/>
<br/>
<br/>
/* create a frame with the given dimensions/background color 
<br/>
   note: the color of the background is also made transparent */
<br/>
<br/>
gdImagePtr createImage(gdImagePtr im, int width, int height, int red, int green, int blue) {
<br/>
  /* allocate the image */
<br/>
  im = gdImageCreate(width, height);
<br/>
<br/>
  /* allocate the background color, as it is the first color allocated in a new
<br/>
     image it will be used as background */
<br/>
  int bg;
<br/>
  bg = gdImageColorAllocate(im, red, green, blue);
<br/>
  
<br/>
  return im;
<br/>
} 
<br/>
<br/>
<br/>
/* create a backup of the animation specified by GIF_NAME */
<br/>
<br/>
void backupAnimation(void) {
<br/>
  if (fileExists(GIF_NAME)) {
<br/>
    char newName[200];
<br/>
    newName[0] = '\0';
<br/>
    
<br/>
    int n;
<br/>
    for (n=1; n&gt;0; n++) {
<br/>
      sprintf(newName, "old.%d." GIF_NAME, n);
<br/>
      if (!fileExists(newName))
<br/>
   n=-1;
<br/>
    }
<br/>
<br/>
    rename(GIF_NAME, newName);
<br/>
  }
<br/>
}
<br/>
<br/>
<br/>
int main(int argc, char *argv[]) {
<br/>
  /* check if the correct number of arguments have been suplied */
<br/>
  if (argc != 3) {
<br/>
    /* print usage message */
<br/>
    printf("Usage: %s [string png/gif] [int frameSkip where frameSkip&gt;=0]\nExample: %s gif 9; would produce a gif animation where every tenth frame is used. \nExample: %s png 0; would produce one png image for each frame. \nNote: The first frame can't be skipped. \n", argv[0], argv[0], argv[0]);
<br/>
    return 20;
<br/>
  }
<br/>
  
<br/>
  /* set output type */
<br/>
  char outType[3];
<br/>
  strcpy(outType, argv[1]);
<br/>
<br/>
  /* set frameSkip value */
<br/>
  int frameSkip;
<br/>
  frameSkip = atoi(argv[2]); /* this will cause an floating point exception if argv[2] cant be converted to and int */
<br/>
<br/>
  /* backup the animation file if it already exists */
<br/>
  if (!strcmp(outType, "gif")) 
<br/>
    backupAnimation();
<br/>
  
<br/>
  /* declare the image */
<br/>
  gdImagePtr im;
<br/>
<br/>
  /* create the image */
<br/>
  im = createImage(im, WIDTH, HEIGHT, 0, 0, 0);
<br/>
<br/>
  /* a simple algorithm indended for testing */
<br/>
  int frame;
<br/>
  int red=0;
<br/>
  for (frame=0; frame&lt;HEIGHT; frame++) {
<br/>
    /* put pixels to image */
<br/>
    int i;
<br/>
    for (i=0; i&lt;WIDTH; i++) 
<br/>
      putPixel(im, i, frame, red, 0, 0);
<br/>
<br/>
    /* output the image */
<br/>
    makeFile(im, outType, frame, frameSkip);
<br/>
<br/>
    /* change the color of the next row */
<br/>
    red++;
<br/>
  }
<br/>
  srand(time(NULL));
<br/>
  int r;
<br/>
  int x=WIDTH/2, y=HEIGHT/2;
<br/>
  for (frame=0; frame&lt;HEIGHT/2; frame++) {
<br/>
    r = (rand() % (HEIGHT/2))-(HEIGHT/4);
<br/>
    x+=r;
<br/>
    r = (rand() % (HEIGHT/2))-(HEIGHT/4);
<br/>
    y+=r;
<br/>
    red = (rand() % WIDTH);
<br/>
    drawLine(im, WIDTH/2, HEIGHT/2, x, y, red, 0, 0);
<br/>
    makeFile(im, outType, frame, frameSkip);
<br/>
    
<br/>
    x=WIDTH/2; 
<br/>
    y=HEIGHT/2;
<br/>
  }
<br/>
  for (frame=0; frame&lt;HEIGHT; frame++) {
<br/>
    /* put pixels to image */
<br/>
    int i;
<br/>
    for (i=0; i&lt;WIDTH; i++) 
<br/>
      putPixel(im, i, frame, 0, 0, 0);
<br/>
<br/>
    /* output the image */
<br/>
    makeFile(im, outType, frame, frameSkip);
<br/>
<br/>
    /* change the color of the next row */
<br/>
    red++;
<br/>
  } /* end of the testing algorithm */
<br/>
<br/>
  /* close gif */ 
<br/>
  if (!strcmp(outType, "gif")) 
<br/>
    closeGif();
<br/>
<br/>
  /* destroy image */
<br/>
  gdImageDestroy(im);
<br/>
<br/>
  return 0;
<br/>
}
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"><br/><br/>Last edited by kajic on Thu Mar 17, 2005 1:07 am; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#37775 - FluBBa - Wed Mar 16, 2005 9:46 am</h4>
    <div class="postbody"><span class="postbody">You do know this forum is for Gameboy Advance, right?<br/>_________________<br/>I probably suck, my not is a programmer.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#37784 - tepples - Wed Mar 16, 2005 2:26 pm</h4>
    <div class="postbody"><span class="postbody">And for tools designed to convert images for use on a Game Boy Advance. Explanation using an example of a program that you maintain: Imagine a bmp/jpg/png to PocketNES splash screen converter.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
