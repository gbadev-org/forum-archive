<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Text Background Tilemaps - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>Graphics > Text Background Tilemaps</h2>
<div id="posts">
<div class="post">
    <h4>#21881 - faz99 - Tue Jun 08, 2004 7:28 pm</h4>
    <div class="postbody"><span class="postbody">Hey,
<br/>
I'm stuck on drawing onto backgrounds (Or rather the map data) in backgrounds that don't rotate.
<br/>
If this has been asked before then direct me because i searched around...
<br/>
<br/>
I can get rotation backgrounds working fine they aren't so bad since the map is a linear array..
<br/>
But according to The Pern Project:
<br/>
<br/>
<span style="font-style: italic">"Unfortunately text backgrounds are not quite as simple. Size 0 (256x256) and size 2(256x512) still work as linear arrays but size 1 and 3 are broken into separate blocks."</span>
<br/>
<br/>
But when i try to treat a size 0 map as a linear array on a text background, i just don't get the same outcome that i get when i do this with a rotational background.
<br/>
I know it has to be something simple but i don't know what, frustrating stuff :)
<br/>
<br/>
Here's my code:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#include "gba.h"
<br/>
#include "dispcnt.h"
<br/>
#include "tilesetup.h"
<br/>
#include "tiles.h"
<br/>
#include "tilemap.c"
<br/>
#include "keypad.h"
<br/>
<br/>
<br/>
Bg bg2;
<br/>
<br/>
//wait for the screen to stop drawing
<br/>
void WaitForVsync()
<br/>
{
<br/>
   while((volatile u16)REG_VCOUNT != 160){}
<br/>
}
<br/>
<br/>
int main()
<br/>
{
<br/>
   int index = 0;  //generic loop variables
<br/>
   u16 loop;
<br/>
   u16* temp;      //temporary storage pointer
<br/>
<br/>
   //set mode 2 and enable sprites and 1d mapping
<br/>
   SetMode(MODE_1);
<br/>
<br/>
<br/>
   bg2.number = 1;            //background number 0-3
<br/>
   bg2.charBaseBlock = 0;
<br/>
   bg2.screenBaseBlock = 28;      //map data position on 2Kb boundary
<br/>
   bg2.colorMode = BG_COLOR_256;           //256-colour background
<br/>
   bg2.size = TEXTBG_SIZE_256x256;          //size of map
<br/>
   bg2.mosaic = 0;                         //not enabled
<br/>
   bg2.x_scroll = 0;         //scrolling variables
<br/>
   bg2.y_scroll = 0;
<br/>
   bg2.wraparound = WRAPAROUND;
<br/>
   
<br/>
   //Point to correct tile and map data, update the Background and Display registers accordingly
<br/>
    EnableBackground(&amp;bg2);
<br/>
<br/>
<br/>
<br/>
   for(loop = 0; loop &lt; 256; loop++)
<br/>
      BGPaletteMem[loop] = tilesPalette[loop];     //load the background palette into memory
<br/>
<br/>
   for(loop = 0; loop &lt; tiles_WIDTH * tiles_HEIGHT /2; loop++)  //load tile image data
<br/>
      bg2.tileData[loop] = tilesData[loop];
<br/>
<br/>
   //load the map image data
<br/>
   temp = (u16*)tilemap;
<br/>
   for(loop = 0; loop &lt; 32 * 32 /2; loop++) 
<br/>
      bg2.mapData[loop] = temp[loop];
<br/>
<br/>
   //Main Game loop
<br/>
   while(1)
<br/>
   {
<br/>
      
<br/>
      WaitForVsync();               //waits for the screen to stop drawing
<br/>
      UpdateBackground(&amp;bg2); //make sure registers are updated if anything changes e.g. scrolling
<br/>
      if (!(REG_P1 &amp; KEY_UP))
<br/>
            bg2.y_scroll += 1;
<br/>
            
<br/>
      
<br/>
   }
<br/>
   return(0);
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I got most of this code from various tutorials around, so i just left all their comments in.
<br/>
This is practically the same code i used for the rotational backgrounds except these changed..
<br/>
<br/>
bg2.number=1	=&gt;	bg2.number=2
<br/>
TEXTBG_SIZE...	=&gt;	ROTBG_SIZE...
<br/>
<br/>
And then i changed the key input so that is increments y_scroll instead of DX.
<br/>
<br/>
So.. What the hell's the problem? o_O<br/>_________________<br/>\(^_^)/</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#21883 - Lupin - Tue Jun 08, 2004 8:03 pm</h4>
    <div class="postbody"><span class="postbody">I am not sure what you are doing now, but for rotation backgrounds you use 8 bit values and for text backgrounds you have to use 16 bit values (bit 0-9 = tile ID; bit 10 = HF; bit 11 = VF; bit 12-15 = palette ID). Did you take care of the different format?<br/>_________________<br/><a class="postlink" href="http://pokeme.shizzle.it/" target="_blank">Team Pokeme</a>
<br/>
<a class="postlink" href="http://lupin.shizzle.it/" target="_blank">My blog and PM ASM tutorials</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#21884 - faz99 - Tue Jun 08, 2004 8:13 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Lupin wrote:</b></span></td> </tr> <tr> <td class="quote">I am not sure what you are doing now, but for rotation backgrounds you use 8 bit values and for text backgrounds you have to use 16 bit values (bit 0-9 = tile ID; bit 10 = HF; bit 11 = VF; bit 12-15 = palette ID). Did you take care of the different format?</td> </tr></table><span class="postbody">
<br/>
<br/>
Should this not sort it out?
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">temp = (u16*)tilemap; </td> </tr></table><span class="postbody"><br/>_________________<br/>\(^_^)/</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#21890 - sajiimori - Tue Jun 08, 2004 9:05 pm</h4>
    <div class="postbody"><span class="postbody">If tilemap is a u8[] where each element is a tile index, then casting it to u16* and reading an element will return a pair of tiles (which is probably not what you want).  You can copy from a u8 to a u16 and the compiler will automatically pad the u8 with zeros (which is probably what you want).
<br/>
<br/>
Better yet, arrange the source data in text bg format and DMA it.  Then you'll get the full range of 1024 tiles, instead of just 256, along with flags for flipping and such.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#21968 - ZeroX - Thu Jun 10, 2004 8:48 am</h4>
    <div class="postbody"><span class="postbody">I'm thinking maybe, just maybe because you didnt enable the background in the REG_DISPCNT register. In your code you used Setmode(MODE_1) only. Try SetMode(MODE_1 | BG0_ENABLE), or whatever BG you're using. Check your dispcnt.h header file.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#21972 - faz99 - Thu Jun 10, 2004 3:35 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>ZeroX wrote:</b></span></td> </tr> <tr> <td class="quote">I'm thinking maybe, just maybe because you didnt enable the background in the REG_DISPCNT register. In your code you used Setmode(MODE_1) only. Try SetMode(MODE_1 | BG0_ENABLE), or whatever BG you're using. Check your dispcnt.h header file.</td> </tr></table><span class="postbody">
<br/>
<br/>
I did do that.. didn't include the function here, its done in... Updatebackground.
<br/>
<br/>
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">If tilemap is a u8[] where each element is a tile index, then casting it to u16* and reading an element will return a pair of tiles (which is probably not what you want). You can copy from a u8 to a u16 and the compiler will automatically pad the u8 with zeros (which is probably what you want). 
<br/>
</td> </tr></table><span class="postbody">
<br/>
Interesting...
<br/>
Anyway i think it has something to do with the format... it need to be a u16 but its a u8.
<br/>
When i used MapEd it output it as a u16 and then it worked! \(^_^)/
<br/>
But i still think its strange... Hm..
<br/>
I think i have it sorted anyway im not really sure, if anything else comes uup i'll let you all know ;)<br/>_________________<br/>\(^_^)/</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#21983 - sajiimori - Thu Jun 10, 2004 6:50 pm</h4>
    <div class="postbody"><span class="postbody">What you need to understand is that these 3 arrays contain exactly the same data:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
const u8 byte_array[] = { 0x0A, 0x0B, 0x0C, 0x0D };
<br/>
const u16 hword_array[] = { 0x0B0A, 0x0D0C };
<br/>
const u32 word_array[] = { 0x0D0C0B0A };
<br/>
</td> </tr></table><span class="postbody">
<br/>
And that these expressions are true (assuming the arrays are aligned correctly):
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
((u32*) hword_array)[0] == word_array[0]
<br/>
((u32*) byte_array)[0]  == word_array[0]
<br/>
((u16*) word_array)[0]  == hword_array[0]
<br/>
((u16*) byte_array)[0]  == hword_array[0]
<br/>
((u8*) word_array)[0]   == byte_array[0]
<br/>
((u8*) hword_array)[0]  == byte_array[0]
<br/>
</td> </tr></table><span class="postbody">
<br/>
It's a matter of perspective -- an array is just a string of bits in the end.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
