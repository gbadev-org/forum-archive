<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Auto header Fixup with GNU Assembler - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>ASM > Auto header Fixup with GNU Assembler</h2>
<div id="posts">
<div class="post">
    <h4>#11615 - ace - Tue Oct 14, 2003 1:09 pm</h4>
    <div class="postbody"><span class="postbody">I don't like odd little utilities if they can be avoided.
<br/>
<br/>
One thing that is annoying is the checksum in the Program header for GBA ROMS/Multiboot images.  Usually you need some strange little utility to fix it.  this is annoying.
<br/>
<br/>
Following is code that can be added to the assembler startup section of the GBA ROM/Multibbot image to automatically calculate this checksum for GNU Assembler:
<br/>
<br/>
    // Nifty autogenerate header checksum
<br/>
    .set    checksum, 0
<br/>
<br/>
    // Game Title - Must be 12 characters (80000A0h)
<br/>
    .irp   param,'M','y',' ','R','o','m',' ','I','m','a','g','e'
<br/>
    .set   char, \param
<br/>
    .byte  char
<br/>
    .set   checksum, checksum - char
<br/>
    .endr
<br/>
<br/>
    // Game Code - might ned to set to 'M','B',' ',' ' for some emulators - 4 characters (80000ACh)
<br/>
    .irp   param,'0','0','0','0'
<br/>
    .set   char, \param
<br/>
    .byte  char
<br/>
    .set   checksum, checksum - char
<br/>
    .endr
<br/>
<br/>
    // Maker Code - 2 characters (80000B0h)
<br/>
    .irp   param,'0','0'
<br/>
    .set   char, \param
<br/>
    .byte  char
<br/>
    .set   checksum, checksum - char
<br/>
    .endr
<br/>
<br/>
    // Fixed Value 0x96      (80000B2h)
<br/>
    // Main Unit Code        (80000B3h)
<br/>
    // Device Type           (80000B4h)
<br/>
    // Unused Data - 7 Bytes (80000B5h)
<br/>
    // Software Version No   (80000BCh)
<br/>
    .irp   param,0x96,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
<br/>
    .set   char, \param
<br/>
    .byte  char
<br/>
    .set   checksum, checksum - char
<br/>
    .endr
<br/>
    // On FIQ or Invalid Instruction
<br/>
    // Call 09fe2000 if MS Bit of 0x080000B4 set   and 0x800009C = 0xA5 for debug rom.
<br/>
    // Call 09ffc000 if MS Bit of 0x080000B4 clear and 0x800009C = 0xA5 for debug rom.
<br/>
<br/>
<br/>
    // Complement Check (80000BDh)
<br/>
    // Needs to be auto generated thus :
<br/>
    // 1) Add all the values from ROM locations $a0 to (and including) $bc.
<br/>
    // 2) Add $19 to this value.
<br/>
    // 3) Exclusive OR with $ff.
<br/>
    // 4) Save the 8 least significant bits of the result to ROM location $bd.
<br/>
    .set checksum, checksum - 0x19
<br/>
    .set checksum, checksum &amp; 0xFF
<br/>
    .byte   checksum
<br/>
<br/>
    // Reserved - 2 bytes (80000BEh) -- Needs to be zero ??? (does it??)
<br/>
    .byte   0x00,0x00
<br/>
<br/>
<br/>
Now you dont need a utility to "fix up" the header. The only other thing you need is the "Fixed Nintendo Logo" data, but thats not hard to track down on the net.
<br/>
<br/>
Hope this is usefull to anyone.
<br/>
<br/>
ACE.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#102689 - SoLo2 - Sat Sep 16, 2006 4:09 am</h4>
    <div class="postbody"><span class="postbody">Thanks to ace for this little clue.
<br/>
<br/>
I haven't tried it, yet it seems to
<br/>
concord with Martin's GBATEK info.
<br/>
<br/>
Greetings,
<br/>
SoLo2<br/>_________________<br/>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<br/>
Visit:
<br/>
<a href="http://thebitsclub.tripod.com" target="_blank">http://thebitsclub.tripod.com</a>
<br/>
<a href="http://biis.tripod.com" target="_blank">http://biis.tripod.com</a></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
