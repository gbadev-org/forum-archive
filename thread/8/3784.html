<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Calling ARM-IWRAM code from THUMB/ROM - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>ASM > Calling ARM-IWRAM code from THUMB/ROM</h2>
<div id="posts">
<div class="post">
    <h4>#24013 - pan69 - Mon Jul 26, 2004 5:27 pm</h4>
    <div class="postbody"><span class="postbody">Hi guys,
<br/>
<br/>
Have been messing all day, programming and searching this forum to figure out where I go wrong. I'm trying to call an ARM function located in IWRAM from my THUMB (ROM) code but the function doesn't seem to return.
<br/>
<br/>
My main THUMB code looks like this:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
@
<br/>
@ file: main.s
<br/>
@
<br/>
<br/>
   .thumb_func
<br/>
   .align
<br/>
   .section .text
<br/>
<br/>
   .include "gba.inc"
<br/>
<br/>
   .global   AgbMain
<br/>
<br/>
AgbMain:
<br/>
      bl      memCopy    @ &lt;-- Where it goes wrong (read on)
<br/>
<br/>
   @ Switch to 240x160x15bpp mode.
<br/>
<br/>
      ldr   r0, =MODE_3
<br/>
      ldr   r1, =BG2_ENABLE
<br/>
      bl      setModeT
<br/>
<br/>
   @ Plot a green pixel in the center of the screen.
<br/>
<br/>
      ldr   r0, =0
<br/>
      ldr   r1, =255
<br/>
      ldr   r2, =0
<br/>
      bl      rgb15T
<br/>
<br/>
      ldr   r1, =(240 / 2)
<br/>
      ldr   r2, =(160 / 2)
<br/>
      ldr   r3, =VRAM
<br/>
      bl      setPixel3T
<br/>
<br/>
main:
<br/>
      b      main
<br/>
<br/>
   .end
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
The first function called is the ARM-IWRAM memCopy function which is defined like this:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
@
<br/>
@ file: memCopy.s
<br/>
@
<br/>
<br/>
   .arm
<br/>
   .align
<br/>
   .section .iwram, "ax", %progbits
<br/>
<br/>
   .include "gba.inc"
<br/>
<br/>
   .global memCopy
<br/>
   .type memCopy, function
<br/>
<br/>
memCopy:
<br/>
   @ Return to caller...
<br/>
<br/>
      bx      lr
<br/>
<br/>
   .end
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Everything compiles/links fine (GAS from GNUARM 3.4.4). Now, when running this program it crashes. But, when I remove that first BL to memCopy the program runs just fine.
<br/>
<br/>
Also when I change the:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
.section .iwram, "ax", %progbits
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
in the memCopy.s file to:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
.section .text
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
The program runs fine. Meaning the BL to memCopy returns. I'm using crt0.S v1.28 and Linker Script v1.3 by Jeff Frohwein.
<br/>
<br/>
This is how I compile and link:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
arm-elf-as -mcpu=arm7tdmi -mthumb-interwork main.s -o main.o
<br/>
arm-elf-as -mcpu=arm7tdmi -mthumb-interwork setModeT.s -o setMode.o
<br/>
arm-elf-as -mcpu=arm7tdmi -mthumb-interwork setPixel3T.s -o setPixel.o
<br/>
arm-elf-as -mcpu=arm7tdmi -mthumb-interwork rgb15T.s -o rgb15.o
<br/>
arm-elf-as -mcpu=arm7tdmi -mthumb-interwork memCopy.s -o memCopy.o
<br/>
<br/>
arm-elf-ld -Tc:\development\gba\lnkscript.ld -o rom.elf crt0.o main.o setMode.o setPixel.o rgb15.o memCopy.o
<br/>
arm-elf-objcopy -O binary rom.elf rom.gba
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I would really appriciate any help!
<br/>
<br/>
Thanks...
<br/>
<br/>
- Pan</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#24015 - poslundc - Mon Jul 26, 2004 5:38 pm</h4>
    <div class="postbody"><span class="postbody">Well, unless you're building it as a multiboot program, it shouldn't be linking at all, because the distance from code in the ROM to code in IWRAM is further than what can be processed in a BL instruction.
<br/>
<br/>
Furthermore, you are switching from Thumb to ARM instructions without using a BX instruction, which won't work.
<br/>
<br/>
You need to load the address of the other function into memory, and then use the BX instruction to branch to it. eg.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">     ldr     r0, L_MYFUNC
<br/>
     mov     lr, pc
<br/>
     bx      r0
<br/>
          ...
<br/>
L_MYFUNC:
<br/>
     .word     myFunctionName     @ function you want to branch to</td> </tr></table><span class="postbody">
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#24017 - pan69 - Mon Jul 26, 2004 6:24 pm</h4>
    <div class="postbody"><span class="postbody">Aha, I understand...
<br/>
<br/>
...but that leaves me with even more questions. First, how come that it does link? When my memCopy function is supposed to be in IWRAM and unreachable with a BL instruction, I should get a link error but I don't... Any ideas why? 
<br/>
<br/>
And I don't quite understand your code. You load the address of a label and at the address of that label is a word variable...? I don't understand.... Could you whip me up a working example? That would be great... :)
<br/>
<br/>
Thanks!
<br/>
<br/>
- Pan</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#24018 - poslundc - Mon Jul 26, 2004 7:18 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>pan69 wrote:</b></span></td> </tr> <tr> <td class="quote">...but that leaves me with even more questions. First, how come that it does link? When my memCopy function is supposed to be in IWRAM and unreachable with a BL instruction, I should get a link error but I don't... Any ideas why?</td> </tr></table><span class="postbody">
<br/>
<br/>
Three possibilities:
<br/>
<br/>
1. Your code is compiled as multiboot.
<br/>
2. Your linker/link script is erroneous.
<br/>
3. I made a mistake reading/interpreting your code, or am missing some other information.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">And I don't quite understand your code. You load the address of a label and at the address of that label is a word variable...? I don't understand.... Could you whip me up a working example? That would be great... :)</td> </tr></table><span class="postbody">
<br/>
<br/>
It is the same as loading a global variable from C into a register, except instead of the name of the variable it is the name of the function. I don't have time to write a working example for you, but you should be able to find plenty by searching the forums or the net.
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#24029 - pan69 - Mon Jul 26, 2004 8:35 pm</h4>
    <div class="postbody"><span class="postbody">Thanks for your time and putting me into the right direction. The hunt is on! To bad there are so many half-truths and incomplete code snippets out there...
<br/>
<br/>
- Pan</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#24066 - pan69 - Tue Jul 27, 2004 10:02 am</h4>
    <div class="postbody"><span class="postbody">Oke guys,
<br/>
<br/>
It's always the best reward if you find things out for your self. This was the problem:
<br/>
<br/>
First of all the call to the memCopy function should have been done like poslundc suggested. Becoming like this:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
      ldr   r0, =memCopy
<br/>
      mov   lr, pc
<br/>
      bx      r0
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
After changing that, the function never returned. This was due to the fact that 'lr' did contain the correct address to return to but when the 'bx' instruction was executed the cpu never got back to thumb mode and started executing ARM instructions at the address where 'lr' pointing to.
<br/>
So before executing 'bx lr' the lower bit of the 'lr' register needed to be set to '1' (causing a switch to thumb on bx). the code became this:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
memCopy:
<br/>
   @ Return to caller...
<br/>
<br/>
     orr     lr, lr, #1          @ &lt;-- going back to thumb...
<br/>
     bx      lr
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
So, there you have it... I hope this may help people in the future :)
<br/>
<br/>
- Pan</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#24069 - torne - Tue Jul 27, 2004 12:00 pm</h4>
    <div class="postbody"><span class="postbody">I would recommend setting the low bit before the call, not in the return, otherwise if you call memCopy from ARM code it will fail to return correctly. Something like this:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
      ldr   r0, =memCopy
<br/>
      mov   lr, pc
<br/>
      add   lr, #3
<br/>
      bx      r0
<br/>
</td> </tr></table><span class="postbody">
<br/>
You have to add three because the addition of the extra instruction means you need to return one halfword later.
<br/>
<br/>
Personally, I'd do this with a farcall helper function, but if you're only calling it in a few places it probably doesn't matter.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#24070 - Kay - Tue Jul 27, 2004 12:03 pm</h4>
    <div class="postbody"><span class="postbody">In order to return correctly from subrout, you must save LR (R14) in stack before calling cascaded branch and link/exchange code from another subrout (exemple in ARM).
<br/>
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
   ....
<br/>
   stmed   sp!,{r14}
<br/>
   bl   SubRoutToGo
<br/>
   ldmed   sp!,{r14}
<br/>
   ...
<br/>
<br/>
SubRoutToGo:
<br/>
   ...
<br/>
   mov   pc,lr
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
<br/>
Try to verify that point too ... in many cases, this will cause infinite loop or random failure when returning from subrout when LR is not saved.
<br/>
<br/>
<br/>
<br/>
<br/>
-- Kay</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#24072 - pan69 - Tue Jul 27, 2004 12:47 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>torne wrote:</b></span></td> </tr> <tr> <td class="quote">I would recommend setting the low bit before the call, not in the return, otherwise if you call memCopy from ARM code it will fail to return correctly. Something like this:
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
      ldr   r0, =memCopy
<br/>
      mov   lr, pc
<br/>
      add   lr, #3
<br/>
      bx      r0
<br/>
</td> </tr></table><span class="postbody">
<br/>
You have to add three because the addition of the extra instruction means you need to return one halfword later.
<br/>
<br/>
Personally, I'd do this with a farcall helper function, but if you're only calling it in a few places it probably doesn't matter.
<br/>
</span></td> </tr></table><span class="postbody">
<br/>
<br/>
Good point! But, instead of using a helper function, which can cause a little overhead, I fabricated this little GAS macro:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
.macro farCallT funcptr
<br/>
      ldr   r7, funcptr
<br/>
      mov   r6, #3
<br/>
      mov   lr, pc
<br/>
      add   lr, r6
<br/>
      bx      r7
<br/>
.endm
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
This macro is only usable in thumb code (I use the T at the end of all my functions/macros in order to indicate where they are to be used). Now I can call memCopy like this:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
      farCallT =memCopy
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
- Pan</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#24078 - torne - Tue Jul 27, 2004 5:35 pm</h4>
    <div class="postbody"><span class="postbody">Why put 3 into r6 first? You can add it directly.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#24091 - pan69 - Tue Jul 27, 2004 8:19 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>torne wrote:</b></span></td> </tr> <tr> <td class="quote">Why put 3 into r6 first? You can add it directly.</td> </tr></table><span class="postbody">
<br/>
<br/>
GAS doesn't like me adding immediate values to a register higher then r7 (lr equals r14) in thumb mode...
<br/>
<br/>
- Pan</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
