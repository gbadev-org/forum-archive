<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Stack Pointer basics? - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>ASM > Stack Pointer basics?</h2>
<div id="posts">
<div class="post">
    <h4>#46216 - Digeraticus - Tue Jun 21, 2005 7:55 pm</h4>
    <div class="postbody"><span class="postbody">I was wondering if anyone knew where I could find out about the stack pointer, how to use it, and what it is good for. Thanks.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#46228 - arundel - Tue Jun 21, 2005 11:23 pm</h4>
    <div class="postbody"><span class="postbody">There's not a lot to say. The stack pointer is a standard register that points to a memory location (n=32bit register).
<br/>
<br/>
PUSH n:
<br/>
mov reg(n), [SP]
<br/>
sub SP, 4
<br/>
<br/>
POP n:
<br/>
mov [SP], reg[n]
<br/>
add SP, 4
<br/>
<br/>
The stack layout itself is very simple. It's like a pile of sheets of paper. You put every new sheet of paper on top of the pile.
<br/>
<br/>
Of course you can manipulate the stack pointer without limitations.<br/>_________________<br/><span style="font-weight: bold">http://www.nausicaa.net</span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#46230 - DekuTree64 - Tue Jun 21, 2005 11:58 pm</h4>
    <div class="postbody"><span class="postbody">Actually, the stack on GBA is full-descending, so you need to subtract BEFORE storing a value to it.
<br/>
<br/>
Push a register:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">sub sp, sp, #4
<br/>
str reg, [sp]
<br/>
<br/>
// or more efficient, pre-decrement and write back to sp
<br/>
str reg, [sp, #-4]!</td> </tr></table><span class="postbody">
<br/>
<br/>
Pop a register:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">ldr reg, [sp]
<br/>
add sp, sp, #4
<br/>
<br/>
// or equivalently, post-increment with the load
<br/>
ldr reg, [sp], #4</td> </tr></table><span class="postbody">
<br/>
<br/>
Easiest is to use the load/store multiple instructions:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">stmfd sp!, {reg1, reg2, reg3}
<br/>
ldmfd sp!, {reg1, reg2, reg3}</td> </tr></table><span class="postbody">
<br/>
<br/>
Or equivalently in THUMB:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">push {reg1, reg2, reg3}
<br/>
pop {reg1, reg2, reg3}</td> </tr></table><span class="postbody"><br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#46250 - Digeraticus - Wed Jun 22, 2005 8:40 am</h4>
    <div class="postbody"><span class="postbody">I was hoping to find out more about things like Stack Frames, parameter passing via the stack, and how you are supposed to save registers to the stack before entering a new subroutine.
<br/>
<br/>
Are we supposed to keep track of which registers we save and load, or does the hardware do part of that job?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#46253 - Cearn - Wed Jun 22, 2005 9:42 am</h4>
    <div class="postbody"><span class="postbody">Not sure about stack frames, but if you want to know how parameters are passed, you may want to take a look at the <a class="postlink" href="http://www.arm.com/miscPDFs/8031.pdf" target="_blank">AAPCS</a> (it's a pdf btw). 
<br/>
<br/>
The short of it is: the first four arguments are put in r0-r3, the rest (if any) go on the stack. r0-r3 are <span style="font-weight: bold">scratch</span> registers, meaning that the caller of a function expects them to be clobbered (goes for r12 to IIRC). The called function doesn't have to save those. If you need the other registers (r4 and on) the called function should push/pop them. If a function calls another function, then r14 (the link register, lr) must be stacked as well.
<br/>
<br/>
If you want to see how the compiler does this, compile with -S and browse the generated assembly. It can be quite instructive.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#46392 - Digeraticus - Fri Jun 24, 2005 2:54 am</h4>
    <div class="postbody"><span class="postbody">Can we get any more info on medium to advanced stack uses? I guess I underestimated these stack topics...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#46410 - sajiimori - Fri Jun 24, 2005 10:31 am</h4>
    <div class="postbody"><span class="postbody">Computer science books on algorithms, data structures, and compilers will discuss stacks at length.  ARM-specific details can be found in the ARM documentation.  Let us know if you have any specific questions.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#46435 - Miked0801 - Fri Jun 24, 2005 6:50 pm</h4>
    <div class="postbody"><span class="postbody">Stack - Last if First Out data storage structure.
<br/>
<br/>
The default (r13) is used for temporary variable storage, register saving, and local variable declarations.  The default stack starts at the end (almost) of IWRAM and grows backwarads through memory so that the top of memory can be safly reserved for static and global declarations.
<br/>
<br/>
Anything else :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#46441 - Digeraticus - Fri Jun 24, 2005 9:22 pm</h4>
    <div class="postbody"><span class="postbody">Miked, I made it pretty clear that I want to know about parameter passing via the stack, using the stack for temporary variables, and stack frames... I guess I know all the basic stuff, and when I encountered something I hadn?t heard about before, I assumed it was basic when I read this thread. But from people?s responses, I guess using a stack in these ways isn?t as basic as I thought.
<br/>
<br/>
So if I could get more info on this stuff, that?d be nice. If you think I?d get a better response in a new thread titled ?Advanced Stack Techniques?, I can post it...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#46443 - poslundc - Fri Jun 24, 2005 10:10 pm</h4>
    <div class="postbody"><span class="postbody">I think everyone is having trouble figuring out what exactly it is you want to know. There are no real advanced "techniques" to using a stack. It's just that: a stack. Creating a thread with a different title won't change that.
<br/>
<br/>
On the GBA, when you want to store data for a routine, you put it on the stack, usually using stmfd. Then when you want to pop stuff off, you use ldmfd. You can access specific offsets into the stack using str and ldr if you keep track of where you've placed your stuff.
<br/>
<br/>
Ensuring that the SP is at the same point when your subroutine exits as it was when it began maintains the stack frame for your routine, as specified in the AAPCS.
<br/>
<br/>
<a class="postlink" href="http://forum.gbadev.org/viewtopic.php?t=2338" target="_blank">This topic</a> goes into detail about how the AAPCS specifies behaviour for variadic routines, if that's what you're looking for.
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#46445 - Miked0801 - Fri Jun 24, 2005 10:21 pm</h4>
    <div class="postbody"><span class="postbody">Oh wait, he's talking using: mov r13,13 to  double the speed at which stack accesses occur.  I get it.
<br/>
<br/>
:)</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
