<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>inline asm - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>ASM > inline asm</h2>
<div id="posts">
<div class="post">
    <h4>#9235 - johnny_north - Thu Jul 31, 2003 4:36 am</h4>
    <div class="postbody"><span class="postbody">I admit I don't know what I'm doing when it comes to assembly, could someone help me here?
<br/>
<br/>
When I do this:
<br/>
<br/>
   void MBClient::SWI25(MBStruct mp){
<br/>
   asm("mov r0, %0\n"
<br/>
      " mov r1,#1\n"
<br/>
      " swi 0x25\n"       //NOTE!!!!! Use 0x250000 for ARM C Compiler mode.
<br/>
      :  // Outputs       // 0x25 here will only work for Thumb mode.
<br/>
      :  // Inputs
<br/>
      : "r0","r1","r2","r8","r9","r10","r11","r12"     // Regs crushed &amp; smushed
<br/>
      );
<br/>
<br/>
   }
<br/>
<br/>
I get the error:
<br/>
mbclient.cpp: In member function `void MBClient::SWI25(MBStruct)':
<br/>
mbclient.cpp:140: invalid `asm': operand number out of range
<br/>
<br/>
I'm trying to take Jeff F's multiboot struct out of the global variable space, instead passing the struct to swi25 as a local.  How can I set r0 to mp and avoid this error?
<br/>
<br/>
Maybe someone could help me with the main issue: when I declare the MBStruct as a global (MBStruct is just a struct with info for the bios to do multiboot cliet stuff, about 40 bytes) the program starts fine, then hangs  in the same place every time. If I make the MBStruct a member of a class and declare an instace of the class, no problem. Any reason declaring a global would do this?
<br/>
<br/>
devkit R4, C++
<br/>
CFLAGS  = -I $(INCDIR2) -I $(INCDIR) -I $(PRJDIR) -mthumb-interwork -c -g -Wall 
<br/>
SFLAGS  = -I $(INCDIR2) -I $(INCDIR) --warn -mthumb-interwork -marm7tdmi
<br/>
LDFLAGS = -L $(LIBDIR) -L $(LIBDIR2) -L $(PRJDIR) -T lnkscript -lm -lg -lstdc++ -lgcc -nostartfiles -Wl,-Map,bin.map</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#9236 - DekuTree64 - Thu Jul 31, 2003 5:24 am</h4>
    <div class="postbody"><span class="postbody">Put "r" (mp) where it says // Inputs and it should work. 
<br/>
But my advice is to use pure ASM instead of inline, unless absolutely neccessary. Just make a .s file and write functions in that, and call them from C like regular functions. 
<br/>
Basically what you need to do for an ASM function is something like
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
.global FuncName
<br/>
.arm
<br/>
.align 4
<br/>
FuncName:
<br/>
//do stuff
<br/>
bx lr
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Another thnig you'll most likely need is to save registers so you can mess with them, and then restore them before you return, so do something like
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
.global AnotherFunction
<br/>
.arm
<br/>
.align 4
<br/>
AnotherFunction:
<br/>
stmfd sp!, {r4-r7}
<br/>
//do stuff involving r4-r7
<br/>
ldmfd sp!. {r4-r7}
<br/>
bx lr
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
stm/ldm mean store multiple/load multiple, and fd means full descending Full means the value currently pointed to by the stack pointer (r13, also called sp), is used, so you should change sp before writing to it, or load from it before changing it, and descending means it grows downward, so decrement and then store, or load and then increment.
<br/>
Hope that helps, just post if anything needs clearing up.
<br/>
<br/>
Oh, and I don't know if that would work for a member function, I've never used C++ on GBA. But you could write an ASM function and then call that from your C++ member function.<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#9291 - johnny_north - Fri Aug 01, 2003 2:34 am</h4>
    <div class="postbody"><span class="postbody">I see what you're refering to when I look at other code. Ok, I've made the change:
<br/>
<br/>
void MBClient::SWI25(MBStruct mp){
<br/>
<br/>
   // Execute BIOS routine to transfer client binary to slave unit
<br/>
   asm volatile (
<br/>
      " mov r0, %0\n"
<br/>
      " mov r1,#1\n"
<br/>
      " swi 0x25\n"       //NOTE!!!!! Use 0x250000 for ARM C Compiler mode.
<br/>
      :  // Outputs       // 0x25 here will only work for Thumb mode.
<br/>
      :  "r" (mp)// Inputs
<br/>
      : "r0","r1","r2","r8","r9","r10","r11","r12"     // Regs crushed &amp; smushed
<br/>
      );
<br/>
<br/>
   }
<br/>
<br/>
Now I get this error:
<br/>
mbclient.cpp: In member function `void MBClient::SWI25(MBStruct)':
<br/>
mbclient.cpp:140: Internal compiler error in emit_move_insn, at expr.c:2713 (this is line 140 " mov r0, %0\n")
<br/>
Please submit a full bug report,
<br/>
with preprocessed source if appropriate.
<br/>
<br/>
I have other swi inline stuff elsewhere that compiles and works fine:
<br/>
<br/>
void Background::LZ77UnCompVRAM(u32 source, u32 dest) {
<br/>
      asm("mov r0, %0\n"
<br/>
            "mov r1, %1\n"
<br/>
            "swi 0x12 &lt;&lt; 16 \n"
<br/>
            :
<br/>
            :"r" (source), "r" (dest)
<br/>
            :"r0", "r1" );
<br/>
}
<br/>
<br/>
??</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#9292 - johnny_north - Fri Aug 01, 2003 2:36 am</h4>
    <div class="postbody"><span class="postbody">I was mistaken the line 140 error refers to:
<br/>
<br/>
asm volatile (</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#9295 - DekuTree64 - Fri Aug 01, 2003 3:24 am</h4>
    <div class="postbody"><span class="postbody">Try ldr r0, %0 or ldr r0, [%0], forgot which it is, but I think that's the problem.<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#9311 - tom - Fri Aug 01, 2003 10:50 am</h4>
    <div class="postbody"><span class="postbody">no, the problem is something else.
<br/>
look at the following bit of code (i used this to reproduce the problem, i was so bored=)
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
typedef struct {
<br/>
    u32 x;
<br/>
    u32 y;
<br/>
    u32 z;
<br/>
}bla;
<br/>
<br/>
void foo(bla blubb) {
<br/>
    asm volatile (
<br/>
        "mov    r0,%0    \n"
<br/>
        :
<br/>
        : "r"(blubb)
<br/>
        : "r0"
<br/>
    );
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
the problem is, blubb is a bla structure on the stack, and with the line
<br/>
<br/>
"r"(blubb)
<br/>
<br/>
you tell the compiler to move this structure (not its address, which is probably what you want...) into a register, which isn't possible.
<br/>
solution: make blubb a pointer to a bla structure.
<br/>
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
void MBClient::SWI25(MBStruct *mp){ 
<br/>
    asm(
<br/>
        "mov r0,%0\n" 
<br/>
        "mov r1,#1\n" 
<br/>
        "swi 0x25\n"
<br/>
        : // no output
<br/>
        : "r"(mp)
<br/>
        : "r0","r1","r2","r8","r9","r10","r11","r12"
<br/>
    ); 
<br/>
} 
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
this should work, haven't tested it, though.
<br/>
oh yes...something else: according to gbatek, the pointer to the multiboot structure must be passed in r7, not r0. also, there's a return value you might want to pass back (r0  0=okay, 1=failed)</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
