<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Passing parameters to assembly functions - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>ASM > Passing parameters to assembly functions</h2>
<div id="posts">
<div class="post">
    <h4>#15779 - gbawiz - Thu Jan 29, 2004 11:42 pm</h4>
    <div class="postbody"><span class="postbody">Hello,
<br/>
I am attempting to write some of my function procedures in assembly but my main code is in 'C'
<br/>
How do I send parameters such as 'int variables' to my assembly function?
<br/>
<br/>
Thanx</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#15781 - DekuTree64 - Fri Jan 30, 2004 12:10 am</h4>
    <div class="postbody"><span class="postbody">This is a pretty common question around here, but here goes. The first 4 parameters are passed in r0-r3, the rest are pushed onto the stack. Check <a class="postlink" href="http://forum.gbadev.org/viewtopic.php?t=2338" target="_blank">http://forum.gbadev.org/viewtopic.php?t=2338</a> for more info on how to retrieve the stack ones.<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#15782 - poslundc - Fri Jan 30, 2004 12:19 am</h4>
    <div class="postbody"><span class="postbody">The <a class="postlink" href="http://www.arm.com/products/DevTools/abi/aapcs.pdf" target="_blank">Arm-Thumb Procedure Call Standard</a> is the definitive reference you need.
<br/>
<br/>
Generally, though, the first four parameters to a function are passed in registers r0-r3.
<br/>
<br/>
You can access global variables by specifying them in local code and then loading them into registers from there.
<br/>
<br/>
<span style="font-weight: bold">Edit:</span> DekuTree64 beat me to it... :P
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#15783 - gbawiz - Fri Jan 30, 2004 1:09 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>poslundc wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
Generally, though, the first four parameters to a function are passed in registers r0-r3.
<br/>
You can access global variables by specifying them in local code and then loading them into registers from there.
<br/>
Dan.</td> </tr></table><span class="postbody">
<br/>
<br/>
Thanks for the advice.
<br/>
How do you load variables into the registers in your 'C' source code for use in the routines which are written in assembly?
<br/>
<br/>
I tried defining the variables outside of the 'main' routine so that they are visible in all functions.
<br/>
My 'c' source and assembly link and compile ok and i can reference the variables from the assembly but they seem to have the wrong values.
<br/>
here is the examples:
<br/>
<br/>
-------------- 'C' source (main.c) -------------------
<br/>
#include"gba.h"
<br/>
<br/>
extern void setpixel();
<br/>
<br/>
u16 pixel = 0x00FF;
<br/>
<br/>
int main()
<br/>
{
<br/>
<br/>
  REG_DISPCNT = 0x403;
<br/>
  setpixel();
<br/>
  while(1){}
<br/>
}
<br/>
------------------------------------------------
<br/>
<br/>
------------- assembly source (test.s)-----------------
<br/>
<br/>
@----- CODE START ----@
<br/>
	.global setpixel
<br/>
setpixel:
<br/>
	ldr r1,=0x6000200
<br/>
	ldr r2, = 0x00ff
<br/>
	str r2, [r1]
<br/>
	bx lr @return;
<br/>
@------ CODE END ----@
<br/>
<br/>
------------------------------------------------
<br/>
and here is the command lines I use (inside a batch file)
<br/>
<br/>
set path=C:\devkitadv\bin;%path%
<br/>
gcc test.s main.c
<br/>
objcopy -O binary a.out test.gba
<br/>
pause</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#15784 - poslundc - Fri Jan 30, 2004 2:52 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>gbawiz wrote:</b></span></td> </tr> <tr> <td class="quote">Thanks for the advice.
<br/>
How do you load variables into the registers in your 'C' source code for use in the routines which are written in assembly?</td> </tr></table><span class="postbody">
<br/>
<br/>
An example would be as follows:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">   ldr   r0, .L_GLOBALS   @ r0 &lt;- address of myCVariable
<br/>
   ldr   r1, [r0]      @ r1 &lt;- contents of myCVariable
<br/>
   str   r2, [r0]      @ myCVariable &lt;- contents of r2
<br/>
   b   SOMEWHERE_ELSE
<br/>
.L_GLOBALS:
<br/>
   .word   myCVariable</td> </tr></table><span class="postbody">
<br/>
<br/>
... where myCVariable is (as the name implies) a global variable in C.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">I tried defining the variables outside of the 'main' routine so that they are visible in all functions.
<br/>
My 'c' source and assembly link and compile ok and i can reference the variables from the assembly but they seem to have the wrong values.
<br/>
here is the examples:</td> </tr></table><span class="postbody">
<br/>
<br/>
OK, a few things.
<br/>
<br/>
1. Your example doesn't actually attempt to access any C variables, so it's impossible to tell what could be going wrong with it.
<br/>
<br/>
2. What exactly goes wrong with your code? ie. if it compiles and links okay, what do you expect it to do and what is it doing instead? Be specific.
<br/>
<br/>
3. Please post your code inside the code tags, as it makes it much easier to read.
<br/>
<br/>
Nothing jumps out as being "wrong" in the code you posted, other than the colour of the pixel you are plotting may not be what you are intending (0x00FF will give you 100% intensity red mixed with 50% intensity green).
<br/>
<br/>
I also think you're supposed to put a .pool directive at the end of your code if you're generating constants using the "ldr =" technique, although if it's compiling then it's probably just replacing the ldrs with mov and orr instructions.
<br/>
<br/>
You might also want to add the following tags to the beginning of your code:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">   .section    .iwram   @ put your arm code in IWRAM, or use .text for ROM-based code
<br/>
   .arm         @ specify arm instructions (vs. .thumb)
<br/>
   .align   2   @ align to 4 bytes; not usually a problem but just in case
<br/>
   .type   setpixel, function   @ useful for the linker, I suppose</td> </tr></table><span class="postbody">
<br/>
<br/>
Your stuff is compiling so none of the above stuff is absolutely necessary, but these are useful directives nevertheless.
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#15790 - torne - Fri Jan 30, 2004 12:01 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>poslundc wrote:</b></span></td> </tr> <tr> <td class="quote">I also think you're supposed to put a .pool directive at the end of your code if you're generating constants using the "ldr =" technique, although if it's compiling then it's probably just replacing the ldrs with mov and orr instructions.</td> </tr></table><span class="postbody">
<br/>
<br/>
You don't need to put .pool in most circumstances; the pool is automatically dumped at a section change (i.e. end of the file). You only need to use a .pool directive when the default location for the pool is too far away from one of the instructions that references it. Also, the ldr pseudoinstruction can only generate mov instructions (or ldr from a pool), it's not smart enough to do shifts/adds for you (and wouldn't know whether to or not, as it doesn't know the memory timing parameters of your target hardware).</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#15797 - poslundc - Fri Jan 30, 2004 2:42 pm</h4>
    <div class="postbody"><span class="postbody">Yeah, that makes sense. One of the reasons I never used the "ldr =" technique was because I was always sceptical about how it weighed the timing of memory accesses versus the timing of orr-ing together a constant. It makes far more sense that it just chooses between either mov-ing it in or ldr-ing it from the pool.
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#15800 - gbawiz - Fri Jan 30, 2004 4:43 pm</h4>
    <div class="postbody"><span class="postbody">Hello,
<br/>
Ive just had a look at the entry i made above,
<br/>
the line which states: ldr r2, = 0x00ff should be ldr r2, = pixel
<br/>
if you compile the 'test.s' file on its own in a GBA assembler then it should show a red dot on the screen which is what it should be according to the tutorial I used.
<br/>
What i want to do is to pass a pixel value from the main 'C' code to the assembler function 'drawpixel'
<br/>
Here is my attempt:
<br/>
<br/>
<span style="color: red">Firstly here is the c code within main.c</span>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#include"gba.h"
<br/>
<br/>
u16 pixel = 0x00FF;
<br/>
extern void setpixel();
<br/>
<br/>
int main()
<br/>
{   
<br/>
   REG_DISPCNT = 0x403;
<br/>
   setpixel();
<br/>
   while(1){}
<br/>
}
<br/>
<br/>
//----------- end  --------------------
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
<span style="color: violet">Now here is the assembly code within 'test.s'</span>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#include"main.c"
<br/>
<br/>
<br/>
@----- CODE START ----@
<br/>
.L_GLOBALS: 
<br/>
   .word pixel
<br/>
<br/>
   .global setpixel
<br/>
setpixel:
<br/>
   ldr r4,=0x06000200
<br/>
   ldr r5, = pixel
<br/>
   str r5, [r4]
<br/>
   bx lr @return;
<br/>
<br/>
@------ CODE END ----@
<br/>
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
here is the batch file i use to create the rom
<br/>
<br/>
<span style="color: blue">
<br/>
set path=C:\devkitadv\bin;%path%
<br/>
gcc test.s main.c
<br/>
objcopy -O binary a.out test.gba
<br/>
pause</span>
<br/>
<br/>
<br/>
At some point the 'pixel' variable doesnt keep the 0x00ff value and the colour on the screen ends up wrong.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#15801 - poslundc - Fri Jan 30, 2004 4:54 pm</h4>
    <div class="postbody"><span class="postbody">You need to read my example again. I'll give you a hint: you created a label called .L_GLOBALS but you aren't using it anywhere in your code. Suspicious, no?
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#15829 - torne - Sat Jan 31, 2004 4:15 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>poslundc wrote:</b></span></td> </tr> <tr> <td class="quote">Yeah, that makes sense. One of the reasons I never used the "ldr =" technique was because I was always sceptical about how it weighed the timing of memory accesses versus the timing of orr-ing together a constant. It makes far more sense that it just chooses between either mov-ing it in or ldr-ing it from the pool.</td> </tr></table><span class="postbody">
<br/>
<br/>
If you'd like a version that can compare memory timings, I wrote a macro which does this: <a href="http://forum.gbadev.org/viewtopic.php?t=154" target="_blank">http://forum.gbadev.org/viewtopic.php?t=154</a>
<br/>
It is set up under the assumption that the constant pool will be in ROM with default wait state timings, and will either generate shift/add sequences or a ldr = instruction.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#15830 - poslundc - Sat Jan 31, 2004 4:22 pm</h4>
    <div class="postbody"><span class="postbody">Neat. I'll probably continue just to decide manually whether to load or generate my constants, however. :) Seeing as I'm constantly flip-flopping between putting my code in IWRAM and EWRAM and ROM anyway.
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#15840 - gbawiz - Sun Feb 01, 2004 1:36 am</h4>
    <div class="postbody"><span class="postbody">I have managed to get my test routine working.
<br/>
I have realised that the problem is that when i pass the variable called 'pixel' , the assembly routine sees that as an address, even although i defined it as a 'u16' and not a pointer.
<br/>
To get around this i have loaded the address into r0 and then load r1 with the contents of address stored at r0.
<br/>
<br/>
Is there a faster and more direct way of getting variables into registers in assembly?
<br/>
<br/>
Thanks
<br/>
GbaWIZ</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#15842 - poslundc - Sun Feb 01, 2004 2:59 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>gbawiz wrote:</b></span></td> </tr> <tr> <td class="quote">I have managed to get my test routine working.
<br/>
I have realised that the problem is that when i pass the variable called 'pixel' , the assembly routine sees that as an address, even although i defined it as a 'u16' and not a pointer.</td> </tr></table><span class="postbody">
<br/>
<br/>
OK, the thing to realize is that when you get into assembler, it doesn't care what kinds of types and whatnot you were using in C. When you make a variable global, the <span style="font-style: italic">address</span> of that variable is provided to the linker. Think about it; in the following code:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">   ldr   r0, .L_GLOBALS
<br/>
   bx   lr
<br/>
.L_GLOBALS:
<br/>
   .word   myGlobalVariable</td> </tr></table><span class="postbody">
<br/>
<br/>
If myGlobalVariable is an imported variable from C, the variable itself won't actually exist at the memory address .L_GLOBALS, but somewhere else in memory that has been determined by the linker. What will instead be put there is the address of myGlobalVariable (or a pointer to it).
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">To get around this i have loaded the address into r0 and then load r1 with the contents of address stored at r0.</td> </tr></table><span class="postbody">
<br/>
<br/>
That's how it's done. (And also what I showed you in my earlier example. &lt;wink&gt;)
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Is there a faster and more direct way of getting variables into registers in assembly?</td> </tr></table><span class="postbody">
<br/>
<br/>
If you want to you can define your global variables in proximity to your ASM code, and then refer to it as an extern global in all your C code.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">   .align 2
<br/>
   .global myGlobalVariable
<br/>
   mov      r0, #SOMEVALUE
<br/>
   str      r0, myGlobalVariable   @ change the variable's value
<br/>
   @ etc. etc.
<br/>
   bx      lr
<br/>
myGlobalVariable:
<br/>
   .word   0x12345678   @initial variable value goes here
<br/>
<br/>
Then in your C code would have the following definition:
<br/>
<br/>
extern int      myGlobalVariable;</td> </tr></table><span class="postbody">
<br/>
<br/>
This is kind of a hacky way to do things, though. It's very rare that the extra load statment will make all that much difference, and it would probably be considered better practice to keep your global variables defined in your C code.
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#15873 - FluBBa - Mon Feb 02, 2004 9:29 am</h4>
    <div class="postbody"><span class="postbody">Did anybody even read what DekuTree64 wrote?
<br/>
<br/>
The first 4 arguments to the function are the normal registers.
<br/>
<br/>
Just do it like this with your define:
<br/>
extern void setpixel(u16 color);
<br/>
<br/>
@----- CODE START ----@
<br/>
.global setpixel
<br/>
setpixel:
<br/>
ldr r1,=0x6000200
<br/>
str r0, [r1]
<br/>
bx lr @return;
<br/>
@------ CODE END ----@ 
<br/>
<br/>
And it will set the pixel to the value of the first argument.
<br/>
Gaaaah, how hard can it be.<br/>_________________<br/>I probably suck, my not is a programmer.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#15880 - poslundc - Mon Feb 02, 2004 3:15 pm</h4>
    <div class="postbody"><span class="postbody">No offense, FluBBa, but it should be pretty obvious from the thread that the guy is interested in more than just how to pass a parameter to a function.
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
