<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Comparing two arrays - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>ASM > Comparing two arrays</h2>
<div id="posts">
<div class="post">
    <h4>#49316 - Shadow Wedge - Thu Jul 28, 2005 5:04 pm</h4>
    <div class="postbody"><span class="postbody">Hi, I've just started ARM assembly and I've made a test algorithm that compares two arrays of bytes and wanted to see if it is decent or if it could be improved further.
<br/>
<br/>
The C code is:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">int16 CompareArrays(int8* Array1, int8* Array2, int16 SizeOfArray) {
<br/>
   SizeOfArray *= SizeOfArray; //input is the root of what it should be
<br/>
<br/>
   int8* End = Array + SizeOfArray;
<br/>
   while (Array1 != End)
<br/>
      if (*Puzzle++ != *CurrentState++)
<br/>
         return 0; //failure
<br/>
<br/>
   return -1; //success
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
And the assembly that I made was:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">   mul     r3, r2, r2      @r2 contains the square root of the number of items in the array
<br/>
   and     r5, r3, #3      @r5 stores the remainder of the division
<br/>
   mov     r4, r3, asr #2  @r4 stores the number of fours in r3
<br/>
beginloop4s:
<br/>
   ldr   r2, [r0], #4
<br/>
   ldr   r3, [r1], #4
<br/>
   cmp   r2, r3
<br/>
   movne   r0, #0          @if not equal return 0
<br/>
   movne   pc, lr
<br/>
   sub     r4, r4, #1
<br/>
   bne   beginloop4s
<br/>
<br/>
   cmp   r5, #0          @make sure that there's a point in comparing more bytes
<br/>
   beq   endfunction
<br/>
beginloop1s:
<br/>
   ldrsb   r2, [r0], #1
<br/>
   ldrsb   r3, [r1], #1
<br/>
   cmp   r2, r3
<br/>
   movne   r0, #0          @if not equal return 0
<br/>
   movne   pc, lr
<br/>
   sub   r5, r5, #1
<br/>
   bne   beginloop1s
<br/>
endfunction:
<br/>
   mvn   r0, #0          @everything's a-ok, can return -1
<br/>
   mov   pc, lr
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
The compiler compared it one byte at a time, but I'm comparing the arrays in sets of four bytes. Would this be faster than one byte at a time?
<br/>
<br/>
Also, I don't know which registers I can mess with without pushing them.
<br/>
<br/>
Any help would be appreciated.
<br/>
<br/>
Edit: forgot to rename one of the variables in the C code.<br/>_________________<br/>...</span><span class="gensmall"><br/><br/>Last edited by Shadow Wedge on Fri Jul 29, 2005 10:14 pm; edited 2 times in total</span></div>    
</div>
<div class="post">
    <h4>#49321 - tepples - Thu Jul 28, 2005 5:32 pm</h4>
    <div class="postbody"><span class="postbody">On a typical RISC architecture such as ARM, you can compare arrays four bytes at a time <span style="font-style: italic">only if</span> the arrays are aligned. Any general purpose memcmp() implementation that uses one machine word at a time will also have to have one byte at a time for comparing non-aligned arrays, so your function will have to have special case code for each possibility. Some implementations just drop the word-at-a-time mode for space optimization. If you have your own reimplementation of memcmp() (as I see here), GCC definitely isn't smart enough to create a word-at-a-time mode by itself.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#49404 - Lupin - Fri Jul 29, 2005 2:08 pm</h4>
    <div class="postbody"><span class="postbody">Why are you passing Array1 and Array2 if they are not used within the function?
<br/>
<br/>
I guess "Puzzle" and "End" need to be int32 pointers and not int8<br/>_________________<br/><a class="postlink" href="http://pokeme.shizzle.it/" target="_blank">Team Pokeme</a>
<br/>
<a class="postlink" href="http://lupin.shizzle.it/" target="_blank">My blog and PM ASM tutorials</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#49410 - gladius - Fri Jul 29, 2005 3:30 pm</h4>
    <div class="postbody"><span class="postbody">A few small things:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
   sub     r4, r4, #1 
<br/>
   bne   beginloop4s 
<br/>
</td> </tr></table><span class="postbody">
<br/>
That will not work, because the flags are not set by every instruction.  You have to specify the 's' flag to set flags.  So, it would be like this:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
   subs     r4, r4, #1 
<br/>
   bne   beginloop4s 
<br/>
</td> </tr></table><span class="postbody">
<br/>
Secondly, instead of doing the two movne's, it would probably be better to do something like this:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
movne failReturn
<br/>
...
<br/>
failReturn:
<br/>
mov r0,#0
<br/>
mov pc, lr
<br/>
goodReturn:
<br/>
mvn r0, #0
<br/>
mov pc, lr
<br/>
</td> </tr></table><span class="postbody">
<br/>
Finally, you need to store r4-r12 and lr if you modify them.  Everything else is fair game (but if you don't restore the sp to what it was on entering, there will be trouble!)
<br/>
<br/>
Add the following to handle that:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
stmfd sp!, {r4-r5}
<br/>
...
<br/>
ldmfd sp!, {r4-r5} @ Execute this before you return
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#49438 - Miked0801 - Fri Jul 29, 2005 7:06 pm</h4>
    <div class="postbody"><span class="postbody">Also, your initial shift down of num bytes
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
mov     r4, r3, asr #2
<br/>
</td> </tr></table><span class="postbody">
<br/>
Works as intended only of the number of bytes in the array is a multiple of 4.  Prentend there are only 7 bytes to compare.  Your routine will abort after processing only 4 of those bytes.  BTW, if the size is less than 4 bytes, you routine is reading off the end of both arrays - another no-no.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#49456 - caitsith2 - Fri Jul 29, 2005 9:44 pm</h4>
    <div class="postbody"><span class="postbody">Also, instead of doing 
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
mov pc, lr
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
you may wish to do this
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
bx lr
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
What this allows for, is the code to be called from both thumb and arm mode, and switch the processor mode back properly, when done.
<br/>
<br/>
If you use </span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
mov pc, lr
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Then if the code that executed it was arm code, it will return properly, but if it was called from thumb code, then it will return in arm mode, which is not good.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#49459 - Shadow Wedge - Fri Jul 29, 2005 10:26 pm</h4>
    <div class="postbody"><span class="postbody">tepples:
<br/>
I don't know that much about alignment... Is it when the location of the beginning of the array is divisible by 4? And if so, how do I specifically set an array to be aligned? Otherwise I don't know how to check if an array is aligned...
<br/>
<br/>
Lupin: "Why are you passing Array1 and Array2 if they are not used within the function?"
<br/>
Erm, sorry... From the calling function Array1 is stored in r0, and Array2 is stored in r1.
<br/>
<br/>
gladius: Thanks, I'll add those suggestions.
<br/>
<br/>
Miked0801: Well, I store the remainder of the division in r5 (the AND statement) and then the second loop is to compare the extra bytes (if there are any). Also, thanks for telling me about the less-than-4-bytes thing, but this function is assuming that the array is at least 4 bytes long.
<br/>
<br/>
caitsith2: Thanks, I'll change that.
<br/>
<br/>
My updated code is:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">   stmfd sp!, {r4-r5} 
<br/>
   mul     r3, r2, r2      @r2 contains the square root of the number of items in the array
<br/>
   and     r5, r3, #3      @r5 stores the remainder of the division
<br/>
   mov     r4, r3, asr #2  @r4 stores the number of fours in r3
<br/>
beginloop4s:
<br/>
   ldr   r2, [r0], #4
<br/>
   ldr   r3, [r1], #4
<br/>
   cmp   r2, r3
<br/>
   bne   failreturn        @if not equal return 0
<br/>
   subs     r4, r4, #1
<br/>
   bne   beginloop4s
<br/>
<br/>
   cmp   r5, #0          @make sure that there's a point in comparing more bytes
<br/>
   beq   goodreturn
<br/>
beginloop1s:
<br/>
   ldrsb   r2, [r0], #1
<br/>
   ldrsb   r3, [r1], #1
<br/>
   cmp   r2, r3
<br/>
   bne   failreturn        @if not equal return 0
<br/>
   subs   r5, r5, #1
<br/>
   bne   beginloop1s
<br/>
goodreturn:
<br/>
   mvn   r0, #0          @everything's a-ok, can return -1
<br/>
   ldmfd sp!, {r4-r5}
<br/>
   bx lr
<br/>
failreturn:
<br/>
   mov   r0, #0          @did not work, return 0
<br/>
   ldmfd sp!, {r4-r5}
<br/>
   bx lr
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Edit: I'm failing at posting correctly today &gt;_&gt;<br/>_________________<br/>...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#49478 - tepples - Sat Jul 30, 2005 1:11 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Shadow Wedge wrote:</b></span></td> </tr> <tr> <td class="quote">I don't know that much about alignment... Is it when the location of the beginning of the array is divisible by 4?</td> </tr></table><span class="postbody">
<br/>
Yes.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">And if so, how do I specifically set an array to be aligned?</td> </tr></table><span class="postbody">
<br/>
<a class="postlink" href="http://gcc.gnu.org/onlinedocs/gcc-3.4.4/gcc/Variable-Attributes.html#Variable-Attributes" target="_blank">There's an attribute for that</a>.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
