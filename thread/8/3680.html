<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>problem with red dot! - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>ASM > problem with red dot!</h2>
<div id="posts">
<div class="post">
    <h4>#23234 - Darmstadium - Thu Jul 08, 2004 6:04 am</h4>
    <div class="postbody"><span class="postbody">Yo, I'm a real noob to ASM, I just started today. I got a problem with this code that is supposed to display two red dots of 0xF &gt; 0xE:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
@include screen.h
<br/>
@textarea
<br/>
<br/>
;set mode, enable bg2
<br/>
ldr r0,=REG_DISPCNT
<br/>
ldr r1,=(MODE_3 | BG2_ENABLE)
<br/>
str r1,[r0]
<br/>
<br/>
ldr r0,=0xF
<br/>
ldr r1,=0xE
<br/>
cmp r0,r1
<br/>
bgt drawreddots
<br/>
<br/>
;main loop
<br/>
mainloop
<br/>
B mainloop
<br/>
<br/>
drawreddots
<br/>
ldr r0,=0xFF
<br/>
ldr r1,=(vram+(40+100*240))
<br/>
str r0,[r1]
<br/>
ldr r1,=(vram+(43+100*240))
<br/>
str r0,[r1]
<br/>
<br/>
@pool
<br/>
@endarea
<br/>
</td> </tr></table><span class="postbody">
<br/>
The first dot appears but the second doesn't.
<br/>
<br/>
And I got a question about branching to a different label: if I want to go back to where I branched from in the drawreddots label after the code there is done being executed, do I have to make a label back where I branched from and then branch back to there like this?:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
@include screen.h
<br/>
@textarea
<br/>
<br/>
;set mode, enable bg2
<br/>
ldr r0,=REG_DISPCNT
<br/>
ldr r1,=(MODE_3 | BG2_ENABLE)
<br/>
str r1,[r0]
<br/>
<br/>
ldr r0,=0xF
<br/>
ldr r1,=0xE
<br/>
cmp r0,r1
<br/>
bgt drawreddots
<br/>
returnfromdrawing
<br/>
<br/>
;main loop
<br/>
mainloop
<br/>
b mainloop
<br/>
<br/>
drawreddots
<br/>
ldr r0,=0xFF
<br/>
ldr r1,=(vram+(40+100*240))
<br/>
str r0,[r1]
<br/>
ldr r1,=(vram+(43+100*240))
<br/>
str r0,[r1]
<br/>
b returnfromdrawing
<br/>
<br/>
@pool
<br/>
@endarea
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
thanks</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#23236 - DekuTree64 - Thu Jul 08, 2004 7:11 am</h4>
    <div class="postbody"><span class="postbody">What's happening is that the first of your dots is placed at byte 40, and the second is at 43, but because of how the ARM deals with non-word-aligned str instructions, it's writing ot the same place. The lower byte makes no difference at all, and writing to an odd halfword causes it to write the lower 2 bytes of the word to that odd address, and the upper 2 bytes to the 2 bytes BELOW that, so they're swapped. Normally you don't want that to happen. 
<br/>
So, your second dot is being drawn in the next pixel over, but also covering over the previous dot. To fix this, use strh, which stores 2 bytes instead of 4. Also, you need to multiply your addresses by 2 for mode3, because ARM instructions operate in bytes always, and mode3 is 2 bytes per pixel.
<br/>
<br/>
Also, use strh for writing the value to REG_DISPCNT, because it's a 16-bit register. The upper 2 bytes aren't used, so it won't cause problems here, but for the future, you could overwrite another register without knowing it.
<br/>
<br/>
For getting back to where you were, use bl instead of just b. That copies the old r15 (also called the program counter, or pc), into r14 (link register, lr), and then branches. Then use bx lr (or bx r14, same thing) to get back to where you were. 
<br/>
Watch out though, when you do that it overwrites the old value of lr, so you need to store it first. Since this is your. That's done by pushing it onto the stack with stmfd sp!, {lr}. sp is the stack pointer, also known as r13. Do this at the start of your function so you don't have to worry about it, and then when returning use ldmfd sp!, {lr} to get it back, and then bx lr to whoever called you. 
<br/>
<br/>
You don't need to worry about all that for this though, since you're going into an infinite loop. You can just bgtl (or blgt? I forget which) to drawreddots and then bx lr to get back.<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#23245 - Darmstadium - Thu Jul 08, 2004 5:12 pm</h4>
    <div class="postbody"><span class="postbody">I did all the stuff you said and the two red dots draw where I want em, but the green dot doesn't draw at all. I can't figure out why not. Could you take a look?:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
@include screen.h
<br/>
@textarea
<br/>
<br/>
ldr r0,=REG_DISPCNT
<br/>
ldr r1,=(MODE_3 | BG2_ENABLE)
<br/>
strh r1,[r0]
<br/>
<br/>
ldr r0,=0xF
<br/>
ldr r1,=0xE
<br/>
cmp r0,r1
<br/>
stmfd sp!,{lr}
<br/>
bgtl drawreddots
<br/>
<br/>
ldr r0,=0x5
<br/>
ldr r1,=0x5
<br/>
sub r2,r0,r1
<br/>
cmp r2,0x0
<br/>
stmfd sp!,{lr}
<br/>
<br/>
;main loop
<br/>
mainloop
<br/>
b mainloop
<br/>
<br/>
drawreddots
<br/>
ldmfd sp!,{lr}
<br/>
ldr r0,=0xFF
<br/>
ldr r1,=(vram+(40*2+100*2*240))
<br/>
strh r0,[r1]
<br/>
ldr r1,=(vram+(42*2+100*2*240))
<br/>
strh r0,[r1]
<br/>
bx lr
<br/>
<br/>
drawgreendot
<br/>
ldmfd sp!,{lr}
<br/>
ldr r0,=0xF0F
<br/>
ldr r1,=(vram+(8*2+8*2*240))
<br/>
strh r0,[r1]
<br/>
bx lr
<br/>
@pool
<br/>
@endarea
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
thanks for your help</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#23252 - dagamer34 - Thu Jul 08, 2004 7:38 pm</h4>
    <div class="postbody"><span class="postbody">I never did understand ARM ASM. I guess I should learn it now. Some one needs to make another assembly tutorial. I would if I could but I can't so I guess I won't. :)<br/>_________________<br/>Little kids and Playstation 2's don't mix. :(</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#23256 - johnny_north - Thu Jul 08, 2004 9:59 pm</h4>
    <div class="postbody"><span class="postbody">Are you missing a branch to drawgreendots?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#23265 - Darmstadium - Fri Jul 09, 2004 12:30 am</h4>
    <div class="postbody"><span class="postbody">yes, it appears i am. wow, I really have no idea how I could have missed that...thanks man</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
