<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Picture Problems - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>ASM > Picture Problems</h2>
<div id="posts">
<div class="post">
    <h4>#172923 - nathanpc - Thu Mar 11, 2010 7:36 pm</h4>
    <div class="postbody"><span class="postbody">Hello,
<br/>
 I was trying to do some tests with pictures and Assembly with this code:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">.arm
<br/>
.text
<br/>
.global main
<br/>
main:
<br/>
   mov r0, #0x4000000  @ the usual set up routine
<br/>
   mov r1, #0x400   @ 0x403 is BG 2 enable, and mode 3.
<br/>
   add r1, r1, #3
<br/>
   strh r1, [r0]   @ the memory I/O value we're setting is actually 16bits, let's not mess 
<br/>
         @ something else up by writting 32.
<br/>
   
<br/>
   mov r0, #0x6000000  @ address of VRAM
<br/>
   ldr r1, =pic        @ using this form of LDR with a label will put the address of the label into r1.
<br/>
   mov r2, #0x960     @ the amount of 32 BYTE writes to fill the screen (we'll be using a new instruction)
<br/>
loop1:
<br/>
   ldmia r1!, { r3,r4,r5,r6,r7,r8,r9,r10 } @ will start with the address in r1, it will load each listed register
<br/>
            @ with 32bits from memory, incrementing the address by 4 each time. The final address used +4
<br/>
            @ will be written back into r1 (because of the !). Note this instruction doesn't use 
<br/>
            @ brackets around the register used for the address.
<br/>
   stmia r0!, { r3,r4,r5,r6,r7,r8,r9,r10 } @ will start with the address in r1, it will store each listed register
<br/>
            @ into memory (32bit write), adding 4 to the address. The final address used +4 will
<br/>
            @ be written back.
<br/>
   @ These instructions are a fast(er) way to do block memory copying, they are only useful when you have alot of
<br/>
   @ registers available (registers 3-10 were used here, but I could have said r2,r4, they don't have to be in order
<br/>
   @ just don't use the address register in the destination list.
<br/>
<br/>
   subs r2, r2, #1  @ subtraction setting the flags
<br/>
   bne loop1  @ will loop if r2 wasn't zero.
<br/>
<br/>
infin:
<br/>
   b infin  @ infinite loop
<br/>
<br/>
.ltorg   @ give the assembler a place to put the immediate value "pool", needed for the ldr REG,= (s).
<br/>
pic:   @ a label to indicate the address  of the included data.
<br/>
   .incbin "pic.bin"  @ include the binary file</td> </tr></table><span class="postbody">
<br/>
But when I tried to emulate it, I got this:
<br/>
<a href="http://img707.imageshack.us/img707/8145/imagemqmf.png">[Images not permitted - Click here to view it]</a>
<br/>
What can I do?
<br/>
<br/>
<span style="font-style: italic">PS: I've used the sample image povided with Bimbo.</span>
<br/>
<br/>
Best Regards,
<br/>
 Nathan Paulino Campos</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#172927 - Dwedit - Thu Mar 11, 2010 8:45 pm</h4>
    <div class="postbody"><span class="postbody">The code looks correct.  The data file is probably bad.  Look at the data file with a hex editor or something, it will probably just be a repeating sequence of words or something.<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#172932 - nathanpc - Thu Mar 11, 2010 11:24 pm</h4>
    <div class="postbody"><span class="postbody">I've exported the hex to a TXT file. Take a look at it and on the bin file.
<br/>
<ul>
<br/>
<li><a class="postlink" href="http://d.imagehost.org/download/0204/pic" target="_blank">Hex Output</a>
<br/>
</li><li><a class="postlink" href="http://i.imagehost.org/download/0203/pic" target="_blank">pic.bin (75 KB)</a></li></ul></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#172933 - Dwedit - Thu Mar 11, 2010 11:48 pm</h4>
    <div class="postbody"><span class="postbody">Code worked fine when I tested it.
<br/>
<br/>
Which version of DevKitArm are you using?
<br/>
If you are using the example makefiles, there is an issue with the toolchain where the starting directory is actually "build\" instead of what you would expect.  So incbin will fail to find the file.  You need to .incbin "../source/pic.bin" instead of just "pic.bin" (assuming your .bin file is in the "source" directory)
<br/>
<br/>
Edit: You mentioned you aren't using devkitarm.
<br/>
Make sure your memory map is correct.  It sounds like your compiler is generating code running from 0x00000000, and it tries to load an absolute address from there.  It only ran correctly up to this point because all other code was position independent.  The start address should be 0x08000000.<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#172934 - nathanpc - Fri Mar 12, 2010 12:02 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Dwedit wrote:</b></span></td> </tr> <tr> <td class="quote">Edit: You mentioned you aren't using devkitarm.
<br/>
Make sure your memory map is correct.  It sounds like your compiler is generating code running from 0x00000000, and it tries to load an absolute address from there.  It only ran correctly up to this point because all other code was position independent.  The start address should be 0x08000000.</td> </tr></table><span class="postbody">
<br/>
How can I do this?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#172938 - Dwedit - Fri Mar 12, 2010 6:32 am</h4>
    <div class="postbody"><span class="postbody">Use the makefiles, specs, linkscripts, and crt0 files that come with devkitpro, and stuff will just work.<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#172955 - nathanpc - Fri Mar 12, 2010 6:22 pm</h4>
    <div class="postbody"><span class="postbody">Now I've compiled the DevKit Advance binutils and tried to compile the sources with it. Like this:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">arm-agb-elf-as -mthumb-interwork test.S
<br/>
arm-agb-elf-objcopy -O binary a.out pic.gba</td> </tr></table><span class="postbody">
<br/>
And now I got a black screen only.
<br/>
<br/>
What I need to do now?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#172958 - Dwedit - Fri Mar 12, 2010 8:28 pm</h4>
    <div class="postbody"><span class="postbody">Devkitadvance is really old, avoid it.<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#172960 - nathanpc - Fri Mar 12, 2010 8:34 pm</h4>
    <div class="postbody"><span class="postbody">Ok, but I want to use it and what I can do?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#172961 - Cearn - Fri Mar 12, 2010 9:31 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>nathanpc wrote:</b></span></td> </tr> <tr> <td class="quote">Ok, but I want to use it and what I can do?</td> </tr></table><span class="postbody">You can use assembly just as well with devkitArm as devkitAdv. Probably better, actually, because the distribution also contains template makefiles that can manage your assembly files pretty much automatically.
<br/>
<br/>
For example, assuming you've got devkitArm and its examples:
<br/>
<ul><li>Grab the gba template from the examples (examples/gba/template), copy it somewhere and rename it to ... whatever.</li><li>Remove the template.c file from the source folder.</li><li>Create a main.s file in the source folder.</li><li>Fill it with the following code:</li></ul></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">//
<br/>
// main.s : example assembly file.
<br/>
//
<br/>
<br/>
// main function. Entry point. 
<br/>
// Notice the boilerplate directives for a function. While not always 
<br/>
// required, it is recommended.
<br/>
    .text                       @ Text (=code) section
<br/>
    .arm                        @ ARM code (Thumb uses ".thumb_func")
<br/>
    .align 2                    @ Align to 4-byte boundary.
<br/>
    .global main                @ Make a symbol out of the function name.
<br/>
main:
<br/>
    @ Enable bg-mode 3 and BG 2
<br/>
    ldr     r0,=0x04000000      @ = REG_DISPCNT
<br/>
    ldr     r1,=0x0403          @ = DCNT_MODE3 | DCNT_BG2
<br/>
    str     r1, [r0]
<br/>
<br/>
    @ Draw a red rectangle.
<br/>
    ldr     r0,=0x001F                  @ Red color
<br/>
    ldr     r1,=(0x06000000+10*240+20)  @ position (20,10)
<br/>
<br/>
    mov     r2, #32                     @ Height
<br/>
.Ly_loop:
<br/>
        mov     r3, #40                 @ Width
<br/>
.Lx_loop:
<br/>
            strh    r0, [r1], #2        @ Plot 1 pixel, advance pointer
<br/>
            subs    r3, r3, #1          @ Advance x-index and test.
<br/>
            bne     .Lx_loop
<br/>
            @ End x_loop
<br/>
        add     r1, #(240-40)*2         @ Advance pointer to the next line of the rect.
<br/>
        subs    r2, #1                  @ Advance y-index and test.
<br/>
        bne     .Ly_loop
<br/>
        @ End y_loop
<br/>
    
<br/>
.Lloop:                         @ Infinite loop.
<br/>
    b   .Lloop
<br/>
</td> </tr></table><span class="postbody">This code will produce a red rectangle in video mode 3. It's not very efficient, but it works. The indentation is optional, but it can be useful to indicate loop-blocks and such.<li>Now to assemble and link the code: just run make in the project's directory. For convenience, you can do it from within an IDE or programmer's editor (like PN2 which comes with the devkitArm. Open the pnproj file and hit Alt+1.
<br/>
<br/>
with devkitArm and it's template projects, all the set-up stuff is taken care of. Yes, you can use devkitAdv if you really want to, but all that does is make thing harder unnecessarily.
<br/>
<br/>
Tonc also contains a rudimentary guide to ARM assembly (<a class="postlink" href="http://www.coranac.com/tonc/text/asm.htm" target="_blank">tonc:asm</a>). It can tell you the most important instructions, things to watch out for, and where you can get more information (in particular, instruction quick-references).
<br/>
<br/>
One nice trick is to write some C code and compile with -save-temps. With this, GCC will put the generated assembly code in a file, and you can look at it and see what functional ARM assembly looks like.</li></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
