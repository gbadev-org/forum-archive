<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Errors re-writing a "C" in assembly - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>ASM > Errors re-writing a "C" in assembly</h2>
<div id="posts">
<div class="post">
    <h4>#177085 - blessingta@hotmail.co.uk - Thu Dec 08, 2011 2:35 pm</h4>
    <div class="postbody"><span class="postbody">Basically, I'm trying to rewrite a "C" function in assembly but it refuses to work.
<br/>
<br/>
here is the code &amp; errors: (my original C file is the one commented out)
<br/>
<br/>
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
//VRAM = video ram
<br/>
#include &lt;gba_console.h&gt;
<br/>
#include &lt;gba_video.h&gt;
<br/>
#include &lt;gba_interrupt.h&gt;
<br/>
#include &lt;gba_systemcalls.h&gt;
<br/>
#include &lt;gba_input.h&gt;
<br/>
<br/>
#include &lt;stdio.h&gt;
<br/>
<br/>
/*
<br/>
void ASSEMBLY_FUNC_HERE()
<br/>
{
<br/>
<br/>
volatile unsigned char * pvuc_Im_in_assembly = "find me here in assembly";
<br/>
<br/>
}
<br/>
*/
<br/>
asm (
<br/>
".align   2                           \n\t"
<br/>
".global   ASSEMBLY_FUNC_HERE      \n\t"
<br/>
"   .code   16                      \n\t"
<br/>
"   .thumb_func                     \n\t"
<br/>
"   .type   ASSEMBLY_FUNC_HERE, %function \n\t"
<br/>
"ASSEMBLY_FUNC_HERE:                  \n\t"
<br/>
//".LFB6:                                \n\t"
<br/>
   
<br/>
"   .loc 1 11 0                      \n\t"
<br/>
"   .cfi_startproc                   \n\t"  
<br/>
//".LVL0:                              \n\t"
<br/>
"   .loc 1 15 0                     \n\t"
<br/>
"   @ sp needed for prologue          \n\t"
<br/>
"   bx   lr                          \n\t"
<br/>
"   .cfi_endproc                    \n\t"
<br/>
//".LFE6:                              \n\t"
<br/>
"   .size   ASSEMBLY_FUNC_HERE, .-ASSEMBLY_FUNC_HERE \n\t"
<br/>
   );
<br/>
<br/>
int NEWFUNC (int i)
<br/>
{
<br/>
 i += 9000;
<br/>
return i;
<br/>
}
<br/>
<br/>
//---------------------------------------------------------------------------------
<br/>
// Program entry point
<br/>
//---------------------------------------------------------------------------------
<br/>
int main(void) {
<br/>
//---------------------------------------------------------------------------------
<br/>
<br/>
   // the vblank interrupt must be enabled for VBlankIntrWait() to work
<br/>
   // since the default dispatcher handles the bios flags no vblank handler
<br/>
   // is required
<br/>
   irqInit();
<br/>
   irqEnable(IRQ_VBLANK);
<br/>
<br/>
   consoleDemoInit();
<br/>
   
<br/>
   ASSEMBLY_FUNC_HERE();
<br/>
   NEWFUNC(1);
<br/>
   
<br/>
   while (1) {
<br/>
      VBlankIntrWait();
<br/>
   }
<br/>
}
<br/>
<br/>
<br/>
<br/>
</td> </tr></table><span class="postbody">
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
&gt; "make" 
<br/>
main.c
<br/>
arm-eabi-gcc -MMD -MP -MF /h/YEAR2/Console_Programming_CONPRG/Course_Work/gba/my_gba_asm/build/main.d -g -Wall -O3 -save-temps -mcpu=arm7tdmi -mtune=arm7tdmi -fomit-frame-pointer -ffast-math -mthumb -mthumb-interwork -I/h/YEAR2/Console_Programming_CONPRG/Course_Work/gba/my_gba_asm/include -I/c/devkitPro/libgba/include -I/h/YEAR2/Console_Programming_CONPRG/Course_Work/gba/my_gba_asm/build -c /h/YEAR2/Console_Programming_CONPRG/Course_Work/gba/my_gba_asm/source/main.c -o main.o 
<br/>
h:/YEAR2/Console_Programming_CONPRG/Course_Work/gba/my_gba_asm/source/main.c: In function 'main':
<br/>
h:/YEAR2/Console_Programming_CONPRG/Course_Work/gba/my_gba_asm/source/main.c:58:2: warning: implicit declaration of function 'ASSEMBLY_FUNC_HERE' [-Wimplicit-function-declaration]
<br/>
main.s: Assembler messages:
<br/>
main.s:20: Error: unassigned file number 1
<br/>
main.s:20: Error: junk at end of line, first unrecognized character is `0'
<br/>
main.s:22: Error: unassigned file number 1
<br/>
main.s:22: Error: junk at end of line, first unrecognized character is `0'
<br/>
make[1]: *** [main.o] Error 1
<br/>
"make": *** [build] Error 2
<br/>
<br/>
&gt; Process Exit Code: 2
<br/>
&gt; Time Taken: 00:01
<br/>
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#177086 - blessingta@hotmail.co.uk - Thu Dec 08, 2011 2:44 pm</h4>
    <div class="postbody"><span class="postbody">Are functions declared in assembly hidden from "C"? Do I have to declare my function in "C" instead?
<br/>
<br/>
<br/>
From reading a bit, I'm guessing align 2 is a place in memory, 
<br/>
but what is LFB6?Is it a subroutine within a function?
<br/>
<br/>
Plus why is the line below returning an error and that does it do?
<br/>
"loc 1 11 0          \n\t"</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#177094 - Cearn - Sat Dec 10, 2011 11:06 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>blessingta@hotmail.co.uk wrote:</b></span></td> </tr> <tr> <td class="quote">Are functions declared in assembly hidden from "C"? Do I have to declare my function in "C" instead?</td> </tr></table><span class="postbody">
<br/>
Yes and yes. 
<br/>
<br/>
I think you're missing a very important distinction here. You have function (and variable) <span style="font-weight: bold">definitions</span> and <span style="font-weight: bold">declarations</span>. A definition is the actual function itself and what will appear in the intermediate object files (.o) and the final binary (.gba). The declaration just to tell C that some symbol exists in the project and how to interact with it. A definition can act as a declaration, but not the other way around.
<br/>
<br/>
Example:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">// --------------------------------------------------------------------
<br/>
// DECLARATIONS. Put these in source (.c) or header (.h) files.
<br/>
// --------------------------------------------------------------------
<br/>
extern int var;
<br/>
extern const unsigned int data[256];
<br/>
void foo(int x);
<br/>
<br/>
<br/>
// --------------------------------------------------------------------
<br/>
// DEFINITIONS. Put these in source (.c) only.
<br/>
// --------------------------------------------------------------------
<br/>
<br/>
// uninitialized definition
<br/>
int var;
<br/>
<br/>
// initialized definition
<br/>
const unsigned int data[256]=
<br/>
{
<br/>
    // data
<br/>
};
<br/>
<br/>
void foo(int x)
<br/>
{
<br/>
    // code
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
In your example, the thing between asm() is the definition, but the C compiler pretty much ignores what's inside because it's for the assembler to handle. As such, no declaration for ASSEMBLY_FUNC_HERE() exists yet.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>blessingta@hotmail.co.uk wrote:</b></span></td> </tr> <tr> <td class="quote">From reading a bit, I'm guessing align 2 is a place in memory, 
<br/>
but what is LFB6?Is it a subroutine within a function?
<br/>
</td> </tr></table><span class="postbody">Technically, there are no such things as functions or variables or anything in assembly. There's just instructions, data and labels. "LFB6" is a label, which marks an important location for the assembler, that's all. In practice, though, some labels are useful to think of as functions or variables, but the assembler really doesn't care.
<br/>
<br/>
As a rule, anything ending with ":" is a label. By convention, labels that start with "." are supposed to be internal labels, indicating branch destinations for things like ifs and loops. The other things that start with "." (like ".align 2") are directives, telling the assembler how to deal with the next instruction, but don't appear in the generated binary.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>blessingta@hotmail.co.uk wrote:</b></span></td> </tr> <tr> <td class="quote">Plus why is the line below returning an error and that does it do?
<br/>
"loc 1 11 0          \n\t"</td> </tr></table><span class="postbody">This is a potential breakpoint for a debugger (generated by compiler flag "-g"), and they can be removed.
<br/>
<br/>
The reason it returns an error is because the first argument is a file number. If you look at the generated asm for NEW_FUNC(), you'll see this:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">NEWFUNC:
<br/>
.LFB0:
<br/>
   .file 1 "h:/dev/gba/proj/tonc/test/mini/blessing.c"
<br/>
   .loc 1 39 0
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
The .file directive indicates what file is linked to file number 1. Since ASSEMBLY_FUNC_HERE() is above NEW_FUNC, the numer isn't defined yet, and ".loc 1" doesn't work. 
<br/>
<br/>
If you want to learn asm by looking at what the compiler makes, remove the "-g" compiler flag first. It generates much cleaner assembly that way. I would also strongly suggest using separate assembly files instead of inline assembly for your first tries. Learning assembly can be hard enough without having to learn the intricacies and potential pitfalls that come with inline asm, as you've seen here.
<br/>
<br/>
my_asm.s (put this in '/sources')
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">@ Standard boilerplate for assembly functions
<br/>
    .text               @ Put the following stuff in the "text" (== code) section
<br/>
    .align 2            @ align to 1&lt;&lt;2 bytes
<br/>
    .thumb              @ Assemble as thumb code
<br/>
    .thumb_func         @ Call as thumb function
<br/>
    .global my_func     @ Generate an object symbol for it
<br/>
my_func:                @ Label for function entry point.
<br/>
    @ start of function
<br/>
<br/>
    bx lr
<br/>
    @ end of function
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
in main.c: 
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">// Function declaration (not definition)
<br/>
void my_func();
<br/>
<br/>
//---------------------------------------------------------------------------------
<br/>
// Program entry point
<br/>
//---------------------------------------------------------------------------------
<br/>
int main(void) {
<br/>
   irqInit();
<br/>
   irqEnable(IRQ_VBLANK);
<br/>
<br/>
   // function call
<br/>
   my_func();
<br/>
<br/>
   consoleDemoInit();
<br/>
   
<br/>
   while (1) {
<br/>
      VBlankIntrWait();
<br/>
   }
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
See also <a class="postlink" href="http://forum.gbadev.org/viewtopic.php?t=17784" target="_blank">thread: 17784</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#177106 - blessingta@hotmail.co.uk - Sun Dec 11, 2011 9:50 pm</h4>
    <div class="postbody"><span class="postbody">thanks.
<br/>
<br/>
 I just need to get assembly working in less than 2days for my assessment deadline.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
