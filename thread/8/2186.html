<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Why can't I branch? :( - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>ASM > Why can't I branch? :(</h2>
<div id="posts">
<div class="post">
    <h4>#11399 - davewelsh - Sat Oct 04, 2003 4:26 pm</h4>
    <div class="postbody"><span class="postbody">I was following gbaguy's tutorials (although I'm using as instead of goldroad), and I've managed to get things working well, figuring out .EQU instead of @define, .text instead of @textarea, etc.
<br/>
<br/>
What I'm having trouble with is loops.
<br/>
<br/>
Here is code that works:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">        .include "consts.s"
<br/>
                                                                                                         
<br/>
        .ARM
<br/>
        .ALIGN
<br/>
                                                                                                         
<br/>
        LDR r1,=REG_DISPCNT             @ load into r1 ??
<br/>
        LDR r2,=(MODE_3|BG2_ENABLE)     @ load graphics mode into into r2
<br/>
        STR r2, [r1]                    @ store r2 into [r1] (init graphics)
<br/>
                                                                                                         
<br/>
        LDR r1, =0xff00ff               @ load colour into r1 (2 x red)
<br/>
        LDR r2, =VRAM+2400              @ load initial location into r2 (0, 10)
<br/>
        STR r1, [r2]                    @ plot two pixels at [r2]
<br/>
                                                                                                         
<br/>
        ADD r2, r2, #4                  @ move forward
<br/>
        STR r1, [r2]                    @ plot two pixels at [r2]
<br/>
                                                                                                         
<br/>
        ADD r2, r2, #4                  @ move forward
<br/>
        STR r1, [r2]                    @ plot two pixels at [r2]
<br/>
                                                                                                         
<br/>
        ADD r2, r2, #4                  @ move forward
<br/>
        STR r1, [r2]                    @ plot two pixels at [r2]
<br/>
                                                                                                         
<br/>
        ADD r2, r2, #4                  @ move forward
<br/>
        STR r1, [r2]                    @ plot two pixels at [r2]
<br/>
                                                                                                         
<br/>
wait:   B wait                          @ loop forever
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I'm not sure if the "B wait" works, but I assume it does for now.
<br/>
<br/>
Here is code that doesn't seem to work for me. The loop only executes once:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">        .include "consts.s"
<br/>
                                                                                                         
<br/>
        .ARM
<br/>
        .ALIGN
<br/>
                                                                                                         
<br/>
        LDR r1,=REG_DISPCNT             @ load into r1 ??
<br/>
        LDR r2,=(MODE_3|BG2_ENABLE)     @ load graphics mode into into r2
<br/>
        STR r2, [r1]                    @ store r2 into [r1] (init graphics)
<br/>
                                                                                                         
<br/>
        LDR r1, =0xff00ff               @ load colour into r1 (2 red pixels)
<br/>
        LDR r2, =VRAM+2400              @ load initial location into r2 (0, 10)
<br/>
                                                                                                         
<br/>
        MOV r3, #5
<br/>
                                                                                                         
<br/>
loop:   STR r1, [r2]                    @ plot two pixels at [r2]
<br/>
        ADD r2, r2, #4                  @ move forward
<br/>
        SUBS r3, r3, #1                 @ decrement loop register
<br/>
        BPL loop                        @ loop while positive
<br/>
                                                                                                         
<br/>
wait:   B wait                          @ loop forever</td> </tr></table><span class="postbody">
<br/>
<br/>
When I run this in VirtualBoyAdvance I get two red pixels at (0, 10) and (1, 10) but I figure I should get 8 more. I've also tried this with the labels on their own lines.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#11400 - sajiimori - Sat Oct 04, 2003 8:07 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
LDR r1, =0xff00ff               @ load colour into r1 (2 red pixels)
<br/>
</td> </tr></table><span class="postbody">
<br/>
Actually, 0x1f is red, but close enough. :-)
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
LDR r2, =VRAM+2400              @ load initial location into r2 (0, 10)
<br/>
</td> </tr></table><span class="postbody">
<br/>
That would actually be (0, 5), because it's 2 bytes per pixel.
<br/>
<br/>
But more importantly:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
loop:   STR r1, [r2]                    @ plot two pixels at [r2]
<br/>
</td> </tr></table><span class="postbody">
<br/>
You can only write 16 bits at a time to VRAM (that's one pixel in mode 3).  Use strh instead.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#11401 - tom - Sat Oct 04, 2003 9:49 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>sajiimori wrote:</b></span></td> </tr> <tr> <td class="quote">You can only write 16 bits at a time to VRAM (that's one pixel in mode 3).  Use strh instead.</td> </tr></table><span class="postbody">
<br/>
<br/>
nope. although the vram's bus width is only 16 bits, you can do 32 bit reads/writes.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#11402 - davewelsh - Sat Oct 04, 2003 10:14 pm</h4>
    <div class="postbody"><span class="postbody">Thanks for the info. I still don't see why I'm not getting more pixels. It seems to me the loop should run through a few times and draw more pixels.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#11403 - sajiimori - Sat Oct 04, 2003 10:29 pm</h4>
    <div class="postbody"><span class="postbody">I must be confused.  Maybe it was just that you can't write 8 bits at a time...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#11404 - davewelsh - Sat Oct 04, 2003 11:23 pm</h4>
    <div class="postbody"><span class="postbody">Well it was working with 32-bit writes, but I changed it to 16-bit ones. There's still the problem that no braching works for me. The following code only draws one pixel but it should draw a lot more:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">        LDR r6, =0x04000000             @ load ?? into r6
<br/>
        LDR r5, =(0x3|0x400)            @ load graphics mode into into r5
<br/>
        STR r5, [r6]                    @ store r5 into [r6] (init graphics)
<br/>
                                                                                                       
<br/>
        LDR r6, =0x06000960             @ load initial draw location into r6
<br/>
        LDR r5, =0x060012c0             @ load final draw location into r5
<br/>
        LDR r4, =0x001f                 @ load colour into r4 (2 red pixels)
<br/>
                                                                                                       
<br/>
test:
<br/>
        STRH r4, [r6], #2
<br/>
        CMP r6, r5
<br/>
        BLT test                        @ loop while r6 less than r5
<br/>
                                                                                                       
<br/>
wait:
<br/>
        B wait                          @ loop forever</td> </tr></table><span class="postbody">
<br/>
<br/>
<span style="text-decoration: underline">For example</span>, if I add the line</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">B test</td> </tr></table><span class="postbody"> just before the test label, then no pixels are drawn. Even though execution should simply go down to the next line and continue on.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#11405 - davewelsh - Sun Oct 05, 2003 1:20 am</h4>
    <div class="postbody"><span class="postbody">I found and downloaded souce code for some assembly-only projects. When I compiled them they didn't work, so I figure that's where my problem is.
<br/>
<br/>
I have been using</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">arm-thumb-elf-as -o output.elf input.s</td> </tr></table><span class="postbody"> Is this correct or not?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#11406 - DekuTree64 - Sun Oct 05, 2003 3:20 am</h4>
    <div class="postbody"><span class="postbody">Try replacing the arm-thumb-elf-as with gcc and see if it works.<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#11407 - davewelsh - Sun Oct 05, 2003 4:10 am</h4>
    <div class="postbody"><span class="postbody">Thanks for all your help. My problem was I wasn't setting up my header and entry point correctly. Once I added</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">.TEXT
<br/>
.ARM
<br/>
.GLOBAL AgbMain
<br/>
<br/>
AgbMain:</td> </tr></table><span class="postbody"> I was fine.
<br/>
<br/>
I copiled crt0.s into crt0.o and new2.s into new2.o by </span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">arm-thumb-elf-gcc -c &lt;inputfile&gt;</td> </tr></table><span class="postbody">
<br/>
<br/>
Then I linked them using </span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">arm-thumb-elf-gcc -o output.elf crt0.o new2.o -nostartfiles -nostdlib -T lnkscript</td> </tr></table><span class="postbody">
<br/>
<br/>
And then the standard </span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">arm-thumb-elf-objcopy -O binary output.elf output.gba</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
