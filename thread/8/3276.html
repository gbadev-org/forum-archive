<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>ARM - Branching vs. conditional operands question - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>ASM > ARM - Branching vs. conditional operands question</h2>
<div id="posts">
<div class="post">
    <h4>#19589 - isildur - Thu Apr 22, 2004 2:52 pm</h4>
    <div class="postbody"><span class="postbody">I am a bit new to ARM assembly and I read somewhere that its better to avoid branching as much as possible because branching is slow. But I was wondering which is faster between the 2 versions of the same code (taken from Dooby's lib).
<br/>
<br/>
This is the original, no branching:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
tst r0, #0x1        @ halfword aligned?
<br/>
<br/>
@ not aligned
<br/>
ldrneh   r1, [r0, #-1]!      @ grab short holding byte we're writing
<br/>
bicne   r1, r1, #0xff00   @ blank pixel we're writing
<br/>
orrne   r1, r1, r2, lsl #8  @ insert pixel we're writing
<br/>
strneh   r1, [r0], #2        @ write &amp; leave aligned to next halfword
<br/>
<br/>
@ aligned
<br/>
ldreqh   r1, [r0]               @ grab halfword
<br/>
biceq   r1, r1, #0x00ff       @ clear left pixel
<br/>
orreq   r1, r1, r2, lsr #24   @ insert left pixel
<br/>
streqh   r1, [r0]               @ plot
<br/>
<br/>
bx r14
<br/>
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
And this modification with just one branch and no conditions in the instructions:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
tst r0, #0x1   @ halfword aligned?
<br/>
beq L_Aligned
<br/>
<br/>
@ not aligned
<br/>
ldrh r1, [r0, #-1]!      @ grab short holding byte we're writing
<br/>
bic r1, r1, #0xff00      @ blank pixel we're writing
<br/>
orr r1, r1, r2, lsl #8   @ insert pixel we're writing
<br/>
strh r1, [r0], #2        @ write &amp; leave aligned to next halfword
<br/>
bx r14
<br/>
<br/>
@ aligned
<br/>
L_Aligned:
<br/>
ldrh   r1, [r0]      @ grab halfword
<br/>
bic   r1, r1, #0x00ff   @ clear left pixel
<br/>
orr   r1, r1, r2, lsr #24   @ insert left pixel
<br/>
strh   r1, [r0]      @ plot
<br/>
bx r14
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
So which one is faster/better and why?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#19591 - col - Thu Apr 22, 2004 3:25 pm</h4>
    <div class="postbody"><span class="postbody">The second one is faster
<br/>
<br/>
The conditional code using the ARM branch costs 3 cycles or 1 cycle whereas the conditional code in the first example always costs 4 cycles.
<br/>
<br/>
IMO it should be possible to juggle this to achieve better performance than either of these examples - but its impossible to say for sure because the code is out of context.
<br/>
<br/>
Col</span><span class="gensmall"><br/><br/>Last edited by col on Thu Apr 22, 2004 3:37 pm; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#19592 - poslundc - Thu Apr 22, 2004 3:26 pm</h4>
    <div class="postbody"><span class="postbody">Assuming you are running this code from RAM instead of ROM (which you should be, especially since ARM code is most effective when run from IWRAM), the second version is definitely faster than the first.
<br/>
<br/>
This is because there is no penalty in RAM for random-access, so even though a branch costs three memory-accessing cycles, you aren't hurt by having to jump to a different location in the code.
<br/>
<br/>
The break-even point between using conditional execution and just branching depends on the type of code and where it's being run from, but usually it's in the neighbourhood of three instructions or so.
<br/>
<br/>
You should also consider where the program flow is likely to go most of the time. In a pixel-plotting routine you'll probably have 50% of the time take the aligned branch, and the other 50% of the time the unaligned branch. But if you are handling a special-case in a routine that will only occur 10% of the time, you obviously want to optimize for the other 90%.
<br/>
<br/>
<span style="font-weight: bold">Edit:</span> col beat me, but only because the Internet seems to be way slow today...
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
