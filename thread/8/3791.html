<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Some ASM - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>ASM > Some ASM</h2>
<div id="posts">
<div class="post">
    <h4>#24107 - ProblemBaby - Wed Jul 28, 2004 2:08 am</h4>
    <div class="postbody"><span class="postbody">Iam trying and trying to add some asm code into my
<br/>
project and Ive two big problems.
<br/>
<br/>
1.
<br/>
Ive added added some BIOS-calls the one ive tried works except for one!
<br/>
VBlankIntrWait.
<br/>
<br/>
Code (yes it is a lot C but I dont think that is the problem):
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
void VBlankIntrWait();
<br/>
<br/>
void VBlankInt()
<br/>
{
<br/>
   REG_IF |= 0x1;
<br/>
}
<br/>
<br/>
void AgbMain()
<br/>
{
<br/>
   IntrTable[0] = VBlankInt;
<br/>
   REG_DISPSTAT = 0x8;
<br/>
   REG_IE |= 0x1;
<br/>
   REG_IME = 1;
<br/>
   
<br/>
<br/>
   while (1)
<br/>
   {
<br/>
      // Do stuff
<br/>
      VBlankIntrWait();
<br/>
   }
<br/>
}
<br/>
<br/>
// then in a .S file
<br/>
.arm
<br/>
.align 4
<br/>
.section .iwram
<br/>
<br/>
.global VBlankIntrWait
<br/>
VBlankIntrWait:
<br/>
   SWI 0x050000
<br/>
   BX lr
<br/>
</td> </tr></table><span class="postbody">
<br/>
Can someone see an error?
<br/>
<br/>
2.
<br/>
Ive made thumb_func-functions they worked until a tried to do
<br/>
one function that is anything special. But VBA tell me this:
<br/>
Unsupported BIOS function 9f called from 02017490. A BIOS file is needed in order to get correct behaviour.
<br/>
The interesting thing is if Ive a function like:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
.thumb_func
<br/>
.global func:
<br/>
func
<br/>
bx lr
<br/>
</td> </tr></table><span class="postbody">
<br/>
this one works.
<br/>
but if  I put one intruction more onto it i got the error.
<br/>
even if I do this:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
.thumb_func
<br/>
.global func:
<br/>
func
<br/>
bx lr
<br/>
bx lr
<br/>
</td> </tr></table><span class="postbody">
<br/>
and this works if I take away the other function that is in the file
<br/>
except the head and bx lr.
<br/>
strange huh!!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#24118 - dagamer34 - Wed Jul 28, 2004 4:03 am</h4>
    <div class="postbody"><span class="postbody">Man, I think this should be FAQed. I had this problem to but luckily I solved it today by reading some old posts. You have to notify the bios that a vblank has occured. Here's the code:
<br/>
<br/>
Put this where you define a whole bunch of registers, I like to put it right under REG_INTERUPT.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#define REG_BIOSVBLANK     *(vu16*)0x3007ff8      /* BIOS VBLANK Interrupt status bit*/
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
And then change your VBlank code to this:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
void VBlankInt() 
<br/>
{ 
<br/>
   // Acknowledge to the BIOS that a Vblank interupt has occured
<br/>
   REG_BIOSVBLANK = 1;
<br/>
   REG_IF |= 0x1; 
<br/>
} 
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I don't think I can solve your other problem, maybe someone more experienced in assembly can.<br/>_________________<br/>Little kids and Playstation 2's don't mix. :(</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#24125 - DekuTree64 - Wed Jul 28, 2004 7:49 am</h4>
    <div class="postbody"><span class="postbody">Yup, that problem should definitely go into the FAQ. I had a hard battle with it myself when I first tried to use the VBlank SWI. Would you mind adding it, Tepples?
<br/>
<br/>
Not sure what's happening in that other problem though. You are using GCC and not Goldroad or anything, right? If so, that shouldn't even compile, with the colon after the .global, and the label by itself. Or maybe you just typed it into the message by hand and made a typo. In any case, I need to see more code to figure out what's wrong. 
<br/>
Simple things to try that probably won't fix it: 
<br/>
1. Put .align 2 before it
<br/>
2. Put .thumb before it (I think .thumb_func automatically switches to reading instructions as thumb, but you never know)
<br/>
3. Make it a little longer so you have more to compare with, use the -Map file.map option when linking to check where the function is, and then go look at it in VBA's disassembly to see if it looks the same
<br/>
<br/>
And that's all I can think of for now, because I'm sleepy.<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#24137 - ProblemBaby - Wed Jul 28, 2004 12:09 pm</h4>
    <div class="postbody"><span class="postbody">1.
<br/>
Thanks, 
<br/>
it works in VBA but not at hardware any idea?
<br/>
just one more question as you saw in my first post the functions is put in iwram and that works perfect when i compile as multiboot but if I dont it doesn't work (ive to choose rodata).
<br/>
Something I should know???
<br/>
<br/>
2.
<br/>
Yeah it was a typo, I should look at it more today and see if I can solve if thanks for the tips. I'll post more code if I can't</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#24146 - tepples - Wed Jul 28, 2004 3:21 pm</h4>
    <div class="postbody"><span class="postbody">Things related to the BIOS may in fact work differently on the GBA and VBA. That said, I'm working on wording it for the FAQ.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#24460 - ProblemBaby - Wed Aug 04, 2004 1:18 am</h4>
    <div class="postbody"><span class="postbody">I got strange, strange problems I dont understand!
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
.thumb
<br/>
.align
<br/>
.section .rodata
<br/>
.thumb_func
<br/>
<br/>
.global IntrWait
<br/>
IntrWait:
<br/>
   SWI 0x04
<br/>
   BX lr
<br/>
<br/>
// .. more BIOS functions
<br/>
<br/>
HuffUnComp:
<br/>
   @SWI 0x13
<br/>
   
<br/>
   hej:
<br/>
   LDR r2, =0x4000000
<br/>
   LDR r3, =0x403
<br/>
   
<br/>
   B hej
<br/>
   
<br/>
   BX lr
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
this is my asm-file when I try to call HuffUnComp the code never come to this functions I dont understand why!
<br/>
+ I got the strange VBA error (BIOS File)
<br/>
why, why, why?? please help!
<br/>
it worked when it was ARM code and in iwram in VBA but not at hardware
<br/>
but I want it in ROM is that impossible??</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#24544 - ProblemBaby - Thu Aug 05, 2004 3:37 pm</h4>
    <div class="postbody"><span class="postbody">I fixed it it must be .text instead of .section .rodata
<br/>
for code!</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
