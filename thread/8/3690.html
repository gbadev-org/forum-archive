<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>questions - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>ASM > questions</h2>
<div id="posts">
<div class="post">
    <h4>#23307 - Darmstadium - Fri Jul 09, 2004 5:46 pm</h4>
    <div class="postbody"><span class="postbody">I have a lot of questions. Here they go:
<br/>
<br/>
1. Why would I use the bl instruction at all? I could just copy pc somewhere else and not have to worry about storing the old lr and then putting it back in lr after I branch to the code I want.
<br/>
<br/>
2. How do you make macros using GAS?
<br/>
<br/>
3. What is the stack for and how do I make use of it?
<br/>
<br/>
4. How do I write a function that takes arguments and returns a value in ASM and then use it in my C code?
<br/>
<br/>
5. How do I make variables using GAS and how do I tell it where in memory I want them?
<br/>
<br/>
6. Is there a tutorial on ARM ASM better that gbaguy's?
<br/>
<br/>
If you could answer any of these questions, I would be very grateful</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#23309 - poslundc - Fri Jul 09, 2004 6:25 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Darmstadium wrote:</b></span></td> </tr> <tr> <td class="quote">1. Why would I use the bl instruction at all? I could just copy pc somewhere else and not have to worry about storing the old lr and then putting it back in lr after I branch to the code I want.</td> </tr></table><span class="postbody">
<br/>
<br/>
BL lets you do it in a single instruction.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">2. How do you make macros using GAS?</td> </tr></table><span class="postbody">
<br/>
<br/>
.macro MyMacroName
<br/>
@ macro code
<br/>
.endm
<br/>
<br/>
Alternatively, if you run your code through the GCC pre-processor by naming it with a .S extension instead of lowercase .s, you can also use the #define macro directive it affords.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">3. What is the stack for and how do I make use of it?</td> </tr></table><span class="postbody">
<br/>
<br/>
The stack is memory used by the system, primarily for storing variables and passing parameters to and from subroutines. r13 is the stack pointer and is reserved for its use. It is a full-descending stack, which means that when your program begins it points to the end of IWRAM, and when you want to push a value onto it you first subtract 4 (the size of a register) from the stack pointer and store your value at that location. When you want to pop a value off you take the value currently being pointed to and increment the stack pointer.
<br/>
<br/>
You use it primarily with the assembly instructions stmfd and ldmfd, which handle the logistics automatically for you. But you can also use str and ldr, so long as you are mindful of where the stack pointer is pointing to.
<br/>
<br/>
In order to prevent memory leaks and crashes, the sp should always point to the same spot it pointed to at the end of your routine as it did at the beginning.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">4. How do I write a function that takes arguments and returns a value in ASM and then use it in my C code?</td> </tr></table><span class="postbody">
<br/>
<br/>
See <a class="postlink" href="http://www.arm.com/products/DevTools/abi/aapcs.pdf" target="_blank">the ARM procedure call standard</a> for the definitive reference, but basically the first four arguments passed to your function appear in r0-r3. Any additional arguments are on the stack. Your return value goes in r0. Search the forum for more details.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">5. How do I make variables using GAS and how do I tell it where in memory I want them?</td> </tr></table><span class="postbody">
<br/>
<br/>
This is a bit of a tricky question. Local variables should just be put on the stack, and can be referenced by using str/ldr commands relative to the stack pointer.
<br/>
<br/>
There are a few ways of creating global variables, but probably the simplest to explain and understand is just to create them in your C code. Then you can reference them in your ASM as in the following example:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">     ldr     r0, L_GLOBALS     @ r0 now has pointer to myCGlobal
<br/>
     ldr     r1, [r0]     @ r1 now has value of myCGlobal
<br/>
     add      r1, r1, #1
<br/>
     str     r1, [r0]     @ myCGlobal has now been incremented by 1
<br/>
     @ more code...
<br/>
     bx      lr
<br/>
L_GLOBALS:
<br/>
     .word     myCGlobal</td> </tr></table><span class="postbody">
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">6. Is there a tutorial on ARM ASM better that gbaguy's?</td> </tr></table><span class="postbody">
<br/>
<br/>
I'll let someone else answer this one, as I don't even recall what tutorial I used originally.
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#23380 - f(DarkAngel) - Sun Jul 11, 2004 1:10 pm</h4>
    <div class="postbody"><span class="postbody"><a href="http://www.heyrick.co.uk/assembler/" target="_blank">http://www.heyrick.co.uk/assembler/</a>
<br/>
This's like a (incomplete) reference sheet rather that tutorial. Not GBA-specific.
<br/>
<br/>
<a href="http://www1.cs.columbia.edu/~cs4824/arm_std_html.html" target="_blank">http://www1.cs.columbia.edu/~cs4824/arm_std_html.html</a>
<br/>
Tutorials/guides.<br/>_________________<br/>death scream...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#23409 - pan69 - Mon Jul 12, 2004 7:40 am</h4>
    <div class="postbody"><span class="postbody">Hi,
<br/>
<br/>
while we're at it... I also have a question about GAS: Can I use structures, like in C, and if so, how? Can't find it in the manual...
<br/>
<br/>
- Luke</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#23420 - poslundc - Mon Jul 12, 2004 2:38 pm</h4>
    <div class="postbody"><span class="postbody">Sharing structs between C and ASM is a tricky, tricky business. There is no automatic system to handle it, which is unfortunate, and you have to be careful because if you do it manually you need to be aware of how GCC pads and organizes your struct.
<br/>
<br/>
There is a somewhat complicated technique you can use which I have implemented for my programs, which requires two things:
<br/>
<br/>
- Knowledge of makefiles with which to make an intermediary program run when one of your header files containing the structs change
<br/>
- A C compiler (preferably GCC) targetted for your computer
<br/>
<br/>
Your GCC needs to generate structs the same way the ARM-targetted GCC does for it to work. Experimentally mine does so (for Mac OS X), and I would expect the same on most 32-bit platforms.
<br/>
<br/>
Like I said, it's a bit of a complicated system, and you need to add a line of code to an intermediary program whenever you want to access another struct field, but once you get it working it is pretty awesome as it automatically generates constants you can use in ASM and not worry about how your struct changes with time.
<br/>
<br/>
<a href="http://www.ifi.uio.no/~inf3150/tfaq2.html" target="_blank">http://www.ifi.uio.no/~inf3150/tfaq2.html</a> describes the general setup; I can provide you with code if you'd like, although I may not be able to get my hands on it until later this week.
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#23422 - torne - Mon Jul 12, 2004 2:41 pm</h4>
    <div class="postbody"><span class="postbody">The .struct directive defines a structure field by making offsets into the absolute section. You use it like this:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">    .struct 0
<br/>
field1:
<br/>
    .struct field1 + 4
<br/>
field2:
<br/>
    .struct field2 + 2
<br/>
field3:</td> </tr></table><span class="postbody">
<br/>
<br/>
This gives you three symbols, field1, field2 and field3, in the absolute section with values 0, 4 and 6 respectively. This can be used as a structure with a four-byte field, a two-byte field and another field of any length: just do preindexed addressing to access structure members:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">ldr r0, [r1, #field2]</td> </tr></table><span class="postbody">
<br/>
That will load field2 from the structure at the address in r1.
<br/>
<br/>
It's not very elegant, but it's all you get; remember, there are no variables in assembler, only memory locations, so you can't define a structure in the conventional sense. Also note that the .struct directive leaves the assembler in the absolute section, so make sure to insert a .section directive to switch back to the text segment once you have defined your structures, as otherwise your code will not link correctly.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
