<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>devkitARM and .s files problem - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>ASM > devkitARM and .s files problem</h2>
<div id="posts">
<div class="post">
    <h4>#58571 - t81b - Mon Oct 24, 2005 5:39 pm</h4>
    <div class="postbody"><span class="postbody">hello,
<br/>
<br/>
I've been trying to move a project over to devkitarm from devkitadv but I've run into a couple of problems with .s files. 
<br/>
I think I've tracked one problem down to branch commands not jumping to the correct address when I use the .global directive for a symbol.
<br/>
Below is a small snippet of code demonstrating the problem.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
   .thumb_func
<br/>
   .global   back
<br/>
back:   b   for
<br/>
   
<br/>
   .thumb_func
<br/>
   .global for
<br/>
for:   b   back
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Now this works without problems in devkitadv, but with devkitARM the branch commands point to the wrong addresses, so could there be something wrong with devkitARM or AS, or am I doing something wrong?
<br/>
<br/>
If I leave out the globals it works ok but I need to use them, and I could get around the problem by doing the following, so that branches within a file jump to a different label but the same address (but I'd have quite a few files to go through so I'd rather not have to do this :) )
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
   .thumb_func
<br/>
   .global   back
<br/>
back:
<br/>
back2:   b   for2
<br/>
   
<br/>
   .thumb_func
<br/>
   .global for
<br/>
for:
<br/>
for2:   b   back2
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
<br/>
The other problem is to do with devkitarm not being able to find .include files unless I give the absolute path such as:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">.include "e:/project/source/hardware.inc"</td> </tr></table><span class="postbody">
<br/>
<br/>
rather than
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">.include "hardware.inc"</td> </tr></table><span class="postbody">
<br/>
<br/>
<br/>
I can get around this by replacing the following lines in the base_rules:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#---------------------------------------------------------------------------------
<br/>
%.o: %.s
<br/>
   @echo $(notdir $&lt;)
<br/>
   @$(CC) -MMD -MF $(DEPSDIR)/$*.d -x assembler-with-cpp $(ASFLAGS) -c $&lt; -o $@
<br/>
   @$(adjustdepends)
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
with this :
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#---------------------------------------------------------------------------------
<br/>
%.o: %.s
<br/>
   @echo $(notdir $&lt;)
<br/>
   @$(AS) $(ASFLAGS) $&lt; -o $@
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
	but I'd rather not go messing with the base_rules file if I can avoid it.
<br/>
<br/>
<br/>
Any ideas on what I'm doing wrong or how to fix this?
<br/>
I'm using the latest version of devkitarm.
<br/>
<br/>
Thanks, Brendan</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#58574 - poslundc - Mon Oct 24, 2005 6:08 pm</h4>
    <div class="postbody"><span class="postbody">This looks like it could be an alignment problem... try adding the following lines before both labels:
<br/>
<br/>
.align 2
<br/>
<br/>
Also, make sure that the assembler is generating thumb code (I'm not certain that the thumb_func directive sets that flag) by placing the following at the beginning:
<br/>
<br/>
.thumb
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#58611 - t81b - Mon Oct 24, 2005 9:54 pm</h4>
    <div class="postbody"><span class="postbody">No, it's not that. I did have these set and should've included them with the example.
<br/>
<br/>
Here is a complete file and the disassembly from no$gba which shows the problem better.
<br/>
<br/>
I tried moving the updatePlayerDir routine to the top of the file but that made no difference.
<br/>
<br/>
Brendan.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
   .include   "defines.s"
<br/>
<br/>
@ face_forward
<br/>
@ set_plr_direction
<br/>
   
<br/>
   .text
<br/>
   .thumb
<br/>
   .align 4
<br/>
   
<br/>
   .thumb_func
<br/>
   .global   face_forward
<br/>
face_forward:
<br/>
   mov   r5,#plr_playdir
<br/>
   ldrh   r1,[r0,r5]
<br/>
   cmp   r1,#0
<br/>
   beq   1f         @ playing_up
<br/>
   
<br/>
   @===========================
<br/>
   @ playing down
<br/>
   @===========================
<br/>
<br/>
   mov   r5,#PLR_DIR_TO
<br/>
    mov   r1,#4
<br/>
    strh   r1,[r0,r5]
<br/>
    b   updatePlayerDir      @ THIS JUMPS TO THE WRONG ADDRESS
<br/>
    
<br/>
   @===========================
<br/>
   @ playing up
<br/>
   @===========================
<br/>
<br/>
1:
<br/>
   mov   r5,#PLR_DIR_TO
<br/>
   mov   r1,#0
<br/>
   strh   r1,[r0,r5]
<br/>
   b   updatePlayerDir      @ THIS JUMPS TO THE WRONG ADDRESS
<br/>
<br/>
<br/>
      
<br/>
<br/>
@=========================================================
<br/>
@ set the direction of the player depending on his angle
<br/>
@=========================================================
<br/>
<br/>
   @set the direction
<br/>
<br/>
    .thumb_func
<br/>
    .global   set_plr_direction
<br/>
set_plr_direction:
<br/>
   ldrh   r2,[r0,#plr_angle]
<br/>
   mov   r3,#0            @direction
<br/>
   mov   r1,#64   @45
<br/>
   cmp   r2,r1
<br/>
   ble   1f   
<br/>
   mov   r3,#2
<br/>
   mov   r1,#192   @135
<br/>
   cmp   r2,r1
<br/>
   ble   1f   
<br/>
   mov   r3,#4
<br/>
   ldr   r1,=320   @225
<br/>
   cmp   r2,r1
<br/>
   ble   1f   
<br/>
   mov   r3,#6
<br/>
   ldr   r1,=448   @315
<br/>
   cmp   r2,r1
<br/>
   ble   1f   
<br/>
   mov   r3,#0
<br/>
1:
<br/>
<br/>
   mov   r5,#PLR_DIR_TO
<br/>
   strh   r3,[r0,r5]
<br/>
   b   updatePlayerDir      @ THIS JUMPS TO THE WRONG ADDRESS
<br/>
   
<br/>
<br/>
   
<br/>
@================================
<br/>
@ turn until player is facing the correct way
<br/>
@================================
<br/>
@ entry:
<br/>
@   r0 = player data address
<br/>
<br/>
   .thumb_func
<br/>
   .global updatePlayerDir
<br/>
updatePlayerDir:
<br/>
   mov   r3,#PLR_DIR_TO
<br/>
   ldrh   r1,[r0,r3]
<br/>
   ldrh   r2,[r0,#PLR_DIR]
<br/>
   sub   r1,r2
<br/>
   beq   9f               @ facing the correct way
<br/>
   bge   1f               @ turn right
<br/>
   
<br/>
   @ turn left
<br/>
   mvn   r1,r1
<br/>
   add   r1,#1
<br/>
   cmp   r1,#4
<br/>
   bge   2f               @ quicker to turn right
<br/>
<br/>
4:
<br/>
   sub   r2,#1
<br/>
   bge   3f
<br/>
   add   r2,#8
<br/>
3:
<br/>
   strh   r2,[r0,#PLR_DIR]
<br/>
   mov   pc,lr
<br/>
   
<br/>
1:
<br/>
   @ turn right
<br/>
   cmp   r1,#4
<br/>
   bge   4b               @ quicker to turn left
<br/>
<br/>
2:
<br/>
   add   r2,#1
<br/>
   cmp   r2,#8
<br/>
   blt   3f
<br/>
   sub   r2,#8
<br/>
3:
<br/>
   strh   r2,[r0,#PLR_DIR]
<br/>
9:
<br/>
   mov   pc,lr
<br/>
<br/>
   .pool
<br/>
   </td> </tr></table><span class="postbody">
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
face_forward:
<br/>
    080BCBA0 (T)  mov     r5,40h                                  ;3  274
<br/>
    080BCBA2 (T)  ldrh    r1,[r0,r5]                              ;7  281
<br/>
    080BCBA4 (T)  cmp     r1,0h                                   ;3  284
<br/>
    080BCBA6 (T)  beq     80BCBB0h                                ;11 295
<br/>
    080BCBA8 (T)  mov     r5,4Ch                                  ;3  298
<br/>
    080BCBAA (T)  mov     r1,4h                                   ;3  301
<br/>
    080BCBAC (T)  strh    r1,[r0,r5]                              ;8  309
<br/>
    080BCBAE (T)  b       80BCBD4h   THIS SHOULD BRANCH TO updatePlayerDir ;11 320
<br/>
    080BCBB0 (T)  mov     r5,4Ch                                  ;3  323
<br/>
    080BCBB2 (T)  mov     r1,0h                                   ;3  326
<br/>
    080BCBB4 (T)  strh    r1,[r0,r5]                              ;8  334
<br/>
    080BCBB6 (T)  b       80BCBCCh   THIS SHOULD BRANCH TO updatePlayerDir ;11 345
<br/>
set_plr_direction:
<br/>
    080BCBB8 (T)  ldrh    r2,[r0,1Ch]                             ;7  352
<br/>
    080BCBBA (T)  mov     r3,0h                                   ;3  355
<br/>
    080BCBBC (T)  mov     r1,40h                                  ;3  358
<br/>
    080BCBBE (T)  cmp     r2,r1                                   ;3  361
<br/>
    080BCBC0 (T)  ble     80BCBDCh                                ;11 372
<br/>
    080BCBC2 (T)  mov     r3,2h                                   ;3  375
<br/>
    080BCBC4 (T)  mov     r1,0C0h                                 ;3  378
<br/>
    080BCBC6 (T)  cmp     r2,r1                                   ;3  381
<br/>
    080BCBC8 (T)  ble     80BCBDCh                                ;11 392
<br/>
    080BCBCA (T)  mov     r3,4h                                   ;3  395
<br/>
    080BCBCC (T)  ldr     r1,=140h                                ;12 407
<br/>
    080BCBCE (T)  cmp     r2,r1                                   ;3  410
<br/>
    080BCBD0 (T)  ble     80BCBDCh                                ;11 421
<br/>
    080BCBD2 (T)  mov     r3,6h                                   ;3  424
<br/>
    080BCBD4 (T)  ldr     r1,=1C0h                                ;12 436
<br/>
    080BCBD6 (T)  cmp     r2,r1                                   ;3  439
<br/>
    080BCBD8 (T)  ble     80BCBDCh                                ;11 450
<br/>
    080BCBDA (T)  mov     r3,0h                                   ;3  453
<br/>
    080BCBDC (T)  mov     r5,4Ch                                  ;3  456
<br/>
    080BCBDE (T)  strh    r3,[r0,r5]                              ;8  464
<br/>
    080BCBE0 (T)  b       80BCBA2h  THIS SHOULD BRANCH TO updatePlayerDir  ;11 475
<br/>
updatePlayerDir:
<br/>
    080BCBE2 (T)  mov     r3,4Ch                                  ;3  478
<br/>
    080BCBE4 (T)  ldrh    r1,[r0,r3]                              ;7  485
<br/>
    080BCBE6 (T)  ldrh    r2,[r0,36h]                             ;7  492
<br/>
    080BCBE8 (T)  sub     r1,r1,r2                                ;3  495
<br/>
    080BCBEA (T)  beq     80BCC0Eh                                ;11 506
<br/>
    080BCBEC (T)  bge     80BCC00h                                ;11 517
<br/>
    080BCBEE (T)  mvn     r1,r1                                   ;3  520
<br/>
    080BCBF0 (T)  add     r1,1h                                   ;3  523
<br/>
    080BCBF2 (T)  cmp     r1,4h                                   ;3  526
<br/>
    080BCBF4 (T)  bge     80BCC04h                                ;11 537
<br/>
    080BCBF6 (T)  sub     r2,1h                                   ;3  540
<br/>
    080BCBF8 (T)  bge     80BCBFCh                                ;11 551
<br/>
    080BCBFA (T)  add     r2,8h                                   ;3  554
<br/>
    080BCBFC (T)  strh    r2,[r0,36h]                             ;8  562
<br/>
    080BCBFE (T)  mov     r15,r14                                 ;3  565
<br/>
    080BCC00 (T)  cmp     r1,4h                                   ;3  568
<br/>
    080BCC02 (T)  bge     80BCBF6h                                ;11 579
<br/>
    080BCC04 (T)  add     r2,1h                                   ;3  582
<br/>
    080BCC06 (T)  cmp     r2,8h                                   ;3  585
<br/>
    080BCC08 (T)  blt     80BCC0Ch                                ;11 596
<br/>
    080BCC0A (T)  sub     r2,8h                                   ;3  599
<br/>
    080BCC0C (T)  strh    r2,[r0,36h]                             ;8  607
<br/>
    080BCC0E (T)  mov     r15,r14                                 ;3  610
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#58622 - poslundc - Mon Oct 24, 2005 10:45 pm</h4>
    <div class="postbody"><span class="postbody">Try inserting .align directives between your functions, and see how it goes then.
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#58675 - wintermute - Tue Oct 25, 2005 8:06 am</h4>
    <div class="postbody"><span class="postbody">The handy thing about using the -x assembler-with-cpp option is that you get to use the C Preprocessor. That means #define and #include amongst other things.
<br/>
<br/>
As for the incorrect branches, that's just weird. It seems to work fine with arm code and with functions that aren't made global in general. Looks like it's a problem with a recent GAS patch I made. Release 16a seems to work fine whereas r17 has the problem you describe. It should be sufficient to replace the bin/arm-elf-as and arm-elf/bin/as binaries with theire counterparts from r16a.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#58732 - t81b - Tue Oct 25, 2005 5:01 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Try inserting .align directives between your functions, and see how it goes then.
<br/>
<br/>
Dan. </td> </tr></table><span class="postbody">
<br/>
<br/>
Tried this but no luck.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">As for the incorrect branches, that's just weird. It seems to work fine with arm code and with functions that aren't made global in general. Looks like it's a problem with a recent GAS patch I made. Release 16a seems to work fine whereas r17 has the problem you describe. It should be sufficient to replace the bin/arm-elf-as and arm-elf/bin/as binaries with theire counterparts from r16a.</td> </tr></table><span class="postbody">
<br/>
<br/>
No luck with this either, the same thing happens.
<br/>
Looking at the addresses the branches are pointing to, I think I can see what is happening.
<br/>
It looks like the distance of the branch is the right length but instead of adding that distance to the address where the branch command is, it is always adding the distance to the address at the start of the file. Maybe this will be of some use in helping to find a fix.
<br/>
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">The handy thing about using the -x assembler-with-cpp option is that you get to use the C Preprocessor. That means #define and #include amongst other things. </td> </tr></table><span class="postbody">
<br/>
<br/>
That does sound useful. Didn't realise I could do that. But does that mean I will still have to change the base_rules so I can find the .include files?
<br/>
<br/>
Brendan</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
