<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Problem with macro for gas - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>ASM > Problem with macro for gas</h2>
<div id="posts">
<div class="post">
    <h4>#177754 - Jim - Thu Feb 07, 2013 8:00 pm</h4>
    <div class="postbody"><span class="postbody">Hi,
<br/>
<br/>
I've worked on a project a while ago, where I dissassembled some ARM-Code and had some problems with bl-commands. Here is a copy of the description on what I worked.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
/*
<br/>
"blown" is my own bl-command, because the most
<br/>
bls go to an adress that isn't already
<br/>
dissassembled, so I had to write a function
<br/>
that makes a command that goes to an address
<br/>
that isn't already included.
<br/>
      blown   0x3710, 0x2CC
<br/>
Here we're at address 0x2CC and want to jump to 0x3710
<br/>
<br/>
y = current adress, where the command is
<br/>
x = address where the jump goes to
<br/>
*/
<br/>
.macro   blown   x=0, y=0
<br/>
.hword   0b1111000000000000 | ((((\x-\y)&gt;&gt;12)&amp;0b11111111111))
<br/>
.hword   0b1111100000000000 | ((((\x-(\y+2))&gt;&gt;1)&amp;0b11111111111)-1)
<br/>
.endm
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I've searched for an automatic way to get the current address (so that I don't have to set "y"), but found nothing that worked. Maybe someone here knows how to do it. Although my code works, it will only work as long as I don't change the code too much.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#177755 - Dwedit - Thu Feb 07, 2013 8:43 pm</h4>
    <div class="postbody"><span class="postbody">I'm having difficulty understanding what you're trying to do here.  Are you trying to hack a NDS program?  That's the only way I'd ever see valid addresses less than 02000000, since that might be a valid address in ITCM on the NDS.
<br/>
<br/>
You can use $ to get the current address, then you can subtract that from another label to get a relative address.  Something like ($ - someLabel).  The address and label must be in the same section in the same source file.
<br/>
<br/>
Absolute addresses aren't generated until link time.  During link-time, only really simple math can be used on addresses, specifically, adding a constant.  So to get around that, make your addresses relative to something instead of absolute.
<br/>
<br/>
But if you have your memory map set up correctly (including the custom linkscript), you should be able to directly use b and bl instructions exactly as they are written.
<br/>
If you are patching code, you probably should be using a different assembler for that.<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
