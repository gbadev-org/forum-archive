<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>sections and reading a .map file - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>ASM > sections and reading a .map file</h2>
<div id="posts">
<div class="post">
    <h4>#12840 - poslundc - Fri Nov 28, 2003 6:21 pm</h4>
    <div class="postbody"><span class="postbody">How do I tell from the .map file where in memory my code is being copied to when the GBA loads up?
<br/>
<br/>
When I use .section .iwram, I can see the the function name being referenced with a ROM address (0x08XXXXXX), but I can't figure out how to tell that it is placed in iwram later on.
<br/>
<br/>
My main reason for asking is that I've tried adding .section .rodata before my Thumb function to make sure it is being run from the ROM, but it mysteriously crashes the app. Does that indicate that it <span style="font-style: italic">wasn't</span> running from ROM by default, for some reason? And moving it there made it stop working...?
<br/>
<br/>
Thanks,
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#12845 - tepples - Fri Nov 28, 2003 7:17 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>poslundc wrote:</b></span></td> </tr> <tr> <td class="quote">How do I tell from the .map file where in memory my code is being copied to when the GBA loads up?</td> </tr></table><span class="postbody">
<br/>
I don't know; I don't use .map files. But you can extract such information from .elf files:
<br/>
<br/>
<span style="font-weight: bold">nm shooter.elf</span>
<br/>
list the run addresses of code and data objects in shooter.elf, ordered by name
<br/>
<br/>
<span style="font-weight: bold">nm -n shooter.elf</span>
<br/>
list the run addresses of code and data objects in shooter.elf, ordered by address
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">My main reason for asking is that I've tried adding .section .rodata before my Thumb function to make sure it is being run from the ROM</td> </tr></table><span class="postbody">
<br/>
You should place your functions in section .text. The DevKit Advance link script will always place .text section in ROM unless you're compiling for multiboot, in which case it will be placed in EWRAM.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#12851 - poslundc - Fri Nov 28, 2003 8:50 pm</h4>
    <div class="postbody"><span class="postbody">Thanks, tepples. Is there a link to somewhere that I can go to learn more about .section locations, etc.? Everything I've found seems to be either erroneous or incomplete.
<br/>
<br/>
Thanks,
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#12852 - poslundc - Fri Nov 28, 2003 9:05 pm</h4>
    <div class="postbody"><span class="postbody">Ack! According to nm, all of my ARM routines are currently being called from addresses in the 0x08000000 range! They must be going ridiculously slow if they're running from ROM instead of IWRAM.
<br/>
<br/>
What could possibly be the reason for this? I've put .section .iwram at the beginning of each of those.
<br/>
<br/>
Thanks,
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#12853 - DekuTree64 - Fri Nov 28, 2003 9:12 pm</h4>
    <div class="postbody"><span class="postbody">Hmm, my .map files seem to show .iwram functions in .iwram, but not the locations in ROM that they're copied from. Are you sure your function is actually geting put in IWRAM? One easy way to check is to put an infinite loop in the function, open it in VBA, it of course locks up, then check the disassembly and see if you're in 0x3000000 or 0x8000000.
<br/>
If you're just using
<br/>
.section .iwram
<br/>
try 
<br/>
.section .iwram, "ax", %progbits
<br/>
instead, and see if that fixes it. GCC seems to be pretty hard to talk into working properly with different sections. I got so fed up with it when making my demo for the compo that I just started declaring big arrays in my functions, copying the code I needed into them, and branching to the array address. Since arrays go onto the stack, and the stack is in IWRAM, it worked fine. 
<br/>
<br/>
And yes, use .text for code, .rodata for read-only data. I don't know if it has any specific rules about not putting functions in .rodata, but one interesting thing I discovered when trying to put my big chunks of data in .s files is that if you use .align 4 while you're in .rodata, it causes weird errors about .rodata overlapping with .iwram or something. .align 2 is fine though, and that always seems to get it word aligned, even though I thought it meant align to 2 bytes. I guess it means align to 2 words, in which case .align 4 is wasting space anyway. Took me forever to figure out that's what was causing the errors.<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#12854 - poslundc - Fri Nov 28, 2003 9:44 pm</h4>
    <div class="postbody"><span class="postbody">Changing it to .section .iwram, "ax", %progbits doesn't seem to make any difference. I tried .section .data as well, all to no avail.
<br/>
<br/>
This all seems very ridiculous to me. Does anyone know where I can get the latest crt0.s and linkscript files? Maybe that has something to do with it...
<br/>
<br/>
Thanks,
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#12856 - poslundc - Fri Nov 28, 2003 11:12 pm</h4>
    <div class="postbody"><span class="postbody">Aha! Apparently it was because I was using a .text directive after the .arm directive. Not sure why that was there... it must've been in the tutorials when I first learned ARM asm.
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#12867 - DekuTree64 - Sat Nov 29, 2003 1:23 am</h4>
    <div class="postbody"><span class="postbody">Ah, that makes sense. So you were doing something like this?
<br/>
.section .iwram
<br/>
.arm
<br/>
.align
<br/>
.text
<br/>
label:
<br/>
@do stuff
<br/>
<br/>
.text is short for .section .text, so that would be going back to putting code in ROM just before starting to actually write stuff.
<br/>
Oh well, at least the mystery is solved.<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#12873 - tepples - Sat Nov 29, 2003 4:59 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>DekuTree64 wrote:</b></span></td> </tr> <tr> <td class="quote">one interesting thing I discovered when trying to put my big chunks of data in .s files is that if you use .align 4 while you're in .rodata, it causes weird errors about .rodata overlapping with .iwram or something. .align 2 is fine though, and that always seems to get it word aligned, even though I thought it meant align to 2 bytes. I guess it means align to 2 words, in which case .align 4 is wasting space anyway.</td> </tr></table><span class="postbody">
<br/>
On some platforms, .align n aligns to n bytes. On other platforms, .align n aligns to 2^n bytes. Gas <a class="postlink" href="http://www.gnu.org/manual/gas-2.9.1/html_node/as_68.html#SEC70" target="_blank">matches the behavior of the platform's vendor-supplied assembler</a>. To force .align to do what you want, use the Gas directive <a class="postlink" href="http://www.gnu.org/manual/gas-2.9.1/html_node/as_72.html#SEC74" target="_blank">.balign which always aligns to n bytes</a>.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
