<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>R4 woes. - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>ASM > R4 woes.</h2>
<div id="posts">
<div class="post">
    <h4>#169027 - Tyler24 - Tue Jun 09, 2009 9:29 pm</h4>
    <div class="postbody"><span class="postbody">I'm trying to convert the R4's DLDI code to assembly, and I've hit quite the roadblock. I can't find any documentation on the card, or its controller, so I've pretty much just copied Chisim's DLDI code for the R4. I can communicate with the R4, and I'm pretty sure that I can write commands to it correctly because my emulator (Mac DeSmuME) will output that it doesn't see the R4 card, but my actual hardware running the same binary reports that it does see the R4. Yet, for some reason, when I try to perform a logical read, all I get is a bunch of zero-ed out data.
<br/>
<br/>
In summary, when I try to read the first 64b of my MicroSD card, all I get is:
<br/>
<br/>
0000:0000 0x00000000
<br/>
0000:0004 0x00000000
<br/>
0000:0008 0x00000000
<br/>
0000:000C 0x00000000
<br/>
0000:0010 0x00000000
<br/>
...
<br/>
0000:0040 0x00000000
<br/>
<br/>
and yet startup(), isInserted(), etc. all return TRUE on my actual hardware with the R4, and return FALSE on my emulator.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
@ ------------------------------------------------------------------------------
<br/>
@  Sends a command to the DS card.
<br/>
@
<br/>
@  r0 - Command
<br/>
@  r1 - Address
<br/>
@  r2 - Flags
<br/>
@ ------------------------------------------------------------------------------
<br/>
_card_write_command:
<br/>
   stmfd   sp!, {lr}
<br/>
<br/>
   ldr   r3, =0x040001A1
<br/>
   mov   r4, #(0x80 | 0x40)
<br/>
   strb   r4, [r3, #0x00]
<br/>
<br/>
   strb   r0, [r3, #0x07]
<br/>
<br/>
   mov   r4, r1, lsr #24
<br/>
   and   r4, r4, #0xFF
<br/>
   strb   r4, [r3, #0x08]
<br/>
<br/>
   mov   r4, r1, lsr #16
<br/>
   and   r4, r4, #0xFF
<br/>
   strb   r4, [r3, #0x09]
<br/>
<br/>
   mov   r4, r1, lsr #8
<br/>
   and   r4, r4, #0xFF
<br/>
   strb   r4, [r3, #0x0A]
<br/>
<br/>
   mov   r4, r1
<br/>
   and   r4, r4, #0xFF
<br/>
   strb   r4, [r3, #0x0B]
<br/>
<br/>
   mov   r4, #0x00
<br/>
   strb   r4, [r3, #0x0C]
<br/>
   strb   r4, [r3, #0x0D]
<br/>
   strb   r4, [r3, #0x0E]
<br/>
<br/>
   ldmfd   sp!, {lr}
<br/>
   mov   pc, lr
<br/>
<br/>
<br/>
<br/>
@ ------------------------------------------------------------------------------
<br/>
@  Sends a command to the DS card, waits for it to be ready.
<br/>
@
<br/>
@  r0 - Command
<br/>
@  r1 - Address
<br/>
@  r2 - Flags
<br/>
@ ------------------------------------------------------------------------------
<br/>
_card_wait_ready:
<br/>
   stmfd   sp!, {lr}
<br/>
   mov   r7, #0
<br/>
<br/>
_card_wait_ready_loop1:
<br/>
   bl   _card_write_command
<br/>
   ldr   r3, =0x040001A4
<br/>
   str   r2, [r3, #0x00]
<br/>
<br/>
_card_wait_ready_loop2:
<br/>
   ldr   r4, [r3, #0x00]
<br/>
   ands   r4, r4, #(1 &lt;&lt; 23)
<br/>
   beq   _card_wait_ready_chk2
<br/>
<br/>
   ldr   r4, =0x04100010
<br/>
   ldr   r4, [r4, #0x00]
<br/>
   cmp   r4, #0
<br/>
<br/>
   moveq   r7, #1
<br/>
<br/>
_card_wait_ready_chk2:
<br/>
   ldr   r4, [r3, #0x00]
<br/>
   ands   r4, r4, #(1 &lt;&lt; 31)
<br/>
   bne   _card_wait_ready_loop2
<br/>
<br/>
_card_wait_ready_chk1:
<br/>
   cmp   r7, #0
<br/>
   beq   _card_wait_ready_loop1
<br/>
<br/>
   ldmfd   sp!, {lr}
<br/>
   mov   pc, lr
<br/>
<br/>
<br/>
<br/>
@ ------------------------------------------------------------------------------
<br/>
@  Does a polled transfer with the card.
<br/>
@
<br/>
@  r0 - Command
<br/>
@  r1 - Address
<br/>
@  r2 - Flags
<br/>
@  r5 - Destination
<br/>
@  r6 - Length
<br/>
@ ------------------------------------------------------------------------------
<br/>
_card_polled_xfer:
<br/>
   stmfd   sp!, {lr}
<br/>
<br/>
   bl   _card_write_command
<br/>
   ldr   r3, =0x040001A4
<br/>
   str   r2, [r3, #0x00]
<br/>
<br/>
   add   r7, r5, r6
<br/>
<br/>
_card_polled_xfer_loop:
<br/>
   ldr   r4, [r3, #0x00]
<br/>
   ands   r4, r4, #(1 &lt;&lt; 23)
<br/>
   beq   _card_polled_xfer_check
<br/>
<br/>
   ldr   r4, =0x04100010
<br/>
   ldr   r4, [r4, #0x00]
<br/>
<br/>
_card_polled_xfer_copy_check:
<br/>
   subs   r8, r7, r5
<br/>
   beq   _card_polled_xfer_check
<br/>
<br/>
   str   r4, [r5, #0x00]
<br/>
   add   r5, r5, #4
<br/>
<br/>
@ ------------------------------------------------------------------------------
<br/>
@  DEBUG CODE THAT PRINTS THE HEX OUTPUT OF R4 GOES HERE
<br/>
@ ------------------------------------------------------------------------------
<br/>
<br/>
_card_polled_xfer_check:
<br/>
   ldr   r4, [r3, #0x00]
<br/>
   ands   r4, r4, #(1 &lt;&lt; 31)
<br/>
   bne   _card_polled_xfer_loop
<br/>
<br/>
   ldmfd   sp!, {lr}
<br/>
   mov   pc, lr
<br/>
<br/>
@ ------------------------------------------------------------------------------
<br/>
@  Performs a logical read on the card.
<br/>
@
<br/>
@  r1 - Address
<br/>
@  r5 - Destination
<br/>
@  r6 - Length
<br/>
@ ------------------------------------------------------------------------------
<br/>
_card_read_data:
<br/>
   stmfd   sp!, {lr}
<br/>
   bl   _read_card_info @ not really necessary
<br/>
<br/>
   mov   r0, #0xB9
<br/>
   ldr   r2, =0xa7586000
<br/>
   bl   _card_wait_ready
<br/>
<br/>
   mov   r0, #0xBA
<br/>
   ldr   r2, =0xa1586000
<br/>
   bl   _card_polled_xfer
<br/>
<br/>
   ldmfd   sp!, {lr}
<br/>
   mov   pc, lr
<br/>
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Do I need to set the DRQ bit, and enable DMA access or something??
<br/>
I'm rather confused... I thought I could just read data piece by piece...</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
