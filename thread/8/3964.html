<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>question about function calling - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>ASM > question about function calling</h2>
<div id="posts">
<div class="post">
    <h4>#25551 - Darmstadium - Tue Aug 24, 2004 11:39 pm</h4>
    <div class="postbody"><span class="postbody">I'm trying to write a function is ASM and then call it using C code. I can call the function with no problems, but once i have i seem to have some problems. I know that in my ASM function I should back-up the values in registers 4-7 before using them. i try to push them on the stack like this:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
mov r12,sp
<br/>
<br/>
stmfd sp!,{r4}
<br/>
stmfd sp!,{r5}
<br/>
stmfd sp!,{r6}
<br/>
stmfd sp!,{r7}
<br/>
</td> </tr></table><span class="postbody">
<br/>
the top line stores the address of the first of my arguments that were pushed on the stack when the function was called. now i try to access them like so:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
ldmfd r12!,{r4}
<br/>
ldmfd r12!,{r5}
<br/>
ldmfd r12!,{r6}
<br/>
ldmfd r12!,{r7}
<br/>
</td> </tr></table><span class="postbody">
<br/>
Does the above code put the first argument in r4 and the second one in r5 and so on?
<br/>
now i do all the fun stuff that my function does and am ready to return to the C code. First I have to restore the values of r4-r7 to what they were when my asm function was called. i try to do that like this:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
ldmfd sp!,{r7}
<br/>
ldmfd sp!,{r6}
<br/>
ldmfd sp!,{r5}
<br/>
ldmfd sp!,{r4}
<br/>
</td> </tr></table><span class="postbody">
<br/>
Have i done this correctly? i seem to have a problem when running my c code after my asm function is done executing.
<br/>
Thanks for your help!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#25552 - poslundc - Tue Aug 24, 2004 11:48 pm</h4>
    <div class="postbody"><span class="postbody">Nothing jumps out as being incorrect about what you're doing. But make sure you realize that the first four parameters passed to your function are <span style="font-style: italic">not</span> on the stack, but are passed into registers r0-r3.
<br/>
<br/>
You're also wasting cycles by not performing your stores/loads in a single instruction. Instead of going one at a time, do the following:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">stmfd sp!, {r4-r7}
<br/>
@ etc.
<br/>
ldmfd r12!, {r4-r7}
<br/>
@ etc.
<br/>
ldmfd sp!, {r4-r7}</td> </tr></table><span class="postbody">
<br/>
<br/>
Also realize that in addition to r4-r7 you are expected to preserve r8, r9, r10, r11 and r14 across your function call.
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#25554 - Darmstadium - Wed Aug 25, 2004 12:06 am</h4>
    <div class="postbody"><span class="postbody">thanks for your speedy response! its good to know that you can load and store a lotta registers at once. i'm sure i'm doing it right, but could you check out my new code for me?:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
mov r12,sp 
<br/>
<br/>
stmfd sp!,{r4-r11}
<br/>
stmfd sp!,{r14}
<br/>
<br/>
ldmfd r12!,{r4-r7}
<br/>
<br/>
ldmfd sp!,{r14}
<br/>
ldmfd sp!,{r11-r4}
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#25555 - poslundc - Wed Aug 25, 2004 12:12 am</h4>
    <div class="postbody"><span class="postbody">Your code is correct, but again, there is a more concise and more efficient notation. ;)
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">stmfd sp!, {r4-r11, r14}
<br/>
ldmfd sp!, {r4-r11, r14}</td> </tr></table><span class="postbody">
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
