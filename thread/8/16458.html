<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Random numbers in Arm Asm - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>ASM > Random numbers in Arm Asm</h2>
<div id="posts">
<div class="post">
    <h4>#166815 - Flash - Thu Feb 19, 2009 2:02 pm</h4>
    <div class="postbody"><span class="postbody">Having a slight problem trying to reduce a 32 bit number returned from a generator to a value between 0-383.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
ldr     ip, seedpointer
<br/>
ldmia   ip, {r8, r9}
<br/>
tst     r9, r9, lsr #1
<br/>
movs    r2, r8, rrx
<br/>
adc     r9, r9, r9
<br/>
eor     r2, r2, r8, lsl #12
<br/>
eor     r8, r2, r2, lsr #20
<br/>
stmia   ip, {r8, r9}
<br/>
..... with these variables :-
<br/>
seedpointer: 
<br/>
        .long    seed  
<br/>
seed: 
<br/>
        .long    0x55555555 
<br/>
        .long    0x55555555
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
is used to generate the number with r8 returning the value. No matter what i do, i cannot get the result within my bounds without creating weighting to either of the ends due to my rounding?
<br/>
<br/>
I am sure it is something silly that I am missing, but for the life of me, I cannot get it right :(
<br/>
<br/>
Any help would be great</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#166826 - Miked0801 - Thu Feb 19, 2009 6:40 pm</h4>
    <div class="postbody"><span class="postbody">Lets see
<br/>
Load r12 with your seed pointer
<br/>
then grab 64-bits of seed into r8,r9
<br/>
Then put the low bit of r9 on carry
<br/>
Then move into r2, r8 with something called rrx?
<br/>
Mix and munge r2,r9,r8
<br/>
and put a new seed back out.
<br/>
<br/>
I see nothing - nothing at all that is limiting the range of generator.  You are going to get some sort of number in r8 for sure, but it will be 32-bit.
<br/>
<br/>
You could range it without a mod/divide with:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
and r0,r8,#0x1FF   ; Get a number 0 - 511
<br/>
add r0,r8,r8,lsl #1    ; x3
<br/>
mov r8,r8, lsl #4   ; / 4
<br/>
</td> </tr></table><span class="postbody">
<br/>
And you get a number from 0 to 383</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#166830 - naleksiev - Thu Feb 19, 2009 7:15 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Miked0801 wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
and r0,r8,#0x1FF   ; Get a number 0 - 511
<br/>
add r0,r8,r8,lsl #1    ; x3
<br/>
mov r8,r8, lsl #4   ; / 4
<br/>
</td> </tr></table><span class="postbody">
<br/>
And you get a number from 0 to 383</span></td> </tr></table><span class="postbody">
<br/>
<br/>
I just start learning ASM for ARM so excuse me if I'm wrong but I think there are a few errors in above code.
<br/>
<br/>
Shouldn't it be
<br/>
and r0,r8,#0x1FF   ; Get a number 0 - 511
<br/>
add <span style="font-weight: bold">r8,r0</span>,r8,lsl #1    ; x3
<br/>
mov r8,r8, <span style="font-weight: bold">rsl</span> #4   ; / 4<br/>_________________<br/><a class="postlink" href="http://raynds.blogspot.com/" target="_blank">http://raynds.blogspot.com/</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#166832 - Maxxie - Thu Feb 19, 2009 8:16 pm</h4>
    <div class="postbody"><span class="postbody">indeed, 
<br/>
on top of that:
<br/>
- exchange the #4 against a #2 if /4 is meant.
<br/>
at the second add, use r0 at both inputs. r8 is still the full range at that point (&gt;511)<br/>_________________<br/><a class="postlink" href="http://nintendods.desperate-programmers.com/doku.php?id=wireless_io_map" target="_blank">Trying  to bring more detail into understanding the wireless hardware</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#166833 - Cearn - Thu Feb 19, 2009 8:53 pm</h4>
    <div class="postbody"><span class="postbody">If your random number generator spans the whole 32 bits (or even just the top N bits), you use something like this:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">@ Assume r2 is an RNG in range[0, 1&lt;&lt;32). Wanted is range [0, 384)
<br/>
ldr     r1,=384           @ Load desired range.
<br/>
mull    r3, r0, r1, r2    @ r0 = 384*[0, 1&lt;&lt;32)/(1&lt;&lt;32) for [0, 384) result.
<br/>
</td> </tr></table><span class="postbody">
<br/>
Basically, an N-bit RNG has range [0, 1&lt;&lt;N). Multiplying by your range M gives the range [0, M&lt;&lt;N). shifting right by N reduces it to [0, M).</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#166836 - Flash - Thu Feb 19, 2009 9:40 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Maxxie wrote:</b></span></td> </tr> <tr> <td class="quote">indeed, 
<br/>
on top of that:
<br/>
- exchange the #4 against a #2 if /4 is meant.
<br/>
at the second add, use r0 at both inputs. r8 is still the full range at that point (&gt;511)</td> </tr></table><span class="postbody">
<br/>
this works, thanks
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
ldr r2,=0x1ff
<br/>
and r9,r8,r2
<br/>
add r8,r9,r9,lsl #1
<br/>
mov r8,r8,lsr #2
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I had to change the registers as was using r0 in the loop.
<br/>
<br/>
I tried the tidy looking mul version, but cannot compile with a mul stretching 4 registers</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#166843 - Cearn - Fri Feb 20, 2009 10:27 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Flash wrote:</b></span></td> </tr> <tr> <td class="quote">I tried the tidy looking mul version, but cannot compile with a mul stretching 4 registers</td> </tr></table><span class="postbody">
<br/>
I thought the unsigned long multiply was called MULL, but apparently it's UMULL. Try that instead. See also <a class="postlink" href="http://nocash.emubase.de/gbatek.htm#arm7multiplyandmultiplyaccumulatemulmla" target="_blank">gbatek:MUL</a> for details.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#166853 - Miked0801 - Fri Feb 20, 2009 7:45 pm</h4>
    <div class="postbody"><span class="postbody">Wow, I screwed up every single line.  Go me.
<br/>
<br/>
Bah, and to 0-511, Multiply by 3, divide by 4.  There.  Silly programmer, asm tricks are for kids (with assemblers to check ones work...)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#166854 - Flash - Fri Feb 20, 2009 8:49 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Miked0801 wrote:</b></span></td> </tr> <tr> <td class="quote">Wow, I screwed up every single line.  Go me.
<br/>
<br/>
Bah, and to 0-511, Multiply by 3, divide by 4.  There.  Silly programmer, asm tricks are for kids (with assemblers to check ones work...)</td> </tr></table><span class="postbody">
<br/>
<br/>
Thanks for showing me the way! :)
<br/>
<br/>
The main thing was it got the job done, thanks!!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167403 - Flash - Tue Mar 10, 2009 11:01 pm</h4>
    <div class="postbody"><span class="postbody">Ok, got another little problem,
<br/>
<br/>
Using the code at the top of this post to return a random 32 bit number, does anyone know the quickest way to reduce it to a number from 0-223?
<br/>
<br/>
I have sat here for ages and can get the range but it is messy! I am sure that there is a really easy way to do it, but again... for the life of me :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167404 - Miked0801 - Tue Mar 10, 2009 11:05 pm</h4>
    <div class="postbody"><span class="postbody">32-bits to 8-bits =
<br/>
&gt;&gt; 24
<br/>
<br/>
8-bits = 0-255 (or 256 entries)
<br/>
<br/>
224 / 256 = 7/8
<br/>
<br/>
* 7,
<br/>
&gt;&gt; 3</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167410 - Ruben - Wed Mar 11, 2009 2:11 am</h4>
    <div class="postbody"><span class="postbody">Neat algorithm..
<br/>
Simple, fast, hard to figure out without seeing it and too easy when you do. I love it.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
