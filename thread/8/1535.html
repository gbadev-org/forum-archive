<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>What is fp? How to use "structs"? - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>ASM > What is fp? How to use "structs"?</h2>
<div id="posts">
<div class="post">
    <h4>#7809 - Lupin - Wed Jun 25, 2003 1:31 pm</h4>
    <div class="postbody"><span class="postbody">I watched my compiled gcc source and I found this bit of instructions (right at the beginning of the func):
<br/>
<br/>
mov	ip, sp
<br/>
stmfd	sp!, {r4, r5, r6, r7, fp, ip, lr, pc}
<br/>
sub	fp, ip, #4
<br/>
mov	r0, #256
<br/>
strh	r0, [fp, #-34]	@ movhi
<br/>
<br/>
now, I'm wondering an little bit, because of 2 things:
<br/>
1) What value does fp store? ip/sp aren't initialized, i copied the code right after the function label...
<br/>
2) I thought the second number/register in these brackets is something like an byte-index or so, but why does the code use an negative index?
<br/>
<br/>
this code should put 256 into an member of an data structure. Even though I defined the structre in my C-code, it seens that it doesn't need to get declared within the asm instructions...
<br/>
How could I handle something like structs in ASM?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#7831 - tepples - Thu Jun 26, 2003 6:27 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Lupin wrote:</b></span></td> </tr> <tr> <td class="quote">I watched my compiled gcc source and I found this bit of instructions (right at the beginning of the func):
<br/>
<br/>
mov	ip, sp
<br/>
stmfd	sp!, {r4, r5, r6, r7, fp, ip, lr, pc}
<br/>
sub	fp, ip, #4
<br/>
mov	r0, #256
<br/>
strh	r0, [fp, #-34]	@ movhi
<br/>
<br/>
now, I'm wondering an little bit, because of 2 things:
<br/>
1) What value does fp store? ip/sp aren't initialized, i copied the code right after the function label...
<br/>
</td> </tr></table><span class="postbody">
<br/>
'sp' is the stack pointer. GCC seems to be using 'fp' as some sort of stack frame pointer (analogous to 'bp' of i386?).
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">2) I thought the second number/register in these brackets is something like an byte-index or so, but why does the code use an negative index?</td> </tr></table><span class="postbody">
<br/>
The 'fp' seems to point to the <span style="font-style: italic">end</span> of the stack frame, which means that offsets to structures would be negative.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Even though I defined the structre in my C-code, it seens that it doesn't need to get declared within the asm instructions...</td> </tr></table><span class="postbody">
<br/>
A struct is compiled to a set of offsets; its structure doesn't necessarily show up in any object file.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">How could I handle something like structs in ASM?</td> </tr></table><span class="postbody">
<br/>
Define the name of each field as an offset from the beginning of the struct. Some assemblers have macros to do this automatically.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#7839 - Lupin - Thu Jun 26, 2003 1:05 pm</h4>
    <div class="postbody"><span class="postbody">tepples, could you perhaps give me an little example of an very basic struct wich shows how to use them, I don't understand how to handle this, because I never worked with stack stuff before (or maybe an nice tutorial about this?)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#7873 - tepples - Fri Jun 27, 2003 7:43 am</h4>
    <div class="postbody"><span class="postbody">I'm not that experienced with doing complicated stuff in assembly language. I just write my programs in C (the optimizer in DKA R5b3 is decent) and save the assembly for BIOS calls or 32x32=64 bit multiplies.
<br/>
<br/>
To get ideas, try writing struct code in C and see what it turns into in assembly (gcc -S instead of gcc -c will output the assembly file that gcc sends to as).<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#7898 - Lupin - Fri Jun 27, 2003 7:53 pm</h4>
    <div class="postbody"><span class="postbody">yeah, I got the code I posted above from gcc asm output, but I still don't understand it, because it uses the stack (I at least think so :))...
<br/>
<br/>
You multiply 32x32=64? Do you really need that high precission on an gba, since the gba doesn't support 64bit by hardware that might be slow I thought.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#7901 - tepples - Fri Jun 27, 2003 8:23 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Lupin wrote:</b></span></td> </tr> <tr> <td class="quote">yeah, I got the code I posted above from gcc asm output, but I still don't understand it, because it uses the stack (I at least think so :))...</td> </tr></table><span class="postbody">
<br/>
Try writing struct code that uses a global variable. Try writing struct code that uses a data structure passed by reference. Then look at the asm that GCC generates. Don't skip straight to code that uses a struct on the stack.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">You multiply 32x32=64? Do you really need that high precission on an gba, since the gba doesn't support 64bit by hardware that might be slow I thought.</td> </tr></table><span class="postbody">
<br/>
Sometimes I need 32x32=middle 32 bits or 32x32=upper 32 bits. The normal mul instruction gives the lower 32 bits.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#7909 - Lupin - Sat Jun 28, 2003 10:25 am</h4>
    <div class="postbody"><span class="postbody">i see, the stack is the place where function variables/structures go, right?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#7925 - funkeejeffou - Sat Jun 28, 2003 7:20 pm</h4>
    <div class="postbody"><span class="postbody">Stack is just an adress pointing at the end of IWram memory. You use it to store temporarly variables by using the "push" or "pop" instruction.
<br/>
Push to write to IWram the value contained in a register
<br/>
Pop to restore a register with the value in the stack.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
