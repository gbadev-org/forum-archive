<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Help with some inline ASM - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>ASM > Help with some inline ASM</h2>
<div id="posts">
<div class="post">
    <h4>#1275 - animension - Thu Jan 16, 2003 4:00 am</h4>
    <div class="postbody"><span class="postbody">I'm trying to access the BIOS divide utility (SWI 6) and I'm having trouble inlining the ASM calls. Here's the source code:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
void BIOSDIV(
<br/>
   signed long numerator, 
<br/>
   signed long denominator,
<br/>
   signed long *div,
<br/>
   signed long *mod,
<br/>
   signed long *abs
<br/>
){
<br/>
<br/>
   asm volatile(
<br/>
      "
<br/>
   @ SUBSTITUTION LIST
<br/>
   @ 0: %0
<br/>
   @ 1: %1
<br/>
   @ 2: %2
<br/>
   @ 3: %3
<br/>
   @ 4: %4
<br/>
<br/>
   ldr      r0,=%3   @ Load the value of %3(numerator) into r0
<br/>
   ldr      r1,=%4   @ Load the value of %4(denominator) into r1
<br/>
   swi      6      @ Call BIOS SWI 6 (DIV)
<br/>
   str      r0,[%0]   @ Store value of r0 (numerator DIV denominator) into &amp;div
<br/>
   str      r1,[%1]   @ Store value of r1 (numerator MOD denominator) into &amp;mod
<br/>
   str      r2,[%2]   @ Store value of r2 (abs of numerator DIV denominator) into &amp;abs
<br/>
      "
<br/>
      : "=r"(div), "=r"(mod),"=r"(abs)   // OUTPUT LIST
<br/>
      : "r"(numerator), "r"(denominator)   // INPUT LIST
<br/>
      : "r0","r1","r2","r3","r4","r5"      // CLOBBER LIST
<br/>
   );
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
What I get from the compiler is:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
test.o: In function `BIOSDIV(long, long, long*, long*, long*)':
<br/>
test.o(.text+0x88): undefined reference to `lr'
<br/>
test.o(.text+0x8c): undefined reference to `ip'
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
A look at the asm file that is generated by the compiler shows:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
_Z7BIOSDIVllPlS_S_:
<br/>
   @ Function supports interworking.
<br/>
   @ args = 4, pretend = 0, frame = 0
<br/>
   @ frame_needed = 0, current_function_anonymous_args = 0
<br/>
   stmfd   sp!, {r4, r5, r6, lr}
<br/>
   mov   lr, r0
<br/>
   mov   ip, r1
<br/>
   
<br/>
   @ SUBSTITUTION LIST
<br/>
   @ 0: lr
<br/>
   @ 1: r6
<br/>
   @ 2: ip
<br/>
   @ 3: lr
<br/>
   @ 4: ip
<br/>
<br/>
   ldr      r0,=lr   @ Load the value of lr(numerator) into r0
<br/>
   ldr      r1,=ip   @ Load the value of ip(denominator) into r1
<br/>
   swi      6      @ Call BIOS SWI 6 (DIV)
<br/>
   str      r0,[lr]   @ Store value of r0 (numerator DIV denominator) into &amp;div
<br/>
   str      r1,[r6]   @ Store value of r1 (numerator MOD denominator) into &amp;mod
<br/>
   str      r2,[ip]   @ Store value of r2 (abs of numerator DIV denominator) into &amp;abs
<br/>
      
<br/>
   ldmfd   sp!, {r4, r5, r6, lr}
<br/>
   bx   lr
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Why is this in C++ inline ASM:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
   @ SUBSTITUTION LIST
<br/>
   @ 0: %0
<br/>
   @ 1: %1
<br/>
   @ 2: %2
<br/>
   @ 3: %3
<br/>
   @ 4: %4
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Turning into this in generated ASM:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
   @ SUBSTITUTION LIST
<br/>
   @ 0: lr
<br/>
   @ 1: r6
<br/>
   @ 2: ip
<br/>
   @ 3: lr
<br/>
   @ 4: ip
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Does anyone have any idea why the substitions aren't working? I'm totally new at inlining ASM so any help would be appreciated.
<br/>
<br/>
Thanks!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#1305 - DekuTree64 - Thu Jan 16, 2003 5:22 pm</h4>
    <div class="postbody"><span class="postbody">Well, appearently it's using all sorts of registers for the inputs, but I always thought it used the stack instead. 
<br/>
Well I use this, and I know it works, so try it instead:
<br/>
<br/>
void divfull(s32 numerator, s32 denomenator, 
<br/>
	s32 *quotient, s32 *remainder, s32 *abs)
<br/>
{
<br/>
	asm volatile
<br/>
	("
<br/>
		mov	r0, %3
<br/>
		mov	r1, %4
<br/>
		swi	0x60000
<br/>
		ldr	r2, %0
<br/>
		str	r0, [r2]
<br/>
		ldr	r2, %1
<br/>
		str	r1, [r2]
<br/>
		ldr	r2, %2
<br/>
		str	r3, [r2]
<br/>
		"
<br/>
		: "=m" (quotient), "=m" (remainder), "=m" (abs)
<br/>
		: "r" (numerator), "r" (denomenator)
<br/>
		: "r0", "r1", "r2", "r3"
<br/>
	);
<br/>
}</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#1306 - DekuTree64 - Thu Jan 16, 2003 5:26 pm</h4>
    <div class="postbody"><span class="postbody">Ah, there was the problem, you were putting "=r"(output) instead of "=m"(output), so it was just picking registers to put those in. No idea why it would pick so many important ones, especially ip, but oh well^_^</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#1326 - animension - Thu Jan 16, 2003 7:48 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>DekuTree64 wrote:</b></span></td> </tr> <tr> <td class="quote">Ah, there was the problem, you were putting "=r"(output) instead of "=m"(output), so it was just picking registers to put those in. No idea why it would pick so many important ones, especially ip, but oh well^_^</td> </tr></table><span class="postbody">
<br/>
<br/>
I don't seem to grasp the difference... the documentation says that "r" simply means a generic register but that "m" means a memory address.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
r    
<br/>
A register operand is allowed provided that it is in a general register.
<br/>
<br/>
m
<br/>
A memory operand is allowed, with any kind of address that the machine supports in general. 
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Isn't a general register able to handle a memory address? I'm not sure I understand the black magic that's going on behind the scenes...<br/>_________________<br/>"Beer is proof that God loves us and wants us to be happy."
<br/>
-- Benjamin Franklin</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#1343 - animension - Thu Jan 16, 2003 9:23 pm</h4>
    <div class="postbody"><span class="postbody">Also another question: is the BIOS divide utility more efficient than using the "/" and "%" operators in C?<br/>_________________<br/>"Beer is proof that God loves us and wants us to be happy."
<br/>
-- Benjamin Franklin</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#1344 - Splam - Thu Jan 16, 2003 9:28 pm</h4>
    <div class="postbody"><span class="postbody">The answer to that is a resounding and very big YES ;)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#1346 - animension - Thu Jan 16, 2003 10:17 pm</h4>
    <div class="postbody"><span class="postbody">Another question: is it possible with C++ to make an operator use a different function, somewhat like operator overloading, but with primitive types? Essentially, is it possible to replace the "/" and "%" operators to call a function that retreives their respective values after a BIOS divide instead? Like, make the "/" operator point to and call a function that does a BIOS divide and return the quotient and "%" do a BIOS divide and return the modulus?<br/>_________________<br/>"Beer is proof that God loves us and wants us to be happy."
<br/>
-- Benjamin Franklin</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#1355 - tepples - Thu Jan 16, 2003 11:56 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>animension wrote:</b></span></td> </tr> <tr> <td class="quote">Another question: is it possible with C++ to make an operator use a different function, somewhat like operator overloading, but with primitive types?</td> </tr></table><span class="postbody">
<br/>
C++ does not support replacing the primitive types' operator actions.  You'll need to make a class.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#1358 - animension - Fri Jan 17, 2003 12:06 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>DekuTree64 wrote:</b></span></td> </tr> <tr> <td class="quote">Well, appearently it's using all sorts of registers for the inputs, but I always thought it used the stack instead. 
<br/>
Well I use this, and I know it works, so try it instead:
<br/>
<br/>
void divfull(s32 numerator, s32 denomenator, 
<br/>
	s32 *quotient, s32 *remainder, s32 *abs)
<br/>
{
<br/>
	asm volatile
<br/>
	("
<br/>
		mov	r0, %3
<br/>
		mov	r1, %4
<br/>
		swi	0x60000
<br/>
		ldr	r2, %0
<br/>
		str	r0, [r2]
<br/>
		ldr	r2, %1
<br/>
		str	r1, [r2]
<br/>
		ldr	r2, %2
<br/>
		str	r3, [r2]
<br/>
		"
<br/>
		: "=m" (quotient), "=m" (remainder), "=m" (abs)
<br/>
		: "r" (numerator), "r" (denomenator)
<br/>
		: "r0", "r1", "r2", "r3"
<br/>
	);
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
I cut and pasted this and I get the following compiler errors:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
<br/>
---------- Compile ROM ----------
<br/>
test.cpp: In function `void divfull(int, int, s32*, s32*, s32*)':
<br/>
test.cpp:34: output number 1 not directly addressable
<br/>
test.cpp:34: output number 2 not directly addressable
<br/>
test.cpp:50: confused by earlier errors, bailing out
<br/>
make: *** [test.o] Error 1
<br/>
Output completed (0 sec consumed) - Normal Termination
<br/>
</td> </tr></table><span class="postbody"><br/>_________________<br/>"Beer is proof that God loves us and wants us to be happy."
<br/>
-- Benjamin Franklin</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#1367 - DekuTree64 - Fri Jan 17, 2003 5:30 am</h4>
    <div class="postbody"><span class="postbody">Hmm, well I copy/pasted it straight from my game, so I don't know why it wouldn't work. Well, try using your code, but just replacing the "=r" with "=m" and see if that fixes it. 
<br/>
And about your question on the difference between r and m, at least as far as I know, you need to use m when you'll be storing something back to memory, and r when you just want to put it in a register and leave it there. I'm not too clear on inline ASM myself though, I pretty much copy/pasted and guessed my way into getting it working. One of these days I'll get around to making a pure ASM div function instead though, so you might want to just do that to begin with too.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#1399 - tepples - Sat Jan 18, 2003 5:23 am</h4>
    <div class="postbody"><span class="postbody">This worked for me, but it's not the most efficient:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
/* bios_divmod() ***********************
<br/>
   Convert n/d to a mixed fraction q+r/d
<br/>
   Returns Q.
<br/>
*/
<br/>
int bios_divmod (int num, int den, int *rem)
<br/>
{
<br/>
  int quo;
<br/>
<br/>
  asm volatile (
<br/>
    " mov   r0,%2  \n"
<br/>
    " mov   r1,%3  \n"
<br/>
    " swi   6      \n"  /* in ARM, s/6/0x60000/ */
<br/>
    " mov   %0,r0  \n"
<br/>
    " ldr   r2,%1  \n"
<br/>
    " str   r1,[r2]\n"
<br/>
    : "=r" (quo), "=m" (rem) // Outputs
<br/>
    : "r" (num), "r" (den)   // Inputs
<br/>
    : "r0","r1","r2","r3"    // clobber
<br/>
  );
<br/>
  return quo;
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Normally, I use this external asm subroutine, which even handles divide-by-zero in a rational manner (important for some projection code):
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
@ int dv(int num, int den)
<br/>
@ Divide two signed integers.
<br/>
<br/>
.THUMB
<br/>
.THUMB_FUNC
<br/>
.ALIGN
<br/>
.GLOBL  dv
<br/>
<br/>
dv:
<br/>
  cmp r1, #0
<br/>
  beq 0f
<br/>
  swi 6
<br/>
  bx lr
<br/>
0:
<br/>
  ldr r0, =0x7fffffff
<br/>
  bx lr
<br/>
</td> </tr></table><span class="postbody">[/code]<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
