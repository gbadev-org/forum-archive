<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>crt0 ignoring main() - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>ASM > crt0 ignoring main()</h2>
<div id="posts">
<div class="post">
    <h4>#2613 - Vivi - Sun Feb 09, 2003 2:15 am</h4>
    <div class="postbody"><span class="postbody">I'm sorry if this sounds like an idiotic question, but I'm far more used to programming in C than ASM.
<br/>
<br/>
crt0.s is included in my project. Every time I attempt to compile the game, though, it says 'IntrRet': Undefined reference to main. I don't know why it isn't linking to Main, because under any other code it works fine. Main is called main(), not AgbMain(), so I know it's not that...
<br/>
<br/>
What problem does that indicate?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#2614 - MayFly - Sun Feb 09, 2003 5:30 am</h4>
    <div class="postbody"><span class="postbody">Hi Vivi,
<br/>
<br/>
If you are using Jeff's Crt0.s (version 1.28 at least) did you uncomment out the ".equ _CPPSupport, 1" statement?
<br/>
<br/>
@ Uncomment the following line to support C++ development.
<br/>
@ You also need to name your main C function the following:
<br/>
@    int main (void)  ...instead of... int AgbMain (void)
<br/>
@ Doing so will cause ~5500 bytes of c++ support code to be
<br/>
@ linked in with your project so do not enable c++ support
<br/>
@ unless you plan to use it.
<br/>
<br/>
@ .equ __CPPSupport, 1
<br/>
<br/>
As I understand it, if you're compiling any C++ code you have to modify the Crt0.s file as such. Don't forget the main function must be declared as a function returning type int.
<br/>
<br/>
Hope this helps.
<br/>
<br/>
MayFly</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#2618 - siaspete - Sun Feb 09, 2003 11:09 am</h4>
    <div class="postbody"><span class="postbody">If you're using Devkit Advance you don't need a crt0.s. The compiler will supply one internally. To save some headaches, make sure you link your program using gcc (or g++) instead of ld.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#2626 - Vivi - Sun Feb 09, 2003 5:08 pm</h4>
    <div class="postbody"><span class="postbody">Well, it turns out though, the makefile was compiling incorrectly. I solved the problem by replacing it with a new one. But thanks anyways!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#2635 - Maddox - Sun Feb 09, 2003 7:16 pm</h4>
    <div class="postbody"><span class="postbody">siaspete,
<br/>
 What types of headaches does ld give that gcc doesn't?  How do you do the actual link with gcc?<br/>_________________<br/>You probably suck.  I hope you're is not a game programmer.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#5871 - Jason Wilkins - Sun May 11, 2003 10:18 am</h4>
    <div class="postbody"><span class="postbody">ld is a pain because to link a C program correctly you need to supply five files in addition to any which are in your project.  It is doubly painful because of multilib (arm, thumb, arm-thumb-interwork, thumb-thumb-interwork).  Also, there are several support libraries that have to be supplied just right.
<br/>
<br/>
Here is how gcc calls ld:
<br/>
<br/>
ld -o mygame.elf crt0.o crtn.o crtbegin.o myfile1.o myfile2.o crtend.o crti.o -lgcc -lc -lgcc -lmylib1 -lmylib2
<br/>
<br/>
gcc will do this for you if you just call it as:
<br/>
<br/>
gcc -o mygame.elf mygame.o -lmylib1 -lmylib2
<br/>
<br/>
Use g++ for c++ programs, it will add -lstdc++ and -lsupc++ to the command line as well.
<br/>
<br/>
You may think that does not look too bad, but now consider multilib.  The crt*.o files have to come out of the correct lib directory lib, lib/thumb, lib/interwork, or lib/thumb/interwork.  Providing the full path for each will make the command line quite long!  I'm not even sure how to get the -l option to get the libraries out of the correct multilib directories.  I have never tried it because I always use gcc or g++ to figure it all out for me.
<br/>
<br/>
Even a program with no C or C++ support can benefit by using the -nostartfiles and/or -nostdlib options with gcc, because gcc can still be used to link with the correct version of a library.
<br/>
<br/>
DevKit Advance R5 provides environment variables to make finding crt0.o easier.  The variables CRT0, CRT0_THUMB, CRT0_INTERWORK, and CRT0_THUMB_INTERWORK are set to the location of the crt0.o
<br/>
<br/>
You can use this with gcc to link a program that does not use main, and would have no constructor, destructor, or atexit support.
<br/>
<br/>
gcc -o mygame.elf -nostartfiles -nostdlib $CRT0 myfile1.o myfile1.o -lsomelib<br/>_________________<br/><a href="http://devkitadv.sourceforge.net" target="_blank">http://devkitadv.sourceforge.net</a></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
