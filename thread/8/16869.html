<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Four-in-one 16->8-bit - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>ASM > Four-in-one 16->8-bit</h2>
<div id="posts">
<div class="post">
    <h4>#170357 - Ruben - Fri Sep 18, 2009 8:58 pm</h4>
    <div class="postbody"><span class="postbody">So I decided to start writing my FFIV sequel from scratch again, and am close to running out of cycles, so I'm thinking about speeding up the only part 'optimizable' in the sound mixing code: 16-bit to 8-bit, 4 samples at once. (That is, make 4x 8-bit samples from 4x 16-bit samples quickly)
<br/>
<br/>
What I have at the moment is this...
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">@ r0: Destination (8-bit, word aligned)
<br/>
@ r1: Source (16-bit, word aligned)
<br/>
@ r2: Count
<br/>
@ r4: Mask 0x00FF00FF
<br/>
.LMix:
<br/>
    ldmia   r1!, {r5-r8}          @ RRRRLLLL
<br/>
    
<br/>
    and     r5, r4, r5, lsr #0x08 @ 00RR00LL
<br/>
    and     r6, r6, r4, lsl #0x08 @ RR00LL00
<br/>
    orr     r5, r5, r6            @ RRRRLLLL
<br/>
    
<br/>
    mov     r6, r5, lsr #0x10     @ 0000RRRR
<br/>
    bic     r5, r5, r6, lsl #0x10 @ 0000LLLL
<br/>
    mov     r6, r6, ror #0x10     @ RRRR0000
<br/>
    
<br/>
    and     r7, r4, r7, lsr #0x08 @ 00RR00LL
<br/>
    and     r8, r8, r4, lsl #0x08 @ RR00LL00
<br/>
    orr     r7, r7, r8            @ RRRRLLLL
<br/>
    
<br/>
    orr     r5, r5, r7, lsl #0x10 @ LLLLLLLL
<br/>
    orr     r6, r6, r7, lsr #0x10 @ RRRRRRRR
<br/>
    mov     r6, r6, ror #0x10
<br/>
    
<br/>
    str     r6, [r0, #BUFFER_LEN*BUFCNT]
<br/>
    str     r5, [r0], #0x04
<br/>
    
<br/>
    subs    r2, r2, #0x04
<br/>
    bne     .LMix</td> </tr></table><span class="postbody">
<br/>
I know there's gotta be a way to speed this up by getting rid of the ror's but... HOW? Can anyone help me here? Please? &gt;&lt;'</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170358 - DekuTree64 - Fri Sep 18, 2009 9:28 pm</h4>
    <div class="postbody"><span class="postbody">Well I don't have any brilliant ideas at the moment, but this should do it in one cycle less:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">and r5, r4, r5, lsr #8
<br/>
and r6, r6, r4, lsl #8
<br/>
orr r5, r5, r6
<br/>
<br/>
and r7, r4, r7, lsr #8
<br/>
and r8, r8, r4, lsl #8
<br/>
orr r6, r7, r8
<br/>
<br/>
mov r7, r5, lsl #16
<br/>
mov r8, r6, lsl #16
<br/>
orr r7, r8, r7, lsr #16
<br/>
<br/>
bic r8, r6, r8, lsr #16
<br/>
orr r8, r8, r5, lsr #16</td> </tr></table><span class="postbody">
<br/>
I'll post again if I come up with anything better.<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170359 - Ruben - Fri Sep 18, 2009 9:51 pm</h4>
    <div class="postbody"><span class="postbody">Thanks for the idea, Deku! It sped up a fair bit, considering that it does 528 samples per frame, with 16 channels + linear interpolation.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170360 - Ruben - Fri Sep 18, 2009 10:18 pm</h4>
    <div class="postbody"><span class="postbody">Latest code by Deku, which I believe is as fast as it can get:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">@ r0: Dest
<br/>
@ r1: Source
<br/>
@ r2: Count
<br/>
@ r3: Mask (0000FFFF; register is FFFFFFFF)
<br/>
@ r4: Mask (00FF00FF)
<br/>
<br/>
.LMix:
<br/>
   ldmia  r1!, {r5-r8}
<br/>
   
<br/>
   and    r5, r4, r5, lsr #0x08 @ 00R100L1
<br/>
   and    r6, r6, r4, lsl #0x08 @ R200L200
<br/>
   orr    r5, r5, r6            @ R2R1L2L1
<br/>
   
<br/>
   and    r7, r4, r7, lsr #0x08 @ 00R300L3
<br/>
   and    r8, r8, r4, lsl #0x08 @ R400L400
<br/>
   orr    r6, r7, r8            @ R4R3L4L3
<br/>
   
<br/>
   and    r7, r5, r3, lsr #0x10
<br/>
   orr    r7, r7, r6, lsl #0x10
<br/>
   
<br/>
   bic    r8, r6, r3, lsr #0x10
<br/>
   orr    r8, r8, r5, lsr #16
<br/>
   
<br/>
   str    r8, [r0, #BUFFER_LEN*BUFCNT]
<br/>
   str    r7, [r0], #0x04
<br/>
   
<br/>
   subs   r2, r2, #0x04
<br/>
   bne    .LMix</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170404 - Cearn - Mon Sep 21, 2009 6:41 pm</h4>
    <div class="postbody"><span class="postbody">How about this? Untested, but I think the idea is sound.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">@ BbAa,DdCc,FfEe,HhGg -&gt; GECA,HFDB
<br/>
<br/>
    @ r0 : dst (8bit)
<br/>
    @ r1 : src (16bit)
<br/>
    @ r2 : count
<br/>
    @ r4 : 0x00FF00FF
<br/>
.Lmix:
<br/>
    ldmia   r1!, {r5-r8}            @ BbAa,DdCc,FfEe,HhGg
<br/>
    
<br/>
    @ Downsample r5 and r6
<br/>
    and     r5, r4, r5, lsr #8      @ 0B0A
<br/>
    and     r6, r4, r6, lsr #8      @ 0D0C
<br/>
    orr     r5, r5, r6, lsl #8      @ DBCA
<br/>
    
<br/>
    @ Downsample r7 and r8
<br/>
    and     r7, r4, r7, lsr #8      @ 0F0E
<br/>
    and     r8, r4, r8, lsr #8      @ 0H0G
<br/>
    orr     r7, r7, r8, lsl #8      @ HFGE
<br/>
    
<br/>
    @ Swap (DB) and (GE)
<br/>
    eor     r6, r6, r5, lsr #16     @ HF(G^D)(E^B)
<br/>
    eor     r5, r5, r6, lsl #16     @ GECA
<br/>
    eor     r6, r6, r5, lsr #16     @ HFDB
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170413 - Ruben - Mon Sep 21, 2009 11:17 pm</h4>
    <div class="postbody"><span class="postbody">Wow, that actually worked! Thanks! ^_^'</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
