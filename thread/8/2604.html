<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Pointers to local memory - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>ASM > Pointers to local memory</h2>
<div id="posts">
<div class="post">
    <h4>#14338 - poslundc - Mon Jan 05, 2004 5:57 pm</h4>
    <div class="postbody"><span class="postbody">I've been wondering on occasion if there's any way to dynamically generate a pointer to somewhere in local memory.
<br/>
<br/>
That is to say, I can easily create a pointer and load it in with a ldr statement, such as in the following simple function that takes a pointer to a string and copies another constant string from local memory into it:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">TestFn:
<br/>
   ldr      r1, .L_TEST
<br/>
.STRING_LOOP:
<br/>
   ldrb   r2, [r1], #1
<br/>
   cmp      r2, #0
<br/>
   bxeq   lr
<br/>
   strb   r2, [r0], #1
<br/>
   b      .STRING_LOOP
<br/>
<br/>
.L_TEST:
<br/>
   .word   .L_TEST + 4
<br/>
   .asciz   "This is a test"</td> </tr></table><span class="postbody">
<br/>
<br/>
In this case, 4 bytes were wasted storing a fairly redundant word that just pointed to the next word ahead, and I had to use a load statement just to get a value that is a constant offset of the PC. Shouldn't I be able to do some arithmetic with the program counter instead? Something like:
<br/>
<br/>
add r1, pc, #.L_TEST
<br/>
<br/>
(Which I've tried, and doesn't work.)
<br/>
<br/>
Is there a way of doing this? I'm very curious to know.
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#14349 - DekuTree64 - Mon Jan 05, 2004 6:58 pm</h4>
    <div class="postbody"><span class="postbody">Yeah, it's a pseudo-op called adr. It's actually done with an add on the processor, so it is possible to count up the instructions by hand and type in the offset yourself, but adr makes the assembler do it for you. So for your example, it would be
<br/>
<br/>
adr r1, .L_TEST<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#14357 - poslundc - Mon Jan 05, 2004 8:01 pm</h4>
    <div class="postbody"><span class="postbody">Well now I know. Is there a source somewhere for these nifty pseudo-ops?
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#14362 - Paul Shirley - Mon Jan 05, 2004 8:53 pm</h4>
    <div class="postbody"><span class="postbody">removed</span><span class="gensmall"><br/><br/>Last edited by Paul Shirley on Sun Mar 28, 2004 9:22 pm; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#14366 - poslundc - Mon Jan 05, 2004 9:28 pm</h4>
    <div class="postbody"><span class="postbody">I've been working off the ARM7TDMI data sheet for ages, and the only references I've found for the adr pseudo-instruction were it being used in a couple of examples for the bx instruction and the swi instruction, with no explanation as to what it did. The lea pseudo-instruction was nowhere to be found.
<br/>
<br/>
Are these pseudo-ops characteristic of the processor, or the assembler?
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#14382 - DekuTree64 - Mon Jan 05, 2004 10:48 pm</h4>
    <div class="postbody"><span class="postbody">The only 2 pseudo-ops I was aware of were adr (which turns to add reg, pc, #ofs) and nop (mov r0, r0). I tried lea and got a bad instruction error. I think that was an instruction on x86 processors, but not ARM.
<br/>
Anyway, I learned them from GBATEK, down in the processor info section<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#14391 - tepples - Mon Jan 05, 2004 11:32 pm</h4>
    <div class="postbody"><span class="postbody">Like the numerous MIPS macros, these ARM pseudo-ops (ldr =, adr) seem to be assembler-implemented macros.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#14397 - Paul Shirley - Tue Jan 06, 2004 12:06 am</h4>
    <div class="postbody"><span class="postbody">removed</span><span class="gensmall"><br/><br/>Last edited by Paul Shirley on Sun Mar 28, 2004 9:23 pm; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#14430 - torne - Tue Jan 06, 2004 4:20 pm</h4>
    <div class="postbody"><span class="postbody">adr and various other pseudo-ops are implemented by the assembler and are translated into real machine instructions. They are pretty standard; the same ones work in GNU as and in the ARM development kit. The info file for as will list them, under the Machine Dependencies section.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#14895 - sasq - Wed Jan 14, 2004 3:08 pm</h4>
    <div class="postbody"><span class="postbody">Just do
<br/>
<br/>
add r0, pc, #label-.-2
<br/>
<br/>
in gas, or
<br/>
<br/>
add r0, pc, #label-?-2
<br/>
<br/>
in goldarm, provided label is 32bit aligned.
<br/>
Besides not wasting space, this type of coding also has the nice benefit of being completely relocatable.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#14901 - poslundc - Wed Jan 14, 2004 4:46 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>sasq wrote:</b></span></td> </tr> <tr> <td class="quote">Just do
<br/>
<br/>
add r0, pc, #label-.-2
<br/>
<br/>
in gas, or
<br/>
<br/>
add r0, pc, #label-?-2
<br/>
<br/>
in goldarm, provided label is 32bit aligned.
<br/>
Besides not wasting space, this type of coding also has the nice benefit of being completely relocatable.</td> </tr></table><span class="postbody">
<br/>
<br/>
I tried something similar to this in gas, and it wouldn't assemble. :P
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#14904 - sasq - Wed Jan 14, 2004 5:15 pm</h4>
    <div class="postbody"><span class="postbody">Well similar isn't same - and that works. The important bit is that "." means current adress so the expression evaluates to something small enough for an add.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#14905 - poslundc - Wed Jan 14, 2004 5:58 pm</h4>
    <div class="postbody"><span class="postbody">Interesting, I'll have to give it a try. I was always under the impression that labels were generated relative to the program counter to begin with.
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#14920 - torne - Wed Jan 14, 2004 8:21 pm</h4>
    <div class="postbody"><span class="postbody">The adr pseudo-op does exactly the same as the above add, but with the added benefit that it will automatically generate a load and store the address in a literal pool if it's out of range, whereas the add will fail. Just use adr. =)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#14929 - poslundc - Wed Jan 14, 2004 8:38 pm</h4>
    <div class="postbody"><span class="postbody">Does that mean I need to use a .pool directive if I'm going to use adr? 'Cos I don't normally include a .pool directive... (I like to assemble/load my constants myself.)
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#14931 - jma - Wed Jan 14, 2004 9:23 pm</h4>
    <div class="postbody"><span class="postbody">Using LEA (I don't know ADR) you should not need a .POOL directive. This is because the assembler should insert an ADD rd,PC,# instruction.
<br/>
<br/>
Jeff<br/>_________________<br/><a href="mailto:massung@gmail.com">massung@gmail.com</a>
<br/>
<a href="http://www.retrobyte.org" target="_blank">http://www.retrobyte.org</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#14944 - torne - Thu Jan 15, 2004 1:31 am</h4>
    <div class="postbody"><span class="postbody">adr only uses the pool if the address generated is out of range. You don't need a .pool directive most of the time anyway, as the pool will be dumped at each section change automatically. The .pool (or .ltorg) directive is just a hint to dump it early.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
