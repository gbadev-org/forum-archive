<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Problems With Code Converting - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>ASM > Problems With Code Converting</h2>
<div id="posts">
<div class="post">
    <h4>#174556 - nathanpc - Sat Jun 26, 2010 12:19 am</h4>
    <div class="postbody"><span class="postbody">Hello,
<br/>
 I'm starting to study how to convert a C source code(for GBA of course) to ARM Assembly, then I got this simple example from TONC:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">int main()
<br/>
{
<br/>
    *(unsigned int*)0x04000000 = 0x0403;
<br/>
<br/>
    ((unsigned short*)0x06000000)[120+80*240] = 0x001F;
<br/>
<br/>
    while(1);
<br/>
<br/>
    return 0;
<br/>
}</td> </tr></table><span class="postbody">
<br/>
Then I converted it into this:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">.arm
<br/>
.text
<br/>
.align 2
<br/>
.global main
<br/>
main:
<br/>
        mov r0, #0x4000000
<br/>
        mov r1, #0x400
<br/>
        add r1, r1, #3
<br/>
        str r1, [r0]
<br/>
        
<br/>
        mov r0, #0x6000000
<br/>
        mov r1, #0x1F
<br/>
        mov r2, #0xBB00
<br/>
        add r2, r2, #0x80
<br/>
        str r1, [r0], r2
<br/>
<br/>
infin:
<br/>
   b infin</td> </tr></table><span class="postbody">
<br/>
The <span style="font-weight: bold">0xBB80</span> value, I got from the expression <span style="font-weight: bold">[120+80*240]</span> from the C source, what is <span style="font-weight: bold">48000</span> in decimal, then I used a hexadecimal calculator to calculate what it's in hexadecimal. It compiles ok, but when I tried to run this on my emulator, I got nothing. As you can see here:
<br/>
<a href="http://img34.imageshack.us/img34/5024/nothingasmgba.png">[Images not permitted - Click here to view it]</a>
<br/>
What I need to do?
<br/>
<br/>
Best Regards,
<br/>
 Nathan Paulino Campos<br/>_________________<br/><span style="font-size: 9px; line-height: normal">Reading Tonc and trying to remind my very old C knowledge.
<br/>
<br/>
Just bought a GameBoy Advance SP one of those cartridges to put the ROMs for onboard debug.</span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#174557 - Dwedit - Sat Jun 26, 2010 3:08 am</h4>
    <div class="postbody"><span class="postbody">This piece of code should set DISPCNT to 0403 (mode 3, a 16-bit color layer, with layer 2 enabled), then it sets some pixel to color 1F (red).
<br/>
<br/>
What's calling main?
<br/>
Are you using the standard makefiles and linkscripts?  If so, then we know what's calling main (the crt0 file), and we know that main is located at 08xxxxxx.<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#174558 - nathanpc - Sat Jun 26, 2010 3:27 am</h4>
    <div class="postbody"><span class="postbody">Hello <span style="font-weight: bold">Dwedit</span>,
<br/>
 Before I've tried this code, from the <a class="postlink" href="http://patater.com/gbaguy/gba/ch2.htm" target="_blank">GBAGuy's tutorial</a>, just to test if my compiler is ok, and my emulator displayed all red ok:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">.arm
<br/>
.text
<br/>
.align 2
<br/>
.global main
<br/>
main:
<br/>
        mov r0, #0x4000000
<br/>
        mov r1, #0x400
<br/>
        add r1, r1, #3
<br/>
        str r1, [r0]
<br/>
        
<br/>
        mov r0, #0x6000000
<br/>
        mov r1, #0xFF
<br/>
        mov r2, #0x9600
<br/>
loop1: 
<br/>
   strh r1, [r0], #2
<br/>
   subs r2, r2, #1
<br/>
   bne loop1 
<br/>
infin:
<br/>
   b infin</td> </tr></table><span class="postbody">
<br/>
And that code works, like it should: The entire screen filled with a red color. But as you can see on my C source code, what I want is just a pixel, located at <span style="font-weight: bold">120x80</span>.
<br/>
<br/>
What did you suggest me to do?
<br/>
<br/>
Best Regards,
<br/>
 Nathan Paulino Campos<br/>_________________<br/><span style="font-size: 9px; line-height: normal">Reading Tonc and trying to remind my very old C knowledge.
<br/>
<br/>
Just bought a GameBoy Advance SP one of those cartridges to put the ROMs for onboard debug.</span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#174559 - headspin - Sat Jun 26, 2010 4:06 am</h4>
    <div class="postbody"><span class="postbody">First of all 120+80*240 equals 19320 (0x4B78). Secondly you should write a half word (use strh instead of str) for the second store. Also note it's casting to a short before it indexes the array.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">((unsigned short*)0x06000000)[120+80*240] = 0x001F; </td> </tr></table><span class="postbody">
<br/>
<br/>
So the 120+80*240 is actually 19320 steps into the array in half words (2 bytes). So to convert that to bytes you would need to multiply it by 2. 19320*2 = 38640 or 0x96F0.<br/>_________________<br/><a class="postlink" href="http://headsoft.com.au/index.php?category=warhawk" target="_blank">Warhawk DS</a> | <a class="postlink" href="http://headsoft.com.au/index.php?category=mmll" target="_blank">Manic Miner: The Lost Levels</a> | <a class="postlink" href="http://headsoft.com.au/index.php?category=tdg" target="_blank">The Detective Game</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#174561 - Cearn - Sat Jun 26, 2010 8:15 am</h4>
    <div class="postbody"><span class="postbody">You don't need to do the arithmetic yourself, the assembler can do it for you. This can save you some trouble (and it makes it easier to figure out what you meant six months from now). If you're using the template makefiles, you can also create macros for this. The assembler also has macro-capabilities of its own, look that up on the manual.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#define MODE3_PX(x, y)   (x+240*y)*2
<br/>
<br/>
   ldr      r2,=(120+80*240)*2         @ Offset for (120,80)
<br/>
   ldr      r2,=MODE3_PX(120,80)      @ Offset via macro
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Also, be aware of the differences between addressing modes.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
   ldr      r0, [r1, r2]    @ Pre-indexed.             r0= *(u32*)(r1+r2)
<br/>
   ldr      r0, [r1, r2]!   @ Pre-indexed,  writeback. r0= *(u32*)(r1 += r2)
<br/>
   ldr      r0, [r1], r2    @ Post-indexed, writeback. r0= *(u32*)r1; r1 += r2;
<br/>
</td> </tr></table><span class="postbody">
<br/>
The post-indexed with write-back that you used in `str r1, [r0], r2' adds the offset <span style="font-weight: bold">after</span> the store, so the pixel is actually at (0,0). If you zoom in you'll see.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#174564 - nathanpc - Sat Jun 26, 2010 1:31 pm</h4>
    <div class="postbody"><span class="postbody">Yeah, now I saw it at the 0x0: <a href="http://img62.imageshack.us/img62/2467/redpixgba.png">[Images not permitted - Click here to view it]</a>
<br/>
But as I saw, it is located at the 0x0, because of the instruction <span style="font-weight: bold">str r1, [r0], r2</span>, but what I should do to make it appear at the place that it should(120x80)?<br/>_________________<br/><span style="font-size: 9px; line-height: normal">Reading Tonc and trying to remind my very old C knowledge.
<br/>
<br/>
Just bought a GameBoy Advance SP one of those cartridges to put the ROMs for onboard debug.</span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#174568 - Cearn - Sat Jun 26, 2010 5:15 pm</h4>
    <div class="postbody"><span class="postbody">Use a pre-indexing mode: <span style="font-weight: bold">str r1, [r0, r2]</span>. 
<br/>
<br/>
When choosing from the three possibilities, first know what you really want to do. The modes write-back will change the second operand (the first register between brackets). If you don't need that, use simple pre-indexing. If you do, decide whether it needs to be done before you access the memory or after. It's the difference between *ptr++ and *++ptr. 
<br/>
<br/>
GBAGuy used writeback because he wanted the register to already point to the right spot for the next iteration of the loop. He used post-indexing because pre-indexing would have skipped over the first pixel.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#174576 - nathanpc - Sun Jun 27, 2010 3:49 pm</h4>
    <div class="postbody"><span class="postbody">Thanks, now I understood. :)<br/>_________________<br/><span style="font-size: 9px; line-height: normal">Reading Tonc and trying to remind my very old C knowledge.
<br/>
<br/>
Just bought a GameBoy Advance SP one of those cartridges to put the ROMs for onboard debug.</span></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
