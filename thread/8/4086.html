<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>What to know about GAS and mixing it with C - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>ASM > What to know about GAS and mixing it with C</h2>
<div id="posts">
<div class="post">
    <h4>#26467 - funkeejeffou - Thu Sep 16, 2004 1:40 pm</h4>
    <div class="postbody"><span class="postbody">Hi,
<br/>
<br/>
As I'm changing apartment soon, I won't have the internet for maybe a month. However I must keep coding the project I'm actually on(pretty interesting huh :-); that is why I'm posting here today cause tomorrow internet will be gone :(
<br/>
<br/>
I'm currently using DevKitARM R8, and as I need to optimize a lot my code, I have thought of using ASM written functiuns in a big main C program(the forum members seems to prefer this over inline assembly).
<br/>
The problem is, after searching for two nights on gbadev.org and google, I couldn't bring up myself with answers, and it seems that no special docs exists on mixing GAS and C.
<br/>
I would just like to have a clear and complete method on this topic so that I understand what is happening and so that I can code peacefully.
<br/>
<br/>
So please help me out with these little questions :
<br/>
<br/>
1)How do I create the general structure of my program, providing the main file and functiun are in C code, and can call ASM functiuns located in IWRAM(ARM Code) or EWRAM(Thumb Code).
<br/>
<br/>
2) How do I create an ASM functiun in a separate file so that the main program will know its existence. How do I call this functiun? How do I retrieve the parameters I've sent to it(in ASM), how do I return a value and use it in C code? 
<br/>
<br/>
3) How can global variables be accessed in ASM?
<br/>
<br/>
4) Can I know what is the first free adress in RAM when using ASM, and can I move the heap after alocating memory?
<br/>
<br/>
5) How can I force the ASM functiuns and the C one to be in thumb or ARM, and in IWRAM, EWRAM or ROM?
<br/>
<br/>
6) What is the way of compiling a big project like this with C, ASM functiuns in ROM, RAM and ARM/Thumb(makefile)?
<br/>
<br/>
7) If there is a sourcecode somewhere concerning this code architecture, I'd be happy to have the link.
<br/>
<br/>
Thanks in Advance !
<br/>
<br/>
PS : I know these questions are often asked here, but the answers aren't always clear. Maybe it would be a good idea putting the answers in Tepples GBAdev Frequently asked, or creating a good tutorial on it.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#26468 - poslundc - Thu Sep 16, 2004 2:05 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>funkeejeffou wrote:</b></span></td> </tr> <tr> <td class="quote">1)How do I create the general structure of my program, providing the main file and functiun are in C code, and can call ASM functiuns located in IWRAM(ARM Code) or EWRAM(Thumb Code).</td> </tr></table><span class="postbody">
<br/>
<br/>
The best way is to create your C files as normal, and make a separate .S file for each of your assembly routines. You can specify what section of memory you want the ASM code to appear in with the .section directives, eg. .section .iwram, .section .ewram, and .section .text (for ROM).
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">2) How do I create an ASM functiun in a separate file so that the main program will know its existence. How do I call this functiun? How do I retrieve the parameters I've sent to it(in ASM), how do I return a value and use it in C code?</td> </tr></table><span class="postbody">
<br/>
<br/>
Just create a header file to #include in your C code that has the function prototype in it, with the keyword extern:
<br/>
<br/>
extern void myASMFunction(void);
<br/>
<br/>
If you are calling assembly code from C and jumping from ROM to IWRAM, you need to make a long call. This is done in the function prototype of your ASM routine, such as:
<br/>
<br/>
extern __attribute__ ((long call)) void myASMfunction(void);
<br/>
<br/>
For the parameters, the first four will appear in r0 to r3. Any additional ones will be placed on the stack. You can return a value by putting it into r0 before calling bx lr. Google up the ARM intra-procedure call standard (or search the forum and you'll probably find a link) for more details.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">3) How can global variables be accessed in ASM?</td> </tr></table><span class="postbody">
<br/>
<br/>
Global variables generate a 32-bit symbol that is visible to the linker, so all you have to do is put their name in a 32-bit value your ASM code can reach to grab a pointer to them. ie.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">     ldr     r0, L_GLOBALS     @ r0 &lt;- pointer to myCVar
<br/>
     ldr     r1, [r0]          @ r1 &lt;- myCVar's value
<br/>
     add     r1, r1, #1
<br/>
     str     r1, [r0]           @ myCVar is incremented by 1
<br/>
          ...
<br/>
     bx      lr
<br/>
L_GLOBALS:
<br/>
     .word     myCVar     @ linker will replace myCVar with the variable's actual address</td> </tr></table><span class="postbody">
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">4) Can I know what is the first free adress in RAM when using ASM, and can I move the heap after alocating memory?</td> </tr></table><span class="postbody">
<br/>
<br/>
The stack pointer register (sp, or r13) contains a pointer to the top of available IWRAM. There is no built-in notion of a heap on the GBA; you must either write your own memory management routine or use malloc.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">5) How can I force the ASM functiuns and the C one to be in thumb or ARM, and in IWRAM, EWRAM or ROM?</td> </tr></table><span class="postbody">
<br/>
<br/>
.arm for ARM functions
<br/>
.thumb, and
<br/>
.thumb_func for Thumb functions
<br/>
.section .iwram for IWRAM
<br/>
.section .ewram for EWRAM
<br/>
.section .text for ROM
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">6) What is the way of compiling a big project like this with C, ASM functiuns in ROM, RAM and ARM/Thumb(makefile)?</td> </tr></table><span class="postbody">
<br/>
<br/>
Depends on how complicated you want your build to be. It is possible to call it all on a single line where you pass in all of your C and assembly files. My makefile has a separate directive for first compiling all of the .c files into .o files, then for assembling all of the .S files into .o files, then for linking all of the .o files into a .elf file.
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#26469 - funkeejeffou - Thu Sep 16, 2004 2:21 pm</h4>
    <div class="postbody"><span class="postbody">Thanks Dan !
<br/>
<br/>
Just a few points I don't get at a 100% :
<br/>
<br/>
1) For functiun parameters let us say I have 6 in this one :
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">int junk(int a, int b, int c, int d, int e, int f)</td> </tr></table><span class="postbody">
<br/>
then :
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">r0 = a;
<br/>
r1 = b;
<br/>
r2 = c; 
<br/>
r3 = d;</td> </tr></table><span class="postbody">
<br/>
Now I pull the stack :
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">ldmfd {sp!, r5-r6}</td> </tr></table><span class="postbody">
<br/>
(maybe it is not the exact syntax as i havent done any ARM ASM for a year...)
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">r5 = e;
<br/>
r6 = f; </td> </tr></table><span class="postbody">
<br/>
<br/>
What I wanna know is the order how they are pushed on the descending stack.
<br/>
<br/>
2) For globals, you mean there will be a symbol for each of them?
<br/>
Where do I find the adress of each(in what file)?
<br/>
Also if a global is a pointer, and I allocate it dynamically using malloc, how can I retrieve the adress?
<br/>
<br/>
3) Would it be too much asking for a sample makefile ? :-)
<br/>
<br/>
Thanks again
<br/>
<br/>
Cheers, Jeff.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#26471 - poslundc - Thu Sep 16, 2004 3:02 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>funkeejeffou wrote:</b></span></td> </tr> <tr> <td class="quote">1) For functiun parameters let us say I have 6 in this one :
<br/>
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">int junk(int a, int b, int c, int d, int e, int f)</td> </tr></table><span class="postbody">
<br/>
then :
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">r0 = a;
<br/>
r1 = b;
<br/>
r2 = c; 
<br/>
r3 = d;</td> </tr></table><span class="postbody">
<br/>
Now I pull the stack :
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">ldmfd {sp!, r5-r6}</td> </tr></table><span class="postbody">
<br/>
(maybe it is not the exact syntax as i havent done any ARM ASM for a year...)
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">r5 = e;
<br/>
r6 = f; </td> </tr></table><span class="postbody">
<br/>
<br/>
What I wanna know is the order how they are pushed on the descending stack.</span></td> </tr></table><span class="postbody">
<br/>
<br/>
torne explains it better than I ever could in <a class="postlink" href="http://forum.gbadev.org/viewtopic.php?t=2338" target="_blank">http://forum.gbadev.org/viewtopic.php?t=2338</a>.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">2) For globals, you mean there will be a symbol for each of them?
<br/>
Where do I find the adress of each(in what file)?</td> </tr></table><span class="postbody">
<br/>
<br/>
You don't; the linker does. You just put the name of the global variable you want to reference in there and the linker does the rest.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Also if a global is a pointer, and I allocate it dynamically using malloc, how can I retrieve the adress?</td> </tr></table><span class="postbody">
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">     ldr    r0, L_GLOBALS     @ r0 &lt;- pointer variable's address (pointer to pointer)
<br/>
     ldr     r1, [r0]     @ r1 &lt;- pointer variable (regular pointer)
<br/>
     ldr     r2, [r1]     @ r1 &lt;- whatever myPointer points to
<br/>
          ...
<br/>
     bx     lr
<br/>
L_GLOBALS:
<br/>
     .word     myPointer</td> </tr></table><span class="postbody">
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">3) Would it be too much asking for a sample makefile ? :-)</td> </tr></table><span class="postbody">
<br/>
<br/>
Don't have one on me. Google it up; the net is filled with plenty of makefile tutorials. It's something you'll want to learn sooner or later.
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#26563 - Quirky - Sat Sep 18, 2004 5:24 pm</h4>
    <div class="postbody"><span class="postbody">You don't need an extra label for accessing variables in other compilation units; unless you are accessing structures this is probably a nicer way to go about accessing ints and stuff: 
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
ldr  r0,=my_variable 
<br/>
ldr  r1,[r0]
<br/>
add  r1,r1,#1
<br/>
str  r1,[r0]
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#26564 - poslundc - Sat Sep 18, 2004 6:01 pm</h4>
    <div class="postbody"><span class="postbody">The =-prefix method is also fine, and is a shorthand for the method I demonstrated. The only thing to be wary of is that it involves the creation of a literal pool which isn't always practical for very large or multiple routines, or at least can make debugging difficult if you don't know how it works. I personally prefer the explicit method, but you can certainly use the =-prefix method if you feel it makes code more readable.
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
