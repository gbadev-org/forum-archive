<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>I don't know... - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>ASM > I don't know...</h2>
<div id="posts">
<div class="post">
    <h4>#25870 - anoneem - Mon Aug 30, 2004 10:22 am</h4>
    <div class="postbody"><span class="postbody">Damn, it's me again! :) I was writing a stupid program, wich i would like to draw for me some nice colours on the screen. Here it goes...
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">@textarea
<br/>
<br/>
loop:
<br/>
<br/>
ldr r1,=0x4000000      ;screen conrol
<br/>
<br/>
ldr r2,=0x403         ;Mode 3, BG2
<br/>
<br/>
str r2,[r1]         ;OKAY!
<br/>
<br/>
;Tryb 3 ON
<br/>
<br/>
ldr r0,=0x0FF         ;it is colour
<br/>
<br/>
ldr r1,=0         ;x position
<br/>
<br/>
ldr r2,=0         ;y position
<br/>
<br/>
ldr r3,=240         ;well... 240 value :) r3 is counter
<br/>
<br/>
ldr r4,=0x06000000      ;vram
<br/>
<br/>
ldr r5,=0         ;
<br/>
<br/>
ldr r6,=240         ;wide
<br/>
<br/>
ldr r7,=160         ;height
<br/>
<br/>
testx:
<br/>
<br/>
cmp r3,0         ;is line drawn?
<br/>
<br/>
beq wiersz:         ;if yes, draw next
<br/>
<br/>
mla r5,r2,r6,r1         ;if no, y*240+x
<br/>
<br/>
add r4,r4,r5         ;vram+position
<br/>
<br/>
str r0,[r4]         ;and draw dot
<br/>
<br/>
add r1,r1,1         ;inc x
<br/>
<br/>
sub r3,r3,1         ;counter - 1
<br/>
<br/>
add r0,r0,1         ;inc colour
<br/>
<br/>
b testx:
<br/>
<br/>
wiersz:
<br/>
<br/>
add r3,r3,240         ;240 - x position is 0, so set counter of x line
<br/>
<br/>
cmp r7,0         ;is last point of screen drawn? (240,160)
<br/>
<br/>
beq loop:         ;if yes, loop
<br/>
<br/>
sub r7,r7,1         ;if no, dec counter
<br/>
<br/>
b testx            ;and branch
<br/>
<br/>
label1
<br/>
b label1
<br/>
<br/>
@pool
<br/>
@endarea</td> </tr></table><span class="postbody">
<br/>
<br/>
But it's drawing a... colourfull starfield? What am I doing bad here? Please, if You are boring, or if You want to educate a little dummy coder, fix it! I will be thankfull!
<br/>
<br/>
PS. Sory for english, if it's bad.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#25871 - pan69 - Mon Aug 30, 2004 12:22 pm</h4>
    <div class="postbody"><span class="postbody">Hi,
<br/>
<br/>
In Mode 3, isn't a pixel supposed to be 16bits (2 bytes). I think you need to multiply the y*240+x by 2 somewhere to determine to offset.
<br/>
<br/>
- Pan</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#25874 - anoneem - Mon Aug 30, 2004 4:13 pm</h4>
    <div class="postbody"><span class="postbody">So, is it going to be something like...
<br/>
<br/>
mla r5,r2,r6,r1			;y*240+x
<br/>
<br/>
mul r5,r5,r8                                               ;r8 is equ 2
<br/>
<br/>
???
<br/>
<br/>
I also changed values in incrementer - from 1 to 2, also i did it with counter. Effect is... some of dots, wich were changing colours, aren't doin' it any more. :)
<br/>
<br/>
BTW: Have You got some piece of code realizing that operation (colour of every next line should be ++)?
<br/>
<br/>
Greetz</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#25902 - f(DarkAngel) - Tue Aug 31, 2004 8:33 am</h4>
    <div class="postbody"><span class="postbody">Using shifting for div/mul by powers of two will be much faster. To multiply by 2, you could at least add the register to itself...<br/>_________________<br/>death scream...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#25904 - [mRg] - Tue Aug 31, 2004 11:17 am</h4>
    <div class="postbody"><span class="postbody">Note: This could be the blind leading the blind but ill have a go !
<br/>
<br/>
As I understand from your code you are trying to increase the colour for each line on the screen.
<br/>
<br/>
I think the problem is how you are incrementing the colour. Its not as easy as adding or subtracting 1 from the colour .. because the format is BGR adding one means you will cycle through the red range a bunch of times as you increase the other colours.
<br/>
<br/>
the colour can be constructed with : ((R)+((G)&lt;&lt;5)+((B)&lt;&lt;10)) where the &lt;&lt; is a LSL and the maximum in each channel can be 31 (ie 0-&gt;31 so 32 values)
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
<br/>
mov r1, #31 @ (Red)
<br/>
mov r2, #31 @ (Green)
<br/>
mov r3, #31 @ (Blue)
<br/>
add r1, r1, r2, lsl #5    @ Shift left 5 for green
<br/>
add r1, r1, r3, lsl #10  @ Shift left 10 for blue
<br/>
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
r1 now contains your colour !! (In this example its white)
<br/>
<br/>
I made a quick example (its not great code as im a newbie too but I hope you understand what Im trying to do and its all good practice for me :P )
<br/>
<br/>
Hope this helps in some way (investigating opened my eyes to  a few things anyway :)
<br/>
<br/>
Regards
<br/>
<br/>
[mRg]
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
<br/>
.arm
<br/>
.align
<br/>
.text
<br/>
.global main
<br/>
<br/>
@-------------------------------------------------------
<br/>
@ Include header with standard GBA definitions                         
<br/>
@-------------------------------------------------------
<br/>
<br/>
.include "includes/gba.h"
<br/>
<br/>
@-------------------------------------------------------
<br/>
@ Main program label                       
<br/>
@-------------------------------------------------------
<br/>
<br/>
main:
<br/>
<br/>
@--------------------------------------------------------
<br/>
@ Setup screen
<br/>
@--------------------------------------------------------
<br/>
<br/>
          ldr r0, =REG_DISPCNT         @ Display register      
<br/>
          ldr r1, =(MODE_3|BG2_ENABLE)   @ OR the options we want
<br/>
          strh r1, [r0]               @ Store in the register
<br/>
         
<br/>
          mov r0, #0x6000000      @ VRAM Screen buffer
<br/>
          mov r1, #0x1F         @ Red - ((31)+((0)&lt;&lt;5)+((0)&lt;&lt;10)) - Colour format = ((R)+((G)&lt;&lt;5)+((B)&lt;&lt;10))
<br/>
          
<br/>
          mov r2, #0x9600      @ Number of writes to fill the screen (240*160) in hex
<br/>
          mov r3, #240         @ Counter to check horizontal line has been drawn (there are better ways to detect this) 
<br/>
          ldr r4, =0x7FFF       @ Final colour we want (white - ((31)+((31)&lt;&lt;5)+((31)&lt;&lt;10))) - Colour format = ((R)+((G)&lt;&lt;5)+((B)&lt;&lt;10))
<br/>
          
<br/>
@--------------------------------------------------------
<br/>
@ Fill Screen
<br/>
@--------------------------------------------------------
<br/>
          
<br/>
loop1:    strh r1, [r0], #2      @ Save colour in screen buffer and move pointer along ready for the next colour
<br/>
          subs r3, r3, #1      @ Subtract 1 from r3 and check if its 0 (ie end of the line)
<br/>
          bleq addCol         @ If it is then jump to increment colour routine
<br/>
          subs r2, r2, #1      @ Subtract 1 from r2 is it 0 then screen has finished drawing
<br/>
          bne loop1             @ If it hasnt finished then loop back !
<br/>
          
<br/>
infin:      
<br/>
         b infin               @ infinite loop
<br/>
<br/>
addCol:
<br/>
         ldr r5, =((0)+((1)&lt;&lt;5)+((1)&lt;&lt;10)) @ Here we are loading 1 into the G+B areas so we can move from the red colour -&gt; white (r4)
<br/>
         cmp r1, r4                    @ Check if we match the white colour yet
<br/>
         movge r15, r14                 @ If so then exit routine (ie do nothing)
<br/>
         add r1, r1, r5                 @ If not add increase the G+B areas in r1 by adding r5
<br/>
         mov r3, #240                 @ Reset r3
<br/>
         mov r15, r14                 @ Exit routine
<br/>
         
<br/>
.align
<br/>
.pool
<br/>
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#25922 - anoneem - Tue Aug 31, 2004 5:51 pm</h4>
    <div class="postbody"><span class="postbody">Great! Thank You for that! You're my asm guru. :)</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
