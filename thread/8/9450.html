<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Porting PocketNES to GCC? - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>ASM > Porting PocketNES to GCC?</h2>
<div id="posts">
<div class="post">
    <h4>#81958 - Dwedit - Wed May 03, 2006 2:01 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>In <a class="postlink" href="http://forum.gbadev.org/viewtopic.php?p=81890#81890" target="_blank">this post</a>, wintermute wrote:</b></span></td> </tr> <tr> <td class="quote">I must admit I'd be interested in seeing how much the performance differs when compiled with a recent gcc.</td> </tr></table><span class="postbody">
<br/>
I'm sure it wouldn't differ at all, since 99.99% of the code executed each frame is already assembly code.
<br/>
<br/>
The big thing stopping me from doing it is that I don't understand how to construct the necessary makefiles, linkscripts, crt0.s, or make the appropriate changes to the asm .s files.  Does GCC's assembler have all the features necessary to compile PocketNES, including macros, conditional compilation, and something equivalent to Image$$RO$$Limit?  Does GCC use a different calling convention than SDT?  That could break all the calls from ASM to C.<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#81959 - tepples - Wed May 03, 2006 2:11 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Dwedit wrote:</b></span></td> </tr> <tr> <td class="quote">The big thing stopping me from [porting Loopy/Flubba emulators to GCC] is that I don't understand how to construct the necessary makefiles, linkscripts, crt0.s, or make the appropriate changes to the asm .s files.</td> </tr></table><span class="postbody">
<br/>
You can start by familiarizing yourself with wintermute's port of the GNU tools: get at least Hello World running using the standard GBA link script and crt0 provided with devkitARM. Here are the <a class="postlink" href="http://sourceware.org/binutils/docs-2.16/" target="_blank">manuals</a> for Gas (assembler), ld (linker), and the rest of binutils.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Does GCC's assembler have all the features necessary to compile PocketNES, including macros</td> </tr></table><span class="postbody">
<br/>
Yes, Gas has <a class="postlink" href="http://sourceware.org/binutils/docs-2.16/as/Macro.html#Macro" target="_blank">macros</a>.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">conditional compilation</td> </tr></table><span class="postbody">
<br/>
Yes, Gas has <a class="postlink" href="http://sourceware.org/binutils/docs-2.16/as/If.html#If" target="_blank">if</a>.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">and something equivalent to Image$$RO$$Limit?</td> </tr></table><span class="postbody">
<br/>
I don't know what the heck an Image$$RO$$Limit is, but while using Google to look for clues, I found <a class="postlink" href="http://sources.redhat.com/ml/crossgcc/2003-03/msg00006.html" target="_blank">this porting guide</a>.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Does GCC use a different calling convention than SDT?</td> </tr></table><span class="postbody">
<br/>
GCC uses the ARM-Thumb Procedure Call Standard.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#81987 - gladius - Wed May 03, 2006 7:47 am</h4>
    <div class="postbody"><span class="postbody">GCC's macros do not have feature parity with the ARM assemblers unfortunately.  For PocketNES this is not a big deal because Loopy didn't go hog wild on the macros thankfully :).  Porting snesadvance/snesds on the other hand...
<br/>
<br/>
The section values (image limit, size, start, etc.) are defined by GCC as well, yes, but they have different names that are assigned by your linkscript.
<br/>
<br/>
You'd want to learn some linkscript-fu before embarking on a port.  Start by hacking up the default ones included in devkitarm.  There are examples of modfied linkscripts floating about, I hacked them up for pocketspc somewhat so you might want to take a look there.
<br/>
<br/>
The crt0 stuff is not neccesary with pocketnes, it has code that does all that for itself, you'd just need to link in boot.s instead of crt0.s.
<br/>
<br/>
And, finally, the calling convention is the same.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#82001 - sgeos - Wed May 03, 2006 10:38 am</h4>
    <div class="postbody"><span class="postbody">Food for thought:  How much trouble would writing a (more than likely perl) filter to convert from one macro set to the other be?
<br/>
<br/>
-Brendan</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#82016 - wintermute - Wed May 03, 2006 1:13 pm</h4>
    <div class="postbody"><span class="postbody">building assembly files using arm-elf-gcc -x assembler-with-cpp -c &lt;source&gt;.s -o &lt;object&gt;.o gives you access to the C preprocessor. That way you can gain access to all the features of the preprocessor such as C style comments and #defines. Capitalising the extension does the same thing.
<br/>
<br/>
As for the linker supplied variables it's really just a matter of figuring out the equivalent name or supplying an equivalent value from the linker script.<br/>_________________<br/><a class="postlink" href="http://www.devkitpro.org/" target="_blank">devkitPro - professional toolchains at amateur prices</a>
<br/>
<a class="postlink" href="http://wiki.devkitpro.org/index.php/IRC" target="_blank">devkitPro IRC support</a>
<br/>
<a class="postlink" href="http://davejmurphy.com/" target="_blank">Personal Blog</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#82229 - FluBBa - Thu May 04, 2006 5:49 pm</h4>
    <div class="postbody"><span class="postbody">Quirky used a lot from PocketNES when making his <a class="postlink" href="http://www.geocities.com/quirky_2k1/emulation/" target="_blank">PocketBeeb</a>, which can be compiled by GCC.<br/>_________________<br/>I probably suck, my not is a programmer.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
