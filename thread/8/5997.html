<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Stepping though ASM: binary search - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>ASM > Stepping though ASM: binary search</h2>
<div id="posts">
<div class="post">
    <h4>#45365 - ymalik - Fri Jun 10, 2005 12:19 am</h4>
    <div class="postbody"><span class="postbody">Is there anything that allows the stepping through of assembly code?  VBA has the disassemble feature, but it's hard to control.  For example, I am implementing binary search, first iteratively and then recursively.  Here is the iterative code:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
/* C code
<br/>
int bsearch2(int array[], int key, int size)
<br/>
{
<br/>
 int high, low, mid;
<br/>
<br/>
 low = 0;
<br/>
 high = size - 1;
<br/>
<br/>
 while(low &lt;= high)
<br/>
 {
<br/>
  mid = (high + low)&gt;&gt;1;
<br/>
<br/>
  if(array[mid] == key)
<br/>
   return mid;
<br/>
  else if(array[mid] &gt; key)
<br/>
   high = mid - 1;
<br/>
  else
<br/>
   low = mid + 1;
<br/>
 }
<br/>
<br/>
 return -1;
<br/>
}
<br/>
*/
<br/>
@ r0: pointer to array
<br/>
@ r1: key to search for
<br/>
@ r2: size of array
<br/>
bsearch2:
<br/>
   sub r2, r2, #1 @ r2 = high value
<br/>
   mov r3, #0  @ r3 = low value
<br/>
<br/>
loop:
<br/>
   cmp r3, r2  @ if low &gt; high, key not in array
<br/>
   movgt r0, #-1
<br/>
   bxgt lr
<br/>
   add r4, r2, r3 @ r4 = high + low
<br/>
   mov r4, r4, lsr#1 @ r4 = mid = r4/2
<br/>
   add r5, r0, r4
<br/>
   ldr r5, [r5]   @ r5 = *(array + mid)
<br/>
   cmp r5, r1  @ array[mid] == key
<br/>
   moveq r0, r4
<br/>
   bxeq lr
<br/>
   subgt r2, r4, #1
<br/>
   addlt r3, r4, #1
<br/>
   b loop
<br/>
</td> </tr></table><span class="postbody">
<br/>
It always returns -1, but I don't know when it is returning -1.
<br/>
<br/>
Thanks,
<br/>
Yasir</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#45370 - Miked0801 - Fri Jun 10, 2005 12:57 am</h4>
    <div class="postbody"><span class="postbody">No$ allows assembly stepping...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#45380 - strager - Fri Jun 10, 2005 1:49 am</h4>
    <div class="postbody"><span class="postbody">Replace moveq r0, r4 and bxeq lr with b end and add a section:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
end:
<br/>
    /* Debug */
<br/>
    mov r1, #0x0
<br/>
    ldr r1, [r1]
<br/>
<br/>
    mov r0, r4
<br/>
    bx lr
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Fire up the DOS version of VBA (forgot what it was called) and add a read breakpoint for the address 0x00000000.  I've also noticed that you used registers 4 and 5, but they are not pushed into stack before hand.  Add the neccesary code to solve that.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#45382 - ymalik - Fri Jun 10, 2005 3:04 am</h4>
    <div class="postbody"><span class="postbody">The freeware version of no$ does not have any debugging features.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>strager wrote:</b></span></td> </tr> <tr> <td class="quote">Replace moveq r0, r4 and bxeq lr with b end and add a section:
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
end:
<br/>
    /* Debug */
<br/>
    mov r1, #0x0
<br/>
    ldr r1, [r1]
<br/>
<br/>
    mov r0, r4
<br/>
    bx lr
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Fire up the DOS version of VBA (forgot what it was called) and add a read breakpoint for the address 0x00000000.  I've also noticed that you used registers 4 and 5, but they are not pushed into stack before hand.  Add the neccesary code to solve that.</span></td> </tr></table><span class="postbody">
<br/>
What does loading contents of address 0x0 do?
<br/>
Is there someway to set breakpoints in assembly code within GDB?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#45412 - strager - Fri Jun 10, 2005 1:18 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>ymalik wrote:</b></span></td> </tr> <tr> <td class="quote">What does loading contents of address 0x0 do?
<br/>
Is there someway to set breakpoints in assembly code within GDB?</td> </tr></table><span class="postbody">
<br/>
The data at 0x00000000+ is BIOS, which is not readable and will cause an exception (error).
<br/>
<br/>
I don't know how to set up GDB, so I wouldn't know.  Sorry.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#45416 - ymalik - Fri Jun 10, 2005 2:59 pm</h4>
    <div class="postbody"><span class="postbody">Ok, an error occurs.  Then what?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#45426 - strager - Fri Jun 10, 2005 5:18 pm</h4>
    <div class="postbody"><span class="postbody">Make a breakpoint in SDL.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#45433 - Quirky - Fri Jun 10, 2005 5:41 pm</h4>
    <div class="postbody"><span class="postbody">Compile your assembler with -g, like you would with C, and use VBA with insight. Works ok. VBA seems a bit buggy with the size of steps, occasionally skipping several opcodes for some reason, but for the price you can't complain.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#45434 - isildur - Fri Jun 10, 2005 5:43 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quirky wrote:</b></span></td> </tr> <tr> <td class="quote">Compile your assembler with -g, like you would with C, and use VBA with insight. Works ok. VBA seems a bit buggy with the size of steps, occasionally skipping several opcodes for some reason, but for the price you can't complain.</td> </tr></table><span class="postbody">
<br/>
<br/>
I thought it was insight that caused this leap stepping... Pissed me off more than I could endure, specially when you are used to win32 debuggers.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#45457 - Quirky - Fri Jun 10, 2005 9:07 pm</h4>
    <div class="postbody"><span class="postbody">One cause seems to be a bug in VBA, stepping through code in the VBA built in debugger shows the behaviour fairly clearly. I assume this behaviour is being passed on to Insight, most of the time it has no effect as each line of C compiles to several operations, but could occasionally cause problems. 
<br/>
<br/>
Another cause would be compiling with optimistation - that will have a bearing on the way the flow of the code goes and could look weird compared to the C original. I've seen code with 3 calls to a function like this:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
if (whatever)
<br/>
  function(a, b);
<br/>
else if (something_else)
<br/>
  function(b, c);
<br/>
else
<br/>
  function(d, e);
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Where a break on the first and final function calls would *both* be triggered in a single pass. I assume there's only one real branch instruction to the function and the other paths simply set up the registers. Plus thumb has to add in extra branches depending on the size of your if...else's.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#45475 - ymalik - Sat Jun 11, 2005 1:08 am</h4>
    <div class="postbody"><span class="postbody">I got binary search to work.
<br/>
I hooked up the SDL version of VBA with Insight.  I was able to step through the assembly code line by line, therefore I don't know where you guys are coming from by saying that VBA skips over multiple lines of code.  I could also view the registers.  I noticed that the middle index was being computed correctly, but the wrong element was being loaded into r5.  I then realized that I was dealing with an array of ints, so I had to multiply the offset by 4.
<br/>
Insight was very nice.  The thing that I hated was the register window kept going into the background when hit the next ASM instruction button, and that I couldn't use the keyboard to step through ASM code.  Here is the code:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
/* C code
<br/>
int bsearch2(int array[], int key, int size)
<br/>
{
<br/>
 int high, low, mid;
<br/>
<br/>
 low = 0;
<br/>
 high = size - 1;
<br/>
<br/>
 while(low &lt;= high)
<br/>
 {
<br/>
  mid = (high + low)&gt;&gt;1;
<br/>
<br/>
  if(array[mid] == key)
<br/>
   return mid;
<br/>
  else if(array[mid] &gt; key)
<br/>
   high = mid - 1;
<br/>
  else
<br/>
   low = mid + 1;
<br/>
<br/>
 }
<br/>
<br/>
 return -1;
<br/>
}
<br/>
*/
<br/>
@ r0: pointer to array of ints
<br/>
@ r1: key to search for
<br/>
@ r2: size of array
<br/>
bsearch2:
<br/>
   stmda r13!, {r4-r5}
<br/>
   sub r2, r2, #1 @ r2 = high value
<br/>
   mov r3, #0  @ r3 = low value
<br/>
<br/>
loop:
<br/>
   cmp r3, r2  @ if low &gt; high, key not in array
<br/>
   movgt r4, #-1
<br/>
   bgt end
<br/>
   add r4, r2, r3 @ r4 = high + low
<br/>
   mov r4, r4, lsr#1 @ r4 = mid = r4/2
<br/>
   mov r4, r4, lsl#2 @ offset in multiple of 4 bytes, not 1 byte
<br/>
@ could have done just lsl#1, but did this for clarity's sake
<br/>
   add r5, r0, r4 @ r5 = array + mid
<br/>
   mov r4, r4, lsr#2 @ change back to logical 1 element offset
<br/>
   ldr r5, [r5]   @ r5 = *(array + mid)
<br/>
   cmp r5, r1  @ array[mid] == key
<br/>
   beq end
<br/>
   subgt r2, r4, #1
<br/>
   addlt r3, r4, #1
<br/>
   b loop
<br/>
<br/>
end:
<br/>
   mov r0, r4
<br/>
   ldmib r13!, {r4-r5}
<br/>
   bx lr
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Now I want to do this recursively.</span><span class="gensmall"><br/><br/>Last edited by ymalik on Sat Jun 11, 2005 3:41 am; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#45478 - strager - Sat Jun 11, 2005 2:37 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>ymalik wrote:</b></span></td> </tr> <tr> <td class="quote">Now I want to do this recursively.</td> </tr></table><span class="postbody">
<br/>
<br/>
Good for you. :-P</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#45485 - tepples - Sat Jun 11, 2005 4:42 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>ymalik wrote:</b></span></td> </tr> <tr> <td class="quote">The freeware version of no$ does not have any debugging features.</td> </tr></table><span class="postbody">
<br/>
Is there a reason (e.g. under 18) that you can't use PayPal? Or are you using a computer that can't run Windows or FreeDOS (e.g. a Mac, or a Linux box with the entire HD reformatted to ext3 or Reiser4)?
<br/>
<br/>
The only kind of recursion that you should do with bsearch or any other true in-place algorithm is tail recursion, and the asm equivalent of tail recursion is a GOTO, called 'b' in ARM. But for real recursion (e.g. qsort), the procedure is to push r1-3 and r12 (if you need to keep them across calls), bl to the start of the function, pop r1-3 and r12 (if you pushed them), and read the return value out of r0.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#45527 - ymalik - Sat Jun 11, 2005 5:13 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tepples wrote:</b></span></td> </tr> <tr> <td class="quote">Is there a reason (e.g. under 18) that you can't use PayPal? Or are you using a computer that can't run Windows or FreeDOS (e.g. a Mac, or a Linux box with the entire HD reformatted to ext3 or Reiser4)?</td> </tr></table><span class="postbody">
<br/>
PayPal means that there's money involved, and I don't want to spend money on this.  I haven't even tested anything on hardware yet.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">The only kind of recursion that you should do with bsearch or any other true in-place algorithm is tail recursion, and the asm equivalent of tail recursion is a GOTO, called 'b' in ARM. But for real recursion (e.g. qsort), the procedure is to push r1-3 and r12 (if you need to keep them across calls), bl to the start of the function, pop r1-3 and r12 (if you pushed them), and read the return value out of r0.</td> </tr></table><span class="postbody">
<br/>
But I want to learn how to do function calls.  Using GOTO won't allow be to do that.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#45529 - tepples - Sat Jun 11, 2005 5:53 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>ymalik wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tepples wrote:</b></span></td> </tr> <tr> <td class="quote">the procedure is to push r1-3 and r12 (if you need to keep them across calls), bl to the start of the function, pop r1-3 and r12 (if you pushed them), and read the return value out of r0.</td> </tr></table><span class="postbody">
<br/>
But I want to learn how to do function calls.</span></td> </tr></table><span class="postbody">
<br/>
That <span style="font-style: italic">is</span> a function call. Please read the ARM/Thumb Procedure Call Standard (<a class="postlink" href="http://www.utdallas.edu/~edsha/security/armcallconvention.pdf" target="_blank">PDF</a>) for details.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
