<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>code to play an AVI file - Works - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>ASM > code to play an AVI file - Works</h2>
<div id="posts">
<div class="post">
    <h4>#6669 - GbaGuy - Sun Jun 01, 2003 4:57 pm</h4>
    <div class="postbody"><span class="postbody">This is what I have:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
@arm
<br/>
@fsize   32
<br/>
<br/>
@equ   oam_table   =   0x03000000
<br/>
<br/>
b start
<br/>
@include screen.h
<br/>
@include dma.h
<br/>
@dup   dcb 0xba,0x0
<br/>
start:
<br/>
<br/>
ldr r7,=0x4000000
<br/>
ldr r8,=0x403
<br/>
str r8,[r7]
<br/>
<br/>
ldr r2,=StartOfAVI
<br/>
ldr r3,=0  ; offset from StartOfAVI
<br/>
ldr r9,=0x63643030 ; means a video chunk, 0x63643030
<br/>
ldr r8,=4
<br/>
ldr r7,=1
<br/>
ldr r10,=0
<br/>
ldr r6,=240*160*2-2
<br/>
<br/>
playAVI:
<br/>
   ldr r2,=StartOfAVI
<br/>
   ldr r5,=0
<br/>
   add r5,r2,r3   ; Add offset to r2 (base) give r5 the full addr
<br/>
   ldr r4,[r5]     ; get data
<br/>
   cmp r4,r9       ; see if a video frame is coming up
<br/>
   bne NotAVidChunk  ; if not, goto NotAVidChunk
<br/>
   add r5,r5,r8       ; add 4 to get past the chunk specifier and something else that I don't know what exactly it is.
<br/>
   
<br/>
   ldr r0,=0x4000006 ;0x4000006 is vertical trace counter it?s address is loaded into r0 
<br/>
scanline_wait: ;lable
<br/>
   ldrh r1, [r0] ;move the value stored in the scan line register into r1
<br/>
   cmp r1, 160 ;comp it with 160
<br/>
        bne scanline_wait ;if it is equal then we are done else it jumps to scanline wait 
<br/>
<br/>
   DrawMode3Pic r5    ; draw the picture with DMA.
<br/>
   add r3,r3,r6
<br/>
   add r3,r3,r7
<br/>
   b playAVI
<br/>
<br/>
NotAVidChunk:
<br/>
   add r3,r3,r7   ; add 1 to the offset
<br/>
   b playAVI     ; try again
<br/>
<br/>
StartOfAVI:
<br/>
   ; AVI file to be DOS Copy commanded to the end which will be here.
<br/>
   ; AVI file hopefully will be uncompressed, no sound, 16bit color
<br/>
   ; and 240x160. VirtualDub can be used to get it like that.
<br/>
<br/>
@endarea
<br/>
@pool
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Everything now works, except for the picture being upside-down and
<br/>
the colors reversed.
<br/>
<br/>
Anyone want to help on this?
<br/>
<br/>
Thanks,
<br/>
- Mike
<br/>
<br/>
PS: The headers can be retrieved if you take my website
<br/>
<a href="http://k2pts.home.attbi.com/gbaguy/" target="_blank">http://k2pts.home.attbi.com/gbaguy/</a> and append the name of a
<br/>
header.</span><span class="gensmall"><br/><br/>Last edited by GbaGuy on Mon Jun 02, 2003 1:27 am; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#6682 - arundel - Sun Jun 01, 2003 10:17 pm</h4>
    <div class="postbody"><span class="postbody">I can't find any major errors, but maybe I'm too newb. Could you post some screenshots of the output picture you mentioned?<br/>_________________<br/><span style="font-weight: bold">http://www.nausicaa.net</span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#6683 - GbaGuy - Sun Jun 01, 2003 10:29 pm</h4>
    <div class="postbody"><span class="postbody">The only problems with the picture (as outputted from the currectly posted
<br/>
code), is that it's upside-down and red and blue are reversed, that's what
<br/>
I'd expect.
<br/>
<br/>
What I want to do now is get it working on the read GBA. Here's output
<br/>
taken from VisualBoyAdvance:
<br/>
<br/>
<a href="http://k2pts.home.attbi.com/gbaguy/screen.JPG">[Images not permitted - Click here to view it]</a>
<br/>
<br/>
In the movie, the blue thing (it's a pyramid, but you can't tell from that
<br/>
angle) spins. It's also supposed to be red. And the image is upside-down
<br/>
of course.
<br/>
<br/>
Any ideas?
<br/>
<br/>
I was thinking maybe syncing with VBlank would have a better chance
<br/>
of getting output on the real GBA...
<br/>
[/img]</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#6690 - arundel - Sun Jun 01, 2003 11:44 pm</h4>
    <div class="postbody"><span class="postbody">I might have an answer to the wrong colour issue. I believe the GBA uses a different colour sceme, as used in the avi image data. The AGB uses BGR and it seems the avi data is using RGB. Try a right rotation by 5 bits and then exchange bits 5-10 with bits 11-15. This might become a bit tricky, since you'll have to be very careful with the bits. I think one of the colours uses 6 bits (<span style="color: blue">blue?</span>), the others 5 bits. Be sure to check out some docs concerning this matter.
<br/>
<br/>
<span style="font-weight: bold">EDIT:
<br/>
<br/>
The problem with the upside down image could be related to the endianess. Check all code to see, if this might be an issue. The GBA uses little endian, although natively the ARM CPU supports both memory models.</span><br/>_________________<br/><span style="font-weight: bold">http://www.nausicaa.net</span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#6692 - GbaGuy - Mon Jun 02, 2003 12:39 am</h4>
    <div class="postbody"><span class="postbody">I had a feeling that the GBA's color format was the reverse of AVIs.
<br/>
<br/>
As for the upside-down image, the frames are stored that way in AVIs
<br/>
for some reason, that'll take a using the end of frame address and telling
<br/>
the DMA to source decrement, I think that might work.
<br/>
<br/>
Right now, I'm more concerned about getting it working on the hardware.
<br/>
I did some tests and discovered that absolutely nothing that I write in
<br/>
ASM is working on the hardware and that the header is showing some
<br/>
wierd stuff (header values are coming from the AVI that is at the end
<br/>
part of the file!! I know because I've had the title of the ROM be RIFF
<br/>
and 00dcd). ROMs that I've coded in C are working so there's something
<br/>
wrong with the ROMs that are coded in ASM.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#6695 - DekuTree64 - Mon Jun 02, 2003 1:35 am</h4>
    <div class="postbody"><span class="postbody">GBA's color is 5.5.5 BGR (meaning bit0-4 is red, bit5-9 is green, and bit10-14 is blue (when you write out a number, the upper bits come first, so that's why it's called BGR)), with the highest bit unused (most computers use 5.6.5 for 16-bit, which is what Arundel was thinking of). For the upside down problem, just set REG_BG2PD (or it might be PA, not sure which) to -256 and the hardware will flip it for you.
<br/>
As for the not working on HW problem, use GAS. I've never used Goldroad myself, but with GAS you can link .o files compiled from ASM or C, so you can just use whichever language is best for the particular function you're writing, and if your C programs are working fine, then ASM programs shouldn't be any different.
<br/>
I think the syntax is a little different though.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#6697 - GbaGuy - Mon Jun 02, 2003 1:46 am</h4>
    <div class="postbody"><span class="postbody">Got it working on hardware now, it was a problem with the header.
<br/>
<br/>
Thanks for the flipping tip!
<br/>
<br/>
I tried using GAS and OBJCOPY, but for some reason some of
<br/>
the branches got messed up.
<br/>
<br/>
I'm DMAing the frame directly from where they start to VRAM, so
<br/>
I might have to write a PC program to do the color adjustment, as
<br/>
I can't find an option in VirtualDub to reverse R and B.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#6735 - Ampersand - Mon Jun 02, 2003 1:10 pm</h4>
    <div class="postbody"><span class="postbody">Hi,
<br/>
<br/>
I also noticed Goldroad to have problems with headers, some small files also need to be padded to 2kb file size.<br/>_________________<br/><a href="http://www.iome.nl" target="_blank">www.iome.nl</a></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
