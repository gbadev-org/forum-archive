<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Calling and returning from externally linked asm routines - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>ASM > Calling and returning from externally linked asm routines</h2>
<div id="posts">
<div class="post">
    <h4>#18835 - gbawiz - Tue Apr 06, 2004 10:47 pm</h4>
    <div class="postbody"><span class="postbody">Hello,
<br/>
I have recently tried to create a program which uses ASM as well as C source.
<br/>
It works on its own but when I incorporate it into some of my other programs then it has errors.
<br/>
Although Im not exactly sure what the problem is, I have a suspicion with regards to the contents of the registers before the functions are called and after they finish.
<br/>
<br/>
Should the registers be preserved at the start of the asm routines and then reinstated after the asm?
<br/>
if so then how do i preserve?
<br/>
Thanks</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#18836 - DekuTree64 - Tue Apr 06, 2004 11:00 pm</h4>
    <div class="postbody"><span class="postbody">r0-r3 are used for arguments, so they're free to do what you want with. r12 is also free, so no need to preserve it. r14 is the link register, so you need to make sure you keep its value somewhere so you can return to where you were called from. Other than that it's free for use. r12 is the stack, so of course it needs to be preserved. You can store it to a pc-relative address if you're really cramped for registers, but beware if your interrupts switch to the user stack for extra space. Generally it's best to keep the stack intact at all times.
<br/>
r4-r11 need to be preserved, and r15 is the program counter, so of course you can't use it for anything else.
<br/>
Most of the time you just push any regs you need to preserve onto the stack, which is done with a stmfd instruction in ARM, or a push instruction in THUMB. Then to load them back at the end, use ldmfd or pop for their respective CPU modes.
<br/>
<br/>
So something like this:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">.global thing
<br/>
.align
<br/>
.arm
<br/>
thing:
<br/>
stmfd r13!, {r4-r11, r14}
<br/>
@do stuff involving all those registers
<br/>
ldmfd r13!, {r4-r11, r14}
<br/>
bx r14   @return to caller</td> </tr></table><span class="postbody"><br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#18918 - Cearn - Thu Apr 08, 2004 9:05 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>DekuTree64 wrote:</b></span></td> </tr> <tr> <td class="quote">r0-r3 are used for arguments, so they're free to do what you want with. </td> </tr></table><span class="postbody">
<br/>
Yeah, but is this true even when the function has less than 4 arguments? Say your function is 
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">foo(int x, int y)</td> </tr></table><span class="postbody">
<br/>
I know that x and y are put in r0 and r1 by the calling function, but what happens to the contents of r2 and r3; are they still free as well?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#18930 - batblaster - Thu Apr 08, 2004 1:05 pm</h4>
    <div class="postbody"><span class="postbody">Yes are free, you can use but don't forget to save all the others...<br/>_________________<br/>Batblaster / 7 Raven Studios Co. Ltd
<br/>
------------------------------------------</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#18931 - Cearn - Thu Apr 08, 2004 1:08 pm</h4>
    <div class="postbody"><span class="postbody">oki. Thanks for clearing that up.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#19022 - gbawiz - Sat Apr 10, 2004 12:27 pm</h4>
    <div class="postbody"><span class="postbody">Hello all,
<br/>
I have a question with regards to ISR interrupt routines.
<br/>
In my app, I am using two timers, each with the ability to call the interrupt routine.
<br/>
timer 1 deals with the general game timers such as the animation frame rate, counting, etc.. and the other deals with the audio.
<br/>
<br/>
The question I have is: what happens when the ISR is currently servcing the interrupt from timer 1 and then timer 2 generates and interrupt?
<br/>
<br/>
Is timer2 ignored?
<br/>
or does the CPU wait till it finishes timer1 servicing then move onto 2
<br/>
or does the interrupt for timer 1 get interrupted by timer 2 with timer 2 being serviced?
<br/>
<br/>
Thanks
<br/>
GbaWIZ</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#19024 - poslundc - Sat Apr 10, 2004 1:05 pm</h4>
    <div class="postbody"><span class="postbody">I am responding to this in a different topic... I don't know why you would put it as a reply to this one.
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#19029 - gbawiz - Sat Apr 10, 2004 1:31 pm</h4>
    <div class="postbody"><span class="postbody"><a href="http://forum.gbadev.org/viewtopic.php?p=19026&amp;highlight=#19026" target="_blank">http://forum.gbadev.org/viewtopic.php?p=19026&amp;highlight=#19026</a></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
