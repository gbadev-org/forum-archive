<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Atomic Compare-and-Swap operation on the ARM9? - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>ASM > Atomic Compare-and-Swap operation on the ARM9?</h2>
<div id="posts">
<div class="post">
    <h4>#174964 - shotgunninja - Tue Aug 10, 2010 6:06 pm</h4>
    <div class="postbody"><span class="postbody">Hello, my name is Nick, and I've been working on a game engine for the DS in (gasp) C/C++. However, I'm trying to add Interrupt-Safe (aka Thread-Safe, but for Interrupt Handlers) data structures to my engine, and in order to make them truly safe 100% of the time, I need to have access to an atomic Compare-and-Swap instruction. Is there one in the instruction set of the DS' ARM9 processor?
<br/>
<br/>
Essentially, I need to be able to do this without interrupting and WITHOUT DISABLING REG_IME:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
// As a C function:
<br/>
bool CompareAndSwap(uint32&amp; dest, uint32 oldVal, uint32 newVal) {
<br/>
   if (dest != oldVal) {
<br/>
      return false;
<br/>
   } else {
<br/>
      dest = newVal;
<br/>
      return true;
<br/>
   }
<br/>
}
<br/>
// As register pseudocode:
<br/>
CAS(Rd,Ro,Rn):
<br/>
   SREG[EQ] := (Rd EQ Ro);
<br/>
   Rd := Rn if (Rd EQ Ro);
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#174968 - elhobbs - Tue Aug 10, 2010 7:58 pm</h4>
    <div class="postbody"><span class="postbody">what about swp(b)?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#174971 - Pate - Wed Aug 11, 2010 5:41 am</h4>
    <div class="postbody"><span class="postbody">The ARM ARM section 9.5 shows a code snippet for creating a semaphore. There is no atomic compare-and-conditional-write in ARM, so achieving similar result needs some additional code.
<br/>
<br/>
The example does not produce lock-free data access, but as you mention in the other thread, perhaps you don't actually need to lock the access fully as you know that only the interrupt routine can interrupt the main "thread", not the other way around.
<br/>
<br/>
Pate<br/>_________________<br/><ul><li>Now working on DSx86 <a href="http://dsx86.patrickaalto.com" target="_blank">http://dsx86.patrickaalto.com</a>
<br/>
</li><li>Get LineWarsDS from <a href="http://linewars.patrickaalto.com" target="_blank">http://linewars.patrickaalto.com</a></li></ul></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#175022 - LOst? - Tue Aug 17, 2010 12:10 am</h4>
    <div class="postbody"><span class="postbody">I would also want to know this!
<br/>
<br/>
So far my guessing haven't produced anything that works. 
<br/>
<br/>
I basically want all the InterlockedExchange, InterlockedCompareExchange, InterlockedIncrement, etc in ARM assembler callable from C. 
<br/>
<br/>
I tried this for InterlockedExchange:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
   .arch   armv5te
<br/>
   .cpu   arm946e-s
<br/>
   
<br/>
   .text
<br/>
   .arm
<br/>
   
<br/>
   .global   InterlockedExchange
<br/>
InterlockedExchange:
<br/>
   swp r1, r1, [r0]
<br/>
   mov r0,r1
<br/>
<br/>
   .end
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
extern "C" s32 InterlockedExchange (s32 volatile* Target, s32 Value);
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
The code sure exchanges the two long values as Target becomes Value, but the returned value is not correct (I think).
<br/>
<br/>
Feel free to laugh, as I know 1% of ARM assembler. Mostly trying to patch code from different sites:
<br/>
<a href="http://src.gnu-darwin.org/ports/lang/fpc/work/fpc-2.2.0/rtl/arm/arm.inc.html" target="_blank">http://src.gnu-darwin.org/ports/lang/fpc/work/fpc-2.2.0/rtl/arm/arm.inc.html</a>
<br/>
<a href="http://www.netmite.com/android/mydroid/1.0/external/androidmono/mono/libgc/include/private/gc_locks.h" target="_blank">http://www.netmite.com/android/mydroid/1.0/external/androidmono/mono/libgc/include/private/gc_locks.h</a>
<br/>
<a href="http://msdn.microsoft.com/en-us/library/ms683590" target="_blank">http://msdn.microsoft.com/en-us/library/ms683590</a>(VS.85).aspx
<br/>
<br/>
In the end, I want to implement a semaphore class for the NDS.<br/>_________________<br/><span style="font-style: italic">Exceptions are fun</span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#175023 - Pate - Tue Aug 17, 2010 4:55 am</h4>
    <div class="postbody"><span class="postbody">The code looks correct in principle, but adding a return at the end might help. Like this:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
InterlockedExchange: 
<br/>
    swp     r1, r1, [r0] 
<br/>
    mov     r0,r1
<br/>
    bx      lr
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I haven't actually used .end in my own ASM code, so I am not sure if that is smart enough to add the return code if it is missing, but spelling it out is OK also in that case.
<br/>
<br/>
You can also reduce the code to plain
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
    swp    r0, r0, [r1]
<br/>
    bx     lr
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
if you swap the parameters, but if you want to keep the current parameter order (for compatibility with other software) your current code is fine.
<br/>
<br/>
Hope this helps!
<br/>
<br/>
Pate<br/>_________________<br/><ul><li>Now working on DSx86 <a href="http://dsx86.patrickaalto.com" target="_blank">http://dsx86.patrickaalto.com</a>
<br/>
</li><li>Get LineWarsDS from <a href="http://linewars.patrickaalto.com" target="_blank">http://linewars.patrickaalto.com</a></li></ul></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#175024 - LOst? - Tue Aug 17, 2010 6:37 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Pate wrote:</b></span></td> </tr> <tr> <td class="quote">The code looks correct in principle, but adding a return at the end might help. Like this:
<br/>
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
InterlockedExchange: 
<br/>
    swp     r1, r1, [r0] 
<br/>
    mov     r0,r1
<br/>
    bx      lr
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I haven't actually used .end in my own ASM code, so I am not sure if that is smart enough to add the return code if it is missing, but spelling it out is OK also in that case.
<br/>
<br/>
You can also reduce the code to plain
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
    swp    r0, r0, [r1]
<br/>
    bx     lr
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
if you swap the parameters, but if you want to keep the current parameter order (for compatibility with other software) your current code is fine.
<br/>
<br/>
Hope this helps!
<br/>
<br/>
Pate</span></td> </tr></table><span class="postbody">
<br/>
The bx lr worked! Thanks!
<br/>
<br/>
Because the volatile pointer to the long value is sent through R0, and not R1 as your example did, this code is what finally did it:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
   .arch   armv5te
<br/>
   .cpu   arm946e-s
<br/>
   
<br/>
   .text
<br/>
   .arm
<br/>
   
<br/>
   .global   InterlockedExchange
<br/>
InterlockedExchange:
<br/>
   swp      r1, r1, [r0]   
<br/>
   mov      r0, r1
<br/>
   bx      lr
<br/>
<br/>
   .end
<br/>
</td> </tr></table><span class="postbody"><br/>_________________<br/><span style="font-style: italic">Exceptions are fun</span></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
