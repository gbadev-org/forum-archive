<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Direct Sound in ASM - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>ASM > Direct Sound in ASM</h2>
<div id="posts">
<div class="post">
    <h4>#178085 - chickendude - Sat Sep 21, 2013 9:12 pm</h4>
    <div class="postbody"><span class="postbody">I'm trying to get direct sound set up but it never seems to play anything. I've read a bunch of different tutorials online but can't piece it together. Nothing comes out of the speakers.
<br/>
<br/>
Right now here's a bit of C code i'm trying to replicate:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">REG_SOUNDCNT_H = SOUNDA_VOLUME_100 | SOUNDA_LOUT | SOUNDA_ROUT | SOUNDA_FIFORESET;   // = 0x0604
<br/>
REG_SOUNDCNT_X = SOUND_ENABLE;   // = 0x80
<br/>
REG_TM0D = 65536 - (16777216 / soundFreq);
<br/>
REG_TM0CNT = TIMER_ENABLE;   // = 0x80
<br/>
REG_DM1SAD = (u32) soundDataAddr;
<br/>
REG_DM1DAD = (u32) &amp;(REG_SGFIFOA);   // **** Maybe i'm getting this wrong? I don't know what this code actually means in C :/
<br/>
REG_DM1CNT_H = DMA_DEST_FIXED | DMA_REPEAT | DMA_WORD | DMA_MODE_FIFO | DMA_ENABLE;   // = 0xB640</td> </tr></table><span class="postbody">
<br/>
Here's what i've got so far:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">main:
<br/>
@ Turn off sound channels 1-4
<br/>
   ldr r0,=REG_SOUNDCNT_L
<br/>
   mov r1,#0
<br/>
@   str r1,[r0]
<br/>
<br/>
@ Enable DSA, full volume, using Timer 0
<br/>
   ldr r0,=REG_SOUNDCNT_H
<br/>
   ldr r1,=0x0604 @ SND_OUTPUT_RATIO_100|DSA_OUTPUT_RATIO_100|DSA_OUTPUT_TO_BOTH|DSA_TIMER0|DSA_FIFO_RESET
<br/>
   str r1,[r0]
<br/>
<br/>
   ldr r0,=REG_SOUNDCNT_X
<br/>
   ldr r1,=0x80 @SND_ENABLED
<br/>
   str r1,[r0]
<br/>
<br/>
   ldr r0,=REG_TM0D
<br/>
   ldr r1,=0xFFFF - 761   @ CPU pulls one byte every 761 cycles
<br/>
   str r1,[r0]
<br/>
<br/>
   ldr r0,=REG_TM0CNT
<br/>
   ldr r1,=0x80 @TIMER_ENABLE
<br/>
   str r1,[r0]
<br/>
<br/>
   ldr r0,=REG_DMA1SAD
<br/>
   ldr r1,=music
<br/>
   str r1,[r0]
<br/>
<br/>
   ldr r0,=REG_DMA1DAD
<br/>
   ldr r1,=REG_FIFO_A
<br/>
   str r1,[r0]
<br/>
<br/>
   ldr r0,=REG_DMA1CNT
<br/>
   ldr r1,=0xB640 @DMA_ENABLE|START_ON_FIFO_EMPTY|DMA_16|DMA_REPEAT|DMA_DEST_FIXED
<br/>
   str r1,[r0]
<br/>
<br/>
here:
<br/>
   bl here</td> </tr></table><span class="postbody">I put some junk data at "music:" but it doesn't play anything :/</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#178094 - headspin - Sun Sep 22, 2013 2:04 pm</h4>
    <div class="postbody"><span class="postbody">Check out the sound demo <a class="postlink" href="http://greatflash.co.uk/index.php?topic=67.0" target="_blank">here</a><br/>_________________<br/><a class="postlink" href="http://headsoft.com.au/index.php?category=warhawk" target="_blank">Warhawk DS</a> | <a class="postlink" href="http://headsoft.com.au/index.php?category=mmll" target="_blank">Manic Miner: The Lost Levels</a> | <a class="postlink" href="http://headsoft.com.au/index.php?category=tdg" target="_blank">The Detective Game</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#178098 - DekuTree64 - Mon Sep 23, 2013 9:34 pm</h4>
    <div class="postbody"><span class="postbody">You need to use strh for the 16-bit registers.<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#178099 - chickendude - Tue Sep 24, 2013 2:07 pm</h4>
    <div class="postbody"><span class="postbody">Thanks for both your suggestions. I've gotten sound effects to work with the sound channels, but i couldn''t get direct sound to work. Also thanks for the reminder on the half-words, it's been a while since i've touched ARM assembly...
<br/>
<br/>
I figured out what the issue was, i was writing to REG_DMA1CNT (REG_DMA1CNT_L) instead of the high byte(s).
<br/>
<br/>
Now to figure out how to write actual music to put in there... :D
<br/>
<br/>
EDIT: Btw, for background music in a game, how is it generally handled? I assumed it was using direct sound but i'm not really sure. And how do you compose music for the GBA?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#178100 - Dwedit - Tue Sep 24, 2013 7:19 pm</h4>
    <div class="postbody"><span class="postbody">If you want a very nice GBA music and sound library, try Maxmod.  It's a mod player engine for the GBA/DS, which also lets you play additional sampled sound effects as well.  It comes included with devkitarm.  It's also very low on CPU usage, playing the famous "aryx.s3m" file uses under 25% CPU usage.<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#178101 - chickendude - Tue Sep 24, 2013 7:48 pm</h4>
    <div class="postbody"><span class="postbody">Thanks, that looks and sounds great, but for now i'd like to try my hand at writing my own routines. I see some example files that use it (as well as mmutil), but i don't see anywhere to check out the actual maxmod source.
<br/>
<br/>
The songs in the sample rom on the Maxmod site sound amazing, are they played using direct sound? And how are they written? Online i've read things talking about "instrument sets" and other things which make it sound a little like midi files, but i really don't know. I'll try reading through the information on belogic, but a lot of it is a bit confusing to me.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#178102 - DekuTree64 - Tue Sep 24, 2013 9:32 pm</h4>
    <div class="postbody"><span class="postbody">Lots of ways to go. Some games use the GBC channels for music and direct sound for SFX. My current NES-ish style game uses one direct sound channel for music (4 channel .mod format with a sound mixer), and GBC channels and the other direct sound for SFX. Most games, I'd do an 8-channel stereo mixer, and use it for both music and SFX. All depends on how much CPU time you want to devote to it, and what sort of quality you need for the sound effect/music style of your game.
<br/>
<br/>
As for learning to write your own routines, there's always my old tutorial series if you haven't run across it already :) <a class="postlink" href="http://deku.rydia.net/program/sound1.html" target="_blank">http://deku.rydia.net/program/sound1.html</a>
<br/>
<br/>
I need to write another chapter on my latest mixer, to show off some assembly optimizing. But for now, you can just peruse the source if you want. The music player is all the same as the tutorial, aside from how it sets up the mixer channels being a bit different.
<br/>
<a class="postlink" href="http://deku.rydia.net/temp/SoundMix.s" target="_blank">http://deku.rydia.net/temp/SoundMix.s</a>
<br/>
<a class="postlink" href="http://deku.rydia.net/temp/Sound.h" target="_blank">http://deku.rydia.net/temp/Sound.h</a>
<br/>
<br/>
.s3m/.xm/.it formats can make better sounding music than .mod, but the player code is a lot more complex, particularly in the case of .it.  Here's my current PC game sound engine, which uses .it format... haven't worked on it in several years so I don't remember exactly what state it's in at the moment. I'm pretty sure the music player is complete, with all effects and fiddly timing issues as accurate to WinAmp 2.95 as I can get them. <a class="postlink" href="http://deku.rydia.net/temp/PC_Sound.zip" target="_blank">http://deku.rydia.net/temp/PC_Sound.zip</a>
<br/>
<br/>
For music composition, I use ModPlug Tracker. But first you'll have to find/make some .wav files to use as instruments. Here's my current chiptune single-cycle wave set:
<br/>
<a class="postlink" href="http://deku.rydia.net/temp/Waves.mod" target="_blank">http://deku.rydia.net/temp/Waves.mod</a>
<br/>
Still working on sound effect generation techniques...
<br/>
<br/>
As always, my code and sounds are free for anyone to use, no credit needed.<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#178103 - chickendude - Tue Sep 24, 2013 10:51 pm</h4>
    <div class="postbody"><span class="postbody">Thanks! I've been going through your tutorial and this one here:
<br/>
<a href="http://archive.gamedev.net/archive/reference/programming/features/gbasound1/index.html" target="_blank">http://archive.gamedev.net/archive/reference/programming/features/gbasound1/index.html</a>
<br/>
<br/>
I'll try to look through it all more thoroughly tomorrow, in particular your SoundMix code (assembly code is much easier for me to read than C code).
<br/>
<br/>
I can't wait to get some music i've written myself going on my GBA :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#178104 - Dwedit - Wed Sep 25, 2013 2:16 am</h4>
    <div class="postbody"><span class="postbody">Maxmod source code is there with the rest of devkitpro:
<br/>
<br/>
<a href="http://sourceforge.net/p/devkitpro/maxmod/ci/master/tree/" target="_blank">http://sourceforge.net/p/devkitpro/maxmod/ci/master/tree/</a>
<br/>
<br/>
And it's almost all in assembly.<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#178105 - chickendude - Wed Sep 25, 2013 9:06 am</h4>
    <div class="postbody"><span class="postbody">Wow, thanks! I guess it makes sense that the source wouldn't be there after compiling devkitPro/deleting the sources ;)</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
