<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>swi 05 - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>ASM > swi 05</h2>
<div id="posts">
<div class="post">
    <h4>#23431 - MothAttack - Mon Jul 12, 2004 6:11 pm</h4>
    <div class="postbody"><span class="postbody">I'm having trouble with swi 05.  Imagine the following very, very simple program (written for clarity, mind you):
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">@ load up an interrupt handler
<br/>
ldr r0, =0x03007ffc
<br/>
ldr r1, =my_interrupt_handler
<br/>
str r1, [r0]
<br/>
<br/>
@ enable vblank interrupt
<br/>
ldr r0, =0x04000200
<br/>
mov r1, #1
<br/>
strh r1, [r0]
<br/>
<br/>
@ enable master interrupt
<br/>
ldr r0, =0x04000208
<br/>
mov r1, #1
<br/>
strh r1, [r0]
<br/>
<br/>
swi 0x00050000
<br/>
<br/>
&lt;do something noticeable, like plotting a pixel or something&gt;</td> </tr></table><span class="postbody">
<br/>
<br/>
If I run this, nothing noticeable happens.  In fact, my_interrupt_handler never gets called.  It seems that the vblank interrupt doesn't occur.  If I enable a timer, for example, then my_interrupt_handler will get called.  Is there something else I have to do to get vblanks to cause interrupts?  Or to get vblanks to occur at all?  (Enabling a video mode doesn't help.)  Or is this just an emulator problem?  (I'm using VisualboyAdvance.)
<br/>
<br/>
<br/>
<br/>
EDIT:
<br/>
Oops...  Never mind.  There is something else I have to do...namely:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">@ enable vblank interrupt in a different place
<br/>
ldr r0, =0x04000004
<br/>
mov r1, #8
<br/>
strh r1, [r0]</td> </tr></table><span class="postbody">
<br/>
<br/>
So, there you go.  Well, I'll leave this post here for others to learn from.  (Yeah, that's it...)  Any moderators can delete it if they want...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#25428 - [mRg] - Sun Aug 22, 2004 8:17 pm</h4>
    <div class="postbody"><span class="postbody">Could someone post  (or link to) a full example of how to use swi 5 in asm so I can replace my current Vblank routine with a nice powersaving one :)
<br/>
<br/>
I understand how to set up the interupts (from the exmaple by MothAttack) and why they need to be set up but I am unsure what code needs to be in the interrupt handler.
<br/>
<br/>
Am I branching to my main routine or do I just need to pass some data back to say that the interrupt has been handled (I tried the example on gbaguys asm tutorial but its not too clear) if so how do I do that :)
<br/>
<br/>
Just reading the FAQ on Devrs do I need to save any registers Im using before I call the SWI or is that for soemthing else? 
<br/>
<br/>
Sorry to sound a bit thick but any help or examples to clarify this would be greatly received.
<br/>
<br/>
TIA
<br/>
<br/>
[mRg]</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#25439 - Cearn - Sun Aug 22, 2004 10:46 pm</h4>
    <div class="postbody"><span class="postbody">In addition to aknowledging the interrupt in REG_IF, the BIOS routines also require you to set that bit in the BIOS version of that register at location 0x03fffff8. See <a class="postlink" href="http://forum.gbadev.org/viewtopic.php?t=1544" target="_blank">http://forum.gbadev.org/viewtopic.php?t=1544</a> for a little more detail. There are a number of similar threads on this all around the forum too. To see how this could be set up in ASM, get libgba from <a class="postlink" href="http://www.devkit.tk" target="_blank">www.devkit.tk</a>.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#25490 - [mRg] - Tue Aug 24, 2004 1:10 am</h4>
    <div class="postbody"><span class="postbody">Magic ! 
<br/>
<br/>
Thats fixed it .. thanks Cearn :)
<br/>
<br/>
My code for peoples future reference ... 
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
<br/>
@--------------------------------------------------------
<br/>
@ Interrupt setup 
<br/>
@--------------------------------------------------------    
<br/>
<br/>
         ldr r0, =REG_IME                       @ enable master interrupt
<br/>
         mov r1, #INT_ENABLE
<br/>
         strh r1, [r0]
<br/>
         
<br/>
         ldr r0, =REG_INTADDR                     @ load up an interrupt handler
<br/>
         ldr r1, =intr_handler
<br/>
         str r1, [r0]
<br/>
<br/>
         ldr r0, =REG_IE                              @ enable vblank
<br/>
         ldr r1, =INT_VBLANK
<br/>
         strh r1, [r0]
<br/>
      
<br/>
         ldr r0, =REG_DISPSTAT                     @ enable vblank interrupt
<br/>
         mov r1, #STAT_VBLANK
<br/>
         strh r1, [r0]
<br/>
<br/>
@--------------------------------------------------------
<br/>
@ Main infinite loop
<br/>
@--------------------------------------------------------         
<br/>
<br/>
infin:
<br/>
         
<br/>
         swi 0x50000
<br/>
         
<br/>
         b infin                                                  @ BRANCH - infinite loop
<br/>
<br/>
@--------------------------------------------------------
<br/>
@ End main program !
<br/>
@--------------------------------------------------------
<br/>
<br/>
@--------------------------------------------------------
<br/>
@ Interupt Handler
<br/>
@--------------------------------------------------------
<br/>
<br/>
intr_handler:
<br/>
<br/>
         ldr r0, =REG_IME                 @ disable master interrupt
<br/>
         mov r1, #0
<br/>
         strh r1, [r0]
<br/>
       
<br/>
          ldr r2, =0x03fffff8               @ let the bios know that vblank occurred
<br/>
 
<br/>
          ldr r0, =REG_IF                     @ Load in current flag
<br/>
          ldrh r1, [r0]
<br/>
          
<br/>
         cmp r1, #INT_VBLANK               @ Check if its vblank
<br/>
          streqh r1, [r2]
<br/>
<br/>
         ldr r0, =REG_IF                     @ Unset the flag by writing a 1 to that bit
<br/>
         mov r1, #1
<br/>
         strh r1, [r0]
<br/>
<br/>
         ldr r0, =REG_IME                 @ re-enable master interrupt
<br/>
         mov r1, #1
<br/>
         strh r1, [r0]
<br/>
         
<br/>
         bx lr
<br/>
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Now i just gotta get this bloody mod player to work :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#25500 - dagamer34 - Tue Aug 24, 2004 3:44 am</h4>
    <div class="postbody"><span class="postbody">In the future, you should take a look at the FAQ. I actually had to get tepples to add this problem to the FAQ recently. I also had a problem like this.
<br/>
<br/>
It makes me wonder, does ANYONE actually look at the FAQ before asking a question? I'll admit that I usually don't... :)<br/>_________________<br/>Little kids and Playstation 2's don't mix. :(</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#25515 - [mRg] - Tue Aug 24, 2004 9:08 am</h4>
    <div class="postbody"><span class="postbody">True .. I should have read the FAQ (just found it ! .. I heard people talk of the fabled FAQ before and I thought it was the one that links from the top of the page and had thought 'whats's the use of this for coding ?')
<br/>
<br/>
In my defence there wasnt a beginners section last time I was on this board, so it wasnt the first place I looked :?) (no excuse I know .. but ill know for next time !)
<br/>
<br/>
Thanks for not flaming me for being a blind l4m0r :?)
<br/>
<br/>
[mRg]</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
