<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Direct Sound sample won't play - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>ASM > Direct Sound sample won't play</h2>
<div id="posts">
<div class="post">
    <h4>#1892 - GbaGuy - Sat Jan 25, 2003 3:22 am</h4>
    <div class="postbody"><span class="postbody">I rewrote the direct sound sample code in ASM (from BeLogic.com)
<br/>
and came up with this, but it doesn't appear to work (using VisualBoyAdvance):
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
@include dma.h
<br/>
@include dirsound.h
<br/>
@include timer.h
<br/>
@include interrupt.h
<br/>
b start
<br/>
THE_WAV
<br/>
@incbin wav.raw
<br/>
start
<br/>
<br/>
ldr r4,= REG_SOUNDCNT_H
<br/>
ldr r5,= 0x0B0F
<br/>
strh r5,[r4]
<br/>
<br/>
ldr r4, =REG_SOUNDCNT_X
<br/>
ldr r5, =0x0080
<br/>
strh r5,[r4]
<br/>
<br/>
ldr r4,=REG_DMA1SAD
<br/>
ldr r5,=THE_WAV
<br/>
str r5,[r4]
<br/>
<br/>
ldr r4,=REG_DMA1DAD
<br/>
ldr r5,=0x040000a0
<br/>
str r5,[r4]
<br/>
<br/>
ldr r4,= REG_DMA1CNT
<br/>
ldr r5,= 0xb600 | DMA_32NOW
<br/>
strh r5,[r4]
<br/>
<br/>
ldr r4, = REG_TM0D
<br/>
ldr r5,= 0x7098
<br/>
strh r5,[r4]
<br/>
<br/>
ldr r4, = REG_TM0CNT
<br/>
ldr r5, = 0xC4
<br/>
strh r5,[r4]
<br/>
<br/>
ldr r4, = REG_INTADDR
<br/>
ldr r5, = Handler
<br/>
str r5,[r4]
<br/>
<br/>
ldr r4, = REG_IE
<br/>
ldr r5, = 0x10
<br/>
strh r5,[r4]
<br/>
<br/>
ldr r4, = REG_IME
<br/>
ldr r5, = 0x1
<br/>
strh r5,[r4]
<br/>
<br/>
ldr r4, = REG_TM0D
<br/>
ldr r5, = 0xFBE8
<br/>
strh r5,[r4]
<br/>
<br/>
ldr r4, = REG_TM0CNT
<br/>
ldr r5, = 0x0080
<br/>
strh r5,[r4]
<br/>
<br/>
infin
<br/>
b infin
<br/>
<br/>
Handler:
<br/>
   ldr r1,=0
<br/>
   ldr r2,=REG_DMA1CNT
<br/>
   str r1,[r2]
<br/>
   ldr r2,=REG_TM0CNT
<br/>
   str r1,[r2]
<br/>
<br/>
   ldr r2,=REG_IF
<br/>
   str r1,[r2]
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
<br/>
Please help.
<br/>
<br/>
Thanks,
<br/>
- GbaGuy</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#1895 - Splam - Sat Jan 25, 2003 4:30 am</h4>
    <div class="postbody"><span class="postbody">Is that all the code or did you miss a bit off?  ie How do you return from the interrupt?  bx lr maybe?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#1896 - GbaGuy - Sat Jan 25, 2003 4:36 am</h4>
    <div class="postbody"><span class="postbody">Are you sure it's bx lr ?
<br/>
<br/>
I'm not sure, but I had it in my head that clearing REG_IF would return
<br/>
from the interrupt.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#1911 - Splam - Sat Jan 25, 2003 5:06 pm</h4>
    <div class="postbody"><span class="postbody">I've just woken up so forgive me if this is wrong but,
<br/>
<br/>
When an interrupt occurs the BIOS catches it, vectors to its interrupt handler which then pushes r0-r3, r12 and lr, fetches the interrupt vector at 0x3007ffc and reads the contents of that into the PC which then causes the processor to run your code.  When you've finished your code you then need to get back to the exit part of the bios routine which is done with bx lr, the bios then pulls those registers from the stack and sets the PC back to what it was b4 the interrupt.  Clearing REG_IF is only to tell the gba that you've handled that interrupt (so another one can occur), it won't do anything about exiting the interrupt routine.
<br/>
<br/>
Having said that, because you're playing a sample straight from rom and not mixing it into a buffer you should at least hear the sample once, which is what you seem to be wanting anyway as the interrupt handler stops the dma and timer, so if it's playing nothing then it's something else wrong too ;)  It's just hard to spot something written in asm with "magic numbers" everywhere.  I'll have a look at your code some more and convert the hex ldr's so I can see what you're putting in all the dma and timer registers.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#1918 - DekuTree64 - Sat Jan 25, 2003 8:06 pm</h4>
    <div class="postbody"><span class="postbody">Hmm, I don't really know what it's supposed to do, but it looks like the interrupt is to stop the sound when it's done? Looks like you set your timer up right, then set IE and IME, and then set the same timer for the sound frequency, so the interrupt is never being called. 
<br/>
And I'd need to see the definition of DMA_32NOW to be sure, but do you have it set to dest fixed (bit 6)? If not then you're going through all sorts of registers setting them to the sound data, which is of course not a good thing to do.
<br/>
<br/>
So to fix it, use a different timer for the interrupt (and Splam is right, you should have a bx lr at the end ofthe interrupt), and set bit 6 in DMA1CNT.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#1929 - GbaGuy - Sun Jan 26, 2003 3:01 am</h4>
    <div class="postbody"><span class="postbody">Alright, I took out the timer stuff and the interrupt handler. Also, now
<br/>
I set everything in REG_SOUNDCNT_H which should allow both FIFOs
<br/>
to go if I wanted them to (only need 1).
<br/>
<br/>
So, by elimination, it has to be the DMA transfer.
<br/>
<br/>
Also, it angers me that I translated all this from the C sample code at
<br/>
<a href="http://www.belogic.com," target="_blank">www.belogic.com,</a> and it doesn't work...
<br/>
<br/>
Here's the new code:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
<br/>
@include dma.h
<br/>
@include dirsound.h
<br/>
@include timer.h
<br/>
@include interrupt.h
<br/>
b start
<br/>
THE_WAV
<br/>
@incbin wav.raw
<br/>
start
<br/>
<br/>
ldr r4,= REG_SOUNDCNT_L 
<br/>
ldr r5,= 0              
<br/>
strh r5,[r4]
<br/>
<br/>
ldr r4,= REG_SOUNDCNT_H  
<br/>
ldr r5,= 0xFFFF
<br/>
strh r5,[r4]
<br/>
<br/>
ldr r4, =REG_SOUNDCNT_X
<br/>
ldr r5, =0x00000080
<br/>
str r5,[r4]
<br/>
<br/>
ldr r4,=REG_DMA1SAD
<br/>
ldr r5,=THE_WAV
<br/>
str r5,[r4]
<br/>
<br/>
ldr r4,=REG_DMA1DAD
<br/>
ldr r5,=0x40000a0
<br/>
str r5,[r4]
<br/>
<br/>
ldr r4,= REG_DMA1CNT
<br/>
ldr r5,= 0xb600  ; according to BeLogic, this number is :
<br/>
strh r5,[r4]        ; DMA enabled+ start on FIFO+32bit+repeat 
<br/>
<br/>
; further more, I've tried ORing 0xb600 with DMA_DEST_FIXED, but
<br/>
; that didn't work either.
<br/>
<br/>
infin
<br/>
b infin
<br/>
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
<br/>
In theory, I should atleast hear the entire sound once, right?
<br/>
But I don't hear anything...
<br/>
<br/>
thanks for you help so far,
<br/>
- GbaGuy</span><span class="gensmall"><br/><br/>Last edited by GbaGuy on Sun Jan 26, 2003 8:03 pm; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#1946 - Splam - Sun Jan 26, 2003 2:16 pm</h4>
    <div class="postbody"><span class="postbody">Well, having looked at the example code on the BeLogic site you seem to have made the mistake of setting up a timer for the dma and a cascade timer (the one that tells you when the sample is complete) BUT used timer0 for both of them..  Quite probably whats causing the problem if the C example works and your asm one doesn't.  Hope that fixes it for you ;)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#1947 - DekuTree64 - Sun Jan 26, 2003 5:48 pm</h4>
    <div class="postbody"><span class="postbody">Ok, assembly is hard to explain every little detail of how to fix, so I just made the changes myself. I haven't tested it, but try it out and see if it works. If it doesn't, then I'm just as clueless as you^_^
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
@include dma.h 
<br/>
@include dirsound.h 
<br/>
@include timer.h 
<br/>
@include interrupt.h 
<br/>
b start 
<br/>
THE_WAV 
<br/>
@incbin wav.raw 
<br/>
start 
<br/>
<br/>
ldr r4,= REG_SOUNDCNT_H 
<br/>
ldr r5,= 0x0B0F ;setting this to 0xffff was setting the timer bit as well, which makes it use TM2 instead of TM1
<br/>
strh r5,[r4] 
<br/>
<br/>
ldr r4, =REG_SOUNDCNT_X 
<br/>
ldr r5, =0x0080 
<br/>
strh r5,[r4] 
<br/>
<br/>
ldr r4,=REG_DMA1SAD 
<br/>
ldr r5,=THE_WAV 
<br/>
str r5,[r4] 
<br/>
<br/>
ldr r4,=REG_DMA1DAD 
<br/>
ldr r5,=0x040000a0 
<br/>
str r5,[r4] 
<br/>
<br/>
ldr r4,= REG_DMA1CNT 
<br/>
ldr r5,= 0xb640 ;this has dest fixed set
<br/>
strh r5,[r4] 
<br/>
<br/>
ldr r4, = REG_TM0D ;and this is for the sound frequency, so it needs to be here
<br/>
ldr r5, = 0xFBE8 
<br/>
strh r5,[r4] 
<br/>
<br/>
ldr r4, = REG_TM0CNT 
<br/>
ldr r5, = 0x0080 
<br/>
strh r5,[r4] 
<br/>
<br/>
infin 
<br/>
b infin 
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#1949 - Splam - Sun Jan 26, 2003 6:16 pm</h4>
    <div class="postbody"><span class="postbody">The original code posted was ok so I'd suggest using that  EXCEPT it needs bx lr at the end of interrupt code AND change the TM0 to TM1.  Just read the C source again and see which one..</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
