<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Can anyone help me porting x86 asm? - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>ASM > Can anyone help me porting x86 asm?</h2>
<div id="posts">
<div class="post">
    <h4>#46663 - Locke - Tue Jun 28, 2005 9:59 pm</h4>
    <div class="postbody"><span class="postbody">I'm trying to port a jpeg decoder to the NintendoDS, but I found some asm functions in the original source and I don't know how to handle them.
<br/>
<br/>
I don't want to start learning x86 asm only to translate 20 lines, so if any of you can write this 3 functions in plain C I will be very gratefull (of course I will give credit for the work in the readme)
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#ifdef _MSC_VER
<br/>
WORD lookKbits(BYTE k)
<br/>
{
<br/>
 _asm {
<br/>
    mov dl, k
<br/>
    mov cl, 16
<br/>
    sub cl, dl
<br/>
    mov eax, [wordval]
<br/>
    shr eax, cl
<br/>
 }
<br/>
}
<br/>
<br/>
WORD WORD_hi_lo(BYTE byte_high,BYTE byte_low)
<br/>
{
<br/>
   _asm {
<br/>
        mov ah,byte_high
<br/>
        mov al,byte_low
<br/>
       }
<br/>
}
<br/>
SWORD get_svalue(BYTE k)
<br/>
// k&gt;0 always
<br/>
// Takes k bits out of the BIT stream (wordval), and makes them a signed value
<br/>
{
<br/>
   _asm {
<br/>
         xor ecx, ecx
<br/>
         mov cl,k
<br/>
         mov eax,[wordval]
<br/>
         shl eax,cl
<br/>
         shr eax, 16
<br/>
         dec cl
<br/>
         bt eax,ecx
<br/>
         jc end_macro
<br/>
   signed_value:inc cl
<br/>
         mov ebx,[start_neg_pow2]
<br/>
         add ax,word ptr [ebx+ecx*2]
<br/>
       end_macro:
<br/>
   }
<br/>
}
<br/>
#endif</td> </tr></table><span class="postbody">
<br/>
<br/>
Where BYTE = unsigned char; WORD = unsigned short int; SWORD = signed short int; DWORD = unsigned int; wordval = DWORD; start_neg_pow2 = DWORD;
<br/>
<br/>
<br/>
Thanks for your time.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#46665 - sajiimori - Tue Jun 28, 2005 10:14 pm</h4>
    <div class="postbody"><span class="postbody">It's hard to say what the C equivalent would be because the preconditions and postconditions aren't clear.  It's possible that there is no C code that does exactly what is needed of these routines because in C you can't control the exact contents of the registers.
<br/>
<br/>
For example, in WORD_hi_lo, I don't know if the upper 16 bits of eax are presumed to be clear on entry, or if they are meant to be retained.  In the latter case, a C version cannot be written.
<br/>
<br/>
x86 is a pain.  :/</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#46666 - gladius - Tue Jun 28, 2005 10:15 pm</h4>
    <div class="postbody"><span class="postbody">No guarantee's as my x86 asm is a bit rusty, but I think this is correct.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
WORD lookKbits(BYTE k) 
<br/>
{ 
<br/>
 return wordval &gt;&gt; (16 - k);
<br/>
} 
<br/>
<br/>
WORD WORD_hi_lo(BYTE byte_high,BYTE byte_low) 
<br/>
{ 
<br/>
 return ((WORD)byte_high &lt;&lt; 8) | byte_low;
<br/>
}
<br/>
<br/>
// k&gt;0 always 
<br/>
// Takes k bits out of the BIT stream (wordval), and makes them a signed value 
<br/>
SWORD get_svalue(BYTE k) 
<br/>
{ 
<br/>
 DWORD tmp = ((DWORD)wordval &lt;&lt; k) &gt;&gt; 16;
<br/>
 if (tmp &amp; (1 &lt;&lt; (k - 1))) tmp += start_neg_pow2[k];
<br/>
 return (SWORD)tmp;
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
sajiimori: I think the intent is clear at least.  I can't even remember if the top 16 bits are guaranteed to be preserved when there is a return value in ax though.</span><span class="gensmall"><br/><br/>Last edited by gladius on Tue Jun 28, 2005 10:20 pm; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#46667 - headspin - Tue Jun 28, 2005 10:19 pm</h4>
    <div class="postbody"><span class="postbody">Why re-invent the wheel? There is a working jpeg decoder at <a href="http://headkaze.webpal.info/" target="_blank">http://headkaze.webpal.info/</a> for the DS that should be more than sufficient for any jpeg decoding needs (It's very fast running from IWRAM).<br/>_________________<br/><a class="postlink" href="http://headsoft.com.au/index.php?category=warhawk" target="_blank">Warhawk DS</a> | <a class="postlink" href="http://headsoft.com.au/index.php?category=mmll" target="_blank">Manic Miner: The Lost Levels</a> | <a class="postlink" href="http://headsoft.com.au/index.php?category=tdg" target="_blank">The Detective Game</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#46675 - Locke - Tue Jun 28, 2005 11:23 pm</h4>
    <div class="postbody"><span class="postbody">Thanks, I will try both decoders and use the most suitable for my pourposes.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#46716 - Locke - Wed Jun 29, 2005 11:57 am</h4>
    <div class="postbody"><span class="postbody">headspin, your jpeg decoder doesn't work when loading something bigger than 256 width. I get black lines interpolated with the image data... I'm decoding the full jpeg into main memory and then copying the focused region to VRAM (using framebuffer). Did you know about this issue?
<br/>
<br/>
<br/>
gladius, It seems to be some problem with your code. I get an error in this line:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">if (tmp &amp; (1 &lt;&lt; (k - 1))) tmp += start_neg_pow2[k]; </td> </tr></table><span class="postbody">
<br/>
<br/>
which I fix like this:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">if (tmp &amp; (1 &lt;&lt; (k - 1))) tmp += ((SWORD *)start_neg_pow2)[k]; </td> </tr></table><span class="postbody">
<br/>
<br/>
But I'm getting weird results...
<br/>
<br/>
<br/>
I tried to understand the asm code by myself, but I found some lines that I can't.
<br/>
<br/>
Why incrementing and decrementing cl (k) if you are not going to use it again?
<br/>
Does bt eax,ecx test eax's bit 0?
<br/>
add ax,word ptr [ebx+ecx*2] &lt;- ecx is set to 0 from the beggining...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#46719 - headspin - Wed Jun 29, 2005 2:24 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Locke wrote:</b></span></td> </tr> <tr> <td class="quote">headspin, your jpeg decoder doesn't work when loading something bigger than 256 width. I get black lines interpolated with the image data... I'm decoding the full jpeg into main memory and then copying the focused region to VRAM (using framebuffer). Did you know about this issue?</td> </tr></table><span class="postbody">
<br/>
<br/>
It's not <span style="font-style: italic">my</span> decoder, it's by Burton Radons. But anyway, check out the following lines in gba-jpeg-decode.cpp..
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">JPEG_Convert (row [256], YBlock [2 * JPEG_DCTSIZE + 0], Cb, Cr); // 240
<br/>
JPEG_Convert (row [257], YBlock [2 * JPEG_DCTSIZE + 1], Cb, Cr); // 241</td> </tr></table><span class="postbody">
<br/>
<br/>
Change those values to suit the width of your image. Let me know how you go..<br/>_________________<br/><a class="postlink" href="http://headsoft.com.au/index.php?category=warhawk" target="_blank">Warhawk DS</a> | <a class="postlink" href="http://headsoft.com.au/index.php?category=mmll" target="_blank">Manic Miner: The Lost Levels</a> | <a class="postlink" href="http://headsoft.com.au/index.php?category=tdg" target="_blank">The Detective Game</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#46728 - Lupin - Wed Jun 29, 2005 6:18 pm</h4>
    <div class="postbody"><span class="postbody">SWORD get_svalue(BYTE k) 
<br/>
// k&gt;0 always 
<br/>
// Takes k bits out of the BIT stream (wordval), and makes them a signed value 
<br/>
{ 
<br/>
   _asm { 
<br/>
         xor ecx, ecx  //ecx = 0
<br/>
         mov cl,k       // lower byte of ecx (cl) = k
<br/>
         mov eax,[wordval]  //load wordval to eax
<br/>
         shl eax,cl  // shift eax&lt;&lt;cl
<br/>
         shr eax, 16  // shift eax&gt;&gt;16
<br/>
         dec cl         // decrement lower byte of ecx (cl)
<br/>
         bt eax,ecx  // what is this instruction doing? o_o
<br/>
         jc end_macro //jump if cary to end_macro
<br/>
   signed_value:inc cl  //increment lower bit of cl
<br/>
         mov ebx,[start_neg_pow2]  //load start_neg_pow2 to ebx
<br/>
         add ax,word ptr [ebx+ecx*2] //ax = ax + start_neg_pow2[ecx*2]
<br/>
       end_macro: 
<br/>
   } 
<br/>
}
<br/>
<br/>
You should at least understand the basic register layout of x86 CPU... ecx is a 32 bit register, cx is the 16 lower bits of ecx, ch is the high byte of cx and cl is the low byte of cx. I am not sure about the bt instruction but i am too lazy to look it up now :)<br/>_________________<br/><a class="postlink" href="http://pokeme.shizzle.it/" target="_blank">Team Pokeme</a>
<br/>
<a class="postlink" href="http://lupin.shizzle.it/" target="_blank">My blog and PM ASM tutorials</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#46771 - Locke - Thu Jun 30, 2005 11:36 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>headspin wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Locke wrote:</b></span></td> </tr> <tr> <td class="quote">headspin, your jpeg decoder doesn't work when loading something bigger than 256 width. I get black lines interpolated with the image data... I'm decoding the full jpeg into main memory and then copying the focused region to VRAM (using framebuffer). Did you know about this issue?</td> </tr></table><span class="postbody">
<br/>
<br/>
It's not <span style="font-style: italic">my</span> decoder, it's by Burton Radons. But anyway, check out the following lines in gba-jpeg-decode.cpp..
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">JPEG_Convert (row [256], YBlock [2 * JPEG_DCTSIZE + 0], Cb, Cr); // 240
<br/>
JPEG_Convert (row [257], YBlock [2 * JPEG_DCTSIZE + 1], Cb, Cr); // 241</td> </tr></table><span class="postbody">
<br/>
<br/>
Change those values to suit the width of your image. Let me know how you go..</span></td> </tr></table><span class="postbody">
<br/>
<br/>
Yes, it did the trick. I've modified my file so it uses the width from JPEG_DecompressImage and now works fine with any image size.
<br/>
<br/>
<br/>
Lupin, thanks for the info. Now I really understand the pourpose of that function. (I think bt is bit test, checks the sign bit)</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
