<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>noob question regarding compilation of C++ and ASM in DKP - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>ASM > noob question regarding compilation of C++ and ASM in DKP</h2>
<div id="posts">
<div class="post">
    <h4>#149878 - mr_munk - Sat Jan 26, 2008 10:58 am</h4>
    <div class="postbody"><span class="postbody">Hi,
<br/>
<br/>
I have tried my best to research this on the forum but still cannot find / understand the information that I need.
<br/>
<br/>
I have the following asm function copied from an example:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
.arm 
<br/>
.section .text
<br/>
.align 2
<br/>
.global redfill
<br/>
redfill: 
<br/>
      mov r0, #0x4000000 
<br/>
      mov r1, #0x400 
<br/>
      add r1, r1, #3 
<br/>
      str r1, [r0]    
<br/>
      mov r0, #0x6000000 
<br/>
      mov r1, #0xFF 
<br/>
      mov r2, #0x9600 
<br/>
loop1: 
<br/>
      strh r1, [r0], #2 
<br/>
      subs r2, r2, #1 
<br/>
      bne loop1 
<br/>
infin: 
<br/>
      b infin
<br/>
</td> </tr></table><span class="postbody">
<br/>
this resides in source/redfill.s
<br/>
<br/>
I also have a function prototype in include/redfill.h
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
extern void redfill(void); 
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Finally I try to call the function in my main.cpp file
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
//asm function
<br/>
   redfill();
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
and get a compiler error - 'undefined reference to redfill()'
<br/>
<br/>
can someone tell me where I am going wrong ?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#149880 - Kyoufu Kawa - Sat Jan 26, 2008 11:33 am</h4>
    <div class="postbody"><span class="postbody">Forgot to #include redfill.h?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#149881 - mr_munk - Sat Jan 26, 2008 11:37 am</h4>
    <div class="postbody"><span class="postbody">Hi, thanks for your reply, I should have mentioned in my original post that I did include the header in my cpp</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#149882 - Dwedit - Sat Jan 26, 2008 11:55 am</h4>
    <div class="postbody"><span class="postbody">You must declare C or ASM functions inside an extern "C" block...
<br/>
<br/>
extern "C"{
<br/>
  void foo();
<br/>
}
<br/>
<br/>
The reason you do this is because the real C++ name for any function is mangled to indicate the types of the arguments and return type.
<br/>
For example,
<br/>
void foo()
<br/>
gets renamed to "_Z3foov" instead of "foo".
<br/>
By using an extern "C" block, you are telling the C++ compiler that this symbol name comes from a C or ASM source file, and shouldn't be mangled.
<br/>
<br/>
This also means that if you were to name your ASM function "_Z3foov", you could call it from C++ under the name foo.  While pre-mangling names technically works, different compilers do not usually use the same mangling convention, so you should use extern "C" instead.<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#149883 - mr_munk - Sat Jan 26, 2008 12:06 pm</h4>
    <div class="postbody"><span class="postbody">Thank you very much for your comprehensive answer Dwedit :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#149885 - mr_munk - Sat Jan 26, 2008 12:10 pm</h4>
    <div class="postbody"><span class="postbody">Not that I want to pre-mangle my function definitions but out of curiosity - could you break down _Z3foov to show how the compiler encodes the arguments and return types?
<br/>
<br/>
I'm guessing v at the end indicates void
<br/>
what about the _Z3 ?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#149890 - nipil - Sat Jan 26, 2008 1:59 pm</h4>
    <div class="postbody"><span class="postbody">I think <a class="postlink" href="http://en.wikipedia.org/wiki/Name_mangling" target="_blank">this page</a> could provide you with insightful information. Considering dkp is based on gcc (afaik), take a look at the corresponding sections.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#149935 - mr_munk - Sun Jan 27, 2008 5:11 pm</h4>
    <div class="postbody"><span class="postbody">Will check it out thanks :)</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
