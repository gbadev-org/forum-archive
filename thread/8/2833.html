<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Branches within loops - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>ASM > Branches within loops</h2>
<div id="posts">
<div class="post">
    <h4>#16166 - animension - Tue Feb 10, 2004 1:34 am</h4>
    <div class="postbody"><span class="postbody">I was wondering just how much of an impact a branch instruction would have in a loop. For instance, what if you had something like:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
mov r0,#0
<br/>
looptop:
<br/>
cmp r0,#128    @ loop 128 times
<br/>
beq endloop
<br/>
@ do stuff here ...
<br/>
cmp r1,#0   @ some other arbitrary number
<br/>
beq loopbottom @ skip if equal
<br/>
@ do other stuff here
<br/>
loopbottom:
<br/>
add r0,r0,#1
<br/>
b looptop
<br/>
endloop:
<br/>
@ finished with loop here
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
How much would the cmp and beq in the middle of the loop cost, aside from extra instructions? Would there be a big impact with the cache, etc? I'm trying to optimize the inner loop in a time critical task, and I'm thinking it might be better if I sort out certain criteria before hand and run different loops based on these criteria. The only problem is that the code will bloat if I have too many different versions of the loop not to mention the fact that it'll be a maintenance nightmare :/
<br/>
<br/>
Any suggestions?<br/>_________________<br/>"Beer is proof that God loves us and wants us to be happy."
<br/>
-- Benjamin Franklin</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#16170 - DekuTree64 - Tue Feb 10, 2004 3:52 am</h4>
    <div class="postbody"><span class="postbody">GBA has no cache, so you can count cycles exactly. Also, any conditional instruction that doesn't get executed takes 1 instruction, so that's what it will take unless it's executed, and then it will be more. 2S + 1N, according to GBATEK, which in IWRAM will be 3 cycles.
<br/>
But surely it would be better to do the main looping check and branch if NOT equal, at the end of the loop instead of branching to the top and then checking if you need to branch. And then if you loop from 128 down instead of 0 up, you can use the condition setting ability of the ARM to cut the cmp entirely
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">mov r0,#128 
<br/>
looptop: 
<br/>
@ do stuff here ... 
<br/>
cmp r1,#0   @ some other arbitrary number 
<br/>
beq loopbottom @ skip if equal 
<br/>
@ do other stuff here 
<br/>
loopbottom: 
<br/>
subs r0,r0,#1 
<br/>
bne looptop 
<br/>
@ finished with loop here</td> </tr></table><span class="postbody">
<br/>
Or if you're working in THUMB, sub always sets the condition flags, so you still don't need to cmp, but I assume you're working in ARM in IWRAM if it's speed-critical.<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#16171 - jd - Tue Feb 10, 2004 3:56 am</h4>
    <div class="postbody"><span class="postbody">If the branch isn't taken it only takes 1 cycle to execute, just like most ARM instructions. If it is taken then it causes a pipeline stall which I think takes an extra 2 cycles (or possibly 3 - I can't remember off the top of my head). The GBA's processor has no cache, so you don't need to worry about that.
<br/>
<br/>
If "beq loopbottom" is very rare, the code as shown takes 8 cycles/loop. The first optimisation I'd make would be to make the loop counter count to zero rather than up to 128, i.e.:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
mov r0,#128
<br/>
looptop:
<br/>
@ do stuff here ...
<br/>
cmp r1,#0? ?@ some other arbitrary number
<br/>
beq loopbottom @ skip if equal
<br/>
@ do other stuff here
<br/>
loopbottom:
<br/>
subs r0,r0,#1
<br/>
bgt looptop
<br/>
@ finished with loop here
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
With the same assumptions mentioned above, this would take 6 cycles/loop. If your loop is short you could unroll it - with the code you've specified this would take just 2 cycles/loop - i.e. only the "cmp" and the "beq loopbottom" would remain.
<br/>
<br/>
How much of an effect removing the cmp and beq will have on the overall performance depends on how many cycles are taken up by the other stuff in your inner loop. If it's trivial to do it in advance then do it, but if doing it in advance requires more complex maths than doing it in the inner loop then you'll have to work out how many CPU cycles it would take with each approach and then make your decision based on that. However, in most cases it's a good idea to remove as much stuff as possible from your inner loop.
<br/>
<br/>
(By the way, all the timings above assume you're running the code from IWRAM.)
<br/>
<br/>
EDIT: Drat, DekuTree beat me to it. ;)</span><span class="gensmall"><br/><br/>Last edited by jd on Tue Feb 10, 2004 4:06 am; edited 3 times in total</span></div>    
</div>
<div class="post">
    <h4>#16172 - poslundc - Tue Feb 10, 2004 3:58 am</h4>
    <div class="postbody"><span class="postbody">There is no cache on the GBA.
<br/>
<br/>
Branch instructions flush the pipeline, which basically stalls the processor for two additional cycles.
<br/>
<br/>
There is an additional performance hit if your code is running from ROM and you use a branch, because the next instruction needs to be read non-sequentially which takes a lot longer than a sequential read. (I'd imagine this penalty would also be incurred whenever you use the ldr/str commands, anyone care to confirm?)
<br/>
<br/>
Furthermore, if you turn on ROM-prefetch (which drains the battery quicker) then sequential instructions have a zero-waitstate (which means they're loaded immediately), but again you lose this advantage every time you branch.
<br/>
<br/>
The upshot of all of this is:
<br/>
<br/>
- Avoid branches as much as possible, especially when running from ROM. You can avoid backwards branches by unrolling your loops, and you can avoid forward branches by using conditional execution (ARM mode only).
<br/>
<br/>
- If you are optimizing a time-critical inner loop like you say, you should be doing it in ARM code in IWRAM. Branches have less of a penalty there because of the zero waitstate, but you should still try to unroll and use conditional execution as much as possible. It wasn't clear if your routine was ARM or Thumb, but if it's performance-critical then make it ARM and make it in IWRAM.
<br/>
<br/>
- Testing and branching forward (like the one you have in the middle of your loop) for special cases is worthwhile if you are skipping a significant amount of code, and the special case occurs often enough for it to be worthwhile. Some judgement is needed here.
<br/>
<br/>
- You obviously need to make an acceptable tradeoff between code bloat and optimization for speed. Yes, you only have 32K of IWRAM, but hey, this is precisely the kind of thing it's there for.
<br/>
<br/>
The only structural alteration I would make to your loop setup is to move your test to the end of the loop, so that you're saving a branch instruction when the loop terminates, for what it's worth. If you aren't actually using the value in your counter, I would also make it a decrementing counter so that you can save the cmp instruction. ie.:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">   mov      r0, #128
<br/>
looptop:
<br/>
   @ do stuff
<br/>
   cmp      r1, #0
<br/>
   beq      loopbottom
<br/>
   @ do more stuff
<br/>
loopbottom:
<br/>
   subs      r0, r0, #1
<br/>
   bne      looptop
<br/>
<br/>
   @ finished with loop here</td> </tr></table><span class="postbody">
<br/>
<br/>
Hope this helps,
<br/>
<br/>
Dan.
<br/>
<br/>
<span style="font-weight: bold">EDIT:</span> Figures I'd be the last one to get my response in... :P</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#16176 - DekuTree64 - Tue Feb 10, 2004 4:17 am</h4>
    <div class="postbody"><span class="postbody">LOL, I figured I was racing Dan to the punch, but I didn't expect James too^_^<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#16213 - animension - Tue Feb 10, 2004 7:14 pm</h4>
    <div class="postbody"><span class="postbody">LOL thanks for racing to answer my question guys. :)
<br/>
<br/>
Well, I'll keep all of these things you 3 mentioned in consideration. Hopefully I'll be able to squeeze more juice out of my routine. Thanks!<br/>_________________<br/>"Beer is proof that God loves us and wants us to be happy."
<br/>
-- Benjamin Franklin</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
