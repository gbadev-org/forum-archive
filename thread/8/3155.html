<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Strange? - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>ASM > Strange?</h2>
<div id="posts">
<div class="post">
    <h4>#18669 - johsta - Wed Mar 31, 2004 12:54 pm</h4>
    <div class="postbody"><span class="postbody">hi
<br/>
<br/>
This is two ways of doing the exact same thing... 
<br/>
the thing is that the asm code with 7 instructions i much slower then the one with 13 instructions... why??? something to do with the pipeline? I don't got a clue.. btw this is done in a tight loop...
<br/>
<br/>
the C/C++ expression is: relX=(tileX&lt;&lt;3)+x-objHalfWidth;
<br/>
<br/>
<br/>
<br/>
ASM - Fast:
<br/>
<br/>
ldr	r3, [r11, -#128]
<br/>
str	r3, [r11, -#112]
<br/>
<br/>
ldr	r3, [r11, -#112]
<br/>
mov	r3, r3, lsl #3
<br/>
str	r3, [r11, -#112]
<br/>
<br/>
ldr	r2, [r11, -#112]
<br/>
ldr	r3, [r11, -#68]
<br/>
add	r3, r2, r3
<br/>
str	r3, [r11, -#112]
<br/>
<br/>
ldr	r2, [r11, -#112]
<br/>
ldr	r3, [r11, -#88]
<br/>
rsb	r3, r3, r2
<br/>
str	r3, [r11, -#112]
<br/>
<br/>
ASM - slow
<br/>
<br/>
ldr	r3, [r11, -#128]
<br/>
mov	r2, r3, lsl #3
<br/>
ldr	r3, [r11, -#68]
<br/>
add	r2, r2, r3
<br/>
ldr	r3, [r11, -#88]
<br/>
rsb	r3, r3, r2
<br/>
str	r3, [r11, -#112]
<br/>
<br/>
thanks,</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#18673 - poslundc - Wed Mar 31, 2004 3:10 pm</h4>
    <div class="postbody"><span class="postbody">There is no logical reason for the first version to run faster than the second version.
<br/>
<br/>
Are you certain about your findings? What was the approximate difference in speed? Did you try this on hardware? Emulators can be misleading in this stuff.
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#18676 - Lupin - Wed Mar 31, 2004 4:12 pm</h4>
    <div class="postbody"><span class="postbody">The second version IS faster. Just count the cycles, you will (of course) end up with less cycles in the second version, you don't need any profiling to find out that 13 instructions are slower than 7 instructions (this is also because most of the operations on arm cpu only take up 1-3 cycles, only mul is taking a lot more :))<br/>_________________<br/><a class="postlink" href="http://pokeme.shizzle.it/" target="_blank">Team Pokeme</a>
<br/>
<a class="postlink" href="http://lupin.shizzle.it/" target="_blank">My blog and PM ASM tutorials</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#18678 - poslundc - Wed Mar 31, 2004 5:37 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Lupin wrote:</b></span></td> </tr> <tr> <td class="quote">The second version IS faster. Just count the cycles, you will (of course) end up with less cycles in the second version, you don't need any profiling to find out that 13 instructions are slower than 7 instructions (this is also because most of the operations on arm cpu only take up 1-3 cycles, only mul is taking a lot more :))</td> </tr></table><span class="postbody">
<br/>
<br/>
&lt;shakes head&gt;
<br/>
<br/>
MUL only takes between 2 and 5 cycles, depending on the operands.
<br/>
<br/>
Even SMLAL and UMULL - the multiply-long-and-accumulate instructions - only take between 4 and 7 cycles.
<br/>
<br/>
The waitstates for ROM and EWRAM can result in load, store and branch instructions taking considerably longer than a multiply instruction.
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#18706 - johsta - Thu Apr 01, 2004 12:49 pm</h4>
    <div class="postbody"><span class="postbody">the code with 13 instructions equals tho this...
<br/>
<br/>
relX = tileX;
<br/>
relX &lt;&lt;= 3;
<br/>
relX += x;
<br/>
relX -= objHalfWidth;
<br/>
<br/>
this is said to run faster in c++, and does run faster, but then why does it generate more instructions then
<br/>
<br/>
relX= (tileX&lt;&lt;8)+x-objHalfWidth;
<br/>
<br/>
<br/>
:) ?</span><span class="gensmall"><br/><br/>Last edited by johsta on Thu Apr 01, 2004 12:58 pm; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#18708 - poslundc - Thu Apr 01, 2004 12:52 pm</h4>
    <div class="postbody"><span class="postbody">It would be a lot more helpful if you answered my questions about your findings first.
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#18709 - johsta - Thu Apr 01, 2004 12:57 pm</h4>
    <div class="postbody"><span class="postbody">relX= (tileX&lt;&lt;8)+x-objHalfWidth; 
<br/>
<br/>
this is supposed to generate temporary variables... and the other expression, only work with the ref.
<br/>
<br/>
But, it must be slower to write the data back all the time with str... compared to only using the registers</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#18710 - johsta - Thu Apr 01, 2004 1:02 pm</h4>
    <div class="postbody"><span class="postbody">This was done on the vba emulator and the speed difference is about 
<br/>
40 % when the code runs in IWRAM and about 20% on the ROM...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#18715 - torne - Thu Apr 01, 2004 2:31 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>johsta wrote:</b></span></td> </tr> <tr> <td class="quote">relX= (tileX&lt;&lt;8)+x-objHalfWidth; 
<br/>
<br/>
this is supposed to generate temporary variables... and the other expression, only work with the ref.
<br/>
<br/>
But, it must be slower to write the data back all the time with str... compared to only using the registers</td> </tr></table><span class="postbody">
<br/>
Who says this is 'supposed' to generate temporary variables? As the intermediate values are not accessible by the program, it's the compiler's right to optimise them out of existence, which is exactly what it's done. What optimisation settings are you using on the compiler? The former code is clearly being generated with poor optimisation, as otherwise the redundant copies would be removed. A compiler with good optimisation settings enabled will generate identical code (under alpha conversion) for your two C code examples.
<br/>
<br/>
VBA is not completely cycle-accurate and cannot reasonably be used for testing the performance of code. Test on hardware. The shorter code is faster.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
