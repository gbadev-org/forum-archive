<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>again variables in function - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>ASM > again variables in function</h2>
<div id="posts">
<div class="post">
    <h4>#12927 - shadow_gg - Mon Dec 01, 2003 1:24 pm</h4>
    <div class="postbody"><span class="postbody">hello,got a problem accessing variables in a function
<br/>
in fact still not resolved since last time :/
<br/>
it compiles but it seems it doesn't read the variable sky
<br/>
r3 don't get the correct value of sky
<br/>
it displays me strange data
<br/>
<br/>
blitasm()
<br/>
{
<br/>
 void *sky=(void *)(0x8000000+SIZE_ROM+SIZE_PAL+SIZE_IMAGE+SIZE_MAP);
<br/>
        asm volatile(" 
<br/>
	.ALIGN
<br/>
	.ARM
<br/>
<br/>
	ldr		r0,=screen
<br/>
	ldr		r0,[r0]	
<br/>
	ldr		r3,%0
<br/>
	ldr		r3,[r3]	
<br/>
	ldr		r2,=9600
<br/>
boucle:
<br/>
	ldr		r1,[r3],#4
<br/>
	str		r1,[r0],#4
<br/>
	subs	r2,r2,#1
<br/>
	bpl		boucle
<br/>
	.pool
<br/>
":/*no output*/:"m"(sky):"r0","r1","r2","r3");
<br/>
}
<br/>
but when declaring sky global
<br/>
doing ldr r3,=sky
<br/>
ldr r3,[r3] it works ?
<br/>
:/
<br/>
what happens?
<br/>
<br/>
I know it's better to write in a separate .s file,but more simple for me to write in C functions.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#12928 - Paul Shirley - Mon Dec 01, 2003 2:25 pm</h4>
    <div class="postbody"><span class="postbody">removed</span><span class="gensmall"><br/><br/>Last edited by Paul Shirley on Sun Mar 28, 2004 9:32 pm; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#12929 - shadow_gg - Mon Dec 01, 2003 2:45 pm</h4>
    <div class="postbody"><span class="postbody">thx
<br/>
but sky is not a constant bcs SIZE_ROM is a variable (int)
<br/>
and I need to read from memory
<br/>
wanna convert another function where there are lot of variables,
<br/>
and I can't have all these variables at the same time in register
<br/>
<br/>
why %0 don't represent sky ?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#12932 - poslundc - Mon Dec 01, 2003 4:32 pm</h4>
    <div class="postbody"><span class="postbody">Take out the fourth line:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
   ldr r3,[r3]
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Also, it's helpful to people if you post in the same thread you used before, so they can see what previous answers were.
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#12933 - DekuTree64 - Mon Dec 01, 2003 5:20 pm</h4>
    <div class="postbody"><span class="postbody">Try this in a .s file:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
.GLOBAL blitasm
<br/>
.ALIGN 
<br/>
.ARM
<br/>
blitasm:
<br/>
ldr r0,=screen 
<br/>
ldr r0,[r0] 
<br/>
mov r3, #0x8000000
<br/>
ldr r2, =SIZE_ROM
<br/>
ldr r2, [r2]
<br/>
add r3, r3, r2
<br/>
ldr r2, =SIZE_PAL
<br/>
ldr r2, [r2]
<br/>
add r3, r3, r2
<br/>
ldr r2, =SIZE_IMAGE
<br/>
ldr r2, [r2]
<br/>
add r3, r3, r2
<br/>
ldr r2, =SIZE_MAP
<br/>
ldr r2, [r2]
<br/>
add r3, r3, r2
<br/>
ldr r2,=9600 
<br/>
boucle: 
<br/>
ldr r1,[r3],#4 
<br/>
str r1,[r0],#4 
<br/>
subs r2,r2,#1 
<br/>
bpl boucle 
<br/>
.pool 
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Assuming that all those things are variables (you should really go with the standard naming style of variables starting with small letters, and constants being all caps with underscores for spaces, so it's clear to other people what things are), that will load them in and add them up to compute sky inside the ASM block. That way you don't need to use inline ASM at all, and thusly will have no weird problems that noone knows for sure how to fix.
<br/>
<br/>
ALthough I think Dan is right about just removing that ldr r3, [r3].<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#12934 - shadow_gg - Mon Dec 01, 2003 5:26 pm</h4>
    <div class="postbody"><span class="postbody">yeah he was right
<br/>
thx</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
