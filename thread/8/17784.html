<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Attempting to copy memory using asm - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>ASM > Attempting to copy memory using asm</h2>
<div id="posts">
<div class="post">
    <h4>#177037 - Timofiend - Fri Dec 02, 2011 2:58 am</h4>
    <div class="postbody"><span class="postbody">So I am attempting to copy some character data from a header file into the character base block, but I have gone wrong somewhere. It compiles, but when linking I am told that in another function there is an undefined reference to "r7" and "ip"
<br/>
<br/>
This is how I am trying to copy the data:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
   asm volatile(
<br/>
   ".arm\n\t"
<br/>
   "mov r3, #0\n\t"
<br/>
   "ldr r0, =%[fontcbb]\n\t"
<br/>
   "ldr r1, =%[fontdata]\n"
<br/>
   "for_loop:\n\t"
<br/>
   "ldr r2, [r1, r3, lsl #2]\n\t"
<br/>
   "str r2, [r0, r3, lsl #2]\n\t"
<br/>
   "add r3, #1\n\t"
<br/>
   "cmp r3, #7\n\t"
<br/>
   "blt for_loop\n\t"
<br/>
   ".code 16"
<br/>
   : [fontcbb] "+r" (fontCBB2) 
<br/>
   : [fontdata] "r" (fontData)
<br/>
   : "cc", "r0", "r1", "r2", "r3"
<br/>
   );</td> </tr></table><span class="postbody">
<br/>
<br/>
FontCBB2 is a 32 bit pointer to the location in the character base block I am trying to write to, and fontData is a 32 bit pointer to my array full of character data.
<br/>
<br/>
I tried removing the function that was referenced, but it just caused the same problem with a different function, so I assume I have done something wrong in the asm code.
<br/>
<br/>
Any ideas? I am fairly new at this so if theres anything else I haven't included that would help locate the problem just ask. I am trying to integrate this into my c code.
<br/>
<br/>
<br/>
On a different note while I am here I had another question - When using labels for branches in asm code that is in a function, I have no troubles as long as the function is being called once, but if I call the function more than once I am told the error message that my labels are already define, is there something I should be doing to avoid that?
<br/>
<br/>
Here is an example of what I am doing, this is in a print text function I have written to avoid the text going off the screen
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">      asm volatile(
<br/>
      "cmp %[tempOut], #32\n\t"
<br/>
      "blt end\n"
<br/>
      "loop1:\n\t"
<br/>
      "sub %[tempOut], %[tempIn], #32\n\t"
<br/>
      "cmp %[tempOut], #31\n\t"
<br/>
      "bgt loop1\n\t"
<br/>
      "cmp %[tempOut], #31\n\t"
<br/>
      "bne skip\n\t"
<br/>
      "add %[cursorPosOut], %[cursorPosIn], #1\n"
<br/>
      "skip:"
<br/>
      "cmp %[tempOut], #32\n\t"
<br/>
      "bne end\n\t"
<br/>
      "add %[cursorPosOut], %[cursorPosIn], #2\n"      
<br/>
      "end:\n\t"
<br/>
      :[tempOut] "+r" (temp), [cursorPosOut] "+r" (cursorPos)
<br/>
      :[tempIn] "r" (temp), [cursorPosIn] "r" (cursorPos)
<br/>
      );</td> </tr></table><span class="postbody">
<br/>
<br/>
We have been asked to demonstrate knowledge of how to integrate asm into our code - if you were wondering why I am using this.
<br/>
<br/>
Thanks</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#177038 - Dwedit - Fri Dec 02, 2011 7:54 am</h4>
    <div class="postbody"><span class="postbody">When you do ARM inline assembly, you need to specify input, output, and clobber lists.  See the <a class="postlink" href="http://www.ethernut.de/en/documents/arm-inline-asm.html" target="_blank">"ARM GCC Inline Assembler Cookbook"</a> for more details.
<br/>
<br/>
And you can't just do a .code32 as your first line, you need to force a mode change from THUMB to ARM by using a "bx" instruction, like this:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
adr r0,SomeLabel
<br/>
bx r0
<br/>
.code32
<br/>
SomeLabel:
<br/>
 nop
<br/>
.code16
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
<br/>
For the labels problem, this is because of function inlining.  You can use unnamed numeric labels instead, so instead of code like this:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">loop1:
<br/>
 nop
<br/>
 subs r0,r0,#1
<br/>
 bne loop1</td> </tr></table><span class="postbody">
<br/>
you would use this type of label:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">0:
<br/>
 nop
<br/>
 subs r0,r0,#1
<br/>
 bne 0b
<br/>
</td> </tr></table><span class="postbody">
<br/>
You use just the number to define the label, then when you use the label, you specify the direction, "b" for backwards, and "f" for forwards.
<br/>
<br/>
There is no limit to how many times you can define a numeric label.  Only problem is that if you copy-paste code, you may be adding a conflicting numeric label where it didn't exist before, and that would make your branches go to the wrong place.
<br/>
<br/>
If you don't want to use the unnamed numeric labels, you can also set of the attributes of the function to force it to never be inlined.<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#177042 - Timofiend - Fri Dec 02, 2011 1:03 pm</h4>
    <div class="postbody"><span class="postbody">Thanks for the reply. I have looked through the cookbook, and quite a few other bits of documentation. I was under the impression that when using multiple lines of code I could specify the input/output and clobber lists at the end of the whole code snippet rather than on a per-line basis? That what I was doing previously with other snippets and it seemed to work fine.
<br/>
<br/>
Also I thought the .code32 was forcing the mode change? Do I specifically need to use arm as I am trying to load a 32bit address? I only changed it because I couldnt logical shift left within my ldr statement using just thumb, but if I were to be loading 32bit addresses I would need to be doing it in arm anyway wouldnt I?
<br/>
<br/>
Thanks for the help, and I shall try using the unnamed numeric labels instead thanks for that as well :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#177048 - Miked0801 - Fri Dec 02, 2011 4:32 pm</h4>
    <div class="postbody"><span class="postbody">Thumb allows 32-bit addressing just fine.  You are just limited to the number of registers that you can access, you get a few less op-codes, and you don't get built in shifting and conditional compiler per op-code.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#177060 - Cearn - Sat Dec 03, 2011 11:23 am</h4>
    <div class="postbody"><span class="postbody">Did the assignment specifically ask for inline assembly? If not, using a separate assembly file might be easier as you won't have to worry about its particular syntax and quotes and \ns and such. If you're using the template makefiles, you don't even have to do anything extra to assemble it.
<br/>
<br/>
The basic framework would be
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
Basic rules for assembly: 
<br/>
* r0-r3 are the first 4 parameters of the function, the rest goes onto the stack.
<br/>
* r0-r3, r12 are free to use as you will. When using other registers, push them onto the stack first and pop them when you're done. 
<br/>
* Return value goes in r0.
<br/>
* Return from the function via bx lr
<br/>
<br/>
<br/>
// --- in assembly file (say, foo.s) ---
<br/>
@ int asm_add(int a, int b);
<br/>
@ Add two numbers and return them.
<br/>
<br/>
@ Standard boiler plate: 
<br/>
    .text                  @ Put in into the code section
<br/>
    .align  2              @ Align function to 1&lt;&lt;2
<br/>
    .thumb                 @ Use Thumb code
<br/>
    .thumb_func            @ This will be thumb function (seems redundant, but really isn't)
<br/>
    .global asm_add        @ Make function accessible to outside world.
<br/>
asm_add:
<br/>
    add     r0, r1         @ r0 = r0 + r1
<br/>
    bx      lr
<br/>
<br/>
<br/>
// --- In C file ---
<br/>
<br/>
int asm_add(int a, int b);
<br/>
<br/>
int c= asm_add(5, 4);
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
<a class="postlink" href="http://www.coranac.com/tonc/text/asm.htm#ssec-asm-32" target="_blank">More complicated example of ARM function: </a>:
<br/>
<br/>
memcpy32.s: 
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
@ === void memcpy32(void *dst, const void *src, uint nwords) IWRAM_CODE; =============
<br/>
@ r0, r1: dst, src
<br/>
@ r2: nwords, then nwords&gt;&gt;3
<br/>
@ r3-r10: data buffer
<br/>
@ r12: nwords&amp;7
<br/>
    .section .iwram,"ax", %progbits
<br/>
    .align  2
<br/>
    .code   32
<br/>
    .global memcpy32
<br/>
memcpy32:
<br/>
    and     r12, r2, #7     @ r12: residual word count
<br/>
    movs    r2, r2, lsr #3  @ r2: block count
<br/>
    beq     .Lres_cpy32
<br/>
    push    {r4-r10}
<br/>
<br/>
    @ Copy 32byte chunks with 8fold xxmia
<br/>
    @ r2 range: [1, inf)
<br/>
.Lmain_cpy32:
<br/>
        ldmia   r1!, {r3-r10}   
<br/>
        stmia   r0!, {r3-r10}
<br/>
        subs    r2, #1
<br/>
        bne     .Lmain_cpy32
<br/>
    pop     {r4-r10}
<br/>
<br/>
    @ And the residual 0-7 words. 
<br/>
    @ r12 range: [0,7]
<br/>
.Lres_cpy32:
<br/>
        subs    r12, #1
<br/>
        ldrcs   r3, [r1], #4
<br/>
        strcs   r3, [r0], #4
<br/>
        bcs     .Lres_cpy32
<br/>
<br/>
    @ return
<br/>
    bx  lr
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
in C file: 
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
// declaration: 
<br/>
extern "C" void memcpy32(void *dst, const void *src, nwords) IWRAM_CODE;
<br/>
<br/>
// Usage. Copy gfx for someSprite to OBJ VRAM.
<br/>
#define someSpriteTilesLen 256         // Length of someSpriteTiles, in bytes.
<br/>
u32 someSpriteTiles[64];               // sprite gfx array.
<br/>
<br/>
memcpy32(SPRITE_GFX, someSpriteTiles, someSpriteTilesLen/4);
<br/>
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#177098 - Timofiend - Sat Dec 10, 2011 5:55 pm</h4>
    <div class="postbody"><span class="postbody">Thanks very much for the reply. Sorry it took me a while to get back I have been working on some other aspects of the project for now.
<br/>
<br/>
I do not think he specifically asked for it to be inline, although when giving us resources the inline assembly method was mentioned. I have sent off an email to double check this, and if it is allowed then I will definitely try your method thank you for the info.
<br/>
<br/>
So is there anything special I would have to do to include the separate assembly file in my project? Would I need to place it somewhere in particular in the project folder? **edit** I just read in the other thread that it would go in /sources. Would I need to tell the compiler I have put this here? Or would it automatically recognise and use it?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#177099 - Miked0801 - Sat Dec 10, 2011 6:42 pm</h4>
    <div class="postbody"><span class="postbody">Depends on your makefile.  Many will scan for .s files and automatically call the assembler on them instead of the compiler.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
