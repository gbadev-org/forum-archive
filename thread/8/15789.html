<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>ASM to C - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>ASM > ASM to C</h2>
<div id="posts">
<div class="post">
    <h4>#160066 - naleksiev - Thu Jul 10, 2008 12:40 am</h4>
    <div class="postbody"><span class="postbody">I was profiling something at work and I notice that switch case always have the default case at the top. The first two instructions in the fake example below.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">cmp         r4,#3
<br/>
bhi         *+56           
<br/>
add         pc,pc,r4,lsl #2
<br/>
nop         
<br/>
b           *+16           
<br/>
b           *+20           
<br/>
b           *+24           
<br/>
b           *+28           
<br/>
mov         lr,#2
<br/>
b           *+24
<br/>
mov         lr,#3
<br/>
b           *+16
<br/>
mov         lr,#4
<br/>
b           *+8
<br/>
mov         lr,#5</td> </tr></table><span class="postbody">
<br/>
<br/>
This case should never happened in my code. If I was writing it in ASM it should be fine to get rid of the cmp and bhi. The problem is that it won't wort the optimization compared to code readability.
<br/>
<br/>
So is it possible this to be done in C / C++?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#160077 - sgeos - Thu Jul 10, 2008 4:16 am</h4>
    <div class="postbody"><span class="postbody">The ASM code produced by a C or C++ code segment (or anything else for that matter) is highly dependant on the compiler you use.  Exact behavior will vary across make, version, and optimization level of the compiler.
<br/>
<br/>
The question is, do you need this code to be more efficient?  Most of the time, the answer is no.  If the answer is yes, either find a better algorithm or rewrite your current algorithm in hand optimized assembler.
<br/>
<br/>
-Brendan</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#160121 - naleksiev - Thu Jul 10, 2008 5:22 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>sgeos wrote:</b></span></td> </tr> <tr> <td class="quote">The question is, do you need this code to be more efficient?</td> </tr></table><span class="postbody">
<br/>
<br/>
To save 2 cycles... it's fine the way it is. I was just wandering if I can trick the compiler that I don't have default case and that the variable in the switch will have one of the listed values.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#160124 - sajiimori - Thu Jul 10, 2008 5:52 pm</h4>
    <div class="postbody"><span class="postbody">On GCC, you can do this, but it's not exactly the same (because it involves an LDR):</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">int test(int n)
<br/>
{
<br/>
   static const void* labels[] =
<br/>
   {
<br/>
      &amp;&amp;L1,
<br/>
      &amp;&amp;L2,
<br/>
      &amp;&amp;L3,
<br/>
   };
<br/>
<br/>
   goto *labels[n];
<br/>
<br/>
L1:
<br/>
   return 123;
<br/>
L2:
<br/>
   return 456;
<br/>
L3:
<br/>
   return 789;
<br/>
}</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#160129 - sgeos - Thu Jul 10, 2008 7:11 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>naleksiev wrote:</b></span></td> </tr> <tr> <td class="quote">To save 2 cycles... it's fine the way it is.</td> </tr></table><span class="postbody">
<br/>
If you are calling it 2000 times a frame, 2 cycles becomes 4000 and that may be a big deal.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>naleksiev wrote:</b></span></td> </tr> <tr> <td class="quote">I was just wandering if I can trick the compiler that I don't have default case and that the variable in the switch will have one of the listed values.</td> </tr></table><span class="postbody">
<br/>
Your current compiler?  Maybe.  All compilers?  No.  What works for one makes things less efficient for another.  In general, just write simple code and worry about cycles when you need to.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>sajiimori wrote:</b></span></td> </tr> <tr> <td class="quote">On GCC, you can do this, but it's not exactly the same (because it involves an LDR):<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">int test(int n)
<br/>
{
<br/>
   static const void* labels[] =
<br/>
   {
<br/>
      &amp;&amp;L1,
<br/>
      &amp;&amp;L2,
<br/>
      &amp;&amp;L3,
<br/>
   };
<br/>
<br/>
   goto *labels[n];
<br/>
<br/>
L1:
<br/>
   return 123;
<br/>
L2:
<br/>
   return 456;
<br/>
L3:
<br/>
   return 789;
<br/>
}</td> </tr></table><span class="postbody"></span></td> </tr></table><span class="postbody">
<br/>
I've never seen voodoo like that before.
<br/>
Then again, I can't say there are many goto gurus out there.
<br/>
<br/>
-Brendan</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#160143 - Miked0801 - Thu Jul 10, 2008 9:41 pm</h4>
    <div class="postbody"><span class="postbody">It's a hand coded jump table.  God knows what crap the compiler will do to it though :)
<br/>
<br/>
You could always not define one of your cases and let it go to default - let it be the most actively called function.  Of course, I do not at all recommend that kind of code for anything outside of very special case routines that you will be married to for all eternity.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#160149 - naleksiev - Thu Jul 10, 2008 10:29 pm</h4>
    <div class="postbody"><span class="postbody">Thank you guys!
<br/>
<br/>
The jump table makes sense although I'm going to add it to my code :):):) But that was the answer to my question.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#160158 - Dwedit - Thu Jul 10, 2008 11:23 pm</h4>
    <div class="postbody"><span class="postbody">Jump tables aren't standard C.  The "Cil" compiler turns a GCC style jump table into a switch block before compiling.<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
