<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Anyone actually ever used PLD? - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>ASM > Anyone actually ever used PLD?</h2>
<div id="posts">
<div class="post">
    <h4>#176604 - sverx - Wed Aug 24, 2011 9:43 am</h4>
    <div class="postbody"><span class="postbody">You know I'm basically a newbie of ARM asm...
<br/>
I've read on ARM946-E tech sheets that it implements the PLD instruction which should tell the data cache that quite soon we will access some piece of data which is stored at a given location and the memory unit -if it's possible- should load the cache line so that when we will need the data it will be already cached.
<br/>
It looks quite simple, IMHO.
<br/>
I have that quite long array of words (say 16000) in main ram and I need to process -not simply memcopy- each of them sequentially. So my code looks like:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">ldm &lt;some of the words&gt;
<br/>
pld &lt;some of the words I'll need later&gt;
<br/>
&lt;process the data&gt;
<br/>
&lt;process the data&gt;
<br/>
&lt;process the data&gt;
<br/>
...
<br/>
&lt;process the data&gt;
<br/>
stm &lt;the results&gt;
<br/>
(if !done) b &lt;back&gt;</td> </tr></table><span class="postbody">
<br/>
<br/>
In my tests I couldn't make such code go any faster than the same version without the pld instruction. I've been also trying to move the piece of code to ITCM so that even the code itself it isn't in main ram, to give plenty of access to the ldm instruction. No luck.
<br/>
<br/>
Any idea?
<br/>
<br/>
Thanks :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#176605 - wintermute - Wed Aug 24, 2011 12:20 pm</h4>
    <div class="postbody"><span class="postbody">Code in ITCM runs at the same speed as code in the cache, there's no advantage to moving code there unless either your loop exceeds the size of the instruction cache. I suspect there might be some advantage if the code is called from many places and somehow it's been expelled from the cache between calls - I haven't been able to write code to test that though.
<br/>
<br/>
There are other ways to improve access speed for data processing - for instance if your data is a list of x, y and z co-ordinates then you'll get more improvement from having an array for each element instead of interleaving them in one structure. This way you make use of 3 cache lines during processing instead of just one (assuming each array is bigger than 32 bytes).
<br/>
<br/>
The ARM Architechture Reference Manual says that the PLD instruction is a hint and acts as NOP on memory systems that don't support the optimisation. Given that Nintendo didn't add the necessary interface to provide byte writes to GBA cart space &amp; VRAM I think we can probably safely assume PLD won't work if it needs some support from the memory architecture. Feel free to disprove this though :p<br/>_________________<br/><a class="postlink" href="http://www.devkitpro.org/" target="_blank">devkitPro - professional toolchains at amateur prices</a>
<br/>
<a class="postlink" href="http://wiki.devkitpro.org/index.php/IRC" target="_blank">devkitPro IRC support</a>
<br/>
<a class="postlink" href="http://davejmurphy.com/" target="_blank">Personal Blog</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#176606 - kusma - Wed Aug 24, 2011 12:25 pm</h4>
    <div class="postbody"><span class="postbody">PLD is an optional instruction in ARM9, and it is very common for implementations to remove it. I suspect this is the case for the ARM9 in the DS as well.
<br/>
<br/>
When writing software that targets multiple ARM implementations, I've inserted PLDs where I'd get a register-stall anyway (e.g when I have to read a register in the instruction after one that writes it). That has helped on the chips that do implement PLD without causing any harm on those who does not.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#176607 - sverx - Wed Aug 24, 2011 12:47 pm</h4>
    <div class="postbody"><span class="postbody">wintermute: I tried moving the code to ITCM just to make sure that the opcode fetches wouldn't interfere with cache/main memory access, not to make the code faster, as it's just few bytes and it will be cached easily, of course :)
<br/>
Data interleaving is an interesting hint, even if I really have just a simple word array. I'll think about it.
<br/>
kusma: I read that PLD is an optional instruction, but unfortunately the only way I know for checking if it has been implemented or not in the DS is to test it. I still can't make it work, but I still can't assume it hasn't been implemented...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#176609 - Miked0801 - Wed Aug 24, 2011 9:28 pm</h4>
    <div class="postbody"><span class="postbody">PLD is vital to to the 3DS on its ARM chips, but does nothing on the regular DS.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#176610 - sverx - Thu Aug 25, 2011 8:35 am</h4>
    <div class="postbody"><span class="postbody">Miked0801: ... and I believe DSi is just like regular DS, or do they actually added PLD support there? I'm running my tests on a DSLite because it's what I've got ATM.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#176611 - sverx - Fri Aug 26, 2011 10:55 am</h4>
    <div class="postbody"><span class="postbody">I've found on the net this piece of code (from "Android Open Source Project"):
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">bic       r12, r1, #0x1F
<br/>
ldr       r3, [r12], #32      /* cheap ARM9 preload */</td> </tr></table><span class="postbody">
<br/>
which looks like it's aligning r12 to a cache line (8 words) and it's loading the first word from there. It makes me think that the ARM9 just waits the word he needs and that the next 7 words are loaded into the cache 'later' (thus building a kind of 'read ahead')
<br/>
<br/>
In my tests this doesn't seem to happen on DS. It's again a different ARM9 implementation?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#176637 - Miked0801 - Sun Aug 28, 2011 1:47 am</h4>
    <div class="postbody"><span class="postbody">DSi has same memory controller/CPU as the DS, jus clocked higher.  No PLD there needed either. Again, the 3DS is the first handheld that needs it from Nintendo.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#176640 - wintermute - Sun Aug 28, 2011 10:25 am</h4>
    <div class="postbody"><span class="postbody">what do you mean by "needing" PLD?<br/>_________________<br/><a class="postlink" href="http://www.devkitpro.org/" target="_blank">devkitPro - professional toolchains at amateur prices</a>
<br/>
<a class="postlink" href="http://wiki.devkitpro.org/index.php/IRC" target="_blank">devkitPro IRC support</a>
<br/>
<a class="postlink" href="http://davejmurphy.com/" target="_blank">Personal Blog</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#176645 - Miked0801 - Mon Aug 29, 2011 4:05 am</h4>
    <div class="postbody"><span class="postbody">It actually has a real (and quite small) cache.  And from personal experience, doing a memcpy without the cache being properly pipelined via PLD caused a large, nearly catastrophic slowdown in performance.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#176646 - sverx - Tue Aug 30, 2011 9:49 am</h4>
    <div class="postbody"><span class="postbody">From what I've read around it seems like that the ARM926 can </span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">stall only until the requested world is fetched, but the linefill continues in the the background</td> </tr></table><span class="postbody">... but this seems to be not the case for ARM946.
<br/>
According to ARM website, the 926 has a MMU and the 946 has no MMU (there's a MPU, which is something different) so I guess I have to forget about any kind of preload. Pity. Oh well, ok. :|
<br/>
<br/>
edit: I finally found this:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">The ARM946E-S does not perform critical word first loading on cache line fills, [...]</td> </tr></table><span class="postbody">
<br/>
<a class="postlink" href="http://infocenter.arm.com/help/index.jsp?topic=/com.arm.doc.faqs/ka3840.html" target="_blank">here</a>, or ARM website. Just to let you know.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
