<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Interleaved samples or bad code? - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>ASM > Interleaved samples or bad code?</h2>
<div id="posts">
<div class="post">
    <h4>#161202 - Ruben - Wed Jul 30, 2008 1:33 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">@ assuming that...
<br/>
@ r3: left volume | (right volume &lt;&lt; 16)
<br/>
@ r4: ROM offset
<br/>
@ r5: 22.10 offset from "ROM offset" (r4)
<br/>
@ r9: mixed samples (16 bits left, 16 bits right)
<br/>
<br/>
add      r12, r4, r5, lsr #shift
<br/>
ldrsb    r12, [r12, #0x10]
<br/>
mul      r12, r3, r12
<br/>
add      r9, r9, r12, asr #0x07   </td> </tr></table><span class="postbody">
<br/>
That's the mixing step. After doing a small calculation (16 channels * 127 max volume * (+127 highest sample) &gt; 65535), I *assume* that it would overflow if all 16 channels were active and mixed 127. So I used that division/shift before adding thing and this is in my mix-down/clipping loop:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">.LClipLoop:
<br/>
   ldrsh    ip, [r0], #0x02
<br/>
   bic      ip, ip, #0xFF00
<br/>
   mov      ip, ip, asr #0x02
<br/>
   strb     ip, [r1], #0x01
<br/>
   
<br/>
   ldrsh    ip, [r0], #0x02
<br/>
   mov      ip, ip, asr #0x02
<br/>
   strb     ip, [r3], #0x01
<br/>
   subs     r2, r2, #0x01
<br/>
   bcs      .LClipLoop</td> </tr></table><span class="postbody">
<br/>
So... I thought that all I would have to do is clear some bits of the left channel (which would be an overflow, I think) but I just get static. Any ideas why? Am I missing something TOTALLY obvious?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161204 - Ruben - Wed Jul 30, 2008 1:47 pm</h4>
    <div class="postbody"><span class="postbody">FOLLOWUP:
<br/>
On further inspection, the right channel is perfectly fine but it's the left that has the static.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161207 - eKid - Wed Jul 30, 2008 3:49 pm</h4>
    <div class="postbody"><span class="postbody">Your problem is probably here:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">add      r9, r9, r12, asr #0x07</td> </tr></table><span class="postbody">
<br/>
The top value (right output) gets shifted fine (with sign extension), but the bottom value (left output) gets the bottom bits shifted out of the top value.
<br/>
<br/>
example:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">samp = -20 [0FFFFFFECh]
<br/>
vol = 127,127 [07F007F]
<br/>
samp * vol = 0F613F614h (note also the 1 sample error you'll get with negative numbers)
<br/>
value &gt;&gt; 7 = 0FFEC27ECh = 0FFEC, 27ECh = -20, 10220 :\
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161230 - Ruben - Thu Jul 31, 2008 2:11 am</h4>
    <div class="postbody"><span class="postbody">Hmm... anyone have any idea what to do then? My mixer runs at 1.7% CPU per channel @ 18157Hz (any panning) which is... slow IMO.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161232 - eKid - Thu Jul 31, 2008 4:12 am</h4>
    <div class="postbody"><span class="postbody">Use unsigned samples :P</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161234 - Ruben - Thu Jul 31, 2008 4:19 am</h4>
    <div class="postbody"><span class="postbody">LOL!!! Unsigned samples get rid of this problem?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161235 - eKid - Thu Jul 31, 2008 4:28 am</h4>
    <div class="postbody"><span class="postbody">Something like this:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">signed sample data [-128..127]
<br/>
  -20, -10, 0, 10, 20, etc
<br/>
unsigned sample data [+128, or ^0x80]
<br/>
  108, 118, 128, 138, 148
<br/>
<br/>
during calculations:
<br/>
  add up volume of each channel (used to convert unsigned to signed during the mixdown)
<br/>
<br/>
mixing loop:
<br/>
<br/>
  read unsigned sample [can use ldrb which can shift the position register]
<br/>
  multiply by volume [left and right]
<br/>
  clear bits that will be shifted into low word [clear 0x1F0000 for 32 channels]
<br/>
  add shifted value to mix [lsr#5 for 32 channels]
<br/>
<br/>
mixdown:
<br/>
<br/>
  read sample
<br/>
  subtract volume total * x (x equals amount to match the mixing bit depth)
<br/>
  shift sample to 8-bit
<br/>
  clamp sample to -128 to 127
<br/>
  write sample to output
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161678 - Ruben - Sun Aug 10, 2008 4:53 am</h4>
    <div class="postbody"><span class="postbody">Hmm... well, OK... but that still doesn't answer my question! :P Is my hypothesis (WOOT! Learned a new word at school!) correct and causing an overflow, or am I just going nuts, lol?</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
