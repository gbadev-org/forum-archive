<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Using libfat from asm - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>ASM > Using libfat from asm</h2>
<div id="posts">
<div class="post">
    <h4>#167447 - headspin - Thu Mar 12, 2009 1:32 pm</h4>
    <div class="postbody"><span class="postbody">Were writing a game in pure asm and would like to break the 4 MB limit of the DS because we wan't some high quality music playing in the background.
<br/>
<br/>
After quite a bit of research I've found our only choice is to use libfat. We may just have to accept the fact that some "C" code will be required to support libfat, but I guess we'll have to get over that.
<br/>
<br/>
Right now I have written a <a class="postlink" href="http://members.iinet.net.au/~freeaxs/nds/libfat_demo.zip" target="_blank">libfat_demo.zip</a> where it reads two image files ("fat2:/dev/pic1.bin" and "fat2:/dev/pic2.bin") and dmacopy them into VRAM.
<br/>
<br/>
I have managed to get this working but for some reason I have to add 9108 bytes to the buffer for it to display the full picture. I have no idea where this value comes from as the data is raw and I have sucessfully dma'ed the same files using bin2o and gbfs so I'm not sure what's going wrong.
<br/>
<br/>
Here is my readFile() function
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#include &lt;stdio.h&gt;
<br/>
#include &lt;stdlib.h&gt;
<br/>
#include &lt;sys/stat.h&gt; 
<br/>
<br/>
unsigned char *buffer = NULL;
<br/>
<br/>
int readFile(char *fileName)
<br/>
{ 
<br/>
   FILE *pFile;
<br/>
   struct stat fileStat;
<br/>
   size_t result;
<br/>
   
<br/>
   if(buffer != NULL)
<br/>
      free(buffer);
<br/>
<br/>
   pFile = fopen(fileName, "rb");
<br/>
   
<br/>
   if (pFile == NULL)
<br/>
      return 0;
<br/>
<br/>
   if(fstat(pFile-&gt;_file, &amp;fileStat) &lt; 0)
<br/>
      return 0;
<br/>
<br/>
   buffer = (unsigned char *) malloc(fileStat.st_size);
<br/>
   
<br/>
   if (buffer == NULL)
<br/>
      return 0;
<br/>
<br/>
   result = fread(buffer, 1, fileStat.st_size, pFile);
<br/>
   
<br/>
   if (result != fileStat.st_size)
<br/>
      return 0;
<br/>
<br/>
   fclose(pFile);
<br/>
   
<br/>
   return fileStat.st_size;
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
And here is my code to dmacopy the buffer into VRAM
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">bl fatInitDefault
<br/>
<br/>
ldr r0, =strPic1
<br/>
bl readFile
<br/>
<br/>
mov r1, #BG_BMP_RAM(0)
<br/>
mov r2, r0
<br/>
ldr r0, =(buffer + 9108) 
<br/>
bl dmaCopy
<br/>
<br/>
ldr r0, =strPic2
<br/>
bl readFile
<br/>
<br/>
mov r1, #BG_BMP_RAM_SUB(0)
<br/>
mov r2, r0
<br/>
ldr r0, =(buffer + 9108)
<br/>
bl dmaCopy</td> </tr></table><span class="postbody">
<br/>
<br/>
Everything seems to be working fine apart from this strange 9108 byte offset. Why do I need to add that value to get the full picture displayed?
<br/>
<br/>
Also is there a way I can read the files from the same folder the .nds file is in? I seem to have to give the full path which would force people to use a file structure and I would prefer to avoid that.<br/>_________________<br/><a class="postlink" href="http://headsoft.com.au/index.php?category=warhawk" target="_blank">Warhawk DS</a> | <a class="postlink" href="http://headsoft.com.au/index.php?category=mmll" target="_blank">Manic Miner: The Lost Levels</a> | <a class="postlink" href="http://headsoft.com.au/index.php?category=tdg" target="_blank">The Detective Game</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167450 - Ruben - Thu Mar 12, 2009 3:10 pm</h4>
    <div class="postbody"><span class="postbody">Because you have to read the buffer first. :)
<br/>
<br/>
Aka..
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">ldr r0, =buffer @ Get address of unsigned char *buffer;
<br/>
ldr r0, [r0] @ Get the pointer stored in 'buffer'</td> </tr></table><span class="postbody">
<br/>
<br/>
EDIT:
<br/>
You might be able to get away with "ldr r0, buffer" to avoid 2 loads, but it will depend on the location of "buffer" (you can probably declare it in the assembler file to be sure it will be nearby).</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167468 - headspin - Thu Mar 12, 2009 11:49 pm</h4>
    <div class="postbody"><span class="postbody">Thanks for that Ruben. I can't believe I missed that. I guess that's what happens when you code tired!
<br/>
<br/>
I did notice there seems to be some buffer corruption and the very beginning and end which dispalys on the screen as a few random pixels. I have no idea what that could be.<br/>_________________<br/><a class="postlink" href="http://headsoft.com.au/index.php?category=warhawk" target="_blank">Warhawk DS</a> | <a class="postlink" href="http://headsoft.com.au/index.php?category=mmll" target="_blank">Manic Miner: The Lost Levels</a> | <a class="postlink" href="http://headsoft.com.au/index.php?category=tdg" target="_blank">The Detective Game</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167472 - elhobbs - Fri Mar 13, 2009 3:45 am</h4>
    <div class="postbody"><span class="postbody">you probably need to flush the data cache. dma bypasses the data cache and reads the memory directly.</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">DC_FlushAll();</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
