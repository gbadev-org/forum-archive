<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Invalid constant - why? - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>ASM > Invalid constant - why?</h2>
<div id="posts">
<div class="post">
    <h4>#71374 - HyperHacker - Sun Feb 12, 2006 6:07 am</h4>
    <div class="postbody"><span class="postbody">I'm trying to put some ASM code into a C program for DS:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">__asm(".arm\n"
<br/>
   "mov r2,#8000\n");</td> </tr></table><span class="postbody">
<br/>
(Not complete, obviously.)
<br/>
<br/>
The problem is if I specify a number above 8000 (decimal) in any instruction, the assembler/gcc says it's an invalid constant. What's so invalid about it?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#71378 - chishm - Sun Feb 12, 2006 7:01 am</h4>
    <div class="postbody"><span class="postbody">ARM ASM constants can only be an 8bit shifted constant. For instance, 0xff0000 (0xff &lt;&lt; 16) is valid, 0x1f40 (0xfa &lt;&lt; 5) is valid, while 0x1f41 is not. You'll notice that 8000 = 0x1f40 and is therefore valid, however 8001 = 0x1f41 and is therefore invalid.
<br/>
<br/>
On another note, THUMB ASM constants can only be an unshifted 8 bit value.<br/>_________________<br/><a class="postlink" href="http://chishm.drunkencoders.com" target="_blank">http://chishm.drunkencoders.com</a>
<br/>
<a class="postlink" href="http://dldi.drunkencoders.com" target="_blank">http://dldi.drunkencoders.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#71379 - HyperHacker - Sun Feb 12, 2006 7:08 am</h4>
    <div class="postbody"><span class="postbody">Hm, so then how do I load something arbitrary like 0x12345? Do I have to break it down into a series of shifts, like <span style="font-style: italic">(0x12 &lt;&lt; 12) | (0x34 &lt;&lt; 4) | 5</span>? Seems rather difficult to write efficient code doing that...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#71382 - DekuTree64 - Sun Feb 12, 2006 8:02 am</h4>
    <div class="postbody"><span class="postbody">The common way is to store the constant somewhere near to the current instruction, and use a pc-relative load. In fact, it's so common that the assembler has a shortcut for it:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">ldr r0, =8001
<br/>
// ...do more stuff, return from function
<br/>
<br/>
.pool</td> </tr></table><span class="postbody">
<br/>
The .pool directive tells the assembler that it can place such constants for loading there. Usually it's best to put it before the start or after the end of your function, so your code doesn't have to jump over it. You can have multiple pools too, if your function gets larger than the range of a pc-relative load (although that's pretty rare).<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#71385 - HyperHacker - Sun Feb 12, 2006 8:48 am</h4>
    <div class="postbody"><span class="postbody">Ah, that explains quite a bit. Thanks! Unfortunately, the code isn't working... I'm trying to load whatever app is on the GBA cart, as WifiMe would.
<br/>
<br/>
On ARM7, I do this:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void (*Reboot)(void) = (void(*)())0x080000C0;
<br/>
Reboot();</td> </tr></table><span class="postbody">
<br/>
<br/>
On ARM9:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void Reboot()
<br/>
{
<br/>
   IPC-&gt;arm7desc = A7_REBOOT; //Tell ARM7 to reboot
<br/>
   (*(vuint32*)0x027FFE24) = (vuint32)Reboot2;
<br/>
   Reboot2();
<br/>
}
<br/>
<br/>
<br/>
/*
<br/>
Used by Reboot().
<br/>
*/
<br/>
void Reboot2()
<br/>
{
<br/>
   __asm(".arm\n"
<br/>
   "ldr r1,=0x027FFE24\n"
<br/>
   "ldr r0,[r1]\n"
<br/>
   "mov pc,r0\n"
<br/>
   ".pool\n");
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
According to <a class="postlink" href="http://forum.gbadev.org/viewtopic.php?t=8095" target="_blank">this thread</a>, this is what WifiMe does, but it's just freezing the system.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
