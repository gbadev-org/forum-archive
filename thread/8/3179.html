<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Triangle Sort in ASM how to improve ??? - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>ASM > Triangle Sort in ASM how to improve ???</h2>
<div id="posts">
<div class="post">
    <h4>#18815 - batblaster - Tue Apr 06, 2004 12:48 am</h4>
    <div class="postbody"><span class="postbody">Hi !
<br/>
<br/>
This is my triangle sort routine in ASM , i've maded all routine in asm like rotation and fill but i think the sort is not very fast, i'm very happy if someone can help me on make it faster...
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
<br/>
@-----------------------------------------------------------------------
<br/>
@
<br/>
@   Triangle sort , this routine make the sort of triangle faces
<br/>
@   to be filled
<br/>
@
<br/>
@extern void TriangleSort(PTriangolo,void*,u32 ntriangoli);
<br/>
@
<br/>
@PTriangolo is a structure
<br/>
@-----------------------------------------------------------------------
<br/>
<br/>
.global TriangleSort
<br/>
.arm
<br/>
.align 2
<br/>
.section .iwram @, "ax", %progbits
<br/>
<br/>
@    for (i=0;i&lt;ntriangoli;i++)
<br/>
@    {
<br/>
@        z[i]=(((PPunto3D) &amp;Punti_rotati[(&amp;triang[i])-&gt;p1])-&gt;z+
<br/>
@         ((PPunto3D) &amp;Punti_rotati[(&amp;triang[i])-&gt;p2])-&gt;z+
<br/>
@         ((PPunto3D) &amp;Punti_rotati[(&amp;triang[i])-&gt;p3])-&gt;z);
<br/>
@    }
<br/>
<br/>
TriangleSort:
<br/>
    stmfd   sp!, {r4-r11, lr}
<br/>
<br/>
@Start of the routine who create the Z array, the same of the "C" version showed above
<br/>
<br/>
    mov     r5,#0
<br/>
    mov     r10,#8
<br/>
    mov     r11,#12
<br/>
    mov     r14,r1
<br/>
srtloop:
<br/>
    mov     r12,r5,lsl #4
<br/>
    ldr     r6,[r0,r12]
<br/>
    add     r12,r12,#4
<br/>
    ldr     r7,[r0,r12]
<br/>
    add     r12,r12,#4
<br/>
    ldr     r8,[r0,r12]
<br/>
    mla     r9,r6,r11,r10
<br/>
    mla     r6,r7,r11,r10
<br/>
    mla     r7,r8,r11,r10
<br/>
    ldr     r9,[r3,r9]
<br/>
    ldr     r6,[r3,r6]
<br/>
    ldr     r7,[r3,r7]
<br/>
    add     r8,r9,r6
<br/>
    add     r8,r8,r7
<br/>
    str     r8,[r14],#4
<br/>
    add     r5,r5,#1
<br/>
    cmp     r5,r2
<br/>
    bmi     srtloop
<br/>
@End of routine who make Z Array
<br/>
<br/>
    mov     r4,#1           @i=1
<br/>
sortloop:
<br/>
    mov     r5,r2,lsl #2           @numtrinagoli in r5
<br/>
sortloop2:
<br/>
    sub     r5,r5,#4        @numtriangoli will be -1 this is j
<br/>
    cmp     r5,r4           @compare j with i
<br/>
    bmi     out             @if is &lt; i will go out else &gt;= go on
<br/>
<br/>
    ldr     r6,[r1,r5]      
<br/>
    sub     r5,r5,#4        @j-1
<br/>
    ldr     r7,[r1,r5]      
<br/>
    cmp     r6,r7           @if z[j]&gt;z[j-1]
<br/>
    strgt   r6,[r1,r5]      
<br/>
    addgt   r5,r5,#4      
<br/>
    strgt   r7,[r1,r5]
<br/>
    movgt   r5,r5,lsl #2
<br/>
    ldrgt   r6,[r0,r5]
<br/>
    addgt   r5,r5,#4
<br/>
    ldrgt   r7,[r0,r5]
<br/>
    addgt   r5,r5,#4
<br/>
    ldrgt   r8,[r0,r5]
<br/>
    addgt   r5,r5,#4
<br/>
    ldrgt   r9,[r0,r5]
<br/>
    subgt   r5,r5,#12+16
<br/>
    ldrgt   r10,[r0,r5]
<br/>
    addgt   r5,r5,#4
<br/>
    ldrgt   r11,[r0,r5]
<br/>
    addgt   r5,r5,#4
<br/>
    ldrgt   r12,[r0,r5]
<br/>
    addgt   r5,r5,#4
<br/>
    ldrgt   r14,[r0,r5]
<br/>
<br/>
    strgt   r9,[r0,r5]
<br/>
    subgt   r5,r5,#4
<br/>
    strgt   r8,[r0,r5]
<br/>
    subgt   r5,r5,#4
<br/>
    strgt   r7,[r0,r5]
<br/>
    subgt   r5,r5,#4
<br/>
    strgt   r6,[r0,r5]
<br/>
    addgt   r5,r5,#16
<br/>
    strgt   r10,[r0,r5]
<br/>
    addgt   r5,r5,#4
<br/>
    strgt   r11,[r0,r5]
<br/>
    addgt   r5,r5,#4
<br/>
    strgt   r12,[r0,r5]
<br/>
    addgt   r5,r5,#4
<br/>
    strgt   r14,[r0,r5]
<br/>
    subgt   r5,r5,#12
<br/>
    movgt   r5,r5,asr #2
<br/>
    b       sortloop2
<br/>
out:
<br/>
    add     r4,r4,#1
<br/>
    cmp     r4,r2
<br/>
    bmi     sortloop
<br/>
<br/>
    ldmfd   sp!, {r4-r11, lr}
<br/>
    bx      lr
<br/>
<br/>
<br/>
THIS IS THE "C" Version of my sort, this is only the 2nd step the 1st one was showed above
<br/>
<br/>
   for (i=1;i&lt;ntriangoli;i++)
<br/>
   {
<br/>
      for (j=ntriangoli-1;j&gt;=i;j--)
<br/>
      {
<br/>
         if (z[j]&gt;z[j-1])
<br/>
         {
<br/>
            z1=z[j];
<br/>
            z[j]=z[j-1];
<br/>
            z[j-1]=z1;
<br/>
            t1=triang[j-1];
<br/>
            triang[j-1]=triang[j];
<br/>
            triang[j]=t1;
<br/>
         }
<br/>
      }
<br/>
   }
<br/>
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
The ASM version is faster then the "C" version but i think not to much, i've tried to make some changes like this:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
<br/>
    mov     r4,#1           @i=1
<br/>
sortloop:
<br/>
    mov     r5,r2,lsl #2           @numtrinagoli in r5
<br/>
sortloop2:
<br/>
    sub     r5,r5,#4        @numtriangoli will be -1 tutto this is j
<br/>
sortloop3:
<br/>
    cmp     r5,r4           @compare j with i
<br/>
    bmi     out             @if is &lt; i will go out else &gt;= go on
<br/>
<br/>
    ldr     r6,[r1,r5]      
<br/>
    sub     r5,r5,#4        @j-1
<br/>
    ldr     r7,[r1,r5]      
<br/>
    cmp     r6,r7           @if z[j]&gt;z[j-1]
<br/>
    ble     sortloop3
<br/>
<br/>
rest of code some of before
<br/>
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
But i don't know is slowly then the other...
<br/>
<br/>
Any idea on how to improve ??? 
<br/>
<br/>
To sort,rotate,fill a 86 vertex and 168 triange i take 1 entire cycle...
<br/>
<br/>
I know is possible to make it better but really i don't know...
<br/>
<br/>
Thanks a lot to DekuTree64 to help me and thanks to anyone who make all the docs i found on the arm asm intructions...
<br/>
<br/>
Thanks to anyone in advance...
<br/>
<br/>
P.S. Sorry for nomuch comments and sorry for some comment in a very bad english...<br/>_________________<br/>Batblaster / 7 Raven Studios Co. Ltd
<br/>
------------------------------------------</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#18825 - Lupin - Tue Apr 06, 2004 12:23 pm</h4>
    <div class="postbody"><span class="postbody"><a href="http://ciips.ee.uwa.edu.au/~morris/Year2/PLDS210/qsort.html" target="_blank">http://ciips.ee.uwa.edu.au/~morris/Year2/PLDS210/qsort.html</a><br/>_________________<br/><a class="postlink" href="http://pokeme.shizzle.it/" target="_blank">Team Pokeme</a>
<br/>
<a class="postlink" href="http://lupin.shizzle.it/" target="_blank">My blog and PM ASM tutorials</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#18826 - DekuTree64 - Tue Apr 06, 2004 3:54 pm</h4>
    <div class="postbody"><span class="postbody">Sorry I never got a chance to reply to your mail about this, I've been a little busy lately. 
<br/>
Quicksort would be best, but here's a litle improvement to bubble sort that's easy to do. It should still work looping backward, but I'll stick with the one I know works
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">for(i = 0; i &lt; count; i++)
<br/>
{
<br/>
   int idx = i;
<br/>
   for(j = i+1; j &lt; count; j++)
<br/>
   {
<br/>
      if(z[j] &gt; z[idx])
<br/>
         idx=j;
<br/>
   }
<br/>
   if(idx != i)
<br/>
      //swap
<br/>
}</td> </tr></table><span class="postbody"><br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#18863 - Torlus - Wed Apr 07, 2004 9:30 am</h4>
    <div class="postbody"><span class="postbody">You should consider Radix sort instead. Simple to code, and much more efficient for the purpose of triangle sorting.<br/>_________________<br/>GBA,GC,NGPC,GP32,FPGA,DS stuff at <a class="postlink" href="http://torlus.com/" target="_blank">http://torlus.com/</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#18867 - batblaster - Wed Apr 07, 2004 12:45 pm</h4>
    <div class="postbody"><span class="postbody">Thank you to anyone... I will try to make it in asm and hope will be faster hehehe... 
<br/>
<br/>
If someone doit before me please post here...
<br/>
<br/>
Thanks.....<br/>_________________<br/>Batblaster / 7 Raven Studios Co. Ltd
<br/>
------------------------------------------</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#18877 - poslundc - Wed Apr 07, 2004 6:42 pm</h4>
    <div class="postbody"><span class="postbody">Radix sort requires the use of a supplementary sorting algorithm. It is probably best when used in conjunction with counting sort, although the effectiveness of the algorithm will be determined by your available memory.
<br/>
<br/>
If you intend to use radix sort, though, make sure your sort-digits are a power of two, and not a power of ten.
<br/>
<br/>
Dan (uses insertion sort for almost everything).</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#18910 - Miked0801 - Thu Apr 08, 2004 2:01 am</h4>
    <div class="postbody"><span class="postbody">Shell sort is another nice alternative that uses less RAM/Stack the QUick and for smaller data sets, is comperable or faster.  It's what I use for sorting our actors.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#18973 - tepples - Thu Apr 08, 2004 10:32 pm</h4>
    <div class="postbody"><span class="postbody"><a class="postlink" href="http://en.wikipedia.org/wiki/Shell_sort" target="_blank">Shell sort: O(n^1.25)</a>. I have used Shell sort (decreasing gap insertion sort) for an NES game, and it worked fine. I was even able to implement it in 6502 assembly language in fewer than a half dozen tries.
<br/>
<br/>
<a class="postlink" href="http://en.wikipedia.org/wiki/Heapsort" target="_blank">Heapsort: O(n*log(n))</a>. Approaches the average case efficiency of Quicksort for large data sets.
<br/>
<br/>
Both Shell sort and Heapsort can be implemented either iteratively or with only tail recursion. Quicksort requires non-tail recursion and thus requires extra stack space. Quicksort can also degrade to O(n^2) in the worst case if your pivot choices work against you (common on sorted data unless you use middle-of-domain pivot); that won't happen with Shell sort or Heapsort.
<br/>
<br/>
See Wikipedia's <a class="postlink" href="http://en.wikipedia.org/wiki/Quicksort" target="_blank">Quicksort</a> article for details.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#20504 - sasq - Wed May 12, 2004 8:47 am</h4>
    <div class="postbody"><span class="postbody">If this is for the purpose of drawing inconvex objects, have you thought about turning the object into a BSP-tree instead? No sorting, perfect rendering with no glitches...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#20513 - Lupin - Wed May 12, 2004 12:08 pm</h4>
    <div class="postbody"><span class="postbody">BSP trees are a good idea, but you will still have to use sorting for models and such... or just use a backbuffer (will be way slower though).<br/>_________________<br/><a class="postlink" href="http://pokeme.shizzle.it/" target="_blank">Team Pokeme</a>
<br/>
<a class="postlink" href="http://lupin.shizzle.it/" target="_blank">My blog and PM ASM tutorials</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#20521 - Daniel Andersen - Wed May 12, 2004 2:07 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tepples wrote:</b></span></td> </tr> <tr> <td class="quote">Both Shell sort and Heapsort can be implemented either iteratively or with only tail recursion. Quicksort requires non-tail recursion and thus requires extra stack space.</td> </tr></table><span class="postbody">
<br/>
<br/>
Are you even sure that GCC supports tail recursion? I'm not. Anyway, it is not always possible for it to implement tail recursion dependent of how you use the local stack frame, e.g. passing on pointers to local variables etc. And since C is (very) weakly typed GCC cannot be sure with any pointers; for instance, passing on an integer in a cal in tail position might just be a pointer into the local stack frame and thus this cannot be destroyed, but there is no way for GCC to tell that.
<br/>
<br/>
True, it can be argued that passing on pointers to local variables is a bad habbit, but how does GCC care? ;)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#20872 - keldon - Tue May 18, 2004 9:49 pm</h4>
    <div class="postbody"><span class="postbody">the passing of integers is simply pushing the value of that integer onto the stack .. tail recursion - or any recursion for that matter is fine
<br/>
<br/>
Pointers are another issue - it's fine so long as you remember that they're all pointing to the same piece of data</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
