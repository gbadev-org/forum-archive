<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Questions - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>ASM > Questions</h2>
<div id="posts">
<div class="post">
    <h4>#24665 - ProblemBaby - Mon Aug 09, 2004 3:27 am</h4>
    <div class="postbody"><span class="postbody">1.
<br/>
Is this dangerous?
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
LDR r0, =address to something
<br/>
LDR r0, [r0]
<br/>
</td> </tr></table><span class="postbody">
<br/>
it works on both VBA and No$GBA havent tried on hardware but is it supposed to work or isnt it a good choice?
<br/>
<br/>
2.
<br/>
Does it exist better ways to copy things in thumb mode then this:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
LDR r3, =200
<br/>
Copy:
<br/>
LDR r2, [r0]
<br/>
STR r2, [r1]
<br/>
ADD r0, #4
<br/>
ADD r0, #4
<br/>
SUB r3, #1
<br/>
CMP r3, #0
<br/>
BNE Copy
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I would be glad if these to questions could be answered.
<br/>
thanks in advance!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#24669 - bakery2k - Mon Aug 09, 2004 5:27 am</h4>
    <div class="postbody"><span class="postbody">I'm pretty sure 1 is fine. It should work, and should not cause any performance problems.
<br/>
<br/>
I'm not sure about 2 as I haven't used thumb myself, but in ARM you can use the multiple register transfer instructions. Are these available in thumb? *checks book* Yes, they are. Using LDMIA/STMIA will be faster. Also, your last instruction before the branch, "CMP r3, #0", can be removed as the SUB will set the Z condition code for you.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#24673 - NEiM0D - Mon Aug 09, 2004 10:44 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>ProblemBaby wrote:</b></span></td> </tr> <tr> <td class="quote">1.
<br/>
Is this dangerous?
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
LDR r0, =address to something
<br/>
LDR r0, [r0]
<br/>
</td> </tr></table><span class="postbody">
<br/>
it works on both VBA and No$GBA havent tried on hardware but is it supposed to work or isnt it a good choice?
<br/>
</span></td> </tr></table><span class="postbody">
<br/>
<br/>
This should work at anytime.
<br/>
There is a problem that might occur when doing this alot:
<br/>
The literal pool range will go beyond the PC-relative offset.
<br/>
<br/>
This means you will have to tell the assembler to write the literal pool, and branch over that.
<br/>
The GCC command for writing the current literal pool is ".pool", or the ARM SDT equivalent is "LTORG".
<br/>
Example:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
b Skip_Pool
<br/>
.pool
<br/>
Skip_Pool:
<br/>
 ... continue with code...
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>ProblemBaby wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
2.
<br/>
Does it exist better ways to copy things in thumb mode then this:
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
LDR r3, =200
<br/>
Copy:
<br/>
LDR r2, [r0]
<br/>
STR r2, [r1]
<br/>
ADD r0, #4
<br/>
ADD r0, #4
<br/>
SUB r3, #1
<br/>
CMP r3, #0
<br/>
BNE Copy
<br/>
</td> </tr></table><span class="postbody">
<br/>
</span></td> </tr></table><span class="postbody">
<br/>
<br/>
I believe most thumb alu opcodes are always setting the S flags.
<br/>
So I'd say you can remove that cmp instruction.
<br/>
Also, why are you adding 4 to r0 twice?
<br/>
I think you meant r1 in the second one.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
LDR r3, =200
<br/>
Copy:
<br/>
LDR r2, [r0]
<br/>
STR r2, [r1]
<br/>
ADD r0, #4
<br/>
ADD r1, #4
<br/>
SUB r3, #1
<br/>
BNE Copy
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
The ARM equivalent of copying memory blocks is much nicer:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
LDR r3,=200
<br/>
Copy:
<br/>
LDR r2,[r0],#4
<br/>
STR r2,[r1],#4
<br/>
SUBS r3,r3,#4
<br/>
BNE Copy
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Cheers.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#24689 - DekuTree64 - Mon Aug 09, 2004 10:00 pm</h4>
    <div class="postbody"><span class="postbody">Actually, you can use the THUMB multiple load/stores to do the exact same thing as that ARM copy:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">LDR r3, =200 
<br/>
Copy: 
<br/>
LDMIA r0!, {r2}
<br/>
STMIA r1!, {r2}
<br/>
SUB r3, #1
<br/>
BNE Copy</td> </tr></table><span class="postbody">
<br/>
<br/>
And yes, that load address/load value is the normal way to do it. That's one of the main reasons it's good to put related globals in a struct, then you load the address of the struct, and all the individual vars are offset from that, or better yet, loaded with a single ldmia. 
<br/>
The other solution, if you're writing code that will be in RAM, is to define your globals right near your function, so you can load them directly by their labels (which assembles to a PC-relative load), like this:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">.section .iwram, "ax", %progbits
<br/>
.global var1
<br/>
var1:
<br/>
.word 0
<br/>
.global var2
<br/>
var2:
<br/>
.word 0
<br/>
<br/>
.global function
<br/>
.arm
<br/>
.align 2
<br/>
function:
<br/>
ldr r0, var1</td> </tr></table><span class="postbody">
<br/>
<br/>
That's kind of a hacky way to do it, but it does work if you need to do a lot of individual loading/storing and don't have a free register to store the struct address.<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#24691 - ProblemBaby - Mon Aug 09, 2004 11:54 pm</h4>
    <div class="postbody"><span class="postbody">Thanks for the posts!
<br/>
it really helped
<br/>
<br/>
Ive one more question ive a ASM-function that is called from C the prototype looks something like this:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
void Print(u8 x, u8 y, char *text)
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
it doesnt work good at all if I send the same pointer text pointer to the function the  second time it doesnt work. I tried to dont increment the pointer at all but it was still changed. Is it something that Ive to know about this kind of function??[/code]</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#24692 - DekuTree64 - Tue Aug 10, 2004 12:08 am</h4>
    <div class="postbody"><span class="postbody">You can increment the pointer all you want, because it's only copied into a register when calling the function (r2, in this case), just as long as you don't modify the data that it's pointing to (which you most likely aren't doing). I don't know why it would work once and not twice though. Would you mind posting some code from the Print function?<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#24693 - ProblemBaby - Tue Aug 10, 2004 12:28 am</h4>
    <div class="postbody"><span class="postbody">Sure!
<br/>
Note: that this isnt optimized yet
<br/>
<br/>
r2 is the string
<br/>
r0 is where the text started
<br/>
r1 is where the next char should be putted
<br/>
the font is 8x16 so ive to copy twice
<br/>
as you can see in the code maybe its a bit tricky to understand how the map is organized but its quite simple the top tile of for example char 'A'
<br/>
is stored at mapFont['A']
<br/>
and the second part is at mapFont['A'+128]
<br/>
this is to make it easy to copy
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
CopyCharacter:
<br/>
      LDRB r3, [r2]
<br/>
      
<br/>
      CMP r3, #0
<br/>
      BEQ Finished
<br/>
      CMP r3, #'\n'
<br/>
      BNE NoNewRow
<br/>
      
<br/>
      ADD r0, #128
<br/>
      MOV r1, r0
<br/>
      ADD r2, #1
<br/>
      B CopyCharacter
<br/>
   NoNewRow:      
<br/>
<br/>
      LSL r3, #1
<br/>
      LDR r4, =g_mapFont
<br/>
      ADD r4, r3
<br/>
      
<br/>
      LDRH r3, [r4]      
<br/>
      STRH r3, [r1]
<br/>
      ADD r4, #128
<br/>
      ADD r4, #128
<br/>
      ADD r1, #64
<br/>
      LDRH r3, [r4]
<br/>
      STRH r3, [r1]
<br/>
      
<br/>
      SUB r1, #62
<br/>
      ADD r2, #1
<br/>
      B CopyCharacter
<br/>
   Finished:
<br/>
      BX lr
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#24698 - jd - Tue Aug 10, 2004 12:59 am</h4>
    <div class="postbody"><span class="postbody">You don't seem to be restoring the value of r4 before returning. This could possibly cause the problem you mentioned. Quick fix: use r12 instead of r4. (You are allowed to corrupt r0-r3 and r12. Everything else must be restored before returning from the function.)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#24700 - ProblemBaby - Tue Aug 10, 2004 1:09 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>jd wrote:</b></span></td> </tr> <tr> <td class="quote">(You are allowed to corrupt r0-r3 and r12. Everything else must be restored before returning from the function.)</td> </tr></table><span class="postbody">
<br/>
<br/>
Thanks I had no idea of that.
<br/>
Sadly it didnt solve the problem!
<br/>
But ive used r4,r5,r6,r7 in other functions without store them
<br/>
maybe the compiler (and if i Call it from C) fix this automataclly???</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#24701 - ProblemBaby - Tue Aug 10, 2004 1:32 am</h4>
    <div class="postbody"><span class="postbody">the code is in thumb mode is it still possible to use r12???</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#24705 - jd - Tue Aug 10, 2004 2:47 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>ProblemBaby wrote:</b></span></td> </tr> <tr> <td class="quote">the code is in thumb mode is it still possible to use r12???</td> </tr></table><span class="postbody">
<br/>
<br/>
I must confess, I'm not sure. I forgot the code was thumb - I've only really used ARM myself but I would assume the rules are the same.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#24706 - ProblemBaby - Tue Aug 10, 2004 2:51 am</h4>
    <div class="postbody"><span class="postbody">jd: 
<br/>
I solved the problem first time I tried I made something wrong
<br/>
but now it works many thanks!
<br/>
<br/>
I doesnt seems to work to use r12
<br/>
i tried this simple thing
<br/>
LDR r12, =20
<br/>
and the compiler gaved me error.
<br/>
Maybe I can use it in other ways?
<br/>
<br/>
and then I wonder if it take long time to push variables on the stack?
<br/>
for example is it worth to use one more register instead of the two ADDs?
<br/>
it will be called quite many times if the string is long!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#24709 - jd - Tue Aug 10, 2004 3:09 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>ProblemBaby wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
I doesnt seems to work to use r12
<br/>
i tried this simple thing
<br/>
LDR r12, =20
<br/>
and the compiler gaved me error.
<br/>
Maybe I can use it in other ways?
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I seem to remember that thumb imposes limitations on which instructions can use which registers, so that might be the problem you're running into here. Personally, I'd recommend avoiding thumb assembler and using ARM assembler in IWRAM instead if you need performance as it's easier and faster. If you don't need performance then C compiled as thumb in ROM would be a better choice IMHO. Still, it's up to you.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>ProblemBaby wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
and then I wonder if it take long time to push variables on the stack?
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Accessing the stack is pretty quick.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>ProblemBaby wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
for example is it worth to use one more register instead of the two ADDs?
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
That depends on how many times you expect the extra ADD to be used, and also what type of memory your code and the stack is in.
<br/>
<br/>
(Although if you were using ARM you'd be able to get rid of both of the ADDs and a lot more besides. :)</span><span class="gensmall"><br/><br/>Last edited by jd on Tue Aug 10, 2004 3:24 am; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#24710 - DekuTree64 - Tue Aug 10, 2004 3:13 am</h4>
    <div class="postbody"><span class="postbody">Glad to hear you got it working. I couldn't figure out what was wrong with it, so I'd planned on giving it a closer look later. 
<br/>
<br/>
As for r12, there is nothing 'actually' special about it, only that the ARM procedure call standard says that you can corrupt it, which means that compilers will make sure it's preserved when calling functions. Accessing it in THUMB is the same as the other upper regs, using special variations of some instructions (mov and add I know can do it, maybe sub). Generally you can just ignore it in THUMB mode, and store/load r4-r7 on the stack using push and pop. Push does exactly the same thing as a stmfd in ARM, and pop is an ldmfd. Push takes 1+NumberOfRegs cycles to execute, and pop takes 2+numberOfRegs. Since the stack is in IWRAM, you don't have any waitstates, so those are the exact times. 
<br/>
<br/>
Most of the time, you can just push as many regs as you want right at the start of a function and pop them right at the end, so you never have to worry about them inbetween. One push/pop per function call won't matter at all in the long run, unless it's in an inner loop that gets called a lot, and then you can just make the outer loop in ASM too, so you know what's in each reg when it gets called, and don't have to do any preserving/loading new things in at all<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#24887 - ProblemBaby - Fri Aug 13, 2004 1:50 am</h4>
    <div class="postbody"><span class="postbody">Ive one more question=)
<br/>
if I want to make a function that takes more then 4 parameters
<br/>
what happans then??
<br/>
are they stored in r4, r5... or in another place?
<br/>
if they arent stored in another place: what happens with the law that says
<br/>
that I only can use r0-r3 and have to push the other onto the stack before I can use them??
<br/>
<br/>
Thanks!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#24888 - jd - Fri Aug 13, 2004 2:02 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>ProblemBaby wrote:</b></span></td> </tr> <tr> <td class="quote">Ive one more question=)
<br/>
if I want to make a function that takes more then 4 parameters
<br/>
what happans then??
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
The extra parameters go on the stack.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#24889 - ProblemBaby - Fri Aug 13, 2004 2:39 am</h4>
    <div class="postbody"><span class="postbody">So I get them by doing this:
<br/>
POP { r4, r5... }?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#24890 - tepples - Fri Aug 13, 2004 3:01 am</h4>
    <div class="postbody"><span class="postbody">You have to save r4-r11 and r14 before you can load arguments into them.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#24891 - poslundc - Fri Aug 13, 2004 3:09 am</h4>
    <div class="postbody"><span class="postbody">You don't want to change the stack pointer when retrieving them. The parameters ought to be left on the stack at the end of your routine. If necessary, make a copy of your stack pointer and use that.
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#24893 - DekuTree64 - Fri Aug 13, 2004 4:09 am</h4>
    <div class="postbody"><span class="postbody">Yes, it's kind of irritating, especially in THUMB mode. You have to push some regs, and then load from sp+4*numberOfRegsPushed. In ARM, you can just copy the stack pointer to r12 (because it's free), then push the regs onto the stack, and load from r12. In THUMB, you can do about the same thing, but with 2 wasted instructions (mov to r12, push, mov r12 to something else, or push, mov sp to something, and add an offset to that). But then if you have enough args to be worth ldmia'ing, you most likely won't have any regs left to work in, so then it's easiest to just load them one at a time as needed, offsetting from sp. Another nice trick is to use
<br/>
.equ var, offset
<br/>
to define your stack vars, and that way you can account for the regs you push at the start and then never worry about it again.<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#24903 - ProblemBaby - Fri Aug 13, 2004 12:09 pm</h4>
    <div class="postbody"><span class="postbody">Hmm, I want it to be easy to use in C-code
<br/>
I didnt exactly got what you meant.
<br/>
Maybe one of you can add some code to this down below:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
<br/>
@ this function takes 7 arguments
<br/>
.thumb_func
<br/>
.ManyArgFunc
<br/>
ManyArgFunc:
<br/>
<br/>
@ ???
<br/>
<br/>
bx lr
<br/>
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#24904 - DKL - Fri Aug 13, 2004 1:10 pm</h4>
    <div class="postbody"><span class="postbody">In thumb mode, it would be something like this :
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
@ this function takes 7 arguments 
<br/>
.THUMB_FUNC
<br/>
<br/>
ManyArgFunc: 
<br/>
<br/>
push  {r4-r7, lr}
<br/>
add   r7, sp, #20
<br/>
ldmia r7!, {r4-r6}
<br/>
<br/>
...
<br/>
r0 to r6 contain the 7 parameters
<br/>
...
<br/>
<br/>
mov r0, (a return_value)
<br/>
<br/>
pop {r4-r7, lr}
<br/>
bx lr 
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
just an example, not tested but should be correct,
<br/>
take a look at my LZSS source, if you want an example for ARM mode.
<br/>
<br/>
See <a class="postlink" href="http://www.arm.com/products/DevTools/abi/aapcs.pdf" target="_blank">http://www.arm.com/products/DevTools/abi/aapcs.pdf</a> too.
<br/>
<br/>
Happy coding,
<br/>
DKL</span><span class="gensmall"><br/><br/>Last edited by DKL on Tue Aug 17, 2004 10:19 am; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#24933 - f(DarkAngel) - Fri Aug 13, 2004 6:19 pm</h4>
    <div class="postbody"><span class="postbody">In case you're familiar with x86 assembly, it's similar to cdecl calling convention for the parameters after 4th. The callee pushes and pops the parameters.
<br/>
<br/>
You don't actually do push/pop anything though. Using ldr will usually be faster (depends on what you actually doing though, you might alter the stack etc).<br/>_________________<br/>death scream...</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
