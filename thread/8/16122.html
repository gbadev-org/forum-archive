<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Asm problems - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>ASM > Asm problems</h2>
<div id="posts">
<div class="post">
    <h4>#163785 - cualquiercosa327 - Sat Oct 11, 2008 2:58 pm</h4>
    <div class="postbody"><span class="postbody">Hello , i would like ask some help with this asm.
<br/>
It is the code was created to use the ds motion pack with mario kart and other games.
<br/>
it patchs the game when you press select+start and let you use the cartidge for moving the game.But it doesnt work to me.
<br/>
I have a TTDS card.I know other codes works for me,i tried the "demo" of mario ds with an ar code and it works,but the part select+start has to be deleted also.
<br/>
<br/>
here are the code:
<br/>
<br/>
<br/>
<br/>
push {r0-r7}
<br/>
ldr r0,values 
<br/>
ldrh r1,data 
<br/>
ldr r2,values+4 
<br/>
ldrh r3,data+2
<br/>
cmp r1,#0 
<br/>
ldreqh r4,[r0]
<br/>
tsteq r4,#4
<br/>
tsteq r4,#8
<br/>
cmpeq r1,#0
<br/>
moveq r1,#1
<br/>
streq r1,data
<br/>
cmp r1,#1
<br/>
bne end
<br/>
mov r4,#0x02000000
<br/>
add r5,r4,r3,lsl #0x10
<br/>
add r3,#0x1
<br/>
strh r3,data+2
<br/>
add r6,r4,r3,lsl #0x10
<br/>
loop:
<br/>
ldr r7,[r5],#4
<br/>
cmp r7,r0
<br/>
streq r4,[r5,#-4]
<br/>
cmp r5,r6
<br/>
blt loop
<br/>
cmp r3,#0x40
<br/>
moveq r3,#0
<br/>
streq r3,data
<br/>
streq r3,data+2
<br/>
end:
<br/>
pop {r0-r7}
<br/>
bx r14
<br/>
values:
<br/>
.word 0x04000130
<br/>
.word 0x02400000
<br/>
data:
<br/>
.word 0x00000000
<br/>
<br/>
<br/>
<br/>
<br/>
i would like know what part is the select+start code,and delete or maybe change for "if i press L" as example.
<br/>
<br/>
I was trying to understand the code and  i deleted this :
<br/>
cmp r1,#0 //compara r1 con 0
<br/>
<br/>
ldreqh r4,[r0]
<br/>
<br/>
tsteq r4,#4
<br/>
<br/>
tsteq r4,#8
<br/>
<br/>
cmpeq r1,#0
<br/>
<br/>
moveq r1,#1
<br/>
<br/>
streq r1,data
<br/>
<br/>
cmp r1,#1
<br/>
<br/>
bne end
<br/>
<br/>
but i am unable to make it works :(
<br/>
<br/>
thanks</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#163789 - Miked0801 - Sat Oct 11, 2008 6:01 pm</h4>
    <div class="postbody"><span class="postbody">tsteq r4,#4 
<br/>
tsteq r4,#8 
<br/>
<br/>
These two lines are what test for start+select.  To check for L-Button instead, use:
<br/>
<br/>
tsteq  r4,#0x20
<br/>
<br/>
with the rest of the code the same.
<br/>
<br/>
BTW, this assembler code is obviously hand-written and also is overly complex for what it has to do.  It feels like someone showing off who has no business showing off.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#163792 - cualquiercosa327 - Sat Oct 11, 2008 9:05 pm</h4>
    <div class="postbody"><span class="postbody">a lot of thanks
<br/>
i am going to test it now</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#163793 - cualquiercosa327 - Sat Oct 11, 2008 10:35 pm</h4>
    <div class="postbody"><span class="postbody">i deleted this part ,and also tried to change the select+start code for L,but it also doesnt work.
<br/>
I think it would be the error ,but it seem not.(in the example of asmtoar it was).I have trying several thing but i am new with asm code.
<br/>
<br/>
this is the other second part of the code
<br/>
<br/>
push {r0-r5}
<br/>
mov r5,#0x04000000
<br/>
ldr r5,[r5,#0x130]
<br/>
ldrh r1,counter
<br/>
add r1,r1,#1
<br/>
strh r1,counter
<br/>
mov r2,#0x0A000000
<br/>
mov r3,#0x02000000
<br/>
mov r4,#2
<br/>
tst r1,#2
<br/>
addne r4,#2
<br/>
tst r1,#1
<br/>
ldrneb r0,[r2]
<br/>
ldreqb r1,[r2,r4]
<br/>
beq end
<br/>
tst r1,#2
<br/>
bne Y
<br/>
cmp r0,#0x71
<br/>
biclt r5,#0x010
<br/>
cmp r0,#0x8f
<br/>
bicgt r5,#0x020
<br/>
strh r5,counter+2
<br/>
b end
<br/>
Y:
<br/>
ldrh r5,counter+2
<br/>
cmp r0,#0x71
<br/>
biclt r5,#0x040
<br/>
cmp r0,#0x8f
<br/>
bicgt r5,#0x080
<br/>
strh r5,[r3]
<br/>
end:
<br/>
pop {r0-r5}
<br/>
bx r14
<br/>
counter:
<br/>
.word 0x00000000
<br/>
<br/>
some idea why it doesnt work?? (or a easier way to write it),the idea is
<br/>
 reading the pad and the dsmotion pack(and/or other cartidge), and "join" them together.
<br/>
<br/>
a lot of thanks
<br/>
<br/>
I am trying a lot of tests,(i also tried use the wario ware cartidge before using this code as base and adapting to wario cartidge but also i was unable to make it working). 
<br/>
Now i have just bought a dsmotion pak  and the original code also doesnt work :(</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#163844 - Miked0801 - Mon Oct 13, 2008 6:36 pm</h4>
    <div class="postbody"><span class="postbody">Honestly, without all the code in front of me and a lot of spare time (which I don't have at the moment), I'm not going to be able to do this for you.  The previous example was reading bits from the input port.  That was easy to figure out.  Your new example is reading from all over the place, without comments, and that makes it a pain to figure out.  I'll let others give it a shot if they wish. :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#163859 - cualquiercosa327 - Mon Oct 13, 2008 9:48 pm</h4>
    <div class="postbody"><span class="postbody">ok,thanks  Miked0801.
<br/>
I have comment the second code.It took me a lot of time,but now i am able to understand it,but i go on without having sucessfull with it.
<br/>
I go on with it,but thanks
<br/>
Dani</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#163890 - Cearn - Tue Oct 14, 2008 3:41 pm</h4>
    <div class="postbody"><span class="postbody">This, as far as I can tell, is what those two routines are doing:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
struct { 
<br/>
   u16 isPatched;      //!&lt; Check to see if the patching's been done.
<br/>
   u16   block;         //!&lt; Block index in RAM (used for patch progress).
<br/>
} ALIGN(4) gMotionPatch;   // aka data
<br/>
<br/>
u16   counter[2]= { 0, 0 };
<br/>
   
<br/>
void sub_1(void)
<br/>
{   
<br/>
   if(gMotionPatch.isPatched==0)
<br/>
   {
<br/>
      // Select and Start are both down: start patching.
<br/>
      keys= REG_KEYINPUT;
<br/>
      if((~keys&amp;KEY_START) &amp;&amp; (~keys&amp;KEY_SELECT))
<br/>
      {
<br/>
         gMotionPatch.isPatched= 1;
<br/>
         gMotionPatch.block= 0;
<br/>
      }
<br/>
   }
<br/>
   
<br/>
   if(gMotionPatch.isPatched!=1)
<br/>
      return;
<br/>
   
<br/>
   // If we're here, we're patching.
<br/>
   
<br/>
   u32 *ptr= &amp;MAINRAM32[gMotionPatch.block*0x4000];
<br/>
   gMotionPatch.block++;
<br/>
   
<br/>
   // Find a reference to the REG_INPUT register in a section of 
<br/>
   // RAM and redirect it to the start of MAINRAM.
<br/>
   for(i=0; i&lt;0x4000; i++)
<br/>
   {
<br/>
      if(ptr[i] == (u32)&amp;REG_KEYINPUT)
<br/>
         ptr[i]= (u32)MAINRAM;         
<br/>
   }
<br/>
   
<br/>
   // Err ...
<br/>
   if(gMotionPatch.block==0x40)
<br/>
   {
<br/>
      gMotionPatch.isPatched= 0;
<br/>
      gMotionPatch.block= 0;   
<br/>
   }
<br/>
}
<br/>
<br/>
<br/>
void sub_2(void)
<br/>
{
<br/>
   keys= REG_KEYINPUT;
<br/>
   counter[0]++;
<br/>
<br/>
   if(counter[0] &amp; 2)
<br/>
      r4= 4;
<br/>
   else
<br/>
      r4= 2;
<br/>
      
<br/>
   if(counter[0] &amp; 1)
<br/>
   {
<br/>
      r0= SRAM[0];
<br/>
      if(counter[1] &amp; 2)         // Y part
<br/>
      {
<br/>
         keys= counter[1];
<br/>
         if(r0 &lt;= 0x70)
<br/>
            keys &amp;= ~KEY_UP;
<br/>
         if(r0 &gt;= 0x90)
<br/>
            keys &amp;= ~KEY_DOWN;
<br/>
            
<br/>
         MAINRAM16[0]= keys;   
<br/>
      }
<br/>
      else                  // X part
<br/>
      {
<br/>
         if(r0 &lt;= 0x70)
<br/>
            keys &amp;= ~KEY_RIGHT;
<br/>
         if(r0 &gt;= 0x90)
<br/>
            keys &amp;= ~KEY_LEFT;
<br/>
            
<br/>
         counter[1]= keys;
<br/>
      }
<br/>
   }
<br/>
   else
<br/>
   {
<br/>
      r1= SRAM[r4];   // no-op ???
<br/>
   }
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
What I've called sub_1 seems to do the patching, or at least part of it. If St+Se are down, it goes to a patching loop that searches out references to REG_KEYINPUT in RAM and replaces them with a link to the start of Main RAM. I think the idea is that the motion-control routine updates the values there and any routine that used REG_KEYINPUT will use those values instead. Note that the patch-loop runs in 0x10000-byte blocks, but it looks like only the first block is actually patched. If there is code in higher blocks, I think they will still use the regular keypad. Of course, any data at the start of Main RAM will be overridden. Let's hope it wasn't important.
<br/>
<br/>
The second routine is probably the motion-control routine itself. counter[0] is probably a frame counter, and every two frames data from the motion pack (via SRAM) is read. In the counter[1] conditional blocks, the direction-bits in the key-input is overridden by checking the motion values against a dead-zone (the 0x70-0x90 range, apparently). 
<br/>
<br/>
At least, that's what the code is trying to do. The `r1= SRAM[r4]' (corresponding to the `ldreqb r1,[r2,r4]' in the middle somewhere) seems to be a no-op. I think some NE or EQ may have been wrong there.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#164273 - cualquiercosa327 - Sat Oct 25, 2008 10:44 am</h4>
    <div class="postbody"><span class="postbody">Thanks cearn.Excuse me for answering so later,i had read the post but i have not answer.
<br/>
<br/>
Yesterday night i was reading and "undersanding" your code.
<br/>
i have two question 
<br/>
1)what make r4 in void sub_2(void) ??
<br/>
2)Where read (in your code and/or asm code ) the motion 
<br/>
<br/>
thanks</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
