<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Malloc in x86/ARM assembly(And IDA Pro Free things) - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>ASM > Malloc in x86/ARM assembly(And IDA Pro Free things)</h2>
<div id="posts">
<div class="post">
    <h4>#158951 - yellowstar - Mon Jun 23, 2008 3:34 am</h4>
    <div class="postbody"><span class="postbody">Could somebody explain this?
<br/>
<br/>
IDA Pro Free disassembly of a exported function in my Wmb Asm module:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
                 public _Z17pcap_open_offlinePKcPc
<br/>
.text:10001360 _Z17pcap_open_offlinePKcPc proc near
<br/>
.text:10001360
<br/>
.text:10001360 var_28          = dword ptr -28h
<br/>
.text:10001360 var_24          = dword ptr -24h
<br/>
.text:10001360 var_20          = dword ptr -20h
<br/>
.text:10001360 var_1C          = dword ptr -1Ch
<br/>
.text:10001360 arg_0           = dword ptr  8
<br/>
.text:10001360
<br/>
.text:10001360                 push    ebp             ; 1C number is size of capture header structure
<br/>
.text:10001361                 mov     ebp, esp
<br/>
.text:10001363                 push    edi
<br/>
.text:10001364                 push    esi
<br/>
.text:10001365                 push    ebx
<br/>
.text:10001366                 sub     esp, 1Ch        ; void *
<br/>
.text:10001369                 mov     [esp+28h+var_28], 19h
<br/>
.text:10001370                 call    malloc
<br/>
.text:10001375                 mov     ds:lvarpcaplibpcap_open_offline_cap, eax
<br/>
<br/>
...
<br/>
<br/>
mov     esi, ds:lvarpcaplibpcap_open_offline_cap
<br/>
.text:10001438                 mov     [esp+28h+var_28], esi
<br/>
.text:1000143B
<br/>
.text:1000143B loc_1000143B:                           ; CODE XREF: _Z17pcap_open_offlinePKcPc+22Fj
<br/>
.text:1000143B                 call    free
<br/>
.text:10001440                 xor     ecx, ecx
<br/>
.text:10001442
<br/>
.text:10001442 loc_10001442:                           ; CODE XREF: _Z17pcap_open_offlinePKcPc+20j
<br/>
.text:10001442                                         ; _Z17pcap_open_offlinePKcPc+8Fj ...
<br/>
.text:10001442                 add     esp, 1Ch
<br/>
.text:10001445                 mov     eax, ecx
<br/>
.text:10001447                 pop     ebx
<br/>
.text:10001448                 pop     esi
<br/>
.text:10001449                 pop     edi
<br/>
.text:1000144A                 pop     ebp
<br/>
.text:1000144B                 retn                    ; void *
<br/>
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
This would most likely be very similar in ARM assembly, instead of x86. (Register names aside)Anyway: I know the esp register points to the stack. I know with x86/Intel CPUs, the stack grows backwards. So the sub mnemonic would make the stack grow, will add will make the stack shrink. The size that's it's changing the stack with these mnemonics, that's 0x1C. The size of the capture header. Then after the add mnemonic, it does a mov, putting 0x19 in the stack, were esp points. How does malloc know how much to allocate? 0x19 is 3 bytes smaller than 0x1C. Does malloc word-align the value passed to it via stack?(parameter, I think)
<br/>
Does it use the values subtracted from esp? So would subtract ebp by esp to get the amount to allocate? I tried to look at the dissassembly for malloc, but I couldn't - only got something similar to a header. )-:
<br/>
<br/>
I'd much rather RE/disassemble NDS/ARM code, but with IDA Pro Free, the only processors it supports is x86 processors on PC. And the only loaders available are PC only. The commercial has these things, but that's $500. It seems to be possible to add this processors myself with the Free version and the IDA Pro SDK, but on the web site they only have the SDK for IDA 5.2. And the free version is 4.9. I need SDK version 4.9, for the commercial version.(The SDK is free) 
<br/>
Unfortunately, the SDK can't be used with the free IDA Pro without patching. I have that patch, just not the SDK. Does anybody know where I can download it? Unfortunately, loaders/processor modules have to be made specifically for the free version with that patch. Plugins that aren't built for that, and aren't made with SDK version 4.9 too probably, won't work with the free version.(But there seems to be a tool to patch plugins so they work with the free version)
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
Processor modules are blocked by the free version. 
<br/>
</td> </tr></table><span class="postbody">
<br/>
)-: But I heard that the processor modules, and even the the loaders, are encrypted. But that might be only in the commercial version, that they would be encrypted. Encrypting modules in the commercial version would make a lot of sense. There's this private key unique to each copy of IDA Pro. The modules are encrypted with this key.(However there might be more things done for this, I don't remember. I read this in a tutorial about this)
<br/>
<br/>
EDIT:
<br/>
I guess there is not encryption in IDA Pro Free. I checked one processor module in an hex editor, and the strings weren't incomplete or anything. That tutorial said if there incomplete/scrambled/and such, the file is encrypted.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#158954 - tepples - Mon Jun 23, 2008 4:38 am</h4>
    <div class="postbody"><span class="postbody">Have you checked GNU Binutils to see if it has a disassembler? If so, you might be able to disassemble devkitARM's libc that way.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#158955 - eKid - Mon Jun 23, 2008 4:50 am</h4>
    <div class="postbody"><span class="postbody">arm-eabi-objdump can disassemble things, I haven't played with it much though.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#158974 - yellowstar - Mon Jun 23, 2008 4:33 pm</h4>
    <div class="postbody"><span class="postbody">Strange... When I ran objdump with cmd.exe for the first time, it worked fine, but after that, Windows kept reporting the program was not a valid Win32 application... And cmd.exe reports "access denied".
<br/>
<br/>
I know ndstool can disassemble, but I'd prefer a tool with a GUI, and supports ARM, and maybe even PPC.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#159085 - gladius - Wed Jun 25, 2008 6:03 am</h4>
    <div class="postbody"><span class="postbody">What is the real goal of disassembling malloc?  It would be easier to help if we knew the real problem :).  You probably don't want to try to map what is happening in x86 to what would happen in ARM.  The calling conventions are completely different, which are how arguments are passed to functions.  That has a major impact on how the stack is handled and the way functions are written.
<br/>
<br/>
arm-eabi-objdump is a pretty effective disassembler (text wise) actually.  It sounds like you might have overwritten the exe when you used it the first time, so I'd re-download it.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#159087 - yellowstar - Wed Jun 25, 2008 6:19 am</h4>
    <div class="postbody"><span class="postbody">What I want to know is, how does malloc know how much memory the program wants to allocate? I'll try that sometime gladius.
<br/>
<br/>
A few days ago I found the IDA Pro 4.9 SDK, but I couldn't get the samples to compile... )-: I read that the commercial plugins aren't compatible with the free version, unless they are built with a certain patch. And that patch is only for Visual Studio. Is this because there's only problems with VS, or is this a problem with all compilers?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#159097 - tepples - Wed Jun 25, 2008 12:56 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>yellowstar wrote:</b></span></td> </tr> <tr> <td class="quote">What I want to know is, how does malloc know how much memory the program wants to allocate?</td> </tr></table><span class="postbody">
<br/>
In the ARM procedure call standard, the first four arguments to a function are passed in r0 through r3. This means malloc() looks at r0 to see how many bytes to allocate.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#159098 - Dwedit - Wed Jun 25, 2008 1:05 pm</h4>
    <div class="postbody"><span class="postbody">(post being edited)<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#159108 - yellowstar - Wed Jun 25, 2008 4:23 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tepples wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>yellowstar wrote:</b></span></td> </tr> <tr> <td class="quote">What I want to know is, how does malloc know how much memory the program wants to allocate?</td> </tr></table><span class="postbody">
<br/>
In the ARM procedure call standard, the first four arguments to a function are passed in r0 through r3. This means malloc() looks at r0 to see how many bytes to allocate.</span></td> </tr></table><span class="postbody">
<br/>
So what would the x86 version be?(Yes, I know this forum is for mainly ARM assembly...)
<br/>
The stack is used for for function parameters in x86, but the value passed isn't the same as the the value that I'm allocating in my C++ code...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#159109 - silent_code - Wed Jun 25, 2008 4:47 pm</h4>
    <div class="postbody"><span class="postbody">Random thought: Maybe that's due to paging or something simillar?<br/>_________________<br/><span style="font-size: 9px; line-height: normal"><span style="text-decoration: underline"><span style="font-weight: bold"></span></span> July 5th 08: "<span style="font-weight: bold">Volumetric Shadow Demo</span>" 1.6.0 (final) source released
<br/>
June 5th 08: "<span style="font-weight: bold">Zombie NDS</span>" WIP released!
<br/>
It's all on my page, just click <span style="font-weight: bold">WWW</span> below.</span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#159117 - tepples - Wed Jun 25, 2008 7:25 pm</h4>
    <div class="postbody"><span class="postbody">Are you using C++? An implementation of operator new MAY[1] just pass the object's size down to malloc(), but it is not REQUIRED to. To help fight <a class="postlink" href="http://en.wikipedia.org/wiki/Fragmentation_%28computer%29#External_fragmentation" target="_blank">memory fragmentation</a>, some implementations of operator new use malloc() to allocate pools of objects with similar sizes and then allocate chunks within those pools.
<br/>
<br/>
<span style="font-size: 10px; line-height: normal">[1] <a class="postlink" href="http://www.faqs.org/rfcs/rfc2119.html" target="_blank">RFC 2119</a> defines "MAY".</span><br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#159119 - Maxxie - Wed Jun 25, 2008 8:15 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>yellowstar wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
So what would the x86 version be?(Yes, I know this forum is for mainly ARM assembly...)
<br/>
The stack is used for for function parameters in x86, but the value passed isn't the same as the the value that I'm allocating in my C++ code...</td> </tr></table><span class="postbody">
<br/>
<br/>
There are some different calling standards.
<br/>
<br/>
The c-calling standard for x86 would be to push arguments from right to left and let the caller clean up afterwards. Return values are passed in EAX.
<br/>
<br/>
stdcall would require the callee to clean up.
<br/>
<br/>
So a malloc call (clearly a c call) to allocate 10 bytes under flat windows 32bit memory layout, with stack growing down (configureable via d-bit in flags) would look like 
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
PUSH 0x0000000A
<br/>
CALL @malloc 
<br/>
ADD esp,4
<br/>
</td> </tr></table><span class="postbody">
<br/>
The pointer is returned in EAX.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#159120 - Dwedit - Wed Jun 25, 2008 8:31 pm</h4>
    <div class="postbody"><span class="postbody">You can also just go to newlib's website and read their code to malloc if you're interested in how it works.<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#159180 - yellowstar - Thu Jun 26, 2008 4:10 pm</h4>
    <div class="postbody"><span class="postbody">Yes, I'm using C++, but I'm mainly using only malloc, not new.(New is used in the assembly stage, I guess I should switch it back to malloc...)
<br/>
<br/>
I need a disassembly of malloc, not C code, as this is assembly I'm working with.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#159199 - tepples - Thu Jun 26, 2008 9:13 pm</h4>
    <div class="postbody"><span class="postbody">You can get the assembly code corresponding to any C or C++ code by using <span style="font-weight: bold">gcc -S</span> where you would otherwise use <span style="font-weight: bold">gcc -c</span>.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#159211 - yellowstar - Fri Jun 27, 2008 4:29 am</h4>
    <div class="postbody"><span class="postbody">I can't get g++ to output the assembly...(With Dev-Cpp)
<br/>
I tried using g++.exe -c -s, but that didn't work.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#159219 - Dwedit - Fri Jun 27, 2008 12:35 pm</h4>
    <div class="postbody"><span class="postbody">gcc -S -O2 -c file.c -o output.s
<br/>
<br/>
must be a captial -S, not a small -s.<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#159223 - yellowstar - Fri Jun 27, 2008 2:32 pm</h4>
    <div class="postbody"><span class="postbody">That worked, kind of. I got the assembly for dllmain, but it won't work correctly for the wmb cpp code...(Compiling errors. )-: )</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#159229 - tepples - Fri Jun 27, 2008 7:30 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>yellowstar wrote:</b></span></td> </tr> <tr> <td class="quote">(Compiling errors. )-: )</td> </tr></table><span class="postbody">
<br/>
Please paste them.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#159231 - yellowstar - Fri Jun 27, 2008 9:02 pm</h4>
    <div class="postbody"><span class="postbody">Hmm... Apparently it did work at some point, I just didn't notice the assembly file... But I don't see any malloc dissembly anywhere...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#159232 - tepples - Fri Jun 27, 2008 9:34 pm</h4>
    <div class="postbody"><span class="postbody">When you use gcc -S, you should specify the name of an assembly language file, not an object file, after -o.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#159236 - Dwedit - Fri Jun 27, 2008 10:40 pm</h4>
    <div class="postbody"><span class="postbody">You'll only see the assembly of malloc if you're actually compiling malloc.    Otherwise, you need to disassemble it from somewhere else.  You can find the malloc which devkitarm uses in the CVS browser of newlib.
<br/>
<br/>
I think the code for malloc is in this file:
<br/>
<a href="http://sourceware.org/cgi-bin/cvsweb.cgi/~checkout~/src/newlib/libc/stdlib/mallocr.c?rev=1.16&amp;content-type=text/plain&amp;cvsroot=src" target="_blank">http://sourceware.org/cgi-bin/cvsweb.cgi/~checkout~/src/newlib/libc/stdlib/mallocr.c?rev=1.16&amp;content-type=text/plain&amp;cvsroot=src</a><br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
