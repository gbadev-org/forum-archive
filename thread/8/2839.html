<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Sequential vs. Non-Sequential - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>ASM > Sequential vs. Non-Sequential</h2>
<div id="posts">
<div class="post">
    <h4>#16209 - poslundc - Tue Feb 10, 2004 5:28 pm</h4>
    <div class="postbody"><span class="postbody">Inspired by the other topic recently posted here, I'm just interested in probing more into the nature of the memory controller and how it works with different instructions.
<br/>
<br/>
Take the following example case, running from ROM. We know that this code will take advantage of sequential reads to load the instruction:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">   mov      r1, r0
<br/>
   add      r1, r0, r1</td> </tr></table><span class="postbody">
<br/>
<br/>
But that this one won't, because of the branch:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">   b      nextstatement
<br/>
nextstatement:
<br/>
   mov      r1, r0</td> </tr></table><span class="postbody">
<br/>
<br/>
What about an instruction that loads from the ROM, though? I would assume that it would also cause a miss:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">   mov      r0, #0x08000000
<br/>
   ldr      r1, [r0]
<br/>
   mov      r0, r1   @ should be a non-sequential instruction (?)</td> </tr></table><span class="postbody">
<br/>
<br/>
How about an instruction that accesses internal/external RAM instead of the ROM? Does that affect the sequential reading of instructions?
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">   mov      r0, #0x03000000
<br/>
   str      r1, [r0]
<br/>
   mov      r0, r1   @ would this be a sequential instruction or not?</td> </tr></table><span class="postbody">
<br/>
<br/>
Finally, to look at things from the reverse direction... if I am running code from IWRAM and it is reading data from the ROM, does the memory controller lose its sequentiality between multiple ROM reads if I don't use a ldmia?
<br/>
<br/>
For example, the following code running in IWRAM (or anywhere) will take advantage of sequential access:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">   ldmia   r0, {r1, r2}</td> </tr></table><span class="postbody">
<br/>
<br/>
But if it was done the following way, where the memory controller must load the next instruction from IWRAM, would it be able to maintain sequential reading from ROM:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">   ldr      r1, [r0], #4   @ next ROM read is sequentially ordered...
<br/>
   ldr      r2, [r0]      @ ... but is it read sequentially if the load instruction must first be read from IWRAM?</td> </tr></table><span class="postbody">
<br/>
<br/>
I realize that there are also pipelining issues to consider in all of these questions - so it would actually be an instruction further down being fetched while the others are being executed - but please bear in mind these are only examples to illustrate the question, and the nature of the problem (which is how the memory controller decides what's sequential) stays the same with or without pipelining.
<br/>
<br/>
These are details that I've puzzled over for the past longish while but never really formulated as a proper question. Any help solving the mystery is appreciated. :)
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#16215 - animension - Tue Feb 10, 2004 7:38 pm</h4>
    <div class="postbody"><span class="postbody">An excellent set of questions Dan! I've been mulling over the same questions myself for a while now and would love to gain some insight as well :)<br/>_________________<br/>"Beer is proof that God loves us and wants us to be happy."
<br/>
-- Benjamin Franklin</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#16220 - torne - Tue Feb 10, 2004 8:32 pm</h4>
    <div class="postbody"><span class="postbody">I could be wrong about any of the following, but from my understanding of the GBA memory hardware and my knowledge of the ARM pipeline:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>poslundc wrote:</b></span></td> </tr> <tr> <td class="quote">What about an instruction that loads from the ROM, though? I would assume that it would also cause a miss:
<br/>
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">   mov      r0, #0x08000000
<br/>
   ldr      r1, [r0]
<br/>
   mov      r0, r1   @ should be a non-sequential instruction (?)</td> </tr></table><span class="postbody"></span></td> </tr></table><span class="postbody">
<br/>
<br/>
That will cause a future instruction fetch to be non-sequential, yes; but not the immediately following instruction. ARM7 is pipelined with three pipeline stages: Decode, RegRead/ALU, and Memory/RegWrite. At the time the ldr instruction reaches the memory stage, the mov instruction is copying r1 into the ALU, and the *next* instruction is due to be fetched. The fetch of the next instruction will not be able to proceed as the memory bus is in use by the read for the ldr (memory stage always takes precedence over instruction fetches); once the ldr completes, the next instruction will be non-sequentially fetched. This leaves an empty pipeline slot between the mov and the next instruction.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">How about an instruction that accesses internal/external RAM instead of the ROM? Does that affect the sequential reading of instructions?
<br/>
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">   mov      r0, #0x03000000
<br/>
   str      r1, [r0]
<br/>
   mov      r0, r1   @ would this be a sequential instruction or not?</td> </tr></table><span class="postbody"></span></td> </tr></table><span class="postbody">
<br/>
<br/>
That should still be sequential; the sequential/non-seq stuff is only affected by accesses to ROM. Again, a pipeline slot is left empty as the instruction following 'mov' is scheduled to be fetched at the same time as the str is writing; the chip has only one memory channel and no cache, so can't fetch the instruction at the same time.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Finally, to look at things from the reverse direction... if I am running code from IWRAM and it is reading data from the ROM, does the memory controller lose its sequentiality between multiple ROM reads if I don't use a ldmia?
<br/>
<br/>
For example, the following code running in IWRAM (or anywhere) will take advantage of sequential access:
<br/>
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">   ldmia   r0, {r1, r2}</td> </tr></table><span class="postbody">
<br/>
<br/>
But if it was done the following way, where the memory controller must load the next instruction from IWRAM, would it be able to maintain sequential reading from ROM:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">   ldr      r1, [r0], #4   @ next ROM read is sequentially ordered...
<br/>
   ldr      r2, [r0]      @ ... but is it read sequentially if the load instruction must first be read from IWRAM?</td> </tr></table><span class="postbody"></span></td> </tr></table><span class="postbody">
<br/>
<br/>
This is the case I'm not sure about; I don't really know how the sequential read is implemented in hardware. If it's done by strobing, then it should be possible to read sequentially even when there is a gap between accesses; however, if it's automatic or some other method is used, it may only be able to read sequentially on consecutive clock cycles.
<br/>
<br/>
If you want to find out the answers to all these with no speculation at all involved, write code with examples of all of them and profile it on real hardware, then compare the results to a static timing analysis performed under varying assumptions until one matches.
<br/>
<br/>
All the above are affected by prefetch as well, of course, in further complicated ways. =)
<br/>
<br/>
EDIT: actually, my comment about the third case applies to the second as well. Does anyone know the exact hardware mechanism used for the cart bus? no$ says only how non-sequential accesses are performedn, afaict, and I can't find mention at all in cowbite.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#16251 - Large Metal Teeth - Wed Feb 11, 2004 5:05 am</h4>
    <div class="postbody"><span class="postbody">The GBA cartridge has hardware counters that increment when the GBA Game Pak Bus's read line is strobed.  The ROM does not need to be read on successive clock cycles.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#16268 - torne - Wed Feb 11, 2004 1:17 pm</h4>
    <div class="postbody"><span class="postbody">Thanks, Large Metal Teeth; in which case, the answers to the above are that the second and third cases shouldbe sequential.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
