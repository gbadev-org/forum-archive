<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>my code wont compile intline?? - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>ASM > my code wont compile intline??</h2>
<div id="posts">
<div class="post">
    <h4>#8651 - slip - Thu Jul 17, 2003 12:31 pm</h4>
    <div class="postbody"><span class="postbody">I've compiled this code using glodroad but when I try and implement it inline it doesn't work.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void drawLine(u32 x, u32 max, u32 min, u32 c, u32 b)
<br/>
{
<br/>
   /*
<br/>
   ;;register
<br/>
   ;;r0 - the x value(incoming)-&gt;(changed internally to minimum)
<br/>
   ;;r1 - the y counter(internally)-&gt;but(incoming)is maximum
<br/>
   ;;r2 - the wall minimum(incoming)
<br/>
   ;;r3 - the colour(incoming)
<br/>
   ;;r4 - temp (int) -&gt; (inc buffer)
<br/>
   ;;r5 - temp
<br/>
   ;;r6 - temp
<br/>
   */
<br/>
   asm("   
<br/>
      .ALIGN
<br/>
      .ARM
<br/>
   ldr r5,=#240
<br/>
   mul r6,r1,r5
<br/>
   add r6,r6,r4
<br/>
   add r6,r0,r6
<br/>
<br/>
   mul r7,r2,r5
<br/>
   add r0,r0,r4
<br/>
   add r0,r0,r7
<br/>
<br/>
moreline:
<br/>
   strb r3,[r1]
<br/>
   sub r6,r6,#240
<br/>
   cmp r6,r0
<br/>
   bne moreline
<br/>
<br/>
      " :
<br/>
      /* No output */ : 
<br/>
      "r" (x), "r" (max), "r" (min), "r" (c), "r" (b):
<br/>
      "r5", "r6");
<br/>
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I get two errors
<br/>
Error: Bad expression
<br/>
Error:Grabage following instruction
<br/>
<br/>
the line numbers refer to a file in a temp folder, I've looked for the file but its not there. I don't know which lines the errors are refering to.
<br/>
<br/>
can anyone help?
<br/>
thanks<br/>_________________<br/>[url="http://www.ice-d.com"]www.ice-d.com[/url]</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#8653 - Quirky - Thu Jul 17, 2003 12:37 pm</h4>
    <div class="postbody"><span class="postbody">Add -save-temps to keep your temp files to find the error. And you have to add a newline "\n" at the end of each line of inlined assembler for it to compile.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#8655 - slip - Thu Jul 17, 2003 12:55 pm</h4>
    <div class="postbody"><span class="postbody">Thanks for the tip....
<br/>
Ok... the source of the problem is
<br/>
  ldr r5,=#240
<br/>
=\.. its the only ldr instruction I have there. it looks fine to me though... (I've only been doing asm for two days)...
<br/>
I changed ldr to mov.... and its compiled... I don't see why though... any suggestions?<br/>_________________<br/>[url="http://www.ice-d.com"]www.ice-d.com[/url]</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#8659 - slip - Thu Jul 17, 2003 1:28 pm</h4>
    <div class="postbody"><span class="postbody">this is unreal... I just ran a few tests....
<br/>
when calling the function it does not work correctly.
<br/>
but if set the values for the registers in my asm then I get the correct result... its as though the parameters are not being passed or I'm using the incorrectly.
<br/>
<br/>
I'm assuming
<br/>
void drawLine(u32 x, u32 max, u32 min, u32 c, u32 b)
<br/>
<br/>
r0 x
<br/>
r1 max
<br/>
r2 min
<br/>
r3 c
<br/>
r4 b
<br/>
<br/>
=\
<br/>
thanks again<br/>_________________<br/>[url="http://www.ice-d.com"]www.ice-d.com[/url]</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#8661 - Lupin - Thu Jul 17, 2003 2:31 pm</h4>
    <div class="postbody"><span class="postbody">Your code looks interesting to me, what does it do? How could you draw an line with just one X coordinate and some other vars (wich I don't understand what they do)?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#8684 - slip - Fri Jul 18, 2003 12:11 am</h4>
    <div class="postbody"><span class="postbody">the routine is only ment to draw a vertical line. Thus you only need one x co-ordinate, the maximum and minimum y values, colour and the buffer to write to.
<br/>
<br/>
The code sets a register as the maximum y + x + the buffer, and another with the minimum, each loop the code subtracts one line (240bytes) from the maximum y register and when that register - the minimum one == 0 then the loop stops.
<br/>
<br/>
The problem at the moment is the function inputs arn't working properly. When calling from C++ the values don't seem to come through to r0-r4 and I can't work out why.<br/>_________________<br/>[url="http://www.ice-d.com"]www.ice-d.com[/url]</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#8701 - Master S - Fri Jul 18, 2003 10:01 am</h4>
    <div class="postbody"><span class="postbody">I think that only the first 3 (or 4) parameters are given directly in registers. The rest is pushed on the stack</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#8737 - torne - Fri Jul 18, 2003 8:52 pm</h4>
    <div class="postbody"><span class="postbody">Master S is right. Only four arguments are passed in registers, the fifth and further arguments are pushed onto the stack by the caller. Read the ARM/Thumb Procedure Call Standard, available from arm.com; it explains the ARM calling conventions.
<br/>
<br/>
Torne</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#8753 - slip - Sat Jul 19, 2003 3:55 am</h4>
    <div class="postbody"><span class="postbody">Thanks for that. I looked at the document and this is what it says...
<br/>
<br/>
o Loading the first 4 words into integer registers a1-a4 (lowest addressed into a1). If there are fewer than 4
<br/>
words, they are loaded into a1-a3, a1-a2, or a1 only.
<br/>
<br/>
o Pushing remaining words onto the stack in reverse order (so the first remaining parameter word is at
<br/>
VAL(SP), the second at VAL(SP)+4, and so on).
<br/>
<br/>
now does that means I can just use a ldm and load r4-r7 like this:
<br/>
<br/>
ldmfd sp!,{r4-r7}
<br/>
<br/>
is it full-decending or something else? or is this wrong all together?
<br/>
thanks<br/>_________________<br/>[url="http://www.ice-d.com"]www.ice-d.com[/url]</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#8754 - sgstair - Sat Jul 19, 2003 3:57 am</h4>
    <div class="postbody"><span class="postbody">Hello slip,
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>slip wrote:</b></span></td> </tr> <tr> <td class="quote">Thanks for the tip....
<br/>
Ok... the source of the problem is
<br/>
  ldr r5,=#240
<br/>
=\.. its the only ldr instruction I have there. it looks fine to me though... (I've only been doing asm for two days)...
<br/>
I changed ldr to mov.... and its compiled... I don't see why though... any suggestions?</td> </tr></table><span class="postbody">
<br/>
<br/>
The source of your problem is the #... 
<br/>
when using gnu's as, you can mov r5,#number, or ldr r5,=number, but not ldr r5,=#number
<br/>
<br/>
Hope this helps :)
<br/>
-Stephen</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#8759 - slip - Sat Jul 19, 2003 5:59 am</h4>
    <div class="postbody"><span class="postbody">=).. thanks for that sgstair I wondered what was going on.<br/>_________________<br/>[url="http://www.ice-d.com"]www.ice-d.com[/url]</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#8761 - slip - Sat Jul 19, 2003 6:20 am</h4>
    <div class="postbody"><span class="postbody">I've changed the code a bit....
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
void drawLine(u32 x, u32 max, u32 min, u32 c, u32 b, u32 tx, u32 *t, u32 scale)
<br/>
{
<br/>
   /*
<br/>
   ;;register
<br/>
   ;;r1 - the x value(incoming)-&gt;(changed internally to minimum)
<br/>
   ;;r2 - the y counter(internally)-&gt;but(incoming)is maximum
<br/>
   ;;r3 - the wall minimum(incoming)
<br/>
   ;;r4 - the colour(incoming)
<br/>
   ;;r5 - incoming buffer
<br/>
   */
<br/>
//========ASM==============
<br/>
   //Draw vertical line based on ^^
<br/>
   asm("   
<br/>
      .ALIGN
<br/>
      .ARM
<br/>
   ldmfd sp!,{r5-r8}
<br/>
<br/>
   mov r9,#240
<br/>
   mul r10,r2,r9
<br/>
   add r8,r8,r5
<br/>
   add r8,r1,r10
<br/>
<br/>
   mul r11,r3,r7
<br/>
   add r1,r1,r5
<br/>
   add r1,r1,r11
<br/>
<br/>
moreline:
<br/>
   strb r4,[r10]
<br/>
   sub r10,r10,#240
<br/>
   cmp r10,r1
<br/>
   bge moreline
<br/>
<br/>
      " :
<br/>
      /* No output */ : 
<br/>
      "r" (x), "r" (max), "r" (min), "r" (c), "r" (b), "r" (tx), "r" (t), "r" (scale):
<br/>
      "r9", "r10", "r11");
<br/>
//=====ENDASM==============*/
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
All that has changed is the register numbers have been chagned to abide by the rules stated in the documentation. I've added ldmfd sp!,{r5-r8} to set the registers 5-8 from the stack which should be b,tx,t,scale respectively... and I'm asuming r1-r4 are set with x,max,min and c. The extra variables that I'm trying to pass arn't being used just yet they are waiting in r6-r8 until I code the extra stuff. The extra code is going to take the address at t as the 64*64 texture and blit the 'tx' x colum to the screen instead of writting just a solid colour. I know that I don't need c in this case but the code should still work though I've got the extra variables in right?
<br/>
does anyone have any clue?
<br/>
thanks again...<br/>_________________<br/>[url="http://www.ice-d.com"]www.ice-d.com[/url]</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#8762 - Dev - Sat Jul 19, 2003 6:46 am</h4>
    <div class="postbody"><span class="postbody">Generally speaking, you can't clobber most registers when intermixing C and ASM code.
<br/>
<br/>
Precisely which registers must be preserved will depend on your compiler, but for most stuff (including ADS, I believe), R0-R3 are OK to destroy and the rest aren't.
<br/>
<br/>
Typically, the other registers are used by the compiler for various purposes -- i.e. R13 is the Stack (duh), R14 is the Return Address, but R12 (or R11, or R10) may be a "stack frame pointer", or a "global variable base" or something else that the compiler expects to be preserved.
<br/>
<br/>
I don't have a specific reference, but for ADS you can try looking up "ARM/THUMB Procedure Call Standard" or something similar to that (but equally verbose.) -- or, try "ATPCS".
<br/>
<br/>
Take a look at the disassembly of your compiler's generated code when it calls a regular C function that has a bunch of parameters -- also check out the start and end of the function itself.
<br/>
<br/>
There will be a small "prologue" and "epilogue" that are placed at the start and end of the function, respectively.
<br/>
<br/>
The prologue basically saves the registers that your routine will clobber (except those you're allowed to, of course), then loads the parameters passed from the caller into the registers you want to use.
<br/>
<br/>
The epilogue restores the saved registers that were clobbered before returning to the caller.
<br/>
<br/>
The only other issue is whether or not your function is supposed to dispose of the passed parameters, or if that's something that the caller is supposed to do.
<br/>
<br/>
The compiler has already generated code to push the extra parameters on the stack before calling your function (obviously) -- but it may also have added code that will remove those extra parameters upon return -- which means that your function must NOT remove them before returning!
<br/>
<br/>
To find out whether your compiler expects the caller, or the callee, to clean the stack you can simply check the disassembly of the code generated by the compiler when it calls your function.
<br/>
<br/>
As an aside, you should also check whether or not your compiler lets you specify which registers the parameters are to be put into -- i.e. Some compilers let you tell them what registers to use, and the compiler takes care of everything else.
<br/>
<br/>
Similarly, your compiler may have an option to specify which registers are destroyed by your function, and the compiler will automatically generate all the code to preserve those registers around your function (i.e. it'll create the prologue and epilogue for you, or in some cases, it'll add extra code where your function returns to, that reloads the mangled registers).
<br/>
<br/>
Best,
<br/>
<br/>
Dev.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#8763 - slip - Sat Jul 19, 2003 7:49 am</h4>
    <div class="postbody"><span class="postbody">ahh crap... fair enough looks like I might have to work on it then. what about if I had an array with all my variables in it then just passed the address to the first entry then I could access the others by incrimenting the address? 
<br/>
<br/>
I've got the ARM/THUMB Procedure Call Standard, also in the gbaguy tutorials gbaguy talks about the registers you can and can't use. r0-r12 are free to use apparently and r13,r14,and r15 are used for other purposes. I also read this in the document from <a href="http://www.geocities.com/wonglinhoo/Arm.htm" target="_blank">http://www.geocities.com/wonglinhoo/Arm.htm</a> which explains the use of the r13-r15 in detail.
<br/>
<br/>
The document explaining implementing inline asm from gbadev.org explains the format used. The last part is the registers that are "destroyed" (the word used) which are the ones you want to use. I'm guessing that the compiler takes this information and makes a prologue and epilogue as you said.
<br/>
<br/>
I'm going to have to call it a day right now and get back to it tomorrow. Thanks for your help everyone and I'll probably be posting tomorrow with more problems... =)...<br/>_________________<br/>[url="http://www.ice-d.com"]www.ice-d.com[/url]</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#8764 - Dev - Sat Jul 19, 2003 9:52 am</h4>
    <div class="postbody"><span class="postbody">I checked <a href="http://www.arm.com" target="_blank">www.arm.com</a> and found this:
<br/>
<br/>
<a class="postlink" href="http://www.arm.com/support/566FQ9/$File/ATPCS.pdf" target="_blank">http://www.arm.com/support/566FQ9/$File/ATPCS.pdf</a>
<br/>
<br/>
It seems to be from Oct. 2000 -- whether or not this "standard" is still adhered to is anyone's guess.
<br/>
<br/>
Checking the first couple pages, you'll see that they refer to stack frame pointers, etc. etc. etc. beyond just R13-R15 -- again, whether or not the other registers are actually used (or were used, or still are), is unknown.
<br/>
<br/>
Also, it's probably only "guaranteed" for their own stuff -- i.e. if you're not using ADS, what you need to do could be completely different.
<br/>
<br/>
... at least now, though, you'll have a better idea of what to do!
<br/>
<br/>
Dev.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#8766 - torne - Sat Jul 19, 2003 12:20 pm</h4>
    <div class="postbody"><span class="postbody">Read my post: <a href="http://forum.gbadev.org/viewtopic.php?t=1119" target="_blank">http://forum.gbadev.org/viewtopic.php?t=1119</a>
<br/>
It explains the procedure call standard, more or less. I don't use inline asm, so I do not know what the compiler generates for you.
<br/>
<br/>
As a summary, though, you may only change the values of r0-r3, and r11. Other changed values must be pushed to the stack and popped back. If the compiler does this for you, then you won't have to.
<br/>
<br/>
To load your parameters, you want to do ldmia sp,{r4-r7}. The stack is indeed full-descending, but you are not popping values from the stack; just reading them. You also do not want to use ! as you don't want to change the stack pointer. 
<br/>
<br/>
Dev: yes, the current procedure call standard is from October 2000. It just hasn't changed since them. Every single ARM-targetting compiler, linker, or any binary tool should generate code compliant with that standard, including GCC and the ARM SDT. Not all of the standard applies to the GBA though. Section 4 - Base Standard all applies, except for 4.6 and 4.7 (the GBA uses the no floating-point hardware version in 4.8). 5.1 applies if you are mixing ARM and Thumb code, but not the rest of section 5. Section 6 is irrelevant, but section 7 has useful stuff. =)
<br/>
<br/>
The GBA doesn't use the stack limit register, but can use the frame pointer register.
<br/>
<br/>
Every platform whose compilers are compatible, and every platform with an operating system, has a coherent procedure call standard. It is not an artifact of the compiler you are using; it is an artifact of the platform, and all compiler writers will follow it.
<br/>
<br/>
Torne</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#8768 - sgstair - Sat Jul 19, 2003 1:41 pm</h4>
    <div class="postbody"><span class="postbody">I think you're trying to approach this the wrong way, when you use the asm keyword from c, and specify certain values for input, you have to access them differently ... (/me goes and looks it up) ...
<br/>
<br/>
you might find this useful: <a class="postlink" href="http://www.devrs.com/gba/files/asmc.txt" target="_blank">http://www.devrs.com/gba/files/asmc.txt</a>
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">   asm volatile("
<br/>
      mov    r3,%0
<br/>
<br/>
      mov    r5, #240
<br/>
      lsl    r5, r5, #1          @ r5 = 480
<br/>
<br/>
      mul    r5,r5,r3
<br/>
      mov    r4,%1
<br/>
      add    r5,r5,r4
<br/>
      add    r5,r5,r4
<br/>
<br/>
      mov    r3,#192
<br/>
      lsl    r3, r3, #19         @ r3 = 0x6000000
<br/>
<br/>
      add    r3,r3,r5
<br/>
      mov    r4,%2
<br/>
      strh   r4,[r3]
<br/>
      " :
<br/>
      /* No output */ :                 // No output is returned from this routine.
<br/>
      "r" (py), "r" (px), "r" (colr) :  // Define the routine inputs (%0,%1,%2).
<br/>
      "r3", "r4", "r5" );               // Specific which registers we destroy.
<br/>
                                        // For more info on 'asm' read the GCC docs at gnu.org
<br/>
   }
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
When using the asm(), and you specify the inputs, you have to access them using %0, %1, ... instead of trying to pick registers for them - gcc does the register picking and setup.  Also, in the 'destroyed', you should list ALL registers you use (write stuff to)
<br/>
<br/>
Hope this helps :)
<br/>
-Stephen</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#8769 - sgstair - Sat Jul 19, 2003 1:44 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>torne wrote:</b></span></td> </tr> <tr> <td class="quote">Read my post: <a href="http://forum.gbadev.org/viewtopic.php?t=1119" target="_blank">http://forum.gbadev.org/viewtopic.php?t=1119</a>
<br/>
It explains the procedure call standard, more or less. I don't use inline asm, so I do not know what the compiler generates for you.
<br/>
<br/>
As a summary, though, you may only change the values of r0-r3, and r11. Other changed values must be pushed to the stack and popped back. If the compiler does this for you, then you won't have to.
<br/>
<br/>
To load your parameters, you want to do ldmia sp,{r4-r7}. The stack is indeed full-descending, but you are not popping values from the stack; just reading them. You also do not want to use ! as you don't want to change the stack pointer. 
<br/>
<br/>
Torne</td> </tr></table><span class="postbody">
<br/>
<br/>
This works very nicely when writing the entire function in asm, but when you have an inline asm within C, the C part of the function handles the paramater passing.  You will have to either write the entire function in asm (it's not too hard) or just do things the way gcc does them, the asm() keyword has very specific usage for passing paramaters.
<br/>
<br/>
-Stephen</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#8789 - slip - Sun Jul 20, 2003 3:16 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>torne wrote:</b></span></td> </tr> <tr> <td class="quote">Read my post: <a href="http://forum.gbadev.org/viewtopic.php?t=1119" target="_blank">http://forum.gbadev.org/viewtopic.php?t=1119</a>
<br/>
It explains the procedure call standard, more or less. I don't use inline asm, so I do not know what the compiler generates for you.
<br/>
<br/>
As a summary, though, you may only change the values of r0-r3, and r11. Other changed values must be pushed to the stack and popped back. If the compiler does this for you, then you won't have to.
<br/>
<br/>
To load your parameters, you want to do ldmia sp,{r4-r7}. The stack is indeed full-descending, but you are not popping values from the stack; just reading them. You also do not want to use ! as you don't want to change the stack pointer. 
<br/>
<br/>
Dev: yes, the current procedure call standard is from October 2000. It just hasn't changed since them. Every single ARM-targetting compiler, linker, or any binary tool should generate code compliant with that standard, including GCC and the ARM SDT. Not all of the standard applies to the GBA though. Section 4 - Base Standard all applies, except for 4.6 and 4.7 (the GBA uses the no floating-point hardware version in 4.8). 5.1 applies if you are mixing ARM and Thumb code, but not the rest of section 5. Section 6 is irrelevant, but section 7 has useful stuff. =)
<br/>
<br/>
The GBA doesn't use the stack limit register, but can use the frame pointer register.
<br/>
<br/>
Every platform whose compilers are compatible, and every platform with an operating system, has a coherent procedure call standard. It is not an artifact of the compiler you are using; it is an artifact of the platform, and all compiler writers will follow it.
<br/>
<br/>
Torne</td> </tr></table><span class="postbody">
<br/>
<br/>
After reading your other post <a href="http://forum.gbadev.org/viewtopic.php?t=1119" target="_blank">http://forum.gbadev.org/viewtopic.php?t=1119</a>
<br/>
 I've become a little confused about how you are suposed to push the registers r4-r12 onto the stack but then also be able to load the parameters from the stack as well.
<br/>
For example r4-r10 I would like to use... so
<br/>
   stmfd sp!,{r4-r10}
<br/>
I store them on the register so I can restore them later... but I also want to load my 5th to 8th parameter from the stack.
<br/>
   ldmia sp,{r4-r7}
<br/>
which I worked out that it should be...
<br/>
   ldmia sp+28,{r4-r7}
<br/>
in order to be pointing to the start of the first parameter. But how can you do this? Should I be using a register so I can load the r13 (sp) then add 28 to it and use that temporary register as the base register?
<br/>
You guys have been a great help and I'm really starting to understand whats going on. Thanks =)<br/>_________________<br/>[url="http://www.ice-d.com"]www.ice-d.com[/url]</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#8790 - slip - Sun Jul 20, 2003 3:30 am</h4>
    <div class="postbody"><span class="postbody">sgstair I read the asmc document and thats how I got started with all this. The problem is that document doesn't talk about passing many parameters. I have some variations of code some work others don't... This is what I have:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
   asm("   
<br/>
      .ALIGN
<br/>
      .ARM
<br/>
<br/>
   stmfd sp!,{r4-r10}
<br/>
<br/>
    mov r4,%4
<br/>
    mov r3,%3
<br/>
   mov r2,%2
<br/>
   mov r1,%1
<br/>
   mov r0,%0
<br/>
<br/>
   mov r8,#240
<br/>
   mul r9,r1,r8
<br/>
   add r9,r9,r4
<br/>
   add r9,r0,r9
<br/>
<br/>
   mul r10,r2,r8
<br/>
   add r0,r0,r4
<br/>
   add r0,r0,r10
<br/>
<br/>
moreline:
<br/>
   strb r3,[r9]
<br/>
   sub r9,r9,#240
<br/>
   cmp r9,r0
<br/>
   bge moreline
<br/>
<br/>
   ldmfd sp!,{r4-r10} 
<br/>
<br/>
      " :
<br/>
      /* No output */ : 
<br/>
      "r" (x), "r" (max), "r" (min), "r" (c), "r" (b), "r" (tx):
<br/>
      "r8", "r9", "r10");
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
This one works fine.
<br/>
The difference is at the start in this one. I have done what I said in my previous post about using a temp reg and the sp+28. It works too. But if I remove the any of the lines mov rx,%x in either of these two the routine wont work. It seems that I have to mov r0-r4,%0-%4 as though the parameters arn't being put in r0-r3
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
   stmfd sp!,{r4-r10}
<br/>
   mov r4,r13
<br/>
   add r4,r4,#28
<br/>
        ldmia r4,{r4-r8}
<br/>
<br/>
    mov r4,%4
<br/>
    mov r3,%3
<br/>
   mov r2,%2
<br/>
   mov r1,%1
<br/>
   mov r0,%0
<br/>
<br/>
.... same as above
<br/>
<br/>
   ldmfd sp!,{r4-r10} 
<br/>
<br/>
      " :
<br/>
      /* No output */ : 
<br/>
      "r" (x), "r" (max), "r" (min), "r" (c), "r" (b), "r" (tx):
<br/>
      "r8", "r9", "r10");
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
The other two variations are the same as above except the difference is the line
<br/>
		"r" (x), "r" (max), "r" (min), "r" (c), "r" (b), "r" (tx):
<br/>
is extended to 
<br/>
		"r" (x), "r" (max), "r" (min), "r" (c), "r" (b), "r" (tx), "r" (t), "r" (scale):
<br/>
<br/>
once these extra parameters are included the routine does not work.
<br/>
<br/>
Thats the details of my problem.
<br/>
[/code]<br/>_________________<br/>[url="http://www.ice-d.com"]www.ice-d.com[/url]</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#8792 - sgstair - Sun Jul 20, 2003 6:25 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>slip wrote:</b></span></td> </tr> <tr> <td class="quote">sgstair I read the asmc document and thats how I got started with all this. The problem is that document doesn't talk about passing many parameters. I have some variations of code some work others don't... This is what I have:
<br/>
<br/>
...
<br/>
<br/>
This one works fine.
<br/>
The difference is at the start in this one. I have done what I said in my previous post about using a temp reg and the sp+28. It works too. But if I remove the any of the lines mov rx,%x in either of these two the routine wont work. It seems that I have to mov r0-r4,%0-%4 as though the parameters arn't being put in r0-r3
<br/>
...
<br/>
The other two variations are the same as above except the difference is the line
<br/>
		"r" (x), "r" (max), "r" (min), "r" (c), "r" (b), "r" (tx):
<br/>
is extended to 
<br/>
		"r" (x), "r" (max), "r" (min), "r" (c), "r" (b), "r" (tx), "r" (t), "r" (scale):
<br/>
<br/>
once these extra parameters are included the routine does not work.
<br/>
<br/>
Thats the details of my problem.
<br/>
[/code]</td> </tr></table><span class="postbody">
<br/>
<br/>
Well, quite obviously the paramaters aren't being put in r0-r3! You aren't actually defining your function in ASM, you're just writing an inline section of ASM within a C function.  C handles ALL of the paramater passing, and thus the paramaters don't appear at all in your inline block.
<br/>
using the %0-%4 is the proper way to use paramaters in an inline block.
<br/>
<br/>
Another potential problem is you're not defining all of the 'destroyed' variables.  you should add to the 3rd varlist (the "r8", "r9", "r10") all of the variables you write to.
<br/>
<br/>
If I were you I'd have written the whole routine in pure assembly a long time ago, without worrying about a C function framework :)
<br/>
<br/>
-Stephen<br/>_________________<br/><a class="postlink" href="http://blog.akkit.org/" target="_blank">http://blog.akkit.org/</a> - <a class="postlink" href="http://www.akkit.org/dswifi/" target="_blank">http://www.akkit.org/dswifi/</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#8795 - slip - Sun Jul 20, 2003 8:05 am</h4>
    <div class="postbody"><span class="postbody">I'm happy to write it in pure asm. But I don't know how to use parameters that way, and I'm not sure how to compile and link and include it. I'll still be able to call it from C the same way right?<br/>_________________<br/>[url="http://www.ice-d.com"]www.ice-d.com[/url]</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#8800 - torne - Sun Jul 20, 2003 2:33 pm</h4>
    <div class="postbody"><span class="postbody">sgstair is right; if you are going to write inline you should do what the gcc docs say. It's not hard to use a separate file for yous asm tho so maybe you should try that.
<br/>
<br/>
Oh, and yes, to get your params, push modified regs, add the size of what you pushed to sp, and load from there.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#8802 - Paul Shirley - Sun Jul 20, 2003 2:52 pm</h4>
    <div class="postbody"><span class="postbody">removed</span><span class="gensmall"><br/><br/>Last edited by Paul Shirley on Sun Mar 28, 2004 10:07 pm; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#8817 - sgstair - Sun Jul 20, 2003 9:11 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>slip wrote:</b></span></td> </tr> <tr> <td class="quote">I'm happy to write it in pure asm. But I don't know how to use parameters that way, and I'm not sure how to compile and link and include it. I'll still be able to call it from C the same way right?</td> </tr></table><span class="postbody">
<br/>
<br/>
Yes you could still be able to call it the same way.  Using the paramaters isn't too hard either - it's the way described by everyone else around here :)
<br/>
<br/>
Here's a snippet of code that uses more than 4 paramaters:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">@extern void DrawPartialImage(s32 x, s32 y, u32 imgnum, u32 orientation,s32 clipx1,s32 clipy1,s32 clipx2,s32 clipy2) {
<br/>
   @ wanted r0=x, r1=y, r2,imgnum, r3=orientation, r4=clipx1, r5=clipy1, 
<br/>
   @ r6=clipx2, r7=clipy2
<br/>
DrawPartialImage:   @ expected: r0=x, r1=y, r2=imgnum, r3=orientation, others on stack
<br/>
<br/>
   mov      r12,r13 @ save stack
<br/>
   STMFD   r13!, {r4-r11} @give us all registers to work with (stored 8x4bytes)
<br/>
   LDMIA   r12,{r4-r7} @clip values x1,y1,x2,y2 in order
<br/>
<br/>
... code and more code
<br/>
<br/>
DPI_exit:   
<br/>
   LDMFD r13!,{r4-r11}
<br/>
   bx lr
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I hope that gives you an idea of what to do - if you have more questions I'll try to answer them :)
<br/>
<br/>
-Stephen<br/>_________________<br/><a class="postlink" href="http://blog.akkit.org/" target="_blank">http://blog.akkit.org/</a> - <a class="postlink" href="http://www.akkit.org/dswifi/" target="_blank">http://www.akkit.org/dswifi/</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#8832 - slip - Mon Jul 21, 2003 8:39 am</h4>
    <div class="postbody"><span class="postbody">Hey thats cool.. Thanks.. I've just made a file named tline.s and it looks like this:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
@extern void drawLine(u32 x, u32 max, u32 min, u32 c, u32 b, u32 tx, u32 *t, u32 scale) {
<br/>
   @ wanted r0=x, r1=max, r2,min, r3=c, r4=b, r5=tx,
<br/>
   @ r6=*t, r7=scale
<br/>
drawLine:   @ expected: r0=x, r1=max, r2=min, r3=c, others on stack
<br/>
<br/>
   mov     r12,r13 @ save stack
<br/>
   STMFD   r13!, {r4-r11} @give us all registers to work with (stored 8x4bytes)
<br/>
   LDMIA   r12,{r4-r7} @clip values b,tx,*t,scale in order
<br/>
<br/>
   mov r8,#240
<br/>
   mul r9,r1,r8
<br/>
   add r9,r9,r4
<br/>
   add r9,r0,r9
<br/>
<br/>
   mul r10,r2,r8
<br/>
   add r0,r0,r4
<br/>
   add r0,r0,r10
<br/>
<br/>
moreline:
<br/>
   strb r3,[r9]
<br/>
   sub r9,r9,#240
<br/>
   cmp r9,r0
<br/>
   bge moreline
<br/>
<br/>
DRAWLINE_exit:
<br/>
   LDMFD r13!,{r4-r11}
<br/>
   bx lr
<br/>
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
=)... to compile it I'm just using my usual:
<br/>
g++ -c -o tline.o tline.s
<br/>
and it compiles without any worry. But when I try and link I get:
<br/>
undefined reference to 'drawLine(unsigned long... more unsigned longs)'
<br/>
thats coming from my c++ object file. I've included in my header file
<br/>
<br/>
extern void drawLine(u32 x, u32 max, u32 min, u32 c, u32 b, u32 tx, u32 *t, u32 scale);
<br/>
<br/>
and not sure what to do now. This seems a much more controlable way of doing this. I know where my parameters are now. Its just that undefined reference problem.[/code]<br/>_________________<br/>[url="http://www.ice-d.com"]www.ice-d.com[/url]</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#8835 - Quirky - Mon Jul 21, 2003 10:22 am</h4>
    <div class="postbody"><span class="postbody">I'm pretty sure you need to add these lines to the .s to make it global:
<br/>
<br/>
.global	drawLine
<br/>
.type	drawLine,function</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#8837 - slip - Mon Jul 21, 2003 10:34 am</h4>
    <div class="postbody"><span class="postbody">I added
<br/>
<br/>
    .ARM
<br/>
    .ALIGN
<br/>
    .global drawLine
<br/>
    .type drawLine,function
<br/>
<br/>
I forgot to add .ARM and .ALIGN. After adding that though I still had the same linker error. I downloaded the graphics lib from devrs.com and checked out the way the asm was used. It looks like this...
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
<br/>
@ Draw an outline ellipse in GBA graphics modes 3 or 5 in ARM asm
<br/>
@ (void) gfxEllipse (u8 x, u8 y, u8 xr, u8 yr, u16 color, u32 addr);
<br/>
<br/>
        .ARM
<br/>
        .ALIGN
<br/>
        .GLOBL  gfxEllipse
<br/>
<br/>
gfxEllipse:
<br/>
<br/>
...
<br/>
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I've guessed that case is not a problem. And I've even tried the same way as its done in the lib. except I use drawLine. But I still get the link error. =\[/code]<br/>_________________<br/>[url="http://www.ice-d.com"]www.ice-d.com[/url]</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#8847 - sgstair - Mon Jul 21, 2003 6:19 pm</h4>
    <div class="postbody"><span class="postbody">Do make sure you're including the .o file generated in your link process!
<br/>
<br/>
I think that's your only problem :)
<br/>
<br/>
-Stephen<br/>_________________<br/><a class="postlink" href="http://blog.akkit.org/" target="_blank">http://blog.akkit.org/</a> - <a class="postlink" href="http://www.akkit.org/dswifi/" target="_blank">http://www.akkit.org/dswifi/</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#8857 - slip - Tue Jul 22, 2003 12:21 am</h4>
    <div class="postbody"><span class="postbody">I thought of that... this is what my link batch file looks like.
<br/>
<br/>
PATH=C:\devkitadv\bin
<br/>
g++ -o main.elf *.o -lm
<br/>
objcopy -O binary main.elf ROm.gba
<br/>
pause
<br/>
<br/>
tline.o is in the directory and I get the error. I just tried adding tline.o after *.o and I got multiple definition drawLine. 
<br/>
<br/>
...
<br/>
...
<br/>
<br/>
Ok I just tried to compile pixel.s (from the asm gfxlib at devrs.com) into my project then call it and got the same error. I'm guessing that its not the asm its the way I'm compiling and/or linking it?<br/>_________________<br/>[url="http://www.ice-d.com"]www.ice-d.com[/url]</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
