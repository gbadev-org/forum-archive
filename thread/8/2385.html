<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>problem accessing variables declared in a function - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>ASM > problem accessing variables declared in a function</h2>
<div id="posts">
<div class="post">
    <h4>#12782 - shadow_gg - Wed Nov 26, 2003 11:56 am</h4>
    <div class="postbody"><span class="postbody">hello everybody,
<br/>
got some noob question:
<br/>
<br/>
why this work:
<br/>
u16 *sky=(u16 *)(0x8000000+SIZE_ROM+SIZE_PAL+SIZE_IMAGE+SIZE_MAP);
<br/>
void blit_asm()
<br/>
{
<br/>
<br/>
	asm volatile(" 
<br/>
	.ALIGN
<br/>
	.ARM
<br/>
	ldr		r0,=screen
<br/>
	ldr		r0,[r0]		@r0 vram
<br/>
	ldr		r3,=sky
<br/>
	ldr		r3,[r3]		@r3 image
<br/>
	mov		r1,#0
<br/>
	ldr		r2,=9600
<br/>
boucle:
<br/>
	ldr		r1,[r3],#4
<br/>
	str		r1,[r0],#4
<br/>
	subs	r2,r2,#1
<br/>
	bpl		boucle
<br/>
	bx		lr
<br/>
.pool
<br/>
":/*no output*/:/*no_input*/:"r0","r1","r2");
<br/>
}
<br/>
it compiles fine
<br/>
but when I put the variable sky in the function,it don't compiles anymore
<br/>
:(
<br/>
it doesn't found sky
<br/>
what is the problem ?
<br/>
thx for helping me !</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#12787 - poslundc - Wed Nov 26, 2003 4:11 pm</h4>
    <div class="postbody"><span class="postbody">Your question is unclear... but I think you are asking why you can no longer reference the variable sky if instead of making it a global variable you make it a local variable in the function.
<br/>
<br/>
First of all, you need to realize that there are no "variables" in assembler. When you use the name "sky" in assembler, it is just inserting the memory address of your global variable, which it gets from the linker.
<br/>
<br/>
The linker knows the symbol "sky" because it is a global variable. The linker doesn't know the symbols of any local variables in functions.
<br/>
<br/>
If you want to use a local variable, you need to pass it as an input to the asm function. See the article on <a class="postlink" href="http://www.devrs.com/gba/files/asmrules.html" target="_blank">GCC Inline Assembly Rules of Engagement</a>.
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#12792 - shadow_gg - Wed Nov 26, 2003 5:52 pm</h4>
    <div class="postbody"><span class="postbody">thx but I cannot access yet to local variables even declaring them as operand of asm function.
<br/>
like this:
<br/>
void blit_asm()
<br/>
{
<br/>
 u16 *sky=(u16 *)(0x8000000+SIZE_ROM+SIZE_PAL+SIZE_IMAGE+SIZE_MAP);
<br/>
<br/>
	asm volatile(" 
<br/>
	.ALIGN
<br/>
	.ARM
<br/>
	ldr		r0,=screen
<br/>
	ldr		r0,[r0]		@r0 vram
<br/>
	ldr		r3,=sky
<br/>
	ldr		r3,[r3]		@r3 image
<br/>
	ldr		r2,=9600
<br/>
boucle:
<br/>
	ldr		r1,[r3],#4
<br/>
	str		r1,[r0],#4
<br/>
	subs	r2,r2,#1
<br/>
	bpl		boucle
<br/>
	bx		lr
<br/>
.pool
<br/>
":/*no output*/:"m"(sky):"r0","r1","r2");
<br/>
}
<br/>
thats means I must pass sky as argument of the function for accessing it?
<br/>
or declaring the variable directly in the asm block ?
<br/>
is there a way to accessing a local variable declared in a C funtion  in a asm block who is inside this same function ?
<br/>
<br/>
sorry for my bad english :/
<br/>
thx for all</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#12802 - DekuTree64 - Wed Nov 26, 2003 8:24 pm</h4>
    <div class="postbody"><span class="postbody">I think you'd need to put "r"(sky) instead of "m", and then use ldr r3, %0, which means the first argment for that ASM block. I haven't messed with inline ASM enough to know the details of it.
<br/>
I'd suggest just writing the function in pure ASM. Much cleaner and less confusing. Just look around in this section for ASM beginner posts, I've explained how to set up a basic ASM function enough times already^_^<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#12806 - poslundc - Wed Nov 26, 2003 8:44 pm</h4>
    <div class="postbody"><span class="postbody">Once again, please read the <a class="postlink" href="http://www.devrs.com/gba/files/asmrules.html" target="_blank">rules of engagement article</a>, as they are very clear on how to do this. You do not reference the "sky" variable directly, you need to use the "%" specifier as well as a number specifying which parameter. Using "m" should be correct, though, the way you are using it. (My understanding is that "r" loads it directly into one of the registers, so you wouldn't need the ldr statement, but how does it choose which register? Is it just any register that isn't specified in the clobber list?)
<br/>
<br/>
I will also chime in to agree with DekuTree64 that it is much easier to write separate asm files and call the functions from C. It also helps to keep your code understandable as your project gets larger: I have one directory for C files and another for ASM files, and my makefile has separate directives to process the two.
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#12812 - shadow_gg - Thu Nov 27, 2003 1:45 am</h4>
    <div class="postbody"><span class="postbody">thx u all
<br/>
it worked well now ^^</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
