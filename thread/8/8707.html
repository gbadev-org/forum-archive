<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Using both ASM and C - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>ASM > Using both ASM and C</h2>
<div id="posts">
<div class="post">
    <h4>#73276 - HyperHacker - Fri Feb 24, 2006 9:38 am</h4>
    <div class="postbody"><span class="postbody">So far I have various DS projects written in C, which work nicely. The ARM7 and ARM9 code is compiled into two separate .o files using arm-elf-g++. The same program then turns them into .elf files, then arm-elf-objcopy turns them into arm7.bin and arm9.bin which are fed into ndstool to make a .nds file.
<br/>
<br/>
The question is where would a .s file fit in here? I compile it to another .o file, and then what? I haven't experimented with GCC much; just basic stuff.
<br/>
<br/>
Also, when I compile something using the .fPIC option, how exactly does it work? Does the generated code always use relative memory accesses, and if so, where does it get the base address? (What I'm looking to do here is compile one or two functions into a file, then have my program load it into memory and have it work just as if these functions had been in its own source, save of course for the fact that they'd have no name.)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#73279 - DekuTree64 - Fri Feb 24, 2006 10:26 am</h4>
    <div class="postbody"><span class="postbody">Yeah, just assemble a .s file into a .o and it links the same as if it came from a .c file or whatever. Not sure how much you know about compilers, but one useful thing to wrap your head around is that global functions and varables are referenced by literal symbol names in the .o files, and aren't actually converted to addresses until linking. That's basically what static linking is. I know next to nothing about dynamic linking, but there was a thread about it a while back if you're curious about it.
<br/>
<br/>
I've never messed around with position-independent code, but I do find the idea interesting. I would assume that it's all done offset-based, and any references to code outside that position-independent block would be absolute addresses. Referencing anything in another position-independent block would be tricky though, but could be done if you make an offset table to each function from the start of the block, and add the base address to that when branching.
<br/>
<br/>
EDIT: On second thought, referencing something in another position-independent block wouldn't be any harder than accessing the first one from the static code... If you figure out if/how the compiler does it, I'd be interested to know :)<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#73341 - HyperHacker - Fri Feb 24, 2006 10:53 pm</h4>
    <div class="postbody"><span class="postbody">That's what I thought, but where do I add in the .o file in the process of making .elf and .bin files out of them? Like to compile the ARM9 binary, I do this:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">echo Compiling ARM9...
<br/>
%devkitarm_path%\arm-elf-g++ -g -mcpu=arm9tdmi -mtune=arm9tdmi -mthumb-interwork -I%ndslib_path%\include -DARM9 -fomit-frame-pointer -ffast-math -o%devkitarm_path%\arm9.o -c arm9.c
<br/>
IF NOT EXIST %devkitarm_path%\arm9.o GOTO done
<br/>
%devkitarm_path%\arm-elf-g++ -g -mthumb-interwork -mno-fpu -specs=ds_arm9.specs %devkitarm_path%\arm9.o -L%ndslib_path%\lib -lnds9 -o%devkitarm_path%\arm9.elf 
<br/>
IF NOT EXIST %devkitarm_path%\arm9.elf GOTO done
<br/>
%devkitarm_path%\arm-elf-objcopy -O binary %devkitarm_path%\arm9.elf %devkitarm_path%\arm9.bin
<br/>
IF NOT EXIST %devkitarm_path%\arm9.bin GOTO done</td> </tr></table><span class="postbody">
<br/>
Where do I reference the new .o file I've created here? My guess would be adding it after "%devkitarm_path%\arm9.o" in the second arm-elf-g++ call, is that correct? And is there an easy way to make the same code available to both CPUs without duplicating it, or would I have to include it in one and just pass the other its address at runtime?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#73344 - DekuTree64 - Fri Feb 24, 2006 11:16 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>HyperHacker wrote:</b></span></td> </tr> <tr> <td class="quote">Where do I reference the new .o file I've created here? My guess would be adding it after "%devkitarm_path%\arm9.o" in the second arm-elf-g++ call, is that correct?</td> </tr></table><span class="postbody">
<br/>
Yep.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">And is there an easy way to make the same code available to both CPUs without duplicating it, or would I have to include it in one and just pass the other its address at runtime?</td> </tr></table><span class="postbody">
<br/>
You can set up your makefile to compile the same source file for both CPUs, but there's no easy way I know of for both binaries to call the exact same function in memory.
<br/>
<br/>
One way you could do it is by making a function pointer table on the CPU with the functions themselves, and just send the address of the table across to the other CPU. Kind of like this:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void DoNothing() {}
<br/>
int AddSomeNumbers(int a, int b) { return a + b; }
<br/>
<br/>
void *functionTable[] =
<br/>
{
<br/>
    (void*)&amp;DoNothing,
<br/>
    (void*)&amp;AddSomeNumbers,
<br/>
};</td> </tr></table><span class="postbody">
<br/>
Then send it across, and on the other CPU:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void (*DoNothing)(void);
<br/>
int (*AddSomeNumbers)(int, int);
<br/>
<br/>
void ReceiveFunctionTable(void *functionTablePtr)
<br/>
{
<br/>
    DoNothing = (void (*)(void)) (functionTablePtr[0]);
<br/>
    AddSomeNumbers = (int (*)(int, int)) (functionTablePtr[1])
<br/>
}</td> </tr></table><span class="postbody">
<br/>
Then you can call DoNothing and AddSomeNumbers from either CPU :)<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#73358 - HyperHacker - Sat Feb 25, 2006 1:20 am</h4>
    <div class="postbody"><span class="postbody">That's what I was thinking. Thanks, just two more questions. How do I specify sections in ASM, and what are they all named? Eg when I coded for Game Boy, I could throw in "ORG $1234" and it would generate code that assumes it'll be run from address 0x1234 (mainly for calculating whether short jumps could reach a given label). How would I do it here? I know how to do it in C, which leads me to the next question: What are all the sections' names? You can specify like IWRAM, BSS etc; what names correspond to what addresses? (Or can I just specify an address?)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#73469 - DekuTree64 - Sat Feb 25, 2006 10:23 pm</h4>
    <div class="postbody"><span class="postbody">If you're using devkit pro, here are the main sections:
<br/>
.text: Main code in ROM (starts at 0x8000000)
<br/>
.rodata: Data in ROM (starts after .text)
<br/>
.iwram: Code/data in IWRAM (starts at 0x3000000)
<br/>
.bss: Uninitialized data in IWRAM (starts after .iwram)
<br/>
.data: Initialized data in IWRAM (starts after .bss)
<br/>
.ewram: Code/data in EWRAM (starts at 0x2000000)
<br/>
.sbss: Uninitialized data in EWRAM (starts after .ewram)
<br/>
<br/>
You can specify sections in gcc with attributes, like:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">int thingInEwram __attribute__((section(".ewram")));
<br/>
<br/>
__attribute__((section(".iwram"), long_call)) void FunctionInIwram();</td> </tr></table><span class="postbody">
<br/>
The long_call is a bit slower than a normal relative branch, but IWRAM is too far from ROM to jump relatively. Not sure if the compiler will figure out that it can relative-jump if you call one IWRAM function from another.
<br/>
<br/>
There are also overlay sections called .iwram0-.iwram7. They all start at the SAME address (after .data I think), so you can only have one of them loaded into IWRAM at a time. Basically lets you conserve IWRAM if you have some pieces of code that will never be used at the same time.
<br/>
<br/>
There are also .ewram0-7, which behave similarly.<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#73481 - HyperHacker - Sun Feb 26, 2006 12:35 am</h4>
    <div class="postbody"><span class="postbody">Alright, thanks a lot! :-)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#73500 - tepples - Sun Feb 26, 2006 3:05 am</h4>
    <div class="postbody"><span class="postbody">I will warn you that you won't be able to use the .sbss section if you're using appended GBFS with multiboot, as I know of no way to make the startup code relocate the GBFS file to after the end of .sbss before the startup code overwrites .sbss.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#73503 - DekuTree64 - Sun Feb 26, 2006 3:36 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tepples wrote:</b></span></td> </tr> <tr> <td class="quote">...relocate the GBFS file to after the end of .sbss before the startup code overwrites .sbss.</td> </tr></table><span class="postbody">
<br/>
Brilliance :)
<br/>
I've been annoyed by my DS binary being larger than necessary because I had to pad out .bss for that. It's times like this that make writing custom startup code worthwhile<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#74743 - HyperHacker - Tue Mar 07, 2006 7:13 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>DekuTree64 wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>HyperHacker wrote:</b></span></td> </tr> <tr> <td class="quote">Where do I reference the new .o file I've created here? My guess would be adding it after "%devkitarm_path%\arm9.o" in the second arm-elf-g++ call, is that correct?</td> </tr></table><span class="postbody">
<br/>
Yep.</span></td> </tr></table><span class="postbody">
<br/>
OK, so why does it think the functions declared in this file don't exist?
<br/>
<br/>
in memory.s:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">.arm
<br/>
.align
<br/>
.section .iwram
<br/>
.global FastCopy
<br/>
.type FastCopy,function
<br/>
<br/>
FastCopy:
<br/>
[some asm code here]</td> </tr></table><span class="postbody">
<br/>
<br/>
in main.h:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#if ARM9
<br/>
[...]
<br/>
extern void FastCopy();
<br/>
#endif</td> </tr></table><span class="postbody">
<br/>
<br/>
It creates memory.o, which contains the string 'FastCopy', but it tells me no such function exists (undefined reference).</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#74747 - DekuTree64 - Tue Mar 07, 2006 8:08 am</h4>
    <div class="postbody"><span class="postbody">Are you using C++? It normally expects function names to be mangled according to their arguments, but assembly labels are output as-is. You'll get similar errors mixing .c and .cpp files too. Use 
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">extern "C" void function();</td> </tr></table><span class="postbody">
<br/>
or to be .c and .cpp compatible, and not have to type as many "C"s if you have a lot of functions,
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#ifdef __cplusplus
<br/>
extern "C" {
<br/>
#endif
<br/>
<br/>
extern void function();
<br/>
extern void anotherFunction();
<br/>
<br/>
#ifdef __cplusplus
<br/>
}
<br/>
#endif</td> </tr></table><span class="postbody">
<br/>
to tell it that the labels are unmangled.<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#74753 - HyperHacker - Tue Mar 07, 2006 11:29 am</h4>
    <div class="postbody"><span class="postbody">Yay! Now only one more error. :-p
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">F:\dos\DevKitPro\devkitARM\bin\arm9.o: In function `Interrupt()':
<br/>
F:\Programs\Source Codes\DS\bootgba/arm9.c:891: relocation truncated to fit: R_ARM_PC24 against symbol `FastCopy' defined in .iwram section in F:\dos\DevKitPro\devkitARM\bin\memory.o</td> </tr></table><span class="postbody">
<br/>
Apparently it doesn't like me putting that ".section .iwram" there. Is this even necessary on DS? (Isn't code put in IWRAM by default?)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#74791 - DekuTree64 - Tue Mar 07, 2006 7:27 pm</h4>
    <div class="postbody"><span class="postbody">Ah, this is for DS. The sections are similar on both, except DS has .itcm and .dtcm (instruction and data tightly coupled memory) instead of .iwram.<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#74817 - HyperHacker - Tue Mar 07, 2006 11:46 pm</h4>
    <div class="postbody"><span class="postbody">I get the same with .itcm. With .dtcm (which doesn't really seem like a good place for code) it compiles but the function seems to go into an endless loop. I can't tell precisely what's going on (my graphics code is FUBARed at the moment so there's nothing displayed) but the power LED is supposed to blink for a few seconds at startup, and it just never stops blinking.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#74819 - DekuTree64 - Tue Mar 07, 2006 11:59 pm</h4>
    <div class="postbody"><span class="postbody">Yeah, DTCM is not executable. I guess you just found out what happens if you try :)
<br/>
<br/>
Try using .align 2 instead of just .align. I think that's the same error I got when putting things in .rodata way back when and that turned out to be what it was mad about (although I'm not sure exactly why).<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#74820 - HyperHacker - Wed Mar 08, 2006 12:06 am</h4>
    <div class="postbody"><span class="postbody">Still no go. Tried 4 too. Is there maybe something I'm supposed to be adding to the prototype when I put it in ITCM? Seems like it's trying to use too short a jump.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#74828 - DekuTree64 - Wed Mar 08, 2006 1:10 am</h4>
    <div class="postbody"><span class="postbody">Could be. Depends on what address ITCM is mapped to with libnds. I think you put __attribute__((long_call)) at the end of the prototype, just before the semicolon to do long calls. Maybe one less set of parentheses, and you may have to specify a section along with it, but I don't remember the exact syntax. Just search the forum for it.<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#74835 - HyperHacker - Wed Mar 08, 2006 2:33 am</h4>
    <div class="postbody"><span class="postbody">Well I got this far:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">extern void FastCopy() __attribute__((section (".itcm"))) __attribute__((long_call))</td> </tr></table><span class="postbody">
<br/>
<br/>
With or without the section attribute, it still goes into a loop, but it at least compiles now. Do I have to map ITCM somewhere myself?</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
