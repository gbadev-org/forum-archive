<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Creating a bitmap - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>OffTopic > Creating a bitmap</h2>
<div id="posts">
<div class="post">
    <h4>#172630 - Azenris - Sun Feb 21, 2010 9:54 pm</h4>
    <div class="postbody"><span class="postbody">Im using VB for this. It was working till i changed to using 4bpp instead of 8bpp. Im just wondering if you can spot anything obviously wrong with this. It creates a new file 16x16 bitmap 4bpp by taking the data from  larger bitmap, 256x384, 4bpp.
<br/>
<br/>
What Happens:
<br/>
<br/>
The file is created, but cannot be opened in windows preview, or windows paint, but Graphics Gale can still open it, when just clicking the save icon in graphics gale after opening it, it will work fine else where. In graphics gale the palette is there and the image is correct.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
' ###########################################################
<br/>
' constants
<br/>
Public Const TILE_PIXELS_X = 16
<br/>
Public Const TILE_PIXELS_Y = 16
<br/>
Public Const TILE_PIXELS_S = (TILE_PIXELS_X / 2) * TILE_PIXELS_Y
<br/>
<br/>
Private Const PALSET_PREFIX = "pal_set_"
<br/>
Private Const PALSET_LOCATION = ".\data\palsets\"
<br/>
Public Const GRAPHIC_DATA_DIR = ".\data\program_files\tiles\graphics\"
<br/>
<br/>
' ###########################################################
<br/>
Private Sub CreateLittleImage(tile As Integer, offset As Integer)
<br/>
    Dim file As Byte
<br/>
    file = FreeFile
<br/>
<br/>
    ' create/open the new image file
<br/>
    Open GRAPHIC_DATA_DIR &amp; "tile_ico_" &amp; tile + offset &amp; ".bmp" For Binary As #file
<br/>
        Dim newImage_Header As TYPE_BITMAPFILEHEADER
<br/>
        Dim newImage_InfoHeader As TYPE_BITMAPINFOHEADER
<br/>
        
<br/>
        ' fill out the header details
<br/>
        newImage_Header.bfType = 19778      ' means "BM" as in bitmap
<br/>
        newImage_Header.bfSize = 0          ' left 0 with no compression
<br/>
        newImage_Header.bfReserved1 = 0     ' res
<br/>
        newImage_Header.bfReserved2 = 0     ' res
<br/>
        newImage_Header.bfOffBits = 1078    ' standard offset
<br/>
<br/>
        newImage_InfoHeader.biSize = 40                 ' standard size
<br/>
        newImage_InfoHeader.biWidth = TILE_PIXELS_X     ' new image width (pixels)
<br/>
        newImage_InfoHeader.biHeight = TILE_PIXELS_Y    ' new image height (pixels)
<br/>
        newImage_InfoHeader.biPlanes = 1                ' 1 plane
<br/>
        newImage_InfoHeader.biBitCount = 4              ' bits per pixel
<br/>
        newImage_InfoHeader.biCompression = 0           ' no compression
<br/>
        newImage_InfoHeader.biSizeImage = TILE_PIXELS_S ' image byte size
<br/>
        newImage_InfoHeader.biXPelsPerMeter = 0
<br/>
        newImage_InfoHeader.biYPelsPerMeter = 0 
<br/>
        newImage_InfoHeader.biClrUsed = 0 
<br/>
        newImage_InfoHeader.biClrImportant = 0
<br/>
        
<br/>
        Put #file, 1, newImage_Header                   ' write the header to the beginning of the file
<br/>
        Put #file, , newImage_InfoHeader                ' write the info header straight after
<br/>
        Put #file, , BMP_ColourTable                    ' then write the colour table
<br/>
        
<br/>
        Dim x As Integer, y As Integer
<br/>
        Dim tilesPerRow As Integer, tilesPerCol As Integer
<br/>
        Dim imageLocX As Long, imageLocY As Long
<br/>
        
<br/>
        ' calculate the offset required to location the correct
<br/>
        ' location in the master image for finding the image
<br/>
        ' being made
<br/>
        tilesPerRow = (BMP_InfoHeader.biWidth / TILE_PIXELS_X)
<br/>
        tilesPerCol = (BMP_InfoHeader.biHeight / TILE_PIXELS_Y)
<br/>
        
<br/>
        If (tile &lt; tilesPerRow) Then
<br/>
            imageLocX = tile
<br/>
            imageLocY = tilesPerCol - 1
<br/>
        Else
<br/>
            imageLocX = tile Mod tilesPerRow
<br/>
            imageLocY = (tilesPerCol - 1) - Int((tile / tilesPerRow))
<br/>
        End If
<br/>
<br/>
        imageLocX = imageLocX * (TILE_PIXELS_X / 2)
<br/>
        imageLocY = (imageLocY * (TILE_PIXELS_Y * (BMP_InfoHeader.biWidth / 2)))
<br/>
        
<br/>
        ' cycle through the master data and write the bytes to the new file
<br/>
        For y = 0 To (TILE_PIXELS_Y - 1)
<br/>
            For x = 0 To ((TILE_PIXELS_X / 2) - 1)
<br/>
                Put #file, , BMP_Data(imageLocX + imageLocY + (x + (y * (BMP_InfoHeader.biWidth / 2))))
<br/>
            Next x
<br/>
        Next y
<br/>
        
<br/>
    ' close the new image
<br/>
    Close #file
<br/>
End Sub</td> </tr></table><span class="postbody"><br/>_________________<br/><a class="postlink" href="http://sacredpotion.blogspot.com/" target="_blank"><span style="color: red">My Homebrew Games</span></a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#172632 - sajiimori - Mon Feb 22, 2010 12:29 am</h4>
    <div class="postbody"><span class="postbody">I have no idea, but how about using Paint or something to create a .bmp exactly like the one you're trying to write, and look for differences in the binary?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#172639 - Cearn - Mon Feb 22, 2010 11:21 am</h4>
    <div class="postbody"><span class="postbody">It's the BITMAPFILEHEADER's bfOffBits. It's supposed to be the offset to where the image data starts (usually right after the palette). Your value of 1078 would be correct for an 8bpp image (14 (BMFH) + 40 (BMIH) + 1024 (palette) ), but for your 4bpp image it would place the start well outside the file. The windows preview apparently doesn't like it if the sizes don't match up; Graphics Gale seems a little more lenient. For correctness, it might be best to fill in the BITMAPFILEHEADER.bfSize field and BITMAPINFOHEADER.biClrUsed as well.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#172642 - Azenris - Mon Feb 22, 2010 5:26 pm</h4>
    <div class="postbody"><span class="postbody">Doh :/ Thank you for the replies :)<br/>_________________<br/><a class="postlink" href="http://sacredpotion.blogspot.com/" target="_blank"><span style="color: red">My Homebrew Games</span></a></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
