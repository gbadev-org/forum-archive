<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>ACK! Undocumented code! - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>OffTopic > ACK! Undocumented code!</h2>
<div id="posts">
<div class="post">
    <h4>#156011 - Lazy1 - Tue May 06, 2008 8:40 am</h4>
    <div class="postbody"><span class="postbody">So I'm looking at libmpeg2 and it's mpeg2dec example...
<br/>
I want to rip my eyes out...
<br/>
<br/>
To me example code is no good unless I end up understanding what and why it's doing, copy-paste is not an option :/
<br/>
How do all of you handle such code?
<br/>
<br/>
Maybe I should look at ffmpeg/libavcodec instead, but I'm not sure if that's suitable for the DS.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#156015 - sgeos - Tue May 06, 2008 8:49 am</h4>
    <div class="postbody"><span class="postbody">I'd rather have a bad example to work from than no example at all.  I guess I usually end up heading to google.  Answers tend to turn up if I'm really interested in solving the problem.
<br/>
<br/>
-Brendan</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#156017 - simonjhall - Tue May 06, 2008 9:13 am</h4>
    <div class="postbody"><span class="postbody">Ah I'm pissing around with that library at the moment and I've got it rigged up into our framework at work. So if you have any questions I can hopefully help you...however I'm not too comfortable with the 'api' so don't ask too much!
<br/>
<br/>
Btw have you tried debugging it? It's written in macros and gcc doesn't generate debugging information for functions which are entirely made of macros...<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#156019 - sgeos - Tue May 06, 2008 9:24 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>simonjhall wrote:</b></span></td> </tr> <tr> <td class="quote">Btw have you tried debugging it? It's written in macros and gcc doesn't generate debugging information for functions which are entirely made of macros...</td> </tr></table><span class="postbody">
<br/>
Macro languages have their place, but pasting a macro language layer on top of something like C is definitely wrong...
<br/>
Good luck?  It seems like documentation must live somewhere...
<br/>
<br/>
-Brendan</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#156021 - simonjhall - Tue May 06, 2008 9:35 am</h4>
    <div class="postbody"><span class="postbody">It looks like they really want to be using templates but instead do the whole thing with macros. Makes profiling a bit of a bitch too, as since there's no debug line information I can't figure out which lines of code are the most expensive! Instead I get useless info like "24000 clocks spent on this line". Nice.<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#156023 - Lazy1 - Tue May 06, 2008 11:59 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>simonjhall wrote:</b></span></td> </tr> <tr> <td class="quote">Ah I'm pissing around with that library at the moment and I've got it rigged up into our framework at work. So if you have any questions I can hopefully help you...however I'm not too comfortable with the 'api' so don't ask too much!
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Thanks, I'll keep that in mind while trying to dissect and understand the example.
<br/>
I did however give ffmpeg/libavcodec a go and it does in fact compile and run on the DS, unfortunately the output is garbage and I get a bunch of decode errors that aren't there on the PC.
<br/>
<br/>
Libavcodec does seem a bit bloated for a streaming app though so I'll just keep hacking around with libmpeg2, maybe some day I'll dump a single frame of video!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#156025 - simonjhall - Tue May 06, 2008 12:04 pm</h4>
    <div class="postbody"><span class="postbody">libmpeg2 works ok on the DS, it's just a bit too slow to be usable...<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#156026 - Lazy1 - Tue May 06, 2008 12:05 pm</h4>
    <div class="postbody"><span class="postbody">Unless I'm mistaken moonshell uses libmpeg2 and that seems fast enough, besides - I'm only looking for 12-18 fps.
<br/>
Maybe there is a faster mpeg decoding library?
<br/>
<br/>
EDIT:
<br/>
DURRRR!
<br/>
I missed the samples entirely...
<br/>
Again, insomnia and coding do not mix.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#156033 - Lazy1 - Tue May 06, 2008 2:10 pm</h4>
    <div class="postbody"><span class="postbody">Well, it actually works!
<br/>
<br/>
With video displayed: 9-10 FPS
<br/>
Just decoding: 18-23 FPS
<br/>
<br/>
I'm guessing it's the colour conversion functions slowing it down, I'll take a look at that later for optimizations.
<br/>
Still, even at 9FPS that's faster than any remote view application so far. (though I'm playing from disk)
<br/>
<br/>
If I can squeeze 15 FPS out of this then maybe I'll get around to a screen capture/scale/encode app for remote play goodness :D</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#156035 - silent_code - Tue May 06, 2008 2:14 pm</h4>
    <div class="postbody"><span class="postbody">-&gt; awesome! &lt;-</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#156040 - Lazy1 - Tue May 06, 2008 4:11 pm</h4>
    <div class="postbody"><span class="postbody">It seems the libmpeg2 version in svn has ARM optimizations, unfortunately it seems broken since it doesn't decode anything and mpeg2_parse returns STATE_INVALID.
<br/>
<br/>
Really annoying... so close but so far.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#156057 - strager - Tue May 06, 2008 8:55 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Lazy1 wrote:</b></span></td> </tr> <tr> <td class="quote">With video displayed: 9-10 FPS
<br/>
Just decoding: 18-23 FPS
<br/>
<br/>
I'm guessing it's the colour conversion functions slowing it down, I'll take a look at that later for optimizations.
<br/>
<br/>
[...]
<br/>
<br/>
If I can squeeze 15 FPS out of this then maybe I'll get around to a screen capture/scale/encode app for remote play goodness :D</td> </tr></table><span class="postbody">
<br/>
<br/>
Have you considered parallel processing, assigning the colour conversion (YUV =&gt; RGB*, right?) to the ARM7?  The ARM7 can write to VRAM banks C and D (if I recall), and you can swap them to the GPU to render.
<br/>
<br/>
* Are you converting YUV (the native format) to RGB888 to RGB555?  If so you can cut out the middle conversion and save lots of cycles by changing the algorithm a little bit.
<br/>
<br/>
Perform some profiling and see if you can move some sensitive code parts and data structures to ITCM and DTCM, respectively.  This <span style="font-style: italic">really</span> helps, especially with access to very commonly accessed data and code.
<br/>
<br/>
Lazy1, if you can extract the ARM code and the C code it replaces, an able person may be able to see the problem here and patch it.  Of course, you could always ask on the libmpeg2 forums (if such a place exists) or look at earlier revisions of the source code.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#156107 - simonjhall - Tue May 06, 2008 11:34 pm</h4>
    <div class="postbody"><span class="postbody">From the profiling that I've done I spend the majority of my CPU time doing the YUV-&gt;RGB32 conversion, so I reckon you may do to. If you're feeling lazy1 (heh), try just drawing the Y (which is at full resolution) and skipping the colour conversion altogether. Also, make sure that you've got dithering turned off as that's gonna cost you too...
<br/>
<br/>
I'm not 100% sure though that you can compare my timings to yours though as my hardware has floating-power goodness :-)
<br/>
<br/>
Man, I spent all day watching Star Trek IV rolling over and over just trying to make it crash :-)<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#156166 - Lazy1 - Wed May 07, 2008 11:29 am</h4>
    <div class="postbody"><span class="postbody">I'm still not too happy about the decode speed even without the conversion/display.
<br/>
I'll have to look around for some more optimizations, and it seems I have a lot of reading to do since I have never worked with anything but RGB. :D</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#156169 - simonjhall - Wed May 07, 2008 11:59 am</h4>
    <div class="postbody"><span class="postbody">Here's a post that I did a while ago when I first had a bash with this mpeg library - it's got timing info in it pulled straight from a DS. I'm doing YUV-&gt;RGB16 in it btw. Seems the majority of the time is spent doing the idct bit (inverse discrete cosine transform).
<br/>
<br/>
<a href="http://forum.gbadev.org/viewtopic.php?p=132123#132123" target="_blank">http://forum.gbadev.org/viewtopic.php?p=132123#132123</a><br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#156263 - Lazy1 - Thu May 08, 2008 5:09 am</h4>
    <div class="postbody"><span class="postbody">Interesting...
<br/>
I also found that the ARM optimized motion compensation did not help noticeably, unless somehow it's not activated.
<br/>
<br/>
Do you know of any optimized idct functions for ARM?
<br/>
Maybe this is a good time to start learning ARM assembly. (for the 9th time)
<br/>
<br/>
What really sucks though is I'll have to do this under windows, I really prefer linux for dev but really linux just isn't for gaming.
<br/>
<br/>
Another thought is a "turbo" mode where I just upscale 128x96 video and jitter it using hardware.
<br/>
That'll look like shit but maybe allow higher framerates/bitrates for games where fine details don't matter.
<br/>
<br/>
EDIT:
<br/>
Mod - rename thread?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#156292 - Miked0801 - Thu May 08, 2008 4:53 pm</h4>
    <div class="postbody"><span class="postbody">Isn't IDCT just a table lookup?  Or am I forgetting something?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#156343 - tepples - Thu May 08, 2008 10:52 pm</h4>
    <div class="postbody"><span class="postbody">IDCT == inverse <a class="postlink" href="http://en.wikipedia.org/wiki/Discrete_cosine_transform" target="_blank">discrete cosine transform</a><br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#156359 - Miked0801 - Thu May 08, 2008 11:30 pm</h4>
    <div class="postbody"><span class="postbody">I know what it is, but I am pretty sure that all the methods I've seen for using it (JPEG decompressors) used a table lookup for the IDCT step.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#156363 - strager - Thu May 08, 2008 11:56 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Lazy1 wrote:</b></span></td> </tr> <tr> <td class="quote">Do you know of any optimized idct functions for ARM?
<br/>
Maybe this is a good time to start learning ARM assembly. (for the 9th time)</td> </tr></table><span class="postbody">
<br/>
<br/>
If you provide the source code, I may be able to rewrite some of the IDCT functions (in particular, mpeg2_idct_add_c) in ARM ASM for speed optimizations.  (I could just blindly "test" from libmpeg2 directly, but it'd be nice to test on the actual target.)  Does the code work in an emulator?  If so that'd be really awesome.  =]  Hopefully I'll be able to somewhat accurately profile the code, so I don't produce <span style="font-style: italic">slower</span> code than what GCC generates.  At least a "time it took to decode" would be nice (and perhaps all that would be needed if simply changing the code).
<br/>
<br/>
What optimization level (-O flag) are you using, by the way?  You might be able to use -O3 to speed things up even further (or cause the code to crash).</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#156367 - Lazy1 - Fri May 09, 2008 12:09 am</h4>
    <div class="postbody"><span class="postbody">I'll have to look at my code closely again since for some reason the videos are green on hardware.
<br/>
They work fine in an emulator though.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#156413 - Lazy1 - Fri May 09, 2008 2:49 pm</h4>
    <div class="postbody"><span class="postbody">You know what might be even better?
<br/>
Youtube.
<br/>
<br/>
It's definitely possible if you have a server running to transcode the video into say MPEG-4 then stream it to the DS.
<br/>
We know the DS can play XVID at 10 frames per second at 256x192 and that's good enough for streaming video.
<br/>
<br/>
The only thing that would be nice is maybe a boost in WiFi speed, I get about 40 KB/s &lt; 5ft from my AP.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
