<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>c++: glibc memmory corruption - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>OffTopic > c++: glibc memmory corruption</h2>
<div id="posts">
<div class="post">
    <h4>#132234 - Mr Snowflake - Sun Jun 24, 2007 10:36 pm</h4>
    <div class="postbody"><span class="postbody">*** EDIT see below ***
<br/>
<br/>
Hi guys,
<br/>
<br/>
I'm working on a .bsp (V30 - half-life) loader/renderer. But when I try to allocate some memory on the heap I get a: *** glibc detected *** /home/mrsnowflake/Projects/c/snow3d/debug/src/snow3d: malloc(): memory corruption: 0x0810a5c0 ***. I tried it on my desktop and on my laptop, but they both give the same error. Both my computers are running ubuntu, so maybe I should try some other os.
<br/>
<br/>
This is the code genereting the error:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">      planes = new Plane[header-&gt;planes.size/sizeof(Plane)];
<br/>
      if(!readLump(planes, header-&gt;planes.offset, header-&gt;planes.size))
<br/>
         return false;
<br/>
      //textureLumpHeader = &amp;header + header-&gt;directory[LUMP_FACES].offset;
<br/>
      //mipTex = &amp;header + header-&gt;directory[LUMP_FACES].offset;
<br/>
      vertices = new Vertex_t[header-&gt;vertices.size/sizeof(Vertex_t)];
<br/>
      if(!readLump(vertices, header-&gt;vertices.offset, header-&gt;vertices.size))
<br/>
         return false;
<br/>
      listOfFaces = new faceList[header-&gt;lface.size/sizeof(faceList)];
<br/>
      if(!readLump(listOfFaces, header-&gt;lface.offset, header-&gt;lface.size))
<br/>
         return false;
<br/>
      listOfEdges = new surfedge[header-&gt;ledges.size/sizeof(surfedge)];
<br/>
      if(!readLump(listOfEdges, header-&gt;ledges.offset, header-&gt;ledges.size))
<br/>
         return false;
<br/>
      nodes = new Node[header-&gt;nodes.size/sizeof(Node)];
<br/>
      if(!readLump(nodes, header-&gt;nodes.offset, header-&gt;nodes.size))
<br/>
         return false;
<br/>
      //texInfo = &amp;header + header-&gt;directory[LUMP_FACES].offset;
<br/>
      faces = new Face[header-&gt;faces.size/sizeof(Face)];
<br/>
      if(!readLump(faces, header-&gt;faces.offset, header-&gt;faces.size))
<br/>
         return false;
<br/>
      leaves = new Leaf[header-&gt;leaves.size/sizeof(Leaf)];
<br/>
      if(!readLump(leaves, header-&gt;leaves.offset, header-&gt;leaves.size))
<br/>
         return false;
<br/>
      clipNode = new ClipNode[header-&gt;clipnodes.size/sizeof(ClipNode)];
<br/>
      if(!readLump(clipNode, header-&gt;clipnodes.offset, header-&gt;clipnodes.size))
<br/>
         return false;
<br/>
      edges = new Edge[header-&gt;edges.size/sizeof(Edge)];
<br/>
      if(!readLump(edges, header-&gt;edges.offset, header-&gt;edges.size))
<br/>
         return false;
<br/>
      models = new Model[header-&gt;models.size/sizeof(Model)];
<br/>
      if(!readLump(models, header-&gt;models.offset, header-&gt;models.size))
<br/>
         return false;</td> </tr></table><span class="postbody">
<br/>
the readLump reads some data from a file. The program usely crashes at clipNode = new ClipNode[header-&gt;clipnodes.size/sizeof(ClipNode)]; Does any one as an idea why this is happening?
<br/>
<br/>
I just discovered the issue only exists when I setup SDL first. If I comment all the SDL stuff the allocation runs perfectly, but when I just SDL_Init( SDL_INIT_VIDEO ) the problem exists.
<br/>
<br/>
EDIT: Well, I think it's a SDL problem. When I load the map before I setup SDL, the code crashes when gdb gets at SDL_Init( SDL_INIT_VIDEO )... So I probably need to fix sdl or work around sdl...<br/>_________________<br/><a class="postlink" href="http://www.mrsnowflake.be" target="_blank">http://www.mrsnowflake.be</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#132256 - chishm - Mon Jun 25, 2007 3:11 am</h4>
    <div class="postbody"><span class="postbody">I found those errors can be caused much earlier in the program. I ran into this problem once when I accidentally overflowed a malloc'd buffer. The actual error didn't show up until much later, when I tried to free a different buffer.<br/>_________________<br/><a class="postlink" href="http://chishm.drunkencoders.com" target="_blank">http://chishm.drunkencoders.com</a>
<br/>
<a class="postlink" href="http://dldi.drunkencoders.com" target="_blank">http://dldi.drunkencoders.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#132274 - Mr Snowflake - Mon Jun 25, 2007 12:12 pm</h4>
    <div class="postbody"><span class="postbody">With your reply in mind, I tried to allocate a 'fail-safe' buffer between my file reading stuff and the sdl stuff. And now the program works... 
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">   try{
<br/>
      test = new char[1&lt;&lt;shiftNum];
<br/>
   }catch(...){
<br/>
      cerr &lt;&lt; "New gecatched\n";
<br/>
   }
<br/>
</td> </tr></table><span class="postbody">The thing is: when shiftNum == 30 I catch an error. When shiftNum == 20 I get a segmentation fault and when shiftNum == 10 I get this: *** glibc detected *** /home/mrsnowflake/Projects/c/snow3d/debug/src/snow3d: free(): invalid next size (fast): 0x0804eb30 *** Which is the same error when doing the file load before the SDL init.
<br/>
<br/>
Strange stuff.<br/>_________________<br/><a class="postlink" href="http://www.mrsnowflake.be" target="_blank">http://www.mrsnowflake.be</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#132290 - ps2aich - Mon Jun 25, 2007 3:54 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Mr Snowflake wrote:</b></span></td> </tr> <tr> <td class="quote">With your reply in mind, I tried to allocate a 'fail-safe' buffer between my file reading stuff and the sdl stuff. And now the program works... 
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">   try{
<br/>
      test = new char[1&lt;&lt;shiftNum];
<br/>
   }catch(...){
<br/>
      cerr &lt;&lt; "New gecatched\n";
<br/>
   }
<br/>
</td> </tr></table><span class="postbody">The thing is: when shiftNum == 30 I catch an error. When shiftNum == 20 I get a segmentation fault and when shiftNum == 10 I get this: *** glibc detected *** /home/mrsnowflake/Projects/c/snow3d/debug/src/snow3d: free(): invalid next size (fast): 0x0804eb30 *** Which is the same error when doing the file load before the SDL init.
<br/>
<br/>
Strange stuff.</span></td> </tr></table><span class="postbody">
<br/>
<br/>
I only know such strange things happen when mixing debug and non debug built libraries. Usually, in debug builds, the malloc/new handler inserts kinds of sentinel bytes between allocated memory blocks to detect illegal write accesses. 
<br/>
So, if memory is allocated in non debug build lib and deallocated in debug-build code, maybe memory corruption is detected (since the sentinel bytes are not there) OR memory is corrupted itself, sind the deallocation nulls out imaginary sentinel bytes.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#132372 - Mr Snowflake - Tue Jun 26, 2007 9:21 am</h4>
    <div class="postbody"><span class="postbody">That sounds pretty believable. But I changed my code back to the original state: meaning, I now read the whole file, well, I'll eventually read only the world stuff I need and then stream the textures. So now I don't have the allocation problem any more. But thanks any way, if/when I encounter this problem again, I'll check if building a default or maybe optimized binary helps solving this problem.
<br/>
<br/>
[edit]Solved[/edit]
<br/>
[strike]Now I have another question: Say I need to load this struct from a file:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
struct TextureLumpHeader{
<br/>
  unsigned long numTex;      // Number of miptex structures
<br/>
  unsigned long offset[numTex];
<br/>
};</td> </tr></table><span class="postbody">
<br/>
What is the best way of doing this. At the moment, like I said, I load the whole file in unsigned byte* data. So I can get the memory location for the TextureLumpHeader struct by doing (TextureLumpHeader*)(data+header-&gt;textLumpOffset). With header-&gt;textLumpOffset being just the offset in the file.
<br/>
This code doesn't work, as I can't allocate offset[numTex] because numTex is unknow. That's why I changed offset to a unsigned long*. But I can't access offset that way either it's rendering a segmentation fault. I tried setting offset myself to (unsigned long*)(data+header-&gt;textLumpOffset+sizeof(unsigned long)) but this still isn't working...[/strike]<br/>_________________<br/><a class="postlink" href="http://www.mrsnowflake.be" target="_blank">http://www.mrsnowflake.be</a></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
