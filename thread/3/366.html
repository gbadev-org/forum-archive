<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>BUG ... in LZ77 decompression on GBA hardware ?? - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>Hardware > BUG ... in LZ77 decompression on GBA hardware ??</h2>
<div id="posts">
<div class="post">
    <h4>#2264 - cosmic4z - Fri Jan 31, 2003 10:40 pm</h4>
    <div class="postbody"><span class="postbody">Hello,
<br/>
<br/>
My first posting here ...
<br/>
<br/>
I think I have found a BUG in the LZ77 uncompression GBA ROM function ... uncopressing to VRAM ... (LZ77UnCompVram)
<br/>
<br/>
<br/>
I have some tile data that I compressed.
<br/>
<br/>
When I decompress to WRAM (using LZ77UnCompWram) then DMA to VRAM ... it works perfect.
<br/>
<br/>
When I decompress the same data direct to VRAM (using LZ77UnCompVram) ... the data is corrupt!
<br/>
<br/>
WHAT IS GOING ON !!! ?
<br/>
<br/>
Jamie</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#2273 - tepples - Fri Jan 31, 2003 11:55 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>cosmic4z wrote:</b></span></td> </tr> <tr> <td class="quote">When I decompress to WRAM (using LZ77UnCompWram) then DMA to VRAM ... it works perfect.
<br/>
<br/>
When I decompress the same data direct to VRAM (using LZ77UnCompVram) ... the data is corrupt!</td> </tr></table><span class="postbody">
<br/>
Corrupt in what way?  Are the pixels lined up properly, but garbage replaces some of the pixels that were originally of color 0 or color 0x20?  In that case, you may have run into a bug in the LZ77 compressor floating around on the Internet, which causes the compressed data stream to refer to data before the start of the file.  Here's a way to test whether or not you're seeing this:
<br/>
<br/>
1. Fill the first 32 bytes of a buffer with random data.
<br/>
2. Use LZ77UnCompWram(), starting the decompression immediately after the random data.
<br/>
3. Copy to VRAM.
<br/>
<br/>
If you can reproduce the corruption this way, you have an invalid LZ77 data stream, and you might be interested in my corrected compressor.  E-mail me if you want it.
<br/>
<br/>
If you can't reproduce the corruption this way, make sure that both source and destination buffers start on addresses that are a multiple of four bytes.  The *UncompVram() functions are a lot pickier about the destination starting address than the *UncompWram() functions.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#2288 - cosmic4z - Sat Feb 01, 2003 1:38 pm</h4>
    <div class="postbody"><span class="postbody">Thanks for your suggestion Tepples.
<br/>
<br/>
I believe (*know*) that the data has been compressed correctly and that the problem lays with the decompression.
<br/>
<br/>
I tried compressing the data using both AGBComp.exe and also the LZ77 compression source. I get exactly the same results.
<br/>
<br/>
When I decompress the data direct to VRAM it is corrupt. If I decompress (the exact same compressed data) to WRAM first, and then DMA it to VRAM, it works perfectly fine.
<br/>
<br/>
Both source and destination address are a multiple of 4 bytes !!.
<br/>
<br/>
I guess it's just one of those unresloved mysteries (how I hate those !!).
<br/>
<br/>
I will just have to work around it.
<br/>
<br/>
Is there any source for GBA huffman compression ?
<br/>
<br/>
<br/>
Thanks,
<br/>
<br/>
Jamie.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#2292 - ZoneGN - Sat Feb 01, 2003 2:48 pm</h4>
    <div class="postbody"><span class="postbody">Your uncompressed &amp; your compressed file must be also a multiple of 4
<br/>
<br/>
if you have for example un compressed file 3877 octets, you must add 3 octets (anything you want) to have 3880 octets.
<br/>
<br/>
i think that fix the problem.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#2436 - Paul Shirley - Mon Feb 03, 2003 10:50 pm</h4>
    <div class="postbody"><span class="postbody">removed</span><span class="gensmall"><br/><br/>Last edited by Paul Shirley on Sun Mar 28, 2004 9:39 pm; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#2437 - Splam - Mon Feb 03, 2003 11:06 pm</h4>
    <div class="postbody"><span class="postbody">Well it's the BIOS VRAM specific decompression routine so I presume Nintendo know what they're doing ;)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#2438 - cosmic4z - Mon Feb 03, 2003 11:37 pm</h4>
    <div class="postbody"><span class="postbody">Paul:
<br/>
<br/>
Yes ... all data (source and dest) is aligned to 4 bytes and multiples of 4 bytes in length.
<br/>
<br/>
Splam:
<br/>
<br/>
Nintendo know what they are doing do they? I am not convinced ... I am convinced there is some kind of fault in the BIOS LZ77 VRam decompression routine.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#2440 - Splam - Tue Feb 04, 2003 12:26 am</h4>
    <div class="postbody"><span class="postbody">I'm sure someone would have noticed it by now if there was a bug  ie a game developer or someone at Nintendo.  If you'd ever had to go through the Nintendo submission process for a game the stuff they put you through (which is like torture sometimes) must be trivial compared to to their hardware testing.  Still I suppose theres always the chance that a certain ordering of data could produce an error and you just happen to be the lucky guy to stumble across it.
<br/>
<br/>
Have you tried (and this is just a stab in the dark) using the vram call to decompress to wram then dma it?  or is that what you meant when you said you'd tried it to wram already? or did you use the wram specific call for that?
<br/>
<br/>
Oh yeah, are you testing this on hardware or an emu? and if an emu are you using a bios file? if so which one? there are pre-release versions around which supposedly have bugs from some of the early devkits.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#2451 - Splam - Tue Feb 04, 2003 8:34 am</h4>
    <div class="postbody"><span class="postbody">One other thought, you said you used agbcomp to compress the data, did you make sure to set the search size to 2 or greater?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#2463 - cosmic4z - Tue Feb 04, 2003 1:02 pm</h4>
    <div class="postbody"><span class="postbody">Hi Splam.
<br/>
<br/>
Some interesting points you make.
<br/>
<br/>
I am actually a 'professional GBA developer' and YES ... I have had the pleasuse of going through Nintendo's wonderfull submission process !!! ... (the joys or getting link up mode working).
<br/>
<br/>
I tried it both on Hardware and on the Visualboy Advance emulator ... same results.
<br/>
<br/>
I tried uncompressing to WRAM and then DMA'ing to VRAM ... when I do this the data comes out fine / no problem. I uncompress the exact same data direct to VRAM and it's like garbage city !!!
<br/>
<br/>
AHH !!! ... just read your post again ... when I uncompressed to WRAM I did infact use the WRAM specific call ... will try with the VRAM specific call ... decompress to WRAM then DMA to VRAM ... nice idea :-)
<br/>
<br/>
I actually tried using some LZ77 compression source to compress the data ... and also AGBComp ... made no difference in all cases / permutations.
<br/>
<br/>
I will also have a look at your suggestion re: search size of 2 +
<br/>
<br/>
Thanks for your suggestions Splam.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#2464 - cosmic4z - Tue Feb 04, 2003 1:38 pm</h4>
    <div class="postbody"><span class="postbody">Oooops !!!
<br/>
<br/>
Just tried uncompressing to WRAM unsing both LZ77UnCompWram() and LZ77UnCompVram() ... then DMA'ing to VRAM.
<br/>
<br/>
Results were not the same (WRAM specific function was fine ... VRAM specific function garbaged the data).
<br/>
<br/>
Had a look at the docs for AGBComp ...
<br/>
<br/>
-l search (&gt;0) 
<br/>
Outputs using LZ77 compression. Use LZ77UnCompVram() or LZ77UnCompWram() to decompress.
<br/>
Specify 2 or more for search for data decompressed using LZ77UnCompVram().
<br/>
<br/>
Guess who wasn't setting a value for the search size .... DOH !!!.
<br/>
<br/>
Sorry bout that guys.
<br/>
<br/>
- Jamie</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#2475 - tepples - Tue Feb 04, 2003 4:36 pm</h4>
    <div class="postbody"><span class="postbody">Without even looking at a disassembled BIOS, I can see how the decompressor might screw up when trying to read 1 byte back while writing 2 bytes at a time.  It would read a byte that hasn't even been written yet (the VRAM functions write two bytes at a time).  I can also think of a simple workaround that Nintendo could have used while writing the BIOS, special casing all matches of offset 1, which could actually have sped up the decompressor.  Therefore, it's a bug.  And it probably won't be fixed in the next BIOS revision because BIOS revisions have to remain bug-for-bug compatible with programs that exploit BIOS bugs for performance.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
