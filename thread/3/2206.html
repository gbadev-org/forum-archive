<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>REG_VCOUNT on hardware - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>Hardware > REG_VCOUNT on hardware</h2>
<div id="posts">
<div class="post">
    <h4>#11513 - poslundc - Thu Oct 09, 2003 2:21 am</h4>
    <div class="postbody"><span class="postbody">Does anyone know if REG_VCOUNT behaves differently on hardware than in emulation, in particular relating to the interlaced nature of the screen?
<br/>
<br/>
I've been trying to do a simple gradient ("sky") by changing a palette colour from the top of the screen to the bottom of the screen. I'm using HBlank interrupts and REG_VCOUNT to determine what colour to use.
<br/>
<br/>
It works fine in emulation, but on hardware the very first scanline flickers for the first 30 pixels or so.
<br/>
<br/>
I experimentally set it up so that it wouldn't start changing the background colour until the 10th line. Now the first ten lines flicker alternately (ie. interlaced), and the 11th line behaves the way the first line did before.
<br/>
<br/>
Here's the interrupt code:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
skyLevel = gCamera.horizon - REG_VCOUNT + 1;
<br/>
<br/>
if ((REG_VCOUNT &gt; 10) &amp;&amp; (gCamera.horizon &gt; REG_VCOUNT))
<br/>
{
<br/>
   BGPaletteMem[gSkyColourIndex] = gSkyValues[skyLevel];
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Simple enough, huh? And it behaves as expected in emulation, but on hardware those first ten lines BEFORE it starts actually <span style="font-style: italic">doing</span> anything mysteriously flicker.
<br/>
<br/>
Because the flicker is interlaced I thought it might have something to do with how the GBA processes HBlank interrupts and calculates VCOUNT. Can anyone enlighten me?
<br/>
<br/>
Thanks,
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#11514 - tepples - Thu Oct 09, 2003 4:29 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>poslundc wrote:</b></span></td> </tr> <tr> <td class="quote">Does anyone know if REG_VCOUNT behaves differently on hardware than in emulation, in particular relating to the interlaced nature of the screen?</td> </tr></table><span class="postbody">
<br/>
No, it doesn't.  The "interlacing" of the GBA screen isn't real interlacing. The GBA draws all scanlines in all frames, but in order to improve apparent LCD response times, the GBA draws every other scanline at what appears to be half brightness.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">It works fine in emulation, but on hardware the very first scanline flickers for the first 30 pixels or so.</td> </tr></table><span class="postbody">
<br/>
First thirty pixels?  Sounds like you're doing a mid-draw write to the palette. Try loading the first scanline's color during vblank.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#11515 - poslundc - Thu Oct 09, 2003 4:53 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tepples wrote:</b></span></td> </tr> <tr> <td class="quote">No, it doesn't.  The "interlacing" of the GBA screen isn't real interlacing. The GBA draws all scanlines in all frames, but in order to improve apparent LCD response times, the GBA draws every other scanline at what appears to be half brightness.</td> </tr></table><span class="postbody">
<br/>
<br/>
Yeah, I know, but I'm at a loss to explain what could be causing this, so I'm leaning towards whatever crazy connections I can manufacture between the symptoms.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">First thirty pixels?  Sounds like you're doing a mid-draw write to the palette. Try loading the first scanline's color during vblank.</td> </tr></table><span class="postbody">
<br/>
<br/>
Sorry, I should've mentioned that's already been taken care of. I'm very puzzled as to why the colour would only change partway through the scanline, since I know my HBlank interrupts are being called properly and aren't taking too long. (I literally commented everything out of the code except for pretty much what was above, so there's no way I'm using up all of my cycles - especially considering I was DMAing rot/scale data in before I commented the stuff out to debug.)
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
