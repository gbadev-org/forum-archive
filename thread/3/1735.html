<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Possible timing issue? - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>Hardware > Possible timing issue?</h2>
<div id="posts">
<div class="post">
    <h4>#8858 - sgstair - Tue Jul 22, 2003 1:07 am</h4>
    <div class="postbody"><span class="postbody">Hello, I'm working on a project and testing it on a Flash Advance 64M card.  Access timings are set to 4/2 and prefetch is disabled.
<br/>
<br/>
Right now, the game works perfectly on a GBASP, but crashes at random locations on a normal GBA.  Any idea why it might be doing this? I think it's likely it will work well on a professional cart, but can anyone give me more precice information?
<br/>
<br/>
-Stephen<br/>_________________<br/><a class="postlink" href="http://blog.akkit.org/" target="_blank">http://blog.akkit.org/</a> - <a class="postlink" href="http://www.akkit.org/dswifi/" target="_blank">http://www.akkit.org/dswifi/</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#8860 - Dev - Tue Jul 22, 2003 5:18 am</h4>
    <div class="postbody"><span class="postbody">Stephen,
<br/>
<br/>
I vaguely recall hearing something about the 64M cards having far more problems than virtually all other sizes -- if I come across something further in that regard, I'll follow up.
<br/>
<br/>
Can you create a really simple test case that causes it to crash?  I.e. a simple loop that performs whatever operation you're doing that will generate a crash within, say, a few hours?
<br/>
<br/>
It might be easy to simply change the background color in a few places and when it crashes, you'll notice it's stopped changing -- by looking at the color, you'll be able to start narrowing down the area... or at least where in your logic it ran last before crashing!
<br/>
<br/>
If you've got a piece of test code that's small enough, it would probably be easy to isolate whether it's a timing issue, an interrupt issue, or just the cart being flaky.
<br/>
<br/>
Also, I've noticed that the GBA is far more prone to problems with dirty connectors and cart insertion placement than the SP is (although that might just be because it's much older...)
<br/>
<br/>
Still, every so often the cart won't boot, and by simply removing and then replacing the cart and backing it off a teeny bit fixes the odd weirdness... I don't really have any suggestion to offer regarding cleaning the contacts on the GBA, although looking at the ones here, they're pretty grimy!  Same there?
<br/>
<br/>
Good luck!
<br/>
<br/>
Dev.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#8861 - sgstair - Tue Jul 22, 2003 5:38 am</h4>
    <div class="postbody"><span class="postbody">Thanks for the reply :)
<br/>
<br/>
This project we've been working on for many months, and just recently were testing on gbasp - we knew it had some freezing problems on the regular gba with FA carts, and I imagine that's just a timing issue.  (I'll try to hunt it down later, when it's more important)
<br/>
<br/>
The strangeness was just when we could test it on the gbasp, and it worked just fine, no freezing or anything.
<br/>
<br/>
Does anyone know of any hardware changes between gba and sp, cause there have to be some.
<br/>
<br/>
-Stephen<br/>_________________<br/><a class="postlink" href="http://blog.akkit.org/" target="_blank">http://blog.akkit.org/</a> - <a class="postlink" href="http://www.akkit.org/dswifi/" target="_blank">http://www.akkit.org/dswifi/</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#8862 - Dev - Tue Jul 22, 2003 6:26 am</h4>
    <div class="postbody"><span class="postbody">It sounds like it could be the notorious 64M cart problem -- sometimes they're just plain flaky.
<br/>
<br/>
Have you tried cleaning the contacts on the GBA?  Have you tried it with other units?
<br/>
<br/>
There's definitely some sort of HW changes between the GBA and SP, but no one's found anything that's "testable" yet...
<br/>
<br/>
The CPU has been revved, though (you'll be able to find a few images of the PCBs online somewhere, and the rev#s are bumped).
<br/>
<br/>
I strongly doubt that they'll have made any significant changes aside from optimization to reduce the die, but you never know... it doesn't seem likely that they'd want to screw around with fixing the bugs in the core that are already there just because they're making a new chipset.
<br/>
<br/>
Tepples, any thoughts?
<br/>
<br/>
Based on what I've seen elsewhere, there are definitely power-related issues from the backlight on the SP, but that should theoretically cause *more* problems not fewer!
<br/>
<br/>
Still, as I mentioned, you might think about adding a color change to your BG at the start of various top-level functions and making a test build that you just let run -- it'll rapidly let you isolate what general region was the last to execute before it died.
<br/>
<br/>
Dev.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#8870 - sgstair - Tue Jul 22, 2003 3:22 pm</h4>
    <div class="postbody"><span class="postbody">Ok, I will play with the color changes - see what turns up. 
<br/>
<br/>
The contacts are fine. We've tried this many times, with brand new carts and brand new gbas / gbasps
<br/>
<br/>
It could easily be the notorious 64M problem, I suppose the 'problems' with the gbasp having lower voltage or something are actually a bonus in this case?
<br/>
<br/>
-Stephen<br/>_________________<br/><a class="postlink" href="http://blog.akkit.org/" target="_blank">http://blog.akkit.org/</a> - <a class="postlink" href="http://www.akkit.org/dswifi/" target="_blank">http://www.akkit.org/dswifi/</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#8878 - Dev - Tue Jul 22, 2003 5:46 pm</h4>
    <div class="postbody"><span class="postbody">The only time I've heard of ANY problems with the GBASP's voltage is when people try to burn their flashrom and they're running on batteries with the LCD backlight turned on.
<br/>
<br/>
I'd doubt that it's the cause of your troubles, but you never know.
<br/>
<br/>
Dev.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#8879 - sgstair - Tue Jul 22, 2003 5:48 pm</h4>
    <div class="postbody"><span class="postbody">I think a voltage difference might be the issue, since it does work properly on the sp, and crashes randomly on a normal gba.
<br/>
<br/>
-Stephen<br/>_________________<br/><a class="postlink" href="http://blog.akkit.org/" target="_blank">http://blog.akkit.org/</a> - <a class="postlink" href="http://www.akkit.org/dswifi/" target="_blank">http://www.akkit.org/dswifi/</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#8885 - Dev - Tue Jul 22, 2003 11:05 pm</h4>
    <div class="postbody"><span class="postbody">If you don't have anything other than 64M carts, you might want to post a small demo that people could download and try on the 128M or 256M units.
<br/>
<br/>
Be sure to fill us in when you find the cause!
<br/>
<br/>
Dev.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#8898 - ampz - Wed Jul 23, 2003 1:53 pm</h4>
    <div class="postbody"><span class="postbody">The GBA is 3.3V and there is no reason why the GBASP should not be 3.3V as well.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#8909 - sgstair - Wed Jul 23, 2003 4:53 pm</h4>
    <div class="postbody"><span class="postbody">Maybe not a voltage difference but a current difference?
<br/>
Even a voltage difference is possible - the gbasp has a different kind of battery altogether, and has a backlight too... people reporting problems writing flash carts is somewhat indicative of this.
<br/>
<br/>
There are some hardware differences, though subtle.
<br/>
<br/>
-Stephen<br/>_________________<br/><a class="postlink" href="http://blog.akkit.org/" target="_blank">http://blog.akkit.org/</a> - <a class="postlink" href="http://www.akkit.org/dswifi/" target="_blank">http://www.akkit.org/dswifi/</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#8924 - ampz - Wed Jul 23, 2003 10:13 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>sgstair wrote:</b></span></td> </tr> <tr> <td class="quote">Maybe not a voltage difference but a current difference?
<br/>
Even a voltage difference is possible - the gbasp has a different kind of battery altogether, and has a backlight too... people reporting problems writing flash carts is somewhat indicative of this.
<br/>
<br/>
There are some hardware differences, though subtle.
<br/>
<br/>
-Stephen</td> </tr></table><span class="postbody">
<br/>
<br/>
If you knew a bit about electricity you'd know that there cannot be a difference in current unless there is a difference in voltage for a given load (like a flashcart).
<br/>
The type of battery is not important since both the GBA and the GBASP use a switch mode power supply (SMPS).
<br/>
<br/>
It is possible that the SMPS in the GBASP is weaker than the one in the GBA, making it fail when the load goes too high.
<br/>
As you say, the load on the GBASP IS higher due to the backlight. It might make the SMPS fail if combined with a very power-hungry cart. Who knows.
<br/>
<br/>
People having problems with the SP should try shutting off the light.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#8925 - Dev - Wed Jul 23, 2003 10:44 pm</h4>
    <div class="postbody"><span class="postbody">Yes, technically it's a current difference, but I didn't want it to get too complicated.
<br/>
<br/>
The fact is that the GBASP problems I've heard of ONLY occur when trying to erase and burn a flash rom when the unit is battery-powered and the light is on.
<br/>
<br/>
If running regular code, there should be no difference.
<br/>
<br/>
I'd suspect a BUG in the software rather than one in the hardware... at least until it can be definitely proven otherwise.
<br/>
<br/>
Dev.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#8931 - sgstair - Thu Jul 24, 2003 2:36 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>ampz wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>sgstair wrote:</b></span></td> </tr> <tr> <td class="quote">Maybe not a voltage difference but a current difference?
<br/>
Even a voltage difference is possible - the gbasp has a different kind of battery altogether, and has a backlight too... people reporting problems writing flash carts is somewhat indicative of this.
<br/>
<br/>
There are some hardware differences, though subtle.
<br/>
<br/>
-Stephen</td> </tr></table><span class="postbody">
<br/>
<br/>
If you knew a bit about electricity you'd know that there cannot be a difference in current unless there is a difference in voltage for a given load (like a flashcart).
<br/>
The type of battery is not important since both the GBA and the GBASP use a switch mode power supply (SMPS).
<br/>
<br/>
It is possible that the SMPS in the GBASP is weaker than the one in the GBA, making it fail when the load goes too high.
<br/>
As you say, the load on the GBASP IS higher due to the backlight. It might make the SMPS fail if combined with a very power-hungry cart. Who knows.
<br/>
<br/>
People having problems with the SP should try shutting off the light.</span></td> </tr></table><span class="postbody">
<br/>
<br/>
<br/>
I know quite a bit about electricity - and you've left resistance entirely out of the mix.  It is possible that the SMPS will vary, not fail, in the sp when there is a heavy load, in which case the voltage and current will fall. however, the constant resistance in the equation may be different between the sp and the regular gba, causing there to be a different voltage/current ratio.  If the SMPS were actually to fail, who knows what would happen, it's likely the cpu would be first to go though.
<br/>
<br/>
Also, I'm NOT having problems with the SP, I'm stating that this program WORKS on the SP, and DOESN'T on the regular gba.
<br/>
<br/>
-Stephen<br/>_________________<br/><a class="postlink" href="http://blog.akkit.org/" target="_blank">http://blog.akkit.org/</a> - <a class="postlink" href="http://www.akkit.org/dswifi/" target="_blank">http://www.akkit.org/dswifi/</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#8932 - tepples - Thu Jul 24, 2003 3:37 am</h4>
    <div class="postbody"><span class="postbody">I have five distinct test environments available to me:<ul><li>a Glacier GBA with a Visoly Flash Advance 256 Mbit cart</li><li>a Glacier GBA with an MBV2 cable</li><li>a GB Player with with a Visoly Flash Advance 256 Mbit cart</li><li>a GB Player with an MBV2 cable</li><li>VisualBoyAdvance</li></ul>
<br/>
I'd be happy to test the code. Can you put source code and/or a binary on a public HTTP server and give us the URI?<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#8935 - ampz - Thu Jul 24, 2003 10:21 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>sgstair wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>ampz wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>sgstair wrote:</b></span></td> </tr> <tr> <td class="quote">Maybe not a voltage difference but a current difference?
<br/>
Even a voltage difference is possible - the gbasp has a different kind of battery altogether, and has a backlight too... people reporting problems writing flash carts is somewhat indicative of this.
<br/>
<br/>
There are some hardware differences, though subtle.
<br/>
<br/>
-Stephen</td> </tr></table><span class="postbody">
<br/>
<br/>
If you knew a bit about electricity you'd know that there cannot be a difference in current unless there is a difference in voltage for a given load (like a flashcart).
<br/>
The type of battery is not important since both the GBA and the GBASP use a switch mode power supply (SMPS).
<br/>
<br/>
It is possible that the SMPS in the GBASP is weaker than the one in the GBA, making it fail when the load goes too high.
<br/>
As you say, the load on the GBASP IS higher due to the backlight. It might make the SMPS fail if combined with a very power-hungry cart. Who knows.
<br/>
<br/>
People having problems with the SP should try shutting off the light.</span></td> </tr></table><span class="postbody">
<br/>
<br/>
<br/>
I know quite a bit about electricity - and you've left resistance entirely out of the mix.  It is possible that the SMPS will vary, not fail, in the sp when there is a heavy load, in which case the voltage and current will fall. however, the constant resistance in the equation may be different between the sp and the regular gba, causing there to be a different voltage/current ratio.  If the SMPS were actually to fail, who knows what would happen, it's likely the cpu would be first to go though.
<br/>
<br/>
Also, I'm NOT having problems with the SP, I'm stating that this program WORKS on the SP, and DOESN'T on the regular gba.
<br/>
<br/>
-Stephen</span></td> </tr></table><span class="postbody">
<br/>
<br/>
I did not leave out resistance. Resistance == load.
<br/>
I did not want to use the word resistance since a flashcart is anything but a purely resistive load. What I'am saying is just that since the voltage is the same, and the flashcart load is the same, there cannot be any difference in the current the flashcart sees. That's all.
<br/>
<br/>
For the flashcart voltage/current to vary, there must be a problem with the SMPS.
<br/>
<br/>
I'am well aware that you are having problems with the GBA, and not the SP. That is indeed a strange problem.
<br/>
The GBASP cart connector is surface mounted, and the leads are probably slightly shorter. Might help the timing 0.1ns...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#8942 - Cyberman - Thu Jul 24, 2003 3:03 pm</h4>
    <div class="postbody"><span class="postbody">If you are concerned about a voltage difference, changing the speed of the components, would be by lowering the voltage would slow the components down.  The only real way to know what is going on would be to put the cartridge power supply rails on an ocilloscope and watch the wave form. A 20mhz scope will be all you need.  Setting the triggering might be a bit of a challenge (IE finding something to trigger it so the wave shows something), though if you are in an endless loop it won't be as bad (each time the address is reloaded would be a good event to trigger on).
<br/>
<br/>
You can also look at the clock skew differences. Since all of this would be on the cartridge not the GBA, just open said cartridge and put the probs in I guess. :)
<br/>
<br/>
As for what the problem might be, there really isn't enough information to make a guess (and that's all it would be).
<br/>
<br/>
SMPS supplies will vary depending on the passive components and the controller chip, if the SMPS chip is different or the same etc.  It depends on what there input voltages is what inductor they used, what decoupling cap they used on the power input to the SMPS and what post inductor filter capacitor they used that will determine it's behavior. In other words.. too many things, since a schematic for the SP is not likely to magically appear you can only derive information by what you observe.
<br/>
<br/>
Actually if the SP power supply is a bit better than the GBA then it's likely that supply voltage to the cart would be more stable.  Depending on how much hardware they have on the cart the chip can be drawing to much current at the right time causing it to glitch.  I've noticed this happens with designs that are close to the systems tolerances (I should say things I've made that are.. ;) ).
<br/>
<br/>
Experiment you need to thiink of ways to isolate each possibility.
<br/>
<br/>
If you REALLY think it's the power supply, decouple it, by adding an external power supply to the cartridge, granted it may take a while to put together, it does guarentee if it is the power supply or not.  A nice LDO will work nicely and you can use a 5V supply with it, these are simple and cheap.
<br/>
<br/>
If you think it's the timing.. change the wait state used with the cartridge at the very begining of your program, that is something you can do with the GBA entirely in software perhaps the most practical of all the ideas ;)
<br/>
<br/>
Cyb</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#8946 - sgstair - Thu Jul 24, 2003 5:18 pm</h4>
    <div class="postbody"><span class="postbody">At the heart of what I am suggesting, is that the cartridge interface circuitry in the SP has a different resistive load than the gba.  This resistance is then combined with the resistance of the cart, and DOES cause a different voltage/current ratio.
<br/>
<br/>
-Stephen<br/>_________________<br/><a class="postlink" href="http://blog.akkit.org/" target="_blank">http://blog.akkit.org/</a> - <a class="postlink" href="http://www.akkit.org/dswifi/" target="_blank">http://www.akkit.org/dswifi/</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#8947 - sgstair - Thu Jul 24, 2003 5:25 pm</h4>
    <div class="postbody"><span class="postbody">Thanks cyberman - I'll be checking all this when I have access to the equipment (in a few weeks, when college starts again)
<br/>
<br/>
I think it is the timing, but clock skew is likely the issue,  the flash cart may not be good enough to do what I want it to do.  My instinct tells me it will work on a commercial cart, but I'm not sure about that either.  I'll try to shift it to a lower waitstate - that might help.  I'll also rewrite the interrupt handler, as I'm pretty sure it's interrupt related. 
<br/>
<br/>
-Stephen<br/>_________________<br/><a class="postlink" href="http://blog.akkit.org/" target="_blank">http://blog.akkit.org/</a> - <a class="postlink" href="http://www.akkit.org/dswifi/" target="_blank">http://www.akkit.org/dswifi/</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#8998 - Dev - Sat Jul 26, 2003 12:30 am</h4>
    <div class="postbody"><span class="postbody">Now that you mention it, I recall some older 64M carts having trouble at anything faster than 4/2.
<br/>
<br/>
If you're using 3/1 and expecting it to work on older 64M carts, that could be the problem.
<br/>
<br/>
Dev.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#9002 - sgstair - Sat Jul 26, 2003 2:18 am</h4>
    <div class="postbody"><span class="postbody">I mentioned already - I am using 4/2 for timing
<br/>
<br/>
-Stephen<br/>_________________<br/><a class="postlink" href="http://blog.akkit.org/" target="_blank">http://blog.akkit.org/</a> - <a class="postlink" href="http://www.akkit.org/dswifi/" target="_blank">http://www.akkit.org/dswifi/</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#9003 - Dev - Sat Jul 26, 2003 2:24 am</h4>
    <div class="postbody"><span class="postbody">Well, I'm tapped then.  You haven't provided enough information to help any further.
<br/>
<br/>
Be sure to tell us once you figure out what the problem was.
<br/>
<br/>
Dev.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#9005 - sgstair - Sat Jul 26, 2003 5:57 am</h4>
    <div class="postbody"><span class="postbody">I'm not particularly looking for an answer - just a good guess.  I was wondering if anyone had come across this issue before, cause it is rather obscure and I'd never seen or heard of it before.  Why a program works perfectly on the GBA SP and randomly freezes on the regluar GBA with the same cart, same everything else just doesn't make much sense.
<br/>
<br/>
Anyhow- thanks to everyone for your suggestions/insights, I'm sorry but I'm not in a position to provide more information or else I'd have a rom out there for you to play with.
<br/>
<br/>
-Stephen<br/>_________________<br/><a class="postlink" href="http://blog.akkit.org/" target="_blank">http://blog.akkit.org/</a> - <a class="postlink" href="http://www.akkit.org/dswifi/" target="_blank">http://www.akkit.org/dswifi/</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#9013 - Dev - Sat Jul 26, 2003 4:21 pm</h4>
    <div class="postbody"><span class="postbody">My best guess is that either you've got a bug, or the latest chipset has fixed some weird issue relating to DMA and/or Interrupt generation.
<br/>
<br/>
If infact you've discovered a hardware-based timing issue, it may be possible to use it to detect GBA vs. GBASP.
<br/>
<br/>
Dev.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
