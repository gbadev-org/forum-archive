<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>GBAMP Firmware Hacking - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>Hardware > GBAMP Firmware Hacking</h2>
<div id="posts">
<div class="post">
    <h4>#46684 - chishm - Wed Jun 29, 2005 2:42 am</h4>
    <div class="postbody"><span class="postbody">Hi all,
<br/>
I have finished with the compact flash part of the GBA movie player, so now I am moving onto the firmware. Has has been previously discussed the firmware shows up as a repeat of 512 bytes if dumped without booting the GBAMP first. I have so far been unable to figure out how to unlock the rest of the memory without booting the GBAMP first. My question is: if someone has a corrupted GBAMP (ie it won't boot at all) and a multiboot cable of some kind (MBV2, Xboo) could you please
<br/>
1) Start the GBAMP normally even if it won't boot
<br/>
2) Quickly power cycle the GBA and press START + SELECT to enter multiboot mode
<br/>
3) Dump the firmware
<br/>
4) Examine the firmware to check if it still has the repeating 512 byte block.
<br/>
5) If allowed, post the dump.
<br/>
Thankyou.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#46689 - Lynx - Wed Jun 29, 2005 3:44 am</h4>
    <div class="postbody"><span class="postbody">You might want to check with DF, as I think he's working on writing his own Firmware.. I'd guess he was able to dump and decrypt to learn how to write his own firmware.  But I'm just guessing.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#46695 - chishm - Wed Jun 29, 2005 5:08 am</h4>
    <div class="postbody"><span class="postbody">I know Darkfader has already flashed his GBAMP, but he is also only able to access the first 512 bytes in DS mode. I am trying to figure out how to access all of the memory. I can already dump the proper firmware in its entirety, but only if I boot the GBAMP normally first. I am trying to figure out how to do it without having to boot into GBA mode first.
<br/>
<br/>
In GBATek it mentions that the BIOS performs a sequence of reads based on the header. Does anyone know what addresses it reads from and how to work out which sequence is used? I think this is going to be important information.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#46701 - tepples - Wed Jun 29, 2005 6:15 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>chishm wrote:</b></span></td> </tr> <tr> <td class="quote">In GBATek it mentions that the BIOS performs a sequence of reads based on the header. Does anyone know what addresses it reads from and how to work out which sequence is used? I think this is going to be important information.</td> </tr></table><span class="postbody">
<br/>
Dump your GBA's BIOS, load it into an emulator, and log ROM accesses during the first few seconds.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#46703 - chishm - Wed Jun 29, 2005 6:19 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tepples wrote:</b></span></td> </tr> <tr> <td class="quote">Dump your GBA's BIOS, load it into an emulator, and log ROM accesses during the first few seconds.</td> </tr></table><span class="postbody">
<br/>
I've already dumped my GBA's BIOS and tried it with VBA dev, but I can't figure out how to log address <span style="font-style: italic">reads</span> with it. Are there any emulators that allow me to do this that are free (I can't send money over the internet)?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#46704 - tepples - Wed Jun 29, 2005 6:39 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>chishm wrote:</b></span></td> </tr> <tr> <td class="quote">(I can't send money over the internet)</td> </tr></table><span class="postbody">
<br/>
Under 18? Or not in a first world country?
<br/>
<br/>
You could always get the VBA source, edit it to log all cart reads while r15 is within the BIOS, and recompile it.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#46745 - chishm - Thu Jun 30, 2005 1:10 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tepples wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>chishm wrote:</b></span></td> </tr> <tr> <td class="quote">(I can't send money over the internet)</td> </tr></table><span class="postbody">
<br/>
Under 18? Or not in a first world country?
<br/>
<br/>
You could always get the VBA source, edit it to log all cart reads while r15 is within the BIOS, and recompile it.</span></td> </tr></table><span class="postbody">
<br/>
I am 18, and unless Australia is not a first world country, those aren't the reasons. Its actually because I have no credit card and I am not going to give bank account details over the net, money transefers cost something like $5 to $20, and since No$GBA hobby version is $15 its not worth it. 
<br/>
<br/>
I took your advice with the VBA source. I had to download like 600MB of SDKs on a 300MB 256/64 ADSL plan (maybe I am in a third world country) to get it to compile. It was worth it though, as I now have a log of the reads performed by the BIOS. If anyone wants them I could post it here, but its a bit long.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#46747 - tepples - Thu Jun 30, 2005 1:22 am</h4>
    <div class="postbody"><span class="postbody">If you could narrow it down to those reads that change based on the title of the ROM (see gbafix) and based on bits 0 and 1 of byte 0x0800009E, there should be only 16 possibilities.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#46753 - chishm - Thu Jun 30, 2005 5:24 am</h4>
    <div class="postbody"><span class="postbody">I actually took the log after loading the firmware dump, so it should have the correct set of reads required for the cartridge.
<br/>
<br/>
I've been examining the hardware in the GBAMP and I know what one of the chips is (39VF400A : 16 * 32KiB flash ROM) but I am not 100% on the other. I think it might be a PIC used to protect the firmware, only ollowing the low 9 bits of the firmwarew bus through until it is unlocked by the BIOS.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#46763 - darkfader - Thu Jun 30, 2005 6:26 am</h4>
    <div class="postbody"><span class="postbody">Wow.. much talk here again. hehe.
<br/>
512 bytes -&gt; 8 address lines.
<br/>
And there are also 8 address lines that are locked.
<br/>
I previously tried the logged accesses too.. but no success. Already mentioned that somewhere on the DS hardware forum.
<br/>
Anyway, it's unlocked by only the init sequence that GBA BIOS makes, since I can read everything fine using my own app that I flashed.
<br/>
Perhaps it's not just the sequence, but also some low-level thingy.
<br/>
Check <a href="http://cvs.sourceforge.net/viewcvs.py/devkitpro/tools/nds/bootstrap/flashmp/" target="_blank">http://cvs.sourceforge.net/viewcvs.py/devkitpro/tools/nds/bootstrap/flashmp/</a> for flashing details.
<br/>
You _can_ use that reinsert trick in DS mode to unlock it, but the chance of success is very small. So you'd have to reinsert a lot.
<br/>
And that other chip is not a PIC, but some CPLD. Don't know the exact type, but I have some suspect. Not really useful though, since it's difficult to modify it.
<br/>
I still haven't set up a CVS for your FAT code... oh well.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#46769 - chishm - Thu Jun 30, 2005 10:43 am</h4>
    <div class="postbody"><span class="postbody">I forgot the lowest bit address line is not connected. After experimenting with it I have found the following about reading the firmware:
<br/>
1) Once it is locked, it will not unlock until the power has been removed for a sufficient time (a few seconds)
<br/>
2) Once it is unlocked, it remains unlocked (see above)
<br/>
3) It becomes locked by reads to memory outside a certain range
<br/>
4) If the firmware is locked, not even booting normally will work
<br/>
5) If the firmware is unlocked and a soft reset is issued it will boot normally, however if it is locked the GBA will freeze (see #4)
<br/>
<br/>
Does a soft reset actually execute the entire boot routine again or does it simply jump back to 0x08000000? How could I force a jump to 0x0800000 without a reset?
<br/>
<br/>
Darkfader:
<br/>
I have looked at your flashing code, and from what I see the flash addresses are not mapped sequentially to the GBA bus. That is the flash address lines are not connected in ascending order to the GBA address lines, even with the non connected A13, A14 and A15. Is this correct? 
<br/>
And does this mean that if a block of data is written to the flash chip properly it will appear scrambled when accessed from the GBA? 
<br/>
If I flash my GBAMP using your tool, do you currently have a way to recover back to the normal firmware without using Repair.nes?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#46785 - darkfader - Thu Jun 30, 2005 3:17 pm</h4>
    <div class="postbody"><span class="postbody">It's correct that the addresses are scrambled. But it really only affects on how you send the erase and programming codes to the flashchip. I could change the calls to the addresscalculator function with fixed values to make it faster. Then if you write in sequental cart addresses using the GBA/DS, data will be written scrambled in flashchip. And this vice-versa of course.
<br/>
And yes, I do have a backup of the data and could also restore it.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#46812 - chishm - Fri Jul 01, 2005 2:10 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>darkfader wrote:</b></span></td> </tr> <tr> <td class="quote">Anyway, it's unlocked by only the init sequence that GBA BIOS makes, since I can read everything fine using my own app that I flashed.
<br/>
Perhaps it's not just the sequence, but also some low-level thingy.
<br/>
</td> </tr></table><span class="postbody">
<br/>
Can you explain this to me. Say you overwrite the firmware completely, including the header. What happens when you try to dump it without the BIOS unlocking it first? Is it still locked? And say you have changed the header so that the startup read sequence is changed. Does it still unlock properly? I am just trying to figure out whether it is a specific sequence of reads by the BIOS that unlocks it, as opposed to the timings of the reads.
<br/>
<br/>
EDIT:
<br/>
I have worked out how to jump to the cart start without a reset. Here is the code I use:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">// Jump to cart start
<br/>
asm ("ldr r4, =1&lt;&lt;27");
<br/>
asm ("bx r4");</td> </tr></table><span class="postbody">I know it is not the best way to do it, but it is just a quick way to know that I am not executing any BIOS code before the cart starts.
<br/>
<br/>
Using this I have written a program that waits until a cart is inserted before jumping to the start address. The point? Simple, I multiboot the program with no cart inserted, then insert the GBAMP. It boots normally, proving that it is unlocked. What is more is that there is no way that it could possibly have been unlocked by the BIOS, as it is not inserted until the BIOS has finished executing. This shows that the BIOS <span style="font-weight: bold">does not</span> unlock the GBAMP.
<br/>
Another thing I have done with this is lock the GBAMP.
<br/>
Executing this code:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">for (u32 i = 300; i &lt; 400; i+=2)
<br/>
   temp16 = *((vu16*)(0x08000000 + i));
<br/>
</td> </tr></table><span class="postbody">will lock the GBAMP. After those reads have completed it will not boot until it has had time for the power to drain. What's so interesting about this? It seems that rather than the BIOS <span style="font-style: italic">unlocking</span> the GBAMP, <span style="font-style: italic">attempts to read it actually lock the firmware</span>. All very interesting...</span><span class="gensmall"><br/><br/>Last edited by chishm on Fri Jul 01, 2005 5:11 am; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#46832 - Dwedit - Fri Jul 01, 2005 5:07 am</h4>
    <div class="postbody"><span class="postbody">Is it possible to read the first 512 bytes from other pages even when it's locked?  I remember being able to do that easily.
<br/>
If so, there should be 16k of rom to play around with!<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#46836 - chishm - Fri Jul 01, 2005 5:21 am</h4>
    <div class="postbody"><span class="postbody">Yes you can read the first 512 bytes every 0x4000 bytes. There are 32 such pages available. This gives us 16K to work with. The only problem is that the firmware happens to store bookmarks in some of those pages, so it is too dangerous to use the normal firmware at the same time (if this is even possible)
<br/>
<br/>
More info on locking / unlocking: Before the firmware is locked or unlocked reads to memory outside of the first 512 bytes result in 0 data. Reading certain addresses will lock it though, so you have to be careful. If only I could work out how to unlock it.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#46955 - darkfader - Sat Jul 02, 2005 5:06 pm</h4>
    <div class="postbody"><span class="postbody">The fail-safe part is 32KBytes. And I got the unlock sequence too :P
<br/>
I'll put it into the flashing tool...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#46975 - chishm - Sun Jul 03, 2005 12:23 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>darkfader wrote:</b></span></td> </tr> <tr> <td class="quote">The fail-safe part is 32KBytes. And I got the unlock sequence too :P
<br/>
I'll put it into the flashing tool...</td> </tr></table><span class="postbody">
<br/>
So what is the unlock sequence? Is it done by the BIOS or by the firmware? I'm really curious about this one. I've spent ages trying to figure it out, as you can probably guess from my previous posts.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#46981 - darkfader - Sun Jul 03, 2005 1:31 am</h4>
    <div class="postbody"><span class="postbody">Got something upped to that CVS.
<br/>
Do you have MSN/IRC ? :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#47091 - chishm - Tue Jul 05, 2005 1:59 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>darkfader wrote:</b></span></td> </tr> <tr> <td class="quote">The fail-safe part is 32KBytes. And I got the unlock sequence too :P
<br/>
I'll put it into the flashing tool...</td> </tr></table><span class="postbody">
<br/>
I have checked it out. It works quite nicely. You can shrink that unlock sequence down to 108 bytes if you wanted to. You only need to do a 32 bit read with every first out of two addresses. You can also store each read address as a byte shifted down by 1. It is then possible to unlock the entire firmware from code within the first 512 bytes. 
<br/>
<br/>
There are a few tricks to this, though. First, you will have to read the data backwards, from halfwords 510 down to 250 (aprroximately). If you tried to read it in ascending order you will lock the firmware. Then you will have to run the unlock code from RAM, as running from ROM will cause additional reads, ruining the unlock sequence (you probably knew this).</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#47121 - darkfader - Tue Jul 05, 2005 12:59 pm</h4>
    <div class="postbody"><span class="postbody">Ok, changed to bytes now.
<br/>
I could make my loader use the flash so it doesn't get in the way when loading programs to RAM, but putting on CF is more versatile so I'll stick to that.
<br/>
I continued my FAT driver a little more and can read long filenames. yay....</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#47160 - DiemetriX - Tue Jul 05, 2005 11:23 pm</h4>
    <div class="postbody"><span class="postbody">So how long do you think it's before we can boot homebrew from the MP via software or Wifi Darkfader?<br/>_________________<br/><a href="http://www.home.no/diemetrix/1337.htm" target="_blank">www.home.no/diemetrix/1337.htm</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#47193 - zubiac - Wed Jul 06, 2005 7:45 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>DiemetriX wrote:</b></span></td> </tr> <tr> <td class="quote">So how long do you think it's before we can boot homebrew from the MP via software or Wifi Darkfader?</td> </tr></table><span class="postbody">
<br/>
<br/>
yeah I wonder that too.
<br/>
This will be so roxor cause after frying 2 GBA flash cards in a row(&gt;_&lt;) I'm not willing to spend another 100euros for another flash card.
<br/>
My GBAMP sits here with 5 different CF cards and has no real job yet(beside watching "Powerpuff girls").
<br/>
<br/>
I can't thank darfader and chism enough for hacking the GBAMP cause it will save tons of people's money once released.
<br/>
<br/>
I ?know for sure that the first thing I will do(once the hack works) is FINALLY flashing the hacked firmware(FlashMe) on my DS.<br/>_________________<br/>Abusing Cube and DS with all sorts of homebrew and hacks.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#47319 - chishm - Thu Jul 07, 2005 10:46 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>darkfader wrote:</b></span></td> </tr> <tr> <td class="quote">Ok, changed to bytes now.
<br/>
I could make my loader use the flash so it doesn't get in the way when loading programs to RAM, but putting on CF is more versatile so I'll stick to that.
<br/>
I continued my FAT driver a little more and can read long filenames. yay....</td> </tr></table><span class="postbody">
<br/>
While I was trying to figure out the firmware unlock sequence I was disassembling the firmware startup. In the first 512 bytes it sets up the display and stack (unimportant) but the reads it does from the cart obviously unlock it. It then copies the rest of the firmware "cluster" (from 512 B to 4 KiB) to EWRAM and jumps there. This part basically DMAs the next cluster to IWRAM (which is where the update code is) then jumps to it. 
<br/>
My point? At the moment you are only using the first sector of the firmware for your boot loader, which limits its abilities like you rely on there being startup code in the MBR of the CF card. However, since the first cluster only loads the second cluster there should be more than enough space to check the CF card for a boot loader file. If it doesn't find a boot loader, it can then continue loading the GBAMP software. This retains the functionality of the GBAMP while incoporating a DS loader.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#47320 - zubiac - Thu Jul 07, 2005 12:00 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>chishm wrote:</b></span></td> </tr> <tr> <td class="quote">My point? At the moment you are only using the first sector of the firmware for your boot loader, which limits its abilities like you rely on there being startup code in the MBR of the CF card. However, since the first cluster only loads the second cluster there should be more than enough space to check the CF card for a boot loader file. If it doesn't find a boot loader, it can then continue loading the GBAMP software. This retains the functionality of the GBAMP while incoporating a DS loader.</td> </tr></table><span class="postbody">
<br/>
<br/>
So the original GBAMP firmware will still survive after the hack?
<br/>
which means: you are still able to use the MP for its purpose?
<br/>
<br/>
wow just wow. awesome if true<br/>_________________<br/>Abusing Cube and DS with all sorts of homebrew and hacks.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#47362 - skabio - Fri Jul 08, 2005 3:09 am</h4>
    <div class="postbody"><span class="postbody">It appears that the new version of the movie player, M3, is about to be released.
<br/>
<br/>
<a href="http://www.m3adapter.com/" target="_blank">http://www.m3adapter.com/</a>
<br/>
<br/>
It looks like it now supports full gba and nds games and emulators as well as saving.  There are now apparently separate versions for the gba and nds.  No sign of how much they will cost however.
<br/>
<br/>
?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#47389 - chishm - Fri Jul 08, 2005 2:38 pm</h4>
    <div class="postbody"><span class="postbody">Okay, after some more testing, it seems that the GBAMP firmware is more sensitive to changes to the boot cluster than I thought. Replacing the boot cluster with custom code, even if it emulates the firmware, does not work. Trying to jump immediately after the GBAMP jumps to the loading code does not work. 
<br/>
I have managed to insert my own code. To do this I insert my code at offset 0x3CA0. Then I change the BX at 0x023C to a B to my code. Once the code is finished running I then BX to 0x03000000. 
<br/>
Problems:
<br/>
This limits the custom code to 0x360 bytes in size, much smaller than originally hoped, but still bigger than before. It also could create problems when running in DS mode. I cannot test this as I don't have a pass through, but the more code executed that was meant for the GBA, the more likely it is to freeze.
<br/>
Benefits:
<br/>
You can still use the GBAMP for its original purpose. It is also completely compatible with the updates. Also, depending on the code, this may be the only time a hack needs to be applied, as it can load the rest from the CF card.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#47581 - chishm - Mon Jul 11, 2005 1:05 am</h4>
    <div class="postbody"><span class="postbody">Okay, I have written my own bootloader. It will run _BOOT_MP.GBA from the root directory. If the file is not found then it runs the normal firmware. _BOOT_MP.GBA is simply a multiboot compatible rom. I have used it with TOD (great game), PocketNES and some custom code. I have not been able to test it in DS mode (see above post) but it won't work anyway, as it is using the GBA IWRAM. 
<br/>
<br/>
Quick question:
<br/>
1) What is the easiest way to detect if it is running in DS mode?
<br/>
2) What happens if I try to use the GBA IWRAM address (0x0300:0000) in DS mode?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#47583 - tepples - Mon Jul 11, 2005 1:31 am</h4>
    <div class="postbody"><span class="postbody">REG_VCOUNT will go from 0 to 228 in GBA mode or 0 to 262 in Nintendo DS mode.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#47589 - chishm - Mon Jul 11, 2005 3:48 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tepples wrote:</b></span></td> </tr> <tr> <td class="quote">REG_VCOUNT will go from 0 to 228 in GBA mode or 0 to 262 in Nintendo DS mode.</td> </tr></table><span class="postbody">
<br/>
Unfortunately that would require me to monitor REG_VCOUNT to check its values, or use an interupt to check it. I was wanting something like a memory address that has one definite value on the GBA and another on the DS. 
<br/>
EDIT: Now posted in DS forum.
<br/>
<br/>
I have also managed to hijack the GBAMP bootloader ealier on. Now it will jump to my code right after loading it. This should increase the compatibility with DS mode, as less code is executed.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#48048 - dovoto - Sat Jul 16, 2005 5:05 pm</h4>
    <div class="postbody"><span class="postbody">I just ordered my gbaMP and would like to encorperate this fat code into libnds.  I would also like to get it up and running for booting nds files with some form of multiboot loader. 
<br/>
<br/>
 Could someone explain the general process required to reflash the firmware and to modify it for my own purposes (including what ever links are appropriate)
<br/>
<br/>
...Idealy I would like to use Chishms but with a slight modification that it boot _BOOT_MP.gba or _BOOT_MP.ds depending on the mode it detects. (I assume this is also Chishms goal).  It should not be too difficult to detect DS mode and if you have not allready found a simple enough way then i can look into it.
<br/>
<br/>
I am basicaly going to use this device for testing in hopes of developing my own SD based equivalent that will include natriums serial port.  Hopefully everything will fit flush inside the the gba cart as apposed to hanging out like the MP.<br/>_________________<br/><a href="http://www.drunkencoders.com" target="_blank">www.drunkencoders.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#48074 - darkfader - Sun Jul 17, 2005 12:19 am</h4>
    <div class="postbody"><span class="postbody">:(</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#48075 - dovoto - Sun Jul 17, 2005 12:21 am</h4>
    <div class="postbody"><span class="postbody">darkfader if you have a more interesing idea for getting access to CF than putting the code in ndslib please let me know...I am pretty lazy when it comes down to it so if prevents me from having to import and test the source code I am all for it.<br/>_________________<br/><a href="http://www.drunkencoders.com" target="_blank">www.drunkencoders.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#48079 - darkfader - Sun Jul 17, 2005 12:41 am</h4>
    <div class="postbody"><span class="postbody">Ideally, I would like to put the system calls on the movie player itself. I think I have some generic way to make the system call stub. It would be nice if it worked for both gba and nds libs.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#48080 - dovoto - Sun Jul 17, 2005 1:02 am</h4>
    <div class="postbody"><span class="postbody">hmm...a generic method would be nice although i am not sure exactly how you would go about implementing it with the code on the CF firmware. Would this aid us in getting generic file access so we can use fopen("wifi:/dir/file.txt", "w")    and
<br/>
fopen("gbamp:/dir/file.blah", "r") and
<br/>
fopen("nds:/dir/blah.blah", "wb") ...
<br/>
<br/>
?<br/>_________________<br/><a href="http://www.drunkencoders.com" target="_blank">www.drunkencoders.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#48081 - chishm - Sun Jul 17, 2005 1:10 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>dovoto wrote:</b></span></td> </tr> <tr> <td class="quote">I just ordered my gbaMP and would like to encorperate this fat code into libnds.  I would also like to get it up and running for booting nds files with some form of multiboot loader. 
<br/>
<br/>
 Could someone explain the general process required to reflash the firmware and to modify it for my own purposes (including what ever links are appropriate)
<br/>
<br/>
...Idealy I would like to use Chishms but with a slight modification that it boot _BOOT_MP.gba or _BOOT_MP.ds depending on the mode it detects. (I assume this is also Chishms goal).  It should not be too difficult to detect DS mode and if you have not allready found a simple enough way then i can look into it.
<br/>
<br/>
I am basicaly going to use this device for testing in hopes of developing my own SD based equivalent that will include natriums serial port.  Hopefully everything will fit flush inside the the gba cart as apposed to hanging out like the MP.</td> </tr></table><span class="postbody">
<br/>
To flash the GBAMP firmware, you will need Darkfader's flashing tool. It is in the tools section of the DevKitPro CVS, under Tools\nds\bootstrap\flashmp. 
<br/>
<br/>
My firmware is already doing that, but it has a few bugs that need to be fixed. The FAT code still has a few bugs, but you can add it to libnds. However, it would probably better to add it as a separate part of DevKitPro, because it is for both NDS and GBA roms.
<br/>
<br/>
I have worked out how to detect DS mode, with the help of tepples. It is based on the principle that the byte at 0A00:0000 will be different depending on whether it is in NDS or GBA mode. This requires that there is no SRAM on the cart.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#48082 - dovoto - Sun Jul 17, 2005 1:14 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>chishm wrote:</b></span></td> </tr> <tr> <td class="quote">To flash the GBAMP firmware, you will need Darkfader's flashing tool. It is in the tools section of the DevKitPro CVS, under Tools\nds\bootstrap\flashmp.</td> </tr></table><span class="postbody">
<br/>
<br/>
Thanks :) 
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>chishm wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
My firmware is already doing that, but it has a few bugs that need to be fixed. The FAT code still has a few bugs, but you can add it to libnds. However, it would probably better to add it as a separate part of DevKitPro, because it is for both NDS and GBA roms. </td> </tr></table><span class="postbody">
<br/>
<br/>
This sounds good to me although not sure if this is the same thing as DarkFader was suggesting.  Would be nice to see a few smaller libraries pop up for general utility.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>chishm wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
I have worked out how to detect DS mode, with the help of tepples. It is based on the principle that the byte at 0A00:0000 will be different depending on whether it is in NDS or GBA mode. This requires that there is no SRAM on the cart.</td> </tr></table><span class="postbody">
<br/>
<br/>
Nice<br/>_________________<br/><a href="http://www.drunkencoders.com" target="_blank">www.drunkencoders.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#48086 - darkfader - Sun Jul 17, 2005 1:38 am</h4>
    <div class="postbody"><span class="postbody">It's not the same thing.
<br/>
<br/>
Bah. I can't seem to be able to unlock the flash somehow. Although it works in my flasher :(</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#48089 - chishm - Sun Jul 17, 2005 2:46 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>darkfader wrote:</b></span></td> </tr> <tr> <td class="quote">It's not the same thing.
<br/>
<br/>
Bah. I can't seem to be able to unlock the flash somehow. Although it works in my flasher :(</td> </tr></table><span class="postbody">
<br/>
How exactly are you trying to unlock it? From the firmware itself, or from a multiboot binary loaded with the GBAMP sitting idle in the slot? 
<br/>
<br/>
I am having troubles with my firmware hack. It consistently works using WifiMe, but doesn't work with FlashMe. It also only seems to work with homebrew software, not commercial demos.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#48100 - darkfader - Sun Jul 17, 2005 4:19 am</h4>
    <div class="postbody"><span class="postbody">Oh... I now edited 3 words like you said and added some code to go to GBA mode @ 08000200 and it worked :)
<br/>
Guess it cannot be unlocked even with that long unlocking sequence after it has been locked by a wrong reading order.
<br/>
<br/>
@dovoto:
<br/>
What do you think about linux-style path? Using /mnt/ for stuff :)
<br/>
/mnt/ndssave/
<br/>
/mnt/gbasave/
<br/>
/mnt/save/  (auto link to either nds- or gbasave)
<br/>
/mnt/nds/    (nds file system)
<br/>
/mnt/mp/    (media player, CF/SD...  normally mounted as root)
<br/>
/mnt/mpflash/   (rom file system)
<br/>
Perhaps not as flexible and might clutter the tree... hmm... or perhaps an option to make them hidden :)
<br/>
I'll think about it some more after I got something working at least...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#48103 - tepples - Sun Jul 17, 2005 5:00 am</h4>
    <div class="postbody"><span class="postbody">A better syntax for wifi (once someone disassembles SM64DS) would be fopen("http://host/dir/file.txt", "r"), no?<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#48107 - chishm - Sun Jul 17, 2005 5:24 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tepples wrote:</b></span></td> </tr> <tr> <td class="quote">A better syntax for wifi (once someone disassembles SM64DS) would be fopen("http://host/dir/file.txt", "r"), no?</td> </tr></table><span class="postbody">
<br/>
Should that be "wftp://host/dir/file.txt"?
<br/>
http = hypertext transport protocol
<br/>
wftp = wi fi transfer protocol or wireless file transfer protocol
<br/>
<br/>
Maybe we could just use UNC for everything, with each nds assigned a unique name. This could be confusing, but I'm just thinking what the best method would be.
<br/>
<br/>
Ideally, all file drivers (GBFS, GBAMP FAT, NDS) would use the same naming convention, for files and functions, so that it is easy to switch between them.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#48108 - tepples - Sun Jul 17, 2005 5:28 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>chishm wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tepples wrote:</b></span></td> </tr> <tr> <td class="quote">A better syntax for wifi (once someone disassembles SM64DS) would be fopen("http://host/dir/file.txt", "r"), no?</td> </tr></table><span class="postbody">
<br/>
Should that be "wftp://host/dir/file.txt"?
<br/>
http = hypertext transport protocol
<br/>
wftp = wi fi transfer protocol or wireless file transfer protocol</span></td> </tr></table><span class="postbody">
<br/>
Wouldn't FTP over TCP/IP over Wi-Fi just be FTP over TCP/IP over Wi-Fi?
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Maybe we could just use UNC for everything, with each nds assigned a unique name. This could be confusing, but I'm just thinking what the best method would be.</td> </tr></table><span class="postbody">
<br/>
<a class="postlink" href="http://us5.samba.org/samba/" target="_blank">Super Mario Brothers Protocol</a>?<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#48110 - chishm - Sun Jul 17, 2005 6:02 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tepples wrote:</b></span></td> </tr> <tr> <td class="quote">Wouldn't FTP over TCP/IP over Wi-Fi just be FTP over TCP/IP over Wi-Fi?</td> </tr></table><span class="postbody">
<br/>
It wouldn't necessarily be <a href="http://FTP." target="_blank">FTP.</a> It may end up being a custom protocol with a server running on the PC. However, it would probably be better just to use FTP, for compatibility.
<br/>
<br/>
On the other hand, the protocol should not need to be specified. Depending on the host being accessed, the driver would choose the protocol invisibly to the caller.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#48112 - tepples - Sun Jul 17, 2005 6:16 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>chishm wrote:</b></span></td> </tr> <tr> <td class="quote">On the other hand, the protocol should not need to be specified. Depending on the host being accessed, the driver would choose the protocol invisibly to the caller.</td> </tr></table><span class="postbody">
<br/>
That would work only if the hostname starts with "www" or "ftp" or the like. Or would it portscan the host, looking for HTTP then FTP then whatever? Or if I'm missing something fundamental, what am I missing?<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#48914 - chishm - Sun Jul 24, 2005 3:13 am</h4>
    <div class="postbody"><span class="postbody">Tepples:
<br/>
Well if it is accessing files within a game then it is always going to be <a href="http://ftp." target="_blank">ftp.</a> If it is browsing web pages then it is always going to be http. If it is accessing the CF card then it will always be file. Maybe the protocol should be optional, just in case the caller wants to access the file in a specific way.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#48916 - tepples - Sun Jul 24, 2005 4:39 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>chishm wrote:</b></span></td> </tr> <tr> <td class="quote">Well if it is accessing files within a game then it is always going to be ftp<span style="font-weight: bold"></span>. If it is browsing web pages then it is always going to be http.</td> </tr></table><span class="postbody">
<br/>
HTTP is in general a more efficient protocol than FTP, as FTP has much more setup and teardown per file. HTTP uses only one connection, unlike FTP which uses one connection for commands and another for each file transfer. Even for larger files, notice that most commercial sites that offer files for download offer them over HTTP rather than FTP<span style="font-weight: bold"></span>.
<br/>
<br/>
<a class="postlink" href="http://apache.slashdot.org/comments.pl?sid=156760&amp;cid=13141182" target="_blank">Here is a Slashdot thread debating the merits of HTTP and FTP</a>.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">If it is accessing the CF card then it will always be file.</td> </tr></table><span class="postbody">
<br/>
Granted, but the name 'file' is also associated with UNC paths to CIFS resources.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Maybe the protocol should be optional, just in case the caller wants to access the file in a specific way.</td> </tr></table><span class="postbody">
<br/>
Most files can be accessed <span style="font-style: italic">only</span> in a specific way. How would you suggest to guess the protocol given the rest of the URL?<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#48918 - dovoto - Sun Jul 24, 2005 4:49 am</h4>
    <div class="postbody"><span class="postbody">I would like to see explicit paths for the filesystem.<br/>_________________<br/><a href="http://www.drunkencoders.com" target="_blank">www.drunkencoders.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#48928 - chishm - Sun Jul 24, 2005 6:46 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tepples wrote:</b></span></td> </tr> <tr> <td class="quote">Most files can be accessed <span style="font-style: italic">only</span> in a specific way. How would you suggest to guess the protocol given the rest of the URL?</td> </tr></table><span class="postbody">
<br/>
If URLs are used for every file access, then accesses to the CF card could only be file, for instance. What I am saying, is that rather than having to explicitly specify the protocol for every file access, some (like the CF card) could be implicit in the URL.
<br/>
However, you make a good point, and explicit protocol specification is a lot better for reducing ambiguity, but less efficient. Say I wanted to access a specific file, but I don't know where it is. If the user of the program pointed to the location then rather than the program trying to figure out which protocol to use, the file driver could.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#49068 - binarystatic - Tue Jul 26, 2005 4:41 am</h4>
    <div class="postbody"><span class="postbody">im a noob when it comes to cvs, is there any easy way to download all associated files with the flashmp other than manually recursing through every directory and downloading each file one by one? or does anyone have a pre-compled version of flashmp?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#49076 - chishm - Tue Jul 26, 2005 6:41 am</h4>
    <div class="postbody"><span class="postbody">I will include an NDS version in the next release.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
