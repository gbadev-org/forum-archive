<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>How does DMA controller really work? - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>Hardware > How does DMA controller really work?</h2>
<div id="posts">
<div class="post">
    <h4>#493 - notron - Wed Jan 08, 2003 3:49 am</h4>
    <div class="postbody"><span class="postbody">Newbie here with another question. I have searched everywhere for the answer but haven't found it.
<br/>
<br/>
When using DMA mode ( channel 3, wait-for-vertical-sync, WITHOUT interrupts enabled), how does the GBA handle it. E.G. when I set the control register, does it suspend further code execution until the DMA is complete, or does it continue own executing code? If it is the later case, then how does the DMA controller interrupt code execution in order to take over the bus and complete the DMA operation?
<br/>
<br/>
I am testing this on the Boycott Advance and am getting some interesting effects ( very delayed completion of the DMA operation) and I am wondering if this is an artifact of the emulator or if this is really the way the GBA works?
<br/>
<br/>
If anyone knows where there is a detailed manual of the GBA,  I would love to get my hands on it. I have the GBATEK by Martin Korth but it doesn't go into this much detail on HW operation.<br/>_________________<br/>MysticX is The Defender</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#520 - ampz - Wed Jan 08, 2003 10:30 am</h4>
    <div class="postbody"><span class="postbody">DMA transfers halts the execution until completed.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#528 - imikeyi - Wed Jan 08, 2003 1:55 pm</h4>
    <div class="postbody"><span class="postbody">The "Cowbite Virtual Hardware Specifications" seems to be the most detailed reference for the GBA.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#536 - Splam - Wed Jan 08, 2003 3:04 pm</h4>
    <div class="postbody"><span class="postbody">The dma won't start until it hits a vsync (wait-for-vertical-sync set), then the dma starts, the processor will stop executing instructions until the dma transfer is complete.  Also remember the vblank period starts at line 160 not line 0 (which is a good thing because you've got all that time to process the dma b4 the screen is redrawn) but maybe you're expecting it to begin at 0 or even as soon as you trigger it?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#539 - Touchstone - Wed Jan 08, 2003 3:18 pm</h4>
    <div class="postbody"><span class="postbody">Are you sure that DMA transfers aren't executed until the vblank interrupt?<br/>_________________<br/>You can't beat our meat</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#540 - Splam - Wed Jan 08, 2003 4:23 pm</h4>
    <div class="postbody"><span class="postbody">Depends if you tell them to be or not.  You can choose to start now, next vblank,  next hblank or another one, damn forgot what that one is, something to do with the sound dma i think  hehe but notron said he'd set it to the vblank one.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#549 - notron - Wed Jan 08, 2003 6:28 pm</h4>
    <div class="postbody"><span class="postbody">Well, from all the comments I have come to the conclusion that what I am seeing is an artifact of the Boycott Advance emulator.  I am telling it to wait for the next VBLANK before starting the DMA, but I do NOT have interrupts enabled for the DMA.  In this case I expected the code execution to be halted at the point of setting the DMA control register and then waiting until VSync, then completing the DMA, then resuming execution of the code.  In actuality, it appears in my prorgram that the code continued to execute while the DMA controller was waiting for the next VSYNC and then it would halt execution of the code, complete the DMA and then resume execution of the code.  I suspect that the emulator is using a separate thread to emulate the DMA controller and that thread is running at the same W9x priority as the main code thread, thus it is having to wait for its w9x time slice before it can start checking and waiting for the Vsync. Since the main code thread was not immediately suspended when it set the DMA control register, it continued to execute until the end of its time-slice.
<br/>
<br/>
Of course, I can't be sure without looking at the code for the emulator, but from the appearance of my display, this appears to be what happened.
<br/>
<br/>
Thanks to everyone who contributed input.<br/>_________________<br/>MysticX is The Defender</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#635 - Splam - Thu Jan 09, 2003 7:42 am</h4>
    <div class="postbody"><span class="postbody">I'd suggest using VBOY instead, boycott is nowhere near as accurate (even with the new release).  Also you seem to have got the wrong idea about DMA interrupts,  they're triggered when a dma is finished, nothing to do with when they start, stupid most of the time I know because the processor is stopped anyway but it can be used in some cases (audio processing).
<br/>
<br/>
The settings you've got will set the dma into "wait for vsync" the processor will continue doing its thing, vsync happens, dma starts, dma finishes, precessor restarts..  If you had dma interrupt request turned ON it would TRIGGER an interrupt AFTER the dma completes,  nothing to do with when dma starts. :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#668 - notron - Thu Jan 09, 2003 4:34 pm</h4>
    <div class="postbody"><span class="postbody">Splam,
<br/>
<br/>
Thanks for the update. The issue was whether or not the processor kept on running after issuing the DMA "wait for sync". You answered that and now I know it keeps running until the vsync event halts it.  I didn't do a good job of explaining the interrupts thing, but I did know that the interrupt, if enabled, would be on completion of the DMA.  I was just noting that I did not have it enabled.
<br/>
<br/>
Thanks also for the tip on VBOY. I will check it out immediately. I was just using Boycott Advance based on recommendation from someone else.
<br/>
<br/>
Thanks again.<br/>_________________<br/>MysticX is The Defender</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#670 - Splam - Thu Jan 09, 2003 4:41 pm</h4>
    <div class="postbody"><span class="postbody">No problem,  forums aren't the best place to work out problems due to the time lag between asking, waiting for a reply, realising the reply isn't what you wanted  etc :)</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
