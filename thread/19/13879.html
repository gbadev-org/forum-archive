<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>EZ-V DLDI Driver with unaligned read - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS Flash Equipment > EZ-V DLDI Driver with unaligned read</h2>
<div id="posts">
<div class="post">
    <h4>#137028 - ps2aich - Tue Aug 07, 2007 2:34 pm</h4>
    <div class="postbody"><span class="postbody">Hi all,
<br/>
<br/>
I open an extra thread to not poison <a class="postlink" href="http://forum.gbadev.org/viewtopic.php?t=13856" target="_blank">New DLDI Tester - flash card report</a> thread: 
<br/>
<br/>
I was a little disappointed that EZ-V does not pass the read alignment
<br/>
test (since I recently bought one), so I modified the driver
<br/>
to allow this feature:
<br/>
<br/>
Before I upload the modified driver to the DLDI-Wiki, please could
<br/>
some EZ-V User test it (of course, it works for me, but you never know :-)): <a class="postlink" href="http://www.divshare.com/download/1493401-3a5" target="_blank">ez5s.zip</a>
<br/>
<br/>
<br/>
Reason for the failure was following code snippet:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">*((uint32 *)(&amp;ppbuf[i])) = CARD_DATA_RD;</td> </tr></table><span class="postbody">
<br/>
which I replaced by
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">temp = CARD_DATA_RD;
<br/>
temp1= CARD_DATA;
<br/>
ppbuf[i] = *p;
<br/>
ppbuf[i+1] = *(p+1);
<br/>
ppbuf[i+2] = *(p+2);
<br/>
ppbuf[i+3] = *(p+3);</td> </tr></table><span class="postbody">
<br/>
which was already as comment there.
<br/>
As result, the driver didn't fit anymore into 8k, so now it uses
<br/>
16k (should be no problem since for DLDI 32k are reserved
<br/>
nevertheless). If this would be an problem for anyone,
<br/>
I can try to spare some space by refactoring *p usage.
<br/>
<br/>
<span style="font-weight: bold">Edit 080801:</span>
<br/>
Somebody noticed, that on large block reads, the driver with the unaligned read feature was much slower than the former one. So I optimzed it again by testing for unalignment.
<br/>
The updated dldi can be found in the <a class="postlink" href="http://dldi.drunkencoders.com/index.php?title=EZ_Flash_5_%28SD_Card%29" target="_blank">DLDI Wiki</a>.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">// test if ppbuf is 4byte-aligned
<br/>
   if ((((uint32) ppbuf) &amp; 0x3) )
<br/>
   {
<br/>
      // ppbuf is non-aligned
<br/>
      do {
<br/>
         // Read data if available
<br/>
         if (CARD_CR2 &amp; CARD_DATA_READY) {
<br/>
            if (i&lt; target) 
<br/>
            {
<br/>
               temp = CARD_DATA_RD;
<br/>
               ppbuf[i] = *p;
<br/>
               ppbuf[i+1] = *(p+1);
<br/>
               ppbuf[i+2] = *(p+2);
<br/>
               ppbuf[i+3] = *(p+3);
<br/>
            }
<br/>
            i+=4;
<br/>
         }
<br/>
      } while (CARD_CR2 &amp; CARD_BUSY);
<br/>
   }
<br/>
   else
<br/>
   {
<br/>
      // ppbuf is aligned
<br/>
      do {
<br/>
         // Read data if available
<br/>
         if (CARD_CR2 &amp; CARD_DATA_READY) {
<br/>
            if (i&lt; target) 
<br/>
            {
<br/>
                *((uint32 *)(&amp;ppbuf[i])) = CARD_DATA_RD;
<br/>
            }
<br/>
            i+=4;
<br/>
         }
<br/>
      } while (CARD_CR2 &amp; CARD_BUSY);
<br/>
   }
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"><br/><br/>Last edited by ps2aich on Fri Aug 01, 2008 9:22 pm; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#137130 - Diddl - Wed Aug 08, 2007 8:19 am</h4>
    <div class="postbody"><span class="postbody">I will test it tonight (after work). thanks for your work!
<br/>
<br/>
<br/>
<br/>
[Edit] Sorry, I can't download this???</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#137240 - ps2aich - Thu Aug 09, 2007 9:24 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Diddl wrote:</b></span></td> </tr> <tr> <td class="quote">I will test it tonight (after work). thanks for your work!
<br/>
<br/>
<br/>
<br/>
[Edit] Sorry, I can't download this???</td> </tr></table><span class="postbody">
<br/>
<br/>
Hm, it works for me, and on the site, already a number of people
<br/>
have downloaded it.
<br/>
<br/>
I put it additionally on another file hoster: <a class="postlink" href="http://www.keepmyfile.com/download/e815c01794558" target="_blank">ez5s.zip</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#137262 - Diddl - Thu Aug 09, 2007 5:51 pm</h4>
    <div class="postbody"><span class="postbody">sorry, today the first link works also.
<br/>
<br/>
<br/>
very succesful!! dldi works very fine now. wolfenstein 3d works also now.
<br/>
<br/>
thanks for your work. could you send this to chishm for update dldi page?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#137279 - ps2aich - Thu Aug 09, 2007 8:51 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Diddl wrote:</b></span></td> </tr> <tr> <td class="quote">sorry, today the first link works also.
<br/>
<br/>
<br/>
very succesful!! dldi works very fine now. wolfenstein 3d works also now.
<br/>
<br/>
thanks for your work. could you send this to chishm for update dldi page?</td> </tr></table><span class="postbody">
<br/>
<br/>
Diddl, thanks for counter testing :-)
<br/>
<br/>
I updated the <a class="postlink" href="http://dldi.drunkencoders.com/index.php?title=EZ_Flash_5_%28SD_Card%29" target="_blank">EZ5 DLDI Page</a> in the DLDI Wiki now.
<br/>
(chishms page is not maintained anymore, the Wiki is the place to go :-))
<br/>
<br/>
Btw, this driver update also fixes the wrong dldi spec of the driver
<br/>
(it was accidently specified as Slot-2).
<br/>
<br/>
To Psychowood: I think you have still an ez5s_v2.dldi in your
<br/>
excellent tool <a class="postlink" href="http://dldi.drunkencoders.com/index.php?title=DLDI_Right_Click" target="_blank">DLDI Right Click</a> (I can recommend it to all EZ-V users, because
<br/>
it also does the Headerfix for homebrew, which is needed for the EZ-V) ,
<br/>
you can replace it by this new driver.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#137298 - dantheman - Fri Aug 10, 2007 12:14 am</h4>
    <div class="postbody"><span class="postbody">Since you have uploading capability, could you add the DLDI file for the MMP (since apparently the MMD file doesn't work for all MMP users)?
<br/>
<br/>
I posted it at <a href="http://forum.gbadev.org/viewtopic.php?t=12963&amp;start=30" target="_blank">http://forum.gbadev.org/viewtopic.php?t=12963&amp;start=30</a> though it appears nobody has uploaded it since then.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#137328 - ps2aich - Fri Aug 10, 2007 8:47 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>dantheman wrote:</b></span></td> </tr> <tr> <td class="quote">Since you have uploading capability, could you add the DLDI file for the MMP (since apparently the MMD file doesn't work for all MMP users)?
<br/>
<br/>
I posted it at <a href="http://forum.gbadev.org/viewtopic.php?t=12963&amp;start=30" target="_blank">http://forum.gbadev.org/viewtopic.php?t=12963&amp;start=30</a> though it appears nobody has uploaded it since then.</td> </tr></table><span class="postbody">
<br/>
<br/>
Hi dantheman,
<br/>
<br/>
since the DLDI Wiki is a 'Wiki', you could easily do it yourself
<br/>
(I suppose you have the ability to test this dldi driver).
<br/>
<br/>
Simply register at the wiki, and request upload rights
<br/>
at <a class="postlink" href="http://dldi.drunkencoders.com/index.php?title=DLDIWiki:Upload_rights_request" target="_blank">this page</a>
<br/>
<br/>
Than you can add a new slot-2 device and upload the driver.
<br/>
<br/>
I only would do it when absolutely no other can do it, since I have
<br/>
no ability to test it.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#137357 - dantheman - Fri Aug 10, 2007 8:15 pm</h4>
    <div class="postbody"><span class="postbody">Ah, I was wondering where the upload rights page was.  Well the problem is that I can't test it, as I don't have the device.  All I have is a few reports from people who couldn't get programs to work with the default MMD DLDI file but could with the MMP one here.  Ah well, I'll figure it out, thanks.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161348 - ps2aich - Fri Aug 01, 2008 9:27 pm</h4>
    <div class="postbody"><span class="postbody">Update: Speed improvement for aligned reads (see update in <a class="postlink" href="http://forum.gbadev.org/viewtopic.php?p=137028&amp;highlight=edit+080801#137028" target="_blank">first post</a>)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161586 - josath - Wed Aug 06, 2008 9:04 pm</h4>
    <div class="postbody"><span class="postbody">A further optimization would be if the buffer is unaligned, use 8-bit copies for just the few odd bytes at the beginning &amp; end, and 32-bit copies for all the bytes inbetween.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161634 - ps2aich - Fri Aug 08, 2008 2:48 pm</h4>
    <div class="postbody"><span class="postbody">Hm, you are right, but my assumption was, that unaligned reads are only happening in certain circumstances (e.g. calculating an address  in a buffer to load a texture) and not constantly.
<br/>
<br/>
But I will try it perhaps, since im currently optimizing further (ezteam published the ez5sdhc source code), so I currently had write speed a little bit optimized (better crc algorithm from ez5sdhc source, removing unneeded memcpy on aligned write buffer) and removed stack allocation of write buffer to a static allocated one (solved some problems with certain homebrew applications).</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
