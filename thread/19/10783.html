<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>compiling for DS slot carts - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS Flash Equipment > compiling for DS slot carts</h2>
<div id="posts">
<div class="post">
    <h4>#97939 - nl - Sat Aug 12, 2006 1:19 pm</h4>
    <div class="postbody"><span class="postbody">hello
<br/>
<br/>
<br/>
i'm developing with a DS-slot-only cart (UFP) and have difficulties running my programs. the *.nds files produced with devkitpro are not accepted by the burning program of UFP, it says the file is not a "clean ROM".
<br/>
<br/>
is there a way of compiling my code to such a "clean ROM"? though i read all related posts i found, it is still not quite clear to me what is the difference and if it's possible to put together a proper nds file.
<br/>
<br/>
the writer software accepts my *.nds file when using "menu mode", but then there will be an ugly menu from which i can start the program. also, i intend to access the flash chip (main program flash ROM, not EEPROM) from within my code, but the offsets may be wrong when starting from a menu.
<br/>
<br/>
thank you.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#97953 - Linkiboy - Sat Aug 12, 2006 2:48 pm</h4>
    <div class="postbody"><span class="postbody">UFP is intended to function as a Warez only device, you woud have to compile your game with the official Nintendo SDK to get it to work I assume.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#97954 - chishm - Sat Aug 12, 2006 3:03 pm</h4>
    <div class="postbody"><span class="postbody">When building the .nds file with ndstool, set the ARM9 binary offset to 0x8000 within the NDS file (not the start address). If the problem is caused by the flash card acting as a direct DS Card clone, then this may fix it (depending on how the flasher was written).<br/>_________________<br/><a class="postlink" href="http://chishm.drunkencoders.com" target="_blank">http://chishm.drunkencoders.com</a>
<br/>
<a class="postlink" href="http://dldi.drunkencoders.com" target="_blank">http://dldi.drunkencoders.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#97958 - nl - Sat Aug 12, 2006 3:52 pm</h4>
    <div class="postbody"><span class="postbody">thanks for the quick answers. i'll try the offset thing.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#97993 - nl - Sat Aug 12, 2006 6:39 pm</h4>
    <div class="postbody"><span class="postbody">just tried to change the offset (by adding -r9 0x8000 to ndstool parameters, is that right?), but with no effect.
<br/>
<br/>
when looking at the ufp_passme.nds that comes with the writer (the only clean rom i have), i found that this file starts right with the game name while the test.nds produced with ndstool has some extra 160 bytes before that. when i removed these 160 bytes, the ufp writer recognized my .nds file as "SRAM_V110   PASS01" and allowed to write it like a clean rom - but it still wouldn't start.
<br/>
<br/>
my guess/hope is that no special tools are required but just some padding to get the arm7 / arm9 binaries at the right offset after the first 160 bytes were removed.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#98001 - dXtr - Sat Aug 12, 2006 7:04 pm</h4>
    <div class="postbody"><span class="postbody">it mostly sounds like you have some kind of header problem for your program. but also make sure that the code your trying out doesn't expect to be run from the slot-2<br/>_________________<br/>go back to coding and stop screaming wolf :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#98002 - Mighty Max - Sat Aug 12, 2006 7:07 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>nl wrote:</b></span></td> </tr> <tr> <td class="quote">just tried to change the offset (by adding -r9 0x8000 to ndstool parameters, is that right?), but with no effect.
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
no. -r9 0x... sets the RAM address where it is copied to.
<br/>
<br/>
The ndstool has no extra option to set the rom offset. What you can however do is to create a header file manually (see <a href="http://www.bottledlight.com/ds/index.php/FileFormats/NDSFormat" target="_blank">http://www.bottledlight.com/ds/index.php/FileFormats/NDSFormat</a>) and use this with the option -h<br/>_________________<br/><a class="postlink" href="http://mightymax.org/gbamp_multiboot.html" target="_blank">GBAMP Multiboot</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#98048 - nl - Sat Aug 12, 2006 10:22 pm</h4>
    <div class="postbody"><span class="postbody">Thanks again.
<br/>
Ndstool seems to create most of the header data correctly but places them in different locations. For example, the game title does not appear at address 0x00 but at 0xA0. The next value I can identify is the ARM9 binary size which is correctly located at 0x2C. I assumed that the first 32 bytes are exchanged with those from offset 0xA0 while the rest is in the right place (binary sizes, checksums, etc) and exchanged these bytes.
<br/>
Ndstool sets the ARM9 source address to 0x200, so I padded it to offset 0x4000 and corrected the header entry. I did the same for the ARM7 binary (offset 0xc000) and finally created the new header checksum with ndstool. I am a little uncertain about the "execute addr" and "copy to addr" and tried different variations, using the default values (0x02000000) and adding 0x02000800 / 0x02000800 to the source address for arm9. For arm7 I left the default values (0x03800000).
<br/>
<br/>
The resulting files were all accepted by the UFP writer but the DS just said "no cart in DS slot".</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#98065 - Mighty Max - Sun Aug 13, 2006 12:06 am</h4>
    <div class="postbody"><span class="postbody">0x02000000 for execute&amp;ram address of homebrew is usually correct. (unless explicit changed)
<br/>
<br/>
Try to get the header off of an official demo and change the addresses as needed. This way you are sure you have the correct logo data etc.<br/>_________________<br/><a class="postlink" href="http://mightymax.org/gbamp_multiboot.html" target="_blank">GBAMP Multiboot</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#98107 - Scorpei - Sun Aug 13, 2006 8:46 am</h4>
    <div class="postbody"><span class="postbody">Doesn't it need to be encrypted (unless your DS is flashed)?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#98111 - Mighty Max - Sun Aug 13, 2006 9:14 am</h4>
    <div class="postbody"><span class="postbody">It is encrypted for the transfer card&lt;-&gt;ds. It is stored decrypted on the card.<br/>_________________<br/><a class="postlink" href="http://mightymax.org/gbamp_multiboot.html" target="_blank">GBAMP Multiboot</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#98135 - nl - Sun Aug 13, 2006 2:49 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Mighty Max wrote:</b></span></td> </tr> <tr> <td class="quote">0x02000000 for execute&amp;ram address of homebrew is usually correct. (unless explicit changed)</td> </tr></table><span class="postbody">
<br/>
<br/>
From the examples given in the header format documentation I guessed that the source address should be added to 0x02000000 plus 0x800 for the execute addr. Anyway, I tried all variations without success.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Mighty Max wrote:</b></span></td> </tr> <tr> <td class="quote">Try to get the header off of an official demo and change the addresses as needed. This way you are sure you have the correct logo data etc.</td> </tr></table><span class="postbody">
<br/>
<br/>
Wouldn't the CRCs be wrong when anything is changed? The header CRC can be corrected with ndstool, but what about "CRC16"? And wouldn't other data have to be altered too, like "unk addr", FAT info, etc?
<br/>
<br/>
<br/>
When I start the UFP with my nds file now, it freezes without showing the startup sceen. The upper screen is white and the lower one shows the health warning in very light grey. Is this a known behaviour that indicates a specific problem?
<br/>
<br/>
When the program is strarted from the UFP menu, only the ARM9 code seems to work.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#98138 - Mighty Max - Sun Aug 13, 2006 3:11 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>nl wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Mighty Max wrote:</b></span></td> </tr> <tr> <td class="quote">0x02000000 for execute&amp;ram address of homebrew is usually correct. (unless explicit changed)</td> </tr></table><span class="postbody">
<br/>
<br/>
From the examples given in the header format documentation I guessed that the source address should be added to 0x02000000 plus 0x800 for the execute addr. Anyway, I tried all variations without success.
<br/>
</span></td> </tr></table><span class="postbody">
<br/>
<br/>
0x02000000 entry point is for homebrew use. The crt0 of devkitArm is simply put at the very start of the bins.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Mighty Max wrote:</b></span></td> </tr> <tr> <td class="quote">Try to get the header off of an official demo and change the addresses as needed. This way you are sure you have the correct logo data etc.</td> </tr></table><span class="postbody">
<br/>
<br/>
Wouldn't the CRCs be wrong when anything is changed? The header CRC can be corrected with ndstool, but what about "CRC16"? And wouldn't other data have to be altered too, like "unk addr", FAT info, etc?
<br/>
<br/>
</span></td> </tr></table><span class="postbody">
<br/>
Indeed, forgot about the Secure CRC16. However if the Secure area is zeroed out (0x4000-0x8000) shouldn't this CRC be easy to fill?
<br/>
<br/>
My personal view on unk addr7/9 is, that they point to the end of the crt0 code for the binaries. Their content is not of any interest for homebrew and should stay what they are.
<br/>
<br/>
<br/>
<br/>
But i can't be much more helpfull, the MFP is pretty new, and actually you are the first i hear of, who tries to run homebrew on it.<br/>_________________<br/><a class="postlink" href="http://mightymax.org/gbamp_multiboot.html" target="_blank">GBAMP Multiboot</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#98166 - nl - Sun Aug 13, 2006 7:54 pm</h4>
    <div class="postbody"><span class="postbody">OK, it works now. Thanks a lot for the help again.
<br/>
<br/>
I'll identify the unnecessary steps in my procedure (I tried many things and I'm not sure which ones finally lead to success) and provide a little program or maybe just a batch file or modify ndstool if the source is available.
<br/>
Basically, the ARM binaries both need to be 8 kb (or 16?) aligned and the apropriate values have to be set in the header (offsets, ROM size, header size), the rest was taken from the UFP passme ROM. Then the header has to be re-sorted (game name on beginning) and finally CRCs have to be re-calculated.
<br/>
<br/>
It's nice to have a single little cart for the DS slot and start my program right away, especially for demonstration and giving copies away. The UFP has a hole in the plastic case where a chip slightly sticks out, covered only by the sticker label. However, it fits well into the slot and I guess future hardware revisions will have no parts sticking out (I think it was ther very first generation of the first standalone DS-slot flashcart, so we can expect improvements in the future).</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#98170 - Mighty Max - Sun Aug 13, 2006 8:18 pm</h4>
    <div class="postbody"><span class="postbody">Could you do me a favor and do a little review / howto?
<br/>
<br/>
I'm planning to get a DS-Slot solution too, but there are nearly no info about these atm to decide uppon.<br/>_________________<br/><a class="postlink" href="http://mightymax.org/gbamp_multiboot.html" target="_blank">GBAMP Multiboot</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#98191 - nl - Sun Aug 13, 2006 11:56 pm</h4>
    <div class="postbody"><span class="postbody">i don't know too much about these too. the two currently available solutions (UltraFlashPass and Ninjapass DS Flash Jr.) are said to be clones of the same hardware or even from the same factory. both suppliers claim their product to be the first real DS flash cart.
<br/>
<br/>
the size is 512 mbit - little for games but plenty for homebrew. i haven't tested too many files with it, actually got it solely for programming. an official demo worked when started from the menu but not without menu. generally it seems less picky when using the menu, i guess files are patched then while direct boot requires clean ROMs. some sources say that files are always patched by the writer, but my guess is that the UFP actually acts like a normal DS cart when in single-ROM, non-menu mode.
<br/>
<br/>
writing times are said to be extremely slow, it can take hours to fill the entire 512 mbit. however, my small test program was written within a few seconds.
<br/>
<br/>
as mentioned by dXtr, there may be problems with homebrew programs which think they are running from the GBA slow and try to access it.
<br/>
<br/>
i already opened the cartridge and found an unnamed chip (the one that's sticking out, probably an FPGA), a flash chip and two eeproms. i guess the menu software copies the content of the smaller eeprom (ST M95040, 4 Kbit), which acts like a standard DS cart eeprom, to the bigger one (ST M45PE20, 2Mbit), so it can remember different saves for different games. i am very interested in the main flash chip and hope i can write it from within my code. it is labeled "4455LLYBQ2", i don't know what that stands for, all i found it is that it seems to be intel. once i know how to read/write the DS slot, i may read the ID via standard commands.
<br/>
<br/>
<br/>
my conclusion on UFP is that it is relatively useless for piracy due to small memory and slow writing, but it's great to have my homebrew program  on a single cart, just like a commercial game (only that chip sticking out and slightly lifting up the label makes it look not quite professional). if we find out how to access both eeproms or even the main flash, it has just everything you need.
<br/>
<br/>
<br/>
i'm not quite sure what you mean by "review / howto", if you have furhter questions, please feel free to ask.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#98245 - JaJa - Mon Aug 14, 2006 9:45 am</h4>
    <div class="postbody"><span class="postbody">Useless for piracy?
<br/>
There are very few games that are 1024Mbit, with many seeming to be around 256Mbit or 512Mbit. Remember they can be trimmed too.
<br/>
That means that this device can run nearly all roms, and it seems that it does so fairly easily.
<br/>
<br/>
It probably has a 4kbit EEPROM and a 2Mbit chip for different save types/sizes?<br/>_________________<br/>LAWL HOOGE
<br/>
<a class="postlink" href="http://www.pageofrandom.wordpress.com/" target="_blank">My Blog</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#98253 - nl - Mon Aug 14, 2006 10:39 am</h4>
    <div class="postbody"><span class="postbody">of course the UFP can be used for piracy, that's what it's made for. but you can put only one or two games on the cart and writing is very slow, so that you can't just swap them. i am not familiar with piracy, but i guess those who do it want to have as many games as possible. people who collect mp3s or crcked software usally count their possesion in gigabytes - no matter what crappy music in which lousy encoding or what useless software it is.
<br/>
so for those who want to be the cool warez dude (the target audience of UFP i'd say), it is not so useful because you can't show off your huge collection of ripped ROMs.
<br/>
<br/>
when starting a game from the menu, it first says "copying save data", that's why i assumed one eeprom is used as backup for the other one. but i may be wrong.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#98255 - JaJa - Mon Aug 14, 2006 10:48 am</h4>
    <div class="postbody"><span class="postbody">Interesting.
<br/>
But some game saves are 2Mbit (Nintendogs for example), so it couldn't copy that to the 4kbit chip.
<br/>
<br/>
If it can only hold one or two games at a time though, I suppose it doesn't matter.
<br/>
<br/>
However, you've done a good job at getting homebrew to run on that device.
<br/>
Have you tried getting exisiting homebrew to run?<br/>_________________<br/>LAWL HOOGE
<br/>
<a class="postlink" href="http://www.pageofrandom.wordpress.com/" target="_blank">My Blog</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#98258 - nl - Mon Aug 14, 2006 11:10 am</h4>
    <div class="postbody"><span class="postbody">so i'm probably wrong about the eeprom usage.
<br/>
<br/>
<br/>
i haven't tried existing homebrew yet, only some example code from devkitpro.
<br/>
<br/>
i have written a little tool that puts together a valid clean rom .nds file from the arm7 / arm9 binaries and the UFP ROM header, it should be easy to modify it so that it extracts the binaries from an existing nds file generated with devkit/ndstool.
<br/>
<br/>
it should be no problem to get existing programs to run, unless they try to access a GBA cart.
<br/>
<br/>
currently the tool only works with my local setup (hardcoded filenames, etc), i'll make it available when this is solved. i'm glad i can contribute somthing useful to the development community though i just started :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#98347 - Scorpei - Mon Aug 14, 2006 8:44 pm</h4>
    <div class="postbody"><span class="postbody">What about running homebrew with the DSlink?
<br/>
Normal .nds homebrew (or modified with your new tool :P) should work right, and possibly FAT lib homebrew if a supporting FAT lib would be written?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#112434 - jonnyhilly - Sat Dec 16, 2006 10:30 am</h4>
    <div class="postbody"><span class="postbody">Hi, is there any update on this topic ?
<br/>
I just got a Ninjapass, and am now dismayed to discover I cant do home brew on it
<br/>
<br/>
also does a rom need to be setup differently (header etc..) if its going to be used in 2 ways... both downloaded via wifi and put onto a DS cart.
<br/>
<br/>
<br/>
thanks
<br/>
Jon</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#112495 - mastertop101 - Sat Dec 16, 2006 11:36 pm</h4>
    <div class="postbody"><span class="postbody">Try this and please say me if it works :
<br/>
<a href="http://rapidshare.com/files/7710105/Ninja_X9_Rom_Tool.zip.html" target="_blank">http://rapidshare.com/files/7710105/Ninja_X9_Rom_Tool.zip.html</a>
<br/>
just drag and drop .nds on the .bat file and use OUTPUTX9.nds instead..</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#112500 - jonnyhilly - Sun Dec 17, 2006 12:15 am</h4>
    <div class="postbody"><span class="postbody">OK, I tried it with the hello_world.nds
<br/>
that comes with devkitpro,
<br/>
I got an error window popup,
<br/>
<br/>
that is labelled: Project1
<br/>
with erroe message...
<br/>
Run-time error '5'
<br/>
Invalid procedure call or argument
<br/>
<br/>
<br/>
I ran it by clicking on the bottom button "homebrew no fat patch (BETA Test)", then selecting the .nds file in the file selector window.
<br/>
<br/>
I have Win XP
<br/>
<br/>
Let me know if you want me to try anything else</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#112502 - jonnyhilly - Sun Dec 17, 2006 12:43 am</h4>
    <div class="postbody"><span class="postbody">also tried with a few other sample .nds files with the same result.
<br/>
<br/>
the tool looks promising, hope you can get it to all work</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#112531 - bobmcbob - Sun Dec 17, 2006 5:25 pm</h4>
    <div class="postbody"><span class="postbody">Please try the orignal tool for the Ninjapass X9 if your still having trouble with the GUI version.
<br/>
<br/>
Tool located here : <a href="http://tapper.bucklehost.co.uk/x9/x9hbloader-0.1.zip" target="_blank">http://tapper.bucklehost.co.uk/x9/x9hbloader-0.1.zip</a>
<br/>
<br/>
Be sure to read the readme file.
<br/>
For updates etc see the ninjapass forum.  Its quite active at  the moment.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#112568 - jonnyhilly - Sun Dec 17, 2006 11:17 pm</h4>
    <div class="postbody"><span class="postbody">Thanks bob
<br/>
that worked for the hello_world.nds that comes with DevKitPro
<br/>
thanks for the link
<br/>
<br/>
Interestingly, it spat out an error, saying "test build will seg fault"
<br/>
Though it still ran.... perhaps this will be an issue with more complex example code.
<br/>
I'll try some other examples later
<br/>
<br/>
Thanks again
<br/>
<br/>
I made a quick batch file that makes things easier to test, instead of typing in the command line stuff. So anyone else trying this out... just make a text file called "PATCH IT.bat" and paste the following into it...
<br/>
<br/>
del patch.bin
<br/>
copy bootloader.bin patch.bin
<br/>
copy test.nds patched.nds
<br/>
patcher.exe test.nds patched.nds
<br/>
del patch.bin
<br/>
pause
<br/>
<br/>
This will turn your test.nds into a patched.nds, and keep the folder clean.
<br/>
Just double click "PATCH IT.bat" after copying your test.nds into the same folder as the patcher.exe
<br/>
<br/>
You should also be able to add this as a post build step when compiling. Though I havn't tried that yet... not sure how to do it with DevKitPro</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#112575 - bobmcbob - Mon Dec 18, 2006 1:24 am</h4>
    <div class="postbody"><span class="postbody">yeh its just a warning the stuff about seg fault because there is no error checking.  That build was purely proof of concept.
<br/>
<br/>
Some stuff works and some stuff doesnt.  
<br/>
<br/>
There is a better way to work if you are compiling your own stuff from scratch.  Il post all my x9 stuff at some point tomorow.
<br/>
<br/>
Glad the tool works for you.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
