<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>GBA Cartridge Header and GBA System Control - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>DS Flash Equipment > GBA Cartridge Header and GBA System Control</h2>
<div id="posts">
<div class="post">
    <h4>#160835 - guybye - Wed Jul 23, 2008 8:47 am</h4>
    <div class="postbody"><span class="postbody">I've read at <a href="http://nocash.emubase.de/gbatek.htm#gbasystemcontrol" target="_blank">http://nocash.emubase.de/gbatek.htm#gbasystemcontrol</a> that there should be a GBA Cartridge Header. So as far as I understand the header is actually a part of the data that is in the cart. So, if I am downloading a bin file to a flash cart who takes care of this header?
<br/>
<br/>
At the GBA System Control section it is said that the wait state parameters are set. BY WHOM? 
<br/>
How do I access these registers? 
<br/>
Is there an automatic subroutine that read this data from the cart (by the NDS)? 
<br/>
If I am using a slow home made flash-cart how do I configure the NDS for the right wait-state??
<br/>
<br/>
Hope someone knows the answers....
<br/>
<br/>
So, thanks ahead
<br/>
Guy</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#160836 - eKid - Wed Jul 23, 2008 9:19 am</h4>
    <div class="postbody"><span class="postbody">The GBA header is prefixed to all GBA game binaries, it contains data necessary to boot the game (entry points, checksums, etc). I don't think you need a header if you're just using the cart for data.
<br/>
<br/>
The wait states for the gba slot can be changed on the DS with the EXMEMCNT register (same address as GBA's WAITCNT)
<br/>
<a href="http://nocash.emubase.de/gbatek.htm#dsmemorycontrolcartridgesandmainram" target="_blank">http://nocash.emubase.de/gbatek.htm#dsmemorycontrolcartridgesandmainram</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#160844 - guybye - Wed Jul 23, 2008 12:22 pm</h4>
    <div class="postbody"><span class="postbody">OK, But if I am using my home made flash cart with has its own latency- someone need to tell NDS that information? who is gonna do that?
<br/>
<br/>
btw how do i write to the EXMEMCNT  what is the C functoin that does it?
<br/>
I am a hardware man --&gt; so some C refernce can do no harm.
<br/>
<br/>
Thanks,
<br/>
           Guy</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#160846 - eKid - Wed Jul 23, 2008 2:10 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>guybuy wrote:</b></span></td> </tr> <tr> <td class="quote">OK, But if I am using my home made flash cart with has its own latency- someone need to tell NDS that information? who is gonna do that?</td> </tr></table><span class="postbody">
<br/>
Aren't you, the cartbuilder, supposed to know those things? :P
<br/>
You could maybe test some data reads from the cart on the DS with decreasing waitstates and see when the data goes wrong. :)
<br/>
<br/>
To set the cart waitstates in C (using libnds):
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#include &lt;nds.h&gt;
<br/>
<br/>
// wSRAM = SRAM access time (0-3 = 10, 8, 6, 18 cycles)
<br/>
// wN = ROM 1st access time (nonsequential) (0-3 = 10, 8, 6, 18 cycles)
<br/>
// wS = ROM 2nd access time (sequential) (0-1 = 6, 4 cycles)
<br/>
// PHI = PHI-pin out (0-3 = Low, 4.19MHz, 8.38MHz, 16.76MHz)
<br/>
// [no idea what PHI-pin out is]
<br/>
<br/>
void SetGBATiming( int wSRAM, int wN, int wS, int PHI )
<br/>
{
<br/>
    // mask other bits into a variable
<br/>
    u32 memcnt = REG_EXMEMCNT &amp; 0xFF80;
<br/>
    
<br/>
    // add new waitstate settings
<br/>
    memcnt |= wSRAM | (wN &lt;&lt; 2) | (wS &lt;&lt; 4) | (PHI &lt;&lt; 5);
<br/>
<br/>
    // set wait control
<br/>
    REG_EXMEMCNT = memcnt;
<br/>
}
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#160897 - tepples - Thu Jul 24, 2008 4:34 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>guybye wrote:</b></span></td> </tr> <tr> <td class="quote">OK, But if I am using my home made flash cart with has its own latency- someone need to tell NDS that information? who is gonna do that?</td> </tr></table><span class="postbody">
<br/>
Your card will boot up in 4,2 wait state. Commercial games change it to 3,1 soon after they start.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#160902 - eKid - Thu Jul 24, 2008 5:02 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tepples wrote:</b></span></td> </tr> <tr> <td class="quote">Your card will boot up in 4,2 wait state. Commercial games change it to 3,1 soon after they start.</td> </tr></table><span class="postbody">
<br/>
Note that the DS seems to have different waitstate settings than a GBA.
<br/>
<br/>
edit: err, maybe not, gbatek specifies WAITCNT measurements in waitstates and EXMEMCNT in actual access time.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#160907 - guybye - Thu Jul 24, 2008 12:53 pm</h4>
    <div class="postbody"><span class="postbody">I am tring to develop a flash card based on a data flash (32GB). It is a quite slow flash so i want to use N,S = 8,2. So the command to change from 4,2 to 8,2 is stored in the flash.... the GBA/NDS will not be able to read this data since it access the cart with higher speed (4,2). What can I do? 
<br/>
10x 
<br/>
<br/>
Guy</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#160910 - eKid - Thu Jul 24, 2008 1:05 pm</h4>
    <div class="postbody"><span class="postbody">Sounds like a problem... Not really sure if there is a solution besides using custom code before starting the cart's program..
<br/>
<br/>
Do you want 8,2 16mhz cycles or 33mhz cycles?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#160970 - tepples - Fri Jul 25, 2008 12:51 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>guybye wrote:</b></span></td> </tr> <tr> <td class="quote">I am tring to develop a flash card based on a data flash (32GB). It is a quite slow flash so i want to use N,S = 8,2. So the command to change from 4,2 to 8,2 is stored in the flash.... the GBA/NDS will not be able to read this data since it access the cart with higher speed (4,2). What can I do?</td> </tr></table><span class="postbody">
<br/>
"Data flash" is often NAND, especially in those sizes. Some commercial GBA flash cards, such as EFA II, use a hybrid NAND/NOR setup: the card's menu and the running game are stored in a fast 256 Mbit NOR flash, and the user can copy a game from the NAND to the NOR from within the card's menu. The EZFlash V works the same way: the user copies a GBA game from NAND in SLOT-1 to fast NOR flash on the 3-in-1 expansion in SLOT-2 using a program that runs on the DS.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
