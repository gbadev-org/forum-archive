<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Sprites problem... - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>Patater's Introduction to Nintendo DS Programming > Sprites problem...</h2>
<div id="posts">
<div class="post">
    <h4>#170376 - Nanashi - Sun Sep 20, 2009 7:45 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#include &lt;nds.h&gt;
<br/>
<br/>
#include "starField.h"
<br/>
#include "splash.h"
<br/>
#include "man.h"
<br/>
#include "woman.h"
<br/>
<br/>
#define FRAMES_PER_ANIMATION 3
<br/>
<br/>
/* Select a low priority DMA channel to perform our background copying. */
<br/>
static const int DMA_CHANNEL = 3;
<br/>
<br/>
void initVideo() {
<br/>
    /*
<br/>
     *  Map VRAM to display a background on the main and sub screens.
<br/>
     * 
<br/>
     *  The vramSetMainBanks function takes four arguments, one for each of the
<br/>
     *  major VRAM banks. We can use it as shorthand for assigning values to
<br/>
     *  each of the VRAM bank's control registers.
<br/>
     *
<br/>
     *  We map banks A and B to main screen  background memory. This gives us
<br/>
     *  256KB, which is a healthy amount for 16-bit graphics.
<br/>
     *
<br/>
     *  We map bank C to sub screen background memory.
<br/>
     *
<br/>
     *  We map bank D to LCD. This setting is generally used for when we aren't
<br/>
     *  using a particular bank.
<br/>
     */
<br/>
    vramSetMainBanks(VRAM_A_MAIN_BG_0x06000000,
<br/>
                     VRAM_B_MAIN_BG_0x06020000,
<br/>
                     VRAM_C_SUB_BG_0x06200000,
<br/>
                     VRAM_D_LCD);
<br/>
   vramSetBankE(VRAM_E_MAIN_SPRITE);
<br/>
   vramSetBankF(VRAM_F_MAIN_SPRITE);
<br/>
   
<br/>
<br/>
    /*  Set the video mode on the main screen. */
<br/>
    videoSetMode(MODE_5_2D | // Set the graphics mode to Mode 5
<br/>
                 DISPLAY_BG2_ACTIVE | // Enable BG2 for display
<br/>
                 DISPLAY_BG3_ACTIVE); //Enable BG3 for display
<br/>
<br/>
    /*  Set the video mode on the sub screen. */
<br/>
    videoSetModeSub(MODE_5_2D | // Set the graphics mode to Mode 5
<br/>
                    DISPLAY_BG3_ACTIVE); // Enable BG3 for display
<br/>
}
<br/>
<br/>
void initBackgrounds() {
<br/>
    /*  Set up affine background 3 on main as a 16-bit color background. */
<br/>
    REG_BG3CNT = BG_BMP16_256x256 |
<br/>
                 BG_BMP_BASE(0) | // The starting place in memory
<br/>
                 BG_PRIORITY(3); // A low priority
<br/>
<br/>
    /*  Set the affine transformation matrix for the main screen background 3
<br/>
     *  to be the identity matrix.
<br/>
     */
<br/>
    REG_BG3PA = 1 &lt;&lt; 8;
<br/>
    REG_BG3PB = 0;
<br/>
    REG_BG3PC = 0;
<br/>
    REG_BG3PD = 1 &lt;&lt; 8;
<br/>
<br/>
    /*  Place main screen background 3 at the origin (upper left of the
<br/>
     *  screen).
<br/>
     */
<br/>
    REG_BG3X = 0;
<br/>
    REG_BG3Y = 0;
<br/>
<br/>
    /*  Set up affine background 2 on main as a 16-bit color background. */
<br/>
    REG_BG2CNT = BG_BMP16_128x128 |
<br/>
                 BG_BMP_BASE(8) | // The starting place in memory
<br/>
                 BG_PRIORITY(2);  // A higher priority
<br/>
<br/>
    /*  Set the affine transformation matrix for the main screen background 3
<br/>
     *  to be the identity matrix.
<br/>
     */
<br/>
    REG_BG2PA = 1 &lt;&lt; 8;
<br/>
    REG_BG2PB = 0;
<br/>
    REG_BG2PC = 0;
<br/>
    REG_BG2PD = 1 &lt;&lt; 8;
<br/>
<br/>
    /*  Place main screen background 2 in an interesting place. */
<br/>
    REG_BG2X = -(SCREEN_WIDTH / 2 - 32) &lt;&lt; 8;
<br/>
    REG_BG2Y = -32 &lt;&lt; 8;
<br/>
<br/>
    /*  Set up affine background 3 on the sub screen as a 16-bit color
<br/>
     *  background.
<br/>
     */
<br/>
    REG_BG3CNT_SUB = BG_BMP16_256x256 |
<br/>
                     BG_BMP_BASE(0) | // The starting place in memory
<br/>
                     BG_PRIORITY(3); // A low priority
<br/>
<br/>
    /*  Set the affine transformation matrix for the sub screen background 3
<br/>
     *  to be the identity matrix.
<br/>
     */
<br/>
    REG_BG3PA_SUB = 1 &lt;&lt; 8;
<br/>
    REG_BG3PB_SUB = 0;
<br/>
    REG_BG3PC_SUB = 0;
<br/>
    REG_BG3PD_SUB = 1 &lt;&lt; 8;
<br/>
<br/>
    /*
<br/>
     *  Place main screen background 3 at the origin (upper left of the screen)
<br/>
     */
<br/>
    REG_BG3X_SUB = 0;
<br/>
    REG_BG3Y_SUB = 0;
<br/>
}
<br/>
<br/>
void displayStarField() {
<br/>
    dmaCopyHalfWords(DMA_CHANNEL,
<br/>
                     starFieldBitmap, /* This variable is generated for us by
<br/>
                                       * grit. */
<br/>
                     (uint16 *)BG_BMP_RAM(0), /* Our address for main
<br/>
                                               * background 3 */
<br/>
                     starFieldBitmapLen); /* This length (in bytes) is generated
<br/>
                                           * from grit. */
<br/>
}
<br/>
<br/>
<br/>
<br/>
void displaySplash() {
<br/>
    dmaCopyHalfWords(DMA_CHANNEL,
<br/>
                     splashBitmap, /* This variable is generated for us by
<br/>
                                    * grit. */
<br/>
                     (uint16 *)BG_BMP_RAM_SUB(0), /* Our address for sub
<br/>
                                                   * background 3 */
<br/>
                     splashBitmapLen); /* This length (in bytes) is generated
<br/>
                                        * from grit. */
<br/>
}
<br/>
<br/>
<br/>
//---------------------------------------------------------------------
<br/>
// The man sprite
<br/>
// he needs a single pointer to sprite memory
<br/>
// and a reference to his frame graphics so they
<br/>
// can be loaded as needed
<br/>
//---------------------------------------------------------------------
<br/>
typedef struct 
<br/>
{
<br/>
   int x;
<br/>
   int y;
<br/>
<br/>
   u16* sprite_gfx_mem;
<br/>
   u8*  frame_gfx;
<br/>
<br/>
   int state;
<br/>
   int anim_frame;
<br/>
}Man;
<br/>
<br/>
enum SpriteState {W_UP = 0, W_RIGHT = 1, W_DOWN = 2, W_LEFT = 3};
<br/>
<br/>
//---------------------------------------------------------------------
<br/>
// Screen dimentions
<br/>
//---------------------------------------------------------------------
<br/>
enum {SCREEN_TOP = 0, SCREEN_BOTTOM = 192, SCREEN_LEFT = 0, SCREEN_RIGHT = 256};
<br/>
<br/>
void animateMan(Man *sprite)
<br/>
{
<br/>
   int frame = sprite-&gt;anim_frame + sprite-&gt;state * FRAMES_PER_ANIMATION;
<br/>
<br/>
   u8* offset = sprite-&gt;frame_gfx + frame * 32*32;
<br/>
<br/>
   dmaCopy(offset, sprite-&gt;sprite_gfx_mem, 32*32);
<br/>
}
<br/>
<br/>
//---------------------------------------------------------------------
<br/>
// Initializing a man requires little work, allocate room for one frame
<br/>
// and set the frame gfx pointer
<br/>
//---------------------------------------------------------------------
<br/>
void initMan(Man *sprite, u8* gfx)
<br/>
{
<br/>
   sprite-&gt;sprite_gfx_mem = oamAllocateGfx(&amp;oamMain, SpriteSize_32x32, SpriteColorFormat_256Color);
<br/>
   
<br/>
   sprite-&gt;frame_gfx = (u8*)gfx;
<br/>
}
<br/>
void displayHero()
<br/>
{
<br/>
dmaCopy(manPal, SPRITE_PALETTE, 512);
<br/>
dmaCopy(womanPal, SPRITE_PALETTE, 512);
<br/>
<br/>
}
<br/>
typedef struct
<br/>
{
<br/>
   int x;
<br/>
   int y;
<br/>
<br/>
   u16* sprite_gfx_mem[12];
<br/>
   int gfx_frame;
<br/>
<br/>
   int state;
<br/>
   int anim_frame;
<br/>
<br/>
<br/>
}Woman;
<br/>
<br/>
void animateWoman(Woman *sprite)
<br/>
{
<br/>
   sprite-&gt;gfx_frame = sprite-&gt;anim_frame + sprite-&gt;state * FRAMES_PER_ANIMATION;
<br/>
}
<br/>
<br/>
//---------------------------------------------------------------------
<br/>
// Initializing a woman requires us to load all of her graphics frames 
<br/>
// into memory
<br/>
//---------------------------------------------------------------------
<br/>
void initWoman(Woman *sprite, u8* gfx)
<br/>
{
<br/>
   int i;
<br/>
<br/>
   for(i = 0; i &lt; 12; i++)
<br/>
   {
<br/>
      sprite-&gt;sprite_gfx_mem[i] = oamAllocateGfx(&amp;oamSub, SpriteSize_32x32, SpriteColorFormat_256Color);
<br/>
      dmaCopy(gfx, sprite-&gt;sprite_gfx_mem[i], 32*32);
<br/>
      gfx += 32*32;
<br/>
   }
<br/>
}
<br/>
<br/>
<br/>
<br/>
<br/>
int main()
<br/>
{
<br/>
   Man man = {0,0};
<br/>
   Woman woman = {20,20};
<br/>
   
<br/>
    /*  Turn on the 2D graphics core. */
<br/>
    powerOn(POWER_ALL_2D);
<br/>
<br/>
    /*  Configure the VRAM and background control registers. */
<br/>
    lcdMainOnBottom(); // Place the main screen on the bottom physical screen
<br/>
    initVideo(); 
<br/>
    initBackgrounds(); 
<br/>
   displayStarField(); 
<br/>
    displaySplash();
<br/>
<br/>
   oamInit(&amp;oamMain, SpriteMapping_1D_128, false);
<br/>
   
<br/>
   initWoman(&amp;woman, (u8*)womanTiles);
<br/>
   
<br/>
   initMan(&amp;man, (u8*)manTiles);
<br/>
   displayHero();
<br/>
   man.state = W_DOWN;
<br/>
   woman.state = W_DOWN;
<br/>
   while(1) 
<br/>
   {
<br/>
      scanKeys();
<br/>
<br/>
      int keys = keysHeld();
<br/>
<br/>
      if(keys)
<br/>
      {
<br/>
         if(keys &amp; KEY_UP)
<br/>
         {
<br/>
            if(man.y &gt;= SCREEN_TOP) man.y--;
<br/>
            
<br/>
<br/>
            man.state =  W_UP;
<br/>
         }
<br/>
         if(keys &amp; KEY_LEFT)
<br/>
         {
<br/>
            if(man.x &gt;= SCREEN_LEFT) man.x--;
<br/>
            
<br/>
<br/>
            man.state =  W_LEFT;
<br/>
         }
<br/>
         if(keys &amp; KEY_RIGHT)
<br/>
         {
<br/>
            if(man.x &lt;= SCREEN_RIGHT -32) man.x++;
<br/>
            
<br/>
<br/>
            man.state = W_RIGHT;
<br/>
         }
<br/>
         if(keys &amp; KEY_DOWN)
<br/>
         {
<br/>
            if(man.y &lt;= SCREEN_BOTTOM -32) man.y++;
<br/>
         
<br/>
<br/>
            man.state =  W_DOWN;
<br/>
         }
<br/>
      
<br/>
         man.anim_frame++;
<br/>
         woman.anim_frame++;
<br/>
         if(man.anim_frame &gt;= FRAMES_PER_ANIMATION) man.anim_frame = 0;
<br/>
         if(woman.anim_frame &gt;= FRAMES_PER_ANIMATION) woman.anim_frame = 0;
<br/>
         
<br/>
<br/>
      }
<br/>
<br/>
      animateMan(&amp;man);
<br/>
      animateWoman(&amp;woman);
<br/>
<br/>
      
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
      //-----------------------------------------------------------------
<br/>
      // Set oam attributes, notice the only difference is in the sprite 
<br/>
      // graphics memory pointer argument.  The man only has one pointer
<br/>
      // while the women has an array of pointers
<br/>
      //-----------------------------------------------------------------
<br/>
      oamSet(&amp;oamMain, 0, man.x, man.y, 0, 0, SpriteSize_32x32, SpriteColorFormat_256Color, 
<br/>
         man.sprite_gfx_mem, -1, false, false, false, false, false);
<br/>
      oamSet(&amp;oamMain, 1, woman.x, woman.y, 0, 0, SpriteSize_32x32, SpriteColorFormat_256Color, 
<br/>
         woman.sprite_gfx_mem[woman.gfx_frame], -1, false, false, false, false, false);
<br/>
<br/>
      
<br/>
      swiWaitForVBlank();
<br/>
<br/>
      oamUpdate(&amp;oamMain);
<br/>
      
<br/>
   }
<br/>
<br/>
<br/>
  
<br/>
    
<br/>
<br/>
    return 0;
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Ok here is the problem i have a function to display my two heroes
<br/>
called displayHero but when i load my heroes in the same screen they becoming like the first hero and they loose the colors anyone can help or tell me whats the problem??:S:SS:SS
<br/>
<br/>
[/code]</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
