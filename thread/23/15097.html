<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>to understand recursive, you must first understand recursive - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS homebrew announcements > to understand recursive, you must first understand recursive</h2>
<div id="posts">
<div class="post">
    <h4>#151656 - darkchild - Sun Mar 02, 2008 12:34 am</h4>
    <div class="postbody"><span class="postbody">ok guys, I'm going for a recursive folder killer, this is what I've done so far:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void recursivedelete(const char *folder, const char *dir)
<br/>
{
<br/>
   DIR_ITER* recur;
<br/>
   bool temp;
<br/>
   
<br/>
   char *fullpath = " ";
<br/>
   sprintf(fullpath, "%s%s/", dir, folder);
<br/>
   recur = diropen (fullpath);
<br/>
   if (recur != NULL)
<br/>
   {
<br/>
      while (dirnext(recur, filename, &amp;st) == 0)
<br/>
      {
<br/>
         if ((strcmp(filename, ".") !=0) &amp; (strcmp(filename, "..") !=0))
<br/>
         {
<br/>
            temp = (st.st_mode &amp; S_IFDIR ? true : false);
<br/>
            if (temp == true) {
<br/>
               sprintf(fullpath, "%s%s/", dir, folder);
<br/>
<br/>
               recursivedelete(filename, fullpath );
<br/>
               unlink(fullpath);
<br/>
            }
<br/>
            else
<br/>
            {
<br/>
               sprintf(fullpath, "%s%s/%s", dir, folder, filename);
<br/>
               PA_OutputText(1,0,i +1, "%d : %s",i, fullpath);
<br/>
               remove (fullpath );
<br/>
            }
<br/>
         }
<br/>
      }
<br/>
      sprintf(fullpath, "%s%s/", dir, folder);
<br/>
      unlink(fullpath);
<br/>
   }
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
yet all it does is go to that folder, delete all files in it, but not the subfolders.. not the subfolder's files.
<br/>
<br/>
now, the syntax of this function:
<br/>
<br/>
recursivedelete ("currentdir", "nameofthefolderwearedeleting");
<br/>
<br/>
<br/>
what am I doing wrong? :X
<br/>
<br/>
<br/>
<br/>
<span style="font-weight: bold">Edit : I posted this on the wrong section, can a mod move it to the right one? :X</span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#151681 - zAlbee - Mon Mar 03, 2008 6:58 am</h4>
    <div class="postbody"><span class="postbody">Well looks like syntax is reversed and should be
<br/>
<br/>
recursivedelete ("nameofthefolderwearedeleting", "currentdir");
<br/>
<br/>
Other than that, where are you allocating buffer space for your filename and fullpath strings? I don't even see filename declared.
<br/>
<br/>
Edit:
<br/>
Two args for folder and dir seems unnecessary. You always use them together anyway. Line 19: unlink(fullpath) is unnecessary, because the recursive call will already have unlinked it.
<br/>
<br/>
Here's pseudocode that makes it easier to see.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">// precondition: dir is a directory with 0 or more files
<br/>
// postcondition: dir is gone, along with contents
<br/>
<br/>
rdel (dir) {
<br/>
   for files f in dir:
<br/>
      if (f is a folder) rdel(f)
<br/>
      else remove (f)
<br/>
   unlink (dir);
<br/>
}</td> </tr></table><span class="postbody"><br/>_________________<br/><span style="font-size: 10px; line-height: normal">DS Lite white, R4DS, 1GB Kingmax microSD</span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#151688 - elwing - Mon Mar 03, 2008 8:55 am</h4>
    <div class="postbody"><span class="postbody">not only are the 2 string not necessary since they are always used together, but worst you are concatenating the strings 3 time for each function call... by the way, wouldn't it be wise to add a recursive counter to avoid stack overflow? trough i'm not sure it's needed on a ds...
<br/>
<br/>
and to answers zalbee, yes there is no declaration for the strings, he's trying to construct fullpath right on the constant " " he declared... it's strange that the DS doesn't crash with that. on windows you'll get some nice access violation for that...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#151698 - Cydrak - Mon Mar 03, 2008 4:09 pm</h4>
    <div class="postbody"><span class="postbody">elwing, that's because PCs have a full MMU; the DS hasn't, so writing const data will silently change the const. It will catch wildly out of range pointers though. In libnds, defaultExceptionHandler() installs a guru meditation/RSo'D.
<br/>
<br/>
Also... the stack maxes out at 16kb, which could really be a problem. libfat is moving toward UTF-8, so iirc it needs 3*256 chars. But, maybe you could build the path in place:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">// trailing slash on 'dir' is required
<br/>
rdel(dir) {
<br/>
   char path[MAXPATHLEN]
<br/>
   strcpy(path, dir)
<br/>
   rdel_internal(path)
<br/>
}
<br/>
<br/>
rdel_internal(dir) {
<br/>
   for files f in dir:
<br/>
      if (f not folder)
<br/>
         remove (f)
<br/>
      else
<br/>
          tail = dir + strlen(dir)
<br/>
          sprintf(tail, "%s/", f)
<br/>
          rdel_internal(dir)
<br/>
          strcpy(tail, "")
<br/>
   unlink(dir)
<br/>
}</td> </tr></table><span class="postbody">
<br/>
darkchild, if you come from other languages, realise there are no dynamic "strings" in C... you need to make space ahead of time. If you don't give a big enough char array to sprintf(), it will happily blow past the end. Unless you can predict the size, snprintf() is better. It truncates, but better than crashing..
<br/>
<br/>
Pointers and arrays have an insidious tendency to look the same, but really they aren't (heh, someone correct me if I'm wrong):
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">char *fooPtr     = "foo";
<br/>
char barArray[]  = "bar";
<br/>
char bazArray[4] = { 'b','a','z', 0 };</td> </tr></table><span class="postbody">
<br/>
The bar and baz definitions are arrays. One is just convenient (but deceptive) shorthand.
<br/>
<br/>
Whereas, foo only gives you a pointer *to* an array, and here, not one you should write to. It'd be like if you said "int* numPtr = &amp;5;"... which is wrong. Since even if GCC let you do that, it may combine all the unique constants, and then you might accidentially change all the 5's in your code.</span><span class="gensmall"><br/><br/>Last edited by Cydrak on Mon Mar 03, 2008 4:29 pm; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#151699 - masscat - Mon Mar 03, 2008 4:29 pm</h4>
    <div class="postbody"><span class="postbody">Sometimes the best thing about recursion is not using it. Here is an iterative directory tree delete:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">int
<br/>
deleteDirTree( const char *aDirPath) {
<br/>
  int success = 1;
<br/>
  int complete = 0;
<br/>
  uint32_t depth = 0;
<br/>
  char next_dir_name[256];
<br/>
  char orig_working_directory[MAXPATHLEN];
<br/>
<br/>
  getcwd( orig_working_directory, MAXPATHLEN);
<br/>
<br/>
  if ( chdir( aDirPath) != 0) {
<br/>
    /* failed to get into the directory, cannot continue */
<br/>
    return 0;
<br/>
  }
<br/>
<br/>
<br/>
  while ( !complete) {
<br/>
    /* attempt to delete everything in the current directory */
<br/>
    DIR_ITER *dp = diropen( ".");
<br/>
<br/>
    if ( dp != NULL) {
<br/>
      int move_down = 0;
<br/>
      struct stat file_st;
<br/>
      char name_buffer[256];
<br/>
<br/>
      while (!complete) {
<br/>
        if ( dirnext( dp, name_buffer, &amp;file_st) == 0) {
<br/>
          /*
<br/>
           * avoid trying to delete "." and ".."
<br/>
           */
<br/>
          if ( strcmp( name_buffer, "..") != 0 &amp;&amp; strcmp( name_buffer, ".") != 0) {
<br/>
            if ( unlink( name_buffer) != 0) {
<br/>
              if ( file_st.st_mode &amp; S_IFDIR) {
<br/>
                if ( errno == EPERM) {
<br/>
                  /* the directory is not empty */
<br/>
                  if ( move_down == 0) {
<br/>
                    move_down = 1;
<br/>
<br/>
                    /* keep this directory name for later */
<br/>
                    strcpy( next_dir_name, name_buffer);
<br/>
                  }
<br/>
                }
<br/>
                else {
<br/>
                  /* the delete failed for some other reason, oh dear */
<br/>
                  success = 0;
<br/>
                  complete = 1;
<br/>
                }
<br/>
              }
<br/>
              else {
<br/>
                /* failed to unlink a file, not alot can happen now */
<br/>
                success = 0;
<br/>
                complete = 1;
<br/>
              }
<br/>
            }
<br/>
          }
<br/>
        }
<br/>
        else {
<br/>
          /* completed the directory walk */
<br/>
          break;
<br/>
        }
<br/>
      }
<br/>
      dirclose( dp);
<br/>
<br/>
      if ( !complete) {
<br/>
        if (move_down) {
<br/>
          /*
<br/>
           * Move into the lower directory
<br/>
           */
<br/>
          if ( chdir( next_dir_name) != 0) {
<br/>
            success = 0;
<br/>
            complete = 1;
<br/>
          }
<br/>
          depth += 1;
<br/>
        }
<br/>
        else {
<br/>
          /* successfully deleted the contents of this directory
<br/>
           * so unlink it */
<br/>
          chdir("..");
<br/>
<br/>
          if ( depth == 0) {
<br/>
            if ( unlink(aDirPath) != 0) {
<br/>
              /* should have worked */
<br/>
              success = 0;
<br/>
            }
<br/>
            complete = 1;
<br/>
          }
<br/>
          else {
<br/>
            depth -= 1;
<br/>
          }
<br/>
        }
<br/>
      }
<br/>
    }
<br/>
    else {
<br/>
      /* time to cry */
<br/>
      success = 0;
<br/>
      complete = 1;
<br/>
    }
<br/>
  }
<br/>
<br/>
  chdir( orig_working_directory);
<br/>
<br/>
  return success;
<br/>
}</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#151705 - darkchild - Mon Mar 03, 2008 8:02 pm</h4>
    <div class="postbody"><span class="postbody">Hmm, so recursive sometimes is bad...
<br/>
<br/>
And yes xD I did come from another language (VB6)
<br/>
<br/>
I'm still learning C to be honest :X
<br/>
<br/>
Still a newbie &gt;_&gt;
<br/>
<br/>
But thank you all for the help, I will try masscat's code, if it works, I'll credit ya, and of course, all of you for the great amount of help you guys gave me.
<br/>
<br/>
Thank you, it's good to know you guys actually care :)
<br/>
<br/>
Edit : masscat, the compiler gives me an error :
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">c:/iFile/source/includes/io.c: In function 'deleteDirTree':
<br/>
c:/iFile/source/includes/io.c:215: error: 'errno' undeclared (first use in this function)
<br/>
c:/iFile/source/includes/io.c:215: error: (Each undeclared identifier is reported only once
<br/>
c:/iFile/source/includes/io.c:215: error: for each function it appears in.)
<br/>
c:/iFile/source/includes/io.c:215: error: 'EPERM' undeclared (first use in this function)</td> </tr></table><span class="postbody">
<br/>
<br/>
I don't know how to work with this "Errno" -.-
<br/>
<br/>
<br/>
Edit : Nevermind, googled a bit and found that I had to add "Errno.h" :)</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
