<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>libmikmod 3.2.0ds1 - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS homebrew announcements > libmikmod 3.2.0ds1</h2>
<div id="posts">
<div class="post">
    <h4>#147553 - Stonebone - Sat Dec 22, 2007 11:37 pm</h4>
    <div class="postbody"><span class="postbody">I?ve released a new version of libmikmod for Nintendo DS. Here is what?s new:
<br/>
<br/>
    * Based on libmikmod 3.2.0-beta2
<br/>
    * Many fixes to the hardware mixer by Andreas Back. It is almost as good as the software mixer now!
<br/>
<br/>
Download here: <a href="http://code.google.com/p/tetattds/downloads/list" target="_blank">http://code.google.com/p/tetattds/downloads/list</a>
<br/>
Blog: <a href="http://blog.dev-scene.com/flatware/" target="_blank">http://blog.dev-scene.com/flatware/</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#147589 - jackman - Mon Dec 24, 2007 1:41 am</h4>
    <div class="postbody"><span class="postbody">Thanks for the new release.
<br/>
<br/>
Hardware Mode now works better, but with some .mod's there's a timing issue, I hear channels playing which shouldn't play at this time.
<br/>
<br/>
MD Mode:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">md_mode |= DMODE_STEREO | DMODE_SURROUND | DMODE_HQMIXER | DMODE_INTERP;</td> </tr></table><span class="postbody">
<br/>
<br/>
Disabling Surround, HQMixer and/or Interpolation brought the same result. Possibly incorrect Timer0 settings?
<br/>
<br/>
Timer0 Code:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">// call update with correct timing
<br/>
TIMER0_CR = 0;
<br/>
irqSet(IRQ_TIMER0, TimerInterrupt);
<br/>
irqEnable(IRQ_TIMER0);
<br/>
TIMER0_DATA = TIMER_FREQ_256(md_bpm * 50 / 125);
<br/>
TIMER0_CR = TIMER_DIV_256 | TIMER_IRQ_REQ | TIMER_ENABLE;</td> </tr></table><span class="postbody">
<br/>
<br/>
in function TimerInterrupt() :
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void TimerInterrupt()
<br/>
{
<br/>
   // player tick
<br/>
   MikMod_Update();
<br/>
   
<br/>
   // the bpm can change in the middle of the song
<br/>
   TIMER0_DATA = TIMER_FREQ_256(md_bpm * 50 / 125);
<br/>
}</td> </tr></table><span class="postbody"><br/>_________________<br/>Equipment:
<br/>
Nintendo DS, GBAMP v2, SuperCard SD, SuperKey, Acekard 2i</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#147607 - Stonebone - Mon Dec 24, 2007 11:38 am</h4>
    <div class="postbody"><span class="postbody">md_mode is ignored by the hardware mixer. It's only used by the software mixer.
<br/>
<br/>
But yes, I also think there is some kind of timing issue. Here is what the MikMod documentation says:
<br/>
<a class="postlink" href="http://mikmod.raphnet.net/doc/libmikmod-3.1.10/docs/mikmod.html" target="_blank">http://mikmod.raphnet.net/doc/libmikmod-3.1.10/docs/mikmod.html</a>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">The player function is called every module tick to process module playback. The rate at which the player function is called is controlled by the sound driver, and is computed by the following equation:
<br/>
(bpm*50)/125 calls per second, which means every 125000/(bpm*50) milliseconds. The bpm value is the tempo of the module and can change from its initial value when requested by the module.</td> </tr></table><span class="postbody">
<br/>
It's normally the driver's responsibility to control the timing, but instead my driver calls the player function once in the update function. With the timer code you have there it should work, but it doesn't. There must be some flaw in my logic.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#147632 - tepples - Mon Dec 24, 2007 11:45 pm</h4>
    <div class="postbody"><span class="postbody">If you have an update function that's getting called at a constant CLOCKS_PER_SEC Hz, then you can try something like this:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">tempoCounter += mod-&gt;curTempo;
<br/>
while (counter &gt;= CLOCKS_PER_SEC * 5 / 2) {
<br/>
  updateTick(mod);
<br/>
  counter -= CLOCKS_PER_SEC * 5 / 2;
<br/>
}</td> </tr></table><span class="postbody">
<br/>
On the GBA, DS, or an NTSC console, updating on vblank would give CLOCKS_PER_SEC = 60.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#147663 - Stonebone - Tue Dec 25, 2007 7:07 pm</h4>
    <div class="postbody"><span class="postbody">I'm not sure if it is a good idea. It is important that it gets called at the exact right moment.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#148092 - Rajveer - Wed Jan 02, 2008 3:45 am</h4>
    <div class="postbody"><span class="postbody">This is great, first time trying to get music into my game and it was very easy. Thanks!
<br/>
<br/>
Just to make sure though, I shouldn't be worried about this line in the ARM9 makefile should I?
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote"># note: arm9tdmi isn't the correct CPU arch, but anything newer and LD
<br/>
# *insists* it has a FPU or VFP, and it won't take no for an answer!</td> </tr></table><span class="postbody">
<br/>
<br/>
Any side effects in using the ARM9tdmi architecture? Also, what's LD?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#148113 - Stonebone - Wed Jan 02, 2008 1:18 pm</h4>
    <div class="postbody"><span class="postbody">That comment comes from an old version of the project template from devkitARM. I think it was fixed in newer version of devkitARM and/or the template. You don't need to worry about it. LD is the linker.
<br/>
<br/>
<span style="font-weight: bold">["devkitPro" is the company. -- MOD]</span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#148160 - Rajveer - Thu Jan 03, 2008 4:30 am</h4>
    <div class="postbody"><span class="postbody">I've got a bit of a problem. I've created an IT file in Modplug Tracker, which doesn't want to work with libmodmik unless I save it in compatibility mode, where it sounds like crap. I read up on Dark Knight Ez's posts about loading it in Impulse Tracker and saving it as IT2xx, but Impulse Tracker doesn't seem to want to load either the original IT or the version saved with compability mode. How did you load and test IT files, or do you not use Modplug Tracker?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#148182 - Stonebone - Thu Jan 03, 2008 11:37 am</h4>
    <div class="postbody"><span class="postbody">No I did not use MPT since I normally use linux, but the thing is I know very little about mods. It might sound strange porting mikmod to ds and all, but I just needed something to play music in tetattds. Music which somebody else wrote.
<br/>
<br/>
But basically, if it doesn't load at all, then it's a problem with mikmod itself, not the ds port. If it sounds crap it might be the ds port.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#148183 - Rajveer - Thu Jan 03, 2008 11:56 am</h4>
    <div class="postbody"><span class="postbody">Nah I'm sure it's not the ds port as Dark Knight ez wrote (on another forum) that it should be fine as long as you can convert to IT2xx within Impulse Tracker itself, so it seems to be a problem between MTP and Impulse Tracker compatibility. I'll stop spamming this thread with my problems now, thanks for the port :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#150666 - SiW - Sun Feb 10, 2008 12:22 am</h4>
    <div class="postbody"><span class="postbody">Is there any reason why I can't get single samples working?  (<span style="font-weight: bold">Update:</span> see below)  I haven't tried loading from file as my project isn't setup for FAT, so I had to add a load from memory routine in mikmod/arm9/source/memoryloader.c:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">MIKMODAPI extern SAMPLE* Sample_LoadMemory(const void* buffer, size_t size )
<br/>
{
<br/>
   SAMPLE* sample = 0;
<br/>
<br/>
   MMEMORYREADER* reader=(MMEMORYREADER*)malloc(sizeof(MMEMORYREADER));
<br/>
   if (reader) {
<br/>
      reader-&gt;core.Eof  = &amp;MemoryReader_Eof;
<br/>
      reader-&gt;core.Read = &amp;MemoryReader_Read;
<br/>
      reader-&gt;core.Get  = &amp;MemoryReader_Get;
<br/>
      reader-&gt;core.Seek = &amp;MemoryReader_Seek;
<br/>
      reader-&gt;core.Tell = &amp;MemoryReader_Tell;
<br/>
      reader-&gt;buffer = (const UBYTE*)buffer;
<br/>
      reader-&gt;size = size;
<br/>
<br/>
      sample = Sample_LoadGeneric((MREADER*)reader);
<br/>
      free(reader);
<br/>
   }
<br/>
<br/>
   return sample;
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
But Sample_LoadGeneric is returning NULL.  I'm passing it what should be a legitimate buffer (a mono .wav passed through bin2o, tried 8 and 16 bit) so I'm not sure what gives.  
<br/>
<br/>
Anyone know how quickly Martin Korth is processing no$ payments these days so I can actually debug this? :*)
<br/>
<br/>
<span style="font-weight: bold">Update</span> - I'm now wondering if there's actually any point to getting this working when I could just use playSound.  My thinking was it would be nice to use the mikmod stuff to maintain portability with some of my other projects, but..</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#150672 - Dark Knight ez - Sun Feb 10, 2008 12:48 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Nah I'm sure it's not the ds port as Dark Knight ez wrote (on another forum) that it should be fine as long as you can convert to IT2xx within Impulse Tracker itself, so it seems to be a problem between MTP and Impulse Tracker compatibility. I'll stop spamming this thread with my problems now, thanks for the port :)</td> </tr></table><span class="postbody">
<br/>
Really late response to this. Sorry. Just read it.
<br/>
Anyway, the newest versions of ModPlug Tracker and such should not be used. Instead, use the older versions which save to a a somewhat older IT format which -can- be converted to the old IT2xx format by Impulse Tracker. (Download <a class="postlink" href="http://lpchip.com/modplug/viewtopic.php?t=16" target="_blank">here</a>.)<br/>_________________<br/><span style="font-size: 9px; line-height: normal"><a class="postlink" href="http://amplituds.drunkencoders.com" target="_blank">AmplituDS website</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#156941 - M3d10n - Fri May 16, 2008 5:20 pm</h4>
    <div class="postbody"><span class="postbody">Any idea on how much CPU the software mixing uses? I'm trying to convert some .mid files to .it using ModPlug, but it keeps generating files with 16+ channels for some reason (even if the channels are empty in MP) and the hardware playback gets buggy.
<br/>
<br/>
--EDIT--
<br/>
Heh, I found I can limit the number of channels... but even so the hardware mixer still sounds glitchy with the files I'm using. I want to use .IT tracks as background music for my 3D game, so CPU-usage is important.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#156962 - tepples - Fri May 16, 2008 10:40 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>M3d10n wrote:</b></span></td> </tr> <tr> <td class="quote">I'm trying to convert some .mid files to .it using ModPlug, but it keeps generating files with 16+ channels for some reason (even if the channels are empty in MP) and the hardware playback gets buggy.</td> </tr></table><span class="postbody">
<br/>
You can make MPT delete empty channels. Go into Song Properties and reduce the number of channels. It'll ask you which channels to delete, highlighting a few empty channels if it finds any.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">I want to use .IT tracks as background music for my 3D game, so CPU-usage is important.</td> </tr></table><span class="postbody">
<br/>
Then compose the tracks directly in .it.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#156968 - M3d10n - Sat May 17, 2008 12:42 am</h4>
    <div class="postbody"><span class="postbody">I got proper sounding .IT tracks now, but the hardware mixer can't reproduce them properly. The software mixer, however, is perfect, even if a little grainy. The tracks are using 5 to 7 channels. I just hope there's CPU left for the game, or it's bye bye 60fps.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
