<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>httpexec v1.2 (Updated: July 10 2007) - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>DS homebrew announcements > httpexec v1.2 (Updated: July 10 2007)</h2>
<div id="posts">
<div class="post">
    <h4>#127935 - Fling - Sun May 06, 2007 8:31 pm</h4>
    <div class="postbody"><span class="postbody"><span style="font-weight: bold">Intro:</span>
<br/>
What is httpexec? It's basically DS Download Play over HTTP. It combines the work of EyeballKid's HappyHTTP library and GrizzlyAdams' exec_stub from DSChannels with a bit of glue code written by yours truly. It's meant to be used as a development tool to decrease the time spent between when you recompile your project to the time you see it running on your DS with no card swapping in between.
<br/>
<br/>
<span style="font-weight: bold">Latest Version:</span> v1.2 (<a class="postlink" href="http://files.blarg.ca/projects/httpexec_v1.2.tar.bz2" target="_blank">Download</a>)
<br/>
<br/>
<span style="font-weight: bold">Changes</span>
<br/>
- Added EyeballKid's CrackURL() function contributed via the gbadev.org forums. As a result, URL parsing is a lot more flexible then it was previously.
<br/>
- More meaningful error messages will now be displayed if any problems occur during the HTTP download.
<br/>
<br/>
<span style="font-weight: bold">Known Issues</span>
<br/>
Not really httpexec-specific, but there is a bit of a delay (at least for me) in the DSChannels exec_stub just before it finishes booting the downloaded binary. This is caused by a call to FAT_FreeFiles(). If you experience this delay, you can get rid of it by removing the function call. I will not be distributing any modified exec_stub binaries as I'm not 100% certain if removing this call will not result in any problems for anyone (it hasn't for me so far however).
<br/>
<br/>
------
<br/>
<br/>
Please consult the "readme.txt" file included in the download for usage notes, etc. If you encounter any problems be sure to tell me about them by replying to this topic!</span><span class="gensmall"><br/><br/>Last edited by Fling on Wed Jul 11, 2007 1:52 am; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#127949 - simonjhall - Sun May 06, 2007 10:45 pm</h4>
    <div class="postbody"><span class="postbody">So how long does this take from the moment the program starts to the time the downloaded program is executed? (assuming a 500k elf)
<br/>
If it's fast enough I'll be trying this!<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#127954 - Fling - Sun May 06, 2007 11:08 pm</h4>
    <div class="postbody"><span class="postbody">After getting rid of the exec_stub delay by removing the FAT_FreeFiles call (seems to still work correctly with all the tests I've done so far), I tested it out with a 585.5KB program I had sitting around. From when I press power on my DS to when the program starts running took ~16 seconds, downloading at ~62KB/sec (measured from my PC). Not sure if I can increase that download speed at all as I haven't even looked into optimization yet (just basically took the HappyHTTP lib as-is and stuck it into httpexec).
<br/>
<br/>
This was tested on my Supercard MiniSD. I noticed my DS-X takes significantly longer to write the downloaded program to flash memory... didn't time it though.
<br/>
<br/>
Anyway... I'm sure card-swapping seems more appealing for quicker code reloading with a larger program so far, heh.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#128789 - EyeballKid - Tue May 15, 2007 8:05 am</h4>
    <div class="postbody"><span class="postbody">Cool - I'll definitely be using this next time I get back into doing some DS hacking!
<br/>
If you find any bottlenecks in HappyHTTP, send me patches!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#128866 - dantheman - Wed May 16, 2007 2:49 am</h4>
    <div class="postbody"><span class="postbody">Just wanted to report that it works fine on my Supercard miniSD, though I have to send the .nds files, not .ds.gba or .sc.nds ones, which I'm not accustomed to doing.  Still, it works fine, so thank you.  
<br/>
<br/>
The only issue I have found is that even though my config file has WAITFORKEY=0 set, I still have to press A for it to progress from "Ready to jump."  While this isn't a major issue, I felt it noteworthy.  Does setting EXECDEBUG=1 override this?  If so, that might be the reason, as I turned that on so I could see if/when it froze upon booting.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#128868 - Fling - Wed May 16, 2007 3:21 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>dantheman wrote:</b></span></td> </tr> <tr> <td class="quote">The only issue I have found is that even though my config file has WAITFORKEY=0 set, I still have to press A for it to progress from "Ready to jump."  While this isn't a major issue, I felt it noteworthy.  Does setting EXECDEBUG=1 override this?  If so, that might be the reason, as I turned that on so I could see if/when it froze upon booting.</td> </tr></table><span class="postbody">
<br/>
<br/>
Yeah, "WAITFORKEY" only affects whether you get a "Press any button to continue" immediately after the .nds is downloaded. The only reason that option is actually included is because I wanted a quick way to be able to turn on/off a pause before booting the .nds for debugging purposes. WAITFORKEY has no effect on the "Ready to jump" wait... that is controlled by EXECDEBUG, as I considered it to be part of the debugging output.
<br/>
<br/>
Somewhat confusing now that I think about it, heh. I'll probably change that around for the next version so it's a bit more obvious what controls what.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>EyeballKid wrote:</b></span></td> </tr> <tr> <td class="quote">If you find any bottlenecks in HappyHTTP, send me patches!</td> </tr></table><span class="postbody">
<br/>
<br/>
Unfortunately I haven't had a chance to really take a nice long look over the code in HappyHTTP. I'm 99% certain that the bottleneck is there, as using DSLinux I can download at ~120KB/sec ... double the speed of httpexec. Hopefully I'll get a chance to take a good look soon.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#128941 - EyeballKid - Wed May 16, 2007 10:48 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Fling wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>EyeballKid wrote:</b></span></td> </tr> <tr> <td class="quote">If you find any bottlenecks in HappyHTTP, send me patches!</td> </tr></table><span class="postbody">
<br/>
<br/>
Unfortunately I haven't had a chance to really take a nice long look over the code in HappyHTTP. I'm 99% certain that the bottleneck is there, as using DSLinux I can download at ~120KB/sec ... double the speed of httpexec. Hopefully I'll get a chance to take a good look soon.</span></td> </tr></table><span class="postbody">
<br/>
<br/>
Hmmm... I'd be pretty sure that DSLinux uses a different IP stack. I'd guess it's just be the standard Linux IP stack on top of a custom kernel module to implement a network interface on the DS hardware.
<br/>
<br/>
So the bottleneck could be in libwifi (sgstairs IP stack). Does anyone have any transfer-rate figures from other libwifi-using apps?
<br/>
<br/>
In HappyHTTP, my feeling would be that the I/O operations would far far outweigh the HTTP parsing. So the place to start looking would be in the Connection::pump() function.
<br/>
Ideas:
<br/>
- Increase the size of the recv buffer (I don't think this will make much difference, as it's already a lot bigger than the likely MTU).
<br/>
- Get rid of the select() call in datawaiting(). It's only used to prevent pump() from blocking, which probably isn't a big deal in this case. Just replace the datawaiting function with:
<br/>
bool datawaiting( int sock ) { return true; }
<br/>
Last time I used libwifi, it didn't implement select() - maybe it's still a little rough in that area?
<br/>
<br/>
I just ran some tests with HappyHTTP on my Linux laptop. I can download a 4megabyte file from a remote website in around 35 seconds. About 110KiloBytes/sec. Which is about as fast a download as my internet connection ever sees with any app, Changing the recv buffer size to 64Kilobytes made no noticeable difference.
<br/>
So my guess is that the bottleneck is within libwifi (or in the specific way HappyHTTP is using libwifi which is causing the slowdown)...
<br/>
<br/>
Hope this helps!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#129283 - phlip - Mon May 21, 2007 2:15 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>EyeballKid wrote:</b></span></td> </tr> <tr> <td class="quote">So the bottleneck could be in libwifi (sgstairs IP stack). Does anyone have any transfer-rate figures from other libwifi-using apps?</td> </tr></table><span class="postbody">
<br/>
<br/>
I wrote an extremely bodgy HTTPd using libdswifi so I could copy files to my DS with curl... I generally get around 100-110KB/s (reading from the socket, writing to the file).<br/>_________________<br/>&lt;link rel="signature" type="text/hilarious" href="/funnysig.txt" /&gt;</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#129285 - simonjhall - Mon May 21, 2007 3:05 pm</h4>
    <div class="postbody"><span class="postbody">All my programs which use wifi get extremely low throughput in the wifi lib yet I can't seem to find what's different between my setup of the wifi lib and anyone elses... Basically I get definately less than 5k/s - I wouldn't be surprised if's closer to 1k/s!<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#129395 - chrisc - Tue May 22, 2007 11:38 am</h4>
    <div class="postbody"><span class="postbody">I get 50kps approx using a sc ds1 works nice thanks!
<br/>
<br/>
this is about on par with other wifi apps I've used
<br/>
I wouldnt know about dslinux cause i cant get it to work on my scds...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#133752 - ChronoDK - Sun Jul 08, 2007 11:49 am</h4>
    <div class="postbody"><span class="postbody">I get an error when running this. "terminate called after instance of happyhttp:Wobbly"
<br/>
<br/>
What does that mean?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#133875 - Fling - Mon Jul 09, 2007 2:41 pm</h4>
    <div class="postbody"><span class="postbody">Is there any other error information? What (if anything) is displayed before the error message?
<br/>
<br/>
EDIT: Also, probably should make sure, but have you been able to use other homebrew that make use of wifi before without any problems?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#133880 - ChronoDK - Mon Jul 09, 2007 2:59 pm</h4>
    <div class="postbody"><span class="postbody">I don't see other errors. It says "libfat...done!" and "wifi...done!"
<br/>
<br/>
This is my config:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
URL=http://192.168.1.100:81/download.nds
<br/>
OUT=/bootme.nds
<br/>
WAITFORKEY=0
<br/>
EXECDEBUG=0
<br/>
EXECPATH=/</td> </tr></table><span class="postbody">
<br/>
<br/>
The error shows even if the web-server is not running. And yes, I have been able to run other homebrew wifi stuff.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#133928 - Fling - Mon Jul 09, 2007 9:25 pm</h4>
    <div class="postbody"><span class="postbody">Actually, it's a good thing you pasted your config... the problem is the URL you're providing httpexec... or more specifically, the port number in the URL. You'll have to change your webserver to run on port 80 as the function that parses the URL doesn't know what to do with port numbers <span style="font-style: italic">yet</span>.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#133977 - EyeballKid - Tue Jul 10, 2007 12:03 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Fling wrote:</b></span></td> </tr> <tr> <td class="quote">Actually, it's a good thing you pasted your config... the problem is the URL you're providing httpexec... or more specifically, the port number in the URL. You'll have to change your webserver to run on port 80 as the function that parses the URL doesn't know what to do with port numbers <span style="font-style: italic">yet</span>.</td> </tr></table><span class="postbody">
<br/>
<br/>
I keep forgetting to merge this into HappyHTTP, but here's the function I use to crack URLs, if it's any use to you. It handles port numbers (defaults to port 80).
<br/>
<br/>
URL of form:
<br/>
"&lt;scheme&gt;://&lt;hostname&gt;[:&lt;hostport&gt;]&lt;hostpath&gt;"
<br/>
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
struct URLStruct
<br/>
{
<br/>
   char scheme[ 32 ];   // "http" etc
<br/>
   char hostname[ 128 ];
<br/>
   int hostport;
<br/>
   char hostpath[ 512];
<br/>
};
<br/>
<br/>
<br/>
// helper fn to parse urls.
<br/>
// return false on failure
<br/>
bool CrackURL( const char* url, URLStruct&amp; out )
<br/>
{
<br/>
   const char* in = url;
<br/>
   out.hostport = 80;
<br/>
<br/>
   // scheme
<br/>
   if( !*in )
<br/>
      return false;
<br/>
   const char* p = strstr( in, "://" );
<br/>
   if( p )
<br/>
   {
<br/>
      int n = p-in;
<br/>
      strncpy( out.scheme, in, n );
<br/>
      out.scheme[n] = '\0';
<br/>
      in += (n+3);   // skip past scheme
<br/>
   }
<br/>
   else
<br/>
   {
<br/>
      strcpy( out.scheme, "http" );
<br/>
   }
<br/>
<br/>
   if( !*in )
<br/>
      return false;
<br/>
<br/>
   //
<br/>
   char* hostname = out.hostname;
<br/>
   while( *in &amp;&amp; *in != ':' &amp;&amp; *in !='/' )
<br/>
      *hostname++ = *in++;
<br/>
   *hostname++ = '\0';
<br/>
<br/>
   if( out.hostname[0] == '\0' )
<br/>
      return false;   // hostname empty
<br/>
<br/>
   // port number?
<br/>
   if( *in == ':' )
<br/>
   {
<br/>
      ++in;
<br/>
      out.hostport = atoi( in );
<br/>
      while( *in &amp;&amp; *in != '/' )
<br/>
         ++in;
<br/>
   }
<br/>
<br/>
   // rest is path
<br/>
   if( *in )
<br/>
      strcpy( out.hostpath, in );
<br/>
   else
<br/>
      strcpy( out.hostpath, "/" );
<br/>
<br/>
   return true;
<br/>
}
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#133981 - EyeballKid - Tue Jul 10, 2007 12:16 am</h4>
    <div class="postbody"><span class="postbody">Also, I'd recommend plonking a try...catch block around the part of main() which does the http stuff. That way you can catch and display error messages, so users might give you more informative error reports...
<br/>
<br/>
eg
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
<br/>
try
<br/>
{
<br/>
   // Connect to the webserver specified, and begin the transfer process
<br/>
   .... etc etc etc ....
<br/>
   conn.close()
<br/>
}
<br/>
catch( happyhttp::Wobbly&amp; e )
<br/>
{
<br/>
   printf( "\nERROR:\n%s\n",e.what() );
<br/>
}
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#133994 - HyperHacker - Tue Jul 10, 2007 1:04 am</h4>
    <div class="postbody"><span class="postbody">That code looks vulnerable to buffer overflows. It strcpy()s into the buffers without doing any length check.<br/>_________________<br/>I'm a PSP hacker now, but I still &lt;3 DS.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#134080 - EyeballKid - Tue Jul 10, 2007 2:31 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>HyperHacker wrote:</b></span></td> </tr> <tr> <td class="quote">That code looks vulnerable to buffer overflows. It strcpy()s into the buffers without doing any length check.</td> </tr></table><span class="postbody">
<br/>
<br/>
OOoop - yep, you're right.
<br/>
Not an issue for most applications happyhttp is designed for, but worth fixing.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#134097 - Fling - Tue Jul 10, 2007 3:54 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>EyeballKid wrote:</b></span></td> </tr> <tr> <td class="quote">Also, I'd recommend plonking a try...catch block around the part of main() which does the http stuff. That way you can catch and display error messages, so users might give you more informative error reports...</td> </tr></table><span class="postbody">
<br/>
<br/>
Thanks for pointing that out (and the CrackURL function)! Not sure why I didn't include that given that I remember specifically enabling exceptions in the makefile.
<br/>
<br/>
I'll be adding that, plus the improved URL parsing function you posted earlier into v1.2.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#134374 - ChronoDK - Thu Jul 12, 2007 9:11 pm</h4>
    <div class="postbody"><span class="postbody">It still won't work with anything but port 80 right? 
<br/>
<br/>
My problem is that I can't run a local webserver on port 80 because some service is using that port (and I can't figure out which one). So other port numbers would be my request for 1.3 :-)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#134396 - Fling - Thu Jul 12, 2007 11:15 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">URL=http://10.0.0.1:81/download.nds</td> </tr></table><span class="postbody">
<br/>
<br/>
Worked fine for me. Not sure exactly why it wouldn't for you. You sure you didn't maybe make a typo?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#134482 - ChronoDK - Fri Jul 13, 2007 11:14 am</h4>
    <div class="postbody"><span class="postbody">Whoops, I did - sorry. 
<br/>
<br/>
My ip had changed since last time :-|</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#134497 - Fling - Fri Jul 13, 2007 12:56 pm</h4>
    <div class="postbody"><span class="postbody">Ah, actually after posting I thought that might have been the case after looking at the config file you posted since it looked like you were just using DHCP on your computer.
<br/>
<br/>
Anyway, glad to know it worked for you.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
