<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Simple loop, strange behaviour - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>DS development > Simple loop, strange behaviour</h2>
<div id="posts">
<div class="post">
    <h4>#148296 - nipil - Fri Jan 04, 2008 1:56 pm</h4>
    <div class="postbody"><span class="postbody">I'm back with something strange. Here's the actual code sample :
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#include &lt;nds.h&gt;
<br/>
#include &lt;stdio.h&gt;
<br/>
<br/>
int main(void) {
<br/>
   u8 a,i;
<br/>
<br/>
   videoSetMode(0);
<br/>
   videoSetModeSub(MODE_0_2D | DISPLAY_BG0_ACTIVE);
<br/>
   vramSetBankC(VRAM_C_SUB_BG);
<br/>
   SUB_BG0_CR = BG_MAP_BASE(31);
<br/>
   BG_PALETTE_SUB[255] = RGB15(31,31,31);
<br/>
   consoleInitDefault((u16*)SCREEN_BASE_BLOCK_SUB(31), (u16*)CHAR_BASE_BLOCK_SUB(0), 16);
<br/>
<br/>
   u8 * tileMemory = (u8*)BG_TILE_RAM(1);
<br/>
   for (i = 0; i &lt; 64; i++) {
<br/>
      tileMemory[i] = 6;
<br/>
      printf("%i ",tileMemory[i]);
<br/>
   }
<br/>
   for (a = 0; a &lt; 64; a++) {
<br/>
      printf("%i ", tileMemory[a]);
<br/>
   }
<br/>
<br/>
   return 0;
<br/>
}</td> </tr></table><span class="postbody">As you can see, the code is a *very* simple modification to the arm9 template: Basically, filling an 8x8 tile with "6" and double checking if it's correctly written.
<br/>
<br/>
Output from no$gba :
<br/>
<a href="http://images3.hiboox.com/images/0108/mndr5vv4.gif">[Images not permitted - Click here to view it]</a>
<br/>
<br/>
Output from other emulators :
<br/>
<a href="http://images3.hiboox.com/images/0108/44pchn9d.gif">[Images not permitted - Click here to view it]</a>
<br/>
<br/>
Questions are :
<br/>
- has this anything to do some "volatile" memory ?
<br/>
- relating to the point above :
<br/>
  * is it a normal behaviour correctly implemented in no$gba (and as such something wrongly done on others)
<br/>
  * OR is it a bug in no$gba (which i should maybe report) ?
<br/>
- If i'm doing it wrong, how should i do it ?
<br/>
<br/>
I'm asking this here, because i don't like having different results for something so simple (code-wise).</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#148298 - Lick - Fri Jan 04, 2008 2:40 pm</h4>
    <div class="postbody"><span class="postbody">Don't write to the VRAM in bytes (u8). Use shorts (u16) or longs (u32). Also, use BG_TILE_RAM_SUB for the subscreen.<br/>_________________<br/><a class="postlink" href="http://licklick.wordpress.com" target="_blank">http://licklick.wordpress.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#148299 - nipil - Fri Jan 04, 2008 2:42 pm</h4>
    <div class="postbody"><span class="postbody">Fiddling with this, i made the following discovery :
<br/>
<br/>
- if i write directly to the (u8*)BG_TILE_RAM(1), "6" is reset to "0"
<br/>
- if i write the "6" to a temp buffer, and then copy it to memory using swiCopy, they is no reset
<br/>
<br/>
For info, I turned "main" display on &amp; off (is turned on below), no change.
<br/>
Now, with the swiCopy, i have a normal &amp; consistant behaviour.
<br/>
So... <span style="font-weight: bold"><span style="font-style: italic">What's the big difference between the 2 methods ?</span></span>
<br/>
<br/>
The actual code is now :
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#include &lt;nds.h&gt;
<br/>
#include &lt;stdio.h&gt;
<br/>
<br/>
int main(void) {
<br/>
   u8 a,i;
<br/>
<br/>
   videoSetMode(MODE_0_2D | DISPLAY_BG0_ACTIVE);
<br/>
   vramSetBankA(VRAM_A_MAIN_BG_0x06000000);
<br/>
   BG0_CR = BG_32x32 | BG_COLOR_256 | BG_MAP_BASE(0) | BG_TILE_BASE(1);
<br/>
   
<br/>
   videoSetModeSub(MODE_0_2D | DISPLAY_BG0_ACTIVE);
<br/>
   vramSetBankC(VRAM_C_SUB_BG);
<br/>
   SUB_BG0_CR = BG_MAP_BASE(31);
<br/>
   BG_PALETTE_SUB[255] = RGB15(31,31,31);
<br/>
   consoleInitDefault((u16*)SCREEN_BASE_BLOCK_SUB(31), (u16*)CHAR_BASE_BLOCK_SUB(0), 16);
<br/>
<br/>
   u8 temp[64];
<br/>
   u8 * tileMemory = (u8*)BG_TILE_RAM(1);
<br/>
   for (i = 0; i &lt; 64; i++) { temp[i] = 6; }
<br/>
   for (a = 0; a &lt; 64; a++) { iprintf("%i ", temp[a]); }
<br/>
   swiCopy(temp, tileMemory, 32);
<br/>
   for (a = 0; a &lt; 64; a++) { iprintf("%i ", tileMemory[a]); }
<br/>
   return 0;
<br/>
}</td> </tr></table><span class="postbody">I tend to think this might be a bug in no$gba... though i read it was quite reliable.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#148304 - nipil - Fri Jan 04, 2008 2:56 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Lick wrote:</b></span></td> </tr> <tr> <td class="quote">Don't write to the VRAM in bytes (u8). Use shorts (u16) or longs (u32).</td> </tr></table><span class="postbody">
<br/>
Argh, i wasn't aware of the 16/32 bits write. <span style="font-weight: bold">And now it works without swiCopy</span> :
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">   u16 * tileMemory = (u16*)BG_TILE_RAM(1);
<br/>
   for (i = 0; i &lt; 32; i++) {
<br/>
      tileMemory[i] = 0x0606;
<br/>
      printf("%04x ",tileMemory[i]);
<br/>
   }
<br/>
   for (a = 0; a &lt; 32; a++) {
<br/>
      printf("%04x ", tileMemory[a]);
<br/>
   }</td> </tr></table><span class="postbody">
<br/>
So, this means i cannot write to the VRAM in 8-bit mode ? (so 16bit writes for sprites, tiles, maps, framebuffer and so on ?)
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Lick wrote:</b></span></td> </tr> <tr> <td class="quote">Also, use BG_TILE_RAM_SUB for the subscreen.</td> </tr></table><span class="postbody">
<br/>
The tiles i'm writing in are to be displayed on the "main" screen (display "above" and "debug" on sub) that's why i chose BG_TILE_RAM. Should i change ?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#148305 - Peter - Fri Jan 04, 2008 3:01 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>nipilSo wrote:</b></span></td> </tr> <tr> <td class="quote">this means i cannot write to the VRAM in 8-bit mode ? (so 16bit writes for sprites, tiles, maps, framebuffer and so on ?)</td> </tr></table><span class="postbody">
<br/>
From GBATek:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>GBATek wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
All VRAM (and Palette, and OAM) can be written to only in 16bit and 32bit units (STRH, STR opcodes), 8bit writes are ignored (by STRB opcode). The only exception is "Plain &lt;ARM7&gt;-CPU Access" mode: The ARM7 CPU can use STRB to write to VRAM (the reason for this special feature is that, in GBA mode, two 128K VRAM blocks are used to emulate the GBA's 256K Work RAM).
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
See <a class="postlink" href="http://nocash.emubase.de/gbatek.htm" target="_blank">GBATek</a> chapter <span style="font-style: italic">DS Memory Control - VRAM</span> for more information.<br/>_________________<br/>Kind Regards,
<br/>
Peter</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#148369 - Lick - Sat Jan 05, 2008 1:50 am</h4>
    <div class="postbody"><span class="postbody">Nipil, in your first paste, you did not use the main screen. In your second paste, you do use it.
<br/>
<br/>
So disregard my suggestion, but remember that there's a BG_..._RAM() and a BG_..._RAM_SUB(). However, with bases there is only BG_..._BASE and <span style="font-weight: bold">no BG_..._BASE_SUB</span>.<br/>_________________<br/><a class="postlink" href="http://licklick.wordpress.com" target="_blank">http://licklick.wordpress.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#148450 - nipil - Sat Jan 05, 2008 10:14 pm</h4>
    <div class="postbody"><span class="postbody">So in file video.h i read :
<br/>
<br/>
323 #define BG_TILE_BASE(base) ((base) &lt;&lt; 2)
<br/>
324 #define BG_MAP_BASE(base)  ((base) &lt;&lt; 8)
<br/>
325 #define BG_BMP_BASE(base)  ((base) &lt;&lt; 8)
<br/>
<br/>
This means i use the same BG_*_BASE for both main and sub.
<br/>
<br/>
Got it, thanks !</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
