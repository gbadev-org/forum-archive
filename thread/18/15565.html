<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>something wrong with iprintf (r21) - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>DS development > something wrong with iprintf (r21)</h2>
<div id="posts">
<div class="post">
    <h4>#157203 - PypeBros - Tue May 20, 2008 9:55 am</h4>
    <div class="postbody"><span class="postbody">hey there.
<br/>
i'm migrating some of my software from devkitARM r20 to r21, and i noticed that iprintf() isn't working properly anymore. To put it clear: it doesn't print anything at all.
<br/>
<br/>
The font is there, calling consoleWriteChar('h') manually works, fprintf(stderr,"hello, world") works too, but i cannot get iprintf("hello, world") to work.
<br/>
<br/>
any clue ? I'm doing consoleInitDefault() as usual, too ...<br/>_________________<br/><a class="postlink" href="http://sylvainhb.blogspot.com/p/sprite-editor.html" target="_blank"> SEDS: Sprite Edition on DS</a> :: <a class="postlink" href="http://sylvainhb.blogspot.com/search/label/modplayer" target="_blank">modplayer</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#157207 - Maxxie - Tue May 20, 2008 11:05 am</h4>
    <div class="postbody"><span class="postbody">There was no problem for me when r21 was active here. However r21 is outdated.
<br/>
<br/>
Whenever iprintf fails on me i am quite sure that i have a stack problem somewhere. In 9/10th of all cases i went out of or corrupted the stack somehow.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#157209 - PypeBros - Tue May 20, 2008 11:18 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Maxxie wrote:</b></span></td> </tr> <tr> <td class="quote">There was no problem for me when r21 was active here. However r21 is outdated.</td> </tr></table><span class="postbody">
<br/>
(yeah, i know, i just can't keep up to date with devkitARM for those hobby projects ... )
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote"> Whenever iprintf fails on me i am quite sure that i have a stack problem somewhere. In 9/10th of all cases i went out of or corrupted the stack somehow.</td> </tr></table><span class="postbody">
<br/>
Straight ahead, i'd say it is unlikely to be the case here (even putting a 'hello' straight on the second line of the program doesn't show... i can't have messed up the stack *that* early), but thanks for the suggestion: i'll investigate anyway.
<br/>
<br/>
I was more thinking of some initialisation step going wrong (or being corrupted) somehow. I guess i'll just grab the sources and go for another "debugging session darker than the night" :P
<br/>
<br/>
oh, btw, i must mention that this is happening in C++ code.<br/>_________________<br/><a class="postlink" href="http://sylvainhb.blogspot.com/p/sprite-editor.html" target="_blank"> SEDS: Sprite Edition on DS</a> :: <a class="postlink" href="http://sylvainhb.blogspot.com/search/label/modplayer" target="_blank">modplayer</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#157210 - kusma - Tue May 20, 2008 11:26 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>PypeBros wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote"> Whenever iprintf fails on me i am quite sure that i have a stack problem somewhere. In 9/10th of all cases i went out of or corrupted the stack somehow.</td> </tr></table><span class="postbody">
<br/>
Straight ahead, i'd say it is unlikely to be the case here (even putting a 'hello' straight on the second line of the program doesn't show... i can't have messed up the stack *that* early)</span></td> </tr></table><span class="postbody">
<br/>
How did you manage to setup the console in just one line?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#157211 - PypeBros - Tue May 20, 2008 12:53 pm</h4>
    <div class="postbody"><span class="postbody">okay, line #1 was instaciation of the GuiEngine class that initialises the console and stuff.
<br/>
But that wasn't the point. Replacing it with consoleDemoInit(void) would do it one-liner too, which i did since i do not trust my own code in such case :P
<br/>
<br/>
Well, anyway, it turns out that iprintf is a wrapper around vfiprintf.c which is auto-generated out of vfprintf.c at compile-time (so i don't have any source for inspecting further), and that it's an 'integer-only' version of printf (which appear to be there and working even in crude environment). so i guess i'll just strip all those 'i's from my code, use regular (and working) printf and stop wondering.
<br/>
<br/>
If one day i find what was wrong, i'll come back and post the cause.<br/>_________________<br/><a class="postlink" href="http://sylvainhb.blogspot.com/p/sprite-editor.html" target="_blank"> SEDS: Sprite Edition on DS</a> :: <a class="postlink" href="http://sylvainhb.blogspot.com/search/label/modplayer" target="_blank">modplayer</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#157212 - kusma - Tue May 20, 2008 1:21 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>PypeBros wrote:</b></span></td> </tr> <tr> <td class="quote">okay, line #1 was instaciation of the GuiEngine class that initialises the console and stuff.
<br/>
</td> </tr></table><span class="postbody">
<br/>
Which totally makes it NOT being the second line of code in your application, only in your main-function. Which is a completely different thing :)
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">But that wasn't the point. Replacing it with consoleDemoInit(void) would do it one-liner too, which i did since i do not trust my own code in such case :P
<br/>
</td> </tr></table><span class="postbody">
<br/>
Would you mind posting the minimal code to reproduce this?
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Well, anyway, it turns out [...] so i guess i'll just strip all those 'i's from my code, use regular (and working) printf and stop wondering.
<br/>
</td> </tr></table><span class="postbody">
<br/>
Sounds like the best way of assuring any hidden bug WILL come back later and haunt you :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#157213 - PypeBros - Tue May 20, 2008 1:42 pm</h4>
    <div class="postbody"><span class="postbody">Well, you're right, and that's how i work usually ... debugging your debugging tools sometimes cannot let you go your usual ways. If it happens again with the regular printf, at least i'll have source code to study :P
<br/>
<br/>
anyway.
<br/>
<br/>
main.cpp:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#include &lt;nds.h&gt;
<br/>
#include &lt;nds/arm9/console.h&gt;
<br/>
#include &lt;fat.h&gt;
<br/>
#include &lt;stdio.h&gt;
<br/>
#include &lt;stdarg.h&gt;
<br/>
<br/>
<br/>
int main()
<br/>
{
<br/>
  defaultExceptionHandler();
<br/>
  BG0_CR = BG_MAP_BASE(28)|BG_TILE_BASE(0)|BG_PRIORITY(0);
<br/>
  videoSetMode(  MODE_0_2D | DISPLAY_BG0_ACTIVE);
<br/>
  vramSetMainBanks(   VRAM_A_MAIN_SPRITE,        // flat allocation: everything has 128K
<br/>
            VRAM_B_MAIN_BG_0x06000000,        
<br/>
            VRAM_C_SUB_BG_0x06200000,  //map C to background memory
<br/>
            VRAM_D_SUB_SPRITE
<br/>
            ); 
<br/>
  BG_PALETTE[0]=RGB15(0,0,0);
<br/>
  BG_PALETTE[255] = RGB15(31,31,31);//by default font rendered with color 255
<br/>
  BG_PALETTE[15] = RGB15(31,31,31);//by default font rendered with color 255
<br/>
  consoleInitDefault((u16*)SCREEN_BASE_BLOCK(28), (u16*)CHAR_BASE_BLOCK(0), 16);
<br/>
 
<br/>
  fatInitDefault();
<br/>
  iprintf("ready.\n"); // &lt;-- don't show up
<br/>
  va_list dummy;
<br/>
  vfiprintf(stdout,"don't work?",dummy); // &lt;-- don't show up either
<br/>
<br/>
  fprintf(stderr,"(or so it seems ...)\n"); // &lt;-- this one is fine.
<br/>
  fprintf(stdout,"(maybe that's just stdout going wrong?)\n"); // &lt;-- this one too.
<br/>
  while(1) {
<br/>
  }
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Makefile (yes, i'm using some custom ARM7 code, which shouldn't interfere with the observed problem, afaik)
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#---------------------------------------------------------------------------------
<br/>
.SUFFIXES:
<br/>
#---------------------------------------------------------------------------------
<br/>
ifeq ($(strip $(DEVKITARM)),)
<br/>
$(error "Please set DEVKITARM in your environment. export DEVKITARM=&lt;path to&gt;devkitARM")
<br/>
endif
<br/>
<br/>
include $(DEVKITARM)/ds_rules
<br/>
<br/>
ifeq ($(CURDIR)/build,$(shell pwd))
<br/>
@echo "we are in the 'build' directory"
<br/>
BASEDIR := ..
<br/>
else
<br/>
BASEDIR := $(CURDIR)
<br/>
endif
<br/>
<br/>
#---------------------------------------------------------------------------------
<br/>
# TARGET is the name of the output
<br/>
# BUILD is the directory where object files &amp; intermediate files will be placed
<br/>
# SOURCES is a list of directories containing source code
<br/>
# INCLUDES is a list of directories containing extra header files
<br/>
#---------------------------------------------------------------------------------
<br/>
TARGET      :=   $(shell basename $(CURDIR))
<br/>
BUILD      :=   build
<br/>
SOURCES      :=   source
<br/>
DATA      :=   data  
<br/>
INCLUDES   :=   ../include
<br/>
<br/>
#---------------------------------------------------------------------------------
<br/>
# options for code generation
<br/>
#---------------------------------------------------------------------------------
<br/>
ARCH   :=   -mthumb -mthumb-interwork
<br/>
<br/>
# note: arm9tdmi isn't the correct CPU arch, but anything newer and LD
<br/>
# *insists* it has a FPU or VFP, and it won't take no for an answer!
<br/>
CFLAGS   :=   -g -Wall -O2\
<br/>
         -march=armv5te -mtune=arm946e-s -fomit-frame-pointer\
<br/>
         -ffast-math \
<br/>
         $(ARCH)
<br/>
<br/>
CFLAGS   +=   $(INCLUDE) -DARM9
<br/>
CXXFLAGS   := $(CFLAGS) -fno-rtti -fno-exceptions
<br/>
<br/>
ASFLAGS   :=   -g $(ARCH)
<br/>
LDFLAGS   =   -specs=ds_arm9.specs -g $(ARCH) -mno-fpu -Wall -Xlinker -Map -Xlinker test.map
<br/>
<br/>
#---------------------------------------------------------------------------------
<br/>
# any extra libraries we wish to link with the project
<br/>
#---------------------------------------------------------------------------------
<br/>
# for some unknown reasons, i may not put NDS9 ahead of my own lib :?
<br/>
LIBS := -lfat -lnds9
<br/>
<br/>
<br/>
#---------------------------------------------------------------------------------
<br/>
# list of directories containing libraries, this must be the top level containing
<br/>
# include and lib
<br/>
#---------------------------------------------------------------------------------
<br/>
LIBDIRS   :=   $(LIBNDS)
<br/>
<br/>
#---------------------------------------------------------------------------------
<br/>
# no real need to edit anything past this point unless you need to add additional
<br/>
# rules for different file extensions
<br/>
#---------------------------------------------------------------------------------
<br/>
ifneq ($(BUILD),$(notdir $(CURDIR)))
<br/>
#---------------------------------------------------------------------------------
<br/>
<br/>
export OUTPUT   :=   $(BASEDIR)/$(TARGET)
<br/>
<br/>
export VPATH   :=   $(foreach dir,$(SOURCES),$(BASEDIR)/$(dir)) \
<br/>
               $(foreach dir,$(DATA),$(BASEDIR)/$(dir))
<br/>
<br/>
export DEPSDIR   :=   $(BASEDIR)/$(BUILD)
<br/>
<br/>
CFILES      :=   $(foreach dir,$(SOURCES),$(notdir $(wildcard $(dir)/*.c)))
<br/>
CPPFILES   :=   $(foreach dir,$(SOURCES),$(notdir $(wildcard $(dir)/*.cpp)))
<br/>
SFILES      :=   $(foreach dir,$(SOURCES),$(notdir $(wildcard $(dir)/*.s)))
<br/>
BINFILES   :=   $(foreach dir,$(DATA),$(notdir $(wildcard $(dir)/*.*)))
<br/>
<br/>
#---------------------------------------------------------------------------------
<br/>
# use CXX for linking C++ projects, CC for standard C
<br/>
#---------------------------------------------------------------------------------
<br/>
ifeq ($(strip $(CPPFILES)),)
<br/>
#---------------------------------------------------------------------------------
<br/>
   export LD   :=   $(CC)
<br/>
#---------------------------------------------------------------------------------
<br/>
else
<br/>
#---------------------------------------------------------------------------------
<br/>
   export LD   :=   $(CXX)
<br/>
#---------------------------------------------------------------------------------
<br/>
endif
<br/>
#---------------------------------------------------------------------------------
<br/>
<br/>
export OFILES   :=   $(addsuffix .o,$(BINFILES)) \
<br/>
         $(CPPFILES:.cpp=.o) $(CFILES:.c=.o) $(SFILES:.s=.o)
<br/>
<br/>
export INCLUDE   :=   $(foreach dir,$(INCLUDES),-I$(BASEDIR)/$(dir)) \
<br/>
               $(foreach dir,$(LIBDIRS),-I$(dir)/include) \
<br/>
               $(foreach dir,$(LIBDIRS),-I$(dir)/include) \
<br/>
               -I$(BASEDIR)/$(BUILD)
<br/>
<br/>
export LIBPATHS   :=   $(foreach dir,$(LIBDIRS),-L$(dir)/lib)
<br/>
<br/>
.PHONY: $(BUILD) clean all
<br/>
#---------------------------------------------------------------------------------
<br/>
$(BUILD):
<br/>
   @echo "adds $(BASEDIR)/$(BUILD) if doesn't exists"
<br/>
   @echo "VPATH = $(VPATH)"
<br/>
   @[ -d $@ ] || mkdir -p $@
<br/>
   @make -C $(BUILD) -f $(CURDIR)/Makefile
<br/>
   @echo "back to `pwd`"
<br/>
all: $(BUILD)
<br/>
<br/>
#---------------------------------------------------------------------------------
<br/>
clean:
<br/>
   @echo clean ...
<br/>
   @rm -fr $(BUILD) $(TARGET).elf $(TARGET).nds $(TARGET).arm9 $(TARGET).ds.gba 
<br/>
<br/>
install:
<br/>
   rsync $(TARGET).nds $(REPOSITORY)/justatest.nds
<br/>
<br/>
#---------------------------------------------------------------------------------
<br/>
else
<br/>
<br/>
DEPENDS   :=   $(OFILES:.o=.d)
<br/>
all: $(OUTPUT).nds
<br/>
<br/>
#---------------------------------------------------------------------------------
<br/>
# main targets
<br/>
#---------------------------------------------------------------------------------
<br/>
$(OUTPUT).ds.gba   :    $(OUTPUT).nds
<br/>
$(OUTPUT).nds   :    $(OUTPUT).arm9 ../../lib/ppp.arm7
<br/>
   ndstool   -c $(OUTPUT).nds -7 ../../lib/ppp.arm7 -9 $(OUTPUT).arm9
<br/>
$(OUTPUT).arm9   :   $(OUTPUT).elf
<br/>
$(OUTPUT).elf   :   $(OFILES) ../../lib/libpppds.a ../../lib/libgeds.a
<br/>
<br/>
#---------------------------------------------------------------------------------
<br/>
%.bin.o   :   %.bin
<br/>
#---------------------------------------------------------------------------------
<br/>
   @echo $(notdir $&lt;)
<br/>
   @$(bin2o)
<br/>
<br/>
-include $(DEPENDS)
<br/>
<br/>
<br/>
#---------------------------------------------------------------------------------------
<br/>
endif
<br/>
#---------------------------------------------------------------------------------------
<br/>
</td> </tr></table><span class="postbody"><br/>_________________<br/><a class="postlink" href="http://sylvainhb.blogspot.com/p/sprite-editor.html" target="_blank"> SEDS: Sprite Edition on DS</a> :: <a class="postlink" href="http://sylvainhb.blogspot.com/search/label/modplayer" target="_blank">modplayer</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#157231 - Quirky - Tue May 20, 2008 8:54 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>PypeBros wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
anyway.
<br/>
<br/>
main.cpp:</td> </tr></table><span class="postbody">
<br/>
<br/>
That exact code copy pasted over the hello world example from devkitpro works with dka r21 here. I even checked on hardware. I'd search for the bug in <a class="postlink" href="http://www.codinghorror.com/blog/archives/001079.html" target="_blank">your own code</a> before cracking open printf.c.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#157354 - PypeBros - Thu May 22, 2008 12:57 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quirky wrote:</b></span></td> </tr> <tr> <td class="quote">That exact code copy pasted over the hello world example from devkitpro works with dka r21 here.</td> </tr></table><span class="postbody">
<br/>
not much surprising. The error is most likely coming from some odd libraries combination (maybe some symbols wrongly linked) than really from a bug in iprintf.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">I'd search for the bug in <a class="postlink" href="http://www.codinghorror.com/blog/archives/001079.html" target="_blank">your own code</a> before cracking open printf.c.</td> </tr></table><span class="postbody">
<br/>
Well, i realise now how this could sound to you. I'm not suspecting some bug in the newlib, rather something i don't know about iprintf that could make it behave differently from fprintf, and how and why, so that i can go further investigating what in my code broke the library. That's usually how i'm debugging things.
<br/>
<br/>
Anyway, without the sources for that specific file, i can't investigate that way further, so my only chance is to increase warning levels (-Weffc++ added), do another pass of code refactoring and hope better luck.<br/>_________________<br/><a class="postlink" href="http://sylvainhb.blogspot.com/p/sprite-editor.html" target="_blank"> SEDS: Sprite Edition on DS</a> :: <a class="postlink" href="http://sylvainhb.blogspot.com/search/label/modplayer" target="_blank">modplayer</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#157357 - PypeBros - Thu May 22, 2008 1:16 pm</h4>
    <div class="postbody"><span class="postbody">oooow. 
<br/>
comparing one of my older program that was still working and the one causing troubles, i realised the only difference comes from defaultExceptionHandler() to be called either before or after consoleInitDefault()..
<br/>
<br/>
And i happen to have hacked defaultExceptionHandler() for my own purposes, and "casually" placed a iprintf("beware the guru") in that function.
<br/>
<br/>
So apparently, if iprintf() is called before consoleInitDefault(), all the further calls to iprintf() will fail to display anything ... i'd have expected something similar with printf() being called earlier causing further printf() to fail, but no. calling printf() before consoleInitDefault() also makes iprintf() not to work... weirder and weirder.
<br/>
<br/>
Expect more from PypeBros in Wonderland++ to come soon :P<br/>_________________<br/><a class="postlink" href="http://sylvainhb.blogspot.com/p/sprite-editor.html" target="_blank"> SEDS: Sprite Edition on DS</a> :: <a class="postlink" href="http://sylvainhb.blogspot.com/search/label/modplayer" target="_blank">modplayer</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#157370 - Quirky - Thu May 22, 2008 8:56 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>PypeBros wrote:</b></span></td> </tr> <tr> <td class="quote">oooow. 
<br/>
&lt;snip&gt;
<br/>
Expect more from PypeBros in Wonderland++ to come soon :P</td> </tr></table><span class="postbody">
<br/>
<br/>
That is odd, but then "undefined behaviour" tends to result in odd things happening. At least you found the problem and told us about your mini-blunder. Respect. :-)
<br/>
<br/>
(I prefer just to keep quiet about things - <a class="postlink" href="http://forum.gbadev.org/viewtopic.php?t=14385#143638" target="_blank">last time I made a song and dance about an error</a>, it was all my fault ;-))</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
