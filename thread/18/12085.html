<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>NDS ROM Internal FAT? - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > NDS ROM Internal FAT?</h2>
<div id="posts">
<div class="post">
    <h4>#114229 - cheapo - Fri Jan 05, 2007 4:45 pm</h4>
    <div class="postbody"><span class="postbody">Hello all!
<br/>
<br/>
I'm sorry if this is a dumb question, I'm fairly new to the DS development. Been playing with PALib for a while, now I decided to learn more about the DS hardware and start developing only using DKP/libnds.
<br/>
<br/>
It's known that NDS commercial ROMs have an internal filesystem, and that we're able to create/extract files from this filesystem via ndstool, right? 
<br/>
<br/>
So why isn't there a lib to read/write to this filesystem using libnds? Is that because no one did it yet or is there something more, like something commercial ROMs can do that homebrew can't?
<br/>
<br/>
I've been asking myself this for quite a while, so I decided to ask you guys hoping I can understand  the reason.
<br/>
<br/>
Thanks a lot!<br/>_________________<br/>There's no place like 127.0.0.1</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#114235 - Sausage Boy - Fri Jan 05, 2007 5:47 pm</h4>
    <div class="postbody"><span class="postbody">Most pirate rom patching tools rely on finding exact Nintendo code, so they wouldn't be able to patch homebrew even if we made a library. That means the program would run on very few devices. Also, you can't write to that filesystem from games.
<br/>
<br/>
Why use a filesystem with less features that works on less devices than what we already have (libfat)?<br/>_________________<br/>"no offense, but this is the gayest game ever"</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#114236 - cheapo - Fri Jan 05, 2007 5:58 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Sausage Boy wrote:</b></span></td> </tr> <tr> <td class="quote">Most pirate rom patching tools rely on finding exact Nintendo code, so they wouldn't be able to patch homebrew even if we made a library. That means the program would run on very few devices. Also, you can't write to that filesystem from games.</td> </tr></table><span class="postbody">
<br/>
<br/>
Well, that's something I didn't know. So <span style="font-weight: bold">if</span> there was a library to read this kind of filesystem the NDS would need to be patched to work on flashcarts?
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Sausage Boy wrote:</b></span></td> </tr> <tr> <td class="quote">Why use a filesystem with less features that works on less devices than what we already have (libfat)?</td> </tr></table><span class="postbody">
<br/>
<br/>
The idea would be to have all files my game needs to read (like images, sounds, etc) inside the NDS itself (no need to manually copy files to your card, much like a commercial ROM), but without using the 4MB memory we use for code. I know I could do this with GBFS for example, but it wouldn't work on carts without 32MB GBA RAM and Slot-1, right?<br/>_________________<br/>There's no place like 127.0.0.1</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#114239 - josath - Fri Jan 05, 2007 6:19 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>cheapo wrote:</b></span></td> </tr> <tr> <td class="quote">The idea would be to have all files my game needs to read (like images, sounds, etc) inside the NDS itself (no need to manually copy files to your card, much like a commercial ROM), but without using the 4MB memory we use for code. I know I could do this with GBFS for example, but it wouldn't work on carts without 32MB GBA RAM and Slot-1, right?</td> </tr></table><span class="postbody">
<br/>
<br/>
There is currently no good way to do this. Even if you were to write homebrew code to access the NITRO FAT, which can be embedded in a .nds, it most likely wouldn't work on most flashcarts, because as mentioned above, the pirate patchers look for very specific nintendo code, instead of actually emulating a DS cart.
<br/>
<br/>
One possibility I've toyed with is this:
<br/>
<br/>
1. Attach appended GBFS
<br/>
2. If cart has GBAROM space, simply use it as normal
<br/>
3. If not, use libfat and fopen("mygame.nds"), and use fread(), fseek(), etc to read from the appended GBFS
<br/>
<br/>
There is only one downside to step 3: There is no way AFAIK to find out what .nds file you are running. Thus there are two options:
<br/>
A. Make sure the user never renames your .NDS file, and force them to place it on the root of the card. DOWNSIDE: Some people like to rename their files, or place them in directories.
<br/>
B. Scan through their entire cart, looking at the header of each .NDS file until you find the correct one. DOWNSIDE: Slow if many files on the cart, possibly some extra work / problems, if they have multiple versions of your NDS on their cart
<br/>
<br/>
Sidenote: Everywhere you see GBFS mentioned, you can also use romfs (aka romdiskfs). It is slightly more complex, but a more flexible. (longer filenames, directory support, etc). 
<br/>
<a class="postlink" href="http://dev-scene.com/NDS/DOCfilesystems" target="_blank">Here's a quick overview of various filesystems</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#114241 - Lynx - Fri Jan 05, 2007 7:06 pm</h4>
    <div class="postbody"><span class="postbody">I think what you are getting at is the same as <a class="postlink" href="http://forum.gbadev.org/viewtopic.php?t=11820" target="_blank">THIS TOPIC</a> which is reguarding dynamically loading data into the 4MB RAM space.  and then some how turned into an OS at which case I lost interest as we already have DSLinux if I wanted an OS..
<br/>
<br/>
Anyway, as I posted in that thread, I believe there are two ways to directly do what you are speaking of.  One, the hard way, would be to hard code addresses into your .nds file that keeps a specific range saved for managing data, and then the "rest" of the 4MB space for loading your data in and out.  And then the second way, easy cause it uses magic, is to have a library that would create the address pointers for you when you compiled your code.<br/>_________________<br/><a class="postlink" href="http://www.ndshb.com" target="_blank">NDS Homebrew Roms &amp; Reviews</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#114251 - josath - Fri Jan 05, 2007 9:13 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Lynx wrote:</b></span></td> </tr> <tr> <td class="quote">I think what you are getting at is the same as <a class="postlink" href="http://forum.gbadev.org/viewtopic.php?t=11820" target="_blank">THIS TOPIC</a> which is reguarding dynamically loading data into the 4MB RAM space.  and then some how turned into an OS at which case I lost interest as we already have DSLinux if I wanted an OS..</td> </tr></table><span class="postbody">
<br/>
<br/>
That is not quite what cheapo was asking, I think he is only worried about data assets, non-executable stuff. For these you don't need any linker trickery or fancy OS coding or anything. Just the ability to do stuff like loadSprite("gfx/playerman.pcx");
<br/>
<br/>
Basically, the case where you want a NDS &gt; 4MB, but still works on GBAMP and Slot-1 devices. (and also don't want to have the files cluttering up the card, but instead all embedded in the .nds)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#114610 - Payk - Tue Jan 09, 2007 2:57 pm</h4>
    <div class="postbody"><span class="postbody">I realy can understand that thing. Its just handy to have one rom, just as we all know it from handhelds/consoles. It has advantages too.
<br/>
<br/>
-I got a 7.5MB folder with lots of textures. If i use fat for my game, and want to update datas it loads about 50 files to sd card. That takes about 2-3 minutes! If i use KOSFS instead, i just copy a 7.5MB rom to SD card within 20 sec.
<br/>
<br/>
-It doesnt matter in which folder or subfolder the rom with attached datas are, it doesnt change internal paths or something. Its much more flexible and easier to archivate
<br/>
<br/>
-And most important is of course, that it isnt THAT easy to change/rip content. I guess that ?ersons who can do that, also could write their own games. So ppl wpuld feel more secure when releasing roms with textures/music.
<br/>
<br/>
But yeah that all doesnt work on slot1 solucions. Thats why i still prefer slot2. That manufactures could have made a homebrew patcher which redirects each GBA-ROMACCES to their EEPROM....But no one did that.
<br/>
<br/>
Libfat looks cool too, but i got (like i said) 50 files and a folderstructure which i want to keep alive. Its pretty s...y that only fatlib and kos are usable for my game in a handy way. I hope we will see another solution soon.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#114644 - Sunray - Tue Jan 09, 2007 7:02 pm</h4>
    <div class="postbody"><span class="postbody">Well, I use GBFS to create a data file which is stored as a regular fat file. So I have project.nds and project.data. Internally I just open the data file and search using the GBFS header. If the file wasnt found I try to open it as an external fat file.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#114846 - cheapo - Thu Jan 11, 2007 1:48 am</h4>
    <div class="postbody"><span class="postbody">Probably silly question: if I make a homebrew and generate a NDS using ndstool with some files together (using ndstool ability to create Nitro-FAT) and put it inside some slot-1 device (no patching), is there a memory address I can access the (read-only) FAT, in raw mode?<br/>_________________<br/>There's no place like 127.0.0.1</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#114852 - Lynx - Thu Jan 11, 2007 3:50 am</h4>
    <div class="postbody"><span class="postbody">Nope, Slot-1 isn't directly addressable.  You'll have to swap RAM like official games.<br/>_________________<br/><a class="postlink" href="http://www.ndshb.com" target="_blank">NDS Homebrew Roms &amp; Reviews</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#114895 - cheapo - Thu Jan 11, 2007 11:21 am</h4>
    <div class="postbody"><span class="postbody">Can you point me to any information about swapping RAM, so I can understand what does it mean?<br/>_________________<br/>There's no place like 127.0.0.1</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#114898 - Payk - Thu Jan 11, 2007 12:04 pm</h4>
    <div class="postbody"><span class="postbody">Sunray:
<br/>
Quite cool idea but still no folder structure. I am thinking about adding a file for a pseudo folder structure, and add a lib which then access it with stdio functions. But thats much work. There is already a KOSFS. It would be cool to make it working with FAT. I watched the source and i am sure that dont wanna do that :D
<br/>
Anyone likes to do that?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#115021 - Lynx - Fri Jan 12, 2007 7:20 am</h4>
    <div class="postbody"><span class="postbody">Cheapo, that's the problem.  Currently nobody is doing it, which is why we have this topic and the topic I linked to earlier.  I still believe everyone wants the same results overall.<br/>_________________<br/><a class="postlink" href="http://www.ndshb.com" target="_blank">NDS Homebrew Roms &amp; Reviews</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#115023 - tepples - Fri Jan 12, 2007 8:00 am</h4>
    <div class="postbody"><span class="postbody">"swapping RAM": First you load the GBFS file's header and directory from disk into RAM. Then whenever you want to load an object from GBFS, you read the offset and size from the directory, malloc() that much space, seek in the file, and load it in. Should I make a wrapper to load GBFS from stdio as a proof of concept of how GBFS could fit into a program that uses libfat?<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#115042 - Payk - Fri Jan 12, 2007 1:49 pm</h4>
    <div class="postbody"><span class="postbody">Yeah that would be very cool. Best would be with dirrectorys and encryption (xor or something...very simple save)
<br/>
<br/>
And yeah that "ram swapping" isnt not any problem in anykind. As you said you just load the adresses of files which should be 32bit per file into ram. The rest is just load what you need. You would do same with fat, too.
<br/>
But GBFS in the GBA-ROMSPACE has a great advantage. You can dirrectly point to it. If you point to it, the entiry file doesnt have to be in RAM, too.
<br/>
Thats what makes cardridge so unique :D</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#115048 - cheapo - Fri Jan 12, 2007 2:36 pm</h4>
    <div class="postbody"><span class="postbody">Okay, so commercial GBA games can store up to 32 MB in ROM and read it directly, with no swapping, right?
<br/>
<br/>
But NDS commercial games do RAM swapping in order to read the contents below the program (which is limited to 4MB and placed in RAM). So, how do commercial games read these contents (the files inside Nitro-FAT) to put it in RAM and use it?
<br/>
<br/>
Is homebrew able to do something similar, for example, inside an emulator (where no patch is applied to the NDS ROM)? Even as a proof-of-concept, is there a way to reach the contents of the NDS file below program data inside an emulator?<br/>_________________<br/>There's no place like 127.0.0.1</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#115102 - josath - Sat Jan 13, 2007 12:28 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tepples wrote:</b></span></td> </tr> <tr> <td class="quote">"swapping RAM": First you load the GBFS file's header and directory from disk into RAM. Then whenever you want to load an object from GBFS, you read the offset and size from the directory, malloc() that much space, seek in the file, and load it in. Should I make a wrapper to load GBFS from stdio as a proof of concept of how GBFS could fit into a program that uses libfat?</td> </tr></table><span class="postbody">
<br/>
<br/>
Yes please, I know of a couple people that would use it. I tried hacking something similar, but it was a bit buggy.
<br/>
<br/>
Now if only we had a solution to the problem of knowing where to load the GBFS file from -- currently there is no easy way of knowing which .NDS file was launched from the media card.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#115125 - HyperHacker - Sat Jan 13, 2007 4:07 am</h4>
    <div class="postbody"><span class="postbody">Well the easiest way would be for launchers to just leave the path in memory somewhere. I was thinking too it might be possible to pass parameters to the app's Main(), which would allow a standard argc/argv system to be used.<br/>_________________<br/>I'm a PSP hacker now, but I still &lt;3 DS.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#115135 - josath - Sat Jan 13, 2007 5:04 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>HyperHacker wrote:</b></span></td> </tr> <tr> <td class="quote">Well the easiest way would be for launchers to just leave the path in memory somewhere. I was thinking too it might be possible to pass parameters to the app's Main(), which would allow a standard argc/argv system to be used.</td> </tr></table><span class="postbody">
<br/>
There are soo many launchers though (almost every flashcart has it's own). That means we'd have to get them all to agree on where to put it, then get the users to use the new launchers.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#115138 - amphoterous - Sat Jan 13, 2007 5:19 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>josath wrote:</b></span></td> </tr> <tr> <td class="quote">There are soo many launchers though (almost every flashcart has it's own). That means we'd have to get them all to agree on where to put it, then get the users to use the new launchers.</td> </tr></table><span class="postbody">
<br/>
<br/>
Better now than never? I believe that homebrew is all about collaboration and I hope that something on this scale could be done.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#115139 - tepples - Sat Jan 13, 2007 5:28 am</h4>
    <div class="postbody"><span class="postbody">If you build it, they will come. Or at least Chishm thinks so with DLDI.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#115241 - Lynx - Sun Jan 14, 2007 2:41 am</h4>
    <div class="postbody"><span class="postbody">Well, I think it worked with the FATlib.. :)  I'm sure if someone put together something like this, people would definatly use it.<br/>_________________<br/><a class="postlink" href="http://www.ndshb.com" target="_blank">NDS Homebrew Roms &amp; Reviews</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#115246 - josath - Sun Jan 14, 2007 3:59 am</h4>
    <div class="postbody"><span class="postbody">The difference being that DLDI / fatlib changes, do not require changes to the firmware of the flashcarts. Using the new DLDI makes your homebrew more compatible, using a feature not supported by all flashcarts would make it less compatible (though perhaps it would pressure the flashcart makers into complying with the standard)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#115306 - Lynx - Sun Jan 14, 2007 10:50 pm</h4>
    <div class="postbody"><span class="postbody">You lost me.. What feature is not available from all fashcarts?  If you think commercial card providers will add a "feature" to their software, you'll be waiting a LONG TIME!  They don't give a crap about homebrew compatibility.  But, if there was a "universal" launcher (code, I mean) that all homebrewers could easily use, or it was added to DevkitPro, then it would work, as people compliling their homebrew would have the "feature" anyway.
<br/>
<br/>
Of course, the downside would be that when your supercard (insert any commercial loader here) menu comes up, you'd have to launch a homebrew app for launching everything else.  So, would people be willing to double "launch" to be able to play their favorite homebrew with the capabilities we are talking about?  Dunno.<br/>_________________<br/><a class="postlink" href="http://www.ndshb.com" target="_blank">NDS Homebrew Roms &amp; Reviews</a></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
