<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>FPS calculation - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>DS development > FPS calculation</h2>
<div id="posts">
<div class="post">
    <h4>#152849 - ghuldan - Fri Mar 21, 2008 5:33 pm</h4>
    <div class="postbody"><span class="postbody">Hi everyone,
<br/>
<br/>
Here is my code to calculate fps : 
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#define TICK ( (TIMER1_DATA &gt;&gt; 5) + (TIMER2_DATA &lt;&lt; 11) )
<br/>
<br/>
TIMER1_DATA = 0;
<br/>
TIMER2_DATA = 0;
<br/>
TIMER1_CR = TIMER_DIV_1024 | TIMER_ENABLE;
<br/>
TIMER2_CR = TIMER_CASCADE | TIMER_ENABLE;
<br/>
<br/>
while (1) {
<br/>
   u32 start = TICK;
<br/>
   
<br/>
   ... doing stuff
<br/>
   
<br/>
   PA_WaitForVBL();
<br/>
   
<br/>
   u32 end = TICK - start;
<br/>
   
<br/>
   PA_OutputText(1, 0, 22, "FPS: %d   ", 1000 / end);
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
Putting it that way, i got 58fps while desmume running at 7fps
<br/>
<br/>
Putting <span style="font-weight: bold">PA_WaitForVBL();</span> after <span style="font-weight: bold">PA_OutputText</span>, and i got 250fps while desmume running at 7fps.
<br/>
<br/>
What does it means actually ? Is desmume so slow ? Or am i wrong in my FPS calculation ? If not, would it means that code would run at my FPS on real hardware ?
<br/>
<br/>
Thanks a lot.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#152851 - Lazy1 - Fri Mar 21, 2008 5:50 pm</h4>
    <div class="postbody"><span class="postbody">Easier way to calculate frames per second...
<br/>
<br/>
Global variables:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
int FramesDrawn = 0;
<br/>
int VBlanks = 0;
<br/>
int FPS = 0;
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
VBlank handler:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
void IRQVBlank( void ) {
<br/>
   if ( VBlanks == 60 ) {
<br/>
      FPS = FramesDrawn;
<br/>
<br/>
      FramesDrawn = 0;
<br/>
      VBlanks = 0;
<br/>
   }
<br/>
<br/>
   VBlanks++;
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Main loop:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
while ( 1 ) {
<br/>
   // Do some stuff
<br/>
   FramesDrawn++;
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Then your current framerate will be in the FPS variable and you don't need to use timers.
<br/>
I just typed this in the reply box so it might not work right off the bat.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#152852 - simonjhall - Fri Mar 21, 2008 6:34 pm</h4>
    <div class="postbody"><span class="postbody">Huh. Never thought of doing it like that! I normally time how long one frame takes and then average that over a few frames (eg 20-100).<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#152896 - Programix - Sat Mar 22, 2008 9:27 am</h4>
    <div class="postbody"><span class="postbody">If you are using PAlib, you can use PA_RTC.FPS for getting fps ^^<br/>_________________<br/><a class="postlink" href="http://www.programix.info" target="_blank">My blog</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#152933 - HyperHacker - Sat Mar 22, 2008 11:29 pm</h4>
    <div class="postbody"><span class="postbody">VBlanks may as well be a static local variable of the VBlank handler.<br/>_________________<br/>I'm a PSP hacker now, but I still &lt;3 DS.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#153124 - ghuldan - Tue Mar 25, 2008 10:47 am</h4>
    <div class="postbody"><span class="postbody">Hi everyone, thanks for for your help.
<br/>
<br/>
1) PA_RTC.FPS return 0 for me ...
<br/>
<br/>
2) I tried the IRQVBlank thing but it's staying at 0;
<br/>
Tried to put VBlanks in global and static local ...
<br/>
<br/>
One thing i wonder, how do the program "knows" it must launch IRQVBlank after each VBlank ? Is there anything else to set set up to make it work ? I'm not good with Interrupts.
<br/>
<br/>
In addition, i heard libfat shouldnt be used with interrupt ... I'm using libfat and will always use it ... so ?
<br/>
<br/>
I understand my calculation is wrong to be used with libfat because of the timer dependance but, this FPS calculation is not required to be that much sharp for me, i know when libfat is called when i manipulate my homebrew and i know when it is not used. So initially i wanted to know if, with this calculation would mean my program would run at my FPS on real hardware ?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#153126 - Programix - Tue Mar 25, 2008 12:06 pm</h4>
    <div class="postbody"><span class="postbody">PA_RTC.FPS works only if you put PA_InitVBL() on start of the program and if you are calling PA_WaitForVBL() every frame. Hope it helps :)<br/>_________________<br/><a class="postlink" href="http://www.programix.info" target="_blank">My blog</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#153133 - silent_code - Tue Mar 25, 2008 1:54 pm</h4>
    <div class="postbody"><span class="postbody">it dosn't "know". interrupts are fired by the hw and are "interrupting" normal code execution to handle the interrupt event. ;^)
<br/>
btw.: software interrupts also exist (in general).</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#153134 - ghuldan - Tue Mar 25, 2008 1:58 pm</h4>
    <div class="postbody"><span class="postbody">but how can it "knows" to launch void IRQVBlank(void) each VBlank here and not another procedure ? Is there anything to set in registeries before ?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#153135 - ghuldan - Tue Mar 25, 2008 1:59 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Programix wrote:</b></span></td> </tr> <tr> <td class="quote">PA_RTC.FPS works only if you put PA_InitVBL() on start of the program and if you are calling PA_WaitForVBL() every frame. Hope it helps :)</td> </tr></table><span class="postbody">
<br/>
<br/>
Both are in my code ... and it does not work for me.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#153137 - silent_code - Tue Mar 25, 2008 2:06 pm</h4>
    <div class="postbody"><span class="postbody">ah!
<br/>
you need to set it up!
<br/>
<br/>
	irqInit();
<br/>
	irqSet(IRQ_VBLANK, drawOnIRQ);
<br/>
	irqEnable(IRQ_VBLANK);
<br/>
<br/>
happy coding! :^)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#153138 - ghuldan - Tue Mar 25, 2008 2:44 pm</h4>
    <div class="postbody"><span class="postbody">I ran some test : 
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
void IRQVBlank() {
<br/>
   
<br/>
   FPS++;
<br/>
}
<br/>
<br/>
irqInit();
<br/>
irqSet(IRQ_VBLANK, IRQVBlank);
<br/>
irqEnable(IRQ_VBLANK);
<br/>
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
then i write FPS each loop.
<br/>
It appears IRQVBlank() is called only one time ...
<br/>
<span style="text-decoration: underline">I use libfat </span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#153140 - simonjhall - Tue Mar 25, 2008 2:48 pm</h4>
    <div class="postbody"><span class="postbody">Try putting a printf in the vblank handler instead.
<br/>
Also, make sure the variable that you're incrementing in the handler is volatile. If the main loop that you check the variable in is small enough then there's a chance that the value won't be updated in the local copy.<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#153149 - Lazy1 - Tue Mar 25, 2008 6:50 pm</h4>
    <div class="postbody"><span class="postbody">This raises an interesting point actually, if newlib is not interrupt safe then really you should not be calling printf in the vblank handler.
<br/>
One way around that would be to make a printf wrapper which disables the vblank interrupt, calls printf and re-enables vblank.
<br/>
<br/>
Sounds kinda hacky though, what is the proper way to handle this anyway?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#153153 - simonjhall - Tue Mar 25, 2008 7:24 pm</h4>
    <div class="postbody"><span class="postbody">If you never use newlib stuff in your main thread and only ever use it in interrupt handlers you should be alright ;-)
<br/>
Though seriously, the interrupt handlers aren't nested and only the main thread can be paused mid-execution so this should be fine, right?
<br/>
<br/>
But I realise that in more complex programs it may not feasible to do nothing in your main thread*, so I always stick locks around juicy stuff like file access.
<br/>
<br/>
<span style="font-size: 9px; line-height: normal">*no, I don't want some dull example of how old games were written entirely in their hblank interrupt</span><br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
