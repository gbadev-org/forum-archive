<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>30 FPS due to Graphics Command FIFO stall? (Renamed) - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > 30 FPS due to Graphics Command FIFO stall? (Renamed)</h2>
<div id="posts">
<div class="post">
    <h4>#159547 - silent_code - Wed Jul 02, 2008 2:19 pm</h4>
    <div class="postbody"><span class="postbody">Hell-ow!
<br/>
<br/>
In the new demo I'm currently working on, which is based on the VSD (using devkitARM R23b and libnds 20071023) I released earlier, I get 30 FPS when enabling lighting...
<br/>
<br/>
That seems odd, because I'm only using one light, which is only set once at the start of the frame. Material propperties are only set four times (at max.) throughout the frame and I'm not hitting any hard limits - neither primitive / vertex list RAM (around 1400 triangles and 4200 vertices), nor rendering buffer lines (46 free in last frame, which is the max., as two of the 48 lines available are always getting filled, it seems)...
<br/>
<br/>
It's regardless weather the default specular table is being used (bit 15 in the specular / emissive color word of the material command) ect.
<br/>
Disabling lighting, the frame rate pops back to 60.
<br/>
Nothing fancy is involved, nothing else gets disabled, just the lighting.
<br/>
<br/>
Does anyone have a clue why that happens? The hardware is supposed to display scenes at 60 Herz with all features enabled and a fully filled pipeline, that means maxing out the throughput with as much geometry as supported by the hardware.
<br/>
<br/>
I guess I'll have to investigate that a little further, right?<br/>_________________<br/><span style="font-size: 9px; line-height: normal"><span style="text-decoration: underline"><span style="font-weight: bold"></span></span> July 5th 08: "<span style="font-weight: bold">Volumetric Shadow Demo</span>" 1.6.0 (final) source released
<br/>
June 5th 08: "<span style="font-weight: bold">Zombie NDS</span>" WIP released!
<br/>
It's all on my page, just click <span style="font-weight: bold">WWW</span> below.</span></span><span class="gensmall"><br/><br/>Last edited by silent_code on Wed Jul 02, 2008 10:04 pm; edited 3 times in total</span></div>    
</div>
<div class="post">
    <h4>#159549 - elhobbs - Wed Jul 02, 2008 2:58 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>silent_code wrote:</b></span></td> </tr> <tr> <td class="quote">Does anyone have a clue why that happens? The hardware is supposed to display scenes at 60 Herz with all features enabled and a fully filled pipeline, that means maxing out the throughput with as much geometry as supported by the hardware.
<br/>
<br/>
I guess I'll have to investigate that a little further, right?</td> </tr></table><span class="postbody">I am not sure that statement is accurate. I think I remember reading something along the lines that it is possible to overload the geometry engine if there are too many objects on a scanline, even if the total number of polygons and vertices are below the limit for the whole scene.
<br/>
<br/>
EDIT: I want to say I saw this in some GDC pdfs that were floating around the forum</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#159550 - silent_code - Wed Jul 02, 2008 3:13 pm</h4>
    <div class="postbody"><span class="postbody">Thank you. :^)
<br/>
<br/>
Yes, I know, that happens and I am pretty sure that case is <span style="font-weight: bold">indicated by the number of min. free rendering lines</span> in the previous frame (the number is available through a memory location), which is at 46 (best value possible) all the time. :^/
<br/>
<br/>
But again, the problem is, <span style="font-weight: bold">the frame drop only happens when I enable lighting</span> (I am still testing which command causes that), <span style="font-weight: bold">nothing else is changed</span>. The exact same scene, only without lighting, renders at 60 hz. (?) 8^|
<br/>
<br/>
Maybe I am overflowing the graphics command buffer? I'm using "immediate mode", no display lists.
<br/>
<br/>
EDIT: <span style="font-weight: bold">It is also independent of how much is seen on screen! It even happens when both list RAMs are empty (no geometry on screen!)</span> That's so confusing! X^(
<br/>
<br/>
EDIT: I am starting to believe I am actually really sending too many commands, which causes a stall, because I am sending a rather big scene (2880 triangles, 1744 * 3 vertices with position, UV and normal - color is set via material) brute force to the hardware. In that case, I guess, it doesn't matter how much geometry is visible... Can anyone confirm that?<br/>_________________<br/><span style="font-size: 9px; line-height: normal"><span style="text-decoration: underline"><span style="font-weight: bold"></span></span> July 5th 08: "<span style="font-weight: bold">Volumetric Shadow Demo</span>" 1.6.0 (final) source released
<br/>
June 5th 08: "<span style="font-weight: bold">Zombie NDS</span>" WIP released!
<br/>
It's all on my page, just click <span style="font-weight: bold">WWW</span> below.</span></span><span class="gensmall"><br/><br/>Last edited by silent_code on Wed Jul 02, 2008 6:28 pm; edited 2 times in total</span></div>    
</div>
<div class="post">
    <h4>#159556 - sverx - Wed Jul 02, 2008 5:12 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>silent_code wrote:</b></span></td> </tr> <tr> <td class="quote"> [...]  I am sending a rather big scene (2880 triangles, 1744 * 3 vertices with position, UV and normal - color is set via material)  ...</td> </tr></table><span class="postbody">
<br/>
<br/>
I've read <a class="postlink" href="http://en.wikipedia.org/wiki/Nintendo_ds#Technical_specifications" target="_blank">here on wikipedia</a> about a 2048 triangles per frame hard limit. Maybe it's not, but I had to tell you :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#159558 - silent_code - Wed Jul 02, 2008 5:40 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>sverx wrote:</b></span></td> </tr> <tr> <td class="quote">I've read here on wikipedia about a 2048 triangles per frame hard limit. Maybe it's not, but I had to tell you :)</td> </tr></table><span class="postbody">
<br/>
Thanks, but as I have already posted, I am not hitting the hard limit for <span style="font-style: italic">visible</span> (that's what you mean) triangles and / or vertices.
<br/>
<br/>
Again, this only happens when lighting is enabled - and <span style="font-weight: bold">only</span> then! The <span style="font-weight: bold">very same scene</span> without lighting will run at 60 hz! |^C
<br/>
<br/>
Then again, to remove any confusion: <span style="font-weight: bold">It even happens without anything on screen and with the primitive / vertex list RAMs empty</span>! 8^|<br/>_________________<br/><span style="font-size: 9px; line-height: normal"><span style="text-decoration: underline"><span style="font-weight: bold"></span></span> July 5th 08: "<span style="font-weight: bold">Volumetric Shadow Demo</span>" 1.6.0 (final) source released
<br/>
June 5th 08: "<span style="font-weight: bold">Zombie NDS</span>" WIP released!
<br/>
It's all on my page, just click <span style="font-weight: bold">WWW</span> below.</span></span><span class="gensmall"><br/><br/>Last edited by silent_code on Wed Jul 02, 2008 6:25 pm; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#159560 - elhobbs - Wed Jul 02, 2008 5:56 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>silent_code wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>sverx wrote:</b></span></td> </tr> <tr> <td class="quote">I've read <a class="postlink" href="http://en.wikipedia.org/wiki/Nintendo_ds#Technical_specifications" target="_blank">here on wikipedia</a> about a 2048 triangles per frame hard limit. Maybe it's not, but I had to tell you :)</td> </tr></table><span class="postbody">
<br/>
<br/>
Thanks, but as I have already posted, I am not hitting the hard limit for *visible* (that's what you mean) triangles and / or vertices.
<br/>
Again, this only happens when lighting is enabled - and ONLY then! The VERY SAME SCENE without lighting will run at 60 Herz!
<br/>
<br/>
And again, to remove any confusion: IT EVEN HAPPENS WITH NOTHING ON SCREEEN and the primitive / vertex list RAMs EMPTY!!!!</span></td> </tr></table><span class="postbody">at the risk of producing more rage/frustration induced replies ;) do you have any code that we can look at?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#159563 - silent_code - Wed Jul 02, 2008 6:15 pm</h4>
    <div class="postbody"><span class="postbody">&lt;lol&gt; What rage? I'm totally easy. :^) The caps were just there to make sure nobody overlooks that. :^D
<br/>
<br/>
Well, it's simply the VSD from my page, but with minor corrections, that are not related to the problem.
<br/>
<br/>
I'm using an extended dataset, which includes a bigger scene (a *lot* more than just a cube) and an updated version of the character model from the original demo (now it has 504 triangles and around 432 vertices - although most vertices are redundand!)
<br/>
<br/>
I'll try to reproduce what I get in the other demo.
<br/>
I'll be back.<br/>_________________<br/><span style="font-size: 9px; line-height: normal"><span style="text-decoration: underline"><span style="font-weight: bold"></span></span> July 5th 08: "<span style="font-weight: bold">Volumetric Shadow Demo</span>" 1.6.0 (final) source released
<br/>
June 5th 08: "<span style="font-weight: bold">Zombie NDS</span>" WIP released!
<br/>
It's all on my page, just click <span style="font-weight: bold">WWW</span> below.</span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#159565 - ritz - Wed Jul 02, 2008 6:18 pm</h4>
    <div class="postbody"><span class="postbody">I took a quick peek at your 1.5.1 source and the following is just a big guesstimation:
<br/>
<br/>
- you're poly format has light0 always enabled no matter what
<br/>
- when your boolean light flag is true, you start calling the glNormal(NORMAL_PACK()), otherwise you simply don't call glNormal
<br/>
<br/>
So, my guess is that you might be running slightly above 60fps when the light flag is false, and your glNormal calls are dropping you below 60fps (giving you the 30) when the flag is true.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#159567 - silent_code - Wed Jul 02, 2008 6:32 pm</h4>
    <div class="postbody"><span class="postbody">Yeah, that's what I am suspecting, too, but why is that?
<br/>
<br/>
I'm not certain how the thing is called, but is it possible that the Graphics FIFO is overflowed and stalls execution for an additional frame when too many commands are pushed? That would indicate why it is indipendent of what is actually displayed on screen.
<br/>
<br/>
What that basically means, is that the culling and clipping stage can't process the amount of data fast enough and the FIFO gets full at some point, stalling untill the FIFO is empty again (thus dropping a frame.)
<br/>
<br/>
Then, what is is called (in general and in libnds) and how much space is there? Where can I check how full it is?<br/>_________________<br/><span style="font-size: 9px; line-height: normal"><span style="text-decoration: underline"><span style="font-weight: bold"></span></span> July 5th 08: "<span style="font-weight: bold">Volumetric Shadow Demo</span>" 1.6.0 (final) source released
<br/>
June 5th 08: "<span style="font-weight: bold">Zombie NDS</span>" WIP released!
<br/>
It's all on my page, just click <span style="font-weight: bold">WWW</span> below.</span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#159569 - Maxxie - Wed Jul 02, 2008 6:50 pm</h4>
    <div class="postbody"><span class="postbody">If this is the reason of dropping, you can test the langth by pushing increasing amounts of NOPs into the fifo until you notice the framedrop.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#159572 - DekuTree64 - Wed Jul 02, 2008 6:53 pm</h4>
    <div class="postbody"><span class="postbody">Does it run at 60 with lighting enabled on a simpler scene?
<br/>
<br/>
In most games I've worked on, just sending enough commands to get near the poly/vertex limits takes most of a 60Hz frame. That does have processing of animation matrices mixed in, but also display lists rather than immediate mode for the polygons themselves.
<br/>
<br/>
The GPU is quite fast though. RAM is a much bigger bottleneck, so most likely the GPU spending most of its time waiting around for the CPU to give it commands, and the CPU is waiting around for RAM to give it data, and then spending some more time to decide how to give the data to the GPU.<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"><br/><br/>Last edited by DekuTree64 on Wed Jul 02, 2008 6:57 pm; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#159574 - silent_code - Wed Jul 02, 2008 6:56 pm</h4>
    <div class="postbody"><span class="postbody">@DT64: Yes, it does...
<br/>
<br/>
(I'll post more in a few minutes!)
<br/>
<br/>
A few seconds later: Removing the draw call of one of the characters fixed it. 8^|
<br/>
<br/>
What I need to know are some guesstimated numbers (or a link to a gbatek reference - I've been browsing it for hours and couldn't find anything) for the amount of command data / frame, if possible.
<br/>
<br/>
I'll be doing some scene management anyway, so I will still be able to draw more than one character on screen, but it just seemed to odd, that the framerate would drop when sending the normals along with positions and UVs. ... :^/
<br/>
<br/>
@ Maxxie: I guess not sending the additional character did the job, too, but thanks for the suggestion! :^)
<br/>
<br/>
@DT64: Yes, I know the processors are quite fast and culling and clipping that amount of geometry should not be the problem. We can even savely assume that not even those opperations have to be performed, because the framedrop also occurs with no geometry inside the view frustum. :^/
<br/>
<br/>
So from what you wrote, I guess it has to be the memory... ?
<br/>
<br/>
<br/>
EDIT: Is that what I am looking for?
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>gbatek wrote:</b></span></td> </tr> <tr> <td class="quote">FIFO / PIPE Number of Entries
<br/>
The FIFO has 256 entries, additionally, there is a PIPE with four entries (giving a total of 260 entries). If the FIFO is empty, and if the PIPE isn't full, then data is moved directly into the PIPE, otherwise it is moved into the FIFO. If the PIPE runs half empty (less than 3 entries) then 2 entries are moved from the FIFO to the PIPE. The state of the FIFO can be obtained in GXSTAT.Bit16-26, observe that there may be still data in the PIPE, even if the FIFO is empty. Check the busy flag in GXSTAT.Bit27 to see if the PIPE or FIFO contains data (or if a command is still executing).
<br/>
Each PIPE/FIFO entry consists of 40bits of data (8bit command code, plus 32bit parameter value). Commands without parameters occupy 1 entry, and Commands with N parameters occupy N entries.</td> </tr></table><span class="postbody">
<br/>
And especially:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>gbatek wrote:</b></span></td> </tr> <tr> <td class="quote">If the FIFO is full, then a wait is generated until data is removed from the FIFO, ie. the STR opcode gets freezed, during the wait, the bus cannot be used even by DMA, interrupts, or by the NDS7 CPU.</td> </tr></table><span class="postbody">
<br/>
<br/>
So the following should solve the problem, right?
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>gbatek wrote:</b></span></td> </tr> <tr> <td class="quote">GXFIFO Access via DMA
<br/>
Larger pre-calculated data blocks can be sent directly to the FIFO. This is usually done via DMA (use DMA in Geometry Command Mode, 32bit units, Dest=4000400h/fixed, Length=NumWords, Repeat=0). The timings are handled automatically, ie. the system (should) doesn't freeze when the FIFO is full (see below Overkill note though). DMA starts when the FIFO becomes less than half full, the DMA does then write 112 words to the GXFIFO register (or less, if the remaining DMA transfer length gets zero).</td> </tr></table><span class="postbody">
<br/>
<br/>
But I'm still not 100% sure that's it. :^/<br/>_________________<br/><span style="font-size: 9px; line-height: normal"><span style="text-decoration: underline"><span style="font-weight: bold"></span></span> July 5th 08: "<span style="font-weight: bold">Volumetric Shadow Demo</span>" 1.6.0 (final) source released
<br/>
June 5th 08: "<span style="font-weight: bold">Zombie NDS</span>" WIP released!
<br/>
It's all on my page, just click <span style="font-weight: bold">WWW</span> below.</span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#159579 - sajiimori - Wed Jul 02, 2008 7:46 pm</h4>
    <div class="postbody"><span class="postbody">It sounds like you're not finishing the upload during a VDraw, presumably because the CPU is blocking while waiting for your vertex commands to finish (apparently because the hardware is taking longer to process them, due to the lighting calculations).
<br/>
<br/>
But you can totally run a high-poly scene with all lights turned on, at 60fps -- I just tried it not long ago, so I think you're running into a bottleneck somewhere.  Edit: But then again, my background model was vertex lit, and only the characters were using dynamic lights...
<br/>
<br/>
I never use the separate gfx registers (just above the FIFO in address space).  Are they a lot slower than the FIFO?  If so, you could try using the FIFO instead.  You don't have to build a display list -- you just have to upload the data in a slightly different way.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#159585 - silent_code - Wed Jul 02, 2008 8:06 pm</h4>
    <div class="postbody"><span class="postbody">Thanks. :^)
<br/>
<br/>
Well, currently, I'm just using videoGL's immediate mode commands (glVertex etc).
<br/>
<br/>
But, does invisible geometry get lit? I think the lighting calculations are not even touching any of the invisible stuff (which isn't in the list RAMs anyway.)
<br/>
<br/>
I have tried to read the number of FIFO entries and it's allways 0...
<br/>
I'll poke the Graphics Status a little bit more, but I didn't get any valuable information, yet.
<br/>
<br/>
This becomes interesting. :^)<br/>_________________<br/><span style="font-size: 9px; line-height: normal"><span style="text-decoration: underline"><span style="font-weight: bold"></span></span> July 5th 08: "<span style="font-weight: bold">Volumetric Shadow Demo</span>" 1.6.0 (final) source released
<br/>
June 5th 08: "<span style="font-weight: bold">Zombie NDS</span>" WIP released!
<br/>
It's all on my page, just click <span style="font-weight: bold">WWW</span> below.</span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#159588 - zeruda - Wed Jul 02, 2008 8:16 pm</h4>
    <div class="postbody"><span class="postbody">Well, all I can say is I have just tested and I pushed around 1900-2000 textured polygons with 1 hardware light with antialiasing and fogging switched on as well as collision engine and stuff and it ran 60 fps quite easily, probably around 25% cpu time to spare. And from what I remember using 4 lights caused no problems at all either.
<br/>
<br/>
glVertex is very slow. No chance of hitting 60fps if you have a complex scene and are using that, you have to use display lists. I think I only managed around 400 or 500 polygons on screen before the framerate dropped with that. The only other thing I can think of is you are doing shadows and stuff right? I haven't gotten around to that yet but there might be something there that causes an issue when combined with lighting.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#159590 - sajiimori - Wed Jul 02, 2008 8:27 pm</h4>
    <div class="postbody"><span class="postbody">I would not be surprised if the hardware did the lighting calculations for off-screen polys.  Those polys don't end up in the final buffers, but perhaps the calculations are done before clipping.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#159591 - silent_code - Wed Jul 02, 2008 8:40 pm</h4>
    <div class="postbody"><span class="postbody">Nope, actually, it doesn't matter, if I use shadowing or not, but for testing purposes I have disabled it... the only thing that affects it is sending normals (immediate mode, via glNormal) or not (when lighting is "disabled") - all other effects, even capturing, don't have ANY effect on the bahaviour. I disabled shadowing to reduce the geometry load.
<br/>
Also, reducing the geometry and sending normals for it will also work.
<br/>
<br/>
That means the Geometry Command FIFO stalls the bus.
<br/>
<br/>
I haven't done any special testing, so I don't have any real numbers, but I sure get nearly 1000 textured, shaded, antialiased, fogged, shadowed (including the shadow geometry in the "1000") and all bells and whissles triangles before the frame drop... so I guess it's still reasonable. I was just shocked that I didn't hit the limit and still it would drop a frame.
<br/>
<br/>
Well, DMA'ed display lists are the way to go, if I want to be able to max out geometry usage, I guess.
<br/>
<br/>
Thanks for all the advises so far. I'm still open to suggestions. :^D
<br/>
<br/>
Btw: I've tried to read the Graphics Status register (in the main loop) and here's what I've found:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">   uint32 gfx_status = GFX_STATUS;
<br/>
<br/>
   (gfx_status &amp; BIT(0));              // = 0
<br/>
   (gfx_status &amp; BIT(1)) &gt;&gt; 1;         // = 0
<br/>
   (gfx_status &amp; (31 &lt;&lt; 8)) &gt;&gt; 8;      // bits 8..12 = 0
<br/>
   (gfx_status &amp; BIT(13)) &gt;&gt; 13;       // = 0
<br/>
   (gfx_status &amp; BIT(14)) &gt;&gt; 14;       // = 0
<br/>
   (gfx_status &amp; BIT(15)) &gt;&gt; 15;       // = 0
<br/>
   (gfx_status &amp; (511 &lt;&lt; 16)) &gt;&gt; 16;   // bits 16..24 = 0 -&gt; Number of 40bit-entries in Command FIFO  (0..256)
<br/>
   (gfx_status &amp; BIT(24)) &gt;&gt; 24;       // = 0 -&gt; yes, bit 24 again, it means: Command FIFO Full
<br/>
   (gfx_status &amp; BIT(25)) &gt;&gt; 25;       // = 1 -&gt; Command FIFO Less Than Half Full
<br/>
   (gfx_status &amp; BIT(26)) &gt;&gt; 26;       // = 1 -&gt; Command FIFO Empty
<br/>
   (gfx_status &amp; BIT(27)) &gt;&gt; 27;       // = 0 -&gt; Geometry Engine Busy
<br/>
   (gfx_status &amp; (3 &lt;&lt; 30)) &gt;&gt; 30;     // bits 30..31 = 0
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
What's wrong with this? ... EDIT: It needs shifting. EDIT: Fixed :^)
<br/>
<br/>
The relevant parts have been named.
<br/>
I am doing this just before flushing. Doing it after flushing just switches the Geometry Engine Busy bit from 0 to 1.
<br/>
<br/>
Should I try something else?
<br/>
<br/>
<br/>
EDIT: I have tried printing DISP3DCNT / GFX_CONTROL. At any stage it reads 0x099B;
<br/>
<br/>
If I unserstand that correctly, it means that neither "Color Buffer RDLINES Underflow" (render buffer line underflow - the lowest I get is 35 and in avg. it's 44 now, so that's not a problem), nor "Polygon / Vertex RAM Overflow" occured.
<br/>
Shouldn't the latter one be set when a frame was dropped?
<br/>
EDIT: Nope, because I don't fill the RAM to that point... silly me. ;^)
<br/>
<br/>
<span style="font-weight: bold">How can a frame drop be recognized, other than counting FPS?</span><br/>_________________<br/><span style="font-size: 9px; line-height: normal"><span style="text-decoration: underline"><span style="font-weight: bold"></span></span> July 5th 08: "<span style="font-weight: bold">Volumetric Shadow Demo</span>" 1.6.0 (final) source released
<br/>
June 5th 08: "<span style="font-weight: bold">Zombie NDS</span>" WIP released!
<br/>
It's all on my page, just click <span style="font-weight: bold">WWW</span> below.</span></span><span class="gensmall"><br/><br/>Last edited by silent_code on Wed Jul 02, 2008 10:10 pm; edited 4 times in total</span></div>    
</div>
<div class="post">
    <h4>#159599 - silent_code - Wed Jul 02, 2008 9:59 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>sajiimori wrote:</b></span></td> </tr> <tr> <td class="quote">I would not be surprised if the hardware did the lighting calculations for off-screen polys.  Those polys don't end up in the final buffers, but perhaps the calculations are done before clipping.</td> </tr></table><span class="postbody">
<br/>
Aren't lighting calculations done in view or screen space (on most platforms)?
<br/>
And doing lighting before clipping is highly unlikely. Just look at the warping caused in clipped primitives... that includes warped UV and lighting, which is due to the new "clip" vertices.
<br/>
I even think, that clipping happens after culling, so most of all (offscreen or not) primitives would get discarted at an early stage, with minimum computations.
<br/>
<br/>
I could be wrong, though.<br/>_________________<br/><span style="font-size: 9px; line-height: normal"><span style="text-decoration: underline"><span style="font-weight: bold"></span></span> July 5th 08: "<span style="font-weight: bold">Volumetric Shadow Demo</span>" 1.6.0 (final) source released
<br/>
June 5th 08: "<span style="font-weight: bold">Zombie NDS</span>" WIP released!
<br/>
It's all on my page, just click <span style="font-weight: bold">WWW</span> below.</span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#159602 - DekuTree64 - Wed Jul 02, 2008 10:56 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>sajiimori wrote:</b></span></td> </tr> <tr> <td class="quote">I never use the separate gfx registers (just above the FIFO in address space).  Are they a lot slower than the FIFO?</td> </tr></table><span class="postbody">
<br/>
Faster, actually. For the FIFO, you have to feed it a command number plus parameters. With the registers the command gets poked in automatically so the CPU has less work to do. Of course display lists are faster when you can't code specific command sequences.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>silent_code wrote:</b></span></td> </tr> <tr> <td class="quote">How can a frame drop be recognized, other than counting FPS?</td> </tr></table><span class="postbody">
<br/>
You could check if the VCount register is &gt;= 192 just before sending the swap buffer command.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>silent_code wrote:</b></span></td> </tr> <tr> <td class="quote">And doing lighting before clipping is highly unlikely.</td> </tr></table><span class="postbody">
<br/>
Judging by the fact that lighting and vertex colors overwrite eachother, my guess is that the lighting calculations are done by the normal command itself, rather than storing the normal and waiting until you send a vertex.<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#159629 - nce - Thu Jul 03, 2008 4:45 am</h4>
    <div class="postbody"><span class="postbody">indeed the only problem here is more likely the immediate mode.
<br/>
<br/>
I was doing my test a long time ago in immediate mode and using the worst type ever : triangle list !
<br/>
<br/>
result maximum triangles I can push in one frame : ~1500.  and that was 1 color, 1 uv , 1 position for each vertex  ( 3 per triangles )
<br/>
<br/>
Since then I started to first implement a trianglestrip and after converting evertyhing in calllist.... no other choice I think.
<br/>
<br/>
(I'm still planning the use the FIFO irq to parallelize the rendering with my other code)<br/>_________________<br/>-jerome-</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#159632 - a128 - Thu Jul 03, 2008 8:24 am</h4>
    <div class="postbody"><span class="postbody">use also VTX_XY, XZ,YZ vertex commands....they need 1cycle less then VTX16</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#159644 - silent_code - Thu Jul 03, 2008 2:38 pm</h4>
    <div class="postbody"><span class="postbody">Thanks for the hints guys!
<br/>
<br/>
So, there's really nothing I can do about it, but go on with the features I want to implement, which includes using DL and a scene graph anyway. :^)
<br/>
Plus, I want to get away from the aweful scructures used in the demo. I really had to foce myself to use them, because I wanted it to be as simple as possible. :^)
<br/>
<br/>
So, let's see how things turn out. :^)
<br/>
<br/>
PS: I still have to experiment with reading the GFX_CONTROL register, which should tell me how full the FIFO is etc. (Any suggestions on that?)<br/>_________________<br/><span style="font-size: 9px; line-height: normal"><span style="text-decoration: underline"><span style="font-weight: bold"></span></span> July 5th 08: "<span style="font-weight: bold">Volumetric Shadow Demo</span>" 1.6.0 (final) source released
<br/>
June 5th 08: "<span style="font-weight: bold">Zombie NDS</span>" WIP released!
<br/>
It's all on my page, just click <span style="font-weight: bold">WWW</span> below.</span></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
