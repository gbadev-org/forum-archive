<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>how to mix mix arm & thumb? - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>DS development > how to mix mix arm & thumb?</h2>
<div id="posts">
<div class="post">
    <h4>#129586 - Noda - Wed May 23, 2007 11:44 pm</h4>
    <div class="postbody"><span class="postbody">well, I need some to use some arm instructions in my code (like smull), how can I switch to arm mode only for those part and compile the rest with thumb mode?
<br/>
<br/>
is there a gcc pragma or so?
<br/>
<br/>
thanks</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#129595 - tepples - Thu May 24, 2007 1:59 am</h4>
    <div class="postbody"><span class="postbody">In C, you give arm-eabi-gcc the compiler flags <span style="font-weight: bold">-marm -mthumb-interwork</span>. No, I don't know how to force this in wintermute's automagic makefile.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#129600 - Dwedit - Thu May 24, 2007 2:39 am</h4>
    <div class="postbody"><span class="postbody">If you want to hand-code it, you can just use an ASM block containing bx, .arm, then a bunch of ARM code, be sure to .thumb before the block ends.
<br/>
Otherwise, you'd probably need to make a separate C file for ARM code.  Just use -marm when you compile it.<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#129609 - Lick - Thu May 24, 2007 8:43 am</h4>
    <div class="postbody"><span class="postbody">I think nowadays you leave out -mthumb and it will automatically be compiled as ARM.<br/>_________________<br/><a class="postlink" href="http://licklick.wordpress.com" target="_blank">http://licklick.wordpress.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#129611 - Noda - Thu May 24, 2007 9:09 am</h4>
    <div class="postbody"><span class="postbody">Thanks, but I already knew that.
<br/>
<br/>
My problem is that I'd like to have for example one function to be compiled in ARM mode as it contains inline ARM asm, then the rest in thumb mode.
<br/>
<br/>
I tried searching for GCC pragma, but it's seems there's no one for my needs.
<br/>
<br/>
I'll try dwedit idea, by inserting asm(".arm") &amp; .thumb asm instructions where it's needed, and compile with .thumb.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#129613 - kusma - Thu May 24, 2007 9:17 am</h4>
    <div class="postbody"><span class="postbody">GCC can't mix ARM and THUMB within the same compilation unit. GAS should be able to, but then you'd need to write the code in question in assembly.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#129626 - tepples - Thu May 24, 2007 1:18 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Noda wrote:</b></span></td> </tr> <tr> <td class="quote">My problem is that I'd like to have for example one function to be compiled in ARM mode as it contains inline ARM asm, then the rest in thumb mode.</td> </tr></table><span class="postbody">
<br/>
Is it too hard for that one function that uses ARM inline assembly to be put into its own file?<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#129628 - silent_code - Thu May 24, 2007 1:26 pm</h4>
    <div class="postbody"><span class="postbody">just make a "container" function that wraps around the inline asm block and put that into a seperate .c file. or simply write that wrapper directly into an asembler .s file.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#129636 - Noda - Thu May 24, 2007 2:18 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tepples wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Noda wrote:</b></span></td> </tr> <tr> <td class="quote">My problem is that I'd like to have for example one function to be compiled in ARM mode as it contains inline ARM asm, then the rest in thumb mode.</td> </tr></table><span class="postbody">
<br/>
Is it too hard for that one function that uses ARM inline assembly to be put into its own file?</span></td> </tr></table><span class="postbody">
<br/>
<br/>
Indeed, yes, as it's not a full asm function, but a one that use some inline assembly mixed with c code, where the assembly part are defined by macros defined somewhere else... Yes it's quite compicated but it's not my code (it's the helix mp3 fixed point decoder)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#129651 - Dwedit - Thu May 24, 2007 5:51 pm</h4>
    <div class="postbody"><span class="postbody">Inline ASM?  That's really easy to change to ARM mode.
<br/>
<br/>
__asm__ volatile (
<br/>
"adr r3,jumphere\n\t"
<br/>
"bx r3\n\t"
<br/>
".code 32\n"
<br/>
"jumphere:\n\t"
<br/>
"@arm code goes here\n\t"
<br/>
"adr r3,jumpout+1\n\t"
<br/>
"bx r3\n\t"
<br/>
".code 16\n"
<br/>
"jumpout:",...,...,...);
<br/>
<br/>
Only thing though, when using labels in inline ASM, you must mark the function as noinline, otherwise it will try to inline it several times, and complain about duplicate labels.
<br/>
<br/>
This example won't work for the times when you need a small amount of ASM code as arm though, just use a separate c file.<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
