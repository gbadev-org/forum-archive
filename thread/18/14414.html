<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Wireless Problems(liblobby and rooms)(SOLVED) - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > Wireless Problems(liblobby and rooms)(SOLVED)</h2>
<div id="posts">
<div class="post">
    <h4>#143944 - yellowstar - Sat Oct 27, 2007 5:52 pm</h4>
    <div class="postbody"><span class="postbody">I am having troubles with wireless and rooms.
<br/>
<br/>
The host isn't detecting the clients,
<br/>
once joined.(it was doing this even before the client
<br/>
started having problems.)
<br/>
<br/>
The Client isn't detecting
<br/>
the host.(It was detecting it before,
<br/>
but now it won't)
<br/>
<br/>
For the client I'm using the following line of code
<br/>
to get the host of a room.
<br/>
(I was looking for something like LOBBY_GetUserByRoom,
<br/>
but I found the below)
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
user=LOBBY_GetRoomUserBySlot(room,0);
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Please help with my <a class="postlink" href="http://forum.gbadev.org/viewtopic.php?t=14402" target="_blank">sprites</a> problem.
<br/>
This game can't be finished untill
<br/>
it is solved.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
void UserInfoCallback(LPLOBBY_USER user, unsigned long reason)
<br/>
{
<br/>
<br/>
 if(host &amp;&amp; !started &amp;&amp; search_user==NULL)//This function would be called,
<br/>
 //even after the game goes to game.cpp
<br/>
 {
<br/>
  if(user==LOBBY_GetUserByID(USERID_MYSELF))
<br/>
  return;//Stop the host from detecting itself.
<br/>
 
<br/>
  if(reason == USERINFO_REASON_ROOMCHANGE)
<br/>
  {
<br/>
   if(LOBBY_GetRoomByUser(user)==LOBBY_GetRoomByID(ROOMID_MYROOM))
<br/>
   {
<br/>
   search_user=user;
<br/>
   }
<br/>
  }
<br/>
 }
<br/>
<br/>
}
<br/>
<br/>
LPLOBBY_ROOM QueryRooms()//Search through all the rooms,
<br/>
//and return a room for this game.
<br/>
{
<br/>
unsigned short i=0;
<br/>
LPLOBBY_ROOM cur_room;
<br/>
<br/>
   while(1)
<br/>
   {
<br/>
   cur_room = LOBBY_GetRoomByID(i);
<br/>
   
<br/>
   if(cur_room==NULL)return NULL;
<br/>
   
<br/>
   i++;
<br/>
   
<br/>
   if(LOBBY_GetRoomGameCode(cur_room)!=GAMECODE)continue;
<br/>
   //skip
<br/>
   
<br/>
   //if(LOBBY_GetRoomVersion(cur_room)!=VERSION)continue;
<br/>
   //skip
<br/>
   //Commented out because of minor bug in above function.
<br/>
   //(returns gamecode instead of version)
<br/>
   
<br/>
   if(LOBBY_GetUsercountInRoom(cur_room)&gt;=
<br/>
   LOBBY_GetMaxUsercountInRoom(cur_room) )
<br/>
   continue;//When room is full, skip it.
<br/>
   
<br/>
   break;
<br/>
   
<br/>
   }
<br/>
   
<br/>
   return cur_room;
<br/>
}
<br/>
<br/>
LPLOBBY_USER FindRooms()
<br/>
{
<br/>
LPLOBBY_ROOM room;
<br/>
LPLOBBY_USER user=NULL;
<br/>
<br/>
 if(!host)
<br/>
 {
<br/>
 room=QueryRooms();
<br/>
  if(room==NULL)
<br/>
  {
<br/>
   for(int i=0;i&lt;=10;i++)
<br/>
   {
<br/>
   room=QueryRooms();
<br/>
   
<br/>
   if(room!=NULL)
<br/>
   break;
<br/>
   }
<br/>
  }
<br/>
  
<br/>
 if(room!=NULL)
<br/>
 user=LOBBY_GetRoomUserBySlot(room,0);
<br/>
 }
<br/>
 
<br/>
 if(host)
<br/>
 {
<br/>
  if(search_user!=NULL)
<br/>
  user=search_user;
<br/>
 }
<br/>
<br/>
return user;
<br/>
}
<br/>
<br/>
void FindPlayers()//This function finds other players to play with.
<br/>
{
<br/>
LPLOBBY_USER found_user=NULL;
<br/>
LPLOBBY_ROOM found_room=NULL;
<br/>
bool found=false;
<br/>
<br/>
if(host)LOBBY_CreateRoom("GoPongRoom",2,GAMECODE,VERSION);
<br/>
<br/>
   while (1) 
<br/>
   {
<br/>
      
<br/>
      scanKeys() ;
<br/>
      
<br/>
      DebugPrint();
<br/>
      
<br/>
      found_user=FindRooms();
<br/>
      
<br/>
      if(found_user!=NULL)
<br/>
      {
<br/>
      
<br/>
         if(!host)
<br/>
         {
<br/>
         found_room = LOBBY_GetRoomByUser(found_user);
<br/>
         
<br/>
         LOBBY_JoinRoom(found_room);
<br/>
         
<br/>
         while(1)
<br/>
         {
<br/>
         if(
<br/>
         LOBBY_GetRoomUserBySlot(
<br/>
         LOBBY_GetRoomByID(ROOMID_MYROOM),1)==LOBBY_GetUserByID(USERID_MYSELF))
<br/>
         break;
<br/>
         }
<br/>
         
<br/>
         }
<br/>
         
<br/>
         if(host)
<br/>
         {
<br/>
         
<br/>
         
<br/>
         
<br/>
         }
<br/>
         
<br/>
         found=true;
<br/>
      
<br/>
      }
<br/>
      
<br/>
      if(found)
<br/>
      {
<br/>
      player = found_user;
<br/>
      //DoStuff
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
EDIT:
<br/>
I solved it. I rewrote the whole game, and the connecting code,
<br/>
and now it works. I'm now having problems with the game now...</span><span class="gensmall"><br/><br/>Last edited by yellowstar on Mon Dec 24, 2007 12:18 am; edited 4 times in total</span></div>    
</div>
<div class="post">
    <h4>#143953 - Mighty Max - Sat Oct 27, 2007 7:56 pm</h4>
    <div class="postbody"><span class="postbody">I just noticed, i left a change in the lobby code, that i didn't want to.
<br/>
It doesn't matter as long as client and host are compiled against the same lobby version. (Otherwise they might use different channels)
<br/>
<br/>
If this is the problem, do a  make clean &amp; make and copy the same version to each NDS.<br/>_________________<br/><a class="postlink" href="http://mightymax.org/gbamp_multiboot.html" target="_blank">GBAMP Multiboot</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#143954 - yellowstar - Sat Oct 27, 2007 8:06 pm</h4>
    <div class="postbody"><span class="postbody">The Host and Client are in the same NDS.(At the start
<br/>
of the game, it asks wether the player wants to be a host or client)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#143958 - Mighty Max - Sat Oct 27, 2007 8:22 pm</h4>
    <div class="postbody"><span class="postbody">Now after reading through your code: 
<br/>
<br/>
- make sure search_user is volatile. But better here: check the users which are within the room: LOBBY_GetRoomUserBySlot(LOBBY_GetRoomByID(ROOMID_MYROOM),1)
<br/>
<br/>
- You are iterating through all room's exactly once. If the room was not recognized yet at this call, you will call LOBBY_GetRoomUserBySlot &amp; LOBBY_JoinRoom with a NULL value, causing no action. And you will still flag found=true;  
<br/>
<br/>
- You can only assume a succeeded roomjoin, when LOBBY_GetRoomByID(ROOMID_MYROOM) returns non-0. (Which is not set instatntly after the join, but when the room owner replies to the join request)<br/>_________________<br/><a class="postlink" href="http://mightymax.org/gbamp_multiboot.html" target="_blank">GBAMP Multiboot</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#143960 - yellowstar - Sat Oct 27, 2007 8:40 pm</h4>
    <div class="postbody"><span class="postbody">I can't test the above right now.
<br/>
(The computer which has this project on it
<br/>
is being used right now.)
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Mighty Max wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
- You can only assume a succeeded roomjoin, when LOBBY_GetRoomByID(ROOMID_MYROOM) returns non-0. (Which is not set instatntly after the join, but when the room owner replies to the join request)
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
When does the host reply to the join request?
<br/>
<br/>
Is it handled by the lib,
<br/>
or does it happen when the host sends a
<br/>
message to the client?(whom just joined?)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#143961 - Mighty Max - Sat Oct 27, 2007 8:45 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>yellowstar wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
When does the host reply to the join request?
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
The host will on receive try to put the new user into the room.
<br/>
The host then sends a userinfo to all users. If one of the userslots in this info changed relative to the cached info on the client DS, the roomjoin is recognized and a userinfo callback triggered.<br/>_________________<br/><a class="postlink" href="http://mightymax.org/gbamp_multiboot.html" target="_blank">GBAMP Multiboot</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#143964 - yellowstar - Sat Oct 27, 2007 9:34 pm</h4>
    <div class="postbody"><span class="postbody">I tried the above,
<br/>
but both the host and client still
<br/>
do the same thing.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#143965 - Mighty Max - Sat Oct 27, 2007 9:41 pm</h4>
    <div class="postbody"><span class="postbody">Try outputting the userinfo callbacks, to check whether they really don't see each other/the rooms or just the logic is screwed.<br/>_________________<br/><a class="postlink" href="http://mightymax.org/gbamp_multiboot.html" target="_blank">GBAMP Multiboot</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#143967 - yellowstar - Sat Oct 27, 2007 9:56 pm</h4>
    <div class="postbody"><span class="postbody">I did that.
<br/>
<br/>
The host outputed the callback data correctly,
<br/>
while the client didn't output anything.
<br/>
<br/>
The host reconizes the other player.(for the players,
<br/>
not the rooms)
<br/>
It detects that it,(the host, which is this DS)
<br/>
changed its room.
<br/>
It detected that the other player
<br/>
had a timeout.(that was probably when I
<br/>
turned that DS off.)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#143968 - yellowstar - Sat Oct 27, 2007 10:22 pm</h4>
    <div class="postbody"><span class="postbody">The client is saving the debug data
<br/>
correctly now.
<br/>
<br/>
It is only detecting the other player,(only for the player stuff,
<br/>
not the rooms)
<br/>
and a timeout for that player.(probably caused when
<br/>
I turned that DS off.)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#143969 - Mighty Max - Sat Oct 27, 2007 10:23 pm</h4>
    <div class="postbody"><span class="postbody">Well chances are that the client crashes.
<br/>
<br/>
And if you are still trying to get a room of a null user, this will be the case. (There are a lot of functions which needs more parameter checking)<br/>_________________<br/><a class="postlink" href="http://mightymax.org/gbamp_multiboot.html" target="_blank">GBAMP Multiboot</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#143971 - yellowstar - Sat Oct 27, 2007 10:34 pm</h4>
    <div class="postbody"><span class="postbody">I have updated the source in the first post.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#143974 - Mighty Max - Sat Oct 27, 2007 10:58 pm</h4>
    <div class="postbody"><span class="postbody">You are now waiting for the user beeing part of the room, before attempting to join the room.
<br/>
<br/>
It is hard to read without proper formating, and the break/continue constructs doesn't help either ;) 
<br/>
<br/>
PS: don't forget that the LOBBY_Update has to be called. If you use the above function within an IRQ (IE=0) and busy-wait for the join, it will most likely never continue, as there is no IPC-Filling, WIFI-Resending, etc going on.<br/>_________________<br/><a class="postlink" href="http://mightymax.org/gbamp_multiboot.html" target="_blank">GBAMP Multiboot</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#143980 - yellowstar - Sat Oct 27, 2007 11:48 pm</h4>
    <div class="postbody"><span class="postbody">I have updated the source.
<br/>
<br/>
No,
<br/>
it's not be being called from an IRQ.
<br/>
(it's being called from main.)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#144005 - yellowstar - Sun Oct 28, 2007 3:36 am</h4>
    <div class="postbody"><span class="postbody">I have found from my tests
<br/>
that the host is crashing.
<br/>
But, according to those tests,
<br/>
the client isn't crashing.
<br/>
<br/>
I had a debug file created on
<br/>
startup,
<br/>
and in the VBlank IRQ,
<br/>
I would have it print the value
<br/>
of a var,
<br/>
which would be flipped
<br/>
after the print.
<br/>
<br/>
When the var wouldn't change,
<br/>
that meant it crashed.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
