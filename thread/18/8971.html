<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Using data files beyond 4Mb memory limit - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > Using data files beyond 4Mb memory limit</h2>
<div id="posts">
<div class="post">
    <h4>#76309 - melw - Mon Mar 20, 2006 1:17 pm</h4>
    <div class="postbody"><span class="postbody">Hi,
<br/>
<br/>
So far I've included all my data files (graphics, sounds, binaries all alike) in the code and got myself finally into a situation where DS is starting to run out of memory - mostly thanks to sound data sucking up space. The question is, what are the alternatives when having more than 4 megs of data?
<br/>
<br/>
I've been using Chishms FAT library, but having separate data files is tad ugly - how do you use your data when packing everything in a single .nds file?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#76313 - genfish - Mon Mar 20, 2006 1:35 pm</h4>
    <div class="postbody"><span class="postbody">if you have a huge sound file try streaming it maybe?<br/>_________________<br/>there is no rl only afk</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#76386 - josath - Tue Mar 21, 2006 6:35 am</h4>
    <div class="postbody"><span class="postbody">There's two options:
<br/>
1. When loading from a flashcart, you can append the data to the end of your .nds file, and it gets mapped into memory with 0x08000000 being the beginning of your .nds file
<br/>
2. When loading from a device like GBAMP, you can append the data to the end of your .nds file, and just open the .nds file itself using the FAT_open(), FAT_read(), etc commands.
<br/>
<br/>
Ideally, your code would detect which situation it was, and use the appropriate method.
<br/>
<br/>
Either way, I'd suggest using some 'mini-filesystem,' look up GBFS, it was designed for just such an occasion.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#76396 - EyeballKid - Tue Mar 21, 2006 9:16 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>josath wrote:</b></span></td> </tr> <tr> <td class="quote">There's two options:
<br/>
1. When loading from a flashcart, you can append the data to the end of your .nds file, and it gets mapped into memory with 0x08000000 being the beginning of your .nds file
<br/>
2. When loading from a device like GBAMP, you can append the data to the end of your .nds file, and just open the .nds file itself using the FAT_open(), FAT_read(), etc commands.
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Can anyone clarify for me how nds files are handled? Presumably the main (compiled) part is copied out of ROM into the 4Mb RAM block. If there is extra data tacked onto the end of the nds file, is that copied into RAM too or just left in ROM?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#76397 - melw - Tue Mar 21, 2006 9:36 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>josath wrote:</b></span></td> </tr> <tr> <td class="quote">There's two options:
<br/>
1. When loading from a flashcart, you can append the data to the end of your .nds file, and it gets mapped into memory with 0x08000000 being the beginning of your .nds file
<br/>
2. When loading from a device like GBAMP, you can append the data to the end of your .nds file, and just open the .nds file itself using the FAT_open(), FAT_read(), etc commands.
<br/>
<br/>
Ideally, your code would detect which situation it was, and use the appropriate method.
<br/>
<br/>
Either way, I'd suggest using some 'mini-filesystem,' look up GBFS, it was designed for just such an occasion.</td> </tr></table><span class="postbody">
<br/>
<br/>
Thanks! Now when thinking of it, this sounds very simple... One more follow-up question though - where do I get the correct offset for the appended data? Checking quickly the <a class="postlink" href="http://www.bottledlight.com/ds/index.php/FileFormats/NDSFormat" target="_blank">NDS Format specs</a> there's a 4 byte ROM Size at position 0x080... well, I will try that. :)
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>EyeballKid wrote:</b></span></td> </tr> <tr> <td class="quote">Can anyone clarify for me how nds files are handled? Presumably the main (compiled) part is copied out of ROM into the 4Mb RAM block. If there is extra data tacked onto the end of the nds file, is that copied into RAM too or just left in ROM?</td> </tr></table><span class="postbody">
<br/>
<br/>
Well, that was my initial reason for asking this - all data appended after the end of the .nds file is not loaded into memory unless you do so yourself - which is what I want to do in my case for all the sound files as they're growing to several megabytes in size.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#76410 - genfish - Tue Mar 21, 2006 2:25 pm</h4>
    <div class="postbody"><span class="postbody">PM me your email address and i'll send you the code i use for gbfs if you like. Been developing it for a project i'm doing.<br/>_________________<br/>there is no rl only afk</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#76424 - GPFerror - Tue Mar 21, 2006 4:40 pm</h4>
    <div class="postbody"><span class="postbody">i use my romfs and FAT lib , but i just set them up like this
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#ifdef EMU
<br/>
#include &lt;kos/kosstdio.h&gt;
<br/>
#else
<br/>
#include "gba_nds_fat/gba_nds_fat.h"
<br/>
#endif
<br/>
#include &lt;stdio.h&gt;
<br/>
<br/>
#undef FILE
<br/>
#undef DIR
<br/>
#undef size_t
<br/>
#undef fopen
<br/>
#undef fread
<br/>
#undef fwrite
<br/>
#undef fclose
<br/>
#undef ftell
<br/>
#undef rewind
<br/>
#undef fseek
<br/>
#undef chdir
<br/>
#undef ftell
<br/>
#undef getc
<br/>
#undef tmpfile
<br/>
#undef rewind
<br/>
#undef putc
<br/>
#undef fputc
<br/>
#undef fscanf
<br/>
#undef feof
<br/>
#undef stdin
<br/>
#undef stdout
<br/>
#undef fflush
<br/>
<br/>
#ifdef EMU
<br/>
#define FILE KOS_FILE
<br/>
#define fopen KOS_fopen
<br/>
#define fwrite KOS_fwrite
<br/>
#define fread KOS_fread
<br/>
#define fclose KOS_fclose
<br/>
#define fseek KOS_fseek
<br/>
#define fputs KOS_fputs
<br/>
#define fgets KOS_fgets
<br/>
#define fputc KOS_fputc
<br/>
#define getc KOS_getc
<br/>
#define putc KOS_putc
<br/>
#define fgetc KOS_fgetc
<br/>
#define fprintf KOS_fprintf
<br/>
#define vfprintf KOS_fprintf 
<br/>
#define ftell KOS_ftell
<br/>
#define tmpfile KOS_tmpfile
<br/>
#define rewind KOS_rewind
<br/>
#define feof KOS_feof
<br/>
#define stdin KOS_stdin
<br/>
#define stdout KOS_stdout
<br/>
#define fscanf KOS_fscanf
<br/>
#define fflush KOS_fflush
<br/>
#else
<br/>
#define FILE FAT_FILE
<br/>
#define fopen FAT_fopen
<br/>
#define fwrite FAT_fwrite
<br/>
#define fread FAT_fread
<br/>
#define fclose FAT_fclose
<br/>
#define fseek FAT_fseek
<br/>
#define fputs FAT_fputs
<br/>
#define fgets FAT_fgets
<br/>
#define fputc FAT_fputc
<br/>
#define getc FAT_getc
<br/>
#define putc FAT_putc
<br/>
#define fgetc FAT_fgetc
<br/>
#define fprintf FAT_fprintf
<br/>
#define vfprintf FAT_fprintf 
<br/>
#define ftell FAT_ftell
<br/>
#define tmpfile FAT_tmpfile
<br/>
#define rewind FAT_rewind
<br/>
#define feof FAT_feof
<br/>
#define stdin FAT_stdin
<br/>
#define stdout FAT_stdout
<br/>
#define fscanf FAT_fscanf
<br/>
#define fflush FAT_fflush
<br/>
#endif</td> </tr></table><span class="postbody">
<br/>
<br/>
and in my main() i do
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#ifdef EMU
<br/>
  fs_init(); 
<br/>
  // Map Game Cartridge memory to ARM9
<br/>
  sysSetCartOwner( BUS_OWNER_ARM9 );
<br/>
<br/>
  fs_romdisk_mount("/rd", (uint8*)find_first_romfs_file((uint8*)0x08000000), 0);  
<br/>
#else
<br/>
   if (!FAT_InitFiles())
<br/>
   {
<br/>
      iprintf("Unable to initialize media device!");
<br/>
      return -1;
<br/>
   }
<br/>
#endif</td> </tr></table><span class="postbody">
<br/>
<br/>
then if Im compile for fat i undefine EMU or define it if I want to use the romfs, which uses genromfs to packed a directory into one file that can be appended to the end of the .ds.gba or .nds file. For use in emulators or hardware(except gbamp). And I can for the most part use stdio function names which allows for easier porting or future filesystems.
<br/>
<br/>
note. I have added some missing functions to the FAT lib so that my above defines can be used. But the romfs has them implemented already.
<br/>
<br/>
you can download romfs from my site
<br/>
<a href="http://gpf.dcemu.co.uk/ndsromdisk.shtml" target="_blank">http://gpf.dcemu.co.uk/ndsromdisk.shtml</a>
<br/>
<br/>
Troy(GPF)</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
