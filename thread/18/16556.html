<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Optimization help? - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>DS development > Optimization help?</h2>
<div id="posts">
<div class="post">
    <h4>#167684 - TwentySeven - Sun Mar 22, 2009 10:16 am</h4>
    <div class="postbody"><span class="postbody">Hi, I've got a loop I'd like to optimize.                
<br/>
<br/>
global.screens are main ram buffers,  256*192 uint8's in length.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
//The 8 bit version, which takes about 15ms
<br/>
int j=256*192;   
<br/>
uint8* dest=global.screens[0];
<br/>
uint8* toplayer=global.screens[2];
<br/>
uint8* botlayer=global.screens[1];
<br/>
<br/>
while(j--)
<br/>
{
<br/>
   if(*toplayer == 0) 
<br/>
      *dest = *botlayer;
<br/>
   else
<br/>
       *dest = *toplayer;
<br/>
   dest++;
<br/>
   botlayer++;
<br/>
   toplayer++;
<br/>
}
<br/>
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
The next thing I tried was doing 2 bytes at a time, although optimizing from here I get a little ham fisted, which is why Im asking for advice.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
<br/>
//16bit version, which takes about 9ms
<br/>
int j=(256*192)/2;   
<br/>
uint16* dest=(uint16*)global.screens[0];
<br/>
uint16* toplayer=(uint16*)global.screens[2];
<br/>
uint16* botlayer=(uint16*)global.screens[1];
<br/>
    
<br/>
uint16 topA,topB,top; 
<br/>
while(j--)
<br/>
{
<br/>
   top = *toplayer;
<br/>
   if(top ==0)  
<br/>
   {  
<br/>
      *dest = *botlayer;
<br/>
   }
<br/>
   else
<br/>
   {
<br/>
      topA =*toplayer &amp; 0xFF00;      
<br/>
      topB =*toplayer &amp; 0x00FF;      
<br/>
            
<br/>
      if (topA &amp;&amp; topB ) 
<br/>
      {
<br/>
         *dest= *toplayer;
<br/>
      }
<br/>
      else 
<br/>
      if (!topA &amp;&amp; topB)
<br/>
      {
<br/>
         *dest= topB | (*botlayer &amp; 0xFF00);
<br/>
      }
<br/>
      else
<br/>
      {
<br/>
         *dest= topA | (*botlayer &amp; 0x00FF);
<br/>
      }
<br/>
   }
<br/>
   dest++;
<br/>
   botlayer++;
<br/>
   toplayer++;
<br/>
}
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167685 - Mighty Max - Sun Mar 22, 2009 10:45 am</h4>
    <div class="postbody"><span class="postbody">I would like to see the assembly.
<br/>
In cases of these fast followed short if/then it would be interesting to see if conditioned code is produced rather then branching. 
<br/>
<br/>
It might also be faster to increase only an indexing variable and use indirect addressing rather then increasing all 3 base pointers.
<br/>
<br/>
But it all depends on what the compiler already optimizes.<br/>_________________<br/><a class="postlink" href="http://mightymax.org/gbamp_multiboot.html" target="_blank">GBAMP Multiboot</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167687 - TwentySeven - Sun Mar 22, 2009 11:34 am</h4>
    <div class="postbody"><span class="postbody">If I could actually get the -S flag to work with my makefile, this would be really interesting.
<br/>
<br/>
-O3 and the 2nd version runs about 10x faster... (on the pathological best case of an empty top layer)</span><span class="gensmall"><br/><br/>Last edited by TwentySeven on Sun Mar 22, 2009 1:33 pm; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#167690 - Mighty Max - Sun Mar 22, 2009 12:00 pm</h4>
    <div class="postbody"><span class="postbody">Try "-save-temps"
<br/>
<br/>
-S does not work together with -g<br/>_________________<br/><a class="postlink" href="http://mightymax.org/gbamp_multiboot.html" target="_blank">GBAMP Multiboot</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167691 - TwentySeven - Sun Mar 22, 2009 12:10 pm</h4>
    <div class="postbody"><span class="postbody">Oh, thanks, that did it.
<br/>
<br/>
Grabbing the output now.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167692 - TwentySeven - Sun Mar 22, 2009 12:13 pm</h4>
    <div class="postbody"><span class="postbody">This is the o2 output for the 16 bit version
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
.Ltext0:
<br/>
   .align   2
<br/>
   .global   _Z21pixelscreen_Compositev
<br/>
   .type   _Z21pixelscreen_Compositev, %function
<br/>
_Z21pixelscreen_Compositev:
<br/>
   .fnstart
<br/>
.LFB107:
<br/>
   .file 1 "c:/projects/dsclient/source/Pixelscreen.cpp"
<br/>
   .loc 1 149 0
<br/>
   @ Function supports interworking.
<br/>
   @ args = 0, pretend = 0, frame = 0
<br/>
   @ frame_needed = 0, uses_anonymous_args = 0
<br/>
   @ link register save eliminated.
<br/>
.LBB11:
<br/>
   .loc 1 173 0
<br/>
   ldr   r1, .L12
<br/>
   ldr   r3, .L12+4
<br/>
   .loc 1 175 0
<br/>
   ldr   r2, .L12+8
<br/>
.LBE11:
<br/>
   .loc 1 149 0
<br/>
   stmfd   sp!, {r4, r5, r6, r7}
<br/>
   .save {r4, r5, r6, r7}
<br/>
.LCFI0:
<br/>
.LBB12:
<br/>
   .loc 1 173 0
<br/>
   ldr   r4, [r1, r3]
<br/>
   .loc 1 174 0
<br/>
   add   r3, r3, #8
<br/>
   .loc 1 175 0
<br/>
   ldr   r6, [r1, r2]
<br/>
   .loc 1 174 0
<br/>
   ldr   r7, [r1, r3]
<br/>
   .loc 1 175 0
<br/>
   mov   r1, #0
<br/>
   b   .L6
<br/>
.LVL0:
<br/>
.L11:
<br/>
   .loc 1 183 0
<br/>
   ldrh   r3, [r6, r1]
<br/>
   strh   r3, [r4, r1]   @ movhi
<br/>
.L3:
<br/>
   .loc 1 201 0
<br/>
   add   r1, r1, #2
<br/>
   .loc 1 178 0
<br/>
   cmp   r1, #49152
<br/>
   beq   .L10
<br/>
.L6:
<br/>
   .loc 1 180 0
<br/>
   ldrh   r2, [r7, r1]
<br/>
   .loc 1 181 0
<br/>
   cmp   r2, #0
<br/>
   beq   .L11
<br/>
   .loc 1 190 0
<br/>
   ands   r5, r2, #255
<br/>
   moveq   r0, #0
<br/>
   movne   r0, #1
<br/>
   ands   ip, r2, #65280
<br/>
   moveq   r3, #0
<br/>
   andne   r3, r0, #1
<br/>
   cmp   r3, #0
<br/>
   .loc 1 192 0
<br/>
   strneh   r2, [r4, r1]   @ movhi
<br/>
   .loc 1 190 0
<br/>
   bne   .L3
<br/>
   .loc 1 195 0
<br/>
   cmp   ip, #0
<br/>
   movne   r3, #0
<br/>
   andeq   r3, r0, #1
<br/>
   cmp   r3, #0
<br/>
   .loc 1 197 0
<br/>
   ldrneh   r3, [r6, r1]
<br/>
   .loc 1 201 0
<br/>
   ldreqb   r3, [r6, r1]   @ zero_extendqisi2
<br/>
   .loc 1 197 0
<br/>
   bicne   r3, r3, #255
<br/>
   orrne   r3, r5, r3
<br/>
   .loc 1 201 0
<br/>
   orreq   r3, ip, r3
<br/>
   .loc 1 197 0
<br/>
   strneh   r3, [r4, r1]   @ movhi
<br/>
   .loc 1 201 0
<br/>
   streqh   r3, [r4, r1]   @ movhi
<br/>
   add   r1, r1, #2
<br/>
   .loc 1 178 0
<br/>
   cmp   r1, #49152
<br/>
   bne   .L6
<br/>
.L10:
<br/>
.LBE12:
<br/>
   .loc 1 211 0
<br/>
   ldmfd   sp!, {r4, r5, r6, r7}
<br/>
   bx   lr
<br/>
.L13:
<br/>
   .align   2
<br/>
.L12:
<br/>
   .word   global
<br/>
   .word   99976
<br/>
   .word   99980
<br/>
.LFE107:
<br/>
   .fnend
<br/>
   .size   _Z21pixelscreen_Compositev, .-_Z21pixelscreen_Compositev
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167693 - TwentySeven - Sun Mar 22, 2009 12:18 pm</h4>
    <div class="postbody"><span class="postbody">For the sake of completeness, the -O3 output is here:
<br/>
<br/>
<a href="http://www.mydevstuff.com/twoseven/athia/o3Output.txt" target="_blank">http://www.mydevstuff.com/twoseven/athia/o3Output.txt</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167694 - Mighty Max - Sun Mar 22, 2009 12:39 pm</h4>
    <div class="postbody"><span class="postbody">There is still place for optimization. 
<br/>
Esp when merging the two components.
<br/>
<br/>
Something along
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
      const int curTop = *toplayer ;
<br/>
      u16 mask = (curTop  &amp; 0xFF00)?0xFF00:0 ;
<br/>
      mask = mask | ((curTop  &amp; 0xFF)?0xFF:0 ;
<br/>
<br/>
      if (mask == 0xFFFF)
<br/>
      {
<br/>
         *dest = curTop ; /* complete from top layer */
<br/>
      } else
<br/>
      {                          /* merge from both */
<br/>
         *dest = (curTop &amp; mask) | (*botlayer &amp; ~mask) ;
<br/>
      }          
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
This "should" remove the step over the boolean values and branching for them (topA and topB)<br/>_________________<br/><a class="postlink" href="http://mightymax.org/gbamp_multiboot.html" target="_blank">GBAMP Multiboot</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167697 - TwentySeven - Sun Mar 22, 2009 1:36 pm</h4>
    <div class="postbody"><span class="postbody">Hmm I see what you're done there :)
<br/>
<br/>
Under -O3 it comes out to the same speed on the hardware, still about 8ms for ~70% best case.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167699 - Mighty Max - Sun Mar 22, 2009 2:02 pm</h4>
    <div class="postbody"><span class="postbody">Depending on where you have those buffers (doesn't seem to be vram if you previously did it by 8bit access) you can easily extend it to do 4 pixels each iteration with the masks. 
<br/>
That will however only make noticeable difference if you have a 32bit bus to the mem.<br/>_________________<br/><a class="postlink" href="http://mightymax.org/gbamp_multiboot.html" target="_blank">GBAMP Multiboot</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167700 - TwentySeven - Sun Mar 22, 2009 2:27 pm</h4>
    <div class="postbody"><span class="postbody">Like this, right?
<br/>
<br/>
Thats about 12% faster.. 8ms down to 6-7ms - that implys I have a 32bit bus right?
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
   int j=(256*192)/4;   
<br/>
   uint32* dest=(uint32*)global.screens[0];
<br/>
   uint32* toplayer=(uint32*)global.screens[2];
<br/>
   uint32* botlayer=(uint32*)global.screens[1];
<br/>
   
<br/>
   while(j--)
<br/>
   {
<br/>
      
<br/>
      if(*toplayer ==0)  
<br/>
      {  
<br/>
         *dest = *botlayer;
<br/>
      }
<br/>
      else
<br/>
      {
<br/>
   
<br/>
         const int curTop = *toplayer ; 
<br/>
          u32 mask = (curTop  &amp; 0xFF000000) ? 0xFF000000 : 0; 
<br/>
          mask = mask | ((curTop  &amp; 0x00FF0000) ? 0x00FF0000 : 0); 
<br/>
         mask = mask | ((curTop  &amp; 0x0000FF00) ? 0x0000FF00 : 0); 
<br/>
         mask = mask | ((curTop  &amp; 0x000000FF) ? 0x000000FF : 0); 
<br/>
           if (mask == 0xFFFFFFFF) 
<br/>
         { 
<br/>
            *dest = curTop ; /* complete from top layer */ 
<br/>
         } else 
<br/>
         {                          /* merge from both */ 
<br/>
            *dest = (curTop &amp; mask) | (*botlayer &amp; ~mask) ; 
<br/>
         }          
<br/>
<br/>
      }
<br/>
<br/>
      dest++;
<br/>
      botlayer++;
<br/>
      toplayer++;
<br/>
   }
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167701 - Mighty Max - Sun Mar 22, 2009 2:45 pm</h4>
    <div class="postbody"><span class="postbody">I'd say so. 
<br/>
Cache might play in here too (Which is def. connected by the full bus width)<br/>_________________<br/><a class="postlink" href="http://mightymax.org/gbamp_multiboot.html" target="_blank">GBAMP Multiboot</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167702 - a128 - Sun Mar 22, 2009 3:56 pm</h4>
    <div class="postbody"><span class="postbody">One question: Why optimizing? Finish your game and then profile..if it's to slow.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167704 - Mighty Max - Sun Mar 22, 2009 5:08 pm</h4>
    <div class="postbody"><span class="postbody">Well if it comes to that, i'd use the hardware features.
<br/>
But i somehow think this is part of some emulating.<br/>_________________<br/><a class="postlink" href="http://mightymax.org/gbamp_multiboot.html" target="_blank">GBAMP Multiboot</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167705 - Cearn - Sun Mar 22, 2009 6:45 pm</h4>
    <div class="postbody"><span class="postbody">Haven't tried this yet, but it should be decent:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void bmp8AlphaBlit(const void *topv, const void *bottomv, void *dstv)
<br/>
{
<br/>
   u32 *topD= (u32*)topv;
<br/>
   u32 *botD= (u32*)bottomv;
<br/>
   u32 *dstD= (u32*)dstv;
<br/>
<br/>
   const u32 baseMask= 0x01010101;
<br/>
<br/>
   for(int i=0; i&lt;256*192/4; i++)
<br/>
   {
<br/>
      u32 top= *topD++;
<br/>
      u32 mask = top | top&gt;&gt;4;
<br/>
      if(mask != 0)
<br/>
      {
<br/>
         mask |= mask&gt;&gt;2;
<br/>
         mask |= mask&gt;&gt;1;
<br/>
         mask  = (mask&amp;baseMask)*255;
<br/>
         top  |= *botD++ &amp;~ mask;
<br/>
      }
<br/>
      else
<br/>
         top= *botD++;
<br/>
<br/>
      *dstD++ = top;
<br/>
   }
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
Optimizing the loop condition in C is usually pointless. It'll usually be converted into an incrementing loop (i.e., for(;;i++) ) anyway. According to the manual, loads and stores <span style="font-style: italic">should</span> be 1 cycle if waitstates and interlocks aren't an issue. Special casing if mask==0xFFFFFFFF might actually cost a little more due to the extra instructions it requires. This will depend on caching and how random the top buffer's data is. 
<br/>
<br/>
For the mask, don't use the ternary operator. The false-expression adds in unnecessary instructions. Instead, try a form of binary search pattern. if you have a byte with bit-pattern 'abcdefgh', x |= x&gt;&gt;4; combines both nybbles. x |= x&gt;&gt;2 then combines combines pairs and x |= x&gt;&gt;1 effectively makes bit 0 the inclusive OR over all 8 bits. remove the junk from the other bits and *255 for the final mask. The first step in this process is actually done early and used for the fully-transparent case, because if x==0, then x|x&gt;&gt;4 will be as well. (Hat tip to Cydrak for demonstrating this in a post looong ago)
<br/>
<br/>
You don't need to mask the top data. Since the mask was based on the top data, you'd just be masking out zeroes.
<br/>
<br/>
Unfortunately, the compiler doesn't <span style="font-style: italic">quite</span> give the best output, so here's the asm version as well. Add the initialization of r0-r2 if necessary.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">    .text
<br/>
    .arm
<br/>
    .align
<br/>
    .global .bmp8AlphaBlit
<br/>
.bmp8AlphaBlit
<br/>
    @ reglist:
<br/>
    @ r0 : top ptr
<br/>
    @ r1 : bottom ptr
<br/>
    @ r2 : destination ptr
<br/>
    @ r3 : size
<br/>
    @ r4 : top / tmp data
<br/>
    @ r5 : bottom data
<br/>
    @ r6 : mask required for making the pixel mask
<br/>
    @ ip : pixel mask
<br/>
<br/>
    stmfd   sp!, {r4-r6}
<br/>
<br/>
    ldr     r3,=256*192/4
<br/>
    ldr     r6,=0x01010101
<br/>
<br/>
.Lloop:
<br/>
    ldmia   r4, {r0}
<br/>
    orrs    ip, ip, r4, lsr #4      @ First step in mask prep
<br/>
    @ --- Full see-through ---
<br/>
    ldmeqia r4, {r1}
<br/>
    beq     .Lwrite
<br/>
<br/>
    @ --- Partial see-through ---
<br/>
    ldmia   r5, {r1}
<br/>
                                    @ + Mask prep. Bits: abcdefgh
<br/>
    @ orrs  ip, ip, r4, lsr #4        | (ae)(bf)(cg)(dh)
<br/>
    orr     ip, ip, r4, lsr #2      @ | (aceg)(bdfh)
<br/>
    orr     ip, ip, ip, lsr #1      @ | (abcdefgh)
<br/>
    and     ip, ip, r6              @ | bit 0: 1 if any of abcdefgh were set
<br/>
    rsb     ip, ip, ip, lsl #8      @ + *255
<br/>
<br/>
    bic     r5, r5, ip              @ - top | (bottom &amp;~ mask)
<br/>
    orr     r4, r4, r5              @ /
<br/>
<br/>
.Lwrite:
<br/>
    subs    r3, r3, #1
<br/>
    stmia   r4, {r2}                @ Delayed write.
<br/>
    bne .Lloop
<br/>
<br/>
    ldmfd   sp!, {r4-r6}
<br/>
    bx      lr
<br/>
<br/>
    .size   bmp8AlphaBlit, .-bmp8AlphaBlit
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167706 - TwentySeven - Sun Mar 22, 2009 7:04 pm</h4>
    <div class="postbody"><span class="postbody">Thankyou very much for your help, guys.
<br/>
<br/>
a128:  Aye, and typically thats exactly how I work.  Unfortunately I need to get software blitting up alot faster then my original naieve "it works" version, as theres other similar bits of code scheduled.
<br/>
<br/>
So this is more research, then development.
<br/>
<br/>
Theres bugger-all performance difference between the last 3 versions pasted here, the (beautiful...) hand asm'd version is 6 to 7ms.   
<br/>
<br/>
Over twice as fast as the original byte-by-byte c version.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167707 - Mighty Max - Sun Mar 22, 2009 7:37 pm</h4>
    <div class="postbody"><span class="postbody">The bitmasking is quite elegant there, Cearn. :-)
<br/>
<br/>
For the check against 0xFFFFFFFF i'm not quite with you. It really depends on the average situation there tho, how often there will be a row of 4 solids.
<br/>
<br/>
The check itself is just a CMN rN,#1 taking 1S cycle. (added to all cases with at leat one visible top pixel)
<br/>
This compare can skip (ldr with ne condition) the load of the bottom pixels (r5 in your code if its moved just before the mask is applied) which will reduces execution time in this case by 1N +1I cycle.
<br/>
<br/>
So depending on the amount filled in top that additional 1S might be helpfull.<br/>_________________<br/><a class="postlink" href="http://mightymax.org/gbamp_multiboot.html" target="_blank">GBAMP Multiboot</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167708 - FluBBa - Sun Mar 22, 2009 9:16 pm</h4>
    <div class="postbody"><span class="postbody">I guess you can cut out one of the ldm like this
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
.Lloop:
<br/>
    ldmia   r0!, {r4}
<br/>
    orrs    ip, ip, r4, lsr #4      @ First step in mask prep
<br/>
    @ --- Full see-through ---
<br/>
    ldmia r1!, {r5}
<br/>
    beq     .Lwrite
<br/>
<br/>
    @ --- Partial see-through ---
<br/>
                                    @ + Mask prep. Bits: abcdefgh
<br/>
    @ orrs  ip, ip, r4, lsr #4        | (ae)(bf)(cg)(dh)
<br/>
    orr     ip, ip, r4, lsr #2      @ | (aceg)(bdfh)
<br/>
    orr     ip, ip, ip, lsr #1      @ | (abcdefgh)
<br/>
    and     ip, ip, r6              @ | bit 0: 1 if any of abcdefgh were set
<br/>
    rsb     ip, ip, ip, lsl #8      @ + *255
<br/>
<br/>
    bic     r5, r5, ip              @ - top | (bottom &amp;~ mask)
<br/>
    orr     r5, r4, r5              @ /
<br/>
<br/>
.Lwrite:
<br/>
    subs    r3, r3, #1
<br/>
    stmia   r2!, {r5}                @ Delayed write.
<br/>
    bne .Lloop
<br/>
</td> </tr></table><span class="postbody"><br/>_________________<br/>I probably suck, my not is a programmer.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167711 - TwentySeven - Mon Mar 23, 2009 2:54 am</h4>
    <div class="postbody"><span class="postbody">Woops!  I wasn't paying enough attention to my compiler output.
<br/>
<br/>
I havn't been able to make the hand-asm'd version work.
<br/>
It's linking correctly, however, it doesnt appear to generate any output.
<br/>
<br/>
(the C version of the function was getting 6-7ms)
<br/>
<br/>
Any clue as to whats wrong?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167714 - Cearn - Mon Mar 23, 2009 8:22 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>TwentySeven wrote:</b></span></td> </tr> <tr> <td class="quote">Woops!  I wasn't paying enough attention to my compiler output.
<br/>
<br/>
I havn't been able to make the hand-asm'd version work.
<br/>
It's linking correctly, however, it doesnt appear to generate any output.
<br/>
<br/>
(the C version of the function was getting 6-7ms)
<br/>
<br/>
Any clue as to whats wrong?</td> </tr></table><span class="postbody">I seem to have made a few errors here. Treated ldm/stm as if they were ldr/str and had there should be no r4 in the ORR ... lsr #2 line. Together with Flubba's improvement (I swear there was a reason for the second bottom-load, but I really can't see what it was anymore).
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">    .text
<br/>
    .arm
<br/>
    .align
<br/>
    .global .bmp8AlphaBlit
<br/>
.bmp8AlphaBlit
<br/>
    @ reglist:
<br/>
    @ r0 : top ptr
<br/>
    @ r1 : bottom ptr
<br/>
    @ r2 : destination ptr
<br/>
    @ r3 : size
<br/>
    @ r4 : top / tmp data
<br/>
    @ r5 : bottom data
<br/>
    @ r6 : mask required for making the pixel mask
<br/>
    @ ip : pixel mask
<br/>
<br/>
    stmfd   sp!, {r4-r6}
<br/>
<br/>
    ldr     r3,=256*192/4
<br/>
    ldr     r6,=0x01010101
<br/>
<br/>
.Lloop:
<br/>
    ldmia   r0!, {r4}
<br/>
    ldmia   r1!, {r5}
<br/>
    orrs    ip, ip, r4, lsr #4      @ First step in mask prep, and C-thru test
<br/>
    beq     .Lwrite
<br/>
<br/>
    @ --- Partial see-through ---
<br/>
<br/>
    orr     ip, ip, ip, lsr #2      @ + rest of mask making 
<br/>
    orr     ip, ip, ip, lsr #1      @ | bit 0: 1 if any of bits 0-7 were set
<br/>
    and     ip, ip, r6              @ | 
<br/>
    rsb     ip, ip, ip, lsl #8      @ + *255
<br/>
<br/>
    bic     r5, r5, ip              @ - top | (bottom &amp;~ mask)
<br/>
    orr     r5, r4, r5              @ /
<br/>
<br/>
.Lwrite:
<br/>
    subs    r3, r3, #1
<br/>
    stmia   r2!, {r5}               @ Delayed write.
<br/>
    bne .Lloop
<br/>
<br/>
    ldmfd   sp!, {r4-r6}
<br/>
    bx      lr
<br/>
<br/>
    .size   bmp8AlphaBlit, .-bmp8AlphaBlit</td> </tr></table><span class="postbody"> If there are still problems, I'll try to run a test later to make sure it works.
<br/>
<br/>
Also note Mighty Max's point about the mask check. Unrolling a little may help too; I've noticed in the past that a double-load ldm is faster than two single ones, even though the docs say it shouldn't matter.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167715 - TwentySeven - Mon Mar 23, 2009 9:53 am</h4>
    <div class="postbody"><span class="postbody">Well, it displays now, but the bottom layer doesn't show through, so I guess its still buggy?
<br/>
<br/>
Thanks again for trying, though!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167716 - FluBBa - Mon Mar 23, 2009 1:31 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
    orrs    ip, ip, r4, lsr #4      @ First step in mask prep
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Should be:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
    orrs    ip, r4, r4, lsr #4      @ First step in mask prep
<br/>
</td> </tr></table><span class="postbody"><br/>_________________<br/>I probably suck, my not is a programmer.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
