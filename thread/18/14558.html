<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Keeping it 60fps - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>DS development > Keeping it 60fps</h2>
<div id="posts">
<div class="post">
    <h4>#145715 - Rajveer - Tue Nov 20, 2007 9:21 pm</h4>
    <div class="postbody"><span class="postbody">I have a menu which loads ships that the player can select, and (with everything else disabled) draws their icons along the bottom of the screen. The icons are moved along the screen as the user scrolls through the list. The location of the icons are stored in an array called icon_X which simply stores the icons x-coordinate, as all of its 4 corners can be worked out from that. When drawing 11 icons, the game runs at 60fps, running more makes it miss a VBlank and it runs at 30fps. The code is the following:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">while(app_Controller == 2)
<br/>
   {
<br/>
      //Scan Input
<br/>
      scanKeys();
<br/>
      
<br/>
// DRAW THE FADE POLYGON, SHIP, HUD AND ICONS:
<br/>
<br/>
      //Set Texture stack
<br/>
      glMatrixMode(GL_TEXTURE);
<br/>
      glLoadIdentity();
<br/>
      
<br/>
      //Set Projection stack (view) for fade (orthos)
<br/>
      glMatrixMode(GL_PROJECTION);
<br/>
      glLoadIdentity();
<br/>
      glOrthof32(0, 256, 0, 192, 0.1, 1000);
<br/>
      
<br/>
      //Set Modelview stack
<br/>
      glMatrixMode(GL_MODELVIEW);
<br/>
      glLoadIdentity();
<br/>
      
<br/>
      //Fade In if menu_Controller is 0
<br/>
      if(menu_Controller == 0)
<br/>
      {
<br/>
         //Draw a black quad with alpha set to fade variable, layer 1
<br/>
         glPolyFmt(POLY_ALPHA(fade) | POLY_CULL_NONE | POLY_ID(2));
<br/>
         
<br/>
         glBegin(GL_QUAD);
<br/>
         
<br/>
         glColor3b(0,0,0);
<br/>
         glVertex3v16(0, -65, -1); 
<br/>
         glVertex3v16(0, 193, -1); 
<br/>
         glVertex3v16(257, 193, -1);
<br/>
         glVertex3v16(257, -65, -1);
<br/>
      
<br/>
         glEnd();
<br/>
         
<br/>
         //Reduce alpha of black quad, check if fade has completed
<br/>
         fade -= 1;
<br/>
         if(fade &lt;= 0)
<br/>
         {
<br/>
            fade = 0;
<br/>
            menu_Controller = 1;
<br/>
         }
<br/>
      }
<br/>
      
<br/>
      //Check input, move elements, change 3D model if menu_Controller is 1
<br/>
      else if(menu_Controller == 1)
<br/>
      {
<br/>
           //Check for left/right
<br/>
         if(keysDown() &amp; KEY_RIGHT)
<br/>
         {
<br/>
            timer_Left = 0;
<br/>
            timer_Held = 0;
<br/>
            ship_Current++;
<br/>
         }
<br/>
         else if(keysDown() &amp; KEY_LEFT)
<br/>
         {
<br/>
            timer_Left = 0;
<br/>
            timer_Held = 0;
<br/>
            ship_Current--;
<br/>
         }
<br/>
         else if(keysHeld() &amp; KEY_RIGHT)
<br/>
         {
<br/>
            timer_Left = 0;
<br/>
            timer_Held++;
<br/>
            if(timer_Held &gt; 9)
<br/>
            {
<br/>
               timer_Ship++;
<br/>
               if(timer_Ship &gt; 3)
<br/>
               {
<br/>
                  timer_Ship = 0;
<br/>
                  ship_Current++;
<br/>
               }
<br/>
            }
<br/>
         }
<br/>
         else if(keysHeld() &amp; KEY_LEFT)
<br/>
         {
<br/>
            timer_Left = 0;
<br/>
            timer_Held++;
<br/>
            if(timer_Held &gt; 9)
<br/>
            {
<br/>
               timer_Ship++;
<br/>
               if(timer_Ship &gt; 3)
<br/>
               {
<br/>
                  timer_Ship = 0;
<br/>
                  ship_Current--;
<br/>
               }
<br/>
            }
<br/>
         }
<br/>
<br/>
         else if(!keysDown() &amp;&amp; !keysHeld())
<br/>
         {
<br/>
            timer_Left++;
<br/>
            timer_Ship = 0;
<br/>
            timer_Held = 0;
<br/>
         }
<br/>
         
<br/>
         if(ship_Current &gt; (ship_Number - 1))
<br/>
         {ship_Current = (ship_Number - 1);}
<br/>
         else if(ship_Current &lt; 0)
<br/>
         {ship_Current = 0;}
<br/>
               
<br/>
         //Check if current ship is in middle, if not move all icons till correct one is in middle
<br/>
         if(icon_X[ship_Current] &gt; 112)
<br/>
         {
<br/>
            for(temp_Counter = 0; temp_Counter &lt; ship_Number; temp_Counter++)
<br/>
            {
<br/>
               icon_X[temp_Counter] -= 8;
<br/>
            }   
<br/>
         }
<br/>
         else if(icon_X[ship_Current] &lt; 112)
<br/>
         {
<br/>
            for(temp_Counter = 0; temp_Counter &lt; ship_Number; temp_Counter++)
<br/>
            {
<br/>
               icon_X[temp_Counter] += 8;
<br/>
            }   
<br/>
         }
<br/>
         else
<br/>
         {
<br/>
            if(!keysDown() &amp;&amp; !keysHeld())
<br/>
            {
<br/>
               if(ship_Current_Loaded != ship_Current)
<br/>
               {
<br/>
                  if(timer_Left &gt; 8)
<br/>
                  {
<br/>
                     //Retrieve current address of texture and texture palette, unload ship, load new ship
<br/>
                     //whilst loading new texture and texture palette into correct address
<br/>
                     ObjReloadShip(ships[ship_Current].folder_Name, loaded_Ship, 1, 1, 1);
<br/>
                     ship_Current_Loaded = ship_Current;                     
<br/>
                  }
<br/>
               }   
<br/>
            }
<br/>
         }   
<br/>
         
<br/>
         if(keysDown() &amp; KEY_A)
<br/>
         {
<br/>
            menu_Controller = 2;
<br/>
         }   
<br/>
      }
<br/>
      
<br/>
// DRAW THE SELECTED SHIP (PERSPECTIVE):
<br/>
     //DISABLED!!
<br/>
<br/>
// DRAW THE HUD AND ICONS (ORTHOGRAPHIC):
<br/>
   //DISABLED!!
<br/>
      
<br/>
      //Set viewport for whole screen
<br/>
      glViewport(0,0,255,191); //Viewport is changed when drawing the ship too, so is called twice usually
<br/>
      
<br/>
      //Draw the HUD, layer 4
<br/>
      //Set Texture stack
<br/>
      glMatrixMode(GL_TEXTURE);
<br/>
      glLoadIdentity();
<br/>
      
<br/>
      //Set Projection stack (view) for the HUD
<br/>
      glMatrixMode(GL_PROJECTION);
<br/>
      glLoadIdentity();
<br/>
      glOrthof32(0, 256, 0, 192, 0.1, 1000);
<br/>
      
<br/>
      //Set Modelview stack
<br/>
      glMatrixMode(GL_MODELVIEW);
<br/>
      glLoadIdentity();
<br/>
      
<br/>
      //Draw Icons, layer 3
<br/>
      for(temp_Counter = 0; temp_Counter &lt; ship_Number; temp_Counter++)
<br/>
      {
<br/>
         glPolyFmt(POLY_ALPHA(31) | POLY_CULL_NONE | POLY_ID(2));
<br/>
         glBindTexture(GL_TEXTURE_2D, texture_Icon[temp_Counter]);
<br/>
         glColorTable(GL_RGB16, texture_Icon_Palette[temp_Counter]);
<br/>
               
<br/>
         glBegin(GL_QUAD);
<br/>
         
<br/>
         glColor3b(255,255,255);
<br/>
         glTexCoord2t16(0,512);
<br/>
         glVertex3v16(icon_X[temp_Counter], 0, -3); 
<br/>
         glTexCoord2t16(0,0);
<br/>
         glVertex3v16(icon_X[temp_Counter], 32, -3); 
<br/>
         glTexCoord2t16(512,0);
<br/>
         glVertex3v16(icon_X[temp_Counter] + 32, 32, -3);
<br/>
         glTexCoord2t16(512,512);
<br/>
         glVertex3v16(icon_X[temp_Counter] + 32, 0, -3);
<br/>
         
<br/>
         glEnd();
<br/>
         glBindTexture(0, 0);
<br/>
      }
<br/>
      
<br/>
        swiWaitForVBlank();
<br/>
      GFX_FLUSH = 0;
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
Should the code, along with repeating drawing the icons 11 times at the end and modifying the icons x-coordinate if the right one isn't in the middle, be capped at 30fps? What can I change/what am I doing wrong??
<br/>
<br/>
P.S. Obviously the situation worsens when actually drawing the 3D models and HUD icons, but that's all disabled and that's probably because I'm not using display lists with the models (going through an array of triangles, which links to arrays of vertices, normals, texture coords).
<br/>
P.P.S. I've cut out some menu loading code before the first while loop i.e. loading ship models, icons, filling the icon_X array e.t.c.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#145716 - Mighty Max - Tue Nov 20, 2007 9:43 pm</h4>
    <div class="postbody"><span class="postbody">GFX_FLUSH = x
<br/>
<br/>
is not executed before the next vblank. Since you are calling it just after the vblank you are wasting a frame each time<br/>_________________<br/><a class="postlink" href="http://mightymax.org/gbamp_multiboot.html" target="_blank">GBAMP Multiboot</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#145728 - Rajveer - Wed Nov 21, 2007 1:19 am</h4>
    <div class="postbody"><span class="postbody">So the code I posted takes more than a frame to process? That seems a bit weird, it's not doing that much I would have thought, modifying some variables and drawing a few quads. Can anybody find where my code may be slowing down? (I can spot some bad coding but nothing that should have this much of an effect)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#145730 - tepples - Wed Nov 21, 2007 1:47 am</h4>
    <div class="postbody"><span class="postbody">Profile your code.
<br/>
<br/>
The quick and dirty way to do this is to play with the palette or the enabled backgrounds after drawing each object. This allows you to see the time each step takes as the thickness of a bar across the screen. Thinner bar == faster code.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#145734 - wintermute - Wed Nov 21, 2007 4:09 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Rajveer wrote:</b></span></td> </tr> <tr> <td class="quote">So the code I posted takes more than a frame to process? That seems a bit weird, it's not doing that much I would have thought, modifying some variables and drawing a few quads. Can anybody find where my code may be slowing down? (I can spot some bad coding but nothing that should have this much of an effect)</td> </tr></table><span class="postbody">
<br/>
<br/>
No, he's saying that the write to GFX_FLUSH effectively causes a second wait for vblank when you start to fill the geometry pipeline again since the buffer swap isn't completed until the vblank period following the write.
<br/>
<br/>
Try placing the GFX_FLUSH = 0; *before* the swiWaitForVBlank();
<br/>
<br/>
On hardware the swi will have effectively no effect since the processor gets stalled until buffer swap completion when it tries to write more geometry data. As far as I can tell this behaviour is not emulated on any of the popular DS emulators, including no$gba ( up to 2.5b at least, I haven't tested on the just released 2.5c as yet)<br/>_________________<br/><a class="postlink" href="http://www.devkitpro.org/" target="_blank">devkitPro - professional toolchains at amateur prices</a>
<br/>
<a class="postlink" href="http://wiki.devkitpro.org/index.php/IRC" target="_blank">devkitPro IRC support</a>
<br/>
<a class="postlink" href="http://davejmurphy.com/" target="_blank">Personal Blog</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#145749 - Rajveer - Wed Nov 21, 2007 2:08 pm</h4>
    <div class="postbody"><span class="postbody">Ahhah! Cheers for that guys, it works fine now. Funny thing is that I never picked up on that bug and I always wondered why my demos and projects only run at 30fps, haha.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
