<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Need help with FAT porting - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>DS development > Need help with FAT porting</h2>
<div id="posts">
<div class="post">
    <h4>#64126 - FloFri - Mon Dec 19, 2005 6:46 pm</h4>
    <div class="postbody"><span class="postbody">Hi!
<br/>
I want to port the file-class of the new movie player by Moonlight to the GMAMP with chisms FAT driver. This is the class:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">CStream::CStream(char *filename)
<br/>
{
<br/>
  fhandle = FAT_fopen(filename, "r");
<br/>
  size = FAT_GetFileSize();
<br/>
}
<br/>
<br/>
CStream::~CStream(void)
<br/>
{
<br/>
  FAT_fclose(fhandle);
<br/>
}
<br/>
<br/>
int CStream::GetOffset(void) const
<br/>
{
<br/>
  return FAT_ftell(fhandle);
<br/>
}
<br/>
<br/>
void CStream::SetOffset(int _ofs)
<br/>
{
<br/>
  if(size&lt;FAT_ftell(fhandle)) 
<br/>
    FAT_fseek(fhandle, size, 0);
<br/>
  else
<br/>
    FAT_fseek(fhandle, _ofs, 0);
<br/>
}
<br/>
<br/>
int CStream::GetSize(void) const
<br/>
{
<br/>
  return(size);
<br/>
}
<br/>
<br/>
void CStream::OverrideSize(int _size)
<br/>
{
<br/>
  return;
<br/>
}
<br/>
<br/>
bool CStream::eof(void) const
<br/>
{
<br/>
  return FAT_feof(fhandle);
<br/>
}
<br/>
<br/>
u8 CStream::Readu8(void)
<br/>
{
<br/>
  if(eof()==true) return(0);
<br/>
  char temp = FAT_fgetc(fhandle);
<br/>
  FAT_fseek(fhandle, 1, FAT_ftell(fhandle));
<br/>
  return(temp);
<br/>
}
<br/>
<br/>
u16 CStream::Readu16(void)
<br/>
{
<br/>
  u16 data;
<br/>
  
<br/>
  data=(u16)Readu8();
<br/>
  data=data | ((u16)Readu8() &lt;&lt; 8);
<br/>
  
<br/>
  return(data);
<br/>
}
<br/>
<br/>
u32 CStream::Readu32(void)
<br/>
{
<br/>
  u32 data;
<br/>
  
<br/>
  data=(u32)Readu8();
<br/>
  data=data | ((u32)Readu8() &lt;&lt; 8);
<br/>
  data=data | ((u32)Readu8() &lt;&lt; 16);
<br/>
  data=data | ((u32)Readu8() &lt;&lt; 24);
<br/>
  
<br/>
  return(data);
<br/>
}
<br/>
<br/>
int CStream::ReadBuffer(void *_dstbuf,const int _readsize)
<br/>
{
<br/>
  if(eof()==true) return(0);
<br/>
  
<br/>
  int readsize = FAT_fread(_dstbuf, _readsize, sizeof(char), fhandle);
<br/>
  
<br/>
  return(readsize);
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
Can someone tell me if he can find any mistakes in this code, because the function Readu32 seems to return 0 all the time.
<br/>
<br/>
Thanks in advance.
<br/>
FloFri</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#64147 - duencil - Mon Dec 19, 2005 8:58 pm</h4>
    <div class="postbody"><span class="postbody">Careful with your arguments to fseek. The third param should be 0, 1 or 2.  Actually you can remove the fseek in Readu8 altogether, fgetc advances a character anyway. Not sure why you move to the eof in the first result of the conditional in SetOffset, maybe you meant your condition to be 
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code"> if(size&lt; _ofs)</td> </tr></table><span class="postbody">
<br/>
<br/>
Otherwise, I don't know much about chisms FAT driver, so can't help you more. Good luck!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#64165 - FloFri - Mon Dec 19, 2005 10:58 pm</h4>
    <div class="postbody"><span class="postbody">Thanks for your help! I finally got the mistake! I forgot to call FAT_InitFiles();
<br/>
<br/>
Thanks for your help!
<br/>
<br/>
(P.s.: I GOT IT! I got a movie with GBAMP directly from CF! There a some graphic glitches but i have to look what, if i use a lower framerate! So stay tuned!)</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
