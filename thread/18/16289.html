<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Audio streamer v2.0.1 /w source - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>DS development > Audio streamer v2.0.1 /w source</h2>
<div id="posts">
<div class="post">
    <h4>#165392 - DiscoStew - Fri Dec 19, 2008 7:22 am</h4>
    <div class="postbody"><span class="postbody">Here it is. Version 2. The decoder has been converted into assembly, and processing time have been reduced, with stereo by about half of prior c++ implementations. Still only regular PCM and IMA-ADPCM formats. eKid allowed me to use his decoder/player template from his ms-adpcm decoder, so credit to him on that, but I made some extra adjustments with it. The interface is therefore different from the prior version, so update your code.
<br/>
<br/>
<a href="http://www.mediafire.com/?dubioj42m4e" target="_blank">http://www.mediafire.com/?dubioj42m4e</a>
<br/>
<br/>
Decoding times (not including read times):
<br/>
<br/>
22kHz Mono - 4 scanlines decode (~1.5% CPU)
<br/>
22kHz Stereo - 6-7 scanlines decode (~2.5% CPU)
<br/>
44Khz Stereo - 13 scanlines decode (~5% CPU)
<br/>
<br/>
NOTE:
<br/>
Decoder supports both manual and auto mode, but auto mode sometimes suffers from audio cutoff due to a bug in Maxmod. eKid fixed this issue in the newest Maxmod svn, so unless you've compiled the newest svn yourself (or until it is compiled into the new build), just stick with the manual mode.
<br/>
<br/>
<span style="text-decoration: underline">Latest changes/fixes</span>:
<br/>
<ul>Fixed pcm loop streaming
<br/>
</ul>
<br/>
<br/>
EDIT:
<br/>
<br/>
3/23/10 - Re-uploaded to MediaFire with link fixed.<br/>_________________<br/><span style="font-weight: bold">DS</span> - It's all about <span style="font-weight: bold">D</span>isco<span style="font-weight: bold">S</span>tew</span><span class="gensmall"><br/><br/>Last edited by DiscoStew on Wed Mar 31, 2010 6:50 pm; edited 9 times in total</span></div>    
</div>
<div class="post">
    <h4>#165404 - a128 - Fri Dec 19, 2008 5:55 pm</h4>
    <div class="postbody"><span class="postbody">thanks. but with source the community would kiss you :-)</span><span class="gensmall"><br/><br/>Last edited by a128 on Sat Dec 20, 2008 9:25 am; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#165406 - DiscoStew - Fri Dec 19, 2008 6:48 pm</h4>
    <div class="postbody"><span class="postbody">I am planning to release the code, but first, I need to add a lot of comments as to how it works, because right now, it practically has none, and some of the optimizations to the ADPCM decoder look rather odd without them.
<br/>
<br/>
EDIT:
<br/>
<br/>
Commenting of the streaming code is done, but not for the directory code that allows scanning of folders and files. Should get it all done by tonight or tomorrow morning.<br/>_________________<br/><span style="font-weight: bold">DS</span> - It's all about <span style="font-weight: bold">D</span>isco<span style="font-weight: bold">S</span>tew</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#165413 - DiscoStew - Fri Dec 19, 2008 9:56 pm</h4>
    <div class="postbody"><span class="postbody">Ok, I did a good amount of commenting on the stream portion, and just a little with the directory stuff, but it should all be there for people to tinker with. The main focus of this whole thing was the audio streaming.
<br/>
<br/>
Because of a few problems related to using the filesystem with both the audio playback and scanning directories, I locked out scanning until the user stops playback. If someone else has a better way to do this (or can get both to work much better together), I'd appreciate your input.<br/>_________________<br/><span style="font-weight: bold">DS</span> - It's all about <span style="font-weight: bold">D</span>isco<span style="font-weight: bold">S</span>tew</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#165419 - JYC376 - Fri Dec 19, 2008 11:46 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>DiscoStew wrote:</b></span></td> </tr> <tr> <td class="quote">Ok, I did a good amount of commenting on the stream portion, and just a little with the directory stuff, but it should all be there for people to tinker with. The main focus of this whole thing was the audio streaming.
<br/>
<br/>
Because of a few problems related to using the filesystem with both the audio playback and scanning directories, I locked out scanning until the user stops playback. If someone else has a better way to do this (or can get both to work much better together), I'd appreciate your input.</td> </tr></table><span class="postbody">
<br/>
<br/>
Do NOT use the POSIX opendir...There's some problems in libfat, with that.  Use diropen instead: <a class="postlink" href="http://chishm.drunkencoders.com/libfat/" target="_blank">http://chishm.drunkencoders.com/libfat/</a>
<br/>
<br/>
Thanks for the streaming, though!  Came just in time for my project =)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#165422 - DiscoStew - Sat Dec 20, 2008 12:19 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>JYC376 wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>DiscoStew wrote:</b></span></td> </tr> <tr> <td class="quote">Ok, I did a good amount of commenting on the stream portion, and just a little with the directory stuff, but it should all be there for people to tinker with. The main focus of this whole thing was the audio streaming.
<br/>
<br/>
Because of a few problems related to using the filesystem with both the audio playback and scanning directories, I locked out scanning until the user stops playback. If someone else has a better way to do this (or can get both to work much better together), I'd appreciate your input.</td> </tr></table><span class="postbody">
<br/>
<br/>
Do NOT use the POSIX opendir...There's some problems in libfat, with that.  Use diropen instead: <a class="postlink" href="http://chishm.drunkencoders.com/libfat/" target="_blank">http://chishm.drunkencoders.com/libfat/</a>
<br/>
<br/>
Thanks for the streaming, though!  Came just in time for my project =)</span></td> </tr></table><span class="postbody">
<br/>
<br/>
Interesting. Perhaps the libfat example in the toolchain should be updated to reflect this as well, because I started the directory code with that example as a template, and it had opendir in there instead of diropen. I'll get to uploading a fixed version of the project tonight.<br/>_________________<br/><span style="font-weight: bold">DS</span> - It's all about <span style="font-weight: bold">D</span>isco<span style="font-weight: bold">S</span>tew</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#165424 - wintermute - Sat Dec 20, 2008 2:04 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>JYC376 wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
<br/>
Do NOT use the POSIX opendir...There's some problems in libfat, with that.  Use diropen instead: <a class="postlink" href="http://chishm.drunkencoders.com/libfat/" target="_blank">http://chishm.drunkencoders.com/libfat/</a>
<br/>
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
what kind of problems?
<br/>
<br/>
hint: if you found a bug, use the tracker on SF and report it. Please don't just post random messages in forums telling people not to use stuff.
<br/>
<br/>
<a href="http://sourceforge.net/tracker2/?group_id=114505&amp;atid=668551" target="_blank">http://sourceforge.net/tracker2/?group_id=114505&amp;atid=668551</a><br/>_________________<br/><a class="postlink" href="http://www.devkitpro.org/" target="_blank">devkitPro - professional toolchains at amateur prices</a>
<br/>
<a class="postlink" href="http://wiki.devkitpro.org/index.php/IRC" target="_blank">devkitPro IRC support</a>
<br/>
<a class="postlink" href="http://davejmurphy.com/" target="_blank">Personal Blog</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#165425 - wintermute - Sat Dec 20, 2008 2:09 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>DiscoStew wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
I only have 2 formats available for playback atm, one being uncompressed PCM, and the other is IMA-ADPCM, which is software decompressed unfortunately, as the hardware limitation screws over streaming it that way.
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Not to rain on your parade here or anything but I'm pretty sure eKid has IMA-ADPCM decoding built into maxmod somewhere. I know he was working on it prior to release but I'm not sure if the interface was exposed yet.
<br/>
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
with the way I did the simple interface, the audio would bleep and freeze while scanning the files and such, so I locked out that until the user stops the audio playback.</td> </tr></table><span class="postbody">
<br/>
<br/>
Are you attempting file IO in interrupts, cos that *really* isn't going to work.
<br/>
<br/>
As for releasing source, get eKid to check it over &amp; we can maybe shove it in the official example set, if you're willing.<br/>_________________<br/><a class="postlink" href="http://www.devkitpro.org/" target="_blank">devkitPro - professional toolchains at amateur prices</a>
<br/>
<a class="postlink" href="http://wiki.devkitpro.org/index.php/IRC" target="_blank">devkitPro IRC support</a>
<br/>
<a class="postlink" href="http://davejmurphy.com/" target="_blank">Personal Blog</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#165428 - JYC376 - Sat Dec 20, 2008 2:27 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>wintermute wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>JYC376 wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
<br/>
Do NOT use the POSIX opendir...There's some problems in libfat, with that.  Use diropen instead: <a class="postlink" href="http://chishm.drunkencoders.com/libfat/" target="_blank">http://chishm.drunkencoders.com/libfat/</a>
<br/>
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
what kind of problems?
<br/>
<br/>
hint: if you found a bug, use the tracker on SF and report it. Please don't just post random messages in forums telling people not to use stuff.
<br/>
<br/>
<a href="http://sourceforge.net/tracker2/?group_id=114505&amp;atid=668551" target="_blank">http://sourceforge.net/tracker2/?group_id=114505&amp;atid=668551</a></span></td> </tr></table><span class="postbody">
<br/>
<br/>
Completely no idea...Ask chishm: <a class="postlink" href="http://chishm.drunkencoders.com/libfat/" target="_blank">http://chishm.drunkencoders.com/libfat/</a>
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Directory functions do not follow POSIX standards. Custom functions are used for various reasons. </td> </tr></table><span class="postbody"></span><span class="gensmall"><br/><br/>Last edited by JYC376 on Sat Dec 20, 2008 2:29 am; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#165429 - wintermute - Sat Dec 20, 2008 2:29 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>JYC376 wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
<br/>
Completely no idea...Ask chishm: <a class="postlink" href="http://chishm.drunkencoders.com/libfat/" target="_blank">http://chishm.drunkencoders.com/libfat/</a></td> </tr></table><span class="postbody">
<br/>
<br/>
Then don't make assumptions based on old web pages :p
<br/>
<br/>
opendir wasn't available on the DS when that page was written. It is now.<br/>_________________<br/><a class="postlink" href="http://www.devkitpro.org/" target="_blank">devkitPro - professional toolchains at amateur prices</a>
<br/>
<a class="postlink" href="http://wiki.devkitpro.org/index.php/IRC" target="_blank">devkitPro IRC support</a>
<br/>
<a class="postlink" href="http://davejmurphy.com/" target="_blank">Personal Blog</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#165430 - JYC376 - Sat Dec 20, 2008 2:30 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>wintermute wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>JYC376 wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
<br/>
Completely no idea...Ask chishm: <a class="postlink" href="http://chishm.drunkencoders.com/libfat/" target="_blank">http://chishm.drunkencoders.com/libfat/</a></td> </tr></table><span class="postbody">
<br/>
<br/>
Then don't make assumptions based on old web pages :p
<br/>
<br/>
opendir wasn't available on the DS when that page was written. It is now.</span></td> </tr></table><span class="postbody">
<br/>
<br/>
Oh, serious?!  Awesome.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#165434 - DiscoStew - Sat Dec 20, 2008 3:26 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>wintermute wrote:</b></span></td> </tr> <tr> <td class="quote">Not to rain on your parade here or anything but I'm pretty sure eKid has IMA-ADPCM decoding built into maxmod somewhere. I know he was working on it prior to release but I'm not sure if the interface was exposed yet.</td> </tr></table><span class="postbody">
<br/>
He posted <a class="postlink" href="http://forum.gbadev.org/viewtopic.php?t=15830" target="_blank">here</a> about it with a test program for us to try, but I don't think that was related to streaming, but with the sequenced music. He commented out the two ADPCM enums in the mm_types header, because "adpcm streaming is not supported by the ds hardware (the loop point data gets recorded so ring buffers are not possible)". I believe that the initial sample and step index are kept internally when a channel "activates", so even if you got everything working, every block of data after the first would be corrupted because each block has it's own initial sample and step index that may not be the same as with the first block.  Because of this, I wanted to try it myself with external decoding, which is how this little program came about.
<br/>
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Are you attempting file IO in interrupts, cos that *really* isn't going to work.
<br/>
<br/>
As for releasing source, get eKid to check it over &amp; we can maybe shove it in the official example set, if you're willing.</td> </tr></table><span class="postbody">
<br/>
I haven't had a lot of exposure with file IO and interrupts, so this was one way to get my hands dirty. The problem with the audio freezing isn't as bad now because of moving mmStreamUpdate() into a function that gets called via interrupt once per frame, whereas before, it was still left in the infinite loop of the main function, sharing a place with my other crap that would take quite a few frames to finish. There is still some freezing, and if anyone would like to share how to prevent that, then I'm all ears.
<br/>
<br/>
By all means though, if there is anything useful in the source I posted, then grab what you want.<br/>_________________<br/><span style="font-weight: bold">DS</span> - It's all about <span style="font-weight: bold">D</span>isco<span style="font-weight: bold">S</span>tew</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#165465 - eKid - Mon Dec 22, 2008 8:39 am</h4>
    <div class="postbody"><span class="postbody">I was working on an MS-ADPCM decoder, right now it works OK at about 9 scanlines of cpu usage for 32khz stereo decoding (but I haven't tested when it reads data from the cart). I'm not really sure what to do with it yet... I was thinking maybe it could be part of a lib that supports multiple wav formats for streaming, or just add support in the maxmod streaming code.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#165481 - DiscoStew - Mon Dec 22, 2008 8:40 pm</h4>
    <div class="postbody"><span class="postbody">Updated the audio streamer. Max allowable format for IMA-ADPCM playback (44kHz stereo) went from 22% CPU usage to 15% CPU usage. Other IMA-ADPCM formats have scaled down as well.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>eKid wrote:</b></span></td> </tr> <tr> <td class="quote">I was working on an MS-ADPCM decoder, right now it works OK at about 9 scanlines of cpu usage for 32khz stereo decoding (but I haven't tested when it reads data from the cart). I'm not really sure what to do with it yet... I was thinking maybe it could be part of a lib that supports multiple wav formats for streaming, or just add support in the maxmod streaming code.</td> </tr></table><span class="postbody">
<br/>
<br/>
Well, that's much better than what I would be getting with IMA-ADPCM decoding at 32kHz stereo. Are you using Assembly or C/C++ for that?<br/>_________________<br/><span style="font-weight: bold">DS</span> - It's all about <span style="font-weight: bold">D</span>isco<span style="font-weight: bold">S</span>tew</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#165495 - eKid - Tue Dec 23, 2008 4:47 am</h4>
    <div class="postbody"><span class="postbody">Before, everything was a c++ class and the load was like 24 scanlines, I converted the main decoding routine to asm and it dropped down to 9.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#166395 - hacker013 - Sat Feb 07, 2009 9:56 am</h4>
    <div class="postbody"><span class="postbody">can you please release the source?<br/>_________________<br/><a class="postlink" href="http://imetal.nl/" target="_blank">Website / Blog</a>
<br/>
<br/>
Let the nds be with you.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#166451 - Odorules - Sun Feb 08, 2009 11:53 am</h4>
    <div class="postbody"><span class="postbody">The Discotew's code is very good but there is a small glitch when the music starts :(</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#166478 - DiscoStew - Sun Feb 08, 2009 7:15 pm</h4>
    <div class="postbody"><span class="postbody">On No$GBA, the audio can sound crappy when just starting (must be a timing issue), but on hardware, I haven't been able to reproduce that same glitch.<br/>_________________<br/><span style="font-weight: bold">DS</span> - It's all about <span style="font-weight: bold">D</span>isco<span style="font-weight: bold">S</span>tew</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#166484 - hacker013 - Sun Feb 08, 2009 8:18 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Odorules wrote:</b></span></td> </tr> <tr> <td class="quote">The Discotew's code is very good but there is a small glitch when the music starts :(</td> </tr></table><span class="postbody">
<br/>
<br/>
I have that problem on the hardware<br/>_________________<br/><a class="postlink" href="http://imetal.nl/" target="_blank">Website / Blog</a>
<br/>
<br/>
Let the nds be with you.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#166486 - Odorules - Sun Feb 08, 2009 8:25 pm</h4>
    <div class="postbody"><span class="postbody">Me too.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#166511 - DiscoStew - Mon Feb 09, 2009 10:04 am</h4>
    <div class="postbody"><span class="postbody">I was given a little info about what problem people were experiencing, and it wasn't the problem I thought it was originally (which was possible static when starting the audio on an emulator). The two might be linked though, but nonetheless, when I have time this week, I'll look over it and see if I can do something about it.<br/>_________________<br/><span style="font-weight: bold">DS</span> - It's all about <span style="font-weight: bold">D</span>isco<span style="font-weight: bold">S</span>tew</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#166543 - hacker013 - Mon Feb 09, 2009 5:18 pm</h4>
    <div class="postbody"><span class="postbody">thx :)<br/>_________________<br/><a class="postlink" href="http://imetal.nl/" target="_blank">Website / Blog</a>
<br/>
<br/>
Let the nds be with you.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#166573 - DiscoStew - Mon Feb 09, 2009 11:09 pm</h4>
    <div class="postbody"><span class="postbody">I quick question to all that are having this bug with it cutting off some audio when it first starts playing.
<br/>
<br/>
How are you all calling mmStreamUpdate(), or is it set for auto-mode? Also, was there any editing done to the code when used in your own projects?
<br/>
<br/>
As the code stands unaltered in form, it seems to play the audio just fine, but when I swapped these two lines in STREAM_PlayFile().....
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">mmStreamOpen( &amp;Stream_Mystream );
<br/>
Stream_Active = true;</td> </tr></table><span class="postbody">...I began experiencing this problematic situation at the start of playback (but it plays fine afterwards, and when looping).<br/>_________________<br/><span style="font-weight: bold">DS</span> - It's all about <span style="font-weight: bold">D</span>isco<span style="font-weight: bold">S</span>tew</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#166584 - hacker013 - Tue Feb 10, 2009 4:35 pm</h4>
    <div class="postbody"><span class="postbody">'ve changed nothing on your source. if only written a wrapper around it so i can use it in my projects.<br/>_________________<br/><a class="postlink" href="http://imetal.nl/" target="_blank">Website / Blog</a>
<br/>
<br/>
Let the nds be with you.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#166586 - Odorules - Tue Feb 10, 2009 5:43 pm</h4>
    <div class="postbody"><span class="postbody">I was calling mmStreamUpdate like in the vcount handler. But now I call it in the main loop and I haven't this bug anymore. Except a little "crash" when some musics start.
<br/>
Thanks :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#166663 - DiscoStew - Fri Feb 13, 2009 8:48 am</h4>
    <div class="postbody"><span class="postbody">I can only imagine that there is that audio cut off from the very beginning of playback is because by the time the stream is set up, the point where the VCount interrupt activates would have already passed, therefore doesn't do anything with mmStreamUpdate, so by the time it got back to that point for updating, there would be much more data that needed to be decoded, and let's not forget that it uses a buffer with a limited size, further preventing the entire set from being decoded at once, so it could only decode in limited chunks until it finally caught up.
<br/>
<br/>
The reason why it didn't happen with my example is because there isn't anything else that could happen that would put it into this problematic situation.
<br/>
<br/>
While I don't have a solid fix for this *yet*, I would like everyone who is having this problem to try this simple change with their projects that use this decoder. Remove mmStreamUpdate completely, and in the STREAM_PlayFile function, change the line....
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">Stream_Mystream.manual = true;
<br/>
....to....
<br/>
Stream_Mystream.manual = false;</td> </tr></table><span class="postbody">
<br/>
<br/>
....and see if this helps. I'd like feedback concerning this, because by doing this, Maxmod will get the data required when it needs to, rather than waiting for the program to tell it that it can.
<br/>
<br/>
While this may break up the audio streaming in emulators, it seems to run fine on hardware, and that's where it counts, right?<br/>_________________<br/><span style="font-weight: bold">DS</span> - It's all about <span style="font-weight: bold">D</span>isco<span style="font-weight: bold">S</span>tew</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#166672 - Odorules - Fri Feb 13, 2009 7:44 pm</h4>
    <div class="postbody"><span class="postbody">I tried this but I have the same cut off sound when the song start. 
<br/>
Moreover, it works on emulator with Stream_Mystream.manual = false.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#166693 - DiscoStew - Sat Feb 14, 2009 10:25 pm</h4>
    <div class="postbody"><span class="postbody">From the many tests that I have done, I can only conclude that it is a problem from the time it takes from calling mmStreamOpen to the next mmStreamUpdate. I'm also thinking that if you are to try having it update by itself as described in my last post, you may also want to move "Stream_Active = true" to before mmStreamOpen, as it might want to try and update itself right after finishing the mmStreamOpen call (and when it does that, it goes into the STREAM_Update function, where it is ended quickly for not having the actual stream active).
<br/>
<br/>
Also, while it runs fine with no errors or crashes on hardware and emulators, it still brings up static on No$GBA for me. While it's designed to work specifically on hardware, it can get a little irritating when developing with it. If anyone knows how to fix this, please let me know.
<br/>
<br/>
While being on this code-hunt, I decided to see if I could squeeze out any more juice from the decoding portion, and it appears that I have. The code is a little larger as it is expanded. I'll be updating the comments to it before I upload the new version which will be a little faster in decoding.
<br/>
<br/>
I should probably start putting up version numbers or something. I never had any in the past for all my other projects.....because I never got to a point of getting this far, lol. Guess starting with v1.0 will work.
<br/>
<br/>
EDIT:
<br/>
<br/>
New version is uploaded. The internals for the decoding and processing are different from the previous release. The only change made to interfacing with it is the addition to setting it to automatically update. Please give feedback, such as if there are still bugs and overall problems with the audio decoding/playback. The rest are just extras, and are not meant to be perfect, only usable.<br/>_________________<br/><span style="font-weight: bold">DS</span> - It's all about <span style="font-weight: bold">D</span>isco<span style="font-weight: bold">S</span>tew</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#166699 - hacker013 - Sun Feb 15, 2009 10:39 am</h4>
    <div class="postbody"><span class="postbody">i dont't get any sound at all now and yes i tryed all 2 modes and by manual mmStreamUpdate in the vblankhandler.<br/>_________________<br/><a class="postlink" href="http://imetal.nl/" target="_blank">Website / Blog</a>
<br/>
<br/>
Let the nds be with you.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#166729 - DiscoStew - Mon Feb 16, 2009 3:25 am</h4>
    <div class="postbody"><span class="postbody">Seems some bugs snuck in that I didn't account for. The bug that everyone seemed to get before (with audio being cut off) finally revealed itself to me completely, but the simple change I made (without altering any of the decoding routines) makes it much like the previous version, and that was when people began experiencing the problem in the first place. I'll look into it more, as well as anything else I can find. This isn't a good start for this project.  :P
<br/>
<br/>
hacker013,
<br/>
<br/>
Since you aren't getting any sound whatsoever, I'd like you to do something for me. I need you to examine the 'length' and 'Stream_CurPos' variables in the STREAM_Update function with both modes, and tell me what you get.<br/>_________________<br/><span style="font-weight: bold">DS</span> - It's all about <span style="font-weight: bold">D</span>isco<span style="font-weight: bold">S</span>tew</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#166737 - DiscoStew - Mon Feb 16, 2009 7:03 am</h4>
    <div class="postbody"><span class="postbody">I would like everyone that is trying this decode functionality in their projects to try this new files...
<br/>
<br/>
<span style="font-weight: bold">Link removed by Discostew. New version is up</span>
<br/>
<br/>
Because I don't have anything running along side this that is intensive, I need help from you all. This file includes the stream files and a new main.c file. The stream file changes are little alterations to the stream loader, a different initial checker in the callback function, and a temporary function that displays a few status values for the user to see. The main.c file just has the addition of the stream status function. The main reason why I added that was for people who had problems that wanted to examine the data themselves, but didn't want to tamper with anything. If you want, you can add more values to look at (but be mindful that it's set at row 21, so change that if you add more).<br/>_________________<br/><span style="font-weight: bold">DS</span> - It's all about <span style="font-weight: bold">D</span>isco<span style="font-weight: bold">S</span>tew</span><span class="gensmall"><br/><br/>Last edited by DiscoStew on Wed Mar 18, 2009 8:05 am; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#166774 - Odorules - Tue Feb 17, 2009 4:31 pm</h4>
    <div class="postbody"><span class="postbody">I did some tests and your code works fine (there is not "crash" sound when at starting). I copied stream.h and strem.c in my code and there is this bug. It seems it's because of my code :(
<br/>
<br/>
I don't know what could cause this. Any idea ?
<br/>
<br/>
EDIT : This bug is here when I call STREAM_PlayFile() for the first time. I reload the level, I re-call STREAM_PlayFile() and there is not the bug.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#166785 - Emmanuel - Tue Feb 17, 2009 7:42 pm</h4>
    <div class="postbody"><span class="postbody">I downloaded your files in the first post... they work perfectly for me... 
<br/>
Great work</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#166788 - DiscoStew - Tue Feb 17, 2009 8:29 pm</h4>
    <div class="postbody"><span class="postbody">That is just odd. When everyone else is getting no problems with the code (with the except of hacker013), I get problems, but when I don't get problems, everyone else does.
<br/>
<br/>
Emmanuel,
<br/>
<br/>
Are you using the files in a project of yours, or are just trying out the example program? No audio cut-off when switching between different files?
<br/>
<br/>
EDIT:
<br/>
<br/>
So is everyone having no problems with the "manual" version? From the looks of it, it appeared that after I posted the v1.0 release, I only checked the "auto" mode on my own NDS, and the cut-off was resulting on it. Instead of checking the "manual" version too, I assumed it had the same fate, so I went about trying to fix something that didn't necessarily have any problems. If no one is having problems with the manual version (hacker013, I need more information from you concerning why you aren't getting any audio at all), then I'll just remove the auto-mode portions until I figure out the cut-off from that.<br/>_________________<br/><span style="font-weight: bold">DS</span> - It's all about <span style="font-weight: bold">D</span>isco<span style="font-weight: bold">S</span>tew</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#166789 - Emmanuel - Tue Feb 17, 2009 9:40 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>DiscoStew wrote:</b></span></td> </tr> <tr> <td class="quote">Emmanuel,
<br/>
<br/>
Are you using the files in a project of yours, or are just trying out the example program? No audio cut-off when switching between different files?
<br/>
<br/>
EDIT:
<br/>
<br/>
So is everyone having no problems with the "manual" version? From the looks of it, it appeared that after I posted the v1.0 release, I only checked the "auto" mode on my own NDS, and the cut-off was resulting on it. Instead of checking the "manual" version too, I assumed it had the same fate, so I went about trying to fix something that didn't necessarily have any problems. If no one is having problems with the manual version (hacker013, I need more information from you concerning why you aren't getting any audio at all), then I'll just remove the auto-mode portions until I figure out the cut-off from that.</td> </tr></table><span class="postbody">
<br/>
I'm using them in a project of mine, with the one in your first post, working fine with both versions, but I prefer auto... 
<br/>
Also, testing it on No$Gba in auto I did found some "interference" that occured in a timely manner, but on manual that interference totally vanishes... 
<br/>
Hardware doesn't have any of this problems altogether...
<br/>
I'm using C++, Arm7 in the combined template with slight modifications, and EFS to load the sounds</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#166803 - hacker013 - Wed Feb 18, 2009 4:49 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>DiscoStew wrote:</b></span></td> </tr> <tr> <td class="quote">That is just odd. When everyone else is getting no problems with the code (with the except of hacker013), I get problems, but when I don't get problems, everyone else does.
<br/>
<br/>
Emmanuel,
<br/>
<br/>
Are you using the files in a project of yours, or are just trying out the example program? No audio cut-off when switching between different files?
<br/>
<br/>
EDIT:
<br/>
<br/>
So is everyone having no problems with the "manual" version? From the looks of it, it appeared that after I posted the v1.0 release, I only checked the "auto" mode on my own NDS, and the cut-off was resulting on it. Instead of checking the "manual" version too, I assumed it had the same fate, so I went about trying to fix something that didn't necessarily have any problems. If no one is having problems with the manual version (hacker013, I need more information from you concerning why you aren't getting any audio at all), then I'll just remove the auto-mode portions until I figure out the cut-off from that.</td> </tr></table><span class="postbody">
<br/>
<br/>
When i load a .wav it doesn't return NULL so i think that's not the problem. I've monitored some vars:
<br/>
CurrentPos - 0;
<br/>
Length Request  - 0 (0)
<br/>
Buffer length - 0
<br/>
Is Active - 0<br/>_________________<br/><a class="postlink" href="http://imetal.nl/" target="_blank">Website / Blog</a>
<br/>
<br/>
Let the nds be with you.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#166808 - DiscoStew - Wed Feb 18, 2009 7:27 pm</h4>
    <div class="postbody"><span class="postbody">You're getting those values after not getting NULL from STREAM_PlayFile? Looking over my code, I don't see how that is possible, not without changing something in the code itself, because when the function returns non-zero is when code execution also passes by Stream_Active and buffer_length, making them non-zero.<br/>_________________<br/><span style="font-weight: bold">DS</span> - It's all about <span style="font-weight: bold">D</span>isco<span style="font-weight: bold">S</span>tew</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167051 - DiscoStew - Fri Feb 27, 2009 8:33 pm</h4>
    <div class="postbody"><span class="postbody">Expect a new version to be released within the next week or two. I took eKid's approach, and converted my decoding routine into assembly (only stereo atm). Getting about 16 scanlines for 44kHz stereo (as opposed to the 26 from c/c++ implementation), but I'm hoping the routine can be improved.
<br/>
<br/>
The decoding code is in the ASM forums if anyone wants to contribute to improving it, but it is not compatible with either my current release here or even eKid's release (even though the format is similar to his) because of other changes made outside of it to make it work with ima-adpcm.<br/>_________________<br/><span style="font-weight: bold">DS</span> - It's all about <span style="font-weight: bold">D</span>isco<span style="font-weight: bold">S</span>tew</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167128 - Odorules - Mon Mar 02, 2009 7:18 pm</h4>
    <div class="postbody"><span class="postbody">Okay :)
<br/>
I'll use it when you'll release it.
<br/>
I had solved my bug by adding "soundDisable();" when I call STREAM_PlayFile and call soundEnable(); 5 frames after.
<br/>
<br/>
It's not a good fix at all but it works.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167200 - Emmanuel - Thu Mar 05, 2009 3:34 pm</h4>
    <div class="postbody"><span class="postbody">Has anyone gotten any problems with the latest libnds?
<br/>
It just freezes when it comes the moment the play function is called... both in my project and the demo...
<br/>
in the demo, same goes for auto and manual, I select the file: freeze...
<br/>
In my project when I call stream_playFile....</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167268 - iainprice - Sat Mar 07, 2009 4:12 pm</h4>
    <div class="postbody"><span class="postbody">I want to put the streaming audio into my game.... i am trying to load an mp3 from efsroot but am having no luck, has anyone else modified this to work for a libfat mp3 file?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167274 - hacker013 - Sat Mar 07, 2009 5:36 pm</h4>
    <div class="postbody"><span class="postbody">this is for wav files xD<br/>_________________<br/><a class="postlink" href="http://imetal.nl/" target="_blank">Website / Blog</a>
<br/>
<br/>
Let the nds be with you.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167276 - DiscoStew - Sat Mar 07, 2009 5:59 pm</h4>
    <div class="postbody"><span class="postbody">As hacker013 said, it only supported "wav" files, and limited in that range as well for only PCM and IMA-ADPCM.
<br/>
<br/>
One reason why people might be having problems with this is that the toolkit has been updated, and possible conflicts have occurred since then. I only updated last night, and found the most recent compiled version of my streamer to crash on-play with No$GBA, so I'll be working to fix that.<br/>_________________<br/><span style="font-weight: bold">DS</span> - It's all about <span style="font-weight: bold">D</span>isco<span style="font-weight: bold">S</span>tew</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167553 - DiscoStew - Wed Mar 18, 2009 7:32 am</h4>
    <div class="postbody"><span class="postbody">Ok, new version is up, and should be working with the newest toolkit. As noted, auto-mode doesn't work correctly because of a bug in Maxmod, but has been fixed in the newest svn, so either update to that, or wait till it gets compiled with the toolkit.<br/>_________________<br/><span style="font-weight: bold">DS</span> - It's all about <span style="font-weight: bold">D</span>isco<span style="font-weight: bold">S</span>tew</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167557 - hacker013 - Wed Mar 18, 2009 2:50 pm</h4>
    <div class="postbody"><span class="postbody">I hope this version works for me :)
<br/>
<br/>
EDIT: can you release a c version?<br/>_________________<br/><a class="postlink" href="http://imetal.nl/" target="_blank">Website / Blog</a>
<br/>
<br/>
Let the nds be with you.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167568 - Emmanuel - Wed Mar 18, 2009 6:37 pm</h4>
    <div class="postbody"><span class="postbody">Great, it's working awesome... save one little strange thing, which may actually be my file: 
<br/>
When I set loop mode, the first run works fine, second run ends, and then sound like screeches...  starts sounding awful... but, the DS doesn't freeze, in fact, I can play the sound again with A button, and the same happens... awful sound until the second loop ends
<br/>
<br/>
Tried with a different, and smaller file, but same occurs, except the screech sounds different... but it's an awful sound nonetheless</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167575 - DiscoStew - Wed Mar 18, 2009 8:09 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Emmanuel wrote:</b></span></td> </tr> <tr> <td class="quote">Great, it's working awesome... save one little strange thing, which may actually be my file: 
<br/>
When I set loop mode, the first run works fine, second run ends, and then sound like screeches...  starts sounding awful... but, the DS doesn't freeze, in fact, I can play the sound again with A button, and the same happens... awful sound until the second loop ends
<br/>
<br/>
Tried with a different, and smaller file, but same occurs, except the screech sounds different... but it's an awful sound nonetheless</td> </tr></table><span class="postbody">
<br/>
<br/>
It sounds like <a class="postlink" href="http://slog.thestranger.com/files/2008/07/screech9.jpg" target="_blank">this</a>?
<br/>
<br/>
Anyways, I doubt it is your file(s). With looping, there is one of two things that the decoder will do. Either it takes looping information from what is called the "sampler" (if it exists), or the loop markers would get set at the start and end of the audio data block. I currently can't check through my code since I'm not at home, but I believe it might have something to do with the loop markers, and something being altered with the "capture_frame" when it loops back the first time, affecting it the next time it loops around.
<br/>
<br/>
But just so I understand how you are experiencing this, this corruption happens after it streams through the audio twice (meaning it starts when it should begin streaming through it the third time?). Is the audio PCM or IMA-ADPCM? Does it have a sampler block? And you said that when you replay the audio, it plays fine until it gets to that point again?
<br/>
<br/>
<br/>
hacker013,
<br/>
<br/>
I had thought about converting just the decoder to regular C, because the prior versions were like that and people had already adapted their projects with that in mind. I'll see what I can do, but it might be a while before I can truly set aside some time to deal with it.<br/>_________________<br/><span style="font-weight: bold">DS</span> - It's all about <span style="font-weight: bold">D</span>isco<span style="font-weight: bold">S</span>tew</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167577 - Emmanuel - Wed Mar 18, 2009 9:08 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>DiscoStew wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
But just so I understand how you are experiencing this, this corruption happens after it streams through the audio twice (meaning it starts when it should begin streaming through it the third time?).
<br/>
</td> </tr></table><span class="postbody">
<br/>
Yeah, I don't know if it's when the second loop ends, or when the third loop is beginning though...
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote"> Is the audio PCM or IMA-ADPCM? </td> </tr></table><span class="postbody">
<br/>
PCM, 2 channel aka stereo, 16-bit, 44 KHz
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Does it have a sampler block?</td> </tr></table><span class="postbody">
<br/>
what's a sampler block? ok, it's the block of the file with info about somethings... how do I set one, or check to see if it's correct?
<br/>
Doesn't look like it has one though...
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">And you said that when you replay the audio, it plays fine until it gets to that point again?</td> </tr></table><span class="postbody">
<br/>
Yes, the first loop is totally perfect, however, on close inspection, the second time plays perfect too, but the start of the third time is the bad one... noticed that because I managed to hear a bit of the third time in a recent test (nothing fancy, just decided to pay more attention at the timing)
<br/>
<br/>
Btw, I'm clueless about ASM... so, I have no idea of how your code goes, for the ASM part.. which since it's the main part, I haven't even looked at it too much...
<br/>
<br/>
Btw, I'm using the already compiled nds file, no edition nor recompilations on my side... later I'll try to recompile it, and perhaps toy a little more with the file, about this sample block for example</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167580 - DiscoStew - Wed Mar 18, 2009 11:12 pm</h4>
    <div class="postbody"><span class="postbody">Ok, after checking my own PCM wavs on the DS (I bring my DS to work to use on my breaks), it appears that I was right in my assumption. There is a problem with the loop markers, specifically the end marker. The "screech" you are hearing is data being read from past the end of the audio file.
<br/>
<br/>
When I get home today, I'll do a quite sweep over the code, get it fixed, and upload the new version.
<br/>
<br/>
EDIT:
<br/>
<br/>
I was right that it had something to do with the looping values, but wrong that it wasn't the start/end markers. Nevertheless, the problem is fixed. Go ahead and grab it.<br/>_________________<br/><span style="font-weight: bold">DS</span> - It's all about <span style="font-weight: bold">D</span>isco<span style="font-weight: bold">S</span>tew</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167603 - hacker013 - Thu Mar 19, 2009 7:36 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>DiscoStew wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
hacker013,
<br/>
<br/>
I had thought about converting just the decoder to regular C, because the prior versions were like that and people had already adapted their projects with that in mind. I'll see what I can do, but it might be a while before I can truly set aside some time to deal with it.</td> </tr></table><span class="postbody">
<br/>
<br/>
How long do you think it would take to convert it?<br/>_________________<br/><a class="postlink" href="http://imetal.nl/" target="_blank">Website / Blog</a>
<br/>
<br/>
Let the nds be with you.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167649 - Emmanuel - Sat Mar 21, 2009 8:34 am</h4>
    <div class="postbody"><span class="postbody">ok, it looks perfect so far... now the prob is when adding it... I'm given an error at linking when I copy paste into my project... seems the linker is detecting the decode mono and decode stereo functions twice... 
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">ima_adpcm_decode.o: In function `decode_mono_ima_adpcm':
<br/>
c:/source/SSBClash/arm9/source/DStew/ima_adpcm_decode.s:56: multiple definition of `decode_mono_ima_adpcm'
<br/>
ima_adpcm_decode.o:c:/source/SSBClash/arm9/source/DStew/ima_adpcm_decode.s:56: first defined here
<br/>
ima_adpcm_decode.o: In function `decode_stereo_ima_adpcm':
<br/>
c:/source/SSBClash/arm9/source/DStew/ima_adpcm_decode.s:110: multiple definition of `decode_stereo_ima_adpcm'
<br/>
ima_adpcm_decode.o:c:/source/SSBClash/arm9/source/DStew/ima_adpcm_decode.s:110: first defined here</td> </tr></table><span class="postbody">
<br/>
<br/>
It says it's first defined... exactly in the same place the error occurs... I don't know what's the problem, all I know is this is the first .s file I add, all the rest are .cpp
<br/>
<br/>
When I remove just that file... the function is not found, and when I leave it, it's found twice...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167651 - DiscoStew - Sat Mar 21, 2009 9:21 am</h4>
    <div class="postbody"><span class="postbody">I did a little research on this, and the only thing I could find related to this problem is this...
<br/>
<br/>
In the compiler output, is the problematic file being listed twice? The source of this information that had the same problem also reported that the next day, there weren't having any problems associated with multiple definitions from the same line of code, so it could just be a small compiler hiccup. Are you cleaning out the prior build before the next build?<br/>_________________<br/><span style="font-weight: bold">DS</span> - It's all about <span style="font-weight: bold">D</span>isco<span style="font-weight: bold">S</span>tew</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167676 - Emmanuel - Sat Mar 21, 2009 10:05 pm</h4>
    <div class="postbody"><span class="postbody">Lol... I found the problem... in the Arm9 makefile I had export OFILES for S files twice...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167680 - Emmanuel - Sun Mar 22, 2009 5:02 am</h4>
    <div class="postbody"><span class="postbody">So, now I added it to my project... but, ram usage keeps increasing... it seems whenever I call the player's play function RAM increases... and it doesn't decrease ever.... I think it may be the datacache... but since the source isn't mine, and I don't know a thing about ASM, I'm not completly sure...
<br/>
I haven't had the time to test for RAM in your example though... but I don't think it's my project... it only happens when player.play(arguments) is called... and the increase happens each time it's called... though I haven't overload it yet... too lazy to do it...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167683 - DiscoStew - Sun Mar 22, 2009 6:33 am</h4>
    <div class="postbody"><span class="postbody">I'm pretty sure it's that "datacache", since the only time it ever frees that memory is when the Stream class is destroyed. Unfortunately, the place that I thought it would do that is when "active_player = this", but maybe it doesn't destroy the previous stream from right there?
<br/>
<br/>
In the stream's "reset" function, try adding...
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">if( datacache )
<br/>
            delete [] datacache;</td> </tr></table><span class="postbody">
<br/>
...just before it calls to allocate memory, and see if that fixes the memory leak. Please get back to me if it does, and I'll add the fix into the example.<br/>_________________<br/><span style="font-weight: bold">DS</span> - It's all about <span style="font-weight: bold">D</span>isco<span style="font-weight: bold">S</span>tew</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167696 - Emmanuel - Sun Mar 22, 2009 1:34 pm</h4>
    <div class="postbody"><span class="postbody">Still, no use... this is the function whole... I tried to add it at the very start, no use either
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">int IMA_Adpcm_Stream::reset( const char *wav_file, bool loop )
<br/>
{
<br/>
   if( fin ) {
<br/>
      close();
<br/>
   }
<br/>
   fin = fopen(wav_file, "rb");
<br/>
   
<br/>
   if( !fin )
<br/>
      return IMA_ADPCM_ERROR_CANNOTOPEN;
<br/>
<br/>
   if( fget32() != 0x46464952 )      // "RIFF"
<br/>
   {
<br/>
      fclose( fin );
<br/>
      return IMA_ADPCM_ERROR_NOTRIFFWAVE;
<br/>
   }
<br/>
   int size = fget32();
<br/>
   if( fget32() != 0x45564157 )      // "WAVE"
<br/>
   {
<br/>
      fclose( fin );
<br/>
      return IMA_ADPCM_ERROR_NOTRIFFWAVE;
<br/>
   }
<br/>
   
<br/>
   // parse WAV structure
<br/>
   while( tell() &lt; size )
<br/>
   {
<br/>
      u32 code = fget32();
<br/>
      u32 csize = fget32();
<br/>
      switch( code )
<br/>
      {
<br/>
      case 0x20746D66:    // format chunk
<br/>
         
<br/>
         // catch invalid format
<br/>
         format = fget16();
<br/>
         if(( format != WAV_FORMAT_PCM ) &amp;&amp; ( format != WAV_FORMAT_IMA_ADPCM ))
<br/>
         {
<br/>
            fclose( fin );
<br/>
            return IMA_ADPCM_ERROR_UNSUPPORTED;
<br/>
         }
<br/>
         
<br/>
         channels = fget16();
<br/>
         
<br/>
         // catch invalid channels
<br/>
         if(( channels &lt; 1 ) || ( channels &gt; 2 ))
<br/>
         {
<br/>
            fclose( fin );
<br/>
            return IMA_ADPCM_ERROR_INVALIDCHANNELS;
<br/>
         }
<br/>
            
<br/>
         sampling_rate = fget32();// sample rate
<br/>
         skip( 4 );   // avg bytes/second
<br/>
         
<br/>
         block = fget16();
<br/>
         
<br/>
-------------------if( datacache )
<br/>
            delete [] datacache;
<br/>
         
<br/>
         datacache = new u8[block];
<br/>
<br/>
         sampBits = fget16();
<br/>
<br/>
         if((( format == WAV_FORMAT_PCM ) &amp;&amp; (( sampBits != 8 ) &amp;&amp; ( sampBits != 16 ))) ||
<br/>
            (( format == WAV_FORMAT_IMA_ADPCM ) &amp;&amp; ( sampBits != 4 )))
<br/>
         {
<br/>
            fclose( fin );
<br/>
            return IMA_ADPCM_ERROR_UNSUPPORTED;
<br/>
         }
<br/>
         
<br/>
         skip( csize - 0x10 );
<br/>
<br/>
         break;
<br/>
         
<br/>
      case 0x61746164:   // data chunk
<br/>
         wave_data = tell();
<br/>
         loop1 = 0;
<br/>
         skip( csize );
<br/>
         wave_end = tell();
<br/>
         if( format == WAV_FORMAT_PCM )
<br/>
            loop2 = csize &gt;&gt; ( sampBits == 16 ? channels : ( channels - 1 ));
<br/>
         else
<br/>
            loop2 = csize &lt;&lt; ( 2 - channels );
<br/>
         break;
<br/>
         
<br/>
      case 0x6C706D73:   // sampler chunk
<br/>
      {
<br/>
         int s;
<br/>
         skip( 28 );
<br/>
         int nl = fget32();
<br/>
         skip(4);
<br/>
         s = 36;
<br/>
         if( nl &amp;&amp; loop) 
<br/>
         {
<br/>
            skip( 8 );
<br/>
            loop1 = fget32() &gt;&gt; ( 2 - channels );
<br/>
            loop2 = fget32() &gt;&gt; ( 2 - channels );
<br/>
            s += 8+4+4;
<br/>
         }
<br/>
         skip( csize - s );
<br/>
      }
<br/>
         break;
<br/>
      default:
<br/>
         skip( csize );
<br/>
      }
<br/>
   }
<br/>
   wave_loop = loop;
<br/>
   oddnibble = 0;
<br/>
   data.curSamps = 0;
<br/>
   position = 0;
<br/>
   seek( wave_data );
<br/>
   currentblock = tell();
<br/>
   state = state_beginblock;
<br/>
   return IMA_ADPCM_OKAY;
<br/>
}</td> </tr></table><span class="postbody">
<br/>
I tried deleting the player completely when changing music or stopping it, and that didn't work either...
<br/>
<br/>
I test using this: (being called on every frame)
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">struct mallinfo info = mallinfo();
<br/>
        iprintf("\x1b[10;0HMemory in use  : %d bytes \n", info.usmblks + info.uordblks);
<br/>
        iprintf("\x1b[11;0HTotal heap size: %d bytes \n", info.arena);
<br/>
        iprintf("\x1b[12;0HMemory in free : %d bytes \n", info.fsmblks + info.fordblks);</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167712 - DiscoStew - Mon Mar 23, 2009 6:17 am</h4>
    <div class="postbody"><span class="postbody">I believe I may have found where the problem lies, but I want to check with eKid about it, as it may be another problem related to Maxmod.
<br/>
<br/>
eKid, you got mail.  :P<br/>_________________<br/><span style="font-weight: bold">DS</span> - It's all about <span style="font-weight: bold">D</span>isco<span style="font-weight: bold">S</span>tew</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167721 - DiscoStew - Mon Mar 23, 2009 7:29 pm</h4>
    <div class="postbody"><span class="postbody">Ok, the problem did lie in mmStreamClose(). So until it gets updated, the only thing I can think of to fix the problem would be to put the player into a special pause mode when notifying it to stop, where the stream continues to run, but nothing is done in the callback function except to fill in the buffer with 0s. Starting another stream would then release it from this special pause mode, and stuff would continue as normal.
<br/>
<br/>
I may do that as a temporary fix for now, but it will use some processing time in that standby mode because of having to still fill the buffer.
<br/>
<br/>
EDIT:
<br/>
<br/>
Forget it. The temporary fix works fine.......if all of your stream files are of the same sample rate, have the same number of channels, etc. It may work for some people, but I would say it's better to wait for Maxmod to be updated.<br/>_________________<br/><span style="font-weight: bold">DS</span> - It's all about <span style="font-weight: bold">D</span>isco<span style="font-weight: bold">S</span>tew</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167772 - Michoko - Thu Mar 26, 2009 9:22 pm</h4>
    <div class="postbody"><span class="postbody">Hi,
<br/>
<br/>
This seems quite interesting! I have two question, please.
<br/>
<br/>
1) Until now I was using ASlib, for MP3 replay. There is an issue with this lib though: when streaming MP3 from fat, if you also load other games assets, it's likely that glitches or even crashes will occur (more info here, if you're interested: <a href="http://forum.gbadev.org/viewtopic.php?t=14987" target="_blank">http://forum.gbadev.org/viewtopic.php?t=14987</a>). 
<br/>
Is your streaming code concerned by the same issue?
<br/>
<br/>
2) I'd like to test ADPCM compression and audio quality. Please could you recommend an audio app that would produce an audio file compatible with your code?
<br/>
<br/>
Thank you! :)
<br/>
Michoko</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167785 - hacker013 - Fri Mar 27, 2009 3:45 pm</h4>
    <div class="postbody"><span class="postbody">I think I can answer is, but it isn't my project :)
<br/>
<br/>
1. the bug in the wavstreamer has to do with a bug in maxmod (ASLib doesn't use maxmod)
<br/>
<br/>
2. Every basic mp3 to wav converter should work :)<br/>_________________<br/><a class="postlink" href="http://imetal.nl/" target="_blank">Website / Blog</a>
<br/>
<br/>
Let the nds be with you.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167791 - Michoko - Fri Mar 27, 2009 5:41 pm</h4>
    <div class="postbody">Thanks hacker013, but I think you read my message a bit too fast ;)<br/>
<br/>
I was referring to the fact that libfat is not very interrupts friendly, as explained in the link I gave. So if the ADPCM data is streamed using interrupts, and you load another file at the same time (like game assets), it is likely to crash. At least it's the case with ASlib, which uses interrupts to refill its buffer.<br/>
I was wondering if MaxMod had the same issue?<br/>
<br/>
Thanks!</div>    
</div>
<div class="post">
    <h4>#167793 - DiscoStew - Fri Mar 27, 2009 7:14 pm</h4>
    <div class="postbody">While I can't speak for loading/reading a file during playback, the streamer hasn't crashed (yet) when reading directory contents that have a good number of files in them. That's not to say that there aren't any side effects.<br/>
<br/>
Obviously in manual mode, if mmStreamUpdate isn't called once per frame, you'll experience repeating because the buffer hasn't been updated with new data, and you'll experience that in the example project that comes with the decoder if you enter a directory containing a lot of files. My <strong class="text-strong">guess</strong> would be in this mode, as long as mmStreamUpdate is called once per frame, and there isn't anything else that would prevent this from happening (whether from reading a different file, or just too much processing), then you'll have no problems.<br/>
<br/>
Auto-mode is another story because it updates when it needs to, which can be at any time. When the example project, in auto-mode, is under the same situation when reading from a file-heavy directory, the audio will sharply crackle, but will continue playing normally once that process is done.<br/>
<br/>
So, I would have to say that no, Maxmod won't crash in this scenario, but that is just my opinion based on what I've tested, so it may or may not in a similar, but different scenario.</div>    
</div>
<div class="post">
    <h4>#167826 - hacker013 - Mon Mar 30, 2009 6:42 am</h4>
    <div class="postbody">are you already working on a c version? I have tried it by myself but I don't get it working :(</div>    
</div>
<div class="post">
    <h4>#168054 - hacker013 - Wed Apr 08, 2009 3:05 pm</h4>
    <div class="postbody">bump, any updates yet? or maybe a c version (desperate).</div>    
</div>
<div class="post">
    <h4>#168055 - kusma - Wed Apr 08, 2009 3:39 pm</h4>
    <div class="postbody"><blockquote><div><cite>hacker013 wrote:</cite>bump, any updates yet? or maybe a c version (desperate).</div></blockquote>
Why do you need a C-version?</div>    
</div>
<div class="post">
    <h4>#168056 - hacker013 - Wed Apr 08, 2009 3:43 pm</h4>
    <div class="postbody">because my whole game is in c and if I compile it in c++ I have to fix to many errors. -_-</div>    
</div>
<div class="post">
    <h4>#168072 - kusma - Thu Apr 09, 2009 12:21 am</h4>
    <div class="postbody"><blockquote><div><cite>hacker013 wrote:</cite>because my whole game is in c and if I compile it in c++ I have to fix to many errors. -_-</div></blockquote>
Then write a C++ to C wrapper around it.</div>    
</div>
<div class="post">
    <h4>#168125 - hacker013 - Fri Apr 10, 2009 5:14 pm</h4>
    <div class="postbody">how do I do that?</div>    
</div>
<div class="post">
    <h4>#168213 - Apollo - Wed Apr 15, 2009 3:52 pm</h4>
    <div class="postbody">Create a file with a set of functions where you handle the C++ specific things of this library but without being "nested" into a class. Just "pure" functions. Compile this file as a C++ file (meaning the file should have a .cpp postfix) and then call the functions from C as usual.</div>    
</div>
<div class="post">
    <h4>#168244 - kusma - Thu Apr 16, 2009 9:34 pm</h4>
    <div class="postbody">also remember to specify the functions as 'extern "C"' to make sure the C-side can call them.</div>    
</div>
<div class="post">
    <h4>#168276 - hacker013 - Sat Apr 18, 2009 11:52 am</h4>
    <div class="postbody">I think i can do that, I will give it a try.</div>    
</div>
<div class="post">
    <h4>#168594 - hacker013 - Fri May 08, 2009 6:26 pm</h4>
    <div class="postbody">I have tried it. I have changed ima_adpcm.h to ima_adpcm.hpp but I still get this error in my c++ 2 c wrapper for this library:<br/>
<div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>E&amp;#58;\UZProject\UZEngine&gt;make
make -C arm7
make&amp;#91;1&amp;#93;&amp;#58; Entering directory `/e/UZProject/UZEngine/arm7'
make&amp;#91;2&amp;#93;&amp;#58; `/e/UZProject/UZEngine/UZEngine.arm7' is up to date.
make&amp;#91;1&amp;#93;&amp;#58; Leaving directory `/e/UZProject/UZEngine/arm7'
make -C arm9
make&amp;#91;1&amp;#93;&amp;#58; Entering directory `/e/UZProject/UZEngine/arm9'
template.c
arm-eabi-gcc -MMD -MP -MF /e/UZProject/UZEngine/arm9/build/template.d -g -Wall -
O2 -march=armv5te -mtune=arm946e-s -fomit-frame-pointer -ffast-math -mthumb -mth
umb-interwork -I/e/UZProject/UZEngine/arm9/include -I/e/UZProject/UZEngine/arm9/
../common -I/e/UZProject/UZEngine/arm9/source/UZ -I/e/UZProject/UZEngine/arm9/so
urce/NE -I/e/UZProject/UZEngine/arm9/source/UZ/saving -I/e/UZProject/UZEngine/ar
m9/source/UZ/menu -I/e/UZProject/UZEngine/arm9/source/GModules -I/e/UZProject/UZ
Engine/arm9/source/MyEngine -I/e/UZProject/UZEngine/arm9/source/Sound -I/c/devki
tPro/libnds/include -I/e/UZProject/UZEngine/arm9/build -DARM9 -DNDS_DEBUG -DERRO
R_CHECKING -c /e/UZProject/UZEngine/arm9/source/template.c -o template.o
In file included from e&amp;#58;/UZProject/UZEngine/arm9/source/Sound/sound_wrapper.h&amp;#58;4,

                 from e&amp;#58;/UZProject/UZEngine/arm9/source/GModules/menu.h&amp;#58;8,
                 from e&amp;#58;/UZProject/UZEngine/arm9/source/template.c&amp;#58;23&amp;#58; e&amp;#58;/UZProject/UZEngine/arm9/source/Sound/ima_adpcm.hpp&amp;#58;31&amp;#58; error&amp;#58; expected '=', ',', ';', 'asm' or '__attribute__' before 'IMA_Adpcm_Stream'
e&amp;#58;/UZProject/UZEngine/arm9/source/Sound/ima_adpcm.hpp&amp;#58;105&amp;#58; error&amp;#58; expected '=',',', ';', 'asm' or '__attribute__' before 'IMA_Adpcm_Player'
make&amp;#91;2&amp;#93;&amp;#58; *** &amp;#91;template.o&amp;#93; Error 1
make&amp;#91;1&amp;#93;&amp;#58; *** &amp;#91;build&amp;#93; Error 2
make&amp;#91;1&amp;#93;&amp;#58; Leaving directory `/e/UZProject/UZEngine/arm9'
make&amp;#58; *** &amp;#91;arm9/UZEngine.elf&amp;#93; Error 2</code></pre></div></div>    
</div>
<div class="post">
    <h4>#168599 - Mighty Max - Sat May 09, 2009 3:42 am</h4>
    <div class="postbody">Not very surprisingly if you try to compile c++ with the c compiler.<br/>
<br/>
If you include a hpp into a c file (which is compiled as c by the ruleset in devkitpro) it will still be parsed as c and not cpp code.</div>    
</div>
<div class="post">
    <h4>#168601 - hacker013 - Sat May 09, 2009 11:23 am</h4>
    <div class="postbody">any suggestions how to fix that?</div>    
</div>
<div class="post">
    <h4>#168604 - Mighty Max - Sat May 09, 2009 1:47 pm</h4>
    <div class="postbody">Either change the rules to compile c as cpp (not that good of an idea) or well make them cpp :-P<br/>
<br/>
I'm not sure however why to create a copy of existing source (thus increase the effort to maintain it) when you just can just use them extern "C" where you need them. So there is no messup with the original code involved</div>    
</div>
<div class="post">
    <h4>#168605 - hacker013 - Sat May 09, 2009 3:18 pm</h4>
    <div class="postbody"><span class="postbody">but my whole program is in c -_- zo that are a lot of extern "C"<br/>_________________<br/><a class="postlink" href="http://imetal.nl/" target="_blank">Website / Blog</a>
<br/>
<br/>
Let the nds be with you.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#169330 - a128 - Fri Jul 03, 2009 7:03 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>DiscoStew wrote:</b></span></td> </tr> <tr> <td class="quote">On No$GBA, the audio can sound crappy when just starting (must be a timing issue), but on hardware, I haven't been able to reproduce that same glitch.</td> </tr></table><span class="postbody">
<br/>
<br/>
I also have an issue with NO$GBA ....I just used the stream MM example from libnds and streamed a WAV sample....instead of the sinus wave
<br/>
<br/>
on hardware it sounded good...on the emu it sounded distorted....
<br/>
<br/>
no I know why: the buffer size was 1200...rising the buffer to 32767 with  playing rate 44100 worked on emu...I guess it's mutch slower then hardware so  the emu did not make it in time with a small buffer ?!<br/>_________________<br/>"Hey! It compiles! Ship it!"</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#173305 - protomank - Tue Mar 30, 2010 10:45 pm</h4>
    <div class="postbody"><span class="postbody">Does anyone still have the source for this? The mediafire link is broken...<br/>_________________<br/>Iuri Fiedoruk
<br/>
<a href="http://rockbot.upperland.net" target="_blank">http://rockbot.upperland.net</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#173306 - DiscoStew - Tue Mar 30, 2010 11:42 pm</h4>
    <div class="postbody"><span class="postbody">yeah, when I had put it up some time ago, I didn't realize that letting it go inactive would wipe it. If I can find it in my backups, I'll re-upload it.<br/>_________________<br/><span style="font-weight: bold">DS</span> - It's all about <span style="font-weight: bold">D</span>isco<span style="font-weight: bold">S</span>tew</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#173307 - headspin - Tue Mar 30, 2010 11:51 pm</h4>
    <div class="postbody"><span class="postbody">I can host it for you DS if you like.<br/>_________________<br/><a class="postlink" href="http://headsoft.com.au/index.php?category=warhawk" target="_blank">Warhawk DS</a> | <a class="postlink" href="http://headsoft.com.au/index.php?category=mmll" target="_blank">Manic Miner: The Lost Levels</a> | <a class="postlink" href="http://headsoft.com.au/index.php?category=tdg" target="_blank">The Detective Game</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#173319 - wintermute - Wed Mar 31, 2010 9:35 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>a128 wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
on hardware it sounded good...on the emu it sounded distorted....
<br/>
<br/>
no I know why: the buffer size was 1200...rising the buffer to 32767 with  playing rate 44100 worked on emu...I guess it's mutch slower then hardware so  the emu did not make it in time with a small buffer ?!</td> </tr></table><span class="postbody">
<br/>
<br/>
timing is all over the place on emulators, we found it almost impossible to get something that sounded good on both simultaneously.<br/>_________________<br/><a class="postlink" href="http://www.devkitpro.org/" target="_blank">devkitPro - professional toolchains at amateur prices</a>
<br/>
<a class="postlink" href="http://wiki.devkitpro.org/index.php/IRC" target="_blank">devkitPro IRC support</a>
<br/>
<a class="postlink" href="http://davejmurphy.com/" target="_blank">Personal Blog</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#173322 - DiscoStew - Wed Mar 31, 2010 6:57 pm</h4>
    <div class="postbody"><span class="postbody">Ok, it's re-uploaded to MediaFire, and link is fixed. It's been a while since I last touched it, and I haven't had the time to test if it still works, though I would assume it should. It compiles fine at least.
<br/>
<br/>
headspin,
<br/>
<br/>
You and anyone else can go right ahead and host it.<br/>_________________<br/><span style="font-weight: bold">DS</span> - It's all about <span style="font-weight: bold">D</span>isco<span style="font-weight: bold">S</span>tew</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#173323 - protomank - Wed Mar 31, 2010 7:42 pm</h4>
    <div class="postbody"><span class="postbody">Thanks, I'll try it tomorrow, as today my football (aka soccer) team will play for Libertadores da Am?rica, and I'll go to the stadium :)
<br/>
Looking at the code, it looks nice. Probally I'll run on a problem I have already: using sound (maxmod) with SDL, all timers junt went zero, so I can't control events speed and all runs crazy fast.<br/>_________________<br/>Iuri Fiedoruk
<br/>
<a href="http://rockbot.upperland.net" target="_blank">http://rockbot.upperland.net</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#173333 - protomank - Fri Apr 02, 2010 12:46 am</h4>
    <div class="postbody"><span class="postbody">Well it worked.. kinda.
<br/>
It seems like maxmod update (manual or automatica) have some problem that freezes an SDL apps. Any chance of you guys know anything about it?<br/>_________________<br/>Iuri Fiedoruk
<br/>
<a href="http://rockbot.upperland.net" target="_blank">http://rockbot.upperland.net</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#173335 - sverx - Fri Apr 02, 2010 10:14 am</h4>
    <div class="postbody"><span class="postbody">mmm... you mean you're using cpu timers? Maybe MaxMod uses them too...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#173340 - protomank - Fri Apr 02, 2010 11:34 am</h4>
    <div class="postbody"><span class="postbody">Yeah, I think that the problem is that. Both SDL and Maxmod use the same interrupts to control time, so, probally there is a conflict between them.
<br/>
<br/>
So, in the end I'll have to try to fix SDL_Mixer or leave my game without any sound :-(<br/>_________________<br/>Iuri Fiedoruk
<br/>
<a href="http://rockbot.upperland.net" target="_blank">http://rockbot.upperland.net</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#173423 - sverx - Tue Apr 06, 2010 9:29 am</h4>
    <div class="postbody"><span class="postbody">libxm7 uses only ARM7 resources... ;)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#173426 - protomank - Tue Apr 06, 2010 12:59 pm</h4>
    <div class="postbody"><span class="postbody">And what is libmx7, and where I can get it? :)
<br/>
(looking at the source, I saw that SDL also uses arm7, but I can hope it does not matter)<br/>_________________<br/>Iuri Fiedoruk
<br/>
<a href="http://rockbot.upperland.net" target="_blank">http://rockbot.upperland.net</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#173452 - sverx - Wed Apr 07, 2010 9:06 am</h4>
    <div class="postbody"><span class="postbody">uh-oh... I overlooked the topic... you need to stream music? Then sorry for the misleading suggestion, I just read you had some problems with MaxMod and I thought you were searching a replacement for XM/MOD reproduction...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#177556 - Kasumi - Wed Aug 22, 2012 1:13 am</h4>
    <div class="postbody"><span class="postbody">Bumping an old topic.
<br/>
<br/>
I used this (with some modifications) to throw together a simple movie player. I'm getting seemingly random crashes, and I'm hoping the answer is something simple. 
<br/>
<br/>
Edit 2: The answer seems pretty simple. CycloDS iEvolution isn't very good. I guess I'll leave this post in case my hacked in seeking function is useful to someone.
<br/>
<br/>
For instance, I realized that having player.update() in a function set to fire on IRQ_vblank makes it crash. I'm hoping there's just something like that about this player or about maxmod I'm not aware of, like I can't read files during the scanlines this could update, or whatever.
<br/>
<br/>
I made two "big" changes changes to the original player. I'm using nitrofs instead of standard FAT. And I added seeking to the player, in an admittedly hacky way. (Details to the specifics of changes for that are at the end of the post.)
<br/>
<br/>
My crash occurs during regular playing with this streamer. I don't have to use my added seek function/pause for it to occur. In fact, I originally thought the issue was just that my flash card was losing contact but I no longer think that's the case. If I completely remove the cart from the system while this is running the music and video obviously get extremely messed up, but I can actually still interact with the GUI on the touch screen. (Buttons still light up, etc.) When this crash happens, it cycles through the same part of the song over and no input does anything.
<br/>
<br/>
The weird thing is that this has worked forever, but then I decided to try new media files (converted in the exact same way), and I get crashes even on ones that have worked before. So maybe one of the new files changed the timing just enough that two interrupts are now interfering with each other? 
<br/>
<br/>
Here's an outline of my program structure:
<br/>
<br/>
I've got an endless while loop that doesn't wait for vblank or anything else. It calls player.update(), and changes which media file is playing. (I think this is because I also discovered changing media in a vblank function causes this to crash. Otherwise, I'd probably be doing this in an easier way :) ). 
<br/>
<br/>
The endless while loop also does one of the following things each frame. 
<br/>
<br/>
1. Gets an offset for the specific frame in the movie file. The movies are nothing more than uncompressed 128x96 BGR frames stored in sequential order in a single file. The audio actually comes from a separate file which this player reads. 
<br/>
<br/>
2. Uses the offset to load a frame to RAM with fopen, fseek, fread, fclose.
<br/>
<br/>
3. Works with the frame in RAM to double its resolution and copy it to RAM that will be DMA copied to the top screen.
<br/>
<br/>
4. Updates the GUI on the bottom screen if the frame hasn't been drawn yet.
<br/>
<br/>
Then, I have an function set to run on vblank via IRQ that does the following:
<br/>
<br/>
1. Reads and process input. This means it will set RAM to change movies that the endless while loop will pick up on when the interrupt returns. It also allows pausing and resuming the player directly, rather than passing a signal to the endless loop. (Could this cause a problem as well?)
<br/>
<br/>
2. Copies the frame to the top screen with a DMA OR copies the GUI from a RAM buffer to the bottom screen.
<br/>
<br/>
3. This also reads from the player's data to get the current block and total blocks in the wav. It does this and so that the movie frames can actually sync. Is reading this stuff safe in the vblank?
<br/>
<br/>
As of writing this post, I noticed I had an extra fread function for my movie frames. (left over from a test. Oops... Also discovered one other issue with how my frames are handled. I'll have to see if those things fix it, but I'm still making this post in case there are some not obvious gotchas with using vblank_IRQ and maxmod/this player.)
<br/>
<br/>
Edit: Fixed those. Still crashes, at least on one card. Another weird thing is that it doesn't seem to crash on a CycloDS, but it does on a CycloDS ievolution. This is with the same microsd card and everything. I realize the iEvolution isn't well recommended, but might anyone know why this is or how I might be able to fix it for a finicky card? I find it especially odd since I'd think they'd handle DS homebrew about the same...
<br/>
<br/>
Also, here is a (I think) complete list of changes for how I added seeking. (Yes, I realize one should not move private variables to public. If there are specific times I should not read from this data, let me know and I'll try to do it at a safe time.)
<br/>
<br/>
Moved the following to public in class IMA_Adpcm_Stream
<br/>
<br/>
int		wave_data;
<br/>
int		wave_end;
<br/>
int		currentblock;
<br/>
<br/>
void	capture_frame();
<br/>
void	restore_frame();
<br/>
<br/>
Added the following to public in class IMA_Adpcm_Stream
<br/>
<br/>
int seeking;
<br/>
int seekpos;
<br/>
<br/>
Added the following to class IMA_Adpcm_Player
<br/>
<br/>
void seekfunc(int seekpos);
<br/>
<br/>
int pseeking;
<br/>
<br/>
int waveend();
<br/>
int wavedata();
<br/>
<br/>
<br/>
Added the following after stop(); in IMA_Adpcm_Player::play 
<br/>
<br/>
stream.seeking = 0;
<br/>
stream.seekpos = 0;
<br/>
<br/>
Added
<br/>
<br/>
stream.capture_frame();
<br/>
<br/>
before return 0 in in IMA_Adpcm_Player::play
<br/>
<br/>
Here is my IMA_Adpcm_Player::i_stream_request with all my sloppy edits to allow seeking: 
<br/>
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">mm_word IMA_Adpcm_Player::i_stream_request( mm_word length, mm_addr dest, mm_stream_formats format ) {   
<br/>
   if(stream.seeking){
<br/>
      if(stream.seekpos &lt; stream.currentblock){
<br/>
         stream.restore_frame();
<br/>
      }
<br/>
      int countiterations = 0;
<br/>
      while(stream.currentblock &lt;= stream.seekpos &amp;&amp; countiterations &lt; 40){
<br/>
         resume();
<br/>
         countiterations++;
<br/>
         if( !paused ) {
<br/>
            if( !stream.stream( (s16*)dest, length ))
<br/>
            {
<br/>
               // apply volume scaler
<br/>
               if( volume != 256 ) {
<br/>
                  s16 *d = (s16*)dest;
<br/>
                  int i = length;
<br/>
                  for( ; i; i-- ) {
<br/>
                     *d = ((*d) * volume) &gt;&gt; 8; *d++;
<br/>
                     *d = ((*d) * volume) &gt;&gt; 8; *d++;
<br/>
                  }
<br/>
               }
<br/>
            }
<br/>
            else{
<br/>
               stop();
<br/>
               stream.seeking = 0;
<br/>
            }
<br/>
         } else {
<br/>
            s16 *d = (s16*)dest;
<br/>
            int i = length * 2;
<br/>
            for( ; i; i-- ) {
<br/>
               *d++ = 0;
<br/>
            }
<br/>
         }
<br/>
      }
<br/>
      
<br/>
      if(stream.currentblock &gt;= stream.seekpos){
<br/>
         stream.seeking = 0;
<br/>
      }
<br/>
   }else{
<br/>
      if( !paused ) {
<br/>
         if( !stream.stream( (s16*)dest, length ))
<br/>
         {
<br/>
            // apply volume scaler
<br/>
            if( volume != 256 ) {
<br/>
               s16 *d = (s16*)dest;
<br/>
               int i = length;
<br/>
               for( ; i; i-- ) {
<br/>
                  *d = ((*d) * volume) &gt;&gt; 8; *d++;
<br/>
                  *d = ((*d) * volume) &gt;&gt; 8; *d++;
<br/>
               }
<br/>
            }
<br/>
         }
<br/>
         else
<br/>
            stop();
<br/>
      } else {
<br/>
         s16 *d = (s16*)dest;
<br/>
         int i = length * 2;
<br/>
         for( ; i; i-- ) {
<br/>
            *d++ = 0;
<br/>
         }
<br/>
      }
<br/>
   }
<br/>
<br/>
   return length;
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
Essentially it checks if it's seeking. If it does, it checks if we're trying to seek to a block that is before the current. If it does, it restores the frame. (Why I added stream.capture_frame() to the beginning of in IMA_Adpcm_Player::play). Then it just runs the logic that was there before 40 times to quickly play through it.
<br/>
<br/>
I changed IMA_Adpcm_Player::update() to this to detect seeking
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void IMA_Adpcm_Player::update() {
<br/>
   pseeking = stream.seeking;
<br/>
   if( active &amp;&amp; !autofill ) {
<br/>
      mmStreamUpdate();
<br/>
   }
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
And added the following functions:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
void IMA_Adpcm_Player::seekfunc(int seekpos) {
<br/>
   if(stream.seeking == 0){
<br/>
      stream.seeking = 1;
<br/>
      stream.seekpos = seekpos;
<br/>
   }
<br/>
}
<br/>
<br/>
int IMA_Adpcm_Player::waveend() {
<br/>
   return stream.wave_end;
<br/>
}
<br/>
<br/>
int IMA_Adpcm_Player::wavedata() {
<br/>
   return stream.currentblock;
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I could live without seeking, but would like a crash free way to report the current and last blocks so I can at least sync my video frames if that's all that can be done. Sorry for the long post, and here's hoping someone out there can provide some insight!</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
