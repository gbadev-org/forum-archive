<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Exact clock rate of the bus ? - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>DS development > Exact clock rate of the bus ?</h2>
<div id="posts">
<div class="post">
    <h4>#102034 - raphzore - Sun Sep 10, 2006 12:43 am</h4>
    <div class="postbody"><span class="postbody">Hello,
<br/>
<br/>
To calculate timer's value accuratly, we need to know the base clock rate of the nds (so it's bus clock rate I suppose).
<br/>
<br/>
The matter is that in the nocash doc (<a class="postlink" href="http://nocash.emubase.de/gbatek.htm#dsinterrupts" target="_blank">http://nocash.emubase.de/gbatek.htm#dsinterrupts</a>) it's said that bus clock is at 1FF61FEh Hz and in neimod's one (<a class="postlink" href="http://neimod.com/dstek/" target="_blank">http://neimod.com/dstek/</a>) it's 2000000h Hz.
<br/>
<br/>
In libnds 2000000 Hz value is used for the TIMER_FREQ macro, but who is right ?
<br/>
<br/>
I know that it could sound as a weird question, because 2000000 and 1FF61FE are really close values, but I would need as much accuracy as I could have.
<br/>
<br/>
Thanks (and sorry for my english if I've done some mistakes) :).</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#102036 - Sausage Boy - Sun Sep 10, 2006 1:14 am</h4>
    <div class="postbody"><span class="postbody">I would personally trust gbatek over dstek, generally. It does seem like gbatek has the exact value and dstek has it rounded off, but I really don't know anything about this stuff.<br/>_________________<br/>"no offense, but this is the gayest game ever"</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#102038 - tepples - Sun Sep 10, 2006 2:30 am</h4>
    <div class="postbody"><span class="postbody">That's an 0.12 percent difference, which is within tolerance for variation in clock speed from unit to unit. The CPU clock in a handheld doesn't need to be extremely accurate because players of single-player game often can't tell the difference in rates from one unit to the next. Multiplayer games have to correct for the fact that systems in a network may gain or lose a frame's worth of cycles (280896 on the GBA or 560190 on the DS) every few minutes.
<br/>
<br/>
What do you need such a highly accurate time base for anyway, so that we can suggest other ways of going about what you ultimately want to do?<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#102039 - raphzore - Sun Sep 10, 2006 3:23 am</h4>
    <div class="postbody"><span class="postbody">It was only audio related, to base my calculation (for finding good multiple of some frequencies) on the good value.
<br/>
<br/>
Because I would like to avoid detuning without resampling.
<br/>
<br/>
But I'm only at the beginning of the whole thing, I'm looking for some ways to make the sound streaming as light as possible.
<br/>
<br/>
The ds has a quite nice sound hardware mixer :) !</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#102044 - tepples - Sun Sep 10, 2006 4:37 am</h4>
    <div class="postbody"><span class="postbody">The Nintendo DS DAC uses <a class="postlink" href="http://en.wikipedia.org/wiki/Pulse-width_modulation" target="_blank">pulse-width modulation</a>. It is a 10-bit DAC, and a 10-bit PWM DAC has 1024 steps in its sequence. So no matter the CPU frequency, the 10-bit PWM DAC runs once every 1024 ARM7 CPU cycles. If the CPU frequency is 0x02000000 Hz = 33554432 Hz, the DAC runs at 32768 Hz. If the CPU frequency is 0x01FF61FE = 33513982 Hz, the DAC runs at 32728.5 Hz. Unless you're trying to use two systems to generate quadraphonic audio, you can just pretend that all the CPUs run at 0x02000000 Hz for program simplicity.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#102060 - raphzore - Sun Sep 10, 2006 11:53 am</h4>
    <div class="postbody"><span class="postbody">Thanks for this infos ans explanations :) !
<br/>
<br/>
So in the hardware how the "re-sampling" work ? If I read a 22050 Hz sound data on channel 1, the channel will take 1 word every 4/22050 sec (I think).
<br/>
<br/>
So to be able to play this without affecting the sound's pitch, the dac needs to have 32768 value / sec to read, and this values need to be "re-sampled" from the 22050 Hz channel.
<br/>
<br/>
Am I going wrong ?
<br/>
<br/>
If not, how is this process done ?
<br/>
<br/>
I know it's not really the original subject of the topic, but you seem to have a really good knowledge about it :) !</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#102073 - tepples - Sun Sep 10, 2006 4:06 pm</h4>
    <div class="postbody"><span class="postbody">Resampling audio is a bit like stretching an image to a different size. Do you know how rotation and extended rotation backgrounds work?<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#102077 - raphzore - Sun Sep 10, 2006 4:53 pm</h4>
    <div class="postbody"><span class="postbody">In fact I know how resampling works, so for the image streching (1D-&gt;2D).
<br/>
<br/>
But I was wondering how the ds do it (because there is several ways, in term of quality). Simple "stretching" ? linear filtering ? more complexe filtering ?
<br/>
<br/>
Is it virtually CPU free (so not using the ALU that are used when doing ours calculations) ? Or if not, when using 16 channels, the arm7 would be a little busy no ?
<br/>
<br/>
Don't hesitate to say me if I'm totaly wrong in anything, I'm not really sure of my knowledge ^^.
<br/>
<br/>
About rotation I don't know anything about it, in which way is it linked to this problem ?
<br/>
<br/>
Anyway, thanks again for spending time answering me, I appreciate it :).
<br/>
<br/>
You are involved in the DevKitPro developpement ?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#102080 - tepples - Sun Sep 10, 2006 5:45 pm</h4>
    <div class="postbody"><span class="postbody">The nearest-neighbor resampling performed by the hardware doesn't take any CPU time. But for something of higher quality, such as cubic interpolation, you're going to need to spend a bit of time in your ARM7 program.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#102081 - raphzore - Sun Sep 10, 2006 5:55 pm</h4>
    <div class="postbody"><span class="postbody">Great, thanks a lot :) !</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#102120 - raphzore - Mon Sep 11, 2006 12:38 am</h4>
    <div class="postbody"><span class="postbody">In fact I came up with another question ^^.
<br/>
<br/>
Are the sound DMA of the DS still reading 4 words (16 bytes) at a time, like the general purpose DMA of the GBA ?</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
