<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Streaming Sound - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>DS development > Streaming Sound</h2>
<div id="posts">
<div class="post">
    <h4>#55325 - GPFerror - Tue Sep 27, 2005 7:26 pm</h4>
    <div class="postbody"><span class="postbody">Need some help with how to do this or some examples please.
<br/>
<br/>
right now I am calling my function that generates a sound buffer on the arm9 with a set size and then calling playGenericSound on the buffer, right now I have no syncing up being done and the calcsoundbuffer and playsound functions im sure are being called before or late therefore sounding like crap. How can I calculate the buffersize so its in sync?
<br/>
<br/>
I was thinking of somekind of ringbuffer but dont know how to implement this on the DS.
<br/>
<br/>
I understand the general concept but not the implementation. I'v been looking through different released source code of different projects but there is usually so much other code that it makes it difficult to pick out and use what I need.
<br/>
<br/>
So anyone give me code, how to calculate buffersize based off timer/interupts ect on both arm7 and arm9 . and how to sync it up.
<br/>
<br/>
Thanks,
<br/>
Troy(GPF)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#55375 - headspin - Wed Sep 28, 2005 2:28 am</h4>
    <div class="postbody"><span class="postbody">GPF: This is for FrodoDS right? Did you get the files I sent to your e-mail? I was trying to set up a timer on the ARM7 that will store an IPC variable of the current play position of the buffer. From that the ARM9 can calculate when to send the next buffer chunk. Basing that on the Win32 implementation of sound in Frodo, it should theoretically work.
<br/>
<br/>
Unfortunately I couldn't get timers working at all using the new libnds, whereas the older ndslib was no problem.<br/>_________________<br/><a class="postlink" href="http://headsoft.com.au/index.php?category=warhawk" target="_blank">Warhawk DS</a> | <a class="postlink" href="http://headsoft.com.au/index.php?category=mmll" target="_blank">Manic Miner: The Lost Levels</a> | <a class="postlink" href="http://headsoft.com.au/index.php?category=tdg" target="_blank">The Detective Game</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#55377 - GPFerror - Wed Sep 28, 2005 2:33 am</h4>
    <div class="postbody"><span class="postbody">actually its for something else because I knew you were working on FrodoDS but I didnt get your email could you send it again please. Or send me a link by pm and I will download it.
<br/>
<br/>
Thanks</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#55398 - DekuTree64 - Wed Sep 28, 2005 6:18 am</h4>
    <div class="postbody"><span class="postbody">The way I've done it before is by playing a looping buffer on ARM7, and using hardware timers on ARM9 to keep track of where it is in the buffer. The only tricky thing is getting the sound channel and the timers started at close to the same time.
<br/>
Make sure the channel starts a little sooner though, so you never fill past where it currently is.
<br/>
<br/>
The actual ring buffering is just a matter of splitting up a load of samples if you're going to hit the end before it's done. 
<br/>
<br/>
For example, say your buffer is 1000 samples long, your current position is 900, and you need to mix 500 samples. 900 + 500 would go past 1000, so it needs split up. Your first batch will be 
<br/>
bufferLength - bufferPos = 1000 - 900 = 100 samples.
<br/>
After that's done, set the position back to 0, and since you've mixed 100 samples so far, you need to mix 400 more to get to your total 500. So mix them, update the buffer position to 400, and you're done.
<br/>
<br/>
<br/>
For the sample counting, you can use a timer that triggers an interrupt every x samples, and in the interrupt update a variable telling how many samples need to be mixed. Then in your game loop or VBlank or something, mix however many samples have accumulated in that variable, and reset it to 0.
<br/>
<br/>
If I remember right, sound channel timers run at half the frequency of the CPU hardware timers, so set your counting timer's overflow period to 2*soundChannelTimerPeriod*x, where x is the number of samples you want to wait between each interrupt (I used 256).
<br/>
The actual REG_TMxD value will be 65536 - period.<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#55460 - gladius - Wed Sep 28, 2005 6:19 pm</h4>
    <div class="postbody"><span class="postbody">Check out <a href="http://forum.gbadev.org/viewtopic.php?p=45741" target="_blank">http://forum.gbadev.org/viewtopic.php?p=45741</a> for some sample code to do this.  For the arm9, all I did was send a FIFO message from the arm7 when the mixing needed to be done and do the mixing on the arm9 then.  Works a treat.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#55465 - GPFerror - Wed Sep 28, 2005 7:31 pm</h4>
    <div class="postbody"><span class="postbody">Here is the code that im currently using on the arm9 side , EmulateLine() is called in a loop for each rasterline. How would I convert it to stay in sync? Really appreciate the help and hope that this message can be used by others since there seems to be little documentation on using sound streaming at this time.
<br/>
<br/>
I have gone through gladius's soundmixer forum post and DekuTree64 ModplayerDS code and many other sound code and Im understanding what its doing but im lost on how I should implement it for the code below.
<br/>
<br/>
Thanks,
<br/>
Troy(GPF)
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
  const unsigned TOTAL_RASTERS = 0x138;
<br/>
  const unsigned SCREEN_FREQ = 50; 
<br/>
  const int SAMPLE_BUF_SIZE = 0x138*2;
<br/>
  const uint32 SAMPLE_FREQ = 11025;
<br/>
<br/>
void DigitalRenderer::init_sound(void)
<br/>
{ 
<br/>
  sndbufsize = SAMPLE_BUF_SIZE;
<br/>
  sound_buffer = new int16[sndbufsize];
<br/>
  int sample_in_ptr;
<br/>
  ready = true;
<br/>
}
<br/>
<br/>
  setGenericSound (SAMPLE_FREQ,64,64,1); 
<br/>
<br/>
void DigitalRenderer::EmulateLine(void)
<br/>
{
<br/>
  if (ready)
<br/>
  {
<br/>
    static int divisor = 0;
<br/>
    static int to_output = 0;
<br/>
    static int buffer_pos = 0;
<br/>
<br/>
    if (!ready)
<br/>
   return;
<br/>
<br/>
   sample_buf[sample_in_ptr] = volume;
<br/>
   sample_in_ptr = (sample_in_ptr + 1) % SAMPLE_BUF_SIZE;
<br/>
<br/>
    /*
<br/>
     * Now see how many samples have to be added for this line
<br/>
     */
<br/>
    divisor += SAMPLE_FREQ;
<br/>
    while (divisor &gt;= 0)
<br/>
       divisor -= TOTAL_RASTERS*SCREEN_FREQ, to_output++;
<br/>
<br/>
    /*
<br/>
     * Calculate the sound data only when we have enough to fill
<br/>
     * the buffer entirely.
<br/>
     */
<br/>
     
<br/>
    if ((buffer_pos + to_output) &gt;= sndbufsize) {
<br/>
   int datalen = sndbufsize - buffer_pos;
<br/>
   to_output -= datalen;
<br/>
<br/>
                //creates the soundbuffer to be played
<br/>
   calc_buffer(sound_buffer + buffer_pos, datalen*2);
<br/>
<br/>
                //play the sound
<br/>
   playGenericSound(sound_buffer, sndbufsize*2);
<br/>
   buffer_pos = 0;
<br/>
    }  
<br/>
  }
<br/>
}</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#55491 - GPFerror - Wed Sep 28, 2005 9:30 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>gladius wrote:</b></span></td> </tr> <tr> <td class="quote">Check out <a href="http://forum.gbadev.org/viewtopic.php?p=45741" target="_blank">http://forum.gbadev.org/viewtopic.php?p=45741</a> for some sample code to do this.  For the arm9, all I did was send a FIFO message from the arm7 when the mixing needed to be done and do the mixing on the arm9 then.  Works a treat.</td> </tr></table><span class="postbody">
<br/>
<br/>
So on the arm7 is send a fifo(whats in it? bufferposition?) maybe a code snip would help me.
<br/>
<br/>
Then within my emulateline function I check something in the fifo skip if more data is not needed or call my calc_buffer(sound_buffer,length) with a length from the fifo? or do I still do my default length? Also do I call playGenericSound or just set some value in the fifo to the sndbuffer?
<br/>
<br/>
thanks,
<br/>
Troy</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#55587 - gladius - Thu Sep 29, 2005 6:30 pm</h4>
    <div class="postbody"><span class="postbody">On the arm7 side right after I set up the channels to play, I do this which is just copying over the mixed data in the arm7 play buffers and sending off a command to the arm9 to mix.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
        for (int i = 0; i &lt; MIXBUFSIZE; i++) {
<br/>
            playBuffer[soundCursor + i] = SPC_IPC-&gt;playBuffer[i];
<br/>
            playBuffer[soundCursor + i + (MIXBUFSIZE * 2)] = SPC_IPC-&gt;playBuffer[i + MIXBUFSIZE];
<br/>
        }
<br/>
        if (IPC_FIFO_CR &amp; IPC_FIFO_ERROR) IPC_FIFO_CR |= IPC_FIFO_SEND_CLEAR;
<br/>
        SendArm9Command(ARM9COMMAND_UPDATE_APU);
<br/>
</td> </tr></table><span class="postbody">
<br/>
The on the arm9 side I do this in my irq handler:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
    if (flags &amp; IRQ_FIFO_NOT_EMPTY) {
<br/>
        // Command recieved from arm7
<br/>
        do {
<br/>
            u32 command = IPC_FIFO_RECIEVE;
<br/>
<br/>
            switch (command) {
<br/>
            case ARM9COMMAND_UPDATE_APU:
<br/>
                const int cyclesToExecute = spcCyclesPerSec / (MIXRATE / MIXBUFSIZE);
<br/>
                for (int i = 0; i &lt; cyclesToExecute / 32; i++) {
<br/>
                    DspEmulateOneSample(((u16*)SPC_IPC-&gt;playBuffer) + i);
<br/>
                }
<br/>
                break;
<br/>
            }
<br/>
        } while (!(IPC_FIFO_CR &amp; IPC_FIFO_RECV_EMPTY));
<br/>
<br/>
        IF = IRQ_FIFO_NOT_EMPTY;
<br/>
    }
<br/>
</td> </tr></table><span class="postbody">
<br/>
DspEmulateOneSample just sticks the current sample in at playBuffer[i] which is a buffer stored in shared memory.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#56173 - GPFerror - Thu Oct 06, 2005 9:51 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>gladius wrote:</b></span></td> </tr> <tr> <td class="quote">On the arm7 side right after I set up the channels to play, I do this which is just copying over the mixed data in the arm7 play buffers and sending off a command to the arm9 to mix.
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
        for (int i = 0; i &lt; MIXBUFSIZE; i++) {
<br/>
            playBuffer[soundCursor + i] = SPC_IPC-&gt;playBuffer[i];
<br/>
            playBuffer[soundCursor + i + (MIXBUFSIZE * 2)] = SPC_IPC-&gt;playBuffer[i + MIXBUFSIZE];
<br/>
        }
<br/>
        if (IPC_FIFO_CR &amp; IPC_FIFO_ERROR) IPC_FIFO_CR |= IPC_FIFO_SEND_CLEAR;
<br/>
        SendArm9Command(ARM9COMMAND_UPDATE_APU);
<br/>
</td> </tr></table><span class="postbody">
<br/>
The on the arm9 side I do this in my irq handler:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
    if (flags &amp; IRQ_FIFO_NOT_EMPTY) {
<br/>
        // Command recieved from arm7
<br/>
        do {
<br/>
            u32 command = IPC_FIFO_RECIEVE;
<br/>
<br/>
            switch (command) {
<br/>
            case ARM9COMMAND_UPDATE_APU:
<br/>
                const int cyclesToExecute = spcCyclesPerSec / (MIXRATE / MIXBUFSIZE);
<br/>
                for (int i = 0; i &lt; cyclesToExecute / 32; i++) {
<br/>
                    DspEmulateOneSample(((u16*)SPC_IPC-&gt;playBuffer) + i);
<br/>
                }
<br/>
                break;
<br/>
            }
<br/>
        } while (!(IPC_FIFO_CR &amp; IPC_FIFO_RECV_EMPTY));
<br/>
<br/>
        IF = IRQ_FIFO_NOT_EMPTY;
<br/>
    }
<br/>
</td> </tr></table><span class="postbody">
<br/>
DspEmulateOneSample just sticks the current sample in at playBuffer[i] which is a buffer stored in shared memory.</span></td> </tr></table><span class="postbody">
<br/>
<br/>
<br/>
what is MIXBUFSIZE set to? also is their timing involved on the arm9 side or can I continue to call my sound update buffer, but now it would check the fifo first before actually generating a new buffer?
<br/>
<br/>
thanks,
<br/>
Troy</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#56339 - gladius - Sat Oct 08, 2005 1:40 am</h4>
    <div class="postbody"><span class="postbody">MIXBUFSIZE is set to however big you want your mix buffer to be.  The arm9 is called whenever it needs to update the next MIXBUFSIZE samples.  So that is when you should optimally do your mixing.
<br/>
<br/>
Edit: If you want to see this happening in practice and not pseudo-code, check out the pocketspc source (<a class="postlink" href="http://pocketspc.pocketheaven.com" target="_blank">http://pocketspc.pocketheaven.com</a>).</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#59455 - GPFerror - Tue Nov 01, 2005 10:34 pm</h4>
    <div class="postbody"><span class="postbody">ok looked through the source and im still confused at where to start, right now my code is arm9 only. So I need to switch to using arm7 too. 
<br/>
<br/>
Below is my arm9 code which is called in a loop since its an emulator how should I change the arm9 code to stream the sound?
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">const unsigned TOTAL_RASTERS = 0x138; 
<br/>
  const unsigned SCREEN_FREQ = 50; 
<br/>
  const int SAMPLE_BUF_SIZE = 0x138*2; 
<br/>
  const uint32 SAMPLE_FREQ = 11025; 
<br/>
<br/>
void DigitalRenderer::init_sound(void) 
<br/>
{ 
<br/>
  sndbufsize = SAMPLE_BUF_SIZE; 
<br/>
  sound_buffer = new int16[sndbufsize]; 
<br/>
  int sample_in_ptr; 
<br/>
  ready = true; 
<br/>
} 
<br/>
<br/>
  setGenericSound (SAMPLE_FREQ,64,64,1); 
<br/>
<br/>
void DigitalRenderer::EmulateLine(void) 
<br/>
{ 
<br/>
  if (ready) 
<br/>
  { 
<br/>
    static int divisor = 0; 
<br/>
    static int to_output = 0; 
<br/>
    static int buffer_pos = 0; 
<br/>
<br/>
    if (!ready) 
<br/>
   return; 
<br/>
<br/>
   sample_buf[sample_in_ptr] = volume; 
<br/>
   sample_in_ptr = (sample_in_ptr + 1) % SAMPLE_BUF_SIZE; 
<br/>
<br/>
    /* 
<br/>
     * Now see how many samples have to be added for this line 
<br/>
     */ 
<br/>
    divisor += SAMPLE_FREQ; 
<br/>
    while (divisor &gt;= 0) 
<br/>
       divisor -= TOTAL_RASTERS*SCREEN_FREQ, to_output++; 
<br/>
<br/>
    /* 
<br/>
     * Calculate the sound data only when we have enough to fill 
<br/>
     * the buffer entirely. 
<br/>
     */ 
<br/>
      
<br/>
    if ((buffer_pos + to_output) &gt;= sndbufsize) { 
<br/>
   int datalen = sndbufsize - buffer_pos; 
<br/>
   to_output -= datalen; 
<br/>
<br/>
                //creates the soundbuffer to be played 
<br/>
   calc_buffer(sound_buffer + buffer_pos, datalen*2); 
<br/>
<br/>
                //play the sound 
<br/>
   playGenericSound(sound_buffer, sndbufsize*2); 
<br/>
   buffer_pos = 0; 
<br/>
    }  
<br/>
  } 
<br/>
}</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#59497 - LiraNuna - Wed Nov 02, 2005 6:49 am</h4>
    <div class="postbody"><span class="postbody">Off topic: What emulator is it?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#59538 - GPFerror - Wed Nov 02, 2005 2:42 pm</h4>
    <div class="postbody"><span class="postbody">the c64 emulator Frodo</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#59592 - Dark Knight ez - Wed Nov 02, 2005 8:43 pm</h4>
    <div class="postbody"><span class="postbody">But you said, and I quote:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">actually its for something else because I knew you were working on FrodoDS</td> </tr></table><span class="postbody">
<br/>
;)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#59603 - GPFerror - Wed Nov 02, 2005 9:24 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Dark Knight ez wrote:</b></span></td> </tr> <tr> <td class="quote">But you said, and I quote:
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">actually its for something else because I knew you were working on FrodoDS</td> </tr></table><span class="postbody">
<br/>
;)</span></td> </tr></table><span class="postbody">
<br/>
<br/>
:) yeah that has changed now since I havent the slightest clue on how to do sound streaming for anything on the ds yet</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#59673 - gladius - Thu Nov 03, 2005 6:38 am</h4>
    <div class="postbody"><span class="postbody">The general architecture I chose for streaming sound requires a custom arm7 binary.  It sets the sound system up as normal to play a looped buffer, which is essentially a timer IRQ that plays the new buffers.
<br/>
<br/>
Then when that timer irq occurs on the arm7 side, it plays the current buffer, and sets the toBeMixed buffer to the next one.  It then sends a FIFO message to the arm9 saying "hey, i just started started playing your samples, start mixing the ones for next time right now".
<br/>
<br/>
The arm9 then recieves this message and goes ahead and does the mixing into shared ram at the toBeMixed buffer location.
<br/>
<br/>
Then the next time the irq happens on the arm7 it plays the toBeMixed buffer and sets the toBeMixed buffer to the old location.  This cycle is repeated forever.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
