<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Problem with key presses[SOLVEDish??] - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > Problem with key presses[SOLVEDish??]</h2>
<div id="posts">
<div class="post">
    <h4>#166015 - afireohno - Fri Jan 16, 2009 10:19 pm</h4>
    <div class="postbody"><span class="postbody">I'm getting some strangeness using keysDown(), etc in combination with KEY_X and KEY_Y inside a class. It always evaluates to true. KEY_A and KEY_B work exactly as I would expect. I've even tried something like
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
scanKeys();
<br/>
keysD = keysDown();
<br/>
myClass-&gt;foo(keysD);
<br/>
</td> </tr></table><span class="postbody">
<br/>
No luck.
<br/>
Does anyone have any ideas what I might be doing wrong.
<br/>
edit: So after messing around some I'm more confused than originally.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
//in main
<br/>
bool g = false;
<br/>
while(1)
<br/>
{
<br/>
scanKeys()
<br/>
if (keysHeld() &amp; KEY_X)
<br/>
{
<br/>
   g = true;
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
g is immediately not zero?</span><span class="gensmall"><br/><br/>Last edited by afireohno on Sat Jan 17, 2009 7:08 pm; edited 2 times in total</span></div>    
</div>
<div class="post">
    <h4>#166020 - elhobbs - Sat Jan 17, 2009 5:30 am</h4>
    <div class="postbody"><span class="postbody">scanKeys must be called at least twice before keysHeld has a usable value. there is a thread on the subject... but I could not find it.
<br/>
<br/>
scanKeys stores the state of the keys internally. keysDown can be used to determine if button was pressed since the last call to scanKeys. keysHeld can be used to determine if the button was down for two or more calls to scanKeys.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#166024 - afireohno - Sat Jan 17, 2009 11:22 am</h4>
    <div class="postbody"><span class="postbody">I've tried keysDown()
<br/>
Everything works normally with KEY_A, KEY_B, etc. It is only KEY_Y, and KEY_X that cause the statement to evaluate true without any presses.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#166025 - TwentySeven - Sat Jan 17, 2009 12:10 pm</h4>
    <div class="postbody"><span class="postbody">You're going to have to post alot more source.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#166026 - Cearn - Sat Jan 17, 2009 2:37 pm</h4>
    <div class="postbody"><span class="postbody">If you don't get any response from X and Y at all, you may still have an irqInit() somewhere. As far as I can know, extra calls to irqInit effectively disables the FIFO system used for inter-processor communication. Since X and Y come from the Arm7, this would leave them inactive.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#166027 - afireohno - Sat Jan 17, 2009 2:52 pm</h4>
    <div class="postbody"><span class="postbody">I don't have irqInit() but maybe I'm missing a needed init somewhere. Here is a simple test prog I made up to demonstrate the behavior with as little code as possible.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
<br/>
#include &lt;nds.h&gt;
<br/>
#include &lt;stdio.h&gt;
<br/>
<br/>
int main() 
<br/>
{   
<br/>
   consoleDemoInit();      
<br/>
   int test = 0;
<br/>
   
<br/>
   while(1) {      
<br/>
      scanKeys();      
<br/>
      if(keysHeld() &amp; KEY_X)
<br/>
      {
<br/>
         test = 1;
<br/>
      }      
<br/>
      swiWaitForVBlank();            
<br/>
      consoleClear();      
<br/>
      printf("test = %i",test);
<br/>
      
<br/>
   }
<br/>
   return 0;
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
It's probably something simple but I can't figure it out.
<br/>
edit: took out some more code.
<br/>
tested on no$gba. I'm away from hardware so I haven't tried that yet.
<br/>
<br/>
edit: edit: test with different keys (i.e. KEY_A) and it works as expected.
<br/>
KEY_X, and KEY_Y set test to 1 without any presses.
<br/>
could consoleDemoInit() be the culprit?</span><span class="gensmall"><br/><br/>Last edited by afireohno on Sat Jan 17, 2009 3:17 pm; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#166028 - Legolas - Sat Jan 17, 2009 3:08 pm</h4>
    <div class="postbody"><span class="postbody">This works for me:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
<br/>
#include &lt;nds.h&gt;
<br/>
#include &lt;stdio.h&gt;
<br/>
<br/>
int main()
<br/>
{   
<br/>
   consoleDemoInit();      
<br/>
   int test = 0;
<br/>
   
<br/>
   while(1) {      
<br/>
      scanKeys();      
<br/>
      if(keysHeld() &amp; KEY_X)
<br/>
      {
<br/>
         test = 1;
<br/>
      } else         /// &lt;----------
<br/>
      {                /// &lt;----------
<br/>
         test = 0;  /// &lt;----------  
<br/>
      }                /// &lt;---------- 
<br/>
      swiWaitForVBlank();            
<br/>
      consoleClear();      
<br/>
      printf("test = %i",test);
<br/>
      
<br/>
   }
<br/>
   return 0;
<br/>
} 
<br/>
<br/>
</td> </tr></table><span class="postbody"><br/>_________________<br/><a class="postlink" href="http://itaprogaming.free.fr/" target="_blank">My homepage</a>!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#166029 - afireohno - Sat Jan 17, 2009 3:23 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Legolas wrote:</b></span></td> </tr> <tr> <td class="quote">This works for me:</td> </tr></table><span class="postbody">
<br/>
Yeah this works as expected for me as well.
<br/>
<br/>
edit: After testing random things I found that waiting 2 or more VBlanks before calling scanKeys() fixes the problem. I have no idea why so if anyone could explain this behavior or knows what I might be doing wrong I would appreciate the info. Thanks for the help. Working code.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#include &lt;nds.h&gt;
<br/>
#include &lt;stdio.h&gt;
<br/>
<br/>
int main() 
<br/>
{      
<br/>
   consoleDemoInit();   
<br/>
   for (int i = 0; i &lt;2; i++)
<br/>
   {
<br/>
      swiWaitForVBlank();
<br/>
   }
<br/>
   
<br/>
   int test = 0;
<br/>
   while(1) {      
<br/>
      scanKeys();      
<br/>
      if(keysHeld() &amp; KEY_X)
<br/>
      {
<br/>
         test = 1;
<br/>
      }
<br/>
      swiWaitForVBlank();
<br/>
      consoleClear();      
<br/>
      printf("test = %i",test);      
<br/>
   }
<br/>
   return 0;
<br/>
}
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#166036 - Echo49 - Sun Jan 18, 2009 1:56 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>elhobbs wrote:</b></span></td> </tr> <tr> <td class="quote">scanKeys must be called at least twice before keysHeld has a usable value. there is a thread on the subject... but I could not find it.
<br/>
<br/>
scanKeys stores the state of the keys internally. keysDown can be used to determine if button was pressed since the last call to scanKeys. keysHeld can be used to determine if the button was down for two or more calls to scanKeys.</td> </tr></table><span class="postbody">
<br/>
<br/>
edit: i'm sorry, i read the question wrong</span><span class="gensmall"><br/><br/>Last edited by Echo49 on Mon Jan 19, 2009 6:13 am; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#166049 - afireohno - Sun Jan 18, 2009 9:52 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Echo49 wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>elhobbs wrote:</b></span></td> </tr> <tr> <td class="quote">scanKeys must be called at least twice before keysHeld has a usable value. there is a thread on the subject... but I could not find it.
<br/>
<br/>
scanKeys stores the state of the keys internally. keysDown can be used to determine if button was pressed since the last call to scanKeys. keysHeld can be used to determine if the button was down for two or more calls to scanKeys.</td> </tr></table><span class="postbody"></span></td> </tr></table><span class="postbody">
<br/>
This doesn't really explain the odd behavior I was asking about.
<br/>
In the code I posted above changing KEY_X to KEY_A and removing the loop causes normal behavior. test = 0 until KEY_A is pressed. If I then change KEY_A to KEY_X or KEY_Y and leave the for loop commented out, test is immediately assigned the value 1. The code behaves similarly regardless if I use keysHeld() or keyDown().</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#166050 - Maxxie - Sun Jan 18, 2009 10:06 pm</h4>
    <div class="postbody"><span class="postbody">It does. Key_X/Y requires communication with the ARM7. Key_A can be read locally. I think that this internal difference gets to the surface at this point is a bug and should be solved in the lib.
<br/>
<br/>
Just live with it right now, and make sure everything is up and running before relying on it. The least ppl will notice a 2-vblank-delay at startup.<br/>_________________<br/><a class="postlink" href="http://nintendods.desperate-programmers.com/doku.php?id=wireless_io_map" target="_blank">Trying  to bring more detail into understanding the wireless hardware</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#166086 - sverx - Mon Jan 26, 2009 10:49 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>elhobbs wrote:</b></span></td> </tr> <tr> <td class="quote">scanKeys must be called at least twice before keysHeld has a usable value. there is a thread on the subject... but I could not find it.</td> </tr></table><span class="postbody">
<br/>
<br/>
Maybe is <a class="postlink" href="http://forum.gbadev.org/viewtopic.php?t=16327" target="_blank">this one</a> (reposting it because my post was lost in yesterday HD failure...)
<br/>
<br/>
btw I ended up using keys A &amp; B instead of X &amp; Y in my little example program. I didn't want to add other code and make things look more complicated, and I still believe it should be marked as bug. Ok, maybe not, but it shouldn't behave like that... :|
<br/>
<br/>
<br/>
<br/>
<br/>
?<br/>_________________<br/><a class="postlink" href="http://bit.ly/yiQrz9" target="_blank">libXM7</a>|<a class="postlink" href="http://bit.ly/yJwcOo" target="_blank">NDS programming tutorial (Italiano)</a>|<a class="postlink" href="http://disjointedstudio.blogspot.com/" target="_blank">Waimanu DS / GBA</a>|<a class="postlink" href="http://adshomebrewersdiary.blogspot.com" target="_blank">A DS Homebrewer's Diary</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#166434 - paladine - Sun Feb 08, 2009 6:08 am</h4>
    <div class="postbody"><span class="postbody">I'm having the same problem.  Everything was working great, but then I upgraded to the latest devkitARM + libnds 1.3.1.  Now my X/Y aren't recognizing as pressed, and neither is the touchscreen.  
<br/>
<br/>
I'm thinking perhaps there's a problem with the lib.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#166436 - elhobbs - Sun Feb 08, 2009 6:26 am</h4>
    <div class="postbody"><span class="postbody">make sure you did not call IrqInit in your code</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#166438 - Emmanuel - Sun Feb 08, 2009 8:03 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>elhobbs wrote:</b></span></td> </tr> <tr> <td class="quote">make sure you did not call IrqInit in your code</td> </tr></table><span class="postbody">
<br/>
<br/>
Why is that? I noticed it worked when I commented the IrqInit...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#166439 - Echo49 - Sun Feb 08, 2009 9:11 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>devkitpro.org wrote:</b></span></td> </tr> <tr> <td class="quote">Important Note: breaking changes.
<br/>
<br/>
Interrupt initialisation is now done before main including enabling the vblank interrupt. Since the functions to do this are common to most if not all homebrew apps we decided to simplify things rather than adding extra initialisation in user code for the FIFO based command system. Calling irqInit in main will currently break your code.</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
