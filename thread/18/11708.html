<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>GCC problems - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>DS development > GCC problems</h2>
<div id="posts">
<div class="post">
    <h4>#109150 - Cthulhu - Wed Nov 15, 2006 4:52 pm</h4>
    <div class="postbody"><span class="postbody">Don't know where to post it, so if this is the wrong place, please feel free to move or delete this post :)
<br/>
<br/>
I have some structures in a binary file that i want to read, the structures are like this:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#pragma pack(push, 1)
<br/>
struct MulCell
<br/>
{
<br/>
   u16 TileID;
<br/>
   u8 Z;
<br/>
};
<br/>
<br/>
struct MulBlock
<br/>
{
<br/>
   MulCell cells[8][8];
<br/>
};
<br/>
#pragma pack
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
In a win32 test that i did all worked fine and the data was loaded without problems, but trying to read it from the DS gives "corrupted" data, the first (and ONLY the first) cell (cell[0][0]) gets the correct data, but the other cells won't.
<br/>
The code i use to read:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
   x %= width;
<br/>
   y %= height;
<br/>
<br/>
   u32 blockID = (x / 8) * (height / 8) + (y / 8);
<br/>
   u32 offset = blockID * 192;
<br/>
<br/>
   fseek(fmap, offset, SEEK_SET);
<br/>
   fread(&amp;block-&gt;cells, sizeof(MulCell), 64, fmap);
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
The compiler throws this warning:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote"> warning: #pragma pack(push[, id], &lt;n&gt;) is not supported on this target</td> </tr></table><span class="postbody">
<br/>
<br/>
Any ideas? :S</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#109151 - Mighty Max - Wed Nov 15, 2006 5:02 pm</h4>
    <div class="postbody"><span class="postbody">use "__attribute__(__packed__)" on the structs instead of the pragma
<br/>
<br/>
the corruption you observed should be a 1 byte shifting per entry, as the normal alignment will add a 1 byte space between the 3 byte structures<br/>_________________<br/><a class="postlink" href="http://mightymax.org/gbamp_multiboot.html" target="_blank">GBAMP Multiboot</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#109152 - Cthulhu - Wed Nov 15, 2006 5:13 pm</h4>
    <div class="postbody"><span class="postbody">I tried that and it gives the same "corrupted" value
<br/>
Win32 right value = 174
<br/>
NDS value = 17636
<br/>
<br/>
The code:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">struct MulCell
<br/>
{
<br/>
   u16 TileID;
<br/>
   u8 Z;
<br/>
}__attribute__((__packed__));
<br/>
<br/>
struct MulBlock
<br/>
{
<br/>
   MulCell cells[8][8];
<br/>
}__attribute__((__packed__));</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#109153 - Mighty Max - Wed Nov 15, 2006 5:27 pm</h4>
    <div class="postbody"><span class="postbody">Add a packed to the array too. the aray is a structure that might exist packed and unpacked too. 
<br/>
<br/>
If i understand it correc, packed on the struct can only remove the alignment fillers at the structures level, not from substructures as the array.<br/>_________________<br/><a class="postlink" href="http://mightymax.org/gbamp_multiboot.html" target="_blank">GBAMP Multiboot</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#109161 - Cthulhu - Wed Nov 15, 2006 6:12 pm</h4>
    <div class="postbody"><span class="postbody">I've found that this only works if the two variables are of the same size, so i had to change it to:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
struct MulCell
<br/>
{
<br/>
   u16 TileID;
<br/>
   u16 Z;
<br/>
}__attribute__((__packed__)); </td> </tr></table><span class="postbody">
<br/>
<br/>
And change the file format to fit this... increasing its file size. Don't like this solution at all... anyone knows a more elegant way to do this?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#109163 - Mighty Max - Wed Nov 15, 2006 6:29 pm</h4>
    <div class="postbody"><span class="postbody">Yes, undo the change (that works only because you now fit axactly the alignment) and do 64 single reads into that struct of sizeof(MulCell) = 3.<br/>_________________<br/><a class="postlink" href="http://mightymax.org/gbamp_multiboot.html" target="_blank">GBAMP Multiboot</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#109165 - tepples - Wed Nov 15, 2006 6:53 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Cthulhu wrote:</b></span></td> </tr> <tr> <td class="quote">I have some structures in a binary file that i want to read, the structures are like this:
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#pragma pack(push, 1)
<br/>
struct MulCell
<br/>
{
<br/>
   u16 TileID;
<br/>
   u8 Z;
<br/>
};
<br/>
<br/>
struct MulBlock
<br/>
{
<br/>
   MulCell cells[8][8];
<br/>
};
<br/>
#pragma pack
<br/>
</td> </tr></table><span class="postbody"></span></td> </tr></table><span class="postbody">
<br/>
The most portable way to deserialize a struct is to read it a byte at a time into RAM.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#109290 - Cthulhu - Thu Nov 16, 2006 11:03 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Mighty Max wrote:</b></span></td> </tr> <tr> <td class="quote">Yes, undo the change (that works only because you now fit axactly the alignment) and do 64 single reads into that struct of sizeof(MulCell) = 3.</td> </tr></table><span class="postbody">
<br/>
<br/>
Its the same... the data gets all corrupted or shifted or whatever... and don't like at all the "solution" of making all the variables of the same type.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">The most portable way to deserialize a struct is to read it a byte at a time into RAM.</td> </tr></table><span class="postbody">
<br/>
<br/>
You mean this?
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
   fseek(fmap, offset, SEEK_SET);
<br/>
   //fread(&amp;block-&gt;cells, sizeof(MulCell), 64, fmap);
<br/>
   for(int i = 0; i &lt; 8; i++)
<br/>
   {
<br/>
      for(int j = 0; j &lt; 8; j++)
<br/>
      {
<br/>
         fread(&amp;block-&gt;cells[i][j].TileID, sizeof(u16), 1, fmap);
<br/>
         fread(&amp;block-&gt;cells[i][j].Z, sizeof(s8), 1, fmap);
<br/>
      }
<br/>
   }
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Its exactly the same, it reads wrong data... any ideas? :(
<br/>
<br/>
(In Win32 reads the data fine... it must be some DS or libfat thing :S)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#109291 - Mighty Max - Thu Nov 16, 2006 11:34 pm</h4>
    <div class="postbody"><span class="postbody">That should work just fine, regardless of the packed settings. libfat should be alignment secure too (only the very early versions had a problem here).
<br/>
<br/>
Are you sure you have opened them on both systems as binary?<br/>_________________<br/><a class="postlink" href="http://mightymax.org/gbamp_multiboot.html" target="_blank">GBAMP Multiboot</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#109294 - Cthulhu - Thu Nov 16, 2006 11:50 pm</h4>
    <div class="postbody"><span class="postbody">Yes, in both systems the files are opened in binary, i double checked this.
<br/>
<br/>
I downloaded the libfat form the first post <a class="postlink" href="http://forum.gbadev.org/viewtopic.php?t=10289" target="_blank">here</a>. I really dont know what to do, because change the type of the variables to fit "well" isn't really an option (maybe for one file, but not for the rest).</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#109298 - DekuTree64 - Fri Nov 17, 2006 1:11 am</h4>
    <div class="postbody"><span class="postbody">You could try explicitly splitting the u16 member into two u8s, and combine them manually when reading:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">struct MulCell 
<br/>
{ 
<br/>
   u8 TileID_lo; 
<br/>
   u8 TileID_hi; 
<br/>
   u8 Z; 
<br/>
}; 
<br/>
<br/>
struct MulBlock 
<br/>
{ 
<br/>
   MulCell cells[8][8]; 
<br/>
}; 
<br/>
<br/>
void Foo()
<br/>
{
<br/>
    MulCell *cell = something;
<br/>
    u32 tileID = cell-&gt;TileID_lo | (cell-&gt;TileID_hi &lt;&lt; 8);
<br/>
<br/>
    // Do stuff with tileID
<br/>
}</td> </tr></table><span class="postbody">
<br/>
A bit uglier, but no compiler funkiness to worry about. That's basically what the compiler would do with a packed u16 anyway.<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#109317 - tepples - Fri Nov 17, 2006 4:44 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Cthulhu wrote:</b></span></td> </tr> <tr> <td class="quote">Yes, in both systems the files are opened in binary, i double checked this.</td> </tr></table><span class="postbody">
<br/>
"Binary" varies between platforms. The big differences are <a class="postlink" href="http://en.wikipedia.org/wiki/Endianness" target="_blank">endianness</a> and alignment. Safest is not to use fwrite() on one platform and fread() on another unless you're reading something that has been formatted as an array of u8 or s8.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#109352 - Cthulhu - Fri Nov 17, 2006 3:14 pm</h4>
    <div class="postbody"><span class="postbody">I tried to go with fprintf &amp; fscanf, fwrite &amp; fread, and nothing... even if i read byte per byte only the first struct gets readed fine, the others get incorrect data, here is my code for write the file in win32, i read another file and write the new one without the header information, the only info i need is the mulblocks.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">   FILE * nuevo;
<br/>
   fopen_s(&amp;nuevo,"map2_n.mul","wb");
<br/>
<br/>
   while(!feof(fmap))
<br/>
   {
<br/>
      MulBlock block;
<br/>
<br/>
      unsigned int header;
<br/>
      int h = fread(&amp;header, sizeof(unsigned int),1,fmap);
<br/>
      int h1 = fread(&amp;block.cells, sizeof(MulCell), 64, fmap);
<br/>
      int h2 = fwrite(&amp;block.cells,sizeof(MulCell), 64, nuevo);
<br/>
   }
<br/>
   fclose(nuevo);
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
<br/>
And here is the code for reading in the DS:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
   x %= width;
<br/>
   y %= height;
<br/>
<br/>
   u32 blockID = (x / 8) * (height / 8) + (y / 8);
<br/>
   u32 offset = blockID * 192;
<br/>
<br/>
   fseek(fmap, offset, SEEK_SET);
<br/>
   int h = fread(&amp;block-&gt;cells, sizeof(MulCell), 64, fmap);
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
So... what can i do?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#109354 - KoshNi - Fri Nov 17, 2006 3:30 pm</h4>
    <div class="postbody"><span class="postbody">fae ujlagf nyarlathotep jgjklg  daukjg !! 
<br/>
adjklhad yoggsototh  f kl lh  iophe  guik a! 
<br/>
sgiz !! sgiz !!
<br/>
<br/>
<br/>
[I'm sorry. I couldn't resist. :) ]<br/>_________________<br/>Sunshine. Beauty. Love. Happiness.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#109358 - OOPMan - Fri Nov 17, 2006 4:18 pm</h4>
    <div class="postbody"><span class="postbody">Shouldn't that be...
<br/>
<br/>
Ia! Ia! Cthulhu Ftaghn!<br/>_________________<br/>"My boot, your face..." - Attributed to OOPMan, Emperor of Eroticon VI
<br/>
<br/>
You can find my NDS homebrew projects <a class="postlink" href="http://blog.dev-scene.com/oopman/" target="_blank">here...</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#109413 - tepples - Sat Nov 18, 2006 1:58 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Cthulhu wrote:</b></span></td> </tr> <tr> <td class="quote">I tried to go with fprintf &amp; fscanf, fwrite &amp; fread, and nothing... even if i read byte per byte only the first struct gets readed fine, the others get incorrect data</td> </tr></table><span class="postbody">
<br/>
Have you looked at the file that your win32 code generates in a hex editor? And have you made a simple hex viewer for the DS? The learning experience from those should teach you about file handling.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#109578 - Cthulhu - Sun Nov 19, 2006 12:20 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tepples wrote:</b></span></td> </tr> <tr> <td class="quote">Have you looked at the file that your win32 code generates in a hex editor?</td> </tr></table><span class="postbody">
<br/>
<br/>
Yes, i've looked at the original and the new file and all the data is correct (at least for what i understood from the struct viewer in Hex Workshop), i even tried to read the original file from the DS and it's the same, the first 64 (8x8 MulCell = 1 Block) structs are readed fine, then all the data readed is wrong. I'll keep looking at the files in a hex editor, maybe i missed something... 
<br/>
By the way, as i dont have the ds right now to test things on it (girlfriend have it until thursday) i use libfat-20060709.tar.bz2 because its the one that works with Dualis without too much trouble, is there some other emu that supports fat?</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
