<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Should I deal with the IPC for audio now? - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > Should I deal with the IPC for audio now?</h2>
<div id="posts">
<div class="post">
    <h4>#161233 - DiscoStew - Thu Jul 31, 2008 4:14 am</h4>
    <div class="postbody"><span class="postbody">From what I've read, it seems in a future version of libnds, IPC will be removed to make room for a FIFO communication layer. I have no idea when that will be released, but at this time, I've been wanting to tinker with some audio. I don't have any major plans, like a mod player or whatnot. I don't have expertise in that category. All I want is to be able to playback audio samples in the basic, but compatible, formats that the DS uses from my card.
<br/>
<br/>
For streaming, I plan to use libfat to stream data into a buffer in main RAM that the audio hardware will continually run through (buffer split into two, so while hardware plays one section, the other gets updated, and they switch). I've got the plan all laid out for implementing this except for one part, and that is getting data from the ARM9 to the ARM7 so the ARM7 can take that data, and use it to set up the audio for playback. From what I know, the IPC handles this atm, and I have no idea on how to work with it.
<br/>
<br/>
Again, I know that the IPC will be removed for a much better method (?) in time, so should I even worry about this right now? It's not something that's needed right now. It's just a little change from what I have been doing, to let my brain relax.<br/>_________________<br/><span style="font-weight: bold">DS</span> - It's all about <span style="font-weight: bold">D</span>isco<span style="font-weight: bold">S</span>tew</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161237 - nanou - Thu Jul 31, 2008 5:32 am</h4>
    <div class="postbody"><span class="postbody">There's no reason not to mess around with it. I'm sure you'll get derided by at least one person if you release source that uses the IPC struct, but what can you do until the new libnds is ready?
<br/>
<br/>
I've put stuff on hold simply waiting for the new lib, but waiting isn't getting my stuff done.<br/>_________________<br/>- nanou</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161238 - eKid - Thu Jul 31, 2008 5:37 am</h4>
    <div class="postbody"><span class="postbody">When the next libnds is here, streaming will be handled magically :P
<br/>
Example:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">u8 wavedata[800] __attribute((aligned(4)));
<br/>
<br/>
void fill_stream( mm_addr dest, mm_word nsamples )
<br/>
{
<br/>
   read_the_file( dest, nsamples );
<br/>
}
<br/>
<br/>
void start_stream(void)
<br/>
{
<br/>
   mm_stream_info si;
<br/>
   si.channel = 14;
<br/>
   si.playback_rate = 16000;
<br/>
   si.wave_buffer = wavedata;
<br/>
   si.callback_mono = fill_stream;
<br/>
   si.wave_format = MM_SFORMAT_8BIT_MONO;
<br/>
   si.timers = MM_STIMERS_01;
<br/>
   si.fill_mode = MM_STREAM_FILL_AUTO; // auto-pulse
<br/>
   si.volume = 255;   // max vol
<br/>
   mmOpenStream( &amp;si );
<br/>
}
<br/>
<br/>
void stop_stream(void)
<br/>
{
<br/>
   mmCloseStream();
<br/>
}
<br/>
</td> </tr></table><span class="postbody">(compatible with arm7 OR arm9)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161239 - DiscoStew - Thu Jul 31, 2008 6:06 am</h4>
    <div class="postbody"><span class="postbody">nanou:
<br/>
<br/>
The problem is that I know nothing about the IPC, so I'd have to figure out what does what in the whole scheme of things before even attempting to use it in something applicable, and considering that it will all get tossed at some point in the (near?) future, it would feel like I'd be wasting time by trying to understand it rather than continue with my current project. Even for something as simplistic as what I had in mind, it seems rather complicated to set up.
<br/>
<br/>
eKid:
<br/>
<br/>
That looks pretty simplistic.<br/>_________________<br/><span style="font-weight: bold">DS</span> - It's all about <span style="font-weight: bold">D</span>isco<span style="font-weight: bold">S</span>tew</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161241 - DensitY - Thu Jul 31, 2008 6:35 am</h4>
    <div class="postbody"><span class="postbody">I'd use IPC and do a freeze on which version of libnds you use for your project. 
<br/>
<br/>
alternatively you could have a fixed location in ram where the arm7 and arm9 reads same data from, basically the arm9 can have a structure containing list of sound channels (what state they are in, whats paying in them etc),  feeds a pointer to this to the fixed location in memory, the arm7 grabs the pointer from there and can then cast the data over and use the data to populate the sound hardware. that avoids using IPC, although it is a bit messy :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161242 - DiscoStew - Thu Jul 31, 2008 7:11 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>DensitY wrote:</b></span></td> </tr> <tr> <td class="quote">alternatively you could have a fixed location in ram where the arm7 and arm9 reads same data from, basically the arm9 can have a structure containing list of sound channels (what state they are in, whats paying in them etc),  feeds a pointer to this to the fixed location in memory, the arm7 grabs the pointer from there and can then cast the data over and use the data to populate the sound hardware. that avoids using IPC, although it is a bit messy :)</td> </tr></table><span class="postbody">
<br/>
<br/>
That's an interesting idea. This fixed memory address for the pointer; would I be able to set it up as a global variable on both sides, using something like 'extern'? I don't want to use a non-allocated area of memory that can get affected by actual allocation. This is probably a n00b question. I've never dealt with more than one CPU before.
<br/>
<br/>
Also, with the ARM9, memory can be cached, so would I need to flush that pointer (and the section that contains the channel and buffer data) every time they get updated?
<br/>
<br/>
EDIT:
<br/>
<br/>
Perhaps at the start of my program on the ARM9 side, I choose some 'unallocated memory' that I know won't get used at the start, enter the address of where I will have the actual pointer info into it, flush that word, and wait for the value in that 'unallocated memory' to equal 0. On the ARM7 side, the program starts out with a while loop, waiting for that exact same 'unallocated memory' not to be 0, then take that address for it's own use, and set the 'unallocated memory' to 0. By this, I'll have the pointer that I need. Kinda of crude, but I think it will work...that is.....if that section is not equal to 0 in the first place.<br/>_________________<br/><span style="font-weight: bold">DS</span> - It's all about <span style="font-weight: bold">D</span>isco<span style="font-weight: bold">S</span>tew</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161245 - DensitY - Thu Jul 31, 2008 7:40 am</h4>
    <div class="postbody"><span class="postbody">before frame end you'd most likely have to-do a DC_FlushRange. 
<br/>
<br/>
you could possibly do something like this
<br/>
<br/>
arm9:
<br/>
<br/>
volatile SoundStruct Data;
<br/>
<br/>
((vuint32*)0xMemoryLocation) = &amp;Data;
<br/>
<br/>
on arm7 side:
<br/>
<br/>
volatile SoundStruct *Data;
<br/>
<br/>
Data = (SoundStruct*)(0xMemoryLocation);
<br/>
<br/>
<br/>
Now this isn't really perfect, since you have to use the IPC Bus (this isn't the same as libnds's IPC struct) for the arm9 to tel the arm7 that the sound structure has been cast to that memory location, after that point the arm7 can just cast it to its volatile pointer var. hell you could even use the DS's IPC to transfer the pointer it self (again avoiding libnds's IPC structure)
<br/>
<br/>
<br/>
Its a pretty messy idea now that I think about it lol but it defeats any libnds changes to the IPC struct that they have.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161246 - wintermute - Thu Jul 31, 2008 8:31 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>DensitY wrote:</b></span></td> </tr> <tr> <td class="quote">I'd use IPC and do a freeze on which version of libnds you use for your project. 
<br/>
<br/>
alternatively you could have a fixed location in ram where the arm7 and arm9 reads same data from, basically the arm9 can have a structure containing list of sound channels (what state they are in, whats paying in them etc),  feeds a pointer to this to the fixed location in memory, the arm7 grabs the pointer from there and can then cast the data over and use the data to populate the sound hardware. that avoids using IPC, although it is a bit messy :)</td> </tr></table><span class="postbody">
<br/>
<br/>
This is quite possibly some of the worst advice I've ever seen.
<br/>
<br/>
That's more than a bit messy, it will impact the performance of the arm9.
<br/>
<br/>
Advising people to freeze on particular versions of any of the support libraries is incredibly damaging. More than one person has done just that with the result that they're basically stuck with using a 3 year old toolchain or rewriting their code from scratch.<br/>_________________<br/><a class="postlink" href="http://www.devkitpro.org/" target="_blank">devkitPro - professional toolchains at amateur prices</a>
<br/>
<a class="postlink" href="http://wiki.devkitpro.org/index.php/IRC" target="_blank">devkitPro IRC support</a>
<br/>
<a class="postlink" href="http://davejmurphy.com/" target="_blank">Personal Blog</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161247 - DensitY - Thu Jul 31, 2008 8:41 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">That's more than a bit messy, it will impact the performance of the arm9.</td> </tr></table><span class="postbody">
<br/>
<br/>
100% agree, but it lets him play around with something for now which is what he wants.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
This is quite possibly some of the worst advice I've ever seen.
<br/>
..
<br/>
Advising people to freeze on particular versions of any of the support libraries is incredibly damaging. More than one person has done just that with the result that they're basically stuck with using a 3 year old toolchain or rewriting their code from scratch.</td> </tr></table><span class="postbody">
<br/>
<br/>
This completely depends how far he is into a project.. if he has say 6 months of code there, and its for a game (not a library, libraries are a completely different matter, they MUST stay up to date) and a new library update breaks most of his code, then shoot I'd freeze for that game, and the next game use the new version. Companies and game developers do this a fair bit to ensure they actually finish.
<br/>
<br/>
either case, DS, wait for the next version... else you'll get eatten.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161255 - DekuTree64 - Thu Jul 31, 2008 10:10 am</h4>
    <div class="postbody"><span class="postbody">I'd just implement whichever style you feel like, and adapt to the new libnds when it comes out. Basically your 3 tools are shared memory, ability to trigger an interrupt on the other processor, and ability to transfer data to the other processor through the FIFO (which is really not much different from shared memory with an interrupt).
<br/>
<br/>
Some good sound communication styles are:
<br/>
1. Pure shared memory. ARM9 queues up commands in shared memory, ARM7 checks and processes them periodically. Easy to start, but tricky to get just right. Requires careful consideration of locking and atomic operations because both processors can be working with the queue at once.
<br/>
<br/>
2. Pure interrupt command based. Write a messaging system to transfer multiple-word commands by FIFO, and send all the data for a command that way, to be processed immediately by ARM7. Multi-word FIFO transfers are difficult to get working, but you could use the system I wrote way back when <a class="postlink" href="http://forum.gbadev.org/viewtopic.php?p=132370&amp;highlight=#132370" target="_blank">here</a>. Writing the sound commands is very straightforward.
<br/>
<br/>
3. Command queue processed on interrupt. Same as 1, but instead of ARM7 checking the queue periodically, have ARM9 give it an interrupt. Gives a bit more control over timing, but still need to be careful since you most likely won't want to sit around waiting for ARM7 to go through the queue, and that means you might end up pushing another command onto it before ARM7 is done.
<br/>
<br/>
None of those are particularly dependent on the specific library. As long as both processors have a pointer to some shared memory (either by hardcoded address, or sending a pointer across by some other method) you can do 1 or 3.
<br/>
2 would be a pain if libnds uses the FIFO but doesn't support multi-word transfers, but you could implement a similar messaging system using shared memory and a dataless interrupt.<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161260 - simonjhall - Thu Jul 31, 2008 11:29 am</h4>
    <div class="postbody"><span class="postbody">My vote is for #1 in deku's list, shared memory. It's not library dependent and is a pretty classical way of doing it (it's probably been taught in every operating systems class evaa) so there's lots of material available to help you. You do need to go out of your way to prevent race conditions, though!<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161263 - TwentySeven - Thu Jul 31, 2008 12:20 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">This is quite possibly some of the worst advice I've ever seen. </td> </tr></table><span class="postbody">
<br/>
<br/>
And yet everyone else seems to agree with him about shared memory then, hey?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161265 - sgeos - Thu Jul 31, 2008 12:52 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>DensitY wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
This is quite possibly some of the worst advice I've ever seen.
<br/>
..
<br/>
Advising people to freeze on particular versions of any of the support libraries is incredibly damaging.</td> </tr></table><span class="postbody">
<br/>
This completely depends how far he is into a project.. if he has say 6 months of code there, and its for a game *SNIP* and a new library update breaks most of his code, then shoot I'd freeze for that game, and the next game use the new version. Companies and game developers do this a fair bit to ensure they actually finish.</span></td> </tr></table><span class="postbody">
<br/>
Strongly agree.  You can always use the latest version next time.  There are a lot of things you can do next time.
<br/>
<br/>
-Brendan</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161266 - simonjhall - Thu Jul 31, 2008 1:32 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>TwentySeven wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">This is quite possibly some of the worst advice I've ever seen. </td> </tr></table><span class="postbody">
<br/>
<br/>
And yet everyone else seems to agree with him about shared memory then, hey?</span></td> </tr></table><span class="postbody">Shared memory is good, but a freeze on the libnds version is bad.<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161268 - elhobbs - Thu Jul 31, 2008 2:07 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>wintermute wrote:</b></span></td> </tr> <tr> <td class="quote">Advising people to freeze on particular versions of any of the support libraries is incredibly damaging. More than one person has done just that with the result that they're basically stuck with using a 3 year old toolchain or rewriting their code from scratch.</td> </tr></table><span class="postbody">I think most people are able to weigh advise against the source they are receiving it from and make a decision based on what their goals are. while having the arm7 constantly polling a memory location is going to slow things down it is a fairly well understood option. also, this is homebrew, people want to write code now, not when the next version provides a better solution. and if someone were to suggest FIFO as the solution this would also not be compatible with the next libnds release.
<br/>
<br/>
so, while you are writing well thought out interfaces that will be used by many people, most people are writing code that will probably never see the light of day - just because it is fun.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161279 - silent_code - Thu Jul 31, 2008 8:47 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>elhobbs wrote:</b></span></td> </tr> <tr> <td class="quote">I think most people are able to weigh advise against the source they are receiving it from and make a decision based on what their goals are.</td> </tr></table><span class="postbody">
<br/>
Then, most people don't know what they are talking about most of the time... just take a look at any forum and all the trolls.
<br/>
<br/>
And there are a lot of beginners, that just can't weight anything against anything due to lack of experience. And I'm going on a limb and say, there are a magnitude of more beginners than ... let's say "experienced" people, even on this forum.
<br/>
<br/>
So, most people? Not!
<br/>
Most people that actually know that they are doing? Damn, I hope it's "Yes"!<br/>_________________<br/><span style="font-size: 9px; line-height: normal"><span style="text-decoration: underline"><span style="font-weight: bold"></span></span> July 5th 08: "<span style="font-weight: bold">Volumetric Shadow Demo</span>" 1.6.0 (final) source released
<br/>
June 5th 08: "<span style="font-weight: bold">Zombie NDS</span>" WIP released!
<br/>
It's all on my page, just click <span style="font-weight: bold">WWW</span> below.</span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161354 - tepples - Fri Aug 01, 2008 9:57 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>elhobbs wrote:</b></span></td> </tr> <tr> <td class="quote">I think most people are able to weigh advise against the source they are receiving it from and make a decision based on what their goals are. while having the arm7 constantly polling a memory location is going to slow things down it is a fairly well understood option.</td> </tr></table><span class="postbody">
<br/>
Especially if you arbitrate between the ARM7 and the ARM9 based on some piece of state that your game is already using. For example, in one scheme, the ARM7 has exclusive use of some part of an IPC struct when 192 &lt;= VCOUNT &lt;= 199, and the ARM9 has exclusive use at other times. This is more than enough time for simple code in a vblank ISR to finish transferring information. The NES worked the same way: the CPU had exclusive use of VRAM when 241 &lt;= VCOUNT &lt;= 260, and the PPU at other times.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161372 - DiscoStew - Sat Aug 02, 2008 8:39 am</h4>
    <div class="postbody"><span class="postbody">I decided to try a different approach to getting what I want done. It's not the best method (probably not even close), but I'm not needing a whole lot of control right now, just simply playing streamed and pre-loaded audio samples. I pretty much took the SimpleSound example to play the audio, but added the ARM7 template and altered both binaries a little so I could get some more functionality, such as adding the IMA-ADPCM format. Haven't got to the streamed portion yet, but I will soon enough.
<br/>
<br/>
Not making any drastic changes, as I want to have room for using the new method that is to be released in the new libnds. thx for all the advice.<br/>_________________<br/><span style="font-weight: bold">DS</span> - It's all about <span style="font-weight: bold">D</span>isco<span style="font-weight: bold">S</span>tew</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
