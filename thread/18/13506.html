<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>libfat: Loading a *.bin graphic - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > libfat: Loading a *.bin graphic</h2>
<div id="posts">
<div class="post">
    <h4>#132197 - Rajveer - Sun Jun 24, 2007 3:37 pm</h4>
    <div class="postbody"><span class="postbody">Hi guys. I'm currently rewriting a game of mine to use libfat, and I'm trying to load my original *.bin graphic files. What I'm doing so far:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">   FILE *file_Pointer;
<br/>
<br/>
//Create Texture Space
<br/>
   int main_Menu_Texture[1];
<br/>
   int main_Menu_Texture_Palette[1];
<br/>
<br/>
//Load Textures
<br/>
//Open first texture file, check if exists
<br/>
   if(( file_Pointer = fopen("/Futuracer/Menus/Main Menu/Graphics/Graphic1.bin", "rb") ) == NULL)
<br/>
   {printf("ERROR: Loading Graphic1.bin\n");}
<br/>
   else{printf("Reading Graphic1.bin\n");}
<br/>
   
<br/>
//Load file into texture space
<br/>
   glGenTextures(1, &amp;main_Menu_Texture[0]);
<br/>
   glBindTexture(0, main_Menu_Texture[0]);
<br/>
   glTexImage2D(0, 0, GL_RGB256, TEXTURE_SIZE_128 , TEXTURE_SIZE_128, 0, TEXGEN_TEXCOORD, (u8*)file_Pointer);
<br/>
   glBindTexture(0, 0);
<br/>
   
<br/>
//Close filestream
<br/>
   fclose(file_Pointer);
<br/>
   
<br/>
//Open first texture file palette, check if exists
<br/>
   if(( file_Pointer = fopen("/Futuracer/Menus/Main Menu/Graphics/Graphic1_pal.bin", "rb") ) == NULL)
<br/>
   {printf("ERROR: Loading Graphic1_pal.bin\n");}
<br/>
   else{printf("Reading Graphic1_pal.bin\n");}
<br/>
   
<br/>
//Load palette file into palette space
<br/>
   main_Menu_Texture_Palette[0] = gluTexLoadPal((u16*)file_Pointer, 32, GL_RGB32_A3 );
<br/>
   
<br/>
//Close filestream
<br/>
   fclose(file_Pointer);</td> </tr></table><span class="postbody">
<br/>
<br/>
This results in the quad not being textured. I'm not sure if I'm making proper use of glTexImage2D's last argument (pointer to the graphic), and this is the first time I've ever used any file I/O so can anybody show me where I'm going wrong?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#132198 - chishm - Sun Jun 24, 2007 3:41 pm</h4>
    <div class="postbody"><span class="postbody">You have to read a file into memory. Use fread to load it into malloc'd RAM, then you can copy that to VRAM. Don't try to fread into VRAM directly, as it may use byte writes, which VRAM won't handle correctly.<br/>_________________<br/><a class="postlink" href="http://chishm.drunkencoders.com" target="_blank">http://chishm.drunkencoders.com</a>
<br/>
<a class="postlink" href="http://dldi.drunkencoders.com" target="_blank">http://dldi.drunkencoders.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#132201 - Rajveer - Sun Jun 24, 2007 4:59 pm</h4>
    <div class="postbody"><span class="postbody">Cheers for the reply chishm. I've changed my code, it now checks the file length, mallocs the size of the file and reads the file into RAM. I'm guessing now is the time to use glTexImage2D and use the pointer to  the RAM location as the texture pointer, to put the texture into VRAM?
<br/>
<br/>
My code so far which doesn't work ;) (JUST for the texture not the palette, as its essentially the same thing):
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">FILE *file_Pointer; //Pointer to an opened file
<br/>
long file_Length; //Variable to store length of opened file
<br/>
int main_Menu_Texture[1]; //Create Texture Space
<br/>
<br/>
//Load Textures:
<br/>
//FIRST TEXTURE/////////////////////////////////
<br/>
//Open first texture file, check if exists
<br/>
   if(( file_Pointer = fopen("/Futuracer/Menus/Main Menu/Graphics/Graphic1.bin", "rb") ) == NULL)
<br/>
   {printf("ERROR: Loading Graphic1.bin\n");}
<br/>
   else{printf("Reading Graphic1.bin\n");}
<br/>
   
<br/>
//Find length of file
<br/>
   fseek(file_Pointer, 0L, SEEK_END);
<br/>
   file_Length = ftell(file_Pointer);
<br/>
   rewind(file_Pointer);
<br/>
   iprintf("Length of Graphic1.bin = %d\n", file_Length);
<br/>
   
<br/>
//Create space for texture storage in RAM, read into RAM and close filestream
<br/>
   char *texture_In_RAM = malloc(file_Length + 1);
<br/>
   fread(texture_In_RAM, file_Length, 1, file_Pointer);
<br/>
   fclose(file_Pointer);
<br/>
         
<br/>
//Load file into texture space
<br/>
   glGenTextures(1, &amp;main_Menu_Texture[0]);
<br/>
   glBindTexture(0, main_Menu_Texture[0]);
<br/>
   glTexImage2D(0, 0, GL_RGB256, TEXTURE_SIZE_128 , TEXTURE_SIZE_128, 0, TEXGEN_TEXCOORD, (u8*)texture_In_RAM);
<br/>
   glBindTexture(0, 0);
<br/>
<br/>
//FIRST TEXTURE PALETTE/////////////////////////
<br/>
<br/>
//Open first texture file palette, check if exists
<br/>
   if(( file_Pointer = fopen("/Futuracer/Menus/Main Menu/Graphics/Graphic1_pal.bin", "rb") ) == NULL)
<br/>
   {printf("ERROR: Loading Graphic1_pal.bin\n");}
<br/>
   else{printf("Reading Graphic1_pal.bin\n");}
<br/>
   
<br/>
   //Find length of file
<br/>
   fseek(file_Pointer, 0L, SEEK_END);
<br/>
   file_Length = ftell(file_Pointer);
<br/>
   rewind(file_Pointer);
<br/>
   iprintf("Length of Graphic1_pal.bin = %d\n", file_Length);
<br/>
   
<br/>
   //Create space for texture storage in RAM, read into RAM and close filestream
<br/>
   char *texture_In_RAM2 = malloc(file_Length + 1);
<br/>
   fread(texture_In_RAM2, file_Length, 1, file_Pointer);
<br/>
   fclose(file_Pointer);
<br/>
      
<br/>
   //Load palette file into palette space
<br/>
   main_Menu_Texture_Palette[0] = gluTexLoadPal((u16*)texture_In_RAM2, 32, GL_RGB32_A3 );
<br/>
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Or am I supposed to use some sort of memcpy function to copy it into VRAM? If so, how would I bind the texture to my variable main_Menu_Texture[0]?</span><span class="gensmall"><br/><br/>Last edited by Rajveer on Sun Jun 24, 2007 11:16 pm; edited 2 times in total</span></div>    
</div>
<div class="post">
    <h4>#132228 - simonjhall - Sun Jun 24, 2007 9:10 pm</h4>
    <div class="postbody"><span class="postbody">Which part doesn't work? Does it load into memory correctly? If you're not sure you can stick your screen in framebuffer mode and splat the texture directly onto the screen (and do a per-pixel colour lookup) just to check you've got your texture in memory correctly.
<br/>
I could suggest loads more things to do, but yeah...what isn't working? :-)<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#132239 - Rajveer - Sun Jun 24, 2007 11:15 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>simonjhall wrote:</b></span></td> </tr> <tr> <td class="quote">Which part doesn't work?</td> </tr></table><span class="postbody">
<br/>
<br/>
No idea :-) It "calculates" the total length of the file correctly with fseek and ftell so if it can do that I'm assuming that it can read it properly with fread. I'm also assuming that it loads into memory properly as the application is a few hundred lines long and doesn't run out of RAM (no other graphics or anything). So I think it's not loading the texture properly. Maybe it's the type that I'm using for texture_In_RAM (the pointer to the loaded texture in RAM), I don't know. The quad appears completely untextured, I've edited my previous post to include the code for the palette but I'm stumped! Any suggestions?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#132346 - Rajveer - Tue Jun 26, 2007 3:15 am</h4>
    <div class="postbody"><span class="postbody">Anybody got any suggestions on what I should try now? :-)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#132432 - dannyboy - Tue Jun 26, 2007 5:44 pm</h4>
    <div class="postbody"><span class="postbody">I think if you pass in the address of the texture in ram it may work. Something like:
<br/>
<br/>
glTexImage2D(0, 0, GL_RGB256, TEXTURE_SIZE_128 , TEXTURE_SIZE_128, 0, TEXGEN_TEXCOORD, &amp;texture_In_RAM);
<br/>
<br/>
or maybe
<br/>
<br/>
glTexImage2D(0, 0, GL_RGB256, TEXTURE_SIZE_128 , TEXTURE_SIZE_128, 0, TEXGEN_TEXCOORD, &amp;texture_In_RAM[0]);
<br/>
<br/>
You shouldn't need to cast it since char* is equivalent to u8* or uint8*</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#132459 - Rajveer - Tue Jun 26, 2007 10:38 pm</h4>
    <div class="postbody"><span class="postbody">Hahaa! It wasn't the code! I tried your method dannyboy but still the same results, so I tried compiling one of my older copies of my project which worked fine and all the textures are white with the latest libnds. So what did I change to make it compatible with the latest videoGL:
<br/>
<br/>
I deleted glReset and now call glInit once at the beginning of the application.
<br/>
<br/>
I changed glIdentity to glLoadIdentity.
<br/>
<br/>
I've looked in videoGL but can't find anything, has texture handling changed or something? Shall I post the WHOLE of my code (initialising OpenGL, all OpenGL calls e.t.c.)?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#132462 - simonjhall - Tue Jun 26, 2007 11:04 pm</h4>
    <div class="postbody"><span class="postbody">Yeah that'd probably be handy. A brief description of what you expect it to do and what it actually does would be good. Plus if you could slim it down to the bare minimum (eg initting the system, loading a texture, splatting it on a quad and drawing it on the screen) that'd be nice too!
<br/>
I'm sure we'll be able to spot any problem pretty quick :-)<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#132464 - Rajveer - Tue Jun 26, 2007 11:17 pm</h4>
    <div class="postbody"><span class="postbody">At the moment I'd say it's already at bare minimum ;) The aim is to simply load a texture with libfat and draw it onto a quad.
<br/>
<br/>
[code]FIXEDcode]
<br/>
<br/>
EDIT: Fixed the problem, it was the way I was converting the texture not the code. Cheers!</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
