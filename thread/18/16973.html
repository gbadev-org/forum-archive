<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Expanding my event system from 32 to 64 bits - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > Expanding my event system from 32 to 64 bits</h2>
<div id="posts">
<div class="post">
    <h4>#171397 - headspin - Wed Nov 18, 2009 11:14 am</h4>
    <div class="postbody"><span class="postbody">In my game I have a basic event system that turns bits on to trigger certain events. I use an enum to specify which event is which bit.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">enum EventFlag
<br/>
{
<br/>
   EVENTFLAG_NONE = 0,
<br/>
   EVENTFLAG_EVENT1 = BIT(0),
<br/>
   EVENTFLAG_EVENT2 = BIT(1),
<br/>
   ...
<br/>
   EVENTFLAG_EVENT30 = BIT(29),
<br/>
   EVENTFLAG_EVENT31 = BIT(30),
<br/>
   EVENTFLAG_EVENT32 = BIT(31)
<br/>
};</td> </tr></table><span class="postbody">
<br/>
<br/>
And I have a global 32 bit uint to store all these flags
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">uint m_eventFlags;</td> </tr></table><span class="postbody">
<br/>
<br/>
And to check if a certain event has occured I do
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">if ((eventFlags &amp; m_eventFlags) == eventFlags)</td> </tr></table><span class="postbody">
<br/>
<br/>
Which just checks if the bits that are set match those needed to trigger the event.
<br/>
<br/>
Now I've realised I need to expand this beyond the 32 bits and it's too late for me to come up with a different method of doing things. What is the easiest way to expand this to be 64 bits? I tried using a uint64 instead and get an error in the enum
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">warning: left shift count &gt;= width of type</td> </tr></table><span class="postbody">
<br/>
<br/>
Then I tried changing the enum to uint64
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">enum EventFlag : uint64</td> </tr></table><span class="postbody">
<br/>
<br/>
Then I get the error
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">warning: scoped enums only available with -std=c++0x or -std=gnu++0x</td> </tr></table><span class="postbody">
<br/>
<br/>
So then I added -std=c++0x to the compiler options and then get
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">error: enumerator value -0x00000000080000000 is too large for underlying type 'uint64'</td> </tr></table><span class="postbody">
<br/>
<br/>
And still get the "left shift count &gt;= width of type" error. Will I need to split the flags into two 32-bit integers or perhaps a union? Any ideas on how to expand this without re-writing large chunks of the event system?<br/>_________________<br/><a class="postlink" href="http://headsoft.com.au/index.php?category=warhawk" target="_blank">Warhawk DS</a> | <a class="postlink" href="http://headsoft.com.au/index.php?category=mmll" target="_blank">Manic Miner: The Lost Levels</a> | <a class="postlink" href="http://headsoft.com.au/index.php?category=tdg" target="_blank">The Detective Game</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#171400 - sverx - Wed Nov 18, 2009 12:50 pm</h4>
    <div class="postbody"><span class="postbody">mmm... replacing enums with defines?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#171404 - Cearn - Wed Nov 18, 2009 1:09 pm</h4>
    <div class="postbody"><span class="postbody">0x00000000080000000 is 0x0_0000_0000_8000_0000. You may have one too many zeroes. 
<br/>
<br/>
IIRC, you can also use the 'LL' extension for long long constants. I'm not sure what happens to the numbers if you don't.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#171405 - headspin - Wed Nov 18, 2009 1:34 pm</h4>
    <div class="postbody"><span class="postbody">I checked and definately not putting in too many zeros. A guy suggested I try doing:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">const static unit64 EVENTFLAG_NONE = 0;
<br/>
const static unit64 EVENT_1 = BIT(1);</td> </tr></table><span class="postbody">
<br/>
<br/>
But I still get "warning: left shift count &gt;= width of type" for everything above BIT(31). This seems really strange to me.<br/>_________________<br/><a class="postlink" href="http://headsoft.com.au/index.php?category=warhawk" target="_blank">Warhawk DS</a> | <a class="postlink" href="http://headsoft.com.au/index.php?category=mmll" target="_blank">Manic Miner: The Lost Levels</a> | <a class="postlink" href="http://headsoft.com.au/index.php?category=tdg" target="_blank">The Detective Game</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#171408 - headspin - Wed Nov 18, 2009 2:10 pm</h4>
    <div class="postbody"><span class="postbody">Okay it's fixed with this modified macro
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#define BIT64(n) (1LL &lt;&lt; (n))</td> </tr></table><span class="postbody"><br/>_________________<br/><a class="postlink" href="http://headsoft.com.au/index.php?category=warhawk" target="_blank">Warhawk DS</a> | <a class="postlink" href="http://headsoft.com.au/index.php?category=mmll" target="_blank">Manic Miner: The Lost Levels</a> | <a class="postlink" href="http://headsoft.com.au/index.php?category=tdg" target="_blank">The Detective Game</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#171414 - ant512 - Wed Nov 18, 2009 4:27 pm</h4>
    <div class="postbody"><span class="postbody">How about using a struct instead?
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
typedef struct {
<br/>
    int event1 : 1;
<br/>
    int event2 : 1;
<br/>
    int event3 : 1;
<br/>
    ...
<br/>
    int event64 : 1;
<br/>
} EventArgs;
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
To set an event:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
EventArgs e;
<br/>
e.event1 = 1;
<br/>
e.event3 = 1;
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
To check an event:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
if (e.event1 &amp; e.event3) {
<br/>
    // Some event has occurred involving 1 and 3
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
The struct is packed so that each component consumes just one bit.  It should therefore get passed around as a 64-bit data structure.  It's also far easier to work with - and more extensible - than a bitmask.
<br/>
<br/>
EDIT:  Ah, didn't see that it's too late to change the approach.  Still, one for next time maybe.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#171448 - headspin - Thu Nov 19, 2009 8:40 pm</h4>
    <div class="postbody"><span class="postbody">I will definately try something like that in the future ant512 at the time I didn't think there would be more than 32 events.<br/>_________________<br/><a class="postlink" href="http://headsoft.com.au/index.php?category=warhawk" target="_blank">Warhawk DS</a> | <a class="postlink" href="http://headsoft.com.au/index.php?category=mmll" target="_blank">Manic Miner: The Lost Levels</a> | <a class="postlink" href="http://headsoft.com.au/index.php?category=tdg" target="_blank">The Detective Game</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#171697 - Lick - Mon Dec 14, 2009 10:56 pm</h4>
    <div class="postbody"><span class="postbody">I'm curious, ant512, what happens if you do e.event1 = 1234; What will the compiler do? 
<br/>
<br/>
(I don't have the tools installed to try myself).
<br/>
<br/>
<span style="font-weight: bold">update:</span> I tried this at codepad:</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">struct Events {
<br/>
  int e1 : 1;
<br/>
  int e2 : 1;
<br/>
};
<br/>
<br/>
int main () {
<br/>
  Events ev;
<br/>
<br/>
  ev.e1 = 3;
<br/>
<br/>
  printf("%i, %i", ev.e1, ev.e2);
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
It prints 1, 0. Seems like only the bits allocated for ev1 are written to. It doesn't overwrite ev2.<br/>_________________<br/><a class="postlink" href="http://licklick.wordpress.com" target="_blank">http://licklick.wordpress.com</a></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
