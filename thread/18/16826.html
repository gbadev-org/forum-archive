<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Help:IPC error - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > Help:IPC error</h2>
<div id="posts">
<div class="post">
    <h4>#169972 - littlestone - Thu Aug 20, 2009 8:55 am</h4>
    <div class="postbody"><span class="postbody">I write a little program,a command is sent from arm9 to arm7.It seems than the arm7 processor cann't receive the command.My program is as below:
<br/>
ARM9 Side:
<br/>
main(void)
<br/>
{
<br/>
<br/>
   REG_IPC_FIFO_CR = IPC_FIFO_ENABLE |IPC_FIFO_SEND_CLEAR; 
<br/>
   while(true){
<br/>
        if(KEY_A){
<br/>
                if(REG_IPC_FIFO_CR &amp; 1){
<br/>
                   //if Send Fifo Empty ,send this command
<br/>
                    IPCFIFOSEND=command;
<br/>
                    prinf("send command success\n"):
<br/>
                }else{
<br/>
                   prinf("send fifo not empty\n"):
<br/>
                    printf("REG_IPC_FIFO_CR :0x%x\n",REG_IPC_FIFO_CR );
<br/>
                    REG_IPC_FIFO_CR|=8;
<br/>
                    printf("REG_IPC_FIFO_CR :0x%x\n",REG_IPC_FIFO_CR );
<br/>
                }
<br/>
        }
<br/>
   }
<br/>
}
<br/>
<br/>
ARM7 Side:
<br/>
<br/>
main(void)
<br/>
{
<br/>
    REG_IPC_FIFO_CR = IPC_FIFO_ENABLE |IPC_FIFO_SEND_CLEAR; 
<br/>
    while(true){
<br/>
            if(!(REG_IPC_FIFO_CR &amp; 0x100)){
<br/>
            //if Receive Fifo Empty ,get the command
<br/>
                 u32 msg=IPCFIFORECV; 
<br/>
           }
<br/>
<br/>
    }
<br/>
}
<br/>
<br/>
run this program on nds and press keya continuely,it always prinf as below:
<br/>
press keya for the first time:
<br/>
printf:
<br/>
send command success
<br/>
press keya for the second time:
<br/>
prinf:
<br/>
send fifo not empty
<br/>
REG_IPC_FIFO_CR :0x8100
<br/>
REG_IPC_FIFO_CR :0x8101
<br/>
<br/>
press keya for the third time:
<br/>
printf:
<br/>
send command success
<br/>
<br/>
press keya for the fourth time:
<br/>
prinf:
<br/>
send fifo not empty
<br/>
REG_IPC_FIFO_CR :0x8100
<br/>
REG_IPC_FIFO_CR :0x8101
<br/>
<br/>
It seems that arm7 processor can't receive the command?Anybody meets this problem before?What's this reason?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#169973 - Echo49 - Thu Aug 20, 2009 9:28 am</h4>
    <div class="postbody"><span class="postbody">Have you tried the <a class="postlink" href="http://libnds.devkitpro.org/a00076.html" target="_blank">wrapper functions</a> for FIFO?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#169974 - littlestone - Thu Aug 20, 2009 9:37 am</h4>
    <div class="postbody"><span class="postbody">hi,echo49.
<br/>
I just cann't understand why arm7 cann't receive the command from arm9?Is it possible the arm7 breakdown while the arm9 processor is till running?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#169979 - elhobbs - Thu Aug 20, 2009 1:40 pm</h4>
    <div class="postbody"><span class="postbody">as echo49 pointed out - you need to use the fifo functions provided by libnds. or you need to completely disable the libnds fifo code and use your own - which will take more code than what you provided. keep in mind the libnds fifo code is used by sound, wifi, touch, and X/Y keys to name a few. so ditching it is not trivial.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#169982 - littlestone - Thu Aug 20, 2009 3:36 pm</h4>
    <div class="postbody"><span class="postbody"><a href="http://www.double.co.nz/nintendo_ds/nds_develop7.html" target="_blank">http://www.double.co.nz/nintendo_ds/nds_develop7.html</a>
<br/>
I just want to write a sound program. And I learn from this tutorial given above.I found this sample cann't run on my nds. In the end,I found the reason is arm7 processor cann't receive the command from the arm9 processor. Is it possible some arm9 registers are not set correctly?Therefore, the arm7 processor cann't access IPC register.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#169983 - MH6 - Thu Aug 20, 2009 3:44 pm</h4>
    <div class="postbody"><span class="postbody">Have you tried using MaxMod? It handles sound for you, and is insanely easy to use.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#169984 - elhobbs - Thu Aug 20, 2009 3:58 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>littlestone wrote:</b></span></td> </tr> <tr> <td class="quote">http://www.double.co.nz/nintendo_ds/nds_develop7.html
<br/>
I just want to write a sound program. And I learn from this tutorial given above.I found this sample cann't run on my nds. In the end,I found the reason is arm7 processor cann't receive the command from the arm9 processor. Is it possible some arm9 registers are not set correctly?Therefore, the arm7 processor cann't access IPC register.</td> </tr></table><span class="postbody">yes, you are correct. The registers are not set correctly for what you are trying to do. However, they are set 100% correctly to use the libnds fifo system. any reason you are ignoring suggestions to use the libnds fifo system?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#169985 - vuurrobin - Thu Aug 20, 2009 4:04 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>littlestone wrote:</b></span></td> </tr> <tr> <td class="quote">http://www.double.co.nz/nintendo_ds/nds_develop7.html
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I click the link, and the first thing I see is:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">This tutorial was tested and works with libnds dated 2005-10-18. Unfortunately it no longer works with libnds dated 2005-12-12. I'm looking into it.</td> </tr></table><span class="postbody">
<br/>
<br/>
it also is part of the 'Old Tutorials', according to the top table. seems to me that that tutorial is very outdated. 
<br/>
<br/>
I also believe that the ipc is depricated.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#169986 - littlestone - Thu Aug 20, 2009 4:13 pm</h4>
    <div class="postbody"><span class="postbody">elhobbs and vuurrobin, thanks a lot.
<br/>
This sample works well on no$gba.But it cann't work on my nds.I cann't find the reason.As we all know, when this program runs on no$gba,all arm7 and arm9 processor registers are in reset state before this program runs.But when I run this program on nds, the arm registers have been set by the loader . Is it possible, other registers can affect IPC bewteen arm7 and arm9? Besides, I have tested libnds and met the same question.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#169987 - elhobbs - Thu Aug 20, 2009 5:49 pm</h4>
    <div class="postbody"><span class="postbody">littlestone - you are just kidding at this point, right?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#169994 - littlestone - Fri Aug 21, 2009 1:05 am</h4>
    <div class="postbody"><span class="postbody">elhobbs,I'm not kidding.In fact,I'm puzzled at this question now.I have made a search in the forum and I found somebody else met the same question as me.Unfortunately, nobody gave a good explanation.I believe some registers(not IPC registers) can affect the IPC between arm7 and arm9.Till now,I do not find this register.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#169996 - vuurrobin - Fri Aug 21, 2009 2:03 am</h4>
    <div class="postbody"><span class="postbody">I doubt the problem lies with some register. 
<br/>
<br/>
littlestone, why do you want to use the IPC.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#169997 - elhobbs - Fri Aug 21, 2009 2:12 am</h4>
    <div class="postbody"><span class="postbody">libnds initializes the fifo system prior to your main function ever being called. since libnds has already setup the fifo it is no longer configured to work the way you are trying to use it. writing to the fifo registers probably just messes it up. however, it does not mean you cannot use fifo. you just need to use the api that libnds provides.
<br/>
<br/>
did you look at the link that echo49 provided? you should as this will provide the answers you are looking for.
<br/>
<br/>
in particular you could use fifoSetValue32Handler which establishes a callback handler to receive data. once that has been set then you can use fifoSendDatamsg to send data. so you would want to set the callback on the destination processor then send from the source processor.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170000 - littlestone - Fri Aug 21, 2009 6:47 am</h4>
    <div class="postbody"><span class="postbody">I found the arm7 processor crashed.It's not the IPC question.Thanks for all.It may be difficult for me to solve this problem.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170001 - littlestone - Fri Aug 21, 2009 6:49 am</h4>
    <div class="postbody"><span class="postbody">Who can give some suggestion?My program runs well on no$gba.When running on nds,the arm7 crashed.It's the responsibility of the loader?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170002 - Echo49 - Fri Aug 21, 2009 7:42 am</h4>
    <div class="postbody"><span class="postbody">What flashcart are you using?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170005 - littlestone - Fri Aug 21, 2009 11:50 am</h4>
    <div class="postbody"><span class="postbody">R4</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170006 - sverx - Fri Aug 21, 2009 11:54 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>littlestone wrote:</b></span></td> </tr> <tr> <td class="quote">Who can give some suggestion?My program runs well on no$gba.</td> </tr></table><span class="postbody">
<br/>
<br/>
It reminds me of <a class="postlink" href="http://anguna-dev.blogspot.com/2008/11/everything-seems-to-be-working.html" target="_blank">this post</a> of AngunaDS dev blog: Nathan noticed that there was some kind of "garbage" passed thru the FIFO on a real DS, there wasn't any on no$gba.
<br/>
<br/>
btw all that is pre-1.3.1 ndslib era, when there weren't functions to do that easily...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170007 - Echo49 - Fri Aug 21, 2009 12:08 pm</h4>
    <div class="postbody"><span class="postbody">I had problems with the ARM7 locking up when the flashcart is a CycloDS, but not with Supercard or R4. But this was back with r25.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170009 - gauauu - Fri Aug 21, 2009 3:10 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>sverx wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
It reminds me of <a class="postlink" href="http://anguna-dev.blogspot.com/2008/11/everything-seems-to-be-working.html" target="_blank">this post</a> of AngunaDS dev blog: Nathan noticed that there was some kind of "garbage" passed thru the FIFO on a real DS, there wasn't any on no$gba.
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Heh, I had forgotten about that.  I saw your post and thought, "ME?  I had that problem?"  Turns out I have a bad memory....
<br/>
<br/>
But yeah, I never figured out WHAT was sending messages through the FIFO....maybe the card's loader or something?  It seemed to only happen right when you first started the game.  But sanity checking to make sure the message actually fit my message format fixed the issue.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170010 - sverx - Fri Aug 21, 2009 4:29 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>gauauu wrote:</b></span></td> </tr> <tr> <td class="quote"> [...]I never figured out WHAT was sending messages through the FIFO....maybe the card's loader or something?</td> </tr></table><span class="postbody">
<br/>
<br/>
I don't know, I never experienced that with my setup... I was using a (very simple) custom FIFO scheme, in that <span style="font-style: italic">pre-1.3.1</span> era. I was passing a pointer (so it was simply a 32 bit value) from the ARM9 and I was receiving it correctly on the ARM7. ZERO meant '<span style="font-weight: bold">stop</span> playing', any other value meant '<span style="font-weight: bold">start</span> playing song stored at that address'.
<br/>
<br/>
Worked both on no$gba and on my NDS Lite + R4 with no troubles. So I also really don't know. But, ok, it's gone ;)
<br/>
<br/>
Bye! :D</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
