<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>itcm, link scripts and the heap - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > itcm, link scripts and the heap</h2>
<div id="posts">
<div class="post">
    <h4>#144353 - simonjhall - Wed Oct 31, 2007 11:08 pm</h4>
    <div class="postbody"><span class="postbody">Yo,
<br/>
<br/>
I recently moved loads of code into itcm in order to improve performance a bit and also to reduce the main memory load a bit.
<br/>
Well after doing this, I assumed that I'd be able to regain up to 32k of heap space, since the code would be resident in the itcm memory instead, but this wasn't the case. I forgot about this and now have decided to dig it up again since people seem to have problems loading a few levels due to a lack of RAM.
<br/>
<br/>
I seem to remember that in the early startup of a DS program, the memory protection unit gets set up, code gets copied into various places etc etc, and this is where code is sent to itcm allowing calls to these functions (from the main program) to work correctly. Well once they've been copied, the memory they originally occupied in main memory is no longer needed, right?
<br/>
<br/>
But poking through my elf and the link scripts says otherwise, and as a result I'm not able to win myself back that max 32k of main memory.
<br/>
The link script basically says that *main* memory looks like this:
<br/>
<br/>
- the text section
<br/>
- something else, which has the exact same size as the itcm section
<br/>
- the bss section
<br/>
- the heap.
<br/>
<br/>
Here's the sections header from my elf:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">Program Header:
<br/>
0x70000001 off    0x000779cc vaddr 0x0206f9cc paddr 0x0206f9cc align 2**2
<br/>
         filesz 0x00000110 memsz 0x00000110 flags r--
<br/>
    LOAD off    0x00008000 vaddr 0x02000000 paddr 0x02000000 align 2**15     &lt;--- this is the text section
<br/>
         filesz 0x000751d4 memsz 0x000751d4 flags rwx
<br/>
    LOAD off    0x00080000 vaddr 0x01000000 paddr 0x020751d4 align 2**15     &lt;--- this is the itcm section
<br/>
         filesz 0x00004d74 memsz 0x00004d74 flags rwx
<br/>
    LOAD off    0x00081f48 vaddr 0x02079f48 paddr 0x02079f48 align 2**15     &lt;--- this is the bss section
<br/>
         filesz 0x00000000 memsz 0x00068d5c flags rw-
<br/>
private flags = 4000002: [Version4 EABI] [has entry point]</td> </tr></table><span class="postbody">Even though I've got 16k currently in the itcm section, there's still a 16k 'gap' between the data section and the text section - and I want it back!
<br/>
How trivial is it to wiggle the linker script in order to get the DS startup code (in crt0.s?) to work whilst winning me back some memory after code has been copied into itcm?
<br/>
<br/>
Ta as ever :-)<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#144469 - simonjhall - Fri Nov 02, 2007 11:28 am</h4>
    <div class="postbody"><span class="postbody">Nobody?<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#144473 - freemaan - Fri Nov 02, 2007 1:04 pm</h4>
    <div class="postbody"><span class="postbody">I <span style="font-weight: bold">think</span> you can move "_end = . ; __end__ = . ; PROVIDE (end = _end);" above the BSS section in the linkerscript.<br/>_________________<br/>My other nickname: davido2</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#144479 - ingramb - Fri Nov 02, 2007 6:45 pm</h4>
    <div class="postbody"><span class="postbody">Something like this maybe...
<br/>
<br/>
Rearange your sections like so:
<br/>
<br/>
- the text section 
<br/>
- the bss section
<br/>
- something else, which has the exact same size as the itcm section  
<br/>
- the heap.
<br/>
<br/>
Define __end__ to come after the bss section.  I think this might work, though you may want to take a peek at the arm9 crt0.s and make sure it's not going to use the end lable before it copies the itcm stuff out of main ram.
<br/>
<br/>
I may play around with this myself when I get home...I need more memory too =)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#144524 - wintermute - Sat Nov 03, 2007 7:23 am</h4>
    <div class="postbody"><span class="postbody">If 32K is going to make a difference you have other problems really.
<br/>
<br/>
I did try fiddling this stuff around a while back but I had trouble convincing the linker to accept the bss section being overlaid on other sections.
<br/>
<br/>
I'll have another look and see what I can do though.<br/>_________________<br/><a class="postlink" href="http://www.devkitpro.org/" target="_blank">devkitPro - professional toolchains at amateur prices</a>
<br/>
<a class="postlink" href="http://wiki.devkitpro.org/index.php/IRC" target="_blank">devkitPro IRC support</a>
<br/>
<a class="postlink" href="http://davejmurphy.com/" target="_blank">Personal Blog</a></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
