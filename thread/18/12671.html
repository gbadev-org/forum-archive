<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>libfat and swapping between microSD adapters and Game Cards? - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>DS development > libfat and swapping between microSD adapters and Game Cards?</h2>
<div id="posts">
<div class="post">
    <h4>#121256 - tepples - Sat Mar 10, 2007 8:45 pm</h4>
    <div class="postbody"><span class="postbody">I'm planning to make a trainer for a DS game. First off: it does <span style="font-style: italic">not</span> involve ROM dumping, but it does involve save dumping from an <span style="font-style: italic">authentic</span> DS Game Card. The intended use case is the following:
<br/>
<ol type="1"><li>Load program and datafiles from microSD card in SLOT-1 </li><li>Player ejects microSD adapter from SLOT-1 </li><li>Player inserts Game Card </li><li>Program reads 256 KiB serial flash </li><li>Player ejects Game Card </li><li>Player reinserts microSD adapter in SLOT-1 </li><li>Portions of savegame data are written to microSD card </li></ol>
<br/>
What's the cleanest way to use libfat to cleanly shut down the card and bring it back up? Here's what I'm thinking about so far:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">// Untested, possibly pseudocode
<br/>
<br/>
unsigned char savegameData[256*1024];
<br/>
<br/>
void checkForDSDump() {
<br/>
  fatUnmount(PI_DEFAULT);
<br/>
  alert2Opts("Please remove the flash card and insert your "
<br/>
             "Game Card.",
<br/>
             "OK", "Cancel");
<br/>
  dumpFlashUsingCardme(savegameData);
<br/>
  alert2Opts("Please remove the Game Card and insert your "
<br/>
             "flash card.",
<br/>
             "OK", "Cancel");
<br/>
  fatRemount(PI_DEFAULT);
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
But fatRemount() does not exist in .../libnds/include/fat.h, and
<br/>
fatMountNormalInterface() does not take PI_DEFAULT.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#121263 - Lick - Sat Mar 10, 2007 9:28 pm</h4>
    <div class="postbody"><span class="postbody"><span style="font-weight: bold">fatInitDefault()</span>?<br/>_________________<br/><a class="postlink" href="http://licklick.wordpress.com" target="_blank">http://licklick.wordpress.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#121264 - tepples - Sat Mar 10, 2007 9:30 pm</h4>
    <div class="postbody"><span class="postbody">But doesn't calling fatInitDefault() again leak the cache memory? Or does fatUnmount() free it?<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#121271 - Ryan FB - Sat Mar 10, 2007 11:58 pm</h4>
    <div class="postbody"><span class="postbody">This won't work easily on the two Slot-1 flashcarts/adapters I've tried it on. The DS-X causes my DS to reset when it's inserted back in, and the R4 depends on the DS BIOS startup procedure to init it correctly (meaning you'll have to find a way to emulate this before you can init FAT on it after reinserting it with your program running).</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#121277 - chishm - Sun Mar 11, 2007 1:21 am</h4>
    <div class="postbody"><span class="postbody">Your code is almost correct, but since you only want/need to unmount and remount the Slot-1 interface, use PI_SLOT_1.<br/>_________________<br/><a class="postlink" href="http://chishm.drunkencoders.com" target="_blank">http://chishm.drunkencoders.com</a>
<br/>
<a class="postlink" href="http://dldi.drunkencoders.com" target="_blank">http://dldi.drunkencoders.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#121280 - tepples - Sun Mar 11, 2007 2:04 am</h4>
    <div class="postbody"><span class="postbody">Is there a way for the code to tell which slot is the default? Or should code just probe SLOT-1 and SLOT-2? Is there full documentation for libfat that addresses these issues?<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#121284 - chishm - Sun Mar 11, 2007 4:05 am</h4>
    <div class="postbody"><span class="postbody">Slot-1 is the prefered default. If no card is inserted in Slot-1, then Slot-2 is set as the default. There isn't a function to tell which is set as the default, but if fat1:/. can't be opened for diretory listing while fat2:/. can, then it is safe to assume that Slot-2 is the default.<br/>_________________<br/><a class="postlink" href="http://chishm.drunkencoders.com" target="_blank">http://chishm.drunkencoders.com</a>
<br/>
<a class="postlink" href="http://dldi.drunkencoders.com" target="_blank">http://dldi.drunkencoders.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#121288 - tepples - Sun Mar 11, 2007 7:29 am</h4>
    <div class="postbody"><span class="postbody">When remounting with fatMountNormalInterface(PI_SLOT_1, cacheSize), which cacheSize should I use? Or (per Ryan FB's concern) should I just expect SLOT-1 users not to be able to swap cards?<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#121308 - chishm - Sun Mar 11, 2007 12:39 pm</h4>
    <div class="postbody"><span class="postbody">Default cache size is 8 for the DS. You may indeed run into trouble when trying to re-init the slot-1 cards, though. The only solution would be initializing the card as the BIOS does it, but there's no public code to do that.<br/>_________________<br/><a class="postlink" href="http://chishm.drunkencoders.com" target="_blank">http://chishm.drunkencoders.com</a>
<br/>
<a class="postlink" href="http://dldi.drunkencoders.com" target="_blank">http://dldi.drunkencoders.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#121310 - Lick - Sun Mar 11, 2007 12:58 pm</h4>
    <div class="postbody"><span class="postbody">Slot-1 cards will give you a header and the startup binaries form both ARM7 and ARM9. Once you have received them, the device put itself in a different state (referred to as 'second state'). We have no idea how to put them back in the original state through software commands, the only method known is to re-insert the card.
<br/>
<br/>
The problem with homebrew Slot-1 devices is that you don't know what the ARM7 startup binary does. The ARM9 probably puts itself in a PassMe loop, but the ARM7 might execute some fatal card commands to put the device into a third state, one that has access to the media-storage. (Ryan FB kind of confirmed this for R4?)
<br/>
<br/>
<span style="font-weight: bold">Perhaps there is no third state</span>, in that case, you only need to read out the header and startup binaries so the card put itself into the second state. After that, you may hope that libfat initializes.
<br/>
<br/>
To my knowledge this is exactly what the DS BIOS does:
<br/>
1) Read header from card.
<br/>
2) Store parts of header in 0x27FFE00 (Main RAM).
<br/>
3) Read binaries from card. Decrypt, decompress and execute.<br/>_________________<br/><a class="postlink" href="http://licklick.wordpress.com" target="_blank">http://licklick.wordpress.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#121316 - chishm - Sun Mar 11, 2007 2:29 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Lick wrote:</b></span></td> </tr> <tr> <td class="quote">To my knowledge this is exactly what the DS BIOS does:
<br/>
1) Read header from card.
<br/>
2) Store parts of header in 0x27FFE00 (Main RAM).
<br/>
3) Read binaries from card. Decrypt, decompress and execute.</td> </tr></table><span class="postbody">
<br/>
Yeah, I know that bit already, it's used by Nitro Hax :-p
<br/>
It adds around 8 extra KiB to get all that, though, and I'm not sure it's worth it.<br/>_________________<br/><a class="postlink" href="http://chishm.drunkencoders.com" target="_blank">http://chishm.drunkencoders.com</a>
<br/>
<a class="postlink" href="http://dldi.drunkencoders.com" target="_blank">http://dldi.drunkencoders.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#121387 - HyperHacker - Mon Mar 12, 2007 3:18 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Lick wrote:</b></span></td> </tr> <tr> <td class="quote">The problem with homebrew Slot-1 devices is that you don't know what the ARM7 startup binary does.</td> </tr></table><span class="postbody">
<br/>
Why not? Can you not dump it and find out?<br/>_________________<br/>I'm a PSP hacker now, but I still &lt;3 DS.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#121448 - Lick - Mon Mar 12, 2007 3:00 pm</h4>
    <div class="postbody"><span class="postbody">There is exactly one guy who will spend many days and eventually do that,  the person is probably..
<br/>
<br/>
<br/>
<br/>
You.<br/>_________________<br/><a class="postlink" href="http://licklick.wordpress.com" target="_blank">http://licklick.wordpress.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#121489 - tepples - Mon Mar 12, 2007 7:03 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>chishm wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Lick wrote:</b></span></td> </tr> <tr> <td class="quote">To my knowledge this is exactly what the DS BIOS does:
<br/>
1) Read header from card.
<br/>
2) Store parts of header in 0x27FFE00 (Main RAM).
<br/>
3) Read binaries from card. Decrypt, decompress and execute.</td> </tr></table><span class="postbody">
<br/>
Yeah, I know that bit already, it's used by Nitro Hax :-p
<br/>
It adds around 8 extra KiB to get all that, though, and I'm not sure it's worth it.</span></td> </tr></table><span class="postbody">
<br/>
How much space is available in the R4DS DLDI driver? Can't a DLDI be up to 32 KiB, with most drivers not using even half of that?<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#121504 - Lick - Mon Mar 12, 2007 7:25 pm</h4>
    <div class="postbody"><span class="postbody">It's rather a standard procedure for all Slot-1 devices, shouldn't it therefore be in libfat? (Or not, considering what you can do with the code.)<br/>_________________<br/><a class="postlink" href="http://licklick.wordpress.com" target="_blank">http://licklick.wordpress.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#121519 - HyperHacker - Mon Mar 12, 2007 10:03 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Lick wrote:</b></span></td> </tr> <tr> <td class="quote">There is exactly one guy who will spend many days and eventually do that,  the person is probably..
<br/>
<br/>
<br/>
<br/>
You.</td> </tr></table><span class="postbody">
<br/>
I don't have a slot-1 device.<br/>_________________<br/>I'm a PSP hacker now, but I still &lt;3 DS.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#121538 - tepples - Tue Mar 13, 2007 12:12 am</h4>
    <div class="postbody"><span class="postbody">Besides, only chishm knows how to dump devices that look like DS Game Cards, and he's not telling for fear that the pirates will learn.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#121554 - Ryan FB - Tue Mar 13, 2007 3:10 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tepples wrote:</b></span></td> </tr> <tr> <td class="quote">Besides, only chishm knows how to dump devices that look like DS Game Cards, and he's not telling for fear that the pirates will learn.</td> </tr></table><span class="postbody">
<br/>
I haven't tried it myself yet, but it seems like all the information necessary to do this is available on GBATEK.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#121612 - Lick - Tue Mar 13, 2007 2:55 pm</h4>
    <div class="postbody"><span class="postbody">It's not THAT hard to dump. -_- Disassembling the dump is what's hard.<br/>_________________<br/><a class="postlink" href="http://licklick.wordpress.com" target="_blank">http://licklick.wordpress.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#122267 - cory1492 - Sun Mar 18, 2007 7:03 am</h4>
    <div class="postbody"><span class="postbody">How about this... a little more end user complicated but it could (maybe) be made faster than soft reset for all slot 1 cards.
<br/>
   1. Load program and data files from microSD card in SLOT-1
<br/>
   2. Player ejects microSD adapter from SLOT-1
<br/>
   3. Player inserts Game Card
<br/>
   4. Program reads and compresses 256 KiB serial flash (not always 256)
<br/>
   5. Player ejects Game Card
<br/>
   6. Player reinserts microSD adapter in SLOT-1
<br/>
   7. Compressed flash data is written to adapter's save chip, along with some type of flag to tell the app to write the save out with perhaps a file name, user prompted to shut down and reboot.
<br/>
   8. next program boot, the data on the save chip is converted to a regular save file, and intermediately stored however the adapter normally stores it's save chip data.
<br/>
<br/>
Of course, this assumes a couple things. Save chip being the ident factor for which microSD adapter was reinserted, save chip being available on reinsert... I only know for shure at this point MK5 (and likely all the other similar cards) ID as a 2mbit save chip using cardme.
<br/>
<br/>
Also provides the benefit of having access to the DS game's clean header (nearly, there seem to be a couple that don't using the stuff in libnds) every time to make a sensible file name from.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
