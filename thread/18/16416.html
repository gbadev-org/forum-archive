<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>printf from arm7 - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>DS development > printf from arm7</h2>
<div id="posts">
<div class="post">
    <h4>#166430 - cyril_sy - Sun Feb 08, 2009 1:29 am</h4>
    <div class="postbody"><span class="postbody">Hi!
<br/>
<br/>
I am developing an application which only uses audio features. So decided to use only the arm7 for the moment. However I want to print messages on the screen, for debugging.
<br/>
<br/>
I first succeed in sending strings from the arm7 to the arm9, and printing them :
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
/* ARM7 code */
<br/>
void arm7Printf(const char * s)
<br/>
{
<br/>
    fifoSendDatamsg(FIFO_USER_01, sizeof(s), (u8*)&amp;s);
<br/>
}
<br/>
<br/>
/* ARM9 code */
<br/>
void arm7PrintfFifoHandler(int bytes, void* user_data)
<br/>
{
<br/>
    char * data;
<br/>
    fifoGetDatamsg(FIFO_USER_01, bytes, (u8*)&amp;data);
<br/>
    iprintf(data);
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
It works fine, so I tried this in the arm7 code :
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
void arm7Printf(const char * format, ...)
<br/>
{
<br/>
    static char* tmp = NULL;
<br/>
    va_list ap;
<br/>
<br/>
    if (tmp == NULL) {
<br/>
        tmp = malloc(100);
<br/>
    }
<br/>
    va_start(ap, format);
<br/>
    vsnprintf(tmp, 100, format, ap);
<br/>
    va_end(ap);
<br/>
<br/>
    fifoSendDatamsg(FIFO_USER_01, sizeof(tmp), (u8*)&amp;tmp);
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Unfortunately it doesn't works...
<br/>
It seems that sprintf and other functions like that doesn't work on the arm7...
<br/>
<br/>
Is it something wrong in my code ?
<br/>
<br/>
Thanks ;)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#166431 - Lazy1 - Sun Feb 08, 2009 1:41 am</h4>
    <div class="postbody"><span class="postbody">From a quick look, unless something changed the arm9 cannot access memory allocated on the arm7.
<br/>
<br/>
Also, you are trying to get the string length with sizeof()?
<br/>
You should be using <a class="postlink" href="http://www.manpagez.com/man/3/strlen/" target="_blank">strlen</a> instead.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#166432 - Pete_Lockwood - Sun Feb 08, 2009 2:24 am</h4>
    <div class="postbody"><span class="postbody">Strlen is one issue.  You're also taking the address of the pointer unnecessarily.
<br/>
<br/>
Try
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
void arm7Printf(const char * format, ...)
<br/>
{
<br/>
    static char* tmp = NULL;
<br/>
    va_list ap;
<br/>
<br/>
    if (tmp == NULL) {
<br/>
        tmp = malloc(100);
<br/>
    }
<br/>
    va_start(ap, format);
<br/>
    vsnprintf(tmp, 100, format, ap);
<br/>
    va_end(ap);
<br/>
<br/>
    fifoSendDatamsg(FIFO_USER_01, strlen(tmp), (u8*)tmp);
<br/>
} 
<br/>
</td> </tr></table><span class="postbody"><br/>_________________<br/>It's not an illusion, it just looks like one.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#166433 - Lazy1 - Sun Feb 08, 2009 3:30 am</h4>
    <div class="postbody"><span class="postbody">Also, why not just have an array instead of allocating memory like that?
<br/>
It would be make your code much neater, simpler and easier to follow.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#166452 - Pete_Lockwood - Sun Feb 08, 2009 12:36 pm</h4>
    <div class="postbody"><span class="postbody">Certainly.<br/>_________________<br/>It's not an illusion, it just looks like one.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#166455 - cyril_sy - Sun Feb 08, 2009 12:47 pm</h4>
    <div class="postbody"><span class="postbody">Thanks for replies :)
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Lazy1 wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
Also, why not just have an array instead of allocating memory like that?
<br/>
It would be make your code much neater, simpler and easier to follow.
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Before the malloc, I tried with an array, I got this error in No$gba : </span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>No$gba wrote:</b></span></td> </tr> <tr> <td class="quote">Undefined opcode - with no debug vector defined</td> </tr></table><span class="postbody">
<br/>
So I tried with a malloc, just to see... I stops the error.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Pete_Lockwood wrote:</b></span></td> </tr> <tr> <td class="quote">Strlen is one issue. You're also taking the address of the pointer unnecessarily. </td> </tr></table><span class="postbody">
<br/>
I don't know how does FIFO works, I wanted to send the pointer, not the entire string. I tried with strlen, it doesn't solve the problem...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#166457 - Pete_Lockwood - Sun Feb 08, 2009 1:08 pm</h4>
    <div class="postbody"><span class="postbody">The fifo function's definition says it takes a pointer to the data to send.  Try without taking the address.
<br/>
<br/>
EDIT: looks like there's a fifoSendAddress function for if you just want to send the pointer.<br/>_________________<br/>It's not an illusion, it just looks like one.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#166480 - wintermute - Sun Feb 08, 2009 7:38 pm</h4>
    <div class="postbody"><span class="postbody">The arm9 does not have access to the arm7 internal ram so sending a pointer won't work.
<br/>
<br/>
Attempting to write an application that runs only on the arm7 is a bad idea. Does your audio application require functionality that isn't provided by maxmod?<br/>_________________<br/><a class="postlink" href="http://www.devkitpro.org/" target="_blank">devkitPro - professional toolchains at amateur prices</a>
<br/>
<a class="postlink" href="http://wiki.devkitpro.org/index.php/IRC" target="_blank">devkitPro IRC support</a>
<br/>
<a class="postlink" href="http://davejmurphy.com/" target="_blank">Personal Blog</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#166504 - Lazy1 - Mon Feb 09, 2009 5:48 am</h4>
    <div class="postbody"><span class="postbody">Found this as well:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
// Handlers are called when new data arrives - they're called from interrupt level, but well secured so not too much caution is necessary.
<br/>
// Except that you shouldn't alloc/free or printf from within them, just to be safe.
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
So you'll need to find a way around that.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#166557 - cyril_sy - Mon Feb 09, 2009 6:48 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>wintermute wrote:</b></span></td> </tr> <tr> <td class="quote">The arm9 does not have access to the arm7 internal ram so sending a pointer won't work.</td> </tr></table><span class="postbody">
<br/>
<br/>
Thanks :), instead of sending the pointer, I send the chars, one by one :
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
/* ARM7 side */
<br/>
void arm7Printf(const char * format, ...)
<br/>
{
<br/>
    char tmp[100];
<br/>
    va_list ap;
<br/>
<br/>
    va_start(ap, format);
<br/>
    vsnprintf(tmp, 100, format, ap);
<br/>
    va_end(ap);
<br/>
<br/>
    char * p;
<br/>
    for (p = tmp; *p != '\0'; p++) {
<br/>
        fifoSendValue32(FIFO_USER_01, *p);
<br/>
    }
<br/>
}
<br/>
<br/>
/* ARM9 side */
<br/>
void arm7PrintfFifoHandler(u32 value32, void * userdata)
<br/>
{
<br/>
    putchar(value32);
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
It works nice, but should it always work ? can I check if the fifo is full ?
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>wintermute wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
Attempting to write an application that runs only on the arm7 is a bad idea. Does your audio application require functionality that isn't provided by maxmod?</td> </tr></table><span class="postbody">
<br/>
<br/>
I don't plan to use only the arm7, I want to do an ocarina (when you blow on the mic, a note is played). For the moment I am trying the digital processing part only, I suppose it should be on the ARM7 side ?</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
