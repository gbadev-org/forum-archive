<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Impossible sound problem. - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>DS development > Impossible sound problem.</h2>
<div id="posts">
<div class="post">
    <h4>#115648 - relpats_eht - Thu Jan 18, 2007 3:36 am</h4>
    <div class="postbody"><span class="postbody">According to myself and everyone else's whom I have asked, this problem cannot possible exist, and yet, I'm posting.
<br/>
<br/>
What I really want to know here is how this is even possible. If you know a solution to the problem, you may feel free to tell me it, but what I am really asking is how this bug can possibly exist. I feel it is most easily explained through code.
<br/>
<br/>
ARM7:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">IPC-&gt;aux = 0
<br/>
if(snd-&gt;data[i].rate == 8000) IPC-&gt;aux += 10;
<br/>
SCHANNEL_TIMER(i) = SOUND_FREQ(snd-&gt;data[i].rate); // Does not work
<br/>
SCHANNEL_TIMER(i) = SOUND_FREQ(8000); // Does work
<br/>
if(snd-&gt;data[i].rate == 8000) IPC-&gt;aux += 10;
<br/>
if(snd-&gt;data[i].len == 54661) IPC-&gt;aux += 100;
<br/>
SCHANNEL_LENGTH(i) = snd-&gt;data[i].len; // Does not work
<br/>
SCHANNEL_LENGTH(i) = snd-&gt;data[i].len &gt;&gt; 4; // Does work, but only plays a portion of the sample
<br/>
SCHANNEL_LENGTH(i) = 13665; // Does work (54661 &gt;&gt; 2)
<br/>
if(snd-&gt;data[i].len == 54661) IPC-&gt;aux += 100;</td> </tr></table><span class="postbody">
<br/>
<br/>
If after the sound is loaded and played IPC-&gt;aux is printed out, it will equal 220, meaning that the variables equal what they should, both before and after they are used; however, the sample will not play correctly unless constants are used in place of them. I should also probably note that even while using constants so that the sample, rather than garbage, does play, it is a bit distorted.
<br/>
<br/>
If you would like further explanation or code before you can adequately tell me how this conundrum is possible, please, feel free to ask for it.<br/>_________________<br/>- relpats_eht</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#115651 - Lick - Thu Jan 18, 2007 4:11 am</h4>
    <div class="postbody"><span class="postbody">maybe cuz of some overflow. try doing the frequencycalculations without the defines using 2 steps.<br/>_________________<br/><a class="postlink" href="http://licklick.wordpress.com" target="_blank">http://licklick.wordpress.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#115659 - HyperHacker - Thu Jan 18, 2007 7:14 am</h4>
    <div class="postbody"><span class="postbody">Most of the time I have bugs that defy the laws of logic, it ends up being a massive oversight on my part or memory/stack corruption.<br/>_________________<br/>I'm a PSP hacker now, but I still &lt;3 DS.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#115665 - sajiimori - Thu Jan 18, 2007 7:34 am</h4>
    <div class="postbody"><span class="postbody">Could you post the definitions of SCHANNEL_TIMER, SOUND_FREQ, and snd-&gt;data?
<br/>
<br/>
You may also want to inspect the assembler output.  It may give hints as to the internal difference between what works and what doesn't.
<br/>
<br/>
(My first guess is sign extension.)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#115699 - relpats_eht - Thu Jan 18, 2007 1:42 pm</h4>
    <div class="postbody"><span class="postbody">I've tried using no defines and multiple steps to no avail, and my definitions of SCHANNEL_TIMER, SOUND_FREQ, and snd-&gt;data should be the same as everyone else's; nevertheless.
<br/>
snd-&gt;data:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">typedef struct sTransferSoundData {
<br/>
  const void *data;
<br/>
  u32 len;
<br/>
  u32 rate;
<br/>
  u8 vol;
<br/>
  u8 pan;
<br/>
  u8 format;    // Note: I use this as a bitfield, but only the first 4 bits
<br/>
  u8 PADDING;
<br/>
} TransferSoundData, * pTransferSoundData;</td> </tr></table><span class="postbody">
<br/>
<br/>
Defines:</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#define SCHANNEL_TIMER(n)         (*(vint16*)(0x04000408 + ((n)&lt;&lt;4)))
<br/>
#define SOUND_FREQ(n)   ((-0x1000000 / (n)))</td> </tr></table><span class="postbody">
<br/>
<br/>
Also, I do flush sound data before I submit it to the IPC. Sjiimori, I do not know enough ASM to inspect its output.<br/>_________________<br/>- relpats_eht</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#115700 - Lick - Thu Jan 18, 2007 1:45 pm</h4>
    <div class="postbody"><span class="postbody">What about using u16 for the rate?<br/>_________________<br/><a class="postlink" href="http://licklick.wordpress.com" target="_blank">http://licklick.wordpress.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#115729 - sajiimori - Thu Jan 18, 2007 7:57 pm</h4>
    <div class="postbody"><span class="postbody">First question: If 'data' is a void pointer, why is the compiler letting you dereference it?  Maybe I take the typesafety of C++ for granted, but I didn't even think that was allowed in C.
<br/>
<br/>
Try to make the right-hand side of each assignment the same type as the left-hand side.  With the mix of signed/unsigned and wide/narrow types, I wouldn't be surprised if sign extension really is the problem.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#115732 - Lick - Thu Jan 18, 2007 8:16 pm</h4>
    <div class="postbody"><span class="postbody">It's probably 
<br/>
<br/>
TransferSoundData data[n];
<br/>
<br/>
so data[n].data is void*, not data.<br/>_________________<br/><a class="postlink" href="http://licklick.wordpress.com" target="_blank">http://licklick.wordpress.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#115734 - sajiimori - Thu Jan 18, 2007 8:27 pm</h4>
    <div class="postbody"><span class="postbody">Oh, right.  :)
<br/>
<br/>
ARM assembler is pretty easy.  Compile something like this with -S and check out what it says:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
void broken()
<br/>
{
<br/>
  SCHANNEL_TIMER(i) = SOUND_FREQ(snd-&gt;data[i].rate);
<br/>
}
<br/>
<br/>
void works()
<br/>
{
<br/>
  SCHANNEL_TIMER(i) = SOUND_FREQ(8000);
<br/>
}
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#115735 - josath - Thu Jan 18, 2007 8:33 pm</h4>
    <div class="postbody"><span class="postbody">another test you could try is an intermediate variable or two:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
void maybeworks() {
<br/>
  u16 rate = SOUND_FREQ(snd-&gt;data[i].rate)
<br/>
  SCHANNEL_TIMER(i) = rate;
<br/>
}
<br/>
<br/>
void maybeworks2() {
<br/>
  u32 rate1 = snd-&gt;data[i].rate;
<br/>
  u16 rate2 = SOUND_FREQ(rate2);
<br/>
  SCHANNEL_TIMER(i) = rate2;
<br/>
}
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#115736 - DekuTree64 - Thu Jan 18, 2007 8:54 pm</h4>
    <div class="postbody"><span class="postbody">I think sajiimori may be right, that it's the negative number in that macro that's causing the problem. It's probably converting it to a typeless 32-bit value, and then deciding to do an unsigned division because the variable is unsigned. Try moving the negative outside the parentheses:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#define SOUND_FREQ(n)   (-(0x1000000 / (n)))</td> </tr></table><span class="postbody">
<br/>
<br/>
As for the length setting, the registers take the length in words (32-bit units), so if the sample format is 8-bit, then you'll want length &gt;&gt; 2, if 16-bit, then length &gt;&gt; 1, if ADPCM, then length &gt;&gt; 4.<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#115789 - relpats_eht - Fri Jan 19, 2007 2:39 am</h4>
    <div class="postbody"><span class="postbody">Thank you, the problem was the negative in the macro for frequency and length was fixed by using another variable. I can understand why the macro failed but still don't see the difference between a variable and a variable accessed through a structure and shifted before assignment, but I suppose that is largely irrelevant until I come across such a problem again.<br/>_________________<br/>- relpats_eht</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
