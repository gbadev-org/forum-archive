<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Can use help with fading routine - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > Can use help with fading routine</h2>
<div id="posts">
<div class="post">
    <h4>#83504 - Roembout - Tue May 16, 2006 6:23 pm</h4>
    <div class="postbody"><span class="postbody">Hi there,
<br/>
<br/>
I'm trying out some stuff to fade in/out the palette of a tiled background. I found this routine on this forum:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">int readX, step;
<br/>
float red, green, blue;
<br/>
u16 sourceColor, targetColor;
<br/>
targetColor = WHITE;
<br/>
int fadeSteps = 30;
<br/>
<br/>
for( step = 0; step &lt;= fadeSteps; step++ )
<br/>
{
<br/>
  swiWaitForVBlank( );
<br/>
<br/>
  for( readX = 0; readX &lt; 256; readX++ )
<br/>
  {
<br/>
    sourceColor = BG_PALETTE_SUB[readX];
<br/>
<br/>
    red =   ( ( REDVALUE  ( sourceColor ) * ( fadeSteps - step ) ) + ( REDVALUE  ( targetColor ) * step ) ) / fadeSteps;
<br/>
    green = ( ( GREENVALUE( sourceColor ) * ( fadeSteps - step ) ) + ( GREENVALUE( targetColor ) * step ) ) / fadeSteps;
<br/>
    blue =  ( ( BLUEVALUE ( sourceColor ) * ( fadeSteps - step ) ) + ( BLUEVALUE ( targetColor ) * step ) ) / fadeSteps;
<br/>
<br/>
    BG_PALETTE_SUB[readX] = RGB( (int)red , (int)green , (int)blue );
<br/>
  } 
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
It works fine for fading out to white, but I can't get it to work for fading in from white.
<br/>
<br/>
Anybody knows how I can get it to work?
<br/>
<br/>
Thx, in advance.[/code]</span><span class="gensmall"><br/><br/>Last edited by Roembout on Tue May 16, 2006 6:33 pm; edited 2 times in total</span></div>    
</div>
<div class="post">
    <h4>#83507 - ProblemBaby - Tue May 16, 2006 6:28 pm</h4>
    <div class="postbody"><span class="postbody">you have to set targetcolor for each palette entry.
<br/>
<br/>
to make the routine faster and probably the actual fade a bit smoothier change fadeSteps to 32</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#83512 - Roembout - Tue May 16, 2006 6:38 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>ProblemBaby wrote:</b></span></td> </tr> <tr> <td class="quote">you have to set targetcolor for each palette entry.
<br/>
<br/>
to make the routine faster and probably the actual fade a bit smoothier change fadeSteps to 32</td> </tr></table><span class="postbody">
<br/>
<br/>
Got my fade-in routine now like this:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">dmaCopy( menu_img_bin, (u16*)CHAR_BASE_BLOCK_SUB(0), menu_img_bin_size ); 
<br/>
dmaCopy( menu_map_bin, (u16*)SCREEN_BASE_BLOCK_SUB(4), menu_map_bin_size );
<br/>
<br/>
fadeSteps = 32;
<br/>
sourceColor = WHITE;
<br/>
<br/>
for( step = 0; step &lt;= fadeSteps; step++ )
<br/>
{
<br/>
  swiWaitForVBlank( );
<br/>
<br/>
  for( readX = 0; readX &lt; 256; readX++ )
<br/>
  {
<br/>
    targetColor = menu_pal_bin[readX];
<br/>
  
<br/>
    red =   ( ( REDVALUE  ( sourceColor ) * ( fadeSteps - step ) ) + ( REDVALUE  ( targetColor ) * step ) ) / fadeSteps;
<br/>
    green = ( ( GREENVALUE( sourceColor ) * ( fadeSteps - step ) ) + ( GREENVALUE( targetColor ) * step ) ) / fadeSteps;
<br/>
    blue =  ( ( BLUEVALUE ( sourceColor ) * ( fadeSteps - step ) ) + ( BLUEVALUE ( targetColor ) * step ) ) / fadeSteps;
<br/>
<br/>
    BG_PALETTE_SUB[readX] = RGB( (int)red , (int)green , (int)blue );
<br/>
  } 
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
but still getting a weird result; is starts ok but it fades towards red now in stead of white, like my palette is screwup or something which it aint'.
<br/>
<br/>
Changes the fadesteps to 32, it's a bit smoother yes.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#83518 - waruwaru - Tue May 16, 2006 7:20 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Roembout wrote:</b></span></td> </tr> <tr> <td class="quote">but still getting a weird result; is starts ok but it fades towards red now in stead of white, like my palette is screwup or something which it aint'.</td> </tr></table><span class="postbody">
<br/>
<br/>
How about:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
red   = REDVALUE( sourceColor ) - ( ( REDVALUE( sourceColor ) - REDVALUE( targetColor ) ) * 1.0 * step / fadesteps );
<br/>
green = GREENVALUE( sourceColor ) - ( ( GREENVALUE( sourceColor ) - GREENVALUE( targetColor ) ) * 1.0 * step / fadesteps ); 
<br/>
blue  = BLUEVALUE( sourceColor ) - ( ( BLUEVALUE( sourceColor ) - BLUEVALUE( targetColor ) ) * 1.0 * step / fadesteps );
<br/>
</td> </tr></table><span class="postbody"><br/>_________________<br/><a class="postlink" href="http://www.DSLua.com" target="_blank">DSLua - a scripting language for your DS!</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#83519 - Mighty Max - Tue May 16, 2006 7:21 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
red =   ( ( REDVALUE  ( sourceColor ) * ( fadeSteps - step ) ) + ( REDVALUE  ( targetColor ) * step ) ) / fadeSteps; 
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
- keep in mind that even tho red is float, the conversation to float is only done _after_ the calculation was done. Your float definition therefor does not increase the accuracy, you could have just left it an int if you don't do the calcs in float (explicit cast)
<br/>
<br/>
-you are in each step using the values from the last step. as this influenzes the amount of change in each step, this change might be greater then the actual linear factor included in (fadeSteps - step) / fadeSteps. Your value could in the worst case increase instead of decrease to the target. You can change that by basing your interpolation on the start &amp; endpoint instead of current &amp; endpoint.<br/>_________________<br/><a class="postlink" href="http://mightymax.org/gbamp_multiboot.html" target="_blank">GBAMP Multiboot</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#83520 - ProblemBaby - Tue May 16, 2006 7:38 pm</h4>
    <div class="postbody"><span class="postbody">Yaeh, something like this would be better, I think
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
u32 fadeSteps = 32; 
<br/>
u32 sourceColor = 0x7FFF;
<br/>
u32 red, green, blue;
<br/>
s32 dr, dg, db;
<br/>
<br/>
dr = ((REDVALUE(targetColor) - REDVALUE(sourceColor)) &lt;&lt; 8) / fadeSteps
<br/>
dg = etc
<br/>
db = etc
<br/>
<br/>
red = REDVALUE(sourceColor) + ((dr * step) &gt;&gt; 8);
<br/>
green = etc
<br/>
blue = etc</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#83522 - Roembout - Tue May 16, 2006 7:47 pm</h4>
    <div class="postbody"><span class="postbody">Thx for the replies. I'm gonna try out your suggentions.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#83610 - Roembout - Wed May 17, 2006 10:22 am</h4>
    <div class="postbody"><span class="postbody">This is stuff is tough getting it to work correctly. I came across defines as BLEND_ALPHA and BLEND_FADE_WHITE in video.h. Can I get the same result with this and if I can how do I have to implement it?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#83635 - wintermute - Wed May 17, 2006 3:13 pm</h4>
    <div class="postbody"><span class="postbody">The blend registers won't give you such fine control over the fade - there are only 16 steps.
<br/>
<br/>
<br/>
There is code in libgba which does what you're trying to do which should work  on DS with minor modifications.
<br/>
<br/>
<a href="http://devkitpro.cvs.sourceforge.net/devkitpro/libgba/src/fade.c?revision=1.4&amp;view=markup" target="_blank">http://devkitpro.cvs.sourceforge.net/devkitpro/libgba/src/fade.c?revision=1.4&amp;view=markup</a><br/>_________________<br/><a class="postlink" href="http://www.devkitpro.org/" target="_blank">devkitPro - professional toolchains at amateur prices</a>
<br/>
<a class="postlink" href="http://wiki.devkitpro.org/index.php/IRC" target="_blank">devkitPro IRC support</a>
<br/>
<a class="postlink" href="http://davejmurphy.com/" target="_blank">Personal Blog</a></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
