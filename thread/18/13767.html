<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Help! Wireless and Download Play Client - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > Help! Wireless and Download Play Client</h2>
<div id="posts">
<div class="post">
    <h4>#135607 - yellowstar - Tue Jul 24, 2007 11:32 pm</h4>
    <div class="postbody"><span class="postbody">I have some questions and problems.
<br/>
These questions and problems
<br/>
have to do with <a class="postlink" href="http://forum.gbadev.org/viewtopic.php?t=11946" target="_blank">wireless</a> and a Download Play Client.
<br/>
<br/>
NOTE:
<br/>
I have moved this problem,
<br/>
from my <a class="postlink" href="http://forum.gbadev.org/viewtopic.php?t=13745" target="_blank">"Help! Wireless, bootloader, icon and Download Play Client",</a>
<br/>
to here,
<br/>
since the total size of that starting post was very long.
<br/>
<br/>
1.
<br/>
<br/>
I am trying to make a DS Download Play Client,
<br/>
for Juglak's <a class="postlink" href="http://forum.gbadev.org/viewtopic.php?t=11946" target="_blank">WMB Host.</a>
<br/>
<br/>
All these problems are in this client.
<br/>
<br/>
My client is based on Juglak's WMB Host,
<br/>
for local wireless.
<br/>
<br/>
Like Juglak's WMB Host,
<br/>
my program's graphics is an console.
<br/>
<br/>
<br/>
<br/>
The following is a problem with the wireless communication
<br/>
part of the client.(The downloading and etc.)
<br/>
<br/>
My client never makes it past the Authication step.
<br/>
<br/>
According to the CFTP version of DSFTP,
<br/>
in the Packet Capture tool,
<br/>
it says it(my client) never sends out the Authication requests.
<br/>
<br/>
The only thing it detected was the host's Download Play ad/beacon.
<br/>
<br/>
Here's the things I have tried:
<br/>
<br/>
I tried typecasting the framehead struct to
<br/>
a pointer, whichs points to an unsigned char array,
<br/>
then sending that.
<br/>
<br/>
That failed.
<br/>
<br/>
I tried allocating a dynamic unsigned char array.
<br/>
<br/>
I then copied the contents of the framehead struct
<br/>
into that array.
<br/>
<br/>
Then I would have it sent.
<br/>
<br/>
That failed.
<br/>
<br/>
<br/>
Here's my code:
<br/>
<br/>
This only has the code for the ARM9.
<br/>
Since this app is based on Juglak's WMB Host,
<br/>
this app has the same ARM7 code as the WMB Host.
<br/>
<br/>
After initializing,
<br/>
my app goes into a loop.
<br/>
<br/>
A timer,(gets triggered evey second)
<br/>
handles detecting the Download Play ads/beacons.
<br/>
<br/>
If one was detected at least once,
<br/>
in a 5 second time frame,
<br/>
it displays information about the ad/beacon.
<br/>
<br/>
Other wise,
<br/>
it clears that info,
<br/>
and stops displaying it.
<br/>
<br/>
<br/>
When a ad is detected,
<br/>
to start downloading,
<br/>
you press A.
<br/>
<br/>
It will then ask if you are sure
<br/>
you want to download.
<br/>
With A for yes, B for no.
<br/>
<br/>
After that,
<br/>
it will go into another infinite loop.
<br/>
<br/>
In this loop,
<br/>
a function which handles the actual downloading and ect. ,
<br/>
is called.
<br/>
<br/>
Here is that function:
<br/>
(Note: I cut out the rest of the steps which handles
<br/>
the steps after Authication, since I didn't get to those
<br/>
steps, and beacuse it never makes it past Authication.)
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
void downloadMain()
<br/>
{
<br/>
<br/>
<br/>
<br/>
   int i, ds, j=0, k;
<br/>
   unsigned char *datapkt;
<br/>
   struct nds_rsaframe *rsa;
<br/>
   unsigned char *nds_data;
<br/>
   tNDSHeader *nds_head;
<br/>
   tNDSBanner *banner;
<br/>
   unsigned char *d,*dr;
<br/>
   struct iee80211_framehead FH;
<br/>
   struct iee80211_framehead *fh = &amp;FH;
<br/>
   bool gotrsa=0;
<br/>
   int mode = 1;
<br/>
   unsigned short curdata=0;
<br/>
   unsigned char *dataacked;
<br/>
<br/>
consoleClear();
<br/>
<br/>
if (mode == 1) {
<br/>
         //Wifi_SetRetry(4);
<br/>
         //dr = RXNextFrame(&amp;ds);
<br/>
         //if (dr != NULL) {
<br/>
            //for(int i=0;i&lt;10;i++)
<br/>
            //{
<br/>
            //fh = (struct iee80211_framehead *) malloc(66);//(unsigned int) dr;
<br/>
               
<br/>
            
<br/>
               
<br/>
            memset(fh,sizeof(fh),0);
<br/>
               
<br/>
            // check against macs later to see if its really to us
<br/>
            //Right here, in WMB Host,
<br/>
            //fh-&gt;frame_control always = 4272
<br/>
            
<br/>
            fh-&gt;frame_control = 4272;//4272,3,15
<br/>
            
<br/>
            for(int i = 0; i &lt; 6; i++)
<br/>
            fh-&gt;mac3[i] = the_ad.host_mac[i];
<br/>
            
<br/>
            for(int i = 0; i &lt; 6; i++)
<br/>
            fh-&gt;mac2[i] = mymac[i];
<br/>
            
<br/>
            //if (((FH_FC_TYPE(fh-&gt;frame_control) == 0) &amp;&amp; (FH_FC_SUBTYPE(fh-&gt;frame_control) == 11)) &amp;&amp; 
<br/>
            //CompareMAC(my_mac, fh-&gt;mac3)) {
<br/>
            
<br/>
            for(int i=0;i&lt;10;i++)
<br/>
            {
<br/>
            
<br/>
            unsigned char *buff = (unsigned char*)malloc(sizeof(fh));
<br/>
            
<br/>
            memset(buff,sizeof(buff),0);
<br/>
            
<br/>
            memcpy((unsigned char*)fh,buff,sizeof(buff));
<br/>
            
<br/>
            SendFrame(buff,sizeof(buff));
<br/>
            //free(fh);
<br/>
            
<br/>
            free(buff);
<br/>
            }
<br/>
            
<br/>
            //}
<br/>
            
<br/>
               iprintf("\x1b[18;0H                                ");
<br/>
               iprintf("\x1b[18;0H* Sent Authentication request\n");
<br/>
               
<br/>
               //return;
<br/>
               
<br/>
               //iprintf("\x1b[19;0HMAC1: "); for(i=0;i&lt;6;i++) iprintf("%2.2X ",fh-&gt;mac1[i]);
<br/>
               //iprintf("\x1b[20;0HMAC2: "); for(i=0;i&lt;6;i++) iprintf("%2.2X ",fh-&gt;mac2[i]);
<br/>
               //iprintf("\x1b[21;0HMAC3: "); for(i=0;i&lt;6;i++) iprintf("%2.2X ",fh-&gt;mac3[i]);
<br/>
               //iprintf("\x1b[21;0HMAC3: "); for(i=0;i&lt;6;i++) iprintf("%2.2X ",fh-&gt;mac3[i]);
<br/>
                  
<br/>
               // ack it
<br/>
               
<br/>
               
<br/>
               if(!GetACK(mymac))
<br/>
               return;
<br/>
               
<br/>
               iprintf("\x1b[18;0H* ACKED!\n");
<br/>
               //mac2 is the MAC of the client. That is,
<br/>
               //the DS that is running this app.
<br/>
                  
<br/>
               /*copy_mac(&amp;authres[4], &amp;fh-&gt;mac2[0]);
<br/>
               copy_mac(&amp;authres[10], &amp;mymac[0]);
<br/>
               copy_mac(&amp;authres[16], &amp;mymac[0]);
<br/>
               fh = (struct iee80211_framehead *) (unsigned int) &amp;authres[0];
<br/>
               fh-&gt;sequence_control = bec_seq&lt;&lt;4;
<br/>
               */
<br/>
               bec_seq++;            
<br/>
               //SendFrame(authres,30);
<br/>
               
<br/>
               while(1)
<br/>
               {
<br/>
               
<br/>
               fh = (struct iee80211_framehead *)RXNextFrame(&amp;sz);
<br/>
               
<br/>
               if(sz==30 &amp;&amp; fh!=NULL)
<br/>
               {
<br/>
                if(((unsigned char*)fh)[4]==mymac[0] &amp;&amp; ((unsigned char*)fh)[10]==the_ad.host_mac[0] &amp;&amp; ((unsigned char*)fh)[16]==the_ad.host_mac[0])
<br/>
                {
<br/>
                break;
<br/>
                }
<br/>
                else
<br/>
                {
<br/>
                return;
<br/>
                }
<br/>
               }
<br/>
               else
<br/>
               {
<br/>
               return;
<br/>
               }
<br/>
               
<br/>
               iprintf("\x1b[18;0H* Authenicated!\n");
<br/>
               
<br/>
               }
<br/>
<br/>
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Here is the GetACK function.
<br/>
<br/>
Basicly, it waits for  an ACK with the specified mac.
<br/>
It goes into a for loop,
<br/>
and if it doesn't find it,
<br/>
it returns 0.
<br/>
<br/>
Otherwise,
<br/>
it returns 1.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
bool GetACK(unsigned char *wanted_mac)
<br/>
{
<br/>
<br/>
unsigned char *dat = NULL;
<br/>
<br/>
 for(int i=0; i&lt;10; i++)
<br/>
 {
<br/>
 
<br/>
 dat = RXNextFrame(&amp;sz);
<br/>
 
<br/>
  if(sz==6)
<br/>
  {
<br/>
  
<br/>
   if(CompareMAC(wanted_mac,dat))
<br/>
   {
<br/>
   return 1;
<br/>
   }
<br/>
  
<br/>
  }
<br/>
  
<br/>
  return 0;
<br/>
 
<br/>
 }
<br/>
<br/>
}
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#135611 - yellowstar - Tue Jul 24, 2007 11:42 pm</h4>
    <div class="postbody"><span class="postbody">This post has been moved from my other topic,
<br/>
the topic which this problem was moved from.
<br/>
<br/>
Download Play Client Auth bug:
<br/>
<br/>
I have found out that for some reason,
<br/>
my app won't send anything.
<br/>
<br/>
But recieving works fine.
<br/>
<br/>
I tried sending an ACK.(a packet which contains a MAC
<br/>
address, in this case it was the client's MAC.)
<br/>
<br/>
That failed.
<br/>
<br/>
I guess I'll need to replace the ARM7 code with the ARM7
<br/>
code in Juglak's WMB Host.
<br/>
<br/>
Then if that dosen't work,
<br/>
I'll have to replace the functions in the the ARM9 main source
<br/>
code file.
<br/>
(The functions I copied from WMB Host,
<br/>
I'll have to copy them again unto the ones I have.)
<br/>
<br/>
<span style="font-weight: bold">EDIT:</span>
<br/>
I tried the above,
<br/>
but that didn't fix it.
<br/>
<br/>
When it starts the download process,
<br/>
it dosen't set the current channel to the host's channel.
<br/>
<br/>
This might one of the problems that is causing this,
<br/>
but packet capture programs don't detect anything
<br/>
while it is sending anything,
<br/>
on any channel.
<br/>
<br/>
<span style="font-weight: bold">EDIT2:</span>
<br/>
I tried the above,
<br/>
but that didn't work.
<br/>
<br/>
I also tried to have it print the current channel,
<br/>
but that didn't work.
<br/>
<br/>
For some reason,
<br/>
it wouldn't print that.
<br/>
<br/>
I have it printing before it sets the current channel.
<br/>
<br/>
I have it printing the value the channel it
<br/>
is going to be set to.
<br/>
<br/>
<span style="font-weight: bold">EDIT3:</span>
<br/>
Never mind about
<br/>
the print bug in the above edit,
<br/>
it was clearing the screen before
<br/>
I could see the printed text.
<br/>
<br/>
Now it prints the channel and ect.
<br/>
correctly at that point.
<br/>
<br/>
Now,
<br/>
for some reason,
<br/>
now the host is broadcasting
<br/>
on channel 10,
<br/>
instead of 11,
<br/>
like it was before.
<br/>
<br/>
But that dosen't
<br/>
affect my client,
<br/>
since it sets the current channel
<br/>
to the host's channel,
<br/>
before the download process is started.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#136429 - yellowstar - Wed Aug 01, 2007 5:53 pm</h4>
    <div class="postbody"><span class="postbody">I tried sending a packet which is
<br/>
1 byte in size.
<br/>
I am having it send it in the timer handler
<br/>
which handles recieving the beacons.
<br/>
<br/>
That worked.
<br/>
<br/>
Next I tried sending a packet the size
<br/>
of the struct for an Auth request.(framehead struct)
<br/>
<br/>
That failed.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#136439 - pas - Wed Aug 01, 2007 9:01 pm</h4>
    <div class="postbody"><span class="postbody">PM Juglak ?<br/>_________________<br/><a class="postlink" href="http://www.petitiononline.com/blizzds/petition.html" target="_blank">Starcraft DS ?</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#137250 - Moby Disk - Thu Aug 09, 2007 2:35 pm</h4>
    <div class="postbody"><span class="postbody">If you do PM him, let us know the reply.  There are other peopel who (well...me!) would like to do this, but I haven't even started yet so I can't help.  But I can cheer you on.
<br/>
<br/>
Rah rah rah!
<br/>
DSWifi!
<br/>
yaaaay!
<br/>
(good luck)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#137253 - simonjhall - Thu Aug 09, 2007 2:45 pm</h4>
    <div class="postbody"><span class="postbody">I PMed him about this when I started RE-ing the p-2-p wifi but the mail never left the outbox so I guess he just never picked it up. And I send the message *ages* ago, so maybe he's not been at gbadev for a while...<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#137299 - yellowstar - Fri Aug 10, 2007 12:16 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>simonjhall wrote:</b></span></td> </tr> <tr> <td class="quote">And I send the message *ages* ago, so maybe he's not been at gbadev for a while...</td> </tr></table><span class="postbody">
<br/>
I thought he wasn't on here in a long time.
<br/>
<br/>
<br/>
I tried calling RXNextFrame,
<br/>
1000 times,(in a for loop)
<br/>
before sending frames for the download process.
<br/>
(I tried calling RXNextFrame in a while loop,
<br/>
untill the receive quene was empty.
<br/>
But it never exited that loop.
<br/>
Apparently, the frames kept comming in.)
<br/>
<br/>
That didn't work.
<br/>
<br/>
This probably isn't possible, but:
<br/>
Is it possible to temporarly make
<br/>
the wireless WiFi hardware to stop receiving
<br/>
frames, and only send frames?
<br/>
<br/>
<span style="font-weight: bold">EDIT:</span>
<br/>
I have PMed Juglak.
<br/>
No way of knowing when he will reply...</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
