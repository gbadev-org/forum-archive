<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>SRAM Writing, particularly on Supercard Lite - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > SRAM Writing, particularly on Supercard Lite</h2>
<div id="posts">
<div class="post">
    <h4>#104037 - Moeity - Tue Sep 26, 2006 2:57 am</h4>
    <div class="postbody"><span class="postbody">I'm trying to save a simple single uint32 value to SRAM. I'm using some standard write and read functions:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
void writeSram(int offset, char const* src, int size) {
<br/>
        WAIT_CR &amp;= ~0x0880;
<br/>
        char* dest = (char*)SRAM;
<br/>
        if(offset&gt;0){
<br/>
                while(offset--){
<br/>
                        *dest++;
<br/>
                }
<br/>
        }
<br/>
        int x = 0;
<br/>
        while(size--){
<br/>
                *dest++ = (uint8)(src[x]); x++;
<br/>
        }
<br/>
}
<br/>
<br/>
void readSram(int offset, char* dest, int size) {
<br/>
        WAIT_CR &amp;= ~0x0880;
<br/>
        char const* src = (char const*)SRAM;
<br/>
        if(offset&gt;0){
<br/>
                while(offset--){
<br/>
                        *src++;
<br/>
                }
<br/>
        }
<br/>
        int x = 0;
<br/>
        while(size--){
<br/>
                *dest++ = (uint8)(src[x]);
<br/>
                x++;
<br/>
        }
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Then using:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
     uint32 now_index;
<br/>
     const int S_INDEX_LOC = 0;
<br/>
                ...
<br/>
     void save(){
<br/>
                writeSram(S_INDEX_LOC, (char*)&amp;now_index, sizeof(now_index));
<br/>
    }
<br/>
    void load(){
<br/>
        readSram(S_INDEX_LOC, (char*)&amp;now_index, sizeof(now_index));
<br/>
    }
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
It appears to write, and load back fine when testing, however after powering off I always get a constant value that is not what I saved back. Am I doing anything obviously wrong in code?
<br/>
<br/>
It could also be I'm not setting up my Supercard Lite properly... I compiled in devkitarm, copied the program.nds file to my SD card as /program.nds, and copied the default .sav file from the Supercard program directory as /program.sav. 
<br/>
<br/>
Any ideas? Once this is working I should have a version 0.1 of a working ebook reader with loadable aa fonts, run-time font-resizing and coloring, switchable potrait/landscape modes, and automatic page saving whose souce I can give to anyone interested. Hope to add some very basic html tag parsing and filesytem reading for version 0.2, at which time it should be a decent ebook reader.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#104039 - Moeity - Tue Sep 26, 2006 3:08 am</h4>
    <div class="postbody"><span class="postbody">The code is fine, I was mistakenly QPC saving the wrong save file after rebooting the system. Sorry for the post, problem solved. Two days of being puzzled, then figured it out right after I posted here, of course...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#104053 - HyperHacker - Tue Sep 26, 2006 6:52 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Moeity wrote:</b></span></td> </tr> <tr> <td class="quote">Two days of being puzzled, then figured it out right after I posted here, of course...</td> </tr></table><span class="postbody">
<br/>
I find the best way to find the solution to a problem is to ask for help. Maybe 80% of the time I find it within half an hour of posting or even while writing the post.<br/>_________________<br/>I'm a PSP hacker now, but I still &lt;3 DS.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#104769 - sasq - Mon Oct 02, 2006 2:54 pm</h4>
    <div class="postbody"><span class="postbody">Not to for nothing, but that code is a bit longish. This should be enough:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
void writeSram(int offset,  const char *src, int size) { 
<br/>
        char *dest = ((char*)SRAM) + offset; 
<br/>
        while(size--) *dest++ = *src++; 
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
EDIT:
<br/>
<br/>
or even
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
void writeSram(int offset,  const char *src, int size) { 
<br/>
        while(size--) ((char*)SRAM)[offset+size] = src[size]; 
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
if you want to really write short hard to read code :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#104789 - sumiguchi - Mon Oct 02, 2006 5:52 pm</h4>
    <div class="postbody"><span class="postbody">So does this really persist after a power recycle?  I found that to persist the data, I had to do a quick power cycle (off then on in &lt; 2 or 3 seconds) and then go to the Saver screen and manually write the current SRAM to the file.
<br/>
<br/>
It loads automatically but I haven't been able to get it to save automatically (so that it works after a power cycle)...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#104793 - sasq - Mon Oct 02, 2006 6:08 pm</h4>
    <div class="postbody"><span class="postbody">I've never had such problems with SRAM. Simple 8bit writes has always been enough - do you use some non-standard GBA cart?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#104794 - Sektor - Mon Oct 02, 2006 6:30 pm</h4>
    <div class="postbody"><span class="postbody">Yes, he uses a supercard.  It doesn't have a battery to keep the SRAM, so unless you use the built-in feature to write the SRAM to CF/SD then it will be lost after power off.<br/>_________________<br/><span style="font-size: 9px; line-height: normal"><a class="postlink" href="http://gtamp.com/DS" target="_blank">GTAMP.com/DS</a></span></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
