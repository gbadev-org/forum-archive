<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Differing methods for making display lists... - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>DS development > Differing methods for making display lists...</h2>
<div id="posts">
<div class="post">
    <h4>#136959 - ChrisKnott - Mon Aug 06, 2007 10:16 pm</h4>
    <div class="postbody"><span class="postbody">I`ve noticed that sometimes a display list is defined with normal gl commands, between glBeginList( GL_COMPILE ) and glEndList() (I think), and sometimes it is written as just a u32 array with raw FIFO commands.
<br/>
<br/>
What is the difference between these two methods?
<br/>
<br/>
And also, how do you `save` a display list to a .bin file once you have it done?
<br/>
<br/>
Thanks a lot.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#137007 - ChrisKnott - Tue Aug 07, 2007 11:27 am</h4>
    <div class="postbody"><span class="postbody">Pretty please?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#137008 - Dark Knight ez - Tue Aug 07, 2007 11:30 am</h4>
    <div class="postbody"><span class="postbody">Well, the DS does not have OpenGL commands like glBeginList and glEndList.
<br/>
Some people (including myself) might have coded them -- or something similarly named -- to easily create such a u32 array with raw FIFO commands.
<br/>
So basicly, on the DS, a display list is a u32 array and nothing more. Sometimes hidden by functions.
<br/>
<br/>
You might be interested in checking out the following project's source code... that is to say, the displaylistlib.c and displaylistlib.h files.
<br/>
<a class="postlink" href="http://amplituds.drunkencoders.com/?s=projects&amp;proj=Tools%20for%203D%20models" target="_blank">Tools for 3D models</a>
<br/>
In it are OpenGL-like display list functions: glBeginListDL, glEndListDL, glVertex3fDL, etc. Basicly the regular functions but ending on DL to make a distinction between writing to a display list and writing to regular output.<br/>_________________<br/><span style="font-size: 9px; line-height: normal"><a class="postlink" href="http://amplituds.drunkencoders.com" target="_blank">AmplituDS website</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#137010 - ChrisKnott - Tue Aug 07, 2007 11:47 am</h4>
    <div class="postbody"><span class="postbody">Thanks a load!
<br/>
<br/>
I hope you don't mind if I just reel off a few more questions about display lists...?
<br/>
<br/>
1. How do I make a precompiled .bin file?
<br/>
2. What commands can I used for reading in variable data within a display list, like I presume I can't just use variables normally (it doesn't seem to work at least), do I have to use matrices?
<br/>
3. If you make a triangle strip, how does it know which edge to add the next triangle on?
<br/>
<br/>
Thanks again.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#137016 - silent_code - Tue Aug 07, 2007 1:12 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>ChrisKnott wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
3. If you make a triangle strip, how does it know which edge to add the next triangle on?</td> </tr></table><span class="postbody">
<br/>
it depends on the order you pass vertices: a new vertex creates a tri with the last two. simple, isn't it? ;p</span><span class="gensmall"><br/><br/>Last edited by silent_code on Tue Aug 07, 2007 1:18 pm; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#137017 - tepples - Tue Aug 07, 2007 1:13 pm</h4>
    <div class="postbody"><span class="postbody">1. To read a .bin file, use bin2o (which should happen automatically with wintermute's template if you put your files in the data folder) to put it inside the .nds, or use libfat to read it from another file on the CF or SD card.
<br/>
<br/>
2. To learn how to make dynamic arrays in C, look up malloc(), calloc(), and free(). In C++, also look up new and delete.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>ChrisKnott wrote:</b></span></td> </tr> <tr> <td class="quote">3. If you make a triangle strip, how does it know which edge to add the next triangle on?</td> </tr></table><span class="postbody">
<br/>
GL triangle strips always add points on alternating sides of the strip. Fans are not implemented on the DS.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#137019 - silent_code - Tue Aug 07, 2007 1:20 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tepples wrote:</b></span></td> </tr> <tr> <td class="quote">1. To read a .bin file...</td> </tr></table><span class="postbody">
<br/>
he meant "create", not "read"... ;p
<br/>
<br/>
also, your pt #2 is totally unrelated (or is it just my brain being offline? i'm still a bit sick because of a bad cold. ;) ).
<br/>
he wants to know how to, e.g. scale his model dynamically (you could do that with a matrix) or make other dynamic adjustments to his displaylists (like changing positions, colors, normals or whatever).
<br/>
<br/>
EDIT: now, what tepples *might* mean, is that you could read the diplaylist into a chunk of memory and knowing where what data is, you could just write to that memory, altering any values currently in there. i wouldn't recommend it until you're knowing what you're doing, though. this is very prone to errors, especially when your dl changes.
<br/>
you could still "process" that data (figuring out where the data to be changed is located by scanning through), though knowing the exact locations/offsets is still faster.
<br/>
<br/>
you sure try to do skinned meshes, ain't you? ;D</span><span class="gensmall"><br/><br/>Last edited by silent_code on Tue Aug 07, 2007 1:48 pm; edited 2 times in total</span></div>    
</div>
<div class="post">
    <h4>#137021 - ChrisKnott - Tue Aug 07, 2007 1:34 pm</h4>
    <div class="postbody"><span class="postbody">Thanks peeps, I guess re: the dynamic arrays he was saying that you can read data inside a display list as long as you actually assign the memory and don't just put it on the stack...
<br/>
<br/>
At least that's what I read it as, I'll try it out now.
<br/>
<br/>
Yes, what I want to do (basically as a test) is to have a display list that describes how the vertices are joined together, and their UV data, but gets passed the positions and normals every time it is called.
<br/>
<br/>
Also right, I was curious as to how you MAKE the .bin file, the Makefile I am using at the moment already compiles them nicely. I guess you just make a .c with the just the display list array in and.... er... that's about as far as I got ;).</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#137022 - silent_code - Tue Aug 07, 2007 1:50 pm</h4>
    <div class="postbody"><span class="postbody">as far as i understand, the way you're doing it, the dl is compiled into the rom. if i'm not totally wrong (see above), it creates a .bin and a .h file. include the .h file and you have access to the array as well as some additional information (take a look at one of those .h). from there you can then read / modify the array. no loading, but less ram available. (i'm sure i'm totally mixing up stuff now! i need to go *HOME*! ;p )
<br/>
<br/>
what you seem to want is a tool that creates a .bin with the raw content of the compiled dl array, right?
<br/>
<br/>
a parser comes to my mind: it takes a .c and scans through it, writing corresponding binary values to a .bin.
<br/>
<br/>
... that means if you don't want to write a small (PC/MAC/whatever) prog: include the .c files (you should make them .h instead) including the initialized array and compile. it (read a simple printf) should then output the arrays to the according .bin files.
<br/>
<br/>
that's sort of a sh*t way to do it and you'll have to compile every time you want to convert a new dl and make adjustment for each and every dl (.bin name, a line that passes each array for output). a makefile may help, though it's still pretty sh*tty and definitely *not* artist friendly.</span><span class="gensmall"><br/><br/>Last edited by silent_code on Tue Aug 07, 2007 2:13 pm; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#137024 - ChrisKnott - Tue Aug 07, 2007 2:12 pm</h4>
    <div class="postbody"><span class="postbody">I'm not sure I really do need a tool that creates the .bin files, at the moment at least, it just wondered how they did it - for example a lot of the demos use teapot.bin, and you can just chuck that file around like a model file. 
<br/>
<br/>
The makefile builds a header which you can then include, and you can then call the display list with one command, just seemed the nicest way of managing objects imo.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#137025 - silent_code - Tue Aug 07, 2007 2:18 pm</h4>
    <div class="postbody"><span class="postbody">ok, you want to take a mesh, then convert that mesh into a dl and write the binary representation to a .bin file to use it just like the teapot etc., right?
<br/>
<br/>
there's some plugin for an *expensive* 3d gfx package (3ds max, iirc) that does that. i guess i can't help you any further.
<br/>
I'd write a small converter taking whatever mesh file format you're using, building the dl (rip any needed functions from libnds or take a look at how that plugin does it, if possible) and outputting that as a .bin. (i guess this is the way "they" did it.)
<br/>
<br/>
good luck! ;)
<br/>
<br/>
EDIT:
<br/>
<br/>
... and if it isn't that, what *exactly* is it you're trying to do (and doesn't work)? describe how the process (""workflow"") *should* be and where you're having problems. in a quick, short way, that is.
<br/>
also, look into your build folder after you compiled the demo (for any suspicious .h files etc.).
<br/>
<br/>
NOTE: sorry, i didn't read your last post before... so this may be obsolete.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#137032 - ChrisKnott - Tue Aug 07, 2007 3:25 pm</h4>
    <div class="postbody"><span class="postbody">Thanks, I'll fiddle around with trying to get a .bin file, I had noticed the plugins for Maya and Max etc. not much help to a Milkshaper...
<br/>
<br/>
I tried refering to memory from within a display list, it compiles ok, but it doesn't work in an emulator I run it in. I tried it on the DS and it kind of works, as in it tries to draw a red triangle, but I think it's just pulling junk out of the memory every time I tried to use a variable in the display list.
<br/>
<br/>
I'm basically doing this:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">u32* Verts;
<br/>
<br/>
u32 Triangle[] =
<br/>
(
<br/>
10,
<br/>
blah,
<br/>
FIFO( COLOR, VERTEX, VERTEX, VERTEX )
<br/>
rgb15( 0, 2414521 63161 )
<br/>
Verts[ 0 ], Verts[ 1 ]
<br/>
Verts[ 2 ], Verts[ 3 ]
<br/>
// just put variables in the display list ^^
<br/>
Etc...
<br/>
)
<br/>
<br/>
int main()
<br/>
{
<br/>
Verts = new u32 [ 6 ];
<br/>
Verts[ 0 ] = VERTEX_PACK( inttov16( 0 ), inttov16( 0 ) );
<br/>
etc.
<br/>
// Actually define the vertices here, in main.
<br/>
..
<br/>
...
<br/>
....
<br/>
glDrawList( triangle );
<br/>
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I am aware that that is the worst code example ever posted on these forums...
<br/>
<br/>
Should I be declaring the pointer some other way? I think that's what's going wrong, it doesn't recognise Verts from withing the display list.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#137036 - Dark Knight ez - Tue Aug 07, 2007 4:09 pm</h4>
    <div class="postbody"><span class="postbody">I don't quite understand...
<br/>
<br/>
The easiest way for you to use display lists would be to use something like my .x converter to DS display list format. If Milkshape can export to .x (in ASCII format) that is.
<br/>
The converter will spit out a .c file in which the array is present, and with that everything is pretty much self explanatory. Just doing a callList on the array in that .c file will do the trick.
<br/>
Again, check the model tools section and see if it's of use. If not, then ignore my words here and I must've misunderstood you.
<br/>
<br/>
There are also other tools to convert from .x to DS display list, or from other formats too I think... Search these forums for them.<br/>_________________<br/><span style="font-size: 9px; line-height: normal"><a class="postlink" href="http://amplituds.drunkencoders.com" target="_blank">AmplituDS website</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#137047 - ChrisKnott - Tue Aug 07, 2007 5:16 pm</h4>
    <div class="postbody"><span class="postbody">Sorry, I'll try to clarify...
<br/>
<br/>
I can happily convert a model I make in Milkshape into display list, I wrote my own little text editing program to do that.
<br/>
<br/>
I only wonder how to make that chunk of code into a .bin file, rather than having it in a separate code file, I just personally thought it was nicer as a .bin file but that isn't a great worry...
<br/>
<br/>
My problem is I want to adjust vertices of a model I make, dynamically in the code, basically a kind of animation...
<br/>
<br/>
Say I have a display list of a cube, instead of it saying
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
FIFO_COMMAND_PACK( FIFO_VERTEX16, ... )
<br/>
     VERTEX_PACK( inttov16( 0 ), inttov16( 1 ) ), ....
<br/>
     ...
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
It could say something like:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
FIFO_COMMAND_PACK( FIFO_VERTEX16, ... )
<br/>
     VERTEX_PACK( Verts[ 0 ], Verts[ 1 ] ),....
<br/>
     ...
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Where Verts was an array of v16s which I could set in the code. That would allow me to do crazy distorts on the cube, stretching it and stuff, but the display list should still draw the triangles between all the the right vertices and also UV it correctly.
<br/>
<br/>
Basically what I need is a way of reading data I can set in main(), in a display list... is the only way of doing this, by using the special matrix list? Or is there another way of getting variable data into a display list?
<br/>
<br/>
Thanks.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#137062 - Dark Knight ez - Tue Aug 07, 2007 6:42 pm</h4>
    <div class="postbody"><span class="postbody">Aaaaahhh...
<br/>
Well, it wouldn't work like that, of course. It's not like pointers to other memory locations in the displaylist array itself will work.
<br/>
The only way for this to work would be to either create a new displaylist array for every motionframe, or to adjust values in the existing displaylist array itself.<br/>_________________<br/><span style="font-size: 9px; line-height: normal"><a class="postlink" href="http://amplituds.drunkencoders.com" target="_blank">AmplituDS website</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#137081 - ChrisKnott - Tue Aug 07, 2007 8:45 pm</h4>
    <div class="postbody"><span class="postbody">But I heard that you could still access the DS's matrix stack from with a display list? In that case, you could just pack some matrices full of positions, and read them off.
<br/>
<br/>
Although, maybe that isn't the case. I think I heard that you can RESTORE matrices, but not Push/Pop them.
<br/>
<br/>
Maybe the best option would be to just draw the triangles that are effected by more than one bone normally, ie. not in a display list.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#137087 - M3d10n - Tue Aug 07, 2007 9:06 pm</h4>
    <div class="postbody"><span class="postbody">I've tested push and pop on display lists, and they seem to work OK. I'm using that to include scaling directly into my display lists (the models are scaled during rendering because I'm scaling the vertices coordinates to fit on the v16 range). 
<br/>
<br/>
I had to add some extra FIFO defines for the matrix functions, though. But it's just using the REG2ID() macro just like all other FIFO defines to generate FIFO ids for the matrix commands.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#137155 - silent_code - Wed Aug 08, 2007 1:23 pm</h4>
    <div class="postbody"><span class="postbody">i'm using milkshape aswell!
<br/>
<br/>
what i do is basically: export anything to milkshape ascii and then load that into my custom tools, which in turn export what i need.
<br/>
<br/>
now, all you need to do in your export tool is:
<br/>
<br/>
- build the dl array
<br/>
- open a file in binary mode
<br/>
- write the content of your dl array into it
<br/>
- close the file
<br/>
<br/>
done. now you have your .bin.
<br/>
<br/>
as for passing pointers: i guess the other posters are right, it won't work as expected. but you can still do the trick i posted before: you know the layout of your array. so, when building the dl, you just pass the regular vertex positions (not pointers). then, when animating the mesh, you just point into the dl array and change the values.
<br/>
you could have a vertex pointer array pointing to the vertecies, then you'd only have to index them, not scan through the array or whatever. there are differnt ways of doing this.
<br/>
make sure you allways have access to the original values (of the bind pose etc.) for transformation calculations, though.
<br/>
<br/>
also note, this is just to get you started, it might be a bad solution to the problem. anyway, i hope you get the idea.
<br/>
<br/>
else i'd recommend using matices (as they seem to work). though, then i don't think you could have multiple bone influences.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#137197 - ChrisKnott - Wed Aug 08, 2007 7:55 pm</h4>
    <div class="postbody"><span class="postbody">Ah yay now I can make a .bin file!
<br/>
<br/>
I'm basically going to have the display list set out something like this...
<br/>
<br/>
__in code__
<br/>
 - Calculate the set of matrices for this frame, from interpolating two frames stored in file
<br/>
 - Save all bone matrices to matrix stack
<br/>
 - Calculate vertex positions for triangles with 2+ bones, save in list array
<br/>
<br/>
__in list__
<br/>
 - Load matrix, draw all it's triangles
<br/>
 - Repeat for all bones
<br/>
 - Draw 'joining' triangles
<br/>
<br/>
So basically there's a nice neat bit at the start of the display list, then some messy stuff at the end joining it all together.
<br/>
<br/>
I think it'll be pretty fast, I'll try it out and post results....</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#137212 - silent_code - Wed Aug 08, 2007 9:25 pm</h4>
    <div class="postbody"><span class="postbody">good luck! i hope you get some real great results (and of course post them, as you said!). :D
<br/>
<br/>
ps: any coputer i have is broken atm., so i'm kinda sitting idle all the time instead of programming...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#137259 - ChrisKnott - Thu Aug 09, 2007 5:08 pm</h4>
    <div class="postbody"><span class="postbody">Yay, got it reading off the matrices inside the display list! Should be able to get a little demo off quite soon.
<br/>
<br/>
As an aside, what is the point of setting the matrix mode to MODELVIEW? I doesn't seem to do anything differently if I lose that line...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#137417 - M3d10n - Sat Aug 11, 2007 5:52 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>ChrisKnott wrote:</b></span></td> </tr> <tr> <td class="quote">Yay, got it reading off the matrices inside the display list! Should be able to get a little demo off quite soon.
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Congrats! Don't forget to post it, I'm looking forward to it. :)
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>ChrisKnott wrote:</b></span></td> </tr> <tr> <td class="quote">As an aside, what is the point of setting the matrix mode to MODELVIEW? I doesn't seem to do anything differently if I lose that line...</td> </tr></table><span class="postbody">
<br/>
<br/>
The matrix mode actually sets which matrix stack you're working on. You only need to change it to MODELVIEW if you have it changed to something else before. The DS has 3 matrix stacks (projection, modelview and texture).</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#137716 - ChrisKnott - Tue Aug 14, 2007 10:48 pm</h4>
    <div class="postbody"><span class="postbody">Hey finally managed to get back to programming (life... tsk).
<br/>
<br/>
I've got it to the stage where I can export from Milkshape (with joints) and load it on DS, with the matrix restores in the display list.
<br/>
<br/>
This let's me animate the model, but at the moment I've only got it drawing out the triangles which are only effected by one bone.
<br/>
<br/>
What I have is a section at the end, which has all the other triangles in. I was planning on setting these values of the display list from the code, because then I could do this:
<br/>
<br/>
 - load bone matrix 1
<br/>
 - calculate and write all vertices and normals of bone 1
<br/>
 - load bone matrix 2...
<br/>
 - etc.
<br/>
<br/>
That would mean I only have to load each matrix once, but would have to do hundreds of multiplications and writes to the display list array.
<br/>
<br/>
I was just wondering whether that would be fast enough...
<br/>
<br/>
Would it actually be faster to just write hundreds of matrix restores into the original display list? I mean, there would have to be a matrix restore for possibly every single vertex, but it would mean I wouldn't have to edit the list from within the game code...
<br/>
<br/>
Lastly, if the method of editing the list is faster, I might as well do the whole thing like that, and not have ANY matrix restores in it...?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#138159 - silent_code - Mon Aug 20, 2007 12:17 pm</h4>
    <div class="postbody"><span class="postbody">you'd have to try going different ways.
<br/>
another option would be sorting vertices (and polys) into influence groups, making these groups individual displaylists and thereby getting more flexibility. you'd have more small dls, but with full control. think about it.
<br/>
<br/>
greets!</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
