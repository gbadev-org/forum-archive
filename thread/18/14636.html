<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Weird problem with structs - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>DS development > Weird problem with structs</h2>
<div id="posts">
<div class="post">
    <h4>#146661 - Echo49 - Fri Dec 07, 2007 12:06 pm</h4>
    <div class="postbody"><span class="postbody">I have a program using this struct:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">typedef struct {
<br/>
   u8 x;
<br/>
   u8 y;
<br/>
   s16 radius;
<br/>
   s16 cir;
<br/>
   u8 number;
<br/>
   disc_color color; // this is an enum of 0-3
<br/>
   bool draw;
<br/>
} disc;</td> </tr></table><span class="postbody">
<br/>
Now, I need another variable in it. However, when I try to add</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">u8 z;</td> </tr></table><span class="postbody">into it, I have to put it at the end after "draw". If I stick it anywhere else, I start getting what I believe to be memory address problems for some reason (ie. after passing pointer to a function and modifying a value, the value is modified in the function but not in the main loop). 
<br/>
<br/>
What am I doing wrong?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146662 - Tramboi - Fri Dec 07, 2007 12:14 pm</h4>
    <div class="postbody"><span class="postbody">Looks like:
<br/>
* either a rebuild problem where an obj file doesn't have an up to date definition of the struct
<br/>
* or a duplicated structure definitions that doesn't match but should.
<br/>
<br/>
Try to rebuild everything :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146665 - Mighty Max - Fri Dec 07, 2007 12:51 pm</h4>
    <div class="postbody"><span class="postbody">Access to 16bit or 32bit values have to be aligned. (on the ARM)
<br/>
<br/>
Set the alignment of struct members to 4byte to fix this problem, or presort the struct members: 4byte members before 2 byte members before single byte members
<br/>
<br/>
If you try to read an unaligned little endian 16bit value, you are actually reading the big endian 16bit value beginning from the next lower alignment.<br/>_________________<br/><a class="postlink" href="http://mightymax.org/gbamp_multiboot.html" target="_blank">GBAMP Multiboot</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146666 - Tramboi - Fri Dec 07, 2007 1:06 pm</h4>
    <div class="postbody"><span class="postbody">Are structs packed by default with libnds?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146667 - Mighty Max - Fri Dec 07, 2007 1:08 pm</h4>
    <div class="postbody"><span class="postbody">Depends on your makefile.<br/>_________________<br/><a class="postlink" href="http://mightymax.org/gbamp_multiboot.html" target="_blank">GBAMP Multiboot</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146668 - chishm - Fri Dec 07, 2007 1:09 pm</h4>
    <div class="postbody"><span class="postbody">Struct elements should be padded to the correct alignment in devkitARM. As Tramboi said, try rebuilding your project.<br/>_________________<br/><a class="postlink" href="http://chishm.drunkencoders.com" target="_blank">http://chishm.drunkencoders.com</a>
<br/>
<a class="postlink" href="http://dldi.drunkencoders.com" target="_blank">http://dldi.drunkencoders.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146701 - Echo49 - Fri Dec 07, 2007 10:21 pm</h4>
    <div class="postbody"><span class="postbody">I'd already tried a full rebuild before with no success. Rearranging the order does fix it, but interestingly the s16 values are read and written to properly no matter where they are placed in the struct. It's the bool value that's messing up the data. Do you recommend I use bool or just u8?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146702 - Lick - Fri Dec 07, 2007 10:25 pm</h4>
    <div class="postbody"><span class="postbody">Have you tried recompiling with:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#pragma pack(1)</td> </tr></table><span class="postbody"> above the struct definition?<br/>_________________<br/><a class="postlink" href="http://licklick.wordpress.com" target="_blank">http://licklick.wordpress.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146708 - Echo49 - Fri Dec 07, 2007 11:05 pm</h4>
    <div class="postbody"><span class="postbody">Neither</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#pragma pack(1)</td> </tr></table><span class="postbody">nor</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">__attribute__ ((packed))</td> </tr></table><span class="postbody">helped.</span><span class="gensmall"><br/><br/>Last edited by Echo49 on Fri Dec 07, 2007 11:07 pm; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#146709 - Lick - Fri Dec 07, 2007 11:06 pm</h4>
    <div class="postbody"><span class="postbody">pack, not packet?<br/>_________________<br/><a class="postlink" href="http://licklick.wordpress.com" target="_blank">http://licklick.wordpress.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146710 - Echo49 - Fri Dec 07, 2007 11:07 pm</h4>
    <div class="postbody"><span class="postbody">Yeah, I noticed after I posted, retested to no avail.
<br/>
<br/>
I didn't clean before I built though, I'll try that now.
<br/>
<br/>
Edit: Cleaning didn't help. I'm testing on No$gba though, not actual hardware.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146716 - Lick - Fri Dec 07, 2007 11:44 pm</h4>
    <div class="postbody"><span class="postbody">I think there's a problem somewhere else in your code.<br/>_________________<br/><a class="postlink" href="http://licklick.wordpress.com" target="_blank">http://licklick.wordpress.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146905 - SaruCoder - Tue Dec 11, 2007 1:29 am</h4>
    <div class="postbody"><span class="postbody">How many of these structs are you instantiating at run time?
<br/>
<br/>
If you're creating an array of "disc", then try putting them on the heap using </span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">discs = new disc[n];</td> </tr></table><span class="postbody">
<br/>
<br/>
instead of following which puts stuff onto the stack:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">disc discs[n];</td> </tr></table><span class="postbody">
<br/>
<br/>
If you're putting them on the stack then adding one harmless variable can cause memory issues especially if you're creating thousands of these.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146974 - Echo49 - Wed Dec 12, 2007 11:12 am</h4>
    <div class="postbody"><span class="postbody">I'm instantiating 20 of these on the stack at the moment, but I might up it to 50-100 in the final version.
<br/>
<br/>
Putting them on the heap doesn't help. For some reason the program crashes if I use </span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">disc* discs = malloc(sizeof(disc)*20);
<br/>
memset(discs, 0, sizeof(disc)*20);</td> </tr></table><span class="postbody">
<br/>
with __attribute__ ((packed)) set for the disc struct.
<br/>
<br/>
When I printf() the values of each member of the struct the values are now correct, but the 3D graphics I'm drawing with this information is messing up. Maybe it's my 3D code, but how can a simple re-ordering of the members mess up the program, even with a full rebuild?
<br/>
<br/>
Edit: to be more specific, I *think* it's my textures that are disappearing, since I'm left with white squares rather than my actual texture.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
