<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>DLDI on arm7 - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>DS development > DLDI on arm7</h2>
<div id="posts">
<div class="post">
    <h4>#145990 - knight0fdragon - Tue Nov 27, 2007 8:44 am</h4>
    <div class="postbody"><span class="postbody">ok, I am currently working on a project that relies on the fact that the arm7 does not change when another program is loaded in.
<br/>
<br/>
In order for me to do this, I would need the arm7 to be accessing the FAT, so that it can load code into the arm9 memory without ending up correcpting something.
<br/>
<br/>
Now I have tried a lot of approaches, but so far none have seemed to work, this is my latest attempt
<br/>
<br/>
I start off with a loader, contains both arm7 and arm9 with DLDI on the arm9 side
<br/>
<br/>
I take the arm9 DLDI, and I load it into VRAM_D
<br/>
<br/>
I set arm9 into a passme loop
<br/>
<br/>
now I need the arm7 to actually read the DLDI functions off of VRAM_D, instead of having to copy it over to the arm7s RAM.  Does anybody have any ideas on how I can do this?<br/>_________________<br/><a href="http://www.myspace.com/knight0fdragonds" target="_blank">http://www.myspace.com/knight0fdragonds</a>
<br/>
<br/>
MK DS FC: Dragon 330772 075464 
<br/>
AC WW FC: Anthony SamsClub 1933-3433-9458 
<br/>
MPFH: Dragon 0215 4231 1206</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#145994 - DragonMinded - Tue Nov 27, 2007 10:04 am</h4>
    <div class="postbody"><span class="postbody">I could be totally off, but wouldn't the fact that the arm7 is a different procesor type than arm9 mean that it can't actually share code?  And, if not, you would at least need to make sure the proper control registers were set.<br/>_________________<br/>Enter the mind of the dragon.
<br/>
<br/>
<a href="http://dragonminded.blogspot.com" target="_blank">http://dragonminded.blogspot.com</a>
<br/>
<br/>
Seriously guys, how hard is it to simply TRY something yourself?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#145996 - PypeBros - Tue Nov 27, 2007 10:46 am</h4>
    <div class="postbody"><span class="postbody">i have once been studying the <a class="postlink" href="http://sylvainhb.blogspot.com/2007/08/arm7-et-arm9-sont-sur-un-bateau-arm9.html" target="_blank">loader code from DSchannels</a>, where during the boot of another program, ARM9 was executing the "stub" that was located in a VRAM bank (C comes to mind).
<br/>
<br/>
That stub was doing the FAT and DLDI thing, and while it was modifying the ARM7 too, it wasn't a requirement for that method. HTH. I never heard of someone doing FAT from the ARM7 and i don't know if the ARM7 would have access to the proper bus anyway...<br/>_________________<br/><a class="postlink" href="http://sylvainhb.blogspot.com/p/sprite-editor.html" target="_blank"> SEDS: Sprite Edition on DS</a> :: <a class="postlink" href="http://sylvainhb.blogspot.com/search/label/modplayer" target="_blank">modplayer</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146001 - simonjhall - Tue Nov 27, 2007 1:32 pm</h4>
    <div class="postbody"><span class="postbody">I had a look at this a while ago (there's a thread somewhere), and it seems that libfat is a no-go for the ARM7. Were you gonna use this or just call the DLDI stuff directly?<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146004 - Lick - Tue Nov 27, 2007 4:34 pm</h4>
    <div class="postbody"><span class="postbody">I think I once copied a ARM7-compiled function that only accessed the BG_PALETTE using memcpy to main RAM. Then executed it on ARM9, and it worked!
<br/>
<br/>
Edit: more on topic: yes, you can write a ARM7 stub (not just the DLDI) that works from the VRAM. But remember that you can't initialize libfat twice using fatInitDefault, since the hardware is already initialized. You have to do some hackery (which I forgot), and AFAIK chism is the only one who've made a working stub with the current libfat.<br/>_________________<br/><a class="postlink" href="http://licklick.wordpress.com" target="_blank">http://licklick.wordpress.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146010 - thoduv - Tue Nov 27, 2007 5:51 pm</h4>
    <div class="postbody"><span class="postbody">ARM9 code won't work everytime on ARM7, there are some instructions that are new on ARM9 (such as blx, which is often used) and that will make ARM7 lock on "undefined instruction" state.
<br/>
<br/>
But as Lick wrote, ARM7 code will work on ARM9, although it can result in some memory corruption, if this code uses main memory or local ARM7 memory. That's why compiling code for both CPU would require some special linker script and you would have to remove the "arm9" option from cflags.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146012 - knight0fdragon - Tue Nov 27, 2007 6:16 pm</h4>
    <div class="postbody"><span class="postbody">well libfat does work on the arm7 from what I have seen, I just have to give the arm7 access to the ROM.  The big problem is that DLDI sucks up about a third of arm7s memory, which is why I want to place it inside of VRAM_D<br/>_________________<br/><a href="http://www.myspace.com/knight0fdragonds" target="_blank">http://www.myspace.com/knight0fdragonds</a>
<br/>
<br/>
MK DS FC: Dragon 330772 075464 
<br/>
AC WW FC: Anthony SamsClub 1933-3433-9458 
<br/>
MPFH: Dragon 0215 4231 1206</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146016 - Lazy1 - Tue Nov 27, 2007 7:21 pm</h4>
    <div class="postbody"><span class="postbody">I remember reading that the arm7 does not support the required newlib hooks for libfat to work.
<br/>
Maybe a hacked version of gba_nds_fat would be what you need.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146018 - knight0fdragon - Tue Nov 27, 2007 7:38 pm</h4>
    <div class="postbody"><span class="postbody">maybe, I dunno, I am using the hacked version that chishm used in his loader,  maybe I will just try to find a way to get his loader to reset arm9 only<br/>_________________<br/><a href="http://www.myspace.com/knight0fdragonds" target="_blank">http://www.myspace.com/knight0fdragonds</a>
<br/>
<br/>
MK DS FC: Dragon 330772 075464 
<br/>
AC WW FC: Anthony SamsClub 1933-3433-9458 
<br/>
MPFH: Dragon 0215 4231 1206</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146056 - chishm - Wed Nov 28, 2007 2:40 am</h4>
    <div class="postbody"><span class="postbody">DLDI code is compiled for the ARM7's instruction set, so it should run on either CPU. The only one I've come across that doesn't like the ARM7 is the R4 DLDI. I'm not sure of the exact reason for this. I need to investigate it further.
<br/>
<br/>
DLDI drivers can be run from any memory region that is 8-bit writeable, which includes VRAM allocated to the ARM7. You just need to patch the offsets correctly.<br/>_________________<br/><a class="postlink" href="http://chishm.drunkencoders.com" target="_blank">http://chishm.drunkencoders.com</a>
<br/>
<a class="postlink" href="http://dldi.drunkencoders.com" target="_blank">http://dldi.drunkencoders.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146060 - knight0fdragon - Wed Nov 28, 2007 3:48 am</h4>
    <div class="postbody"><span class="postbody">yeah that is what I need to know, how do I patch the offsets to the correct spots, the DLDI wiki is not exactly helpful on that part<br/>_________________<br/><a href="http://www.myspace.com/knight0fdragonds" target="_blank">http://www.myspace.com/knight0fdragonds</a>
<br/>
<br/>
MK DS FC: Dragon 330772 075464 
<br/>
AC WW FC: Anthony SamsClub 1933-3433-9458 
<br/>
MPFH: Dragon 0215 4231 1206</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146068 - knight0fdragon - Wed Nov 28, 2007 10:31 am</h4>
    <div class="postbody"><span class="postbody">ok, well I got arm7 to load stuff from the DLDI, but I did not use VRAM_D.
<br/>
The only problem with this though is that arm7 and arm9 both require DLDI, since I am not using the libfat portion, and most patchers only load up one side.  I will share my code when I clean it up a little bit for others to use<br/>_________________<br/><a href="http://www.myspace.com/knight0fdragonds" target="_blank">http://www.myspace.com/knight0fdragonds</a>
<br/>
<br/>
MK DS FC: Dragon 330772 075464 
<br/>
AC WW FC: Anthony SamsClub 1933-3433-9458 
<br/>
MPFH: Dragon 0215 4231 1206</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
