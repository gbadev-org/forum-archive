<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Timer problem... - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > Timer problem...</h2>
<div id="posts">
<div class="post">
    <h4>#174258 - relminator - Wed May 26, 2010 4:13 am</h4>
    <div class="postbody"><span class="postbody">Can anyone tell me why this code does not work?
<br/>
<br/>
Thanks!!!
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
<br/>
<br/>
#include &lt;nds.h&gt;
<br/>
#include &lt;stdio.h&gt;
<br/>
<br/>
<br/>
<br/>
<br/>
int main(void)
<br/>
{
<br/>
<br/>
   
<br/>
   //initialize the DS Dos-like functionality
<br/>
   consoleDemoInit();
<br/>
   
<br/>
   
<br/>
   //set frame buffer mode 0
<br/>
   videoSetMode(MODE_0_2D);
<br/>
 
<br/>
   timerStart(0, ClockDivider_1, 65535, NULL);
<br/>
   timerStart(1, ClockDivider_64, 65535, NULL);
<br/>
   timerStart(2, ClockDivider_256, 65535, NULL);
<br/>
   timerStart(3, ClockDivider_1024, 65535, NULL);
<br/>
   
<br/>
   while(1)
<br/>
   {
<br/>
      swiWaitForVBlank();
<br/>
      consoleClear();
<br/>
      iprintf("\x1b[1;1HTimer 0 = %i", timerElapsed(0));
<br/>
      iprintf("\x1b[3;1HTimer 1 = %i", timerElapsed(1));
<br/>
      iprintf("\x1b[5;1HTimer 2 = %i", timerElapsed(2));
<br/>
      iprintf("\x1b[7;1HTimer 3 = %i", timerElapsed(3));
<br/>
   }
<br/>
 
<br/>
   return 0;
<br/>
}
<br/>
 
<br/>
</td> </tr></table><span class="postbody"><br/>_________________<br/><a href="http://rel.betterwebber.com" target="_blank">http://rel.betterwebber.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#174260 - elhobbs - Wed May 26, 2010 5:52 am</h4>
    <div class="postbody"><span class="postbody">You cannot run TimerStart 4 times. It actually uses 2 timers each time. The one you requested as the parameter plus the next one. If you are using wifi then you can only one instance as wifi uses timer 3.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#174261 - relminator - Wed May 26, 2010 6:05 am</h4>
    <div class="postbody"><span class="postbody">Thanks but....
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
<br/>
<br/>
#include &lt;nds.h&gt;
<br/>
#include &lt;stdio.h&gt;
<br/>
<br/>
<br/>
<br/>
<br/>
int main(void)
<br/>
{
<br/>
<br/>
   
<br/>
   //initialize the DS Dos-like functionality
<br/>
   consoleDemoInit();
<br/>
   
<br/>
   
<br/>
   //set frame buffer mode 0
<br/>
   videoSetMode(MODE_0_2D);
<br/>
 
<br/>
   timerStart(0, ClockDivider_256, 65535, NULL);
<br/>
   
<br/>
   while(1)
<br/>
   {
<br/>
      swiWaitForVBlank();
<br/>
      consoleClear();
<br/>
      iprintf("\x1b[1;1HTimer 0 = %i", timerElapsed(0));
<br/>
   }
<br/>
 
<br/>
   return 0;
<br/>
}
<br/>
 
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
<br/>
Doesn't work either.<br/>_________________<br/><a href="http://rel.betterwebber.com" target="_blank">http://rel.betterwebber.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#174263 - elhobbs - Wed May 26, 2010 6:54 am</h4>
    <div class="postbody"><span class="postbody">my bad, I was thinking of cpuStartTiming.
<br/>
<br/>
I am not sure what 65535 will do as the tick parameter. I think you may want to use timerFreqToTicks_256 (or one of the other divider variants) to generate this value from a frequency.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#174265 - relminator - Wed May 26, 2010 9:26 am</h4>
    <div class="postbody"><span class="postbody">Thanks!!! I'll try that tomorrow when I get some coding time.
<br/>
<br/>
BTW, do you have an example of a timer usage that counts every second or so? I just want to profile my code.<br/>_________________<br/><a href="http://rel.betterwebber.com" target="_blank">http://rel.betterwebber.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#174266 - Pete_Lockwood - Wed May 26, 2010 10:42 am</h4>
    <div class="postbody"><span class="postbody">timerStart(1, ClockDivider_1024, 32768, fn_RunsEverySecond);<br/>_________________<br/>It's not an illusion, it just looks like one.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#174270 - relminator - Wed May 26, 2010 1:49 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Pete_Lockwood wrote:</b></span></td> </tr> <tr> <td class="quote">timerStart(1, ClockDivider_1024, 32768, fn_RunsEverySecond);</td> </tr></table><span class="postbody">
<br/>
<br/>
So I have to use a callback function to get values from the timer?<br/>_________________<br/><a href="http://rel.betterwebber.com" target="_blank">http://rel.betterwebber.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#174274 - elhobbs - Wed May 26, 2010 4:12 pm</h4>
    <div class="postbody"><span class="postbody">no, you do not need so use the callback. it looks like cpuStartTiming and cpuEndTiming may already do what you want.
<br/>
<br/>
timers work in 2 different modes - the normal mode is count down and other mode is count up. timerStart puts the timer in count down mode and that is really more suitable for scheduling a callback at a certain frequency rather than measuring time - though it is not impossible. count up mode requires two timers. take a look at the source code - the functions to look at (cpuStartTiming and cpuEndTiming) are at the bottom of this file <a class="postlink" href="http://devkitpro.svn.sourceforge.net/viewvc/devkitpro/trunk/libnds/source/common/timers.c?revision=3412&amp;view=markup" target="_blank">http://devkitpro.svn.sourceforge.net/viewvc/devkitpro/trunk/libnds/source/common/timers.c?revision=3412&amp;view=markup</a>
<br/>
<br/>
cpuStartTiming sets up a high precision timer running at 33.513982 MHz</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#174288 - Rajveer - Wed May 26, 2010 10:01 pm</h4>
    <div class="postbody"><span class="postbody">How exactly would you use timers for code profiling? I've never used timers so as a test I included timers.h and wrapped my main while loop with the following code:
<br/>
<br/>
Beginning
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">u32 timePassed;
<br/>
cpuStartTiming(0);</td> </tr></table><span class="postbody">
<br/>
<br/>
Ending
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">timePassed = cpuEndTiming();
<br/>
printf("\nTime %u", timePassed);
<br/>
while(1){}</td> </tr></table><span class="postbody">
<br/>
<br/>
and I get values ranging from 450781 to 553608 whenever I start the app and it finishes 1 cycle of the loop. Is this the number of instructions that have passed or something, and is it expected that you'd get a range of values?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#174289 - elhobbs - Wed May 26, 2010 11:06 pm</h4>
    <div class="postbody"><span class="postbody">cpuEndTiming returns the number of timer ticks that have elapsed since the timer was started. since the timer is running at 33.513982 MHz  if you divide by 33514 you will get the number of milliseconds that have elapsed. so for instance 450781/33514 = ~13ms. the other value is ~16ms. these values sound about right as at the ds display rate of 60Hz each frame is 16.66ms long.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#174290 - Rajveer - Wed May 26, 2010 11:48 pm</h4>
    <div class="postbody"><span class="postbody">Aha excellent thanks for that, about time I started profiling some of my code too. Just for testing I tried timing 100 multiplications and I got between 99 and 130. I guess I can't always expect the same value as during program execution some things aren't constant, such as memory access times e.t.c?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#174291 - elhobbs - Thu May 27, 2010 12:37 am</h4>
    <div class="postbody"><span class="postbody">no, you probably will not get the same exact value every time, cache hits etc.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#174295 - relminator - Thu May 27, 2010 1:08 am</h4>
    <div class="postbody"><span class="postbody">Thanks guys!<br/>_________________<br/><a href="http://rel.betterwebber.com" target="_blank">http://rel.betterwebber.com</a></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
