<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Extrange problem with background - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > Extrange problem with background</h2>
<div id="posts">
<div class="post">
    <h4>#105095 - Lupi - Thu Oct 05, 2006 11:11 pm</h4>
    <div class="postbody"><span class="postbody">I load two backgrounds into memory and then I assign BG0_CR and BG0_X0, BG0_Y0 as well as with BG3, it works fine in a emulator but I can't see BG0 in my DS hardware.
<br/>
<br/>
There is nothing extrange in the code, I load a background as always, if any of you have a clue, please share it, because I have no idea :S:S...
<br/>
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void LoadBG_BG(){
<br/>
   dmaCopy(BG_img_bin,(void*)BG_TILE_RAM(0), BG_img_bin_size);
<br/>
   dmaCopy(BG_map_bin,(void*)BG_MAP_RAM(8),BG_map_bin_size );
<br/>
}
<br/>
<br/>
void LoadBG_Overview(){
<br/>
   dmaCopy(Overview_img_bin,(void*)BG_TILE_RAM(2), Overview_img_bin_size);
<br/>
   dmaCopy(Overview_map_bin,(void*)BG_MAP_RAM(24),Overview_map_bin_size );
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
This is how I load both tiled bg into memory...
<br/>
<br/>
Thanks in advance</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#105100 - Dark Knight ez - Thu Oct 05, 2006 11:15 pm</h4>
    <div class="postbody"><span class="postbody">Try to use memcpy instead of dmaCopy and see if it makes a difference.
<br/>
There were many situations in DS homebrew which I created, where dmaCopy failed to work.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#105101 - Lupi - Thu Oct 05, 2006 11:25 pm</h4>
    <div class="postbody"><span class="postbody">Tried with memcpy
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void LoadBG_BG(){
<br/>
   memcpy((void*)BG_TILE_RAM(0), BG_img_bin, BG_img_bin_size);
<br/>
   memcpy((void*)BG_MAP_RAM(8), BG_map_bin, BG_map_bin_size );
<br/>
}
<br/>
<br/>
void LoadBG_Overview(){
<br/>
   memcpy((void*)BG_TILE_RAM(2), Overview_img_bin, Overview_img_bin_size);
<br/>
   memcpy((void*)BG_MAP_RAM(24),Overview_map_bin, Overview_map_bin_size );
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
same results :(
<br/>
<br/>
Maybe is in this function to inizialite video:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void IniciaVideo(){
<br/>
   vramSetMainBanks(VRAM_A_MAIN_BG_0x6000000,
<br/>
                VRAM_B_LCD,
<br/>
                VRAM_C_SUB_BG_0x6200000,
<br/>
                VRAM_D_LCD);
<br/>
<br/>
   videoSetMode(MODE_0_2D | 
<br/>
             DISPLAY_BG0_ACTIVE | DISPLAY_BG3_ACTIVE);
<br/>
   videoSetModeSub(0);
<br/>
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
I am also adding powerON(POWER_ALL_2D); at the very start
<br/>
?What can it be hapening?
<br/>
<br/>
PD: Excuse my english please :P</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#105107 - Dark Knight ez - Thu Oct 05, 2006 11:41 pm</h4>
    <div class="postbody"><span class="postbody">You do set the seperate background registers properly, right?
<br/>
Like: </span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">BG0_CR = bla;</td> </tr></table><span class="postbody">
<br/>
Where "bla" consists out of bg priority, the location of the tile base, the map base, etc.
<br/>
<br/>
edit:
<br/>
For "bla" I have the following for example:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">BG_PRIORITY_0 | BG_TILE_BASE(1) | BG_MOSAIC_OFF | BG_256_COLOR | BG_MAP_BASE(29) | BG_WRAP_ON | BG_32x32</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#105108 - Lupi - Fri Oct 06, 2006 12:00 am</h4>
    <div class="postbody"><span class="postbody">I don't do exactly that way...
<br/>
<br/>
I'm doing a Background class to manage easily all the registers, here is a piece of the constructor:
<br/>
<br/>
<a href="http://rafb.net/paste/results/DsnBJn64.html" target="_blank">http://rafb.net/paste/results/DsnBJn64.html</a>
<br/>
<br/>
Once I have the constructor, I put this code, one is the third background (the one being visible) and the Zero is the one I can't see in <span style="text-decoration: underline">hardware</span>, I can see it in a emu
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">Background BGThird (0,3,0,0,0,8,0,3,1);
<br/>
   Background BGZero (0,0,0,0,2,24,0,0,1);</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#105129 - PypeBros - Fri Oct 06, 2006 8:17 am</h4>
    <div class="postbody"><span class="postbody">from previous experiments, emulators aren't very concerned by the actual mappings you're doing, e.g. if you don't map MAIN_BG to anything and still write to MAIN_BG, they will live fine with that.
<br/>
<br/>
The hardware _needs_ the VRAM_A_0x6xxx things to know what physical memory should appear when you read/write to MAIN_BG ...<br/>_________________<br/><a class="postlink" href="http://sylvainhb.blogspot.com/p/sprite-editor.html" target="_blank"> SEDS: Sprite Edition on DS</a> :: <a class="postlink" href="http://sylvainhb.blogspot.com/search/label/modplayer" target="_blank">modplayer</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#105131 - Lupi - Fri Oct 06, 2006 9:00 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>PypeBros wrote:</b></span></td> </tr> <tr> <td class="quote">from previous experiments, emulators aren't very concerned by the actual mappings you're doing, e.g. if you don't map MAIN_BG to anything and still write to MAIN_BG, they will live fine with that.
<br/>
<br/>
The hardware _needs_ the VRAM_A_0x6xxx things to know what physical memory should appear when you read/write to MAIN_BG ...</td> </tr></table><span class="postbody">
<br/>
<br/>
Sorry, but I don't what you are trying to say me
<br/>
If you mean VRAM banks aren't assigned, then I think you are wrong, I'm assigning them
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">vramSetMainBanks(VRAM_A_MAIN_BG_0x6000000,
<br/>
                VRAM_B_LCD,
<br/>
                VRAM_C_SUB_BG_0x6200000,
<br/>
                VRAM_D_LCD);</td> </tr></table><span class="postbody">
<br/>
<br/>
If you mean something totally different, mapping the background, I don't have a clue of what is that or how is it done :P
<br/>
Thanks anyway, I'm a bit new to this :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#105132 - Dark Knight ez - Fri Oct 06, 2006 9:38 am</h4>
    <div class="postbody"><span class="postbody">I'm surprised you created an entire function for it. Seems a bit unnecessary.
<br/>
I'm not sure if background registers can be read, by the way.
<br/>
This for example: </span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">BG0_CR |= BG_PRIORITY(BG_PRIOR);</td> </tr></table><span class="postbody">
<br/>
Is basicly the same as this: </span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">BG0_CR = BG0_CR | BG_PRIORITY(BG_PRIOR);</td> </tr></table><span class="postbody">
<br/>
<span style="font-weight: bold">If</span> access to the background registers are write-only (and thus cannot be read), the effect would probably end up to be this: </span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">BG0_CR = 0 | BG_PRIORITY(BG_PRIOR);
<br/>
or
<br/>
BG0_CR = BG_PRIORITY(BG_PRIOR);</td> </tr></table><span class="postbody">
<br/>
<br/>
Do note that I myself don't know if the registers are write-only. I have never needed to read from them myself.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#105151 - PypeBros - Fri Oct 06, 2006 12:58 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Dark Knight ez wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
I'm not sure if background registers can be read
<br/>
Do note that I myself don't know if the registers are write-only. I have never needed to read from them myself.</td> </tr></table><span class="postbody">
<br/>
<br/>
just checked gbatek (http://nocash.emubase.de/gbatek.htm#lcdiobgcontrol), BG0_CR and friends are R/W. On the other side, registers related to scrolling/rotating are R-O.<br/>_________________<br/><a class="postlink" href="http://sylvainhb.blogspot.com/p/sprite-editor.html" target="_blank"> SEDS: Sprite Edition on DS</a> :: <a class="postlink" href="http://sylvainhb.blogspot.com/search/label/modplayer" target="_blank">modplayer</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#105173 - Lupi - Fri Oct 06, 2006 3:49 pm</h4>
    <div class="postbody"><span class="postbody">Nothing... I have tried without using |= but using Bg0_CR = BG0_CR | blablabla
<br/>
<br/>
Still it will work on Dualis but not in real hardware.
<br/>
<br/>
I have also tried expanding MAIN_BG VRAM to Banks A and B, same results
<br/>
<br/>
Here is my code, it has very few lines:
<br/>
<a href="http://www.megaupload.com/es/?d=WU0P9P5L" target="_blank">http://www.megaupload.com/es/?d=WU0P9P5L</a>
<br/>
<br/>
The class Background is incomplete, some of the member functions still don't use sub-screen.
<br/>
<br/>
I wanted to do it that way because I want easy management of the background bits and setup, and in my game I will need lots, lots of different backgrounds and tiles.
<br/>
<br/>
Thanks for your help :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#105200 - Sausage Boy - Fri Oct 06, 2006 6:03 pm</h4>
    <div class="postbody"><span class="postbody">Works fine on hardware for me. I suspect the problem is that your bootloader sets some register to something, and you're not resetting it (to 0, most likely).
<br/>
<br/>
I didn't look too much in your code, but does it set the BGx_XDX, XDY, YDX and YDY as seen in the 16bit_color_bmp demo?<br/>_________________<br/>"no offense, but this is the gayest game ever"</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#105215 - Lupi - Fri Oct 06, 2006 8:09 pm</h4>
    <div class="postbody"><span class="postbody">Ok, you were right, I tried putting this after everything:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">   BG0_CR = 0;
<br/>
   BG1_CR = 0;
<br/>
   BG2_CR = 0;
<br/>
   BG3_CR = 0;
<br/>
   SUB_BG0_CR = 0;
<br/>
   SUB_BG1_CR = 0;
<br/>
   SUB_BG2_CR = 0;
<br/>
   SUB_BG3_CR = 0;</td> </tr></table><span class="postbody">
<br/>
<br/>
And now it works :)
<br/>
<br/>
Sorry for the time wasted and thanks :D</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
