<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Using fatMountCustomInterface? - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > Using fatMountCustomInterface?</h2>
<div id="posts">
<div class="post">
    <h4>#117645 - cj - Tue Feb 06, 2007 8:47 am</h4>
    <div class="postbody"><span class="postbody">I'm developing a DLDI driver and need to output some debugging messages. I figure the best way to do so is to link in the driver instead of patching it. After digging around the source code of libfat, I was able to put this together:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">    extern const devoptab_t dotab_fat;
<br/>
    char nm[] = "X9SD";
<br/>
<br/>
    IO_INTERFACE fatIf;
<br/>
    fatIf.ioType =   *((uint32*)nm);
<br/>
    fatIf.features = FEATURE_MEDIUM_CANREAD | FEATURE_MEDIUM_CANWRITE | FEATURE_SLOT_NDS;
<br/>
    fatIf.fn_startup      = &amp;_X9SD_startup;
<br/>
    fatIf.fn_isInserted   = &amp;_X9SD_isInserted;
<br/>
    fatIf.fn_readSectors  = &amp;_X9SD_readSectors;
<br/>
    fatIf.fn_writeSectors = &amp;_X9SD_writeSectors;
<br/>
    fatIf.fn_clearStatus  = &amp;_X9SD_clearStatus;
<br/>
    fatIf.fn_shutdown     = &amp;_X9SD_shutdown;
<br/>
<br/>
    fatIf.fn_startup();
<br/>
    fatMountCustomInterface(&amp;fatIf, 8);
<br/>
    fatSetDefaultInterface(PI_CUSTOM);
<br/>
    AddDevice(&amp;dotab_fat);
<br/>
    chdir ("fat:/");</td> </tr></table><span class="postbody">
<br/>
<br/>
However, when I print a directory-listing, is freezes after displaying about 4 entries (with or without debugging messages). In contrast, when I patch in the driver, it does not freeze. I've verified that it is not freezing in my driver -- during the directory listing, it reads one block, prints some files, then freezes somewhere in a call to dirnext().
<br/>
<br/>
First, am I setting up the driver correctly? If so, then any ideas what may be going on? The only thing I can figure is that my driver is corrupting memory and the bug is only manifesting when linked in directly.
<br/>
<br/>
<br/>
Thanks for your time!
<br/>
-CJ</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#117648 - chishm - Tue Feb 06, 2007 10:35 am</h4>
    <div class="postbody"><span class="postbody">To be honest, you're the first person to try using fatMountCustomInterface(). It isn't even complete (as you are probably aware). Perhaps you should try just building the libfat sources with your driver embedded (and set as the first one).<br/>_________________<br/><a class="postlink" href="http://chishm.drunkencoders.com" target="_blank">http://chishm.drunkencoders.com</a>
<br/>
<a class="postlink" href="http://dldi.drunkencoders.com" target="_blank">http://dldi.drunkencoders.com</a></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
