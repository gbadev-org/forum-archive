<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Touchscreen accuracy... again - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > Touchscreen accuracy... again</h2>
<div id="posts">
<div class="post">
    <h4>#65475 - MatLeOuf - Tue Jan 03, 2006 4:00 pm</h4>
    <div class="postbody"><span class="postbody">Hi all!
<br/>
<br/>
my first post will concern the recurrent problem seen on this forum (and others) : the DS touchscreen accuracy with homebrew.
<br/>
At home we've got two DS, bought at the same time, when they were released in France. On mine, the homebrew games using touchscreen are mostly unusable because of a very unaccurate touchscreen coordinates (particularly on the borders), whereas on my brother one everything works perfectly.
<br/>
Some facts first : both DS have the same screen protector, both works perfectly in commercial games, mine is flashed with V5, the other one isn't flashed at all.
<br/>
<br/>
I've decided to search what can be the cause, and I've found something interesting : the PersonalData-&gt;calX1, X2, Y1, Y2 are really not the same on the 2 DS, whereas PersonalData-&gt;calX1px,... are exactly the same. The figures follow:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">on my DS           : X1,Y1 = 624,720 | X2,Y2 = 3360,3212
<br/>
on my brother's DS : X1,Y1 = 688,832 | X2,Y2 = 3352,3328</td> </tr></table><span class="postbody">
<br/>
I've tried to put manually the "good" figures in the arm7/touch.c code of libnds, but it didn't do anything (I used the code of the TouchTest example for my purpose)...
<br/>
<br/>
I'm really new to DS programming (but not new to programming in general), so I've a lot of others things to learn, but this touchscreen problem is really annoying and I'd like very much to see a solution for it.
<br/>
If anyone got ideas, I've got both "good" and "bad" DS at home to try things!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#65481 - Maverick - Tue Jan 03, 2006 5:10 pm</h4>
    <div class="postbody"><span class="postbody"><br/>_________________<br/><a href="http://downtou.ne1.net/" target="_blank">http://downtou.ne1.net/</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#65499 - MatLeOuf - Tue Jan 03, 2006 6:14 pm</h4>
    <div class="postbody"><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#65604 - Maverick - Wed Jan 04, 2006 9:28 am</h4>
    <div class="postbody"><span class="postbody">Thats strange, it works perfectly on my GBAMP, and through wifime, i havent tried it on a flash cart.
<br/>
<br/>
What exactly happens?<br/>_________________<br/><a href="http://downtou.ne1.net/" target="_blank">http://downtou.ne1.net/</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#65615 - pepsiman - Wed Jan 04, 2006 12:07 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>MatLeOuf wrote:</b></span></td> </tr> <tr> <td class="quote">I would be glad to do that, but this soft don't work on my M3...</td> </tr></table><span class="postbody">
<br/>
This NDS file doesn't have a built in loader, so you'll need to add one.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#65616 - MatLeOuf - Wed Jan 04, 2006 12:09 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Maverick wrote:</b></span></td> </tr> <tr> <td class="quote">Thats strange, it works perfectly on my GBAMP, and through wifime, i havent tried it on a flash cart.
<br/>
<br/>
What exactly happens?</td> </tr></table><span class="postbody">Nothing at all :) Just 2 black screens. But it happens regularly with homebrew, I think there's something to add when you  want your soft to work on M3 (in the arm9 code): </span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">powerON(POWER_ALL);</td> </tr></table><span class="postbody"> (<a class="postlink" href="http://forum.gbadev.org/viewtopic.php?t=7723" target="_blank">http://forum.gbadev.org/viewtopic.php?t=7723</a>).</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#65662 - Maverick - Wed Jan 04, 2006 9:48 pm</h4>
    <div class="postbody"><span class="postbody">If it displays one white screen, one black, then that is what it is meant to do<br/>_________________<br/><a href="http://downtou.ne1.net/" target="_blank">http://downtou.ne1.net/</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#65753 - MatLeOuf - Thu Jan 05, 2006 2:20 pm</h4>
    <div class="postbody"><span class="postbody">No, it's really just two black screens, it needs to be recompiled with powerON(POWER_ALL); in the arm9 code (something you don't do on the other sources I've seen on your site) to work on the M3.
<br/>
If you send me the source code I can do it, it's no problem :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#65785 - pepsiman - Thu Jan 05, 2006 6:39 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>MatLeOuf wrote:</b></span></td> </tr> <tr> <td class="quote">No, it's really just two black screens, it needs to be recompiled with powerON(POWER_ALL); in the arm9 code (something you don't do on the other sources I've seen on your site) to work on the M3.
<br/>
If you send me the source code I can do it, it's no problem :)</td> </tr></table><span class="postbody">
<br/>
It does have powerON() - it works on my G6.
<br/>
It doesn't have a built in NDS loader - YOU need to add one.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#65793 - MatLeOuf - Thu Jan 05, 2006 7:54 pm</h4>
    <div class="postbody"><span class="postbody">Thanks for the loader tip, I didn't know that some homebrew needed one to function, still a newbie in that field :)
<br/>
Anyway, the soft works now, and I've been able to take pictures of it on both DS : 
<br/>
<a class="postlink" href="http://img276.imageshack.us/my.php?image=dsc000282es.jpg" target="_blank">My brother DS </a>
<br/>
<a class="postlink" href="http://img276.imageshack.us/my.php?image=dsc000305pj.jpg" target="_blank">My DS</a>
<br/>
I tried to do the same thing on both and, as you can see, the result on my DS is really strange, and it explains why I'm mainly unable to use touchscreen only homebrew on it...
<br/>
And I'm probably not the only one with this problem out there!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#65815 - dovoto - Thu Jan 05, 2006 9:57 pm</h4>
    <div class="postbody"><span class="postbody">I got this from someone and I wont have time to investigate it for the next few days. It is code created by stepping through an official DS game (meteos i think). If someone has time to verify it and clean it up maybe we can figure out why our code is accurate for some but not for otheres.
<br/>
<a class="postlink" href="http://www.drunkencoders.com/demos/DS/TouchTest4.rar" target="_blank">http://www.drunkencoders.com/demos/DS/TouchTest4.rar</a><br/>_________________<br/><a href="http://www.drunkencoders.com" target="_blank">www.drunkencoders.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#65818 - MatLeOuf - Thu Jan 05, 2006 10:43 pm</h4>
    <div class="postbody"><span class="postbody">I didn't look at the code yet (just compiled it), but the touchpad result isn't accurate for me. It seems to be better, but I still can't go nowhere near the top left corner...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#65819 - dovoto - Thu Jan 05, 2006 10:57 pm</h4>
    <div class="postbody"><span class="postbody">but does it work accuratly for you on official games?<br/>_________________<br/><a href="http://www.drunkencoders.com" target="_blank">www.drunkencoders.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#65823 - tepples - Thu Jan 05, 2006 11:19 pm</h4>
    <div class="postbody"><span class="postbody">Do official games go near the corners?<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#65826 - Alex Atkin UK - Thu Jan 05, 2006 11:28 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Some facts first : both DS have the same screen protector, <span style="font-weight: bold">both works perfectly in commercial games</span>, mine is flashed with V5, the other one isn't flashed at all. </td> </tr></table><span class="postbody"><br/>_________________<br/><a class="postlink" href="http://csdclubs.com/club?cid=15" target="_blank"></a><a href="http://csdprojects.co.uk/banners/linuxusers.png">[Images not permitted - Click here to view it]</a>
<br/>
<br/>
<a class="postlink" href="http://csdclubs.com/club?cid=4" target="_blank"></a><a href="http://csdprojects.co.uk/banners/segagaming.png">[Images not permitted - Click here to view it]</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#65834 - MatLeOuf - Fri Jan 06, 2006 12:34 am</h4>
    <div class="postbody"><span class="postbody">Thanks Alex Atkin, I can add that I play Meteos with no <b style="color:#FFA34F">touchscreen</b> <b style="color:#FFA34F">accuracy</b> problem at all (it might suffice to prove it ;)).
<br/>
Both DS have originally a NDSv2 firmware (viewed vith FlashMe V6). 
<br/>
I looked quickly at the TouchTest4 code and I don't think I'll be able to clean it up myself, way too complicated for me, but I'm ready to do all the needed tests to end up with a correctly calibrated <b style="color:#FFA34F">touchscreen</b> on homebrews...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#65845 - wintermute - Fri Jan 06, 2006 2:59 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tepples wrote:</b></span></td> </tr> <tr> <td class="quote">Do official games go near the corners?</td> </tr></table><span class="postbody">
<br/>
<br/>
The only one I've seen so far which makes use of the entire <b style="color:#FFA34F">touchscreen</b> is Pac Pix. It works well on both of my DSes but then, so does the homebrew code :/</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#65847 - Sintax - Fri Jan 06, 2006 3:30 am</h4>
    <div class="postbody"><span class="postbody">Animal Crossing has a button in the extreme upper right which opens/closes the menu. So I figured they don't have problems with screen touches not registering at the edges if they put such an important button there.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#65848 - majincline - Fri Jan 06, 2006 3:32 am</h4>
    <div class="postbody"><span class="postbody">Ok....I've known something was funky about my touch screen but i didnt know it was this serious....this test program really helps see what data is being used by the homebrew.
<br/>
<br/>
My problem:
<br/>
Every time te screen is touched the first parts that register are grossly wrong....they are shifted to the bottom-left corner but then return to the place they should be...this also occurs when letting go and that causes problems. It's like theres something pressing on the screen down there but it only happens in homebrew. I have a video of this behavior because I figure it cant hurt to give a bit too much info. I have also noticed that the top is dificult to press(just the fist couple millimeters) but thats no biggie, and I think comercial games do it to me too.
<br/>
<br/>
Finally uploaded: I really hope these <b style="color:#FFA34F">touchscreen</b> problems can be solved, they've plagued homebrew long enough
<br/>
<a class="postlink" href="http://media.putfile.com/touchscreen18" target="_blank">http://media.putfile.com/touchscreen18</a></span><span class="gensmall"><br/><br/>Last edited by majincline on Fri Jan 06, 2006 8:56 pm; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#65873 - MatLeOuf - Fri Jan 06, 2006 11:39 am</h4>
    <div class="postbody"><span class="postbody">For your information, here are the values I obtain with the TouchTest4 soft:
<br/>
(min_px,min_py) = (24,6)
<br/>
(min_x,min_y) = (512,232) (those values changes with each launch of the program but not much)
<br/>
(max_x,max_y) = (3424,3736) (same thing, values changing a bit)
<br/>
(max_px,max_py) = (228,186)
<br/>
<br/>
Hope this can help...
<br/>
I also made a little video of the app running, so you can see the "disaster" ;)
<br/>
<a class="postlink" href="http://matthieu.montaudouin.free.fr/touchtest.avi" target="_blank">The video.</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#65914 - duencil - Fri Jan 06, 2006 8:21 pm</h4>
    <div class="postbody"><span class="postbody">I've always had problems with readings around the edges of my <b style="color:#FFA34F">touchscreen</b> too.  I've been playing with the test app dovoto posted - from what I've seen its built from decompiling the meteos arm9 executable, doing the <b style="color:#FFA34F">touchscreen</b> coordinates conversion to pixel coordinates on that processor instead of on the arm7 as we have it in libnds, and using a fairly cryptic algorithm which gives results very similar ( I think at most a pixel off ) from those using the method natrium posted here some months ago, and the method wintermute impliments in current libnds.
<br/>
<br/>
For my DS at least the problem was always in the original <b style="color:#FFA34F">touchscreen</b> coordinate readings, that would be off around the corners, rather than in the pixel coordinate conversion.  I think I've managed to solve that problem now.  It seems that just before taking a reading with TSC_MEASURE_X or TSC_MEASURE_Y, the hardware should be prepared calling touchRead(TSC_MEASURE_X | 1) or touchRead(TSC_MEASURE_Y | 1) repectively, ignoring the return value.
<br/>
 If you've downloaded dovoto's <b style="color:#FFA34F">touchscreen</b> app, change the following lines in arm7.cpp:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">x = touchRead(TSC_MEASURE_X | 1);//tempPos.x;
<br/>
y = touchRead(TSC_MEASURE_Y | 1);//tempPos.y;</td> </tr></table><span class="postbody">
<br/>
for
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">touchRead(TSC_MEASURE_X|1);
<br/>
x = touchRead(TSC_MEASURE_X);
<br/>
touchRead(TSC_MEASURE_Y|1);
<br/>
y = touchRead(TSC_MEASURE_Y);</td> </tr></table><span class="postbody">
<br/>
Personally I'd prefer to call the libnds touchReadXY() function, and impliment the changes in the reading there, and just use the pixel cooordinate conversion performed there unless we see a reason to follow the meteos method.  In that function there is already an average of the median readings performed which should also help prevent the kind of spurious contact readings majincline mentions.
<br/>
<br/>
So for making the equivalent change in libnds in touch.c I modify the lines:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">for ( i=0; i&lt;3; i++) {
<br/>
   x[i] =  touchRead(TSC_MEASURE_X | 1);
<br/>
   y[i] =  touchRead(TSC_MEASURE_Y | 1);
<br/>
}
<br/>
   
<br/>
x[3] =  touchRead(TSC_MEASURE_X);
<br/>
y[3] =  touchRead(TSC_MEASURE_Y);</td> </tr></table><span class="postbody">
<br/>
with:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">for ( i=0; i&lt;4; i++) {
<br/>
   touchRead(TSC_MEASURE_X | 1);
<br/>
   x[i] = touchRead(TSC_MEASURE_X);
<br/>
   touchRead(TSC_MEASURE_Y | 1);
<br/>
   y[i] = touchRead(TSC_MEASURE_Y);
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Hope that helps.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#66003 - MatLeOuf - Sat Jan 07, 2006 2:41 pm</h4>
    <div class="postbody"><span class="postbody">Whoa! This is MUCH better! Still not perfect ((min_px,min_py) = (7,7), (max_px,max_py) = (249,189)), but at least the ball follows my stylus!
<br/>
I've just been able to make the changes in the source of the app, when I looked into libnds source (the latest libnds 20052812), there was no such line in arm7/touch.c
<br/>
Anyway, the modified software works a lot better on my DS, and works still flawlessly on the other. So I think someone should modify the libnds to take into account this modifcation (that I've been unable to apply to the latest version, but I'm no expert in that field :)).</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#66004 - wintermute - Sat Jan 07, 2006 2:51 pm</h4>
    <div class="postbody"><span class="postbody">you sure you looked at arm7/touch.c &amp; not arm9/touch.c ?
<br/>
<br/>
did this modification fix that bendiness you had?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#66005 - MatLeOuf - Sat Jan 07, 2006 3:06 pm</h4>
    <div class="postbody"><span class="postbody">Yup, looked in arm7/touch.c, here's the source I've got :
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">touchPosition touchReadXY() {
<br/>
<br/>
   touchPosition touchPos;
<br/>
<br/>
   if ( !touchInit ) {
<br/>
<br/>
      xscale = ((PersonalData-&gt;calX2px - PersonalData-&gt;calX1px) &lt;&lt; 16) / ((PersonalData-&gt;calX2 &amp; -8) - (PersonalData-&gt;calX1 &amp; -8));
<br/>
      yscale = ((PersonalData-&gt;calY2px - PersonalData-&gt;calY1px) &lt;&lt; 16) / ((PersonalData-&gt;calY2 &amp; -8) - (PersonalData-&gt;calY1 &amp; -8));
<br/>
<br/>
      xoffset = (PersonalData-&gt;calX1 &amp; -8) * xscale - (PersonalData-&gt;calX1px &lt;&lt; 16);
<br/>
      yoffset = (PersonalData-&gt;calY1 &amp; -8) * yscale - (PersonalData-&gt;calY1px &lt;&lt; 16);
<br/>
      
<br/>
      touchInit = true;
<br/>
<br/>
   }
<br/>
<br/>
   touchPos.x = touchRead(TSC_MEASURE_X) &amp; -8;
<br/>
   touchPos.y = touchRead(TSC_MEASURE_Y) &amp; -8;
<br/>
<br/>
   s16 px = ( touchPos.x * xscale - xoffset + xscale/2 ) &gt;&gt;16;
<br/>
   s16 py = ( touchPos.y * yscale - yoffset + yscale/2 ) &gt;&gt;16;
<br/>
<br/>
   if ( px &lt; 0) px = 0;
<br/>
   if ( py &lt; 0) py = 0;
<br/>
   if ( px &gt; (SCREEN_WIDTH -1)) px = SCREEN_WIDTH -1;
<br/>
   if ( py &gt; (SCREEN_HEIGHT -1)) px = SCREEN_HEIGHT -1;
<br/>
<br/>
   touchPos.px = px;
<br/>
   touchPos.py = py;
<br/>
<br/>
   return touchPos;
<br/>
<br/>
}</td> </tr></table><span class="postbody">
<br/>
So I see nothing near what duencil modifies.
<br/>
<br/>
Concerning the bending, I can still see it on the sides, but I've got to look at the coordonates figures. I'll say the x coordinates on the left side goes from 7 to 13, 13 being attained near the center of the left side. But anyway it's, as I said, MUCH better than before that modifcation!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#67409 - Nphinity - Tue Jan 17, 2006 8:29 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>MatLeOuf wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">   touchPos.x = touchRead(TSC_MEASURE_X) &amp; -8;
<br/>
   touchPos.y = touchRead(TSC_MEASURE_Y) &amp; -8;</td> </tr></table><span class="postbody">
<br/>
So I see nothing near what duencil modifies.</span></td> </tr></table><span class="postbody">
<br/>
<br/>
Ookay I have not even compiled a single NDS or GBA app ever, however, due to the buggyness I've noticed in coord on homebrew, I was intrested in the thread.
<br/>
<br/>
Anyway, despite my lack of knowledge on the subjuct, I beleive the above lines of code(taken from the code MatLeOuf posted) are the particular lines of code to change, likely should end up looking something like:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">   touchRead(TSC_MEASURE_X | 1);
<br/>
   touchPos.x = touchRead(TSC_MEASURE_X) &amp; -8;
<br/>
   touchRead(TSC_MEASURE_Y | 1);
<br/>
   touchPos.y = touchRead(TSC_MEASURE_Y) &amp; -8;</td> </tr></table><span class="postbody">
<br/>
<br/>
Though, I don't know why the code you two are looking at would be soo different.
<br/>
<br/>
<br/>
I also find the origional code in touch.c that duencil had posted to be very highly suspicious.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">for ( i=0; i&lt;3; i++) {
<br/>
   x[i] =  touchRead(TSC_MEASURE_X | 1);
<br/>
   y[i] =  touchRead(TSC_MEASURE_Y | 1);
<br/>
}
<br/>
   
<br/>
x[3] =  touchRead(TSC_MEASURE_X);
<br/>
y[3] =  touchRead(TSC_MEASURE_Y);</td> </tr></table><span class="postbody">
<br/>
<br/>
What this code does is fill the first 3 results with the | 1 version of the read.  And the final 4th result with a normal read.
<br/>
<br/>
One would assume these numbers are later averaged, and it is no wonder that this would produce inaccurate results, as its averaging two different types of numbers.
<br/>
<br/>
Obviously that can't be right.
<br/>
<br/>
But the question for me is, what is actually right about the replaced code that duencil provided.
<br/>
<br/>
His code fills all 4 results in the array with normal read values.  But also before each read, an | 1 is executed.
<br/>
<br/>
I am curious as to what would happen if you didn't execute the | 1 first.  Since the origional code was comparing apples and oranges, if you just filled all the results with oranges, that may be what fixes the problem.
<br/>
<br/>
Then again, I really dunno this stuff.  Cause it may very well be the | 1 does as is said here, and prepares for a proper read.
<br/>
<br/>
Anyway it goes, hopefully you can get wintermute in on the conversation, ask why he did the 3 | 1's followed by the normal read, he may have had some reason, and of course share your finding.
<br/>
<br/>
I really hope to see a fix implemented in libnds and all the homebrew recompiled(especially WinDS) to use it.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#67453 - HyperHacker - Wed Jan 18, 2006 6:28 am</h4>
    <div class="postbody"><span class="postbody">I've noticed a similar problem in both my programs and others. The touch screen works but every now and then you get some random hit way off from where you touched. For example when using an onscreen keyboard, you hit one key (or even a part of the screen without any keyboard on it) and it registers as hitting some other key. Also when simply drawing a pixel at each touched point occasionally a pixel will appear far from where the screen is being touched. This seems to be most common if you just tap really quick (never seen it while dragging), and I have yet to see it in a commercial game.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#67520 - Sausage Boy - Wed Jan 18, 2006 8:29 pm</h4>
    <div class="postbody"><span class="postbody">Do you use any form of screen protection? I used to have similar issues with homebrew, but removing the plastic from the screen fixed it. Not a nice solution of course, since it works with commercial games we're obviously doing something wrong, but it's nice to be able to enjoy the homebrew properly.<br/>_________________<br/>"no offense, but this is the gayest game ever"</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#67540 - Snuk the Great - Wed Jan 18, 2006 10:01 pm</h4>
    <div class="postbody"><span class="postbody">Hmm, I was quite interested to see how the 'commercial positioning' worked on my DS and I found that  the positioning left/right is oke. But top/bottom is not. It seems that if I am hiting my ds with my styles with a 90degree angle (thats including my eye position :P) it is off about 2mm.
<br/>
<br/>
Now I wonder. If this info is stored in your firmware isn't it possible to make a nds app that can redifine these settings? Just by simply asking for users to give input from the upper right position of their touch screen and then let them give input from there lower left side of the screen. Maybe add a visual aspect like 'touch the red square'.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#67590 - HyperHacker - Thu Jan 19, 2006 5:34 am</h4>
    <div class="postbody"><span class="postbody">Possible, yes, but then wouldn't that interfere with commercial games?
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Sausage Boy wrote:</b></span></td> </tr> <tr> <td class="quote">Do you use any form of screen protection?</td> </tr></table><span class="postbody">Nope.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#67654 - Snuk the Great - Thu Jan 19, 2006 8:09 pm</h4>
    <div class="postbody"><span class="postbody">Hmm, oke this is kind of odd. I figured something else today. I found that the positioning on WinDS is accurate while my Advanced Wars DS (European version) is not. The 2mm off was with AW.
<br/>
<br/>
*booting DS testing other stuff*
<br/>
<br/>
Oke lol, there is a callibration tool build in in the DS firmware already :P. Just used it and I will test AW with it again, so hang in there :P
<br/>
<br/>
Oke, AW is accurate now as well, now I wonder if WinDS is still accurate...
<br/>
<br/>
Oke, I dont get it every app responds differently when it comes to the onscrean possitioning. Atleast the homebrew does... Isnt there just one lib you guys use?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#67694 - Tobin - Thu Jan 19, 2006 10:54 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>HyperHacker wrote:</b></span></td> </tr> <tr> <td class="quote">I've noticed a similar problem in both my programs and others. The touch screen works but every now and then you get some random hit way off from where you touched. For example when using an onscreen keyboard, you hit one key (or even a part of the screen without any keyboard on it) and it registers as hitting some other key. Also when simply drawing a pixel at each touched point occasionally a pixel will appear far from where the screen is being touched. This seems to be most common if you just tap really quick (never seen it while dragging), and I have yet to see it in a commercial game.</td> </tr></table><span class="postbody">
<br/>
I am wondering why this problem is not solved already. A few weeks ago I posted my touchscreen code that I use for DSChess (<a class="postlink" href="http://forum.gbadev.org/viewtopic.php?t=7256" target="_blank">http://forum.gbadev.org/viewtopic.php?t=7256</a>). Maybe it is not the best solution, but for me it really works very well. 
<br/>
The trick is, not to take the first one or two inputs after the pen hits or leaves the key. Then you have no problems with jumping positions.
<br/>
<br/>
Hope we can find a good working solution soon.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#67759 - HyperHacker - Fri Jan 20, 2006 3:33 am</h4>
    <div class="postbody"><span class="postbody">Actually, that makes quite a bit of sense. You had to do the same with the original Game Boy, as the first few reads from the button status registers were unpredictable due to contact bounce. (As you press the button and the two contacts come closer together, electricity will sometimes jump between them and not other times, so until the button is fully depressed, you would get erratic results.) You'd generally just do something like this (in Z80 ASM):
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">ld a,(REG_KEYS)
<br/>
ld a,(REG_KEYS)
<br/>
ld a,(REG_KEYS)
<br/>
ld a,(REG_KEYS)
<br/>
ld a,(REG_KEYS)
<br/>
ld (KeyStatus),a</td> </tr></table><span class="postbody">
<br/>
<br/>
The same sort of problem is probably present here. I've noticed similar with the temperature (with mine, if it's ~20?C, it'll constantly jump between 19 and 21), and that's related to the touch screen, so it's probably the same problem.
<br/>
<br/>
My own code, using NDSlib, actually seems to work almost perfect if I just call touchReadXY() on ARM7, then wait for vblank, in a loop. I discard the very first read each time the screen is touched, as I use my own button-reading code which (like NDSLib's) has one variable for buttons that were just pressed this frame, and one for those that have been held for at least 2 frames. Since the code that handles touching (on ARM9) only checks the touch bit in the 'keys held' variable, it ignores the first touch (where the bit would be set in 'keys pressed' instead), and gives very accurate results, but on very rare occasions it will read some arbitrary other position when I just poke it quickly. If I don't discard the first read, this happens slightly more often. (I haven't tried it on any other DS though.) However, other people's programs such as Moonshell and TxtWriter suffer quite a bit from this. In Moonshell, window dragging often wigs out (the windows jump around), and TxtWriter seems to have the same occasional-incorrect-position bug as mine (when I don't discard the first input) but also, about 30 pixels on the left never register as touched. All commercial games seem to work fine, though.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#67788 - agentq - Fri Jan 20, 2006 11:07 am</h4>
    <div class="postbody"><span class="postbody">ScummVM also ignores the pen inputs for the first frame it's pressed, and this corrects the jumping around problem nearly completely.  It seems the way you touch the screen makes a major difference, if you touch the screen really lightly it's more likely to happen, while if you make firm contact with the screeen it happens less.  The James Bond FPS game on the DS suffers from this problem a lot.
<br/>
<br/>
However, there is still an accuracy issue separate to this.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#67815 - ghazi - Fri Jan 20, 2006 5:07 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Do you use any form of screen protection? I used to have similar issues with homebrew, but removing the plastic from the screen fixed it. Not a nice solution of course, since it works with commercial games we're obviously doing something wrong, but it's nice to be able to enjoy the homebrew properly.</td> </tr></table><span class="postbody">
<br/>
<br/>
Similar to this, my brother's DS performs significantly worse than mine where homebrew is concerned as well (mine doesn't work perfectly around the edges either, but his is much worse).  
<br/>
<br/>
What I noticed was that the plastic lip that goes around the touch screen was deformed to the point that it made contact with the screen.  Until I ran homebrew on it, I thought the only problem with it was that you had to press a bit harder with the stylus.
<br/>
<br/>
Anyway, it may or may not be entirely related, and I don't know how common it is, but I thought maybe I should throw that out.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#68254 - agentq - Mon Jan 23, 2006 10:18 am</h4>
    <div class="postbody"><span class="postbody">Yes, I have also noticed that if I get any grit under the little gap around the screen, it makes the touch screen work badly.  This isn't the cause of the homebrew issues though.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#68327 - chava - Mon Jan 23, 2006 8:50 pm</h4>
    <div class="postbody"><span class="postbody">Hi!
<br/>
<br/>
I've got the same problem, do you know if this can be solved?
<br/>
<br/>
I've tested Win2DS, and there's a shot of what the mouse pointer drawed when I slided the stylus over the four edges of my touchscreen (using Win2DS): 
<br/>
<br/>
<a href="http://img72.imageshack.us/img72/2319/touchscreen1ab.jpg" target="_blank">http://img72.imageshack.us/img72/2319/touchscreen1ab.jpg</a>
<br/>
<br/>
It works great on commercial games, but not with homebrew...
<br/>
<br/>
EDIT: I know there are some posts about similar things, but the screen is well calibrated and it's not because of the protector.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#68338 - Sintax - Mon Jan 23, 2006 9:44 pm</h4>
    <div class="postbody"><span class="postbody">The touchscreen is a tricky thing. I have a feeling on newer DS's they work slightly different, as I've heard that for some people the mouse pointer resets to the middle of the screen, and now your problem (about Win2DS).</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#68350 - duencil - Mon Jan 23, 2006 10:40 pm</h4>
    <div class="postbody"><span class="postbody">Sintax:
<br/>
Could you try the solution I suggested (on the 2nd page of this thread).  THat removed pretty much all the bendiness around the touchscreen edges for me. If you're getting touchscreen coordinates using the touchReadXY() function in libnds, the current version in cvs now incorporates thee changes.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#68900 - knight0fdragon - Fri Jan 27, 2006 7:49 am</h4>
    <div class="postbody"><span class="postbody">Is the calibration affected in anyway with this,  plus what is up with the touch screen having coordingates of 3000+,  is there anyway to set it up to go from 0 to 255 and 0 to 191, that would make the world a lot easier, since i cant access inbetween the pixels anyway.   I was reading through touch.h and it says that that touchread returns both touch and screen coordinates, how do i enable this to return the screen coordinates anyway
<br/>
<br/>
<br/>
<br/>
nevermind, got screen coords, now just need the calibration i guess
<br/>
<br/>
<br/>
i must say i love how my top left corner is reading as 50,5ish and my bottem left is reading 5 , 190ish
<br/>
<br/>
I am trying to build a generic card drawing class for some games id like to make, heres a test of it if people want to test on there hardware and see if they are getting weird results also
<br/>
<br/>
on the top screen
<br/>
line 1 is the current XY of the touch
<br/>
line 2 is the min X and min Y the touch had found
<br/>
line 3 is the max X and max Y the touch had found
<br/>
<br/>
<a href="http://www.free-webster.com/users/knight0fdragon/TouchTest.zip" target="_blank">http://www.free-webster.com/users/knight0fdragon/TouchTest.zip</a><br/>_________________<br/><a href="http://www.myspace.com/knight0fdragonds" target="_blank">http://www.myspace.com/knight0fdragonds</a>
<br/>
<br/>
MK DS FC: Dragon 330772 075464 
<br/>
AC WW FC: Anthony SamsClub 1933-3433-9458 
<br/>
MPFH: Dragon 0215 4231 1206</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#68930 - Xtreme - Fri Jan 27, 2006 1:07 pm</h4>
    <div class="postbody"><span class="postbody">In <span style="font-weight: bold">G6 flash</span> menu (I use the latest "<span style="font-weight: bold">G6 Flash 3 Loader V3.1</span> 24-1-2006") the touch screen also does not function right. It is impossible to use it. I looks like it randomly chooses different location than what I'm pointing at.
<br/>
I have tested with all different commercial games and they seem to be very sharp and accurate even when touching on the edges (animal crossing for example).
<br/>
<br/>
I have European DS with FlashMe v6 (ex N-FW3).
<br/>
<br/>
Has anyone discovered what is causing this? It is very annoying and I'm not able to use homebrew programs/games. :(
<br/>
<br/>
EDIT: I have re-readed all the posts and come to the conclusion that new DS firmwares does fix touch screen proplems.. also prevents homebrew.. heh not working.<br/>_________________<br/>My <a class="postlink" href="http://www.samipupu.com/upload/Guest/xtreme_theme.mp3" target="_blank">Theme</a><span style="font-size: 9px; line-height: normal">
<br/>
DS Lite (FM_V8a) ** R4 Revolution (2GB Transcend) ** SuperCard Lite (2x 2GB Transcend)</span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#69003 - HyperHacker - Fri Jan 27, 2006 10:31 pm</h4>
    <div class="postbody"><span class="postbody">I have V1 firmware and mine works fine aside from occasionally reading the wrong spot when I first touch the screen, which I suggest is just me not reading right. I do notice some problems with the edges (Moonshell's window dragging tends to freak out, especially near the edges, and Txtwriter just plain ignores touches too far near the edge) but I suspect this is due to outdated ndslib code (Txtwriter hasn't been updated in a few months) and/or the first problem (Moonshell's window dragging still acts up near the center, and I haven't seen anyone else report this problem).
<br/>
<br/>
knightOfdragon: ipc-&gt;touchXpx and ipc-&gt;touchYpx. :-)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#69009 - knight0fdragon - Fri Jan 27, 2006 11:26 pm</h4>
    <div class="postbody"><span class="postbody">yea i figured that part out, but for some reason my numbers are off,  I updated my program to display the calibration numbers also, mine are (0,0) , (14652,128),  perhaps theres a problem with the calibration formula in the touch.c, or perhaps its something with supercard.  I loadned my XG2 lite to a friend till he got his SC so i will have him test out my app also to see if he gets the top left and bottem right corners totally warped<br/>_________________<br/><a href="http://www.myspace.com/knight0fdragonds" target="_blank">http://www.myspace.com/knight0fdragonds</a>
<br/>
<br/>
MK DS FC: Dragon 330772 075464 
<br/>
AC WW FC: Anthony SamsClub 1933-3433-9458 
<br/>
MPFH: Dragon 0215 4231 1206</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#69021 - duencil - Sat Jan 28, 2006 12:34 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>knight0fdragon wrote:</b></span></td> </tr> <tr> <td class="quote"> perhaps theres a problem with the calibration formula in the touch.c, or perhaps its something with supercard.  </td> </tr></table><span class="postbody">
<br/>
Have you tried the latest version of touch.c from cvs. It was modified just recently to fix problems with warping around the corners -- maybe you can recompile the lib with that change and see if it helps.
<br/>
<br/>
<a href="http://cvs.sourceforge.net/viewcvs.py/devkitpro/libnds/source/arm7/" target="_blank">http://cvs.sourceforge.net/viewcvs.py/devkitpro/libnds/source/arm7/</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#69045 - knight0fdragon - Sat Jan 28, 2006 3:42 am</h4>
    <div class="postbody"><span class="postbody">yes i have, and i dont think it solved the problem as of yet
<br/>
<br/>
what i am going to do now is write my own calibration formula that is applied to the coordinates of what the screen gives me and just work off that till there is a real solution or something<br/>_________________<br/><a href="http://www.myspace.com/knight0fdragonds" target="_blank">http://www.myspace.com/knight0fdragonds</a>
<br/>
<br/>
MK DS FC: Dragon 330772 075464 
<br/>
AC WW FC: Anthony SamsClub 1933-3433-9458 
<br/>
MPFH: Dragon 0215 4231 1206</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#69111 - OnWarmerMusic - Sat Jan 28, 2006 3:11 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>duencil wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>knight0fdragon wrote:</b></span></td> </tr> <tr> <td class="quote"> perhaps theres a problem with the calibration formula in the touch.c, or perhaps its something with supercard.  </td> </tr></table><span class="postbody">
<br/>
Have you tried the latest version of touch.c from cvs. It was modified just recently to fix problems with warping around the corners -- maybe you can recompile the lib with that change and see if it helps.
<br/>
<br/>
<a href="http://cvs.sourceforge.net/viewcvs.py/devkitpro/libnds/source/arm7/" target="_blank">http://cvs.sourceforge.net/viewcvs.py/devkitpro/libnds/source/arm7/</a></span></td> </tr></table><span class="postbody">
<br/>
<br/>
I was having the "bending" problem around the edges (first run DS, FlashMe v5, w/ screen protector no less) and rebuilding with the new touch.c fixed it brilliantly.  The reading still comes up a few pixels short around the edges, but it's a huge improvement.
<br/>
<br/>
Thanks for pointing this out, duencil :).</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#69116 - knight0fdragon - Sat Jan 28, 2006 4:09 pm</h4>
    <div class="postbody"><span class="postbody">the problem occurs all over the screen, its just tighter in the middle then on the edges, which is probablywhy  i get concave lines on the edges, and it seems like its not accurately reading the right points if u look at it in actual numbers, but i do not believe this is the case.  perhaps the registers are still being initialized and read wrong, who knows.  would be nice to know what nintendos thing does to read it accurately<br/>_________________<br/><a href="http://www.myspace.com/knight0fdragonds" target="_blank">http://www.myspace.com/knight0fdragonds</a>
<br/>
<br/>
MK DS FC: Dragon 330772 075464 
<br/>
AC WW FC: Anthony SamsClub 1933-3433-9458 
<br/>
MPFH: Dragon 0215 4231 1206</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#69304 - knight0fdragon - Sun Jan 29, 2006 9:58 pm</h4>
    <div class="postbody"><span class="postbody">Here are my changed done to touch.c   It gives more accuracy to the touchpad now and reduces a lot of warping.  Unfortunatly, i still get the weird rhombus type shape, so hopefully something else can be done
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
/*---------------------------------------------------------------------------------
<br/>
   $Id: touch.c,v 1.13 2006/01/12 11:13:55 wntrmute Exp $
<br/>
<br/>
   Touch screen control for the ARM7
<br/>
<br/>
   Copyright (C) 2005
<br/>
      Michael Noland (joat)
<br/>
      Jason Rogers (dovoto)
<br/>
      Dave Murphy (WinterMute)
<br/>
<br/>
   This software is provided 'as-is', without any express or implied
<br/>
   warranty.  In no event will the authors be held liable for any
<br/>
   damages arising from the use of this software.
<br/>
<br/>
   Permission is granted to anyone to use this software for any
<br/>
   purpose, including commercial applications, and to alter it and
<br/>
   redistribute it freely, subject to the following restrictions:
<br/>
<br/>
   1.   The origin of this software must not be misrepresented; you
<br/>
         must not claim that you wrote the original software. If you use
<br/>
         this software in a product, an acknowledgment in the product
<br/>
         documentation would be appreciated but is not required.
<br/>
   2.   Altered source versions must be plainly marked as such, and
<br/>
         must not be misrepresented as being the original software.
<br/>
   3.   This notice may not be removed or altered from any source
<br/>
         distribution.
<br/>
<br/>
   $Log: touch.c,v $
<br/>
   Revision 1.13  2006/01/12 11:13:55  wntrmute
<br/>
   modified touch reading code from suggesrions found here -&gt; http://forum.gbadev.org/viewtopic.php?t=7980
<br/>
<br/>
   Revision 1.12  2005/12/17 01:03:05  wntrmute
<br/>
   corrected typos
<br/>
   changed to median values
<br/>
   
<br/>
   Revision 1.11  2005/12/11 22:49:53  wntrmute
<br/>
   use con for console device name
<br/>
   
<br/>
   Revision 1.10  2005/10/17 15:35:56  wntrmute
<br/>
   use weighted averaging
<br/>
   
<br/>
   Revision 1.9  2005/10/03 21:19:34  wntrmute
<br/>
   use ratiometric mode
<br/>
   lock touchscreen on and average several readings
<br/>
   
<br/>
   Revision 1.8  2005/09/12 06:51:58  wntrmute
<br/>
   tidied touch code
<br/>
   
<br/>
   Revision 1.7  2005/09/07 18:05:37  wntrmute
<br/>
   use macros for device settings
<br/>
<br/>
   Revision 1.6  2005/08/23 17:06:10  wntrmute
<br/>
   converted all endings to unix
<br/>
<br/>
   Revision 1.5  2005/08/01 23:12:17  wntrmute
<br/>
   extended touchReadXY to return touchscreen co-ordinates as well as screen co-ordinates
<br/>
<br/>
   Revision 1.4  2005/07/29 00:57:40  wntrmute
<br/>
   updated file headers
<br/>
   added touchReadXY function
<br/>
   made header C++ compatible
<br/>
<br/>
   Revision 1.3  2005/07/12 17:32:20  wntrmute
<br/>
   updated file header
<br/>
<br/>
   Revision 1.2  2005/07/11 23:12:15  wntrmute
<br/>
   *** empty log message ***
<br/>
<br/>
---------------------------------------------------------------------------------*/
<br/>
<br/>
#include &lt;nds/jtypes.h&gt;
<br/>
#include &lt;nds/system.h&gt;
<br/>
#include &lt;nds/arm7/touch.h&gt;
<br/>
<br/>
<br/>
//---------------------------------------------------------------------------------
<br/>
uint16 touchRead(uint32 command) {
<br/>
//---------------------------------------------------------------------------------
<br/>
   uint16 result;
<br/>
   SerialWaitBusy();
<br/>
<br/>
   // Write the command and wait for it to complete
<br/>
   REG_SPICNT = SPI_ENABLE | SPI_BAUD_2MHz | SPI_DEVICE_TOUCH | SPI_CONTINUOUS; //0x0A01;
<br/>
   REG_SPIDATA = command;
<br/>
   SerialWaitBusy();
<br/>
<br/>
   // Write the second command and clock in part of the data
<br/>
   REG_SPIDATA = 0;
<br/>
   SerialWaitBusy();
<br/>
   result = REG_SPIDATA;
<br/>
<br/>
   // Clock in the rest of the data (last transfer)
<br/>
   REG_SPICNT = SPI_ENABLE | 0x201;
<br/>
   REG_SPIDATA = 0;
<br/>
   SerialWaitBusy();
<br/>
<br/>
   // Return the result
<br/>
   return ((result &amp; 0x7F) &lt;&lt; 5) | (REG_SPIDATA &gt;&gt; 3);
<br/>
}
<br/>
<br/>
<br/>
//---------------------------------------------------------------------------------
<br/>
uint32 touchReadTemperature(int * t1, int * t2) {
<br/>
//---------------------------------------------------------------------------------
<br/>
   *t1 = touchRead(TSC_MEASURE_TEMP1);
<br/>
   *t2 = touchRead(TSC_MEASURE_TEMP2);
<br/>
   return 8490 * (*t2 - *t1) - 273*4096;
<br/>
}
<br/>
<br/>
<br/>
<br/>
static bool touchInit = false;
<br/>
static s32 xscale, yscale;
<br/>
static s32 xoffset, yoffset;
<br/>
<br/>
// reading pixel position:
<br/>
//---------------------------------------------------------------------------------
<br/>
touchPosition touchReadXY() {
<br/>
//---------------------------------------------------------------------------------
<br/>
<br/>
<br/>
   touchPosition touchPos;
<br/>
<br/>
<br/>
   if ( !touchInit ) {
<br/>
<br/>
<br/>
      xscale = ((PersonalData-&gt;calX2px - PersonalData-&gt;calX1px) &lt;&lt; 19) / ((PersonalData-&gt;calX2) - (PersonalData-&gt;calX1));
<br/>
      yscale = ((PersonalData-&gt;calY2px - PersonalData-&gt;calY1px) &lt;&lt; 19) / ((PersonalData-&gt;calY2) - (PersonalData-&gt;calY1));
<br/>
<br/>
//      xoffset = (PersonalData-&gt;calX1) * xscale - (PersonalData-&gt;calX1px &lt;&lt; 19);
<br/>
//      yoffset = (PersonalData-&gt;calY1) * yscale - (PersonalData-&gt;calY1px &lt;&lt; 19);
<br/>
<br/>
<br/>
      xoffset = ((PersonalData-&gt;calX1 + PersonalData-&gt;calX2) * xscale  - ((PersonalData-&gt;calX1px + PersonalData-&gt;calX2px) &lt;&lt; 19) ) / 2;
<br/>
      yoffset = ((PersonalData-&gt;calY1 + PersonalData-&gt;calY2) * yscale  - ((PersonalData-&gt;calY1px + PersonalData-&gt;calY2px) &lt;&lt; 19) ) / 2;
<br/>
      touchInit = true;
<br/>
<br/>
   }
<br/>
//New changes start here
<br/>
   s32 x[5],y[5];
<br/>
   
<br/>
   int i;
<br/>
   
<br/>
    //First weed out some garbage reads
<br/>
   for ( i=0; i&lt;5; i++) {
<br/>
      touchRead(TSC_MEASURE_X | 1);
<br/>
      x[i] =  touchRead(TSC_MEASURE_X);
<br/>
      touchRead(TSC_MEASURE_Y | 1);
<br/>
      y[i] =  touchRead(TSC_MEASURE_Y);
<br/>
   }
<br/>
   //grab some more accurate reads now
<br/>
   for ( i=0; i&lt;5; i++) {
<br/>
      touchRead(TSC_MEASURE_X | 1);
<br/>
      x[i] =  touchRead(TSC_MEASURE_X);
<br/>
      touchRead(TSC_MEASURE_Y | 1);
<br/>
      y[i] =  touchRead(TSC_MEASURE_Y);
<br/>
   }
<br/>
<br/>
   s32 temp;
<br/>
   
<br/>
   for ( i=1; i&lt;4; i++ ) {
<br/>
      temp = x[i];
<br/>
<br/>
      if ( temp &gt; x[4] ) { x[i] = x[4]; x[4] = temp; temp = x[i]; } 
<br/>
      if ( temp &lt; x[0] ) { x[i] = x[0]; x[0] = temp; } 
<br/>
<br/>
      temp = y[i];
<br/>
<br/>
      if ( temp &gt; y[4] ) { y[i] = y[4]; y[4] = temp; temp = y[i]; } 
<br/>
      if ( temp &lt; y[0] ) { y[i] = y[0]; y[0] = temp; } 
<br/>
   }
<br/>
<br/>
   touchPos.x = x[2];
<br/>
   touchPos.y = y[2];
<br/>
//New changes end here
<br/>
   s16 px = ( touchPos.x * xscale - xoffset + xscale/2 ) &gt;&gt;19;
<br/>
   s16 py = ( touchPos.y * yscale - yoffset + yscale/2 ) &gt;&gt;19;
<br/>
<br/>
   if ( px &lt; 0) px = 0;
<br/>
   if ( py &lt; 0) py = 0;
<br/>
   if ( px &gt; (SCREEN_WIDTH -1)) px = SCREEN_WIDTH -1;
<br/>
   if ( py &gt; (SCREEN_HEIGHT -1)) py = SCREEN_HEIGHT -1;
<br/>
<br/>
   touchPos.px = px;
<br/>
   touchPos.py = py;
<br/>
<br/>
   return touchPos;
<br/>
<br/>
}
<br/>
<br/>
</td> </tr></table><span class="postbody"><br/>_________________<br/><a href="http://www.myspace.com/knight0fdragonds" target="_blank">http://www.myspace.com/knight0fdragonds</a>
<br/>
<br/>
MK DS FC: Dragon 330772 075464 
<br/>
AC WW FC: Anthony SamsClub 1933-3433-9458 
<br/>
MPFH: Dragon 0215 4231 1206</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#69323 - duencil - Mon Jan 30, 2006 1:14 am</h4>
    <div class="postbody"><span class="postbody">If you want to take the median of your readings, you'll need to do a more thorough sort. All your loop does now is guarantee that the minimums will be in position 0 and the maximums in position 4. 
<br/>
Interesting that you discard your first 5 readings as garbage, though.  Have you confirmed that the second set of 5 readings are more accurate?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#69338 - knight0fdragon - Mon Jan 30, 2006 3:27 am</h4>
    <div class="postbody"><span class="postbody">i have tested it by sending the output to the arm 9, and usually its the first couple of readings that would give me warped results, but anything after the 4th usually gave me desired results for my DS,  as for this median.... I did the same thing as the old touch screen code, but i just added 1 more number to the mix so that i am not averageing 2 results together, which is probably why i was getting an X min of 35 instead of now 12 in the top left corner, but still getting 5 for the bottem left, my other friends are going to use my lib revision tonight on there code and see if it gives them better results<br/>_________________<br/><a href="http://www.myspace.com/knight0fdragonds" target="_blank">http://www.myspace.com/knight0fdragonds</a>
<br/>
<br/>
MK DS FC: Dragon 330772 075464 
<br/>
AC WW FC: Anthony SamsClub 1933-3433-9458 
<br/>
MPFH: Dragon 0215 4231 1206</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#69339 - chishm - Mon Jan 30, 2006 3:35 am</h4>
    <div class="postbody"><span class="postbody">Are any of these techniques checking to see how much pressure is being applied to the screen? The most inaccurate readings are made when the screen is only lightly touched.<br/>_________________<br/><a class="postlink" href="http://chishm.drunkencoders.com" target="_blank">http://chishm.drunkencoders.com</a>
<br/>
<a class="postlink" href="http://dldi.drunkencoders.com" target="_blank">http://dldi.drunkencoders.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#69340 - tepples - Mon Jan 30, 2006 3:41 am</h4>
    <div class="postbody"><span class="postbody">Unfortunately, we don't have solid data as to what constitutes a "light" touch. There is a register that's sensitive to resistance, which is inversely proportional to touch area or "pressure". However, the baseline for a resistance measure varies by at least a factor of 3 from unit to unit.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#69417 - wintermute - Mon Jan 30, 2006 6:12 pm</h4>
    <div class="postbody"><span class="postbody">For those having trouble with bendy edges, give this a try
<br/>
<br/>
<a href="http://devkitpro.sourceforge.net/touch_test.zip" target="_blank">http://devkitpro.sourceforge.net/touch_test.zip</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#69423 - MatLeOuf - Mon Jan 30, 2006 6:53 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>wintermute wrote:</b></span></td> </tr> <tr> <td class="quote">For those having trouble with bendy edges, give this a try
<br/>
<br/>
<a href="http://devkitpro.sourceforge.net/touch_test.zip" target="_blank">http://devkitpro.sourceforge.net/touch_test.zip</a></td> </tr></table><span class="postbody">
<br/>
I tested it, the continuous mode is MUCH better, in fact there's just the right side where I can still see some light bending. But the single shot mode is much more problematic and not very accurate. It seems logic with the method used (median of 5 values) but I prefer to say it ;)
<br/>
<br/>
Anyway, thanks a lot for all your efforts, and keep up the good work!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#69430 - knight0fdragon - Mon Jan 30, 2006 7:26 pm</h4>
    <div class="postbody"><span class="postbody">what did u do to have it do that???<br/>_________________<br/><a href="http://www.myspace.com/knight0fdragonds" target="_blank">http://www.myspace.com/knight0fdragonds</a>
<br/>
<br/>
MK DS FC: Dragon 330772 075464 
<br/>
AC WW FC: Anthony SamsClub 1933-3433-9458 
<br/>
MPFH: Dragon 0215 4231 1206</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#69433 - wintermute - Mon Jan 30, 2006 7:34 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>knight0fdragon wrote:</b></span></td> </tr> <tr> <td class="quote">what did u do to have it do that???</td> </tr></table><span class="postbody">
<br/>
<br/>
I take it this means the new code works better for you?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#69434 - knight0fdragon - Mon Jan 30, 2006 7:36 pm</h4>
    <div class="postbody"><span class="postbody">new codes beautiful  left stays at 3, right stays at 251, only prob is that it jumps from time to time, probably a bad read<br/>_________________<br/><a href="http://www.myspace.com/knight0fdragonds" target="_blank">http://www.myspace.com/knight0fdragonds</a>
<br/>
<br/>
MK DS FC: Dragon 330772 075464 
<br/>
AC WW FC: Anthony SamsClub 1933-3433-9458 
<br/>
MPFH: Dragon 0215 4231 1206</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#69435 - wintermute - Mon Jan 30, 2006 7:44 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>MatLeOuf wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>wintermute wrote:</b></span></td> </tr> <tr> <td class="quote">For those having trouble with bendy edges, give this a try
<br/>
<br/>
<a href="http://devkitpro.sourceforge.net/touch_test.zip" target="_blank">http://devkitpro.sourceforge.net/touch_test.zip</a></td> </tr></table><span class="postbody">
<br/>
I tested it, the continuous mode is MUCH better, in fact there's just the right side where I can still see some light bending. But the single shot mode is much more problematic and not very accurate. It seems logic with the method used (median of 5 values) but I prefer to say it ;)
<br/>
<br/>
Anyway, thanks a lot for all your efforts, and keep up the good work!</span></td> </tr></table><span class="postbody">
<br/>
<br/>
I got rid of the median code and used a slightly different method of reading the touch values which attempts to get a stable reading instead.
<br/>
<br/>
The single shot mode is probably showing up the "light touch" issue which I'm not quite sure how to deal with at present. It sounds like your touchscreen is a lot more sensitive than mine and previous attempts to discard low pressure touches resulted in the code ignoring the stylus completely on some units.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#69438 - knight0fdragon - Mon Jan 30, 2006 7:52 pm</h4>
    <div class="postbody"><span class="postbody">would you mind sharing the method then?<br/>_________________<br/><a href="http://www.myspace.com/knight0fdragonds" target="_blank">http://www.myspace.com/knight0fdragonds</a>
<br/>
<br/>
MK DS FC: Dragon 330772 075464 
<br/>
AC WW FC: Anthony SamsClub 1933-3433-9458 
<br/>
MPFH: Dragon 0215 4231 1206</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#69447 - tepples - Mon Jan 30, 2006 8:52 pm</h4>
    <div class="postbody"><span class="postbody">If single jabs are unreliable, then just ignore the touch screen for the first frame that the pen is down.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#69456 - YopYop - Mon Jan 30, 2006 9:23 pm</h4>
    <div class="postbody"><span class="postbody">We maybe have to read 5 times the touchscreen in continuous mode and make the average of the 3 closer points of the middle of the square that contains these points.
<br/>
<br/>
yopyop</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#69463 - Haiken - Mon Jan 30, 2006 10:34 pm</h4>
    <div class="postbody"><span class="postbody">Did someone try to follow some classical formulas, such as those described <a class="postlink" href="http://www.embedded.com/story/OEG20020529S0046" target="_blank">here</a>.
<br/>
They request 3 calibration points, but although the NDSTechWiki describes only 2 points, my DS asks for 3 of them...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#69472 - Xtreme - Tue Jan 31, 2006 12:06 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>wintermute wrote:</b></span></td> </tr> <tr> <td class="quote">For those having trouble with bendy edges, give this a try touch_test.zip</td> </tr></table><span class="postbody">Ok. That test is great indeed! Thank you that you take the "inaccure situation" seriously!
<br/>
<br/>
I have played with that test many minutes to see if anything changes.. 
<br/>
Center = Very accurate (...*...)
<br/>
Right corner = Ball a bit too much left from stylus  (....*..)
<br/>
Left corner = Very accurate (...*...)
<br/>
<br/>
Top corner = Very accurate X,Y
<br/>
Lower corner = Very accurate X,Y
<br/>
<br/>
<span style="font-weight: bold">Do want to see some on-screen pics?</span><br/>_________________<br/>My <a class="postlink" href="http://www.samipupu.com/upload/Guest/xtreme_theme.mp3" target="_blank">Theme</a><span style="font-size: 9px; line-height: normal">
<br/>
DS Lite (FM_V8a) ** R4 Revolution (2GB Transcend) ** SuperCard Lite (2x 2GB Transcend)</span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#69483 - wintermute - Tue Jan 31, 2006 12:53 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Haiken wrote:</b></span></td> </tr> <tr> <td class="quote">Did someone try to follow some classical formulas, such as those described <a class="postlink" href="http://www.embedded.com/story/OEG20020529S0046" target="_blank">here</a>.
<br/>
They request 3 calibration points, but although the NDSTechWiki describes only 2 points, my DS asks for 3 of them...</td> </tr></table><span class="postbody">
<br/>
<br/>
The third point isn't stored anywhere.
<br/>
<br/>
Using our own calibration functions would mean that all homebrew would need to be calibrated individually for each use.
<br/>
<br/>
Thankfully we seem to be getting somewhere with the touch code and the standard calibration settings.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#69484 - wintermute - Tue Jan 31, 2006 12:58 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>knight0fdragon wrote:</b></span></td> </tr> <tr> <td class="quote">would you mind sharing the method then?</td> </tr></table><span class="postbody">
<br/>
<br/>
I'd like to get another couple of positive tests from people who were having problems then I'll commit it to CVS.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#69485 - duencil - Tue Jan 31, 2006 1:29 am</h4>
    <div class="postbody"><span class="postbody">works well on my unit too, wintermute</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#69488 - wonderworld - Tue Jan 31, 2006 1:34 am</h4>
    <div class="postbody"><span class="postbody">Hey, the first thing that worked for me.
<br/>
Can't say if it's really accurate, because the ball is a bit to large, but
<br/>
i had VERY BAD problems with other apps, like scumm and win2ds.
<br/>
<br/>
THis is a screeny i made using win2ds and tapping "1"
<br/>
<br/>
<a href="http://img210.imageshack.us/my.php?image=img03141om.jpg" target="_blank">http://img210.imageshack.us/my.php?image=img03141om.jpg</a>
<br/>
<br/>
would be a great thing, if this imporved code would make it into apps because every hombrew-app that used the touchscreen was unusable for me till now as you can imagine checking the screenshot..</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#69492 - LuXo - Tue Jan 31, 2006 1:54 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>wintermute wrote:</b></span></td> </tr> <tr> <td class="quote">I'd like to get another couple of positive tests from people who were having problems then I'll commit it to CVS.</td> </tr></table><span class="postbody">
<br/>
<br/>
Its almost perfect for me, its not very accurate in the borders (just a few pixels) but its by far the best touch_test ive tried :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#69533 - HyperHacker - Tue Jan 31, 2006 9:33 am</h4>
    <div class="postbody"><span class="postbody">Is that keyboard in your screenshot public domain or some such? It's used in TxtWriter as well. I asked the author of the program about it but he never replied. I want to use it in my own programs, it's pretty sweet.
<br/>
<br/>
As for pressure, couldn't there be some sort of homebrew pressure calibration? You have the player press some spot light, then another spot hard, and do this a few times to get a good reading, then store it in some unused part of the firmware.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#69540 - Sintax - Tue Jan 31, 2006 10:04 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>HyperHacker wrote:</b></span></td> </tr> <tr> <td class="quote">Is that keyboard in your screenshot public domain or some such? It's used in TxtWriter as well. I asked the author of the program about it but he never replied. I want to use it in my own programs, it's pretty sweet.
<br/>
<br/>
As for pressure, couldn't there be some sort of homebrew pressure calibration? You have the player press some spot light, then another spot hard, and do this a few times to get a good reading, then store it in some unused part of the firmware.</td> </tr></table><span class="postbody">Keyboard: <a href="http://headkaze.webpal.info/" target="_blank">http://headkaze.webpal.info/</a>
<br/>
<br/>
As for a pressure calibration, it's not a real bad idea, it'd just be nice to have code that works for everything. For my first program, I used some pressure code (I think by natrium) and it worked perfectly for me, but other DS's had settings that were way different (it was a drawing program so that was important). The pressure code seemed to work perfectly for me, but it could be like everything else with the touch screen- that it's different for different DS's.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#69577 - chava - Tue Jan 31, 2006 4:46 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>wintermute wrote:</b></span></td> </tr> <tr> <td class="quote">For those having trouble with bendy edges, give this a try
<br/>
<br/>
<a href="http://devkitpro.sourceforge.net/touch_test.zip" target="_blank">http://devkitpro.sourceforge.net/touch_test.zip</a></td> </tr></table><span class="postbody">
<br/>
<br/>
Hey! This is the first homnebrew app that works correctly for my DS! Touch screen is now accurate! 
<br/>
(See what happened to me in win2ds when moving the stylus over the edges of the screen-&gt; <a href="http://img72.imageshack.us/img72/2319/touchscreen1ab.jpg" target="_blank">http://img72.imageshack.us/img72/2319/touchscreen1ab.jpg</a>)
<br/>
<br/>
Please, release the source, so others can use this code in their apps. 
<br/>
<br/>
Thanx!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#69580 - wintermute - Tue Jan 31, 2006 4:54 pm</h4>
    <div class="postbody"><span class="postbody">source is now in CVS, I'll look at doing a libnds stable release over the next couple of days</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#69584 - chava - Tue Jan 31, 2006 5:21 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>wintermute wrote:</b></span></td> </tr> <tr> <td class="quote">source is now in CVS, I'll look at doing a libnds stable release over the next couple of days</td> </tr></table><span class="postbody">
<br/>
<br/>
Thanx! Hope Moonshell will include this ^^</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#69617 - chava - Tue Jan 31, 2006 9:03 pm</h4>
    <div class="postbody"><span class="postbody">Weeeee!!!
<br/>
It's already on new MoonShell! Thanx to moonsheel and wintermute! Hope the rest of homebrew apps will use this soon</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#69646 - Snuk the Great - Tue Jan 31, 2006 10:43 pm</h4>
    <div class="postbody"><span class="postbody">Hmm, I also tested the <a href="http://devkitpro.sourceforge.net/touch_test.zip." target="_blank">http://devkitpro.sourceforge.net/touch_test.zip.</a> It works better then most things I tested, though it seems like my screen is not the right size... I seem to miss 5 pixels at the left and right side of the screen. Adding to that the upper left and lower left differ 2 pixels, oddly enough that are the only ones that differ.
<br/>
Anyway, good work on the tests! I love testing this stuff :P!
<br/>
[EDIT]
<br/>
I reconfigured my DS in the DS menu and now it works perfectly! The only thing that I still find pretty odd is the is the difference of 2 pixels at the upper left and bottom left side of my screen...
<br/>
[/EDIT]</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#69648 - wonderworld - Tue Jan 31, 2006 10:51 pm</h4>
    <div class="postbody"><span class="postbody">I tried out the new moonshell.
<br/>
It works fine now for me....
<br/>
This solved nearly all my touchscreen problems, very nice.
<br/>
<br/>
Hope others will start using this improved code soon, because i can't wait to try out all those apps that weren't working before for me :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#69704 - duencil - Wed Feb 01, 2006 11:13 am</h4>
    <div class="postbody"><span class="postbody">Actually, Moonshell is using the previous revision of touch.c, version 1.13, that came about from my suggestions in page 2 of the thread, rather than wintermute's latest revision.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#69707 - chava - Wed Feb 01, 2006 12:45 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>duencil wrote:</b></span></td> </tr> <tr> <td class="quote">Actually, Moonshell is using the previous revision of touch.c, version 1.13, that came about from my suggestions in page 2 of the thread, rather than wintermute's latest revision.</td> </tr></table><span class="postbody">
<br/>
<br/>
Well, so thanx to anyone involved.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#69708 - duencil - Wed Feb 01, 2006 1:03 pm</h4>
    <div class="postbody"><span class="postbody">Oh hell I wasn?t being petty &amp; seeking credit - I thought people were giving feedback on the latest code based on observations with Moonshell, and I was wondering if MoonLight had found a problem with the latest iteration, or just hadn't got around to testing it yet. As I said, for me it works very well.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#69747 - Xtreme - Wed Feb 01, 2006 5:24 pm</h4>
    <div class="postbody"><span class="postbody">Is the fixed source available to homebrew community?<br/>_________________<br/>My <a class="postlink" href="http://www.samipupu.com/upload/Guest/xtreme_theme.mp3" target="_blank">Theme</a><span style="font-size: 9px; line-height: normal">
<br/>
DS Lite (FM_V8a) ** R4 Revolution (2GB Transcend) ** SuperCard Lite (2x 2GB Transcend)</span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#69792 - tepples - Wed Feb 01, 2006 10:54 pm</h4>
    <div class="postbody"><span class="postbody">The improved version of touch.c should be in libnds CVS repository and should show up in the next release of libnds.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#69995 - Lino - Fri Feb 03, 2006 5:50 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Snuk the Great wrote:</b></span></td> </tr> <tr> <td class="quote">Hmm, I also tested the <a href="http://devkitpro.sourceforge.net/touch_test.zip." target="_blank">http://devkitpro.sourceforge.net/touch_test.zip.</a> </td> </tr></table><span class="postbody">
<br/>
<br/>
Where is the source code?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#70000 - melw - Fri Feb 03, 2006 6:00 pm</h4>
    <div class="postbody"><span class="postbody"><a class="postlink" href="http://www.devkitpro.org/" target="_blank">http://www.devkitpro.org/</a>
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">libnds 20060201 
<br/>
<br/>
improved touch code
<br/>
...</td> </tr></table><span class="postbody">
<br/>
<br/>
It's been there for couple days already.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#70194 - WhyKlef - Sat Feb 04, 2006 11:15 pm</h4>
    <div class="postbody"><span class="postbody">Anyone?!? How do i apply touch.c to my actual firmware? Any program to change it or anything? Sorry for my n00beness</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#70258 - HyperHacker - Sun Feb 05, 2006 4:21 am</h4>
    <div class="postbody"><span class="postbody">It's just a replacement for the touch.c in LibNDS. It doesn't involve firmware.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#78179 - josath - Wed Apr 05, 2006 8:00 pm</h4>
    <div class="postbody"><span class="postbody">I'm using latest touch code from latest CVS libnds, It doesn't solve the 'jumping lines' problem at all. 
<br/>
<br/>
I've tried using some of the other mentioned code, taking multiple reads, taking the median, throwing out first 3 &amp; last 3 readings....they all help a bit, but nothing really solves it completely. the problem is still there. 
<br/>
<br/>
It's not a big deal for most apps, but I'm trying to make a drawing app, and it's really frustrating to have lines drawn where you don't want them (especially since I don't have an 'undo' yet heh).
<br/>
<br/>
Has there been any progress with this? I have a feeling that all the people who have the ability to solve this, have a DS with a more accurate touchscreen and it's hard for them to fix.
<br/>
<br/>
EDIT: One more thing I tried, was throwing out all touchscreen readings where dx &gt; 30 || dy &gt; 30. This solves about 90% of the jumps, there are still the occasional small one, so it's not perfect. But it has the downside of ignoring valid user input where the user is sweeping the stylus really fast across the screen. Still not a 100% solution.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#78186 - tepples - Wed Apr 05, 2006 8:58 pm</h4>
    <div class="postbody"><span class="postbody">To detect impossible jumps in the position, you might want to try taking the <span style="font-style: italic">second</span> derivative of the position stream with respect to time: (d^2x(t)/dt^2, d^2y(t)/dt^2). The second derivative is proportional to the force that the user is using to move his or her fingers/hand/wrist to move the stylus. To find appropriate thresholds, try making a program that graphs the magnitude of this second derivative, and examine the peaks from rapid scratching vs. the peaks from true discontinuities.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#90330 - qw3rty - Thu Jun 29, 2006 7:12 pm</h4>
    <div class="postbody"><span class="postbody">The iteration algorithm for this isn't overly hard :
<br/>
<br/>
you only need to remember the past two frame's touchpositions (and of course you'll need the touchposition of this frame)
<br/>
the acceleration is :
<br/>
<br/>
acceleration_x = (touchPos_2framesago.px - 2* touchPos_1framesago.px + touchPos_0framesago.px) / (dt^2);
<br/>
absolute_acceleration = sqr( acceleration_x^2 + acceleration_y^2 );
<br/>
<br/>
dt := time difference from frame to frame.
<br/>
<br/>
P.S. : The concept seems to work - it gets rid of most of the jumps....it's not (yet) perfect however....
<br/>
<br/>
P.P.S. : you can also use dt = 1 to make things less complicated (IF your game / touchroutine runs at a CONSTANT speed (e.g. 60 Hz)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#90354 - josath - Thu Jun 29, 2006 9:07 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>qw3rty wrote:</b></span></td> </tr> <tr> <td class="quote">.it's not (yet) perfect however....</td> </tr></table><span class="postbody">
<br/>
<br/>
good work, let us know if you make any more progress. perfect touchscreen readings are necessary for a drawing app to work well (like what I've been writing). those evil jumps are quite annoying when i'm trying to draw something :(</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#90464 - qw3rty - Fri Jun 30, 2006 9:40 am</h4>
    <div class="postbody"><span class="postbody">This is one possibility for the beginning of your main loop :
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#define PEN_ACCELERATION_MAX 75 //values from 50 .... 150 make sense in a 60Hz loop-speed
<br/>
swiWaitForVBlank();
<br/>
touchPosition touchPosCurrentFrame;
<br/>
touchPosCurrentFrame = touchReadXY();
<br/>
static touchPosition touchPosLast[2]; //this is to remember the last two readings - touchPosLast[0] will be 2 frames ago, [1] 1 frame ago
<br/>
int acc_x,acc_y,acceleration;
<br/>
acc_x = touchPosLast[0].px - 2* touchPosLast[1].px + touchPos.px;
<br/>
acc_y = touchPosLast[0].py - 2* touchPosLast[1].py + touchPos.py;
<br/>
acceleration = (acc_x*acc_x + acc_y*acc_y); //this is acceleration^2 - if you want the "real" acceleration, take the squareroot but you'll loose accuracy
<br/>
<br/>
touchPosLast[0] = touchPosLast[1];
<br/>
touchPosLast[1] = touchPosCurrentFrame;
<br/>
if (acceleration &gt; PEN_ACCELERATION_MAX)
<br/>
{
<br/>
   //DISCARD THE READING !
<br/>
   .
<br/>
   .
<br/>
   .
<br/>
}
<br/>
.
<br/>
.
<br/>
.
<br/>
//YOUR CODE
<br/>
.
<br/>
.
<br/>
.
<br/>
<br/>
</td> </tr></table><span class="postbody">
<br/>
P.S. : I didn't include the time into the formula - if you call this code on a constant basis (e.g. every 1/60th second) it doesn't matter.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#91502 - wintermute - Fri Jul 07, 2006 4:01 pm</h4>
    <div class="postbody"><span class="postbody">I've been experimenting with multiple sampling per frame in the arm7 code which seems to help quite a bit.
<br/>
<br/>
<a class="postlink" href="http://devkitpro.cvs.sourceforge.net/devkitpro/examples/nds/templates/combined/arm7/source/template.c?revision=1.3&amp;view=markup" target="_blank">new arm7 code</a>
<br/>
<br/>
It might be worth extending this a bit to "smooth" the pen input rather than jjust discarding the erroneous values.<br/>_________________<br/><a class="postlink" href="http://www.devkitpro.org/" target="_blank">devkitPro - professional toolchains at amateur prices</a>
<br/>
<a class="postlink" href="http://wiki.devkitpro.org/index.php/IRC" target="_blank">devkitPro IRC support</a>
<br/>
<a class="postlink" href="http://davejmurphy.com/" target="_blank">Personal Blog</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#91521 - masscat - Fri Jul 07, 2006 6:56 pm</h4>
    <div class="postbody"><span class="postbody">The jumpy pointer problem appears to happen when the touch screen is gently touched.
<br/>
Using the Z1 and Z2 touch screen readings it is possible to ignore light touches. Here is some changes to the while loop of the TouchTest code:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#define RESISTANCE_SHIFT 16
<br/>
uint32 min_resistance = 0x7fffffff;
<br/>
<br/>
while(1) {
<br/>
  uint32 z1, z2, resistance;
<br/>
  ...
<br/>
  ...
<br/>
  z1 = IPC-&gt;touchZ1;
<br/>
  z2 = IPC-&gt;touchZ2;
<br/>
  z2 &lt;&lt;= RESISTANCE_SHIFT;
<br/>
<br/>
  resistance = touch.x;
<br/>
  resistance *= z2/z1 - ( 1 &lt;&lt; RESISTANCE_SHIFT);
<br/>
  resistance &gt;&gt;= RESISTANCE_SHIFT;
<br/>
<br/>
  if ( resistance &lt; min_resistance)
<br/>
    min_resistance = resistance;
<br/>
<br/>
  if ( resistance &lt; (min_resistance + 3000)) {
<br/>
    /* Use the non-gentle touch */
<br/>
    ...
<br/>
    ...
<br/>
    ...
<br/>
  }
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
The resistance calculation is taken from the data on <a class="postlink" href="http://nocash.emubase.de/gbatek.htm#dstouchscreencontrollertsc" target="_blank">no$gba</a>. The 3000 in the <span style="font-style: italic">min_resistance + 3000</span> check is just a value that works on my DS.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#91536 - wintermute - Fri Jul 07, 2006 8:16 pm</h4>
    <div class="postbody"><span class="postbody">This is something that's been tried before. The resistance appears to differ quite markedly between different units and we ended up with some units being totally jump free while others were unable to read the touchscreen at all.
<br/>
<br/>
The two z values are now contained in the touch position structure
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
typedef struct touchPosition {
<br/>
   int16   x;
<br/>
   int16   y;
<br/>
   int16   px;
<br/>
   int16   py;
<br/>
   int16   z1;
<br/>
   int16   z2;
<br/>
} touchPosition;
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I'm still in two minds whether to discard the IPC structure completely and use the hardware mailbox for communication between the processors. Some things make more sense to be maintained in a shared area of main memory, others would be better with the more immediate transfer offered by the registers.<br/>_________________<br/><a class="postlink" href="http://www.devkitpro.org/" target="_blank">devkitPro - professional toolchains at amateur prices</a>
<br/>
<a class="postlink" href="http://wiki.devkitpro.org/index.php/IRC" target="_blank">devkitPro IRC support</a>
<br/>
<a class="postlink" href="http://davejmurphy.com/" target="_blank">Personal Blog</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#91542 - masscat - Fri Jul 07, 2006 9:17 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>wintermute wrote:</b></span></td> </tr> <tr> <td class="quote">This is something that's been tried before. The resistance appears to differ quite markedly between different units and we ended up with some units being totally jump free while others were unable to read the touchscreen at all.
<br/>
<br/>
The two z values are now contained in the touch position structure
<br/>
</td> </tr></table><span class="postbody">
<br/>
The minimum and maximum resistance value can be computed at runtime (as the minimum in my example) and then a threshold calculated from these two values. I am assuming that the response of the touchscreen is the same on all DSs even if the values given for the same pressure vary so if this is not the case then it would not work.
<br/>
<br/>
I could not see the ARM9 libnds function that copies them in, hence directly accessing the IPC structure.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#91592 - wintermute - Sat Jul 08, 2006 2:18 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>masscat wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
The minimum and maximum resistance value can be computed at runtime (as the minimum in my example) and then a threshold calculated from these two values. I am assuming that the response of the touchscreen is the same on all DSs even if the values given for the same pressure vary so if this is not the case then it would not work.
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Interesting theory, we should come up with some code to test this &amp; see how well it works across a range of systems. The major problem we've had with touch screen reading so far is that none of the people contributing to libnds have had access to particularly problematic units. Reading through most of the feedback regarding touch code in the forums it would seem that most of the trouble with erratic and inaccurate touch screens has been with end users rather than developers.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
I could not see the ARM9 libnds function that copies them in, hence directly accessing the IPC structure.</td> </tr></table><span class="postbody">
<br/>
<br/>
Currently they're read from the IPC structure but this may ( or may not ) change at some point in the future. I've been considering implementing a proper FIFO based command system for some time but some aspects may be better left as they are.<br/>_________________<br/><a class="postlink" href="http://www.devkitpro.org/" target="_blank">devkitPro - professional toolchains at amateur prices</a>
<br/>
<a class="postlink" href="http://wiki.devkitpro.org/index.php/IRC" target="_blank">devkitPro IRC support</a>
<br/>
<a class="postlink" href="http://davejmurphy.com/" target="_blank">Personal Blog</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#91596 - HyperHacker - Sat Jul 08, 2006 3:19 am</h4>
    <div class="postbody"><span class="postbody">FYI, I noticed that while many apps have jumping problems on my DS, DSBASIC, which I used quite extensively on vacation last week, didn't do it once that I can recall.<br/>_________________<br/>I'm a PSP hacker now, but I still &lt;3 DS.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#91600 - wintermute - Sat Jul 08, 2006 4:13 am</h4>
    <div class="postbody"><span class="postbody">Anyone know what method DS basic is using for touch screen reading?<br/>_________________<br/><a class="postlink" href="http://www.devkitpro.org/" target="_blank">devkitPro - professional toolchains at amateur prices</a>
<br/>
<a class="postlink" href="http://wiki.devkitpro.org/index.php/IRC" target="_blank">devkitPro IRC support</a>
<br/>
<a class="postlink" href="http://davejmurphy.com/" target="_blank">Personal Blog</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#91652 - zzo38computer - Sat Jul 08, 2006 4:12 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>wintermute wrote:</b></span></td> </tr> <tr> <td class="quote">Anyone know what method DS basic is using for touch screen reading?</td> </tr></table><span class="postbody">
<br/>
<br/>
I made DS BASIC, it uses just a simple one, read 2 reading and if they don't match, then try again. I don't know if it may be inaccurate sometimes... It doesn't seem to be inaccurate on DS BASIC, but DS Multigam uses the same methods and it does jump sometimes, I will see what wrong<br/>_________________<br/><span style="font-weight: bold">Important:</span> Please send messages about FWNITRO to the public forum, not privately to me.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#91698 - HyperHacker - Sat Jul 08, 2006 9:53 pm</h4>
    <div class="postbody"><span class="postbody">Well with DSBASIC you're not drawing lines or anything like that, so it might not show up there.<br/>_________________<br/>I'm a PSP hacker now, but I still &lt;3 DS.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#91775 - masscat - Sun Jul 09, 2006 1:47 pm</h4>
    <div class="postbody"><span class="postbody">With regard to using the Z too filter out gentle touches:
<br/>
The Z values vary with what you use to touch the screen (pen, finger, double touch) so I do not think this is a feasible method. Having read the datasheet for the touchscreen it suggests you can use the Z for determining a pen touch from a finger touch.
<br/>
<br/>
Replacing the TouchTest arm7 code (i.e. the default arm7 code used by ndstool) with the arm7 code from the libnds examples templates directory resulted in almost no pointer jumping for me.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#91781 - tepples - Sun Jul 09, 2006 2:58 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>masscat wrote:</b></span></td> </tr> <tr> <td class="quote">With regard to using the Z too filter out gentle touches:
<br/>
The Z values vary with what you use to touch the screen (pen, finger, double touch)</td> </tr></table><span class="postbody">
<br/>
True, but the values that cause jumping with a stylus might also cause jumping with a finger and vice versa.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#98073 - PadrinatoR - Sun Aug 13, 2006 2:03 am</h4>
    <div class="postbody"><span class="postbody">Hi! I'm trying to do a drawing app and I'm having these troubles you're talking about... is there any way to minimize that annoying trouble?
<br/>
<br/>
If I set a minimum pressure, my app doesn't detect the right border of the screen because it senses less pressure than the rest of the screen... O_o</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#98080 - tepples - Sun Aug 13, 2006 2:42 am</h4>
    <div class="postbody"><span class="postbody">Try looking at the acceleration (second differential) of position readings.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#98110 - qw3rty - Sun Aug 13, 2006 8:50 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>PadrinatoR wrote:</b></span></td> </tr> <tr> <td class="quote">Hi! I'm trying to do a drawing app and I'm having these troubles you're talking about... is there any way to minimize that annoying trouble?
<br/>
<br/>
If I set a minimum pressure, my app doesn't detect the right border of the screen because it senses less pressure than the rest of the screen... O_o</td> </tr></table><span class="postbody">
<br/>
<br/>
The pressure seems to be proportional to the distance from the lower right border.
<br/>
<br/>
min_pressure = C0 + C* sqrt((256 - x)^2 + (192 - y)^2)
<br/>
<br/>
I have no idea which values C0 and C have. My observation may even be false :)
<br/>
<br/>
I didn't look further into pressure reading, after implementing acceleration-limiting, as tepples suggested, because it's easy and gives good results.
<br/>
Maybe combing pressure reading and acceleration limiting would give perfect readings....(allow more acceleration, if pen is pressed harder)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#98116 - masscat - Sun Aug 13, 2006 10:06 am</h4>
    <div class="postbody"><span class="postbody">Here is a link to the touchscreen controller's product page:
<br/>
<br/>
<a class="postlink" href="http://focus.ti.com/docs/prod/folders/print/tsc2046.html" target="_blank">http://focus.ti.com/docs/prod/folders/print/tsc2046.html</a>
<br/>
<br/>
The datasheet is useful when experimenting with touchscreen reading and interpretation.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#98462 - PadrinatoR - Tue Aug 15, 2006 12:17 pm</h4>
    <div class="postbody"><span class="postbody">Hi!
<br/>
I don't know if it is an error nor if it can help to improve touchscreen accuracy:
<br/>
<br/>
s32 readTouchValue(int measure, int retry , int range) {
<br/>
//---------------------------------------------------------------------------------
<br/>
	int i;
<br/>
	s32 this_value=0, this_range;
<br/>
<br/>
	s32 last_value = touchRead(measure | 1);
<br/>
<br/>
	for ( i=0; i &lt; retry; i++) {
<br/>
		this_value = touchRead(measure | 1);
<br/>
		this_range = abs(last_value - this_value);
<br/>
		if (this_range &lt;= range) break;
<br/>
	}
<br/>
<br/>
<span style="font-weight: bold">if ( i == range) this_value = 0;</span>
<br/>
	return this_value;
<br/>
<br/>
}
<br/>
<br/>
<br/>
Due to these declarations:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">static int _MaxRetry = 5;
<br/>
static int _MaxRange = 30;</td> </tr></table><span class="postbody">
<br/>
<br/>
i==range will be always false.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#98651 - PadrinatoR - Wed Aug 16, 2006 7:38 pm</h4>
    <div class="postbody"><span class="postbody">Well... I've read TSC2046 datasheet and I suppose that this is the problem:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote"><span style="text-decoration: underline">TOUCH SCREEN SETTLING</span>
<br/>
<br/>
In some applications, external capacitors may be required
<br/>
across the touch screen for filtering noise picked up by the
<br/>
touch screen (e.g., noise generated by the LCD panel or
<br/>
backlight circuitry). These capacitors provide a low-pass
<br/>
filter to reduce the noise, but cause a settling time
<br/>
requirement when the panel is touched that typically
<br/>
shows up as a gain error. There are several methods for
<br/>
minimizing or eliminating this issue. The problem is that
<br/>
the input and/or reference has not settled to the final
<br/>
steady-state value prior to the ADC sampling the input(s)
<br/>
and providing the digital output. Additionally, the reference
<br/>
voltage may still be changing during the measurement
<br/>
cycle.</td> </tr></table><span class="postbody">
<br/>
<br/>
And these are the possible solutions:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Option 1 is to stop or slow down the TSC2046 DCLK
<br/>
for the required touch screen settling time. This allows the
<br/>
input and reference to have stable values for the Acquire
<br/>
period (3 clock cycles of the TSC2046; see Figure 9). This
<br/>
works for both the single-ended and the differential modes.
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
Option 2 is to operate the TSC2046 in the differential mode
<br/>
only for the touch screen measurements and command
<br/>
the TSC2046 to remain on (touch screen drivers ON) and
<br/>
not go into power-down (PD0 = 1). Several conversions
<br/>
are made depending on the settling time required and the
<br/>
TSC2046 data rate. Once the required number of
<br/>
conversions have been made, the processor commands
<br/>
the  TSC2046 to go into its power-down state on the last
<br/>
measurement. This process is required for X-Position,
<br/>
Y-Position, and Z-Position measurements.
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
Option 3 is to operate in the 15 Clock-per-Conversion mode, which
<br/>
overlaps the analog-to-digital conversions and maintains
<br/>
the touch screen drivers on until commanded to stop by the
<br/>
processor (see Figure 13).</td> </tr></table><span class="postbody">
<br/>
<br/>
According to <a class="postlink" href="http://nocash.emubase.de/gbatek.htm#dstouchscreencontrollertsc" target="_blank">http://nocash.emubase.de/gbatek.htm#dstouchscreencontrollertsc</a>, differential mode doesn't allow to measure the temperature and other things except X, Y, Z1 and Z2... and there are no commercial games that measure the temperature and so on, so... may Nintendo chose option 2 to avoid this problem??</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#98683 - masscat - Wed Aug 16, 2006 11:13 pm</h4>
    <div class="postbody"><span class="postbody">I noticed the same thing and tried out a test where the ADC is left powered up whilst the pen is down, bit 0 is set to 1 in the command byte (arm7 code <a class="postlink" href="http://masscat.afraid.org/dumping_ground/pwr_touch.c" target="_blank">here</a>). There is still jumping when gently touched.
<br/>
<br/>
Having just looked at the code again I notice that I never power the ADC down.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#98691 - HyperHacker - Thu Aug 17, 2006 12:05 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>PadrinatoR wrote:</b></span></td> </tr> <tr> <td class="quote">According to <a class="postlink" href="http://nocash.emubase.de/gbatek.htm#dstouchscreencontrollertsc" target="_blank">http://nocash.emubase.de/gbatek.htm#dstouchscreencontrollertsc</a>, differential mode doesn't allow to measure the temperature and other things except X, Y, Z1 and Z2.</td> </tr></table><span class="postbody">
<br/>
Could we not switch to one mode to read the temperature, then back when we're done?<br/>_________________<br/>I'm a PSP hacker now, but I still &lt;3 DS.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#98693 - PadrinatoR - Thu Aug 17, 2006 12:12 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>HyperHacker wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>PadrinatoR wrote:</b></span></td> </tr> <tr> <td class="quote">According to <a class="postlink" href="http://nocash.emubase.de/gbatek.htm#dstouchscreencontrollertsc" target="_blank">http://nocash.emubase.de/gbatek.htm#dstouchscreencontrollertsc</a>, differential mode doesn't allow to measure the temperature and other things except X, Y, Z1 and Z2.</td> </tr></table><span class="postbody">
<br/>
Could we not switch to one mode to read the temperature, then back when we're done?</span></td> </tr></table><span class="postbody">
<br/>
<br/>
I think it can generate more problems, but it may be possible. I don't know so much about hardware :S</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#98758 - masscat - Thu Aug 17, 2006 10:50 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>PadrinatoR wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>HyperHacker wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>PadrinatoR wrote:</b></span></td> </tr> <tr> <td class="quote">According to <a class="postlink" href="http://nocash.emubase.de/gbatek.htm#dstouchscreencontrollertsc" target="_blank">http://nocash.emubase.de/gbatek.htm#dstouchscreencontrollertsc</a>, differential mode doesn't allow to measure the temperature and other things except X, Y, Z1 and Z2.</td> </tr></table><span class="postbody">
<br/>
Could we not switch to one mode to read the temperature, then back when we're done?</span></td> </tr></table><span class="postbody">
<br/>
<br/>
I think it can generate more problems, but it may be possible. I don't know so much about hardware :S</span></td> </tr></table><span class="postbody">
<br/>
In my example code, you could only read the temperature and battery values when the pen is up. If the pen is down then just use a repeat of the last reading. Somebody using a DS does not leave the pen touching the screen for long enough for this to cause a problem.
<br/>
But, again, the powered up ADC does not solve the gentle touch problem.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#98759 - PadrinatoR - Thu Aug 17, 2006 10:55 am</h4>
    <div class="postbody"><span class="postbody">Ok! And what about the other 2 options?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#98796 - masscat - Thu Aug 17, 2006 5:29 pm</h4>
    <div class="postbody"><span class="postbody">There were a couple of faults in my last example.
<br/>
When the ADC is powered up the PENIRQ signal is disabled and not good for touchscreen touch detecting. Therefore I now power down the touchscreen after the pen release is detected thus re-enabling the PENIRQ signal.
<br/>
Since the touchscreen values and the touchscreen button event are read seperately on the arm9 there is a change that the button could be read as down but the touchscreen value be wrong. I am not sure this happens but to keep things in sync I pass the touch data using the fifo.
<br/>
<br/>
Still some jumping on my DS but I think it is less (although this could be rose tinting on my behalf). If people want to have a play and see what they think grab the <a class="postlink" href="http://masscat.afraid.org/dumping_ground/TouchTestTest.tar.bz2" target="_blank">.nds file and code</a>.
<br/>
<br/>
As for option 1 - I am not sure when it needs the slow/stopped clock. If it is after the touchscreen has received the channel select bits of the command byte but before the aquire period (the last three bit of the command byte) then this would have to be done in hardware and therefore no good to us.
<br/>
As for option 3 - this would have to be done at the hardware level so no good to us.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#98815 - PadrinatoR - Thu Aug 17, 2006 7:30 pm</h4>
    <div class="postbody"><span class="postbody">Yehaaa!! I think I've solved the jumping problem :D This solution is not based on pressure or any other possible variable that depends of the DS.
<br/>
<br/>
First, I'm using this:
<br/>
- devKitPro 1.3.2
<br/>
- libnds 21/06/2006
<br/>
- PAlib 29/06/2006
<br/>
<br/>
I've modified libnds and added one thing to PAlib.
<br/>
Here you can download the modified libnds, PAlib and the alpha version of my drawing app (source and binary): <a href="http://www.ftp.nu/files/5291/" target="_blank">http://www.ftp.nu/files/5291/</a>
<br/>
<br/>
Ok! I've made the next changes:
<br/>
- Added to IPC struct a field:
<br/>
include/nds/ipc.h
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">u8 touchError</td> </tr></table><span class="postbody">
<br/>
- Added to touchPosition struct a field:
<br/>
include/nds/jtypes.h
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">u8 error</td> </tr></table><span class="postbody">
<br/>
<br/>
This field will let us know if data readed from touchscreen is valid. Then... how to know if data is valid? I've modified ReadTouchValue and touchReadXY:
<br/>
<br/>
source/arm7/touch.c
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">s32 readTouchValue(int measure, int retry , int range, u8 *bError) {
<br/>
//---------------------------------------------------------------------------------
<br/>
   int i;
<br/>
   s32 this_value=0, this_range;
<br/>
<br/>
   *bError=false;
<br/>
   s32 last_value = touchRead(measure | 1);
<br/>
<br/>
   for ( i=0; i &lt; retry; i++) {
<br/>
      this_value = touchRead(measure | 1);
<br/>
      this_range = abs(last_value - this_value);
<br/>
      if (this_range &gt; range) break;
<br/>
   }
<br/>
   
<br/>
   if ( i != retry) {this_value = 0; *bError=true; }
<br/>
   return this_value;
<br/>
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
As you can see, I've added a new boolean argument called error. The new struct of this function gets 'retry' values from the touchscreen and, if all of them are in the 'range', returns the last obtained value. In other case, it returns 0 and sets bError to true.
<br/>
<br/>
source/arm7/touch.c
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">touchPosition touchReadXY() {
<br/>
//---------------------------------------------------------------------------------
<br/>
<br/>
   touchPosition touchPos;
<br/>
   u8 error;
<br/>
<br/>
   touchPos.error=false;
<br/>
<br/>
   if ( !touchInit ) {
<br/>
<br/>
      xscale = ((PersonalData-&gt;calX2px - PersonalData-&gt;calX1px) &lt;&lt; 19) / ((PersonalData-&gt;calX2) - (PersonalData-&gt;calX1));
<br/>
      yscale = ((PersonalData-&gt;calY2px - PersonalData-&gt;calY1px) &lt;&lt; 19) / ((PersonalData-&gt;calY2) - (PersonalData-&gt;calY1));
<br/>
<br/>
      xoffset = ((PersonalData-&gt;calX1 + PersonalData-&gt;calX2) * xscale  - ((PersonalData-&gt;calX1px + PersonalData-&gt;calX2px) &lt;&lt; 19) ) / 2;
<br/>
      yoffset = ((PersonalData-&gt;calY1 + PersonalData-&gt;calY2) * yscale  - ((PersonalData-&gt;calY1px + PersonalData-&gt;calY2px) &lt;&lt; 19) ) / 2;
<br/>
      touchInit = true;
<br/>
   }
<br/>
<br/>
   touchPos.x = readTouchValue(TSC_MEASURE_X, _MaxRetry, _MaxRange, &amp;error);
<br/>
   if(error){
<br/>
      touchPos.error=true;
<br/>
      return touchPos;
<br/>
   }
<br/>
   touchPos.y = readTouchValue(TSC_MEASURE_Y, _MaxRetry, _MaxRange, &amp;error);
<br/>
   if(error){
<br/>
      touchPos.error=true;
<br/>
      return touchPos;
<br/>
   }
<br/>
<br/>
   s16 px = ( touchPos.x * xscale - xoffset + xscale/2 ) &gt;&gt;19;
<br/>
   s16 py = ( touchPos.y * yscale - yoffset + yscale/2 ) &gt;&gt;19;
<br/>
   
<br/>
   touchPos.z1 = readTouchValue( TSC_MEASURE_Z1, _MaxRetry, _MaxRange, &amp;error);
<br/>
   touchPos.z2 = readTouchValue( TSC_MEASURE_Z2, _MaxRetry, _MaxRange, &amp;error);
<br/>
<br/>
   if ( px &lt; 0) px = 0;
<br/>
   if ( py &lt; 0) py = 0;
<br/>
   if ( px &gt; (SCREEN_WIDTH -1)) px = SCREEN_WIDTH -1;
<br/>
   if ( py &gt; (SCREEN_HEIGHT -1)) py = SCREEN_HEIGHT -1;
<br/>
<br/>
   touchPos.px = px;
<br/>
   touchPos.py = py;
<br/>
<br/>
   return touchPos;
<br/>
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
Here it checks if there was an error reading X and Y values. If there was, it sets touchPos.error to true and goes out.
<br/>
<br/>
That's all. Then if you want to know if touchscreen is being touched you must do two things: first check IPC-&gt;buttons (or REG_KEYXY) and check if there wasn't any error reading data.
<br/>
<br/>
Changes in PAlib:
<br/>
<br/>
lib/arm7/PA.c
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void PA_UpdateStylus(void){
<br/>
//---------------------------------------------------------------------------------
<br/>
<br/>
   touchPosition tempPos = touchReadXY();
<br/>
<br/>
   IPC-&gt;touchError   = tempPos.error;
<br/>
   
<br/>
   IPC-&gt;touchX    = tempPos.x;
<br/>
    IPC-&gt;touchY    = tempPos.y;
<br/>
    IPC-&gt;touchXpx  = tempPos.px;
<br/>
    IPC-&gt;touchYpx  = tempPos.py;   
<br/>
   
<br/>
   IPC-&gt;touchZ1 = tempPos.z1;//touchRead(TSC_MEASURE_Z2);
<br/>
   IPC-&gt;touchZ2 = tempPos.z2;//touchRead(TSC_MEASURE_Z2);
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
I added a line that gets the possible data reading error  (the two last lines  have been modified too, but that only corrects a little bug :P It doesn't matter)
<br/>
<br/>
And finally:
<br/>
<br/>
lib/arm9/PA/PA_Keys.c
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void PA_UpdateStylus(void) {
<br/>
//u8 temp = (((~IPC-&gt;buttons) &lt;&lt; 6) &amp; (1&lt;&lt;12));
<br/>
u8 temp = (((~IPC-&gt;buttons) &gt;&gt; 6) &amp; 1) &amp;&amp; !IPC-&gt;touchError;
<br/>
<br/>
   Stylus.Pressure = (((IPC-&gt;touchXpx * IPC-&gt;touchZ2) &gt;&gt; 6) / IPC-&gt;touchZ1) - (IPC-&gt;touchXpx &gt;&gt; 6);
<br/>
   //if (Stylus.Pressure &gt; 10) temp = 0; // limit to good pressures
<br/>
<br/>
<br/>
   
<br/>
   Stylus.Released = ((!temp) &amp; Stylus.Held);
<br/>
   Stylus.Newpress = temp &amp; (!Stylus.Held);
<br/>
   Stylus.Held = temp;
<br/>
<br/>
   if (Stylus.Held) { // On en met ? jour que si on touche l'?cran, histoire de pas avoir un truc fauss?
<br/>
      Stylus.altX =  ((IPC-&gt;touchX - 0x0113) / 14);
<br/>
      Stylus.altY =  ((IPC-&gt;touchY - 0x00E0) / 19);
<br/>
   
<br/>
      if(Stylus.Newpress){
<br/>
         Stylus.X =  IPC-&gt;touchXpx;
<br/>
         Stylus.Y =  IPC-&gt;touchYpx;
<br/>
         Stylus.Vx = Stylus.oldVx = 0;
<br/>
         Stylus.Vy = Stylus.oldVy = 0;
<br/>
      }
<br/>
      else if (PA_Distance (Stylus.oldVx, Stylus.oldVy, Stylus.Vx, Stylus.Vy) &lt; 2500){ // Limit speed change
<br/>
         Stylus.oldVx = Stylus.Vx;
<br/>
         Stylus.oldVy = Stylus.Vy;   
<br/>
         Stylus.Vx = IPC-&gt;touchXpx - Stylus.X;
<br/>
         Stylus.Vy = IPC-&gt;touchYpx - Stylus.Y;               
<br/>
         Stylus.X = IPC-&gt;touchXpx;
<br/>
         Stylus.Y = IPC-&gt;touchYpx;
<br/>
      }
<br/>
      else {
<br/>
         Stylus.Vx = Stylus.oldVx;
<br/>
         Stylus.Vy = Stylus.oldVy;
<br/>
      }
<br/>
   }
<br/>
      
<br/>
   
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
The modified line is this:
<br/>
u8 temp = (((~IPC-&gt;buttons) &gt;&gt; 6) &amp; 1) &amp;&amp; !IPC-&gt;touchError;
<br/>
<br/>
As you can see, it avoids to detect a real screen touch that caused an error when arm7 readed data.
<br/>
<br/>
I've tested for 15min touching gently and I haven't noticed any 'jumping fail', but I've only tested it in 2 DS Lite. Test it and comment your results :D
<br/>
<br/>
PS: Sorry, I'm Spaniard and my English isn't very good :P</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#98830 - masscat - Thu Aug 17, 2006 9:11 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>PadrinatoR wrote:</b></span></td> </tr> <tr> <td class="quote">Yehaaa!! I think I've solved the jumping problem :D This solution is not based on pressure or any other possible variable that depends of the DS.</td> </tr></table><span class="postbody">
<br/>
Works nicely on my DS.
<br/>
<br/>
I am still curious why the touchscreen is returning bad readings in the first place. Is this normal for a touchscreen?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#98836 - PadrinatoR - Thu Aug 17, 2006 9:35 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>masscat wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>PadrinatoR wrote:</b></span></td> </tr> <tr> <td class="quote">Yehaaa!! I think I've solved the jumping problem :D This solution is not based on pressure or any other possible variable that depends of the DS.</td> </tr></table><span class="postbody">
<br/>
Works nicely on my DS.
<br/>
<br/>
I am still curious why the touchscreen is returning bad readings in the first place. Is this normal for a touchscreen?</span></td> </tr></table><span class="postbody">
<br/>
<br/>
^^  Well when you doesn't touch firmly the screen, the touchscreen might not be capable to detect what point was touched.
<br/>
<br/>
I don't know XD This is the first touchscreen I've used (I haven't got PDAs or something similar).</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#98890 - qw3rty - Fri Aug 18, 2006 9:13 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>PadrinatoR wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">s32 readTouchValue(int measure, int retry , int range, u8 *bError) {
<br/>
//---------------------------------------------------------------------------------
<br/>
   int i;
<br/>
   s32 this_value=0, this_range;
<br/>
<br/>
   *bError=false;
<br/>
   s32 last_value = touchRead(measure | 1);
<br/>
<br/>
   for ( i=0; i &lt; retry; i++) {
<br/>
      this_value = touchRead(measure | 1);
<br/>
      this_range = abs(last_value - this_value);
<br/>
      if (this_range &gt; range) break;
<br/>
   }
<br/>
   
<br/>
   if ( i != retry) {this_value = 0; *bError=true; }
<br/>
   return this_value;
<br/>
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
</span></td> </tr></table><span class="postbody">
<br/>
<br/>
If I understood your code right, when you set error = true, readTouchValue() returns 0 anyway !
<br/>
So, where's the difference ? (if the function returns 0, the position isn't read obviously !)
<br/>
<br/>
BUT I have tested you little draw APP, and it seems to actually WORK !
<br/>
there's absolutely NO jumping :O
<br/>
<br/>
The only difference I can think of, is that you discard the reading if ANY reading goes wrong (x,y,z1 or z2) - but shouldn't libnds do this anyway ?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#98909 - PadrinatoR - Fri Aug 18, 2006 1:32 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>qw3rty wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>PadrinatoR wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">s32 readTouchValue(int measure, int retry , int range, u8 *bError) {
<br/>
//---------------------------------------------------------------------------------
<br/>
   int i;
<br/>
   s32 this_value=0, this_range;
<br/>
<br/>
   *bError=false;
<br/>
   s32 last_value = touchRead(measure | 1);
<br/>
<br/>
   for ( i=0; i &lt; retry; i++) {
<br/>
      this_value = touchRead(measure | 1);
<br/>
      this_range = abs(last_value - this_value);
<br/>
      if (this_range &gt; range) break;
<br/>
   }
<br/>
   
<br/>
   if ( i != retry) {this_value = 0; *bError=true; }
<br/>
   return this_value;
<br/>
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
</span></td> </tr></table><span class="postbody">
<br/>
<br/>
If I understood your code right, when you set error = true, readTouchValue() returns 0 anyway !
<br/>
So, where's the difference ? (if the function returns 0, the position isn't read obviously !)
<br/>
<br/>
BUT I have tested you little draw APP, and it seems to actually WORK !
<br/>
there's absolutely NO jumping :O
<br/>
<br/>
The only difference I can think of, is that you discard the reading if ANY reading goes wrong (x,y,z1 or z2) - but shouldn't libnds do this anyway ?</span></td> </tr></table><span class="postbody">
<br/>
<br/>
There are a few differences:
<br/>
- 0 is a valid value, so you don't know when that 0 is returned because there was an error or because it's the correct value. Then if error is set to true, it doesn't matter what the function returns because those values won't be taken into account (as you can see in the modification of PA_Keys.c).
<br/>
<br/>
- Previous code only read 2 times the position, if all of them is in the range, the function returns that value, and if after 'retry' retries it hasn't got any value are the range, it discards all readed data and returns 0 (anyway it wasn't working well because the line before 'return this_value' was if ( i == <span style="font-weight: bold">range</span>) this_value = 0; and it should be <span style="font-weight: bold">retry</span>.
<br/>
<br/>
However, the modified code checks the touchscreen 'retry' times and if all times the obtained data is in the specified range around 'last_value', it's accepted. In other case it returns an error.
<br/>
<br/>
I hope these annoying jumps have dissapeared :D</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#98913 - wintermute - Fri Aug 18, 2006 2:12 pm</h4>
    <div class="postbody"><span class="postbody">I was about to say the same thing, the error flag is redundant. In theory the touch screen readings run from 0 to 4097, in practice the extreme values will never be seen so 0 was used as an error value. The original code does not report a pen down if either touchscreen co-ordinate is zero.
<br/>
<br/>
Interestingly Padrinator's code suggests that the range part of this code was the important part, rather than the number of retries. What I was attempting to acheive here was a settled value by repeated reading until all values were within a certain range. Being honest I'd assumed the "bendy" touchscreen readings were caused by not waiting for the value to settle but perhaps reading 2 or 3 times would suffice.<br/>_________________<br/><a class="postlink" href="http://www.devkitpro.org/" target="_blank">devkitPro - professional toolchains at amateur prices</a>
<br/>
<a class="postlink" href="http://wiki.devkitpro.org/index.php/IRC" target="_blank">devkitPro IRC support</a>
<br/>
<a class="postlink" href="http://davejmurphy.com/" target="_blank">Personal Blog</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#98914 - wintermute - Fri Aug 18, 2006 2:21 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>PadrinatoR wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
There are a few differences:
<br/>
- 0 is a valid value, so you don't know when that 0 is returned because there was an error or because it's the correct value. Then if error is set to true, it doesn't matter what the function returns because those values won't be taken into account (as you can see in the modification of PA_Keys.c).
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
0 is actually <span style="font-weight: bold">not</span> a valid value. In practice it's very rare to find values at the extremes of a range for any analog signal and, when you do, it usually indicates that the device has failed in some way.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
- Previous code only read 2 times the position, if all of them is in the range, the function returns that value, and if after 'retry' retries it hasn't got any value are the range, it discards all readed data and returns 0 (anyway it wasn't working well because the line before 'return this_value' was if ( i == <span style="font-weight: bold">range</span>) this_value = 0; and it should be <span style="font-weight: bold">retry</span>.
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Your results seem to indicate that if any of the values are in error then all of them are. It might be sufficient to read 2 values and check the range.<br/>_________________<br/><a class="postlink" href="http://www.devkitpro.org/" target="_blank">devkitPro - professional toolchains at amateur prices</a>
<br/>
<a class="postlink" href="http://wiki.devkitpro.org/index.php/IRC" target="_blank">devkitPro IRC support</a>
<br/>
<a class="postlink" href="http://davejmurphy.com/" target="_blank">Personal Blog</a></span><span class="gensmall"><br/><br/>Last edited by wintermute on Fri Aug 18, 2006 2:33 pm; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#98915 - PadrinatoR - Fri Aug 18, 2006 2:22 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>wintermute wrote:</b></span></td> </tr> <tr> <td class="quote">I was about to say the same thing, the error flag is redundant. In theory the touch screen readings run from 0 to 4097, in practice the extreme values will never be seen so 0 was used as an error value. The original code does not report a pen down if either touchscreen co-ordinate is zero.</td> </tr></table><span class="postbody">
<br/>
<br/>
I think I obtained a negative value from the touchscreen coordinates (before they were converted to pixel coordinates) when I was investigating what caused these jumps. But I may be wrong... that's the reason why I preferred to use an extra variable. Anyway, this method to control errors and pen touches can be improved a lot.
<br/>
<br/>
I think it was better to have a variable in IPC and touchPosition, called something like 'touched', whose value was determined by:
<br/>
(((~IPC-&gt;buttons) &gt;&gt; 6) &amp; 1) &amp;&amp; !IPC-&gt;touchError
<br/>
<br/>
(yes, like 'temp' variable in PA_UpdateStylus from PAlib)
<br/>
<br/>
With this you can forget REG_KEYXY and errors reading data independence, and we'll have all of it in only one variable.
<br/>
<br/>
Well, I've sent to drunken coders a modified version of libnds, until this changes are included in the official package more efficiently :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#98917 - PadrinatoR - Fri Aug 18, 2006 2:30 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>wintermute wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
0 is actually <span style="font-weight: bold">not</span> a valid value. In practice it's very rare to find values at the extremes of a range for any analog signal and, when you do, it usually indicates that the device has failed in some way.</td> </tr></table><span class="postbody">
<br/>
<br/>
Ok, as I said I remember to had obtained a negative value, so I considered 0 as a possible value.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>wintermute wrote:</b></span></td> </tr> <tr> <td class="quote">Your results seem to indicate that if any of the values are in error then all of them are. It might be sufficient to read 2 values and check the range.
<br/>
<br/>
it seems to me that </td> </tr></table><span class="postbody">
<br/>
<br/>
I think you're right because I've changed _MaxRetry to 3 and there is no jumpings :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#98934 - wintermute - Fri Aug 18, 2006 4:35 pm</h4>
    <div class="postbody"><span class="postbody">well, considering the value obtained from the touchscreen is 12bits it's kind of impossible to get a negative value there. I've seen the pixel co-ordinates go negative which is why they're clamped. The touchscreen test example displays the range of values at the edges, try it and see what you get.
<br/>
<br/>
If nothing else, doing a little research on the construction of resistive touch panels will show you that it's physically impossible to obtain values across the entire theoretical range.<br/>_________________<br/><a class="postlink" href="http://www.devkitpro.org/" target="_blank">devkitPro - professional toolchains at amateur prices</a>
<br/>
<a class="postlink" href="http://wiki.devkitpro.org/index.php/IRC" target="_blank">devkitPro IRC support</a>
<br/>
<a class="postlink" href="http://davejmurphy.com/" target="_blank">Personal Blog</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#99129 - PadrinatoR - Sat Aug 19, 2006 6:07 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>wintermute wrote:</b></span></td> </tr> <tr> <td class="quote">well, considering the value obtained from the touchscreen is 12bits it's kind of impossible to get a negative value there. I've seen the pixel co-ordinates go negative which is why they're clamped. The touchscreen test example displays the range of values at the edges, try it and see what you get.
<br/>
<br/>
If nothing else, doing a little research on the construction of resistive touch panels will show you that it's physically impossible to obtain values across the entire theoretical range.</td> </tr></table><span class="postbody">
<br/>
<br/>
Yes, you're right, I may not remember it well or something hehehe :P
<br/>
<br/>
Well I've been testing the drawing app and I had to change '_MaxRange' value because when you touch the border of the screen, it seems that values are less stables and always fall out of range.
<br/>
<br/>
With this values it seems to be solved (in my DS Lite):
<br/>
<br/>
static int _MaxRetry = 5;
<br/>
static int _MaxRange = 170;
<br/>
<br/>
If I reduce _MaxRetry using that range, there are jumps.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#99484 - PadrinatoR - Tue Aug 22, 2006 12:57 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>PadrinatoR wrote:</b></span></td> </tr> <tr> <td class="quote">With this values it seems to be solved (in my DS Lite):
<br/>
<br/>
static int _MaxRetry = 5;
<br/>
static int _MaxRange = 170;</td> </tr></table><span class="postbody">
<br/>
<br/>
I tested my app with this values in another DSLite and there are jumpings :( So it's needed to decrease _MaxRange :S</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#99595 - laurens - Tue Aug 22, 2006 4:27 pm</h4>
    <div class="postbody"><span class="postbody">The code that <a class="postlink" href="http://forum.gbadev.org/viewtopic.php?p=98815#98815" target="_blank">PadrinatoR</a> posted <span style="font-weight: bold">doesn't</span> work for me!
<br/>
either the drawit by padrinator and the draw3 by davr (that both uses the code) give me the same problem.
<br/>
The problem is that only a small area of my touchscreen is actually registered. so i can only touch, and thus paint, at only a very small spot.
<br/>
This is quite bad because i love drawing on my DS.
<br/>
to show what area i only can draw, i have saved an image using davr's Draw app.
<br/>
<br/>
these are the images (please notice that these are twice the size of the DS touchscreen).
<br/>
<br/>
<br/>
The first is made using the Brush tool.
<br/>
<a class="postlink" href="http://imageshack.us" target="_blank"></a><a href="http://img62.imageshack.us/img62/5591/060821204235bz5.png">[Images not permitted - Click here to view it]</a>
<br/>
<br/>
and the second is made by filling the background with black and using the eraser tool to make the white dot.
<br/>
<a class="postlink" href="http://imageshack.us" target="_blank"></a><a href="http://img129.imageshack.us/img129/6444/060821205144lm5.png">[Images not permitted - Click here to view it]</a>
<br/>
<br/>
<br/>
Hope you can help me.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#99599 - PadrinatoR - Tue Aug 22, 2006 4:52 pm</h4>
    <div class="postbody"><span class="postbody">O_o
<br/>
<br/>
I assume that you haven't a screen protector on your touchscreen, commercial games run fine in your DS, and you have calibrated your touchscreen right.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#99603 - PadrinatoR - Tue Aug 22, 2006 5:29 pm</h4>
    <div class="postbody"><span class="postbody">Please, check if this gives you the same results:
<br/>
<br/>
<a href="http://www.ftp.nu/files/5410/" target="_blank">http://www.ftp.nu/files/5410/</a>
<br/>
<br/>
I've seen that if I only take into account the FIRST obtained value and then try to draw at the borders, I get something like this:
<br/>
<br/>
<a href="http://usuarios.lycos.es/soypadrino/FirstTouchRead.PNG">[Images not permitted - Click here to view it]</a>
<br/>
<br/>
And the SECOND value is almost perfect (it depends of pressure, as you know) and lets me draw the borders almost perfect. Then, the code of "readTouchValue" function as I modified it, doesn't return a valid value when I touch the borders because the distance between the FIRST value and the SECOND value is more than 'range' so the function doesn't take into account this touch.
<br/>
<br/>
How to avoid this? I've ignored the FIRST value and taken the SECOND value to check if the next values are in the range:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">   s32 last_value = touchRead(measure | 1); //Dump
<br/>
   last_value = touchRead(measure | 1); //Reference value
<br/>
<br/>
   for ( i=0; i &lt; retry; i++) {
<br/>
      this_value = touchRead(measure | 1);
<br/>
      this_range = abs(last_value - this_value);
<br/>
      if (this_range &gt; range) break;
<br/>
   }</td> </tr></table><span class="postbody">
<br/>
<br/>
<br/>
That's the reason that forced me to increase _MaxRange, but with this change, I can use the initial values: _MaxRetry=5 and _MaxRange=30 and it work's perfectly (in my DS Lite).</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#99607 - laurens - Tue Aug 22, 2006 5:39 pm</h4>
    <div class="postbody"><span class="postbody">I do have a screen protector (a brando one, works fine, never had problems with it).
<br/>
Games work fine with the touchscreen.
<br/>
I just tried to calibrate my DS to see if it work after doing that, but it still doesn't.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#99608 - josath - Tue Aug 22, 2006 5:47 pm</h4>
    <div class="postbody"><span class="postbody">Some info on laurens' problem:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>laurens wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
Ive used the program before to, but im quite concerned now, as i can't use it probably anymore. i can only use a small portion of the screen to touch, ive saved a png of what i was able to draw, and i couldn't draw outside this black dot i managed to create. so i don't know whats the problem now, but its quite sad it didn't work.
<br/>
<br/>
see the attachments for the pictures, the first one is done with a brush, the second one is used by using the paint bucket tool with black and using the eraser i made a white part.
<br/>
</td> </tr></table><span class="postbody">
<br/>
Here are his example images, showing where he can draw on the screen:
<br/>
<a href="http://davr.org/ds2/laurens1.png" target="_blank">http://davr.org/ds2/laurens1.png</a>
<br/>
<a href="http://davr.org/ds2/laurens2.png" target="_blank">http://davr.org/ds2/laurens2.png</a>
<br/>
<br/>
Hopefully this problem can be sorted out, as otherwise this new code seems good.
<br/>
<br/>
EDIT: Whoops, didn't notice the other posts above, somehow I didn't reload, or I'm just blind :P</span><span class="gensmall"><br/><br/>Last edited by josath on Tue Aug 22, 2006 5:55 pm; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#99609 - laurens - Tue Aug 22, 2006 5:50 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>josath wrote:</b></span></td> </tr> <tr> <td class="quote">Some info on laurens' problem:
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>laurens wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
Ive used the program before to, but im quite concerned now, as i can't use it probably anymore. i can only use a small portion of the screen to touch, ive saved a png of what i was able to draw, and i couldn't draw outside this black dot i managed to create. so i don't know whats the problem now, but its quite sad it didn't work.
<br/>
<br/>
see the attachments for the pictures, the first one is done with a brush, the second one is used by using the paint bucket tool with black and using the eraser i made a white part.
<br/>
</td> </tr></table><span class="postbody">
<br/>
Here are his example images, showing where he can draw on the screen:
<br/>
<a href="http://davr.org/ds2/laurens1.png" target="_blank">http://davr.org/ds2/laurens1.png</a>
<br/>
<a href="http://davr.org/ds2/laurens2.png" target="_blank">http://davr.org/ds2/laurens2.png</a>
<br/>
<br/>
Hopefully this problem can be sorted out, as otherwise this new code seems good.</span></td> </tr></table><span class="postbody">
<br/>
Thanks for helping me out now, but as you told me in a previous PM, i already asked about this in the topic and showed the images, i also send a pm to PadrinatoR.
<br/>
Still thanks that you are actually putting effort in this for me =D</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#99616 - wintermute - Tue Aug 22, 2006 6:38 pm</h4>
    <div class="postbody"><span class="postbody">laurens: What boot method are you using to run these applications?<br/>_________________<br/><a class="postlink" href="http://www.devkitpro.org/" target="_blank">devkitPro - professional toolchains at amateur prices</a>
<br/>
<a class="postlink" href="http://wiki.devkitpro.org/index.php/IRC" target="_blank">devkitPro IRC support</a>
<br/>
<a class="postlink" href="http://davejmurphy.com/" target="_blank">Personal Blog</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#99617 - laurens - Tue Aug 22, 2006 6:38 pm</h4>
    <div class="postbody"><span class="postbody">Ok, the problem is <span style="font-weight: bold">solved</span> now!
<br/>
We now find a more accurate way to measure the touch screen and jumping lines, and padrinator is going to post his new fixed code v?ry soon now!
<br/>
be sure to update your homebrew when you've used it!
<br/>
<br/>
It had something to do with the first read data and the second read data. PadrinatoR was using the first read data as a reference point, but it seems that the second read data is much more accurate.
<br/>
He didn't post his new code yet, because he wasn't sure if it worked better at all. Then he gave his beta to me, and it seemed to work perfectly, very smooth and no weird jumping lines. Suddenly the answers all started to come up and he knew what was wrong and stuff. so hes updating the code a little now and is going to post it soon.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#99620 - PadrinatoR - Tue Aug 22, 2006 6:53 pm</h4>
    <div class="postbody"><span class="postbody">Yeah, it seems that all I've talked about in my last post does work for laurens :)
<br/>
<br/>
I hope these changes can help to improve libnds :D</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#99638 - Sausage Boy - Tue Aug 22, 2006 9:20 pm</h4>
    <div class="postbody"><span class="postbody">WOOO!<br/>_________________<br/>"no offense, but this is the gayest game ever"</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#99651 - PadrinatoR - Tue Aug 22, 2006 10:58 pm</h4>
    <div class="postbody"><span class="postbody">Please, test this file and tell me if you notice some of these things:
<br/>
<br/>
- Stylus jumping (you must touch gently the touchscreen)
<br/>
- You can't draw in some parts of the screen even if you touch hardly.
<br/>
<br/>
URL: <a href="http://www.ftp.nu/files/5419/" target="_blank">http://www.ftp.nu/files/5419/</a>
<br/>
<br/>
I've included the modified version of touch.c of libnds (libnds/source/arm7). The other changes are the same that I explained in:
<br/>
<br/>
<a href="http://forum.gbadev.org/viewtopic.php?p=98815#98815" target="_blank">http://forum.gbadev.org/viewtopic.php?p=98815#98815</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#99658 - tepples - Wed Aug 23, 2006 12:37 am</h4>
    <div class="postbody"><span class="postbody">PadrinatoR's tech demo works perfectly on my silver DS classic, came with FW2)<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#99714 - laurens - Wed Aug 23, 2006 3:34 pm</h4>
    <div class="postbody"><span class="postbody">Again, this one works absolutly perfect for me!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#99885 - PadrinatoR - Thu Aug 24, 2006 3:52 pm</h4>
    <div class="postbody"><span class="postbody">Thank you for answering. It seems that no one wants to fix this problem O_o
<br/>
<br/>
Anyway, I've been investigating a bit more.
<br/>
<br/>
Last code generates jumps in some DS where it's better to use the FIRST read data as reference value instead of the second one.
<br/>
<br/>
However I think I've found a solution for this problem, it's not perfect but very accurate. I suggest to use it with a Pressure limitation (a big interval, like 0-170 seems to be enough). Here you have a new test version which uses Pressure limitation and the new solution:
<br/>
<br/>
LINK: <a href="http://www.ftp.nu/files/5434/" target="_blank">http://www.ftp.nu/files/5434/</a>
<br/>
<br/>
As far as I know, this new method needs to avoid reading any measure that needs Single-Ended Mode (temperature, battery and aux inputs) because they seems to unstabilize the rest of measures (x, y and pressure), so I removed temp, battery and aux measures and changed z1 and z2 measures to differential mode. I think Nintendo may do it in this way... at least I've not seen any game that measures temperature or battery (there is a special byte which tell us how charged is our battery, so we needn't to measure it from the touchscreen, isn't it??).
<br/>
<br/>
Well, test these last files and tell me if you can draw in the whole screen and if you notice annoying jumps. This is the most accurate and compatible version I've written, I've combined the new solution with pressure limitation (0-170) so it should work on any DS with only a few little (very very little) jumps and let you draw in the whole screen. Thanks in advance!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#99952 - josath - Thu Aug 24, 2006 10:24 pm</h4>
    <div class="postbody"><span class="postbody">This works pretty good for me, except I have to press more firmly on the screen to get it to register. My comparison is always pictochat - with it, I don't have to press so hard and it draws fine. It's not a big problem, just a minor annoyance. It's not like I'm stabbing the screen or anything, just have to press harder than usual.
<br/>
<br/>
EDIT: One other issue...I can't draw to the top or left edges, theres about a 5 pixel border I cant draw into.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#99957 - PadrinatoR - Thu Aug 24, 2006 10:37 pm</h4>
    <div class="postbody"><span class="postbody">Thanks for answering :D
<br/>
<br/>
It may be the pressure limit... I'm trying other posibilities... I'm beginning to hate the touchscreen hahaha
<br/>
<br/>
It would be great to get PictoChat code and disassemble it to see how does it manage the touchscreen, but I'm not able to get it from firmware :@</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#99964 - josath - Thu Aug 24, 2006 10:51 pm</h4>
    <div class="postbody"><span class="postbody">well, we know that touchscreen can only be accessed by arm7, and also that most commercial nds apps use the same arm7 code, so if you want to disassemble, you could probably look at the arm7 bins from one of the official wifi demos.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#99965 - PadrinatoR - Thu Aug 24, 2006 11:02 pm</h4>
    <div class="postbody"><span class="postbody">Yes I'm trying to study commercial games' source, but I think PictoChat's code is shorter and more simple than, for example, Polarium's one.
<br/>
<br/>
But... what do you mean when you say 'wifi official demos'?? What are those demos??</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#99968 - josath - Thu Aug 24, 2006 11:31 pm</h4>
    <div class="postbody"><span class="postbody"><a href="http://wiki.akkit.org/Downloadable_DS_Demos" target="_blank">http://wiki.akkit.org/Downloadable_DS_Demos</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#100008 - PadrinatoR - Fri Aug 25, 2006 11:01 am</h4>
    <div class="postbody"><span class="postbody">I've disassembled Polarium Trial Version and I've found touchscreen code. I'm studying it now. I suppose that no one has disassembled a commercial game before in order to know how is the touchscreen managed, isn't it?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#100075 - tepples - Fri Aug 25, 2006 10:49 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>PadrinatoR wrote:</b></span></td> </tr> <tr> <td class="quote">I suppose that no one has disassembled a commercial game before in order to know how is the touchscreen managed, isn't it?</td> </tr></table><span class="postbody">
<br/>
Unsurprising. If more people on this board had disassembly skills and were willing to use them, we would have WiFiMe2 by now.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#100080 - zzo38computer - Fri Aug 25, 2006 11:08 pm</h4>
    <div class="postbody"><span class="postbody">If someone knows how to make it to work correctly without jumping, then I will add a calibration feature to FWNITRO<br/>_________________<br/><span style="font-weight: bold">Important:</span> Please send messages about FWNITRO to the public forum, not privately to me.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#100082 - PadrinatoR - Fri Aug 25, 2006 11:13 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>zzo38computer wrote:</b></span></td> </tr> <tr> <td class="quote">If someone knows how to make it to work correctly without jumping, then I will add a calibration feature to FWNITRO</td> </tr></table><span class="postbody">
<br/>
I'm invistigating that, and I've got a very accurate method to do this, but I must study more Brain Training's source.
<br/>
<br/>
Have you got Pictochat's source (ie, the source of the program loaded when you switch on your NDS)?? It may be a very little file with the needed algorithm, so it should be easy to analize.
<br/>
<br/>
<span style="font-weight: bold">tepples</span>, I thought that libnds, no$gba and other emus would be made by disassemble and study commercial games.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#100214 - HyperHacker - Sat Aug 26, 2006 9:47 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tepples wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>PadrinatoR wrote:</b></span></td> </tr> <tr> <td class="quote">I suppose that no one has disassembled a commercial game before in order to know how is the touchscreen managed, isn't it?</td> </tr></table><span class="postbody">
<br/>
Unsurprising. If more people on this board had disassembly skills and were willing to use them, we would have WiFiMe2 by now.</span></td> </tr></table><span class="postbody">
<br/>
Assuming any loaders are exploitable.<br/>_________________<br/>I'm a PSP hacker now, but I still &lt;3 DS.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#100215 - tepples - Sat Aug 26, 2006 9:51 pm</h4>
    <div class="postbody"><span class="postbody">But if some member of this board had actually tried this and found a loader to be more than likely not exploitable, he or she would have posted the info to the board (including a description of what kind of code authentication the subsequent stages of loading use), and we would have known about it by now.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#158522 - ritz - Thu Jun 12, 2008 9:14 pm</h4>
    <div class="postbody"><span class="postbody">Sorry to bring up an old thread, but I was wondering if this (or similar) code for alleviating the gentle-touch-jumping issue, as discussed earlier, has made it into libnds. If not, is it because each DS could possibly be too different in this regard for the code to be used in a common library?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#158524 - josath - Thu Jun 12, 2008 9:19 pm</h4>
    <div class="postbody"><span class="postbody">Have you updated to the latest libnds and tried it? I thought this sort of thing was fixed a long long time ago (notice this thread is almost 2 years old)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#158530 - ritz - Thu Jun 12, 2008 11:20 pm</h4>
    <div class="postbody"><span class="postbody">I'm using devARM 23b with "libnds 20071023" from sourceforge. I'm also using the new default ARM7 code from sourceforge "default am7 20080416". I thought I'd ask as I get funny/wild jumping on very gentle pen touches/movement in my DS app.
<br/>
I'll review my sources/installation when I get home to confirm these versions, etc. It is very possible I botched something up some day in the past and never noticed :)
<br/>
<br/>
Thanks for your reply.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#158532 - josath - Thu Jun 12, 2008 11:40 pm</h4>
    <div class="postbody"><span class="postbody">very gentle touches is likely gonna cause problems, but if you draw with normal pressure does it work ok?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#158543 - ritz - Fri Jun 13, 2008 4:42 am</h4>
    <div class="postbody"><span class="postbody">Yea, all my libs and source match what I said earlier. Must be as you said, josath, just too gentle. Regular pressing seems to work the majority of the time. It's just annoying when stuff flies all over the place instantly :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#158544 - josath - Fri Jun 13, 2008 5:48 am</h4>
    <div class="postbody"><span class="postbody">Most apps it doesn't matter, but if you're doing something like drawing, some clever filtering on your part can get rid of the jumps. No need to use special pressure sensors or anything like that, just do things like:
<br/>
<br/>
1. Disregard the first one or two frames of data when the pen is put down, if the points are too far apart, and:
<br/>
2. Disregard the last one or two frames of data before the pen is picked up, if the points are too far apart.
<br/>
<br/>
I think that should solve most problems.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#158547 - TwentySeven - Fri Jun 13, 2008 6:10 am</h4>
    <div class="postbody"><span class="postbody">What you probably want to use is a SMA or WMA
<br/>
<br/>
see: <a href="http://en.wikipedia.org/wiki/Moving_average" target="_blank">http://en.wikipedia.org/wiki/Moving_average</a>
<br/>
<br/>
think of it as input filtering
<br/>
<br/>
X= (X0+X1+X2+..+Xn)/n;
<br/>
Y= (Y0+Y1+Y2+..+Yn}/n;</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#158562 - ritz - Fri Jun 13, 2008 2:26 pm</h4>
    <div class="postbody"><span class="postbody">Thanks for the tips, I'll try them out.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#158617 - josath - Sat Jun 14, 2008 10:29 pm</h4>
    <div class="postbody"><span class="postbody">I don't know about averaging...the main problem is not noisy data, but a few outliers, that usually come at the very beginning and very end of a touch. I think averaging will give inaccurate results.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#158619 - silent_code - Sat Jun 14, 2008 11:39 pm</h4>
    <div class="postbody"><span class="postbody">You could try the newest release (1.3.0) of my VSdemo (go to my WWW), which has a rather smooth touch implementation. The only problem is, that it has a slight tendency to "drift" towards smaller values. I will hopfully fix that very soon. :^)<br/>_________________<br/><span style="font-size: 9px; line-height: normal"><span style="text-decoration: underline"><span style="font-weight: bold"></span></span> July 5th 08: "<span style="font-weight: bold">Volumetric Shadow Demo</span>" 1.6.0 (final) source released
<br/>
June 5th 08: "<span style="font-weight: bold">Zombie NDS</span>" WIP released!
<br/>
It's all on my page, just click <span style="font-weight: bold">WWW</span> below.</span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#159139 - Funky Gibbon - Wed Jun 25, 2008 11:57 pm</h4>
    <div class="postbody"><span class="postbody">There is a Faulty Batch of DS's, i had one, it would'nt calibrate properly, i did'nt realise it was a fault until someone told me about it, luckily the shop knew about the fault and exchanged my DS even a year after i bought it</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167129 - mbmax - Mon Mar 02, 2009 7:35 pm</h4>
    <div class="postbody"><span class="postbody">I have seen some people in this thread saying that moonshell works better with last modification made in touch library.
<br/>
It seems that the nightmare is here again on some DSL.
<br/>
I have opened this thread last year <a class="postlink" href="http://ezflash.sosuke.com/viewtopic.php?f=16&amp;t=13170" target="_blank">on unofficial ez forum</a> to collect as much as possible information before posting here. 
<br/>
If someone has a clue on what's going on and perhaps a way to fix that, i will be glad to read it. :)
<br/>
<br/>
Thanks.</span><span class="gensmall"><br/><br/>Last edited by mbmax on Tue Mar 03, 2009 11:58 am; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#167136 - Vague Rant - Tue Mar 03, 2009 5:57 am</h4>
    <div class="postbody"><span class="postbody">It's probably not a good idea to link to that board from here, I would recommend just quoting some important information.<br/>_________________<br/>I've got nothing to say, but it's OK.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167138 - qw3rty - Tue Mar 03, 2009 8:55 am</h4>
    <div class="postbody"><span class="postbody">Filtering out readings with too high accelerations worked quite well for me.
<br/>
(I talk about two year old libnds, but it should still hold true)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167142 - mbmax - Tue Mar 03, 2009 11:55 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Vague Rant wrote:</b></span></td> </tr> <tr> <td class="quote">It's probably not a good idea to link to that board from here, I would recommend just quoting some important information.</td> </tr></table><span class="postbody">
<br/>
There is so much informations inside that i really don't know what to quote.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>qw3rty wrote:</b></span></td> </tr> <tr> <td class="quote">Filtering out readings with too high accelerations worked quite well for me.
<br/>
(I talk about two year old libnds, but it should still hold true)</td> </tr></table><span class="postbody">
<br/>
Thanks for your answer qw3rty. If i can reach moonlight again, i will inform him about this. ;)</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
