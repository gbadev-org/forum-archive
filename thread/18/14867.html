<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>How to detect DLDI patching ? - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > How to detect DLDI patching ?</h2>
<div id="posts">
<div class="post">
    <h4>#149325 - PypeBros - Fri Jan 18, 2008 1:51 pm</h4>
    <div class="postbody"><span class="postbody">I am trying to load a .nds from another .nds file, reusing the chism stub and some code from DSChannels. As far as i can tell, there is no way to work around the need for a "card.dldi" file stored at a well-known location on the media card, right ? 
<br/>
<br/>
the .nds to be loaded comes from a network download, so i'd rather avoid to require pre-patching of the file and would like the patch to be applied "live" at run-time. Still, i'd like to allow users who don't need a .dldi patch (e.g. because they have a linker directly supported by libfat) to work without it, which means i need a way to detect whether the driver the libfat is using right now comes from a patch or is a "native" part of the libfat.
<br/>
<br/>
Any clue on how i should proceed ? 
<br/>
(i was thinking of comparing the address of the driver's readblock funtion with the end of compile-time size of the binary, but i fear that'd be a too hackish way to proceed)...
<br/>
<br/>
Thanks in advance.<br/>_________________<br/><a class="postlink" href="http://sylvainhb.blogspot.com/p/sprite-editor.html" target="_blank"> SEDS: Sprite Edition on DS</a> :: <a class="postlink" href="http://sylvainhb.blogspot.com/search/label/modplayer" target="_blank">modplayer</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#149333 - Lick - Fri Jan 18, 2008 3:58 pm</h4>
    <div class="postbody"><span class="postbody">If the .nds is loaded from network, couldn't you tell the file server to patch it with the device's DLDI patch before sending it?
<br/>
<br/>
Also, how can the receiving.nds not be DLDI patched if it needs to write a downloaded.nds? Or is the downloaded.nds only in memory?<br/>_________________<br/><a class="postlink" href="http://licklick.wordpress.com" target="_blank">http://licklick.wordpress.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#149337 - PypeBros - Fri Jan 18, 2008 5:33 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Lick wrote:</b></span></td> </tr> <tr> <td class="quote">If the .nds is loaded from network, couldn't you tell the file server to patch it with the device's DLDI patch before sending it?
<br/>
</td> </tr></table><span class="postbody">
<br/>
That would require the DS to identify the device type, send it to the server, have some sort of .cgi script to perform the patching and host .dldi patches altogether with the offered .nds ... i have to admit i'd prefer an alternate solution ...
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
Also, how can the receiving.nds not be DLDI patched if it needs to write a downloaded.nds? Or is the downloaded.nds only in memory?</td> </tr></table><span class="postbody">
<br/>
Well, i might have receiving.nds not to be patched (and downloaded needing no patching), or i might have receiving.nds patched (either by the user or by the linker). What i'd like to avoid is requiring the user to have card.dldi when the linker needs no patching.
<br/>
<br/>
I tried something like
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
 if (fat &amp;&amp; fat-&gt;disc &amp;&amp; 
<br/>
      fat-&gt;disc-&gt;fn_readSectors&gt;(void*)&amp;__text_end) {
<br/>
    char* name=(char*)&amp;(fat-&gt;disc-&gt;ioType);
<br/>
    iprintf("detected a DLDI driver in use for %c%c%c%c\n",
<br/>
       name[0],name[1],name[2],name[3]);
<br/>
    return true;
<br/>
  }
<br/>
</td> </tr></table><span class="postbody">
<br/>
assuming that the code for DLDI "readSectors" would be appended after the normal .text section, but it doesn't seem to work properly. (e.g. it always thing there is a built-in driver)
<br/>
<br/>
edit: i'm using a Supercard SD (slot 2) for testing. Could it be that the libfat prefers its internal driver to the DLDI one ? Even after i applied dlditool ?<br/>_________________<br/><a class="postlink" href="http://sylvainhb.blogspot.com/p/sprite-editor.html" target="_blank"> SEDS: Sprite Edition on DS</a> :: <a class="postlink" href="http://sylvainhb.blogspot.com/search/label/modplayer" target="_blank">modplayer</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#149340 - olimar - Fri Jan 18, 2008 6:27 pm</h4>
    <div class="postbody"><span class="postbody"></span><span class="gensmall"><br/><br/>Last edited by olimar on Wed Aug 20, 2008 10:53 pm; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#149382 - PypeBros - Sat Jan 19, 2008 12:35 pm</h4>
    <div class="postbody"><span class="postbody">i'm not sure to understand what you suggest, olimar. A built-in driver for SCSD, for instance, define its feature as
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
 FEATURE_MEDIUM_CANREAD | FEATURE_MEDIUM_CANWRITE | FEATURE_SLOT_GBA,
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
and despite it's not a DLDI plugin, it would be considered as "DLDI driver" by your test.
<br/>
<br/>
<br/>
???<br/>_________________<br/><a class="postlink" href="http://sylvainhb.blogspot.com/p/sprite-editor.html" target="_blank"> SEDS: Sprite Edition on DS</a> :: <a class="postlink" href="http://sylvainhb.blogspot.com/search/label/modplayer" target="_blank">modplayer</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#149431 - olimar - Sun Jan 20, 2008 12:46 am</h4>
    <div class="postbody"><span class="postbody"></span><span class="gensmall"><br/><br/>Last edited by olimar on Wed Aug 20, 2008 10:53 pm; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#149438 - Bloodypriest - Sun Jan 20, 2008 1:46 am</h4>
    <div class="postbody"><span class="postbody">Not sure if it's gonna be easy or not but can't you just memcpy the DLDI driver from your master.nds to your slave.nds*. 
<br/>
<br/>
From what I can tell, you are already able to apply a DLDI patch at runtime, except you do it from a card.dldi file. So why not locate the current DLDI driver in memory instead?
<br/>
<br/>
* Sorry if I changed the names but I thought it would be clearer that way which was which.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#149455 - PypeBros - Sun Jan 20, 2008 12:11 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>olimar wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
Maybe this?
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">if (fat &amp;&amp; fat-&gt;disc &amp;&amp; *(((u32*)fat-&gt;disc)-0x18)==0xBF8DA5ED) { 
<br/>
    //DLDI driver in use
<br/>
}</td> </tr></table><span class="postbody"></span></td> </tr></table><span class="postbody">
<br/>
This is checking whether there is a DLDI header *before* the io_interface description, isn't it ?
<br/>
Hmm ... That might work (unless the magic number is erased by the libfat on init, but i guess libfat won't mess with such things).
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
Not sure if it's gonna be easy or not but can't you just memcpy the DLDI driver from your master.nds to your slave.nds*.
<br/>
<br/>
From what I can tell, you are already able to apply a DLDI patch at runtime, except you do it from a card.dldi file. So why not locate the current DLDI driver in memory instead? 
<br/>
</td> </tr></table><span class="postbody">
<br/>
I haven't investigated this so far. Clearly it could be done if DLDI drivers were just "appended" to a .nds binary, but they are also patched, to fit their new location. Whether it can be "detached" or not has never been tried afaik, and the loader i'm using does not seem to provide that.<br/>_________________<br/><a class="postlink" href="http://sylvainhb.blogspot.com/p/sprite-editor.html" target="_blank"> SEDS: Sprite Edition on DS</a> :: <a class="postlink" href="http://sylvainhb.blogspot.com/search/label/modplayer" target="_blank">modplayer</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#149465 - Lick - Sun Jan 20, 2008 3:15 pm</h4>
    <div class="postbody"><span class="postbody">Chishm has already proven that it works. His VRAM boot stub gets patched before it's executed. There's hackery involved so check its source.<br/>_________________<br/><a class="postlink" href="http://licklick.wordpress.com" target="_blank">http://licklick.wordpress.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#149510 - PypeBros - Mon Jan 21, 2008 10:24 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Lick wrote:</b></span></td> </tr> <tr> <td class="quote">Chishm has already proven that it works. His VRAM boot stub gets patched before it's executed. There's hackery involved so check its source.</td> </tr></table><span class="postbody">
<br/>
thanks. I'll google that.<br/>_________________<br/><a class="postlink" href="http://sylvainhb.blogspot.com/p/sprite-editor.html" target="_blank"> SEDS: Sprite Edition on DS</a> :: <a class="postlink" href="http://sylvainhb.blogspot.com/search/label/modplayer" target="_blank">modplayer</a></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
