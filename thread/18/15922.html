<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Ugh, DMA set-up time bizarreness - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>DS development > Ugh, DMA set-up time bizarreness</h2>
<div id="posts">
<div class="post">
    <h4>#161597 - simonjhall - Wed Aug 06, 2008 10:55 pm</h4>
    <div class="postbody"><span class="postbody">I think I'm missing something here!
<br/>
I'm using</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">static inline void dmaCopyHalfWordsAsynch(uint8 channel, const void* src, void* dest, uint32 size) {
<br/>
   DMA_SRC(channel) = (uint32)src;
<br/>
   DMA_DEST(channel) = (uint32)dest;
<br/>
   DMA_CR(channel) = DMA_COPY_HALFWORDS | (size&gt;&gt;1);
<br/>
}</td> </tr></table><span class="postbody">as my DMA function. As far as I can see, there's no blocking going on here. However here's what I'm doing:</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">printf("before %d\n", *(volatile unsigned short *)0x4000006);
<br/>
   dmaCopyHalfWordsAsynch(0, (void *)0x2750000, (void *)0x2770000, 5 * 1024);
<br/>
   dmaCopyHalfWordsAsynch(1, (void *)0x2750000, (void *)0x2770000, 5 * 1024);
<br/>
   dmaCopyHalfWordsAsynch(2, (void *)0x2750000, (void *)0x2770000, 5 * 1024);
<br/>
   dmaCopyHalfWordsAsynch(3, (void *)0x2750000, (void *)0x2770000, 5 * 1024);
<br/>
<br/>
   printf("after %d\n", *(volatile unsigned short *)0x4000006);</td> </tr></table><span class="postbody">I don't care what the data is doing, I don't care that they overlap, and I only vaguely care about the size.
<br/>
<br/>
That magic number I'm print before and after is the vcount register. Only the vertical blank interrupt is on. The ARM7 is idle.
<br/>
<br/>
If I comment out DMAs #2, 3 &amp; 4 my vcount advances by one, my vblank count doesn't increase. This is what I'd expect, as what I'm measuring is the set-up time of a DMA. If I uncomment DMA #2 the time between the two gaps is still 0 vblanks and the vcount has increased to 152. That's quite a long time! If I make it so that they don't overlap I get the exact same result.
<br/>
<br/>
If I change the first function call to be to dmaCopyHalfWords (which blocks at the end) the amount of time is the same!
<br/>
<br/>
If I change it back to the asynchronous version and uncomment the remaining two DMAs (so all four are apparently running asynchronously) the vcount increases to 190. If I make the first three synchronous and the final one asynchronous, vcount ends up at 191.
<br/>
<br/>
I've tried sticking other timing mechanisms around this code (eg timers) and I can verify this result...it looks like as soon as you try and schedule a DMA (whether it's asynchronous or not) but another one is already running it'll block when it's issued. It will literally wait for any pending DMA transfers to finish before a new one can be issued! I think the DMA system has a one-element deep queue and if you try and write another one, it'll block the CPU.
<br/>
<br/>
Can anyone else please verify this?<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161599 - HyperHacker - Wed Aug 06, 2008 11:27 pm</h4>
    <div class="postbody"><span class="postbody">I did pretty much the same thing, and when I went from one asynchronous DMA transfer to four, the operation took about 1/4 as long to complete, just as you'd expect. Maybe the issue here is all four are trying to access the same memory?
<br/>
IIRC, I was copying from RAM to VRAM, maybe RAM to RAM doesn't work as well.<br/>_________________<br/>I'm a PSP hacker now, but I still &lt;3 DS.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161600 - elhobbs - Thu Aug 07, 2008 12:07 am</h4>
    <div class="postbody"><span class="postbody">I think this has already been confirmed form main memory to main memory dma copies in this thread
<br/>
<a class="postlink" href="http://forum.gbadev.org/viewtopic.php?t=13242&amp;postdays=0&amp;postorder=asc&amp;highlight=dma+vram+speed&amp;start=15" target="_blank">http://forum.gbadev.org/viewtopic.php?t=13242&amp;postdays=0&amp;postorder=asc&amp;highlight=dma+vram+speed&amp;start=15</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161609 - ritz - Thu Aug 07, 2008 5:03 am</h4>
    <div class="postbody"><span class="postbody">So basically the problem is that the CPU halts after the first set of DMA_* (because it's DMA'ing now) preventing you from running the next few instructions that load the data into the last 3 DMA_* ports.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">The CPU can be kept running during DMA, provided that it is accessing only TCM (or cached memory), otherwise the CPU is halted until DMA finishes.
<br/>
Respectively, interrupts executed during DMA will usually halt the CPU (unless the IRQ handler uses only TCM and cache; the IRQ vector at FFFF00xxh must be cached, or relocated to ITCM at 000000xxh, and the IRQ handler may not access IE, IF, or other I/O ports).</td> </tr></table><span class="postbody">
<br/>
So, one way to use all 4 channels at the exact time, one would need to set all 4 of the DMA*FILL ports with addresses ahead of time and then set the execution time:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">  0  Start Immediately
<br/>
  1  Start at V-Blank
<br/>
  2  Start at H-Blank (paused during V-Blank)
<br/>
  3  Synchronize to start of display
<br/>
  4  Main memory display
<br/>
  5  DS Cartridge Slot
<br/>
  6  GBA Cartridge Slot
<br/>
  7  Geometry Command FIFO</td> </tr></table><span class="postbody">
<br/>
Does this make sense? Please correct me if I'm wrong (I'm not sure if this is valid).</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161611 - simonjhall - Thu Aug 07, 2008 7:46 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>ritz wrote:</b></span></td> </tr> <tr> <td class="quote">So basically the problem is that the CPU halts after the first set of DMA_* (because it's DMA'ing now) preventing you from running the next few instructions that load the data into the last 3 DMA_* ports.</td> </tr></table><span class="postbody">Nah, the first one does run asychronously and the CPU doesn't block but the instant you try and set another DMA up, it'll pause.
<br/>
<br/>
I'll have a go with what you suggest though, and set them up ahead of time and see what happens :-)<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161620 - zeruda - Thu Aug 07, 2008 9:19 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>HyperHacker wrote:</b></span></td> </tr> <tr> <td class="quote">Specifically, what I'm doing is calling <b style="color:#FFA34F">dmaCopyWordsAsynch</b>() for channels 0, 1 and 2 and dmaCopyWords() for channel 3.</td> </tr></table><span class="postbody">
<br/>
<br/>
Have you tried it like that?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161623 - Dwedit - Thu Aug 07, 2008 10:06 pm</h4>
    <div class="postbody"><span class="postbody">DmaCopyWords and DmaCopyWordsAsync are both preprocessor macros.
<br/>
The one without async also contains a spinwait loop for the DMA to finish.<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
