<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>GBA SAVERAM WARNING!! - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > GBA SAVERAM WARNING!!</h2>
<div id="posts">
<div class="post">
    <h4>#44600 - Darkain - Fri Jun 03, 2005 9:37 am</h4>
    <div class="postbody"><span class="postbody">dispite the topic mentioning GBA, this is indeed specific to, and only to, the Nintendo DS.
<br/>
<br/>
<span style="font-weight: bold">DONT DIRECTLY WRITE TO GBA SAVERAM IN YOUR NDS CODE WITHOUT FIRST CHECKING TO MAKE SURE IT IS OK</span>
<br/>
<br/>
here is the basic hypothetical situation that was brought up in #dsdev the other night... lets say you have a commercial GBA cart inside of your DS, and you WMB (wireless multi-boot) a NDS demo using WifiMe to the DS.  This demo supports saving high scores to the GBA cart...  WOOPSIES!! there goes your commercial game's save data!!!
<br/>
<br/>
DesktopMan and I discussed this for a bit, and agreed upon a common sollution to fix this problem.  You should read from the data area on the cart first and make a simple check.  At byte offset 0x080000AC, there is a 4 byte non-null terminating string containing the value "<span style="font-weight: bold">PASS</span>".  this, from here on forward, will be considered as STANDARD PRACTICE for ALL .NDS loader bootstraps from gba cart.  Here is a basic example of a check to see if it is indeed a flashcart sporting a homebrew nds loader:</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">  if (memcmp((void*)0x080000AC, "PASS", 4) == 0) {
<br/>
    SaveMyGame();
<br/>
  }</td> </tr></table><span class="postbody">
<br/>
<br/>
This value should be checked EVERY SINGLE TIME you try to write data to the saveram, just in case the user swapped carts during usage.
<br/>
<br/>
By default in DevKitARM/PRO r12 (i'm not sure about latest CVS tho), the CRT0 was accidently setup incorrectly for the ARM9 CPU.  It provented you from writing to saveram all together.  I now personally see this as a somewhat GOOD thing just to make sure bad things dont happen.  This is very easy to fix.  In the file <span style="font-style: italic">DevKitArm/arm-elf/lib/ds_arm9_crt0.s</span>, line 132 contains the "DAccess" restrictions (<a class="postlink" href="http://www.arm.com/pdfs/DDI0155A_946ES.pdf" target="_blank">big ass PDF explaining in detail what it means</a>).  This value should be changed to <span style="font-weight: bold">0x36033333</span> to allow read/write access to the GBA Saveram in both usr and svc mode.  This also allows for writing to gba data cart addresses, which is helpful for access cart registers for page flipping and flashing from the unit itself.  here is what the crt0 section should look like:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">   @-------------------------------------------------------------------------
<br/>
   @ IAccess
<br/>
   @-------------------------------------------------------------------------
<br/>
   ldr   r0,=0x06606333
<br/>
   mcr   p15, 0, r0, c5, c0, 3
<br/>
<br/>
   @-------------------------------------------------------------------------
<br/>
   @ DAccess
<br/>
   @-------------------------------------------------------------------------
<br/>
   ldr   r0,=0x36033333
<br/>
   mcr     p15, 0, r0, c5, c0, 2</td> </tr></table><span class="postbody">
<br/>
<br/>
Once this modification has been made, you will need to recompile the CRT file.  This can be done by opening a console window and going to <span style="font-style: italic">devkitarm/arm-elf/lib</span>, and then typing in <span style="font-style: italic">make CRT=ds_arm9</span>.  from here, you should get an output like this:</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">C:\devkitarm\arm-elf\lib&gt;<span style="font-weight: bold">make CRT=ds_arm9</span>
<br/>
arm-elf-gcc  -x assembler-with-cpp -marm -c ds_arm9_crt0.s -ods_arm9_crt0.o
<br/>
arm-elf-gcc  -x assembler-with-cpp -marm -mthumb-interwork -c ds_arm9_crt0.s -o
<br/>
interwork/ds_arm9_crt0.o
<br/>
arm-elf-gcc  -x assembler-with-cpp -mthumb -c ds_arm9_crt0.s -o thumb/ds_arm9_cr
<br/>
t0.o
<br/>
arm-elf-gcc  -x assembler-with-cpp -mthumb -mthumb-interwork -c ds_arm9_crt0.s -
<br/>
o thumb/interwork/ds_arm9_crt0.o
<br/>
<br/>
C:\devkitarm\arm-elf\lib&gt;</td> </tr></table><span class="postbody"><br/>_________________<br/>-=- Darkain Dragoon -=-
<br/>
<a class="postlink" href="http://www.darkain.com" target="_blank">http://www.darkain.com</a>
<br/>
<a class="postlink" href="http://ds.darkain.com/hack" target="_blank">DarkStar</a> for <a class="postlink" href="http://ds.darkain.com" target="_blank">Nintendo DS</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#44604 - miqualke - Fri Jun 03, 2005 12:53 pm</h4>
    <div class="postbody"><span class="postbody">good thing that you warn us.
<br/>
i've just started to implement highscore.
<br/>
thx for the info</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
