<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Sound Streaming - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>DS development > Sound Streaming</h2>
<div id="posts">
<div class="post">
    <h4>#141250 - goruka - Sun Sep 23, 2007 3:45 pm</h4>
    <div class="postbody"><span class="postbody">Hi! What is the best way to do sound streaming on the DS ?
<br/>
I just want a buffer to mix samples to, constantly, and some sort of interrupt that will ask me to feed more data.
<br/>
<br/>
Thanks!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#141263 - ThomasS - Sun Sep 23, 2007 5:15 pm</h4>
    <div class="postbody"><span class="postbody">Using a ring buffer should be the best way (at least it's the way my <a class="postlink" href="http://forum.gbadev.org/viewtopic.php?t=13448&amp;start=0&amp;postdays=0&amp;postorder=asc&amp;highlight=ringbuffer" target="_blank">mp3 decoding examples</a> work).
<br/>
I can't recall from which thread I got the demo I based my mp3 code on, but you can easily throw away the mp3 part of my demos and put in your mix code.
<br/>
You can choose if you want to mix to the buffer on the arm9 or on the arm7.<br/>_________________<br/>&lt;<a class="postlink" href="http://palib.info/forum/modules/newbb/viewtopic.php?viewmode=flat&amp;type=&amp;topic_id=3108&amp;forum=10" target="_blank">dsFont</a>&gt; &lt;<a class="postlink" href="http://palib.info/forum/modules/newbb/viewtopic.php?topic_id=2451&amp;forum=9" target="_blank">Game Collection</a>&gt;</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#141265 - simonjhall - Sun Sep 23, 2007 5:32 pm</h4>
    <div class="postbody"><span class="postbody">The lack of any interrupt when the ring buffer is (near-)empty makes writing this sort of thing a real pain.
<br/>
<br/>
After trying many schemes, the most effective one I found was to take the sound timer settings you use to start a playing the buffer on the ARM7 and make another timer (say TIMER0) with the exact same setup. If you then make another timer (at TIMER1) and get it to pick up the result from TIMER0 when it overflows (there's a cascade flag for this sort of thing) you'll be able to count the number of samples that have elapsed since the sound buffer started playing. To figure out when the buffer has finished playing, set TIMER1 to 65536 - number of samples in the buffer. Then make TIMER2 pick up the results from TIMER1 on overflow and every time the value in TIMER2 changes you'll know your buffer has drained.
<br/>
<br/>
To clarify a bit, set your timers like this:
<br/>
TIMER0 - set it up with the exact same timer settings as the sound hardware is using, eg SOUND_FREQ(sampleRate)
<br/>
TIMER1 - set it to 65536 - number of samples in buffer and turn cascading on
<br/>
TIMER2 - set it to zero, and turn cascading on.
<br/>
<br/>
So, without using interrupts this'll allow you to find out when your buffer is empty and there shouldn't be any drift since both the timers and sound hardware are derived from the same timer settings and bus clock. If you do use interrupts to figure out when stuff happens, if you miss interrupts (eg you were inside another interrupt handler) then you'll get drift and the dreaded clicking!
<br/>
<br/>
Btw I think there's some mistakes in the timer setup I've got there, since I just wrote this from memory! At one point I had missed out one clock cycle per sample (I think it may be 65535 - number, rather than 65536 - number) and the music got out of sync after a few minutes.
<br/>
<br/>
Btw 2: do all this on the ARM7, as it'll be much easier.
<br/>
<br/>
Again, world of pain :-)<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#141301 - goruka - Sun Sep 23, 2007 10:22 pm</h4>
    <div class="postbody"><span class="postbody">That kind of sucks..  from what i see in libnds , it's pretty difficult, and even more if i want to use stereo (have to use 2 sound channels ). Strangely, there seems to be no FIFO like register i can dma-to like in the GBA.
<br/>
<br/>
Moonshell uses a lot of custom code for handling audio, and the examples linked above use PAlib (i'm using libnds). Any idea where i can find simple code examples for sound streaming? I'm basically almost done porting a tracker to the DS.. all the UI works like a charm, but can't find how to stream the audio in any decent way.. plus, i need to mix the audio in the ARM9 , as mixing has to be done in software.
<br/>
<br/>
Thanks!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#141320 - DekuTree64 - Mon Sep 24, 2007 2:25 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>goruka wrote:</b></span></td> </tr> <tr> <td class="quote">That kind of sucks..  from what i see in libnds , it's pretty difficult, and even more if i want to use stereo (have to use 2 sound channels ).</td> </tr></table><span class="postbody">
<br/>
It's not really any more difficult to do stereo. Just start 2 channels at the same time and you can use the same timer to track their positions. The sound hardware itself is pretty easy to use too, just check the <a class="postlink" href="http://nocash.emubase.de/gbatek.htm#dssound" target="_blank">register descriptions in gbatek</a>.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Strangely, there seems to be no FIFO like register i can dma-to like in the GBA.</td> </tr></table><span class="postbody">
<br/>
On DS, each sound channel has its own DMA, so they don't even have a destination address to set.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Any idea where i can find simple code examples for sound streaming?</td> </tr></table><span class="postbody">
<br/>
I don't have any simple example code around, but here's some pseudo code of what I do in my half done tracker (also running a software mixer on ARM9):
<br/>
<br/>
ARM9:
<br/>
- Set REG_IE to disable all interrupts except IPC fifo empty/not empty.
<br/>
- Send a FIFO message to ARM7 telling it to start the ring buffer.
<br/>
- Wait for ARM7 to set a variable in shared memory.
<br/>
- Start cascaded timers, similar to Simon's explanation.
<br/>
- Restore REG_IE.
<br/>
<br/>
ARM7:
<br/>
- When buffer start message is recieved, start sound channels and set the shared variable.
<br/>
<br/>
For FIFO messaging, check out the system I wrote <a class="postlink" href="http://forum.gbadev.org/viewtopic.php?p=132370&amp;highlight=#132370" target="_blank">here</a>. I'm using the unbuffered version, but either should work just as well for this.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">I'm basically almost done porting a tracker to the DS.. all the UI works like a charm, but can't find how to stream the audio in any decent way.. plus, i need to mix the audio in the ARM9 , as mixing has to be done in software.</td> </tr></table><span class="postbody">
<br/>
Cool, what tracker is it? I could use a bit of inspiration to get back working on mine. I'm in that terrible place where all the fun stuff is done, and all there is to do is code up a bunch of menus, and fix bugs in the music player.<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#141336 - goruka - Mon Sep 24, 2007 6:42 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>DekuTree64 wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
Cool, what tracker is it? I could use a bit of inspiration to get back working on mine. I'm in that terrible place where all the fun stuff is done, and all there is to do is code up a bunch of menus, and fix bugs in the music player.</td> </tr></table><span class="postbody">
<br/>
<br/>
I'm porting my own, ChibiTracker to Nintendo DS (http://www.chibitracker.com) It's pretty much done and the UI works very nicely on the DS. I'll be using the C software mixing routines in the ARM9, and will most likely write assembler optimized ones at some point, though for now i think they are enough. 
<br/>
<br/>
The tracker runs pretty good on a Pentium 60, on a song using many channels, so I hope the ARM9 at 66mhz is a better CPU than that and it will handle most songs fine.
<br/>
<br/>
here's a peek at how it's coming along:
<br/>
<br/>
<a href="http://reduz.dyndns.org/chibitracker_ds.nds" target="_blank">http://reduz.dyndns.org/chibitracker_ds.nds</a> (dldi it)
<br/>
<br/>
As you can see pretty much everything works except sound, and you can fully load, edit, save .IT, .XM, .S3M, .MOD files.. 
<br/>
<br/>
I thoguht sound was going to be easier to get to work, but not having much luck, so help in that area is highly appreciated
<br/>
<br/>
Cheers!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#141354 - ThomasS - Mon Sep 24, 2007 1:29 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">the examples linked above use PAlib</td> </tr></table><span class="postbody">
<br/>
No, they only use libnds. To change them to your needs, you only had to paste your own mixing routine in the function
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">// Must fill the ring buffer ((s16*)stream) with numsamples samples.
<br/>
int SoundMixCallback(void *stream, u32 numsamples)
<br/>
{
<br/>
   // ... code to decode mp3s ...
<br/>
}</td> </tr></table><span class="postbody"><br/>_________________<br/>&lt;<a class="postlink" href="http://palib.info/forum/modules/newbb/viewtopic.php?viewmode=flat&amp;type=&amp;topic_id=3108&amp;forum=10" target="_blank">dsFont</a>&gt; &lt;<a class="postlink" href="http://palib.info/forum/modules/newbb/viewtopic.php?topic_id=2451&amp;forum=9" target="_blank">Game Collection</a>&gt;</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#141393 - Lazy1 - Mon Sep 24, 2007 11:02 pm</h4>
    <div class="postbody"><span class="postbody">How would streaming from disk work in all of this?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#141401 - goruka - Tue Sep 25, 2007 1:15 am</h4>
    <div class="postbody"><span class="postbody">Well, not having much luck.. if i use the sound library from that mp3 player, touchscreen stops responding.. keys still work though... no idea why it may be :(</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#141402 - Lazy1 - Tue Sep 25, 2007 1:24 am</h4>
    <div class="postbody"><span class="postbody">The Arm7 code that comes with that MP3 example looks outdated, try getting the default Arm7 template and manually adding the needed changes.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#141420 - ingramb - Tue Sep 25, 2007 4:59 am</h4>
    <div class="postbody"><span class="postbody">So this is set up on the arm7:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">To clarify a bit, set your timers like this:
<br/>
TIMER0 - set it up with the exact same timer settings as the sound hardware is using, eg SOUND_FREQ(sampleRate)
<br/>
TIMER1 - set it to 65536 - number of samples in buffer and turn cascading on
<br/>
TIMER2 - set it to zero, and turn cascading on. </td> </tr></table><span class="postbody">
<br/>
I'm streaming data in on the arm9 via DLDI.  What's the best way to send the timer signal from the arm7 to the arm9?
<br/>
<br/>
I can use the IPC interrupt, but then I defeat the whole purpose of cascading the timers like this (I might miss the IPC interrupt).  I can use a shared eram variable, but it seems like it would be a little messy to synchronize like this.  
<br/>
<br/>
(I'm using shared eram now, and it works, but I get some noise.  Which may be related to other problems, but I'm still curious for feedback.)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#141421 - DragonMinded - Tue Sep 25, 2007 5:45 am</h4>
    <div class="postbody"><span class="postbody">Use a FIFO buffer with interrupts.<br/>_________________<br/>Enter the mind of the dragon.
<br/>
<br/>
<a href="http://dragonminded.blogspot.com" target="_blank">http://dragonminded.blogspot.com</a>
<br/>
<br/>
Seriously guys, how hard is it to simply TRY something yourself?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#141422 - ingramb - Tue Sep 25, 2007 6:30 am</h4>
    <div class="postbody"><span class="postbody">What happens if I miss the FIFO interrupt then?  I thought the whole point of the multi timer setup was to avoid relying on an interrupt.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#141441 - goruka - Tue Sep 25, 2007 4:29 pm</h4>
    <div class="postbody"><span class="postbody">Well, I tried to use the template in libnds as reference, then now touchscreen and everything works fine, except no sound... i may be doing something wrong? here's how my arm7 looks like ( the app i'm porting is opensource ):
<br/>
<br/>
<a href="http://svn.berlios.de/viewcvs/chibitracker/trunk/program/chibitracker_ds_arm7.c?rev=184&amp;view=markup" target="_blank">http://svn.berlios.de/viewcvs/chibitracker/trunk/program/chibitracker_ds_arm7.c?rev=184&amp;view=markup</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#141443 - ThomasS - Tue Sep 25, 2007 5:13 pm</h4>
    <div class="postbody"><span class="postbody">Did you test if SoundDriverNDS::mix is correctly called? If the touchscreen code from the example is outdated, the way it handles the FIFO messages and allocates memory after the IPC struct might be also outdated and may collide with something in your code ...<br/>_________________<br/>&lt;<a class="postlink" href="http://palib.info/forum/modules/newbb/viewtopic.php?viewmode=flat&amp;type=&amp;topic_id=3108&amp;forum=10" target="_blank">dsFont</a>&gt; &lt;<a class="postlink" href="http://palib.info/forum/modules/newbb/viewtopic.php?topic_id=2451&amp;forum=9" target="_blank">Game Collection</a>&gt;</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#141445 - ingramb - Tue Sep 25, 2007 6:11 pm</h4>
    <div class="postbody"><span class="postbody">Simon, can you take a quick look at your code and see if there's anything you're missing in that example?
<br/>
<br/>
I have your system in place, and it's working fantastic, except the sound gets out of sync after a few minutes (just like you said it might).
<br/>
<br/>
I tried both 65536 and 65535, and it's definately 65536 (which makes sense to me anyway).
<br/>
<br/>
Thanks =)</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
