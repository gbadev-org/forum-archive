<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>sprite question - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>DS development > sprite question</h2>
<div id="posts">
<div class="post">
    <h4>#40595 - wally - Wed Apr 20, 2005 7:40 pm</h4>
    <div class="postbody"><span class="postbody">I was trying to use the smantouch program to learn how to program for the DS.  So the first thing I tried was to change the pictures.  So I tried to change the pacman from a 8x8 to a 64x64.  However the graphics come up corrupted.  When changing the sprite size what would I have to change in the main program?  I don't understand the OAM changes.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#41247 - wally - Tue Apr 26, 2005 11:13 pm</h4>
    <div class="postbody"><span class="postbody">OK I got the code to give me 5 sprites, however all five have the same image.  What am I doing wrong? The code is below.
<br/>
Thanks for all your help.
<br/>
<br/>
<br/>
//Custom defines
<br/>
#define REG_VCOUNT *(vu16*)0x4000006		//Our good old vblank counter
<br/>
<br/>
//System includes
<br/>
#include &lt;NDS/NDS.h&gt;
<br/>
#include &lt;NDS/ARM9/rand.h&gt;
<br/>
<br/>
//Artwork includes
<br/>
#include "resources/pal.h"
<br/>
#include "resources/pac0.h"
<br/>
#include "resources/gh0.h"
<br/>
#include "resources/bg.h"
<br/>
<br/>
//-------------------------------------------------------------------
<br/>
<br/>
//OAM globals
<br/>
sSpriteEntry OAMCopy[128];
<br/>
sSpriteEntry OAMCopySub[128];
<br/>
<br/>
//Sprite structure
<br/>
typedef struct
<br/>
{
<br/>
	int x,y;	//location
<br/>
	int xSpeed, ySpeed;	//speed
<br/>
	sSpriteEntry* oam;
<br/>
}Sprite;
<br/>
<br/>
//-------------------------------------------------------------------
<br/>
<br/>
//Moves a sprite in OAM memory
<br/>
void MoveSprite(Sprite* sp)
<br/>
{
<br/>
	int x = sp-&gt;x &gt;&gt; 8;
<br/>
	int y = sp-&gt;y &gt;&gt; 8;
<br/>
<br/>
	sp-&gt;oam-&gt;attribute[1] &amp;= 0xFE00;
<br/>
	sp-&gt;oam-&gt;attribute[1] |= x;
<br/>
<br/>
	sp-&gt;oam-&gt;attribute[0] &amp;= 0xFF00;
<br/>
	sp-&gt;oam-&gt;attribute[0] |= y;
<br/>
<br/>
}
<br/>
//-------------------------------------------------------------------
<br/>
<br/>
 //Initializes the sprites
<br/>
void NextSprite(Sprite* sp, int number)
<br/>
{
<br/>
<br/>
		sp-&gt;x += sp-&gt;xSpeed;
<br/>
		sp-&gt;y += sp-&gt;ySpeed;
<br/>
		if(sp-&gt;x &lt; 256 || sp-&gt;x &gt; 61440) { sp-&gt;xSpeed=-sp-&gt;xSpeed; }
<br/>
		if(sp-&gt;y &lt; 256 || sp-&gt;y &gt; 45056) { sp-&gt;ySpeed=-sp-&gt;ySpeed; }
<br/>
<br/>
<br/>
}
<br/>
<br/>
//-------------------------------------------------------------------
<br/>
<br/>
 //Initializes the sprites
<br/>
void CreateSprite(Sprite* sp, int number)
<br/>
{
<br/>
	sp-&gt;x = (rand() &amp; (100&lt;&lt;8))+((number+number)&lt;&lt;8);
<br/>
	sp-&gt;y = (rand() &amp; (100&lt;&lt;8))+((number+number)&lt;&lt;8);
<br/>
   sp-&gt;xSpeed = (rand() &amp; (3&lt;&lt;6))+(1&lt;&lt;6);
<br/>
	sp-&gt;ySpeed = (rand() &amp; (3&lt;&lt;6))+(1&lt;&lt;6);
<br/>
	sp-&gt;oam = &amp;OAMCopy[number];
<br/>
<br/>
	sp-&gt;oam-&gt;attribute[0] = ATTR0_COLOR_256 | ATTR0_SQUARE;
<br/>
	sp-&gt;oam-&gt;attribute[1] = ATTR1_SIZE_64;
<br/>
	sp-&gt;oam-&gt;attribute[2] = 0;
<br/>
<br/>
<br/>
}
<br/>
<br/>
//-------------------------------------------------------------------
<br/>
<br/>
//Initialises OAM, moving all sprites offscreen
<br/>
void initOAM(void)
<br/>
{
<br/>
	int i;
<br/>
<br/>
	for(i = 0; i &lt; 128; i++)
<br/>
	{
<br/>
		OAMCopy[i].attribute[0] = ATTR0_DISABLED;
<br/>
		OAMCopySub[i].attribute[0] = ATTR0_DISABLED;
<br/>
	}	
<br/>
}
<br/>
<br/>
//-------------------------------------------------------------------
<br/>
<br/>
//Copies OAM buffer to actual OAM memory space
<br/>
void updateOAM(void)
<br/>
{
<br/>
	int i;
<br/>
<br/>
	for(i = 0; i &lt; 128 * sizeof(sSpriteEntry) / 4 ; i++)
<br/>
	{
<br/>
		((uint32*)OAM)[i] = ((uint32*)OAMCopy)[i];
<br/>
		((uint32*)OAM_SUB)[i] = ((uint32*)OAMCopySub)[i];
<br/>
	}
<br/>
}
<br/>
<br/>
//-------------------------------------------------------------------
<br/>
<br/>
//Entry point- this is where we start!
<br/>
int main(int argc, char ** argv) {
<br/>
<br/>
	int i=0, colourComponent=0;
<br/>
<br/>
	//turn on the power to the system
<br/>
	powerON(POWER_ALL);
<br/>
	videoSetMode( MODE_0_2D | DISPLAY_SPR_1D_LAYOUT | DISPLAY_SPR_ACTIVE | DISPLAY_BG0_ACTIVE );
<br/>
	videoSetModeSub( MODE_0_2D | DISPLAY_SPR_1D_LAYOUT | DISPLAY_SPR_ACTIVE | DISPLAY_BG0_ACTIVE );
<br/>
<br/>
	/*
<br/>
	VRAM_A_CR = VRAM_ENABLE | VRAM_ARM9 | VRAM_CORE_A;
<br/>
    VRAM_B_CR = VRAM_ENABLE | VRAM_ARM9 | VRAM_CORE_A;
<br/>
    VRAM_C_CR = VRAM_ENABLE | VRAM_ARM9 | VRAM_CORE_B;
<br/>
    VRAM_D_CR = VRAM_ENABLE | VRAM_ARM9 | VRAM_CORE_B;
<br/>
	vramSetMainBanks(VRAM_A_MAIN_BG,VRAM_B_MAIN_SPRITE,VRAM_C_SUB_BG,VRAM_D_SUB_SPRITE);
<br/>
	*/
<br/>
<br/>
	//Set screens to black initially
<br/>
	BG_PALETTE[0] = RGB15(0, 0, 0);		//Main screen
<br/>
	BG_PALETTE[512] = RGB15(0, 0, 0);		//Sub screen
<br/>
<br/>
<br/>
	Sprite sprites[128];
<br/>
	Sprite sprites_sub[128];
<br/>
	initOAM();
<br/>
<br/>
	//Setup heads
<br/>
   CreateSprite(&amp;sprites[0],0);
<br/>
   CreateSprite(&amp;sprites[1],1);
<br/>
   CreateSprite(&amp;sprites[2],2);
<br/>
   CreateSprite(&amp;sprites[3],3);
<br/>
   CreateSprite(&amp;sprites[4],4);
<br/>
<br/>
<br/>
	//Load palette and sprite data (main screen)
<br/>
	for(i=0; i&lt;512; i++) { SPRITE_PALETTE[i] = palPalette[i]; }
<br/>
	for(i=0; i&lt;8192; i++) { SPRITE_GFX[i] = pac0Data[i]; }
<br/>
	for(i=8193; i&lt;16384; i++) { SPRITE_GFX[i] = pac1Data[i-8193]; }
<br/>
	for(i=16385; i&lt;24576; i++) { SPRITE_GFX[i] = pac2Data[i-16385]; }
<br/>
	for(i=24577; i&lt;32768; i++) { SPRITE_GFX[i] = pac3Data[i-24577]; }
<br/>
	for(i=32769; i&lt;40960; i++) { SPRITE_GFX[i] = pac4Data[i-32769]; }
<br/>
<br/>
	//Setup top screen
<br/>
	sprites_sub[0].x = 8;
<br/>
	sprites_sub[0].y = 8;
<br/>
	sprites_sub[0].xSpeed = (8&lt;&lt;8);
<br/>
	sprites_sub[0].ySpeed = (1&lt;&lt;8);
<br/>
	sprites_sub[0].oam = &amp;OAMCopySub[0];
<br/>
<br/>
	sprites_sub[0].oam-&gt;attribute[0] = ATTR0_COLOR_256 | ATTR0_SQUARE;
<br/>
	sprites_sub[0].oam-&gt;attribute[1] = ATTR1_SIZE_64;
<br/>
	sprites_sub[0].oam-&gt;attribute[2] = 0;
<br/>
<br/>
	//Load palette and sprite data (sub screen)
<br/>
	for(i=0; i&lt;512; i++) { SPRITE_PALETTE_SUB[i] = palPalette[i]; }
<br/>
	for(i=0; i&lt;8192; i++) { SPRITE_GFX_SUB[i] = gh0Data[i]; }
<br/>
<br/>
<br/>
	//-------------------------------------------------------------------
<br/>
<br/>
	//Main game loop
<br/>
	bool exitFlag = false;
<br/>
	while (!exitFlag)
<br/>
	{
<br/>
		//Pulse screen colours (disco time!)
<br/>
		if (colourComponent &lt; 31) { colourComponent++; }
<br/>
		else { colourComponent = 0; }
<br/>
		PALETTE[0] = RGB15(colourComponent, 0, 0);
<br/>
		PALETTE[512] = RGB15(0, 0, 31-colourComponent);
<br/>
<br/>
<br/>
<br/>
		//Move heads
<br/>
<br/>
   	NextSprite(&amp;sprites[0],0);
<br/>
   	NextSprite(&amp;sprites[1],1);
<br/>
   	NextSprite(&amp;sprites[2],2);
<br/>
   	NextSprite(&amp;sprites[3],3);
<br/>
   	NextSprite(&amp;sprites[4],4);
<br/>
<br/>
		MoveSprite(&amp;sprites[0]);
<br/>
		MoveSprite(&amp;sprites[1]);
<br/>
		MoveSprite(&amp;sprites[2]);
<br/>
		MoveSprite(&amp;sprites[3]);
<br/>
	  	MoveSprite(&amp;sprites[4]);
<br/>
<br/>
<br/>
<br/>
<br/>
		//swiWaitForVBlank();
<br/>
		while(REG_VCOUNT != 190) {;}	
<br/>
<br/>
		updateOAM();
<br/>
	}
<br/>
<br/>
	return 0;
<br/>
}</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#41249 - Ethos - Tue Apr 26, 2005 11:19 pm</h4>
    <div class="postbody"><span class="postbody">attribute[2] = 0;
<br/>
<br/>
That is why</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#41251 - wally - Tue Apr 26, 2005 11:22 pm</h4>
    <div class="postbody"><span class="postbody">what exactly is attribute 2?  I thought it was the order the images were placed.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#41253 - Ethos - Tue Apr 26, 2005 11:28 pm</h4>
    <div class="postbody"><span class="postbody">I don't know DS 2D (no time, its all about the 3D).
<br/>
But in GBA attribute 2 (bits 0-9) are the tile in memory you are trying to reference</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#41550 - Pacifist - Fri Apr 29, 2005 4:25 pm</h4>
    <div class="postbody"><span class="postbody">It's the memory offset between where Sprite memory starts and where the sprite you want to draw is.
<br/>
<br/>
0 is the first sprite.  If your drawing 8x8 sprites then the second on is at 2x1 and the third is at 2x2.  2 is the number of bytes the sprite takes up (right?).  An 8x8 sprites has 8*8 pixels = 64 bits / 32 bits per byte = 2 bytes.
<br/>
<br/>
16x16 sprites take up 8 bytes and your 64x64 sprites take up a whopping 128.
<br/>
<br/>
Therefore your sprites should be at
<br/>
<br/>
0*128, 1*128, 2*128 etc...
<br/>
<br/>
however it looks like you've loaded them into specific chunks of sprite memory instead of loading them sequentially.  In this case the offset will be where you loaded them.
<br/>
<br/>
for(i=0; i&lt;8192; i++) { SPRITE_GFX[i] = pac0Data[i]; }
<br/>
for(i=8193; i&lt;16384; i++) { SPRITE_GFX[i] = pac1Data[i-8193]; }
<br/>
for(i=16385; i&lt;24576; i++) { SPRITE_GFX[i] = pac2Data[i-16385]; }
<br/>
for(i=24577; i&lt;32768; i++) { SPRITE_GFX[i] = pac3Data[i-24577]; }
<br/>
for(i=32769; i&lt;40960; i++) { SPRITE_GFX[i] = pac4Data[i-32769]; }
<br/>
<br/>
so sprite one is at  
<br/>
sprites_sub[0].oam-&gt;attribute[2] = 0;
<br/>
two is at
<br/>
sprites_sub[1].oam-&gt;attribute[2] = 8193;
<br/>
three is at
<br/>
sprites_sub[2].oam-&gt;attribute[2] = 16385;
<br/>
etc...
<br/>
<br/>
at least thats what *I* think is going on but I'm still pretty new to all this.
<br/>
[/quote]</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#41552 - wally - Fri Apr 29, 2005 4:43 pm</h4>
    <div class="postbody"><span class="postbody">how would you load them sequentially?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#41555 - Pacifist - Fri Apr 29, 2005 5:04 pm</h4>
    <div class="postbody"><span class="postbody">oho I am wrong about some of this.
<br/>
<br/>
I have the memory addessing all wrong.  A notable sign of this is that I expect one bit to represent the colour of a 256 colour pixel...
<br/>
<br/>
dovoto has a good tutorial on sprites here:
<br/>
<br/>
<a href="http://www.thepernproject.com/tutorials/GBA/day_3.html" target="_blank">http://www.thepernproject.com/tutorials/GBA/day_3.html</a>
<br/>
<br/>
He says that a 64*64 sprite takes up 64*64/2 bytes.  Which makes way more sense than what I was saying.
<br/>
<br/>
So where your using 8192 as the size of your sprites you should use 64*64/2.
<br/>
<br/>
so if you just want to modify your existing code: 
<br/>
int spriteSize = 64*64/2;
<br/>
for(i=0; i&lt;spriteSize; i++) { SPRITE_GFX[i] = pac0Data[i]; }
<br/>
for(i=0; i&lt;spriteSize; i++) { SPRITE_GFX[i+spriteSize] = pac1Data[i]; 
<br/>
for(i=0; i&lt;spriteSize; i++) { SPRITE_GFX[i+spriteSize*2] = pac2Data[i]; }
<br/>
for(i=0; i&lt;spriteSize; i++) { SPRITE_GFX[i+spriteSize*3] = pac3Data[i]; 
<br/>
for(i=0; i&lt;spriteSize; i++) { SPRITE_GFX[i+spriteSize*4] = pac4Data[i]; } 
<br/>
<br/>
You should really read the tutorial.  I may have the size wrong and I obviously haven't tested the code I just wrote.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#41558 - Ethos - Fri Apr 29, 2005 5:58 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Pacifist wrote:</b></span></td> </tr> <tr> <td class="quote">He says that a 64*64 sprite takes up 64*64/2 bytes.  Which makes way more sense than what I was saying.
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Nope, wrong.  He is copying, 64x64*2 bytes, but he is doing 64*64/2 copies of 4 bytes.
<br/>
<br/>
Two threads....same dicussion.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
