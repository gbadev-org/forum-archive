<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Code in vram - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > Code in vram</h2>
<div id="posts">
<div class="post">
    <h4>#141948 - ingramb - Tue Oct 02, 2007 3:55 am</h4>
    <div class="postbody"><span class="postbody">Apologies if this has been asked before (I think it has), but I couldn't find the topic with searching.
<br/>
<br/>
I want to put arm9 code in vram.  I've tried to add a vram section to the linker script and ctr0 files, using the itcm section as a guideline.  But I'm not so good with linker scripts, and I'm having trouble getting it to work.
<br/>
<br/>
This is what I have in my linker script, at the top under the MEMORY heading:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">vram    : ORIGIN = 0x06880000, LENGTH = 64K</td> </tr></table><span class="postbody">
<br/>
Then down in the SECTIONS area, after the itcm:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">__vram_lma = __itcm_lma + SIZEOF(.itcm);
<br/>
<br/>
   .vram __vram_start : AT (__vram_lma)
<br/>
   {
<br/>
      *(.vram)
<br/>
      *vram.*(.vram)
<br/>
      . = ALIGN(4);
<br/>
      __vram_end = ABSOLUTE(.);
<br/>
   } &gt;vram</td> </tr></table><span class="postbody">
<br/>
And finally, I've modified __bss_lma to come after __vram_lma.
<br/>
<br/>
Doing all this crashes the linker.
<br/>
<br/>
So am I even on the right track?  Or is there a better way to do this?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#141970 - NeX - Tue Oct 02, 2007 5:45 pm</h4>
    <div class="postbody"><span class="postbody">Why do you want code in VRAM?<br/>_________________<br/><a class="postlink" href="http://www.mediafire.com/?cuyb10fzdz2" target="_blank">Strummer</a> or <a class="postlink" href="http://www.mediafire.com/?71zxcztscix" target="_blank">Drummer?</a>.  
<br/>
Or maybe you would rather play with sand? <a class="postlink" href="http://www.mediafire.com/?a05z5wmdvxm" target="_blank">Sandscape is for you in that case.</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#141977 - ingramb - Tue Oct 02, 2007 6:40 pm</h4>
    <div class="postbody"><span class="postbody">Vram has less latency than main ram, and I'm out of itcm.  I have code running on the arm7 that reads from main ram, which makes it even slower on the arm9.  I've seen large speed ups already by moving code into itcm.  I need all the speed I can get.  And I have 64K of extra vram that I don't need for gfx.
<br/>
<br/>
So right now, I'm using it for data, but I think I would be better served by filling it with some critical code.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#141978 - simonjhall - Tue Oct 02, 2007 7:22 pm</h4>
    <div class="postbody"><span class="postbody">Not wanting to hijack, but how exactly do you put a function in itcm and do you REALLY get that much of a speed up when you do it? Isn't the instruction cache supposed to handle improving access to code?<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#141980 - ingramb - Tue Oct 02, 2007 7:51 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">how exactly do you put a function in itcm</td> </tr></table><span class="postbody">
<br/>
Just add an ITCM_CODE next to the function name.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Isn't the instruction cache supposed to handle improving access to code?</td> </tr></table><span class="postbody">
<br/>
Yeah, the instruction cache helps.  But It's only 8k.  If your working set is larger than this, you'll still be streaming code from main ram.  Cache misses are expensive, especially if the arm9 has to compete with the arm7.  At the very least, the arm7 is probly playing sound from main ram.
<br/>
<br/>
I've seen significant speed increases when moving code and data into the itcm and dtcm.</span><span class="gensmall"><br/><br/>Last edited by ingramb on Tue Oct 02, 2007 7:54 pm; edited 3 times in total</span></div>    
</div>
<div class="post">
    <h4>#141981 - NeX - Tue Oct 02, 2007 7:51 pm</h4>
    <div class="postbody"><span class="postbody">How do I use that?  I've tried it in every arrangement I can think of and the compiler constantly gets the wrong end of the stick.<br/>_________________<br/><a class="postlink" href="http://www.mediafire.com/?cuyb10fzdz2" target="_blank">Strummer</a> or <a class="postlink" href="http://www.mediafire.com/?71zxcztscix" target="_blank">Drummer?</a>.  
<br/>
Or maybe you would rather play with sand? <a class="postlink" href="http://www.mediafire.com/?a05z5wmdvxm" target="_blank">Sandscape is for you in that case.</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#141983 - simonjhall - Tue Oct 02, 2007 8:20 pm</h4>
    <div class="postbody"><span class="postbody">Yeah, is that all you add to the prototype? You don't need make a trampoline stub function or something?
<br/>
<br/>
can you just do this?
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void main(void)
<br/>
{
<br/>
   donkey("horse");
<br/>
}
<br/>
<br/>
void donkey(char *str) ITCM_CODE
<br/>
{
<br/>
   printf(str);
<br/>
}
<br/>
<br/>
</td> </tr></table><span class="postbody"><br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#141985 - NeX - Tue Oct 02, 2007 8:33 pm</h4>
    <div class="postbody"><span class="postbody">I found more locations in jtypes.h... the code that ITCM_CODE (or whatever) replaces works, but the define itself does not.  Not to mention that ITCM actually seems to be slower, and the touchscreen goes a little doo-lally whilst using the ITCM.<br/>_________________<br/><a class="postlink" href="http://www.mediafire.com/?cuyb10fzdz2" target="_blank">Strummer</a> or <a class="postlink" href="http://www.mediafire.com/?71zxcztscix" target="_blank">Drummer?</a>.  
<br/>
Or maybe you would rather play with sand? <a class="postlink" href="http://www.mediafire.com/?a05z5wmdvxm" target="_blank">Sandscape is for you in that case.</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#141991 - ingramb - Tue Oct 02, 2007 9:23 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Yeah, is that all you add to the prototype? You don't need make a trampoline stub function or something?</td> </tr></table><span class="postbody">
<br/>
The code will be loaded into ram, and then copied into itcm by the crt0.s file (I think).  You don't have to do anything fancy (that I know of).
<br/>
<br/>
For data, there's DTCM_DATA, and DTCM_BSS (for uninitialized globals).
<br/>
<br/>
Also, the itcm has a 32 bit bus, so it's more efficient for arm code (vs thumb).  Files named *.arm.c will be compiled as arm.  Not sure if there's a way to do this on a per-function basis.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">I found more locations in jtypes.h... the code that ITCM_CODE (or whatever) replaces works, but the define itself does not. Not to mention that ITCM actually seems to be slower, and the touchscreen goes a little doo-lally whilst using the ITCM.</td> </tr></table><span class="postbody">
<br/>
<br/>
The macros work fine for me.  I've gotten lots of speed by using the itcm.  You do have to think about what functions should go there.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#141992 - NeX - Tue Oct 02, 2007 9:36 pm</h4>
    <div class="postbody"><span class="postbody">Well, do 40,000-280,000 writes and reads per frame (in tight situations) sound like something that need a little bit of priority?
<br/>
Is the slowdown due to accessing an array in main RAM?<br/>_________________<br/><a class="postlink" href="http://www.mediafire.com/?cuyb10fzdz2" target="_blank">Strummer</a> or <a class="postlink" href="http://www.mediafire.com/?71zxcztscix" target="_blank">Drummer?</a>.  
<br/>
Or maybe you would rather play with sand? <a class="postlink" href="http://www.mediafire.com/?a05z5wmdvxm" target="_blank">Sandscape is for you in that case.</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#141996 - simonjhall - Tue Oct 02, 2007 10:18 pm</h4>
    <div class="postbody"><span class="postbody">Ah I getcha. To redo my previous example, I guess the itcm thing should be like this, since you can't use __attribute__ on a function definition (only its prototype).
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
void donkey(char *str) __attribute__((section(".itcm"), long_call));
<br/>
<br/>
void main(void) 
<br/>
{ 
<br/>
   donkey("horse"); 
<br/>
} 
<br/>
<br/>
void donkey(char *str) 
<br/>
{ 
<br/>
   printf(str); 
<br/>
}</td> </tr></table><span class="postbody">I've just checked with objdump and yeah, it's in itcm.
<br/>
Sorry again about the hijack - I'd imagine that you do something similar with vram. Although tbh if I were doing it, I'd just do it by hand by memcpying the function in and then calling it. But that's cos I'm a hacker ;-)<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#141998 - ingramb - Tue Oct 02, 2007 10:43 pm</h4>
    <div class="postbody"><span class="postbody">No worries about the hijack, itcm is a useful thing to discuss that probly deserves its own thread.
<br/>
<br/>
Back on topic, I've thought about copying to vram myself, but then I either need position indepent code, or I need to relocate manually.  I'd rather not have to deal with either, but it may turn out easier than the alternative link script nightmare.
<br/>
<br/>
I'm really hoping someone who knows about linkscripts can give me some advice though.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#142021 - DiscoStew - Wed Oct 03, 2007 6:15 am</h4>
    <div class="postbody"><span class="postbody">Sorry, going on the ITCM offtopic  :P
<br/>
<br/>
When I use them, I place the ITCM_CODE define at the front of the functions and prototypes, and they work fine for me.<br/>_________________<br/><span style="font-weight: bold">DS</span> - It's all about <span style="font-weight: bold">D</span>isco<span style="font-weight: bold">S</span>tew</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#142023 - gladius - Wed Oct 03, 2007 7:05 am</h4>
    <div class="postbody"><span class="postbody">This looks suspect "*vram.*(.vram)".  Try removing that.  You'll also need to fix up the crt to copy your code over to VRAM (and do the appropriate vram bank allocation before the copy, etc.).
<br/>
<br/>
Oh yeah, and I forget what the "} &gt;iwram = 0xff" syntax means, but maybe try using the "= 0xff" :).  Also, watch your spaces and tabs, I've borked linkscripts by messing up the spacing.  The parser isn't too forgiving.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#142024 - ingramb - Wed Oct 03, 2007 7:45 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">When I use them, I place the ITCM_CODE define at the front of the functions and prototypes, and they work fine for me.</td> </tr></table><span class="postbody">
<br/>
Same for me.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">This looks suspect "*vram.*(.vram)". Try removing that.</td> </tr></table><span class="postbody">
<br/>
This was (incorrectly I think) modified from: "*itcm.*(.text)".  Anyway, removing it makes no difference.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">but maybe try using the "= 0xff"</td> </tr></table><span class="postbody">
<br/>
Same thing, it doesn't make any difference.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Also, watch your spaces and tabs, I've borked linkscripts by messing up the spacing. The parser isn't too forgiving.</td> </tr></table><span class="postbody">
<br/>
I've copied the itcm block and just changed the names, so I think my spacing is OK.  Thanks for the heads up though.
<br/>
<br/>
So it's still crashing the linker, with exit code 5 (whatever that means, can't seem to find exit codes anywhere online).
<br/>
<br/>
Thanks for the suggestions.  I need to just read up on linkscripts I think.  Help is still appreciated though =)</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
