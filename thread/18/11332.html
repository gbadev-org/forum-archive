<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>How can I load Sprites from SD? - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>DS development > How can I load Sprites from SD?</h2>
<div id="posts">
<div class="post">
    <h4>#104850 - jandujar - Tue Oct 03, 2006 8:09 am</h4>
    <div class="postbody"><span class="postbody">I want to make a program that uses sprites, but I want that this sprites must be loaded from a SD with old chrism FAT library.
<br/>
<br/>
I thing I must use 16bit sprites (because I don't know the palette of the SD sprites)
<br/>
<br/>
But I don't know how to load/show 16bit sprites in mode 5.
<br/>
<br/>
Could somebody help me?
<br/>
<br/>
I make this and the sprite is show:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
//Preparo el espacio en memoria de los sprites.
<br/>
   //sprite attribute memory
<br/>
   SpriteEntry * spritesMain = new SpriteEntry[128];
<br/>
   //rotation attributes overlap so assign then to the same location
<br/>
   SpriteRotation * spriteRotationsMain = (SpriteRotation *)spritesMain;
<br/>
      
<br/>
   initOAM(spritesMain, spriteRotationsMain);
<br/>
   updateOAM(spritesMain);
<br/>
      
<br/>
   
<br/>
    spritesMain[0].attribute[0] = ATTR0_BMP | ATTR0_ROTSCALE_DOUBLE | 0; 
<br/>
   spritesMain[0].attribute[1] = ATTR1_SIZE_64 | 0;
<br/>
   spritesMain[0].attribute[2] = ATTR2_ALPHA(1)| 0;
<br/>
<br/>
   // red 64*64 square for 1d bitmap mode
<br/>
   for(int i=0;i&lt;64*64*2;i++)
<br/>
      SPRITE_GFX[i]=RGB15(31,0,0)|(1&lt;&lt;15); //dont forget alpha bit 
<br/>
      
<br/>
   updateOAM(spritesMain);
<br/>
   while(1){
<br/>
   swiWaitForVBlank();
<br/>
   }
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Is this correct? If I put for(int i=0;i&lt;64*64;i++) instead of for(int i=0;i&lt;64*64*2;i++) I only see the half of the cube.
<br/>
<br/>
-How can I load a jpeg to this gfx? using libjpeg from libnds.
<br/>
<br/>
*What is the sprite limit using 64x64 16bit sprites?
<br/>
I think sprite space is 256KB = 256 * 1024 bytes = 262144 bytes
<br/>
<br/>
And I 64x64 16bit sprite uses 64*64*2 = 8192 bytes
<br/>
<br/>
Could I use up to 262144/8192 = 32 64x64 sprites  ?<br/>_________________<br/><a class="postlink" href="http://jandujar.homelinux.com" target="_blank">http://jandujar.homelinux.com</a>
<br/>
<a class="postlink" href="http://www.dsrobot.com" target="_blank">http://www.dsrobot.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#104858 - PypeBros - Tue Oct 03, 2006 12:32 pm</h4>
    <div class="postbody"><span class="postbody">wow, that makes plenty of "how do i ..." in a row.
<br/>
<br/>
1. you can indeed use chishm's FAT library to load content from a file (say, stuff.spr) into some memory region (just using FAT_read, FAT_open, etc, which basically behave almost like standard fopen/fread/etc.), and that indeed includes loading tiles data straight into VRAM. E.g. in my sprite editor, i have
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
bool SpriteSet::Load(char *filename) {
<br/>
   if (!checkFileLibrary()) return false;
<br/>
   FAT_FILE* file=FAT_fopen(filename,"rb");
<br/>
   struct SprFileCmap pal_hdr={};
<br/>
   struct SprFileTile tile_hdr={};
<br/>
   struct SprFileUnknown hdr={};
<br/>
   
<br/>
   iprintf("reading '%s' ...\n",filename);
<br/>
   while (!pal_hdr.magic || !tile_hdr.magic) {
<br/>
     if (FAT_feof(file) || FAT_fread(&amp;hdr, sizeof(hdr),1,file)!=sizeof(hdr)) { 
<br/>
       FAT_fclose(file); 
<br/>
       iprintf("unexpected EOF\n");
<br/>
       return false;
<br/>
     }
<br/>
     iprintf("section '%c%c%c%c' ...", hdr.magic&amp;255,
<br/>
        (hdr.magic&gt;&gt;8)&amp;255,(hdr.magic&gt;&gt;16)&amp;255,(hdr.magic&gt;&gt;24)&amp;255);
<br/>
     switch(hdr.magic) {
<br/>
     case SPR_FILE_CMAP_MAGIC:
<br/>
       pal_hdr.magic=hdr.magic;
<br/>
       if (FAT_fread(&amp;(pal_hdr.ncols),sizeof(u32),1,file)==sizeof(u32)) {
<br/>
    uint nb=FAT_fread(palette_target,sizeof(u16),pal_hdr.ncols,file);
<br/>
    iprintf("%i/%i colors loaded\n",nb/sizeof(u16),pal_hdr.ncols);
<br/>
       }
<br/>
       break;
<br/>
     case SPR_FILE_TILE_MAGIC:
<br/>
         tile_hdr.magic=hdr.magic;
<br/>
         if (FAT_fread(&amp;(tile_hdr.ntiles),sizeof(u32),1,file)==sizeof(u32) &amp;&amp;
<br/>
             FAT_fread(tiles_target,64,tile_hdr.ntiles,file)==64*tile_hdr.ntiles)
<br/>
            iprintf("%i tiles loaded\n",tile_hdr.ntiles);
<br/>
    nbtiles=tile_hdr.ntiles;
<br/>
         break;
<br/>
      default:
<br/>
   iprintf("unknown. skipping %u bytes\n",hdr.skipsize);
<br/>
   FAT_fseek(file, hdr.skipsize, SEEK_CUR);
<br/>
         break;
<br/>
      }
<br/>
   }
<br/>
   FAT_fclose(file);
<br/>
   return true;
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
where palette_target and tiles_target were initialized with (SPRITE_GFX_SUB,SPRITE_PALETTE_SUB) respectively.
<br/>
<br/>
2. if you're using some mode initialization of your own, make sure you defined  things like DISPLAY_SPR_1D, DISPLAY_SPR_1D_BMP and 		 DISPLAY_SPR_1D_BMP_SIZE_128. The actual values might depend on your setup, but what it all means is that depending on those values, the DS hardware will pick different tiles number to form the "next row".
<br/>
<br/>
3. once you've mastered VRAM filling and the FAT library, you're quite free to use any library available to decode any format you read from SD into RAM. That includes JPEG too even if that'd be the last thing <span style="font-style: italic">I</span> would consider (rather picking PNG)<br/>_________________<br/><a class="postlink" href="http://sylvainhb.blogspot.com/p/sprite-editor.html" target="_blank"> SEDS: Sprite Edition on DS</a> :: <a class="postlink" href="http://sylvainhb.blogspot.com/search/label/modplayer" target="_blank">modplayer</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#104859 - chishm - Tue Oct 03, 2006 12:40 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>PypeBros wrote:</b></span></td> </tr> <tr> <td class="quote">you can indeed use chishm's FAT library to load content from a file (say, stuff.spr) into some memory region (just using FAT_read, FAT_open, etc, which basically behave almost like standard fopen/fread/etc.), and that indeed includes loading tiles data straight into VRAM.</td> </tr></table><span class="postbody">
<br/>
That's true, with many conditions. It's a lot like memcpy (in fact, it uses memcpy for some cases) in that it will into memory 2 or 4 bytes at a time when certain conditions are met. Unfortunately, it is not possible to be certain that it will all occur correctly, so you are better off reading into another section of RAM then copy it across.<br/>_________________<br/><a class="postlink" href="http://chishm.drunkencoders.com" target="_blank">http://chishm.drunkencoders.com</a>
<br/>
<a class="postlink" href="http://dldi.drunkencoders.com" target="_blank">http://dldi.drunkencoders.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#104964 - Mollusk - Wed Oct 04, 2006 7:41 pm</h4>
    <div class="postbody"><span class="postbody">i would go with using gif files, as they're already paletted, and using 256 color sprites that way<br/>_________________<br/>PAlib official forum : <a class="postlink" href="http://www.palib.info" target="_blank">http://www.palib.info</a>
<br/>
PAlib official tutorials: <a class="postlink" href="http://www.palib.info/wiki" target="_blank">http://www.palib.info/wiki</a>
<br/>
Updates, help, code examples, tutorials, etc...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#104968 - HyperHacker - Wed Oct 04, 2006 7:56 pm</h4>
    <div class="postbody"><span class="postbody">Isn't GIF copyrighted or something? Anyway PNG is essentially just GIF but better, except without animations. (An animated MNG format exists but few people use it.)<br/>_________________<br/>I'm a PSP hacker now, but I still &lt;3 DS.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#104975 - josath - Wed Oct 04, 2006 9:33 pm</h4>
    <div class="postbody"><span class="postbody">yes, 256 color png is better than 256 color gif.
<br/>
But either way, using a compressed image format, with anything more complex than RLE, will complicate the loading. For simple sprites, which are generally pretty small anyway, the easiest is to just use PCX files. They contain RLE compression, and libnds has a very basic PCX decompression function.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#105038 - jandujar - Thu Oct 05, 2006 12:26 pm</h4>
    <div class="postbody"><span class="postbody">first of all, thank's to all the people who answer me.
<br/>
<br/>
I have made a program that load a jpg icon (two sprites with same gfx) and show this icon on the sub screen. (the jpg icon is bin2o). I not use any palette for the sprites.
<br/>
<br/>
But I'm getting something strange, the icon seems to have been scaled 50% height.
<br/>
What I'm doing wrong?
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#include &lt;nds.h&gt;
<br/>
#include &lt;stdlib.h&gt;  //malloc
<br/>
#include &lt;stdio.h&gt; //iprintf
<br/>
#include "Sprites.h"
<br/>
#include "Video.h"
<br/>
#include "arriba_bin.h"
<br/>
#include "IconoMac.h"
<br/>
#include "gba-jpeg.h"
<br/>
#include "gba-jpeg-decode.h"
<br/>
#include "lupa_jpg.h"
<br/>
<br/>
<br/>
<br/>
int main(int a, char **b){
<br/>
   //////////////////////////// INIT ////////////////////////////////////////
<br/>
   //turn on the 2D core
<br/>
    powerON(POWER_ALL_2D);
<br/>
   
<br/>
    //set up a VBlank handler
<br/>
   irqInit();
<br/>
   irqSet(IRQ_VBLANK, 0);
<br/>
    
<br/>
    initVideo();
<br/>
   initBackgrounds();
<br/>
   initConsole();
<br/>
   
<br/>
   //Cargo los backgrounds
<br/>
   copyBackground(arriba_bin, arriba_bin_size);
<br/>
   copyBackgroundSub(arriba_bin, arriba_bin_size);
<br/>
   
<br/>
   //Preparo el espacio en memoria de los sprites.
<br/>
   //sprite attribute memory
<br/>
   SpriteEntry * spritesMain = new SpriteEntry[128];
<br/>
   //rotation attributes overlap so assign then to the same location
<br/>
   SpriteRotation * spriteRotationsMain = (SpriteRotation *)spritesMain;
<br/>
      
<br/>
   initOAM(spritesMain, spriteRotationsMain);
<br/>
   updateOAM(spritesMain);
<br/>
      
<br/>
   
<br/>
    spritesMain[0].attribute[0] = ATTR0_BMP | ATTR0_ROTSCALE_DOUBLE | 0; //Y
<br/>
   spritesMain[0].attribute[1] = ATTR1_SIZE_64 | 64;
<br/>
   spritesMain[0].attribute[2] = ATTR2_ALPHA(1)| 0;
<br/>
<br/>
   spritesMain[1].attribute[0] = ATTR0_BMP | ATTR0_ROTSCALE_DOUBLE |0; 
<br/>
   spritesMain[1].attribute[1] = ATTR1_SIZE_64 | 0;
<br/>
   spritesMain[1].attribute[2] = ATTR2_ALPHA(1)| 0;
<br/>
<br/>
   //Cargo la lupa
<br/>
   u16* imagen;
<br/>
   imagen=(u16*)malloc(64*64*2);
<br/>
   
<br/>
   REG_IME = 0x00;
<br/>
   JPEG_DecompressImage(lupa_jpg, imagen, 64, 64);
<br/>
   REG_IME = 0x01;
<br/>
   
<br/>
   spriteRotationsMain[0].hdx=256;
<br/>
   spriteRotationsMain[0].hdy=0;
<br/>
   spriteRotationsMain[0].vdx=0;
<br/>
   spriteRotationsMain[0].vdy=256;
<br/>
 
<br/>
<br/>
   // red 64*64 square for 1d bitmap mode  copio el primer icono
<br/>
   int i;
<br/>
   iprintf("paso%d",imagen[0]);
<br/>
   for(i=0;i&lt;64*64*2;i++){
<br/>
      SPRITE_GFX[i]=imagen[i]; //dont forget alpha bit   
<br/>
   }
<br/>
   int suma=64*64*2;
<br/>
   //copio el segundo
<br/>
   for(i=0;i&lt;64*64*2;i++){
<br/>
      SPRITE_GFX[suma+i]=imagen[i]; //dont forget alpha bit      
<br/>
   }
<br/>
   
<br/>
   iprintf("paso%d",imagen[0]);   
<br/>
   updateOAM(spritesMain);
<br/>
   while(1){
<br/>
   swiWaitForVBlank();
<br/>
   }
<br/>
   
<br/>
   
<br/>
   //displaySplash();
<br/>
   
<br/>
      
<br/>
   return 0;   
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
How can I draw a jpg image with a color like a alpha bit? (transparent)
<br/>
SPRITE_GFX[suma+i]=0;  ?  &lt;- will be transparent?
<br/>
<br/>
<a href="http://img214.imageshack.us/img214/5717/dashmu6.jpg">[Images not permitted - Click here to view it]</a><br/>_________________<br/><a class="postlink" href="http://jandujar.homelinux.com" target="_blank">http://jandujar.homelinux.com</a>
<br/>
<a class="postlink" href="http://www.dsrobot.com" target="_blank">http://www.dsrobot.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#105043 - PypeBros - Thu Oct 05, 2006 1:08 pm</h4>
    <div class="postbody"><span class="postbody">Whatever color you use with an alpha bit cleared will not show up. Note that it's truly a <span style="font-style: italic">bit</span>: either you see the pixel, or you don't. If you want "translucent" sprite (e.g. seeing through your magnifying glass, but still with a pale blue tint), what you need is alpha-blending (which applies uniformly to all pixels of the sprite).
<br/>
<br/>
About the sprite being "squeezed" vertically to 1/2 of his height, are you using 1D or 2D bmp mode (see tonc tutorial if the question seems meaningless to you)<br/>_________________<br/><a class="postlink" href="http://sylvainhb.blogspot.com/p/sprite-editor.html" target="_blank"> SEDS: Sprite Edition on DS</a> :: <a class="postlink" href="http://sylvainhb.blogspot.com/search/label/modplayer" target="_blank">modplayer</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#105050 - jandujar - Thu Oct 05, 2006 1:59 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">About the sprite being "squeezed" vertically to 1/2 of his height, are you using 1D or 2D bmp mode (see tonc tutorial if the question seems meaningless to you)</td> </tr></table><span class="postbody">
<br/>
1D or 2D bmp mode?  I don't know
<br/>
<br/>
<br/>
where is this tutorial?
<br/>
<br/>
this?
<br/>
<a href="http://user.chem.tue.nl/jakvijn/tonc/affine.htm" target="_blank">http://user.chem.tue.nl/jakvijn/tonc/affine.htm</a><br/>_________________<br/><a class="postlink" href="http://jandujar.homelinux.com" target="_blank">http://jandujar.homelinux.com</a>
<br/>
<a class="postlink" href="http://www.dsrobot.com" target="_blank">http://www.dsrobot.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#105051 - PypeBros - Thu Oct 05, 2006 2:00 pm</h4>
    <div class="postbody"><span class="postbody">that's rather "regular sprite". see "2.1. The sprite mapping mode"<br/>_________________<br/><a class="postlink" href="http://sylvainhb.blogspot.com/p/sprite-editor.html" target="_blank"> SEDS: Sprite Edition on DS</a> :: <a class="postlink" href="http://sylvainhb.blogspot.com/search/label/modplayer" target="_blank">modplayer</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#105054 - jandujar - Thu Oct 05, 2006 2:31 pm</h4>
    <div class="postbody"><span class="postbody">I use this function to initialize the video.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
void initVideo() {
<br/>
   //enable vram and map it to the right places
<br/>
    vramSetMainBanks(   VRAM_A_MAIN_BG_0x6000000,      //map A and B to main background memory
<br/>
                        VRAM_B_MAIN_BG_0x6020000,      //this gives us 256KB which is a healthy amount for 16-bit gfx
<br/>
                        VRAM_C_SUB_BG_0x6200000,      //map C to sub background memory
<br/>
                        VRAM_D_LCD                  //map D to LCD free space
<br/>
                  //allows adjacent banks to overflow into D if a bug like that was ever to occur
<br/>
                        );
<br/>
   
<br/>
   //map a bank for use with sprites
<br/>
   vramSetBankE(VRAM_E_MAIN_SPRITE); //mapping E to main sprites gives us 64k for sprites
<br/>
   //(64k is the max space that 1024 tiles take up in 256 color mode)
<br/>
   
<br/>
   //set the video mode
<br/>
    videoSetMode(  MODE_5_2D | 
<br/>
                   DISPLAY_SPR_ACTIVE |    //turn on sprites
<br/>
                   DISPLAY_BG3_ACTIVE |    //turn on background 3
<br/>
                   DISPLAY_SPR_1D          //this is used when in tile mode
<br/>
               );
<br/>
   
<br/>
   videoSetModeSub(MODE_5_2D | DISPLAY_BG3_ACTIVE);
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
If I change DISPLAY_SPR_1D for DISPLAY_SPR_2D it's show me 4 sprites (with the same problem of scale)
<br/>
<br/>
<br/>
[EDIT]
<br/>
LOL
<br/>
<br/>
I change video mode, like in the sprite example of libnds
<br/>
DISPLAY_SPR_1D |         
<br/>
DISPLAY_SPR_1D_BMP
<br/>
And it does not work too.
<br/>
<br/>
The problem is Desmume!!!!  With dualis works great.
<br/>
<br/>
Another time I have an problem with the emulator, not the program itselft.<br/>_________________<br/><a class="postlink" href="http://jandujar.homelinux.com" target="_blank">http://jandujar.homelinux.com</a>
<br/>
<a class="postlink" href="http://www.dsrobot.com" target="_blank">http://www.dsrobot.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#105060 - PypeBros - Thu Oct 05, 2006 3:52 pm</h4>
    <div class="postbody"><span class="postbody">1D sprite is the preferred way to go for most of us ... and now that you mention it, there's indeed a bug with that in desmume ... as well as it cannot rotate sprites (maybe it cannot scale them either) and it doesn't understand the "double scale/rotate" or any alpha-blending stuff ... 
<br/>
<br/>
So the only use i've found to desmume is the fact it's my only option on Linux systems ...<br/>_________________<br/><a class="postlink" href="http://sylvainhb.blogspot.com/p/sprite-editor.html" target="_blank"> SEDS: Sprite Edition on DS</a> :: <a class="postlink" href="http://sylvainhb.blogspot.com/search/label/modplayer" target="_blank">modplayer</a></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
