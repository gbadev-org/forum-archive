<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Excpetions on ARM9 - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>DS development > Excpetions on ARM9</h2>
<div id="posts">
<div class="post">
    <h4>#76403 - Mighty Max - Tue Mar 21, 2006 11:03 am</h4>
    <div class="postbody"><span class="postbody">Heya,
<br/>
<br/>
i've worked with exceptions of different kind and how they could be catched on the CPU the last week.
<br/>
<br/>
I intend to use this for implementing soft &amp; hardcoded breakpoints. Together with the multithreading there could be a live-debugger thread that lets you look what went wrong on the hardware &amp; changes memory to resolve the problem &amp; return the execution.
<br/>
<br/>
I've created a version of the Multithreader that does a breakpoint (before it even starts the multithreading) via an undefined instruction. It also would stall the system with a message when reading from/writing to invalid locations.
<br/>
<br/>
Sorce &amp; .nds:
<br/>
<a href="http://mightymax.org/MultiThreading.rar" target="_blank">http://mightymax.org/MultiThreading.rar</a>
<br/>
<br/>
The handling is pretty easy and works allmost like the IRQ handling:
<br/>
<br/>
At 0x27FFD9C is the pointer to the custom exception handler. If there is a 0 stored there, the bios just ignores the exception and jumps back to the execution.
<br/>
<br/>
it prepares the call with storing some information in the RAM just below the pointer:
<br/>
Causing location at 0x027FFD98
<br/>
Saved stack at 0x027FFD94
<br/>
Old ARM mode at 0x027FFD90
<br/>
Old cp15 status at 0x027FFD8C
<br/>
<br/>
additionally it disables the MPU &amp; sets the FIQ &amp; IRQ bit in CPSR to disable all interrupts.
<br/>
<br/>
When the exception handler is called, it does not get a valid value in LR to return to. Therefor we either have to rebuild the LR, or just do the same as would happen without us beeing called.
<br/>
<br/>
This is done in the EnterException in the .s:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
EnterException:
<br/>
            // store context
<br/>
            LDR r12,=ExceptionLocalStorage
<br/>
            STMIA r12,{r0-r11,r13}
<br/>
            
<br/>
            // assign a stack
<br/>
            LDR r12,=ExceptionStack
<br/>
            LDR r13,[r12]
<br/>
            
<br/>
            // Get C function &amp; call it
<br/>
            LDR r12,=ExceptionC
<br/>
            LDR r12,[r12,#0]
<br/>
            ADD r14,r15,#0
<br/>
            BXNE r12
<br/>
         
<br/>
            // restore context
<br/>
            LDR r12,=ExceptionLocalStorage
<br/>
            LDMIA r12,{r0-r11,r13}
<br/>
            
<br/>
            // do the bios code
<br/>
            .word 0xE8BD5000 
<br/>
            .word 0xEE01CF10 
<br/>
            .word 0xE16FF00E 
<br/>
            .word 0xE8BD5000 
<br/>
            .word 0xE25EF004 
<br/>
                           
<br/>
ExceptionC:
<br/>
            .word            0x00000000
<br/>
ExceptionStack:
<br/>
            .word            0x00000000
<br/>
ExceptionLocalStorage:
<br/>
            .word            0x00000000
<br/>
            .word            0x00000000
<br/>
            .word            0x00000000
<br/>
            .word            0x00000000
<br/>
            .word            0x00000000
<br/>
            .word            0x00000000
<br/>
            .word            0x00000000
<br/>
            .word            0x00000000
<br/>
            .word            0x00000000
<br/>
            .word            0x00000000
<br/>
            .word            0x00000000
<br/>
            .word            0x00000000
<br/>
            .word            0x00000000
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
There is one last obstackle still to use it. Whenever you are in the C routine to handle this exception. It will crash on the call to console functions. The solution: enable the MPU again before calling them, and it works fine again.
<br/>
<br/>
If you don't want it enabled &amp; still need to print out, you will need to reinitialize the console.
<br/>
<br/>
I've commented the example code, it should explain the things done
<br/>
<br/>
Now,
<br/>
have fun with exception handling.<br/>_________________<br/><a class="postlink" href="http://mightymax.org/gbamp_multiboot.html" target="_blank">GBAMP Multiboot</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#76798 - HyperHacker - Fri Mar 24, 2006 10:27 pm</h4>
    <div class="postbody"><span class="postbody">Waitwaitwait... these CPUs have exception handling? Or is it just the undefined instruction handler? (Like can you have it break on access to whatever memory area?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#76842 - Mighty Max - Sat Mar 25, 2006 7:59 am</h4>
    <div class="postbody"><span class="postbody">They will break on Data Abort too, yes
<br/>
<br/>
Basically every other verctor beside IRQ &amp; SWI will jump to this address.<br/>_________________<br/><a class="postlink" href="http://mightymax.org/gbamp_multiboot.html" target="_blank">GBAMP Multiboot</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#76862 - caitsith2 - Sat Mar 25, 2006 3:45 pm</h4>
    <div class="postbody"><span class="postbody">You have a bug in function GetR12.  Shouldn't the code be
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
GetR12:
<br/>
            MOVS r0,r12
<br/>
            BX r14
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
instead of 
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
GetR12:
<br/>
            MOVS r0,r14
<br/>
            BX r14
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#76865 - Mighty Max - Sat Mar 25, 2006 4:27 pm</h4>
    <div class="postbody"><span class="postbody">Oups, thanks for that. That's what one get when copy&amp;pasting while beeing half asleep.
<br/>
<br/>
<br/>
<br/>
Btw, the exception vector for the ARM7 is located at 0x380FFDC and works the same (beside it doesn't disable the cp15 - the arm7 has none - and doesn't store it's status)
<br/>
<br/>
So that there are only 3 words saved below 0x380FFDC<br/>_________________<br/><a class="postlink" href="http://mightymax.org/gbamp_multiboot.html" target="_blank">GBAMP Multiboot</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#76892 - HyperHacker - Sat Mar 25, 2006 10:54 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Mighty Max wrote:</b></span></td> </tr> <tr> <td class="quote">They will break on Data Abort too, yes
<br/>
<br/>
Basically every other verctor beside IRQ &amp; SWI will jump to this address.</td> </tr></table><span class="postbody">
<br/>
Oh? So any access to invalid memory triggers this? I didn't know ARM could do that. Can I set the memory ranges myself, or are they hardcoded?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#76896 - Mighty Max - Sat Mar 25, 2006 11:12 pm</h4>
    <div class="postbody"><span class="postbody">It's the CoProcessor 15 which manages the memory protection regions. There are 8 region (programable) descriptors available, but i suggest reading through the arm documentation about the cp15 &amp; the MRC/MCR mnemonics.
<br/>
<br/>
You can invoke such an exception by trying to write into the bios range, which is defined as not writeable on the default region set:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
*(unsigned short *)0xFFFF0000 = 0 ;
<br/>
</td> </tr></table><span class="postbody"><br/>_________________<br/><a class="postlink" href="http://mightymax.org/gbamp_multiboot.html" target="_blank">GBAMP Multiboot</a></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
