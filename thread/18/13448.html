<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>mp3 playback examples (was: Problems using the helix mp3dec) - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>DS development > mp3 playback examples (was: Problems using the helix mp3dec)</h2>
<div id="posts">
<div class="post">
    <h4>#131502 - ThomasS - Sat Jun 16, 2007 11:51 am</h4>
    <div class="postbody"><span class="postbody">Hi,
<br/>
I'm doing a remake of Lode Runner: The Legend Returns for the DS, which works pretty well so far, and am now trying to build in the original music.
<br/>
These are .mid files, and I don't know of a .mid player lib for the DS.
<br/>
But as I use PALib for the project (it is likely to be my last project with PALib, however), there is a .mod player I could use which comes with PALib. I tried endless ways of converting the files to .mod, but it simply doesn't work right.
<br/>
Then I found libmikmod, tried it with the files converted to .s3m or .it, but it had too much bugs.
<br/>
My newest try is to convert the music to mp3 and play it using the Helix mp3 decoder.
<br/>
<br/>
Therefore I took a look at a ringbuffer example from this forum and tried to exchange the .raw music playback with mp3 playback, but I didn't succeed (I don't have much experience with audio programming ...).
<br/>
This was the original code to fill the sound buffer in the example:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void SoundMixCallback(void *stream,u32 numsamples)
<br/>
{
<br/>
   int i;
<br/>
<br/>
   for(i = 0; i &lt; numsamples; i++)
<br/>
   {
<br/>
      if(soundoffset &gt;= sizeof(snd_pirate)) soundoffset = 0;
<br/>
<br/>
      if(soundsystem-&gt;format == 8)
<br/>
      {
<br/>
         ((s8*)stream)[i] = snd_pirate[soundoffset++];   // normal sound 8bit ---&gt; buffer 8bit
<br/>
      }
<br/>
      else
<br/>
      {
<br/>
         ((s16*)stream)[i] = (snd_pirate[soundoffset++] &lt;&lt; 8);   // sound 8bit ---&gt; buffer 16bit
<br/>
      }
<br/>
   }
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
I exchanged snd_pirate with snd_mp3, which holds the content of a mp3 file, and added the helix mp3dec files to the project. The initialization of the sound system is done like this:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">   SoundSystemInit(22050,(1 &lt;&lt; 24) / 22050, 0, 16); // u32 rate,u32 buffersize,u8 channel,u8 format
<br/>
   SoundStartMixer();
<br/>
<br/>
   if ((hMP3Decoder = MP3InitDecoder()) == 0)
<br/>
   {
<br/>
      iprintf("Init mp3dec failed.");
<br/>
      while(1)
<br/>
         swiWaitForVBlank();
<br/>
   }
<br/>
   readPtr = snd_mp3;
<br/>
   bytesLeft = 957126;</td> </tr></table><span class="postbody">
<br/>
<br/>
And the new SoundMixCallback for testing purposes looks like this:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void SoundMixCallback(void *stream, u32 numsamples)
<br/>
{
<br/>
   int i, err, offset;
<br/>
   short outBuf[MAX_NCHAN * MAX_NGRAN * MAX_NSAMP];
<br/>
<br/>
   offset = MP3FindSyncWord(readPtr, bytesLeft);
<br/>
   if (offset &lt; 0)
<br/>
   {
<br/>
      outOfData = 1;
<br/>
      iprintf("\x1b[13;0HFINISH");
<br/>
      return;
<br/>
   }
<br/>
   readPtr += offset;
<br/>
   bytesLeft -= offset;
<br/>
<br/>
   // decode one MP3 frame - if offset &lt; 0 then bytesLeft was less than a full frame
<br/>
   err = MP3Decode(hMP3Decoder, &amp;readPtr, &amp;bytesLeft, outBuf, 0);
<br/>
   if (err)
<br/>
   {
<br/>
      outOfData = err;
<br/>
      iprintf("\x1b[13;0HERROR");
<br/>
      return;
<br/>
   }
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
This doesn't change the buffer but simply decodes the mp3 file completely, and it works - after a while, "FINISH" is displayed.
<br/>
<br/>
Now to the strange part:
<br/>
Filling the stream pointer causes the mp3 decoding to fail. It seems like the mp3 decoder uses the stream memory for something ... ?
<br/>
<br/>
For test purposes, I added the following to the function:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">   for (i = 0; i &lt; numsamples; i++)
<br/>
      ((s16*)stream)[i] = 2&lt;&lt;14;</td> </tr></table><span class="postbody">
<br/>
<br/>
With this change, it freezes instantly in no$gba.
<br/>
On a real DS, it additionally displays that the error -6 occurred, which means ERR_MP3_INVALID_FRAMEHEADER.
<br/>
If I comment out the mp3 decoding after this change, some short noise can be heard, which should be correct.
<br/>
<br/>
So for a strange reason, I can't fill the sound buffer while decoding the mp3 file.
<br/>
<br/>
Can anybody point me to what I'm doing wrong, or has anybody already written some code to use the Helix mp3 player and can post it here?
<br/>
Thanks in advance!<br/>_________________<br/>&lt;<a class="postlink" href="http://palib.info/forum/modules/newbb/viewtopic.php?viewmode=flat&amp;type=&amp;topic_id=3108&amp;forum=10" target="_blank">dsFont</a>&gt; &lt;<a class="postlink" href="http://palib.info/forum/modules/newbb/viewtopic.php?topic_id=2451&amp;forum=9" target="_blank">Game Collection</a>&gt;</span><span class="gensmall"><br/><br/>Last edited by ThomasS on Thu Jun 28, 2007 6:10 pm; edited 2 times in total</span></div>    
</div>
<div class="post">
    <h4>#131523 - tepples - Sat Jun 16, 2007 9:12 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>ThomasS wrote:</b></span></td> </tr> <tr> <td class="quote">I'm [cloning a PC game] for the DS, which works pretty well so far, and am now trying to build in the original music.
<br/>
These are .mid files, and I don't know of a .mid player lib for the DS.</td> </tr></table><span class="postbody">
<br/>
Then how does MoonShell play .mid? If the MoonShell <b style="color:#FFA34F">MIDI</b> player is too heavyweight for your purposes, can you record each instrument, and then interpret the standard <b style="color:#FFA34F">MIDI</b> file per the spec?<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#131563 - ThomasS - Sun Jun 17, 2007 12:50 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Then how does MoonShell play .mid?</td> </tr></table><span class="postbody">
<br/>
<br/>
Moonshell plays the music fine, but I looked at the midrcp plugin source and am unsure if I could extract it and have no idea if it would be fast enough.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">If the MoonShell <b style="color:#FFA34F">MIDI</b> player is too heavyweight for your purposes, can you record each instrument, and then interpret the standard <b style="color:#FFA34F">MIDI</b> file per the spec?</td> </tr></table><span class="postbody">
<br/>
<br/>
If I had more experience with audio programming, I probably could do that.
<br/>
<br/>
But converting to mp3 and playing these files seems to be a good solution to me, if I only could get the playback to work ...
<br/>
<br/>
<span style="font-weight: bold">EDIT</span>:
<br/>
Works almost.
<br/>
<br/>
The first error was that the example I was using reserved too few memory and thus was overwriting the data after it which caused the mp3 decoding to fail.
<br/>
The second problem was that no$gba doesn't emulate this program correctly - it freezes randomly.
<br/>
<br/>
Now it plays on a real DS, but it has some deep noise in it.
<br/>
Perhaps one of you who has more experience with audio knows a possible reason?
<br/>
<br/>
This is the code I'm using to fill the ring buffer (tell me if the approach is generally wrong, I haven't done this before):
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
// Overview:
<br/>
// If data is needed, the function first looks if the buffer "musicBuf" contains some buffered data and if yes, it fills it into the stream.
<br/>
// If there is still more data needed, it decodes one mp3 frame and fills it into the stream
<br/>
// If the mp3 frame contained more data than actually needed, the rest is copied to "musicBuf".
<br/>
<br/>
short musicBuf[MAX_NCHAN * MAX_NGRAN * MAX_NSAMP];
<br/>
int nMusicBuf;
<br/>
<br/>
#define min(a, b) (((a) &lt; (b)) ? (a) : (b))
<br/>
<br/>
void SoundMixCallback(void *stream, u32 numsamples)
<br/>
{
<br/>
   int err, outSample, restSample, minSamples, offset;
<br/>
   short outBuf[MAX_NCHAN * MAX_NGRAN * MAX_NSAMP];
<br/>
   outSample = 0;
<br/>
<br/>
   // Fill buffered data into stream
<br/>
   minSamples = min(nMusicBuf, numsamples);
<br/>
   if (minSamples &gt; 0)
<br/>
   {
<br/>
      // Copy data from musicBuf to stream
<br/>
      numsamples -= minSamples;
<br/>
      nMusicBuf -= minSamples;
<br/>
      memcpy(((s16*)stream) + outSample, musicBuf, minSamples * sizeof(s16));
<br/>
      outSample += minSamples;
<br/>
   }
<br/>
<br/>
   // Still more data needed?
<br/>
   if (numsamples &gt; 0)
<br/>
   {
<br/>
nextFrame:;
<br/>
      // More data is needed. Decode a mp3 frame to outBuf
<br/>
      // Find start of next MP3 frame - assume EOF if no sync found
<br/>
      offset = MP3FindSyncWord(readPtr, bytesLeft);
<br/>
      if (offset &lt; 0)
<br/>
      {
<br/>
         outOfData = 1;
<br/>
         return;
<br/>
      }
<br/>
      readPtr += offset;
<br/>
      bytesLeft -= offset;
<br/>
<br/>
      // Decode one MP3 frame
<br/>
       err = MP3Decode(hMP3Decoder, &amp;readPtr, &amp;bytesLeft, outBuf, 0);
<br/>
      if (err)
<br/>
      {
<br/>
         outOfData = err;
<br/>
         return;
<br/>
      }
<br/>
<br/>
      // Copy data to stream
<br/>
      MP3GetLastFrameInfo(hMP3Decoder, &amp;mp3FrameInfo);
<br/>
      minSamples = min(mp3FrameInfo.outputSamps, numsamples);
<br/>
      restSample = mp3FrameInfo.outputSamps - numsamples;
<br/>
      numsamples -= minSamples;
<br/>
<br/>
      memcpy(((s16*)stream) + outSample, outBuf, minSamples * sizeof(s16));
<br/>
      outSample += minSamples;
<br/>
<br/>
      // Is still more data needed? Then decode the next frame
<br/>
      if (numsamples &gt; 0)
<br/>
         goto nextFrame;
<br/>
<br/>
      // Copy the rest of the decoded data to musicBuf
<br/>
      // TODO: how about decoding directly to this location, copying only the played part to the stream and
<br/>
      //       setting a nMusicBufStart offset?
<br/>
      if (restSample &gt; 0)
<br/>
      {
<br/>
         memcpy(musicBuf, &amp;outBuf[minSamples], restSample * sizeof(s16));
<br/>
         nMusicBuf = restSample;
<br/>
      }
<br/>
   }
<br/>
}
<br/>
</td> </tr></table><span class="postbody"><br/>_________________<br/>&lt;<a class="postlink" href="http://palib.info/forum/modules/newbb/viewtopic.php?viewmode=flat&amp;type=&amp;topic_id=3108&amp;forum=10" target="_blank">dsFont</a>&gt; &lt;<a class="postlink" href="http://palib.info/forum/modules/newbb/viewtopic.php?topic_id=2451&amp;forum=9" target="_blank">Game Collection</a>&gt;</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#131727 - omalone - Tue Jun 19, 2007 2:50 pm</h4>
    <div class="postbody"><span class="postbody">Hi,
<br/>
<br/>
I'm really interested by integrating a mp3 player on my homebrew.
<br/>
So I'm really interested by your work.
<br/>
<br/>
Did you success to compile it and to make it run finally ?
<br/>
<br/>
Regards</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#131746 - ThomasS - Tue Jun 19, 2007 6:05 pm</h4>
    <div class="postbody"><span class="postbody">It compiles, but there is still some noise in the output. The biggest part of the noise seemed to be a timing problem, but some noise is still there and I have no idea why. Perhaps more experimenting with this will show the reason ...<br/>_________________<br/>&lt;<a class="postlink" href="http://palib.info/forum/modules/newbb/viewtopic.php?viewmode=flat&amp;type=&amp;topic_id=3108&amp;forum=10" target="_blank">dsFont</a>&gt; &lt;<a class="postlink" href="http://palib.info/forum/modules/newbb/viewtopic.php?topic_id=2451&amp;forum=9" target="_blank">Game Collection</a>&gt;</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#132184 - ThomasS - Sun Jun 24, 2007 11:06 am</h4>
    <div class="postbody"><span class="postbody">Ok, now it works.
<br/>
The only problem left is that it gets "error -6" at the end of the file instead of "out of data", but the whole song is played, so it's a minor problem here.
<br/>
<br/>
For everyone who wants to use the mp3 player, <a class="postlink" href="http://www.megaupload.com/de/?d=CXLU85EK" target="_blank">here</a> is the download of my sample project - sorry for the upload site :-(
<br/>
<br/>
Note that the helix files are not included because I don't know if their license would allow it. Look at the ReadMe on what files you need (tip: it's probably faster to download all files individual through the "Browse CVS" feature than to follow the "quick"start <a class="postlink" href="https://helixcommunity.org/developers/get_connected_to_cvs/quickstart.html" target="_blank">here</a>)<br/>_________________<br/>&lt;<a class="postlink" href="http://palib.info/forum/modules/newbb/viewtopic.php?viewmode=flat&amp;type=&amp;topic_id=3108&amp;forum=10" target="_blank">dsFont</a>&gt; &lt;<a class="postlink" href="http://palib.info/forum/modules/newbb/viewtopic.php?topic_id=2451&amp;forum=9" target="_blank">Game Collection</a>&gt;</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#132199 - Lick - Sun Jun 24, 2007 4:15 pm</h4>
    <div class="postbody"><span class="postbody"><span style="font-weight: bold">Mirror</span> <a class="postlink" href="http://lickr.org/files/ThomasS_MP3PlaybackDemo_DS.7z" target="_blank">http://lickr.org/files/ThomasS_MP3PlaybackDemo_DS.7z</a>
<br/>
<br/>
I believe you may add the Helix source code to your project, if your project is also licensed with one of <a class="postlink" href="https://community.helixcommunity.org/content/complicense" target="_blank">these</a> licenses.<br/>_________________<br/><a class="postlink" href="http://licklick.wordpress.com" target="_blank">http://licklick.wordpress.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#132281 - omalone - Mon Jun 25, 2007 2:29 pm</h4>
    <div class="postbody"><span class="postbody">Nice work ThomasS !
<br/>
<br/>
I'll have a look at it asap.
<br/>
<br/>
What would it cost to make this run on arm7 ?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#132430 - ThomasS - Tue Jun 26, 2007 4:56 pm</h4>
    <div class="postbody"><span class="postbody">Thanks for mirroring the file, Lick.
<br/>
<br/>
The performance on arm7 and arm9 is described by Noda in <a class="postlink" href="http://forum.gbadev.org/viewtopic.php?t=13299" target="_blank">this thread</a>.
<br/>
<br/>
And here's the <a class="postlink" href="http://www.megaupload.com/de/?d=BD3M281T" target="_blank">arm7 example</a>.
<br/>
<br/>
It tried to license it under the zlib license so I can include the helix files. Please tell me if I did anything wrong - I haven't done this before.<br/>_________________<br/>&lt;<a class="postlink" href="http://palib.info/forum/modules/newbb/viewtopic.php?viewmode=flat&amp;type=&amp;topic_id=3108&amp;forum=10" target="_blank">dsFont</a>&gt; &lt;<a class="postlink" href="http://palib.info/forum/modules/newbb/viewtopic.php?topic_id=2451&amp;forum=9" target="_blank">Game Collection</a>&gt;</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#132440 - DVSoftware - Tue Jun 26, 2007 6:57 pm</h4>
    <div class="postbody"><span class="postbody">please someone mirror this, i can't download from megaupload. Thanks</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#132446 - MaXXik - Tue Jun 26, 2007 8:54 pm</h4>
    <div class="postbody"><span class="postbody">Arm9 playback example did not work for me with devkit r20. On real hardware i heard nothing. What is wrong with source code ?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#132447 - Lick - Tue Jun 26, 2007 9:07 pm</h4>
    <div class="postbody"><span class="postbody"><span style="font-weight: bold">Mirror of 2nd file</span> <a href="http://lickr.org/files/ThomasS_MP3PlaybackDemo_Arm7_DS.7z" target="_blank">http://lickr.org/files/ThomasS_MP3PlaybackDemo_Arm7_DS.7z</a>
<br/>
<br/>
Good job!<br/>_________________<br/><a class="postlink" href="http://licklick.wordpress.com" target="_blank">http://licklick.wordpress.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#132491 - omalone - Wed Jun 27, 2007 8:27 am</h4>
    <div class="postbody"><span class="postbody">As I can't test it for now, could you please tell me if this is working fine on arm7 ? It would be really good.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#132517 - ThomasS - Wed Jun 27, 2007 12:54 pm</h4>
    <div class="postbody"><span class="postbody">Lick:
<br/>
Thanks for mirroring again!
<br/>
<br/>
MaXXik:
<br/>
Strange. Did you download and place the helix files correctly?
<br/>
What does the program display: "playing", "out of data" or "decoding error"?
<br/>
Does the arm7 example work for you?
<br/>
Or perhaps the volume was set too low, as the music file is very quiet at the beginning.<br/>_________________<br/>&lt;<a class="postlink" href="http://palib.info/forum/modules/newbb/viewtopic.php?viewmode=flat&amp;type=&amp;topic_id=3108&amp;forum=10" target="_blank">dsFont</a>&gt; &lt;<a class="postlink" href="http://palib.info/forum/modules/newbb/viewtopic.php?topic_id=2451&amp;forum=9" target="_blank">Game Collection</a>&gt;</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#132545 - MaXXik - Wed Jun 27, 2007 7:14 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>ThomasS wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
MaXXik:
<br/>
Strange. Did you download and place the helix files correctly?
<br/>
What does the program display: "playing", "out of data" or "decoding error"?
<br/>
Does the arm7 example work for you?
<br/>
Or perhaps the volume was set too low, as the music file is very quiet at the beginning.</td> </tr></table><span class="postbody">
<br/>
Yes, i download and place helix playback source code in arm9/helix folder, add -D__GNUC__ -DARM to arm9 makefile and comment two lines of code in file subband.c (//PolyphaseStereo(pcmBuf, sbi-&gt;vbuf + sbi-&gt;vindex + VBUF_LENGTH * (b &amp; 0x01), polyCoef); //PolyphaseMono(pcmBuf, sbi-&gt;vbuf + sbi-&gt;vindex + VBUF_LENGTH * (b &amp; 0x01), polyCoef); ). Then i compile mp3 playback using devkitARM  r20 and start nds executable on NDS. It displays "status: playing", sound volume on console set to maximum, but i do not hear any sound.
<br/>
Thats my source code including compiling nds executable.
<br/>
<a href="http://www.megaupload.com/?d=V2Z2QFVM" target="_blank">http://www.megaupload.com/?d=V2Z2QFVM</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#132555 - ThomasS - Wed Jun 27, 2007 8:10 pm</h4>
    <div class="postbody"><span class="postbody">You spelled "asmpoly_gcc.s" as "asmpoly_gcc.S". If you correct this, you can add the functions PolyphaseStereo / Mono which you commented out in subband.c again. Then it should work.
<br/>
<br/>
And yes, ARM should be defined somewhere. Sorry about that, I placed it directly in an helix header file and forgot to mention it ...<br/>_________________<br/>&lt;<a class="postlink" href="http://palib.info/forum/modules/newbb/viewtopic.php?viewmode=flat&amp;type=&amp;topic_id=3108&amp;forum=10" target="_blank">dsFont</a>&gt; &lt;<a class="postlink" href="http://palib.info/forum/modules/newbb/viewtopic.php?topic_id=2451&amp;forum=9" target="_blank">Game Collection</a>&gt;</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#132561 - MaXXik - Wed Jun 27, 2007 9:03 pm</h4>
    <div class="postbody"><span class="postbody">Wow, thank you ThomasS! When I uncomment PolyphaseStereo / Mono source code lines and build nds executable it work nice on hardware. And as for me i did not notice any sound glitches. Thanks again !</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#132678 - FireSlash - Thu Jun 28, 2007 5:23 pm</h4>
    <div class="postbody"><span class="postbody">Hmm. I'm using your arm7 example, the sound stops about a minute into the song, and there is some background noise.
<br/>
<br/>
This happened initially, and continued after I edited the arm7 template to match my existing one. There have been no changes made to any of the helix files.
<br/>
<br/>
Idea on where to start? The sound is 64kbps mono CBR, so I can't imagine it's a speed issue.<br/>_________________<br/><a class="postlink" href="http://www.fireslash.net" target="_blank">FireSlash.net</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#132680 - ThomasS - Thu Jun 28, 2007 6:07 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">the sound stops about a minute into the song,</td> </tr></table><span class="postbody">
<br/>
This is most likely because the byte count of the music file is entered directly in in soundcommon.h and you didn't adjust it:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#define mp3_bytes 529105</td> </tr></table><span class="postbody">
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">and there is some background noise</td> </tr></table><span class="postbody">
<br/>
Well, with the released version, I never had any background noise.
<br/>
But the files with which I tested it had a very low bit rate (I think it was VBR from 8 to 40 kbps or so), so it could be a speed problem, or the buffer size is too small for longer decoding times ...<br/>_________________<br/>&lt;<a class="postlink" href="http://palib.info/forum/modules/newbb/viewtopic.php?viewmode=flat&amp;type=&amp;topic_id=3108&amp;forum=10" target="_blank">dsFont</a>&gt; &lt;<a class="postlink" href="http://palib.info/forum/modules/newbb/viewtopic.php?topic_id=2451&amp;forum=9" target="_blank">Game Collection</a>&gt;</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#132682 - FireSlash - Thu Jun 28, 2007 6:27 pm</h4>
    <div class="postbody"><span class="postbody">Hmm. Is there a way to remove that? I'm dealing with multiple files and defines don't jive too well with that :)
<br/>
<br/>
Also finding some files don't play. It seems to be at random, and sometime the same file converted to a smaller size no longer works. However, the state still shows as 1 (playing). Hmm.
<br/>
<br/>
EDIT:
<br/>
It seems that files around 1.3mb or so (Yes, they're loading into memory correctly) have this problem, as well as some more exotic ABR/VBR configurations. The latter are probably just limiations in the code, the former might be memory limitations.<br/>_________________<br/><a class="postlink" href="http://www.fireslash.net" target="_blank">FireSlash.net</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#132696 - ThomasS - Thu Jun 28, 2007 7:26 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Is there a way to remove that?</td> </tr></table><span class="postbody">
<br/>
Of course.
<br/>
In the example, the file is included using ".incbin" - I don't know how you can get the size of the file using this method.
<br/>
But the default template makefiles from libnds offer the possibility to include data using "bin2o", this way you'll get the size automatically. Just create a folder called "data" in the arm9 directory, place your music files there (you don't need the *.s files anymore) and rename them to *.bin. When building the project, there should be some .h files generated in the "build" directory, containing variables to access the file data and the size of the files - #include these files and you can use the information.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Also finding some files don't play.</td> </tr></table><span class="postbody">
<br/>
The ~1.3MB files may be big, but if they load into memory correctly, they should play ... the decoder goes through them frame per frame and doesn't have to allocate much memory on the arm7 side. I'll test it tomorrow ...<br/>_________________<br/>&lt;<a class="postlink" href="http://palib.info/forum/modules/newbb/viewtopic.php?viewmode=flat&amp;type=&amp;topic_id=3108&amp;forum=10" target="_blank">dsFont</a>&gt; &lt;<a class="postlink" href="http://palib.info/forum/modules/newbb/viewtopic.php?topic_id=2451&amp;forum=9" target="_blank">Game Collection</a>&gt;</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#132756 - FireSlash - Fri Jun 29, 2007 4:14 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>ThomasS wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Is there a way to remove that?</td> </tr></table><span class="postbody">
<br/>
Of course.</span></td> </tr></table><span class="postbody">
<br/>
I'm loading via FAT, I have the file sizes, I just don't know where helix want's them :)
<br/>
<br/>
I could remove the define and add it to the struct, but I don't know what type it's looking for. I'll sort it out sooner or later, but if you already know it'll save me the trouble of digging through the source. :)<br/>_________________<br/><a class="postlink" href="http://www.fireslash.net" target="_blank">FireSlash.net</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#132797 - ThomasS - Fri Jun 29, 2007 1:57 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">I could remove the define and add it to the struct, but I don't know what type it's looking for.</td> </tr></table><span class="postbody">
<br/>
<br/>
What do you mean with type? It's simply the byte count, this could be stored, for example, in an u32.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">I just don't know where helix want's them :) </td> </tr></table><span class="postbody">
<br/>
The size of the file is stored in the variable "bytesLeft" to know where the file ends.
<br/>
<br/>
So you could add something like u32 mp3Bytes; to the transfer struct and change
<br/>
bytesLeft = mp3_bytes;
<br/>
in sound7.c to
<br/>
bytesLeft = soundsystem-&gt;mp3Bytes;
<br/>
Then set the field in the arm9 part before playing the file and it should work.
<br/>
<br/>
<span style="font-weight: bold">EDIT</span>:
<br/>
I did some tests, like announced:
<br/>
A 2MB 192kbps mp3 plays, but has some background noise with the default settings.
<br/>
Changing the buffer size from 2 * MAX_NCHAN * MAX_NGRAN * MAX_NSAMP to 3 * MAX_NCHAN * MAX_NGRAN * MAX_NSAMP lets the noise disappear (caution: this value is in the code twice!).
<br/>
Making the multiplier (2, 3) bigger than 3 results in too less memory being left for the mp3 decoder - the initialization will fail.<br/>_________________<br/>&lt;<a class="postlink" href="http://palib.info/forum/modules/newbb/viewtopic.php?viewmode=flat&amp;type=&amp;topic_id=3108&amp;forum=10" target="_blank">dsFont</a>&gt; &lt;<a class="postlink" href="http://palib.info/forum/modules/newbb/viewtopic.php?topic_id=2451&amp;forum=9" target="_blank">Game Collection</a>&gt;</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#133587 - LiraNuna - Sat Jul 07, 2007 8:08 am</h4>
    <div class="postbody"><span class="postbody">Any way to read file directly from FAT (without loading the full file into memory) ? I had "Port Helix decoder" on my todo list for ToD2 (Yes, I'll use MP3 as music), and loading a song to memory would be a waste.
<br/>
ARM7 decoding really solves my speed concerns.<br/>_________________<br/>Private property.
<br/>
Violators will be shot, survivors will be shot again.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#133596 - ThomasS - Sat Jul 07, 2007 10:50 am</h4>
    <div class="postbody"><span class="postbody">You could take a look at the official example for the decoder in
<br/>
[Helix Community] / datatype / mp3 / codec / fixpt / testwrap / main.c
<br/>
It decodes a mp3 file, but doesn't hold the whole file in memory.
<br/>
Instead, it has a small buffer which is always refilled if more data is needed.
<br/>
<br/>
This is likely to get difficult when decoding the file on the arm7, however, because <a class="postlink" href="http://forum.gbadev.org/viewtopic.php?t=13571" target="_blank">libfat doesn't work on the arm7</a>.
<br/>
<br/>
A possible solution:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>simonjhall wrote:</b></span></td> </tr> <tr> <td class="quote">I did it in the end by doing 9&lt;-&gt;7 IPC, by wrapping fopen/fread/etc and passing the command through to the ARM9's IPC handler. It does slow down the main processor a bit (something I found out when streaming mp3) but it does mean you don't lose huge amounts of ARM7 storage by including all the file stuff in there.</td> </tr></table><span class="postbody"><br/>_________________<br/>&lt;<a class="postlink" href="http://palib.info/forum/modules/newbb/viewtopic.php?viewmode=flat&amp;type=&amp;topic_id=3108&amp;forum=10" target="_blank">dsFont</a>&gt; &lt;<a class="postlink" href="http://palib.info/forum/modules/newbb/viewtopic.php?topic_id=2451&amp;forum=9" target="_blank">Game Collection</a>&gt;</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
