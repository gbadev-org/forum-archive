<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>What's wrong with memcpy() ? - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > What's wrong with memcpy() ?</h2>
<div id="posts">
<div class="post">
    <h4>#177211 - sverx - Tue Jan 24, 2012 2:46 pm</h4>
    <div class="postbody"><span class="postbody">Is it just happening to me that <span style="font-style: italic">memcpy()</span> can't copy 4 bytes? It doesn't even work with 8, I had to copy 16 bytes to make it work :| (dest and src are word aligned...)<br/>_________________<br/><a class="postlink" href="http://bit.ly/yiQrz9" target="_blank">libXM7</a>|<a class="postlink" href="http://bit.ly/yJwcOo" target="_blank">NDS programming tutorial (Italiano)</a>|<a class="postlink" href="http://disjointedstudio.blogspot.com/" target="_blank">Waimanu DS / GBA</a>|<a class="postlink" href="http://adshomebrewersdiary.blogspot.com" target="_blank">A DS Homebrewer's Diary</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#177213 - elhobbs - Tue Jan 24, 2012 4:39 pm</h4>
    <div class="postbody"><span class="postbody">are you copy to main memory or some other region like vram?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#177215 - Dwedit - Tue Jan 24, 2012 6:58 pm</h4>
    <div class="postbody"><span class="postbody">Step through with a debugger and see what's going on?  (Are there any good GBA debuggers out there besides NO$GBA paid version?)
<br/>
<br/>
Anyway, I like to replace memcpy with my own version, because it doesn't use an optimized ldmia/stmia loop to copy.
<br/>
Tonc has a <a class="postlink" href="http://www.coranac.com/tonc/text/asm.htm" target="_blank">Replacement memcpy</a> function written in assembly that's more optimized.  Except it uses word counts instead of byte counts.  One instruction at the beginning can change that.
<br/>
I use a different one myself.<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#177216 - sverx - Wed Jan 25, 2012 9:28 am</h4>
    <div class="postbody"><span class="postbody">elhobbs: I'm copying from main memory to VRAM, but both source and destination are word aligned and I'm copying an even number of halfwords (so no partial words)
<br/>
<br/>
Dwedit: Yes, I do plan to change it to a faster memcpy() later if needed, but it really left me astonished. Could that be a bug in the memcpy() function or it's working from 16 bytes on by design? (I have no debugger to use, I checked the --save-temps generated file and it seems to me the memcpy() call is correct...)<br/>_________________<br/><a class="postlink" href="http://bit.ly/yiQrz9" target="_blank">libXM7</a>|<a class="postlink" href="http://bit.ly/yJwcOo" target="_blank">NDS programming tutorial (Italiano)</a>|<a class="postlink" href="http://disjointedstudio.blogspot.com/" target="_blank">Waimanu DS / GBA</a>|<a class="postlink" href="http://adshomebrewersdiary.blogspot.com" target="_blank">A DS Homebrewer's Diary</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#177217 - elhobbs - Wed Jan 25, 2012 2:48 pm</h4>
    <div class="postbody"><span class="postbody">16 bytes is the threshold for word copies in memcpy. 4 bytes is the threshold for half word copies and the rest is byte copies. I am surprised that the half word copies are not working - there must be something missing here. I suspect this works fine from main memory to main memory as I use it quite a bit for that purpose - with no problems.
<br/>
<br/>
I have just always assumed that memcpy should not be used for vram as there are faster options - like dma or ldmia/stmia.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#177218 - sverx - Wed Jan 25, 2012 2:57 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">4 bytes is the threshold for half word copies</td> </tr></table><span class="postbody">
<br/>
So it should be working in my case, but it isn't. :|
<br/>
<br/>
mmm... well, I might have made a wrong assumption,then. For instance, when I include a .bin file, does its starting address is word aligned?<br/>_________________<br/><a class="postlink" href="http://bit.ly/yiQrz9" target="_blank">libXM7</a>|<a class="postlink" href="http://bit.ly/yJwcOo" target="_blank">NDS programming tutorial (Italiano)</a>|<a class="postlink" href="http://disjointedstudio.blogspot.com/" target="_blank">Waimanu DS / GBA</a>|<a class="postlink" href="http://adshomebrewersdiary.blogspot.com" target="_blank">A DS Homebrewer's Diary</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#177219 - elhobbs - Wed Jan 25, 2012 5:33 pm</h4>
    <div class="postbody"><span class="postbody">I am not sure - you could look at the address in the map file or you try adding an alignment attribute to the definition ALIGN(4) should do it.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#177220 - sverx - Wed Jan 25, 2012 5:49 pm</h4>
    <div class="postbody"><span class="postbody">Right, the map file... mmm... looks like they're all aligned correctly. Every address is multiple of 4.
<br/>
mmm... the mystery deepens :|
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code"> .rodata        0x0200217c     0x3004 bg2test.img.bin.o
<br/>
                0x0200217c                bg2test_img_bin
<br/>
                0x0200517c                bg2test_img_bin_end
<br/>
                0x0200517c                bg2test_img_bin_size
<br/>
 .rodata        0x02005180      0xc04 bg2test.map.bin.o
<br/>
                0x02005180                bg2test_map_bin
<br/>
                0x02005d80                bg2test_map_bin_end
<br/>
                0x02005d80                bg2test_map_bin_size
<br/>
 .rodata        0x02005d84     0xe5c4 bgtest.img.bin.o
<br/>
                0x02005d84                bgtest_img_bin
<br/>
                0x02014344                bgtest_img_bin_size
<br/>
                0x02014344                bgtest_img_bin_end
<br/>
 .rodata        0x02014348     0x3004 bgtest.map.bin.o
<br/>
                0x02014348                bgtest_map_bin
<br/>
                0x02017348                bgtest_map_bin_end
<br/>
                0x02017348                bgtest_map_bin_size
<br/>
 .rodata        0x0201734c      0x204 bgtest.pal.bin.o
<br/>
                0x0201734c                bgtest_pal_bin
<br/>
                0x0201754c                bgtest_pal_bin_size
<br/>
                0x0201754c                bgtest_pal_bin_end
<br/>
 .rodata        0x02017550      0x804 sprite.img.bin.o
<br/>
                0x02017550                sprite_img_bin
<br/>
                0x02017d50                sprite_img_bin_end
<br/>
                0x02017d50                sprite_img_bin_size
<br/>
 .rodata        0x02017d54      0x204 sprite.pal.bin.o
<br/>
                0x02017d54                sprite_pal_bin
<br/>
                0x02017f54                sprite_pal_bin_end
<br/>
                0x02017f54                sprite_pal_bin_size</td> </tr></table><span class="postbody"><br/>_________________<br/><a class="postlink" href="http://bit.ly/yiQrz9" target="_blank">libXM7</a>|<a class="postlink" href="http://bit.ly/yJwcOo" target="_blank">NDS programming tutorial (Italiano)</a>|<a class="postlink" href="http://disjointedstudio.blogspot.com/" target="_blank">Waimanu DS / GBA</a>|<a class="postlink" href="http://adshomebrewersdiary.blogspot.com" target="_blank">A DS Homebrewer's Diary</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#177221 - elhobbs - Wed Jan 25, 2012 6:33 pm</h4>
    <div class="postbody"><span class="postbody">I seem to remember that gcc may optimize memcpy calls and replace it with inline code. can you verify that memcpy is being called in this section? you could try it with and without optimizations turned on and see if you get different results.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#177222 - Cearn - Wed Jan 25, 2012 7:01 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>elhobbs wrote:</b></span></td> </tr> <tr> <td class="quote">16 bytes is the threshold for word copies in memcpy. [b]4 bytes is the threshold for half word copies and the rest is byte copies[b]. </td> </tr></table><span class="postbody">
<br/>
Are you sure about the halfword thing? As far as I know, it's just byte copies under size 16.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Dwedit wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
Tonc has a <a class="postlink" href="http://www.coranac.com/tonc/text/asm.htm" target="_blank">Replacement memcpy</a> function written in assembly that's more optimized.  Except it uses word counts instead of byte counts.  One instruction at the beginning can change that.</td> </tr></table><span class="postbody">
<br/>
Instead of tonc's routines, use these: <a class="postlink" href="http://coranac.com/files/misc/armfuncs.zip" target="_blank">http://coranac.com/files/misc/armfuncs.zip</a>. They work for odd byte-sizes and in unaligned cases as well. 
<br/>
<br/>
I think I have some timing data lying around here as well somewhere if you're interested, but IIRC it beats memcpy/set in almost all cases.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#177223 - elhobbs - Wed Jan 25, 2012 10:04 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Cearn wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>elhobbs wrote:</b></span></td> </tr> <tr> <td class="quote">16 bytes is the threshold for word copies in memcpy. [b]4 bytes is the threshold for half word copies and the rest is byte copies[b]. </td> </tr></table><span class="postbody">
<br/>
Are you sure about the halfword thing? As far as I know, it's just byte copies under size 16.</span></td> </tr></table><span class="postbody">no, not really sure - just looking at the unpatched newlib source code. it did not look like there was a replacement memcpy in the patches for devkitarm. I did not look at the generated asm/code either.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#177224 - sverx - Thu Jan 26, 2012 10:11 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Cearn wrote:</b></span></td> </tr> <tr> <td class="quote">Are you sure about the halfword thing? As far as I know, it's just byte copies under size 16.</td> </tr></table><span class="postbody">
<br/>
<br/>
That would explain the problem, since VRAM byte writes are ignored. So actually it's not memcpy() fault, it's that it's not kind of 'VRAM safe'...
<br/>
Not a big problem anyway, I will simply copy 16 bytes now, and I'll replace the memcpy() with something faster if needed.
<br/>
<br/>
Thanks! :)<br/>_________________<br/><a class="postlink" href="http://bit.ly/yiQrz9" target="_blank">libXM7</a>|<a class="postlink" href="http://bit.ly/yJwcOo" target="_blank">NDS programming tutorial (Italiano)</a>|<a class="postlink" href="http://disjointedstudio.blogspot.com/" target="_blank">Waimanu DS / GBA</a>|<a class="postlink" href="http://adshomebrewersdiary.blogspot.com" target="_blank">A DS Homebrewer's Diary</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#177225 - kusma - Thu Jan 26, 2012 1:31 pm</h4>
    <div class="postbody"><span class="postbody">memcpy can be implemented to copy a single byte at the time, which doesn't work when you copy to VRAM (at least not on GBA). Perhaps this is your issue?</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
