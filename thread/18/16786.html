<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>SOLVED: Problem displaying BMP loaded from filesystem - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > SOLVED: Problem displaying BMP loaded from filesystem</h2>
<div id="posts">
<div class="post">
    <h4>#169616 - raomon - Mon Jul 27, 2009 12:50 am</h4>
    <div class="postbody"><span class="postbody">Hi, I'm learning how to develop for the NDS but get stuck in how to load bitmaps in backgrounds. <a class="postlink" href="http://www.dev-scene.com/NDS/Tutorials_Day_3#Working_With_Graphics_Files" target="_blank">Here</a> is where currently I am. This is the almost (change in order to follow the post code easily) original code that works without problems:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#include &lt;nds.h&gt;
<br/>
#include &lt;stdio.h&gt;
<br/>
#include &lt;beerguy_bin.h&gt;
<br/>
<br/>
// 14 bytes
<br/>
typedef struct {
<br/>
    char signature[2];
<br/>
    unsigned int fileSize; // 4 bytes, 32 bits
<br/>
    unsigned int reserved;
<br/>
    unsigned int offset;
<br/>
} __attribute__ ((packed)) BmpHeader;
<br/>
<br/>
// 40 bytes
<br/>
typedef struct {
<br/>
    unsigned int headerSize;
<br/>
    unsigned int width;
<br/>
    unsigned int height;
<br/>
    unsigned short planeCount;
<br/>
    unsigned short bitDepth;
<br/>
    unsigned int compression;
<br/>
    unsigned int compressedImageSize;
<br/>
    unsigned int horizontalResolution;
<br/>
    unsigned int verticalResolution;
<br/>
    unsigned int numColors;
<br/>
    unsigned int importantColors;
<br/>
} __attribute__ ((packed)) BmpImageInfo;
<br/>
<br/>
// 256 bytes
<br/>
typedef struct {
<br/>
    unsigned char blue;
<br/>
    unsigned char green;
<br/>
    unsigned char red;
<br/>
    unsigned char reserved;
<br/>
} __attribute__ ((packed)) Rgb;
<br/>
<br/>
typedef struct {
<br/>
    BmpHeader header;
<br/>
    BmpImageInfo info;
<br/>
    Rgb colors[256];
<br/>
    unsigned short image[1];
<br/>
} __attribute__ ((packed)) BmpFile;
<br/>
<br/>
int main(int argc, char **argv) {
<br/>
    u16 *video_buffer_main = (u16*)BG_BMP_RAM(0);
<br/>
    videoSetMode(MODE_5_2D | DISPLAY_BG3_ACTIVE);
<br/>
    vramSetBankA(VRAM_A_MAIN_BG_0x06000000);
<br/>
    BACKGROUND.control[3] = BG_BMP8_256x256 | BG_BMP_BASE(0);
<br/>
    BACKGROUND.bg3_rotation.xdy = 0;
<br/>
    BACKGROUND.bg3_rotation.xdx = 1 &lt;&lt; 8;
<br/>
    BACKGROUND.bg3_rotation.ydx = 0;
<br/>
    BACKGROUND.bg3_rotation.ydy = 1 &lt;&lt; 8;
<br/>
    BmpFile* bmp = (BmpFile*)beerguy_bin; 
<br/>
    consoleDemoInit();
<br/>
    printf("File Size: %i\n", bmp -&gt; header.fileSize);
<br/>
    printf("%c%c\n", bmp -&gt; header.signature[0], bmp -&gt; header.signature[1]);
<br/>
    printf("bit depth: %i\n", bmp -&gt; info.bitDepth);
<br/>
    printf("width:     %i\n", bmp -&gt; info.width);
<br/>
    printf("height:    %i\n", bmp -&gt; info.height);
<br/>
    for (register int i = 0; i &lt; 256; ++i) {
<br/>
        BG_PALETTE[i] = RGB15(  bmp -&gt; colors[i].red &gt;&gt; 3,
<br/>
                                               bmp -&gt; colors[i].green &gt;&gt; 3,
<br/>
                                               bmp -&gt; colors[i].blue &gt;&gt; 3);
<br/>
    }
<br/>
    for(register int iy = 0, ix = 0; iy &lt; bmp -&gt; info.height; ++iy) {
<br/>
        for(ix = 0; ix &lt; bmp -&gt; info.width / 2; ++ix) {
<br/>
            video_buffer_main[iy * 128 + ix] =
<br/>
                bmp -&gt; image[   (bmp -&gt; info.height - 1 - iy) *
<br/>
                                         ((bmp -&gt; info.width + 3) &amp; ~3) / 2 + ix];
<br/>
        }
<br/>
    }
<br/>
    while (1);
<br/>
    return 0;
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
then, as an exercise (and because a read lots of posts recommending filesystem use instead of use the images directly in code), I try to convert the same code in order to have filesystem support (nitrofs in this case):
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#include &lt;nds.h&gt;
<br/>
#include &lt;filesystem.h&gt;
<br/>
#include &lt;stdio.h&gt;
<br/>
<br/>
// 14 bytes
<br/>
typedef struct {
<br/>
    char signature[2];
<br/>
    unsigned int fileSize; // 4 bytes, 32 bits
<br/>
    unsigned int reserved;
<br/>
    unsigned int offset;
<br/>
} __attribute__ ((packed)) BmpHeader;
<br/>
<br/>
// 40 bytes
<br/>
typedef struct {
<br/>
    unsigned int headerSize;
<br/>
    unsigned int width;
<br/>
    unsigned int height;
<br/>
    unsigned short planeCount;
<br/>
    unsigned short bitDepth;
<br/>
    unsigned int compression;
<br/>
    unsigned int compressedImageSize;
<br/>
    unsigned int horizontalResolution;
<br/>
    unsigned int verticalResolution;
<br/>
    unsigned int numColors;
<br/>
    unsigned int importantColors;
<br/>
} __attribute__ ((packed)) BmpImageInfo;
<br/>
<br/>
// 256 bytes
<br/>
typedef struct {
<br/>
    unsigned char blue;
<br/>
    unsigned char green;
<br/>
    unsigned char red;
<br/>
    unsigned char reserved;
<br/>
} __attribute__ ((packed)) Rgb;
<br/>
<br/>
typedef struct {
<br/>
    BmpHeader header;
<br/>
    BmpImageInfo info;
<br/>
    Rgb colors[256];
<br/>
    unsigned short image[1];
<br/>
} __attribute__ ((packed)) BmpFile;
<br/>
<br/>
int main(int argc, char **argv) {
<br/>
    u16 *video_buffer_main = (u16*)BG_BMP_RAM(0);
<br/>
    BmpFile *bmp = NULL;
<br/>
    FILE *bitmapFile = NULL;
<br/>
    videoSetMode(MODE_5_2D | DISPLAY_BG3_ACTIVE);
<br/>
    vramSetBankA(VRAM_A_MAIN_BG_0x06000000);
<br/>
    BACKGROUND.control[3] = BG_BMP8_256x256 | BG_BMP_BASE(0);
<br/>
    BACKGROUND.bg3_rotation.xdy = 0;
<br/>
    BACKGROUND.bg3_rotation.xdx = 1 &lt;&lt; 8;
<br/>
    BACKGROUND.bg3_rotation.ydx = 0;
<br/>
    BACKGROUND.bg3_rotation.ydy = 1 &lt;&lt; 8;
<br/>
    consoleDemoInit();
<br/>
    if (nitroFSInit()) {
<br/>
        bitmapFile = fopen("beerguy.bmp", "rb");
<br/>
        fread(&amp;bmp -&gt; header, sizeof(BmpHeader), 1, bitmapFile);
<br/>
        printf("File Size: %i\n", bmp -&gt; header.fileSize);
<br/>
        printf("Header size: %ld \n", ftell(bitmapFile));
<br/>
        printf("%c%c\n", bmp -&gt; header.signature[0], bmp -&gt; header.signature[1]);
<br/>
        fread(&amp;bmp -&gt; info, sizeof(BmpImageInfo), 1, bitmapFile);
<br/>
        printf("Info: %ld \n", ftell(bitmapFile));
<br/>
        printf("Depth: %i\n", bmp -&gt; info.bitDepth);
<br/>
        printf("Width:     %i\n", bmp -&gt; info.width);
<br/>
        printf("Height:    %i\n", bmp -&gt; info.height);
<br/>
// Here is where I'm stuck because fread crash reading BMP palette
<br/>
        fread(&amp;bmp -&gt; colors, sizeof(Rgb), 256, bitmapFile);
<br/>
        for (register int i = 0; i &lt; 256; ++i) {
<br/>
            BG_PALETTE[i] = RGB15(  bmp -&gt; colors[i].red &gt;&gt; 3,
<br/>
                                                   bmp -&gt; colors[i].green &gt;&gt; 3,
<br/>
                                                   bmp -&gt; colors[i].blue &gt;&gt; 3);
<br/>
        }
<br/>
        printf("Palette: %ld \n", ftell(bitmapFile));
<br/>
        int sz = bmp -&gt; info.height * bmp -&gt; info.width;
<br/>
        fread(&amp;bmp -&gt; image, sizeof(unsigned short), sz, bitmapFile);        
<br/>
        for(register int iy = 0, ix = 0; iy &lt; bmp -&gt; info.height; ++iy) {
<br/>
            for(ix = 0; ix &lt; bmp -&gt; info.width / 2; ++ix) {
<br/>
                video_buffer_main[iy * 128 + ix] =
<br/>
                    bmp -&gt; image[   (bmp -&gt; info.height - 1 - iy) *
<br/>
                                             ((bmp -&gt; info.width + 3) &amp; ~3) / 2 + ix];
<br/>
            }
<br/>
        }
<br/>
        printf("Image: %ld \n", ftell(bitmapFile));
<br/>
    } else {
<br/>
   printf("nitroFSInit failed.\n");
<br/>
    }
<br/>
    fclose(bitmapFile);
<br/>
    while (1);
<br/>
    return 0;
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I try the code with the NO$GBA and it crash with a fatal error that say: "Undefined opcode - with no debug vector defined". At first I think the crash was caused by image file size, because at my first try with filesystem support I try an image with a resolution of 320x200, but the file size was 65078 bytes, is not even a half of whole vram bank. Then I try with the original image, beerguy, but it crash too. I look in the forum if someone had the same problem, but <a class="postlink" href="http://forum.gbadev.org/viewtopic.php?t=16043&amp;highlight=bmp" target="_blank">this</a> is the only post I found with a, more or less, related problem. Hope that somebody can give guidance of a way to load files correctly in the DS and that Dovoto finish the tutorials in the wiki, they are very helpful indeed! :)
<br/>
<br/>
P.D.: The BMP files I'm loading are 8 bit only.</span><span class="gensmall"><br/><br/>Last edited by raomon on Wed Jul 29, 2009 12:47 am; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#169617 - vuurrobin - Mon Jul 27, 2009 1:25 am</h4>
    <div class="postbody"><span class="postbody">I think most people use grit to convert the image files to a format that the ds can handle better. 
<br/>
<br/>
and Dovoto haven't worked on the tutorials in quite some time. I doubt they are up to date with the latest libnds. not that you can't learn from them, but libnds contains a lot of functions to make things easier for programmers.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#169618 - raomon - Mon Jul 27, 2009 2:38 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>vuurrobin wrote:</b></span></td> </tr> <tr> <td class="quote">I think most people use grit to convert the image files to a format that the ds can handle better.</td> </tr></table><span class="postbody">
<br/>
The main reason to try BMP instead of using tools like grit is because I dont always know, ahead of time, what kind of files I'll be using, so I need to decode "non-native" file formats. For example, if I want to write a comic book viewer homebrew that load RAR,ZIP,etc files with images inside (BMP, GIF, PNG, JPEG, etc), then I can't using the raw "comic book file" without first using grit or other tool for transforming the images inside, making it more a problem for the user point of view. I look at the LibNDS api and found that there is support for loading PCX files from there, very useful but not what I'm looking for (yet). So once I know how to load the BMP images correctly, I can try other image file formats and then continue with the following parts of the tutorial.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>vuurrobin wrote:</b></span></td> </tr> <tr> <td class="quote">and Dovoto haven't worked on the tutorials in quite some time. I doubt they are up to date with the latest libnds. not that you can't learn from them, but libnds contains a lot of functions to make things easier for programmers.</td> </tr></table><span class="postbody">
<br/>
Is a pity that Dovoto don't work anymore on the tutorials, I like the low level aproach. :/</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#169672 - raomon - Wed Jul 29, 2009 12:46 am</h4>
    <div class="postbody"><span class="postbody">Hi, I fix the problem and now it work as should be. Just change the image atribute in BmpFile struct from unsigned short image[1] to unsigned short *image, malloc BmpFile and then image atribute with the resolution size of the image. I hope somebody found it useful. Here is the code:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#include &lt;nds.h&gt;
<br/>
#include &lt;filesystem.h&gt;
<br/>
#include &lt;stdio.h&gt;
<br/>
<br/>
typedef struct {
<br/>
    char signature[2];
<br/>
    unsigned int fileSize;
<br/>
    unsigned int reserved;
<br/>
    unsigned int offset;
<br/>
} __attribute__ ((packed)) BmpHeader;
<br/>
<br/>
typedef struct {
<br/>
    unsigned int headerSize;
<br/>
    unsigned int width;
<br/>
    unsigned int height;
<br/>
    unsigned short planeCount;
<br/>
    unsigned short bitDepth;
<br/>
    unsigned int compression;
<br/>
    unsigned int compressedImageSize;
<br/>
    unsigned int horizontalResolution;
<br/>
    unsigned int verticalResolution;
<br/>
    unsigned int numColors;
<br/>
    unsigned int importantColors;
<br/>
} __attribute__ ((packed)) BmpImageInfo;
<br/>
<br/>
typedef struct {
<br/>
    unsigned char blue;
<br/>
    unsigned char green;
<br/>
    unsigned char red;
<br/>
    unsigned char reserved;
<br/>
} __attribute__ ((packed)) Rgb;
<br/>
<br/>
typedef struct {
<br/>
    BmpHeader header;
<br/>
    BmpImageInfo info;
<br/>
    Rgb colors[256];
<br/>
    unsigned short *image;
<br/>
} __attribute__ ((packed)) BmpFile;
<br/>
<br/>
int main(int argc, char **argv) {
<br/>
    u16 *video_buffer_main = (u16*)BG_BMP_RAM(0);
<br/>
    BmpFile *bmp = (BmpFile *) malloc(sizeof(BmpFile));
<br/>
    FILE *bitmapFile = NULL;
<br/>
    videoSetMode(MODE_5_2D | DISPLAY_BG3_ACTIVE);
<br/>
    vramSetBankA(VRAM_A_MAIN_BG_0x06000000);
<br/>
    BACKGROUND.control[3] = BG_BMP8_256x256 | BG_BMP_BASE(0);
<br/>
    BACKGROUND.bg3_rotation.xdy = 0;
<br/>
    BACKGROUND.bg3_rotation.xdx = 1 &lt;&lt; 8;
<br/>
    BACKGROUND.bg3_rotation.ydx = 0;
<br/>
    BACKGROUND.bg3_rotation.ydy = 1 &lt;&lt; 8;
<br/>
    consoleDemoInit();
<br/>
    if (nitroFSInit()) {
<br/>
        bitmapFile = fopen("beerguy.bmp", "rb");
<br/>
        fread(&amp;bmp -&gt; header, sizeof(BmpHeader), 1, bitmapFile);
<br/>
        printf("File Size: %i\n", bmp -&gt; header.fileSize);
<br/>
        printf("Header size: %ld \n", ftell(bitmapFile));
<br/>
        printf("%c%c\n", bmp -&gt; header.signature[0], bmp -&gt; header.signature[1]);
<br/>
        fread(&amp;bmp -&gt; info, sizeof(BmpImageInfo), 1, bitmapFile);
<br/>
        printf("Info: %ld \n", ftell(bitmapFile));
<br/>
        printf("Depth: %i\n", bmp -&gt; info.bitDepth);
<br/>
        printf("Width:     %i\n", bmp -&gt; info.width);
<br/>
        printf("Height:    %i\n", bmp -&gt; info.height);
<br/>
        fread(bmp -&gt; colors, sizeof(Rgb), 256, bitmapFile);
<br/>
        for (register int i = 0; i &lt; 256; ++i) {
<br/>
            BG_PALETTE[i] = RGB15(  bmp -&gt; colors[i].red &gt;&gt; 3,
<br/>
                                    bmp -&gt; colors[i].green &gt;&gt; 3,
<br/>
                                    bmp -&gt; colors[i].blue &gt;&gt; 3);
<br/>
        }
<br/>
        printf("Palette: %ld \n", ftell(bitmapFile));        
<br/>
        bmp -&gt; image = (unsigned short *) malloc(sizeof(unsigned short) * (bmp -&gt; info.width * bmp -&gt; info.height));
<br/>
        fread(bmp -&gt; image, sizeof(unsigned short), (bmp -&gt; info.width * bmp -&gt; info.height), bitmapFile);
<br/>
        for(register int iy = 0, ix = 0; iy &lt; bmp -&gt; info.height; ++iy) {
<br/>
            for(ix = 0; ix &lt; bmp -&gt; info.width / 2; ++ix) {
<br/>
                video_buffer_main[iy * 128 + ix] =
<br/>
                    bmp -&gt; image[   (bmp -&gt; info.height - 1 - iy) *
<br/>
                    ((bmp -&gt; info.width + 3) &amp; ~3) / 2 + ix];
<br/>
            }
<br/>
        }
<br/>
        printf("Image: %ld \n", ftell(bitmapFile));
<br/>
    } else {
<br/>
        printf("Falla de nitroFSInit: Terminando.\n");
<br/>
    }
<br/>
    fclose(bitmapFile);
<br/>
    free(bmp -&gt; image);
<br/>
    free(bmp);
<br/>
    while (1);
<br/>
    return 0;
<br/>
}
<br/>
</td> </tr></table><span class="postbody">[/quote]</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
