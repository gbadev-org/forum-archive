<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>unlink & libfat not working? - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>DS development > unlink & libfat not working?</h2>
<div id="posts">
<div class="post">
    <h4>#148080 - DSfriol - Wed Jan 02, 2008 12:49 am</h4>
    <div class="postbody"><span class="postbody">I've compiled this simple program with libfat (the latest from CVS, where statvfs *seems* to work) and run it on my DS Lite with R4 (1Gb microSD):
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
<br/>
...
<br/>
<br/>
void printFreeDiskSpace()
<br/>
{
<br/>
    struct statvfs st;
<br/>
    statvfs("/.", &amp;st);
<br/>
   iprintf("free space [%ld] Kb",(st.f_bfree*st.f_bsize)/(1024));
<br/>
}
<br/>
<br/>
int main(void) 
<br/>
{
<br/>
   initDs();
<br/>
   fatInitDefault();
<br/>
<br/>
   for (int i=0;i&lt;4;i++)
<br/>
   {
<br/>
      iprintf("iteration [%d]\n",i);
<br/>
<br/>
      FILE* myf=fopen("/test.txt","wt");
<br/>
      if (myf==NULL)
<br/>
      {
<br/>
         iprintf("error opening file\n");
<br/>
         return 1;
<br/>
      }
<br/>
<br/>
      for (int j=0;j&lt;(1024*16);j++)
<br/>
      {
<br/>
         fprintf(myf,"0123456789abcdef");
<br/>
      }
<br/>
<br/>
      fclose(myf);
<br/>
      printFreeDiskSpace();
<br/>
<br/>
      if (unlink("/test.txt")==0)
<br/>
      {
<br/>
         iprintf("ok\n");
<br/>
         printFreeDiskSpace();
<br/>
      }
<br/>
   }
<br/>
<br/>
   return 0;
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Unfortunately, subsequent calls to "printFreeDiskSpace" show that space is *not* staying constant, but *decreases*, even if I call "unlink" on the created file.
<br/>
<br/>
What is not working, statvfs, unlink or...?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#148147 - DSfriol - Wed Jan 02, 2008 11:36 pm</h4>
    <div class="postbody"><span class="postbody">Update: today I run chkdsk from Windows on the microSD and it found 14 lost files. So the problem seems to be in the unlink function. Anyone tried this on his DS?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#148149 - simonjhall - Thu Jan 03, 2008 12:07 am</h4>
    <div class="postbody"><span class="postbody">Isn't unlink one of those internal functions that you're not meant to call? I've always used remove() and I (think I!) get the right results...<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#148172 - DSfriol - Thu Jan 03, 2008 8:52 am</h4>
    <div class="postbody"><span class="postbody">Same result with "remove" (the space is decreasing).</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#148267 - Abcd1234 - Fri Jan 04, 2008 1:41 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>simonjhall wrote:</b></span></td> </tr> <tr> <td class="quote">Isn't unlink one of those internal functions that you're not meant to call? I've always used remove() and I (think I!) get the right results...</td> </tr></table><span class="postbody">
<br/>
<br/>
I would hope not.  unlink() is a standard POSIX libc function, defined in unistd.h, and is the only portable way to delete a file (as far as I'm aware).  It should be no more internal than open(), close(), read(), etc.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#148270 - DSfriol - Fri Jan 04, 2008 3:10 am</h4>
    <div class="postbody"><span class="postbody">I fear libfat has a problem, here.
<br/>
The applications that are using the old lib_fat_nds are ok on my R4, instead. I wrote an email to chishm on the subject.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#148285 - chishm - Fri Jan 04, 2008 10:12 am</h4>
    <div class="postbody"><span class="postbody">I'll take a look at this when I have my development PC up and running again.<br/>_________________<br/><a class="postlink" href="http://chishm.drunkencoders.com" target="_blank">http://chishm.drunkencoders.com</a>
<br/>
<a class="postlink" href="http://dldi.drunkencoders.com" target="_blank">http://dldi.drunkencoders.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#148328 - DSfriol - Fri Jan 04, 2008 4:34 pm</h4>
    <div class="postbody"><span class="postbody">Can I help in any way in the mean time? Compiling libfat with debug, or something similar?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#148391 - chishm - Sat Jan 05, 2008 6:22 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>DSfriol wrote:</b></span></td> </tr> <tr> <td class="quote">Can I help in any way in the mean time? Compiling libfat with debug, or something similar?</td> </tr></table><span class="postbody">Nah, this is mostly a "try it and see what happens" type thing for me. Debugging will involve reproducing the problem, examining the on-disc data structures (the FAT mostly), then figuring out which function is screwing up.<br/>_________________<br/><a class="postlink" href="http://chishm.drunkencoders.com" target="_blank">http://chishm.drunkencoders.com</a>
<br/>
<a class="postlink" href="http://dldi.drunkencoders.com" target="_blank">http://dldi.drunkencoders.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#148395 - DSfriol - Sat Jan 05, 2008 10:23 am</h4>
    <div class="postbody"><span class="postbody">Ok, I'll wait (remember that I have an R4, if that counts).</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
