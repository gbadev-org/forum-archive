<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>akaio and fat.h - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > akaio and fat.h</h2>
<div id="posts">
<div class="post">
    <h4>#172688 - radiodee1 - Thu Feb 25, 2010 2:03 pm</h4>
    <div class="postbody"><span class="postbody">I downloaded and installed akaio on my acekard. The game I'm working on seems to work ok BUT a simple group of score saving functions doesn't work right. Is there some problem with fat.h with the akaio or is this sloppy coding on my part that must be re-worked? I'm using fgetc, fputc, fread and fwrite. Has anyone else heard of anything like this? I don't have another card to test this on, just my one acekard. Thanks.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#172690 - Lazy1 - Thu Feb 25, 2010 3:03 pm</h4>
    <div class="postbody"><span class="postbody">You're going to have to post your score saving code :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#172692 - radiodee1 - Thu Feb 25, 2010 4:38 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">// awesomeguy is the name of the game, and
<br/>
// awesomeguy.dat is the name of the data
<br/>
// file. I tried to take out the 'fread' and
<br/>
// 'fwrite' commands and replaced them with
<br/>
// fgetc and fputc loops, but I left the 
<br/>
// original code in this listing commented out.
<br/>
<br/>
void readData(Score  data[]) {
<br/>
  int i , j, k;
<br/>
  char test[12] = "none       ";
<br/>
  j = 0;
<br/>
  FILE* users;
<br/>
  
<br/>
  for(i = 0; i &lt; 5; i ++) {
<br/>
    j = j + data[i].score;
<br/>
  }
<br/>
  if (j &gt; 0) return;
<br/>
  
<br/>
  mkdir("/DATA", S_IRWXU | S_IRWXO | S_IRWXG);
<br/>
  mkdir("/DATA/awesomeguy", S_IRWXU | S_IRWXO | S_IRWXG);
<br/>
  users = fopen("/DATA/awesomeguy/awesomeguy.dat", "rb");
<br/>
  for (i = 0; i &lt; 5; i ++) {
<br/>
    /*
<br/>
    fread(test, 1, 12, users);
<br/>
    for (k = 0; k &lt; 12; k ++)
<br/>
      data[i].name[k] = test[k];
<br/>
    */
<br/>
    
<br/>
    for (k = 0; k &lt; 12; k ++) {
<br/>
      data[i].name[k] = fgetc(users);
<br/>
    }
<br/>
    
<br/>
    
<br/>
    data[i].score = fgetc( users);
<br/>
    data[i].score += fgetc( users) &lt;&lt; 8;
<br/>
    data[i].score += fgetc( users) &lt;&lt; 16;
<br/>
    data[i].score += fgetc( users) &lt;&lt; 24;
<br/>
    
<br/>
    data[i].level = fgetc( users);
<br/>
    data[i].save1 = fgetc( users);
<br/>
    data[i].save2 = fgetc( users);
<br/>
    data[i].save3 = fgetc( users);
<br/>
    
<br/>
  }
<br/>
  fclose(users);
<br/>
}
<br/>
<br/>
void writeData(Score data[]) {
<br/>
  int i , k;
<br/>
  FILE* users;
<br/>
  //char test[12] = "0123456789 "; // don't forget null ending.
<br/>
  mkdir("/DATA", S_IRWXU | S_IRWXO | S_IRWXG);
<br/>
  mkdir("/DATA/awesomeguy", S_IRWXU | S_IRWXO | S_IRWXG);
<br/>
  users = fopen("/DATA/awesomeguy/awesomeguy.dat", "wb");
<br/>
  fclose(users);
<br/>
  users = fopen("/DATA/awesomeguy/awesomeguy.dat", "ab");
<br/>
  for (i = 0; i &lt; 5; i ++ ) {
<br/>
<br/>
    //fwrite(data[i].name, 1, 12, users);
<br/>
    
<br/>
    for (k = 0; k &lt; 12; k ++) {
<br/>
      fputc( data[i].name[k] ,users);
<br/>
    }
<br/>
    
<br/>
    fputc(data[i].score, users);
<br/>
    
<br/>
    fputc(data[i].score &gt;&gt; 8, users);
<br/>
    
<br/>
    fputc(data[i].score &gt;&gt; 16, users);
<br/>
    
<br/>
    fputc(data[i].score &gt;&gt; 24, users);
<br/>
    
<br/>
    fputc(data[i].level, users);
<br/>
    
<br/>
    fputc(data[i].save1, users);
<br/>
    
<br/>
    fputc(data[i].save2, users);
<br/>
    
<br/>
    fputc(data[i].save3, users);    
<br/>
    
<br/>
  }
<br/>
  fwrite(" END ", 1, 6, users);
<br/>
<br/>
  fclose(users);
<br/>
<br/>
}</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#172693 - radiodee1 - Thu Feb 25, 2010 5:51 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">typedef struct {
<br/>
  // the name of the player.
<br/>
  char name[12];
<br/>
  // the score attained.
<br/>
  u32 score;
<br/>
  // the level the player has played to.
<br/>
  int level;
<br/>
  // three aspects of play that can be saved.
<br/>
  // save1 is lives
<br/>
  // save2 is cycles
<br/>
  // save3 is undefined
<br/>
  int save1,save2,save3;
<br/>
} Score;
<br/>
</td> </tr></table><span class="postbody">
<br/>
Oh, I almost forgot to include that the two functions are passed an array of 5 of these 'Score' structs. That's what <span style="font-style: italic">data[]</span> is.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#172694 - elhobbs - Thu Feb 25, 2010 6:25 pm</h4>
    <div class="postbody"><span class="postbody">are you sure your file is being opened? there is no error checking. perhaps fopen is failing?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#172697 - radiodee1 - Thu Feb 25, 2010 7:15 pm</h4>
    <div class="postbody"><span class="postbody">I put lines like this:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">assert(users != NULL);</td> </tr></table><span class="postbody">
<br/>
after each 'fopen'. The game halts when running under emulation, but runs as before on my DS... with the same messed up contents of the 'data' structs.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#172699 - Azenris - Thu Feb 25, 2010 7:53 pm</h4>
    <div class="postbody"><span class="postbody">not really sure of your problem but i was just wondering why you don't write the whole structure instead of its individual pieces
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">// =================================================================================
<br/>
// SaveGame:
<br/>
// &lt;&lt;: returns   whether or not it successfully saved
<br/>
bool CSaveData::SaveGame(void)
<br/>
{
<br/>
   if (FileSystemOK())
<br/>
   {
<br/>
      // == gather the needed information ==
<br/>
      GatherInformation();
<br/>
<br/>
      // == save the data ==
<br/>
      FILE *pFile = fopen(TXT_SAVEDATA_FILE, "wb");
<br/>
      
<br/>
      if (pFile != NULL)
<br/>
      {
<br/>
         fseek(pFile, 0, SEEK_SET);
<br/>
         fwrite((void*)&amp;m_saveData, sizeof(SAVE_DATA), 1, pFile);
<br/>
         fclose(pFile);
<br/>
<br/>
         return true;
<br/>
      }
<br/>
      else
<br/>
      {
<br/>
         ASSERT(0, "Cannot create savefile")
<br/>
         return false;
<br/>
      }
<br/>
   }
<br/>
<br/>
   return false;
<br/>
}
<br/>
<br/>
// =================================================================================
<br/>
// LoadGame:
<br/>
// &lt;&lt;: returns   whether or not it successfully loaded
<br/>
bool CSaveData::LoadGame(void)
<br/>
{
<br/>
   if (FileSystemOK())
<br/>
   {
<br/>
      // == load the data ==
<br/>
      FILE *pFile = fopen(TXT_SAVEDATA_FILE, "rb");
<br/>
      
<br/>
      if (pFile != NULL)
<br/>
      {
<br/>
         fseek(pFile, 0, SEEK_SET);
<br/>
         fread((void*)&amp;m_saveData, sizeof(SAVE_DATA), 1, pFile);
<br/>
         fclose(pFile);
<br/>
<br/>
         // == place the data where needed ==
<br/>
         DistributeInformation();
<br/>
<br/>
         return true;
<br/>
      }
<br/>
      else
<br/>
      {
<br/>
         return false;
<br/>
      }
<br/>
   }
<br/>
<br/>
   return false;
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
Basically I save the whole saveData struct at once, instead of going through its variables.
<br/>
<br/>
Also just wondering did you mean 
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">users = fopen("/DATA/awesomeguy/awesomeguy.dat", "ab"); </td> </tr></table><span class="postbody">
<br/>
<br/>
ab is append file, as in write at the end
<br/>
<br/>
<a class="postlink" href="http://www.opengroup.org/onlinepubs/007908799/xsh/fopen.html" target="_blank">http://www.opengroup.org/onlinepubs/007908799/xsh/fopen.html</a><br/>_________________<br/><a class="postlink" href="http://sacredpotion.blogspot.com/" target="_blank"><span style="color: red">My Homebrew Games</span></a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#172700 - radiodee1 - Thu Feb 25, 2010 8:22 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Azenris wrote:</b></span></td> </tr> <tr> <td class="quote">not really sure of your problem but i was just wondering why you don't write the whole structure instead of its individual pieces</td> </tr></table><span class="postbody">
<br/>
<br/>
I didn't know that you could. btw, can you explain this:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">      (void*)&amp;m_saveData</td> </tr></table><span class="postbody">
<br/>
??
<br/>
<br/>
Also, about the wb/ab thing... if you don't append the info to the end of the file then the beginning of the file is constantly rewritten. Your way is probably better, but I'm more of a noob (obviously) and my programming skills are lesser. Can you save arrays as well as structs using fwrite? Do you have to serialize them first?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#172701 - Azenris - Thu Feb 25, 2010 9:08 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>radiodee1 wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
I didn't know that you could. btw, can you explain this:
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">      (void*)&amp;m_saveData</td> </tr></table><span class="postbody">
<br/>
??
<br/>
</span></td> </tr></table><span class="postbody">
<br/>
<br/>
That's just a cast, fread/write take a void pointer as their first parameter
<br/>
<a class="postlink" href="http://www.opengroup.org/onlinepubs/007908799/xsh/stdio.h.html" target="_blank">http://www.opengroup.org/onlinepubs/007908799/xsh/stdio.h.html</a>
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>radiodee1 wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
Do you have to serialize them first?
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I didn't.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>radiodee1 wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
Also, about the wb/ab thing... if you don't append the info to the end of the file then the beginning of the file is constantly rewritten. </td> </tr></table><span class="postbody">
<br/>
<br/>
Isn't that what you want, to save the data to the file. And read then what you have. If you kept adding to the end the file would grow and grow and the read function is only ever looking at the first 5 entries anyway.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>radiodee1 wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
Can you save arrays as well as structs using fwrite? 
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Think so you would have to change the nitems parameter.
<br/>
<a class="postlink" href="http://www.opengroup.org/onlinepubs/007908799/xsh/fwrite.html" target="_blank">http://www.opengroup.org/onlinepubs/007908799/xsh/fwrite.html</a><br/>_________________<br/><a class="postlink" href="http://sacredpotion.blogspot.com/" target="_blank"><span style="color: red">My Homebrew Games</span></a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#172702 - radiodee1 - Thu Feb 25, 2010 9:42 pm</h4>
    <div class="postbody"><span class="postbody">this is discouraging as all this worked fine with the old Acekard software... v. 4.18 I think. I still have it, so I may end up going back to it till I can figure this out. btw, I changed the line that said ab to wb with no visible improvement.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#172709 - Lazy1 - Fri Feb 26, 2010 1:52 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Azenris wrote:</b></span></td> </tr> <tr> <td class="quote">not really sure of your problem but i was just wondering why you don't write the whole structure instead of its individual pieces
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I thought there was a good reason for this, it has something to do with alignment and portability between platforms and compilers.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#172722 - radiodee1 - Fri Feb 26, 2010 5:34 pm</h4>
    <div class="postbody"><span class="postbody">I tried AKAIO.1.4.1.Fixed.rar today and found that my code works. You'd think I'd be happy, but I'm still thinking about 1.5.1 (the version that doesn't work). Thanks to posters in this thread, cause my code now looks a lot nicer. The thing that doesn't work for me seems to be fread or fopen with "rb" mode.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#172723 - Lazy1 - Fri Feb 26, 2010 6:21 pm</h4>
    <div class="postbody"><span class="postbody">See what errno is set to after fopen fails.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#172724 - radiodee1 - Fri Feb 26, 2010 6:35 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Lazy1 wrote:</b></span></td> </tr> <tr> <td class="quote">See what errno is set to after fopen fails.</td> </tr></table><span class="postbody">How do you do this?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#172726 - Normmatt - Fri Feb 26, 2010 8:43 pm</h4>
    <div class="postbody"><span class="postbody">copy the official firmware's ak2 dldi and overwrite the akaio one (it has some problems with certain games).</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
