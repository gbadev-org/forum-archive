<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Microphone - with sourcecode - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > Microphone - with sourcecode</h2>
<div id="posts">
<div class="post">
    <h4>#47590 - NEiM0D - Mon Jul 11, 2005 4:38 am</h4>
    <div class="postbody"><span class="postbody">Hi,
<br/>
<br/>
I've figured out how the microphone works.
<br/>
<br/>
Here is some sourcecode (uses my own defines and such, from my site DSTek (<a class="postlink" href="http://neimod.com/dstek/" target="_blank">http://neimod.com/dstek/</a>)):
<br/>
<br/>
<a href="http://www.rafb.net/paste/results/M1ZT3a93.html" target="_blank">http://www.rafb.net/paste/results/M1ZT3a93.html</a>
<br/>
<br/>
Can someone make an ndslib compatible version perhaps?
<br/>
<br/>
I don't like ndslib that much myself, but I gather alot of people use it.
<br/>
<br/>
Oh yes, there's a microphone gain control register too, an update should follow.
<br/>
<br/>
Cheers.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#47592 - Volta - Mon Jul 11, 2005 5:14 am</h4>
    <div class="postbody"><span class="postbody">two thumbs up! :D</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#47598 - rize - Mon Jul 11, 2005 5:53 am</h4>
    <div class="postbody"><span class="postbody">Is the recording/playback supposed to be that full of static?
<br/>
<br/>
nice job btw</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#47599 - MrAdults - Mon Jul 11, 2005 6:27 am</h4>
    <div class="postbody"><span class="postbody">Great to see someone got this up and running, I've been waiting for it. Haven't tried it yet, but looking at it I would note that (0^128)==128 (as an example), and that will be treated as noise on an 8-bit sound channel, which would be producing static. (the ds sound buffer should be read as unsigned, so that will not wrap)
<br/>
<br/>
Edit: tested this out this morning, sounds fine on my hardware.
<br/>
<br/>
-Rich</span><span class="gensmall"><br/><br/>Last edited by MrAdults on Mon Jul 11, 2005 2:39 pm; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#47612 - doublec - Mon Jul 11, 2005 11:30 am</h4>
    <div class="postbody"><span class="postbody">I've put a libnds compatible version in the following two files:
<br/>
<br/>
<a href="http://www.double.co.nz/nintendo_ds/microphone_demo1/microphone7.h" target="_blank">http://www.double.co.nz/nintendo_ds/microphone_demo1/microphone7.h</a>
<br/>
<a href="http://www.double.co.nz/nintendo_ds/microphone_demo1/microphone7.cpp" target="_blank">http://www.double.co.nz/nintendo_ds/microphone_demo1/microphone7.cpp</a>
<br/>
<br/>
And wrote a small tutorial on using them heavily based on your code:
<br/>
<br/>
<a href="http://www.double.co.nz/nintendo_ds/nds_develop9.html" target="_blank">http://www.double.co.nz/nintendo_ds/nds_develop9.html</a>
<br/>
<br/>
Thanks for providing the code!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#47621 - Chetic - Mon Jul 11, 2005 1:52 pm</h4>
    <div class="postbody"><span class="postbody">Great job, Neimod!
<br/>
Now we pretty much just have Wifi left, eh? ;)<br/>_________________<br/>Packin':
<br/>
Grey DS with FlashMe v7
<br/>
1Gbit XG2T 2005 (Neoflash compatible)
<br/>
GBAMP, Supercard CF, 512Mb Magic Key 3 and EZFA 256Mbit</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#47624 - Spaceface - Mon Jul 11, 2005 3:05 pm</h4>
    <div class="postbody"><span class="postbody">a bit offtopic.. how does the DS in for instance wario ware detects it that you're blowing, and not just making a shitload of noise.. frequency's?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#47625 - duencil - Mon Jul 11, 2005 3:17 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>MrAdults wrote:</b></span></td> </tr> <tr> <td class="quote">Great to see someone got this up and running, I've been waiting for it. Haven't tried it yet, but looking at it I would note that (0^128)==128 (as an example), and that will be treated as noise on an 8-bit sound channel, which would be producing static. (the ds sound buffer should be read as unsigned, so that will not wrap)
<br/>
<br/>
Edit: tested this out this morning, sounds fine on my hardware.
<br/>
<br/>
-Rich</td> </tr></table><span class="postbody">
<br/>
<br/>
doublec's libnds compatible remake uses an unsigned sound buffer, but keeps the ^0x80 for signed conversion.  I?ve tried with and without the signed conversion for recording voice and music, and I can't tell which is correct.  Anyone have a better ear?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#47627 - lambi1982 - Mon Jul 11, 2005 3:25 pm</h4>
    <div class="postbody"><span class="postbody"><span style="font-weight: bold">Spaceface</span>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
a bit offtopic.. how does the DS in for instance wario ware detects it that you're blowing, and not just making a shitload of noise.. frequency's? 
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
The noise is what is looks for, when you blow into a microphone it creates a very loud noise, it does not register pressure of any kind.
<br/>
<br/>
try it out on a regular mic hooked to a stereo, thats all nothing special.
<br/>
<br/>
Now to create voice to text on the DS :)<br/>_________________<br/>Who, Me?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#47652 - doublec - Mon Jul 11, 2005 11:24 pm</h4>
    <div class="postbody"><span class="postbody">Playing around with signed/unsigned and the bit shifts in the values from MIC_GetData8 results in variations of loud recording but distorted vs quiet with a little bit of static. I'm sure there's a sweet spot somewhere that gives good volume recording with no static. I'm not knowledgable enough about sound myself to work out what the problem is though.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#47718 - assassda - Tue Jul 12, 2005 7:20 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Now to create voice to text on the DS :)</td> </tr></table><span class="postbody">
<br/>
or at least voice chat first like dsspeak</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#48017 - lambi1982 - Sat Jul 16, 2005 5:51 am</h4>
    <div class="postbody"><span class="postbody">voice chat with what? there isnt any code for a DS to DS connection YET.....( homebew ) I just thought it would be nice to input your own text.
<br/>
<br/>
Dont think that would be hard, just replace the text that is on the top screen and add a text box ;)
<br/>
<br/>
I will shut up now.........<span style="font-weight: bold"> ( As he walks quietly into the shadows ) </span><br/>_________________<br/>Who, Me?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#48022 - TJ - Sat Jul 16, 2005 7:02 am</h4>
    <div class="postbody"><span class="postbody">Well, you could start working on the interface, audio I/O, and real-time encoding/compression.
<br/>
<br/>
By the time you had all the bugs worked out on that, there would probably be some useable wireless code.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#48044 - tepples - Sat Jul 16, 2005 2:21 pm</h4>
    <div class="postbody"><span class="postbody">I can imagine that something dead simple like <a class="postlink" href="http://www.pineight.com/gba/#8ad" target="_blank">8ad</a> (a form of ADPCM) would be sufficient for compressing the audio. An 8ad data stream at 8 kHz sample rate (telephone quality) is 32 kbps (half duplex); a pair of streams (one in, one out) is 64 kbps. Compare that to the 2000 kbps stated capacity of a Ni-Fi channel.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#69917 - knight0fdragon - Fri Feb 03, 2006 12:01 am</h4>
    <div class="postbody"><span class="postbody">Has anyone got this to work with the new libnds???  Do i have to override the arm7 to use the StartRecording and Stop recording functions??  I can not find another way to actually access these functions from the arm9<br/>_________________<br/><a href="http://www.myspace.com/knight0fdragonds" target="_blank">http://www.myspace.com/knight0fdragonds</a>
<br/>
<br/>
MK DS FC: Dragon 330772 075464 
<br/>
AC WW FC: Anthony SamsClub 1933-3433-9458 
<br/>
MPFH: Dragon 0215 4231 1206</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#71136 - knight0fdragon - Fri Feb 10, 2006 4:09 pm</h4>
    <div class="postbody"><span class="postbody">looking at the mic source, it seams that if i take out the ^ 80 in ProcessMicrophoneTimerIRQ() functuins MixRead(), it makes it louder but does not clear the distortion<br/>_________________<br/><a href="http://www.myspace.com/knight0fdragonds" target="_blank">http://www.myspace.com/knight0fdragonds</a>
<br/>
<br/>
MK DS FC: Dragon 330772 075464 
<br/>
AC WW FC: Anthony SamsClub 1933-3433-9458 
<br/>
MPFH: Dragon 0215 4231 1206</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#71178 - tepples - Fri Feb 10, 2006 8:58 pm</h4>
    <div class="postbody"><span class="postbody">Try making an oscilloscope program. Read the microphone's waveform buffer and draw it to a bitmapped background, one sample per column.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#71220 - knight0fdragon - Sat Feb 11, 2006 3:40 am</h4>
    <div class="postbody"><span class="postbody">yes i will do that good idea,  btw, ^80 doesnt go from signed to unsigned...... or does the DS not use 2s compliment to go from positive to negative? IE 1 = 01h and -1 = FFh<br/>_________________<br/><a href="http://www.myspace.com/knight0fdragonds" target="_blank">http://www.myspace.com/knight0fdragonds</a>
<br/>
<br/>
MK DS FC: Dragon 330772 075464 
<br/>
AC WW FC: Anthony SamsClub 1933-3433-9458 
<br/>
MPFH: Dragon 0215 4231 1206</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#71280 - tepples - Sat Feb 11, 2006 3:51 pm</h4>
    <div class="postbody"><span class="postbody">To toggle 8-bit data between signed and unsigned, use ^ 0x80. (Not 80 which means 0x50, 0x80 which means 128.)
<br/>
<br/>
To toggle 16-bit data between signed and unsigned, use ^ 0x8000.
<br/>
<br/>
Seriously, making an o-scope will make it easier for you to diagnose audio capture format problems.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#71291 - knight0fdragon - Sat Feb 11, 2006 5:49 pm</h4>
    <div class="postbody"><span class="postbody">well i was refering to hex with the 80, but why would the last bit affect how loud it is if it was to be signed and unsigned, how would the volume be affected<br/>_________________<br/><a href="http://www.myspace.com/knight0fdragonds" target="_blank">http://www.myspace.com/knight0fdragonds</a>
<br/>
<br/>
MK DS FC: Dragon 330772 075464 
<br/>
AC WW FC: Anthony SamsClub 1933-3433-9458 
<br/>
MPFH: Dragon 0215 4231 1206</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#71350 - 0xtob - Sun Feb 12, 2006 12:51 am</h4>
    <div class="postbody"><span class="postbody">I spent the evening figuring out why the mic quality in the <a class="postlink" href="http://tobw.net/index.php?cat_id=3&amp;project=DS+Sampling+Keyboard" target="_blank">Sampling Keyboard</a> sucked that much and found out several reasons:
<br/>
<ul>
<br/>
<li>The <a class="postlink" href="http://neimod.com/dstek/dstek2.xml#Serial%20Peripheral%20Interface" target="_blank">gain register</a> was not set (seems to default to the lowest gain)
<br/>
</li><li>The arm7 vblank handler disturbed the recording, causing low-freq distorsion
<br/>
</li><li>Sampling rate was only 16khz
<br/>
</li><li>Sampling resolution was only 8 bit (12 is possible)
<br/>
</li></ul>
<br/>
Here's a demo that has all the above issues fixed, including source code: <a class="postlink" href="http://tobw.net/ds/hifimic/hifimic.zip" target="_blank">hifimic.zip</a>
<br/>
<br/>
The recording is much clearer and louder than with the original (doublec/libnds) code. You don't have to eat your DS anymore to record sound.
<br/>
<br/>
I copied the mic functions from libnds and modified them. Also, I removed unnecessary (IMO) stuff from the arm7 vblank handler, like rtc and temperature reading to get rid of the distorsion. A better way is of course to only disable this stuff when you are recording.
<br/>
<br/>
Feel free to do whatever you like with the source. I will release a slightly updated sampling keyboard soon.
<br/>
<br/>
Bye,
<br/>
Tob</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#71383 - knight0fdragon - Sun Feb 12, 2006 8:18 am</h4>
    <div class="postbody"><span class="postbody">ok I must be missing something here, because when i ran a test, -1 turned out to be 0xFF, not 0x81 like what I am assuming people are doing
<br/>
<br/>
to verify my test
<br/>
<br/>
  int ii = -1;
<br/>
  int temp = 128;
<br/>
  for (int i = 0; i &lt; 8; i++)
<br/>
 {
<br/>
    if( ii &amp; temp)
<br/>
      iprintf("1");
<br/>
   else  
<br/>
     iprintf("0");
<br/>
<br/>
   temp&gt;&gt;=1;
<br/>
}
<br/>
which will result in 1111 1111 instead of 1000 0001 which leaves me to beleive it is twos compliment.  unless someone can show me documentation on why ^80 converts a sign to unsign
<br/>
<br/>
<br/>
my lesson on twos compliment
<br/>
<br/>
original binary = 1
<br/>
<br/>
0000 0001  
<br/>
^0xFF
<br/>
1111 1110
<br/>
+ 1
<br/>
1111 1111
<br/>
<br/>
new binary = -1
<br/>
<br/>
so formula should be ^0xFF + 1<br/>_________________<br/><a href="http://www.myspace.com/knight0fdragonds" target="_blank">http://www.myspace.com/knight0fdragonds</a>
<br/>
<br/>
MK DS FC: Dragon 330772 075464 
<br/>
AC WW FC: Anthony SamsClub 1933-3433-9458 
<br/>
MPFH: Dragon 0215 4231 1206</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#71399 - tepples - Sun Feb 12, 2006 3:56 pm</h4>
    <div class="postbody"><span class="postbody">Unsigned byte values go from 0x00 through 0xFF. Two's complement signed byte values go from 0x80 through 0x7F.
<br/>
<br/>
It'd be easier to give an example if phpBB had a table tag.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#71404 - knight0fdragon - Sun Feb 12, 2006 4:52 pm</h4>
    <div class="postbody"><span class="postbody">that still doesnt give me an answer though,  by switching the last bit on an unsigned byte would give me 2 zeroes, and that I cannot find. i get -128-127,where 0 = 0000 like you said.  If data is written in twos compfrom the get-go, going from 01111111(127 Unsigned) to 11111111(255 unsigned) results in -1 signed, and last i checked 127 and -1 are not inverses lol<br/>_________________<br/><a href="http://www.myspace.com/knight0fdragonds" target="_blank">http://www.myspace.com/knight0fdragonds</a>
<br/>
<br/>
MK DS FC: Dragon 330772 075464 
<br/>
AC WW FC: Anthony SamsClub 1933-3433-9458 
<br/>
MPFH: Dragon 0215 4231 1206</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#71457 - chishm - Mon Feb 13, 2006 12:33 am</h4>
    <div class="postbody"><span class="postbody">To understand how it works, do the obvious way of going from signed to unsigned -- add 128 to it.
<br/>
<br/>
So -2 + 128 = 126.
<br/>
In 8-bit hex: 0xfe + 0x80 = 0x17e including carry, or 0x7e after rounding
<br/>
<br/>
Now do it using an xor with 0x80:
<br/>
0xfe ^ 0x80 = 0x7e
<br/>
<br/>
Notice how the two operation give the same result.<br/>_________________<br/><a class="postlink" href="http://chishm.drunkencoders.com" target="_blank">http://chishm.drunkencoders.com</a>
<br/>
<a class="postlink" href="http://dldi.drunkencoders.com" target="_blank">http://dldi.drunkencoders.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#71475 - knight0fdragon - Mon Feb 13, 2006 2:28 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>chishm wrote:</b></span></td> </tr> <tr> <td class="quote">To understand how it works, do the obvious way of going from signed to unsigned -- add 128 to it.
<br/>
<br/>
So -2 + 128 = 126.
<br/>
In 8-bit hex: 0xfe + 0x80 = 0x17e including carry, or 0x7e after rounding
<br/>
<br/>
Now do it using an xor with 0x80:
<br/>
0xfe ^ 0x80 = 0x7e
<br/>
<br/>
Notice how the two operation give the same result.</td> </tr></table><span class="postbody">
<br/>
<br/>
<br/>
um are you trying to prove my point or not?? because from what I remember -2 and 126 are not inverses, so its not a proper sign to unsign conversion<br/>_________________<br/><a href="http://www.myspace.com/knight0fdragonds" target="_blank">http://www.myspace.com/knight0fdragonds</a>
<br/>
<br/>
MK DS FC: Dragon 330772 075464 
<br/>
AC WW FC: Anthony SamsClub 1933-3433-9458 
<br/>
MPFH: Dragon 0215 4231 1206</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#71481 - chishm - Mon Feb 13, 2006 4:00 am</h4>
    <div class="postbody"><span class="postbody">I'm am proving that it works. To go from signed to unsigned 8-bit values, you want to add 128, since signed values range from -128 to 127, and you want them to range from 0 to 255.
<br/>
<br/>
So converting -2 to an unsigned value, <span style="font-style: italic">preserving order of values</span>, you add 128 to it. This gives a result of 126.
<br/>
<br/>
Again, in hex: 0xfe (-2) + 0x80 (128) = 0x7e (126)
<br/>
And using an xor with 0x80: 0xfe (-2) ^ 0x80 = 0x7e (126)
<br/>
<br/>
We are not finding the absolute value. We are shifting every value up by 128. Getting the absolute value will not preserve the order of the values. That is, we want -2 to be less than 1, even after conversion to unsigned. Adding 128 to both values gives 126 &lt; 129, which is true. Finding the absolute value gives 2 &lt; 1, which is clearly false.<br/>_________________<br/><a class="postlink" href="http://chishm.drunkencoders.com" target="_blank">http://chishm.drunkencoders.com</a>
<br/>
<a class="postlink" href="http://dldi.drunkencoders.com" target="_blank">http://dldi.drunkencoders.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#71483 - tepples - Mon Feb 13, 2006 4:10 am</h4>
    <div class="postbody"><span class="postbody">Unsigned linear PCM audio data is defined on a linear scale from 0 to some positive voltage rail. Signed audio data is defined on a linear scale from a rail of negative voltage to a rail of positive voltage. To convert from unsigned to signed, subtract the average DC value, which should usually be half the unsigned code's positive rail.
<br/>
<br/>
For 8-bit data, the proper identities are <ul><li>unsignedVal = signedVal + 0x80 </li><li>signedVal = unsignedVal - 0x80 </li></ul> but because it wraps around at 256, both the + 128 and the - 128 operations are equivalent to ^ 0x80.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#71518 - knight0fdragon - Mon Feb 13, 2006 7:47 am</h4>
    <div class="postbody"><span class="postbody">ok now i think what tepples is saying is kind of making sense to me.
<br/>
<br/>
What i get from the mic is unsigned, where the negative highest wave length starts at 0,  neutral would be at 127/128 and the positive highest would be at 255,  now what i want to do with the bit is shift it so that i get a value of -127 to 127  or whatever<br/>_________________<br/><a href="http://www.myspace.com/knight0fdragonds" target="_blank">http://www.myspace.com/knight0fdragonds</a>
<br/>
<br/>
MK DS FC: Dragon 330772 075464 
<br/>
AC WW FC: Anthony SamsClub 1933-3433-9458 
<br/>
MPFH: Dragon 0215 4231 1206</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#71607 - knight0fdragon - Mon Feb 13, 2006 7:07 pm</h4>
    <div class="postbody"><span class="postbody">0xtob  any chance to get an example of the code you provided??  When I just popped ur code in, it recorded the sound but my voice was slower<br/>_________________<br/><a href="http://www.myspace.com/knight0fdragonds" target="_blank">http://www.myspace.com/knight0fdragonds</a>
<br/>
<br/>
MK DS FC: Dragon 330772 075464 
<br/>
AC WW FC: Anthony SamsClub 1933-3433-9458 
<br/>
MPFH: Dragon 0215 4231 1206</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
