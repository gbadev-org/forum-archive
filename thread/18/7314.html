<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Multithreading on ARM9 - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>DS development > Multithreading on ARM9</h2>
<div id="posts">
<div class="post">
    <h4>#58951 - Mighty Max - Thu Oct 27, 2005 3:28 pm</h4>
    <div class="postbody"><span class="postbody">Hey there,
<br/>
<br/>
i have been working the last two days of letting my arm9 do two different functions at the same time. 
<br/>
<br/>
Currently i just have 2 Threads running max with a simple alternate sheduling (Each IRQ, Threads are switched). Before i move on, i wanted to ask some questions.
<br/>
<br/>
Is someone else already working for a thread sheduler for the nds libs ?
<br/>
If not, would it be possible to get this included when it runs smooth enough?
<br/>
<br/>
What would be better on the NDS / for your applications: FIFO/LIFO or SJF/SRPT ?
<br/>
<br/>
Any other suggestion?
<br/>
<br/>
<br/>
<br/>
<a class="postlink" href="http://mightymax.org/multithreading.html" target="_blank">Sourcecode</a><br/>_________________<br/><a class="postlink" href="http://mightymax.org/gbamp_multiboot.html" target="_blank">GBAMP Multiboot</a></span><span class="gensmall"><br/><br/>Last edited by Mighty Max on Thu Oct 27, 2005 11:37 pm; edited 2 times in total</span></div>    
</div>
<div class="post">
    <h4>#58971 - funkaster - Thu Oct 27, 2005 6:51 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Mighty Max wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
Is someone else already working for a thread sheduler for the nds libs ?
<br/>
If not, would it be possible to get this included when it runs smooth enough?
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I'm porting a scheduler that has many features:
<br/>
<br/>
- semaphores
<br/>
- messages
<br/>
- mutex
<br/>
- multicasting
<br/>
<br/>
etc... I hope to have it ready soon. Right now I don't have the time to finish it, but I think I'll try to finish it the next week.
<br/>
It's based on a mini scheduler we used in my Operating Systems course, it's almost ansi-c, except for the context swaping, which is totally machine dependant.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#58973 - GPFerror - Thu Oct 27, 2005 7:17 pm</h4>
    <div class="postbody"><span class="postbody">i attempted to port a threading example from gba to DS, not much luck though :(
<br/>
<br/>
here is the link to the post
<br/>
<a class="postlink" href="http://forum.gbadev.org/viewtopic.php?t=6448&amp;highlight=threading" target="_blank">http://forum.gbadev.org/viewtopic.php?t=6448&amp;highlight=threading</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#58978 - Mighty Max - Thu Oct 27, 2005 8:32 pm</h4>
    <div class="postbody"><span class="postbody">Ok, then i'll let it basic, and only for my own SysPro course, which just started last week :D
<br/>
<br/>
whoever is interested in it can find the sources on <a href="http://mightymax.org/multithreading.html" target="_blank">http://mightymax.org/multithreading.html</a>
<br/>
<br/>
It is now supporting 
<br/>
 - simple cyclic sheduling
<br/>
 - dynamic amount of threads
<br/>
 - stacking CriticalSections
<br/>
<br/>
The example shows the creation of 2 subthreads from the main thread.
<br/>
<br/>
Each thread counts a var up in its own stack, and displays it on the screen.
<br/>
<br/>
PS: I'm still deving on r13 so it will have to be updated on other DevKitARM releases<br/>_________________<br/><a class="postlink" href="http://mightymax.org/gbamp_multiboot.html" target="_blank">GBAMP Multiboot</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#58989 - GPFerror - Thu Oct 27, 2005 9:41 pm</h4>
    <div class="postbody"><span class="postbody">very cool, need to add this support to libnds or a simple function calls that can be used by us mere mortals :)
<br/>
<br/>
great job</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#58996 - sidral - Thu Oct 27, 2005 11:00 pm</h4>
    <div class="postbody"><span class="postbody">some time ago i've read of this <a class="postlink" href="http://www.sics.se/~adam/pt/" target="_blank">protothreads library</a> as something that could be useful for ds programming.
<br/>
<br/>
it's not real threads but it's light, with embedded systems in mind and fully implemented in ansi c.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#59002 - Dwedit - Thu Oct 27, 2005 11:23 pm</h4>
    <div class="postbody"><span class="postbody">Protothreads makes me vomit.<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#59013 - sidral - Fri Oct 28, 2005 12:27 am</h4>
    <div class="postbody"><span class="postbody">so you should look for a paper bag...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#71650 - knight0fdragon - Mon Feb 13, 2006 9:48 pm</h4>
    <div class="postbody"><span class="postbody">what do u do with LocalStorage?? what type is it and where should I place it in threading.c<br/>_________________<br/><a href="http://www.myspace.com/knight0fdragonds" target="_blank">http://www.myspace.com/knight0fdragonds</a>
<br/>
<br/>
MK DS FC: Dragon 330772 075464 
<br/>
AC WW FC: Anthony SamsClub 1933-3433-9458 
<br/>
MPFH: Dragon 0215 4231 1206</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#72469 - knight0fdragon - Sat Feb 18, 2006 8:07 pm</h4>
    <div class="postbody"><span class="postbody">hmmm for some reason, it cannot find the stuff that is in threading_s.s,  i tried adding it to the libnds library, but that doesnt seem to work either<br/>_________________<br/><a href="http://www.myspace.com/knight0fdragonds" target="_blank">http://www.myspace.com/knight0fdragonds</a>
<br/>
<br/>
MK DS FC: Dragon 330772 075464 
<br/>
AC WW FC: Anthony SamsClub 1933-3433-9458 
<br/>
MPFH: Dragon 0215 4231 1206</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#72478 - GPFerror - Sat Feb 18, 2006 9:20 pm</h4>
    <div class="postbody"><span class="postbody"><a href="http://gpf.dcemu.co.uk/MMmultithread.rar" target="_blank">http://gpf.dcemu.co.uk/MMmultithread.rar</a>  source and binaries.
<br/>
<br/>
I updated it for the latest NDS, have not tested it on hardware though.
<br/>
<br/>
Troy(GPF)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#72480 - sajiimori - Sat Feb 18, 2006 10:02 pm</h4>
    <div class="postbody"><span class="postbody">Dwedit,
<br/>
<br/>
What makes me nauseous is code that is uglier than it needs to be because the author was unwilling to use a technique that he considered distasteful.  Try making this function look as good without allocating a separate stack:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
// AI routine that moves a character around slightly until the collision
<br/>
// code can find a point on the floor underneath it.  Useful when a
<br/>
// character is standing in an awkward spot, like between two planks.
<br/>
// Returns true for success, false for failure, and indeterminate if
<br/>
// the operation hasn't completed yet.
<br/>
tribool WanderUntilFloorFound::operator()()
<br/>
{
<br/>
   begin();
<br/>
<br/>
   // 'me' is a pointer to the character that is being controlled.
<br/>
   if(!me)
<br/>
      terminate(false);  // Fail if there's nobody to control.
<br/>
<br/>
   // 4 tries before failure.
<br/>
   for(i = 0; i &lt; 4; ++i)
<br/>
   {
<br/>
      // Pick which direction to go and how long.
<br/>
      dir = randomAngle();
<br/>
      time = randomInRange(8, 30);
<br/>
<br/>
      while(time--)
<br/>
      {
<br/>
         if(canFindFloorBeneath(me))
<br/>
            terminate(true);  // Success.
<br/>
<br/>
         // Take a single step and wait a tick.
<br/>
         me-&gt;walk(dir);
<br/>
         yield();
<br/>
      }
<br/>
   }
<br/>
<br/>
   // If the routine hasn't finished by now, it automatically
<br/>
   // terminates with 'false'.
<br/>
   end();
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
The above code uses a kind of protothreads.  With dozens of AI characters in a level, indiscriminate allocation of stacks is not an option.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#72499 - knight0fdragon - Sun Feb 19, 2006 3:54 am</h4>
    <div class="postbody"><span class="postbody">has anyonebeen able to get this to work on hardware, it locks up for me when it hits createthread<br/>_________________<br/><a href="http://www.myspace.com/knight0fdragonds" target="_blank">http://www.myspace.com/knight0fdragonds</a>
<br/>
<br/>
MK DS FC: Dragon 330772 075464 
<br/>
AC WW FC: Anthony SamsClub 1933-3433-9458 
<br/>
MPFH: Dragon 0215 4231 1206</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#72520 - Durandle - Sun Feb 19, 2006 2:40 pm</h4>
    <div class="postbody"><span class="postbody">Hmm threading support = SDL threading = porting 100% easier  :P</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#72523 - TheChuckster - Sun Feb 19, 2006 3:00 pm</h4>
    <div class="postbody"><span class="postbody">There still needs to be a context switcher that is specific to the ARM processor.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#72537 - GPFerror - Sun Feb 19, 2006 5:51 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>TheChuckster wrote:</b></span></td> </tr> <tr> <td class="quote">There still needs to be a context switcher that is specific to the ARM processor.</td> </tr></table><span class="postbody">
<br/>
<br/>
I believe that the code in Mighty Max threading coding has a context switcher, Im not that familiar with arm asm so Im just guess thats what the code does in the threading_s.s file.
<br/>
<br/>
Troy(GPF)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#72551 - Mighty Max - Sun Feb 19, 2006 8:47 pm</h4>
    <div class="postbody"><span class="postbody">Heya,
<br/>
<br/>
the context saving &amp; restoring is indeed done in the threading_s.s to a buffer located within the code (so it can be referenced via cp without changing&amp;invalidating any register) 
<br/>
<br/>
The actual switching is then done in the c handler for the interrupt that is called immediately after the buffer is filled. Once this handler returned, the same buffer is used again to build the cpu context for returning from the interrupt state.
<br/>
<br/>
A new thread is created as a copy of the current context (again in the interrupt handler), so that the next interrupt will return twice  to the same address. Counting this event, one jumps to the new thread address and assigns a new stack and the other returns along the existing lr &amp; stack.
<br/>
<br/>
I'm not exactly familar anymore with the details how i implemented this, since it's been some time and my job &amp; studies soaked up my time the last months. (Still having devkit R13 on the disc ;) )<br/>_________________<br/><a class="postlink" href="http://mightymax.org/gbamp_multiboot.html" target="_blank">GBAMP Multiboot</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#72651 - GPFerror - Mon Feb 20, 2006 9:17 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Durandle wrote:</b></span></td> </tr> <tr> <td class="quote">Hmm threading support = SDL threading = porting 100% easier  :P</td> </tr></table><span class="postbody">
<br/>
<br/>
yeah also sound support is currently impossible without threads as well.
<br/>
<br/>
Troy(GPF)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#72663 - DekuTree64 - Mon Feb 20, 2006 10:08 pm</h4>
    <div class="postbody"><span class="postbody">Why does sound require threading? Shouldn't it just be a matter of setting up a timer on ARM7 to count samples played, and every x samples, generate an IPC interrupt to call the SDL sound handler on ARM9?
<br/>
<br/>
Or for less sporadic timing, just accumulate samples and mix however many are needed at the end of your VBlank handler.<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#72671 - GPFerror - Mon Feb 20, 2006 10:39 pm</h4>
    <div class="postbody"><span class="postbody">its more I would have to completly rewrite SDL, currently they way its written is sound is a seperate thread. that sits around and waits for a signal that the previous sound buffer has completed then it sends the next one. thats the cross platform part of the code lol</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#72672 - tepples - Mon Feb 20, 2006 10:49 pm</h4>
    <div class="postbody"><span class="postbody">If you could refactor SDL's sound thread to look like this, then you could probably port it:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
while(!quit) {
<br/>
  doSomething();
<br/>
  waitForPlayedSignal();
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
You'd port it by setting doSomething as the ISR.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#72686 - GPFerror - Tue Feb 21, 2006 12:43 am</h4>
    <div class="postbody"><span class="postbody">Yeah Im looking into a rewrite.
<br/>
<br/>
I still need a magic function that I could call that would tell me when my previous played buffer was completed. If I start the sound at a certain point shouldnt there be some kind of math calculation that would be approximetly tell me how many ms it would take to play the buffer? Then I could just check the number of ms(timer based) that have occured and compare it to this calculation?
<br/>
<br/>
Unfortunetly rewriting the audio thread doesnt help the SDL_threading/mutex/semaphore/condition api :)
<br/>
<br/>
Troy(GPF)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#72764 - GPFerror - Tue Feb 21, 2006 3:39 pm</h4>
    <div class="postbody"><span class="postbody">oops kind of went of topic with sound :)
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>knight0fdragon wrote:</b></span></td> </tr> <tr> <td class="quote">has anyonebeen able to get this to work on hardware, it locks up for me when it hits createthread</td> </tr></table><span class="postbody">
<br/>
<br/>
Yeah that is where it seems to lock up in all the emulators as well.
<br/>
<br/>
Troy(GPF)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#73333 - Mighty Max - Fri Feb 24, 2006 9:13 pm</h4>
    <div class="postbody"><span class="postbody">I don't know if i had updated the web version with the last worked on version,
<br/>
<br/>
i had a problem with mixing thumb and arm32 instructions on create thread that were fixed short before i had to leave.
<br/>
<br/>
I'll take a look and upload if it is that problem tomorrow.<br/>_________________<br/><a class="postlink" href="http://mightymax.org/gbamp_multiboot.html" target="_blank">GBAMP Multiboot</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#73387 - GPFerror - Sat Feb 25, 2006 6:08 am</h4>
    <div class="postbody"><span class="postbody">great looking forward to it, hopefully it can be updated for latest libnds and interupt based thread scheduler is just what im looking for :)
<br/>
<br/>
Troy(GPF)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#73405 - Mighty Max - Sat Feb 25, 2006 11:25 am</h4>
    <div class="postbody"><span class="postbody">Yeah, it is indeed that problem:
<br/>
<br/>
When CreateThread(...) is compiled as thumb it will crash the multithreader.
<br/>
<br/>
I can't find my backup discs with the multithreading sources atm, but the build in threader of the multiboot has had the same changes, so ill just copy &amp; paste them here, so you can make the changes:
<br/>
<br/>
In the CreateThread replace
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
   while (1) {
<br/>
      if (!subCalled &amp;&amp; (activeThread == subThread)) {
<br/>
         // the subthread is now running, as a copy of the creator
<br/>
         // so set what makes this thread individual
<br/>
         // Stack &amp; InstructionPointer
<br/>
         subCalled = activeThread ;
<br/>
         asm("mov r13,%0\n"\
<br/>
            "mov r14,%1\n"\
<br/>
            "BX r14 \n"
<br/>
            ::"r" (stack),"r" (target)) ;
<br/>
      } ;
<br/>
</td> </tr></table><span class="postbody">
<br/>
with
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
   while (1) {
<br/>
      if (!subCalled &amp;&amp; (activeThread == subThread)) {
<br/>
         // the subthread is now running, as a copy of the creator
<br/>
         // so set what makes this thread individual
<br/>
         // Stack &amp; InstructionPointer
<br/>
         subCalled = activeThread ;
<br/>
         CreateThreadHelper(stack,target) ;
<br/>
      } ;
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
The helper function has been defined in the threading_s.s:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
.global CreateThreadHelper
<br/>
<br/>
CreateThreadHelper:
<br/>
            MOV r13,r0
<br/>
            MOV r14,r1
<br/>
            BX r14
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
This way the stack &amp; return address swap is done in arm32 and therefor doesnt fail if CreateThread is called in/from thumb regions.
<br/>
<br/>
Greets
<br/>
Mighty Max
<br/>
<br/>
PS: I should work on the CriticalSection functions to secure them against race effects. Atm they don't use atomic instructions and are therefor not safe against this kind of errors. So if you keep getting random hangups of single threads, please let me know to set some priority to this.<br/>_________________<br/><a class="postlink" href="http://mightymax.org/gbamp_multiboot.html" target="_blank">GBAMP Multiboot</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#73410 - knight0fdragon - Sat Feb 25, 2006 1:33 pm</h4>
    <div class="postbody"><span class="postbody">looks good, be sure to add void CreateThreadHelper(int stack,int target) ; to threading_s.h
<br/>
<br/>
<br/>
when theres 1 thread, no hang ups, mutliple = hangups.<br/>_________________<br/><a href="http://www.myspace.com/knight0fdragonds" target="_blank">http://www.myspace.com/knight0fdragonds</a>
<br/>
<br/>
MK DS FC: Dragon 330772 075464 
<br/>
AC WW FC: Anthony SamsClub 1933-3433-9458 
<br/>
MPFH: Dragon 0215 4231 1206</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#73411 - Mighty Max - Sat Feb 25, 2006 2:12 pm</h4>
    <div class="postbody"><span class="postbody">Hellas again,
<br/>
<br/>
i composed a quick fix for the critical section flaw. It uses an active waiting (not queueing) mutex to safe the access to the critical section counter. This mutex is now atomic and can't be interupted by an IRQ (and therefor by the thread switch)
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
/*
<br/>
   Mutex
<br/>
   Mutex here are active wait and only accept access or no access pending status
<br/>
*/
<br/>
<br/>
void AcquireMutex(unsigned long *mutex) 
<br/>
{
<br/>
   unsigned long preStatus = 1 ; 
<br/>
   while ((preStatus = AtomicSwap(1,mutex))==1) {
<br/>
      // wait till our swap removed a non 1 (InAccess) and stores a 1 there
<br/>
   } ;
<br/>
} ;
<br/>
<br/>
void ReleaseMutex(unsigned long *mutex)
<br/>
{
<br/>
   AtomicSwap(0,mutex) ;
<br/>
} ;
<br/>
<br/>
/*
<br/>
   Within a critical section no thread switch will occure
<br/>
   Critical sections can be encapsuled by another
<br/>
*/
<br/>
<br/>
unsigned long criticalSectionMasterMutex = 0 ;
<br/>
<br/>
void EnterCriticalSection(void)
<br/>
{
<br/>
   AcquireMutex(&amp;criticalSectionMasterMutex) ;
<br/>
   criticalsCount++ ;
<br/>
   ReleaseMutex(&amp;criticalSectionMasterMutex) ;
<br/>
} 
<br/>
<br/>
void LeaveCriticalSection(void) 
<br/>
{
<br/>
   if (criticalsCount) {
<br/>
      AcquireMutex(&amp;criticalSectionMasterMutex) ;
<br/>
      criticalsCount-- ;
<br/>
      ReleaseMutex(&amp;criticalSectionMasterMutex) ;
<br/>
   }
<br/>
} ;
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
where in threading_s.s
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
.global AtomicSwap
<br/>
<br/>
AtomicSwap:
<br/>
            SWP r0,r0,[r1]
<br/>
            BX r14                     
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
unsigned long AtomicSwap(unsigned long newValue,unsigned long *memoryLocation) ;
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
This code however is not tested, i don't have my equipment here atm.
<br/>
<br/>
---
<br/>
<br/>
@KnightOfDragons:
<br/>
Where and what exactly hangs up?<br/>_________________<br/><a class="postlink" href="http://mightymax.org/gbamp_multiboot.html" target="_blank">GBAMP Multiboot</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#73421 - knight0fdragon - Sat Feb 25, 2006 5:25 pm</h4>
    <div class="postbody"><span class="postbody">when there are more then 1 thread, it will hit the first semaphore, then print thread A, then lock<br/>_________________<br/><a href="http://www.myspace.com/knight0fdragonds" target="_blank">http://www.myspace.com/knight0fdragonds</a>
<br/>
<br/>
MK DS FC: Dragon 330772 075464 
<br/>
AC WW FC: Anthony SamsClub 1933-3433-9458 
<br/>
MPFH: Dragon 0215 4231 1206</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#73491 - GPFerror - Sun Feb 26, 2006 2:05 am</h4>
    <div class="postbody"><span class="postbody">yeah its crashing on me also, I just havent had enough time to debug where yet.
<br/>
<br/>
thanks for the updates.
<br/>
Troy(GPF)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#74317 - knight0fdragon - Sat Mar 04, 2006 8:47 am</h4>
    <div class="postbody"><span class="postbody">is there some sort of alternative to this code here
<br/>
<br/>
  REG_IME = 0;
<br/>
  IRQ_HANDLER = &amp;IRQ_Entry;
<br/>
  REG_IE = IRQ_VBLANK;
<br/>
  REG_IF = ~0;
<br/>
  DISP_SR = DISP_VBLANK_IRQ;
<br/>
  REG_IME = 1;
<br/>
<br/>
this seems to screw up with the wifi stuff when it wants to wait on the ARM7
<br/>
<br/>
<br/>
i thought it was something like irqSet(IRQ_VBLANK, IRQ_Entry);, but it turns out its not and i tried playing around with other methods but for some reason either the wifi will lock at ARM7 not being init  or no threading whatsoever<br/>_________________<br/><a href="http://www.myspace.com/knight0fdragonds" target="_blank">http://www.myspace.com/knight0fdragonds</a>
<br/>
<br/>
MK DS FC: Dragon 330772 075464 
<br/>
AC WW FC: Anthony SamsClub 1933-3433-9458 
<br/>
MPFH: Dragon 0215 4231 1206</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#74319 - Mighty Max - Sat Mar 04, 2006 9:25 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code"> REG_IME = 0;
<br/>
IRQ_HANDLER = &amp;IRQ_Entry;
<br/>
REG_IE = IRQ_VBLANK;
<br/>
REG_IF = ~0;
<br/>
DISP_SR = DISP_VBLANK_IRQ;
<br/>
REG_IME = 1; 
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
For the multithreader the IRQ_Entry has to be the first called irq handler. so the default interupt handler can't be used to run the sheduling irq handler. 
<br/>
<br/>
You can however install the IRQ_Entry like in the code above (you might want to enable more IRQ Events REG_IE = IRQ_VBLANK | theotherirqs ; ) and set the default handler as the custom irq handler via a call to 
<br/>
void SetIRQHandler(void *handler) ;
<br/>
of the CIRQ.h<br/>_________________<br/><a class="postlink" href="http://mightymax.org/gbamp_multiboot.html" target="_blank">GBAMP Multiboot</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#74333 - knight0fdragon - Sat Mar 04, 2006 4:30 pm</h4>
    <div class="postbody"><span class="postbody">ok im not really following,
<br/>
heres what i want to do
<br/>
i have vblank as my interrupt handler,
<br/>
i use no other interrupt on arm9,
<br/>
and i have IRQ_Entry(); as the first function called in it
<br/>
<br/>
now it all works well and good when i use the code
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">REG_IME = 0; 
<br/>
IRQ_HANDLER = &amp;vblank; 
<br/>
REG_IE = IRQ_VBLANK; 
<br/>
REG_IF = ~0; 
<br/>
DISP_SR = DISP_VBLANK_IRQ; 
<br/>
REG_IME = 1; </td> </tr></table><span class="postbody">
<br/>
<br/>
and the threads work fine but the wifi locks up,
<br/>
<br/>
now if i use
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">   Initialise the interrupt system
<br/>
  irqInit();
<br/>
   install our simple vblank handler
<br/>
  irqSet(IRQ_VBLANK, &amp;vBlank);
<br/>
   enable the interrupt
<br/>
  irqEnable(IRQ_VBLANK);</td> </tr></table><span class="postbody">
<br/>
<br/>
the wifi works and the threads lock up.  What exactly is the difference between these 2 that would cause this effect<br/>_________________<br/><a href="http://www.myspace.com/knight0fdragonds" target="_blank">http://www.myspace.com/knight0fdragonds</a>
<br/>
<br/>
MK DS FC: Dragon 330772 075464 
<br/>
AC WW FC: Anthony SamsClub 1933-3433-9458 
<br/>
MPFH: Dragon 0215 4231 1206</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#74343 - Mighty Max - Sat Mar 04, 2006 5:34 pm</h4>
    <div class="postbody"><span class="postbody">The IRQ_Entry of threading_s MUST be called from within the rom (bios) region like it does when it is the primary installed irq handler. If you use irqSet then there is a another function call inbetween there, and that leads to the threader failing to backup&amp;restore the correct context and sheduling at other IRQs
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
IRQ Requested -&gt; BIOS Handler -&gt; Default Handler  -&gt; specific event handler (i.e. Threading Handler @ vblank, wifi, ...)
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
What you can do to get this working:
<br/>
1. init everything for the wifi lib to work
<br/>
2. disable IRQs
<br/>
3. save the current IRQ handler to some temp var
<br/>
4. set the IRQ_Entry as the new IRQ handler
<br/>
5. set the saved handler via SetIRQHandler() to set it into the chain again
<br/>
6. enable IRQs
<br/>
<br/>
The IRQ handling should then work this way:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
IRQ Requested -&gt; BIOS Handler -&gt; Threading Handler -&gt; Default Handler  -&gt; specific event handler (i.e. vblank, wifi, ...)
<br/>
</td> </tr></table><span class="postbody"><br/>_________________<br/><a class="postlink" href="http://mightymax.org/gbamp_multiboot.html" target="_blank">GBAMP Multiboot</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#74349 - GPFerror - Sat Mar 04, 2006 6:24 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>knight0fdragon wrote:</b></span></td> </tr> <tr> <td class="quote">ok im not really following,
<br/>
heres what i want to do
<br/>
i have vblank as my interrupt handler,
<br/>
i use no other interrupt on arm9,
<br/>
and i have IRQ_Entry(); as the first function called in it
<br/>
<br/>
now it all works well and good when i use the code
<br/>
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">REG_IME = 0; 
<br/>
IRQ_HANDLER = &amp;vblank; 
<br/>
REG_IE = IRQ_VBLANK; 
<br/>
REG_IF = ~0; 
<br/>
DISP_SR = DISP_VBLANK_IRQ; 
<br/>
REG_IME = 1; </td> </tr></table><span class="postbody">
<br/>
<br/>
and the threads work fine but the wifi locks up,
<br/>
<br/>
now if i use
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">   Initialise the interrupt system
<br/>
  irqInit();
<br/>
   install our simple vblank handler
<br/>
  irqSet(IRQ_VBLANK, &amp;vBlank);
<br/>
   enable the interrupt
<br/>
  irqEnable(IRQ_VBLANK);</td> </tr></table><span class="postbody">
<br/>
<br/>
the wifi works and the threads lock up.  What exactly is the difference between these 2 that would cause this effect</span></td> </tr></table><span class="postbody">
<br/>
<br/>
can you post your fixed source for this? Iv broken something and cant get anything to work.
<br/>
<br/>
thank,
<br/>
Troy(GPF)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#74379 - knight0fdragon - Sat Mar 04, 2006 10:00 pm</h4>
    <div class="postbody"><span class="postbody">What you can do to get this working: 
<br/>
<span style="color: red">1. init everything for the wifi lib to work </span>
<br/>
<span style="color: blue">2. disable IRQs </span>
<br/>
<span style="color: red">3. save the current IRQ handler to some temp var </span>
<br/>
<span style="color: red">4. set the IRQ_Entry as the new IRQ handler </span>
<br/>
<span style="color: red">5. set the saved handler via SetIRQHandler() to set it into the chain again </span>
<br/>
<span style="color: blue">6. enable IRQs </span>
<br/>
<br/>
<br/>
ok everything in the red i have done, now the things in the blue im not actually sure on the correct commands to do that and i cant find anything in the forums regarding it
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">REG_IME=0;</td> </tr></table><span class="postbody">
<br/>
<br/>
is that how i disable them?
<br/>
<br/>
so the code would be 
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
  // Initialise the interrupt system
<br/>
  irqInit();
<br/>
  // install our simple vblank handler
<br/>
  irqSet(IRQ_VBLANK, &amp;vBlank);
<br/>
  REG_IME = 0;
<br/>
  tempHandle = &amp;IRQ_HANDLER;
<br/>
<br/>
  IRQ_HANDLER = &amp;IRQ_Entry;
<br/>
  REG_IE = IRQ_VBLANK;
<br/>
  REG_IF = ~0;
<br/>
  DISP_SR = DISP_VBLANK_IRQ;
<br/>
  REG_IME = 1;
<br/>
  
<br/>
  
<br/>
  // enable the interrupt
<br/>
  irqEnable(IRQ_VBLANK);
<br/>
  
<br/>
  
<br/>
  // Set the user define interupt handler
<br/>
  
<br/>
  SetIRQHandler((void *)&amp;tempHandle);
<br/>
</td> </tr></table><span class="postbody"><br/>_________________<br/><a href="http://www.myspace.com/knight0fdragonds" target="_blank">http://www.myspace.com/knight0fdragonds</a>
<br/>
<br/>
MK DS FC: Dragon 330772 075464 
<br/>
AC WW FC: Anthony SamsClub 1933-3433-9458 
<br/>
MPFH: Dragon 0215 4231 1206</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#74389 - Mighty Max - Sat Mar 04, 2006 11:54 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>knight0fdragon wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">REG_IME=0;</td> </tr></table><span class="postbody">
<br/>
is that how i disable them?
<br/>
</span></td> </tr></table><span class="postbody">
<br/>
<br/>
Yes
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
so the code would be 
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
  // Initialise the interrupt system
<br/>
  irqInit();
<br/>
  // install our simple vblank handler
<br/>
  irqSet(IRQ_VBLANK, &amp;vBlank);
<br/>
  REG_IME = 0;
<br/>
  void *tempHandle = (void *)IRQ_HANDLER;
<br/>
<br/>
  IRQ_HANDLER = &amp;IRQ_Entry;
<br/>
  REG_IE = IRQ_VBLANK;
<br/>
  REG_IF = ~0;
<br/>
  DISP_SR = DISP_VBLANK_IRQ;
<br/>
  
<br/>
  
<br/>
  // enable the interrupt
<br/>
  irqEnable(IRQ_VBLANK);
<br/>
  
<br/>
  REG_IME = 1;
<br/>
  
<br/>
  // Set the user define interupt handler
<br/>
  
<br/>
  SetIRQHandler(tempHandle);
<br/>
</td> </tr></table><span class="postbody"></span></td> </tr></table><span class="postbody">
<br/>
<br/>
I corrected the above code a bit. IRQ_HANDLER is a fix reference to the handler's addr. So &amp;IRQ_HANDLER would be constant. You want to save &amp; reuse its value instead.  - Placed the enable after the complete handler swap.
<br/>
<br/>
This should work.
<br/>
<br/>
Remember to remove the call to the Threading IRQ Handler from yout vblank code.
<br/>
<br/>
<br/>
PS: I know that this is horrible coding unfriendly atm, i'll check that when i got my hardware back and i'm able to test anything again.<br/>_________________<br/><a class="postlink" href="http://mightymax.org/gbamp_multiboot.html" target="_blank">GBAMP Multiboot</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#74397 - knight0fdragon - Sun Mar 05, 2006 1:08 am</h4>
    <div class="postbody"><span class="postbody">hmm it will thead for a few seconds then lock on me<br/>_________________<br/><a href="http://www.myspace.com/knight0fdragonds" target="_blank">http://www.myspace.com/knight0fdragonds</a>
<br/>
<br/>
MK DS FC: Dragon 330772 075464 
<br/>
AC WW FC: Anthony SamsClub 1933-3433-9458 
<br/>
MPFH: Dragon 0215 4231 1206</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#74401 - knight0fdragon - Sun Mar 05, 2006 1:33 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#include &lt;nds.h&gt;
<br/>
<br/>
#include &lt;nds/arm9/console.h&gt; //basic print funcionality
<br/>
#include &lt;malloc.h&gt;
<br/>
#include &lt;stdio.h&gt;
<br/>
#include &lt;string.h&gt;
<br/>
<br/>
extern "C" {
<br/>
   #include &lt;nds/C_IRQ.h&gt;
<br/>
   #include &lt;nds/threading.h&gt;
<br/>
   #include &lt;nds/threading_s.h&gt;
<br/>
}
<br/>
<br/>
void wait()
<br/>
{
<br/>
   while(DISP_Y!=192);
<br/>
   while(DISP_Y==192);
<br/>
}
<br/>
<br/>
<br/>
//---------------------------------------------------------------------------------
<br/>
void InterruptHandler(void) {//---------------------------------------------------------------------------------
<br/>
<br/>
   // Acknowledge interrupts
<br/>
   REG_IF = REG_IF;
<br/>
} 
<br/>
<br/>
LPSEMAPHORE consoleAccess = 0 ;
<br/>
LPTHREAD t1 ;
<br/>
void Thread1(void) {
<br/>
   int i = 0 ;
<br/>
   while (1) {
<br/>
      i++ ;
<br/>
      printf("Thread A: %i\n",i) ;
<br/>
   }
<br/>
} ;
<br/>
<br/>
<br/>
//---------------------------------------------------------------------------------
<br/>
int main(void) {
<br/>
//---------------------------------------------------------------------------------
<br/>
<br/>
   WAIT_CR=0xe800;
<br/>
   wait();
<br/>
  POWER_CR = POWER_ALL_2D ;
<br/>
<br/>
<br/>
   // Graphical Screen for logo &amp; addinfos
<br/>
   videoSetMode(MODE_5_2D | DISPLAY_BG3_ACTIVE); 
<br/>
  vramSetMainBanks(VRAM_A_MAIN_BG_0x6000000, VRAM_B_MAIN_BG_0x6020000, 
<br/>
                   VRAM_C_SUB_BG , VRAM_D_LCD); 
<br/>
<br/>
   SUB_BG0_CR = BG_MAP_BASE(31);
<br/>
   
<br/>
   BG_PALETTE_SUB[255] = RGB15(31,31,31);   //by default font will be rendered with color 255
<br/>
   
<br/>
   //consoleInit() is a lot more flexible but this gets you up and running quick
<br/>
   consoleInitDefault((u16*)SCREEN_BASE_BLOCK_SUB(31), (u16*)CHAR_BASE_BLOCK_SUB(0), 16);
<br/>
   printf("Testapplication Threading\n") ;
<br/>
   printf("- Mighty Max -\n\n") ;
<br/>
   // Set up the multithreader interrupt handler
<br/>
  // Initialise the interrupt system 
<br/>
  irqInit(); 
<br/>
  // install our simple vblank handler 
<br/>
  irqSet(IRQ_VBLANK, &amp;InterruptHandler); 
<br/>
  REG_IME = 0; 
<br/>
  void *tempHandle = (void *)IRQ_HANDLER; 
<br/>
<br/>
  IRQ_HANDLER = &amp;IRQ_Entry; 
<br/>
  REG_IE = IRQ_VBLANK; 
<br/>
  REG_IF = ~0; 
<br/>
  DISP_SR = DISP_VBLANK_IRQ; 
<br/>
  // enable the interrupt 
<br/>
  irqEnable(IRQ_VBLANK); 
<br/>
  REG_IME = 1; 
<br/>
  
<br/>
  // Set the user define interupt handler 
<br/>
  
<br/>
   wait() ;
<br/>
  SetIRQHandler((void *)&amp;tempHandle); 
<br/>
   // Set the user define interupt handler
<br/>
   SetIRQHandler((void *)&amp;InterruptHandler) ;
<br/>
<br/>
   // Create a semaphore for console accesses, so that a position/write can be
<br/>
   // executed without any other thread to jam that
<br/>
   consoleAccess = CreateSemaphore() ;
<br/>
<br/>
   // Create 2 subthreads:
<br/>
   t1 = CreateThread((long)&amp;Thread1,(long)malloc(1024)+1024) ;
<br/>
   
<br/>
   // this is still our main, we can work in too
<br/>
   int i = 0 ;
<br/>
   while (1) {
<br/>
      i++ ;
<br/>
      printf("Main: %i\n",i) ;
<br/>
   }
<br/>
   return 0;
<br/>
}
<br/>
<br/>
<br/>
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
this is the code that i am trying to get working right now, before i insert it into my project that is
<br/>
<br/>
For some reason its still not working unless i disable irqinit,irset, and irqenable
<br/>
<br/>
(also i placed the code into libnds so use the source provided above to actually get it to work)<br/>_________________<br/><a href="http://www.myspace.com/knight0fdragonds" target="_blank">http://www.myspace.com/knight0fdragonds</a>
<br/>
<br/>
MK DS FC: Dragon 330772 075464 
<br/>
AC WW FC: Anthony SamsClub 1933-3433-9458 
<br/>
MPFH: Dragon 0215 4231 1206</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#74492 - Mighty Max - Sun Mar 05, 2006 12:13 pm</h4>
    <div class="postbody"><span class="postbody">If this threads longer then 60ms, then there has to be some other troublemaking effect.
<br/>
<br/>
You should remove the line irqEnable(IRQ_VBLANK) as this is already done in the code REG_IE = IRQ_VBLANK;
<br/>
<br/>
As well as 
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code"> 
<br/>
   SetIRQHandler((void *)&amp;tempHandle);
<br/>
   // Set the user define interupt handler
<br/>
   SetIRQHandler((void *)&amp;InterruptHandler) ;
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
is double done. Remove the second.
<br/>
<br/>
<br/>
<br/>
But as said, i can't test where or why it hangs really. I don't know what changed on the init before the main() call and i don't know if other firmware versions handle the irq entry different (i.e. stacksize at irq entry) now.
<br/>
<br/>
I highly suggest to use a select() and other non blocking means to create a pseudo threading effect till i can check again what went wrong.
<br/>
<br/>
<br/>
What you however could do is to add some lines in the C part of the irq threading handler to check whether IRQ_HANDLER was changed from another pos or the return address within the irq stack storage moved outside your apps code.<br/>_________________<br/><a class="postlink" href="http://mightymax.org/gbamp_multiboot.html" target="_blank">GBAMP Multiboot</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#75343 - GPFerror - Sun Mar 12, 2006 9:15 am</h4>
    <div class="postbody"><span class="postbody">Has anyone got this working? If so can you post the complete code please.
<br/>
<br/>
Thanks,
<br/>
Troy(GPF)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#75387 - Mighty Max - Sun Mar 12, 2006 5:16 pm</h4>
    <div class="postbody"><span class="postbody">I think i found the major bastards, but im testing this right now.
<br/>
At least the interrupt handler does not randomly crash dualis anymore. 
<br/>
<br/>
<br/>
If i'm correct, it was a stack issue in combination in now more stack consuming iprint's
<br/>
<br/>
<br/>
Ill update this post later with the results<br/>_________________<br/><a class="postlink" href="http://mightymax.org/gbamp_multiboot.html" target="_blank">GBAMP Multiboot</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#75388 - wintermute - Sun Mar 12, 2006 5:27 pm</h4>
    <div class="postbody"><span class="postbody">You're not going to get this working with this approach at all.
<br/>
<br/>
Consider this.
<br/>
<br/>
In order to switch between threads you need to perform a context switch. This requires that all the registers are saved for the current thread, including the flags and PC. You then need to load all the registers for the thread you wish to switch to.
<br/>
<br/>
The interrupt dispatcher is not the first piece of code to be run when an interrupt occurs. In both GBA and DS the processor will first execute the BIOS handler which then jumps through the vector location to the dispatcher. Several registers have already been changed at this point.
<br/>
<br/>
In order to perform a context switch you need to know the precise state of the stack at that point - a disassembly of the BIOS code will help immensely here.
<br/>
<br/>
I haven't looked at the BIOS code as yet but I suspect that the stack frame will need to be saved and then changed in order to return to a new thread.
<br/>
<br/>
In order to do all this properly further newlib patches will need to be applied and the libraries rebuilt to understand threading. As I'm sure you'll appreciate this will then annoy people using devkitARM for other platforms where threading has not yet been implemented.
<br/>
<br/>
This is a huge job and not one I'm about to undertake lightly. It will involve large changes to the toolchain and all the libraries currently being used.
<br/>
<br/>
I need to do some further investigation on how this task will affect devkitARM users - at this point  roughly 4000 of them spread among gp32, gba, ds, gp2x and various ARM experimentor boards.<br/>_________________<br/><a class="postlink" href="http://www.devkitpro.org/" target="_blank">devkitPro - professional toolchains at amateur prices</a>
<br/>
<a class="postlink" href="http://wiki.devkitpro.org/index.php/IRC" target="_blank">devkitPro IRC support</a>
<br/>
<a class="postlink" href="http://davejmurphy.com/" target="_blank">Personal Blog</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#75407 - Mighty Max - Sun Mar 12, 2006 7:22 pm</h4>
    <div class="postbody"><span class="postbody">That code already worked, and it still does with the Multiboot which was compiled under R13.
<br/>
<br/>
I don't know what exactly changed that caused it to break. But i'm eager to get it back working.
<br/>
<br/>
The stack that comes with the IRQ handling is indeed saved and restored with the context switching, so that was never a problem.
<br/>
<br/>
Creating a new thread is split into two parts that makes it independend on what the primary IRQ-Handler actually does. In the handler, it is just creating a copy of the current context (including the stackframe).
<br/>
<br/>
Having the same return twice now, one attaches the new thread's stack &amp; jumps, the second returns to the caller.<br/>_________________<br/><a class="postlink" href="http://mightymax.org/gbamp_multiboot.html" target="_blank">GBAMP Multiboot</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#75430 - Mighty Max - Sun Mar 12, 2006 9:22 pm</h4>
    <div class="postbody"><span class="postbody">Got it running now proper again on DeSmuME,
<br/>
<br/>
I hope it will work on hardware as i can't test it right now as allready mentioned.
<br/>
<br/>
There are several points in the code i'm not happy with and will definately need an update, but for now it is working again.
<br/>
<br/>
I will cleanup &amp; fix more things within the week. Expect it on the next weekend.
<br/>
<br/>
<a href="http://mightymax.org/MultiThreading.rar" target="_blank">http://mightymax.org/MultiThreading.rar</a>
<br/>
<br/>
Compiled under the latest devkit &amp; running under DeSmuME 0.33
<br/>
<br/>
<a href="http://mightymax.org/MultiThreading.PNG">[Images not permitted - Click here to view it]</a><br/>_________________<br/><a class="postlink" href="http://mightymax.org/gbamp_multiboot.html" target="_blank">GBAMP Multiboot</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#75470 - GPFerror - Mon Mar 13, 2006 5:29 am</h4>
    <div class="postbody"><span class="postbody">yeah i had someone verified it ran on his hardware , I have sent mic a message about getting support added to dualis as well. 
<br/>
<br/>
Troy(GPF)
<br/>
<a href="http://gpf.dcemu.co.uk" target="_blank">http://gpf.dcemu.co.uk</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#75609 - GPFerror - Tue Mar 14, 2006 5:11 pm</h4>
    <div class="postbody"><span class="postbody">ok, Mic has fixed dualis and it should work in the next version :)
<br/>
<br/>
Troy(GPF)
<br/>
<a href="http://gpf.dcemu.co.uk" target="_blank">http://gpf.dcemu.co.uk</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#75616 - Chris Holmes - Tue Mar 14, 2006 6:59 pm</h4>
    <div class="postbody"><span class="postbody">Maybe I don't understand the reasoning behind it, but why is there such effort to build threading onto either a 33 mhz or 66 mhz arm core?  True threading can't be implemented without either disabling all interrupts or with a test-and-set function (I don't know if these ARM cores even support that operator).
<br/>
<br/>
When you're dealing with such limited resources to begin with, the overhead of context switching is going to kill any of your gains.
<br/>
<br/>
  Chris</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#75620 - tepples - Tue Mar 14, 2006 7:49 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Chris Holmes wrote:</b></span></td> </tr> <tr> <td class="quote">Maybe I don't understand the reasoning behind it, but why is there such effort to build threading onto either a 33 mhz or 66 mhz arm core?</td> </tr></table><span class="postbody">
<br/>
So that SDL, PC games that use SDL, and other PC games that rely on threads can be more easily ported without having to heavily modify them to make use of cooperative threading (i.e. timer listeners that return quickly).<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#75623 - Chris Holmes - Tue Mar 14, 2006 7:54 pm</h4>
    <div class="postbody"><span class="postbody">The SDL issue was only a problem with sounds as far as I could tell.  Someone suggested polling something with the timer interrupt and faking threads that way.  That sounds like a valid solution to that problem.
<br/>
<br/>
As far as PC games, well, any PC game that will run on a 66 mhz ARM core almost certainly won't have threads in it.
<br/>
<br/>
But hey, if people want threads, good luck with that.
<br/>
<br/>
  Chris</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#75850 - Mighty Max - Thu Mar 16, 2006 4:10 pm</h4>
    <div class="postbody"><span class="postbody">To the test-and-set:
<br/>
<br/>
The arm supports an interlocked swp instruction (atomic), that no other entity on the system bus can break. This swp can easily be utilized for an test-and-set and this way for a race secure mutex.
<br/>
<br/>
Every other synch structure (Critical regions, semaphores etc) can be implemented with flagging these structures via this mutex.
<br/>
<br/>
<br/>
<br/>
On some parts tho, i didn't go carefull and that are the places i don't want this way and which will change (i.e. CreateThread uses a non race secure flagging in the public version, Deadlock's are unhandled, ...)
<br/>
<br/>
<br/>
<br/>
On the other hand, if threading is needed or not for someone's project, i don't know. It is simply another way of doing things. But whereever i see more then one CPU, there is a reason for it imho. I don't care on what CPU my math routine runs, as long as the result comes in time. Load balancing is just another step after threading both CPU's
<br/>
<br/>
I started this project parallel to hearing my system programming course, but had to abandon this for some time due to heavy load *g*
<br/>
<br/>
Whoever wants to use threading, has the choice, whoever doesn't want to, doesn't need to.
<br/>
<br/>
<br/>
<br/>
<br/>
PS: Thanks mic!<br/>_________________<br/><a class="postlink" href="http://mightymax.org/gbamp_multiboot.html" target="_blank">GBAMP Multiboot</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#76029 - Mighty Max - Fri Mar 17, 2006 9:09 pm</h4>
    <div class="postbody"><span class="postbody">Heya,
<br/>
<br/>
I've done some investigation to things that might help seperating bugs. Unfortunally, this has to be tested on hardware which i atm have no access to.
<br/>
<br/>
Would be great if anyone could report me if it shows "Breakpoint!" or if it just crashes.
<br/>
<br/>
<a href="http://mightymax.org/Breakpoint_Test.nds" target="_blank">http://mightymax.org/Breakpoint_Test.nds</a>
<br/>
<br/>
<br/>
It should install an exception handler for undefined instructions &amp; causes a undefined instruction exception. Hope this works *g*
<br/>
<br/>
Thanks in advance
<br/>
Mighty Max<br/>_________________<br/><a class="postlink" href="http://mightymax.org/gbamp_multiboot.html" target="_blank">GBAMP Multiboot</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#76113 - LiraNuna - Sat Mar 18, 2006 9:49 am</h4>
    <div class="postbody"><span class="postbody">White screens.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#76117 - Lino - Sat Mar 18, 2006 10:31 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Mighty Max wrote:</b></span></td> </tr> <tr> <td class="quote">Heya,
<br/>
<br/>
I've done some investigation to things that might help seperating bugs. Unfortunally, this has to be tested on hardware which i atm have no access to.
<br/>
<br/>
Would be great if anyone could report me if it shows "Breakpoint!" or if it just crashes.
<br/>
<br/>
<a href="http://mightymax.org/Breakpoint_Test.nds" target="_blank">http://mightymax.org/Breakpoint_Test.nds</a>
<br/>
<br/>
<br/>
It should install an exception handler for undefined instructions &amp; causes a undefined instruction exception. Hope this works *g*
<br/>
<br/>
Thanks in advance
<br/>
Mighty Max</td> </tr></table><span class="postbody">
<br/>
<br/>
Where is the source code? Please.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#76118 - Mighty Max - Sat Mar 18, 2006 10:37 am</h4>
    <div class="postbody"><span class="postbody">I'm not too sure on the address (0x27FFDA4), because i did it pen&amp;paper wise. 
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
void SetBreakpointHandler(unsigned long addr) {
<br/>
   *(unsigned long*)(0x27FFDA4) = addr ;
<br/>
} ;
<br/>
<br/>
void Breakpoint(void) {
<br/>
   iprintf("Breakpoint!") ;
<br/>
   while (1) ;
<br/>
} ;
<br/>
<br/>
void CauseBreakpoint(void) {
<br/>
   typedef void (*bpt)(void) ;
<br/>
   unsigned long undef[2] = { 0xE6000010,0xE25EF004 } ;
<br/>
   // == undefined instruction, SUBS r15,r14,#4 (return)
<br/>
   bpt f = (bpt)&amp;undef[0] ;
<br/>
   f() ;
<br/>
   iprintf("End of breakpoint causing function reached: HALT") ;
<br/>
   while (1) ;
<br/>
} ;
<br/>
<br/>
<br/>
<br/>
within main:
<br/>
   // Test the new breakpoint feature:
<br/>
   SetBreakpointHandler((unsigned long)&amp;Breakpoint) ;
<br/>
   CauseBreakpoint() ;
<br/>
</td> </tr></table><span class="postbody"><br/>_________________<br/><a class="postlink" href="http://mightymax.org/gbamp_multiboot.html" target="_blank">GBAMP Multiboot</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#76166 - Mighty Max - Sat Mar 18, 2006 9:27 pm</h4>
    <div class="postbody"><span class="postbody">I think i misscalculated the address on my first go through.
<br/>
<br/>
I have uploaded two new test files <a href="http://mightymax.org/Test_b.nds" target="_blank">http://mightymax.org/Test_b.nds</a> and <a href="http://mightymax.org/Test_c.nds" target="_blank">http://mightymax.org/Test_c.nds</a>
<br/>
<br/>
The first one runs on Dualis, and just redoes the steps i expect manually. This is(was) for testing if i got it right with the address and the idea what the code does.
<br/>
<br/>
The second one is setting the exception vector &amp; causing an undefined instruction. tho now a bit more safe. if it fails, it returns *g*
<br/>
<br/>
Thanks for everyone who checks it.
<br/>
<br/>
<br/>
On Success the sceen should have one line on it:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
################
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
On Failure the screen will show
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#End of breakpoint causing func
<br/>
tion reached: HALT
<br/>
</td> </tr></table><span class="postbody"><br/>_________________<br/><a class="postlink" href="http://mightymax.org/gbamp_multiboot.html" target="_blank">GBAMP Multiboot</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#76800 - HyperHacker - Fri Mar 24, 2006 10:29 pm</h4>
    <div class="postbody"><span class="postbody">Both worked on my DS via WMB.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#77907 - Dark Knight ez - Mon Apr 03, 2006 11:51 pm</h4>
    <div class="postbody"><span class="postbody">Hey all,
<br/>
<br/>
I'm trying to implement multithreading, but ran into a problem... and that is that the multithreading conflicts with my current implementation of my program (they both try to use VBlank-interrupt?).
<br/>
I noticed in the multithread-topic that someone else had the same(?) issue, but using his altered code makes my entire program crash (doing nothing after running the "setting interrupt-handler" code), so I doubt that's the solution. (Using the original code of the example multithreading program does work, but my arm7-vblank handler doesn't operate anymore when using that, thus prohibiting my program to work.)
<br/>
<br/>
The altered code (with fixes provided by MightyMax [see page 3 of this thread]):
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code"> // Set up the multithreader interrupt handler 
<br/>
  // Initialise the interrupt system 
<br/>
  irqInit(); 
<br/>
  // install our simple vblank handler 
<br/>
  irqSet(IRQ_VBLANK, &amp;InterruptHandler); 
<br/>
  REG_IME = 0; 
<br/>
  void *tempHandle = (void *)IRQ_HANDLER; 
<br/>
<br/>
  IRQ_HANDLER = &amp;IRQ_Entry; 
<br/>
  REG_IE = IRQ_VBLANK; 
<br/>
  REG_IF = ~0; 
<br/>
  DISP_SR = DISP_VBLANK_IRQ; 
<br/>
  REG_IME = 1; 
<br/>
  
<br/>
  // Set the user define interupt handler 
<br/>
  
<br/>
   wait() ; 
<br/>
  SetIRQHandler((void *)&amp;tempHandle);</td> </tr></table><span class="postbody">
<br/>
<br/>
What would be wrong in this code?
<br/>
And if it is true that VBLANK is used for (the start of) multithreading as well, would it not be possible to (for instance) use another interrupt to trigger the multithreading instead of VBLANK, and cause _that_ interrupt to happen/trigger at the end of the already existing VBLANK handler?
<br/>
<br/>
If the problem can't be determined this way, I'll post my code, or snippets thereof.
<br/>
Thanks in advance for any help.
<br/>
<br/>
Greets,
<br/>
Dark Knight ez.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#77967 - Mighty Max - Tue Apr 04, 2006 7:57 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Dark Knight ez wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code"> // Set up the multithreader interrupt handler 
<br/>
  // Initialise the interrupt system 
<br/>
  irqInit(); 
<br/>
  // install our simple vblank handler 
<br/>
  irqSet(IRQ_VBLANK, &amp;InterruptHandler); 
<br/>
  REG_IME = 0; 
<br/>
  void *tempHandle = (void *)IRQ_HANDLER; 
<br/>
<br/>
  IRQ_HANDLER = &amp;IRQ_Entry; 
<br/>
  REG_IE = IRQ_VBLANK; 
<br/>
  REG_IF = ~0; 
<br/>
  DISP_SR = DISP_VBLANK_IRQ; 
<br/>
  REG_IME = 1; 
<br/>
  
<br/>
  // Set the user define interupt handler 
<br/>
  
<br/>
   wait() ; 
<br/>
  SetIRQHandler(tempHandle);</td> </tr></table><span class="postbody">
<br/>
<br/>
</span></td> </tr></table><span class="postbody">
<br/>
<br/>
I corrected the code. (Last Line)
<br/>
<br/>
tempHandle is already &amp;Function. Using &amp;tempHandle will make the interrupt handler jump into your variable and not the function. (&amp;PointerToFunction)<br/>_________________<br/><a class="postlink" href="http://mightymax.org/gbamp_multiboot.html" target="_blank">GBAMP Multiboot</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#77984 - Dark Knight ez - Tue Apr 04, 2006 11:05 am</h4>
    <div class="postbody"><span class="postbody">Thank you. Should've noticed that one. It works again after that (displaying like it should), but ARM7/ARM9 communication is gone after that (which uses IPC and interrupts).
<br/>
Not having X/Y buttons available, no touch screen, and no music is not an option, so I'm going to try something else, more elegant and more time consuming. ;)
<br/>
Thanks for the help though. Appreciate it.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#80544 - aitotat - Sun Apr 23, 2006 10:55 am</h4>
    <div class="postbody"><span class="postbody">Here is my attempt for multithreading on Nintendo DS:
<br/>
<a class="postlink" href="http://koti.mbnet.fi/aitotat/Ohjelmat/NDS_multithreading.zip" target="_blank">http://koti.mbnet.fi/aitotat/Ohjelmat/NDS_multithreading.zip</a>
<br/>
<br/>
Zip contains three different examples where rectangles are moving. Rectangles are each in its own thread.
<br/>
<br/>
If you're going to try them on an emulator, they will only run on iDeaS.<br/>_________________<br/><a class="postlink" href="http://kotisivu.dnainternet.net/ttilli/" target="_blank">http://kotisivu.dnainternet.net/ttilli/</a></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
