<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Accessing NitroROM FS of a .nds loaded from slot1 flashcard - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > Accessing NitroROM FS of a .nds loaded from slot1 flashcard</h2>
<div id="posts">
<div class="post">
    <h4>#139578 - bocca - Fri Sep 07, 2007 6:30 pm</h4>
    <div class="postbody"><span class="postbody">This one is for gurus, I think  :D 
<br/>
<br/>
I am writing a piece of homebrew to load files contained in the .nds file itself using NitroROM file system (http://nocash.emubase.de/gbatek.htm#dscartridgenitroromfilesystem), similar to GBFS or PALib FS. I own a slot2 flashcart (M3 Lite), with it I can easily access the files through GBA Slot ROM memory address (08000000h). It also works on desmume, dualis and no$gba emulators.
<br/>
<br/>
I would like to extend this to work with slot1 flashcards (M3 simply, R4, G6, X-treme), but I do not own one. I know I can use libfat/DLDI instead, but now I would like to know if it is technically possible. I assume it can be done, since backup ROMs loaded from slot2 can access ROM data. But I dont know how.
<br/>
<br/>
I have read that the NDS Slot ROM is not mapped to ARM9/ARM7 bus, so my code would not work. Instead, it must be accessed through a complex serial protocol with encryption(http://nocash.emubase.de/gbatek.htm#dscartridgeprotocol). Do slot1 flashcards mimic that protocol, so that I can use the B7aaaaaaaa000000h command to read data? Is there an easy way?
<br/>
<br/>
Related to this, I wonder how slot2 flashcarts achieve to execute NDS ROMs that access ROM data. I've noted that a .nds ROM patched by M3 Game manager is almost 99% binary different from the original (only first 4000h are equal). Does the patch replace the calls to the card protocol with access to 08000000h? It sounds too complicated...
<br/>
<br/>
Thanks in advance</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#139588 - truedream - Fri Sep 07, 2007 8:32 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>bocca wrote:</b></span></td> </tr> <tr> <td class="quote">This one is for gurus, I think  :D 
<br/>
<br/>
I am writing a piece of homebrew to load files contained in the .nds file itself using NitroROM file system (http://nocash.emubase.de/gbatek.htm#dscartridgenitroromfilesystem), similar to GBFS or PALib FS. I own a slot2 flashcart (M3 Lite), with it I can easily access the files through GBA Slot ROM memory address (08000000h). It also works on desmume, dualis and no$gba emulators.
<br/>
<br/>
I would like to extend this to work with slot1 flashcards (M3 simply, R4, G6, X-treme), but I do not own one. I know I can use libfat/DLDI instead, but now I would like to know if it is technically possible. I assume it can be done, since backup ROMs loaded from slot2 can access ROM data. But I dont know how.
<br/>
<br/>
I have read that the NDS Slot ROM is not mapped to ARM9/ARM7 bus, so my code would not work. Instead, it must be accessed through a complex serial protocol with encryption(http://nocash.emubase.de/gbatek.htm#dscartridgeprotocol). Do slot1 flashcards mimic that protocol, so that I can use the B7aaaaaaaa000000h command to read data? Is there an easy way?
<br/>
<br/>
Related to this, I wonder how slot2 flashcarts achieve to execute NDS ROMs that access ROM data. I've noted that a .nds ROM patched by M3 Game manager is almost 99% binary different from the original (only first 4000h are equal). Does the patch replace the calls to the card protocol with access to 08000000h? It sounds too complicated...
<br/>
<br/>
Thanks in advance</td> </tr></table><span class="postbody">
<br/>
<br/>
this is only possible with cards that support "TRUE NO PATCH MODE"
<br/>
cards that use patching like R4-M3 will not work
<br/>
<br/>
on ez5 and acekard and some other cards the B7 command will work
<br/>
properly as the hardware emulates it correctly
<br/>
<br/>
alternativly if you insert code into your app that gets patched by
<br/>
R4 then you can use it R4 too ;)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#139598 - nornagon - Sat Sep 08, 2007 12:23 am</h4>
    <div class="postbody"><span class="postbody">You don't need to know this, because you don't pirate games. Or do you?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#139599 - Lick - Sat Sep 08, 2007 12:49 am</h4>
    <div class="postbody"><span class="postbody">Are you trying to load a Slot-1 game, or from a Slot-1 device?
<br/>
<br/>
If it's the latter, just use libfat to load the .NDS file. Libfat will handle the card protocol.<br/>_________________<br/><a class="postlink" href="http://licklick.wordpress.com" target="_blank">http://licklick.wordpress.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#139601 - bocca - Sat Sep 08, 2007 1:32 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>nornagon wrote:</b></span></td> </tr> <tr> <td class="quote">You don't need to know this, because you don't pirate games. Or do you?</td> </tr></table><span class="postbody">
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Lick wrote:</b></span></td> </tr> <tr> <td class="quote">Are you trying to load a Slot-1 game, or from a Slot-1 device? 
<br/>
<br/>
If it's the latter, just use libfat to load the .NDS file. Libfat will handle the card protocol.</td> </tr></table><span class="postbody">
<br/>
I just want to make my homebrew program work on slot-1 devices with no additional data files (libfat), only the .nds file (NitroROM). I need only read-access to resources (sound, graphics, etc.) just like commercial ROMs.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>truedream wrote:</b></span></td> </tr> <tr> <td class="quote">this is only possible with cards that support "TRUE NO PATCH MODE" 
<br/>
cards that use patching like R4-M3 will not work
<br/>
<br/>
alternativly if you insert code into your app that gets patched by 
<br/>
R4 then you can use it R4 too ;)</td> </tr></table><span class="postbody">
<br/>
What is "TRUE NO PATCH MODE"? I've read that M3 Simply and R4 Revolution does not need patching. Do you mean that these devices do a patch at load time or something like that? How can I make my code be pached by R4?
<br/>
<br/>
If the B7 command works for slot-1 devices and GBAROM works for slot-2 devices, I'll try to detect the device type at runtime (for example, comparing the NDS Slot ROM header with the one in 027FFE00h) to use the proper read method.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#139608 - tepples - Sat Sep 08, 2007 2:44 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>bocca wrote:</b></span></td> </tr> <tr> <td class="quote">I just want to make my homebrew program work on slot-1 devices with no additional data files (libfat), only the .nds file (NitroROM). I need only read-access to resources (sound, graphics, etc.) just like commercial ROMs.</td> </tr></table><span class="postbody">
<br/>
To work around the lack of an initial working directory in libfat, you can scan the file system using EFS.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#139610 - chishm - Sat Sep 08, 2007 3:15 am</h4>
    <div class="postbody"><span class="postbody">All SLOT-2 and most SLOT-1 cards that run commercial warez do so by patching certain DS card functions in the games to load using that card's protocol instead. Those DS card functions are found only because they are the same across all games that use the same version of the SDK. 
<br/>
<br/>
If you want this to work on your app, you'd need to use the same functions as commercial games do, that is, you'd need to use the SDK. Since this is illegal without being an official developer, you can't actually do this. So your app would only work on cards that support the card protocol in hardware. You'll limit your audience to a small small segment of the homebrew community for the sake of packing your data into the NDS. That being said, look for EFS.<br/>_________________<br/><a class="postlink" href="http://chishm.drunkencoders.com" target="_blank">http://chishm.drunkencoders.com</a>
<br/>
<a class="postlink" href="http://dldi.drunkencoders.com" target="_blank">http://dldi.drunkencoders.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#139622 - truedream - Sat Sep 08, 2007 9:14 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>chishm wrote:</b></span></td> </tr> <tr> <td class="quote">All SLOT-2 and most SLOT-1 cards that run commercial warez do so by patching certain DS card functions in the games to load using that card's protocol instead. Those DS card functions are found only because they are the same across all games that use the same version of the SDK. 
<br/>
<br/>
If you want this to work on your app, you'd need to use the same functions as commercial games do, that is, you'd need to use the SDK. Since this is illegal without being an official developer, you can't actually do this. So your app would only work on cards that support the card protocol in hardware. You'll limit your audience to a small small segment of the homebrew community for the sake of packing your data into the NDS. That being said, look for EFS.</td> </tr></table><span class="postbody">
<br/>
<br/>
wrong. some cards R4/M3 etc need patching.
<br/>
some do not - those what do support the correct hardware commands
<br/>
<br/>
the patching by R4 etc is done transparentl to the 
<br/>
user but it is defenetly done.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#139623 - chishm - Sat Sep 08, 2007 10:11 am</h4>
    <div class="postbody"><span class="postbody">Uh, re-read what I wrote. I said "<span style="font-weight: bold">most</span> SLOT-1 cards". Out of all the SLOT-1 cards available on the market, only a small minority have hardware support for the DS card protocol as used in commercial games. That may change in future, but as of now it is correct.
<br/>
<br/>
Also, as I said, cards that do patching look for functions specific to the official Nintendo SDK. Those that patch homebrew on-the-fly either use DLDI (R4/M3) or directly patch libfat (old versions of the DS-Xtreme firmware).
<br/>
<br/>
truedream, next time you reply make sure you actually read what you are replying to.<br/>_________________<br/><a class="postlink" href="http://chishm.drunkencoders.com" target="_blank">http://chishm.drunkencoders.com</a>
<br/>
<a class="postlink" href="http://dldi.drunkencoders.com" target="_blank">http://dldi.drunkencoders.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#139626 - Diddl - Sat Sep 08, 2007 10:34 am</h4>
    <div class="postbody"><span class="postbody">but it would be cool to support same protocoll like commercial roms do (Nitro FS) for homebrew.
<br/>
<br/>
Which slot 1 cards supports this protocol directly without patching? Is there a list of slot 1 cards which can do this? 
<br/>
<br/>
I think such a slot 1 flashcard will need 
<br/>
+ a 'intelligent' card with own cpu which does the protocoll
<br/>
+ or you need to have a big flash memory (same as commercial) and load nds file into it bevore starting it?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#139631 - truedream - Sat Sep 08, 2007 1:39 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>chishm wrote:</b></span></td> </tr> <tr> <td class="quote">Uh, re-read what I wrote. I said "<span style="font-weight: bold">most</span> SLOT-1 cards". Out of all the SLOT-1 cards available on the market, only a small minority have hardware support for the DS card protocol as used in commercial games. That may change in future, but as of now it is correct.
<br/>
<br/>
Also, as I said, cards that do patching look for functions specific to the official Nintendo SDK. Those that patch homebrew on-the-fly either use DLDI (R4/M3) or directly patch libfat (old versions of the DS-Xtreme firmware).
<br/>
<br/>
truedream, next time you reply make sure you actually read what you are replying to.</td> </tr></table><span class="postbody">
<br/>
eh, i did read ALL .. &lt;&gt; slot-2
<br/>
so yes, sure this is correct what you said most is appropriate.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#139647 - M3d10n - Sat Sep 08, 2007 3:54 pm</h4>
    <div class="postbody"><span class="postbody">Use EFSLib:
<br/>
<a class="postlink" href="http://forum.gbadev.org/viewtopic.php?t=13195&amp;highlight=efslib" target="_blank">http://forum.gbadev.org/viewtopic.php?t=13195&amp;highlight=efslib</a>
<br/>
<br/>
It allows you to use NitroFS, keeping all your data files inside the .NDS itself. It works by using libfat and scanning the card to find the .NDS itself, reads the embedded filesystem so you can use efs_* IO functions to read files from inside the NDS.
<br/>
<br/>
I just can't get it working on nocash no matter what (in theory, using FCSR and appending the .NDS to itself should work).</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#139655 - bocca - Sat Sep 08, 2007 5:25 pm</h4>
    <div class="postbody"><span class="postbody">Thank you so much to all of you. Your responses are clarifying. I'll have a look to EFS.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#139657 - bocca - Sat Sep 08, 2007 6:04 pm</h4>
    <div class="postbody"><span class="postbody">It would be interesting to extend EFS to avoid DLDI usage if possible (for read-only access):
<br/>
<ol type="1"><li>If it detects that direct access to 08000000h memory address is possible (checking the header against 027FFE00h), then use it. This way, in theory all slot-2 devices, in particular old slot-2 non-fat devices (neoflash?) will work without DLDI.
<br/>
</li><li>If not, if it detects that card protocol can be used (checking the header against 027FFE00h), then use it. This way new slot-1 devices with card protocol emulation (EZV?) will also work without DLDI.
<br/>
</li><li>In the rest of the cases (the middle), DLDI will be used. If the device supports DLDI auto-pathing, no user intervention is needed. Only in other cases the user should patch the file.</li></ol></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#139663 - chuckstudios - Sat Sep 08, 2007 7:23 pm</h4>
    <div class="postbody"><span class="postbody">I think using DLDI universally is the best solution. Having the program figure out how it should run itself is kind of stupid when there's one universal way.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#139665 - truedream - Sat Sep 08, 2007 7:49 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>chuckstudios wrote:</b></span></td> </tr> <tr> <td class="quote">I think using DLDI universally is the best solution. Having the program figure out how it should run itself is kind of stupid when there's one universal way.</td> </tr></table><span class="postbody">
<br/>
<br/>
actually the no - the DLDI method would need to find the file on sd-card based on unique signature, for 4GB sd-card this may take a while ;)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#139688 - chuckstudios - Sat Sep 08, 2007 10:17 pm</h4>
    <div class="postbody"><span class="postbody">But it only needs to happen once :P
<br/>
<br/>
Once EFSlib finds the signature, it writes the path inside the NDS. I would know since I use it in my software.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#139718 - truedream - Sun Sep 09, 2007 7:58 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>chuckstudios wrote:</b></span></td> </tr> <tr> <td class="quote">But it only needs to happen once :P
<br/>
<br/>
Once EFSlib finds the signature, it writes the path inside the NDS. I would know since I use it in my software.</td> </tr></table><span class="postbody">
<br/>
<br/>
ha, well yes, that nice trick, it locates itself and modifies itself to reloc itself quickly, yes that really nice.
<br/>
actually a very smart directory search would possible find the nds also quick if it caches dir and fat and then only looks for one sector from the nds file</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#139720 - Lick - Sun Sep 09, 2007 12:17 pm</h4>
    <div class="postbody"><span class="postbody">I've written a <a class="postlink" href="http://forum.gbadev.org/viewtopic.php?t=13654" target="_blank">Locator</a> function (improved by <span style="font-weight: bold">melw</span>) that can search for both a directories and files. So you can statically name your directory to something like "HelloWorld" and let it contain your files, or statically name your NDS to "HelloWorld.nds". Doesn't have to be on the root.<br/>_________________<br/><a class="postlink" href="http://licklick.wordpress.com" target="_blank">http://licklick.wordpress.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#139741 - HyperHacker - Sun Sep 09, 2007 6:30 pm</h4>
    <div class="postbody"><span class="postbody">That's awesome, why haven't I seen it before? You could use it with self-modification to only have to find the config file once.<br/>_________________<br/>I'm a PSP hacker now, but I still &lt;3 DS.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
