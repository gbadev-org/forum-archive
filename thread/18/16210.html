<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Quake 1 rendering. - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > Quake 1 rendering.</h2>
<div id="posts">
<div class="post">
    <h4>#164709 - quip - Sat Nov 15, 2008 5:56 am</h4>
    <div class="postbody"><span class="postbody">I know simonjhall has done a lovely quake 1 release for the ds.
<br/>
So I was wondering what I am I doing wrong here in rendering the faces.
<br/>
Particularly I'm having trouble with the edges.
<br/>
Right now I"m just trying to get it to render properly.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
<br/>
v16 verts[3][16];
<br/>
for(int x = 0; x &lt; bsp-&gt;numFaces; ++x){
<br/>
   glColor3b( x &amp; 255, x &amp; 255, x&amp;255);    // just colors for now
<br/>
        glBegin(GL_TRIANGLES);
<br/>
<br/>
   int numEdges = bsp-&gt;faces[x].numEdges;
<br/>
        for(int i = 0; i &lt; numEdges; i++){
<br/>
                int index = listOfEdges[  bsp-&gt;faces[x].firstEdge + i ];
<br/>
                int vertex;
<br/>
                if( index &gt; ){         //     Normal order
<br/>
                       vertex = edges[  index  ].v[0];
<br/>
                       verts[0][i] = vertices[ vertex ].x;
<br/>
                       verts[1][i] = vertices[ vertex ].y;
<br/>
                       verts[2][i] = vertices[ vertex ].z;
<br/>
                } else {
<br/>
                         vertex = edges[  -index  ].v[1];
<br/>
                       verts[0][i] = vertices[ vertex ].x;
<br/>
                       verts[1][i] = vertices[ vertex ].y;
<br/>
                       verts[2][i] = vertices[ vertex ].z;                       
<br/>
                } 
<br/>
                glVertex3v16(verts[0][i], verts[1][i], verts[2][i]);
<br/>
        }// endfor i
<br/>
   glEnd();
<br/>
}//end for x
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"><br/><br/>Last edited by quip on Sat Nov 15, 2008 8:31 pm; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#164710 - Dr Salvador - Sat Nov 15, 2008 7:04 am</h4>
    <div class="postbody"><span class="postbody">only problem with quake ds i ever get is the framerate</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#164712 - elhobbs - Sat Nov 15, 2008 3:21 pm</h4>
    <div class="postbody"><span class="postbody">the faces are polygons. not triangles.so, you need to manually treat it like a triangle fan.
<br/>
<br/>
pseudo code
<br/>
glBegin(GL_TRIANGLES);
<br/>
for(i=2;i&lt;numverts;i++)
<br/>
{
<br/>
   glVertex(vert[0]);
<br/>
   glVertex(vert[i-1]);
<br/>
   glVertex(vert[i]);
<br/>
}
<br/>
glEnd();
<br/>
<br/>
If you have not already done this - you will need to scale all of the quake float vertices to fit into the ds fixed point vertex format. I used float*2 - that keeps the quake vertices within the ds range of -8 to 8 in 4.12 fixed point format.
<br/>
<br/>
you can download the source code for quakeds,cquake, or even the original id software release. that would answer most of your questions.
<br/>
<br/>
this will be way too many triangles for the ds. you need to use the visibility info to reduce the visible set.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#164714 - silent_code - Sat Nov 15, 2008 3:36 pm</h4>
    <div class="postbody"><span class="postbody">Welcome to the scene. :^)
<br/>
<br/>
Please post some images, so that we can take a look at your edge problem. Thanks.<br/>_________________<br/><span style="font-size: 9px; line-height: normal"><span style="text-decoration: underline"><span style="font-weight: bold"></span></span> July 5th 08: "<span style="font-weight: bold">Volumetric Shadow Demo</span>" 1.6.0 (final) source released
<br/>
June 5th 08: "<span style="font-weight: bold">Zombie NDS</span>" WIP released!
<br/>
It's all on my page, just click <span style="font-weight: bold">WWW</span> below.</span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#164739 - quip - Mon Nov 17, 2008 2:05 am</h4>
    <div class="postbody"><span class="postbody">Thank you. Always nice to enter a new scene. :)
<br/>
<br/>
@elhobbs, my map is very simple right now. Just one cube! so I'm ignoring PVS for now. :), also in the quake source they rendered it like this, so I think I'm doing it correctly. I also implemented your way of triangle fan as well as my way. (I'm not sure my way is correct tho).
<br/>
<br/>
Quake 1:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
      pedges = currententity-&gt;model-&gt;edges;
<br/>
      lnumverts = fa-&gt;numedges;
<br/>
      vertpage = 0;
<br/>
<br/>
      for (i=0 ; i&lt;lnumverts ; i++)
<br/>
      {
<br/>
         lindex = currententity-&gt;model-&gt;surfedges[fa-&gt;firstedge + i];
<br/>
<br/>
         if (lindex &gt; 0)
<br/>
         {
<br/>
            r_pedge = &amp;pedges[lindex];
<br/>
            verts[0][i] = r_pcurrentvertbase[r_pedge-&gt;v[0]];
<br/>
         }
<br/>
         else
<br/>
         {
<br/>
            r_pedge = &amp;pedges[-lindex];
<br/>
            verts[0][i] = r_pcurrentvertbase[r_pedge-&gt;v[1]];
<br/>
         }
<br/>
      }
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
My triangle fan:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
void triangleFan(BSPFVertex *vertices, int tris){   // tris should be numverts - 2
<br/>
   
<br/>
   glPolyFmt(POLY_ALPHA(31) | POLY_CULL_NONE);
<br/>
   
<br/>
   for(int x = 0; x &lt; tris; ++x){
<br/>
      glColor3b(x &amp; 255, x &amp; 255, x &amp; 255);
<br/>
      glBegin(GL_TRIANGLES);
<br/>
      
<br/>
      glVertex3v16(vertices[0].x, vertices[0].y, vertices[0].z); //    We'll use the first one as the reference
<br/>
      glVertex3v16(vertices[x * 4 + 1].x, vertices[x * 4 + 1].y, vertices[ x * 4 + 1].z); //    We'll use the first one as the reference
<br/>
      glVertex3v16(vertices[x * 4 + 2].x, vertices[x * 4 + 2].y, vertices[ x * 4 + 2].z); //    We'll use the first one as the reference
<br/>
      glEnd();
<br/>
   }
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Also here are screenshots of the result.
<br/>
The first image is the rendering using elhobbs' triangle fan way.
<br/>
The second is usingmy triangle fan way.
<br/>
And the last is what it should look like(i obviously drew that one in :P).
<br/>
The Cube is pretty much 9 quads to one side with six sides.
<br/>
<br/>
<br/>
<a href="http://i33.tinypic.com/919x95.jpg">[Images not permitted - Click here to view it]</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#164740 - elhobbs - Mon Nov 17, 2008 2:38 am</h4>
    <div class="postbody"><span class="postbody">the code that I gave you does not need to be broken down into triangles. all of the polygons in quake 1 are convex. this means that for an n vertex polygon it can be rendered as n-2 triangles such that each triangle uses the vertices 0,i-1,i for i =2 to i = n-1
<br/>
<br/>
here is an image to sort it out
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
0---1
<br/>
|   |
<br/>
3---2
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
this quad can be rendered as two triangles
<br/>
0,1,2
<br/>
and
<br/>
0,2,3
<br/>
<br/>
<br/>
I know this method works as it is the method I used in cquake. this probably is not the optimal way to do it but it is the easiest way that does not require storing the bsp data in a different format. one issue that it does not address is tjunctions, but it does not cause a problems for the most part. in case you are not familiar - tjunctions are colinear vertices that are added to prevent seams in adjacent polygons that share partial edges.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#164741 - quip - Mon Nov 17, 2008 2:55 am</h4>
    <div class="postbody"><span class="postbody">@elhobbs
<br/>
Interesting. You method and mines give the same result but I'll just use yours.  I'm guessing maybe the way I'm plotting the vertices is wrong?
<br/>
I made a PC version and with lines, it's correctly drawn, but with GL_POLYGON, it also looks incorrect, same as with the ds version.
<br/>
<br/>
Do you see anything wrong in the way I get the vertices?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#164749 - elhobbs - Mon Nov 17, 2008 9:19 am</h4>
    <div class="postbody"><span class="postbody">here is some code pulled directly from BuildSurfaceDisplayList in gl_rsurf.c
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
medge_t      *pedges, *r_pedge;
<br/>
float      *vec;
<br/>
pedges = currentmodel-&gt;edges;
<br/>
lnumverts = fa-&gt;numedges;
<br/>
for (i=0 ; i&lt;lnumverts ; i++)
<br/>
{
<br/>
      lindex = currentmodel-&gt;surfedges[fa-&gt;firstedge + i];
<br/>
<br/>
      if (lindex &gt; 0)
<br/>
      {
<br/>
         r_pedge = &amp;pedges[lindex];
<br/>
         vec = r_pcurrentvertbase[r_pedge-&gt;v[0]].position;
<br/>
      }
<br/>
      else
<br/>
      {
<br/>
         r_pedge = &amp;pedges[-lindex];
<br/>
         vec = r_pcurrentvertbase[r_pedge-&gt;v[1]].position;
<br/>
      }
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
I am assuming that this level loads correctly on the original pc version of quake, yes?
<br/>
are you sure you are loading the data correctly?
<br/>
you may also want to try and draw it as lines. since the ds does triangles and quads only, you need to render each line as a triangle with the second and third points the same.
<br/>
<br/>
how did you convert the quake float vertices to ds format? floattov16 and floattof32 (or most likely any libnds macros) will not provide usable results as the they will overflow.
<br/>
<br/>
do you have your code someplace where I can look at it as a whole?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#164785 - quip - Fri Nov 21, 2008 6:40 am</h4>
    <div class="postbody"><span class="postbody">I for one am an idiot!
<br/>
Instead of just using the bspfile.h from the quake source, I defined the types by looking at online documentation.
<br/>
And after looking @ it a little while more, I realized the Surfaces edges were int s not short s like i had. 
<br/>
Silly errors, but problem solved. 
<br/>
Thanks all and especially thanks elhobbs. :D</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
