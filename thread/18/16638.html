<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Wifi functions and classes - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > Wifi functions and classes</h2>
<div id="posts">
<div class="post">
    <h4>#168526 - hacker013 - Sat May 02, 2009 3:47 pm</h4>
    <div class="postbody"><span class="postbody">hey,
<br/>
<br/>
I decided to switch to c++ and ported a basic wifi setup from c to c++ but now i'm getting some errors about pointers which point to functions.
<br/>
<br/>
Error message:
<br/>
make -C arm7
<br/>
make[1]: Entering directory `/c/UZProject/DSDEV/arm7'
<br/>
wifi.cpp
<br/>
arm-eabi-g++ -MMD -MP -MF /c/UZProject/DSDEV/arm7/build/wifi.d -g -Wall -O2 -mcp
<br/>
u=arm7tdmi -mtune=arm7tdmi -fomit-frame-pointer -ffast-math -mthumb-interwork -I
<br/>
/c/UZProject/DSDEV/arm7/include -I/c/UZProject/DSDEV/arm7/build -I/c/UZProject/DSDEV/arm7/source -I/c/UZProject/DSDEV/arm7/../dsdev_engine -I/c/devkitPro/libnds/include -I/c/UZProject/DSDEV/arm7/build -DARM7 -fno-rtti -fno-exceptions -fno-rtti -c /c/UZProject/DSDEV/arm7/../dsdev_engine/wifi.cpp -o wifi.o
<br/>
c:/UZProject/DSDEV/arm7/../dsdev_engine/wifi.cpp: In constructor 'WIFI::WIFI()':
<br/>
<br/>
c:/UZProject/DSDEV/arm7/../dsdev_engine/wifi.cpp:38: error: argument of type 'void (WIFI::)()' does not match 'void (*)()'
<br/>
c:/UZProject/DSDEV/arm7/../dsdev_engine/wifi.cpp: In member function 'void WIFI::arm7_fifo()':
<br/>
c:/UZProject/DSDEV/arm7/../dsdev_engine/wifi.cpp:138: error: argument of type 'void (WIFI::)()' does not match 'void (*)()'
<br/>
make[2]: *** [wifi.o] Error 1
<br/>
make[1]: *** [build] Error 2
<br/>
make[1]: Leaving directory `/c/UZProject/DSDEV/arm7'
<br/>
make: *** [arm7/DSDEV.elf] Error 2
<br/>
<br/>
wifi.cpp
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#include "wifi.h"
<br/>
<br/>
/* Basic WIFI Functions */
<br/>
<br/>
WIFI::WIFI() {
<br/>
   #ifdef ARM9
<br/>
   if(Wifi_CheckInit()) return;
<br/>
   REG_IPC_FIFO_CR = IPC_FIFO_ENABLE | IPC_FIFO_SEND_CLEAR; // enable &amp; clear FIFO
<br/>
   
<br/>
   u32 Wifi_pass = Wifi_Init( WIFIINIT_OPTION_USELED );
<br/>
      REG_IPC_FIFO_TX = 0x12345678;
<br/>
      REG_IPC_FIFO_TX = Wifi_pass;
<br/>
      
<br/>
   *((volatile u16 *)0x0400010E) = 0; // disable timer3
<br/>
      
<br/>
   irqSet( IRQ_TIMER3, wifi_timer_50ms ); // setup timer IRQ
<br/>
   irqEnable( IRQ_TIMER3 );
<br/>
      irqSet( IRQ_FIFO_NOT_EMPTY, arm9_fifo ); // setup fifo IRQ
<br/>
      irqEnable( IRQ_FIFO_NOT_EMPTY );
<br/>
      
<br/>
      REG_IPC_FIFO_CR = IPC_FIFO_ENABLE | IPC_FIFO_RECV_IRQ; // enable FIFO IRQ
<br/>
      
<br/>
      Wifi_SetSyncHandler( arm9_synctoarm7 ); // tell wifi lib to use our handler to notify arm7
<br/>
<br/>
   // set timer3
<br/>
   *((volatile u16 *)0x0400010C) = -6553; // 6553.1 * 256 cycles = ~50ms;
<br/>
   *((volatile u16 *)0x0400010E) = 0x00C2; // enable, irq, 1/256 clock
<br/>
   
<br/>
   while( !Wifi_CheckInit() ) { // wait for arm7 to be initted successfully
<br/>
      swiWaitForVBlank();
<br/>
   }
<br/>
   #endif
<br/>
   #ifdef ARM7
<br/>
   irqSet( IRQ_WIFI, Wifi_Interrupt );
<br/>
   irqEnable( IRQ_WIFI );
<br/>
<br/>
   //set up FIFO for wifi init and whatnot
<br/>
   irqSet( IRQ_FIFO_NOT_EMPTY, arm7_fifo );
<br/>
   irqEnable( IRQ_FIFO_NOT_EMPTY );
<br/>
   REG_IPC_FIFO_CR = IPC_FIFO_ENABLE | IPC_FIFO_SEND_CLEAR | IPC_FIFO_RECV_IRQ;
<br/>
   #endif
<br/>
};
<br/>
<br/>
WIFI::~WIFI() {
<br/>
   #ifdef ARM9
<br/>
   if( Wifi_CheckInit() ) 
<br/>
   {
<br/>
      Wifi_DisconnectAP();
<br/>
      Wifi_DisableWifi();
<br/>
      //just wait a while to give ARM7 a chance to finish off the wifi
<br/>
      for( int j = 0; j &lt; 30; ++j ) swiWaitForVBlank();
<br/>
   }
<br/>
   #endif
<br/>
};
<br/>
<br/>
#ifdef ARM9
<br/>
bool WIFI::auto_connect() {
<br/>
   Wifi_AutoConnect();
<br/>
   while( true ) {
<br/>
      int i = Wifi_AssocStatus();
<br/>
      if( i == ASSOCSTATUS_ASSOCIATED ) {
<br/>
         return true;
<br/>
      }
<br/>
      if( i == ASSOCSTATUS_CANNOTCONNECT ) {
<br/>
         return false;
<br/>
      }
<br/>
   }
<br/>
};
<br/>
<br/>
/* Socket Wrapper */
<br/>
<br/>
int WIFI::send( int socket, const char * data ) {
<br/>
   return send( socket, data, strlen( data ), 0 );
<br/>
}
<br/>
<br/>
bool WIFI::socket_create( int * sock, char * host, int port, bool blocking ) {
<br/>
   struct sockaddr_in servaddr;   
<br/>
   if( ( *sock = socket( AF_INET, SOCK_STREAM, 0 ) ) &lt; 0 ) {
<br/>
      return false;
<br/>
   }
<br/>
<br/>
   memset( &amp;servaddr, 0, sizeof( servaddr ) );
<br/>
   servaddr.sin_family = AF_INET;
<br/>
   servaddr.sin_port = htons( port );
<br/>
<br/>
   if( !inet_aton( host, &amp;servaddr.sin_addr ) ) {
<br/>
      servaddr.sin_addr.s_addr = *(unsigned long *) gethostbyname( host )-&gt;h_addr_list[0];
<br/>
   }
<br/>
<br/>
   if( blocking ) {
<br/>
      if( !connect( *sock, (struct sockaddr *) &amp;servaddr, sizeof( servaddr ) ) ) {
<br/>
         return true;
<br/>
      }
<br/>
   } else {
<br/>
      if( !connect( *sock, (struct sockaddr *) &amp;servaddr, sizeof( servaddr ) ) ) {
<br/>
         int i = 1;
<br/>
         ioctl( *sock, FIONBIO, &amp;i );
<br/>
         return true;
<br/>
      }
<br/>
   }
<br/>
     
<br/>
   return false;
<br/>
}
<br/>
<br/>
/* Intern WIFI Functions */
<br/>
<br/>
//wifi timer function, to update internals of sgIP
<br/>
void WIFI::wifi_timer_50ms() {
<br/>
   Wifi_Timer( 50 );
<br/>
}
<br/>
<br/>
//notification function to send fifo message to arm7
<br/>
void WIFI::arm9_synctoarm7() {
<br/>
   REG_IPC_FIFO_TX=0x87654321;
<br/>
}
<br/>
<br/>
//interrupt handler to receive fifo messages from arm7
<br/>
void WIFI::arm9_fifo() {
<br/>
   if( REG_IPC_FIFO_RX == 0x87654321 ) Wifi_Sync();
<br/>
}
<br/>
<br/>
#endif
<br/>
#ifdef ARM7
<br/>
void WIFI::arm7_synctoarm9() {
<br/>
   REG_IPC_FIFO_TX = 0x87654321;
<br/>
}
<br/>
<br/>
//interrupt handler to allow incoming notifications from arm9, including wifi init request
<br/>
void WIFI::arm7_fifo() {
<br/>
   u32 msg = REG_IPC_FIFO_RX;
<br/>
<br/>
   if( msg == 0x12345678 ) {
<br/>
      irqDisable( IRQ_FIFO_NOT_EMPTY );
<br/>
      while( REG_IPC_FIFO_CR &amp; IPC_FIFO_RECV_EMPTY ) {
<br/>
         swiWaitForVBlank();
<br/>
      }
<br/>
      Wifi_Init( REG_IPC_FIFO_RX );
<br/>
      Wifi_SetSyncHandler( arm7_synctoarm9 ); //allow wifi lib to notify arm9
<br/>
      irqEnable( IRQ_FIFO_NOT_EMPTY );
<br/>
   } else if( msg == 0x87654321 ) {
<br/>
      Wifi_Sync();
<br/>
   }
<br/>
}
<br/>
#endif
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
What i'm doing wrong and how can I fix this?<br/>_________________<br/><a class="postlink" href="http://imetal.nl/" target="_blank">Website / Blog</a>
<br/>
<br/>
Let the nds be with you.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#168528 - elhobbs - Sat May 02, 2009 4:05 pm</h4>
    <div class="postbody"><span class="postbody">try declaring arm7_synctoarm9 as static. this will remove the hidden this pointer argument. it will also make it so you can not access any of the class members, but it should not be an issue for this function. you may still need a cast, but making it static will make it safe to cast.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#168589 - hacker013 - Fri May 08, 2009 12:20 pm</h4>
    <div class="postbody"><span class="postbody">you mean moving it outside the class and declare it static of you mean declare it static inside the class? I tried the second and it didn't work.<br/>_________________<br/><a class="postlink" href="http://imetal.nl/" target="_blank">Website / Blog</a>
<br/>
<br/>
Let the nds be with you.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#168590 - Dwedit - Fri May 08, 2009 12:52 pm</h4>
    <div class="postbody"><span class="postbody">It wants a void function which takes no arguments.  All member functions of any class take in a hidden argument, the *this pointer.
<br/>
<br/>
Make the function named "arm9_synctoarm7" a static function.  That way, it's part of the class, but is not part of an object.  It has no access to any members of the class.  A static function inside a class is just a normal function.<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#168591 - elhobbs - Fri May 08, 2009 1:57 pm</h4>
    <div class="postbody"><span class="postbody">like this</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#include &lt;nds.h&gt;
<br/>
#include &lt;dswifi9.h&gt;
<br/>
<br/>
<br/>
class WIFI
<br/>
{
<br/>
   public:
<br/>
      WIFI() {};
<br/>
      static void arm7_synctoarm9() { 
<br/>
         REG_IPC_FIFO_TX = 0x87654321; 
<br/>
      } 
<br/>
};
<br/>
<br/>
<br/>
<br/>
//---------------------------------------------------------------------------------
<br/>
int main(void) {
<br/>
//---------------------------------------------------------------------------------
<br/>
   Wifi_SetSyncHandler( WIFI::arm7_synctoarm9 ); //allow wifi lib to notify arm9 
<br/>
   
<br/>
   while(1) {
<br/>
      swiWaitForVBlank();
<br/>
   }
<br/>
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
also, make sure you are linking the dswifi9 library. add "-ldswifi9" to LIBS in your makefile.
<br/>
<br/>
any reason you are not just using the wifi startup code that is provided by the latest libnds/dswifi release?</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">   if(!Wifi_InitDefault(WFC_CONNECT)) {
<br/>
      iprintf("Failed to connect!");
<br/>
   }</td> </tr></table><span class="postbody"> your solution may have issues with the fifo system now used by libnds</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#168593 - hacker013 - Fri May 08, 2009 4:15 pm</h4>
    <div class="postbody"><span class="postbody">Because I want full control<br/>_________________<br/><a class="postlink" href="http://imetal.nl/" target="_blank">Website / Blog</a>
<br/>
<br/>
Let the nds be with you.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#168595 - elhobbs - Fri May 08, 2009 7:43 pm</h4>
    <div class="postbody"><span class="postbody">unless you are using a fairly old version of libnds\dswifi then you are going to run into issues with the fifosystem. well, good luck with that...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#168596 - hacker013 - Fri May 08, 2009 7:51 pm</h4>
    <div class="postbody"><span class="postbody">Can you suggest me then a better way to handle the fifo ?<br/>_________________<br/><a class="postlink" href="http://imetal.nl/" target="_blank">Website / Blog</a>
<br/>
<br/>
Let the nds be with you.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
