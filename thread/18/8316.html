<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>How do I work this FAT driver thing? - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>DS development > How do I work this FAT driver thing?</h2>
<div id="posts">
<div class="post">
    <h4>#69156 - HyperHacker - Sat Jan 28, 2006 9:20 pm</h4>
    <div class="postbody"><span class="postbody">I downloaded Chism's FAT driver, extracted it, and put the gba_nds_fat directory in my NDSLib include directoy (as I couldn't see any documentation saying where I should actually be putting it). Read through the header files, include gba_nds_fat.c, and write a simple test app to open a file, write to it, and close it. When I try to compile I get about 2000 'undefined reference' errors. Including more of the .h and .c files mostly fixed this (if they're required, why aren't they included in gba_nds_fat.h?) but I still got undefined reference errors regarding M3CF_GetInterface, MPCF_GetInterface etc... I've tried including both the .h and .c files that these are in, but that just makes a lot more errors! &gt;_&lt; How exactly am I supposed to use this?
<br/>
<br/>
Also, I get other errors that should be checked out...
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">F:\dos\DevKitPro\libnds\include/gba_nds_fat\gba_nds_fat.c:219: warning: non-local variable '&lt;anonymous enum&gt; filesysType' uses anonymous type
<br/>
F:\dos\DevKitPro\libnds\include/gba_nds_fat\gba_nds_fat.c: In function 'u32 FAT_ftell(FAT_FILE*)':
<br/>
F:\dos\DevKitPro\libnds\include/gba_nds_fat\gba_nds_fat.c:2302: warning: converting negative value '-0x000000001' to 'u32'</td> </tr></table><span class="postbody">
<br/>
<br/>
This is all my ARM9 code does:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">int main(int argc, char** argv)
<br/>
{
<br/>
   powerON(POWER_ALL_2D); //Turn stuff on (required for some flash cards)
<br/>
   //videoSetMode(MODE_5_2D | DISPLAY_BG3_ACTIVE);
<br/>
   videoSetMode(MODE_5_2D | DISPLAY_BG3_ACTIVE);
<br/>
   videoSetModeSub(MODE_5_2D | DISPLAY_BG3_ACTIVE);
<br/>
   vramSetMainBanks(VRAM_A_MAIN_BG_0x6000000, VRAM_B_LCD, VRAM_C_SUB_BG_0x6200000, VRAM_D_LCD);
<br/>
   MainScreenBuf = CreateGraphicBuffer(SCREEN_WIDTH,SCREEN_HEIGHT);
<br/>
   SubScreenBuf = CreateGraphicBuffer(SCREEN_WIDTH,SCREEN_HEIGHT);
<br/>
   lcdMainOnTop();
<br/>
<br/>
   BG3_CR = BG_BMP16_256x256;
<br/>
   BG3_XDX = 1 &lt;&lt; 8;
<br/>
   BG3_XDY = 0;
<br/>
   BG3_YDX = 0;
<br/>
   BG3_YDY = 1 &lt;&lt; 8;
<br/>
   BG3_CX = 0;
<br/>
   BG3_CY = 0;
<br/>
<br/>
   SUB_BG3_CR = BG_BMP16_256x256;
<br/>
   SUB_BG3_XDX = 1 &lt;&lt; 8;
<br/>
   SUB_BG3_XDY = 0;
<br/>
   SUB_BG3_YDX = 0;
<br/>
   SUB_BG3_YDY = 1 &lt;&lt; 8;
<br/>
   SUB_BG3_CX = 0;
<br/>
   SUB_BG3_CY = 0;
<br/>
<br/>
   //Init interrupts
<br/>
   REG_IME = 0; //Disable interrupts while changing them
<br/>
   IRQ_HANDLER = Interrupt; //Set handler callback
<br/>
   REG_IE = IRQ_VBLANK; //Interrupt on vblank only
<br/>
   REG_IF = ~0;
<br/>
   DISP_SR = DISP_VBLANK_IRQ;
<br/>
   REG_IME = 1; //Enable interrupts
<br/>
<br/>
   swiWaitForVBlank();
<br/>
   swiWaitForVBlank();
<br/>
   swiWaitForVBlank(); //Let things set up
<br/>
<br/>
   uint32 Coords = 0;
<br/>
   if(!FAT_InitFiles())
<br/>
      Coords = printxy2(MainScreenBuf,0,(Coords &gt;&gt; 16),(Coords &amp; 0xFFFF),"FAT_InitFiles() failed\n");
<br/>
<br/>
   FAT_FILE* fp = FAT_fopen("/test.bin","w");
<br/>
   if(!fp)
<br/>
      Coords = printxy2(MainScreenBuf,0,(Coords &gt;&gt; 16),(Coords &amp; 0xFFFF),"FAT_fopen() failed\n");
<br/>
<br/>
   char data[] = "All your base!\xFF\x00\x0A\x0D\xD0\x6F\xEC\xE5";
<br/>
   Coords = printxy2(MainScreenBuf,0,(Coords &gt;&gt; 16),(Coords &amp; 0xFFFF),"fp=0x%08X\nWrote %d of %d bytes\n",fp,FAT_fwrite(data,1,sizeof(data),fp),sizeof(data));
<br/>
   Coords = printxy2(MainScreenBuf,0,(Coords &gt;&gt; 16),(Coords &amp; 0xFFFF),"FAT_fclose() returned %d\n",FAT_fclose(fp));
<br/>
   SwapBuffers = true;
<br/>
<br/>
<br/>
   while(true) swiWaitForVBlank();
<br/>
   return 0;
<br/>
}
<br/>
<br/>
void Interrupt()
<br/>
{
<br/>
   if(REG_IF &amp; IRQ_VBLANK) //VBlank interrupt
<br/>
   {
<br/>
      KeysPressed = IPC-&gt;buttons_pressed; //Best to keep a local copy, since the ARM7 may modify it
<br/>
      KeysHeld = IPC-&gt;buttons_held;
<br/>
<br/>
      if(SwapBuffers)
<br/>
      {
<br/>
         dmaCopyWords(0,MainScreenBuf-&gt;Pixels,BG_GFX,(SCREEN_WIDTH*SCREEN_HEIGHT) &lt;&lt; 1);
<br/>
         dmaCopyWords(1,SubScreenBuf-&gt;Pixels,BG_GFX_SUB,(SCREEN_WIDTH*SCREEN_HEIGHT) &lt;&lt; 1);
<br/>
         SwapBuffers = false;
<br/>
      }
<br/>
<br/>
      VBLANK_INTR_WAIT_FLAGS |= IRQ_VBLANK; //Signal that vblank interrupt has been processed
<br/>
      REG_IF |= IRQ_VBLANK; //Signal that vblank interrupt processing is done. We need to trigger a write even though this shouldn't change the value.
<br/>
   }
<br/>
   else
<br/>
      REG_IF = REG_IF; //Trigger a write
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
ARM7 is just in a loop fetching system info, it isn't involved in FAT so it's not really important.
<br/>
<br/>
<span style="font-weight: bold">[edit]</span> Well, poo. In my not-quite-awake state of mind I'd forgotten to include one of the headers. ^_^;; For anyone else having problems, all I had to do was copy the gba_nds_fat folder into the libnds include folder (where you'll find nds.h and the nds folder) and include quite a few files in my main header:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#include &lt;gba_nds_fat\io_mpcf.h&gt;
<br/>
#include &lt;gba_nds_fat\io_fcsr.h&gt;
<br/>
#include &lt;gba_nds_fat\io_m3cf.h&gt;
<br/>
#include &lt;gba_nds_fat\io_sccf.h&gt;
<br/>
#include &lt;gba_nds_fat\gba_nds_fat.h&gt;
<br/>
#include &lt;gba_nds_fat\disc_io.h&gt;
<br/>
<br/>
#include &lt;gba_nds_fat\gba_nds_fat.c&gt;
<br/>
#include &lt;gba_nds_fat\disc_io.c&gt;
<br/>
#include &lt;gba_nds_fat\io_mpcf.c&gt;
<br/>
#include &lt;gba_nds_fat\io_fcsr.c&gt;
<br/>
#include &lt;gba_nds_fat\io_m3cf.c&gt;
<br/>
#include &lt;gba_nds_fat\io_sccf.c&gt;</td> </tr></table><span class="postbody">
<br/>
<br/>
One thing I noticed, though, is it killed the volume name! The card used to show up as "LEXAR MEDIA" (the default name I didn't bother to change) in Windows, but now just shows "Removeable Drive" just as if no card were inserted. It works fine, just the name is gone. O_o (Or maybe it's a Windows thing.)
<br/>
<br/>
[edit 2]</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">H:\&gt;vol                           
<br/>
 Volume in drive H is LEXAR MEDIA 
<br/>
 Volume Serial Number is 19D3-1D2F</td> </tr></table><span class="postbody">
<br/>
False alarm. Just Windows being weird again.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#69426 - cory1492 - Mon Jan 30, 2006 7:16 pm</h4>
    <div class="postbody"><span class="postbody">you put the source and headers directly in with your other source code that you are compiling, and #include  "gba_nds_fat.h", you can also use the source line in the makefile to include the gbandsfat dir wherever you put it (instead of dropping source code files in with a pre-compiled ndslib library)
<br/>
<br/>
You could also pre-compile it in a similar way to how ndslib is compiled (see its makefile from cvs) and drop a .a and the .h files into ndslib, otherwise you will keep having to compile the source files (although I dont know why you have to include them).</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#69531 - HyperHacker - Tue Jan 31, 2006 9:25 am</h4>
    <div class="postbody"><span class="postbody">Is it absolutely necessary to copy the files into my source every time? Just leaving them in their own directory in \ndslib seems to have worked fine, and it's a lot cleaner that way. (No having the same files scattered about each source directory, and a lot easier to fix things in them.)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#69562 - FireSlash - Tue Jan 31, 2006 3:19 pm</h4>
    <div class="postbody"><span class="postbody">Yeah, that should work.
<br/>
<br/>
You WILL get weird side effects from using the FAT lib. Files and folders will magically dissapear, volumes will modify themselves, and other strange things are liable to happen. Its probably a good idea to run chkdsk /r every week or so.<br/>_________________<br/><a class="postlink" href="http://www.fireslash.net" target="_blank">FireSlash.net</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#69634 - josath - Tue Jan 31, 2006 9:52 pm</h4>
    <div class="postbody"><span class="postbody">yeah, rain corrupted my CF card once...so basically the FAT lib is very experimental code which is known to corrupt the filesystems. I think as long as you are only reading, it should be safe (someone who knows how it works should say this, dont take my word)</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
