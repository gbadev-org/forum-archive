<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>BoxTest locking up?!? - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > BoxTest locking up?!?</h2>
<div id="posts">
<div class="post">
    <h4>#124407 - 3D_geek - Thu Apr 05, 2007 8:29 pm</h4>
    <div class="postbody"><span class="postbody">I've got a weird problem going on here.  I'm rendering a bunch of objects in 3D - doing a libnds BoxTest() call for each object so I don't draw it if it's off-screen.  Once in a while, BoxTest will lock up and never return (there is a 'while(GFX_STATUS&amp;BIT(0));' loop that it's stuck in).
<br/>
<br/>
Noodling around in the BoxTest source:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
int BoxTest(v16 x, v16 y, v16 z, v16 height, v16 width, v16 depth)
<br/>
{
<br/>
  glPolyFmt(BIT(12) | BIT(13));
<br/>
  glBegin(GL_TRIANGLES);
<br/>
  glEnd();
<br/>
  GFX_BOX_TEST = VERTEX_PACK(x, y);
<br/>
  GFX_BOX_TEST = VERTEX_PACK(z, height);
<br/>
  GFX_BOX_TEST = VERTEX_PACK(width, depth);
<br/>
  while(GFX_STATUS &amp; BIT(0));
<br/>
  return (GFX_STATUS &amp; BIT(1));
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
The 'while' loop is waiting on "BoxTest,PositionTest,VectorTest Busy (0=Ready, 1=Busy)' - which seems reasonable.
<br/>
<br/>
In desperation, I stuck an iprintf into the function to see that the contents of the GFX_STATUS register is immediately after the 'glEnd()' call is usually 0x0600A*0$ (where '*' is 1,2, 3 or 4 and '$' is 0 or 2).  But on the times the call locks up, it's 0x0E00A100.  The difference is in bit 26. which is 'Command FIFO Empty'...so BoxTest locks up when the command FIFO is empty?!?!?
<br/>
<br/>
According to <a href="http://nocash.emubase.de/gbatek.htm#ds3dstatus" target="_blank">http://nocash.emubase.de/gbatek.htm#ds3dstatus</a> bits 24 to 27 are:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
  24   Command FIFO Full (MSB of above)  (0=No, 1=Yes; Full)
<br/>
  25   Command FIFO Less Than Half Full  (0=No, 1=Yes; Less than Half-full)
<br/>
  26   Command FIFO Empty                (0=No, 1=Yes; Empty)
<br/>
  27   Geometry Engine Busy (0=No, 1=Yes; Busy; Commands are executing)
<br/>
</td> </tr></table><span class="postbody">
<br/>
...meaning that when everything works OK, the Geometry engine is busy (not surprising) and the Command FIFO is not full, it is less than half full but it's not empty.  On the occasions the command locks up, the Command FIFO is utterly empty.
<br/>
<br/>
Why this would make it lock up is beyond me....any clues?</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
