<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Heap or stack ? Which size ? - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > Heap or stack ? Which size ?</h2>
<div id="posts">
<div class="post">
    <h4>#149845 - nipil - Fri Jan 25, 2008 11:10 pm</h4>
    <div class="postbody"><span class="postbody">About dynamic memory allocation. I ran into a problem after a debugging session, as i forgot to change one line and the rom crashed in the emulator. It led to allocate 15K of local variables, while the stack is (afaik) 16k. I just thought i could use new/malloc instead of local variable. But i just asked myself where the memory would go... And i wondered if there would be enough room. I happen to remember that on a PC, there are a stack and a heap. stacks is for local variables and arguments, heap for dynamic alloc. Is there any heap on the DS, and which size does it have ? Thanks in advance.
<br/>
PS: both "new" and "malloc" just works with 15k.I'd still be happy to get some explanation on how dynamic alloc this works on the DS ;)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#149851 - Dwedit - Sat Jan 26, 2008 12:06 am</h4>
    <div class="postbody"><span class="postbody">The stack is placed in DTCM (address 0x0b003d00), while the heap is located in main memory, starting after the end of the binary.
<br/>
DTCM is only 16k large.  You can move the stack if you really need to, or just use the heap.<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#149857 - simonjhall - Sat Jan 26, 2008 1:17 am</h4>
    <div class="postbody"><span class="postbody">The heap is the rest of the 4MB that's not taken by your code and static data. This is where new and malloc come from.
<br/>
If you want to find out how much heap you've got (heh) keep allocating memory until it fails!<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#149877 - nipil - Sat Jan 26, 2008 10:28 am</h4>
    <div class="postbody"><span class="postbody">Thanks for the info</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#149976 - PypeBros - Mon Jan 28, 2008 10:51 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>simonjhall wrote:</b></span></td> </tr> <tr> <td class="quote">The heap is the rest of the 4MB that's not taken by your code and static data. This is where new and malloc come from.
<br/>
If you want to find out how much heap you've got (heh) keep allocating memory until it fails!</td> </tr></table><span class="postbody">
<br/>
<br/>
Alternatively, you may get the size of your binary (bss included) using 
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
extern char __text_start; // your very first byte of code (@0x02000000)
<br/>
extern char __bss_end;  // your very last byte of (uninitialized) data
<br/>
<br/>
unsigned avlram=0x04000000 - (unsigned)(&amp;__bss_end - &amp;__text_start);
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Don't take the result for granted: all memory allocation algorithms have overheads. E.g. if it says you have exactly 2MB free, you might be able to allocate 2044 blocks of 1KB, but 2048 blocks will certainly fail.<br/>_________________<br/><a class="postlink" href="http://sylvainhb.blogspot.com/p/sprite-editor.html" target="_blank"> SEDS: Sprite Edition on DS</a> :: <a class="postlink" href="http://sylvainhb.blogspot.com/search/label/modplayer" target="_blank">modplayer</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#149978 - nipil - Mon Jan 28, 2008 11:14 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>PypeBros wrote:</b></span></td> </tr> <tr> <td class="quote">Don't take the result for granted: all memory allocation algorithms have overheads.</td> </tr></table><span class="postbody">Thanks a bunch for this trick. I'll take some 5% out of it to be sure it won't overflow.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#149983 - PypeBros - Mon Jan 28, 2008 12:06 pm</h4>
    <div class="postbody"><span class="postbody">Now, if you want to know the <span style="font-style: italic">current</span> amount of memory available (e.g. even after mallocs have been performed already), you might want to try a call to sbrk(0). I don't know to what extend this one has been ported to the devkit, but that should be the logical place to get the info at runtime.
<br/>
<br/>
<br/>
(from linux manpage)
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
sbrk() increments the program's data space by increment bytes.   sbrk()
<br/>
       isn't  a  system  call, it is just a C library wrapper.  Calling sbrk()
<br/>
       with an increment of 0 can be used to find the current location of  the
<br/>
       program break.
<br/>
</td> </tr></table><span class="postbody"><br/>_________________<br/><a class="postlink" href="http://sylvainhb.blogspot.com/p/sprite-editor.html" target="_blank"> SEDS: Sprite Edition on DS</a> :: <a class="postlink" href="http://sylvainhb.blogspot.com/search/label/modplayer" target="_blank">modplayer</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#149984 - elwing - Mon Jan 28, 2008 12:21 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>PypeBros wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>simonjhall wrote:</b></span></td> </tr> <tr> <td class="quote">The heap is the rest of the 4MB that's not taken by your code and static data. This is where new and malloc come from.
<br/>
If you want to find out how much heap you've got (heh) keep allocating memory until it fails!</td> </tr></table><span class="postbody">
<br/>
<br/>
Alternatively, you may get the size of your binary (bss included) using 
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
extern char __text_start; // your very first byte of code (@0x02000000)
<br/>
extern char __bss_end;  // your very last byte of (uninitialized) data
<br/>
<br/>
unsigned avlram=0x04000000 - (unsigned)(&amp;__bss_end - &amp;__text_start);
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Don't take the result for granted: all memory allocation algorithms have overheads. E.g. if it says you have exactly 2MB free, you might be able to allocate 2044 blocks of 1KB, but 2048 blocks will certainly fail.</span></td> </tr></table><span class="postbody">
<br/>
<br/>
that said, using a divide and conquer recursive algorithm that shouldn't take long to find out the exact amound of memory you can use with simon's method</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
