<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Fixpoint 20:12 overflow mulf32 - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > Fixpoint 20:12 overflow mulf32</h2>
<div id="posts">
<div class="post">
    <h4>#139549 - a128 - Fri Sep 07, 2007 11:55 am</h4>
    <div class="postbody"><span class="postbody">While working on a 3d title.....implementing some collision detection.....wondering why this works with float but not with my fixpoint class....I soon dicovered (and just forgot about it..that this could happen)
<br/>
<br/>
that the mulf32(a,b) could have overflow
<br/>
<br/>
Any cool idea for overflow checks (before the mulf32(a,b) command)?
<br/>
<br/>
I would include this for DEBUG purposes.
<br/>
<br/>
Overflow happens 
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
      
<br/>
   Fixed fDet   = abs(fA00 * fA11 - fA01 * fA01);
<br/>
<br/>
   Fixed u1=(fA01 * fB1); /!!!!overflows
<br/>
/*
<br/>
FA01 and fB1 could have larger values
<br/>
<br/>
because i.e. fA01=x*x+y*y+z*z
<br/>
<br/>
I check for a very big triangle...because I want to reduce my triangle count for collsion mesh
<br/>
*/
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
BTW here is my fixpoint class
<br/>
<br/>
<a class="postlink" href="http://a128.atspace.com/fixpoint.tgz" target="_blank">http://a128.atspace.com/fixpoint.tgz</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#139550 - simonjhall - Fri Sep 07, 2007 12:07 pm</h4>
    <div class="postbody"><span class="postbody">I do the majority of my fixed point multiplies with long longs since I'm not really in control of the data that's coming in (so can't prescale it down).
<br/>
So, like this:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">fixed_point a, b;   //in 19:13 format
<br/>
fixed_point result = (int)(((long long)a * (long long)) &gt;&gt; 13);</td> </tr></table><span class="postbody">
<br/>
Not as fast as it could be, but I never get overflows.<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#139551 - a128 - Fri Sep 07, 2007 12:12 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>simonjhall wrote:</b></span></td> </tr> <tr> <td class="quote">I do the majority of my fixed point multiplies with long longs since I'm not really in control of the data that's coming in (so can't prescale it down).
<br/>
So, like this:
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">fixed_point a, b;   //in 19:13 format
<br/>
fixed_point result = (int)(((long long)a * (long long)) &gt;&gt; 13);</td> </tr></table><span class="postbody">
<br/>
Not as fast as it could be, but I never get overflows.</span></td> </tr></table><span class="postbody">
<br/>
<br/>
In my code example
<br/>
<br/>
a*b means mulf32(a,b)....
<br/>
<br/>
Why you are using 19:13 format? OK, you have more precision on the fraction part..I guess
<br/>
<br/>
But llosing  one bit in the integer part...means you must have sooner overflows then using 20:12
<br/>
<br/>
maybe using 24:8 would be cool.  but 8 bits for fractions?! 
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
from <a href="http://inkbattle.marctenbosch.com/postmortem.html" target="_blank">http://inkbattle.marctenbosch.com/postmortem.html</a>
<br/>
However using fixed point meant that any algorithm used had to contain additional overflow checks, as the maximum number that a 20-12 fixed point number can hold is around 722^2, which is quite an inconvenience when checking for squared distances in pixels between characters for example.</td> </tr></table><span class="postbody"></span><span class="gensmall"><br/><br/>Last edited by a128 on Fri Sep 07, 2007 12:25 pm; edited 2 times in total</span></div>    
</div>
<div class="post">
    <h4>#139553 - simonjhall - Fri Sep 07, 2007 12:24 pm</h4>
    <div class="postbody"><span class="postbody">The reason I use long longs is because you can never be sure how large the two numbers you want to multiply are. You could reduce it to a 31:1 format, but you could still get overflows which you wouldn't get when using floats natively. Hence using larger types, then shifting them down.
<br/>
<br/>
The reason I use 19:13 was because that seemed like a good trade off. This was the point at which stuff stopped going wrong :-)
<br/>
20:12 or 18:14 would have done equally well, but (for example) 25:7 wasn't enough.<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#139554 - a128 - Fri Sep 07, 2007 12:27 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>simonjhall wrote:</b></span></td> </tr> <tr> <td class="quote">The reason I use long longs is because you can never be sure how large the two numbers you want to multiply are. </td> </tr></table><span class="postbody">
<br/>
<br/>
Maybe I miss somethink...
<br/>
<br/>
but I also use long long in that mulf32(a,b) code</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#139556 - simonjhall - Fri Sep 07, 2007 1:04 pm</h4>
    <div class="postbody"><span class="postbody">Ok, with a 20:12 fixed-point format, the largest multiply you can do is 16.0 * 16.0 (or equivalent eg 256.0 * 1.0) since any larger numbers will overflow the multiply.
<br/>
<br/>
Here's why:
<br/>
16.0 in 20:12 is 16 &lt;&lt; 12, which is 65536. Now 65536 * 65536 is 4294967296 - the top end of a 32-bit int.
<br/>
To get the result of the multiply you've then got to right-shift that value by the number of bits you've left shifted by (ie 12 here).
<br/>
So 4294967296 &gt;&gt; 12 = 1048576, which is 256.0 in your 20:12 fixed-point format - the correct answer, with no overflow.
<br/>
<br/>
Now if you do a sum which gives a value greater than 256.0 you'd gonna get overflow. Since you may not know the range of values coming into your multiply function, you may overflow.
<br/>
<br/>
To check for this you could take the significand of the two numbers, muliply them together and check to see if they're greater than ~256. If they are, you could use a less precise fixed-point type for the computation (eg 25:7).
<br/>
Or, to maintain the precision of 20:12 at the expense of a bit of speed you can promote the numbers in the multiplication to 64-bit int types.
<br/>
<br/>
So if you want to do 32.0 * 32.0 you'd do this:
<br/>
32.0 in 20:12 fixed-point is 131072
<br/>
131072 * 131072 = 17179869184 - overflow! This is larger than the 32-bit int type can handle.
<br/>
<br/>
So, do this (long long)131072 * (long long)131072 = 17179869184 (now with no overflow)
<br/>
Then shift it back down,
<br/>
(long long)17179869184 &gt;&gt; 12 = 4194304 - small enough for the 32-bit int type used by your fixed-point class.
<br/>
<br/>
Finally,
<br/>
fixed_point result = 4194304, which is 1024.0 in 20:12, the correct answer to 32.0 * 32.0.
<br/>
<br/>
Does this make any sense or does this look like a mess? ;-)<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#139557 - a128 - Fri Sep 07, 2007 1:19 pm</h4>
    <div class="postbody"><span class="postbody">Thanks a lot
<br/>
<br/>
Now I know what I did wrong 
<br/>
<br/>
when I did this
<br/>
<br/>
class Fixed{
<br/>
<br/>
public: int32 value;
<br/>
<br/>
};
<br/>
<br/>
Fixed = a*a+b*b+c*c
<br/>
<br/>
I called the *-operatoor with mulf32() ..which is a waste of scaling
<br/>
for every a*a ..it did  ((long long)a*(long long)a ) &gt;&gt;12
<br/>
<br/>
now I do
<br/>
<br/>
value= (int32) ( (long long)a.value+(long long)a.value +.....+(long long)c.value*(long long)c.value ) &gt;&gt;12</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
