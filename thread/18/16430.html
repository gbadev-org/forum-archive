<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>EFS black screen loading background [fixed] - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > EFS black screen loading background [fixed]</h2>
<div id="posts">
<div class="post">
    <h4>#166530 - Emmanuel - Mon Feb 09, 2009 1:06 pm</h4>
    <div class="postbody"><span class="postbody">I added this to the EFS example:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">      FILE* gfx;
<br/>
      gfx = fopen("title_back.img.bin", "rb");
<br/>
      size = ftell(gfx); 
<br/>
      i = 0;
<br/>
        while(i &lt; size) {
<br/>
            fread(&amp;buffer[i], 1, 1, gfx);
<br/>
            i++;
<br/>
        }
<br/>
      int bg3 = bgInit(3, BgType_Bmp8, BgSize_B8_256x256, 0,0);
<br/>
      static const int DMA_CHANNEL = 3;
<br/>
      dmaCopyHalfWords(DMA_CHANNEL,
<br/>
                     buffer, /* This variable is generated for us by
<br/>
                                       * grit. */
<br/>
                     (uint8 *)BG_BMP_RAM(0), /* Our address for main
<br/>
                                               /* background 3 */
<br/>
                     size); /* This length (in bytes) is generated
<br/>
                                           /* from grit. */</td> </tr></table><span class="postbody">
<br/>
<br/>
The idea is to load title_back.img.bin from EFS. I know this is messy, but this is my first attempt to load a resource from a FAT or something similar... what's wrong? I get a black screen without even the text when I have the dmaCopy uncommented...
<br/>
<br/>
I added it before the text that tells to press A</span><span class="gensmall"><br/><br/>Last edited by Emmanuel on Tue Feb 10, 2009 3:12 pm; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#166531 - Odorules - Mon Feb 09, 2009 1:21 pm</h4>
    <div class="postbody"><span class="postbody">If you use EFS with the lastest version of libnds it won't work.
<br/>
We've made a fix for this problem : <a href="http://www.dev-fr.org/index.php/topic,4067.0.html" target="_blank">http://www.dev-fr.org/index.php/topic,4067.0.html</a>
<br/>
Or use NitroFS.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#166533 - Emmanuel - Mon Feb 09, 2009 1:39 pm</h4>
    <div class="postbody"><span class="postbody">WOW.... I still can't believe it wasn't my code.... all that I wrote it almost from scratch... but now I see it works...
<br/>
<br/>
ONE IMPORTANT QUESTION: I'm getting the first pixels on the upper left side black! Only those, the rest looks ok... in the emu they look fine, but not on hardware, how do I fix it?
<br/>
<br/>
Well, I just reset my ds and it's not happening anymore...
<br/>
<br/>
One more question: That background is a BMP converted into .bin by grit, but it seems to take some time to load... I see the screen black, then the lower half, and then complete... this "lag" is due to FAT loading speed? 
<br/>
And with this code, I'm loading from FAT, right? not from RAM?
<br/>
I really need to start this project good from it's very foundations... it's actually pretty big</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#166549 - Odorules - Mon Feb 09, 2009 5:31 pm</h4>
    <div class="postbody"><span class="postbody">I'm not sure of what I say but it seems dmaCopy is asynchronous. So the background is drawn while you are filling it.
<br/>
You may use memcpy instead of dmaCopy.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#166551 - Emmanuel - Mon Feb 09, 2009 5:38 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Odorules wrote:</b></span></td> </tr> <tr> <td class="quote">I'm not sure of what I say but it seems dmaCopy is asynchronous. So the background is drawn while you are filling it.
<br/>
You may use memcpy instead of dmaCopy.</td> </tr></table><span class="postbody">
<br/>
<br/>
I searched for memcpy in <a href="http://libnds.devkitpro.org/" target="_blank">http://libnds.devkitpro.org/</a> but didn't found it... so:
<br/>
How does memcpy work? Will I need more intermediate steps? which arguments those it takes?
<br/>
<br/>
And about those black pixels at top left: They are only drawn when I turn the "R" button red in my R4... a weird button in the menu, which I don't know what's for.... but when it's green, the pixels are black...
<br/>
Apart from always turning it red: How could this be fixed?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#166552 - Odorules - Mon Feb 09, 2009 5:49 pm</h4>
    <div class="postbody"><span class="postbody">The "R" buttom activate the reset function of the linker. It allow you to reset the NDS by pressing a some buttons.
<br/>
<br/>
memcpy is well known :)
<br/>
Here is its reference : <a href="http://www.cplusplus.com/reference/clibrary/cstring/memcpy.html" target="_blank">http://www.cplusplus.com/reference/clibrary/cstring/memcpy.html</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#166583 - Emmanuel - Tue Feb 10, 2009 3:11 pm</h4>
    <div class="postbody"><span class="postbody">Now, using memcpy, that error disappeared...
<br/>
<br/>
thanks</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
