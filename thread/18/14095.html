<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Using wrapping textures with non-power of two sizes...pain! - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>DS development > Using wrapping textures with non-power of two sizes...pain!</h2>
<div id="posts">
<div class="post">
    <h4>#139607 - simonjhall - Sat Sep 08, 2007 2:26 am</h4>
    <div class="postbody"><span class="postbody">Some context: it's Quake-on-the-DS again, and I'm trying to make the brush model textures which have non-standard sizes work correctly. The character models have non-po2 textures, but they're handled differently (and correctly).
<br/>
<br/>
In Quake, brush models (eg the world itself and ammo packs, not guns, rockets or players) have their meshes stored as a set of vertices, and the faces to be drawn are extracted from the bsp system at runtime to minimise overdraw etc etc. However to save on memory (I think...) texture co-ordinates are not stored - instead the level designer 'projects' their chosen texture map onto their chosen surface (each surface can have a different texture). This projection (a four-component vector) is then stored per face.
<br/>
<br/>
In order to render a textured surface, the Quake software renderer (and QuakeDS) compute these texture co-ordinates at run time (as in every single frame). GLQuake computes the co-ordinates at load time and store them alongside the vertex info.
<br/>
<br/>
The problem is that there are a few textures - for instance the Quake logo in the entrance hall and the skill level labels on the sides of the three teleporters - that have non-power-of-two sizes. For instance the Quake logo is 288x64. The designers exploit the fact that the software renderer allows texture wrapping, and often the co-ordinates that are generated don't lie in the range 0.0-1.0 - again the Quake logo has one of it's corners at (-1.778, 5).
<br/>
<br/>
So what can I do with this on the DS? I've tried lots of solutions which involve adjusting the UVs to fit into 0.0-1.0, but I can't think of anything which would allow you to draw a quad with co-ords (-0.5, -0.5) (0.5, -0.5) (0.5, 0.5) (-0.5, 0.5).
<br/>
OpenGL won't allow a texture of 288x64, so GLQuake resamples the texture (ie it stretches it) up to 512x64 and when it generates its texture co-ordinates (at load time) it does some divides to make sure the co-ords are correct.
<br/>
<br/>
Does anyone have any suggestions of what I ought to do?
<br/>
Bear in mind,
<br/>
- there's not enough memory to pre-generate texture co-ordinates, so it needs to be done at runtime
<br/>
- textures are loaded from disk on an as-needed basis (ie deferred loading), so any resizing would need to be done per-load or on first-load then stored to disk...
<br/>
<br/>
I'm not a graphics person, so I'm not too familiar with dealing with these sorts of problems :-D<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#139614 - elhobbs - Sat Sep 08, 2007 4:17 am</h4>
    <div class="postbody"><span class="postbody">if all of the non-power of two textures are non-tiling then you can load them by horizontal line into a power of two block so that they are aligned to top and left edge. For the texture coords you can subtract the texturemins from all of the coords after you calculate them. I may be mistaken but the ds does not seam to want the coords from 0 to 1 but rather from 0 to texture width
<br/>
<br/>
this is the code that I use in a surface cache based renderer for the ds where vec is the current vertext
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
      s = DotProduct (vec, fa-&gt;texinfo-&gt;vecs[0]) + fa-&gt;texinfo-&gt;vecs[0][3];
<br/>
      s = s - fa-&gt;texturemins[0];
<br/>
      
<br/>
      t = DotProduct (vec, fa-&gt;texinfo-&gt;vecs[1]) + fa-&gt;texinfo-&gt;vecs[1][3];
<br/>
      t  = t - fa-&gt;texturemins[1];
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#139639 - simonjhall - Sat Sep 08, 2007 2:53 pm</h4>
    <div class="postbody"><span class="postbody">Ok, I just tried it...it almost works, but it has the effect of aligning all textures to the left of the face they're on. So if you had a quad which had tex co-ords (0.5, 0) (1.0, 0) (1.0, 1.0) (0.5, 1.0) it'll draw (0, 0) (0.5, 0) (0.5, 1.0) (0, 1.0) instead since the mins will be (0.5, 0). This has the effect of making the logo in the entrance hall say QuakQ since it's made of two faces :-D
<br/>
<br/>
However it's a good idea though - I should be able to compute some kludge factor at the same time as texturemins[] is computed...hmm...thanks!<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#139644 - elhobbs - Sat Sep 08, 2007 3:07 pm</h4>
    <div class="postbody"><span class="postbody">you may want to just try it without subtracting texturemins to see what happens. the more I think about it I do not think you need to do any divides or compensation for the different texture widths because they are not tiling</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#139661 - simonjhall - Sat Sep 08, 2007 7:02 pm</h4>
    <div class="postbody"><span class="postbody">Ok I think I may have done it, but there are still some textures which exploit wrapping which I can't handle (eg the left and right teleporter in the entrance hall).
<br/>
Basically to generate the co-ordinates correctly (ish) I use the texturemins variable like your said, but when I'm building that variable I shunt it and the maximum texture position up and down by the texture size until it's in the range 0 - 1 (or 0 - width in texels).
<br/>
<br/>
eg,</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">if (next_size_up(tex-&gt;texture-&gt;width) != tex-&gt;texture-&gt;width)
<br/>
   {
<br/>
      int x_shunt = 0;
<br/>
      while (mins[0] + x_shunt &lt; 0)
<br/>
         x_shunt += tex-&gt;texture-&gt;width;
<br/>
      
<br/>
      while (mins[0] + x_shunt &gt; tex-&gt;texture-&gt;width)
<br/>
         x_shunt -= tex-&gt;texture-&gt;width;
<br/>
      
<br/>
      while (maxs[0] + x_shunt &lt; 0)
<br/>
         x_shunt += tex-&gt;texture-&gt;width;
<br/>
      
<br/>
      while (maxs[0] + x_shunt &gt; tex-&gt;texture-&gt;width)
<br/>
         x_shunt -= tex-&gt;texture-&gt;width;
<br/>
      
<br/>
      if ((maxs[0] + x_shunt &gt;= 0) &amp;&amp; (maxs[0] + x_shunt &lt;= tex-&gt;texture-&gt;width)
<br/>
         &amp;&amp; (mins[0] + x_shunt &gt;= 0) &amp;&amp; (mins[0] + x_shunt &lt;= tex-&gt;texture-&gt;width))
<br/>
      {
<br/>
         printf("texture \"%s\" fits ok with x shunt %d\n", tex-&gt;texture-&gt;name, x_shunt);
<br/>
      }
<br/>
      else
<br/>
      {
<br/>
         printf("texture \"%s\" does not fit ok in x\n", tex-&gt;texture-&gt;name, x_shunt);
<br/>
//         while(1);
<br/>
      }
<br/>
      s-&gt;texturemins[0] = x_shunt;
<br/>
   }</td> </tr></table><span class="postbody">
<br/>
This makes the magic shunt factor which is added onto all texture co-ordinates to place them in the correct place (assuming there's no wrapping).
<br/>
<br/>
One less thing left to do :-)<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#139664 - Dood77 - Sat Sep 08, 2007 7:42 pm</h4>
    <div class="postbody"><span class="postbody">Glad to see you're still battling with the old QuakeDS problems... Figured out that one where it forces you to look ahead when you walk a few steps? (Look down, then walk forward without touching the touchscreen.)
<br/>
Also, I tried out that "navy seals" mod that someone around here wanted to know if it would work... It ran, but very slowly, and with the error that a texture is too big. (The gun was untextured, amongst other things.)<br/>_________________<br/>If I use a term wrong or something then feel free to correct, I?m not much of a programmer.
<br/>
<span style="font-size: 9px; line-height: normal">
<br/>
Original DS Phat obtained on day of release + flashme v7
<br/>
Supercard: miniSD, Kingston 1GB, Kingston 2GB
<br/>
Ralink chipset PCI NIC
<br/>
</span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#139679 - simonjhall - Sat Sep 08, 2007 8:58 pm</h4>
    <div class="postbody"><span class="postbody">Was that with the Supercard RAM build or the regular one? If it's the regular one then it could be super low on RAM and swapping in out every frame (like the old days :-)
<br/>
<br/>
I'll have a look into that view flipping thing, and yeah I can replicate it pretty easily although I always thought it was by design...
<br/>
<br/>
EDIT: Yeah, it is by design. When you adjust the viewing angle in Quake and then move it'll flip the view back up after a few feet. If you keep changing the viewing angle whilst walking the view will not flip - and this is what QDS does.
<br/>
GLQuake (for Windows) however does something slightly different when you're using the "use mouse" and +mlook option as the mouse is permenantly telling the game that is moving (regardless of the motion), hence does not flip when you walk. QDS only actually sets the view when you touch the screen, so will not flip if you're touching the screen and walking but will do if you touch then screen, let go then walk a little bit.
<br/>
<br/>
EDIT 2: you still wanna web site it up when I finally finish this?<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#139706 - elhobbs - Sun Sep 09, 2007 2:58 am</h4>
    <div class="postbody"><span class="postbody">thinking about it a little and actually testing it in glquake I think what you need to do is normalize the texture coords. I think this actually produces the correct/usable results
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
      s = DotProduct (vec, fa-&gt;texinfo-&gt;vecs[0]) + fa-&gt;texinfo-&gt;vecs[0][3];
<br/>
      t = DotProduct (vec, fa-&gt;texinfo-&gt;vecs[1]) + fa-&gt;texinfo-&gt;vecs[1][3];
<br/>
      
<br/>
      t /= fa-&gt;texinfo-&gt;texture-&gt;height;
<br/>
      s /= fa-&gt;texinfo-&gt;texture-&gt;width;
<br/>
<br/>
      s -= ((int)fa-&gt;texturemins[0]/(int)fa-&gt;texinfo-&gt;texture-&gt;width);
<br/>
      t -= ((int)fa-&gt;texturemins[1]/(int)fa-&gt;texinfo-&gt;texture-&gt;height);
<br/>
</td> </tr></table><span class="postbody">
<br/>
I am not sure if using ints on the texturemins coords is 100% but it makes all the textures in the start level align correctly</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#139771 - Dood77 - Mon Sep 10, 2007 1:50 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>simonjhall wrote:</b></span></td> </tr> <tr> <td class="quote">Was that with the Supercard RAM build or the regular one? If it's the regular one then it could be super low on RAM and swapping in out every frame (like the old days :-)</td> </tr></table><span class="postbody">
<br/>
It was the RAM build... the maps were kinda big in that game too, plus it really required more buttons than you could access while aiming.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>simonjhall wrote:</b></span></td> </tr> <tr> <td class="quote">EDIT: Yeah, it is by design. When you adjust the viewing angle in Quake and then move it'll flip the view back up after a few feet. If you keep changing the viewing angle whilst walking the view will not flip - and this is what QDS does.
<br/>
GLQuake (for Windows) however does something slightly different when you're using the "use mouse" and +mlook option as the mouse is permenantly telling the game that is moving (regardless of the motion), hence does not flip when you walk. QDS only actually sets the view when you touch the screen, so will not flip if you're touching the screen and walking but will do if you touch then screen, let go then walk a little bit.</td> </tr></table><span class="postbody">
<br/>
Ah, that makes much sense. Suppose you could hack this into an option on the menu? And while we're on the mouse-subject, the mouse speed variable still doesn't work...
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>simonjhall wrote:</b></span></td> </tr> <tr> <td class="quote">EDIT 2: you still wanna web site it up when I finally finish this?</td> </tr></table><span class="postbody">
<br/>
Yeah of course, I tried to do some tricky javascript+php to get the flash menu to look the same and not be flash anymore, and read from an external file to get the menu titles and link locations, but I failed, to say the least. Maybe I'll have another go.<br/>_________________<br/>If I use a term wrong or something then feel free to correct, I?m not much of a programmer.
<br/>
<span style="font-size: 9px; line-height: normal">
<br/>
Original DS Phat obtained on day of release + flashme v7
<br/>
Supercard: miniSD, Kingston 1GB, Kingston 2GB
<br/>
Ralink chipset PCI NIC
<br/>
</span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#139798 - simonjhall - Mon Sep 10, 2007 9:40 am</h4>
    <div class="postbody"><span class="postbody">I'll have a go with that navy seal mod if I can find it. Performance has definately improved since I gave you that build, but playing from the Supercard is still slow. Also if the texture was too big to fit the gun then, it will be still!
<br/>
<br/>
And the mouse sensitivity settings thing is something I turn off in a profile build, so that's probably what I gave you! It's very easy to turn back on...but I must remember to do so!
<br/>
<br/>
BTW: yeah, playing from the Supercard is slow. It gets better from cards where you can crank up the speed (eg M3, Opera, EZ flash) but it's still slower than playing from main memory.<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
