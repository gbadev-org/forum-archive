<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Problem with directory scanning code - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > Problem with directory scanning code</h2>
<div id="posts">
<div class="post">
    <h4>#168706 - Echo49 - Sat May 16, 2009 11:05 am</h4>
    <div class="postbody"><span class="postbody">I'm trying to write some code to scan an entire directory which should be full of subdirectories, and inside those subdirectories are the files I want to have picked up by my code.
<br/>
<br/>
However, this code is failing at the first S_ISDIR statement. Both files and directories are returning 0 when testing with S_ISDIR. I've checked the value of st_mode and it's always 0, with both nitrofs on No$gba and libfat on hardware. Am I calling stat() incorrectly? I pretty much copypasted from the example.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void readDir()
<br/>
{
<br/>
   chdir(/*some directory*/);
<br/>
   
<br/>
   struct stat fileinfo;
<br/>
   
<br/>
   DIR* dir = opendir(".");
<br/>
   struct dirent* entry;
<br/>
   
<br/>
   while ((entry = readdir(dir)) != NULL)
<br/>
   {
<br/>
      //ignore generic names
<br/>
      if (strcmp(entry-&gt;d_name, ".") == 0 || strcmp(entry-&gt;d_name, "..") == 0)
<br/>
         continue;
<br/>
      
<br/>
      //get file info
<br/>
      stat(entry-&gt;d_name, &amp;fileinfo);
<br/>
      
<br/>
      //if this is a folder, find all the files inside
<br/>
      if (S_ISDIR(fileinfo.st_mode))
<br/>
      {
<br/>
         DIR* subdir = opendir(entry-&gt;d_name);
<br/>
         struct dirent* subentry;
<br/>
         
<br/>
         while ((subentry = readdir(subdir)) != NULL)
<br/>
         {
<br/>
            //reuse stat struct
<br/>
            stat(subentry-&gt;d_name, &amp;fileinfo);
<br/>
            
<br/>
            //if this is a file
<br/>
            if (!S_ISDIR(fileinfo.st_mode))
<br/>
            {
<br/>
               char* ext = subentry-&gt;d_name;
<br/>
               
<br/>
               int length = strlen(ext);
<br/>
               if (length &lt; 4)
<br/>
                  continue;
<br/>
               
<br/>
               //ext is now the extension of the current file
<br/>
               ext += length - 4;
<br/>
               
<br/>
               if (strcmp(ext, ".ext") == 0)
<br/>
                  ;//do stuff with this data
<br/>
            }
<br/>
         }
<br/>
         
<br/>
         closedir(subdir);
<br/>
      }
<br/>
   }
<br/>
   
<br/>
   closedir(dir);
<br/>
}
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#168712 - Dwedit - Sat May 16, 2009 5:06 pm</h4>
    <div class="postbody"><span class="postbody">Warning: Some versions of devkitarm have a bug where the Stat struct you allocate is too small compared with what gets written there.  Instant memory corruption.  This bug may have been fixed already.<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#168716 - nanou - Sat May 16, 2009 7:38 pm</h4>
    <div class="postbody"><span class="postbody">You should check the return from stat() to see whether it's working at all. A similar problem came up before where a call to chdir() was needed prior to stat(). At a glance you look like you need it too.
<br/>
<br/>
You might want to try using ftw() instead if it's provided.<br/>_________________<br/>- nanou</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#168721 - Echo49 - Sun May 17, 2009 5:44 am</h4>
    <div class="postbody"><span class="postbody">It seems like emulator+nitrofs isn't processing the stat() call properly (returns -1), but worked fine on hardware+libfat.
<br/>
<br/>
I changed to diropen/dirnext/dirclose which worked fine on emulator BUT crashed on hardware ;.; (crashed on return from the readDir function - seemed to be something to do with dirnext)
<br/>
<br/>
So in the end I used opendir to check whether it is a directory or a file (NULL == file, otherwise dir). Took me 2-3 hours too &gt;.&gt;</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
