<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Audio double buffer problem - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>DS development > Audio double buffer problem</h2>
<div id="posts">
<div class="post">
    <h4>#170258 - Pate - Sun Sep 13, 2009 4:58 pm</h4>
    <div class="postbody"><span class="postbody">Hi!
<br/>
<br/>
I am trying to code some audio stuff, and I followed the excellent guide by Deku at <a href="http://deku.gbadev.org/program/sound1.html" target="_blank">http://deku.gbadev.org/program/sound1.html</a> where I found the table of suitable sample rates and buffer sizes for sound mixing.
<br/>
<br/>
I am using the timer value 64612 with buffer size 304 (18157Hz), but I am still experiencing sync problems.
<br/>
<br/>
I initialize my audio like this:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#define ADLIB_CHANNEL_CR   0x04000420
<br/>
#define   ADLIB_ENABLE       (127+(64&lt;&lt;16)+(1&lt;&lt;29)+(1&lt;&lt;27)+(1&lt;&lt;31))
<br/>
#define   ADLIB_TIMER      64612
<br/>
#define   ADLIB_BUFFER_SAMPLES   (304)
<br/>
#define   ADLIB_BUFFER_SIZE   (2*ADLIB_BUFFER_SAMPLES)
<br/>
<br/>
adlib_buf:
<br/>
   .space   (2*ADLIB_BUFFER_SIZE)
<br/>
<br/>
ldr   lr, =adlib_buf
<br/>
ldr   r1, =ADLIB_TIMER      @ SOUND_FREQ(18157)
<br/>
ldr   r2, =ADLIB_CHANNEL_CR
<br/>
mov   r3, #0
<br/>
mov   r4, #ADLIB_BUFFER_SAMPLES  @ (2 buffers of 2-byte samples)/4
<br/>
@-------
<br/>
@ Channel 0
<br/>
@-------
<br/>
str   lr, [r2, #0x04]      @ SCHANNEL_SOURCE(0) = (int)adlib_buf; 
<br/>
strh   r1, [r2, #0x08]      @ SCHANNEL_TIMER(0) = SOUND_FREQ(18157);
<br/>
strh   r3, [r2, #0x0A]      @ SCHANNEL_REPEAT_POINT(0) = 0;
<br/>
str   r4, [r2, #0x0C]      @ SCHANNEL_LENGTH(0) = length; 
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Then inside VBlank interrupt I start the sound playing, using the two buffers back to back and looping back to start at the end of the second buffer:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#define   ADLIB_ENABLE       (127+(64&lt;&lt;16)+(1&lt;&lt;29)+(1&lt;&lt;27)+(1&lt;&lt;31))
<br/>
<br/>
ldr   r1, =ADLIB_CHANNEL_CR
<br/>
ldr   r2, =ADLIB_ENABLE
<br/>
str   r2, [r1]      @ SCHANNEL_CR(0) = ADLIB_ENABLE;
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Then during every VBlank I swap between the two 304-sample (or 608-byte as I use 16bit audio) buffers where I put the sample values to play.
<br/>
<br/>
The problem I am having is that the system drifts out of sync within a couple of seconds, which causes crackling to the sound, and then again after a few seconds it is back in sync for a few seconds, and so on.
<br/>
<br/>
So, my questions are, is this a correct method for using audio double buffering at all? The guides do not seem to use a looping hardware sound channel, is this my problem? I thought the GBA audio values in Deku's guide are still valid with DS, am I correct here?
<br/>
<br/>
Oh, in case you are wondering, yes, I am trying to make ARM7 emulate an AdLib sound card. Many problems with it yet, but this buffer sync problem is something that I have been fighting with for several days now and can not seem to figure it out.
<br/>
<br/>
Any help appreciated!
<br/>
<br/>
Pate<br/>_________________<br/><ul><li>Now working on DSx86 <a href="http://dsx86.patrickaalto.com" target="_blank">http://dsx86.patrickaalto.com</a>
<br/>
</li><li>Get LineWarsDS from <a href="http://linewars.patrickaalto.com" target="_blank">http://linewars.patrickaalto.com</a></li></ul></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170260 - Ruben - Sun Sep 13, 2009 6:27 pm</h4>
    <div class="postbody"><span class="postbody">The problem here is that the DS refresh rate has no 'good' frequencies available, therefore all will cause crackling when resetting on V-Blank only.
<br/>
I personally would recommend using the hardware channels, unless you absolutely must use software rendering.
<br/>
<br/>
Also, you'd normally use 32768Hz mixing frequency on the DS, as this is the output frequency for the hardware.
<br/>
<br/>
I was going to make a longer post, but I had a brain fart, so if someone else can explain how that works... But if no-one does, I'll post how.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170266 - Pate - Mon Sep 14, 2009 5:06 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Ruben wrote:</b></span></td> </tr> <tr> <td class="quote">The problem here is that the DS refresh rate has no 'good' frequencies available, therefore all will cause crackling when resetting on V-Blank only.</td> </tr></table><span class="postbody">
<br/>
<br/>
Ah, so DS hardware differs from GBA in this case? Ok, that pretty much explains the problem I am having. Seems like I need to sync using a timer instead of VBlank. That should fix the sync problem, am I right?
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">I personally would recommend using the hardware channels, unless you absolutely must use software rendering.</td> </tr></table><span class="postbody">
<br/>
<br/>
I currently use 9 hardware sound channels, one for each AdLib channel. Each AdLib channel has two operators that can either output a sample each (in which case I need to mix these two samples) or operator 1 can be used as input for operator 2 to modify the sample that operator 2 generates.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Also, you'd normally use 32768Hz mixing frequency on the DS, as this is the output frequency for the hardware.</td> </tr></table><span class="postbody">
<br/>
<br/>
I don't think I can afford the CPU cycles that rate would require. Currently my code runs 8 channels fine, and did run 9 channels until I had to add an extra branch for each channel (not even for each sample) after which it started crashing. After some more optimizing it should be able to run 9 channels at 18kHz. Sadly it is still missing some features. The problem is that each operator needs 2 table lookups per sample (so in total 2*2*9 table lookups per sample) in addition to the actual sample output to the buffer.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">I was going to make a longer post, but I had a brain fart, so if someone else can explain how that works... But if no-one does, I'll post how.</td> </tr></table><span class="postbody">
<br/>
<br/>
No problem, many thanks for your reply, you cleared up the main problem I was having, so I think I'll just forget about VBlank syncing.
<br/>
<br/>
Thanks again!
<br/>
<br/>
Pate<br/>_________________<br/><ul><li>Now working on DSx86 <a href="http://dsx86.patrickaalto.com" target="_blank">http://dsx86.patrickaalto.com</a>
<br/>
</li><li>Get LineWarsDS from <a href="http://linewars.patrickaalto.com" target="_blank">http://linewars.patrickaalto.com</a></li></ul></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170270 - Ruben - Mon Sep 14, 2009 9:02 am</h4>
    <div class="postbody"><span class="postbody">Yes, syncing to a timer should get rid of the crackling.
<br/>
Also, if you're not going to mix at 32768Hz because of the speed, then I'd recommend 16384Hz.
<br/>
<br/>
Could you paste the main code here? There may be some minor optimizations I know of.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170271 - sverx - Mon Sep 14, 2009 11:46 am</h4>
    <div class="postbody"><span class="postbody">... btw I would choose to activate looping channels in hardware, so that you won't hear 'clicks' when a channel stops/restarts.
<br/>
<br/>
The DS actual mix freq is ~32.728,5 Hz, according to <a class="postlink" href="http://nocash.emubase.de/gbatek.htm#dssoundchannels015" target="_blank">gbatek</a> so you could have your software mixing routines working at 16.364 Hz .
<br/>
<br/>
If you want to use vblank as a heartbeat then you've got to generate 272,73 samples each time vblank. But I would choose another heartbeat or another software mixing freq, one that is a multiple of 60 Hz ( 273 * 60 = 16380 )
<br/>
<br/>
Of course then your buffer should be twice big and you've got to keep track of odd/even vblanks, but that's the easier part :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170275 - Dwedit - Mon Sep 14, 2009 1:35 pm</h4>
    <div class="postbody"><span class="postbody">The frame rate is not 60.  The frame rate is 59.8261.
<br/>
<br/>
In other words, forget about using Vblank as a heartbeat, and stick to timers.<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170276 - sverx - Mon Sep 14, 2009 2:46 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Dwedit wrote:</b></span></td> </tr> <tr> <td class="quote">The frame rate is not 60.  The frame rate is 59.8261.</td> </tr></table><span class="postbody">
<br/>
<br/>
wow. one can't be sure about anything these days :|</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170277 - Pate - Mon Sep 14, 2009 3:48 pm</h4>
    <div class="postbody"><span class="postbody">Thanks for all the replies!
<br/>
<br/>
I'm trying to sync using a timer, but I'm having problems with that one also. Could you please check if my math is correct?
<br/>
<br/>
I was thinking of shortening the buffers to 256 samples (nice round number) and going to 16384 (or close to that) mixing rate. So the SCHANNEL_TIMER value would be 64512 (65536-1024), correct?
<br/>
<br/>
Next, as the actual timers run at double speed, and I want to have the timer interrupt after every 256 samples, the timer should give an IRQ at approximately 64 times a second (16384/256). To get this rate with a timer, the value should be 65024 (65536-512) with a DIV_1024 timer. Is this correct?
<br/>
<br/>
Sadly I still get heavy crackling with that approach.
<br/>
<br/>
I then tested what happens if I don't use an IRQ but instead spin loop on the timer counter, and that gives a clean tone for a little while, then starts crackling, and then again gives a clean tone for a little while.
<br/>
<br/>
Might be something else wrong with my code, but is my math above correct?
<br/>
<br/>
Thanks again!
<br/>
<br/>
Ps. I'm too embarrassed to show the full source code as it has so many problems, but when I get it to work properly and just need optimizations I'll surely show it to you gurus for optimization tips!
<br/>
<br/>
Pate<br/>_________________<br/><ul><li>Now working on DSx86 <a href="http://dsx86.patrickaalto.com" target="_blank">http://dsx86.patrickaalto.com</a>
<br/>
</li><li>Get LineWarsDS from <a href="http://linewars.patrickaalto.com" target="_blank">http://linewars.patrickaalto.com</a></li></ul></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170278 - Ruben - Mon Sep 14, 2009 4:13 pm</h4>
    <div class="postbody"><span class="postbody">If I am thinking correctly, the hardware timer value should be 0x10000-(16756991/16384) = FC01 = 64513 or around there, so that's fine.
<br/>
<br/>
The next thing to do is to have CPU timer 0 overflow with the same value as the sound timer, and have timer 1 cascade off it, with an overflow of your buffer size. ie...
<br/>
<br/>
Mixing frequency = 16384
<br/>
Buffer size = 512
<br/>
<br/>
Channel[0].Timer = 0x10000-(16756991/Mixing frequency)
<br/>
Channe[0].Mode  = Left(127) + on
<br/>
Channel[1].Timer = 0x10000-(16756991/Mixing frequency)
<br/>
Channe[1].Mode  = Right(127) + on
<br/>
Timer[0].Value     = 0x10000-(16756991/Mixing frequency)
<br/>
Timer[0].Mode     = Timer on
<br/>
Timer[1].Value     = 0x10000 - Buffer size
<br/>
Timer[1].Mode     = Timer on + timer cascade + timer IRQ 
<br/>
<br/>
However, I can't be too sure, as I'm about to pass out (as usual).. but I'm pretty sure I did something similar to that on the GBA.[/code]</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170279 - Pate - Mon Sep 14, 2009 5:41 pm</h4>
    <div class="postbody"><span class="postbody">Ah, silly me, I restarted the timer for every buffer fill loop, so of course it slid out of sync.
<br/>
<br/>
I tried again with a constantly running timer, and now it seems (or rather sounds) like it is almost working. No$GBA still pops slightly about 3-4 times a second (might be just the emulated Windows sound buffer looping and not anything wrong with my code), but real hardware sounds completely different, the pure sine tone has changed into a distorted guitar sound. Like the sound volume overdrives the amplifier or something... Weird.
<br/>
<br/>
Anyways, the actual buffer sync problem seems to be solved, now I just need to improve my implementation of it and start working on fixing the problems in the emulation.
<br/>
<br/>
Thanks again for all your help!
<br/>
<br/>
Pate<br/>_________________<br/><ul><li>Now working on DSx86 <a href="http://dsx86.patrickaalto.com" target="_blank">http://dsx86.patrickaalto.com</a>
<br/>
</li><li>Get LineWarsDS from <a href="http://linewars.patrickaalto.com" target="_blank">http://linewars.patrickaalto.com</a></li></ul></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170280 - Ruben - Tue Sep 15, 2009 12:25 am</h4>
    <div class="postbody"><span class="postbody">The 'popping' on no$ could be related to DMA transfers. I know it bugged me for a really long time before I finally figured out no$ doesn't like DMA transfers at all when playing sound.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170294 - Pate - Wed Sep 16, 2009 6:21 am</h4>
    <div class="postbody"><span class="postbody">Okay, the buffering seems to work rather fine now, thanks again for your help!
<br/>
<br/>
I posted a message on the ASM subforum requesting some optimization tips, as I can only manage 8 channels at 16384Hz with 256-sample buffers, not all 9 channels that I need.
<br/>
<br/>
If you have time to look at it and figure out any optimizations, please do! It is at <a href="http://forum.gbadev.org/viewtopic.php?t=16861" target="_blank">http://forum.gbadev.org/viewtopic.php?t=16861</a>
<br/>
<br/>
Thanks again!
<br/>
<br/>
Pate<br/>_________________<br/><ul><li>Now working on DSx86 <a href="http://dsx86.patrickaalto.com" target="_blank">http://dsx86.patrickaalto.com</a>
<br/>
</li><li>Get LineWarsDS from <a href="http://linewars.patrickaalto.com" target="_blank">http://linewars.patrickaalto.com</a></li></ul></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
