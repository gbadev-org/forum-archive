<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>libfat 1.0.3 and desmume woes - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > libfat 1.0.3 and desmume woes</h2>
<div id="posts">
<div class="post">
    <h4>#165484 - Quirky - Mon Dec 22, 2008 10:18 pm</h4>
    <div class="postbody"><span class="postbody">Has anyone had any luck with the new version of libfat together with the recent versions of desmume? fatInitDefault() returns false for me. I use the --cflash=desmume_disk.image approach for testing stuff.
<br/>
<br/>
I've tried with and without DLDI patching, with the fcsr.dldi, no luck either. On the last libfat release and the same version of the code and same versions of desmume (I've tried r1060, r1157-ish and r1212 from desmume's svn) non-complex use of libfat was ok, i.e. opening files, reading and writing, etc. no directory stuff.
<br/>
<br/>
Is it likely that changes to libfat and/or dkp r24 have broken fat support in desmume?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#165485 - elhobbs - Mon Dec 22, 2008 10:33 pm</h4>
    <div class="postbody"><span class="postbody">desmume emulates a GBAMP. The new libfat no longer has the default drivers builtin so it does require manual dldi patching.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#165486 - Quirky - Mon Dec 22, 2008 10:38 pm</h4>
    <div class="postbody"><span class="postbody">FFS, I've done it again. Seems the solution to all my DS problems is to post here, then I will immediately discover what I've screwed up!!
<br/>
<br/>
After debugging desmume, turned out the address passed to the cflash_read fn was 9000100. "Hmm, odd" I thought, "that's not in the list of setup addresses for GBAMP. GBAMP.... maybe I should use that instead of the flash cart sram dldi". Lo and behold, that fixed the problem.
<br/>
<br/>
So, for the record that's:
<br/>
<br/>
1. Compile the file.nds
<br/>
2. Patch with GBA Movie Player (Compact Flash) from <a class="postlink" href="http://chishm.drunkencoders.com/DLDI/" target="_blank">here</a>: dlditool mpcf.dldi file.nds
<br/>
3. Make a fat image:dd if=/dev/zero of=image bs=1048576 count=128 &amp;&amp; mkdosfs -F16 image &amp;&amp; mount -o loop image mount_point &amp;&amp; cp $files mount_point
<br/>
4. Run emu: desmume --cflash=image file.nds
<br/>
5. ???
<br/>
6. Profit
<br/>
<br/>
edit: thx elhobbs, was writing post v slowly when you replied :-)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#165566 - Quirky - Sun Dec 28, 2008 12:35 am</h4>
    <div class="postbody"><span class="postbody">I've not gone completely senile yet, there's a bug in desmume too. r1196 broke libfat support (I :heart: <a class="postlink" href="http://www.kernel.org/pub/software/scm/git/docs/git-bisect.html" target="_blank">git bisect</a>). In particular, the MMU.cpp file has vital calls to cflash_read and cflash_write <a class="postlink" href="http://desmume.svn.sourceforge.net/viewvc/desmume/trunk/desmume/src/MMU.cpp?annotate=1196#l2807" target="_blank">commented out</a>.
<br/>
<br/>
Luckily the fix is easy! Just <a class="postlink" href="https://sourceforge.net/tracker2/?func=detail&amp;aid=2471938&amp;group_id=164579&amp;atid=832291" target="_blank">remove those #if 0</a> and recompile.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#165575 - shash - Sun Dec 28, 2008 3:31 pm</h4>
    <div class="postbody"><span class="postbody">I just applied a patch that fixed the issue, which was just submitted to our <a class="postlink" href="https://sourceforge.net/tracker2/?func=detail&amp;aid=2471938&amp;group_id=164579&amp;atid=832291" target="_blank">bug database</a>, so it should be ok from SVN as of now :)<br/>_________________<br/><a href="http://shashemudev.blogspot.com" target="_blank">http://shashemudev.blogspot.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#165576 - Quirky - Sun Dec 28, 2008 5:34 pm</h4>
    <div class="postbody"><span class="postbody">Yep, just tried it and works great again.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
