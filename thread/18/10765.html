<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>A Debugger Reborn - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>DS development > A Debugger Reborn</h2>
<div id="posts">
<div class="post">
    <h4>#97660 - masscat - Thu Aug 10, 2006 10:34 pm</h4>
    <div class="postbody"><span class="postbody"><span style="font-weight: bold">EDIT:</span> There is now a <a class="postlink" href="http://masscat.afraid.org/ninds/debug_stub.php" target="_blank">Debug Stub webpage</a>. Check there for the latest release.
<br/>
<br/>
I have put together a quick DS GDB debugger stub after poor Simon Hall <a class="postlink" href="http://forum.gbadev.org/viewtopic.php?t=10657" target="_blank">had to withdraw</a> his. No code from Simon's version is used so avoiding ownership/licensing issues. The message processing code is currently based on the sparc stub from the GDB source but this is public domain (the particular source file - not all the gdb source) so there are no problems there.
<br/>
<br/>
The stub is in its early stages but you can do useful stuff with it. You can get from <a class="postlink" href="http://masscat.afraid.org/ninds/debug_stub.php" target="_blank">here</a>.
<br/>
<br/>
<br/>
What is Supported
<br/>
Only continue, memory read and write and reading the register contents are supported at the moment. Breakpointing is all handled by GDB replacing instructions in the code with undefined instructions (arm code) or breakpoint instruction (thumb code) and therefore causing an exception when these are executed. The stub does not maintain the breakpoints at all.
<br/>
If you try to use unsupported features then the stub will break (this includes stepping code).
<br/>
Since GDB does breakpoints, once you hit a breakpoint you must clear it otherwise when you continue the program it will immediately breakpoint again.
<br/>
<br/>
<br/>
Stub to PC communications
<br/>
The debug stub understands the message GDB sends out/expects back so there is no need for an intermediate translator program.
<br/>
The communications and the debug stub logic are seperate (build into seperate libraries). The communications interface is given to the debug stub at runtime. Therefore you can use whatever mechanism you want for PC to stub comms.
<br/>
I have implemented wireless TCP network comms (using dswifi library - tested with version 0.3a) and my <a class="postlink" href="http://forum.gbadev.org/viewtopic.php?t=10754" target="_blank">SPI/UART bridge serial port</a> comms. The TCP network comms use the Nintendo WFC settings for connecting to the AP and get the IP address.
<br/>
If you want to implement your own comms mechanism have a look at the debug_tcp.c and debug_serial.c files to see two examples.
<br/>
<br/>
<br/>
Setup up
<br/>
You will need a version of GDB that understands an ARM target. You can get one from <a class="postlink" href="http://www.codesourcery.com/gnu_toolchains/arm/download.html" target="_blank">here </a>(the eabi version).
<br/>
<br/>
<br/>
Debugging the Demo App using TCP
<br/>
Put debug_tcp.nds on your DS by some means. This will run and connect to the AP and get an IP and the like. At this point the DS will sit waiting for somebody to connect to it (tcp port 30000 in the demo).
<br/>
GDB will needs the corresponding .elf file to correctly inteprete what the DS stub is telling it. You can do do this on the command line as follows:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">arm-none-eabi-gdb debug_tcp.arm9.elf</td> </tr></table><span class="postbody">
<br/>
GDB will start up and present you a prompt. Now to connect to the DS. To connect over TCP requires a command in the following form:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">target remote ip_addr:port_number</td> </tr></table><span class="postbody">
<br/>
Your DS will have displayed it IP address if the wifi side connected correctly. For my DS and using the demo app I type the following:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">target remote 192.168.12.2:30000</td> </tr></table><span class="postbody">
<br/>
If succesful the DS stub will now be connected to GDB.
<br/>
The demo app immediately causes an exception (calling debugHalt()) jumping into the debug stub. This allows the DS stub and GDB to pass messages and get in sync (without this the GDB could timeout waiting for a response from the stub).
<br/>
You can now do some debugging, remembering the restrictions on what is supported.
<br/>
If the connection is lost for some reason you will have to restart the DS.
<br/>
<br/>
<span style="font-weight: bold">EDIT:</span> Changed tarball link to refer to the website instead.</span><span class="gensmall"><br/><br/>Last edited by masscat on Sat Aug 12, 2006 3:40 pm; edited 2 times in total</span></div>    
</div>
<div class="post">
    <h4>#97703 - DynamicStability - Fri Aug 11, 2006 4:07 am</h4>
    <div class="postbody"><span class="postbody">GO GO GO GO!!!! F' THE CORPORATE MACHINE!!!!!
<br/>
<br/>
Simon, I love you.&lt;/incoherent drunk&gt;<br/>_________________<br/>Framebuffer is dead.
<br/>
DynaStab.DrunkenCoders.com</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#97883 - GPFerror - Sat Aug 12, 2006 3:14 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>masscat wrote:</b></span></td> </tr> <tr> <td class="quote">I have put together a quick DS GDB debugger stub after poor Simon Hall <a class="postlink" href="http://forum.gbadev.org/viewtopic.php?t=10657" target="_blank">had to withdraw</a> his. No code from Simon's version is used so avoiding ownership/licensing issues. The message processing code is currently based on the sparc stub from the GDB source but this is public domain (the particular source file - not all the gdb source) so there are no problems there..</td> </tr></table><span class="postbody">
<br/>
<br/>
Awesome , hopefully will get to test this out soon. Im still looking at the code to figure out how to add it to my projects.
<br/>
<br/>
thanks,
<br/>
Troy(GPF)
<br/>
<a href="http://gpf.dcemu.co.uk" target="_blank">http://gpf.dcemu.co.uk</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#97886 - TheChuckster - Sat Aug 12, 2006 4:21 am</h4>
    <div class="postbody"><span class="postbody">Excellent!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#97915 - masscat - Sat Aug 12, 2006 9:25 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>GPFerror wrote:</b></span></td> </tr> <tr> <td class="quote">Im still looking at the code to figure out how to add it to my projects.</td> </tr></table><span class="postbody">
<br/>
A Quick HowTo:
<br/>
This guide assumes you are using TCP comms.
<br/>
<br/>
Inside the <span style="font-style: italic">debug_lib</span> directory you will find a number of libraries.
<br/>
<ul>libdebugstub9.a - the gdb debugger stub
<br/>
libdebugtcp9.a - the dswifi TCP network comms code
<br/>
libdebugserial9.a - my spi/uart bridge comms code
<br/>
</ul>
<br/>
Copy the first two to somewhere where the linker will search for libraries (your libnds/lib directory will do).
<br/>
Also inside the <span style="font-style: italic">debug_lib</span> directory you will find some header files. Only a few are needed for building debugging into an app.
<br/>
<ul>debug_stub.h - the application facing debug stub function interface.
<br/>
debug_tcp.h - the debug stub TCP comms interface.
<br/>
debug_serial.h - the debug stub spi/uart bridge comms interface.
<br/>
</ul>
<br/>
Copy the first two to somewhere the compile will search for header files (your libnds/include directory will do).
<br/>
<br/>
<span style="font-weight: bold">NOTE:</span> if you are using C++ you will need to change the <span style="font-style: italic">debug_stub.h</span>, enclosing the function prototypes with a extern "C". I always forget to do this as I rarely use C++ but I will include the change in future releases. In the mean time the change is as so:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#ifdef __cplusplus
<br/>
extern "C" {
<br/>
#endif
<br/>
<br/>
/** \brief Calling this function will cause a jump to the debugger.
<br/>
Â */
<br/>
void
<br/>
debugHalt( void);
<br/>
<br/>
<br/>
int
<br/>
init_debug( struct comms_fn_iface_debug *comms_if, void *comms_data);
<br/>
<br/>
#ifdef __cplusplus
<br/>
};
<br/>
#endif</td> </tr></table><span class="postbody">
<br/>
Now to your application.
<br/>
You will need to enable wifi in your ARM7 code (an example is in the arm7 directory).
<br/>
In your ARM9 code include the stub and comms header:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#include &lt;debug_stub.h&gt;
<br/>
#include &lt;debug_tcp.h&gt;</td> </tr></table><span class="postbody">
<br/>
When using TCP comms you must call <span style="font-style: italic">irqInit()</span> before initialising the debug stub.
<br/>
Create and initialise a <span style="font-style: italic">struct tcp_debug_comms_init_data</span> giving the port number to use to listen for GDB connections. Then call the <span style="font-style: italic">init_debug</span> function passing it a pointer to the TCP comm interface structure (<span style="font-style: italic">tcpCommsIf_debug</span> - defined in debug_tcp.h) and a pointer to the <span style="font-style: italic">struct tcp_debug_comms_init_data</span> structure you created earlier. Here is an example using port 30000:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">{
<br/>
Â  struct tcp_debug_comms_init_data init_data = {
<br/>
Â  Â  .port = 30000
<br/>
Â  };
<br/>
Â  if ( !init_debug( &amp;tcpCommsIf_debug, &amp;init_data)) {
<br/>
Â  Â  iprintf("Failed to initialise the debugger stub - cannot continue\n");
<br/>
Â  Â  while(1);
<br/>
Â  }
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
Now call <span style="font-style: italic">debugHalt()</span> to cause your program to jump into the debug stub and allow it to sync up with the GDB debugger.
<br/>
To debug your app follow the instructions given for the demo app in the first post.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#97924 - wintermute - Sat Aug 12, 2006 10:33 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>masscat wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
Stub to PC communications
<br/>
The debug stub understands the message GDB sends out/expects back so there is no need for an intermediate translator program.
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Simon used an intermediate proxy for a very good reason. GDB will request the registers one at a time and also parts of the memory one word at a time. Debugging will be a lot faster than direct communication.
<br/>
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
Setup up
<br/>
You will need a version of GDB that understands an ARM target. You can get one from <a class="postlink" href="http://www.codesourcery.com/gnu_toolchains/arm/download.html" target="_blank">here </a>(the eabi version).
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
There's something wrong with Insight/GDB supplied by devkitPro?<br/>_________________<br/><a class="postlink" href="http://www.devkitpro.org/" target="_blank">devkitPro - professional toolchains at amateur prices</a>
<br/>
<a class="postlink" href="http://wiki.devkitpro.org/index.php/IRC" target="_blank">devkitPro IRC support</a>
<br/>
<a class="postlink" href="http://davejmurphy.com/" target="_blank">Personal Blog</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#97936 - masscat - Sat Aug 12, 2006 1:01 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>wintermute wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>masscat wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
Stub to PC communications
<br/>
The debug stub understands the message GDB sends out/expects back so there is no need for an intermediate translator program.
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Simon used an intermediate proxy for a very good reason. GDB will request the registers one at a time and also parts of the memory one word at a time. Debugging will be a lot faster than direct communication.
<br/>
</span></td> </tr></table><span class="postbody">
<br/>
I personally do not like having an intermediate stage storing the DS state as it creates an opportunity for the two (the DS and the intermediate copy) states to become inconsistant and therefore present the debugger with incorrect information.
<br/>
Also the intermediate stage must be ported to different host OSs inorder for people to use it. Although Simon using Java did remove this problem to some extent, it is not a complete solution. For example the Java serial port API is not available on all platforms.
<br/>
Is speed an issue? I use the debugger through a keyboard interface so would not notice a problem.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>wintermute wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>masscat wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
Setup up
<br/>
You will need a version of GDB that understands an ARM target. You can get one from <a class="postlink" href="http://www.codesourcery.com/gnu_toolchains/arm/download.html" target="_blank">here </a>(the eabi version).
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
There's something wrong with Insight/GDB supplied by devkitPro?</span></td> </tr></table><span class="postbody">
<br/>
<br/>
The GDB information was borrowed from Simon's readme. I am a linux user so did not think about Insight and an arm targeted gdb is not included in devkitarm (is this true and if so will one get put in?). So windows users should be able to use the devkitpro Insight/GDB.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#98057 - DynamicStability - Sat Aug 12, 2006 11:10 pm</h4>
    <div class="postbody"><span class="postbody">I'm definately with masscat on this one.  If it's not too much of a hassle, maybe WinterMute will get around to it.  Would save the linux users some hassles.<br/>_________________<br/>Framebuffer is dead.
<br/>
DynaStab.DrunkenCoders.com</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#98538 - masscat - Tue Aug 15, 2006 9:10 pm</h4>
    <div class="postbody"><span class="postbody">A new development release is on the website:
<br/>
<ul>* Partial stepping - non program counter affecting instructions can be stepped. Thumb branch and pop instructions can be stepped. ARM branch instructions can be stepped.
<br/>
* Corrected r15 value given to GDB - GDB expects the r15 value to be the address of the current instruction not the value as if read from the register.
<br/>
* Avoids some data aborts (and therefore death) when reading/writing memory via GDB - only allows access to addresses above 0x02000000.
<br/>
* Change to directory structure - pre-built libraries and headers are available in the libs and include directories. Debug comms source moved into subdirectories.
<br/>
* Some corrections.
<br/>
</ul></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#98632 - simonjhall - Wed Aug 16, 2006 4:50 pm</h4>
    <div class="postbody"><span class="postbody">Hi guys, I've been outa the action for quite a bit and thought I'd check the boards and I see this! Masscat, well done for what you've done so far. I'm glad someone's writing a (legal) debugger!
<br/>
<br/>
Coming from the "been there, done that" point of view it's really cool too see the challenges that you (and therefore I) had to tackle to get this thing working. Although I still seriously recommend having the proxy program I'd love to see how you get on without one.
<br/>
<br/>
There are plenty of gotchas regarding the GDB protocol, so if you ever want a hand figuring out what's going on, give me a shout and I'll be happy to help. Though you do seem to be doing pretty well so far :-)
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">GO GO GO GO!!!! F' THE CORPORATE MACHINE!!!!! 
<br/>
<br/>
Simon, I love you.&lt;/incoherent drunk&gt;</td> </tr></table><span class="postbody">
<br/>
This made my day.
<br/>
<br/>
And if you're wondering what happened to my debugger, I've since written an emulator (which we're using here at work) and it obviously needs to integrate with a debugger...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#98688 - masscat - Wed Aug 16, 2006 11:53 pm</h4>
    <div class="postbody"><span class="postbody">Simon, good to hear that you have been able to use your debugger work.
<br/>
<br/>
The sparc-stub code from the GDB source provided all the message handling so all I had to do was to get characters into and out of it. It also provides functions for reading the parameters passed with the messages. I did build a stub on my PC initially to look at what GDB sent out and send some test messages back.
<br/>
<br/>
From the look of things the minimum set of commands needed for a useful debugger are g, G, s, c, m and M and I only ever send back S stop messages. All of which have examples of handling in the sparc code.
<br/>
<br/>
At the moment I am leaving breakpointing to GDB (using m and M) which seems to work well (and saves me work) as when combined with stepping means you do not need to clear a breakpoint once hit.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#98753 - simonjhall - Thu Aug 17, 2006 9:21 am</h4>
    <div class="postbody"><span class="postbody">Ah, using an existing stub to figure it out! Now why didn't I think of that?! Just out of interest, how fast does it run? Using the wifi (before I did the caching), whenever I tried to disassemble a function it'd chug massively as all the memory reads were four bytes long. Also, how's the serial interface thing working out?
<br/>
<br/>
And you say that it places breakpoints using m/M - how did you get it to do that? Whenever gdb asked me for breakpoints ("hey Simon, can I have a breakpoint?" "no, gdb, you can't") it'd do it via z0/Z0...
<br/>
<br/>
And talking of signals, have you handled ctrl-c yet? I love the way they design the gdb protocol to have that nice format of $<span style="font-style: italic">message</span>#<span style="font-style: italic">checksum</span> but when gdb sents your target a ctrl-c all you get through is a single byte - 3. Wow.
<br/>
<br/>
In that sparc stub of yours, does it handle of the q packets? I could never find very much documentation for q (in particular, the very first q message you get)...
<br/>
<br/>
I'm really looking forward to checking this out once you've finished it - in particular seeing how the ARM7 thing's gonna work out!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#98754 - masscat - Thu Aug 17, 2006 10:23 am</h4>
    <div class="postbody"><span class="postbody">You can see sparc-stub.c in its original glory <a class="postlink" href="http://sources.redhat.com/cgi-bin/cvsweb.cgi/src/gdb/sparc-stub.c?cvsroot=src" target="_blank">here</a>.
<br/>
And <a class="postlink" href="http://sources.redhat.com/gdb/current/onlinedocs/gdb_33.html#SEC668" target="_blank">here </a> is the most useful documentation I could find for the GDB protocol. I ignore all q messages.
<br/>
<br/>
I found out about letting GDB do the breakpointing by accident. If you ignore the z0/Z0 messages (do not send an OK or error reply - sparc-stub.c does not handle z0/Z0 messages) GDB will use a 'm' message to read the original instruction at the breakpoint address and a 'M' message to replace it with an undefined instructions (arm) or bkpt instruction (thumb). Breakpointing for free!
<br/>
<br/>
The ARM7 should be very similar to the ARM9 just with without the cache flushing. Mighty Max <a class="postlink" href="http://forum.gbadev.org/viewtopic.php?t=10657" target="_blank">posted</a> the ARM7 BIOS expection handler operation which is similar to the ARM9. As for comms with the host PC, my spi/uart bridge should work if I compile it for the ARM7 and I was going to look into using a small stack like  <a class="postlink" href="http://www.sics.se/~adam/uip/" target="_blank">uIP</a> for TCP.
<br/>
<br/>
Ctrl-c is not handled yet (run your code with no breakpoints and it is lost forever). I was thinking of having a peek into the received data in the wifi interrrupt handler and causing a break there is ctrl-c has turned up but this will be a rewrite of the packet handling code so will not happen until the basic debug messages are fully supported.
<br/>
<br/>
Yep, switching to assembly in Insight is slow (lots to 'm' messages). I only noticed this recently as I was using GDB from the command line (or emacs) before. I am not too concerned about this as I beleive most people will use the debugger at source level most of the time which performs fine. I am using assembly view alot at the moment and although chuggy when changing source files it is fine for stepping.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#98912 - simonjhall - Fri Aug 18, 2006 2:07 pm</h4>
    <div class="postbody"><span class="postbody">If you let gdb do the breakpoint thing itself with m, will it allow you to resume from those breakpoints? ie will it replace the break with the original instruction when you hit it? Cos if so, that'd be wick :-) Plus, I assume stepping code was a breeze!
<br/>
<br/>
Regarding the crappy documentation - did the stub show you how to do line stepping of code? Not obvious, I thought!
<br/>
<br/>
And ctrl-c - I never found a good solution for this. If you stop the instant that your comms code detects a stop message then there's always the chance of stopping during a piece of code which you really shouldn't stop in. I was gonna label the elf first with the sections you were allowed to stop in, but that's not an ideal solution. Somebody must have a good answer to this!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#99066 - masscat - Sat Aug 19, 2006 12:54 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>simonjhall wrote:</b></span></td> </tr> <tr> <td class="quote">If you let gdb do the breakpoint thing itself with m, will it allow you to resume from those breakpoints? ie will it replace the break with the original instruction when you hit it? Cos if so, that'd be wick :-) Plus, I assume stepping code was a breeze!
<br/>
<br/>
Regarding the crappy documentation - did the stub show you how to do line stepping of code? Not obvious, I thought!</td> </tr></table><span class="postbody">
<br/>
When gdb is do the breakpointing the first thing it does when the stub sends a Stopped message ('S', 'T' or whatever) is sets all the breakpoints it has inserted back to their original instructions ('M' commands).
<br/>
You can only resume from a breakpoint if stepping is implemented in the stub otherwise you repeatedly hit the breakpoint. If the DS stops at a breakpoint and the user hits continue gdb will send a step command and when the stub responds with the corresponding stop message gdb will replace the orignal breakpoint ('M') and then continue ('c').
<br/>
From my understanding of gdb, it does not know much about the operation of the target instruction set (fair enough as it would require lots of work to support a new processor/target). So gdb cannot do stepping as it does not know where to put a breakpoint to step the assembly instruction.
<br/>
Stepping in the stub is the trickiest bit since the ARM does not have hardware support for it. Stepping is a matter of decoding the instruction, determining if it is going to change the value of R15 and if it does computing the destination address. This is what I am doing at the moment. I have got the thumb covered (there are not that many instuctions that can change R15). In arm mode lots of instructions can change R15 as it is just a general purpose register. So it is a matter of covering them all (not too bad as groups of opcodes have common bit patterns).
<br/>
With stepping implemented, gdb steps lines of C source by sending a step command and then reading the register values from the stub. If the program counter is not at the address of the next C source line then it will repeat until it is.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>simonjhall wrote:</b></span></td> </tr> <tr> <td class="quote">And ctrl-c - I never found a good solution for this. If you stop the instant that your comms code detects a stop message then there's always the chance of stopping during a piece of code which you really shouldn't stop in. I was gonna label the elf first with the sections you were allowed to stop in, but that's not an ideal solution. Somebody must have a good answer to this!</td> </tr></table><span class="postbody">
<br/>
Where ctrl-c causes a break can be controlled assuming that ctrl-c handler is inside the interrupt handler for the comms mechanism. If a ctrl-c turns up whilst the stub is in control (stepping for example) then it is simply ignored. If a ctrl-c turns up whilst the user application is running then the address of the app instruction is given by the irq return address so a break instruction can be put there causing a jump into a debug stub when the irq returns.
<br/>
Now, as you say, this will cause lots of problems if it happens to be something that the stub uses. To solve this I have started hiding these functions (cache flushing) from the application by implementing my own copies. This only leaves iprintf (used for logging) which is not a problem as logging will not be enabled in the release stub. The TCP comms functions are safe as they run at interrupt level.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#100088 - gmiller - Sat Aug 26, 2006 12:59 am</h4>
    <div class="postbody"><span class="postbody">Do any of the emulators for the DS support the GDB connection.  The VisualboyAdvanced SDL emulator has it, but I have not seen this feature in any of the DS emulators.  Of course I have not looked close at them so there may be some support.   I have spent time enhancing the VBA emulator to clean up the GDB support so that my students can use it.  So far it works for everything we have tried.  There is some problems in the emulator with input interupts but other than that is appears clean.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#100096 - GPFerror - Sat Aug 26, 2006 2:45 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>gmiller wrote:</b></span></td> </tr> <tr> <td class="quote">Do any of the emulators for the DS support the GDB connection.  The VisualboyAdvanced SDL emulator has it, but I have not seen this feature in any of the DS emulators.  Of course I have not looked close at them so there may be some support.   I have spent time enhancing the VBA emulator to clean up the GDB support so that my students can use it.  So far it works for everything we have tried.  There is some problems in the emulator with input interupts but other than that is appears clean.</td> </tr></table><span class="postbody">
<br/>
<br/>
not yet.
<br/>
<br/>
I heard no$gba(ds emulator) has a source debugger but i think it cost thousands of dollars for commercial development.
<br/>
<br/>
hopefully as soon as a ds emulator supports wifi, gdb support will either be able to use this debugger or have the support built into the emulator :)
<br/>
<br/>
Troy(GPF)
<br/>
<a href="http://gpf.dcemu.co.uk" target="_blank">http://gpf.dcemu.co.uk</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#100117 - josath - Sat Aug 26, 2006 9:01 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>GPFerror wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
I heard no$gba(ds emulator) has a source debugger but i think it cost thousands of dollars for commercial development.
<br/>
</td> </tr></table><span class="postbody">
<br/>
source level debugging is mainly for gba, and starts at $1750 for single user.
<br/>
<br/>
However, the home shareware version ($15) actually supports loading debug info for arm9 binaries, so it will put function names and stuff in the asm debugger window. 
<br/>
<br/>
I'm not sure, but it may do source debugging in DS mode...you'd have to contact him to find out. But it's aimed at commercial development, not so much hobby or students.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#100138 - gmiller - Sat Aug 26, 2006 2:33 pm</h4>
    <div class="postbody"><span class="postbody">Well source level debugging for the GBA is free with the devkitPro setup and the VisualBoyAdvanced (VBA) emulator.  Actually tracing it in the hardware requires the costs you are talking about.  Since I am just targeting the testing with the emulators (first level testing) I don't thing this should be an issue.  Testing in the hardware is the next step after that but if the emulator is true enough to the hardware then the 2nd step should be one of timing rather than functionality.  I have been running a class in machine architecture and my RISC machine is the GBA so we spend time looking at how you directly manipulate the hardware.  I just got some Gamecube dev kits so I plan to add that for my PowerPC part.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#100916 - masscat - Thu Aug 31, 2006 7:24 pm</h4>
    <div class="postbody"><span class="postbody">New release is out; you can get 20030831 from the <a class="postlink" href="http://masscat.afraid.org/ninds/debug_stub.php#tarballs" target="_blank">webpage</a>.
<br/>
<br/>
Added something a bit different in this release. There is now a monitor .nds application. This sits on the DS and allows GDB to download ARM9 elf files to the DS and debug them. The app being debugged does not need to be aware that it is running under a debugger, although there are a number of restrictions placed upon it. The ARM9 app must also be linked against a special version of libnds, startup code and memory map (see the webpage for more info). This is still experimental so have a play and see what happens.
<br/>
<br/>
You can still compile the debug stub into an application if you wish to use it that way.
<br/>
<br/>
Other changes:
<br/>
<ul>Full stepping of Thumb PC affecting instructions.
<br/>
Stepping ARM LDR/LDM instructions loading the PC.
<br/>
Support setting register values.
<br/>
Some other fixes.</ul></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#101207 - nikarul - Sun Sep 03, 2006 9:31 pm</h4>
    <div class="postbody"><span class="postbody">I'm having some trouble using the debugger with debug_tcp.nds.   I load debug_tcp.nds on my DS via linux wmb, I see the "Debug Test application" output on the screen.  Then I try to connect gdb like so:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">$ arm-eabi-gdb debug_tcp.arm9.elf
<br/>
GNU gdb 6.4
<br/>
Copyright 2005 Free Software Foundation, Inc.
<br/>
GDB is free software, covered by the GNU General Public License, and you are
<br/>
welcome to change it and/or distribute copies of it under certain conditions.
<br/>
Type "show copying" to see the conditions.
<br/>
There is absolutely no warranty for GDB.  Type "show warranty" for details.
<br/>
This GDB was configured as "--host=x86_64-unknown-linux-gnu --target=arm-none-eabi"...
<br/>
(gdb) target remote 192.168.0.186:30000
<br/>
Remote debugging using 192.168.0.186:30000
<br/>
Ignoring packet error, continuing...
<br/>
Ignoring packet error, continuing...
<br/>
Ignoring packet error, continuing...
<br/>
Malformed response to offset query, timeout</td> </tr></table><span class="postbody">
<br/>
<br/>
There is no additional output on the DS.  Originally I was having problems with the firewall on my wireless router but I don't think it is blocking anything now (nothing is being dropped according to the iptables packet counters now).  I'm not sure what the problem might be.  Any ideas?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#101217 - masscat - Sun Sep 03, 2006 10:19 pm</h4>
    <div class="postbody"><span class="postbody">Looks like gdb is connecting at least.
<br/>
<br/>
Make sure you are linking against the latest version of the dswifi library (I am using version 0.3a). Can you successfully use other NDS homebrew that uses dswifi?
<br/>
<br/>
You can get the debug stub to print out some log messages by setting DO_LOGGING when compiling. This can be done by editing the Makefiles in <span style="font-style: italic">debug_lib_src</span> and <span style="font-style: italic">debug_lib_src/tcp_comms</span>. The rule for producing the object files has a comment showing you how to do it. Then rebuild everything (<span style="font-style: italic">make clean</span> followed by <span style="font-style: italic">make</span>).
<br/>
This will print out alot of stuff but should show if the stub is receiving messages correctly from GDB.
<br/>
<br/>
Something else you could try is to use <span style="font-style: italic">monitor_tcp.nds</span> in the monitor directory. This should not make a difference as it is pretty much the same code.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#101281 - nikarul - Mon Sep 04, 2006 4:49 am</h4>
    <div class="postbody"><span class="postbody">Doh, turned out to be something stupid on my end.  The firewall on my linux box was filtering out the reply packets.  Thanks for your help.   It's pretty cool to be able to use GDB with my DS!
<br/>
<br/>
One thing I noticed is that if I tell GDB to continue, pressing A freezes the test app after it prints out that A was pressed.  I noticed there is another debugHalt() there, but GDB never breaks.  Is this the expected behavior?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#101305 - masscat - Mon Sep 04, 2006 9:30 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>nikarul wrote:</b></span></td> </tr> <tr> <td class="quote">One thing I noticed is that if I tell GDB to continue, pressing A freezes the test app after it prints out that A was pressed.  I noticed there is another debugHalt() there, but GDB never breaks.  Is this the expected behavior?</td> </tr></table><span class="postbody">
<br/>
That should cause gdb to come back to the command prompt. Below is a couple of continues and button 'A' presses.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">GNU gdb 6.4.50.20060226-cvs
<br/>
Copyright (C) 2006 Free Software Foundation, Inc.
<br/>
GDB is free software, covered by the GNU General Public License, and you are
<br/>
welcome to change it and/or distribute copies of it under certain conditions.
<br/>
Type "show copying" to see the conditions.
<br/>
There is absolutely no warranty for GDB.Â  Type "show warranty" for details.
<br/>
This GDB was configured as "--host=i686-pc-linux-gnu --target=arm-none-eabi"...
<br/>
(gdb) target remote 192.168.12.2:30000
<br/>
Remote debugging using 192.168.12.2:30000
<br/>
debugHalt () at debug_asm_fns.asm:15
<br/>
15Â  Â  Â  Â  Â  Â  Â  bxÂ  Â  Â  lr
<br/>
Current language:Â  auto; currently asm
<br/>
(gdb) c
<br/>
Continuing.
<br/>
Can't send signals to this remote system.Â  SIGURG not sent.
<br/>
<br/>
Program received signal SIGTRAP, Trace/breakpoint trap.
<br/>
debugHalt () at debug_asm_fns.asm:15
<br/>
15Â  Â  Â  Â  Â  Â  Â  bxÂ  Â  Â  lr
<br/>
(gdb) c
<br/>
Continuing.
<br/>
<br/>
Program received signal SIGTRAP, Trace/breakpoint trap.
<br/>
debugHalt () at debug_asm_fns.asm:15
<br/>
15Â  Â  Â  Â  Â  Â  Â  bxÂ  Â  Â  lr
<br/>
(gdb)</td> </tr></table><span class="postbody">
<br/>
The main reason for the debugHalt call is that it allows the target to be stopped. Breaking a running target from GDB is not currently support.
<br/>
<br/>
A word of warning to any users: debugHalt is not supported in your application if you use the monitor_tcp.nds method. If you do put one in and link against the debug library then your code will get stuck forever of the breakpoint instruction.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#105649 - masscat - Tue Oct 10, 2006 4:02 pm</h4>
    <div class="postbody"><span class="postbody">I have put up another release to the <a class="postlink" href="http://masscat.afraid.org/ninds/debug_stub.php#tarballs" target="_blank">debug stub</a> (release 20061010). There is no added functionality to the stub but the TCP communications has been improved (from about 3-5 KB/s when downloading an elf to monitor_tcp to 20-25 KB/s). This has made the stub much more responsive.
<br/>
A hack to dswifi library is needed (see the website).
<br/>
<br/>
You can get a ready built monitor stub <a class="postlink" href="http://masscat.afraid.org/ninds/debug_files/monitor_tcp.nds.zip" target="_blank">here</a>.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#108062 - GPFerror - Sat Nov 04, 2006 10:27 pm</h4>
    <div class="postbody"><span class="postbody">Pretty cool. Finally got around to testing it out today, arm-eabi-insight connects fine stops at my breakpoint and I can step through my code.
<br/>
<br/>
I used the debug stub since the I read that the ARM9 Monitor won't allow wifi functionality, but I am unable to get wifi to work with the stub, or some other problem before then.
<br/>
<br/>
Debugging is pretty slow between steps, maybe I should use arm-eabi-gdb commandline?
<br/>
<br/>
Also I see something on your site about using ARM9 startup code linkscripts etc, but not quite sure how to move that into my project.
<br/>
<br/>
here is my link line
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
CC = arm-eabi-gcc
<br/>
<br/>
ARCHÂ  Â :=Â  Â -mthumb -mthumb-interwork -march=armv5te -mtune=arm946e-s
<br/>
CFLAGSÂ  = -save-temps -g -Wall -O2\
<br/>
Â Â  Â Â  Â -fomit-frame-pointer\
<br/>
Â  Â Â  Â -ffast-math \
<br/>
Â  Â  $(ARCH) -DARM9Â  -D__NDS__ -I$(DEVKITPRO)/libnds/includeÂ  
<br/>
ASFLAGSÂ  Â :=Â  Â -g -mthumb-interwork
<br/>
LDFLAGS = -specs=ds_arm9.specs -mthumb -mthumb-interwork -mno-fpu -Wl,-Map,$(notdir $*.map)
<br/>
<br/>
CFLAGS += -I$(DEVKITPRO)/libnds/include/pdcurses 
<br/>
LDFLAGS += -L$(DEVKITPRO)/libnds/lib -lfat -lpdcurses -ldebugstub9 -ldebugtcp9 -ldswifid9 -ldebugnds9
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
dswifid9 is the latest wifi lib from cvs with your performance enhancement compiled in.
<br/>
<br/>
Thanks,
<br/>
Troy(GPF)
<br/>
<a href="http://gpf.dcemu.co.uk" target="_blank">http://gpf.dcemu.co.uk</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#108175 - GPFerror - Mon Nov 06, 2006 5:30 am</h4>
    <div class="postbody"><span class="postbody">well it seems a little faster with commandline but i keep getting a sigtrap error in malloc
<br/>
<br/>
here is my output
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
GPF@TDNEWCOMP ~/prj/retawq-0.2.6c
<br/>
$ /c/dev/devkitPro/insight/bin/arm-eabi-gdb.exe arm9/retawq.elf
<br/>
GNU gdb 6.5.0
<br/>
Copyright (C) 2006 Free Software Foundation, Inc.
<br/>
GDB is free software, covered by the GNU General Public License, and you are
<br/>
welcome to change it and/or distribute copies of it under certain conditions.
<br/>
Type "show copying" to see the conditions.
<br/>
There is absolutely no warranty for GDB.Â  Type "show warranty" for details.
<br/>
This GDB was configured as "--host=i686-pc-mingw32 --target=arm-eabi"...
<br/>
(gdb) target remote 192.168.2.11:30000
<br/>
Remote debugging using 192.168.2.11:30000
<br/>
debugHalt () at debug_asm_fns.asm:15
<br/>
15Â  Â  Â  Â  Â  Â  Â  bxÂ  Â  Â  lr
<br/>
Current language:Â  auto; currently asm
<br/>
(gdb) n
<br/>
Can't send signals to this remote system.Â  SIGURG not sent.
<br/>
main (argc=0, argv=0x0) at main.c:7259
<br/>
7259Â  Â  Â  Â  Â  Â  if (!fatInitDefault())
<br/>
Current language:Â  auto; currently c
<br/>
(gdb) break 7267
<br/>
Breakpoint 1 at 0x2009d12: file main.c, line 7267.
<br/>
(gdb) continue
<br/>
Continuing.
<br/>
<br/>
Breakpoint 1, main (argc=0, argv=0x0) at main.c:7267
<br/>
7267Â  Â  Â  initialize(argc, argv);
<br/>
(gdb) break 7289
<br/>
Breakpoint 2 at 0x2009db8: file main.c, line 7289.
<br/>
(gdb) continue
<br/>
Continuing.
<br/>
<br/>
Program received signal SIGTRAP, Trace/breakpoint trap.
<br/>
0x02026c0e in _malloc_r ()
<br/>
(gdb) n
<br/>
Single stepping until exit from function _malloc_r,
<br/>
which has no line number information.
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Any ideas?
<br/>
<br/>
Thanks,
<br/>
Troy(GPF)
<br/>
<a href="http://gpf.dcemu.co.uk" target="_blank">http://gpf.dcemu.co.uk</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#108222 - masscat - Mon Nov 06, 2006 9:28 pm</h4>
    <div class="postbody"><span class="postbody">I am a little confused. Are you trying to debug an application that uses wifi? If so then you cannot do it using either the stub or monitor. The gdb stub/monitor requires exclusive access to the wifi (not true for the stub approach as you maybe able to share the IP/wifi stack but I would not recommend it). If you want to debug a wifi application you will need to build a SPI/UART bridge type thing and use that for debug comms.
<br/>
<br/>
If you are using the GDB stub approach then do not link against libdebugnds9.a supplied in the debugger tarball, link against your normal libnds9.a. Not sure if anything bad will happen but it may do.
<br/>
<br/>
The ARM9 monitor is a little stand alone app that sits on the ARM7 and in the lowest 256Kbytes of the ARM9. When run on the DS it should sit there blinking the power LED. At this point you should be able to connect using GDB. You should also be able to ping the DS.
<br/>
Using this approach does require you to change your linker instructions and link against libdebugnds9.a instead of libnds9.a for the ARM9 code (Makefile.app gives an example for building the test app). You may have to copy ds_debug_arm9_crt0.o out of the build_things directory into your build directory. Also in the build_things directory are the files required by the linker (pointed to by the LDFLAGS in the Makefile.app). You may have to edit ds_debug_arm9.specs to give the correct path in the following lines:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">*link:
<br/>
%(old_link) -L ../build_things -T ds_debug_arm9.ld%s</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#108225 - GPFerror - Mon Nov 06, 2006 9:44 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>masscat wrote:</b></span></td> </tr> <tr> <td class="quote">I am a little confused. Are you trying to debug an application that uses wifi? If so then you cannot do it using either the stub or monitor. The gdb stub/monitor requires exclusive access to the wifi (not true for the stub approach as you maybe able to share the IP/wifi stack but I would not recommend it). If you want to debug a wifi application you will need to build a SPI/UART bridge type thing and use that for debug comms.
<br/>
<br/>
If you are using the GDB stub approach then do not link against libdebugnds9.a supplied in the debugger tarball, link against your normal libnds9.a. Not sure if anything bad will happen but it may do.
<br/>
<br/>
The ARM9 monitor is a little stand alone app that sits on the ARM7 and in the lowest 256Kbytes of the ARM9. When run on the DS it should sit there blinking the power LED. At this point you should be able to connect using GDB. You should also be able to ping the DS.
<br/>
Using this approach does require you to change your linker instructions and link against libdebugnds9.a instead of libnds9.a for the ARM9 code (Makefile.app gives an example for building the test app). You may have to copy ds_debug_arm9_crt0.o out of the build_things directory into your build directory. Also in the build_things directory are the files required by the linker (pointed to by the LDFLAGS in the Makefile.app). You may have to edit ds_debug_arm9.specs to give the correct path in the following lines:
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">*link:
<br/>
%(old_link) -L ../build_things -T ds_debug_arm9.ld%s</td> </tr></table><span class="postbody"></span></td> </tr></table><span class="postbody">
<br/>
<br/>
Yeah I am trying to debug an application that uses wifi with the stub, by trying to share the IP/wifi stack of the stub. 
<br/>
I'll compile it against the normal libnds though.
<br/>
<br/>
Troy(GPF)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#108273 - masscat - Tue Nov 07, 2006 10:25 am</h4>
    <div class="postbody"><span class="postbody">If you are sharing the IP/wifi stack then you may want to give the stack more memory.
<br/>
To do this you will have to edit line ~103 in "debug_lib_src/tcp_comms/debug_tcp.c" in the debugger tarball. Change it from:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">u32 Wifi_pass= Wifi_Init(WIFIINIT_OPTION_USELED|WIFIINIT_OPTION_USEHEAP_64);</td> </tr></table><span class="postbody">
<br/>
to something like:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">u32 Wifi_pass= Wifi_Init(WIFIINIT_OPTION_USELED|WIFIINIT_OPTION_USEHEAP_512);</td> </tr></table><span class="postbody">
<br/>
Note the increase in the heap option.
<br/>
<br/>
All I can recommend for your malloc problem is to single step your code and see if you can isolate the code fragment giving you the crash (may require stepping assembler instructions).
<br/>
Also do a clean build of your app to make sure that the .nds file and the .elf file do correspond to the same binary (unlikely but I have sat there wondering why the debugger was doing strange things until I realised I was using the wrong elf file).
<br/>
Unfortunately it may be a problem in the debugger stub as it is not yet complete.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#108301 - GPFerror - Tue Nov 07, 2006 4:56 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>masscat wrote:</b></span></td> </tr> <tr> <td class="quote">If you are sharing the IP/wifi stack then you may want to give the stack more memory.
<br/>
To do this you will have to edit line ~103 in "debug_lib_src/tcp_comms/debug_tcp.c" in the debugger tarball. Change it from:
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">u32 Wifi_pass= Wifi_Init(WIFIINIT_OPTION_USELED|WIFIINIT_OPTION_USEHEAP_64);</td> </tr></table><span class="postbody">
<br/>
to something like:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">u32 Wifi_pass= Wifi_Init(WIFIINIT_OPTION_USELED|WIFIINIT_OPTION_USEHEAP_512);</td> </tr></table><span class="postbody">
<br/>
Note the increase in the heap option.
<br/>
<br/>
All I can recommend for your malloc problem is to single step your code and see if you can isolate the code fragment giving you the crash (may require stepping assembler instructions).
<br/>
Also do a clean build of your app to make sure that the .nds file and the .elf file do correspond to the same binary (unlikely but I have sat there wondering why the debugger was doing strange things until I realised I was using the wrong elf file).
<br/>
Unfortunately it may be a problem in the debugger stub as it is not yet complete.</span></td> </tr></table><span class="postbody">
<br/>
<br/>
Yeah thats what I did last night, and I also recompiled with more debugging options to see if that would help.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
CC = arm-eabi-gcc
<br/>
<br/>
<br/>
ARCHÂ  Â :=Â  Â -mthumb -mthumb-interwork -march=armv5te -mtune=arm946e-s
<br/>
CFLAGSÂ  = -save-temps -Wall -g3 -O0 -fno-eliminate-unused-debug-types \
<br/>
Â Â  Â Â  Â Â  Â  $(ARCH) -DARM9Â  -D__NDS__ -I$(DEVKITPRO)/libnds/include
<br/>
ASFLAGSÂ  Â :=Â  Â -g -mthumb-interwork
<br/>
LDFLAGS = -specs=ds_arm9.specs -mthumb -mthumb-interwork -mno-fpu -Wl,-Map,$(notdir $*.map)
<br/>
<br/>
<br/>
# add include and link paths for ncurses in dslinux
<br/>
CFLAGS += -I$(DEVKITPRO)/libnds/include/pdcurses 
<br/>
<br/>
ifeq ($(GDB), 1)
<br/>
CFLAGS +=-DGDB
<br/>
LDFLAGS += -L$(DEVKITPRO)/libnds/lib -lfat -lpdcurses -ldebugstub9 -ldebugtcp9 -ldswifid9 -lnds9
<br/>
else
<br/>
LDFLAGS += -L$(DEVKITPRO)/libnds/lib -lfat -lpdcursesÂ  Â -ldswifi9dÂ  -lnds9
<br/>
endif
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
But I think I have identified the code thats calling malloc thats causing the problem, thanks to your debugger :) Now to figure out why its crashing there, probably an alignment issue in the struct its trying to allocate memory for or some other wierd problem.
<br/>
<br/>
Thanks for your help and for your gdb debugging tool.
<br/>
<br/>
Troy(GPF)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#108456 - GPFerror - Thu Nov 09, 2006 12:19 am</h4>
    <div class="postbody"><span class="postbody">well the malloc code doesn't appear to be the problem, unless I try to step through it, and works fine in at -O2 when not debugging.
<br/>
<br/>
Maybe gdb is firing an interupt during the malloc call and since malloc isn't thread safe, maybe thats the issue?
<br/>
<br/>
Still awesome to be able to use wifi gdb debugging, maybe one day I can build that serial cable you have on your site, or maybe one of the other serial options? Be nice if I could take my old m3 passme1 or the neoflash mk2 and add a serial cable to either :)
<br/>
<br/>
Thanks,
<br/>
Troy(GPF)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#108487 - masscat - Thu Nov 09, 2006 1:36 pm</h4>
    <div class="postbody"><span class="postbody">Just been playing around stepping through malloc myself and the debugger stub does appear to get itself into a strange state. I will have a look into it.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#108583 - GPFerror - Fri Nov 10, 2006 7:13 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>masscat wrote:</b></span></td> </tr> <tr> <td class="quote">Just been playing around stepping through malloc myself and the debugger stub does appear to get itself into a strange state. I will have a look into it.</td> </tr></table><span class="postbody">
<br/>
<br/>
Great I hope you figure it out :)
<br/>
<br/>
Troy</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#114045 - ApM - Wed Jan 03, 2007 4:50 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>masscat wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>nikarul wrote:</b></span></td> </tr> <tr> <td class="quote">One thing I noticed is that if I tell GDB to continue, pressing A freezes the test app after it prints out that A was pressed.  I noticed there is another debugHalt() there, but GDB never breaks.  Is this the expected behavior?</td> </tr></table><span class="postbody">
<br/>
That should cause gdb to come back to the command prompt. Below is a couple of continues and button 'A' presses.</span></td> </tr></table><span class="postbody">
<br/>
Just a quick post to say that I'm seeing this behaviour with the latest debug stub, compiled against dswifi v0.3b (both with and without buffering hack) with devkitARM 19b, using the latest release of gdb, v6.6.  I tried gdb v6.5 as well to no success.
<br/>
<br/>
I tried rebuilding with DO_LOGGING enabled, and after manually placing the libs in the libs/ directory, the logging works, but the DS crashes in debugHalt after GDB connects in init_debug, eventually timing out GDB.
<br/>
<br/>
The prebuilt monitor stub seems to work correctly, though, so I guess I'll use that.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#130635 - dovoto - Wed Jun 06, 2007 12:39 am</h4>
    <div class="postbody"><span class="postbody">Is this project abandoned?
<br/>
<br/>
I am trying to build the source for r20 and add a stub for ds serial but the source does not compile for me.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
<br/>
C:\devkitpro\insight\Debug_20061010\debug_lib_src&gt;make
<br/>
arm_opcode.c
<br/>
arm-eabi-gcc -MMD -MP -MF /c/devkitpro/insight/Debug_20061010/debug_lib_src/build/arm_opcode.d -DARM9 -g -Wall -O2 -march=armv5te -mtune=arm946e-s -fomit-frame-
<br/>
pointer -ffast-math -mthumb -mthumb-interwork -I/c/devkitpro/insight/Debug_20061010/debug_lib_src/include -I/c/devkitPro/libnds/include -I/c/devkitpro/insight/D
<br/>
ebug_20061010/debug_lib_src/buildÂ  -c /c/devkitpro/insight/Debug_20061010/debug_lib_src/source/arm_opcode.c -o arm_opcode.o
<br/>
c:/devkitpro/insight/Debug_20061010/debug_lib_src/source/arm_opcode.c: In function 'arm_ADD_jump':
<br/>
c:/devkitpro/insight/Debug_20061010/debug_lib_src/source/arm_opcode.c:281: warning: unused variable 'Rn_reg'
<br/>
c:/devkitpro/insight/Debug_20061010/debug_lib_src/source/arm_opcode.c: At top level:
<br/>
c:/devkitpro/insight/Debug_20061010/debug_lib_src/source/arm_opcode.c:21: warning: 'getSP' defined but not used
<br/>
breakpoints.c
<br/>
arm-eabi-gcc -MMD -MP -MF /c/devkitpro/insight/Debug_20061010/debug_lib_src/build/breakpoints.d -DARM9 -g -Wall -O2 -march=armv5te -mtune=arm946e-s -fomit-frame
<br/>
-pointer -ffast-math -mthumb -mthumb-interwork -I/c/devkitpro/insight/Debug_20061010/debug_lib_src/include -I/c/devkitPro/libnds/include -I/c/devkitpro/insight/
<br/>
Debug_20061010/debug_lib_src/buildÂ  -c /c/devkitpro/insight/Debug_20061010/debug_lib_src/source/breakpoints.c -o breakpoints.o
<br/>
debug_stub.c
<br/>
arm-eabi-gcc -MMD -MP -MF /c/devkitpro/insight/Debug_20061010/debug_lib_src/build/debug_stub.d -DARM9 -g -Wall -O2 -march=armv5te -mtune=arm946e-s -fomit-frame-
<br/>
pointer -ffast-math -mthumb -mthumb-interwork -I/c/devkitpro/insight/Debug_20061010/debug_lib_src/include -I/c/devkitPro/libnds/include -I/c/devkitpro/insight/D
<br/>
ebug_20061010/debug_lib_src/buildÂ  -c /c/devkitpro/insight/Debug_20061010/debug_lib_src/source/debug_stub.c -o debug_stub.o
<br/>
F:/DOCUME~1/ADMINI~1/LOCALS~1/Temp/ccO9XKeO.s: Assembler messages:
<br/>
F:/DOCUME~1/ADMINI~1/LOCALS~1/Temp/ccO9XKeO.s:2010: Error: Thumb load/store multiple does not support {reglist}^ -- `ldmia r5,{r0-r12,pc}^'
<br/>
make[1]: *** [debug_stub.o] Error 1
<br/>
make: *** [build] Error 2
<br/>
<br/>
C:\devkitpro\insight\Debug_20061010\debug_lib_src&gt;
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
This seems to be caused by line 742 of the debug_stub.c
<br/>
<br/>
I am using the libnds library template makefile (modified to find libnds includes) to build the project.<br/>_________________<br/><a href="http://www.drunkencoders.com" target="_blank">www.drunkencoders.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#130668 - masscat - Wed Jun 06, 2007 12:21 pm</h4>
    <div class="postbody"><span class="postbody">It is not abandoned (at least not forgotten) but I have not worked on it for quite some time.
<br/>
<br/>
I have been working on the Desmume emulator (among other things). One idea is to use Desmume to debug the on hardware debug stub (although it is not in a position to do this yet) as debugging the stub on hardware is not much fun.
<br/>
<br/>
Your compiling problem is because you are compiling to the thumb instruction set (note the -mthumb on the command line) and the debug_stub.c source has inline ARM only assembler instructions in it (hence the assembler moaning). Remove the -mthumb from the Makefile (leave the -mthumb-interwork though) and the code should compile.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#130694 - dovoto - Wed Jun 06, 2007 7:35 pm</h4>
    <div class="postbody"><span class="postbody">Ahh..okay.  I have it building now (Although i changed the build process a bit) and added a ds serial comm interface (dont have a usb&lt;-&gt;serial port to test with at the moment).
<br/>
<br/>
I get the following warnings and was hoping you can tell me if they are expected:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
<br/>
c /c/devkitpro/libdebug/source/arm_opcode.arm.c -o arm_opcode.arm.o
<br/>
c:/devkitpro/libdebug/source/arm_opcode.arm.c: In function 'arm_ADD_jump':
<br/>
c:/devkitpro/libdebug/source/arm_opcode.arm.c:281: warning: unused variable 'Rn_reg'
<br/>
c:/devkitpro/libdebug/source/arm_opcode.arm.c: At top level:
<br/>
c:/devkitpro/libdebug/source/arm_opcode.arm.c:21: warning: 'getSP' defined but not used
<br/>
<br/>
c:/devkitpro/libdebug/source/thumb_instr.c: In function 'thumb_condB':
<br/>
c:/devkitpro/libdebug/source/thumb_instr.c:34: warning: implicit declaration of function 'condition_check'
<br/>
c:/devkitpro/libdebug/source/thumb_instr.c: At top level:
<br/>
c:/devkitpro/libdebug/source/thumb_instr.c:23: warning: 'thumb_condB' defined but not used
<br/>
c:/devkitpro/libdebug/source/thumb_instr.c:45: warning: 'thumb_condB_jump' defined but not used
<br/>
c:/devkitpro/libdebug/source/thumb_instr.c:66: warning: 'thumb_B_jump' defined but not used
<br/>
c:/devkitpro/libdebug/source/thumb_instr.c:91: warning: 'thumb_BL_BLX1_jump' defined but not used
<br/>
c:/devkitpro/libdebug/source/thumb_instr.c:116: warning: 'thumb_BX_BLX2_jump' defined but not used
<br/>
c:/devkitpro/libdebug/source/thumb_instr.c:133: warning: 'thumb_POP_jump' defined but not used
<br/>
c /c/devkitpro/libdebug/tcp_comms/debug_tcp.c -o debug_tcp.o
<br/>
c:/devkitpro/libdebug/tcp_comms/debug_tcp.c: In function 'init_fn':
<br/>
c:/devkitpro/libdebug/tcp_comms/debug_tcp.c:136: warning: unused variable 'ip_addr'
<br/>
<br/>
C:\devkitpro\libdebug&gt;
<br/>
</td> </tr></table><span class="postbody"><br/>_________________<br/><a href="http://www.drunkencoders.com" target="_blank">www.drunkencoders.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#130701 - masscat - Wed Jun 06, 2007 8:21 pm</h4>
    <div class="postbody"><span class="postbody">Most of the warnings are nothing to worry about.
<br/>
<br/>
The thumb_instr.c file is not needed and can be removed. What it did is now done in the thumb_opcode.c file (I appear to have left thumb_instr.c lying around for no good reason).
<br/>
<br/>
The variable ip_addr in debug_tcp.c and function getSP in arm_opcode.c are only used if logging is enabled.
<br/>
<br/>
<br/>
The unused Rn_reg warning in the arm_ADD_jump function is the only warning of concern. It looks like I never completed the function to calculate the destination address for ARM ADD instructions.
<br/>
As I recall I have not implemented stepping for all the PC affecting ARM instructions so you will not be able to step these.
<br/>
<br/>
<br/>
Somebody else was trying to get the <a class="postlink" href="http://forum.gbadev.org/viewtopic.php?t=13157" target="_blank">stub working with DSerial2</a>.
<br/>
<br/>
<span style="font-weight: bold">Note:</span> I have encountered problems, whilst using the GDB stub in Desmume, stepping assembler instruction using GDB/Insight earlier than version 6.6 (see <a class="postlink" href="http://forums.desmume.org/viewtopic.php?id=85" target="_blank">here</a>). This appears to be a bug in GDB/Insight so I would recommend using the latest version if possible.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#130942 - masscat - Sat Jun 09, 2007 1:51 pm</h4>
    <div class="postbody"><span class="postbody">Quoting from <a class="postlink" href="http://forum.gbadev.org/viewtopic.php?p=130904#130904" target="_blank">Debugging with GDB/Insight with masscat's stub and DSerial2</a> thread.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>wintermute wrote:</b></span></td> </tr> <tr> <td class="quote">This also seems to work quite well with the current Insight build provided by devkitPro with the minor caveat that you'll need to set up the initial connection using the console window rather than the target settings dialog. I have a build of 6.6 which will work as expected and I'll release that after a little more testing.
<br/>
<br/>
Masscat, if you're interested I'd like to offer the debug stub as a devkitPro module downloadable via the installer as per libnds, dswifi etc. Obviously I'd prefer the standardized format Dovoto used to build your code so that it fits in with the rest of the libraries. I can add an install target &amp; give you CVS access if you're up for maintaining the lib as part of devkitPro.</td> </tr></table><span class="postbody">
<br/>
Would it be possible to include an ARM targeted build of GDB (not necessarily Insight) in the Linux (and Windows?) build of devkitarm?
<br/>
<br/>
I am up for putting and maintaining the stub under the devkitpro CVS.
<br/>
<br/>
A couple of things beforehand though.
<br/>
I think the library should be renamed to libgdbstub as I feel the libdebug name is a bit of a misnomer.
<br/>
The comms interface code should be separated from the stub code, i.e. the TCP and DSerial code is not built into the libgdbstub library. Although this does require the user to link against an additional library it removes the dependence on external libraries (dswifi, dserial etc) for users that do not need them. It also allows additions comms interfaces to be added without changing/recompiling the GDB stub library.
<br/>
<br/>
So a directory structure like:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">libgdbstub
<br/>
\-libs
<br/>
Â  \-libgdbstub.a
<br/>
Â  Â  libgdbstub_tcp.a
<br/>
Â  Â  libgdbstub_dserial.a
<br/>
\-include
<br/>
Â  \-gbdstub.h
<br/>
Â  Â  gdbstub_tcp.h
<br/>
Â  Â  gdbstub_dserial.h
<br/>
\-source
<br/>
Â  \-(the GDB stub source goes here)
<br/>
\-comms
<br/>
Â  \-libgdbstub_tcp
<br/>
Â  Â  \-source
<br/>
Â  Â  Â  (source for tcp comms code goes under this directory)
<br/>
Â  \-(directories for other comms libraries)
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I am happy to use Makefiles similar to those made by Dovoto. I will put together the library with the above structure and post it for your review and if you are happy then use that as the initial CVS code. Any comments on this layout?
<br/>
<br/>
Some thoughts for the future:
<br/>
The stub should be adaptable to the GBA too as it would be similar to the ARM7 on the DS.
<br/>
<br/>
<span style="font-weight: bold">EDIT:</span> Some more admin stuff:
<br/>
The GDB stub code will/is released as public domain (i.e. no copyright, do whatever you want to do with it). As is the TCP and SPI/UART bridge comms code.
<br/>
Dovoto, what license do you want the DSerial comms code to be released under? I am not including the libdserial code in this just the GDB stub comms code (the contents of debug_ds_serial.c).
<br/>
<br/>
<span style="font-weight: bold">EDIT2:</span>
<br/>
Currently the firmware for the DSerial device is compiled into its comms library. The firmware and its size could be passed in using the data pointer passed into the comms initialisation function (similar to the port number being passed into the TCP comms initialisation).
<br/>
I would prefer the pass in approach as it allows for firmware changes without requiring a comms library recompile. Any thoughts/comments?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#131049 - masscat - Sun Jun 10, 2007 4:09 pm</h4>
    <div class="postbody"><span class="postbody">I have put together the restructured GDB stub source (<a class="postlink" href="http://masscat.afraid.org/ninds/tars/libgdbstub_20070611.tar.bz2" target="_blank">libgdbstub_20070611.tar.bz2</a>).
<br/>
<br/>
Things of note:
<br/>
<ul><li>I am waiting for dovote to get back to me on what copyright/license notice he wants on the DSerial comms source. Rest of the source files include a no copyright/public domain notice. <span style="font-weight: bold">note:</span> DSerial comms source now has same no copyright/public domain notice.
<br/>
</li><li>I have moved the DSerial firmware out of the comms library as described in previous post. Example application shows how to use this.
<br/>
</li><li>The comms libraries compile separately as described in previous post.
<br/>
</li><li>The library is now called libgdbstub.a. The comms libraries are libgdbstub_tcp.a etc.
<br/>
</li><li>The functions interface to the stub are now consistently named functionName_gdbstub().
<br/>
</li><li>Makefiles as similar to dovote's ones (changes due to separation of comms mechanisms).
<br/>
</li><li>Reinstated the SPI/UART bridge mechanism (for historical reasons more than anything else).
<br/>
</li><li>Moved all external library stuff out. No dswifi, DSerial and spiUART headers, libraries or source is included and must be provided externally.</li></ul>
<br/>
I have tested the TCP example and the stub functions as it has previously.
<br/>
Can somebody test the DSerial example?
<br/>
<br/>
I am happy with the above layout and code and think it would be a good starting point for the initial devkitpro CVS (with the addition of dovote's copyright notice and confirmation that the DSerial example works). So, wintermute, can you review the structure/code and make any suggestion/changes that you feel necessary.
<br/>
<br/>
<span style="font-weight: bold">EDIT:</span> Changed link to tarball with public domain notice in DSerial comms code (no other changes).</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#131299 - wintermute - Thu Jun 14, 2007 1:28 am</h4>
    <div class="postbody"><span class="postbody">Sorry to take so long getting around to looking at this - been a bit busy of late. I still haven't had a chance to have a good look but most of it seems fine, just a couple of niggles.
<br/>
<br/>
Examples should probably be entirely separate - for inclusion in the libnds examples.
<br/>
<br/>
I'm not entirely sure about having multiple libraries for different comms code - there's no real gain by doing things this way. If the comms code is in it's own object it won't be linked if it isn't used.
<br/>
<br/>
I've pretty much decided that the libnds directory within devkitPro should be for devkitPro sanctioned DS libraries and extra environment variables for different libraries is a bit overkill. Just have an install target &amp; shove them in $(LIBNDS).
<br/>
<br/>
More later, I'll get around to tweaking a bit in a couple of days.
<br/>
<br/>
I've looked into adding gdb to the default toolchain scripts which looks doable, just need to test on a couple of other platforms but I don't envisage any major problems with the vanilla gdb.
<br/>
<br/>
I have Insight 6.6. running here as well so I'm hoping to add that to the installer in the next couple of weeks.<br/>_________________<br/><a class="postlink" href="http://www.devkitpro.org/" target="_blank">devkitPro - professional toolchains at amateur prices</a>
<br/>
<a class="postlink" href="http://wiki.devkitpro.org/index.php/IRC" target="_blank">devkitPro IRC support</a>
<br/>
<a class="postlink" href="http://davejmurphy.com/" target="_blank">Personal Blog</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#131349 - masscat - Thu Jun 14, 2007 4:21 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>wintermute wrote:</b></span></td> </tr> <tr> <td class="quote">Examples should probably be entirely separate - for inclusion in the libnds examples.</td> </tr></table><span class="postbody">
<br/>
I will move the examples out and then place them in a directory "gdbstub" which could then live under the /examples/nds/ directory of the devkitpro CVS.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">I'm not entirely sure about having multiple libraries for different comms code - there's no real gain by doing things this way. If the comms code is in it's own object it won't be linked if it isn't used.</td> </tr></table><span class="postbody">
<br/>
In my opinion the comms implementations do not form part of the GDB stub library but have a similar relationship to that of a networking stack and NIC driver.
<br/>
The separation of the comms and stub code allows them to change without affecting the version of the others (as long as the comms inteface is not changed). For example a bug fix in the TCP comms code should not result in a version change (and new release) of the stub library.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">I've pretty much decided that the libnds directory within devkitPro should be for devkitPro sanctioned DS libraries and extra environment variables for different libraries is a bit overkill. Just have an install target &amp; shove them in $(LIBNDS).</td> </tr></table><span class="postbody">
<br/>
The library directory layout is just how I have my environment set up (allows me to easily change library versions using symbolic links), happy to use $(LIBNDS) though.
<br/>
<br/>
Good to hear about GDB builds.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#131828 - wintermute - Wed Jun 20, 2007 3:13 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>masscat wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
I will move the examples out and then place them in a directory "gdbstub" which could then live under the /examples/nds/ directory of the devkitpro CVS.
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Excellent :)
<br/>
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
In my opinion the comms implementations do not form part of the GDB stub library but have a similar relationship to that of a networking stack and NIC driver.
<br/>
The separation of the comms and stub code allows them to change without affecting the version of the others (as long as the comms inteface is not changed). For example a bug fix in the TCP comms code should not result in a version change (and new release) of the stub library.</td> </tr></table><span class="postbody">
<br/>
<br/>
I see what you're saying but this would add complexity to the installer. It's much easier to have everything under one component than to have 3 or more components where one would do. Admittedly separation would make for easier testing and updating. I do have some work in progress on the installer which may make it easier to extend the components though so it's worth thinking about some more.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
The library directory layout is just how I have my environment set up (allows me to easily change library versions using symbolic links), happy to use $(LIBNDS) though.
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Yeah, that's fair enough, it just strikes me that the logical conclusion of separate environment variables for multiple libraries could become quite unmanageble.
<br/>
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
Good to hear about GDB builds.</td> </tr></table><span class="postbody">
<br/>
<br/>
Yeah, I've been getting a lot of requests for this and the Insight builds I do at present are windows only.<br/>_________________<br/><a class="postlink" href="http://www.devkitpro.org/" target="_blank">devkitPro - professional toolchains at amateur prices</a>
<br/>
<a class="postlink" href="http://wiki.devkitpro.org/index.php/IRC" target="_blank">devkitPro IRC support</a>
<br/>
<a class="postlink" href="http://davejmurphy.com/" target="_blank">Personal Blog</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#131867 - koryspansel - Wed Jun 20, 2007 9:10 pm</h4>
    <div class="postbody"><span class="postbody">No gdb console output?  Besides being able to step code, one of the big advantages, for me, is being able to output trace messages without wasting a background or even having to code with the console in mind.  I may be misunderstanding something, but I didn't see anything in the stub that supports this.  So...here it is:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
/** \brief Calling this function will cause the given output to written to the gdb console.
<br/>
Â */
<br/>
void
<br/>
writeString_gdbstub(const char* pstring)
<br/>
{
<br/>
Â  Â  const int max_string_size = 128;
<br/>
Â  Â  static unsigned char buffer[2*max_string_size+8];
<br/>
Â  Â  unsigned int index = 1;
<br/>
<br/>
Â  Â  if(!pstring)
<br/>
Â  Â  Â  Â  return;
<br/>
<br/>
Â  Â  buffer[index++] = 'O';
<br/>
<br/>
Â  Â  while(*pstring &amp;&amp; index &lt; (2*max_string_size+2))
<br/>
Â  Â  {
<br/>
Â  Â  Â  Â  buffer[index++] = hexchars[*pstring &gt;&gt; 4];
<br/>
Â  Â  Â  Â  buffer[index++] = hexchars[*pstring &amp; 0xF];
<br/>
<br/>
Â  Â  Â  Â  ++pstring;
<br/>
Â  Â  }
<br/>
<br/>
Â  Â  buffer[index] = 0;
<br/>
<br/>
Â  Â  // send O packet
<br/>
Â  Â  enableCommsIRQs(&amp;gdbstub_descr);
<br/>
Â  Â  putpacket(gdbstub_descr.comms_if, &amp;buffer[1]);
<br/>
Â  Â  restoreIRQstate(&amp;gdbstub_descr);
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
This works for me, but I do not guarantee this won't break other features or cause strange debugging issues...use at your own risk.
<br/>
<br/>
--
<br/>
Kory</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#131875 - masscat - Wed Jun 20, 2007 10:52 pm</h4>
    <div class="postbody"><span class="postbody">koryspansel:
<br/>
I have never noticed the 'O' packets before and, as you say, they can be very useful.
<br/>
I will look at incorporating them when I begin developing the stub code again.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#131877 - koryspansel - Wed Jun 20, 2007 11:52 pm</h4>
    <div class="postbody"><span class="postbody">masscat,
<br/>
<br/>
yeah, most of the gdb RSP documentation that I looked at mentioned nothing about 'O' packets, maybe a bit about file &amp; console IO.  I just happened to stumble upon <a href="http://venus.billgatliff.com/node/2" target="_blank">http://venus.billgatliff.com/node/2</a> which has some info at the bottom of the page.
<br/>
<br/>
--
<br/>
Kory</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#131909 - masscat - Thu Jun 21, 2007 9:49 am</h4>
    <div class="postbody"><span class="postbody">The <a class="postlink" href="http://sourceware.org/gdb/current/onlinedocs/gdb_33.html#SEC667" target="_blank">GNU GDB documentation</a> does give the 'O' packet in the "Stop Reply Packets" sections. I just read about the 'S' and 'T' packets and ignored the rest though.
<br/>
<br/>
<span style="font-weight: bold">EDIT:</span> Can anybody confirm that the restructured gdbstub works using a DSerial?</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
