<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Changes to FAT library API - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>DS development > Changes to FAT library API</h2>
<div id="posts">
<div class="post">
    <h4>#79219 - chishm - Wed Apr 12, 2006 6:06 am</h4>
    <div class="postbody"><span class="postbody">I am currently working on an update to the FAT library. I am looking to add the ability to call FindFirstFile / FindNextFile recursively, however, this will require a change to the API. This will most likely involve passing a struct amongst the file system methods (FindFirstFile, FindNextFile, GetAlias, etc), that will contain the current state, rather than relying on (ugly) global variables as it does now.
<br/>
<br/>
This API change will not affect functions that mimic the behaviour of standard C file functions (fopen, fclose, remove, chdir).
<br/>
<br/>
So this poll applies to developers who are currently using / going to use the FAT library. End users need not apply.
<br/>
<br/>
While I'm at it, are there any other changes wanted (not hardware related)?<br/>_________________<br/><a class="postlink" href="http://chishm.drunkencoders.com" target="_blank">http://chishm.drunkencoders.com</a>
<br/>
<a class="postlink" href="http://dldi.drunkencoders.com" target="_blank">http://dldi.drunkencoders.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#79235 - tepples - Wed Apr 12, 2006 12:38 pm</h4>
    <div class="postbody"><span class="postbody">The <a class="postlink" href="http://www.opengroup.org/onlinepubs/007908799/xsh/opendir.html" target="_blank">opendir() family</a> already requires passing around a this-pointer.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#79258 - chishm - Wed Apr 12, 2006 1:57 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tepples wrote:</b></span></td> </tr> <tr> <td class="quote">The <a class="postlink" href="http://www.opengroup.org/onlinepubs/007908799/xsh/opendir.html" target="_blank">opendir() family</a> already requires passing around a this-pointer.</td> </tr></table><span class="postbody">
<br/>
I'd model the new functions off of the opendir() family, except they do not contain all of the functionality that I want to provide. Also, to save memory / not include use of malloc, FindFirstFile (or equivalent) will not allocate memory for the structure -- this will be the task of the user.
<br/>
<br/>
FAT_fopen does allocate the memory for FAT_FILE* (from a static block), but this is wasteful, and limits the maximum number of simultaneously open files to 4 (unless customised by the programmer using the library). This may also be a time for FAT_fopen to be changed to rely on the user to allocate the memory, if people so desire it. However, this will break away from the standard fopen specs.<br/>_________________<br/><a class="postlink" href="http://chishm.drunkencoders.com" target="_blank">http://chishm.drunkencoders.com</a>
<br/>
<a class="postlink" href="http://dldi.drunkencoders.com" target="_blank">http://dldi.drunkencoders.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#79279 - 0xtob - Wed Apr 12, 2006 5:31 pm</h4>
    <div class="postbody"><span class="postbody">chishm: If the usability and/or functionality of the FAT lib benefits from whatever changes you're making, I'll be happy to adapt my code to the new lib.
<br/>
<br/>
By the way, is it possible to determine the amount of free space on the card with the current FAT lib? If not, would it be much work to add this? OK, I could just create a "dummy" file of the needed size and check if it has the correct size, then delete it again and write the "real" file, but it's not the most elegant solution :-)
<br/>
<br/>
Bye,
<br/>
Tob</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#79293 - tepples - Wed Apr 12, 2006 6:53 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>chishm wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tepples wrote:</b></span></td> </tr> <tr> <td class="quote">The opendir() family already requires passing around a this-pointer.</td> </tr></table><span class="postbody">
<br/>
I'd model the new functions off of the opendir() family, except they do not contain all of the functionality that I want to provide.</span></td> </tr></table><span class="postbody">
<br/>
What kind of functionality were you talking about? The kind that could be done with stat()?
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">FAT_fopen does allocate the memory for FAT_FILE* (from a static block), but this is wasteful, and limits the maximum number of simultaneously open files to 4 (unless customised by the programmer using the library).</td> </tr></table><span class="postbody">
<br/>
MS-DOS has the FILES= variable in config.sys. Even Windows and Linux have a limit of n open files per process.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">This may also be a time for FAT_fopen to be changed to rely on the user to allocate the memory, if people so desire it. However, this will break away from the standard fopen specs.</td> </tr></table><span class="postbody">
<br/>
Have FAT_InitFilesEx() take a buffer and size, and then have FAT_InitFiles() call FAT_InitFilesEx() with a nominal sized buffer. (Put FAT_InitFiles() and its buffer in a separate file so that it doesn't get linked in if the program only calls FAT_InitFilesEx().)<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#79304 - Mighty Max - Wed Apr 12, 2006 7:29 pm</h4>
    <div class="postbody"><span class="postbody">Imho we could use a change in the interface anyways, so that it would be good if we'd combine them.
<br/>
<br/>
What i'm thinking on is the add of another abstraction layer to seperate the filesystem. We have done this with the hardware, so your FAT lib can use different hardware.
<br/>
<br/>
In the current situation, this is done by the individual, and different #define lines on different builds.
<br/>
<br/>
It would be nice if the "combined device driver" would allow access to gbfs with a "gbfs://" prefix or "fat://" for the normal fat lib. Or defaults to fat if nothing is specified.<br/>_________________<br/><a class="postlink" href="http://mightymax.org/gbamp_multiboot.html" target="_blank">GBAMP Multiboot</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#79312 - HyperHacker - Wed Apr 12, 2006 9:42 pm</h4>
    <div class="postbody"><span class="postbody">3 things I can think of that would be useful to add, if they don't already exist:
<br/>
1) Some way to determine the current directory. Especially useful if the path was always stored at some specific memory location, then when you launch another .nds, it could see what directory it's in.
<br/>
2) Ability to browse the filesystem of the inserted DS card if possible.
<br/>
3) Ability to open the memory card/DS card itself as a file, like you can in Linux.
<br/>
<br/>
As for the API changes, I wouldn't mind having to fill out some information, but between FAT_OpenFilesEx() and passing structs to API functions, this is starting to sound like the Windows API...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#79340 - josath - Thu Apr 13, 2006 12:48 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Mighty Max wrote:</b></span></td> </tr> <tr> <td class="quote">It would be nice if the "combined device driver" would allow access to gbfs with a "gbfs://" prefix or "fat://" for the normal fat lib. Or defaults to fat if nothing is specified.</td> </tr></table><span class="postbody">
<br/>
Even nicer would be if it couldn't find a fat partition, then it automatically falls back to using gbfs.
<br/>
<br/>
Also:
<br/>
It seems enabling Supercard SD breaks the Supercard CF driver. But this is using the fat lib from RAIN, which has the asm driver, so I can't really blame you.
<br/>
<br/>
EDIT:
<br/>
Once the API gets stable enough, I'd suggest making a c++ wrapper. I'll probably take a crack at it if nobody else does.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#79406 - tepples - Thu Apr 13, 2006 12:46 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>josath wrote:</b></span></td> </tr> <tr> <td class="quote">Even nicer would be if it couldn't find a fat partition, then it automatically falls back to using gbfs.</td> </tr></table><span class="postbody">
<br/>
GBFS doesn't support nested folders yet.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#79413 - sofakng - Thu Apr 13, 2006 2:21 pm</h4>
    <div class="postbody"><span class="postbody">chishm, are you going to be implementing a way to include the FAT system inside of an NDS file?  (so people with regular flash carts will work [not only the compact flash cards])
<br/>
<br/>
Also, does your FAT driver support writing?  (will it be supported on regular flash carts like my question above?)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#79434 - tepples - Thu Apr 13, 2006 6:04 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>sofakng wrote:</b></span></td> </tr> <tr> <td class="quote">chishm, are you going to be implementing a way to include the FAT system inside of an NDS file?</td> </tr></table><span class="postbody">
<br/>
You mean bin2s'd and linked into the .nds that gets ? This would be called a loopback file system.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Also, does your FAT driver support writing?  (will it be supported on regular flash carts like my question above?)</td> </tr></table><span class="postbody">
<br/>
"Regular flash carts" are as different as CF and SD. F2A, EZ-Flash, EZFA, EFA, EFA II, G6, etc. all need different procedures to communicate with the ASIC and read and write the flash chip.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#79460 - sofakng - Thu Apr 13, 2006 8:50 pm</h4>
    <div class="postbody"><span class="postbody">Well, all I'm looking for is something that will work with all NDS homebrew systems... (regardless whether the user is using an EZ-Flash II, SuperCard, etc, etc...)
<br/>
<br/>
All I need is a way to permanently save a file (eg. it should work on all NDS systems)...  
<br/>
<br/>
Does nothing like this exist?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#79488 - tepples - Fri Apr 14, 2006 12:35 am</h4>
    <div class="postbody"><span class="postbody">If no CF or SD card is available, you'd probably have to create a 64 kilobyte read/write file system in GBA SRAM.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#79499 - sofakng - Fri Apr 14, 2006 1:13 am</h4>
    <div class="postbody"><span class="postbody">Does the GBA SRAM last between games?  (eg. the users play the game, saves, and then turns the system off to return to it later and resume the game where he left off)
<br/>
<br/>
If so, which library/API is available to work with this file system?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#79514 - tepples - Fri Apr 14, 2006 2:27 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>sofakng wrote:</b></span></td> </tr> <tr> <td class="quote">Does the GBA SRAM last between games?  (eg. the users play the game, saves, and then turns the system off to return to it later and resume the game where he left off)</td> </tr></table><span class="postbody">
<br/>
Yes, provided that the flash cart's battery is charged.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">If so, which library/API is available to work with this file system?</td> </tr></table><span class="postbody">
<br/>
Currently there is no well-known fopen() style library to work with GBA SRAM, but manual bytewise copies to and from the 64 KB region starting at 0x0A000000 work. See the GBA beginners' FAQ. (Note that the DS places GBA SRAM at 0x0A000000, not 0x0E000000 like the GBA.)<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#79926 - chishm - Mon Apr 17, 2006 6:28 am</h4>
    <div class="postbody"><span class="postbody">Sorry for the long delay before replying, I was away and the PC I had access to couldn't get to this site.
<br/>
<br/>
0xtob: 
<br/>
I'll be able to add free space reporting, but it will only be accurate to multiples of free clusters. This is probably best anyway, as it will give a worst case scenario of the amount of space available for a new file.
<br/>
<br/>
tepples:
<br/>
Yes, the planned functionality is for file size, cluster, etc reporting. Since I'm completely rewriting the API, I could just have the default InitFiles accept a memory buffer to allocate from. However, this idea is still in flux.
<br/>
<br/>
Mighty Max:
<br/>
I agree that we need a 3rd layer, to support multiple file systems. GBFS will hopefully become less needed for flash cart users when I am done (take a look at the FCSR device in the current FAT library), but there are still other reasons to abstract away direct file system access. Each support file system will only need to support file listing, directory changing, and file opening / reading / writing functionality. Then the 3rd layer provides the rest of the stdio functionality like fgets, etc.
<br/>
<br/>
HyperHacker:
<br/>
Allowing to determine the current directory means paths will have a size limit. At the moment there is no path length limit, but if this were done it would most likely be limitted to 1024 characters. This already occurs in many desktop OSes, so it isn't too restricting.
<br/>
<br/>
DS cards use a completely different file system (here after refered to as "NitroFS"). NitroFS requires the header of the currently inserted DS card to be intact, to provide values required in locating and parsing the file system on the card. Unfortunately, the header is destroyed by many NDS loaders (like the GBAMP, ndsmall, etc) and there is no easy way around this.
<br/>
<br/>
sofakng:
<br/>
This would be done by the FCSR (Flash Cart with SRAM driver), which is already included in the current FAT library. I just haven't had time / motivation to release a stable file system builder. It simulates a disk of up to 32MB in size, with 64KB of free space using SRAM overlays.<br/>_________________<br/><a class="postlink" href="http://chishm.drunkencoders.com" target="_blank">http://chishm.drunkencoders.com</a>
<br/>
<a class="postlink" href="http://dldi.drunkencoders.com" target="_blank">http://dldi.drunkencoders.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#79942 - sofakng - Mon Apr 17, 2006 12:34 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>chishm wrote:</b></span></td> </tr> <tr> <td class="quote">sofakng:
<br/>
This would be done by the FCSR (Flash Cart with SRAM driver), which is already included in the current FAT library. I just haven't had time / motivation to release a stable file system builder. It simulates a disk of up to 32MB in size, with 64KB of free space using SRAM overlays.</td> </tr></table><span class="postbody">
<br/>
Is the SRAM a permanent storage or temporary (eg. only when the DS is turned on)?
<br/>
<br/>
If you make any progress on a driver for this type of file system, please let me know.  I'd be VERY interested in using it.  Thanks!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#79944 - tepples - Mon Apr 17, 2006 1:27 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>sofakng wrote:</b></span></td> </tr> <tr> <td class="quote">Is the SRAM a permanent storage or temporary (eg. only when the DS is turned on)?</td> </tr></table><span class="postbody">
<br/>
It's permanent as long as your flash cart's battery stays charged.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#79982 - sofakng - Mon Apr 17, 2006 11:18 pm</h4>
    <div class="postbody"><span class="postbody">chishm/tepples:
<br/>
<br/>
What about adding writing support for SD cards to the FAT driver?  I've heard that only CF cards support writing to the file system and SD only allows reading...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#80005 - chishm - Tue Apr 18, 2006 1:27 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>sofakng wrote:</b></span></td> </tr> <tr> <td class="quote">What about adding writing support for SD cards to the FAT driver?  I've heard that only CF cards support writing to the file system and SD only allows reading...</td> </tr></table><span class="postbody">
<br/>
This is a hardware issue and not related to the API. SD writing support will be included when it works in C.<br/>_________________<br/><a class="postlink" href="http://chishm.drunkencoders.com" target="_blank">http://chishm.drunkencoders.com</a>
<br/>
<a class="postlink" href="http://dldi.drunkencoders.com" target="_blank">http://dldi.drunkencoders.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#80102 - tepples - Tue Apr 18, 2006 8:16 pm</h4>
    <div class="postbody"><span class="postbody">What prevents an ARM7 assembly language implementation? Or are you planning to have this work on platforms other than the GBA and Nintendo DS?<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
