<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Memory leaks with DIR_ITER and fopen [SOLVED] - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > Memory leaks with DIR_ITER and fopen [SOLVED]</h2>
<div id="posts">
<div class="post">
    <h4>#176139 - SchmendrickSchmuck - Sat Apr 16, 2011 11:32 am</h4>
    <div class="postbody"><span class="postbody">I'm using DIR_ITER to list all the files in a given folder. However, every time I do so, I noticed that it allocates a lot of memory, and I'm not getting it back. The piece of code below alone takes up 16128 bytes:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
struct stat st;
<br/>
DIR_ITER* dir;
<br/>
dir = diropen(levelLocation);
<br/>
buffer = (u8*)malloc(128);
<br/>
while (dirnext(dir, (char*)buffer, &amp;st) == 0)
<br/>
{
<br/>
}
<br/>
dirclose(dir);
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
<br/>
Changing the while loop to the following ups the memory usage to 114688(!!) bytes:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
char levelName[50][35];
<br/>
int lastfile = 0;
<br/>
<br/>
while (dirnext(dir, (char*)buffer, &amp;st) == 0)
<br/>
{
<br/>
   if(tCounter++ &gt; 1)
<br/>
   {
<br/>
      memset(levelName[lastfile], 0, sizeof(levelName[lastfile]));
<br/>
      strcpy(levelName[lastfile], (char*)buffer);
<br/>
<br/>
      testRead = fopen (levelName[lastfile], "rb");
<br/>
<br/>
      fclose(testRead);
<br/>
<br/>
      lastfile++;
<br/>
   }
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Any thoughts?</span><span class="gensmall"><br/><br/>Last edited by SchmendrickSchmuck on Sun Apr 17, 2011 4:25 pm; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#176141 - elhobbs - Sat Apr 16, 2011 4:15 pm</h4>
    <div class="postbody"><span class="postbody">how are you determining how much memory is free?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#176142 - SchmendrickSchmuck - Sat Apr 16, 2011 4:54 pm</h4>
    <div class="postbody"><span class="postbody">I don't check the free memory, but the memory in use:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
struct mallinfo info = mallinfo();
<br/>
iprintf("\x1b[22;0HMemory in use: %d bytes", info.uordblks);
<br/>
iprintf("\x1b[23;0HTotal heap size: %d bytes", info.arena);
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
The values I gave earlier are based on the change in info.uordblks.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#176144 - Azenris - Sat Apr 16, 2011 10:07 pm</h4>
    <div class="postbody"><span class="postbody">At the bottom of <a href="http://chishm.drunkencoders.com/libfat/" target="_blank">http://chishm.drunkencoders.com/libfat/</a> it shows a file listing demo. Not sure on your problem. Btw wheres the free for the malloc<br/>_________________<br/>&lt;Robert Morley&gt;
<br/>
<a class="postlink" href="http://sacredpotion.blogspot.com/" target="_blank"><span style="color: red">My Homebrew Games</span></a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#176145 - SchmendrickSchmuck - Sun Apr 17, 2011 4:24 pm</h4>
    <div class="postbody"><span class="postbody">Thanks Azenris, I seemed to have overlooked the free command..
<br/>
<br/>
I looked some more into libfat, but it doesn't mention anything like this;
<br/>
It appears that changing the buffer size to libfat's MAXPATHLEN, along with the free command fixed the problem. I had assumed the buffer could be any length as long as it could hold the file name, but that doesn't seem to be the case.
<br/>
<br/>
Thanks again!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#176513 - FluBBa - Tue Aug 09, 2011 5:46 pm</h4>
    <div class="postbody"><span class="postbody">Somebody know where diropen, dirnext &amp; dirclose is today?
<br/>
readdir is so damn slow...<br/>_________________<br/>I probably suck, my not is a programmer.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#176519 - Rajveer - Wed Aug 10, 2011 10:25 am</h4>
    <div class="postbody"><span class="postbody">Yeah I upgraded to the latest devkitARM (from 32 to 34, which includes a new libndsfat, 1.0.10) and can't find those functions anymore.</span><span class="gensmall"><br/><br/>Last edited by Rajveer on Wed Aug 10, 2011 5:11 pm; edited 2 times in total</span></div>    
</div>
<div class="post">
    <h4>#176524 - wintermute - Wed Aug 10, 2011 2:41 pm</h4>
    <div class="postbody"><span class="postbody">I got fed up with people reporting non-existent bugs in those (non standard) functions - they're gone. We should probably have gone with opendir &amp; company right from the off.
<br/>
<br/>
readdir isn't slow you're probably just still using stat, sorry, there are a few more pending example changes.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
      pdir=opendir("/");
<br/>
<br/>
      if (pdir){
<br/>
<br/>
         while ((pent=readdir(pdir))!=NULL) {
<br/>
             if(strcmp(".", pent-&gt;d_name) == 0 || strcmp("..", pent-&gt;d_name) == 0)
<br/>
                 continue;
<br/>
             if(pent-&gt;d_type == DT_DIR)
<br/>
                 iprintf("[%s]\n", pent-&gt;d_name);
<br/>
             else
<br/>
                 iprintf("%s\n", pent-&gt;d_name);
<br/>
         }
<br/>
         closedir(pdir);
<br/>
      } else {
<br/>
         iprintf ("opendir() failure; terminating\n");
<br/>
      }
<br/>
</td> </tr></table><span class="postbody"><br/>_________________<br/><a class="postlink" href="http://www.devkitpro.org/" target="_blank">devkitPro - professional toolchains at amateur prices</a>
<br/>
<a class="postlink" href="http://wiki.devkitpro.org/index.php/IRC" target="_blank">devkitPro IRC support</a>
<br/>
<a class="postlink" href="http://davejmurphy.com/" target="_blank">Personal Blog</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#176531 - FluBBa - Wed Aug 10, 2011 10:18 pm</h4>
    <div class="postbody"><span class="postbody">Thanks a lot, I'll try that tomorrow.
<br/>
<br/>
Another quick question, is the card reading done by the ARM7, is there a read-a-head so that it reads data while the ARM9 is doing stuff?<br/>_________________<br/>I probably suck, my not is a programmer.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#176532 - Dwedit - Wed Aug 10, 2011 10:23 pm</h4>
    <div class="postbody"><span class="postbody">The lack of asynchronous reads has been the most annoying thing about the disc_io part of libfat.  Seems like all the code for the various cards wants to use 100% CPU usage polling loops instead putting it off for later with a timer interrupt.<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#176533 - wintermute - Wed Aug 10, 2011 10:46 pm</h4>
    <div class="postbody"><span class="postbody">card reading is only done by arm7 on the DSi, not sure we can implement async io in any sensible way tbh.<br/>_________________<br/><a class="postlink" href="http://www.devkitpro.org/" target="_blank">devkitPro - professional toolchains at amateur prices</a>
<br/>
<a class="postlink" href="http://wiki.devkitpro.org/index.php/IRC" target="_blank">devkitPro IRC support</a>
<br/>
<a class="postlink" href="http://davejmurphy.com/" target="_blank">Personal Blog</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#176534 - FluBBa - Thu Aug 11, 2011 9:35 am</h4>
    <div class="postbody"><span class="postbody">Seems like reading is a bit faster overall with the new devkitARM, thanks.<br/>_________________<br/>I probably suck, my not is a programmer.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
