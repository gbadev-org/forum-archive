<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>asm adr and BSS section not working. - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > asm adr and BSS section not working.</h2>
<div id="posts">
<div class="post">
    <h4>#168234 - FluBBa - Thu Apr 16, 2009 9:43 am</h4>
    <div class="postbody"><span class="postbody">After a couple of hours I finally found out that using a BSS section and the adr (semi) opcode doesn't work in the latest DevKitARM (gcc bug?).
<br/>
<br/>
Doing something like:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
   .arm
<br/>
   .align 4
<br/>
   .section .text
<br/>
;@----------------------------------------------------------------------------
<br/>
Sound_reset:
<br/>
;@----------------------------------------------------------------------------
<br/>
   stmfd sp!,{lr}
<br/>
   adr r0,SN76496_0
<br/>
   bl SN76496_reset         ;@ sound
<br/>
   ldmfd sp!,{lr}
<br/>
   bx lr
<br/>
;@----------------------------------------------------------------------------
<br/>
   .section .bss
<br/>
SN76496_0:
<br/>
   .space 72
<br/>
</td> </tr></table><span class="postbody">
<br/>
r0 is loaded with the current PC and not with the address of SN76496_0.
<br/>
Using ldr r0,=SN76496_o works as expected and is the right way to do it, but using adr should at least give a warning and probably an error.<br/>_________________<br/>I probably suck, my not is a programmer.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#168237 - olimar - Thu Apr 16, 2009 12:31 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>FluBBa wrote:</b></span></td> </tr> <tr> <td class="quote">After a couple of hours I finally found out that using a BSS section and the adr (semi) opcode doesn't work in the latest DevKitARM (gcc bug?).</td> </tr></table><span class="postbody">
<br/>
Not a bug.  Since it's in a different section, it can only be resolved at link time.  Labels for ADR must be resolvable by the assembler (in the same section and not external).  The reason for this is ADR gets translated to ADD r0, pc, #immediate (possibly a shifted immediate) which the linker doesn't know what to do with... the immediate needs to be figured out by the assembler.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>FluBBa wrote:</b></span></td> </tr> <tr> <td class="quote">r0 is loaded with the current PC and not with the address of SN76496_0.
<br/>
Using ldr r0,=SN76496_o works as expected and is the right way to do it, but using adr <span style="font-weight: bold">should at least give a warning and probably an error.</span></td> </tr></table><span class="postbody">
<br/>
Agreed (notice it does throw an error on ADR to externs though).</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#168240 - Dwedit - Thu Apr 16, 2009 6:05 pm</h4>
    <div class="postbody"><span class="postbody">Converting an emulator from SDT to GCC by hand?
<br/>
It gets really tedious really quick, especially if you are trying to use register relative equates.  GCC just doesn't support them.
<br/>
<br/>
So all the old code like "ldr r0,some_global" or something needs to be re-expressed as "ldr r0,[r10,#some_global]", where "some_global" is the difference between r10 and the equate's memory address.
<br/>
Make a macro, like "ldr_" so that you can continue to use stuff very similar to the old code, so instead of having r10 and # everywhere, you just use "ldr_ r0,some_global".
<br/>
Also need to do that for str, adr, adrl, and byte-sized, halfword-size, and conditional variations of each instruction.
<br/>
<br/>
You also need to change the way maps are declared...
<br/>
<br/>
this example map:
<br/>
MAP 0,r10
<br/>
var_1 # 4
<br/>
var_2 # 4
<br/>
byte_0 # 1
<br/>
byte_1 # 1
<br/>
halfword_0 # 2
<br/>
<br/>
becomes:
<br/>
_map_address_ = 0
<br/>
var_1 = _map_address_
<br/>
_map_address_ = _map_address_ + 4
<br/>
var_2 = _map_address_
<br/>
_map_address_ = _map_address_ + 4
<br/>
...
<br/>
<br/>
But we can simplify this with macros:
<br/>
<br/>
start_map 0
<br/>
_m_ var_1,4
<br/>
_m_ var_2,4
<br/>
...
<br/>
<br/>
<br/>
The source code conversion tool I made looks in header files for MAPS, and automatically adds an underscore to all instructions which use an equate defined inside a MAP.  It also rewrites the map declaration to use macros to define each variable.  It also does much more...
<br/>
So it automatically changes the map, and also changes the "ldr r0,var_1" to "ldr_ r0,var_1".  You still need to provide the macros, but they've already been written and are found in the goomba color GCC version.
<br/>
<br/>
So don't convert by hand, get some tools to help out.<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#168242 - FluBBa - Thu Apr 16, 2009 7:38 pm</h4>
    <div class="postbody"><span class="postbody">The SN76496 core was allready rewritten to use r0 as base for each instance of itself, but I have your macros for some other parts. I'm porting Green Beret right now and most stuff seem to work except I can't get good sound on the DS no matter how I try with MaxMod... So do one have to write everything by hand to get it to work correctly :-P
<br/>
<br/>
Edit: Just saw this in the source to maxmod (regarding structs in asm):
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
.struct 0
<br/>
mms_rate:   .space 4
<br/>
mms_len:   .space 4
<br/>
mms_function:   .space 4
<br/>
mms_format:   .space 4
<br/>
mms_timer:   .space 4
<br/>
mms_manual:   .space 1
<br/>
mms_size:
<br/>
</td> </tr></table><span class="postbody"><br/>_________________<br/>I probably suck, my not is a programmer.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
