<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Bizarre sound problem (renamed, fixed, and laughed at) - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > Bizarre sound problem (renamed, fixed, and laughed at)</h2>
<div id="posts">
<div class="post">
    <h4>#144283 - HyperHacker - Wed Oct 31, 2007 3:18 am</h4>
    <div class="postbody"><span class="postbody">(Was: Error: invalid offset, value too big (0x00000440), and more
<br/>
<br/>
This problem appears to be solved, but the sound problems below aren't.)
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">make -C arm7
<br/>
make[1]: Entering directory `/f/Programs/Sources/DS/bootmenu2/arm7'
<br/>
make[2]: `/f/Programs/Sources/DS/bootmenu2/bootmenu2.arm7' is up to date.
<br/>
make[1]: Leaving directory `/f/Programs/Sources/DS/bootmenu2/arm7'
<br/>
make -C arm9
<br/>
make[1]: Entering directory `/f/Programs/Sources/DS/bootmenu2/arm9'
<br/>
boot.c
<br/>
arm-eabi-gcc -MMD -MP -MF /f/Programs/Sources/DS/bootmenu2/arm9/build/boot.d -g
<br/>
-std=gnu99 -Wall -O2 -mcpu=arm9tdmi -mtune=arm9tdmi -fomit-frame-pointer -ffast-
<br/>
math -mthumb -mthumb-interwork -I/f/Programs/Sources/DS/bootmenu2/arm9/build -I/
<br/>
f/Programs/Sources/DS/bootmenu2/arm9/../bootmenu2 -I/F/DOS/DevKitPro/libnds/incl
<br/>
ude -I/f/Programs/Sources/DS/bootmenu2/arm9/build -DARM9 -c /f/Programs/Sources/
<br/>
DS/bootmenu2/arm9/source/boot.c -o boot.o
<br/>
C:/DOCUME~1/Admin/LOCALS~1/Temp/ccA64Ehb.s: Assembler messages:
<br/>
C:/DOCUME~1/Admin/LOCALS~1/Temp/ccA64Ehb.s:623: Error: invalid offset, value too
<br/>
 big (0x00000440)
<br/>
make[2]: *** [boot.o] Error 1
<br/>
make[1]: *** [build] Error 2
<br/>
make[1]: Leaving directory `/f/Programs/Sources/DS/bootmenu2/arm9'
<br/>
make: *** [arm9/bootmenu2.elf] Error 2</td> </tr></table><span class="postbody">
<br/>
<br/>
WTF is this supposed to mean? It's just randomly started giving me this error when I add code to routines in boot.c.
<br/>
<br/>
<br/>
[edit] Here's another good one on ARM7. (Param4 = 8.)
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">SCHANNEL_TIMER(Param4) = SOUND_FREQ(2000 &lt;&lt; 3);
<br/>
SCHANNEL_CR(Param4) = SOUND_VOL(32) | SOUND_PAN(64) | SCHANNEL_WAVEDUTY(3) | SOUND_FORMAT_PSG | SCHANNEL_ENABLE;</td> </tr></table><span class="postbody">Gets me a 2000hz tone.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">u32 Param2 = 2000;
<br/>
SCHANNEL_TIMER(Param4) = SOUND_FREQ(Param2 &lt;&lt; 3);
<br/>
SCHANNEL_CR(Param4) = SOUND_VOL(32) | SOUND_PAN(64) | SCHANNEL_WAVEDUTY(3) | SOUND_FORMAT_PSG | SCHANNEL_ENABLE;</td> </tr></table><span class="postbody">Gets me what sounds like a 100hz tone.
<br/>
<br/>
Even these won't do it:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">u32 WTF = 16000;
<br/>
SCHANNEL_TIMER(Param4) = SOUND_FREQ(WTF);
<br/>
SCHANNEL_CR(Param4) = SOUND_VOL(32) | SOUND_PAN(64) | SCHANNEL_WAVEDUTY(3) | SOUND_FORMAT_PSG | SCHANNEL_ENABLE;</td> </tr></table><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">u32 WTF = 16000;
<br/>
SCHANNEL_TIMER(Param4) = WTF;
<br/>
SCHANNEL_CR(Param4) = SOUND_VOL(32) | SOUND_PAN(64) | SCHANNEL_WAVEDUTY(3) | SOUND_FORMAT_PSG | SCHANNEL_ENABLE;</td> </tr></table><span class="postbody">It only works if I use a constant. The hell? Putting in higher values does get higher frequencies, but nowhere near 2000hz, and only up to about 4000 (which is maybe 200hz), anything above that drops back down to the same as 2000. I can even pass it back to ARM9 to be printed on the screen to verify that it's 2000.<br/>_________________<br/>I'm a PSP hacker now, but I still &lt;3 DS.</span><span class="gensmall"><br/><br/>Last edited by HyperHacker on Sat Nov 03, 2007 5:37 am; edited 2 times in total</span></div>    
</div>
<div class="post">
    <h4>#144293 - chishm - Wed Oct 31, 2007 6:22 am</h4>
    <div class="postbody"><span class="postbody">Do you use inline assembly in boot.c, and does it reference values outside of the assembly code?<br/>_________________<br/><a class="postlink" href="http://chishm.drunkencoders.com" target="_blank">http://chishm.drunkencoders.com</a>
<br/>
<a class="postlink" href="http://dldi.drunkencoders.com" target="_blank">http://dldi.drunkencoders.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#144294 - HyperHacker - Wed Oct 31, 2007 6:38 am</h4>
    <div class="postbody"><span class="postbody">Only this, which references some hardcoded addresses:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">__asm(".thumb\n"
<br/>
   //"mov r11, r11\n" //No$GBA breakpoint
<br/>
   "ldr r0, =begin\n" //switch to ARM mode
<br/>
   "bx r0\n"
<br/>
   ".arm\n"
<br/>
   "begin:\n"
<br/>
   //"mov r11, r11\n"
<br/>
   "ldr r0, =0x27FFE24\n" //Get boot address
<br/>
   "ldr r3, [r0]\n"
<br/>
   "ldr r0, =0x27FFF6C\n" //Unused header area
<br/>
   "ldr r1, =0xBBBBBBBB\n" //Magic number
<br/>
   "ldr r4, =0\n"
<br/>
   "loop:\n"
<br/>
   "ldr r2, [r0]\n" //Wait for this word to become 0xBBBBBBBB
<br/>
   "cmp r1, r2\n"
<br/>
   "bne loop\n"
<br/>
   "str r1, [r0, #4]\n" //Set the next word to 0xBBBBBBBB to signal the ARM7
<br/>
   "str r4, [r0]\n" //Set it to zero so the game doesn't freak out
<br/>
   "bx r3\n" //Boot
<br/>
);</td> </tr></table><span class="postbody"><br/>_________________<br/>I'm a PSP hacker now, but I still &lt;3 DS.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#144296 - chishm - Wed Oct 31, 2007 8:10 am</h4>
    <div class="postbody"><span class="postbody">Those constants are being put too far from the assembled code. 
<br/>
You can either:
<br/>
1) Put the assembler code in a separate .s file
<br/>
2) Load the constants from C code, using the GCC __asm syntax for passing parameters
<br/>
3) Force the assembler to output the constants close by with a .pool statement.
<br/>
<br/>
1 is the easiest and I'm not sure if 3 will work.<br/>_________________<br/><a class="postlink" href="http://chishm.drunkencoders.com" target="_blank">http://chishm.drunkencoders.com</a>
<br/>
<a class="postlink" href="http://dldi.drunkencoders.com" target="_blank">http://dldi.drunkencoders.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#144371 - HyperHacker - Thu Nov 01, 2007 5:28 am</h4>
    <div class="postbody"><span class="postbody">#3 seems to have worked, thanks. I should have noticed that. D'oh.
<br/>
<br/>
This sound problem is still bugging the heck out of me though.<br/>_________________<br/>I'm a PSP hacker now, but I still &lt;3 DS.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#144376 - DekuTree64 - Thu Nov 01, 2007 7:14 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>HyperHacker wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">u32 Param2 = 2000;
<br/>
SCHANNEL_TIMER(Param4) = SOUND_FREQ(Param2 &lt;&lt; 3);
<br/>
SCHANNEL_CR(Param4) = SOUND_VOL(32) | SOUND_PAN(64) | SCHANNEL_WAVEDUTY(3) | SOUND_FORMAT_PSG | SCHANNEL_ENABLE;</td> </tr></table><span class="postbody">Gets me what sounds like a 100hz tone.</span></td> </tr></table><span class="postbody">
<br/>
Ah, the joy of macros. SOUND_FREQ is defined as (-0x1000000 / (n)), but I think what's happening is that the compiler applies the negation first, which results in the value 0xFF000000, and then decides to do an unsigned division because the constant is typeless and the variable is unsigned. So try making Param2 an s32.<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#144522 - HyperHacker - Sat Nov 03, 2007 5:37 am</h4>
    <div class="postbody"><span class="postbody">Tch, I knew there was something funny with that macro. (Who uses negative hex numbers anyway? &lt;_&lt;) s32 fixed it, thanks.<br/>_________________<br/>I'm a PSP hacker now, but I still &lt;3 DS.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
