<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>DS-Wifi Question - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>DS development > DS-Wifi Question</h2>
<div id="posts">
<div class="post">
    <h4>#169045 - DarkShadow44 - Wed Jun 10, 2009 9:11 pm</h4>
    <div class="postbody"><span class="postbody">Hello,
<br/>
I want to create a game using a wifi connection, but I can only create a socket on a server.
<br/>
Do I need an own server to use wifi connection ?
<br/>
<br/>
And can I create more than one socket on one server ?
<br/>
<br/>
Thanks for your help in advance !</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#169049 - melw - Thu Jun 11, 2009 12:16 pm</h4>
    <div class="postbody"><span class="postbody">It definitely helps if you have an own server or shell access to one, at least during the development. If you plan to create something that's easily installed elsewhere, better stick to Linux (same code works with some tweaking also on Macs).
<br/>
<br/>
On the socket coding in general, there's several tutorials floating around in the internet - here's one page straight from Google: <a class="postlink" href="http://www.linuxhowtos.org/C_C++/socket.htm" target="_blank">http://www.linuxhowtos.org/C_C++/socket.htm</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#169052 - DarkShadow44 - Thu Jun 11, 2009 4:56 pm</h4>
    <div class="postbody"><span class="postbody">So DO i have to use an own server or not ?
<br/>
<br/>
And can a DS (as Server) can send something like a broadcast message that it exists ? (I mean a specific string which contains the IP and the Name of the Game...)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#169053 - elhobbs - Thu Jun 11, 2009 5:24 pm</h4>
    <div class="postbody"><span class="postbody">It depends on what you are trying to do.
<br/>
<br/>
a server is just an application that listens for connections on defined ports and accepts connection requests and then responds according to the nature of the service(s) that it provides.
<br/>
<br/>
a file server - serves files
<br/>
a web server - serves web pages
<br/>
a sql server - serves datasets based on structured query language requests
<br/>
<br/>
this is a very simplistic view, but it should point you in the right direction.
<br/>
<br/>
you have a couple basic options
<br/>
1) the server application resides on a pc and the ds(s) or other pc(s) are the clients
<br/>
2) one ds is the server and other ds(s) or pc(s) can connect as clients
<br/>
<br/>
so what exactly do you mean by "I can only create a socket on a server"?
<br/>
<br/>
probably your best bet is to read up a little bit about tcp/ip sockets as suggested in the previous post.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#169054 - DarkShadow44 - Thu Jun 11, 2009 5:41 pm</h4>
    <div class="postbody"><span class="postbody">I searched for sockets in C/C++ with google, but most were only for windows server, not for the DS. They use librarys the DS can't use.
<br/>
<br/>
I want to create a wifi game, and the best would be that you can choose "Host" or "Join".
<br/>
<br/>
Is it possible to set these DS ("Hosts") as servers and the others can search them ? (Like I said with a broadcast?)
<br/>
<br/>
Else, how can I use a windows program to connect all these DS as I said ? (Clients search Hosts)
<br/>
Would I need an PC as server to search all players ?
<br/>
<br/>
Maybe later I want to add online highscores or map downloading, but there I MUST use a PC as server, or not ?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#169055 - elhobbs - Thu Jun 11, 2009 5:57 pm</h4>
    <div class="postbody"><span class="postbody">look at berkeley sockets examples. the dswifi library provides this interface.
<br/>
<br/>
look at the dswifi examples
<br/>
<br/>
look at other ds source code that uses wifi.
<br/>
<br/>
you could even take a look at the cquake source code (a ds port of idsoftware's quake) which implements a client/server architecture. very little in the network codebase needed to be changed to port it to the ds - mostly just the library startup routines.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#169056 - DarkShadow44 - Thu Jun 11, 2009 6:29 pm</h4>
    <div class="postbody"><span class="postbody">OK, but my main problem is: 
<br/>
How can a client search for all maching servers ?
<br/>
Is it possible for the DS to do a <span style="font-weight: bold">broadcast</span> witch a specific string containing it's IP ? If yes, how ?
<br/>
<br/>
The examples only explain searching for APs, connecting and downloading...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#169059 - elhobbs - Thu Jun 11, 2009 7:41 pm</h4>
    <div class="postbody"><span class="postbody">I am guessing you did not look at the source code to quake or cquake.
<br/>
<br/>
one solution is for clients to send broadcast UDP messages (hint SO_BROADCAST) that your server should respond to if it is accepting new connections. the reponse could contain the information needed to connect (ip address, port, etc). this solution could be used to find all hosts on your subnet and requires no infrastructure.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#169062 - DarkShadow44 - Thu Jun 11, 2009 8:34 pm</h4>
    <div class="postbody"><span class="postbody">Sorry, but....
<br/>
<br/>
What do you mean with "subnet and requires no infrastructure" ?
<br/>
I want to play via the internet...
<br/>
<br/>
And where should I create socket ? On the clients DS ?
<br/>
<br/>
Maybe you can post an example code (sorry but...)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#169063 - Pete_Lockwood - Thu Jun 11, 2009 8:52 pm</h4>
    <div class="postbody"><span class="postbody">So what you mean is you want someone to do all the work for you?<br/>_________________<br/>It's not an illusion, it just looks like one.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#169064 - DarkShadow44 - Thu Jun 11, 2009 9:02 pm</h4>
    <div class="postbody"><span class="postbody">No, but I want to have answered these questions:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">What do you mean with "subnet and requires no infrastructure" ?
<br/>
I want to play via the internet...
<br/>
<br/>
And where should I create socket ? On the clients DS ?</td> </tr></table><span class="postbody">
<br/>
<br/>
Please ?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#169065 - elhobbs - Thu Jun 11, 2009 9:19 pm</h4>
    <div class="postbody"><span class="postbody">you really, really, really need to read up as to what a socket is.
<br/>
<br/>
once you know what a socket is then come back and ask a more specific question.
<br/>
<br/>
you may find that if you put forth no effort on your own, and keep ignoring advice, that people will not be so inclined to help you</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#169075 - DarkShadow44 - Fri Jun 12, 2009 4:52 pm</h4>
    <div class="postbody"><span class="postbody">Hello, I've read some tutorials
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">look at berkeley sockets examples. the dswifi library provides this interface.</td> </tr></table><span class="postbody">
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">to send broadcast UDP messages (hint SO_BROADCAST)</td> </tr></table><span class="postbody">
<br/>
     @ elhobbs: Thanks for that ideas, really helped me
<br/>
<br/>
<br/>
 and I managed it to send AND receive a broadcast, but I only works if the server started first. If the server later comes, he recevies nothing.
<br/>
<br/>
Can you guess why ? The client sends and the server listens...
<br/>
<br/>
If I want receive the broadcast more than 32 times it also hangs (should be no problem, but would be good to know why...)
<br/>
<br/>
And why can't I use recv() instead of recvfrom() ?
<br/>
<br/>
And can I add a kind of TIMEOUT for recvfrom if I don't know how many Players will play (without editing the dswifi lib) ?
<br/>
<br/>
<br/>
P.S. Please tell me if these answers obvious, but I couldn't find it out (but I will keep trying)
<br/>
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">int ServerSockListen;
<br/>
int ClientSockSend;
<br/>
int main()
<br/>
{
<br/>
   consoleDemoInit();
<br/>
  
<br/>
   iprintf("\x1b[1;1HStart");
<br/>
  
<br/>
   Wifi_InitDefault(WFC_CONNECT);
<br/>
  
<br/>
  
<br/>
  
<br/>
   while(1)
<br/>
   {
<br/>
      iprintf("\x1b[5;1HPress A for Server, B for Client");
<br/>
      
<br/>
      scanKeys();
<br/>
      
<br/>
      if(keysDown() &amp; KEY_A)
<br/>
      {
<br/>
         server=true;
<br/>
         break;
<br/>
      }
<br/>
      
<br/>
      if(keysDown() &amp; KEY_B)
<br/>
      {
<br/>
         server=false;
<br/>
         break;
<br/>
      }
<br/>
      swiWaitForVBlank();
<br/>
   }
<br/>
  
<br/>
    iprintf("\x1b[7;1HLoading");
<br/>
   struct sockaddr_in i_addr;
<br/>
   i_addr.sin_family = AF_INET;
<br/>
   i_addr.sin_port = htons(6666);
<br/>
   i_addr.sin_addr.s_addr = htonl(INADDR_BROADCAST);
<br/>
   
<br/>
   
<br/>
   int optval = 1;
<br/>
   
<br/>
   if(server)
<br/>
   {
<br/>
      ServerSockListen=socket(AF_INET, SOCK_DGRAM, 0);
<br/>
      
<br/>
      bind(ServerSockListen, (struct sockaddr *) &amp;i_addr, sizeof(i_addr));
<br/>
      
<br/>
      
<br/>
      int i=0;
<br/>
      while(1)
<br/>
      {
<br/>
         char buffer[8];
<br/>
         int size=sizeof(struct sockaddr);
<br/>
<br/>
         recvfrom(ServerSockListen,buffer,8,0, (struct sockaddr *) &amp;i_addr, &amp;size);
<br/>
<br/>
         iprintf("\x1b[9;1HWaiting:%d ",i);
<br/>
         
<br/>
         if(buffer[0]=='P' &amp;&amp; buffer[1]=='A')
<br/>
         {
<br/>
            iprintf("\x1b[11;1HReceived: %s ",buffer);
<br/>
         }
<br/>
         i++;
<br/>
         swiWaitForVBlank();
<br/>
      }
<br/>
   }
<br/>
   else
<br/>
   {
<br/>
      int i=0;
<br/>
      while(1)
<br/>
      {
<br/>
         ClientSockSend=socket(AF_INET, SOCK_DGRAM, 0);
<br/>
         
<br/>
         
<br/>
         setsockopt(ClientSockSend,SOL_SOCKET,SO_BROADCAST,&amp;optval,sizeof(int));
<br/>
      
<br/>
         sendto(ClientSockSend,"PALIB-HI",8,0, (struct sockaddr *) &amp;i_addr, sizeof(i_addr));
<br/>
         
<br/>
         iprintf("\x1b[9;1HSending:%d ",i);
<br/>
         i++;
<br/>
         swiWaitForVBlank();
<br/>
      }
<br/>
   }
<br/>
   
<br/>
   
<br/>
<br/>
   iprintf("\x1b[22;1HEntering main loop...");
<br/>
     
<br/>
   while(1)
<br/>
   {
<br/>
      swiWaitForVBlank();
<br/>
   }
<br/>
   
<br/>
   return 0;
<br/>
}</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#169078 - elhobbs - Sat Jun 13, 2009 12:21 am</h4>
    <div class="postbody"><span class="postbody">recv only works on a connected socket. recvfrom can be used with unconnected sockets - it has extra parameters to record who it is from.
<br/>
<br/>
not sure why it crashes at exactly 32 iterations but you have a buffer overflow when you print the received packet. your string is 9 chars in length including the null terminator. since you are only sending 8 chars your are not getting a null terminated string. iprintf expects a null terminated string.
<br/>
<br/>
you probably want to take a look at FIONBIO to set your sockets to non-blocking.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#169083 - DarkShadow44 - Sat Jun 13, 2009 4:08 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">you have a buffer overflow when you print the received packet. your string is 9 chars in length including the null terminator. since you are only sending 8 chars your are not getting a null terminated string. iprintf expects a null terminated string. </td> </tr></table><span class="postbody">
<br/>
<br/>
Thanks. That explains, why I outputs one more, unreadable char!</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
