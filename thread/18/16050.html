<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Fast divide by 24 - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>DS development > Fast divide by 24</h2>
<div id="posts">
<div class="post">
    <h4>#162890 - shaymanjw - Mon Sep 15, 2008 7:58 pm</h4>
    <div class="postbody"><span class="postbody">Hi there,
<br/>
<br/>
Anybody know a fast way to divide by 24?
<br/>
The multiply is easy (x&lt;&lt;4 + x&lt;&lt;3), but I can't work out the opposite...
<br/>
<br/>
Cheers.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#162893 - thoduv - Mon Sep 15, 2008 8:35 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>shaymanjw wrote:</b></span></td> </tr> <tr> <td class="quote">Hi there,
<br/>
<br/>
Anybody know a fast way to divide by 24?
<br/>
The multiply is easy (x&lt;&lt;4 + x&lt;&lt;3), but I can't work out the opposite...
<br/>
<br/>
Cheers.</td> </tr></table><span class="postbody">
<br/>
You could begin with: (x&gt;&gt;3)/3
<br/>
There's still a division by 3, but perhaps someone knows how to optimize it.
<br/>
There is always the solution of using a LUT then... For dividing a 16bit signed number, you would need a LUT of 8kbyte (32768 &gt;&gt; 3 = 4096, 2 bytes for each entry). It could be a valuable optimization on GBA (with LUT in ROM), but on NDS, it's likely a bad idea, due to cache... You'd better use hardware accelerators then.</span><span class="gensmall"><br/><br/>Last edited by thoduv on Mon Sep 15, 2008 8:50 pm; edited 3 times in total</span></div>    
</div>
<div class="post">
    <h4>#162894 - chuckstudios - Mon Sep 15, 2008 8:38 pm</h4>
    <div class="postbody"><span class="postbody">You could use:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
int div24(int x)
<br/>
{
<br/>
    int newX = x;
<br/>
    int sum = 0;
<br/>
    do
<br/>
    {
<br/>
        sum += newX &gt;&gt; 5;
<br/>
        newX = x - ((sum &lt;&lt; 4) + (sum &lt;&lt; 3));
<br/>
    }
<br/>
    while(newX &gt;= 48);
<br/>
    if(newX &gt;= 24) sum++;
<br/>
    return sum;
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Edit: Forgot code tags.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#162895 - silent_code - Mon Sep 15, 2008 8:54 pm</h4>
    <div class="postbody"><span class="postbody">The hardware divider is asynchronous, which is good. And it's quite fast, too.<br/>_________________<br/><span style="font-size: 9px; line-height: normal"><span style="text-decoration: underline"><span style="font-weight: bold"></span></span> July 5th 08: "<span style="font-weight: bold">Volumetric Shadow Demo</span>" 1.6.0 (final) source released
<br/>
June 5th 08: "<span style="font-weight: bold">Zombie NDS</span>" WIP released!
<br/>
It's all on my page, just click <span style="font-weight: bold">WWW</span> below.</span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#162896 - kusma - Mon Sep 15, 2008 9:23 pm</h4>
    <div class="postbody"><span class="postbody">I believe this should work:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">unsigned int div24(unsigned int v)
<br/>
{
<br/>
   return (unsigned int)((unsigned long long)v * 0xaaaaaaab) &gt;&gt; (33 + 3);
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
It's based on the math from <a class="postlink" href="http://www.pagetable.com/?p=23" target="_blank">this page</a>.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#162897 - Dwedit - Mon Sep 15, 2008 9:30 pm</h4>
    <div class="postbody"><span class="postbody">The ARM architecture has a MUL instruction in both ARM and THUMB modes.
<br/>
The MUL instruction would take 3 cycles to multiply by 24.  In ARM mode, two shifted additions would take 2 cycles.  So far, so good.
<br/>
But in THUMB mode, you can't use the shifted addition instruction, so each shift has to be a separate instruction, taking 4 cycles instead of 2 cycles.  So using MUL wins out in THUMB mode.<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#162899 - Miked0801 - Mon Sep 15, 2008 9:50 pm</h4>
    <div class="postbody"><span class="postbody">Multiply by the inverse with a fixed point number.
<br/>
<br/>
Something like:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
static const int inverse24 = 65536 / 24;
<br/>
<br/>
int div24(int num)
<br/>
{
<br/>
    return (num * inverse24) &gt;&gt; 16;
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
You lose a touch of precision, but it is very fast.  On DS, just use the hardware divider.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#162902 - Cearn - Mon Sep 15, 2008 11:14 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Miked0801 wrote:</b></span></td> </tr> <tr> <td class="quote">Multiply by the inverse with a fixed point number.
<br/>
Something like:
<br/>
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
static const int inverse24 = 65536 / 24;
<br/>
<br/>
int div24(int num)
<br/>
{
<br/>
    return (num * inverse24) &gt;&gt; 16;
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
You lose a touch of precision, but it is very fast.</span></td> </tr></table><span class="postbody">
<br/>
<br/>
You can get a little better accuracy for x/N by using something like (0x10000+N-1)/N for the reciprocal.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">// For N=24 and x=24:
<br/>
0x10000/24 = 2730 (==0xAAA)
<br/>
24/24 = 24*0xAAA&gt;&gt;16 = 0xFFF0&gt;&gt;16 = 0 :(
<br/>
<br/>
(0x10000+23)/24 = 2730 (==0xAAB)
<br/>
24/24 = 24*0xAAA&gt;&gt;16 = 0x1800C&gt;&gt;16 = 1 :)
<br/>
</td> </tr></table><span class="postbody">
<br/>
The second version gives identical results to standard integer division up to at least x=8192. 
<br/>
<br/>
Also, when compiling to ARM code, gcc will automatically convert divisions by a constant to multiplication by its reciprocal, and take care of any signed/unsigned shenanigans to boot.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#162911 - Miked0801 - Tue Sep 16, 2008 6:24 am</h4>
    <div class="postbody"><span class="postbody">Not in my experienced the compiler doesn't :P  Man I wish we had GCC...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#162932 - Maxxie - Tue Sep 16, 2008 5:19 pm</h4>
    <div class="postbody"><span class="postbody">(x/16 + x/32) / 2 = (3x/32) / 2 = (6x/64) / 2 = 3x/64 = x / 24
<br/>
<br/>
-&gt;
<br/>
<br/>
anyint x_div_24 = (((anyint)x &gt;&gt; 4) + ((anyint)x &gt;&gt; 5)) &gt;&gt; 1 ;
<br/>
<br/>
3 shifts, one add, no fancy magic numbers for each type of integer.<br/>_________________<br/><a class="postlink" href="http://nintendods.desperate-programmers.com/doku.php?id=wireless_io_map" target="_blank">Trying  to bring more detail into understanding the wireless hardware</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#162934 - elhobbs - Tue Sep 16, 2008 5:36 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Maxxie wrote:</b></span></td> </tr> <tr> <td class="quote">(x/16 + x/32) / 2 = (3x/32) / 2 = (6x/64) / 2 = 3x/64 = x / 24
<br/>
<br/>
-&gt;
<br/>
<br/>
anyint x_div_24 = (((anyint)x &gt;&gt; 4) + ((anyint)x &gt;&gt; 5)) &gt;&gt; 1 ;
<br/>
<br/>
3 shifts, one add, no fancy magic numbers for each type of integer.</td> </tr></table><span class="postbody">how accurate is this? am I wrong or does this give 0 for anyint = 24?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#162935 - Cearn - Tue Sep 16, 2008 5:50 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Maxxie wrote:</b></span></td> </tr> <tr> <td class="quote">(x/16 + x/32) / 2 = (3x/32) / 2 = (6x/64) / 2 = 3x/64 = x / 24
<br/>
<br/>
-&gt;
<br/>
<br/>
anyint x_div_24 = (((anyint)x &gt;&gt; 4) + ((anyint)x &gt;&gt; 5)) &gt;&gt; 1 ;
<br/>
<br/>
3 shifts, one add, no fancy magic numbers for each type of integer.</td> </tr></table><span class="postbody">
<br/>
3/64 is not 1/24; it's closer to 1/21. The calculation here is effectively multiplication by a reciprocal, just with very low precision. 1/24= 0x0.0AA..B = 0.000010101010...11. The pattern is such that you need a fair number of shifted-adds for any kind of accuracy.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#162936 - Maxxie - Tue Sep 16, 2008 5:55 pm</h4>
    <div class="postbody"><span class="postbody">Erm yes oups :p<br/>_________________<br/><a class="postlink" href="http://nintendods.desperate-programmers.com/doku.php?id=wireless_io_map" target="_blank">Trying  to bring more detail into understanding the wireless hardware</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#162941 - a128 - Tue Sep 16, 2008 8:40 pm</h4>
    <div class="postbody"><span class="postbody">Are you guys sure this has to be in DS development ?!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#162944 - shaymanjw - Tue Sep 16, 2008 9:22 pm</h4>
    <div class="postbody"><span class="postbody">@a128 - You might be right - I'm working on a tile based platform game for the DS with odd shaped tiles (32x24) and this seemed like a reasonable place.
<br/>
<br/>
Thanks for all the replies (apologies if this is the wrong place - Mods please move to wherever).</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#162957 - tepples - Wed Sep 17, 2008 3:46 am</h4>
    <div class="postbody"><span class="postbody">If you have 32x24 pixel tiles, then you might want to store your world coordinates as fixed-point fractions of a tile and then <span style="font-style: italic">multiply</span> by 24 for display.
<br/>
<br/>
That said, in an ARM (not Thumb) subroutine, try using the smull or umull instruction to multiply by 0x0AAAAAAB and then taking the upper bit.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
