<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Showing background image. - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>DS development > Showing background image.</h2>
<div id="posts">
<div class="post">
    <h4>#96159 - Dark Knight ez - Tue Aug 01, 2006 7:05 pm</h4>
    <div class="postbody"><span class="postbody">Hey all.
<br/>
<br/>
I have code running to show a background image.
<br/>
It works fine on my flashcard, but it appears that it does not on M3.
<br/>
Everything else does work fine on the M3... just not the background.
<br/>
Does someone know how to fix this?
<br/>
<br/>
My code for it is currently:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">    videoSetModeSub(MODE_5_2D | 
<br/>
                    DISPLAY_SPR_ACTIVE |    //turn on sprites
<br/>
                    DISPLAY_BG3_ACTIVE |    //turn on background 0
<br/>
                    DISPLAY_SPR_1D |        //this is used when in tile mode
<br/>
                    DISPLAY_SPR_1D_BMP      //and this in bitmap mode
<br/>
                    );
<br/>
<br/>
    SUB_BG3_CR = BG_BMP8_256x256;
<br/>
    memcpy(BG_GFX_SUB, bg_bin, 256*256);
<br/>
    memcpy(BG_PALETTE_SUB, bg_pal_bin, 256*2);
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Like I said, this _does_ work on my flashcard. Is there something the M3 expects differently, or is my code wrong and my flashcard doesn't mind that?
<br/>
<br/>
Any help would greatly be appreciated.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#96174 - knight0fdragon - Tue Aug 01, 2006 7:44 pm</h4>
    <div class="postbody"><span class="postbody">add powerON(POWER_ALL_2D);<br/>_________________<br/><a href="http://www.myspace.com/knight0fdragonds" target="_blank">http://www.myspace.com/knight0fdragonds</a>
<br/>
<br/>
MK DS FC: Dragon 330772 075464 
<br/>
AC WW FC: Anthony SamsClub 1933-3433-9458 
<br/>
MPFH: Dragon 0215 4231 1206</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#96243 - Dark Knight ez - Wed Aug 02, 2006 12:43 am</h4>
    <div class="postbody"><span class="postbody">I have this line already before doing anything:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">powerON(POWER_ALL);</td> </tr></table><span class="postbody">
<br/>
<br/>
That does even more than your suggestion.
<br/>
<br/>
POWER_ALL according to libnds:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#define POWER_ALL   (POWER_ALL_2D | POWER_3D_CORE | POWER_MATRIX)</td> </tr></table><span class="postbody">
<br/>
<br/>
Any other suggestions?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#96319 - josath - Wed Aug 02, 2006 3:52 pm</h4>
    <div class="postbody"><span class="postbody">M3 does some weird stuff, leaving things in odd states which is non-standard. I have a similar problem (the text background in my app does not show for people with M3 SD).
<br/>
<br/>
Apparently, a workaround is to launch your app from Moonshell</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#96334 - Dark Knight ez - Wed Aug 02, 2006 5:48 pm</h4>
    <div class="postbody"><span class="postbody">I was told that Moonshell can not boot NDS files on an M3...
<br/>
And that the revision of Moonshell made by the M3 team can't even do that.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#96335 - pepsiman - Wed Aug 02, 2006 6:01 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Dark Knight ez wrote:</b></span></td> </tr> <tr> <td class="quote">My code for it is currently:
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">    videoSetModeSub(MODE_5_2D | 
<br/>
                    DISPLAY_SPR_ACTIVE |    //turn on sprites
<br/>
                    DISPLAY_BG3_ACTIVE |    //turn on background 0
<br/>
                    DISPLAY_SPR_1D |        //this is used when in tile mode
<br/>
                    DISPLAY_SPR_1D_BMP      //and this in bitmap mode
<br/>
                    );
<br/>
<br/>
    SUB_BG3_CR = BG_BMP8_256x256;
<br/>
    memcpy(BG_GFX_SUB, bg_bin, 256*256);
<br/>
    memcpy(BG_PALETTE_SUB, bg_pal_bin, 256*2);
<br/>
</td> </tr></table><span class="postbody">
<br/>
</span></td> </tr></table><span class="postbody">
<br/>
No VRAM bank setup?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#96338 - Dark Knight ez - Wed Aug 02, 2006 6:25 pm</h4>
    <div class="postbody"><span class="postbody">Bank C for the background actually. Should've mentioned that.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">    vramSetBankC(VRAM_C_SUB_BG);</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#96924 - omaremad - Sun Aug 06, 2006 4:44 pm</h4>
    <div class="postbody"><span class="postbody">pepsi man has an m3 loader see drunken coder's tools</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#96989 - HyperHacker - Mon Aug 07, 2006 5:57 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Dark Knight ez wrote:</b></span></td> </tr> <tr> <td class="quote">I have this line already before doing anything:
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">powerON(POWER_ALL);</td> </tr></table><span class="postbody">
<br/>
<br/>
That does even more than your suggestion.
<br/>
<br/>
POWER_ALL according to libnds:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#define POWER_ALL   (POWER_ALL_2D | POWER_3D_CORE | POWER_MATRIX)</td> </tr></table><span class="postbody">
<br/>
<br/>
Any other suggestions?</span></td> </tr></table><span class="postbody">
<br/>
By using POWER_ALL you're turning on the 3D core and matrix processor... if you don't use these, then you're just wasting batteries.<br/>_________________<br/>I'm a PSP hacker now, but I still &lt;3 DS.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#97781 - Dark Knight ez - Fri Aug 11, 2006 2:53 pm</h4>
    <div class="postbody"><span class="postbody">I do use them, actually. You'll get to see it in a week or two.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#103828 - Dark Knight ez - Sun Sep 24, 2006 9:31 pm</h4>
    <div class="postbody"><span class="postbody">Wanted to let everyone know that I've found the solution to this problem.
<br/>
You should _not_ use memcpy to put the background graphics and palette into their respective registers.
<br/>
Use 16-bit writes in a for-loop.
<br/>
<br/>
I believe a lot of tutorials used memcpy, and are wrong. I don't know which ones I used for this, but I suggest the ones that do use memcpy be updated to reflect this.
<br/>
<br/>
<br/>
Note:
<br/>
<br/>
I discovered what the problem was, after not being able to alter the background palette somewhat further ingame in AmplituDS. 16-bit writes fixed that.
<br/>
So beware that memcpy might work sometimes (on my setup the background did display correctly with memcpy's), but can screw up at other people's homebrew setups (M3 in this case) and/or when used in other locations in the code (after initializing the game, in this case).
<br/>
I hope this is of some help to people for future reference.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#103830 - tepples - Sun Sep 24, 2006 9:46 pm</h4>
    <div class="postbody"><span class="postbody">This contradicts the findings of other people who have tested memcpy(). If the source and destination are aligned, and above a specific size threshold, it uses 32-bit writes.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#103831 - Lick - Sun Sep 24, 2006 9:47 pm</h4>
    <div class="postbody"><span class="postbody">I think it's because you didn't set the 15th bit (alpha bit) for each pixel. [edit] Which is required for the 3rd background in Mode5.
<br/>
<br/>
- Lick<br/>_________________<br/><a class="postlink" href="http://licklick.wordpress.com" target="_blank">http://licklick.wordpress.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#103836 - Dark Knight ez - Sun Sep 24, 2006 9:55 pm</h4>
    <div class="postbody"><span class="postbody">Tepples:
<br/>
I know. I was amazed to find this out myself too. I stumbled upon it.
<br/>
And if people don't believe me, their choice. There's no harm in switching to 16-bit writes instead of using memcpy though.
<br/>
<br/>
Lick:
<br/>
This is different. I'm loading in the background from an included file, and it uses the background palette. I'm not doing direct pixel writes by creating the colours on the fly, so to speak.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#103935 - Lick - Mon Sep 25, 2006 3:11 pm</h4>
    <div class="postbody"><span class="postbody">Hmm.. I'm a bit confused to be honest. This line 'SUB_BG3_CR = BG_BMP8_256x256;' doesn't that mean you -are- using a bitmap mode?
<br/>
<br/>
- Lick<br/>_________________<br/><a class="postlink" href="http://licklick.wordpress.com" target="_blank">http://licklick.wordpress.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#103939 - Dark Knight ez - Mon Sep 25, 2006 3:43 pm</h4>
    <div class="postbody"><span class="postbody">I -am-.
<br/>
However, the way I use it (an 8-bit background image which uses a palette) I do not have to worry about bit 15 and put that explicitly in my code.
<br/>
<br/>
When I would use it as a framebuffer (writing RGB(15,0,0) to a pixel for example) then I will have to explicitly OR it with bit 15. I'm not sure if and how that utilizes the background palette. I don't think it does.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#103941 - Sektor - Mon Sep 25, 2006 4:01 pm</h4>
    <div class="postbody"><span class="postbody">Try clearing the VRAM after setting up the VRAM banks.  It helped for txtWriter on M3.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
for (i = 0; i &lt; (131072); i++)
<br/>
{
<br/>
BG_GFX[i] = 0;
<br/>
}
<br/>
</td> </tr></table><span class="postbody"><br/>_________________<br/><span style="font-size: 9px; line-height: normal"><a class="postlink" href="http://gtamp.com/DS" target="_blank">GTAMP.com/DS</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#103942 - Dark Knight ez - Mon Sep 25, 2006 4:08 pm</h4>
    <div class="postbody"><span class="postbody">I have no issues with backgrounds anymore.
<br/>
My solution was to use only 16-bit writes instead of memcpy. See a few replies up.
<br/>
VRAM clearing is actually kind of pointless in my case, when I'm going to write an entire background to it anyway. I can see it being useful in other cases though.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
