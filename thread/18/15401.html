<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Handling exit() in existing code - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > Handling exit() in existing code</h2>
<div id="posts">
<div class="post">
    <h4>#154621 - Lazy1 - Sat Apr 19, 2008 9:11 am</h4>
    <div class="postbody"><span class="postbody">While I've been re-porting sdl-sopwith I have noticed that exit() is used almost everywhere.
<br/>
Since the DS has no OS to exit to this is a big problem.
<br/>
<br/>
Ideally I would like to keep the original source base in tact and only modify code specific to the DS.
<br/>
Aside from the exit() issue the port is almost ready and even has working (slightly buggy) PSG sound and TCP/IP netplay :D
<br/>
<br/>
The sound is also tricky since the SDL port just emulated the PC speaker where I just send the current frequency to the PSG.
<br/>
This causes problems when the program turns off and on the speaker causing clicks and delays.
<br/>
<br/>
Not sure how to handle that one without modifying the main sources though.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#154623 - simonjhall - Sat Apr 19, 2008 11:50 am</h4>
    <div class="postbody"><span class="postbody">You could always use the atexit (?) function to define a callback when exit gets called? You could either while(1) it in there, or use one of the reboot libraries to do something more flash.
<br/>
<br/>
No idea about the sound thing though - I've never used the psg!<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#154628 - silent_code - Sat Apr 19, 2008 2:04 pm</h4>
    <div class="postbody"><span class="postbody">this may be obsolete to you, but do you wait the required amount of milliseconds after enabling sound? i can't think of anything else right now.
<br/>
<br/>
good luck and happy coding! :^D</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#154643 - Lazy1 - Sat Apr 19, 2008 7:28 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>silent_code wrote:</b></span></td> </tr> <tr> <td class="quote">this may be obsolete to you, but do you wait the required amount of milliseconds after enabling sound? i can't think of anything else right now.
<br/>
<br/>
good luck and happy coding! :^D</td> </tr></table><span class="postbody">
<br/>
<br/>
I guess I don't but would that really cause the problem?
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>simonjhall wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
You could always use the atexit (?) function to define a callback when exit gets called? You could either while(1) it in there, or use one of the reboot libraries to do something more flash. 
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
But isn't there a way to restart the application without having to reload it?
<br/>
Also, is atexit() called before or after the crt shutdown code (if there is any)?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#154646 - silent_code - Sat Apr 19, 2008 8:08 pm</h4>
    <div class="postbody"><span class="postbody"><a class="postlink" href="http://nocash.emubase.de/gbatek.htm#dssound" target="_blank">gbatek</a>:
<br/>
Power control
<br/>
When restoring power supply to the sound circuit, do not output any sound during the first 15 milliseconds.
<br/>
<br/>
i say: who knows? probably not all of them, altough it might be - i don't know. depends on what "turns off and on the speaker" means in terms of how it's done. ;^)
<br/>
good luck!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#154655 - Cydrak - Sat Apr 19, 2008 10:47 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>silent_code wrote:</b></span></td> </tr> <tr> <td class="quote">this may be obsolete to you, but do you wait the required amount of milliseconds after enabling sound?</td> </tr></table><span class="postbody">
<br/>
This doesn't apply to the PSG registers, it's for powering the whole sound engine itself. For example, when I came out of sleep-mode, I used to get "stuck notes" in my music. As if it was too groggy to see any register writes, for a frame or so. :)
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Lazy1 wrote:</b></span></td> </tr> <tr> <td class="quote">But isn't there a way to restart the application without having to reload it?</td> </tr></table><span class="postbody">
<br/>
Restarting is "halfway" possible, but I seem to remember some unpleasant side-effects. Such as certain globals not being reset, since they were initialized by the compiler... needless to say, code is not so well-behaved after that. &gt;_&gt;
<br/>
<br/>
While something like this could be properly arranged--DTCM data has to be be copied at runtime after all--, I don't think it's supported at the moment. (Someone correct me if I'm wrong.)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#154658 - Lazy1 - Sun Apr 20, 2008 12:33 am</h4>
    <div class="postbody"><span class="postbody">What I might do for the sound is just throw the PC speaker emulation on the arm7, that should solve the stop/start problem as well as sound closer to the original.
<br/>
Only thing is that it uses floats in a lot of places so I'm not sure if it'll be fast enough there.
<br/>
<br/>
I made a few attempts to convert the code PC side to fixed-point with the latest attempt sounding "closer" but eventually crashing :D
<br/>
Maybe I still just can't wrap my head around it.
<br/>
<br/>
As for restarting the game there is a restart function to reset the game but the problem is that registering my atexit() function is not enough, something breaks along the way.
<br/>
<br/>
Now...
<br/>
My old hack was really sick which added -Uexit -Dexit=NDSExitHack to the CFLAGS and simply called the game's restart function.
<br/>
<br/>
I'm not sure how well that would work since exit() is expected to never return.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#154660 - wintermute - Sun Apr 20, 2008 1:07 am</h4>
    <div class="postbody"><span class="postbody">Restarting an application without reloading is not possible.
<br/>
<br/>
exit() is something I may look at again in the future, I'm making use of this in devkitPPC to return to the boot loader. This is slightly more problematic on the DS, especially given the vast array of devices available to boot homebrew code.
<br/>
<br/>
There's a pretty big argument for supporting only a limited subset of homebrew devices, I'm not really sure how well the general userbase would take to that though.<br/>_________________<br/><a class="postlink" href="http://www.devkitpro.org/" target="_blank">devkitPro - professional toolchains at amateur prices</a>
<br/>
<a class="postlink" href="http://wiki.devkitpro.org/index.php/IRC" target="_blank">devkitPro IRC support</a>
<br/>
<a class="postlink" href="http://davejmurphy.com/" target="_blank">Personal Blog</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#154740 - dantheman - Mon Apr 21, 2008 3:26 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>wintermute wrote:</b></span></td> </tr> <tr> <td class="quote">There's a pretty big argument for supporting only a limited subset of homebrew devices, I'm not really sure how well the general userbase would take to that though.</td> </tr></table><span class="postbody">
<br/>
<br/>
Given how quickly DLDI took off after it opened up the world of homebrew to more users, I'm rather skeptical myself.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#154917 - nutki - Tue Apr 22, 2008 11:01 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>wintermute wrote:</b></span></td> </tr> <tr> <td class="quote">exit() is something I may look at again in the future, I'm making use of this in devkitPPC to return to the boot loader. This is slightly more problematic on the DS, especially given the vast array of devices available to boot homebrew code.
<br/>
<br/>
There's a pretty big argument for supporting only a limited subset of homebrew devices, I'm not really sure how well the general userbase would take to that though.</td> </tr></table><span class="postbody">
<br/>
<br/>
How about adding device dependent exit procedure as part of DLDI calls? This would move DLDI directly to toolchain while now it is a libfat thing, but has great advantage of being able to support future hardware without recompiling existing applications. Also possibly move some work from devkitARM maintainers to third parties. 
<br/>
I proposed changes to DLDI inteface also in 'Why does some homebrew demand root installation?' thread. Adding more DLDI features at once (not necessarily the ones I came up with) would help promoting new verion.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#154920 - Lazy1 - Tue Apr 22, 2008 11:15 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>nutki wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
How about adding device dependent exit procedure as part of DLDI calls? </td> </tr></table><span class="postbody">
<br/>
<br/>
Isn't DLDI arm9 only?
<br/>
If I remember correctly restarting requires the help of the arm7 too.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#154924 - nutki - Tue Apr 22, 2008 11:47 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Lazy1 wrote:</b></span></td> </tr> <tr> <td class="quote">Isn't DLDI arm9 only?
<br/>
If I remember correctly restarting requires the help of the arm7 too.</td> </tr></table><span class="postbody">
<br/>
<br/>
I was not aware of that. However DLDI is just a set of functions and is located in memory area accessible by both CPUs as far I know. Things would get complicated (but still doable) if exit procedure would be something more than call arm9_exit() then arm7_exit() or differ between devices.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#154949 - HyperHacker - Wed Apr 23, 2008 5:54 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Lazy1 wrote:</b></span></td> </tr> <tr> <td class="quote">My old hack was really sick which added -Uexit -Dexit=NDSExitHack to the CFLAGS and simply called the game's restart function.
<br/>
<br/>
I'm not sure how well that would work since exit() is expected to never return.</td> </tr></table><span class="postbody">To be honest I'd just use this (or atexit() if it works) and make the function print something like "Program terminated" and loop forever (or power off). exit() is supposed to end the process, this seems like the next best thing.
<br/>
<br/>
When I used exit() on the DS (a library I was using called it) it just showed the standard exception screen, which makes sense (though I'm not sure it was intentional). Returning to the loader would be better, but if that's not possible (due to having to get both CPUs involved), just showing the exception screen with a "Program terminated" or "exit() called" message seems like the next best idea.
<br/>
<br/>
With the plan to implement a standard ARM7 binary and use the FIFO, though, I think the best idea is to define a message in libNDS that gets sent to the other CPU when exit() is called, signaling it to enter the return-to-loader routine. For those who are using custom ARM7 binaries, there'd be some way to change the value of the message (#define it before including nds.h or something) so it doesn't collide with their own message protocol. (I.e. make the message 0xDEADBEEF or something by default, but if you're already using 0xDEADBEEF for something and it's infeasible to change it, you can re-define the message to some other value.)
<br/>
<br/>
The real problem would be the return-to-loader code itself. Could we stick this in the DLDI patches? Using some reserved field or magic word to find the function body within the DLDI section?<br/>_________________<br/>I'm a PSP hacker now, but I still &lt;3 DS.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#154976 - silent_code - Wed Apr 23, 2008 2:55 pm</h4>
    <div class="postbody"><span class="postbody">"It's now safe to turn off your (computer) NDS."
<br/>
anyone? ;^)
<br/>
<br/>
it's also possible (as others have already pointed out) to shut the system down. (via the power register or what ever it is called [where you can turn off background lighting and stuff])</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#155011 - tepples - Wed Apr 23, 2008 10:26 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>silent_code wrote:</b></span></td> </tr> <tr> <td class="quote">it's also possible (as others have already pointed out) to shut the system down. (via the power register or what ever it is called [where you can turn off background lighting and stuff])</td> </tr></table><span class="postbody">
<br/>
Yeah, that's what memtestARM and RAC do, with appropriately in-character remarks. It even appears to be <span style="font-style: italic">recommended</span>, given that three applications in the firmware do the same thing.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#155036 - simonjhall - Thu Apr 24, 2008 7:48 am</h4>
    <div class="postbody"><span class="postbody">And I can vouch for tepples' shutdown code in memtestARM as I pinched it for Q2! (ta mate)<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
