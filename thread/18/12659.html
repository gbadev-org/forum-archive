<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Sounds - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>DS development > Sounds</h2>
<div id="posts">
<div class="post">
    <h4>#121148 - Crs - Fri Mar 09, 2007 3:00 pm</h4>
    <div class="postbody"><span class="postbody">Greets,
<br/>
<br/>
Having started reading up on NDS dev, I have read that ARM7 deals with sound processing.  Is it possible to pass a pointer of an array containing raw sound data from ARM9 to ARM7 and have the ARM7 play it?
<br/>
<br/>
((Sorry I can't test anything at the moment, just thought I'd ask))
<br/>
<br/>
Thanks!<br/>_________________<br/><a href="http://www.hazardball.com" target="_blank">www.hazardball.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#121156 - 0xtob - Fri Mar 09, 2007 4:36 pm</h4>
    <div class="postbody"><span class="postbody">Yep, and that's also how the libnds sound functions do it.<br/>_________________<br/><a class="postlink" href="http://blog.dev-scene.com/0xtob" target="_blank">http://blog.dev-scene.com/0xtob</a> | <a class="postlink" href="http://nitrotracker.tobw.net" target="_blank">http://nitrotracker.tobw.net</a> | <a class="postlink" href="http://dsmi.tobw.net" target="_blank">http://dsmi.tobw.net</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#121215 - Crs - Sat Mar 10, 2007 9:00 am</h4>
    <div class="postbody"><span class="postbody">Thanks thats very good to know :)<br/>_________________<br/><a href="http://www.hazardball.com" target="_blank">www.hazardball.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#122165 - gho - Sat Mar 17, 2007 2:59 pm</h4>
    <div class="postbody"><span class="postbody">Hi, 
<br/>
<br/>
I would like to use the FIFO mechanism to let the ARM7 play PSG sounds controlled by ARM9 code. 
<br/>
<br/>
<br/>
So far, I set up a structure for the ARM9 and the ARM7 like this:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">typedef struct snd_data {
<br/>
      u8 channel;
<br/>
      u8 vol;
<br/>
      u8 pan;
<br/>
      u8 duty;
<br/>
      int freq;
<br/>
      } psgPlayData, *ptrPsgPlay;</td> </tr></table><span class="postbody">
<br/>
<br/>
For the ARM7 I have a function, that tells the PSG what to do:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void playSound(u8 channel, u8 vol, u8 pan, u8 duty, int freq) {
<br/>
<br/>
SCHANNEL_TIMER(channel) = SOUND_FREQ(freq &lt;&lt; 3);
<br/>
SCHANNEL_CR(channel) = SOUND_VOL(vol) | SOUND_PAN(pan) | SCHANNEL_WAVEDUTY(duty) | SOUND_FORMAT_PSG | SCHANNEL_ENABLE;
<br/>
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
<br/>
<br/>
For playing a sound the idea is to fill in the structure on the ARM9 side
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">psgPlayData test, *ptrPsgPlay;
<br/>
   ptrPsgPlay=&amp;test;
<br/>
   
<br/>
   test.channel=14;
<br/>
   test.vol=127;
<br/>
   test.pan=64;
<br/>
   test.duty=4;
<br/>
   test.freq=440;</td> </tr></table><span class="postbody">
<br/>
<br/>
and pass the information to the ARM7 using the FIFO.
<br/>
<br/>
Here is my problem: I have no idea, how to get the information in the ARM9 structure over to the ARM7 section. Probably somehow by placing the pointer to the structure on the FIFO? How is this done, and how to "catch" the pointer on the ARM7 side?
<br/>
<br/>
Thanks!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#122187 - HyperHacker - Sat Mar 17, 2007 8:00 pm</h4>
    <div class="postbody"><span class="postbody">You have to enable the FIFO on both ends, then write the pointer to that struct into it on ARM9. On ARM7, in your interrupt handler, check the FIFO Not Empty bit, and as long as it's set, keep reading words from the FIFO and doing whatever with them. You'll need some way of indicating that the pointer you just passed points to a snd_data struct; the ideal way to do this is to send a number before the pointer that tells what it's used for.
<br/>
<br/>
Just be careful with this; don't point to a local variable, as the ARM7 may not process the message until your function returns, and the pointer will no longer be valid!<br/>_________________<br/>I'm a PSP hacker now, but I still &lt;3 DS.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#122190 - gho - Sat Mar 17, 2007 8:11 pm</h4>
    <div class="postbody"><span class="postbody">Thanks, I will try that out. I get a bit confused by pointers.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#122195 - 0xtob - Sat Mar 17, 2007 8:27 pm</h4>
    <div class="postbody"><span class="postbody">Also beware of caching problems. Before putting the pointer into the queue, make sure the data is written into RAM by flushing the cache for the sound struct using
<br/>
<br/>
DC_FlushRange(const void *base, u32 size);<br/>_________________<br/><a class="postlink" href="http://blog.dev-scene.com/0xtob" target="_blank">http://blog.dev-scene.com/0xtob</a> | <a class="postlink" href="http://nitrotracker.tobw.net" target="_blank">http://nitrotracker.tobw.net</a> | <a class="postlink" href="http://dsmi.tobw.net" target="_blank">http://dsmi.tobw.net</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#122196 - simonjhall - Sat Mar 17, 2007 8:27 pm</h4>
    <div class="postbody"><span class="postbody">I never like using the fifo, so my IPC stuff starts up by trashing a piece of memory that I don't care about and know the address beforehand (0x2000000)
<br/>
<br/>
Here's my IPC startup
<br/>
<br/>
ARM7: spin on 0x2000000 not being zero
<br/>
ARM9: I set 0x2000000 to zero
<br/>
ARM7: spin on 0x2000000 being zero
<br/>
ARM9: I malloc space for my IPC struct. I then take the address of this new struct and write it into 0x2000000
<br/>
ARM9: spin on 0x2000000 not being zero
<br/>
ARM7: 0x2000000 is now no longer zero, so read the data out of that address and use it as a pointer to my new IPC struct
<br/>
ARM7: set 0x2000000 to zero
<br/>
ARM9: restore the original value that was at 0x2000000
<br/>
<br/>
Sha-zam - both your processors now have a common block of memory that they both know about. No FIFO nor interrupt hoo-ha needed!
<br/>
<br/>
Don't forget to OR the address you get back from malloc with 0x400000 to make sure it's uncached.
<br/>
<br/>
When you want to pass a message from one processor to another (eg 7-&gt;9), do this:
<br/>
7: is the struct in use? If so, spin until it's not
<br/>
7: lock the struct, so the other processor can't use it
<br/>
7: write the data
<br/>
7: set the struct's 'ready to be processed' member to true
<br/>
7: spin on struct being ready to be processed == true
<br/>
9's vertical blank: if ready to be processed flag = true, process data
<br/>
9's vertical blank: set ready to be processed to false
<br/>
7: unlock the struct
<br/>
<br/>
So basically, your struct will also need a 'locked' member and a 'ready to be processed' member. Send messages from the 'main thread' of one processor and pick up the results by polling for the ready flag on the other processor (I do it in the hblank)<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#122361 - gho - Sun Mar 18, 2007 10:14 pm</h4>
    <div class="postbody"><span class="postbody">Wow, thanks, it works! 
<br/>
<br/>
I initialized the snd_data struct outside of the ARM9 main function to make it global (thanks HyperHacker, that was crucial).
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">psgPlayData test, *ptrPsgPlay;</td> </tr></table><span class="postbody">
<br/>
<br/>
and place the pointer on the FIFO queue after flushing  like this :
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
DC_FlushAll(); //a bit unelegant
<br/>
REG_IPC_FIFO_TX =   (int) ptrPsgPlay;</td> </tr></table><span class="postbody">
<br/>
<br/>
<br/>
<br/>
On the ARM7 side I have set up a handler for IRQ_FIFO_NOT_EMPTY, which reads the value from the queue:
<br/>
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void FIFOHandler(void) {
<br/>
<br/>
psgPlayData *ptrPsgPlay;
<br/>
u8 channel;
<br/>
u8 vol;
<br/>
u8 pan;
<br/>
u8 duty;
<br/>
int freq;
<br/>
  
<br/>
<br/>
    ptrPsgPlay= (psgPlayData *) REG_IPC_FIFO_RX;
<br/>
      
<br/>
    channel=(*ptrPsgPlay).channel;
<br/>
    vol=(*ptrPsgPlay).vol;
<br/>
    pan=(*ptrPsgPlay).pan;
<br/>
    duty=(*ptrPsgPlay).duty;
<br/>
    freq=(*ptrPsgPlay).freq;
<br/>
      
<br/>
    playSound(channel, vol, pan, duty, freq); 
<br/>
     
<br/>
}</td> </tr></table><span class="postbody">
<br/>
.
<br/>
<br/>
The casts were a bit tricky, my C is a bit rusted, and I don't understand pointers very well.
<br/>
<br/>
Changing PSG behaviour can now simply be done from ARM9 by writing values into the psgPlayData struct. 
<br/>
<br/>
Exciting! One step closer to a one channel PSG-Tracker. Thanks again all!
<br/>
<br/>
Edit:
<br/>
Flushing before placing the pointer is also crucial to get it to run on hardware. Thanks 0xtob.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
