<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Relocating the stack with the PU - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > Relocating the stack with the PU</h2>
<div id="posts">
<div class="post">
    <h4>#124536 - simonjhall - Fri Apr 06, 2007 6:23 pm</h4>
    <div class="postbody"><span class="postbody">I've got this killer function which takes loads of CPU time (it's in floating-point too), it's recursive, and has huge stack frames. There are cases where the function goes a little nuts and runs out of stack, crashing the game.
<br/>
<br/>
I've tried improving it's performance by converting it to fixed-point, but the compiler seems to generate lots of temporaries which are getting stored to the stack. This means the stack frames are even larger than normal and the game crashes even easier.
<br/>
<br/>
I can relocate the stack (for the duration of the function) by just moving $sp to a place in main memory, but obviously the performance dips a bit. I'd ideally like to use the DTCM as much as possible, and the ARM9's CP allows you to move the address of the DTCM so can I just move it to the very end of memory? That way when it'd run out of stack it'd just spill into main memory...
<br/>
<br/>
However (the reason I'm posting), what happens to interrupt handlers when I do this? Do they still expect the stack to exist in the previous position? And isn't the IPC struct at the very end of main memory? Anything else I should be worried about?<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#124539 - DekuTree64 - Fri Apr 06, 2007 7:26 pm</h4>
    <div class="postbody"><span class="postbody">Yeah, the IRQ stack would be pointing to garbage if you yank DTCM out from under it. You could offset it by however much you move DTCM though. SVC stack (used by SWI functions) may be pointing to DTCM as well.
<br/>
Make sure you disable interrupts while fiddling with things.
<br/>
<br/>
As for the IPC, you could just put DTCM overlapping it, so if the stack spills into main RAM, it will be below IPC. Since IPC is always(?) accessed in the non-cached mirror of main RAM anyway, and stack would be much better if cached, then the overlap shouldn't cause any trouble.
<br/>
<br/>
Of course, using main RAM as stack will be chopping down your total available memory, to make sure that address range is always available. I'd try to rewrite the function to do manual recursion first.<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#124746 - wintermute - Sun Apr 08, 2007 4:27 am</h4>
    <div class="postbody"><span class="postbody">It's probably an extremely bad idea to move DTCM during program execution, I certainly wouldn't attempt it. 
<br/>
<br/>
To move dtcm you'll need to adjust the linkscript slightly. The easiest, and my personally recommended, way to do this is use a linkscript fragment in your project.
<br/>
<br/>
Create a file called dtcm.ld in the root of your arm9 code which contains this
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
MEMORY {
<br/>
   dtcm   : ORIGIN = 0x023f8000, LENGTH = 16K
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Then add ../dtcm.ld to LDFLAGS
<br/>
<br/>
You should get a " warning: redeclaration of memory region 'dtcm'" warning when your project gets linked and dtcm should now be at the end of main memory.
<br/>
<br/>
Done this way the interrupt handlers &amp; stacks will be happily relocated at compile time. The only potential problem here is that malloc may give you memory which overlaps your stack but hopefully you're not tight enough on memory for that to be an issue.
<br/>
<br/>
I had to go through libnds and remove a bunch of absolute addresses when I moved dtcm before so everything in there should be fine.<br/>_________________<br/><a class="postlink" href="http://www.devkitpro.org/" target="_blank">devkitPro - professional toolchains at amateur prices</a>
<br/>
<a class="postlink" href="http://wiki.devkitpro.org/index.php/IRC" target="_blank">devkitPro IRC support</a>
<br/>
<a class="postlink" href="http://davejmurphy.com/" target="_blank">Personal Blog</a></span><span class="gensmall"><br/><br/>Last edited by wintermute on Fri Nov 16, 2007 11:47 am; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#124754 - sajiimori - Sun Apr 08, 2007 6:00 am</h4>
    <div class="postbody"><span class="postbody">Are you talking about one of the BSP checks?  If so, those aren't <span style="font-style: italic">too</span> hard to convert to use a hand-made stack instead of native C recursion, which would save tons of stack space, and it's faster to boot.
<br/>
<br/>
Here's a Quake-like ray-vs-BSP test outline using native recursion and omitting terminal cases:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
int bspTest(Ray* r, Node* n)
<br/>
{
<br/>
   if(r is completely on inner side of n)
<br/>
      return bspTest(r, n-&gt;inner);
<br/>
<br/>
   if(r is completely on outer side of n)
<br/>
      return bspTest(r, n-&gt;outer);
<br/>
<br/>
   Ray nearRay = part of r on near side of n;
<br/>
<br/>
   if(bspTest with nearRay shows collision)
<br/>
      return result of nearRay test;
<br/>
<br/>
   Ray farRay = part of r on far side of n;
<br/>
   return result of farRay test;
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
You could translate it to this, which is similar to what I use:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
struct Iteration
<br/>
{
<br/>
   Ray r;
<br/>
   Node* n;
<br/>
};
<br/>
<br/>
int bspTest(Ray* wholeRay, Node* root)
<br/>
{
<br/>
   Iteration stack[MAX_RECURSION_DEPTH];
<br/>
   Iteration* sp = &amp;stack[0];
<br/>
<br/>
   // Push initial iteration onto stack.
<br/>
   sp-&gt;r = *wholeRay;
<br/>
   sp-&gt;n = root;
<br/>
   ++sp;
<br/>
<br/>
   while(sp &gt; &amp;stack[0])
<br/>
   {
<br/>
      pop an iteration off the stack and decrement sp;
<br/>
<br/>
      if(ray is completely on inner side of n)
<br/>
      {
<br/>
         push iteration for inner side;
<br/>
         continue;
<br/>
      }
<br/>
<br/>
      if(ray is completely on outer side of n)
<br/>
      {
<br/>
         push iteration for outer side;
<br/>
         continue;
<br/>
      }
<br/>
<br/>
      push iteration for far side;
<br/>
      push iteration for near side;
<br/>
   }
<br/>
}
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#124878 - simonjhall - Mon Apr 09, 2007 2:23 pm</h4>
    <div class="postbody"><span class="postbody">Yeah, you're exactly right! It's the BSP collision stuff and is used for *everything*. The problem is I don't really know anything about BSPs so I can't do anything smart regarding optimising it - I can just do my usual stuff...
<br/>
I had a go (again) last night at improving the performance/stack usage of the function but I'm still not happy. I may just post the function up here to see if the people who know what they're doing are able to improve it!
<br/>
<br/>
Btw ta wintermute, I'll have a go with this...<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#124892 - sajiimori - Mon Apr 09, 2007 6:29 pm</h4>
    <div class="postbody"><span class="postbody">Translating to manual recursion is a mechanical process, really.  You don't have to know anything about how it works, as long as the same operations are happening.  Just about any recursive function can be translated into this format:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">ReturnType recursiveFunction(Arguments args)
<br/>
{
<br/>
   // "Iteration" struct described later.
<br/>
   Iteration stack[MAX_ITERATIONS];
<br/>
<br/>
   // Stack pointer.
<br/>
   Iteration* sp = &amp;stack[0];
<br/>
<br/>
   sp-&gt;state = ST_ENTRY;
<br/>
   sp-&gt;args = args;
<br/>
   ++sp;
<br/>
<br/>
   while(sp &gt; &amp;stack[0])
<br/>
   {
<br/>
      Iteration it = *sp;
<br/>
      --sp;
<br/>
<br/>
      // 'state' enum described later.
<br/>
      switch(it.state)
<br/>
      {
<br/>
      case ST_ENTRY:
<br/>
         ...
<br/>
<br/>
      case ...
<br/>
      }
<br/>
   }
<br/>
}</td> </tr></table><span class="postbody">
<br/>
When you're at the top of the 'while' loop, that's like re-entering the function, whether it's beginning a new call or returning from a nested call.
<br/>
<br/>
The 'state' enum describes what stage of execution the iteration is at: whether it's just beginning, or returning from the first recursive call, or from the second recursive call, etc.
<br/>
<br/>
Besides that, the Iteration struct contains the arguments for each recursive call, as well as any other would-be local variables that are needed upon returning from a nested call.
<br/>
<br/>
Of course, knowing how it the original function works often results in better optimizations and/or simpler code, but this translation alone will solve the problem, I guarantee.  My BSP code was absolutely <span style="font-style: italic">hopeless</span> until it used manual recursion.  Just a few iterations would blow the stack.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#125371 - simonjhall - Thu Apr 12, 2007 9:46 pm</h4>
    <div class="postbody"><span class="postbody">Btw I forgot to say thanks for the heads-up on this. I just finished converting the BSP traversal to this non-recursive format and it (obviously) no longer runs out of stack! The magic button which crashes the game (in e2m2) no longer works! Excellent :-)
<br/>
It's a really interesting way of programming something and definately makes you think about what you're writing. Kinda reminds me of building and executing functions on the fly in Scheme whilst at uni! (a world of pain)
<br/>
<br/>
Now it's time to go to work on this function and make it faaast...<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#125491 - Jevin - Fri Apr 13, 2007 10:28 pm</h4>
    <div class="postbody"><span class="postbody">Would you mind telling us how you went from recursive version to a non-recursive version? I'm obviously interested. :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#125497 - simonjhall - Fri Apr 13, 2007 11:11 pm</h4>
    <div class="postbody"><span class="postbody">I'm working on it right now, but once when I'm done I'll upload both the original (floating-point) recursive version and the flat (floating-point version) just so you can see how the transformation works. If you care, I'll also show the fixed-point version so people can scrutinise/fix it!
<br/>
<br/>
Basically, using the code in this thread as a guide, I maintain my own stack and push and pop data onto it. The recursion gets turned into a big switch statement which decides where abouts in the flow of the code you are (yeah, it sounds complicated - wait for the code). As the individual calls to the functions need to return true/false, this needs to be recorded too. Plus when a function does a return to the previous stack frame, that result isn't returned directly straight to 'the top' - the program may then take that return value and manipulate it. So this required the concept of a link register, to say where to continue from when returning to the previous 'stack frame'.
<br/>
<br/>
Again, it'll make sense once you see the code!
<br/>
<br/>
But having now trawled through the function, I know exactly what it does. Plus as it never calls itself (in the C sense) I know just where the function is called from (in the rest of the program) and how it can be called. This has made converting it to fixed-point a breeze! Still needs to be faster though...<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
