<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>dswifilib, DevKitARM and stack... crash boom - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > dswifilib, DevKitARM and stack... crash boom</h2>
<div id="posts">
<div class="post">
    <h4>#107755 - ttursas - Wed Nov 01, 2006 8:00 pm</h4>
    <div class="postbody"><span class="postbody">Here we go again... I haven't released a new version of Wright Flight because once again
<br/>
dswifilib crashes the game. I just send one UDP packet and boom. The interesting thing is
<br/>
that this all worked fine four days ago. After adding some code and data files to the game
<br/>
the crashes started again (happened before, but the latest dswifilib release fixed that for
<br/>
a while).
<br/>
<br/>
I've been through my code and I've disabled a big part of it, and there doesn't seem to be
<br/>
anything wrong with it. I've replaced the memory managed in dswifilib, but no help there.
<br/>
Every time I send one UDP packet the game crashes. The irqs work on ARM9, but the
<br/>
main and the only thread gets stuck at the end of one function. It doesn't return from there
<br/>
even though there's nothing blocking it. So it is a stack problem?
<br/>
<br/>
Anyway, this got me thinking.
<br/>
<br/>
arm9/build/.map says:
<br/>
Name             Origin             Length
<br/>
rom              0x08000000         0x02000000
<br/>
ewram            0x02000000         0x003ff000
<br/>
dtcm             0x0b000000         0x00004000
<br/>
itcm             0x01000000         0x00008000
<br/>
*default*        0x00000000         0xffffffff
<br/>
<br/>
... and...
<br/>
<br/>
.stack          0x00080000        0x0
<br/>
                0x00080000                _stack = .
<br/>
 *(.stack)
<br/>
<br/>
...
<br/>
<br/>
I don't move DTCM myself, but does DevKitARM's stuff move it? Is there any RAM at
<br/>
0x80000 in NDS? If not, where is my stack!? :)
<br/>
<br/>
Any ideas? All help is appriciated...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#107765 - ttursas - Wed Nov 01, 2006 8:59 pm</h4>
    <div class="postbody"><span class="postbody">After cleaning the code and doing small changes here and there the game gets stuck
<br/>
after connecting to an AP. Previously that worked... Any ideas? I'm using M3-SD...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#107773 - ttursas - Wed Nov 01, 2006 9:59 pm</h4>
    <div class="postbody"><span class="postbody">I cleaned up the code more, and now the following happens: I can connect to an AP and
<br/>
it's ok, the game continues without crashing. Now, if I send an UDP packet to my PC the
<br/>
game will crash pretty soon. It doesn't matter if I have my server running on my PC or not.
<br/>
A crash will follow. But if I send that UDP packet to an IP where I have no PC -&gt; no crash.
<br/>
<br/>
I'm doing connectionless UDP, sendto() and recvfrom().
<br/>
<br/>
Also, I'm doing C99 stuff. Could this be the culprit? I.e. // comments and I'm allocating
<br/>
variables on the fly, not at the beginning of the function. And when I've moved the introduction
<br/>
of those variables to the beginning of the function dswifilib has worked a bit better. ???
<br/>
Not much, I still have crashes, but less often...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#107779 - ttursas - Wed Nov 01, 2006 11:20 pm</h4>
    <div class="postbody"><span class="postbody">According to this page
<br/>
<br/>
<a href="http://gcc.gnu.org/gcc-4.1/c99status.html" target="_blank">http://gcc.gnu.org/gcc-4.1/c99status.html</a>
<br/>
<br/>
The two C99 features I'm using, "// comments" and "mixed declaration and code" should
<br/>
work... Hmm...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#108071 - ttursas - Sun Nov 05, 2006 12:49 am</h4>
    <div class="postbody"><span class="postbody">I got it to work again, by doing the following things (taken from Wright Flight's CHANGELOG):
<br/>
<br/>
* Removed TCP code from dswifilib, and changed the two framehdr[] arrays that were 
<br/>
   allocated from stack to be larger and allocated from heap apparently fixing the network
<br/>
   play as it works again. Also rewrote memcpy() and strncpy() so that no libg is needed
<br/>
   for them by dswifilib.
<br/>
<br/>
...
<br/>
<br/>
Don't really know 100% what's going on, but that solved my problems, and it works again!
<br/>
And if it breaks once more, I'll get back to this. :P</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#115284 - ttursas - Sun Jan 14, 2007 5:23 pm</h4>
    <div class="postbody"><span class="postbody">dswifilib seems to eat quite a lot of stack, especially in ARM7 interrupts.
<br/>
Wifi_ProcessReceivedFrame() is a good example of this. Taking a look at the default
<br/>
devkitPRO link script output (or whatever it's called), it seems that interrupts have a 256
<br/>
byte stack. Is this true? Anyway, I'll move all those 512 byte arrays to heap, and release
<br/>
the stripped version (that can only do UDP) on Wright Flight www-page
<br/>
( <a href="http://www.iki.fi/~vhelin/nintendoDS.html" target="_blank">http://www.iki.fi/~vhelin/nintendoDS.html</a> ).</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
