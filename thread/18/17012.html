<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Self-modifying code framework? - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>DS development > Self-modifying code framework?</h2>
<div id="posts">
<div class="post">
    <h4>#171702 - Pate - Tue Dec 15, 2009 6:53 am</h4>
    <div class="postbody"><span class="postbody">Hi!
<br/>
<br/>
In my DSx86 emulator I could really use self-modifying code to speed up some things. The problem is, I haven't been able to get self-modifying code to work realiably. It seems to work for a few seconds, and then DSx86 crashes.
<br/>
<br/>
I was wondering, have some of you used self-modifying code (running in ITCM), and what exactly is needed to make this reliable? I think the ARM ARM states that an implementation-specific CPU pipeline flushing is needed before the instruction pointer accesses the self-modified code, but what might this implementation-specific thing be on NDS?
<br/>
<br/>
Thanks!
<br/>
<br/>
Pate<br/>_________________<br/><ul><li>Now working on DSx86 <a href="http://dsx86.patrickaalto.com" target="_blank">http://dsx86.patrickaalto.com</a>
<br/>
</li><li>Get LineWarsDS from <a href="http://linewars.patrickaalto.com" target="_blank">http://linewars.patrickaalto.com</a></li></ul></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#171703 - sverx - Tue Dec 15, 2009 9:47 am</h4>
    <div class="postbody"><span class="postbody">I guess you should invalidate ARM9 instruction cache... libnds has <span style="font-style: italic">IC_InvalidateAll()</span> (or <span style="font-style: italic">IC_InvalidateRange(const void *base, u32 size);</span> ) function for instance...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#171704 - Pate - Tue Dec 15, 2009 10:20 am</h4>
    <div class="postbody"><span class="postbody">Hmm.. My code that I want to change is in ITCM, which I thought does not use the instruction cache?
<br/>
<br/>
Pate<br/>_________________<br/><ul><li>Now working on DSx86 <a href="http://dsx86.patrickaalto.com" target="_blank">http://dsx86.patrickaalto.com</a>
<br/>
</li><li>Get LineWarsDS from <a href="http://linewars.patrickaalto.com" target="_blank">http://linewars.patrickaalto.com</a></li></ul></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#171705 - sverx - Tue Dec 15, 2009 10:32 am</h4>
    <div class="postbody"><span class="postbody">Oh, right :| **!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#171706 - kusma - Tue Dec 15, 2009 11:48 am</h4>
    <div class="postbody"><span class="postbody">In that case, the only thing I can think of is making sure you don't modify the next couple of instructions (that is, don't modify PC+4 and PC+8 in ARM mode, or PC+2 and PC+4 in THUMB mode), since they are already fetched from memory. Do note that ARM9 has a longer than 3 stage pipeline, but I do believe it does some stalling to emulate the ARM7 (and earlier) behavior.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#171707 - Pate - Tue Dec 15, 2009 12:32 pm</h4>
    <div class="postbody"><span class="postbody">Ok.. In that case it looks like the problem is not directly Self-Modifying-Code -related. What I attempted to do was simply to change the immediate value of an instruction, and I couldn't understand why it would crash.
<br/>
<br/>
This is the code:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#if SELFMODTEST
<br/>
    ldrb    r0,[r12],#1            @ Load opcode byte to r0, increment r12 by 1
<br/>
    mov     r2,r3               @ Clear segment override, r2 = r3 = physical DS:0000
<br/>
    .global IRQ_SM
<br/>
IRQ_SM:   
<br/>
    and     r1, r0, #0xFF         @ AND the opcode value with the IRQFlag value, result is either just the opcode or 0
<br/>
#else
<br/>
    ldr     r1,[sp, #SP_IRQFLAG]   @ Get the IRQFlag value (set to 0 if we need to handle an IRQ, else 0xFF)
<br/>
    ldrb    r0,[r12],#1            @ Load opcode byte to r0, increment r12 by 1
<br/>
    mov     r2,r3               @ Clear segment override, r2 = r3 = physical DS:0000
<br/>
    and     r1, r0               @ AND the opcode value with the IRQFlag value, result is either just the opcode or 0
<br/>
#endif   
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I store (in a real timer interrupt handler) 0 to the immediate byte at IRQ_SM when I want to handle an IRQ, and store 0xFF there when I want to continue normally.
<br/>
<br/>
It was some time ago when I last tested this, perhaps I just need to try again.
<br/>
<br/>
Pate<br/>_________________<br/><ul><li>Now working on DSx86 <a href="http://dsx86.patrickaalto.com" target="_blank">http://dsx86.patrickaalto.com</a>
<br/>
</li><li>Get LineWarsDS from <a href="http://linewars.patrickaalto.com" target="_blank">http://linewars.patrickaalto.com</a></li></ul></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#171709 - FluBBa - Tue Dec 15, 2009 4:57 pm</h4>
    <div class="postbody"><span class="postbody">How does the code look like that actually modifies the instruction?<br/>_________________<br/>I probably suck, my not is a programmer.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#171710 - Pate - Tue Dec 15, 2009 7:26 pm</h4>
    <div class="postbody"><span class="postbody">Like this:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#define   IRQ_ON      #0
<br/>
#define   IRQ_OFF      #0xFF
<br/>
<br/>
#if SELFMODTEST
<br/>
   ldr      r1, =IRQ_SM
<br/>
   mov      r0, IRQ_OFF
<br/>
   strb   r0, [r1]
<br/>
#endif
<br/>
<br/>
...
<br/>
<br/>
#if SELFMODTEST
<br/>
   ldr      r1, =IRQ_SM
<br/>
   mov      r0, IRQ_ON
<br/>
   strb   r0, [r1]
<br/>
#endif   
<br/>
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I believe I checked that the low byte of the opcode contains the immediate value, so I only change that.
<br/>
<br/>
Pate<br/>_________________<br/><ul><li>Now working on DSx86 <a href="http://dsx86.patrickaalto.com" target="_blank">http://dsx86.patrickaalto.com</a>
<br/>
</li><li>Get LineWarsDS from <a href="http://linewars.patrickaalto.com" target="_blank">http://linewars.patrickaalto.com</a></li></ul></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#171712 - Dwedit - Tue Dec 15, 2009 11:16 pm</h4>
    <div class="postbody"><span class="postbody">I used a lot of SMC in early working versions of Goomba Color DS, and I never hit any crashes.  I have no idea what's going on here.
<br/>
<br/>
The code looks correct (although, I would never include a # for a number in a define, it just looks wrong in the code).
<br/>
<br/>
Only other things I can think of are whether they are in the same source file, and the address used is correct.  Or maybe there is some completely other unrelated bug showing up.  Maybe add some nops to see if the size difference is triggering a bug or something.<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#171715 - Pate - Wed Dec 16, 2009 6:03 am</h4>
    <div class="postbody"><span class="postbody">Okay, thanks for the info!
<br/>
<br/>
Yeah, I'll need to change that # character, I don't know why I originally did it that way, I've had to change it in most of my other defines (as I needed to perform arithmetic operations with the defines).
<br/>
<br/>
It's good to know that the basic idea I have for SMC is sound, and the problem must be elsewhere in the code. I don't then spend time looking into the wrong things.
<br/>
<br/>
Thanks!
<br/>
<br/>
Pate<br/>_________________<br/><ul><li>Now working on DSx86 <a href="http://dsx86.patrickaalto.com" target="_blank">http://dsx86.patrickaalto.com</a>
<br/>
</li><li>Get LineWarsDS from <a href="http://linewars.patrickaalto.com" target="_blank">http://linewars.patrickaalto.com</a></li></ul></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
