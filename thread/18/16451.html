<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Getting stuff onto the DS pronto - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>DS development > Getting stuff onto the DS pronto</h2>
<div id="posts">
<div class="post">
    <h4>#166713 - Pete_Lockwood - Sun Feb 15, 2009 6:54 pm</h4>
    <div class="postbody"><span class="postbody">So after switching the MicroSD out of my DSTT and into a card reader, copying the file across and moving the card back to the DSTT about three times I got bored.
<br/>
<br/>
I took a quick look around, because I figured I wasn't the only one that might be driven insane by this process, and sure enough there are a bunch of posts on the subject but lots dead links and inelegant solutions abound.
<br/>
<br/>
In the end I just cooked something up myself to pass the file through my wireless router - a couple of tiny applications, one on the PC side and one on the DS.  Just drag-and-drop the file I want sent onto the PC application (or run it from a Makefile) and run up the receiver application on the DS.
<br/>
<br/>
Is anyone using anything much better that doesn't need me to configure the DS wireless and doesn't involve running a webserver or FTP server on the PC?  If so, links plz?<br/>_________________<br/>It's not an illusion, it just looks like one.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#166792 - RickA - Wed Feb 18, 2009 8:46 am</h4>
    <div class="postbody"><span class="postbody">I guess not. But I'd be more than interested in hearing details about how you did it.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#166796 - Pete_Lockwood - Wed Feb 18, 2009 11:45 am</h4>
    <div class="postbody"><span class="postbody">OK..  This is the sender, which lives on the PC.  Nothing fancy, nothing clever.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#include &lt;winsock2.h&gt;
<br/>
#include &lt;stdio.h&gt;
<br/>
<br/>
#define DEFAULT_PORT 21
<br/>
#define DEFAULT_BUFFER_SIZE 4096
<br/>
<br/>
int main(int argc, char* argv[])
<br/>
{
<br/>
   if(argc &lt; 2)
<br/>
      return 0;
<br/>
<br/>
   printf("Preparing to send %s\n", argv[1]);
<br/>
<br/>
   char Buffer[DEFAULT_BUFFER_SIZE + 1];
<br/>
<br/>
    WSAData wsd;
<br/>
<br/>
    if(WSAStartup(MAKEWORD(2, 2), &amp;wsd) != 0)
<br/>
   {
<br/>
        printf("Winsock not initialised!\n");
<br/>
        return -1;
<br/>
    }
<br/>
<br/>
    SOCKET ls = socket(AF_INET, SOCK_STREAM, IPPROTO_TCP);
<br/>
    if (ls == INVALID_SOCKET)
<br/>
   {
<br/>
        printf("Invalid socket!\n");
<br/>
        return -1;
<br/>
    }
<br/>
<br/>
    sockaddr_in service;
<br/>
    memset(&amp;service, 0, sizeof(service));
<br/>
    service.sin_family = AF_INET;
<br/>
    service.sin_addr.s_addr = INADDR_ANY;
<br/>
   service.sin_port = htons(DEFAULT_PORT);
<br/>
<br/>
   if (bind(ls, (SOCKADDR*) &amp;service, sizeof(service)) == SOCKET_ERROR)
<br/>
   {
<br/>
      printf("bind error!\n");
<br/>
      return -1;
<br/>
   }
<br/>
<br/>
   printf("Waiting for connection...\n");
<br/>
<br/>
   if (listen(ls, 1) == SOCKET_ERROR)
<br/>
   {
<br/>
      printf("listen() error!\n");
<br/>
      return -1;
<br/>
   }
<br/>
<br/>
   SOCKET as;
<br/>
<br/>
   while (1)
<br/>
   {
<br/>
      as = accept(ls, NULL, NULL);
<br/>
      if (as == SOCKET_ERROR)
<br/>
      {
<br/>
         continue;
<br/>
      }
<br/>
<br/>
      printf("Sending %s", argv[1]);
<br/>
<br/>
      int namelen = strlen(argv[1]) + 1;
<br/>
      send(as, (char *)&amp;namelen, 4, 0);
<br/>
      send(as, argv[1], namelen, 0);
<br/>
<br/>
      FILE *inf;
<br/>
      fopen_s(&amp;inf, argv[1], "rb");
<br/>
<br/>
      fseek(inf, 0, SEEK_END);
<br/>
      int totbytes = ftell(inf);
<br/>
      send(as, (char *)&amp;totbytes, 4, 0);
<br/>
      fseek(inf, 0, SEEK_SET);
<br/>
<br/>
      int len, sent;
<br/>
      char *pos;
<br/>
<br/>
      while(!feof(inf))
<br/>
      {
<br/>
         len = fread(Buffer, 1, DEFAULT_BUFFER_SIZE, inf);
<br/>
         pos = Buffer;
<br/>
<br/>
         while(len)
<br/>
         {
<br/>
            sent = send(as, Buffer, len, 0);
<br/>
            len -= sent;
<br/>
            pos += sent;
<br/>
         }
<br/>
      }
<br/>
      fclose(inf);
<br/>
      break;
<br/>
   }
<br/>
<br/>
   closesocket(as);
<br/>
   closesocket(ls);
<br/>
   WSACleanup();
<br/>
<br/>
   return 0;
<br/>
}
<br/>
</td> </tr></table><span class="postbody"><br/>_________________<br/>It's not an illusion, it just looks like one.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#166797 - Pete_Lockwood - Wed Feb 18, 2009 11:46 am</h4>
    <div class="postbody"><span class="postbody">This is the reciever, lives on the DS.  There are a few #defines at the top, which provide the important info - and note I didn't bother dealing with WEP, although adding that shouldn't be a big deal.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#include &lt;nds.h&gt;
<br/>
#include &lt;stdio.h&gt;
<br/>
#include &lt;string.h&gt;
<br/>
#include &lt;dswifi9.h&gt;
<br/>
<br/>
#include &lt;sys/types.h&gt;
<br/>
#include &lt;netinet/in.h&gt;
<br/>
<br/>
#include &lt;sys/socket.h&gt;
<br/>
#include &lt;netdb.h&gt;
<br/>
<br/>
#include &lt;fat.h&gt;
<br/>
<br/>
#define SERVER_ADDRESS "192.168.2.2"
<br/>
#define PREFERRED_ROUTER "belkin54g"
<br/>
#define DESTINATION_FOLDER "fat1:/games/"
<br/>
#define BUFFER_SIZE 4096
<br/>
<br/>
void findAP(Wifi_AccessPoint *ap) {
<br/>
   int selected = 0;  
<br/>
   int i;
<br/>
   int count = 0;
<br/>
<br/>
   Wifi_ScanMode();
<br/>
   while(!(keysDown() &amp; KEY_A)) {
<br/>
      scanKeys();
<br/>
<br/>
      count = Wifi_GetNumAP();
<br/>
      consoleClear();
<br/>
      iprintf("Number of APs found: %d\n", count);
<br/>
<br/>
      for(i = 0; i &lt; count; i++) {
<br/>
         Wifi_GetAPData(i, ap);
<br/>
<br/>
          iprintf("%s %s Wep:%s Sig:%i\n",
<br/>
             i == selected ? "*" : " ",
<br/>
            ap-&gt;ssid,
<br/>
             ap-&gt;flags &amp; WFLAG_APDATA_WEP ? "Yes " : "No ",
<br/>
             ap-&gt;rssi * 100 / 0xD0);
<br/>
<br/>
         if(!strcmp(ap-&gt;ssid,PREFERRED_ROUTER))
<br/>
         {
<br/>
            Wifi_GetAPData(i, ap);
<br/>
            return;
<br/>
         }
<br/>
      }
<br/>
      if(keysDown() &amp; KEY_UP &amp;&amp; selected &gt;0 ) selected--;
<br/>
      if(keysDown() &amp; KEY_DOWN &amp;&amp; selected &lt; (count-1)) selected++;
<br/>
      swiWaitForVBlank();
<br/>
   }
<br/>
   Wifi_GetAPData(selected, ap);
<br/>
}
<br/>
<br/>
void readdata(int my_socket, char *filename, int totbytes)
<br/>
{
<br/>
    fd_set readfd;
<br/>
    struct timeval stTime;
<br/>
    stTime.tv_sec = 2;
<br/>
    stTime.tv_usec = 0;
<br/>
   int iRet;
<br/>
   int recvd_len;
<br/>
    char incoming_buffer[BUFFER_SIZE];
<br/>
<br/>
   fatInitDefault();
<br/>
   iprintf("Writing %s", filename);
<br/>
   FILE *outf = fopen(filename, "wb");
<br/>
<br/>
   while( totbytes )
<br/>
    {
<br/>
      swiWaitForVBlank();
<br/>
<br/>
      FD_ZERO( &amp;readfd );
<br/>
      FD_SET( my_socket, &amp;readfd );
<br/>
        iRet = select( my_socket + 1, &amp;readfd, NULL, NULL, &amp;stTime );
<br/>
        if( iRet &gt; 0 )
<br/>
        {
<br/>
            recvd_len = recv( my_socket, incoming_buffer, sizeof(incoming_buffer), 0 );
<br/>
         iprintf(".");
<br/>
            if( recvd_len &gt; 0 )
<br/>
            {
<br/>
            fwrite(incoming_buffer, 1, recvd_len, outf);
<br/>
            totbytes -= recvd_len;
<br/>
         }
<br/>
        }
<br/>
        else if( iRet == 0 )
<br/>
        {
<br/>
         iprintf("\nTimed out!\n");
<br/>
            break;
<br/>
        }
<br/>
        else
<br/>
        {
<br/>
            iprintf( "\nError!!\n" );
<br/>
            break;
<br/>
        }
<br/>
    }
<br/>
   fclose(outf);
<br/>
   iprintf("\nDone\n");
<br/>
}
<br/>
<br/>
int main(void) {
<br/>
   Wifi_AccessPoint ap;
<br/>
<br/>
   int status = ASSOCSTATUS_DISCONNECTED;
<br/>
   int oldStatus;
<br/>
<br/>
   consoleDemoInit(); 
<br/>
   Wifi_InitDefault(false);
<br/>
   findAP(&amp;ap);
<br/>
   consoleClear();
<br/>
   iprintf("Connecting to %s\n", ap.ssid);
<br/>
<br/>
   //use dhcp
<br/>
   Wifi_SetIP(0,0,0,0,0);   
<br/>
   Wifi_ConnectAP(&amp;ap, WEPMODE_NONE, 0, 0);
<br/>
<br/>
   while(status != ASSOCSTATUS_ASSOCIATED &amp;&amp; status != ASSOCSTATUS_CANNOTCONNECT) {
<br/>
      oldStatus = status;
<br/>
      status = Wifi_AssocStatus();
<br/>
      if(oldStatus != status)
<br/>
         iprintf("\n%s", ASSOCSTATUS_STRINGS[status]);
<br/>
      else
<br/>
         iprintf(".");
<br/>
      swiWaitForVBlank();
<br/>
   }
<br/>
<br/>
    struct sockaddr_in sain;
<br/>
    sain.sin_family = AF_INET;
<br/>
    sain.sin_port = htons(21);
<br/>
    sain.sin_addr.s_addr = inet_addr( SERVER_ADDRESS );
<br/>
   
<br/>
    // Create TCP socket
<br/>
    int my_socket = socket( AF_INET, SOCK_STREAM, 0 );
<br/>
    connect( my_socket,(struct sockaddr *)&amp;sain, sizeof(sain) );
<br/>
    iprintf("\n\nConnected\n");
<br/>
<br/>
   int namelen;
<br/>
   swiWaitForVBlank();
<br/>
   recv( my_socket, &amp;namelen, 4, 0 );
<br/>
<br/>
   char filename[namelen];
<br/>
   swiWaitForVBlank();
<br/>
   recv( my_socket, filename, namelen, 0 );
<br/>
<br/>
   int totbytes;
<br/>
   swiWaitForVBlank();
<br/>
   recv( my_socket, &amp;totbytes, 4, 0 );
<br/>
<br/>
   iprintf("Receiving %d bytes from %s\n", totbytes, filename);
<br/>
<br/>
   char *pos = filename + namelen;
<br/>
   while(pos &gt; filename)
<br/>
   {
<br/>
      if(*pos == '\\')
<br/>
      {
<br/>
         pos++;
<br/>
         break;
<br/>
      }
<br/>
      pos--;
<br/>
   }
<br/>
   char outfilename[1024];
<br/>
   sprintf(outfilename, "%s%s", DESTINATION_FOLDER, pos);
<br/>
<br/>
   readdata(my_socket, outfilename, totbytes);
<br/>
   return 0;
<br/>
}
<br/>
</td> </tr></table><span class="postbody"><br/>_________________<br/>It's not an illusion, it just looks like one.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#166798 - Pete_Lockwood - Wed Feb 18, 2009 11:50 am</h4>
    <div class="postbody"><span class="postbody">So you just run both up, in no particular order, and the file will be transferred across to the SD card.  If you send something like "c:\my stuff\mything.nds" it does a simple strip to work out that the filename is mything.nds and places that in the directory controlled by the #define in the receiver.
<br/>
<br/>
Clearly it would be easy to extend this to be more flexible, broadcast from the DS to find the sender app without knowing the IP address, have the sender specify the destination folder etc. but I don't need any of that.<br/>_________________<br/>It's not an illusion, it just looks like one.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#168196 - silent_code - Tue Apr 14, 2009 3:29 pm</h4>
    <div class="postbody"><span class="postbody">Thanks. :^D<br/>_________________<br/><span style="font-size: 9px; line-height: normal"><span style="text-decoration: underline"><span style="font-weight: bold"></span></span> July 5th 08: "<span style="font-weight: bold">Volumetric Shadow Demo</span>" 1.6.0 (final) source released
<br/>
June 5th 08: "<span style="font-weight: bold">Zombie NDS</span>" WIP released!
<br/>
It's all on my page, just click <span style="font-weight: bold">WWW</span> below.</span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#168197 - azaydius - Tue Apr 14, 2009 3:42 pm</h4>
    <div class="postbody"><span class="postbody">What kind of transfer speeds are you getting with this?<br/>_________________<br/>fileNinja - <a href="https://sourceforge.net/projects/fileninja/" target="_blank">https://sourceforge.net/projects/fileninja/</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#168199 - samel - Tue Apr 14, 2009 5:28 pm</h4>
    <div class="postbody"><span class="postbody">You can just try mine
<br/>
<br/>
<a href="http://donotjava.netsons.org/?page_id=34" target="_blank">http://donotjava.netsons.org/?page_id=34</a>
<br/>
<br/>
and if you have some comments/improvements we can collaborate to make only one tool together.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#168202 - Pete_Lockwood - Wed Apr 15, 2009 12:18 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>azaydius wrote:</b></span></td> </tr> <tr> <td class="quote">What kind of transfer speeds are you getting with this?</td> </tr></table><span class="postbody">
<br/>
<br/>
Dunno exactly.  I've since killed my default arm7 binary and wifi library and I'm too lazy to download them again at the moment to compile in something that'll give me a proper measurement.
<br/>
<br/>
Doing a very simple estimate based on filesize and seconds elapsed it's something a shade over 50 kilobytes per second.  You could remove the swiWaitForVBlank in the main reader loop and probably squeeze some more out of it.
<br/>
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>samel wrote:</b></span></td> </tr> <tr> <td class="quote">You can just try mine
<br/>
and if you have some comments/improvements we can collaborate to make only one tool together.</td> </tr></table><span class="postbody">
<br/>
<br/>
I didn't set out to compete, I just couldn't find anything simple so I spent 20 minutes and made my own.  I have no plans to do anything more on my solution so by all means improve away.<br/>_________________<br/>It's not an illusion, it just looks like one.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
