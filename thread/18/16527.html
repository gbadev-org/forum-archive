<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Issues with CycloDS? (swiWaitForVBlank on ARM7) - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>DS development > Issues with CycloDS? (swiWaitForVBlank on ARM7)</h2>
<div id="posts">
<div class="post">
    <h4>#167325 - Echo49 - Mon Mar 09, 2009 7:37 am</h4>
    <div class="postbody"><span class="postbody">My game runs fine on a Supercard and an R4, but users of the CycloDS experience random crashes during the game. I don't personally own a CycloDS so testing it is a bit of a pain. Does anyone know of any issues with the CycloDS? Perhaps with the FIFO?</span><span class="gensmall"><br/><br/>Last edited by Echo49 on Tue Mar 10, 2009 11:37 am; edited 2 times in total</span></div>    
</div>
<div class="post">
    <h4>#167365 - Echo49 - Tue Mar 10, 2009 4:10 am</h4>
    <div class="postbody"><span class="postbody">I have narrowed the problem down to either FIFO not working, or the ARM7 freezing (or stuck in an infinite loop). My ARM7 main loop is somewhat like the following (please ignore any incorrect function names or incorrect number of arguments, I'm doing this from memory):
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">while (1)
<br/>
{
<br/>
    while (fifoCheckValue32(FIFO_USER_01))
<br/>
        fifoGetValue32(FIFO_USER_01); //and do something with it
<br/>
    
<br/>
    swiWaitForVBlank();
<br/>
    
<br/>
    fifoSendValue32(FIFO_USER_01, someValue);
<br/>
}</td> </tr></table><span class="postbody">
<br/>
Could it be that I'm sending and receiving on the same channel? I did a few experiments beforehand and it didn't seem like it would clash or cause problems. The important thing to note is that this problem <span style="font-style: italic">only</span> happens with the CycloDS. There is no problem at all when I use the Supercard or the R4.
<br/>
<br/>
Also what would be the best (or easiest/simplest) way to check whether the ARM7 has hung or not? iirc printf() doesn't work from the ARM7.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167373 - Echo49 - Tue Mar 10, 2009 11:44 am</h4>
    <div class="postbody"><span class="postbody">After even more testing (over the internet) I've discovered it's because of the swiWaitForVBlank() instruction.
<br/>
<br/>
When I copmile with both custom ARM9 and ARM7 files, on the <span style="font-weight: bold">ARM7</span> when using the <span style="font-weight: bold">CycloDS</span>, the following will cause random crashes:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">while (1)
<br/>
{
<br/>
    //... do stuff
<br/>
    swiWaitForVBlank();
<br/>
}</td> </tr></table><span class="postbody">
<br/>
Whereas the following will not:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">while(1)
<br/>
{
<br/>
   //... do stuff
<br/>
   while (REG_VCOUNT&gt;=192);
<br/>
   while (REG_VCOUNT&lt;192);
<br/>
}</td> </tr></table><span class="postbody">
<br/>
Are you allowed to call swiWaitForVBlank() from both CPUs? Does anyone know of a better work-around for this?
<br/>
<br/>
<span style="font-size: 9px; line-height: normal">can someone reply? being the only replier in my own thread gets kinda depressing &gt;.&gt;</span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167376 - Pete_Lockwood - Tue Mar 10, 2009 3:06 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Echo49 wrote:</b></span></td> </tr> <tr> <td class="quote">Are you allowed to call swiWaitForVBlank() from both CPUs?</td> </tr></table><span class="postbody">
<br/>
<br/>
Just so you have a response from someone else..  Yes, you can call swiWaitForVBlank() on the ARM7.  Can't help with the actual problem.<br/>_________________<br/>It's not an illusion, it just looks like one.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167378 - hacker013 - Tue Mar 10, 2009 3:25 pm</h4>
    <div class="postbody"><span class="postbody">I have the same problem on my m3 ds real with m3 sakura firmware :(<br/>_________________<br/><a class="postlink" href="http://imetal.nl/" target="_blank">Website / Blog</a>
<br/>
<br/>
Let the nds be with you.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167390 - Lazy1 - Tue Mar 10, 2009 7:20 pm</h4>
    <div class="postbody"><span class="postbody">For arm7 debugging you can always use the sound hardware to generate noise, there are proper ways to do it but I just played a sound with the address of main().
<br/>
<br/>
It gave a few pops and some other weird noises so I knew that the one section of code had been executed.
<br/>
Still, it's a really ugly hack.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167394 - nanou - Tue Mar 10, 2009 7:44 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Lazy1 wrote:</b></span></td> </tr> <tr> <td class="quote">Still, it's a really ugly hack.</td> </tr></table><span class="postbody">
<br/>
<br/>
That's really not a bad idea though, especially if you can't trust IPC for some reason.<br/>_________________<br/>- nanou</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167399 - Pete_Lockwood - Tue Mar 10, 2009 8:27 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Lazy1 wrote:</b></span></td> </tr> <tr> <td class="quote">For arm7 debugging you can always use the sound hardware to generate noise, there are proper ways to do it but I just played a sound with the address of main().</td> </tr></table><span class="postbody">
<br/>
<br/>
Haha.  I use the LED to get an idea of where my ARM7 code is.<br/>_________________<br/>It's not an illusion, it just looks like one.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167401 - Echo49 - Tue Mar 10, 2009 9:11 pm</h4>
    <div class="postbody"><span class="postbody">I have resolved this by simply not using swiWaitForVBlank() and processing my main loop (which is extremely short) in the vblank interrupt handler.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#include &lt;nds.h&gt;
<br/>
#include &lt;dswifi7.h&gt;
<br/>
<br/>
void fifoHandler(u32 value, void* buffer)
<br/>
{
<br/>
   /* do handler stuff */
<br/>
}
<br/>
<br/>
void VcountHandler()
<br/>
{
<br/>
   inputGetAndSend();
<br/>
}
<br/>
<br/>
void VblankHandler(void)
<br/>
{
<br/>
   /* do my stuff */
<br/>
<br/>
   Wifi_Update();
<br/>
}
<br/>
<br/>
int main()
<br/>
{
<br/>
   irqInit();
<br/>
   fifoInit();
<br/>
<br/>
   // read User Settings from firmware
<br/>
   readUserSettings();
<br/>
<br/>
   // Start the RTC tracking IRQ
<br/>
   initClockIRQ();
<br/>
<br/>
   SetYtrigger(80);
<br/>
<br/>
   installWifiFIFO();
<br/>
   installSoundFIFO();
<br/>
<br/>
   installSystemFIFO();
<br/>
   
<br/>
   irqSet(IRQ_VCOUNT, VcountHandler);
<br/>
   irqSet(IRQ_VBLANK, VblankHandler);
<br/>
<br/>
   irqEnable( IRQ_VBLANK | IRQ_VCOUNT | IRQ_NETWORK);
<br/>
   
<br/>
   //fifo handler
<br/>
   fifoSetValue32Handler(FIFO_USER_01, fifoHandler, NULL);
<br/>
   
<br/>
   // Keep the ARM7 mostly idle
<br/>
   while (1)
<br/>
   {
<br/>
      //choose some irq that will never trigger to keep ARM7 idle
<br/>
      swiIntrWait(1, IRQ_CARD);
<br/>
   }
<br/>
}</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
