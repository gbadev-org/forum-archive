<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Background Rotation and Movement Question (now with code) - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>DS development > Background Rotation and Movement Question (now with code)</h2>
<div id="posts">
<div class="post">
    <h4>#46920 - connor9 - Sat Jul 02, 2005 2:33 am</h4>
    <div class="postbody"><span class="postbody">I'm having a bit of trouble with rotation backgrounds. I want to be able to rotate a background about the center point of the screen as in this picture:
<br/>
<a href="http://connor.completelyfreehosting.com/tf/1.jpg">[Images not permitted - Click here to view it]</a>
<br/>
<br/>
After you've rotated say 45 degrees, if you press up or down I want background to move up and down relative to the screen as opposed to relative to it's own position. As in number two in the following figure.
<br/>
<a href="http://connor.completelyfreehosting.com/tf/2.jpg">[Images not permitted - Click here to view it]</a>
<br/>
<br/>
From reading the old cearn tutorials I can only seem to get the behavoir shown in number 1 of the second picture. When you press up or down it moves up and down relative to the background. I.e if you've rotated 45 degrees. Down will move it in a 45 degree angle line.
<br/>
<br/>
Any help would be much appreciated.
<br/>
<br/>
Update: Here's the code for it:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
s16 s = SIN[angle &amp; 0x1FF] &gt;&gt; 4;
<br/>
s16 c = COS[angle &amp; 0x1FF] &gt;&gt; 4;
<br/>
(scaleX,Y are alwats 1 &lt;&lt; 8)
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
This will rotate about the left corner of the screen(bad), but up and down are relative to the screen not the background(good!)
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
        s16 tX = scrollX&lt;&lt;8;
<br/>
        s16 tY = scrollY&lt;&lt;8;
<br/>
        s16 tcx = (c*scrollX - s*scrollY);
<br/>
        s16 tcy = (s*scrollX + c*scrollY );
<br/>
    
<br/>
        BG3_XDX = ( c * scaleX ) &gt;&gt; 8;
<br/>
        BG3_XDY = (-s * scaleX ) &gt;&gt; 8;
<br/>
        BG3_YDX = ( s * scaleY ) &gt;&gt; 8;
<br/>
        BG3_YDY = ( c * scaleY ) &gt;&gt; 8;
<br/>
        
<br/>
        BG3_CX = tcx - rcX * (c - s);
<br/>
        BG3_CY = tcy - rcY * (s + c);
<br/>
</td> </tr></table><span class="postbody">
<br/>
This will rotate about the center of the screen(good!), but up and down are relative to the background not the screen (bad)
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
        s16 tX = scrollX&lt;&lt;8;
<br/>
        s16 tY = scrollY&lt;&lt;8;
<br/>
        s16 tcx = tX;
<br/>
        s16 tcy = tY;
<br/>
    
<br/>
        BG3_XDX = ( c * scaleX ) &gt;&gt; 8;
<br/>
        BG3_XDY = (-s * scaleX ) &gt;&gt; 8;
<br/>
        BG3_YDX = ( s * scaleY ) &gt;&gt; 8;
<br/>
        BG3_YDY = ( c * scaleY ) &gt;&gt; 8;
<br/>
        
<br/>
        BG3_CX = tcx - rcX * (c - s);
<br/>
        BG3_CY = tcy - rcY * (s + c);
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#47108 - Cearn - Tue Jul 05, 2005 8:21 am</h4>
    <div class="postbody"><span class="postbody">(tcx,tcy) scrolls along the map's principal axes, (rcx,rcy) along the screen's. Try modifying rcx/y values instead of tcx/y.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#47202 - Cearn - Wed Jul 06, 2005 9:15 am</h4>
    <div class="postbody"><span class="postbody">... nm, should have read more carefully. The basic equation is 
<br/>
<span style="font-weight: bold">dx</span> = <span style="font-weight: bold">p0</span> - <span style="font-weight: bold">P?q0</span>
<br/>
with <span style="font-weight: bold">p0</span> the origin in map-space (scrolls along map axes) and <span style="font-weight: bold">q0</span> the origin in screen-space (scrolls along screen axes). You need something like this because the registers do the translation before the transformation, so you need to compensate for the matrix so scroll along the screen axes. The versions you have now use <span style="font-weight: bold">P</span> on <span style="font-weight: bold">p0</span> and something <span style="font-style: italic">very</span> strange to <span style="font-weight: bold">q0</span>. Something like this should be better:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">// NOTE: terms are never defined, going by this assumption
<br/>
// p0 = (scrollX,scrollY)  (.0 fixed)
<br/>
// q0 = (rcX,rcY)  (.0 fixed)
<br/>
s32 tcX = scrollX&lt;&lt;8; 
<br/>
s32 tcY = scrollY&lt;&lt;8; 
<br/>
    
<br/>
BG3_XDX = ( c * scaleX ) &gt;&gt; 8; 
<br/>
BG3_XDY = (-s * scaleX ) &gt;&gt; 8; 
<br/>
BG3_YDX = ( s * scaleY ) &gt;&gt; 8; 
<br/>
BG3_YDY = ( c * scaleY ) &gt;&gt; 8; 
<br/>
        
<br/>
BG3_CX = tcx - (rcX*c - rcY*s); 
<br/>
BG3_CY = tcy - (rcX*s + rcY*c); 
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#47217 - connor9 - Wed Jul 06, 2005 2:57 pm</h4>
    <div class="postbody"><span class="postbody">Hey thanks for the help.
<br/>
<br/>
I tried that and it rotates around the screen center but it moves along the map axis instead of along the screen axis. rcX and rcY should be set to the screen midpoints right?
<br/>
<br/>
Here's the rom of what it's doing:
<br/>
<a class="postlink" href="http://www.connor.completelyfreehosting.com/starfield/" target="_blank">http://www.connor.completelyfreehosting.com/starfield/</a>
<br/>
<br/>
Again thanks for helping me.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#47226 - Cearn - Wed Jul 06, 2005 4:26 pm</h4>
    <div class="postbody"><span class="postbody">The binary doesn't seem to work on any of the emulators (unless I'm doing it wrong, which is a good possibility here), so I can't see what it does. Sorry.
<br/>
<br/>
Take a step back and look at each step in the mapping process. In principle, the rotation <span style="font-style: italic">always</span> happens with respect to the screen's origin. With <span style="font-weight: bold">dx</span>= (BG3_CX, BG3_CY) you can set offset the map coordinates. The rotation still happens around the screen's origin, but this is now at a different map-coordinate <span style="font-weight: bold">dx</span>, so that it looks as though you rotate around different map coordinates. 
<br/>
A map-offset is all you have available here: it's <span style="font-style: italic">not</span> possible to rotate around any other screen position than the origin. However, what you can do is make it <span style="font-style: italic">look</span> like you're doing that, and that's where <span style="font-weight: bold">p0</span>=(tcX, tcY) and <span style="font-weight: bold">q0</span>=(rcX,rcY) come in. <span style="font-weight: bold">p0</span> is the map-point around which the rotation takes place. The purpose of <span style="font-weight: bold">q0</span> is to then move the image you now have by rcX horizontally and rcY vertically. Basically, rcX and rcY serve as the screen's scrolling registers. By combining them via <span style="font-weight: bold">dx</span>= <span style="font-weight: bold">p0</span>-<span style="font-weight: bold">P?q0</span> you have map offset <span style="font-weight: bold">dx</span> that rotates around <span style="font-weight: bold">p0</span> (with a radius |<span style="font-weight: bold">q0</span>|) so that it looks as though you're rotating around a different screen point than the origin, but all you're doing is updating what is mapped <span style="font-style: italic">to</span> the origin as you rotate.
<br/>
<br/>
Remember what <span style="font-weight: bold">p0</span> and <span style="font-weight: bold">q0</span> represent, don't think about the final effect. I have the feeling that what you want isn't a way to scroll along the screen axes (that'd be what <span style="font-weight: bold">q0</span> is for), but a way to walk on the map along an angle (changing <span style="font-weight: bold">p0</span>). The effect looks the same if you walk, but if you then rotate the difference becomes clear. To accomplish that, do something like <span style="font-weight: bold">p0</span> += <span style="font-weight: bold">P?ds</span>, where <span style="font-weight: bold">ds</span> is the vector of movement along screen axes.
<br/>
<br/>
I know it's tricky to explain without images or a movie or something. You could try constructing something out of paper and sticks to get a feel of what's going on.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
