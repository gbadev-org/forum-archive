<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>possible vram layouts - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>DS development > possible vram layouts</h2>
<div id="posts">
<div class="post">
    <h4>#170457 - vuurrobin - Sun Sep 27, 2009 2:54 pm</h4>
    <div class="postbody"><span class="postbody">hello everybody,
<br/>
<br/>
for my DSOL library, I'm planning to allow different preset vram layouts so that people still have some control over them without actually have to worry about setting them correctly. I already have some layouts, but if someone has improvements or new layouts, I would be glad to hear them.
<br/>
<br/>
note that I'm currently only focusing on 2d, so nothing will be mapped to 3d stuff.
<br/>
<br/>
<br/>
<span style="font-weight: bold">the layouts:</span>
<br/>
<br/>
<br/>
standard:
<br/>
vram A-D will be divided between sprites and backgrounds, vram F-I will be used for extended palettes. 
<br/>
vram E goes unused.
<br/>
AFAIK, this is what palib has.
<br/>
<br/>
background plus:
<br/>
vram A-B will be used for main backgrounds and vram E for main sprites. the rest is the same as standard.
<br/>
<br/>
sprite plus:
<br/>
vram A-B will be used for main sprites and vram E for main background. the rest is the same as standard.
<br/>
<br/>
background max:
<br/>
vram A-D will be used for main backgrounds, vram E and (hopefully) G for main sprites, vram F for main background extended palettes and vram H-I for sub backgrounds and sprites.
<br/>
<br/>
main plus:
<br/>
vram A-B will be used for main backgrounds, vram C-D for main sprites, vram F-G for extended palettes and H-I for sub background and sub sprites. vram E goes unused.
<br/>
<br/>
<br/>
I think that this are all possible layouts where you can get the most of vram, as far as 2d go (I don't think that most people will use vram as ARM7 work ram).
<br/>
<br/>
comments, ideas, improvements or new layouts? post them :)<br/>_________________<br/>my blog:
<br/>
<a href="http://vuurrobin.100webcustomers.com/" target="_blank">http://vuurrobin.100webcustomers.com/</a></span><span class="gensmall"><br/><br/>Last edited by vuurrobin on Mon Sep 28, 2009 10:11 pm; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#170461 - sverx - Mon Sep 28, 2009 10:12 am</h4>
    <div class="postbody"><span class="postbody">Hi
<br/>
 it's since some time I was thinking also to do something similar, so I think we can join efforts, if you don't mind :)
<br/>
<br/>
I personally was thinking about giving different choices considering to have BGs and sprite both ON, extended palettes optional. Of course we've got two video engines using the 9 VRAM banks and we should take care of it, you know.
<br/>
<br/>
BGs can use 16/32/64/80/96/128/256/384/512 KB on main engine and 32/48/128 KB on sub engine, sprites can use 16/32/64/128/256 on main engine and 16/128 on sub engine (I've still got to check all these configurations, thought... see this -&gt; <a href="http://dev-scene.com/NDS/NDS_Tutorials_VramTable" target="_blank">http://dev-scene.com/NDS/NDS_Tutorials_VramTable</a> )
<br/>
<br/>
I was thinking about calling a single function to set up everything at once. Was that your idea too?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170464 - hacker013 - Mon Sep 28, 2009 7:44 pm</h4>
    <div class="postbody"><span class="postbody">Everybody who uses arm7 sound decoding uses vramd for the arm7, so I think you should keep that option.<br/>_________________<br/><a class="postlink" href="http://imetal.nl/" target="_blank">Website / Blog</a>
<br/>
<br/>
Let the nds be with you.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170468 - AntonioND - Mon Sep 28, 2009 9:42 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>hacker013 wrote:</b></span></td> </tr> <tr> <td class="quote">Everybody who uses arm7 sound decoding uses vramd for the arm7, so I think you should keep that option.</td> </tr></table><span class="postbody">
<br/>
Uhmm... No, not really. In fact, I've only seen VRAM assigned to ARM7 in nds loaders...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170469 - vuurrobin - Mon Sep 28, 2009 10:10 pm</h4>
    <div class="postbody"><span class="postbody">@sverx, I would be happy to join efforts to find those vram layouts :) .
<br/>
<br/>
I think we should always try to use as many vram banks as possible, and to always have some vram mapped to backgrounds and sprites, both main and sub (which I don't think should be that hard). I probably will also allow the user to set its own layout, because I doubt we will find all layouts.
<br/>
<br/>
as for the actual implementation, I'm putting every layout in its own function, so it will make it easier to work with. I'm not sure if the user will directly call these functions or that I will create an vramInit function or something.
<br/>
but I think that our implementation will be somewhat different, seeing as mine will have some DSOL specific stuff ;)
<br/>
here is an example of such a function:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void vramLayoutStandard()
<br/>
{
<br/>
    vramSetBankA(VRAM_A_MAIN_SPRITE_0x06400000);
<br/>
   vramSetBankB(VRAM_B_MAIN_BG_0x06000000);
<br/>
    vramSetBankC(VRAM_C_SUB_BG_0x06200000);
<br/>
    vramSetBankD(VRAM_D_SUB_SPRITE);
<br/>
<br/>
    //not used
<br/>
    //vramSetBankE();
<br/>
<br/>
    vramSetBankF(VRAM_F_BG_EXT_PALETTE);//main background palettes
<br/>
    vramSetBankG(VRAM_G_SPRITE_EXT_PALETTE);//main sprites palettes
<br/>
    vramSetBankH(VRAM_H_SUB_BG_EXT_PALETTE);//sub background palettes
<br/>
    vramSetBankI(VRAM_I_SUB_SPRITE_EXT_PALETTE);//sub sprites palettes
<br/>
<br/>
<br/>
   //allow both tiled and bitmap sprites, and using extended palettes
<br/>
   oamInit(&amp;oamMain, SpriteMapping_Bmp_1D_128, true);
<br/>
   oamInit(&amp;oamSub, SpriteMapping_Bmp_1D_128, true);
<br/>
        //other DSOL specific stuff, like enabling extended sprites
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
<br/>
I haven't checked them all, but I think you're fairly spot on with those configurations. but now we have to see how we can fit them together.
<br/>
<br/>
@hacker013, I think most people will use maxmod, which AFAIK doesn't use the vram. and if people want to use it, then they will have the option to set it themselves.
<br/>
<br/>
<br/>
@AntonioND, what do you mean by nds loaders? are you talking about programs that run *.nds files, like the homebrewmenu?
<br/>
<br/>
<br/>
anyway, I have added another vram layout, main plus:
<br/>
vram A-B will be used for main backgrounds, vram C-D for main sprites, vram F-G for extended palettes and H-I for sub background and sub sprites. vram E goes unused.<br/>_________________<br/>my blog:
<br/>
<a href="http://vuurrobin.100webcustomers.com/" target="_blank">http://vuurrobin.100webcustomers.com/</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170471 - AntonioND - Mon Sep 28, 2009 11:15 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>vuurrobin wrote:</b></span></td> </tr> <tr> <td class="quote">@AntonioND, what do you mean by nds loaders? are you talking about programs that run *.nds files, like the homebrewmenu?</td> </tr></table><span class="postbody">Yes, that kind of programs Is the only one I've seen that use VRAM for ARM7.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170475 - Tommmie - Tue Sep 29, 2009 6:29 am</h4>
    <div class="postbody"><span class="postbody">just look at dsorganize or moonshell and you've some other programs that uses vram for sound decoding(and something they call save_malloc).</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170478 - AntonioND - Tue Sep 29, 2009 8:43 am</h4>
    <div class="postbody"><span class="postbody">But most programs don't need that. DSorganize and moonshell are quite special programs.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170479 - sverx - Tue Sep 29, 2009 9:42 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>vuurrobin wrote:</b></span></td> </tr> <tr> <td class="quote">I think we should always try to use as many vram banks as possible, and to always have some vram mapped to backgrounds and sprites, both main and sub [...] </td> </tr></table><span class="postbody">
<br/>
<br/>
Personally I think we should define many options and implement them using the fewer vram banks as possible, also leaving bank C and/or bank D free when possible.
<br/>
<br/>
I would define some values (defines or enums) both for main and for sub to describe BGs/Sprite/ExtPal configurations, and activate them using a function (or method I guess ;) ) that accepts the two parameters: MAIN and SUB engines mode.
<br/>
<br/>
For instance we could have something like
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#define MAIN_BG_128K_SPR_128K             1
<br/>
#define MAIN_BG_128K_SPR_256K             2
<br/>
// other ...
<br/>
<br/>
#define MAIN_BG_EXT_PAL                   0x100
<br/>
#define MAIN_SPR_EXT_PAL                  0x200
<br/>
// ... maybe also BG 'half' extended palette?
<br/>
<br/>
// then even define constants for most common ones...?
<br/>
#define MAIN_BG_128K_SPR_128K_BG_EXT_PAL  (MAIN_BG_128K_SPR_128K | MAIN_BG_EXT_PAL)</td> </tr></table><span class="postbody">
<br/>
<br/>
and so on, with something similar for SUB engine.
<br/>
<br/>
Then the function assigns and activate the vram banks and returns 0 on success and another code on failure (maybe somebody's trying to ask too much...)
<br/>
<br/>
Of course we should define how banks will be mapped to modes. I guess you want to start from this, right?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170488 - hacker013 - Tue Sep 29, 2009 3:23 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>AntonioND wrote:</b></span></td> </tr> <tr> <td class="quote">But most programs don't need that. DSorganize and moonshell are quite special programs.</td> </tr></table><span class="postbody">
<br/>
<br/>
I think it is important enough to keep if you ask me ;) And I use it also.<br/>_________________<br/><a class="postlink" href="http://imetal.nl/" target="_blank">Website / Blog</a>
<br/>
<br/>
Let the nds be with you.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170530 - vuurrobin - Wed Sep 30, 2009 7:12 pm</h4>
    <div class="postbody"><span class="postbody">@sverx, why would you want to use as fewer vram banks as possible? it seems kind of a waste if you ask me. 
<br/>
<br/>
using defines like that means that you would have to calculate where to map the vram banks at runtime. this means that the user would have to code, compile and run it just to see if its possible. it would also mean that the user has to check for an error, which it may forget and thus introducing bugs that may be hard to find.
<br/>
<br/>
I think that vram layout should be decided during compile time, so it doesn't have to be done at runtime.
<br/>
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>hacker013 wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>AntonioND wrote:</b></span></td> </tr> <tr> <td class="quote">But most programs don't need that. DSorganize and moonshell are quite special programs.</td> </tr></table><span class="postbody">
<br/>
<br/>
I think it is important enough to keep if you ask me ;) And I use it also.</span></td> </tr></table><span class="postbody">
<br/>
<br/>
anybody that uses vram for ARM7 is modifying the default ARM7 code. if you need an custom ARM7 core, then I think setting the vram banks yourself should be easy compared to the actual ARM7 code. and I already said that I will allow the option to set the vram banks yourself in DSOL.<br/>_________________<br/>my blog:
<br/>
<a href="http://vuurrobin.100webcustomers.com/" target="_blank">http://vuurrobin.100webcustomers.com/</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170540 - sverx - Thu Oct 01, 2009 11:56 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>vuurrobin wrote:</b></span></td> </tr> <tr> <td class="quote">using defines like that means that you would have to calculate where to map the vram banks at runtime. this means that the user would have to code, compile and run it just to see if its possible. it would also mean that the user has to check for an error, which it may forget and thus introducing bugs that may be hard to find.
<br/>
<br/>
I think that vram layout should be decided during compile time, so it doesn't have to be done at runtime.</td> </tr></table><span class="postbody">
<br/>
<br/>
I see. So that means to define all the possible (or at least some among the most interesting ones) configurations of BOTH the main and sub engine and give them a name, then create a document where for each configuration we describe how much memory goes to BGs, how much for sprites and so on. Is that your idea?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170542 - vuurrobin - Thu Oct 01, 2009 1:16 pm</h4>
    <div class="postbody"><span class="postbody">pretty much, yes.
<br/>
<br/>
<br/>
to be honest, I think that the standard layout would be enough for most people (at least for most people comming from palib)<br/>_________________<br/>my blog:
<br/>
<a href="http://vuurrobin.100webcustomers.com/" target="_blank">http://vuurrobin.100webcustomers.com/</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170545 - sverx - Thu Oct 01, 2009 4:39 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>vuurrobin wrote:</b></span></td> </tr> <tr> <td class="quote">I think that the standard layout would be enough for most people (at least for most people comming from palib)</td> </tr></table><span class="postbody">
<br/>
<br/>
Well, it's 128KB for BGs and 128KB for sprites for both main and sub, and it has all the possible extended palette (BGs/sprite main/sub) activated, so it's very flexible. But I do think some people would need some more memory for the main engine. In one of the projects I'm working on, I'm using 256KB for sprites on main, for instance (well, also 128KB for textures, but it's unrelated) and I had to drop some extended palettes (we don't have 10 banks...).
<br/>
<br/>
So now I'm actually quite interested in knowing how other developer mapped the vram banks in their projects...
<br/>
<br/>
Anybody?</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
