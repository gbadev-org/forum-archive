<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Question of saving to SRAM for R4 cards - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>DS development > Question of saving to SRAM for R4 cards</h2>
<div id="posts">
<div class="post">
    <h4>#134304 - Zapf_Bandit - Thu Jul 12, 2007 11:37 am</h4>
    <div class="postbody"><span class="postbody">Hey,
<br/>
<br/>
I just bought myself a nifty R4 (slot1) card today.
<br/>
<br/>
I copied the game I am working on and it worked fine.
<br/>
<br/>
I have been using my supercard lite (slot2) for dev up until now.
<br/>
<br/>
I now want to add some persistant data to the cart (i.e. sram stuff)
<br/>
<br/>
My question is:
<br/>
<br/>
How should I save data using the slot1?
<br/>
<br/>
When I start my rom a *.sav file is created by the OS but I can't seem to read or write to it.
<br/>
<br/>
All the examples I can find use the memory on slot2 for saving. I have tried simply using:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">*(uint8*)(SRAM) = 69;</td> </tr></table><span class="postbody">
<br/>
<br/>
Has anyone else run into this? What is the solution? Can homebrew saves be done on an R4?
<br/>
<br/>
I'm thinking I should use eeprom for saving but I can't find any example code using this.
<br/>
<br/>
I'm not a n00b but really need some advice.
<br/>
<br/>
Thanks in advance for any info,
<br/>
Zapf bandit</span><span class="gensmall"><br/><br/>Last edited by Zapf_Bandit on Thu Jul 12, 2007 12:48 pm; edited 2 times in total</span></div>    
</div>
<div class="post">
    <h4>#134306 - Zapf_Bandit - Thu Jul 12, 2007 12:17 pm</h4>
    <div class="postbody"><span class="postbody">I have done a bit more research and have found a lib that should be able to read and write to eeprom.
<br/>
<br/>
It is called "cardme" and I found it in RAC (<a class="postlink" href="http://www.pineight.com/dx/RAC" target="_blank">http://www.pineight.com/dx/RAC</a>)
<br/>
<br/>
Anyhow I included the files and tried the following:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">int cardType = cardmeGetType();
<br/>
u8 test = 69;
<br/>
cardmeWriteEeprom(0, &amp;test, 1, cardType);
<br/>
test = 0;
<br/>
cardmeReadEeprom(0, &amp;test, 1, cardType);
<br/>
//test should now be 69 again...</td> </tr></table><span class="postbody">
<br/>
<br/>
On both my Supercard lite and the R4 "cardType" is -1 (i.e. not detected)
<br/>
<br/>
What am I doing wrong? I am even close to the right path?
<br/>
<br/>
Please help,
<br/>
Zapf Bandit</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#134319 - tepples - Thu Jul 12, 2007 1:20 pm</h4>
    <div class="postbody"><span class="postbody">Cardme is intended for reading and writing authentic DS Game Cards. Are you making sure to eject your NoPass or R4 and insert a Game Card before pressing a button that starts the cardme operation? If so, which Game Card are you using?<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#134322 - spinal_cord - Thu Jul 12, 2007 1:42 pm</h4>
    <div class="postbody"><span class="postbody">Would it not be easier to force a card type, rather than trying to detect it, I assume the R4 detects what type of save you are tying to do.  I have an R4, so any progress in this would be useful to me also.<br/>_________________<br/>I'm not a boring person, it's just that boring things keep happening to me.
<br/>
<a class="postlink" href="http://spinal.dizidesigns.co.uk/" target="_blank">Homepage</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#134323 - OOPMan - Thu Jul 12, 2007 1:49 pm</h4>
    <div class="postbody"><span class="postbody">Why not just use libfat + DLDI?<br/>_________________<br/>"My boot, your face..." - Attributed to OOPMan, Emperor of Eroticon VI
<br/>
<br/>
You can find my NDS homebrew projects <a class="postlink" href="http://blog.dev-scene.com/oopman/" target="_blank">here...</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#134324 - Zapf_Bandit - Thu Jul 12, 2007 1:49 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Would it not be easier to force a card type, rather than trying to detect it, I assume the R4 detects what type of save you are tying to do. I have an R4, so any progress in this would be useful to me also.</td> </tr></table><span class="postbody">
<br/>
<br/>
I had the same thought on the drive home from work. I hope it doesn't brick my R4, I only got it this morning :-P
<br/>
<br/>
I wonder which I should use? I think I'll try for the full 512Kb and see what happens...
<br/>
<br/>
I am going to try that now and see what happens... Wish me luck...
<br/>
<br/>
Zapf Bandit</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#134325 - Zapf_Bandit - Thu Jul 12, 2007 1:52 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Why not just use libfat + DLDI?</td> </tr></table><span class="postbody">
<br/>
<br/>
I wanted to avoid having to patch after every build.
<br/>
<br/>
I guess it has the great advantage that it will work for all cards...
<br/>
<br/>
I guess I could add it into the makefile which I will do if this doesn't work.
<br/>
<br/>
Just testing now...
<br/>
<br/>
Zapf Bandit</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#134326 - OOPMan - Thu Jul 12, 2007 2:01 pm</h4>
    <div class="postbody"><span class="postbody">Well, you're using an R4. The latest R4 firmware auto-patches DLDI, so you don't need to worry in that respect.
<br/>
<br/>
The SuperCard, not so much so :-(<br/>_________________<br/>"My boot, your face..." - Attributed to OOPMan, Emperor of Eroticon VI
<br/>
<br/>
You can find my NDS homebrew projects <a class="postlink" href="http://blog.dev-scene.com/oopman/" target="_blank">here...</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#134328 - Zapf_Bandit - Thu Jul 12, 2007 2:28 pm</h4>
    <div class="postbody"><span class="postbody">Well that's sealed it...
<br/>
<br/>
If I tried to pass in any card type to "cardmeWriteEeprom" the whole arm9 seized up.
<br/>
<br/>
Looks like it's libfat for me... Thanks for the advice OOPMan.
<br/>
<br/>
Great news about the auto patch on R4, really justifies my decision.
<br/>
<br/>
Zapf Bandit</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#134415 - Zapf_Bandit - Fri Jul 13, 2007 1:30 am</h4>
    <div class="postbody"><span class="postbody">Yay !!!
<br/>
<br/>
libfat is WAY cool...
<br/>
<br/>
I now have a config file that I can read and write from!
<br/>
<br/>
For completeness I am going to show all the changes I had to make in the hope that it will help someone else out.
<br/>
<br/>
This is using devKitArm r20 and assuming that you are using a varient of the template shell supplied.
<br/>
<br/>
1) In "arm9/Makefile" changed:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">LIBS   := -lnds9</td> </tr></table><span class="postbody">
<br/>
to
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">LIBS   := -lfat -lnds9</td> </tr></table><span class="postbody">
<br/>
<br/>
2) In "arm9/source/main.cpp" added:  
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#include &lt;fat.h&gt;
<br/>
#include &lt;stdio.h&gt;</td> </tr></table><span class="postbody">
<br/>
<br/>
3) Added this before trying to read and write:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code"> fatInitDefault();</td> </tr></table><span class="postbody">
<br/>
<br/>
4) To read:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">FILE* test = fopen ("/game.settings", "r");
<br/>
if (test)
<br/>
{
<br/>
    fseek ( test , 0 , SEEK_END );
<br/>
    uint32 testSize = ftell (test);
<br/>
    rewind ( test );
<br/>
    fread ( testBuffer, 1, testSize,  test );
<br/>
    fclose ( test );
<br/>
}</td> </tr></table><span class="postbody">
<br/>
where testBuffer is a allocated char*
<br/>
<br/>
4) To write:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">FILE* test = fopen ("/game.settings", "w");
<br/>
if (test) 
<br/>
{
<br/>
    fwrite( testBuffer, 1, sizeof(testBuffer), test );
<br/>
    fclose ( test );
<br/>
}</td> </tr></table><span class="postbody">
<br/>
where testBuffer is a allocated char*
<br/>
<br/>
In order for this to work correctly you need to patch with the DLDI for the card you use. You can easily add this to your Makefile by changing:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">$(TARGET).nds   :   $(TARGET).arm7 $(TARGET).arm9
<br/>
        ndstool   -c $(TARGET).nds -7 $(TARGET).arm7 -9 $(TARGET).arm9</td> </tr></table><span class="postbody">
<br/>
to
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">$(TARGET).nds   :   $(TARGET).arm7 $(TARGET).arm9
<br/>
        ndstool   -c $(TARGET).nds -7 $(TARGET).arm7 -9 $(TARGET).arm9
<br/>
        dlditool ***.dldi $(TARGET).nds</td> </tr></table><span class="postbody">
<br/>
where "***.dldi" id the dldi for the card you use (e.g. r4tf.dldi). You can get these DLDIs from <a class="postlink" href="http://chishm.drunkencoders.com/DLDI/" target="_blank">http://chishm.drunkencoders.com/DLDI/</a>
<br/>
<br/>
I hope this info helps someone else out,
<br/>
Zapf Bandit</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#136025 - spinal_cord - Sat Jul 28, 2007 4:42 pm</h4>
    <div class="postbody"><span class="postbody">How do loaders (such as the R4 one) know what type of save chip to emulate for commercial games? Is there info in the file header or something?<br/>_________________<br/>I'm not a boring person, it's just that boring things keep happening to me.
<br/>
<a class="postlink" href="http://spinal.dizidesigns.co.uk/" target="_blank">Homepage</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#136109 - josath - Sun Jul 29, 2007 8:34 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>spinal_cord wrote:</b></span></td> </tr> <tr> <td class="quote">How do loaders (such as the R4 one) know what type of save chip to emulate for commercial games? Is there info in the file header or something?</td> </tr></table><span class="postbody">
<br/>
<br/>
Do they actually emulate a save chip? Or do they simply patch the rom on the fly in order to change eeprom-write commands to r4-fat-write commands?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#136178 - Dood77 - Sun Jul 29, 2007 10:12 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>josath wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>spinal_cord wrote:</b></span></td> </tr> <tr> <td class="quote">How do loaders (such as the R4 one) know what type of save chip to emulate for commercial games? Is there info in the file header or something?</td> </tr></table><span class="postbody">
<br/>
<br/>
Do they actually emulate a save chip? Or do they simply patch the rom on the fly in order to change eeprom-write commands to r4-fat-write commands?</span></td> </tr></table><span class="postbody">
<br/>
Is it possible, since it asks if you want to create a .sav file every time you run a new .nds file, that it appends that file to the .nds every time it's run?<br/>_________________<br/>If I use a term wrong or something then feel free to correct, I?m not much of a programmer.
<br/>
<span style="font-size: 9px; line-height: normal">
<br/>
Original DS Phat obtained on day of release + flashme v7
<br/>
Supercard: miniSD, Kingston 1GB, Kingston 2GB
<br/>
Ralink chipset PCI NIC
<br/>
</span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#136663 - spinal_cord - Fri Aug 03, 2007 5:09 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>josath wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>spinal_cord wrote:</b></span></td> </tr> <tr> <td class="quote">How do loaders (such as the R4 one) know what type of save chip to emulate for commercial games? Is there info in the file header or something?</td> </tr></table><span class="postbody">
<br/>
<br/>
Do they actually emulate a save chip? Or do they simply patch the rom on the fly in order to change eeprom-write commands to r4-fat-write commands?</span></td> </tr></table><span class="postbody">
<br/>
<br/>
Even if the don't emulate the save chip and patch the rom, I assume the differnt save chips are written to differently, so wouldn't the loader still need to know what sort of chip it is supposed to be looking for?<br/>_________________<br/>I'm not a boring person, it's just that boring things keep happening to me.
<br/>
<a class="postlink" href="http://spinal.dizidesigns.co.uk/" target="_blank">Homepage</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#136664 - josath - Fri Aug 03, 2007 5:14 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>spinal_cord wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>josath wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>spinal_cord wrote:</b></span></td> </tr> <tr> <td class="quote">How do loaders (such as the R4 one) know what type of save chip to emulate for commercial games? Is there info in the file header or something?</td> </tr></table><span class="postbody">
<br/>
<br/>
Do they actually emulate a save chip? Or do they simply patch the rom on the fly in order to change eeprom-write commands to r4-fat-write commands?</span></td> </tr></table><span class="postbody">
<br/>
<br/>
Even if the don't emulate the save chip and patch the rom, I assume the differnt save chips are written to differently, so wouldn't the loader still need to know what sort of chip it is supposed to be looking for?</span></td> </tr></table><span class="postbody">
<br/>
<br/>
(This is complete speculation) My guess is there is some NitroSDK function like:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">writeEEPROM(u8 *data, int offset, int size);</td> </tr></table><span class="postbody">
<br/>
and this function handles checking for the chip type. All the flashcart authors have to do, is replace that call with a:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">writeToFAT(u8 *data, int offset, int size, char *filename);</td> </tr></table><span class="postbody">
<br/>
They don't have to care what the writeEEPROM function does internally. The flashcarts i've seen, always use a save file that is as big as possible (ie even a game with 512-byte save will have a 256KB save file)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#136709 - spinal_cord - Sat Aug 04, 2007 12:18 am</h4>
    <div class="postbody"><span class="postbody">But if you write to the .sav manually, and it is named as the card names it, it will be overwritten by the card and you will lose your data.
<br/>
<br/>
I still think it is a good idea to be able to use the modern slot-1 cards virtual eeprom the way that commercial games do it.<br/>_________________<br/>I'm not a boring person, it's just that boring things keep happening to me.
<br/>
<a class="postlink" href="http://spinal.dizidesigns.co.uk/" target="_blank">Homepage</a></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
