<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Extended palettes. - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > Extended palettes.</h2>
<div id="posts">
<div class="post">
    <h4>#69812 - ProblemBaby - Thu Feb 02, 2006 3:48 am</h4>
    <div class="postbody"><span class="postbody">Trying to use extended palettes.
<br/>
Ive enabled Bit 31 in DISPCNT
<br/>
Ive enabled Bit 13 (colormode) for my sprite
<br/>
Ive enabled a vrambank.
<br/>
something ive missed? the sprite still uses the standard palette!
<br/>
please help!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#69813 - knight0fdragon - Thu Feb 02, 2006 4:13 am</h4>
    <div class="postbody"><span class="postbody">are u doing it in 16 color mode or 256?<br/>_________________<br/><a href="http://www.myspace.com/knight0fdragonds" target="_blank">http://www.myspace.com/knight0fdragonds</a>
<br/>
<br/>
MK DS FC: Dragon 330772 075464 
<br/>
AC WW FC: Anthony SamsClub 1933-3433-9458 
<br/>
MPFH: Dragon 0215 4231 1206</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#69816 - ProblemBaby - Thu Feb 02, 2006 4:56 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
are u doing it in 16 color mode or 256?
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Don't understand. I want to have 16 256 color palettes. Ive enabled 256 color mode for the sprite. But I cant understand why it still use the standard palette when Ive enabled extended object palette in the display control.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#69823 - knight0fdragon - Thu Feb 02, 2006 5:43 am</h4>
    <div class="postbody"><span class="postbody">from what ive been reading i believe only the 16 color mode can use the extended palettes. not the 256 or 16bit mode,  the reason why i believe this is is 16 colors * 16 different palletes gets u the 256 different pallets available<br/>_________________<br/><a href="http://www.myspace.com/knight0fdragonds" target="_blank">http://www.myspace.com/knight0fdragonds</a>
<br/>
<br/>
MK DS FC: Dragon 330772 075464 
<br/>
AC WW FC: Anthony SamsClub 1933-3433-9458 
<br/>
MPFH: Dragon 0215 4231 1206</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#69838 - Mollusk - Thu Feb 02, 2006 8:32 am</h4>
    <div class="postbody"><span class="postbody">knightofdragon, that was on gba... On DS you can have 16 256 colors palettes for backgrounds and sprites
<br/>
<br/>
hat vram bank did you use ? could you post the code you set up ? Did you check in dualis that your palette was correctly loaded ?<br/>_________________<br/>PAlib official forum : <a class="postlink" href="http://www.palib.info" target="_blank">http://www.palib.info</a>
<br/>
PAlib official tutorials: <a class="postlink" href="http://www.palib.info/wiki" target="_blank">http://www.palib.info/wiki</a>
<br/>
Updates, help, code examples, tutorials, etc...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#69844 - knight0fdragon - Thu Feb 02, 2006 9:09 am</h4>
    <div class="postbody"><span class="postbody">oh ok, well a lot of the stuff i am looking at is from GBA, since the DS documentation is still not as good<br/>_________________<br/><a href="http://www.myspace.com/knight0fdragonds" target="_blank">http://www.myspace.com/knight0fdragonds</a>
<br/>
<br/>
MK DS FC: Dragon 330772 075464 
<br/>
AC WW FC: Anthony SamsClub 1933-3433-9458 
<br/>
MPFH: Dragon 0215 4231 1206</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#69849 - ProblemBaby - Thu Feb 02, 2006 10:11 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
hat vram bank did you use ? could you post the code you set up ? Did you check in dualis that your palette was correctly loaded ?
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
It is supposed to work in dualis, right? Iam using vram bank F, I can see in dualis that my palette is loaded to that bank. But it must be something more than bit 31 in dispcnt that enables extended palettes! Cuase, why, why, why is it using the standard palette???</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#72929 - mlequim - Wed Feb 22, 2006 2:43 pm</h4>
    <div class="postbody"><span class="postbody">does the extended palettes works on the two screens ? I would like to use 16*256 colors palettes for both screens in tiles mode</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#72931 - Mollusk - Wed Feb 22, 2006 2:49 pm</h4>
    <div class="postbody"><span class="postbody">it should work, and it works on both screens.
<br/>
<br/>
Try loading the palette a bit everywhere, and having sprites with different palettes shown. Did you enable the VRAM to extended palettes ?<br/>_________________<br/>PAlib official forum : <a class="postlink" href="http://www.palib.info" target="_blank">http://www.palib.info</a>
<br/>
PAlib official tutorials: <a class="postlink" href="http://www.palib.info/wiki" target="_blank">http://www.palib.info/wiki</a>
<br/>
Updates, help, code examples, tutorials, etc...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#72932 - mlequim - Wed Feb 22, 2006 2:52 pm</h4>
    <div class="postbody"><span class="postbody">thank's mollusk, 
<br/>
I have not done a test because I have no hardware to test extended palettes, I asked that to know if my pals who does the graphism can use more palettes. We limit to the features that work simultaneously on both screens.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#72934 - Mollusk - Wed Feb 22, 2006 2:54 pm</h4>
    <div class="postbody"><span class="postbody">oh, and it works on Dualis and DeSmuMe<br/>_________________<br/>PAlib official forum : <a class="postlink" href="http://www.palib.info" target="_blank">http://www.palib.info</a>
<br/>
PAlib official tutorials: <a class="postlink" href="http://www.palib.info/wiki" target="_blank">http://www.palib.info/wiki</a>
<br/>
Updates, help, code examples, tutorials, etc...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#72935 - mlequim - Wed Feb 22, 2006 2:55 pm</h4>
    <div class="postbody"><span class="postbody">ho nice !! i will download the latest versions !</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#100488 - Goosey - Mon Aug 28, 2006 5:38 am</h4>
    <div class="postbody"><span class="postbody">Hello I am running into similar issues.
<br/>
<br/>
My video init routine:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">   // Map VRAM to display a background on the main and sub screen and give us lots of sprites
<br/>
   vramSetMainBanks(   VRAM_A_MAIN_BG_0x6000000,   // Map A and B to main BG memory. This gives us 256KB which is healthy of 16-bit GFX
<br/>
                  VRAM_B_MAIN_BG_0x6020000,   
<br/>
                  VRAM_C_SUB_BG_0x6200000,   // Map C to sub background memory
<br/>
                  VRAM_D_LCD );            // Map D to LCD free space
<br/>
<br/>
   // Mapping E to main sprites gives us 64k for sprites. (64k is the max space that 1024 tiles take up in 256 color mode)
<br/>
   vramSetBankE( VRAM_E_MAIN_SPRITE );
<br/>
<br/>
   // Map banks for extended sprite palette
<br/>
   vramSetBankF( VRAM_F_OBJ_EXT_PALETTE );
<br/>
<br/>
   // Set video mode on the main screen
<br/>
   videoSetMode(   MODE_5_2D |                  // Set the graphics mode to Mode 5 2D
<br/>
               DISPLAY_SPR_ACTIVE |         // Turn on sprites
<br/>
               DISPLAY_BG3_ACTIVE |         // Turn on background 3
<br/>
               DISPLAY_SPR_1D |            // This is used when in tile mode
<br/>
               DISPLAY_SPR_EXT_PALETTE);
<br/>
<br/>
   // Set the video mode on the sub screen
<br/>
   videoSetModeSub(   MODE_5_2D |               // Set the graphics mode to Mode 5 2D
<br/>
                  DISPLAY_BG3_ACTIVE );      // Turn on background 3</td> </tr></table><span class="postbody">
<br/>
<br/>
Sprite setup routine
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">   // Map banks for extended sprite palette
<br/>
   vramSetBankF( VRAM_F_LCD );
<br/>
<br/>
   uint16 entirePaletteMem[256*3] = {0};
<br/>
   dmaCopy(blueyellow.Pal,   &amp;entirePaletteMem[0],   sizeof(u16)*blueyellow.PalSize);
<br/>
   dmaCopy(cyanpurple.Pal,   &amp;entirePaletteMem[256],   sizeof(u16)*cyanpurple.PalSize);
<br/>
   dmaCopy(redgreen.Pal,   &amp;entirePaletteMem[512],   sizeof(u16)*redgreen.PalSize);
<br/>
<br/>
   dmaCopy(entirePaletteMem, VRAM_F_EXT_PALETTE, sizeof(uint16)*256*3);
<br/>
<br/>
   // Map banks for extended sprite palette
<br/>
   vramSetBankF( VRAM_F_OBJ_EXT_PALETTE );
<br/>
   
<br/>
   uint32 gfxIDOffset = 0;
<br/>
   for (uint32 i = 0; i &lt; spriteDatList.size(); ++i)
<br/>
   {
<br/>
      SpriteData&amp; curDat = *(spriteDatList[i]);   
<br/>
<br/>
      //copy in the sprite graphics
<br/>
      dmaCopy(   curDat.Sprite,                     //from address
<br/>
               &amp;SPRITE_GFX[gfxIDOffset&gt;&gt;1],         //to address
<br/>
               sizeof(u8)*curDat.SpriteSize );         //size of data to copy
<br/>
      spriteEntry[i].attribute[0]   =   ATTR0_COLOR_256 | ATTR0_ROTSCALE;      //256 colors, able to rotscale
<br/>
      spriteEntry[i].attribute[1]   =   ATTR1_ROTDATA(i) | ATTR1_SIZE_64;      //size 64x64
<br/>
<br/>
      int paletteBank            = i; //for extended palettes only
<br/>
      int displayPriority         = 0;
<br/>
      int startingTileOffset      = gfxIDOffset&gt;&gt;5; //div by 32
<br/>
      spriteEntry[i].attribute[2]   =   (0xF000 &amp; (paletteBank&lt;&lt;12)) | 
<br/>
                              (0x0C00 &amp; (displayPriority&lt;&lt;10)) | 
<br/>
                              (0x03FF &amp; startingTileOffset);
<br/>
      gfxIDOffset += (curDat.SpriteSize);
<br/>
   }
<br/>
<br/>
   updateSprites(ships, spriteEntry, spriteRotation);
<br/>
<br/>
   //update the OAM
<br/>
   updateOAM(spriteEntry);</td> </tr></table><span class="postbody">
<br/>
<br/>
Sorry code not formatted well for forum.. :\
<br/>
<br/>
So, I am setting the DISPLAY_SPR_EXT_PALETTE, setting VRAM_F to be the VRAM_F_OBJ_EXT_PALETTE, and copying in the data. 
<br/>
<br/>
The code seems to work properly in Dualis, but on HW it fails (the sprites are all black, as if VRAM_F is not filled)
<br/>
<br/>
Some things:
<br/>
<ul>
<br/>
<li>Originally I <span style="font-style: italic">did not</span> set the VRAM_F to VRAM_F_LCD while copying and reset it to VRAM_F_OBJ_EXT_PALETTE afterowrds (seems illogical to me). However that results in VRAM_F being blank in Dualis (and still blank in hardware). This suggestion (thx KoD) seems to help in Dualis at least.
<br/>
</li><li>If I don't buffer the palettes into 'entirePaletteMem' then only the first palette appears to be in VRAM_F in Dualis. In hardware the third palette would appear to be in VRAM_F at the location the first palette should be (as if each dmaCopy was overwriting the previous, altough I DID dmaCopy into offsets of the VRAM_F).
<br/>
</li><li>Have tried replacing the dmaCopy's with swiFastCopy calls. In Dualis this results in black sprites, in HW this seems to result in transparent sprites (???)
<br/>
</li><li>Have tried replacing the dmaCopy's with memcpy calls. In both cases this results in black sprites.
<br/>
</li></ul>
<br/>
<br/>
<br/>
No idea where I am going wrong, this seems like it should be fairly straightfoward. Any suggestions appreciated.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#100492 - pkwong - Mon Aug 28, 2006 6:06 am</h4>
    <div class="postbody"><span class="postbody">i'm trying to ext. palettes for sprites too
<br/>
can display on HW with some errors
<br/>
<br/>
try removing this:
<br/>
(0xF000 &amp; (paletteBank&lt;&lt;12)) 
<br/>
<br/>
&gt;C-F SP  OE_A2_16C#  Sub-palette to use when in 16-color mode. Has no effect if the color mode flag (attr0{C}) is set.  
<br/>
(quote from: <a href="http://user.chem.tue.nl/jakvijn/tonc/regobj.htm" target="_blank">http://user.chem.tue.nl/jakvijn/tonc/regobj.htm</a> )
<br/>
<br/>
and try to copy to VRAM_F instead of VRAM_F_EXT_PALETTE
<br/>
<br/>
i dunno if it works, but that's the difference from my code
<br/>
<br/>
<br/>
<br/>
<br/>
let me ask my question here too. :P
<br/>
i have around 5xx color palettes, using ext. palette at VRAM_F.
<br/>
the sprites using the first 256 palettes works fine, but the later ones are corrupted.
<br/>
i see in dualis that the palettes are mapped to VRAM_F, Set 0, #1
<br/>
is there something extra i need to set before using that part of palettes?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#100493 - pkwong - Mon Aug 28, 2006 6:24 am</h4>
    <div class="postbody"><span class="postbody">i've just done some testing,
<br/>
it seems that copying the palettes to an array first won't work on HW
<br/>
<br/>
try direct copying them to VRAM_F from blueyellow.Pal..etc
<br/>
<br/>
sould it be the problem of dmaCopy?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#100536 - Goosey - Mon Aug 28, 2006 3:21 pm</h4>
    <div class="postbody"><span class="postbody">Thanks for the replies pkwong,
<br/>
<br/>
If you are not setting the palette offset in the sprite OAMs then all the sprites are going to be using the first palette. The link to Tonc's site refers to GBA which could not use additional 256 color palettes.
<br/>
<br/>
As I understand the extended palettes will map 8KB (of the 16KB buffer) for use in extended palettes. This will give space for 16 palettes of 256 colors. 
<br/>
<br/>
Not copying into the temporary buffer was (as noted in my first post) something that I did try to no avail.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#100546 - pkwong - Mon Aug 28, 2006 4:47 pm</h4>
    <div class="postbody"><span class="postbody">many thanks!
<br/>
i solved my problem.
<br/>
<br/>
sorry for misleading you...
<br/>
<br/>
<br/>
last try :P
<br/>
coz i really dun see much diff between yours and mine
<br/>
&gt;If I don't buffer the palettes into 'entirePaletteMem' then only the first palette appears to be in VRAM_F
<br/>
<br/>
don't buffer to entirePaletteMem AND copy to VRAM_F instead of VRAM_F_OBJ_EXT_PALETTE
<br/>
and of coz set to VRAM_F_LCD before that and VRAM_F_OBJ_EXT_PALETTE after
<br/>
and use dmaCopy, though i didn't try swiFastCopy
<br/>
<br/>
good luck!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#100635 - Goosey - Tue Aug 29, 2006 2:15 am</h4>
    <div class="postbody"><span class="postbody">Thanks pkwong! I have it working now following exactly as you described. Odd because I could have sworn I had this arrangement last night and it did not work, but *shrug* it work now! :D (both in HW and in Dualis).
<br/>
<br/>
Any experts have any explanation for why it fails to put this in a temporary buffer first? Not that I would find that preferable, but I find it very suprising that it didn't work.
<br/>
<br/>
EDIT:
<br/>
<br/>
One other question that is bugging me:
<br/>
<br/>
When I use extended OBJ palettes the original palette memory isn't used for that functionionality anymore.. Anyone know if it is used for another purpose by the NDS when extended palettes are active? Is it safe for CPU use? It is exposed to both CPU's right, so could use it for another IPC area?
<br/>
<br/>
Thx</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#101145 - dannyboy - Sun Sep 03, 2006 4:37 am</h4>
    <div class="postbody"><span class="postbody">Well I got this working having a palette written to an array, here's my code:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
// First add this option to the video mode
<br/>
| DISPLAY_SPR_EXT_PALETTE
<br/>
<br/>
void CSprite::SetPaletteColours(u8 PaletteID)
<br/>
{
<br/>
    for (int i = 0; i &lt; 256; i++) {
<br/>
        VRAM_I[(PaletteID * 256) + i] = Image.palette[i];
<br/>
    }
<br/>
}
<br/>
<br/>
<br/>
void CSprite::LoadImage(unsigned char* pcxFile, int i) // Load simage into the given memory location
<br/>
{
<br/>
    int offset = i*32*16;           // offset in memory for multiple sprites
<br/>
<br/>
    loadPCX(pcxFile, &amp;Image);           // load our pcx file into an image
<br/>
    imageTileData(&amp;Image);              // tile it so it is useful as sprite data
<br/>
    SetPaletteColours(i);                   // load it's palette
<br/>
    for(int i = 0; i &lt; 32*16; i++) { SPRITE_GFX_SUB[offset + i] = Image.data16[i]; }
<br/>
}
<br/>
<br/>
<br/>
void CSprite::LoadImages()
<br/>
{
<br/>
    vramSetBankI(VRAM_I_LCD);                       // Open VRAM bank for writing in palettes
<br/>
    // load pcx file into an image and then to sprite memory and also load palette
<br/>
    LoadImage((u8*)gbfs_get_obj(&amp;data_gbfs, "zero.pcx", NULL), 0);
<br/>
    LoadImage((u8*)gbfs_get_obj(&amp;data_gbfs, "one.pcx", NULL), 1);
<br/>
    vramSetBankI(VRAM_I_SUB_SPRITE_EXT_PALETTE);    // Close VRAM bank
<br/>
}
<br/>
<br/>
// void CSprite::SetImage(int i, int Value, int palette)
<br/>
{
<br/>
    sprites[i].oam-&gt;attribute[0] = ATTR0_COLOR_256 | ATTR0_SQUARE;
<br/>
    sprites[i].oam-&gt;attribute[1] = ATTR1_SIZE_32;
<br/>
    sprites[i].oam-&gt;attribute[2] = ATTR2_PALETTE(palette) | Value*32;     // how many 2 bytes to skip
<br/>
}
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
