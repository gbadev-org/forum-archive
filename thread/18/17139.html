<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>[HowTo] Read data from DS-Slot ROM [emulators only] - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>DS development > [HowTo] Read data from DS-Slot ROM [emulators only]</h2>
<div id="posts">
<div class="post">
    <h4>#172842 - Ruben - Mon Mar 08, 2010 8:51 am</h4>
    <div class="postbody"><span class="postbody">Hi all!
<br/>
<br/>
I just figured out how to read data from DS-Slot ROM [which I believe only works with emulators as I think flash software can only patch official stuff] so...
<br/>
<br/>
<span style="font-weight: bold"><span style="text-decoration: underline">Setting up a framework</span></span>
<br/>
<br/>
This step is quite important as it will define how you will setup your file reading routines.
<br/>
<br/>
Do you need directories? How long are the filenames allowed to be? Will they get exclusive rights/permissions?
<br/>
Those are some questions you need to ask yourself.
<br/>
For me, these are my answers:
<br/>
-I do not need directories, merely names
<br/>
-Filenames should only be 32-64 at most
<br/>
-No exclusive permissions
<br/>
<br/>
<span style="font-weight: bold"><span style="text-decoration: underline">Making a pseudo filesystem</span></span>
<br/>
<br/>
Now that you have your answers, you will need to make a program that adds files to your NDS binary. Something simple would be similar to this..
<br/>
<br/>
-Pad NDS file to 200h bytes
<br/>
-Find magic key for allocation table
<br/>
-Setup parameters in said allocation table [things like filename, filesize [padded to 200h bytes], permissions, etc]
<br/>
-Append files to NDS file, making sure to PAD EVERY FILE to 200h bytes
<br/>
<br/>
My program is rather simple, and can be found here: <a class="postlink" href="http://pastebin.com/rNDzwCnb" target="_blank">link</a>
<br/>
<br/>
<span style="font-weight: bold"><span style="text-decoration: underline">Accessing your filesystem</span></span>
<br/>
<br/>
Now that you have your files appended to the binary [there to no be loaded into RAM automatically] and have your FAT set up, you now need a way to read from ROM to get the right data.
<br/>
<br/>
The first part is rather simple: You look through your FAT until you find the file you're after and load its parameters needed for loading.
<br/>
<br/>
Now the tricky part is using the registers correctly [this took me AGES to figure out].
<br/>
<br/>
The first thing to do is enable the NDS-slot. To do this, you merely ORR the right bit into AUXSPICNT
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">REG_AUXSPICNT |= 0x8000; //alternatively, you can write 0x80
<br/>
                         //to the top byte</td> </tr></table><span class="postbody">
<br/>
Now that the DS-slot is enabled you have to tell it what to do. This is done by issuing a read command like so..
<br/>
<br/>
B7aaaaaaaa000000 &lt;- Read command [from gbaTek]
<br/>
<br/>
The B7 is the 'read' command. aaaaaaaa is the address/offset from which we want to read [aligned by 200h]. So the first thing to do is write the command to the register.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">REG_DSCARD_CMD[0] = 0xB7,
<br/>
REG_DSCARD_CMD[1] = offset&gt;&gt;24,
<br/>
REG_DSCARD_CMD[2] = offset&gt;&gt;16,
<br/>
REG_DSCARD_CMD[3] = offset&gt;&gt; 8,
<br/>
REG_DSCARD_CMD[4] = offset,
<br/>
REG_DSCARD_CMD[5] = 0,
<br/>
REG_DSCARD_CMD[6] = 0,
<br/>
REG_DSCARD_CMD[7] = 0;</td> </tr></table><span class="postbody">
<br/>
Notice that the offset is MSB first.
<br/>
<br/>
Now that the command has been sent, we have to enable the transfer. This is done by writing to ROMCTRL:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">REG_ROMCTRL = START + BIT(29) + SIZE(1); //A1000000h</td> </tr></table><span class="postbody">
<br/>
<br/>
Now the DS will read from ROM and give you the right data. How do we read it? Simple.
<br/>
We wait until the block word is ready [bit 23, ROMCTRL] and read a word from 0x04100010. This is done until we've read the full 200h block.
<br/>
If your file is bigger than 200h then you will need to do this more than once until all the 200h blocks are done.
<br/>
<br/>
My source can be found here: <a class="postlink" href="http://pastebin.com/7cABekBF" target="_blank">link</a>
<br/>
<br/>
<span style="font-weight: bold"><span style="text-decoration: underline">Final notes</span></span>
<br/>
<br/>
Well, this article may have been a bit confusing but hopefully the source code will help you figure out the parts that make no sense ;D
<br/>
<br/>
I'd like to thank DekuTree for putting up with me for ages about this and whoever it was that made gbaTek for its specs. ^-^'
<br/>
<br/>
Lastly, the dsfsLoad function can be used and/or distributed freely. No credit required though it would be nice. Also, it only takes a single argument which is the filename; it mallocs the length of the file and returns its address.
<br/>
<br/>
Until later!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#172846 - wintermute - Mon Mar 08, 2010 1:20 pm</h4>
    <div class="postbody"><span class="postbody">What's wrong with nitroFS?
<br/>
<br/>
Honestly, what's with all the wheel reinvention lately?<br/>_________________<br/><a class="postlink" href="http://www.devkitpro.org/" target="_blank">devkitPro - professional toolchains at amateur prices</a>
<br/>
<a class="postlink" href="http://wiki.devkitpro.org/index.php/IRC" target="_blank">devkitPro IRC support</a>
<br/>
<a class="postlink" href="http://davejmurphy.com/" target="_blank">Personal Blog</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#172848 - Ruben - Mon Mar 08, 2010 1:32 pm</h4>
    <div class="postbody"><span class="postbody">Well, I personally hadn't seen nitroFS mainly cos I compile with my own cart+linkscripts so I don't really know about any updates on libnds &gt;_&gt;'
<br/>
<br/>
EDIT:
<br/>
Also if I'm reading correctly, it reads from GBA-slot ROM rather than DS-slot ROM</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#172851 - wintermute - Mon Mar 08, 2010 2:03 pm</h4>
    <div class="postbody"><span class="postbody">Currently it reads from GBA slot on emulators and old style GBA flashcarts yes. On slot1 cards it reads via libfat.
<br/>
<br/>
If you *really* want to help then submit a patch which allows it to read from slot1 in desmume, that might even work on some recent slot1 flashcards.
<br/>
<br/>
The homebrew community needs yet another filesystem like it needs a hole in the head.
<br/>
<br/>
And just to make this absolutely clear, I really don't care what you do in your own applications for your own amusement. When it comes to releasing code for the community to use please, <span style="font-weight: bold">please</span> work with the devkitPro supplied tools and libraries. You can provide the greatest benefit to the community as a whole by helping to improve those.
<br/>
<br/>
<a href="http://en.wikipedia.org/wiki/The_Paradox_of_Choice:_Why_More_Is_Less" target="_blank">http://en.wikipedia.org/wiki/The_Paradox_of_Choice:_Why_More_Is_Less</a><br/>_________________<br/><a class="postlink" href="http://www.devkitpro.org/" target="_blank">devkitPro - professional toolchains at amateur prices</a>
<br/>
<a class="postlink" href="http://wiki.devkitpro.org/index.php/IRC" target="_blank">devkitPro IRC support</a>
<br/>
<a class="postlink" href="http://davejmurphy.com/" target="_blank">Personal Blog</a></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
