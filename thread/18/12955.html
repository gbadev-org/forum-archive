<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Background Transparency and 3D Edge Antialiasing - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>DS development > Background Transparency and 3D Edge Antialiasing</h2>
<div id="posts">
<div class="post">
    <h4>#125061 - rhaegar - Wed Apr 11, 2007 2:29 am</h4>
    <div class="postbody"><span class="postbody">A bit of a noob here so bear with me.
<br/>
<br/>
I seems like you can 'blend' more than 2 backgrounds together using BLEND_CR.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">BLEND_CR = BLEND_ALPHA | BLEND_DST_BG0 | BLEND_DST_BG1Â  | BLEND_DST_SPRITE | BLEND_SRC_BG2;
<br/>
BLEND_AB = 8 | 8&lt;&lt;8;</td> </tr></table><span class="postbody">This will render BG0, BG1 and sprites normally and then blend BG2 over this rendered image. The reverse however (swapping DST and SRC and inverting the background priorities) does not seem to work.
<br/>
<br/>
Situation:
<br/>
I'm using 2 background layers, BG0 and BG3 under mode 5. BG3 is a full screen tilled image. I'm using the 3D on BG0 to simulate  2D vector graphics using antialiasing and layers of flat shaded polygons along with one large polygon at the back for the background.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">BG0_CR = BG_PRIORITY(BG_PRIORITY_1);
<br/>
BG3_CR = BG_COLOR_16 | BG_RS_32x32 | BG_MAP_BASE(0) | BG_TILE_BASE(1) | BG_PRIORITY(BG_PRIORITY_0);
<br/>
BLEND_CR = BLEND_ALPHA | BLEND_DST_BG0 | BLEND_DST_SPRITE | BLEND_SRC_BG3;
<br/>
BLEND_AB = 8 | 8&lt;&lt;8;</td> </tr></table><span class="postbody">This will work properly, drawing the 3D and the priority 1 sprites, then blending this with BG3, and finally drawing the priority 0 sprites over that.
<br/>
<br/>
Problem:
<br/>
I want the transparent sprites to blend with the 3D background and not BG3. As i can't seem to simply replace BLEND_DST_SPRITE with BLEND_SRC_SPRITE, i revese the role of BG0 and BG3.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">BG0_CR = BG_PRIORITY(BG_PRIORITY_0);
<br/>
BG3_CR = BG_COLOR_16 | BG_RS_32x32 | BG_MAP_BASE(0) | BG_TILE_BASE(1) | BG_PRIORITY(BG_PRIORITY_1);
<br/>
BLEND_CR = BLEND_ALPHA | BLEND_SRC_BG0 | BLEND_DST_SPRITE | BLEND_DST_BG3;
<br/>
BLEND_AB = 8 | 8&lt;&lt;8;</td> </tr></table><span class="postbody">However, only the 3D and priority 0 sprites appear (no blending).
<br/>
Changing POLY_ALPHA under glPolyFmt will seem to fix the problem though i seem need a new POLY_ID for each polygon layer or they disappear completely (havent tried changing for every layer as it will require a significant recode). From what i can tell with different IDs though, i seem to loose antialiasing.
<br/>
<br/>
So my question is, how can i blend the 3D layer into the rest of my screen without loosing antialiasing?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#125064 - DekuTree64 - Wed Apr 11, 2007 2:53 am</h4>
    <div class="postbody"><span class="postbody">Yeah, anti-aliasing only works for opaque polygons, so you'll have to use BLEND_CR if you want transparency+AA.
<br/>
<br/>
I'm not sure if I understand the effect you're going for though. So you want a solid tile background in the back, a 50% transparent 3D layer above it, and then 50% transparent sprites on top of all that? And you need to be able to see the 3D stuff through the sprites?<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#125066 - rhaegar - Wed Apr 11, 2007 3:15 am</h4>
    <div class="postbody"><span class="postbody">I want a solid tile background in the back, sprites ontop of this background, and 50% transparent 3D layer ontop of all of it. I can do 3D layer at the back, sprites above it, and 50% tile background on the top. The difference being i want the sprites to blend with the 3D as opposed to the tile layer.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#125069 - DekuTree64 - Wed Apr 11, 2007 3:32 am</h4>
    <div class="postbody"><span class="postbody">Oh ok, so the sprites themselves aren't transparent? That should be no problem then. Try this:
<br/>
<br/>
BG0: Priority 0
<br/>
Sprites: Priority 1
<br/>
BG3: Priority 1
<br/>
<br/>
BLEND_CR: SRC_BG0 | DST_BG3 | DST_SPRITE<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#125073 - rhaegar - Wed Apr 11, 2007 4:06 am</h4>
    <div class="postbody"><span class="postbody">This is what i had initially. The problem is that the sprites blend with BG3 but i want them to blend with the 3D...
<br/>
Will have a look at screen capture and see if that is of any use, though its probably more effort that its worth.
<br/>
Might just stick with what i have.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#125075 - DekuTree64 - Wed Apr 11, 2007 4:45 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>rhaegar wrote:</b></span></td> </tr> <tr> <td class="quote">The problem is that the sprites blend with BG3 but i want them to blend with the 3D...</td> </tr></table><span class="postbody">
<br/>
Hmm, that's strange. With dest set to BG3+sprites, those two should be flattened together before blending takes place. Are you testing on hardware, or an emulator? If you can't run on hardware, send me a .nds and I'll try it. My email is my nickname here, at hotmail.com.<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#125076 - rhaegar - Wed Apr 11, 2007 5:03 am</h4>
    <div class="postbody"><span class="postbody">Sorry, read ur post wrong. Thought u had BG0 as DST and BG3 as SRC.
<br/>
I can put the BG3 on top (flattening out 3D and sprites), but putting 3D on top (BG0 as DST) means only the 3D is displayed for some reason.
<br/>
I'm running it on hardware.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
