<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Sprite won't display properly - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>DS development > Sprite won't display properly</h2>
<div id="posts">
<div class="post">
    <h4>#124648 - Stuk - Sat Apr 07, 2007 4:27 pm</h4>
    <div class="postbody"><span class="postbody">I seem to be encountering a few problems learning to code for the DS :)
<br/>
<br/>
This time I can't get a 16x16 sprite to appear properly. The left of the image is how it appears in emulators and on the DS, and the right is how it should appear (without the magenta eventually :) ):
<br/>
<a href="http://www.thejunkyard.co.uk/ds/badds.png">[Images not permitted - Click here to view it]</a>
<br/>
For this I've set the sprite attributes to be 32x32 just to show that the data is there, but not in the right place. When set to 16x16 just the top red and green parts are shown.
<br/>
<br/>
This is the code I'm using to display the sprite:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
   //sprite attribute memory
<br/>
   SpriteEntry *spritesMain = new SpriteEntry[128];
<br/>
   //rotation attributes overlap so assign then to the same location
<br/>
   SpriteRotation *spriteRotationsMain = (SpriteRotation *)spritesMain;
<br/>
<br/>
   initOAM(spritesMain, spriteRotationsMain);
<br/>
<br/>
   int x = 10, y= 110, loc = 32;
<br/>
<br/>
   spritesMain[0].attribute[0] = ATTR0_COLOR_256 | ATTR0_ROTSCALE_DOUBLE | y;
<br/>
   spritesMain[0].attribute[1] = ATTR1_ROTDATA(0) | ATTR1_SIZE_32 | x; //Set to 32 for debugging, should be 16
<br/>
   spritesMain[0].attribute[2] = loc;
<br/>
<br/>
   //copy in the sprite palettes
<br/>
   dmaCopy(ball_pal_bin, SPRITE_PALETTE, ball_pal_bin_size);
<br/>
<br/>
   //copy the sprite graphics in obj graphics mem
<br/>
   dmaCopy(ball_img_bin, &amp;SPRITE_GFX[loc * 16], ball_img_bin_size);
<br/>
<br/>
   updateOAM(spritesMain);
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
And this is how I've set up the memory:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
   videoSetMode(MODE_0_2D | DISPLAY_BG0_ACTIVE| DISPLAY_SPR_ACTIVE );
<br/>
   videoSetModeSub(MODE_0_2D | DISPLAY_BG0_ACTIVE);
<br/>
<br/>
   vramSetMainBanks(VRAM_A_MAIN_BG, VRAM_B_MAIN_BG, VRAM_C_SUB_BG, VRAM_D_LCD);
<br/>
   vramSetBankE(VRAM_E_MAIN_SPRITE);
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
initOAM() clears the attributes for all sprites. Does anybody have any ideas on what might be going wrong? I wondered if I should be using a different display mode, but on switching this to MODE_5_2D everything broke :). I could have another stab at it if that is the problem.
<br/>
<br/>
Any help would be appreciated, 
<br/>
Stuk</span><span class="gensmall"><br/><br/>Last edited by Stuk on Sat Apr 07, 2007 4:57 pm; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#124650 - Dark Knight ez - Sat Apr 07, 2007 4:36 pm</h4>
    <div class="postbody"><span class="postbody">You have no copy for the sprites array to OAM?<br/>_________________<br/><span style="font-size: 9px; line-height: normal"><a class="postlink" href="http://amplituds.drunkencoders.com" target="_blank">AmplituDS website</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#124653 - Stuk - Sat Apr 07, 2007 4:56 pm</h4>
    <div class="postbody"><span class="postbody">Oops, forgot to include the trailing updateOAM(spritesMain) in my first post (now updated) which does this:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void updateOAM(SpriteEntry *spriteEntry) {
<br/>
   DC_FlushAll();
<br/>
    dmaCopy(spriteEntry, OAM, 128 * sizeof(SpriteEntry));
<br/>
}</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#124662 - tepples - Sat Apr 07, 2007 5:24 pm</h4>
    <div class="postbody"><span class="postbody">There are two things that could cause that issue: <ol type="1"><li>Size is 32 (where it should be 16). </li><li>Shape is wide (where it should be square). </li></ol><br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#124665 - Stuk - Sat Apr 07, 2007 5:39 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tepples wrote:</b></span></td> </tr> <tr> <td class="quote">1. Size is 32 (where it should be 16).</td> </tr></table><span class="postbody">
<br/>
Like I mentioned, I've set it to 32 for debugging, just to show the data has been copied <span style="font-style: italic">somewhere</span>. When it is set to
<br/>
spritesMain[0].attribute[1] = ATTR1_ROTDATA(0) | ATTR1_SIZE_<span style="font-weight: bold">16</span> | x;
<br/>
Then I get this: <a href="http://www.thejunkyard.co.uk/ds/just16.png">[Images not permitted - Click here to view it]</a>
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tepples wrote:</b></span></td> </tr> <tr> <td class="quote">2. Shape is wide (where it should be square). </td> </tr></table><span class="postbody">
<br/>
I've tried that as well:
<br/>
spritesMain[0].attribute[0] = <span style="font-weight: bold">ATTR0_SQUARE</span> | ATTR0_COLOR_256 | ATTR0_ROTSCALE_DOUBLE | y;
<br/>
gives exactly the same results. I assume "square" is default.
<br/>
<br/>
Thanks for the help so far :)
<br/>
<br/>
In case it helps some of the other code I'm using is in <a class="postlink" href="http://forum.gbadev.org/viewtopic.php?p=124435" target="_blank">this topic</a>, although obviously updated slightly for the addition of sprites.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#124669 - tepples - Sat Apr 07, 2007 5:54 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Stuk wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tepples wrote:</b></span></td> </tr> <tr> <td class="quote">2. Shape is wide (where it should be square). </td> </tr></table><span class="postbody">
<br/>
I've tried that as well:
<br/>
spritesMain[0].attribute[0] = <span style="font-weight: bold">ATTR0_SQUARE</span> | ATTR0_COLOR_256 | ATTR0_ROTSCALE_DOUBLE | y;
<br/>
gives exactly the same results. I assume "square" is default.</span></td> </tr></table><span class="postbody">
<br/>
You're correct that square is the default. It's more likely that the value of the variable "y" is overwriting the bits intended for square/wide/tall. Have you tried following the suggestion in <a class="postlink" href="http://forum.gbadev.org/viewtopic.php?p=6775#6775" target="_blank">FAQ</a> question "Why do my sprites become corrupt when I move them off the top or the left side of the screen"?
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">spritesMain[0].attribute[0] = ATTR0_SQUARE | ATTR0_COLOR_256 | ATTR0_ROTSCALE_DOUBLE
<br/>
                              | (y &amp; 0x00FF);
<br/>
</td> </tr></table><span class="postbody">
<br/>
And have you tried it with 16-color and non-rot/scale sprites?<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#124674 - Stuk - Sat Apr 07, 2007 6:31 pm</h4>
    <div class="postbody"><span class="postbody">Anding 0x00FF and 0x01FF to y and x respectively made no difference. This is occurring over the whole screen, not just at the top or left. 
<br/>
<br/>
Using a 16 colour image again made no difference.
<br/>
<br/>
And do I only need to remove ATTR0_ROTSCALE_DOUBLE to make sure I'm not using rot/scale sprites?
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">   spritesMain[0].attribute[0] = ATTR0_SQUARE | ATTR0_COLOR_256  | (y &amp; 0x00FF);
<br/>
   spritesMain[0].attribute[1] = ATTR1_ROTDATA(0) | ATTR1_SIZE_16 | (x &amp; 0x01FF);</td> </tr></table><span class="postbody">
<br/>
<br/>
I've also just realised that I've done this earlier:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">    BG0_CR     = BG_32x32 | BG_COLOR_256 | BG_MAP_BASE(0) | BG_TILE_BASE(1);
<br/>
    SUB_BG0_CR = BG_32x32 | BG_COLOR_256 | BG_MAP_BASE(2) | BG_TILE_BASE(3);</td> </tr></table><span class="postbody">
<br/>
Would that affect the 16x16 sprite? Or am I just being silly now? :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#124691 - LiraNuna - Sat Apr 07, 2007 8:42 pm</h4>
    <div class="postbody"><span class="postbody">Is your sprite tiling layout set to 1D?
<br/>
<br/>
DISPLAY_SPR_1D
<br/>
<br/>
Else the tile location might point to a different tile<br/>_________________<br/>Private property.
<br/>
Violators will be shot, survivors will be shot again.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#124694 - Stuk - Sat Apr 07, 2007 8:52 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>LiraNuna wrote:</b></span></td> </tr> <tr> <td class="quote">Is your sprite tiling layout set to 1D?
<br/>
<br/>
DISPLAY_SPR_1D</td> </tr></table><span class="postbody">
<br/>
Ahh hah!! Joy :D
<br/>
<br/>
So in conclusion this is the change that needed to be done:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">videoSetMode(MODE_0_2D | DISPLAY_BG0_ACTIVE| DISPLAY_SPR_ACTIVE | DISPLAY_SPR_1D);
<br/>
                                                                ^^^^^^^^^^^^^^^^</td> </tr></table><span class="postbody"> Your help is very much appreciated, thank you. *Very happy*
<br/>
<br/>
Now lets see if I can do something decent with this new knowledge :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#124704 - beamer30 - Sat Apr 07, 2007 9:56 pm</h4>
    <div class="postbody"><span class="postbody">before i post i just want to say im n00b so thats why i'm asking this question:
<br/>
<br/>
wouldn't it be easier to just use PAlib, or is there a certian reason your opening sprites that way?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#124706 - Stuk - Sat Apr 07, 2007 10:04 pm</h4>
    <div class="postbody"><span class="postbody">Indeed I did think of resorting to PALib, but I want to learn about the hardware as it is, rather than have everything done for me through a layer of abstraction.
<br/>
<br/>
This way might be more difficult, but hell, it's a learning experience... and I want to be "hardcore" :P</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#124708 - beamer30 - Sat Apr 07, 2007 10:09 pm</h4>
    <div class="postbody"><span class="postbody">ok thanks i was just wondering hop you "hardcore" trining goes well</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#124716 - tepples - Sat Apr 07, 2007 11:30 pm</h4>
    <div class="postbody"><span class="postbody">As far as I know, PAlib is DS-only. Going directly to the hardware and building your own abstractions on top of that makes it easier to develop GBA and DS versions of a work in parallel.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
