<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>stuck with 3ds model import function - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>DS development > stuck with 3ds model import function</h2>
<div id="posts">
<div class="post">
    <h4>#108491 - chrissieboy - Thu Nov 09, 2006 3:48 pm</h4>
    <div class="postbody"><span class="postbody">Hi guys im busy with a function to load a 3ds model.
<br/>
I renamed the model.3ds to hovercraft.bin and include it in my main.cpp
<br/>
I read some tutorials about how the 3ds model is build.
<br/>
I viewed the model with a hex viewer, everything went ok.
<br/>
But when my code reach the VERTICES LIST wich starts with 0x4110 it stops reading the 3ds file(renamed to .bin).
<br/>
Everything after the VERTICES LIST is also not be found in the hovercraft.bin
<br/>
<br/>
I really dont understand why this is happening???
<br/>
Because the MAIN CHUNK, 3D EDITOR CHUNK, OBJECT BLOCK and  TRIANGULAR MESH are all found??
<br/>
<br/>
When i printout on the ds the part of memory where VERTICES LIST is it displays the hex values:
<br/>
<span style="font-weight: bold">10 41</span> 00 0B  00 00 EA 00 D7 85 84 3F
<br/>
<br/>
so it really exists but the swith/case doesn't see that its there or something???
<br/>
<br/>
Does anyone no why ? because im really stuck now...
<br/>
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
for(int i=0;i&lt;2800;i++)
<br/>
{
<br/>
<br/>
<br/>
    switch (((u16*)hovercraft_bin)[i])
<br/>
    {
<br/>
      // MAIN CHUNK
<br/>
        case 0x4d4d: 
<br/>
      iprintf("%04x  ", ((u16*)hovercraft_bin)[i]);
<br/>
      iprintf("MAIN CHUNK Found! %d\n", i);
<br/>
        break; 
<br/>
      
<br/>
      // 3D EDITOR CHUNK
<br/>
        case 0x3D3D: 
<br/>
      iprintf("%04x  ", ((u16*)hovercraft_bin)[i]);
<br/>
      iprintf("3D EDITOR CHUNK Found! %d\n",i);
<br/>
        break; 
<br/>
<br/>
      // OBJECT BLOCK
<br/>
        case 0x4000: 
<br/>
      iprintf("%04x  ", ((u16*)hovercraft_bin)[i]);
<br/>
      iprintf("OBJECT BLOCK Found! %d\n", i);
<br/>
      
<br/>
        break; 
<br/>
<br/>
      // TRIANGULAR MESH
<br/>
        case 0x4100: 
<br/>
      iprintf("%04x  ", ((u16*)hovercraft_bin)[i]);
<br/>
      iprintf("TRIANGULAR MESH Found! %d\n", i);
<br/>
        break; 
<br/>
<br/>
      // VERTICES LIST
<br/>
        case 0x4110: 
<br/>
      iprintf("%04x  ", ((u16*)hovercraft_bin)[i]);
<br/>
      iprintf("VERTICES LIST Found! %d\n", i);
<br/>
        break;    
<br/>
<br/>
      // FACES DESCRIPTION
<br/>
        case 0x4120: 
<br/>
      iprintf("%04x  ", ((u16*)hovercraft_bin)[i]);
<br/>
      iprintf("FACES DESCRIPTION Found! %d\n",i);
<br/>
        break;    
<br/>
<br/>
      // MAPPING COORDINATES LIST
<br/>
        case 0x4140: 
<br/>
      iprintf("%04x  ", ((u16*)hovercraft_bin)[i]);
<br/>
      iprintf("MAPPING COORDINATES LIST Found! %d\n",i );
<br/>
        break; 
<br/>
   }
<br/>
   
<br/>
}
<br/>
</td> </tr></table><span class="postbody">[/b]</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#108520 - thegamefreak0134 - Thu Nov 09, 2006 9:12 pm</h4>
    <div class="postbody"><span class="postbody">The only thing I can figure is that you are limiting your initial for loop to 2800. Perhaps set it using the sizeof() function to make sure it scans the entire array? I see no obvious problems with the code, and it looks like you copied and pasted and changed the values, so the code after the problem point should be fine. The behavior you describe sounds very much like the loop is stopping before it ever gets to the verticies list.<br/>_________________<br/>What if the hokey-pokey really is what it's all about?
<br/>
<br/>
[url=http:/www.darknovagames.com/index.php?action=recruit&amp;clanid=1]Support Zeta on DarkNova![/url]</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#108530 - chrissieboy - Thu Nov 09, 2006 10:45 pm</h4>
    <div class="postbody"><span class="postbody">yeah that was also the first thing i was thinking, but if i make it 1000000 it still doesn't works.
<br/>
<br/>
But i figured out that its 16 bytes after the TRIANGULAIR MESH, so it MUST work but i dont know why it doesn't works???
<br/>
<br/>
So still stuck, anyway thanx for your time and help!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#108548 - Cearn - Fri Nov 10, 2006 12:28 am</h4>
    <div class="postbody"><span class="postbody">Looking at the 3Ds file specs (<a class="postlink" href="http://www.wotsit.org" target="_blank">www.wotsit.org</a>, FTW) it doesn't seem like the file doesn't care much about data alignment. For example, a chunk header is a short followed directly by a long, even though that means that the long isn't 4byte aligned like an ARM processor requires. It's possible somewhere there's an odd-sized chunk, which might throw all the later chunks off their proper alignment. Since you've managed to find the vertex chunk yourself, check whether it's on an even byte boundary.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#108581 - toa - Fri Nov 10, 2006 6:48 am</h4>
    <div class="postbody"><span class="postbody"><a href="http://sourceforge.net/projects/lib3ds/" target="_blank">http://sourceforge.net/projects/lib3ds/</a>
<br/>
<br/>
Very nice C-interface 3ds decoding etc. library.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#108605 - chrissieboy - Fri Nov 10, 2006 11:52 am</h4>
    <div class="postbody"><span class="postbody">Cearn!! thanx i had take a look at it, when i rename my .3ds file in 3dstudio max.
<br/>
So the model was Object02 and i renamed it in 3dmax to bject02 then it follows a good 4 byte segment, and i see the rest of the chunks found!!
<br/>
Because i use ((u16*)hovercraft_bin)[i] it expects 4 byte segment i think?
<br/>
<br/>
So if i make it ((u8*)hovercraft_bin)[i] it expects 2 byte segment i think?
<br/>
<br/>
If i use this code :
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
if(((u8*)hovercraft_bin)[i] == 0x40 &amp;&amp; ((u8*)hovercraft_bin)[i-1] == 0x10)
<br/>
</td> </tr></table><span class="postbody">
<br/>
It will find the chunk 0x4010, but then there comes another problem, then i must read the float vectors x,y,z wich are each 4 bytes :
<br/>
<br/>
<span style="font-weight: bold">EA 00 D7 85</span> 84 3F 66 1F <span style="font-weight: bold">EF 3E FE C5</span>
<br/>
<br/>
<br/>
So i thought to make something like this :
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
vector.x[0] = ((u8*)hovercraft_bin)[i+5] + ((u8*)hovercraft_bin)[i+6] + ((u8*)hovercraft_bin)[i+7] + ((u8*)hovercraft_bin)[i+8] 
<br/>
<br/>
vector.y[0] = ((u8*)hovercraft_bin)[i+9] + ((u8*)hovercraft_bin)[i+10] + ((u8*)hovercraft_bin)[i+11] + ((u8*)hovercraft_bin)[i+12]
<br/>
<br/>
vector.z[0] = ((u8*)hovercraft_bin)[i+13] + ((u8*)hovercraft_bin)[i+14] + ((u8*)hovercraft_bin)[i+15] + ((u8*)hovercraft_bin)[i+16]
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
But i can't figure out whats the code to merge 4 time ((u8*)hovercraft_bin)[i] together? because above doesn't work :(
<br/>
<br/>
I thought maybe merge it like this together?? :
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
vector.z[0] = ((u8*)hovercraft_bin)[i+13] &amp; ((u8*)hovercraft_bin)[i+14] &amp; ((u8*)hovercraft_bin)[i+15] &amp; ((u8*)hovercraft_bin)[i+16]
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Also no good results, sorry for my bad programming but im very new to c++, so high level coding with pointers im still learning, but i think i need a pointer to search trough the hex data.
<br/>
So when i read 4bytes i move the pointer 4bytes, and when i read 2bytes i move the pointer 2bytes, and then search further for the chunks?
<br/>
<br/>
Also found this tutorial about loading 3ds model :
<br/>
<a class="postlink" href="http://www.spacesimulator.net/tut4_3dsloader.html" target="_blank">http://www.spacesimulator.net/tut4_3dsloader.html</a>
<br/>
<br/>
But this is loading an 3ds model from a fat system, and my efa cardridge is not able to use chrishm his fat filesystem :(
<br/>
<br/>
Hope you guys can help me ;)
<br/>
Anyway thanx for all your help and time!!!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#108615 - Cearn - Fri Nov 10, 2006 2:53 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>chrissieboy wrote:</b></span></td> </tr> <tr> <td class="quote">Cearn!! thanx i had take a look at it, when i rename my .3ds file in 3dstudio max.
<br/>
So the model was Object02 and i renamed it in 3dmax to bject02 then it follows a good 4 byte segment, and i see the rest of the chunks found!!
<br/>
Because i use ((u16*)hovercraft_bin)[i] it expects 4 byte segment i think?
<br/>
<br/>
So if i make it ((u8*)hovercraft_bin)[i] it expects 2 byte segment i think?
<br/>
</td> </tr></table><span class="postbody">
<br/>
? These sentences make little sense. Please clarify.
<br/>
<br/>
Anyway, as I said before:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code"> C type  | ARM name | typedef | size
<br/>
char     | byte     | s8/u8   | 1 byte
<br/>
short    | halfword | s16/u16 | 2 bytes
<br/>
int/long | word     | s32/u32 | 4 bytes</td> </tr></table><span class="postbody">
<br/>
<br/>
So if you interpret the file as a halfword array you'll always work with 2-byte boundaries. The problem is that .3ds files aren't halfword arrays or use any kind of alignment requirements so that reading them as anything else than byte for byte could be problematic. 
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>chrissieboy wrote:</b></span></td> </tr> <tr> <td class="quote">If i use this code :
<br/>
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
if(((u8*)hovercraft_bin)[i] == 0x40 &amp;&amp; ((u8*)hovercraft_bin)[i-1] == 0x10)
<br/>
</td> </tr></table><span class="postbody">
<br/>
It will find the chunk 0x4010, but then there comes another problem, then i must read the float vectors x,y,z wich are each 4 bytes :
<br/>
<br/>
<span style="font-weight: bold">EA 00 D7 85</span> 84 3F 66 1F <span style="font-weight: bold">EF 3E FE C5</span>
<br/>
<br/>
So i thought to make something like this :
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
vector.x[0] = ((u8*)hovercraft_bin)[i+5] + ((u8*)hovercraft_bin)[i+6] + ((u8*)hovercraft_bin)[i+7] + ((u8*)hovercraft_bin)[i+8] 
<br/>
</td> </tr></table><span class="postbody"></span></td> </tr></table><span class="postbody">
<br/>
Reading individual bytes and piecing them together is part of what you should be doing, yeah, but there are several points to be aware of here.
<br/>
First, simply adding the individual bytes does just that: add the bytes. This is what you're doing here: 0xEA + 0x00 + 0xD7 + 0x85. Naturally, this isn't how you string together bytes to a word. Borrowing from <a class="postlink" href="http://forum.gbadev.org/viewtopic.php?t=11648" target="_blank">this thread</a>:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tepples wrote:</b></span></td> </tr> <tr> <td class="quote">unsigned int peeki32(const unsigned char *src) {
<br/>
  return src[0] | (src[1] &lt;&lt; 8) | (src[2] &lt;&lt; 16) | (src[3] &lt;&lt; 24);
<br/>
}
<br/>
<br/>
unsigned int peeki16(const unsigned char *src) {
<br/>
  return src[0] | (src[1] &lt;&lt; 8);
<br/>
}</td> </tr></table><span class="postbody">
<br/>
Reading floats is eve more problematic because the 4-byte chunk you'll have assembled will be an integer and assigning it to a float will convert the integer to a float, not reinterpret the bits. For example 0x85D700EA = -2049507094, which I'm sure you don't have in your file somewhere. Floats have a different bit format so simply casting won't work. What might work is this (note: untested)
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">float peekfloat(const unsigned char *src) {
<br/>
  u32 tmp[1];
<br/>
  *tmp= src[0] | (src[1] &lt;&lt; 8) | (src[2] &lt;&lt; 16) | (src[3] &lt;&lt; 24);
<br/>
  return *(float*)tmp;
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
There are better ways, especially as the floats will have to be converted back to fixed points later on, but this'll have to do for now.
<br/>
<br/>
As you're still getting to grips with C++ and pointers, I must again strongly urge you to work it out on a PC first. The ability to set breakpoints and examining memory and variables in an IDE will help you a lot. Forget about reading 3d files for a moment and learn proper pointer/memory use first. Create a small, well-defined set of test-data and read that with differently typed pointers and at different byte offsets and see what happens. This will allow you to be prepared for problems you might encounter in Real Life. 
<br/>
<br/>
Also, use pointer variables instead of casting hovercraft_bin directly all the time. It'll make your code more readable and maintainable. A 3ds file is composed of chunks, so parsing them as such (rather than just one big array) is more proper. The chunks also indicate how big each of them is, so you don't have to search the whole file for them. For example:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">// Pseudo code for 3ds parsing
<br/>
void parse_3ds(const u8 *src)
<br/>
{
<br/>
    const u8 *chunk= src;
<br/>
    while( not EOF )
<br/>
    {
<br/>
        // Get chunk type
<br/>
        u16 chunk_type = peeki16(chunk);
<br/>
        switch(chunk_type)
<br/>
        {
<br/>
        case CHUNK_TYPE0:
<br/>
            chunk += load_chunk_type0(chunk);
<br/>
            break;
<br/>
        case CHUNK_TYPE1:
<br/>
            chunk += load_chunk_type1(chunk);
<br/>
            break;
<br/>
<br/>
        ...  other cases
<br/>
<br/>
        default:
<br/>
            chunk += peeki32(chunk+2);
<br/>
        }
<br/>
    }
<br/>
}
<br/>
<br/>
u32 load_chunk_type0(const u8* chunk)
<br/>
{
<br/>
    chunk_len= peeki32(chunk+2);
<br/>
    chunk += 6;  // skip chunk header
<br/>
<br/>
    // code to load chunk
<br/>
<br/>
    return chunk_len;  // return chunk length so the caller knows how much to skip
<br/>
}
<br/>
<br/>
</td> </tr></table><span class="postbody">
<br/>
It should be something like that, I'm pretty sure there is a more optimal way of reading them, but this would be a start.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#108617 - chrissieboy - Fri Nov 10, 2006 3:30 pm</h4>
    <div class="postbody"><span class="postbody">thank you very very very much Cearn!
<br/>
<br/>
It start to make sense to me now, but i think i first need to learn more about pointers, because when i read it, its very difficult for me to understand.
<br/>
<br/>
I think its a good idea to learn with the debugger because then i really understand how and what c is doing in the memory, i used it already a couple of times.
<br/>
<br/>
But when reading the spacesim tutorial i thought this is a good tutorial to start with and trying to use it on the ds.
<br/>
<br/>
But now i know its not that easy ;)
<br/>
<br/>
I'm going to expiriment and read a lot this weekend, so hope to come back next week with a finished 3ds model loader ;)
<br/>
<br/>
Anyway thank you all very very much for your time, and helping me to get further.
<br/>
<br/>
When im stuck next week im going to post it here again!!
<br/>
<br/>
-Chris</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
