<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Sprite rotation problem - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>DS development > Sprite rotation problem</h2>
<div id="posts">
<div class="post">
    <h4>#149546 - jonezer4 - Mon Jan 21, 2008 10:06 pm</h4>
    <div class="postbody"><span class="postbody">I'm updating some code and come across a weird issue I can't figure out. The old way I used to set up attribute 1 for sprites was like this:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">oamMainP-&gt;spriteBuffer[n].attribute[1] = ATTR1_ROTDATA(n) |ATTR1_SIZE_64   | 0;    
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I'm updating it to the easier to read:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
oamMainP-&gt;spriteBuffer[n].posX = 0;
<br/>
oamMainP-&gt;spriteBuffer[n].rsMatrixIdx = ATTR1_ROTDATA(n);
<br/>
oamMainP-&gt;spriteBuffer[n].objSize = OBJSIZE_64;</td> </tr></table><span class="postbody">
<br/>
<br/>
In both of those "n" is just a number incremented in a for loop, 0 to 31.
<br/>
<br/>
The old way works perfectly, but the new way, all my sprites seem to share the exact same rotation matrix (matrix 0 it appears). Any ideas? Here's the full code for the relevant area:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
<br/>
void initSpritesMain(tOAM* oamMainP, SpriteInfo* spriteInfoMainP)
<br/>
{
<br/>
   //init OAM
<br/>
   initOAM(oamMainP-&gt;spriteBuffer, oamMainP-&gt;matrixBuffer, MAIN_SCREEN);
<br/>
<br/>
   for (int n = 0; n &lt; 32; n++) {
<br/>
   //Attribute 0 stuff
<br/>
   oamMainP-&gt;spriteBuffer[n].posY = 0;
<br/>
   oamMainP-&gt;spriteBuffer[n].isRotoscale = true;
<br/>
<br/>
   oamMainP-&gt;spriteBuffer[n].rsDouble = false;
<br/>
   oamMainP-&gt;spriteBuffer[n].objMode = OBJMODE_NORMAL;
<br/>
   oamMainP-&gt;spriteBuffer[n].isMosaic = false;
<br/>
   oamMainP-&gt;spriteBuffer[n].colMode = OBJCOLOR_256;
<br/>
   oamMainP-&gt;spriteBuffer[n].objShape = OBJSHAPE_SQUARE;
<br/>
<br/>
        //ATTRIBUTE 1 STUFF THAT DOESN'T WORK
<br/>
   //oamMainP-&gt;spriteBuffer[n].posX = 0;
<br/>
   //if (n &lt; 32)
<br/>
   //   oamMainP-&gt;spriteBuffer[n].rsMatrixIdx = ATTR1_ROTDATA(n);
<br/>
   //else
<br/>
   //   oamMainP-&gt;spriteBuffer[n].rsMatrixIdx = ATTR1_ROTDATA(31);
<br/>
<br/>
   //   oamMainP-&gt;spriteBuffer[n].objSize = OBJSIZE_64;
<br/>
<br/>
   //Attribute 1
<br/>
   oamMainP-&gt;spriteBuffer[n].attribute[1] = ATTR1_ROTDATA(n) 
<br/>
                                 |ATTR1_SIZE_64
<br/>
                                 | 0;    //posX   
<br/>
<br/>
   //Attribute 2
<br/>
   oamMainP-&gt;spriteBuffer[n].tileIdx = spriteGfxID * n;
<br/>
   oamMainP-&gt;spriteBuffer[n].objPal = spriteGfxID * n;
<br/>
   oamMainP-&gt;spriteBuffer[n].objPriority = OBJPRIORITY_3;         //lowest   
<br/>
   hideSprite(&amp;oamMainP-&gt;spriteBuffer[n], true);               //hide all sprites upon initialization
<br/>
   spriteInfoMainP[n].entry = &amp;oamMainP-&gt;spriteBuffer[n];
<br/>
<br/>
         rotateSprite(&amp;oamMainP-&gt;matrixBuffer[n], 0);
<br/>
      spriteInfoMainP[n].rot = &amp;oamMainP-&gt;matrixBuffer[n];
<br/>
<br/>
   }
<br/>
<br/>
   
<br/>
<br/>
   //Copying all sprite images and palette into dma at once
<br/>
   dmaCopyHalfWords(SPRITE_DMA_CHANNEL,cardsTiles,&amp;SPRITE_GFX[0], cardsTilesLen);
<br/>
   dmaCopyHalfWords(SPRITE_DMA_CHANNEL, cardsPal,(uint16 *)SPRITE_PALETTE,cardsPalLen);
<br/>
   updateOAM(oamMainP-&gt;spriteBuffer,MAIN_SCREEN);   
<br/>
}
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#149570 - Cearn - Tue Jan 22, 2008 1:29 am</h4>
    <div class="postbody"><span class="postbody">ATTR1_ROTDATA (and all the other ATTRx macros) shift the values so that they can be ORRed into the attributes For example, ATTR1_ROTDATA(1) gives 1&lt;&lt;8 = 0x0100. Using the C bitfield construct because such bit manipulations unnecessary. Just use the number as is: rsMatrixIdx= 1 and such.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
