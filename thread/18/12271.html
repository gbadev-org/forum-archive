<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>DS Memory Expansion Pak - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>DS development > DS Memory Expansion Pak</h2>
<div id="posts">
<div class="post">
    <h4>#116624 - chishm - Sat Jan 27, 2007 2:18 pm</h4>
    <div class="postbody"><span class="postbody">I got the DS (Lite) <b style="color:#FFA34F">Browser</b> today, so naturally I played with the memory pak a bit. Since I haven't seen any similar topics, I thought I'd create one about the Memory Expansion Pak. Some of this information was obtained from MoonLight's ImageView application, although I'm not sure he is the original author. If you are the original author, post here to acknowledge this.
<br/>
<br/>
The Pak contains 8 MiB of usable RAM.
<br/>
There is a header at 0x080000B0 consisting of:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">FF FF 00 00 00 24 24 24 FF FF FF FF FF FF FF 7F</td> </tr></table><span class="postbody">
<br/>
To use the memory, you have to unlock it. The unlock register is at 0x08240000. Write 0x0001 there to unlock the RAM, 0x0000 to lock it. 
<br/>
The RAM starts at 0x09000000 and ends at 0x09800000, and is 8 MiB in size.
<br/>
The memory from 0x08000000 to 0x09000000 is not writable. It is all 0xFFFF except for the header and the unlock register.
<br/>
You need to write at least 16 bits at a time (bytes will be mirrored across a 16 bit address). 
<br/>
To access the cart from the ARM9, you'll need to give the ARM9 access to Slot-2.<br/>_________________<br/><a class="postlink" href="http://chishm.drunkencoders.com" target="_blank">http://chishm.drunkencoders.com</a>
<br/>
<a class="postlink" href="http://dldi.drunkencoders.com" target="_blank">http://dldi.drunkencoders.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#116625 - simonjhall - Sat Jan 27, 2007 2:36 pm</h4>
    <div class="postbody"><span class="postbody">Wow, that sounds pretty easy! Well done!
<br/>
<br/>
I'm kinda disappointed that it's slot-2 though - I'd hoped that I'd be slot-1, allowing people with RAM-less cards (like the gbamp) get access to extra memory. Plus I'd imagine there would be better performance from slot 1...
<br/>
<br/>
Now whatever happened to having that library which'd wrap all up all these 'extra RAM' solutions?<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#116668 - chishm - Sun Jan 28, 2007 2:03 am</h4>
    <div class="postbody"><span class="postbody">Well as I said, some of the info came from <a class="postlink" href="http://mdxonline.dyndns.org/archives/2007/01/image_viewer_ver06.shtml" target="_blank">MoonLight's Image Viewer application</a>, which contains a basic RAM expansion library.
<br/>
<br/>
Slot-1 is impossible to use for directly addressed memory. The slot-2 expansion is good for use with slot-1 media adapters. Being an official Nintendo product, it is a lot easier to buy too.<br/>_________________<br/><a class="postlink" href="http://chishm.drunkencoders.com" target="_blank">http://chishm.drunkencoders.com</a>
<br/>
<a class="postlink" href="http://dldi.drunkencoders.com" target="_blank">http://dldi.drunkencoders.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#116669 - tepples - Sun Jan 28, 2007 2:26 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>chishm wrote:</b></span></td> </tr> <tr> <td class="quote">The slot-2 expansion is good for use with slot-1 media adapters. Being an official Nintendo product, it is a lot easier to buy too.</td> </tr></table><span class="postbody">
<br/>
Only in Japan, Europe, and Australia. In the United States and Canada, both SuperCard and Nintendo DS <b style="color:#FFA34F">Browser</b> are import products.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#116673 - Firon - Sun Jan 28, 2007 2:43 am</h4>
    <div class="postbody"><span class="postbody">It's pretty easy to find online, though.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#116687 - chishm - Sun Jan 28, 2007 11:22 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tepples wrote:</b></span></td> </tr> <tr> <td class="quote">In the United States and Canada, both SuperCard and Nintendo DS <b style="color:#FFA34F">Browser</b> are import products.</td> </tr></table><span class="postbody">
<br/>
That's because North America is such a minor market that products are only released there as an afterthought. :p<br/>_________________<br/><a class="postlink" href="http://chishm.drunkencoders.com" target="_blank">http://chishm.drunkencoders.com</a>
<br/>
<a class="postlink" href="http://dldi.drunkencoders.com" target="_blank">http://dldi.drunkencoders.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#116689 - Lick - Sun Jan 28, 2007 11:57 am</h4>
    <div class="postbody"><span class="postbody">Oh don't be silly, think about all the PS3's sold in Europe!
<br/>
<br/>
<br/>
None.<br/>_________________<br/><a class="postlink" href="http://licklick.wordpress.com" target="_blank">http://licklick.wordpress.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#116877 - silent_code - Tue Jan 30, 2007 4:54 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Lick wrote:</b></span></td> </tr> <tr> <td class="quote">Oh don't be silly, think about all the PS3's sold in Europe! None.</td> </tr></table><span class="postbody">
<br/>
<br/>
because the ps3 wasn't released here, yet. ;P launch is on 27-3-2007 in eu and au.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#116913 - Lynx - Tue Jan 30, 2007 11:16 pm</h4>
    <div class="postbody"><span class="postbody">That's his point.. talk about a minor market.. :)<br/>_________________<br/><a class="postlink" href="http://www.ndshb.com" target="_blank">NDS Homebrew Roms &amp; Reviews</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#116988 - Lazy1 - Wed Jan 31, 2007 4:03 pm</h4>
    <div class="postbody"><span class="postbody">Thanks for the information, now those who have this cart can use it to get 4MB of ram when using Mini vMac :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#116993 - 0xtob - Wed Jan 31, 2007 5:34 pm</h4>
    <div class="postbody"><span class="postbody">Lazy1:
<br/>
How have you eliminated 8 bit writes? Did you manually wrap each 8bit write to a read 16bit, modify, write 16bit operation?<br/>_________________<br/><a class="postlink" href="http://blog.dev-scene.com/0xtob" target="_blank">http://blog.dev-scene.com/0xtob</a> | <a class="postlink" href="http://nitrotracker.tobw.net" target="_blank">http://nitrotracker.tobw.net</a> | <a class="postlink" href="http://dsmi.tobw.net" target="_blank">http://dsmi.tobw.net</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#116995 - Lazy1 - Wed Jan 31, 2007 5:47 pm</h4>
    <div class="postbody"><span class="postbody">Well, the Mini vMac sources for the most part wrapped all the memory reads/writes except for a few places.
<br/>
To find the remaining areas I modified desmume to log 8bit writes to the gba slot and exit.
<br/>
<br/>
I replaced the 8bit write wrapper with code provided by sgstair to do the read/modify/write stuff, then went around with addr2line and the desmume output fixing the areas where 8bit writes still existed.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#117096 - Dood77 - Thu Feb 01, 2007 7:02 am</h4>
    <div class="postbody"><span class="postbody">Does anyone know how fast the access to this memory is in comparison to the supercard/m3 ram?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#117661 - OOPMan - Tue Feb 06, 2007 1:12 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>simonjhall wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
Now whatever happened to having that library which'd wrap all up all these 'extra RAM' solutions?</td> </tr></table><span class="postbody">
<br/>
<br/>
Hehehe, we discussed it a while back. Unfortunately, no one actually got around to doing said wrapping up :-)
<br/>
<br/>
Somewhere in the world there might be a saying along the lines of:
<br/>
<br/>
"Man who start thread should implement solution"
<br/>
<br/>
Happily, I don't live in that part of the world, and hence I happily start threads on topics such as RAM libs, OSes and more without intending to do the implementing myself ;-)<br/>_________________<br/>"My boot, your face..." - Attributed to OOPMan, Emperor of Eroticon VI
<br/>
<br/>
You can find my NDS homebrew projects <a class="postlink" href="http://blog.dev-scene.com/oopman/" target="_blank">here...</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#117711 - HyperHacker - Tue Feb 06, 2007 9:16 pm</h4>
    <div class="postbody"><span class="postbody">I think the problem was nobody was quite sure how extended memory should be handled, since different programs need different things. Some need one big 36MB block while others can live with two, and some would need to be able to malloc() chunks of the extended memory while others (emulators, for example) would be better off with direct access.<br/>_________________<br/>I'm a PSP hacker now, but I still &lt;3 DS.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#117713 - Lazy1 - Tue Feb 06, 2007 9:28 pm</h4>
    <div class="postbody"><span class="postbody">The cart detection and lock/unlock functions I use in Mini vMac DS could be used as the base of a library I guess.
<br/>
It would require some work though since the M3 codes don't seem to work on all carts and I don't have the hardware to debug/fix it and my email to the company hasn't been replied to yet.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#ifdef UseGBARam
<br/>
   #define MakeLong( a, b, c, d ) ( ( d &lt;&lt; 24 ) + ( c &lt;&lt; 16 ) + ( b &lt;&lt; 8 ) + a )
<br/>
<br/>
   extern void setCache( unsigned int Flags );
<br/>
<br/>
   typedef struct CartAPI_S {
<br/>
      void ( *SetCart_RAM ) ( void );
<br/>
      void ( *SetCart_Disk ) ( void );
<br/>
<br/>
      si5b ( *GetCart_Base ) ( void );
<br/>
      si5b ( *GetCart_Size ) ( void );
<br/>
   } CartAPI_T;
<br/>
<br/>
   /**************************************************************************************/
<br/>
   #define SC_UNLOCK *( ( vu16* ) 0x09FFFFFE )
<br/>
<br/>
   LOCALPROC Supercard_Set_RAM( void ) {
<br/>
      SC_UNLOCK = 0xA55A;
<br/>
      SC_UNLOCK = 0xA55A;
<br/>
      SC_UNLOCK = 0x0005;
<br/>
      SC_UNLOCK = 0x0005;
<br/>
<br/>
      DC_FlushAll( );
<br/>
      setCache( 0x4A );
<br/>
   }
<br/>
<br/>
   LOCALPROC Supercard_Set_Disk( void ) {
<br/>
      SC_UNLOCK = 0xA55A;
<br/>
      SC_UNLOCK = 0xA55A;
<br/>
      SC_UNLOCK = 0x0003;
<br/>
      SC_UNLOCK = 0x0003;
<br/>
<br/>
      DC_FlushAll( );
<br/>
      setCache( 0x42 );
<br/>
   }
<br/>
<br/>
   LOCALFUNC si5b Supercard_Base( void ) {
<br/>
      return ( si5b ) 0x08000000;
<br/>
   }
<br/>
<br/>
   LOCALFUNC si5b Supercard_Size( void ) {
<br/>
      return ( si5b ) ( 32 * 1024 * 1024 );
<br/>
   }
<br/>
   /**************************************************************************************/
<br/>
   #define OPERA_UNLOCK *( ( vu16* ) 0x08240000 )
<br/>
<br/>
   LOCALPROC Opera_Set_RAM( void ) {
<br/>
      OPERA_UNLOCK = 0x0001;
<br/>
<br/>
      DC_FlushAll( );
<br/>
      setCache( 0x4A );
<br/>
   }
<br/>
<br/>
   LOCALPROC Opera_Set_Disk( void ) {
<br/>
      OPERA_UNLOCK = 0x0000;
<br/>
<br/>
      DC_FlushAll( );
<br/>
      setCache( 0x42 );
<br/>
   }
<br/>
<br/>
   LOCALFUNC si5b Opera_Base( void ) {
<br/>
      return ( si5b ) 0x09000000;
<br/>
   }
<br/>
<br/>
   LOCALFUNC si5b Opera_Size( void ) {
<br/>
      return ( si5b ) ( 8 * 1024 * 1024 );
<br/>
   }
<br/>
<br/>
   LOCALFUNC blnr Opera_Detect( void ) {
<br/>
      Opera_Set_RAM( );
<br/>
      *( ( vu16* ) 0x09000000 ) = 0xF00D;
<br/>
<br/>
      if ( *( ( vu16* ) 0x09000000 ) == 0xF00D ) {
<br/>
         Opera_Set_Disk( );
<br/>
         return trueblnr;
<br/>
      }
<br/>
<br/>
      return falseblnr;
<br/>
   }
<br/>
   /**************************************************************************************/
<br/>
   #define M3_MODE_ROM 0x00400004
<br/>
   #define M3_MODE_MEDIA 0x00400003
<br/>
   #define M3_MODE_RAM_R 0x00400002
<br/>
   #define M3_MODE_RAM_RW 0x00400006 // read-write access 
<br/>
<br/>
   static u16 M3_readHalfword( u32 addr ) {
<br/>
         return *( ( vu16* ) addr );
<br/>
   }
<br/>
<br/>
   void M3_changeMode( u32 mode ) {
<br/>
      M3_readHalfword( 0x08e00002 );
<br/>
      M3_readHalfword( 0x0800000e );
<br/>
      M3_readHalfword( 0x08801ffc );
<br/>
      M3_readHalfword( 0x0800104a );
<br/>
      M3_readHalfword( 0x08800612 );
<br/>
      M3_readHalfword( 0x08000000 );
<br/>
      M3_readHalfword( 0x08801b66 );
<br/>
      M3_readHalfword( 0x08000000 + ( mode &lt;&lt; 1 ) );
<br/>
      M3_readHalfword( 0x0800080e );
<br/>
      M3_readHalfword( 0x08000000 );
<br/>
<br/>
      if ( ( mode &amp; 0x0f ) == 4 ) {   // unlock ROM addr &gt;= 0x200
<br/>
         M3_readHalfword( 0x080001e4 );
<br/>
         M3_readHalfword( 0x080001e4 );
<br/>
         M3_readHalfword( 0x08000188 );
<br/>
         M3_readHalfword( 0x08000188 );
<br/>
      } else {
<br/>
         M3_readHalfword( 0x09000000 );
<br/>
      }
<br/>
   }
<br/>
<br/>
   LOCALPROC M3_Set_RAM( void ) {
<br/>
      M3_changeMode( M3_MODE_RAM_RW );
<br/>
<br/>
      DC_FlushAll( );
<br/>
      setCache( 0x4A );
<br/>
   }
<br/>
<br/>
   LOCALPROC M3_Set_Disk( void ) {
<br/>
      M3_changeMode( M3_MODE_MEDIA );
<br/>
<br/>
      DC_FlushAll( );
<br/>
      setCache( 0x42 );
<br/>
   }
<br/>
<br/>
   LOCALFUNC si5b M3_Base( void ) {
<br/>
      return ( si5b ) 0x08000000;
<br/>
   }
<br/>
<br/>
   LOCALFUNC si5b M3_Size( void ) {
<br/>
      return ( 32 * 1024 * 1024 );
<br/>
   }
<br/>
   /**************************************************************************************/
<br/>
<br/>
   CartAPI_T GBACart;
<br/>
<br/>
   LOCALFUNC blnr InitGBACart( void ) {
<br/>
      struct stat st;
<br/>
<br/>
      if ( stat( "/.", &amp;st ) == 0 ) {
<br/>
         if ( st.st_dev == MakeLong( 'S', 'C', 'C', 'F' ) || st.st_dev == MakeLong( 'S', 'C', 'S', 'D' ) ) {
<br/>
            GBACart.SetCart_RAM = Supercard_Set_RAM;
<br/>
            GBACart.SetCart_Disk = Supercard_Set_Disk;
<br/>
            GBACart.GetCart_Base = Supercard_Base;
<br/>
            GBACart.GetCart_Size = Supercard_Size;
<br/>
<br/>
            iprintf( "Found Supercard CF or Supercard SD\n" );
<br/>
            return trueblnr;
<br/>
         }
<br/>
<br/>
         if ( st.st_dev == MakeLong( 'M', '3', 'C', 'F' ) || st.st_dev == MakeLong( 'M', '3', 'S', 'D' ) ) {
<br/>
            GBACart.SetCart_RAM = M3_Set_RAM;
<br/>
            GBACart.SetCart_Disk = M3_Set_Disk;
<br/>
            GBACart.GetCart_Base = M3_Base;
<br/>
            GBACart.GetCart_Size = M3_Size;
<br/>
<br/>
            iprintf( "Found M3 CF or M3 SD\n" );
<br/>
            return trueblnr;
<br/>
         }
<br/>
<br/>
         if ( Opera_Detect( ) == trueblnr ) {
<br/>
            GBACart.SetCart_RAM = Opera_Set_RAM;
<br/>
            GBACart.SetCart_Disk = Opera_Set_Disk;
<br/>
            GBACart.GetCart_Base = Opera_Base;
<br/>
            GBACart.GetCart_Size = Opera_Size;
<br/>
<br/>
            iprintf( "Found Opera memory expansion\n" );
<br/>
            return trueblnr;
<br/>
         }
<br/>
      }
<br/>
<br/>
      return falseblnr;
<br/>
   }
<br/>
#endif
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I'm not sure about DC_FlushAll() but I'm pretty sure you won't be needing setCache().</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#117715 - HyperHacker - Tue Feb 06, 2007 9:40 pm</h4>
    <div class="postbody"><span class="postbody">You test for the Opera expansion by writing to it and reading it back? Why not just look for the header?<br/>_________________<br/>I'm a PSP hacker now, but I still &lt;3 DS.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#117718 - Lazy1 - Tue Feb 06, 2007 9:57 pm</h4>
    <div class="postbody"><span class="postbody">I guess I could have, but I didn't think of that at the time.
<br/>
Thanks for the suggestion though, that will probably be more reliable.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#117734 - Lick - Wed Feb 07, 2007 12:34 am</h4>
    <div class="postbody"><span class="postbody">That's a nice piece of pasting you have there! Thanks Lazy1!
<br/>
<br/>
<span style="font-weight: bold">*bookmarks*</span><br/>_________________<br/><a class="postlink" href="http://licklick.wordpress.com" target="_blank">http://licklick.wordpress.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#122178 - Genoil - Sat Mar 17, 2007 5:53 pm</h4>
    <div class="postbody"><span class="postbody">Thanks, I've been using this code to err.. see if it actually works! And it does, but I've changed the detection mechanism (simplified the code aswell):
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
int Mempak_Detect( void ) {
<br/>
  MEMPAK_UNLOCK = 0x0001;
<br/>
<br/>
  int i = 0;
<br/>
  int * header = (int *)0x080000B0;
<br/>
  int check[]  = {0x0000FFFF, 0x24242400, 0xFFFFFFFF, 0x7FFFFFFF};
<br/>
 
<br/>
  while(*(header++) == *(check+i) &amp;&amp; i &lt; 4) i++;   
<br/>
<br/>
  return i==4;
<br/>
} 
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Now that this worked, I wanted to test some actual writing and reading, so I used the code in your (lazy1) detection function to do a write, read it back and test if it is still the same. But somehow it doesn't seem to matter what address I use for writing/reading. If I use 0x08000000 instead of 0x09000000, it will still pass. Or 0x9900000 for that matter. 
<br/>
<br/>
Now I have to admit that I've never actually been doing any DS development before,  and I read C better than I write it, but what am I doing wrong here? How would I actually be able to find the writable parts of the available address space like chishm did?
<br/>
<br/>
[edit]
<br/>
<br/>
Well I'm still not 100% sure about what went wrong here, but I created something with visual feedback and in there it appears that indeed only the area between 0x09000000 and 0x09800000 is writable.
<br/>
<br/>
[edit]
<br/>
<br/>
Well now I'm 100% sure I put some code in the wrong place because I tried again and now it works as expected...</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
