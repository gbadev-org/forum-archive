<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Calling for help to fix SDL_Mixer - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > Calling for help to fix SDL_Mixer</h2>
<div id="posts">
<div class="post">
    <h4>#173342 - protomank - Fri Apr 02, 2010 12:04 pm</h4>
    <div class="postbody"><span class="postbody">Is there anyone with free time and will to help me to fix the SDL_Mixer?
<br/>
<br/>
Currently, the problem is in wave reading, in this part of the code:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#define SDL_RWread(ctx, ptr, size, n)   (ctx)-&gt;read(ctx, ptr, size, n)
<br/>
<br/>
static int ReadChunk(SDL_RWops *src, Chunk *chunk)
<br/>
{
<br/>
   chunk-&gt;magic   = SDL_ReadLE32(src);
<br/>
   chunk-&gt;length   = SDL_ReadLE32(src);
<br/>
   chunk-&gt;data = (Uint8 *)malloc(chunk-&gt;length);
<br/>
   if ( chunk-&gt;data == NULL ) {
<br/>
      SDL_Error(SDL_ENOMEM);
<br/>
      return(-1);
<br/>
   }
<br/>
   if ( SDL_RWread(src, chunk-&gt;data, chunk-&gt;length, 1) != 1 ) {
<br/>
      SDL_Error(SDL_EFREAD);
<br/>
      free(chunk-&gt;data);
<br/>
      return(-1);
<br/>
   }
<br/>
   return(chunk-&gt;length);
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
It is always returning SDL_EFREAD. Here is the big function that call ReadChunk:
<br/>
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">SDL_AudioSpec * SDL_LoadWAV_RW (SDL_RWops *src, int freesrc,
<br/>
      SDL_AudioSpec *spec, Uint8 **audio_buf, Uint32 *audio_len)
<br/>
{
<br/>
   int was_error;
<br/>
   Chunk chunk;
<br/>
   int lenread;
<br/>
   int MS_ADPCM_encoded, IMA_ADPCM_encoded;
<br/>
   int samplesize;
<br/>
<br/>
   /* WAV magic header */
<br/>
   Uint32 RIFFchunk;
<br/>
   Uint32 wavelen;
<br/>
   Uint32 WAVEmagic;
<br/>
<br/>
   /* FMT chunk */
<br/>
   WaveFMT *format = NULL;
<br/>
<br/>
   /* Make sure we are passed a valid data source */
<br/>
   was_error = 0;
<br/>
   if ( src == NULL ) {
<br/>
      was_error = 1;
<br/>
      goto done;
<br/>
   }
<br/>
      
<br/>
   /* Check the magic header */
<br/>
   RIFFchunk   = SDL_ReadLE32(src);
<br/>
   wavelen      = SDL_ReadLE32(src);
<br/>
   if ( wavelen == WAVE ) { /* The RIFFchunk has already been read */
<br/>
      WAVEmagic = wavelen;
<br/>
      wavelen   = RIFFchunk;
<br/>
      RIFFchunk = RIFF;
<br/>
   } else {
<br/>
      WAVEmagic = SDL_ReadLE32(src);
<br/>
   }
<br/>
   if ( (RIFFchunk != RIFF) || (WAVEmagic != WAVE) ) {
<br/>
      SDL_SetError("Unrecognized file type (not WAVE)");
<br/>
      was_error = 1;
<br/>
      goto done;
<br/>
   }
<br/>
<br/>
   /* Read the audio data format chunk */
<br/>
   chunk.data = NULL;
<br/>
   do {
<br/>
      if ( chunk.data != NULL ) {
<br/>
         free(chunk.data);
<br/>
      }
<br/>
      lenread = ReadChunk(src, &amp;chunk);
<br/>
      if ( lenread &lt; 0 ) {
<br/>
         was_error = 1;
<br/>
         goto done;
<br/>
      }
<br/>
   } while ( (chunk.magic == FACT) || (chunk.magic == LIST) );
<br/>
<br/>
   /* Decode the audio data format */
<br/>
   format = (WaveFMT *)chunk.data;
<br/>
   if ( chunk.magic != FMT ) {
<br/>
      SDL_SetError("Complex WAVE files not supported");
<br/>
      was_error = 1;
<br/>
      goto done;
<br/>
   }
<br/>
   MS_ADPCM_encoded = IMA_ADPCM_encoded = 0;
<br/>
   switch (SDL_SwapLE16(format-&gt;encoding)) {
<br/>
      case PCM_CODE:
<br/>
         /* We can understand this */
<br/>
         break;
<br/>
      case MS_ADPCM_CODE:
<br/>
         /* Try to understand this */
<br/>
         if ( InitMS_ADPCM(format) &lt; 0 ) {
<br/>
            was_error = 1;
<br/>
            goto done;
<br/>
         }
<br/>
         MS_ADPCM_encoded = 1;
<br/>
         break;
<br/>
      case IMA_ADPCM_CODE:
<br/>
         /* Try to understand this */
<br/>
         if ( InitIMA_ADPCM(format) &lt; 0 ) {
<br/>
            was_error = 1;
<br/>
            goto done;
<br/>
         }
<br/>
         IMA_ADPCM_encoded = 1;
<br/>
         break;
<br/>
      default:
<br/>
         SDL_SetError("Unknown WAVE data format: 0x%.4x",
<br/>
               SDL_SwapLE16(format-&gt;encoding));
<br/>
         was_error = 1;
<br/>
         goto done;
<br/>
   }
<br/>
   memset(spec, 0, (sizeof *spec));
<br/>
   spec-&gt;freq = SDL_SwapLE32(format-&gt;frequency);
<br/>
   switch (SDL_SwapLE16(format-&gt;bitspersample)) {
<br/>
      case 4:
<br/>
         if ( MS_ADPCM_encoded || IMA_ADPCM_encoded ) {
<br/>
            spec-&gt;format = AUDIO_S16;
<br/>
         } else {
<br/>
            was_error = 1;
<br/>
         }
<br/>
         break;
<br/>
      case 8:
<br/>
         spec-&gt;format = AUDIO_U8;
<br/>
         break;
<br/>
      case 16:
<br/>
         spec-&gt;format = AUDIO_S16;
<br/>
         break;
<br/>
      default:
<br/>
         was_error = 1;
<br/>
         break;
<br/>
   }
<br/>
   if ( was_error ) {
<br/>
      SDL_SetError("Unknown %d-bit PCM data format",
<br/>
         SDL_SwapLE16(format-&gt;bitspersample));
<br/>
      goto done;
<br/>
   }
<br/>
   spec-&gt;channels = (Uint8)SDL_SwapLE16(format-&gt;channels);
<br/>
   spec-&gt;samples = 4096;      /* Good default buffer size */
<br/>
<br/>
   /* Read the audio data chunk */
<br/>
   *audio_buf = NULL;
<br/>
   do {
<br/>
      if ( *audio_buf != NULL ) {
<br/>
         free(*audio_buf);
<br/>
      }
<br/>
      lenread = ReadChunk(src, &amp;chunk);
<br/>
      if ( lenread &lt; 0 ) {
<br/>
         was_error = 1;
<br/>
         goto done;
<br/>
      }
<br/>
      *audio_len = lenread;
<br/>
      *audio_buf = chunk.data;
<br/>
   } while ( chunk.magic != DATA );
<br/>
<br/>
   if ( MS_ADPCM_encoded ) {
<br/>
      if ( MS_ADPCM_decode(audio_buf, audio_len) &lt; 0 ) {
<br/>
         was_error = 1;
<br/>
         goto done;
<br/>
      }
<br/>
   }
<br/>
   if ( IMA_ADPCM_encoded ) {
<br/>
      if ( IMA_ADPCM_decode(audio_buf, audio_len) &lt; 0 ) {
<br/>
         was_error = 1;
<br/>
         goto done;
<br/>
      }
<br/>
   }
<br/>
<br/>
   /* Don't return a buffer that isn't a multiple of samplesize */
<br/>
   samplesize = ((spec-&gt;format &amp; 0xFF)/8)*spec-&gt;channels;
<br/>
   *audio_len &amp;= ~(samplesize-1);
<br/>
<br/>
done:
<br/>
   if ( format != NULL ) {
<br/>
      free(format);
<br/>
   }
<br/>
   if ( freesrc &amp;&amp; src ) {
<br/>
      SDL_RWclose(src);
<br/>
   }
<br/>
   if ( was_error ) {
<br/>
      spec = NULL;
<br/>
   }
<br/>
   return(spec);
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
The struct that contains the wave (I believe the problem is here):
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
typedef struct SDL_RWops {
<br/>
   /* Seek to 'offset' relative to whence, one of stdio's whence values:
<br/>
      SEEK_SET, SEEK_CUR, SEEK_END
<br/>
      Returns the final offset in the data source.
<br/>
    */
<br/>
   int (SDLCALL *seek)(struct SDL_RWops *context, int offset, int whence);
<br/>
<br/>
   /* Read up to 'num' objects each of size 'objsize' from the data
<br/>
      source to the area pointed at by 'ptr'.
<br/>
      Returns the number of objects read, or -1 if the read failed.
<br/>
    */
<br/>
   int (SDLCALL *read)(struct SDL_RWops *context, void *ptr, int size, int maxnum);
<br/>
<br/>
   /* Write exactly 'num' objects each of size 'objsize' from the area
<br/>
      pointed at by 'ptr' to data source.
<br/>
      Returns 'num', or -1 if the write failed.
<br/>
    */
<br/>
   int (SDLCALL *write)(struct SDL_RWops *context, const void *ptr, int size, int num);
<br/>
<br/>
   /* Close and free an allocated SDL_FSops structure */
<br/>
   int (SDLCALL *close)(struct SDL_RWops *context);
<br/>
<br/>
   Uint32 type;
<br/>
   union {
<br/>
       struct {
<br/>
      int autoclose;
<br/>
       FILE *fp;
<br/>
       } stdio;
<br/>
       struct {
<br/>
      Uint8 *base;
<br/>
       Uint8 *here;
<br/>
      Uint8 *stop;
<br/>
       } mem;
<br/>
       struct {
<br/>
      void *data1;
<br/>
       } unknown;
<br/>
   } hidden;
<br/>
<br/>
} SDL_RWops;
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
<br/>
It does not seem too complex to fix, but I lack any knowledge about wave format :-(<br/>_________________<br/>Iuri Fiedoruk
<br/>
<a href="http://rockbot.upperland.net" target="_blank">http://rockbot.upperland.net</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#173344 - wintermute - Fri Apr 02, 2010 12:12 pm</h4>
    <div class="postbody"><span class="postbody">You'll be much better off getting rid of SDL, it's really not suited to the DS at all.<br/>_________________<br/><a class="postlink" href="http://www.devkitpro.org/" target="_blank">devkitPro - professional toolchains at amateur prices</a>
<br/>
<a class="postlink" href="http://wiki.devkitpro.org/index.php/IRC" target="_blank">devkitPro IRC support</a>
<br/>
<a class="postlink" href="http://davejmurphy.com/" target="_blank">Personal Blog</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#173346 - protomank - Fri Apr 02, 2010 12:39 pm</h4>
    <div class="postbody"><span class="postbody">No, thanks!!!!
<br/>
<br/>
Reason is that SDL is GREAT, VERY GREAT for multi-platform. Currently I have ports for Windows, Linux, Mac, playstation 2 and Nintendo DS. I know that with little time I can also port it to Wii and XBox. Also, it currently runs very, very well on the DS, except for the sound part.
<br/>
<br/>
I can't use maxmod, because there is a conflict, mas both it and SDL seems to be using the same IRQs, so I my game get stucks when updating a stream in maxmod.<br/>_________________<br/>Iuri Fiedoruk
<br/>
<a href="http://rockbot.upperland.net" target="_blank">http://rockbot.upperland.net</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#173358 - Dwedit - Fri Apr 02, 2010 5:47 pm</h4>
    <div class="postbody"><span class="postbody">Maybe someone should make a LibNDS-like API that runs on top of SDL when compiled on anything other than the NDS?  Nothing like debugging your NDS code with Visual C++.  Like an emulator without emulating the CPU (except maybe for running ARM ASM code included in the program).<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#173360 - elhobbs - Fri Apr 02, 2010 6:09 pm</h4>
    <div class="postbody"><span class="postbody">why do you think the problem lies with SDL_RWops?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#173365 - protomank - Fri Apr 02, 2010 7:59 pm</h4>
    <div class="postbody"><span class="postbody">Because this is the part that files:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">if ( SDL_RWread(src, chunk-&gt;data, chunk-&gt;length, 1) != 1 ) { 
<br/>
      SDL_Error(SDL_EFREAD); </td> </tr></table><span class="postbody">
<br/>
<br/>
I've used multiple wayrs of opening the file, like loading it to memory first, and in all the cases I got SDL_EFREAD in the end.
<br/>
Sure, this is just what I got by backtracing the problem, Iit is a bit hard, once when SDL is initializwed, I can't see the printfs anymore, and for some reason, redirecting stdout to a file always produce a empty one. If I had a way to bebug, or communicate with the DS like I do with PS2 (it uses a program called ps2client), probally it would be easier.<br/>_________________<br/>Iuri Fiedoruk
<br/>
<a href="http://rockbot.upperland.net" target="_blank">http://rockbot.upperland.net</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#173374 - elhobbs - Sat Apr 03, 2010 4:10 am</h4>
    <div class="postbody"><span class="postbody">SDL_RWread is just a wrapper for fread. fread returns the number of bytes read. In this case it is trying to read 1 byte from the file. This code is verifying that the read is completing successfully it is not verifying what was read. Are you sure that libfat has been I initialized properly by calling fatInitDefault? Does your device auto dldi patch or do you need to do it manually?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#173375 - protomank - Sat Apr 03, 2010 4:59 am</h4>
    <div class="postbody"><span class="postbody">Libfat is not the problem. I did placed debug to check if fopen is working (ok), if it was loaded into memory (ok) if load_wav got it (ok), but when it tryies to play, it complains that the stream is bad.
<br/>
<br/>
SDL_RWread actually sets the chunk-&gt;length of the sdl struct to the size of the data in stream, and that is the part that is not working.<br/>_________________<br/>Iuri Fiedoruk
<br/>
<a href="http://rockbot.upperland.net" target="_blank">http://rockbot.upperland.net</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#173767 - protomank - Thu Apr 29, 2010 8:48 pm</h4>
    <div class="postbody"><span class="postbody">So, actually no one wants to fix the SDL for Nintendo DS? Or at least, help me to do so with your expertise?<br/>_________________<br/>Iuri Fiedoruk
<br/>
<a href="http://rockbot.upperland.net" target="_blank">http://rockbot.upperland.net</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#173769 - FluBBa - Thu Apr 29, 2010 9:31 pm</h4>
    <div class="postbody"><span class="postbody">So, it expects chunk-&gt;length to not be 1 and still get 1 in return?
<br/>
I haven't read up enough on how filereading works for that...<br/>_________________<br/>I probably suck, my not is a programmer.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
