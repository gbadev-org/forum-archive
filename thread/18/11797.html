<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>VCOUNT interrupt. - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > VCOUNT interrupt.</h2>
<div id="posts">
<div class="post">
    <h4>#110183 - Dark Knight ez - Sun Nov 26, 2006 3:11 pm</h4>
    <div class="postbody"><span class="postbody">Hey guys.
<br/>
<br/>
About time I posted another question.
<br/>
This one concerns the use of VCOUNT interrupt.
<br/>
As far as I understand, you can trigger an interrupt on a certain hblank (vertical scanline) with this. I checked gbatek, bugged LiraNuna about it, but I could not get it to work.
<br/>
<br/>
I created a small tech demo of me trying to get it to work without all the other code of my project possibly interfering. Still no luck though. Could someone point out what's wrong in my little techdemo?
<br/>
(All commented out code in there was also tested enabled, to no avail.)
<br/>
As you might be able to tell, the goal of this techdemo is to show black on the upper half of the screen, and another colour on the bottom half.
<br/>
<br/>
Thanks in advance.
<br/>
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">/* YTrigger Tech-Demo *
<br/>
 *********************/
<br/>
<br/>
#include &lt;nds.h&gt;
<br/>
#include &lt;stdio.h&gt;
<br/>
#include &lt;string&gt;
<br/>
#include &lt;sstream&gt;
<br/>
#include &lt;malloc.h&gt;
<br/>
#include &lt;nds/memory.h&gt;
<br/>
#include &lt;nds/ARM9/console.h&gt;
<br/>
<br/>
#include &lt;nds/registers_alt.h&gt;
<br/>
<br/>
<br/>
static inline void setYTrigger(int YValue) {
<br/>
    REG_DISPSTAT = (REG_DISPSTAT &amp; 0xFF ) | (YValue &lt;&lt; 8);
<br/>
    //REG_DISPSTAT = (REG_DISPSTAT &amp; 0xFF ) | (YValue &lt;&lt; 8) | (( YValue &amp; 0x100 ) &gt;&gt; 2);
<br/>
}
<br/>
<br/>
<br/>
void handleVBlankInterrupt() {
<br/>
    BG_PALETTE[0] = 0;
<br/>
}
<br/>
<br/>
void handleYTriggerInterrupt() {
<br/>
    BG_PALETTE[0] = 0x1F;
<br/>
}
<br/>
<br/>
<br/>
<br/>
int main() {
<br/>
    powerON(POWER_ALL_2D);
<br/>
    
<br/>
    //vramSetBankA(VRAM_A_MAIN_BG);
<br/>
    DISPLAY_CR = MODE_0_2D; // | DISPLAY_BG0_ACTIVE;
<br/>
    //BG0_CR = BG_PRIORITY_0 | BG_TILE_BASE(0) | BG_256_COLOR | BG_MAP_BASE(28) | BG_32x32;
<br/>
    
<br/>
    irqInit();
<br/>
<br/>
    irqSet(IRQ_VBLANK, handleVBlankInterrupt);
<br/>
    irqEnable(IRQ_VBLANK);
<br/>
    
<br/>
    setYTrigger(96);
<br/>
    irqSet(IRQ_VCOUNT, handleYTriggerInterrupt);
<br/>
    irqEnable(IRQ_VCOUNT);
<br/>
    
<br/>
    
<br/>
    while (1)    {
<br/>
        swiWaitForVBlank();
<br/>
    }
<br/>
    return 0;
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
<br/>
<span style="font-size: 9px; line-height: normal">edited to represent the current version (which still does not work).</span><br/>_________________<br/><span style="font-size: 9px; line-height: normal"><a class="postlink" href="http://amplituds.drunkencoders.com" target="_blank">AmplituDS website</a></span></span><span class="gensmall"><br/><br/>Last edited by Dark Knight ez on Mon Nov 27, 2006 12:58 pm; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#110186 - ProblemBaby - Sun Nov 26, 2006 3:22 pm</h4>
    <div class="postbody"><span class="postbody">Hey
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
    irqSet(IRQ_VCOUNT, handleVBlankInterrupt); // IRQ_VBLANK
<br/>
    irqEnable(IRQ_VBLANK); 
<br/>
    
<br/>
    setYTrigger(96); 
<br/>
    irqSet(IRQ_VCOUNT, handleYTriggerInterrupt); 
<br/>
    irqEnable(IRQ_VCOUNT); 
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
First it seems like your first irqSet is wrong. Second Iam unsure if NDSLib set the stat-bits automatically for you as it does for hbl and vbl.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#110187 - Mighty Max - Sun Nov 26, 2006 3:23 pm</h4>
    <div class="postbody"><span class="postbody">You got to enable vcount irq in dispstat too. (Bit 5)<br/>_________________<br/><a class="postlink" href="http://mightymax.org/gbamp_multiboot.html" target="_blank">GBAMP Multiboot</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#110192 - Dark Knight ez - Sun Nov 26, 2006 4:13 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">First it seems like your first irqSet is wrong</td> </tr></table><span class="postbody">
<br/>
Yeah... fixed that one now. Didn't solve the problem though.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Second Iam unsure if NDSLib set the stat-bits automatically for you as it does for hbl and vbl.</td> </tr></table><span class="postbody">
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">You got to enable vcount irq in dispstat too. (Bit 5)</td> </tr></table><span class="postbody">
<br/>
I looked it up, and that is indeed done by irqEnable. (I also did it manually first to make sure that wasn't the problem.)
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">if (irq &amp; IRQ_VCOUNT)
<br/>
    REG_DISPSTAT |= DISP_YTRIGGER_IRQ;
<br/>
</td> </tr></table><span class="postbody">
<br/>
Where DISP_YTRIGGER_IRQ is BIT(5).<br/>_________________<br/><span style="font-size: 9px; line-height: normal"><a class="postlink" href="http://amplituds.drunkencoders.com" target="_blank">AmplituDS website</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#110194 - ProblemBaby - Sun Nov 26, 2006 5:10 pm</h4>
    <div class="postbody"><span class="postbody">iam not familiar with ndslib but musnt you initialize the irq-system somehow?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#110199 - Dark Knight ez - Sun Nov 26, 2006 6:09 pm</h4>
    <div class="postbody"><span class="postbody">Quite right. Yet another line I forgot to add to my tech demo.
<br/>
"irqInit();" line added now.
<br/>
<br/>
However, it still fails to work.<br/>_________________<br/><span style="font-size: 9px; line-height: normal"><a class="postlink" href="http://amplituds.drunkencoders.com" target="_blank">AmplituDS website</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#110344 - Dark Knight ez - Mon Nov 27, 2006 11:44 pm</h4>
    <div class="postbody"><span class="postbody">Surely someone got this interrupt to work. Anyone?<br/>_________________<br/><span style="font-size: 9px; line-height: normal"><a class="postlink" href="http://amplituds.drunkencoders.com" target="_blank">AmplituDS website</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#110353 - bsder - Tue Nov 28, 2006 12:59 am</h4>
    <div class="postbody"><span class="postbody">Isn't there a bit in DISPSTAT you have to set as well?
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
4000004h - DISPSTAT - General LCD Status (Read/Write)
<br/>
Display status and Interrupt control. The H-Blank conditions are generated once per scanline, including for the 'hidden' scanlines during V-Blank.
<br/>
<br/>
  Bit   Expl.
<br/>
  0     V-Blank flag   (Read only) (1=VBlank)
<br/>
  1     H-Blank flag   (Read only) (1=HBlank)
<br/>
  2     V-Counter flag (Read only) (1=Match)
<br/>
  3     V-Blank IRQ Enable         (1=Enable)
<br/>
  4     H-Blank IRQ Enable         (1=Enable)
<br/>
  5     V-Counter IRQ Enable       (1=Enable)
<br/>
  6-7   Not used
<br/>
  8-15  V-Count Setting            (0-227)
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I don't see where you set Bit 5.  Also, you might want to check bit 2 as it should trigger during the expected scanline even without an interrupt.
<br/>
<br/>
-a</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#110363 - gmiller - Tue Nov 28, 2006 1:55 am</h4>
    <div class="postbody"><span class="postbody">Maybe a dumb question but are you compiling this code in ARM mode?  On the GBA the interrupt handler needs to be ARM mode.  The interrupt handler dispatcher I ASSUME can do ARM/THUMB calls but I don't know.  I don't do and DS development yet so I could be completely off.
<br/>
<br/>
Also does the irqEnable mess with the vcount part of DISPSTAT?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#110405 - Dark Knight ez - Tue Nov 28, 2006 9:11 am</h4>
    <div class="postbody"><span class="postbody">Notice one of my previous replies.
<br/>
"irqEnable(IRQ_VCOUNT);" actually sets BIT(5) of REG_DISPSTAT.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote"> Also, you might want to check bit 2 as it should trigger during the expected scanline even without an interrupt. </td> </tr></table><span class="postbody">
<br/>
You want me to check with HBlank interrupts if that flag has been set at (a certain) scanline at all? Sure, but if that's not set, then something's very wrong with documentation or how I interpret it.
<br/>
<br/>
@gmiller:
<br/>
I'm using regular ARM code. I've been using VBlank and HBlank interrupts without a problem. Just this VCOUNT interrupt won't work with me.<br/>_________________<br/><span style="font-size: 9px; line-height: normal"><a class="postlink" href="http://amplituds.drunkencoders.com" target="_blank">AmplituDS website</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#110408 - Ted - Tue Nov 28, 2006 11:11 am</h4>
    <div class="postbody"><span class="postbody">I copied the code in the first post and compiled it, and as far as i can tell it works as intended.
<br/>
The bottom half turns red on my hardware, except that the first two pixels that should be red are still black. I assume that's because the hardware keeps drawing while we're changing the palette.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#110458 - Dark Knight ez - Tue Nov 28, 2006 7:30 pm</h4>
    <div class="postbody"><span class="postbody">Unfortunately, that code does not work with either my EZ-Flash 2 or my EZ-Flash 4.
<br/>
<br/>
The VBlank function is executed, I can verify that.
<br/>
The VCount function, however, is not.
<br/>
<br/>
Odd that you got it to work, Ted.
<br/>
Might I ask what version of devkitpro you are using?
<br/>
Could you upload the (.ds.gba) binary for me, so I can check if it has to do with my compiling setup or my DS setup?
<br/>
<br/>
edit:
<br/>
DevilSpawn compiled it for me and that version works on my DS.
<br/>
Must be due to my old (v18?) devkitpro. I'll upgrade to the latest, hoping it doesn't break any of my (old) projects. Thanks, Ted.<br/>_________________<br/><span style="font-size: 9px; line-height: normal"><a class="postlink" href="http://amplituds.drunkencoders.com" target="_blank">AmplituDS website</a></span></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
