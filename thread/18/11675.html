<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>DS crash causing me to go insane - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > DS crash causing me to go insane</h2>
<div id="posts">
<div class="post">
    <h4>#108642 - FireSlash - Fri Nov 10, 2006 8:53 pm</h4>
    <div class="postbody"><span class="postbody">So, heres what I know:
<br/>
testObject isn't null
<br/>
<span style="font-weight: bold">this</span> inside testObject isn't null.
<br/>
But <span style="font-weight: bold">a</span> in spriteController::attachActor is, for some reason, null.
<br/>
<br/>
.....*twitch*
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">// === spriteController.h
<br/>
// Sprite controller
<br/>
// manages the OAM
<br/>
// For great justice
<br/>
 
<br/>
#ifndef __class_spriteController
<br/>
#define __class_spriteController
<br/>
 
<br/>
#include "managedObject.h"
<br/>
#include "actor.h"
<br/>
#include &lt;nds.h&gt;
<br/>
 
<br/>
class spriteController: public managedObject
<br/>
{
<br/>
   public:
<br/>
      bool create(objectManager *instigator);
<br/>
      void tick(float deltatime);
<br/>
      bool destroy();
<br/>
      // spriteController specific functions
<br/>
      void moveSprite(int id, u16 x, u16 y);
<br/>
      void rotateSprite(int id, u16 angle);
<br/>
      int attachActor(actor *a);
<br/>
      void detachActor(actor *a);
<br/>
   protected:
<br/>
      SpriteEntry *spriteMain;
<br/>
      SpriteRotation *spriteRotationMain;
<br/>
      int nextID;
<br/>
};
<br/>
#endif
<br/>
 
<br/>
 
<br/>
// ===== spriteController.cpp
<br/>
 
<br/>
#include "spriteController.h"
<br/>
 
<br/>
int spriteController::attachActor(actor *a)
<br/>
{
<br/>
   //if (a == NULL)
<br/>
   //   return 0;
<br/>
   int id = nextID++; // HACK
<br/>
   Coordinate position;
<br/>
   position = a-&gt;getLocation(); // CRASHES HERE &lt;&lt;&lt;&lt;------ ;(
<br/>
 
<br/>
   spriteMain[0].attribute[0] =   ATTR0_COLOR_256 |
<br/>
                           ATTR0_ROTSCALE_DOUBLE |
<br/>
                           (int)position.y;
<br/>
 
<br/>
   spriteMain[0].attribute[1] =   ATTR1_ROTDATA(0) |
<br/>
                           ATTR1_SIZE_64 | 
<br/>
                           (int)position.x;
<br/>
 
<br/>
   spriteMain[0].attribute[2] = id;
<br/>
 
<br/>
   dmaCopy(a-&gt;getGfxLoader()-&gt;image()-&gt;palette, (u16*)SPRITE_PALETTE, sizeof(a-&gt;getGfxLoader()-&gt;image()-&gt;palette));
<br/>
   dmaCopy(a-&gt;getGfxLoader()-&gt;image()-&gt;data8, &amp;SPRITE_GFX[id * 16], (a-&gt;getGfxLoader()-&gt;image()-&gt;width * a-&gt;getGfxLoader()-&gt;image()-&gt;height));
<br/>
 
<br/>
   return id;
<br/>
}
<br/>
 
<br/>
// === testObject.h
<br/>
// Object to debug with.
<br/>
 
<br/>
#include "actor.h"
<br/>
#include "objectManager.h"
<br/>
#include "spriteController.h"
<br/>
 
<br/>
class testObject: public actor
<br/>
{
<br/>
   public:
<br/>
      bool create(objectManager *instigator);
<br/>
      void tick(float deltatime);
<br/>
   protected:
<br/>
      int counter;
<br/>
};
<br/>
 
<br/>
// === testObject.cpp
<br/>
// Object to debug with
<br/>
#include &lt;nds.h&gt;
<br/>
#include &lt;stdio.h&gt;
<br/>
 
<br/>
#include "testObject.h"
<br/>
 
<br/>
bool testObject::create(objectManager *instigator)
<br/>
{
<br/>
   o = instigator;
<br/>
   createGfx("mat.pcx");
<br/>
   o-&gt;s-&gt;attachActor(this);
<br/>
   return true;
<br/>
}
<br/>
 
<br/>
void testObject::tick(float deltaTime)
<br/>
{
<br/>
   // Do stuff
<br/>
}
<br/>
//===== main.cpp
<br/>
// Includes
<br/>
 
<br/>
#include &lt;nds.h&gt;
<br/>
#include &lt;fat.h&gt;
<br/>
 
<br/>
#include "objectManager.h"
<br/>
#include "testObject.h"
<br/>
#include "videoController.h"
<br/>
#include "spriteController.h"
<br/>
 
<br/>
int main(int argc, char ** argv)
<br/>
{
<br/>
   powerON(POWER_ALL_2D);
<br/>
 
<br/>
   irqInit();
<br/>
   irqSet(IRQ_VBLANK, 0);
<br/>
 
<br/>
   objectManager manager;
<br/>
   manager.create(); // Initialize!
<br/>
 
<br/>
   // Init fat routines
<br/>
   fatInitDefault();
<br/>
 
<br/>
   // Create video controller
<br/>
   videoController *v;
<br/>
   v = new videoController;
<br/>
   v-&gt;create(&amp;manager); // Sets up vram banks
<br/>
   manager.attach(v);
<br/>
 
<br/>
   manager.v = v;
<br/>
 
<br/>
   // Create sprite controller
<br/>
   spriteController *s;
<br/>
   s = new spriteController;
<br/>
   s-&gt;create(&amp;manager);
<br/>
   manager.attach(s);
<br/>
 
<br/>
 
<br/>
   // TEST
<br/>
   testObject *test;
<br/>
   test = new testObject;
<br/>
   test-&gt;create(&amp;manager);
<br/>
 
<br/>
   manager.attach(test); 
<br/>
 
<br/>
   while (1)
<br/>
   {
<br/>
      manager.manage();
<br/>
      //swiWaitForVBlank();
<br/>
   }
<br/>
 
<br/>
   return 0;
<br/>
}</td> </tr></table><span class="postbody"><br/>_________________<br/><a class="postlink" href="http://www.fireslash.net" target="_blank">FireSlash.net</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#108647 - KoshNi - Fri Nov 10, 2006 9:31 pm</h4>
    <div class="postbody"><span class="postbody">I don't like how this smells : 
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code"> o-&gt;s-&gt;attachActor(this);  </td> </tr></table><span class="postbody">
<br/>
<br/>
Does it mean :
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code"> (o-&gt;s)-&gt;attachActor(this);  </td> </tr></table><span class="postbody">
<br/>
<br/>
or :
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code"> o-&gt;(s-&gt;attachActor(this));  </td> </tr></table><span class="postbody">
<br/>
<br/>
I don't know why, but it reminds me this song from Cypress Hill :
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote"> When tha shit goes down ya better be
<br/>
ready (when tha shit goes down)
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
<br/>
Good luck guy...<br/>_________________<br/>Sunshine. Beauty. Love. Happiness.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#108649 - josath - Fri Nov 10, 2006 9:55 pm</h4>
    <div class="postbody"><span class="postbody">and are you 100% sure that a is null? I'd put an if(a==null) iprintf("omg A is null!"); just to be sure. otherwise, there may be something else which is crashing but you don't realize.
<br/>
<br/>
If you can't get it to work, simplify it down to the simplest possible case you can:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">clas blah {
<br/>
  void attachFoo(foo *f) { if(f == null) iprintf("fails!"); else iprintf("ok!"); };
<br/>
};
<br/>
<br/>
class foo {
<br/>
  void testme(blah *b) { b-&gt;attachFoo(this); };
<br/>
};
<br/>
<br/>
main() {
<br/>
  blah *b = new blah();
<br/>
  foo *f = new foo();
<br/>
  foo-&gt;testme(b);
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
Then work your way up from there. I know it seems like a lot of work, but when there is no other option, you have to do things the brute-force way.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#108670 - pollier - Sat Nov 11, 2006 3:52 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>KoshNi wrote:</b></span></td> </tr> <tr> <td class="quote">Does it mean :
<br/>
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code"> (o-&gt;s)-&gt;attachActor(this);  </td> </tr></table><span class="postbody">
<br/>
<br/>
or :
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code"> o-&gt;(s-&gt;attachActor(this));  </td> </tr></table><span class="postbody"></span></td> </tr></table><span class="postbody">
<br/>
<br/>
It's definitely the former; I don't think o-&gt;(s-&gt;attachActor(this)); is even valid C!<br/>_________________<br/>(Works for me!)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#108681 - FireSlash - Sat Nov 11, 2006 5:30 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>josath wrote:</b></span></td> </tr> <tr> <td class="quote">and are you 100% sure that a is null? I'd put an if(a==null) iprintf("omg A is null!"); just to be sure. otherwise, there may be something else which is crashing but you don't realize.
<br/>
<br/>
If you can't get it to work, simplify it down to the simplest possible case you can:
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I already tried this, hence how I discovered a was null..
<br/>
If you uncomment the if... statement, the DS doesn't crash.
<br/>
<br/>
If you comment out the line referencing "a", it does not crash.
<br/>
<br/>
If you comment out everything else in the function but the a-&gt;getLocation() call, it crashes.<br/>_________________<br/><a class="postlink" href="http://www.fireslash.net" target="_blank">FireSlash.net</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#108694 - simonjhall - Sat Nov 11, 2006 10:23 am</h4>
    <div class="postbody"><span class="postbody">Have you tried building the code on the PC and then stepping through it on that? Yeah I know you can't catch DS-specific bugs, but it'd at least show you if something obvious is wrong.
<br/>
<br/>
OR, you could run it in one of the emulators and step through clock-by-clock.
<br/>
<br/>
Now that I think about it - if you send the code to me I'll try it with the debugger...but I'm about to go away for the weekend! I could look at it Sunday night if you like!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#108697 - OOPMan - Sat Nov 11, 2006 10:54 am</h4>
    <div class="postbody"><span class="postbody">This definitely looks like a null pointer problem of some kind. Well, I think we're pretty certain of that already...
<br/>
<br/>
What you need to work out is why you're being passed a null pointer...
<br/>
<br/>
I wonder if you should/shouldn't be using the pointer deref (*) operators and/or reference (&amp;) operators somewhere some that you are/aren't using them...
<br/>
<br/>
In other words, make sure your pointer operation is 100% kosher. The problem code uses pointers and it's often minor errors in such code that causes these kind of crashes...<br/>_________________<br/>"My boot, your face..." - Attributed to OOPMan, Emperor of Eroticon VI
<br/>
<br/>
You can find my NDS homebrew projects <a class="postlink" href="http://blog.dev-scene.com/oopman/" target="_blank">here...</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#108811 - FireSlash - Sun Nov 12, 2006 5:01 am</h4>
    <div class="postbody"><span class="postbody">Found my null pointer.
<br/>
<br/>
I was cleaning up the names a bit, and I went back to look at the spriteController definition, only to find I never assigned objectManager a pointer to the spriteController.....
<br/>
<br/>
Hence, o-&gt;s &lt;-- NULL.<br/>_________________<br/><a class="postlink" href="http://www.fireslash.net" target="_blank">FireSlash.net</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#108842 - OOPMan - Sun Nov 12, 2006 8:18 am</h4>
    <div class="postbody"><span class="postbody">Yes, Null pointers are one reason why use of references is encouraged now :-) Even though they don't solve all the problems...<br/>_________________<br/>"My boot, your face..." - Attributed to OOPMan, Emperor of Eroticon VI
<br/>
<br/>
You can find my NDS homebrew projects <a class="postlink" href="http://blog.dev-scene.com/oopman/" target="_blank">here...</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#108880 - FireSlash - Sun Nov 12, 2006 5:01 pm</h4>
    <div class="postbody"><span class="postbody">I read up on references once, but they just looked like funny looking pointers to me.
<br/>
<br/>
Anyway, old habits die hard :/<br/>_________________<br/><a class="postlink" href="http://www.fireslash.net" target="_blank">FireSlash.net</a></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
