<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Streaming audio with timers - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>DS development > Streaming audio with timers</h2>
<div id="posts">
<div class="post">
    <h4>#175389 - Relfos - Thu Nov 11, 2010 10:56 pm</h4>
    <div class="postbody"><span class="postbody">I'm trying to find out how to stream audio data, using a timer and a double buffer aproach.
<br/>
<br/>
My idea would be to decode audio into two buffers, play buffer one, start timer, when timer finishes, play buffer two, decode new data into buffer one, and restart timer, etc
<br/>
<br/>
Now, how can I setup a timer that finishes exactly on the right spot to switch the buffers?
<br/>
And what function should be used to swap the buffers? I'm thinking of soundPlaySample, but maybe there's something better?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#175393 - sverx - Fri Nov 12, 2010 4:41 pm</h4>
    <div class="postbody"><span class="postbody">The ARM9 (well, each processor to say the truth) has 4 timers that could trigger an IRQ at the end of the expected time. Using one of those and soundPlaySample() function would probably fit your needs :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#175394 - Relfos - Fri Nov 12, 2010 4:50 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>sverx wrote:</b></span></td> </tr> <tr> <td class="quote">The ARM9 (well, each processor to say the truth) has 4 timers that could trigger an IRQ at the end of the expected time. Using one of those and soundPlaySample() function would probably fit your needs :)</td> </tr></table><span class="postbody">
<br/>
Yes, that was my idea, but looking at the timer example on the devkitpro, I don't really understand how to get the timing right.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">//calls the timerCallBack function 5 times per second.
<br/>
timerStart(0, ClockDivider_1024, TIMER_FREQ_1024(5), timerCallBack);
<br/>
</td> </tr></table><span class="postbody">
<br/>
Why five times per second?
<br/>
Does this ClockDivider_1024 constant means that the timer will tick 1024 times per second?
<br/>
So, if I'm playing a sample with frequency X, that is a multiple of 1024, I guess I know how to setup the timer, but what if the frequency is not a multiple of 1024, for example, say 11025hz</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#175395 - Exophase - Fri Nov 12, 2010 8:24 pm</h4>
    <div class="postbody"><span class="postbody">For audio playback, you want to have a buffer that's not too large such that there's a lot of latency, but not too small or else there will be too much extra overhead involved in going in and out of the routine that fills it. If the buffer is being filled 5 times per second that means the buffer needs to hold at least 200ms worth of data (if it's double buffered you'd have 400ms worth). That's a little on the large side in terms of latency, but if you're just using it for music then it's fine. The actual size of the buffer depends on the sample playback rate.
<br/>
<br/>
This sample playback rate has nothing to do with the buffering rate except that it dictates how large the buffer must be. The sound hardware visible to the ARM7 will automatically play back from the buffer at this rate. You can think of the sound channels as being separate timers that tick down at the appropriate rate. You have to setup the playback rate separately.
<br/>
<br/>
ClockDivider_1024 means that this timer will tick at the bus clock rate (33MHz) divided by 1024. So the timer will increment every 1024 bus cycles, or at a rate of around 32.7KHz. The timer IRQ will occur every time the 16-bit counter value wraps around from 0xFFFF to 0x0000, and will call the callback when this happens and reload the counter value. Therefore, the reload value determines how often the IRQ is called. The macro TIMER_FREQ_1024 converts a period from Hz to 32.7KHz units.
<br/>
<br/>
This is what the macro actually does:
<br/>
<br/>
TIMER_FREQ_1024(n)   (-(0x2000000&gt;&gt;10)/(n))
<br/>
<br/>
The 0x2000000 value is the number of bus ticks in a second: 2^25 (33,554,432 cycles per second). Then it's shifted right by 10 to divide by 1024, giving you the number of 1024 cycle ticks in a second. This is then divided by the number of counts you want in a second. Finally, the value is negated because you're counting up towards 0.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#175396 - Relfos - Fri Nov 12, 2010 9:51 pm</h4>
    <div class="postbody"><span class="postbody">I see, thanks!
<br/>
But soundPlaySample hangs when called inside a timer, it this normal behavior?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#175397 - wintermute - Fri Nov 12, 2010 10:41 pm</h4>
    <div class="postbody"><span class="postbody"><a href="http://maxmod.org/ref/tut/streaming.html" target="_blank">http://maxmod.org/ref/tut/streaming.html</a><br/>_________________<br/><a class="postlink" href="http://www.devkitpro.org/" target="_blank">devkitPro - professional toolchains at amateur prices</a>
<br/>
<a class="postlink" href="http://wiki.devkitpro.org/index.php/IRC" target="_blank">devkitPro IRC support</a>
<br/>
<a class="postlink" href="http://davejmurphy.com/" target="_blank">Personal Blog</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#175398 - Relfos - Fri Nov 12, 2010 11:19 pm</h4>
    <div class="postbody"><span class="postbody">Thank you, that seems perfect!</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
