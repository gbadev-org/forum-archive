<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Sound problems after some minutes of play... - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > Sound problems after some minutes of play...</h2>
<div id="posts">
<div class="post">
    <h4>#168689 - HarryPitfall - Fri May 15, 2009 6:05 pm</h4>
    <div class="postbody"><span class="postbody">Hello people, I'm getting a really strange behavior with my 'prototype' game...
<br/>
After 3 or 4 minutes of play, the game just stop to play sounds, mmEffectEx just do nothing. I'm using a music also while the game is running (the music is fine, but the effect stops to play).
<br/>
I test on 2 emulators, and they have the bug, I didn't test on a real hardware... 
<br/>
There is something wrong with the code itself that i don't see?
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#include &lt;stdio.h&gt;
<br/>
#include &lt;maxmod9.h&gt;
<br/>
#include &lt;nds.h&gt;
<br/>
<br/>
#include "soundbank.h"
<br/>
#include "soundbank_bin.h"
<br/>
<br/>
// Console Helper Functions
<br/>
<br/>
void clearScreen() {
<br/>
   iprintf("\x1b[2J");
<br/>
}
<br/>
<br/>
void printAt(int line, int column, int color, const char* str) {
<br/>
   iprintf("\x1b[%d;%dH\x1b[%dm%s", line, column, color, str);
<br/>
}
<br/>
<br/>
const char* strEnemy[4] = {"&gt;o&lt;", "@", "$", "#"};
<br/>
<br/>
typedef struct {
<br/>
   int active;
<br/>
   int x, y;
<br/>
   int type;
<br/>
   int hp;
<br/>
   int size;   
<br/>
   int color;
<br/>
} enemyData;
<br/>
<br/>
<br/>
int main() {
<br/>
   // Randomize
<br/>
   srand(time(NULL));
<br/>
   // Load Sound/Music
<br/>
   mmInitDefaultMem((mm_addr)soundbank_bin);
<br/>
   mmLoadEffect(SFX_BOOM);
<br/>
   mmLoadEffect(SFX_SHOT);
<br/>
   mmLoadEffect(SFX_GETHIT);
<br/>
   mmLoadEffect(SFX_GETSCORE);
<br/>
   mmLoadEffect(SFX_GETSHIELD);
<br/>
   // Effect
<br/>
   mm_sound_effect boom = {
<br/>
      { SFX_BOOM } ,         // id
<br/>
      (int)(1.0f * (1&lt;&lt;10)),   // rate
<br/>
      0,      // handle
<br/>
      255,   // volume
<br/>
      127,   // panning
<br/>
   };
<br/>
   mm_sound_effect shot = {
<br/>
      { SFX_SHOT } ,         // id
<br/>
      (int)(1.0f * (1&lt;&lt;10)),   // rate
<br/>
      0,      // handle
<br/>
      255,   // volume
<br/>
      127,   // panning
<br/>
   };
<br/>
   mm_sound_effect gethit = {
<br/>
      { SFX_GETHIT } ,         // id
<br/>
      (int)(1.0f * (1&lt;&lt;10)),   // rate
<br/>
      0,      // handle
<br/>
      255,   // volume
<br/>
      127,   // panning
<br/>
   };
<br/>
   mm_sound_effect getscore = {
<br/>
      { SFX_GETSCORE } ,         // id
<br/>
      (int)(1.0f * (1&lt;&lt;10)),   // rate
<br/>
      0,      // handle
<br/>
      255,   // volume
<br/>
      127,   // panning
<br/>
   };
<br/>
   mm_sound_effect getshield = {
<br/>
      { SFX_GETSHIELD } ,         // id
<br/>
      (int)(1.0f * (1&lt;&lt;10)),   // rate
<br/>
      0,      // handle
<br/>
      255,   // volume
<br/>
      127,   // panning
<br/>
   };
<br/>
   mmLoad(MOD_BGMUSIC);
<br/>
   mmSetModuleVolume(512); // Half Volume...
<br/>
   // SubScreen = Console (32 columns, 24 rows)
<br/>
   consoleDemoInit();
<br/>
   //  Video Mode...
<br/>
   videoSetMode(MODE_FB0); 
<br/>
   vramSetBankA(VRAM_A_LCD);
<br/>
   // Raw Draw (Upper Screen)
<br/>
   for(int row = 0; row &lt; 192; row++)
<br/>
      for(int col = 0; col &lt; 256; col++) {
<br/>
         int offset = (row * 256) + col;
<br/>
         VRAM_A[offset] = RGB15(row % 32, col % 32, (offset&gt;&gt;1) % 32);
<br/>
      }
<br/>
   //
<br/>
   while (1) {
<br/>
      clearScreen();
<br/>
      int flag1 = 0;
<br/>
      while (flag1 == 0) {
<br/>
         printAt(11,  9, 39, "+------------+");
<br/>
         printAt(12,  9, 39, "|            |");
<br/>
         printAt(13,  9, 39, "+------------+");
<br/>
         printAt(12, 11, 45, "SPACE RAID");
<br/>
         scanKeys();
<br/>
         if (keysDown() &amp; KEY_A) flag1 = 1;
<br/>
         swiWaitForVBlank();
<br/>
      }
<br/>
      //
<br/>
      mmStart(MOD_BGMUSIC, MM_PLAY_LOOP);      
<br/>
      //      
<br/>
      int nextobj = 0;   
<br/>
      enemyData objs[10];
<br/>
      for(int i = 0; i &lt; 10; i++) {
<br/>
         objs[i].active = 0;
<br/>
         objs[i].x = 0;
<br/>
         objs[i].y = 0;
<br/>
         objs[i].type = 0;
<br/>
         objs[i].hp = 0;
<br/>
         objs[i].size = 0;
<br/>
         objs[i].color = 0;
<br/>
      }
<br/>
      //
<br/>
      int navex = 15;
<br/>
      int score = 0;
<br/>
      int shield = 5;
<br/>
      int framejump = 0;
<br/>
      int framecount = 0;
<br/>
      int takedown = 0;
<br/>
      int combo = 0;      
<br/>
      int iscomboenabled = 0;
<br/>
      while (shield &gt; 0) {   
<br/>
         framejump = (framejump+1) % 3;
<br/>
         if (framejump == 0) {
<br/>
            framecount = (framecount+1) % 360; // 360 is a good number (div 2, 3, 5, 6, 10)
<br/>
            int isShot = 0;
<br/>
            // Input
<br/>
            scanKeys();
<br/>
            /* Handle left and right parts of D-Pad. */
<br/>
            if (keysHeld() &amp; KEY_LEFT) {
<br/>
               if (navex &gt; 2) navex--;
<br/>
            } else if (keysHeld() &amp; KEY_RIGHT) {
<br/>
               if (navex &lt; 29) navex++;
<br/>
            }
<br/>
            /* Fire? */
<br/>
            if (keysDown() &amp; KEY_A) {
<br/>
               isShot = 1;            
<br/>
            }
<br/>
            // Logic
<br/>
            if (((rand() % 5) == 0) &amp;&amp; (objs[nextobj].active == 0)) {
<br/>
               objs[nextobj].active = 1;
<br/>
               objs[nextobj].type = rand() % 2;
<br/>
               objs[nextobj].x = 2 + (rand() % 28);
<br/>
               objs[nextobj].y = -1;
<br/>
               objs[nextobj].hp = 0; // Unused for now...
<br/>
               // Change Type If...
<br/>
               if (takedown &gt; 5) {
<br/>
                  takedown = 0;
<br/>
                  objs[nextobj].type = 2;
<br/>
               }
<br/>
               if (iscomboenabled == 1) {
<br/>
                  iscomboenabled = 0;
<br/>
                  objs[nextobj].type = 3;
<br/>
               }
<br/>
               
<br/>
               if (objs[nextobj].type == 0)
<br/>
                  objs[nextobj].size = 1; 
<br/>
               else
<br/>
                  objs[nextobj].size = 0; 
<br/>
               if (objs[nextobj].type &lt; 2)   
<br/>
                  objs[nextobj].color = 44;
<br/>
               else
<br/>
                  objs[nextobj].color = 43;
<br/>
               // So, can change into bonus if...
<br/>
               nextobj = (nextobj + 1) % 10;
<br/>
            }
<br/>
            for(int i = 0; i &lt; 10; i++) {
<br/>
               if (objs[i].active == 1) {
<br/>
                  objs[i].y++;
<br/>
                  if (objs[i].y == 21) {
<br/>
                     // Colision Check, Shields and Game Over...
<br/>
                     int distance = navex - objs[i].x;
<br/>
                     int hitfactor = 2 + objs[i].size;
<br/>
                     if ((distance &lt; hitfactor) &amp;&amp; (distance &gt; -hitfactor)) {
<br/>
                        if (objs[i].type == 2) {
<br/>
                           score+=50;         
<br/>
                           getscore.handle = mmEffectEx(&amp;getscore);
<br/>
                        } else if (objs[i].type == 3) {
<br/>
                           shield++;
<br/>
                           getshield.handle = mmEffectEx(&amp;getshield);
<br/>
                        } else {                     
<br/>
                           objs[i].active = 0;
<br/>
                           shield--;
<br/>
                           gethit.handle = mmEffectEx(&amp;gethit);
<br/>
                        }
<br/>
                     }
<br/>
                  } else if (objs[i].y &gt; 21) {
<br/>
                     objs[i].active = 0;
<br/>
                  }
<br/>
               }
<br/>
            }
<br/>
            // Output
<br/>
            clearScreen();
<br/>
            printAt(21, navex - 1, 43, "&lt;^&gt;");
<br/>
            if (isShot) {
<br/>
               mmEffectEx(&amp;shot);
<br/>
               int j = 0;
<br/>
               combo = 0;
<br/>
               for(int i = 20; i &gt; 0; i--) {
<br/>
                  printAt(i, navex, 41, "|");
<br/>
                  // Check colision, if did it, stop the phaser here... add points and disable enemy, also, draw the hit (amazing)                  
<br/>
                  for(int k = 0; k &lt; 10; k++) {
<br/>
                     if ((objs[k].active == 1) &amp;&amp; (objs[k].type &lt; 2)) {
<br/>
                        if (
<br/>
                           (objs[k].x == navex) ||
<br/>
                           ((objs[k].x-objs[k].size) == navex) ||
<br/>
                           ((objs[k].x+objs[k].size) == navex)
<br/>
                        ) {
<br/>
                           j = 1; // Something Get's Hit!
<br/>
                           objs[k].active = 0;
<br/>
                           score += ((objs[k].type + 1) * 5);
<br/>
                           printAt(objs[k].y - 1, objs[k].x - 1, 41, "\\|/");
<br/>
                           printAt(objs[k].y,     objs[k].x - 1, 41, "- -");
<br/>
                           printAt(objs[k].y + 1, objs[k].x - 1, 41, "/|\\");                           
<br/>
                           takedown++;
<br/>
                           combo++;
<br/>
                        }               
<br/>
                     }
<br/>
                  }
<br/>
               }   
<br/>
               if (combo &gt; 2)
<br/>
                  iscomboenabled = 1;
<br/>
               if (j == 0)
<br/>
                  score--; // Missing shots costs 1 score...
<br/>
               else
<br/>
                  boom.handle = mmEffectEx(&amp;boom); // Hit Sound!
<br/>
            }      
<br/>
            for(int i = 0; i &lt; 10; i++) {
<br/>
               if (objs[i].active == 1) {
<br/>
                  printAt(objs[i].y, objs[i].x - objs[i].size, objs[i].color, strEnemy[objs[i].type]);
<br/>
               }   
<br/>
            }
<br/>
            printAt(22, 0,         42, "================================");
<br/>
            printAt(23, 1,         46, "Score: "); iprintf("%d", score);
<br/>
            printAt(23, 20,        46, "Shield: "); iprintf("%d", shield);
<br/>
            // Wait
<br/>
         }
<br/>
         swiWaitForVBlank();
<br/>
      }   
<br/>
      //
<br/>
      mmStop();
<br/>
      //
<br/>
      int flag2 = 0;
<br/>
      while (flag2 == 0) {
<br/>
         printAt(11, 10, 39, "+-----------+");
<br/>
         printAt(12, 10, 39, "|           |");
<br/>
         printAt(13, 10, 39, "+-----------+");
<br/>
         printAt(12, 12, 39 + (rand() % 8), "GAME OVER");
<br/>
         scanKeys();
<br/>
         if (keysDown() &amp; KEY_A) flag2 = 1;
<br/>
         swiWaitForVBlank();
<br/>
      }
<br/>
   }
<br/>
   // Halt      
<br/>
   return 0;
<br/>
}
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
