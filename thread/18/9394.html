<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>IPC FIFO - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > IPC FIFO</h2>
<div id="posts">
<div class="post">
    <h4>#81361 - ProblemBaby - Fri Apr 28, 2006 6:30 pm</h4>
    <div class="postbody"><span class="postbody">Hi
<br/>
<br/>
i have some problems with the ipc fifo.
<br/>
I want to send a Command ID from the arm9 and handle that in the arm7.
<br/>
my way of doing this is:
<br/>
<br/>
Ive a recieve interrupt function, that first Reads the command ID, handles it, and then make another read, to define as finished
<br/>
<br/>
in the arm 9, when I want to send a command I first wait until the FIFO is empty, Fill a global struct with the parameters, then Send first the Command ID and then a 0.
<br/>
This works when the calls isnt to close, else only one command is processed. Can't understand why, cause it should not be able to send a new command before the recieve interrupt is finished. Is this probably a bug or is it something I don't know about the IPC that makes this don't work.
<br/>
<br/>
What I want to do is to control the sounds regs from arm9, maybe you have better ideas how to do that, I need to be able to update more then once in a frame.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#81368 - DekuTree64 - Fri Apr 28, 2006 7:34 pm</h4>
    <div class="postbody"><span class="postbody">Sounds like a bug to me. If ARM9 is only waiting until the FIFO is empty, then as soon as ARM7 reads the command, ARM9 could wipe out the global struct before ARM7 reads it. Could make a local copy of the global struct before actually reading from the FIFO, or set some flag when it's safe to overwrite the global struct again.
<br/>
<br/>
I have a simple FIFO system that I could send to you tonight if you want. It's pretty basic, but reliable. Just writes a single word to the FIFO, and then waits until the other CPU processes it before returning.
<br/>
The waiting is done by having each CPU keep track of how many commands they have sent, and how many commands they have processed. When sending, you increment the local sent counter, and then wait until the other CPU's processed counter is equal.<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#81390 - ProblemBaby - Fri Apr 28, 2006 11:17 pm</h4>
    <div class="postbody"><span class="postbody">a working example would be great! Check out the my profile to get my mail or are you going to upload it somewhere?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#81998 - DekuTree64 - Wed May 03, 2006 10:20 am</h4>
    <div class="postbody"><span class="postbody">Oops, I kind of forgot about this post...
<br/>
Well, here is my little <a class="postlink" href="http://deku.gbadev.org/ipc.zip" target="_blank">IPC system</a>. 
<br/>
Should convert over to libnds easily, you'll just need to put the arm9FifoSent, arm9FifoProcessed, etc. in a seperate struct and place it after the transfer region struct or something.
<br/>
<br/>
I also included my higher level sound code, which does the starting of sound channels using the fifo commands. 
<br/>
<br/>
The mixer splits all the software channels across 8 batches, so it starts up all the hardware channels playing buffers. I'm not actually sure if splitting batches like that helps anything though... I think adding them all together and clipping manually might have the same result.<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#82617 - ProblemBaby - Sun May 07, 2006 10:18 pm</h4>
    <div class="postbody"><span class="postbody">thanks a lot, this really helped!</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
