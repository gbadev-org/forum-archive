<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>lickfifo (r4) - an automatic FIFO-interrupt-handler - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > lickfifo (r4) - an automatic FIFO-interrupt-handler</h2>
<div id="posts">
<div class="post">
    <h4>#115440 - Lick - Tue Jan 16, 2007 3:42 am</h4>
    <div class="postbody"><span class="postbody"><span style="font-weight: bold">Download</span>
<br/>
#Scroll down for r4
<br/>
<br/>
<span style="font-weight: bold">Why</span>
<br/>
I wrote a small, simple and automatic FIFO-interrupt-handler to eliminate the chaotic FIFO IRQ spaghetti that was present in my previous projects.
<br/>
<br/>
<span style="font-weight: bold">What</span>
<br/>
I call it <span style="font-style: italic">lickfifo</span>, and it will enable, disable the FIFO IRQ with 2 simple functions, and it also has a functionpointer-system, where you can add your own FIFO IRQ messagehandlers to an automatic process. It works on both ARM7 and ARM9! 
<br/>
The example project should illustrate how it works, and why it makes your code much cleaner. It sends (triggered by keyinput) a message from ARM9 to the ARM7 (automatically) back to the ARM9 that (automatically) swaps the LCDs.
<br/>
<br/>
<span style="font-weight: bold">How</span>
<br/>
#Scroll down for r4
<br/>
<br/>
Suggestions are welcome,
<br/>
- Lick<br/>_________________<br/><a class="postlink" href="http://licklick.wordpress.com" target="_blank">http://licklick.wordpress.com</a></span><span class="gensmall"><br/><br/>Last edited by Lick on Fri Jan 19, 2007 2:54 pm; edited 10 times in total</span></div>    
</div>
<div class="post">
    <h4>#115445 - Lick - Tue Jan 16, 2007 3:56 am</h4>
    <div class="postbody"><span class="postbody">Currently, <span style="font-style: italic">lickfifoAddHandler</span>(functionpointer) returns an index that can be used to remove the handler at a later stage with <span style="font-style: italic">lickfifoRemoveHandler(</span>index). I could probably replace the index-system by simply checking the handler-array against the passed functionpointer. Like: <span style="font-style: italic">lickfifoRemoveHandler</span>(functionpointer).
<br/>
Dunno if that's necessary though. It's probably <span style="font-style: italic">slower</span> as well.
<br/>
<br/>
- Lick<br/>_________________<br/><a class="postlink" href="http://licklick.wordpress.com" target="_blank">http://licklick.wordpress.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#115480 - 0xtob - Tue Jan 16, 2007 11:52 am</h4>
    <div class="postbody"><span class="postbody">Great idea Lick!
<br/>
<br/>
I would really like to see this in libnds. Then, the IPC transfer region struct could be replaced by something more flexible and it would be much easier to let the CPUs talk to each other.
<br/>
<br/>
Some suggestions:
<br/>
<br/>
I would personally think it's cleaner to add handlers for specific message types instead of checking for the message inside the handler, i.e.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
lickfifoAddHandler(FIFO_CMD_PLAY_SAMPLE, handlePlaySample);
<br/>
</td> </tr></table><span class="postbody">
<br/>
Of course, handlers like handleBelowTen would not be possible like this, but I don't see the point in that anyway.
<br/>
<br/>
Also, it would be cool to have an easy way of sending commands and data over the FIFO, something like
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
sendFifoCommand(FIFO_CMD_PLAY_SAMPLE, &amp;smpinfo, sizeof(smpinfo));
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
What do you think?<br/>_________________<br/><a class="postlink" href="http://blog.dev-scene.com/0xtob" target="_blank">http://blog.dev-scene.com/0xtob</a> | <a class="postlink" href="http://nitrotracker.tobw.net" target="_blank">http://nitrotracker.tobw.net</a> | <a class="postlink" href="http://dsmi.tobw.net" target="_blank">http://dsmi.tobw.net</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#115484 - Lick - Tue Jan 16, 2007 3:34 pm</h4>
    <div class="postbody"><span class="postbody">I was thinking about it myself too. It seems much easier to let the automatic process recognize the message, instead of doing it in each and every handler. 
<br/>
Sending messages is indeed something that should be included as well, hehe.
<br/>
<br/>
I will work on it later today!
<br/>
- Lick<br/>_________________<br/><a class="postlink" href="http://licklick.wordpress.com" target="_blank">http://licklick.wordpress.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#115541 - Lick - Wed Jan 17, 2007 12:34 am</h4>
    <div class="postbody"><span class="postbody"><span style="font-weight: bold">Download</span>
<br/>
<a class="postlink" href="http://www.box.net/public/v6szntzybv" target="_blank">lickfifo_r2.zip (17kB)</a> (Example included, press A/B)
<br/>
<br/>
<span style="font-weight: bold">What's added in r2</span>
<br/>
Message handlers are now assigned to id's and you can send data along with the message. Thanks 0xtob for the suggestions.
<br/>
<br/>
<span style="font-weight: bold">Notes</span>
<br/>
- Data can be sent per byte (1), per short (2) or per long (4).
<br/>
<br/>
<span style="font-weight: bold">How</span>
<br/>
Processor A</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void SampleMessageHandler1(u32 bytes, u32 transfertype) {
<br/>
  // message handler that doesn't receive data
<br/>
}
<br/>
<br/>
void SampleMessageHandler2(u32 bytes, u32 transfertype) {
<br/>
  // message handler that receives data
<br/>
   u8 data[256];
<br/>
   lickfifoRecv(&amp;data, bytes, transfertype);
<br/>
}
<br/>
<br/>
..
<br/>
lickfifoAddHandler(201, SampleMessageHandler1);
<br/>
lickfifoAddHandler(202, SampleMessageHandler2);
<br/>
lickfifoEnable();
<br/>
..</td> </tr></table><span class="postbody">
<br/>
Processor B</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
char data[256];
<br/>
strcpy(data, "Example data");
<br/>
..
<br/>
lickfifoEnable();
<br/>
lickfifoSend(201, 0, 0, 0);
<br/>
lickfifoSend(202, data, 256, LICKFIFO_TRANSFER_LONG);
<br/>
..</td> </tr></table><span class="postbody"><br/>_________________<br/><a class="postlink" href="http://licklick.wordpress.com" target="_blank">http://licklick.wordpress.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#115544 - 0xtob - Wed Jan 17, 2007 1:09 am</h4>
    <div class="postbody"><span class="postbody">Great work, Lick!
<br/>
<br/>
With libcartreset, this will be the second Lick-lib in NitroTracker. One question though: What are the different transfer types for? Does it make a difference (except for a speed gain perhaps) if the data is transferred as bytes, shorts or longs?<br/>_________________<br/><a class="postlink" href="http://blog.dev-scene.com/0xtob" target="_blank">http://blog.dev-scene.com/0xtob</a> | <a class="postlink" href="http://nitrotracker.tobw.net" target="_blank">http://nitrotracker.tobw.net</a> | <a class="postlink" href="http://dsmi.tobw.net" target="_blank">http://dsmi.tobw.net</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#115546 - Lick - Wed Jan 17, 2007 1:22 am</h4>
    <div class="postbody"><span class="postbody">The transfertype is only set when you send, after that it's all just 'pass along'. And I -think- that 4byte transfers will be the fastest. <span style="font-weight: bold">[edit]</span> Also make sure your data is the correct size.
<br/>
<br/>
Oh and if you haven't noticed (you should have!) the max handlers is currently set to 32. You can change that yourself by changing a define, according to your own needs (speed vs maximum).
<br/>
<br/>
I kinda dislike libcartreset, at least, the current form. I should update it -fast-. Hehe..
<br/>
- Lick<br/>_________________<br/><a class="postlink" href="http://licklick.wordpress.com" target="_blank">http://licklick.wordpress.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#115621 - Lick - Wed Jan 17, 2007 11:55 pm</h4>
    <div class="postbody"><span class="postbody"><span style="font-weight: bold">Download</span>
<br/>
<a class="postlink" href="http://www.box.net/public/g0i56idu0a" target="_blank">go to this page</a>
<br/>
<br/>
<span style="font-weight: bold">lickfifo r3</span>
<br/>
- Fixed the non-working "lickfifoRemoveHandler()" in r2. It works now, and it accepts the id of the handler that will be removed.
<br/>
- Renamed some types like the functionpointer-type, it's now called a "LICKFIFO_CALLBACK".
<br/>
- The callbacks do not require parameters anymore, because..
<br/>
- The data-receive function will now track the amount of bytes transferred. It's simply "lickfifoRecv(&amp;myData);" now.
<br/>
<br/>
This should be the final release, until new features are suggested! Thanks for using lickfifo!
<br/>
- Lick<br/>_________________<br/><a class="postlink" href="http://licklick.wordpress.com" target="_blank">http://licklick.wordpress.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#115624 - Mighty Max - Thu Jan 18, 2007 12:29 am</h4>
    <div class="postbody"><span class="postbody">In your send rountine:
<br/>
<br/>
You are waiting for the fifo to becoem empty before sending the next byte. Instad you should wait until the fifo is not full. 
<br/>
<br/>
If you are allways waiting for a empty fifo, you are risking to cause an irq on the other side for every single byte as the other side might leave the irq because the fifo is empty before it was filled with the next byte. This will be really slow. If you instead fill the next byte as soon as there is place available, you can handle the stream in one irq, and with the full speed the fifo can do.
<br/>
<br/>
The Recv function does not check against buffer overrun, and there is no indication whether the data was transfered. It is not possible to wait for an transfer (even if i'd implement a way check if the transfer was successfull) in an irq handler. I.e. when you try to request another chunk of sounddata from within a timerirq, without hassle with reentrant irq calls or leaving the timer.
<br/>
<br/>
But that all can be improved, so keep up the work!<br/>_________________<br/><a class="postlink" href="http://mightymax.org/gbamp_multiboot.html" target="_blank">GBAMP Multiboot</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#115637 - Lick - Thu Jan 18, 2007 1:31 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Mighty Max wrote:</b></span></td> </tr> <tr> <td class="quote">The Recv function does not check against buffer overrun, and there is no indication whether the data was transfered. It is not possible to wait for an transfer (even if i'd implement a way check if the transfer was successfull) in an irq handler. I.e. when you try to request another chunk of sounddata from within a timerirq, without hassle with reentrant irq calls or leaving the timer.</td> </tr></table><span class="postbody">
<br/>
<br/>
Hey Mighty Max, thanks for your comments, it sure seems like there is much that still needs to be done hehe. 
<br/>
<br/>
I'm not sure if I should make the system bug-prove though. It's designed to make things easier, not safer. At this point, the programmer should know what he's doing when calling Send and Recv. 
<br/>
IMO, it's pretty obvious because <span style="font-style: italic">each id is paired with 1 callback</span>, so there's always 1 send and 1 (optional) receive. It might get buggy if an id <span style="font-style: italic">is accidentally paired with two callbacks</span>, so I need to prevent that from happening.<span style="font-weight: bold"> (Will do in r4)</span>
<br/>
<br/>
As for the latter part, about waiting for a transfer.. I'm not sure I get what you're trying to say here. You mean like a Recv function that works outside of a FIFO callback? Perhaps I can make a SendAndRecv function, so it will trigger the other side to send data, and after that, receive the data in the same function. Good idea?
<br/>
<br/>
<br/>
Thanks for your interesting comments,
<br/>
- Lick<br/>_________________<br/><a class="postlink" href="http://licklick.wordpress.com" target="_blank">http://licklick.wordpress.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#115841 - Lick - Fri Jan 19, 2007 2:51 pm</h4>
    <div class="postbody"><span class="postbody"><span style="font-weight: bold">Download</span>
<br/>
<a class="postlink" href="http://www.box.net/public/16ml7eakfm" target="_blank">Downloadpage r4</a>
<br/>
<br/>
<span style="font-weight: bold">lickfifo r4</span>
<br/>
- All "lick" and "LICK" prefixes removed. (The library is still called "lickfifo" though. ;)
<br/>
- fifoSend and fifoRecv modified to only transfer data.
<br/>
- fifoTrigger added. This will do the triggering from now on.
<br/>
- fifoSend routine now waits until the "fifo is not full"  instead of "fifo is empty".
<br/>
<br/>
<span style="font-weight: bold">How</span></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">.. first processor
<br/>
fifoAddHandler(id, callback);
<br/>
fifoEnable();
<br/>
<br/>
.. other processor
<br/>
fifoTrigger(id); // this invokes callback on the other processor
<br/>
fifoSend(data, sizeof(data), FIFO_TRANSFER_BYTE); // optional
<br/>
fifoRecv(data, sizeof(data), FIFO_TRANSFER_BYTE); // optional</td> </tr></table><span class="postbody">
<br/>
<br/>
Keep the suggestions coming!
<br/>
- Lick<br/>_________________<br/><a class="postlink" href="http://licklick.wordpress.com" target="_blank">http://licklick.wordpress.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#115860 - Lick - Fri Jan 19, 2007 8:24 pm</h4>
    <div class="postbody"><span class="postbody">Well, to show how easy it is to add to this automatic system, I went ahead and implemented lickfifo<span style="font-weight: bold">X</span>. It's basically a <span style="font-weight: bold">"useful set of handlers"</span> for lickfifo.
<br/>
<br/>
<a class="postlink" href="http://www.box.net/public/vlnjsm4ltx" target="_blank">Download page</a>
<br/>
<br/>
It enables you to do the following:
<br/>
- ARM9: see if hardware is DS Lite.
<br/>
- ARM9: control the DS Lite brightness.
<br/>
- ARM9: control the backlights.
<br/>
- ARM9: read the firmware.
<br/>
<br/>
Call fifoXAddHandlers() to add the handlers to the lickfifo-system.
<br/>
<br/>
Enjoy!
<br/>
- Lick<br/>_________________<br/><a class="postlink" href="http://licklick.wordpress.com" target="_blank">http://licklick.wordpress.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#115890 - Lick - Fri Jan 19, 2007 11:40 pm</h4>
    <div class="postbody"><span class="postbody">It suddenly strook me: should this actually be called an IPC system instead of FIFO system?
<br/>
<br/>
w00t..<br/>_________________<br/><a class="postlink" href="http://licklick.wordpress.com" target="_blank">http://licklick.wordpress.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#115907 - HyperHacker - Sat Jan 20, 2007 2:41 am</h4>
    <div class="postbody"><span class="postbody">Perhaps, but it could be confused with the "IPC" struct in the libnds header files, which is simply shared RAM.<br/>_________________<br/>I'm a PSP hacker now, but I still &lt;3 DS.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#115932 - Lick - Sat Jan 20, 2007 1:02 pm</h4>
    <div class="postbody"><span class="postbody">I got a tip from someone that this code seriously has problems and might cause breakage and bugs. 
<br/>
<span style="font-weight: bold">It's recommended NOT to use it.</span>
<br/>
<br/>
We'll just forget about its existence..<br/>_________________<br/><a class="postlink" href="http://licklick.wordpress.com" target="_blank">http://licklick.wordpress.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#115958 - tepples - Sat Jan 20, 2007 7:38 pm</h4>
    <div class="postbody"><span class="postbody">Have you abandoned the project entirely, or will you fix these major problems in an r5?<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#115965 - Lick - Sat Jan 20, 2007 7:50 pm</h4>
    <div class="postbody"><span class="postbody">Well, <span style="font-weight: bold">the code works, </span>but the whole design of it (a callback-mechanism inside an interrupt) can cause a lot of bugs.
<br/>
<br/>
To be honest, I am STILL not really sure what issues might occur, but I am convinced that whatever Wintermute advices is probably correct. He is the one who wrote the interruptDispatcher, after all.<br/>_________________<br/><a class="postlink" href="http://licklick.wordpress.com" target="_blank">http://licklick.wordpress.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#116000 - DekuTree64 - Sun Jan 21, 2007 12:51 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Lick wrote:</b></span></td> </tr> <tr> <td class="quote">Well, <span style="font-weight: bold">the code works, </span>but the whole design of it (a callback-mechanism inside an interrupt) can cause a lot of bugs.</td> </tr></table><span class="postbody">
<br/>
Huh? That's basically what the interrupt dispatcher itself does... Sure you have to be careful not to mess with things that could break the code that was interrupted, but that's just standard procedure when working with interrupts.
<br/>
<br/>
I'd like to hear what the specific problems were, because it looks fine to me, and I've been using a similar system that I wrote for a long time with no problems.<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#116016 - Lick - Sun Jan 21, 2007 4:46 am</h4>
    <div class="postbody"><span class="postbody">I updated the <a class="postlink" href="http://www.box.net/public/16ml7eakfm" target="_blank">r4 download</a>. The .c sourcefile is now <span style="font-style: italic">much</span> easier to read. No other changes (except for the loop in the FIFO IRQ-handler).
<br/>
<br/>
DekuTree64, I think it has to do with reentrancy, or something like that.<br/>_________________<br/><a class="postlink" href="http://licklick.wordpress.com" target="_blank">http://licklick.wordpress.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#116032 - DekuTree64 - Sun Jan 21, 2007 6:53 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Lick wrote:</b></span></td> </tr> <tr> <td class="quote">DekuTree64, I think it has to do with reentrancy, or something like that.</td> </tr></table><span class="postbody">
<br/>
Ah, nested interrupts. That could cause chaos if you don't check for it, but it doesn't make the design of the system inherently bad.
<br/>
<br/>
Should be all you need is in __fifoIRQ(), disable the FIFO receive interrupt in REG_IE, then read stuff from the FIFO and do callbacks, then reenable at the end. That way, if another FIFO transfer happens in the middle of the handler, it won't actually be registered until after the callback has finished processing.
<br/>
<br/>
<br/>
EDIT: Nevermind that, I just looked at the default dispatcher in the libnds source and found this little bit of code:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">@---------------------------------------------------------------------------------
<br/>
got_handler:
<br/>
@---------------------------------------------------------------------------------
<br/>
<br/>
   mrs   r2, cpsr
<br/>
   bic   r2, r2, #0xdf      @ \__
<br/>
   orr   r2, r2, #0x1f      @ /  --&gt; Enable IRQ &amp; FIQ. Set CPU mode to System.
<br/>
   msr   cpsr,r2
<br/>
<br/>
   ldr   r2, [r3,#0x210]      @ REG_IE
<br/>
   stmfd   sp!, {r0,r2, r3,lr}   @ irq mask, IE, REG_IE, lr
<br/>
   bic   r2, r2, r0      @ disable interrupt about to be serviced
<br/>
   str   r2, [r3,#0x210]
<br/>
<br/>
   adr   lr, IntrRet
<br/>
   bx   r1</td> </tr></table><span class="postbody">
<br/>
Which already disables the interrupt it's about to jump to the handler for. So there should be no re-entering __fifoIRQ() at all. So I have no idea what the danger is.
<br/>
<br/>
<br/>
EDIT #2: Oh wait, there is still potential for missed messages due to an annoying thing in the dispatcher which I <a class="postlink" href="http://forum.gbadev.org/viewtopic.php?t=11398&amp;postdays=0&amp;postorder=asc&amp;start=0" target="_blank">complained about before</a>. I guess you could do a blocking system to get around it, where when one CPU send a message, it waits until the other has finished running the callback and reported back before moving on. Slower, but guarantees safety.
<br/>
<br/>
<span style="font-size: 8px; line-height: normal">But I still hold that clearing the REG_IF bit before jumping to the user handler is the only safe way to handle interrupts.</span><br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#116052 - Lick - Sun Jan 21, 2007 1:24 pm</h4>
    <div class="postbody"><span class="postbody">If it's a matter of time and how long the interrupt handler takes (if it takes too long then messages will be lost), then I think there could be <span style="font-weight: bold">critical</span> and <span style="font-weight: bold">non-critical</span> messages. The critical messages will be handled immediately, and non-critical messages will be put into a queue and are then handled in the mainloop, or vblank.
<br/>
It's not often that these interrupts are critical, so in practice it would come down to 2 or 3 critical and the rest non-critical. 
<br/>
<br/>
But there's more to it, I'm sure there is, but no one can explain it thoroughly.<br/>_________________<br/><a class="postlink" href="http://licklick.wordpress.com" target="_blank">http://licklick.wordpress.com</a></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
