<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Does anyone used Fog in a demo? [Renamed] - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > Does anyone used Fog in a demo? [Renamed]</h2>
<div id="posts">
<div class="post">
    <h4>#138293 - a128 - Wed Aug 22, 2007 1:23 pm</h4>
    <div class="postbody"><span class="postbody">Does anyone used Fog in a demo?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#138321 - silent_code - Wed Aug 22, 2007 11:05 pm</h4>
    <div class="postbody"><span class="postbody">i tried it, but somehow the fog just affected the clear color.
<br/>
when i get back to nds development, i'll sure try again. ;D good luck till then!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#138329 - simonjhall - Wed Aug 22, 2007 11:41 pm</h4>
    <div class="postbody"><span class="postbody">Yeah I used fog. What would you like to know?<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#138364 - zeruda - Thu Aug 23, 2007 8:19 am</h4>
    <div class="postbody"><span class="postbody">Here's what you need:
<br/>
In a header file:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#define POLY_FOG  (1&lt;&lt;15)
<br/>
#define GL_FOG_SHIFT(n)   ((n)&lt;&lt;8)
<br/>
<br/>
#define GL_RDLINE_UNDERFLOW   (1&lt;&lt;12)
<br/>
#define GL_VERTEX_OVERFLOW    (1&lt;&lt;13)
<br/>
<br/>
#define GFX_FOG_COLOR   (*(vuint32*) 0x04000358)
<br/>
#define GFX_FOG_OFFSET  (*(vuint32*) 0x0400035C)
<br/>
#define GFX_FOG_TABLE   ((vuint8*)  0x04000360)
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
In you code you need the following:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
void glFogColor(uint8 red, uint8 green, uint8 blue, uint8 alpha) {
<br/>
    GFX_FOG_COLOR = (red) | ((green) &lt;&lt; 5) | ((blue) &lt;&lt; 10) | ((alpha) &lt;&lt; 16);
<br/>
}
<br/>
<br/>
void glFogDepth(uint16 depth) { GFX_FOG_OFFSET = depth; }
<br/>
<br/>
void UpdateFog()
<br/>
{
<br/>
    glFogColor(31, 13, 13, 31);
<br/>
    glFogDepth(24832);
<br/>
    int Mass = 2;
<br/>
    int Shift = 2;
<br/>
    for (int i = 0; i &lt; 32; i++) { GFX_FOG_TABLE[i] = (i &lt;&lt; Mass); }
<br/>
<br/>
    GFX_CONTROL = GL_FOG | GL_FOG_SHIFT(Shift) | GL_RDLINE_UNDERFLOW |
<br/>
                GL_VERTEX_OVERFLOW | GL_TEXTURE_2D | GL_BLEND;
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
The colour is rgba, although I haven't got the alpha component to make any difference. The depth is how far back you want the fog. The mass varies from 0-2 and the Shift from 0-15 and those affect the strength of the fog.
<br/>
<br/>
You also have to enable Fog in your polyformat for your meshes:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
glPolyFmt(SETALPHA(31) | POLY_FOG | POLY_ID(17));
<br/>
        glPushMatrix();
<br/>
            DrawMesh();
<br/>
        glPopMatrix(1);</td> </tr></table><span class="postbody">[/code]</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#138365 - a128 - Thu Aug 23, 2007 8:20 am</h4>
    <div class="postbody"><span class="postbody">I know how to setup Fog...
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#ifdef FOG
<br/>
<br/>
    GFX_CONTROL = GL_TEXTURE_2D | GL_FOG | GL_FOG_SHIFT(8) | GL_ANTIALIAS | GL_BLEND;
<br/>
<br/>
    // Set up the fog stuff
<br/>
    glFogColor(31, 0, 0, 31);
<br/>
<br/>
    glFogDepth(2);//just a test value
<br/>
<br/>
    int i;
<br/>
<br/>
    //density
<br/>
<br/>
    for (i = 0; i &lt; 32; i++) {
<br/>
        GFX_FOG_TABLE[i] = i / 2; //just a fake value NOT the real thing?!
<br/>
    }
<br/>
<br/>
#endif
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
What I do not know - and what I want to have with Fog - is , how to setup Fog... so the Fog range is i.e from 40 to 100 for the far plane .
<br/>
<br/>
 guess the most important think is to calculate some W-values for the GFX_FOG_TABLE</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#138367 - zeruda - Thu Aug 23, 2007 8:54 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>a128 wrote:</b></span></td> </tr> <tr> <td class="quote">I know how to setup Fog...
<br/>
<br/>
What I do not know - and what I want to have with Fog - is , how to setup Fog... so the Fog range is i.e from 40 to 100 for the far plane .</td> </tr></table><span class="postbody">
<br/>
<br/>
I don't quite get what you mean. If you have a depth of 0 the fog come right up to the camera. If you push it back 10000, it goes back a ways, and set it 30000 or so it goes all the way back.
<br/>
<br/>
The mass(fog table) has 3 effective settings. 0 for light mist. 1 for standard smooth fog. 3 for fog that becomes like a wall.
<br/>
<br/>
The fog shift then manipulates the fog table. 0 for small gradient. And the 15 for less gradient. If you have mass of 2 and gradient 15 then it will be like a flat wall. But use 2 and 2 and it is smoother.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#138380 - a128 - Thu Aug 23, 2007 1:20 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>zeruda wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
I don't quite get what you mean. If you have a depth of 0 the fog come right up to the camera. If you push it back 10000, it goes back a ways, and set it 30000 or so it goes all the way back.
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I tried your code..and I have the same "problem"...
<br/>
<br/>
What I want is basicly this
<br/>
<br/>
The Camera is at distance 0
<br/>
<br/>
THe Fog should start at offset 100 ..so the coloring of the vertex with the fog density should start at 100
<br/>
<br/>
What I have now is ...the coloring starts allways at 0
<br/>
<br/>
If I apply glFogDepth(100) this doesnot work ...maybe I have to convert the value 100 to DS fixpoint and feed glFogDepth() with this value?!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#138382 - kusma - Thu Aug 23, 2007 1:40 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>a128 wrote:</b></span></td> </tr> <tr> <td class="quote">THe Fog should start at offset 100 ..so the coloring of the vertex with the fog density should start at 100
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Try adjusting the fog-table.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#138543 - zeruda - Sat Aug 25, 2007 8:14 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>a128 wrote:</b></span></td> </tr> <tr> <td class="quote">If I apply glFogDepth(100) this doesnot work ...maybe I have to convert the value 100 to DS fixpoint and feed glFogDepth() with this value?!</td> </tr></table><span class="postbody">
<br/>
<br/>
Well I was using increments of 0x0100 whatever that translates to, just keep testing with bigger values.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#141614 - silent_code - Thu Sep 27, 2007 3:22 pm</h4>
    <div class="postbody"><span class="postbody">i've tested the code and the fog didn't show up, no matter what values i was setting. any special requirements? i use w buffering, but that shouldn't be a problem.
<br/>
<br/>
also, i'm calling update at the beginning of the frame and i've got the poly attribute set, as well as everything you've posted. still no fog.
<br/>
<br/>
?:^|
<br/>
<br/>
could you post some example, please? thanks!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#141685 - a128 - Fri Sep 28, 2007 8:19 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>silent_code wrote:</b></span></td> </tr> <tr> <td class="quote">i've tested the code and the fog didn't show up, no matter what values i was setting. any special requirements? i use w buffering, but that shouldn't be a problem.
<br/>
<br/>
also, i'm calling update at the beginning of the frame and i've got the poly attribute set, as well as everything you've posted. still no fog.
<br/>
<br/>
?:^|
<br/>
<br/>
could you post some example, please? thanks!</td> </tr></table><span class="postbody">
<br/>
<br/>
You must enable fog for each mesh......  Edit:and yes...test fog on hardware !
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">glPolyFmt(POLY_ALPHA(31) | POLY_FOG | ....); </td> </tr></table><span class="postbody"></span><span class="gensmall"><br/><br/>Last edited by a128 on Mon Oct 01, 2007 8:45 am; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#141741 - M3d10n - Sat Sep 29, 2007 1:49 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>silent_code wrote:</b></span></td> </tr> <tr> <td class="quote">i've tested the code and the fog didn't show up, no matter what values i was setting. any special requirements? i use w buffering, but that shouldn't be a problem.
<br/>
<br/>
also, i'm calling update at the beginning of the frame and i've got the poly attribute set, as well as everything you've posted. still no fog.
<br/>
<br/>
?:^|
<br/>
<br/>
could you post some example, please? thanks!</td> </tr></table><span class="postbody">
<br/>
<br/>
Are you testing on actual hardware? No$gba doesn't support fog whatsoever, and I didn't try fog code on other emulators.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#141888 - zeruda - Mon Oct 01, 2007 9:12 am</h4>
    <div class="postbody"><span class="postbody">Fogging does work to some extent on the ideas emulator.
<br/>
But anyway here is a full example with some fogging, I based it on the
<br/>
quads example in libnds examples.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#include &lt;nds.h&gt;
<br/>
<br/>
#define POLY_FOG  (1&lt;&lt;15)
<br/>
#define GL_FOG_SHIFT(n)   ((n)&lt;&lt;8)
<br/>
<br/>
#define GL_RDLINE_UNDERFLOW   (1&lt;&lt;12)
<br/>
#define GL_VERTEX_OVERFLOW    (1&lt;&lt;13)
<br/>
<br/>
#define GFX_FOG_COLOR   (*(vuint32*) 0x04000358)
<br/>
#define GFX_FOG_OFFSET  (*(vuint32*) 0x0400035C)
<br/>
#define GFX_FOG_TABLE   ((vuint8*)  0x04000360)
<br/>
<br/>
void Initialise()       // Initialise the DS into 3D mode and setup the camera
<br/>
{
<br/>
   powerON(POWER_ALL);
<br/>
   videoSetMode(MODE_0_3D);       // set mode 0, enable BG0 and set it to 3D
<br/>
   irqInit();                     // irqs are nice
<br/>
   irqEnable(IRQ_VBLANK);
<br/>
   glInit();
<br/>
<br/>
   glClearColor(10, 10, 10,31);   // BG must be opaque for AA to work
<br/>
   glClearPolyID(63);             // BG must have a unique polygon ID for AA to work
<br/>
   glClearDepth(0x7FFF);
<br/>
<br/>
   glViewPort(0, 0, 255, 191);    // this should work the same as the normal gl call
<br/>
   glMatrixMode(GL_PROJECTION);   // Setup the camera
<br/>
   glLoadIdentity();
<br/>
   gluPerspective(35, 256.0 / 192.0, 0.1, 400);
<br/>
   gluLookAt(0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 1.0, 0.0);
<br/>
   glMatrixMode(GL_MODELVIEW);
<br/>
}
<br/>
<br/>
void DrawQuad() // Draws a quad. Honest.
<br/>
{
<br/>
    glColor3b(255,255,255);
<br/>
    glBegin(GL_QUAD);
<br/>
        glVertex3v16(inttov16(-1),inttov16(-1),0);
<br/>
        glVertex3v16(inttov16(1), inttov16(-1), 0);
<br/>
        glVertex3v16(inttov16(1), inttov16(1), 0);
<br/>
        glVertex3v16(inttov16(-1), inttov16(1), 0);
<br/>
    glEnd();
<br/>
}
<br/>
<br/>
void glFogColor(u8 red, u8 green, u8 blue, u8 alpha)
<br/>
{
<br/>
    GFX_FOG_COLOR = (red) | ((green) &lt;&lt; 5) | ((blue) &lt;&lt; 10) | ((alpha) &lt;&lt; 16);
<br/>
}
<br/>
<br/>
void UpdateFog()
<br/>
{
<br/>
    glFogColor(1, 1, 21, 31);   // The colour of the fog in rgba except the alpha does nothing
<br/>
    GFX_FOG_OFFSET = 60032;     // This is the fog depth as in how far back the fog starts
<br/>
    for (int i = 0; i &lt; 32; i++) { GFX_FOG_TABLE[i] = (i &lt;&lt; 2); } // Overall Heavyness of fog
<br/>
<br/>
    GFX_CONTROL = GL_FOG | GL_FOG_SHIFT(2) | GL_RDLINE_UNDERFLOW |  // Shift is the fog gradient
<br/>
                GL_VERTEX_OVERFLOW | GL_TEXTURE_2D | GL_BLEND;
<br/>
}
<br/>
<br/>
void Input(float &amp;XPos, float &amp;ZPos)
<br/>
{
<br/>
    scanKeys();
<br/>
    u16 keys = keysHeld();
<br/>
    if((keys &amp; KEY_UP)) { ZPos += 0.02; }
<br/>
    if((keys &amp; KEY_DOWN)) { ZPos -= 0.02; }
<br/>
    if((keys &amp; KEY_LEFT)) { XPos += 0.02; }
<br/>
    if((keys &amp; KEY_RIGHT)) { XPos -= 0.02; }
<br/>
}
<br/>
<br/>
int main()
<br/>
{
<br/>
    float XPos = 0;
<br/>
    float ZPos = 0;
<br/>
    Initialise();
<br/>
    UpdateFog(); // Setup the fog
<br/>
    
<br/>
    while(1) {
<br/>
        Input(XPos, ZPos);  // update the camera position
<br/>
        glPushMatrix();
<br/>
            glTranslate3f32(floattof32(XPos), 0, floattof32(ZPos-3)); // move camera away
<br/>
            glPolyFmt(POLY_ALPHA(31) | POLY_CULL_NONE); // Draw without any fogging
<br/>
            DrawQuad();
<br/>
            
<br/>
            glTranslate3f32(floattof32(3), 0, floattof32(-3));
<br/>
            glPolyFmt(POLY_ALPHA(31) | POLY_CULL_NONE | POLY_FOG); // Start drawing with fogging
<br/>
            for (int i = 0; i &lt; 10; i++) {
<br/>
                DrawQuad();
<br/>
                glTranslate3f32(floattof32(1), 0, floattof32(3));
<br/>
            }
<br/>
        glPopMatrix(1);
<br/>
        glFlush(0);
<br/>
        swiWaitForVBlank();
<br/>
    }
<br/>
}</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#141892 - silent_code - Mon Oct 01, 2007 10:19 am</h4>
    <div class="postbody"><span class="postbody">thanks for the code!
<br/>
<br/>
btw: yes, i'm *obviously* &lt;joking&gt; testing on hardware (i wouln't have made the shadow volume demo with emulators ;^P) - no, really, i do. if no$ isn't complaining, i'm burning it and testing on hw.
<br/>
<br/>
i've got it to "work" in the meantime. "work", because it was working all the time, only i had to put some *odd* numbers for shift and mass to actually see the effect. i think shift of 9 (anything higher lower would result in no / subtle fog) and mass of 2++. that's why my previous attempts to fog failed... silly stuff.
<br/>
<br/>
now that it works, i have another problem. the fog seems to stop at some point and "restart", means it's repeading the fog table instead of clamping it. well, that may be cause by the shift value or what so ever, maybe i'm using some kind of uncommon coordinate granuality [what the hell did i just write? ;^p]... i have to investigate a bit further. in fact, it's just my shadow volume demo (there it is again) i've added it to. as i've added motion blur, i had to drastically decrease some values, not just adjust them. it was kind of from .4 to .001, so maybe my meshes are a bit too "tight"? really strange stuff.
<br/>
<br/>
again, thanks for the help. :^D</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#141905 - DiscoStew - Mon Oct 01, 2007 2:21 pm</h4>
    <div class="postbody"><span class="postbody">FORGET THIS POST!
<br/>
<br/>
Early in the morning, I had very little time before I had to leave for my first class, and when I looked at this line, my brain clicked as if something was amiss there, when in fact it really wasn't. In my mind, I was going by the last result per loop being shifted, such that when i = 1, the result was 4, but when i = 2, the result was 16 (when shifting 4 to the left twice). So, I thought I found the problem involving a "reset" of the fog from the bits getting shifted outside the 32-bit value, when in fact I wasn't even close. So anyone who raised an eyebrow at my post, you had a good reason to. So to conclude........don't program when your brain is not functioning correctly. Wait to get some coffee first.
<br/>
<br/>
<br/>
------------------------------------------
<br/>
<br/>
Original post.....
<br/>
<br/>
Though I haven't actually tried doing any fog, I was looking at that code, and I saw this line...
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">for (int i = 0; i &lt; 32; i++) { GFX_FOG_TABLE[i] = (i &lt;&lt; 2); } // Overall Heavyness of fog </td> </tr></table><span class="postbody">
<br/>
<br/>
If you are using this code in your demo, it would possibly explain why it "restarts", as when 'i' gets to 16, the value to be put in already exceeds what a 32-bit value can hold, so I assume it copies only the lower 32-bits, meaning it would start at 0 again, and work it's way up. If you want to clamp it to the max, then in this particular situation, loop 16 times, and then filling in the remaining table with the max 32-bit value.<br/>_________________<br/><span style="font-weight: bold">DS</span> - It's all about <span style="font-weight: bold">D</span>isco<span style="font-weight: bold">S</span>tew</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#141974 - silent_code - Tue Oct 02, 2007 6:06 pm</h4>
    <div class="postbody"><span class="postbody">that *would* have made sense, but it repeats *periodically*. that means the  fog table is repeated after a certain depth offset, again and again, untill the geometry gets clipped by the far plane.
<br/>
unfortunately i didn't have time to get back to the code. :^C</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
