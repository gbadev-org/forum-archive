<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>GnM DLDI, libFAT, and/or libNDS is (not) broken. - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>DS development > GnM DLDI, libFAT, and/or libNDS is (not) broken.</h2>
<div id="posts">
<div class="post">
    <h4>#153630 - HyperHacker - Thu Apr 03, 2008 5:45 am</h4>
    <div class="postbody"><span class="postbody">I don't know if people have been just not seeing my <a class="postlink" href="http://forum.gbadev.org/viewtopic.php?p=151678#151678" target="_blank">posts</a> or ignoring them or what but one of these things is definitely broken.
<br/>
<br/>
The hardware all works fine; I've tested on 2 different DSes (DS and DS Lite) with 2 different MicroSD cards (the included one and a 2GB Kingston) and 2 different GnMs, and have tried both DLDI patches.
<br/>
<br/>
<a class="postlink" href="http://hyperhacker.no-ip.org/b/gmtest.zip" target="_blank">This</a> is a simple test case. Since the ARM9 code is ~12 lines (excluding comments and whitespace) and the ARM7 code is a simple infinite loop I am <span style="font-weight: bold">extremely</span> doubtful it has a bug. I used a zip file to preserve the directory structure, makefile etc but the relevant code fits nicely in this post:
<br/>
<br/>
ARM9:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">int main(int argc, char** argv)
<br/>
{
<br/>
   //sysSetBusOwners(true, true);
<br/>
   //REG_IME = 0;
<br/>
<br/>
   videoSetMode(MODE_0_2D | DISPLAY_BG0_ACTIVE);
<br/>
   vramSetMainBanks(VRAM_A_MAIN_BG_0x06000000, VRAM_B_LCD,
<br/>
      VRAM_C_LCD, VRAM_D_LCD);
<br/>
<br/>
   BG0_CR = BG_TILE_BASE(1) | BG_MAP_BASE(1);
<br/>
   BG0_X0 = -1;
<br/>
   BG0_Y0 = -1;
<br/>
   BG_PALETTE[0] = RGB15(31, 0, 0);
<br/>
<br/>
   do {
<br/>
      swiWaitForVBlank();
<br/>
   } while(!fatInitDefault());
<br/>
<br/>
   BG_PALETTE[0] = RGB15(0, 31, 0);
<br/>
<br/>
   while(true) swiWaitForVBlank();
<br/>
   return 0;
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
ARM7:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">int main(int argc, char** argv)
<br/>
{
<br/>
   while(true) swiWaitForVBlank();
<br/>
   return 0;
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
It simply turns one screen red, calls fatInitDefault() in a loop, and if it succeeds, turns the screen green and loops forever. It never succeeds.
<br/>
<br/>
<br/>
The problem is not as simple as "will not mount", though. <span style="font-style: italic">This</span> app won't mount. However, others do with varying degrees of success.
<br/>
<br/>
The app I'm working on now: At first it wouldn't mount at all. Then it randomly would. Now it does every time (though sometimes taking several seconds) but stat() hangs. Previously it was returning -1, which is not an error code I could find anywhere, now it just doesn't return at all.
<br/>
<br/>
The boot menu included with Chishm's loader: Works fine.
<br/>
<br/>
LMP v1.02: Was working fine, but recently has been freezing at random. Sometimes after hours, sometimes after one second. It never did this on GBAMP.
<br/>
<br/>
Every app randomly takes between ~1 and ~15 seconds to mount.
<br/>
<br/>
<br/>
Now there's an obvious pattern here:
<br/>
1) My app is compiled with the latest versions of libFAT and libNDS, and it works, but stat() hangs.
<br/>
2) The test case also uses the latest versions, and does almost nothing, and it doesn't work at all.
<br/>
3) LMP uses older versions, and it works but randomly crashes.
<br/>
4) Chishm's menu uses older versions (most likely not the same as LMP), and it works.
<br/>
<br/>
My guess is that some routine has changed and the DLDIs don't like it (leaving the hardware in an unexpected state or something), and that most every app calls this routine at least once. Though I've tried twiddling various bits in REG_EXMEMCNT to no avail.
<br/>
<br/>
I haven't been changing much of anything. Basically just adding on-screen debug output to the app to see what's going on. One or two files on the card get modified every now and then. In other words the effects seem to be fairly random.
<br/>
<br/>
<br/>
Is nobody else having these problems? Am I the only one using this crappy card? Am I invisible?
<br/>
<br/>
[edit] Yeah, the test program works fine after fixing the <span style="font-style: italic">glaringly obvious</span> bug that I can't believe nobody else pointed out. -_-; *hangs head in shame for not seeing that sooner* Even stat() works fine there. Time to figure out who's stomping my memory.<br/>_________________<br/>I'm a PSP hacker now, but I still &lt;3 DS.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
