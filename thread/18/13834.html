<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Can the arm7 play MIDI files? - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > Can the arm7 play MIDI files?</h2>
<div id="posts">
<div class="post">
    <h4>#136413 - Lazy1 - Wed Aug 01, 2007 2:21 pm</h4>
    <div class="postbody"><span class="postbody">I know moonshell can run timidity but that is on the arm9, is there enough speed and memory on the arm7 to do this?
<br/>
I have recently found out that the guy who made the music for wolf3d has released several midis which sound MUCH better than the old adlib versions.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#136423 - Sunray - Wed Aug 01, 2007 4:13 pm</h4>
    <div class="postbody"><span class="postbody">Well, most commercial GBA games use midi-like music. Running on an ARM7 at haft the speed.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#136432 - Lazy1 - Wed Aug 01, 2007 7:32 pm</h4>
    <div class="postbody"><span class="postbody">I'm not sure that is the same thing though.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#136447 - tepples - Wed Aug 01, 2007 9:55 pm</h4>
    <div class="postbody"><span class="postbody">Yes, it would be straightforward to write a MIDI interpreter and run it on the ARM7 <span style="font-style: italic">if</span> you have a suitably licensed sample bank.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#136453 - Lazy1 - Wed Aug 01, 2007 10:59 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tepples wrote:</b></span></td> </tr> <tr> <td class="quote">Yes, it would be straightforward to write a MIDI interpreter and run it on the ARM7 <span style="font-style: italic">if</span> you have a suitably licensed sample bank.</td> </tr></table><span class="postbody">
<br/>
<br/>
I don't like the sound of that, or understand it.
<br/>
Is more text going to keep me from using midi music?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#136454 - tepples - Wed Aug 01, 2007 11:14 pm</h4>
    <div class="postbody"><span class="postbody">A sample bank is a set of wave files that represent the sounds that the DS is supposed to play when processing a NoteOn event in MIDI. For instance, you might have samples of notes being played on a piano, a bass guitar, a violin, etc. Most people do not both own and know how to play these instruments, so they rely on third-party sample banks.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#136458 - Lazy1 - Thu Aug 02, 2007 12:40 am</h4>
    <div class="postbody"><span class="postbody">I see...
<br/>
The trouble is that I have no idea about audio programming so writing a midi interpreter is way out of my skill level.
<br/>
Does one already exist that will run on the arm7, and is there enough memory for all of the needed samples along with a running game?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#136466 - tepples - Thu Aug 02, 2007 2:12 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Lazy1 wrote:</b></span></td> </tr> <tr> <td class="quote">I see...
<br/>
The trouble is that I have no idea about audio programming</td> </tr></table><span class="postbody">
<br/>
It's not hard to learn, just as you might have learned graphics programming. There are 16 voices; each has a set of audio registers. You write the starting address of wave data, the length of the data, the pitch, and the volume, and the DS handles the rest. It's a lot like OAM, just out of the speakers.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">is there enough memory for all of the needed samples along with a running game?</td> </tr></table><span class="postbody">
<br/>
If you load only those instruments and sound effects that your current scene uses, there should be no problem. Case in point: commercial DS games work.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#136469 - Lazy1 - Thu Aug 02, 2007 3:20 am</h4>
    <div class="postbody"><span class="postbody">Ok, I see now...
<br/>
But if I need 16 channels for MIDI, what will I do since the game needs two channels for sound effects.
<br/>
<br/>
Unless not all channels are used?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#136470 - tepples - Thu Aug 02, 2007 4:02 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Lazy1 wrote:</b></span></td> </tr> <tr> <td class="quote">But if I need 16 channels for MIDI</td> </tr></table><span class="postbody">
<br/>
A lot of tunes use only 8 channels. One trick is to define an instrument that contains a chord, so that you can use 1 channel instead of 3. A lot of music from the 4-channel MOD era does this.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">what will I do since the game needs two channels for sound effects.</td> </tr></table><span class="postbody">
<br/>
Kill the two quietest notes.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#136473 - zefrench - Thu Aug 02, 2007 4:32 am</h4>
    <div class="postbody"><span class="postbody">So far the only suitable librairies I can find are:
<br/>
<br/>
WildMidi <a class="postlink" href="http://sourceforge.net/projects/wildmidi/" target="_blank">http://sourceforge.net/projects/wildmidi/</a>
<br/>
<br/>
 and libTiMidity <a class="postlink" href="http://sourceforge.net/projects/libtimidity/" target="_blank">http://sourceforge.net/projects/libtimidity/</a>
<br/>
<br/>
<br/>
Neither have been ported  to Nintendo DS
<br/>
<br/>
Low quality alternative is MidiKey2Freq 
<br/>
<br/>
MoonShell has a MIDI plugin, not usre how usable that would be (midrcp plugin source ).
<br/>
<br/>
Nice post of an ARM7 based mp3 player at
<br/>
<a class="postlink" href="http://forum.gbadev.org/viewtopic.php?t=13448&amp;postdays=0&amp;postorder=asc&amp;highlight=midi&amp;start=15" target="_blank">http://forum.gbadev.org/viewtopic.php?t=13448&amp;postdays=0&amp;postorder=asc&amp;highlight=midi&amp;start=15</a>
<br/>
<br/>
Another alternative is using the hardware base sound compression  using sound compressed using  ima-adpcm (usallually does nto soudn so well on a desktop, but typically sound just fine on the DS tiny speaker)
<br/>
<br/>
<a href="http://nocash.emubase.de/gbatek.htm#dssound" target="_blank">http://nocash.emubase.de/gbatek.htm#dssound</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#136503 - kusma - Thu Aug 02, 2007 12:19 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tepples wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">what will I do since the game needs two channels for sound effects.</td> </tr></table><span class="postbody">
<br/>
Kill the two quietest notes.</span></td> </tr></table><span class="postbody">
<br/>
Uh, I'd probably try a bit better heuristic than that, you might end up killing notes that are early in the attack-part of it's envelope.
<br/>
<a href="http://www.kebby.org/articles/fr08snd4.html" target="_blank">http://www.kebby.org/articles/fr08snd4.html</a> has a slightly better approach in  section 4.4.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#136562 - tepples - Thu Aug 02, 2007 9:22 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>kusma wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tepples wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">what will I do since the game needs two channels for sound effects.</td> </tr></table><span class="postbody">
<br/>
Kill the two quietest notes.</span></td> </tr></table><span class="postbody">
<br/>
Uh, I'd probably try a bit better heuristic than that, you might end up killing notes that are early in the attack-part of it's envelope.</span></td> </tr></table><span class="postbody">
<br/>
I hadn't thought about that. Most of the attacks in my music engines are part of the wave, not part of some external envelope.
<br/>
<br/>
Or you could use a music format like S3M or XM, which gives the music a fixed number of channels (e.g. 8) and has the composer perform voice allocation.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#136590 - Lazy1 - Fri Aug 03, 2007 12:52 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tepples wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
Or you could use a music format like S3M or XM, which gives the music a fixed number of channels (e.g. 8) and has the composer perform voice allocation.</td> </tr></table><span class="postbody">
<br/>
<br/>
I am 100% sure that is not an option, any chance on timidity though?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#136591 - zefrench - Fri Aug 03, 2007 1:43 am</h4>
    <div class="postbody"><span class="postbody">If you post the location of the midi files in questions, I can play them on a good MIDI player and then incode them in acpm and let you listen to them if you are interested,</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#136594 - Lazy1 - Fri Aug 03, 2007 2:08 am</h4>
    <div class="postbody"><span class="postbody">RAW Sounds are too large, especially when there are 27 tracks.
<br/>
<br/>
[Edit]
<br/>
Fair enough, ADPCM seems to compress fairly well at 32768Hz.
<br/>
<br/>
I have the tools to convert imf to raw, what would I need to get a DS compatible ADPCM file and what is the best way to stream it from disk?
<br/>
<br/>
[Edit again]
<br/>
Ok, two conversion utilities failed...
<br/>
<br/>
1) sox produces broken output on the ds
<br/>
2) audacity forces the output to 44100Hz
<br/>
<br/>
I need a utility that can convert to adpcm, works on linux and can do batch jobs.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#136609 - thegamefreak0134 - Fri Aug 03, 2007 5:28 am</h4>
    <div class="postbody"><span class="postbody">On your MIDI channel issue, I can't honestly think of any music that I have written that uses more than 16 notes at once. I also can't see the point in having something that does so, unless you need an echo effect, which you can fake once again by using an echoing sample to save channels.
<br/>
<br/>
Don't confuse the 16 channels of MIDI with the 16 channels on the DS. The channels on a standard midi controller can usually play more than one note at once, and in fact you are more limited in the number of instruments you can have going at once than you are in the number of notes. The DS is a different beast, in a way. Each channel is only capable (without mixing software, easy to write, but unnecessary in most cases) of playing one sample (note) at once. As such, when a MIDI interpreter comes across a chord in a MIDI channel, it should split it into 3 separate channels and use the first ones available. This means that a composer of music in this format would only have to be careful about not using more than 16 (or less, if you need SFX) notes at once, not necessarily more than 16 tracks. 
<br/>
<br/>
Personally, my music often ends up having more than 16 "tracks" with shared channels, mainly because I can't handle percussion on only one staff when I compose in MIDI. Since the most standard midi file will split the notes up by track, you would have instances where you have more tracks than the DS has channels, even if not all of them are being used at the same time.
<br/>
<br/>
---
<br/>
<br/>
Lazy 1, you posted right after I hit reply. Odd... I just read your most recent post.
<br/>
<br/>
32768Hz seems like an awfully high sample rate for a DS game. Remember that your engine will likely send most of it's output to the DS's speakers. Although considerably better than other handheld's speakers, they still aren't that great, and a lower sample rate would hardly be noticed, I think, especially for certain instruments. Of course, if you must, you must.
<br/>
<br/>
I'm afraid I cannot help you terribly on the tools issue though, I haven't delved terribly into DS sound personally, I just understand it. I've only used the RAW format myself.
<br/>
<br/>
In any case, good luck. Oh, and members feel free to correct me, it's late and I'm sure I have made more than one error in my sleepiness. ^_^
<br/>
<br/>
-gamefreak<br/>_________________<br/>What if the hokey-pokey really is what it's all about?
<br/>
<br/>
[url=http:/www.darknovagames.com/index.php?action=recruit&amp;clanid=1]Support Zeta on DarkNova![/url]</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#136645 - Lazy1 - Fri Aug 03, 2007 3:07 pm</h4>
    <div class="postbody"><span class="postbody">Ok, 22050Hz gives nice audio quality with a small file size. (just under 700KB for 57s)
<br/>
I finally figured out how to get audacity to export at the right sample rate and using the ima2raw converter posted on here it plays perfectly on the DS.
<br/>
<br/>
All I need now is to implement streaming the music from disk and finding an application to convert the audio to adpcm from the command line.
<br/>
<br/>
[EDIT]
<br/>
FFMPEG Seems to provide DS compatible IMA-ADPCM audio.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#136821 - Lazy1 - Sun Aug 05, 2007 5:59 pm</h4>
    <div class="postbody"><span class="postbody">Sorry to bump but I cannot get streaming from disk to work, are there any existing examples of streaming raw adpcm audio?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#137188 - Lazy1 - Wed Aug 08, 2007 6:45 pm</h4>
    <div class="postbody"><span class="postbody">Maybe it would help if I provided code?
<br/>
<br/>
ipcsound.h
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#ifndef _IPCSOUND_H_
<br/>
#define _IPCSOUND_H_
<br/>
<br/>
#define MusicChunkSize ( 65535 )
<br/>
<br/>
typedef struct {
<br/>
   volatile int Arm9StartMusic;
<br/>
   volatile int Arm9StopMusic;
<br/>
   volatile int Arm9Busy;
<br/>
<br/>
   volatile int Arm7RequestBufferFill;
<br/>
   volatile int Arm7Busy;
<br/>
<br/>
   volatile void* Buffer;
<br/>
   volatile int Length;
<br/>
   volatile int Rate;
<br/>
<br/>
   volatile int Segment;
<br/>
} MusicCommand;
<br/>
<br/>
#define MusicControl ( *( ( volatile MusicCommand* ) IPC + sizeof( TransferRegion ) ) )
<br/>
<br/>
#endif
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
arm9/source/main.c
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#include &lt;nds.h&gt;
<br/>
#include &lt;fat.h&gt;
<br/>
#include &lt;stdio.h&gt;
<br/>
#include "../../ipcsound.h"
<br/>
<br/>
volatile char AudioBuffer[ MusicChunkSize * 2 ];
<br/>
FILE* MusicFile = NULL;
<br/>
<br/>
void InitMusicSystem( void ) {
<br/>
   MusicControl.Arm9StartMusic = 0;
<br/>
   MusicControl.Arm9StopMusic = 0;
<br/>
   MusicControl.Arm9Busy = 0;
<br/>
   MusicControl.Arm7RequestBufferFill = 0;
<br/>
   MusicControl.Arm7Busy = 0;
<br/>
   MusicControl.Buffer = ( void* ) 0;
<br/>
   MusicControl.Length = 0;
<br/>
   MusicControl.Rate = 0;
<br/>
   MusicControl.Segment = 0;
<br/>
}
<br/>
<br/>
void UpdateMusicSystem( void ) {
<br/>
   char* ReadPosition = NULL;
<br/>
   int BytesRead = 0;
<br/>
<br/>
   if ( MusicControl.Arm7RequestBufferFill == 1 ) {
<br/>
      MusicControl.Arm7RequestBufferFill = 0;
<br/>
      MusicControl.Arm7Busy = 0;
<br/>
<br/>
      switch ( MusicControl.Segment ) {
<br/>
         case 0:
<br/>
            ReadPosition = ( char* ) &amp;AudioBuffer[ 0 ];
<br/>
            break;
<br/>
         case 1:
<br/>
            ReadPosition = ( char* ) &amp;AudioBuffer[ MusicChunkSize ];
<br/>
            break;
<br/>
         default:
<br/>
            break;
<br/>
      };
<br/>
<br/>
      if ( feof( MusicFile ) )
<br/>
         fseek( MusicFile, 0, SEEK_SET );
<br/>
<br/>
      if ( ( BytesRead = fread( ReadPosition, 1, MusicChunkSize, MusicFile ) ) &lt; MusicChunkSize ) {
<br/>
         ReadPosition+= BytesRead;
<br/>
<br/>
         fseek( MusicFile, 0, SEEK_SET );
<br/>
         fread( ReadPosition, 1, MusicChunkSize - BytesRead, MusicFile );
<br/>
      }
<br/>
<br/>
      printf( "ARM7: More data needed! Reading to segment %d\n", MusicControl.Segment );
<br/>
   }
<br/>
}
<br/>
<br/>
int main( void ) {
<br/>
   powerON( POWER_ALL_2D | POWER_SWAP_LCDS );
<br/>
<br/>
   irqInit( );
<br/>
   irqEnable( IRQ_VBLANK );
<br/>
<br/>
   InitMusicSystem( );
<br/>
   consoleDemoInit( );
<br/>
<br/>
   fatInitDefault( );
<br/>
<br/>
   if ( ( MusicFile = fopen( "roster.adpcm.bin", "r" ) ) != NULL ) {
<br/>
      fread( AudioBuffer, 1, MusicChunkSize * 2, MusicFile );
<br/>
      printf( "It begins...\n" );
<br/>
<br/>
      MusicControl.Buffer = ( void* ) AudioBuffer;
<br/>
      MusicControl.Length = MusicChunkSize * 2;
<br/>
      MusicControl.Arm9StartMusic = 1;
<br/>
   }
<br/>
<br/>
   while ( 1 ) {
<br/>
      swiWaitForVBlank( );
<br/>
      UpdateMusicSystem( );
<br/>
   }
<br/>
<br/>
   return 0;
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
arm7/source/template.c
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#include &lt;nds.h&gt;
<br/>
#include &lt;stdlib.h&gt;
<br/>
#include "../../ipcsound.h"
<br/>
<br/>
//---------------------------------------------------------------------------------
<br/>
void startSound(int sampleRate, const void* data, u32 bytes, u8 channel, u8 vol,  u8 pan, u8 format) {
<br/>
//---------------------------------------------------------------------------------
<br/>
   SCHANNEL_TIMER(channel)  = SOUND_FREQ(sampleRate);
<br/>
   SCHANNEL_SOURCE(channel) = (u32)data;
<br/>
   SCHANNEL_LENGTH(channel) = bytes &gt;&gt; 2 ;
<br/>
   SCHANNEL_CR(channel)     = SCHANNEL_ENABLE | SOUND_ONE_SHOT | SOUND_VOL(vol) | SOUND_PAN(pan) | (format==1?SOUND_8BIT:SOUND_16BIT);
<br/>
}
<br/>
<br/>
<br/>
//---------------------------------------------------------------------------------
<br/>
s32 getFreeSoundChannel() {
<br/>
//---------------------------------------------------------------------------------
<br/>
   int i;
<br/>
   for (i=1; i&lt;16; i++) {
<br/>
      if ( (SCHANNEL_CR(i) &amp; SCHANNEL_ENABLE) == 0 ) return i;
<br/>
   }
<br/>
   return -1;
<br/>
}
<br/>
<br/>
int vcount;
<br/>
touchPosition first,tempPos;
<br/>
<br/>
//---------------------------------------------------------------------------------
<br/>
void VcountHandler() {
<br/>
//---------------------------------------------------------------------------------
<br/>
   static int lastbut = -1;
<br/>
   
<br/>
   uint16 but=0, x=0, y=0, xpx=0, ypx=0, z1=0, z2=0;
<br/>
<br/>
   but = REG_KEYXY;
<br/>
<br/>
   if (!( (but ^ lastbut) &amp; (1&lt;&lt;6))) {
<br/>
 
<br/>
      tempPos = touchReadXY();
<br/>
<br/>
      if ( tempPos.x == 0 || tempPos.y == 0 ) {
<br/>
         but |= (1 &lt;&lt;6);
<br/>
         lastbut = but;
<br/>
      } else {
<br/>
         x = tempPos.x;
<br/>
         y = tempPos.y;
<br/>
         xpx = tempPos.px;
<br/>
         ypx = tempPos.py;
<br/>
         z1 = tempPos.z1;
<br/>
         z2 = tempPos.z2;
<br/>
      }
<br/>
      
<br/>
   } else {
<br/>
      lastbut = but;
<br/>
      but |= (1 &lt;&lt;6);
<br/>
   }
<br/>
<br/>
   if ( vcount == 80 ) {
<br/>
      first = tempPos;
<br/>
   } else {
<br/>
      if (   abs( xpx - first.px) &gt; 10 || abs( ypx - first.py) &gt; 10 ||
<br/>
            (but &amp; ( 1&lt;&lt;6)) ) {
<br/>
<br/>
         but |= (1 &lt;&lt;6);
<br/>
         lastbut = but;
<br/>
<br/>
      } else {    
<br/>
         IPC-&gt;mailBusy = 1;
<br/>
         IPC-&gt;touchX         = x;
<br/>
         IPC-&gt;touchY         = y;
<br/>
         IPC-&gt;touchXpx      = xpx;
<br/>
         IPC-&gt;touchYpx      = ypx;
<br/>
         IPC-&gt;touchZ1      = z1;
<br/>
         IPC-&gt;touchZ2      = z2;
<br/>
         IPC-&gt;mailBusy = 0;
<br/>
      }
<br/>
   }
<br/>
   IPC-&gt;buttons      = but;
<br/>
   vcount ^= (80 ^ 130);
<br/>
   SetYtrigger(vcount);
<br/>
<br/>
}
<br/>
<br/>
//---------------------------------------------------------------------------------
<br/>
void VblankHandler(void) {
<br/>
//---------------------------------------------------------------------------------
<br/>
   u32 i;
<br/>
<br/>
<br/>
   //sound code  :)
<br/>
   TransferSound *snd = IPC-&gt;soundData;
<br/>
   IPC-&gt;soundData = 0;
<br/>
<br/>
   if (0 != snd) {
<br/>
<br/>
      for (i=0; i&lt;snd-&gt;count; i++) {
<br/>
         s32 chan = getFreeSoundChannel();
<br/>
<br/>
         if (chan &gt;= 0) {
<br/>
            startSound(snd-&gt;data[i].rate, snd-&gt;data[i].data, snd-&gt;data[i].len, chan, snd-&gt;data[i].vol, snd-&gt;data[i].pan, snd-&gt;data[i].format);
<br/>
         }
<br/>
      }
<br/>
   }
<br/>
}
<br/>
<br/>
void IRQTimer1( void ) {
<br/>
   static int Segment = 0;
<br/>
<br/>
   switch ( Segment ) {
<br/>
      case 0:
<br/>
         // Fill the 1st segment
<br/>
         MusicControl.Segment = 0;
<br/>
         MusicControl.Arm7RequestBufferFill = 1;
<br/>
         MusicControl.Arm7Busy = 1;
<br/>
         break;
<br/>
      case 1:
<br/>
         // Fill the 2nd segment
<br/>
         MusicControl.Segment = 1;
<br/>
         MusicControl.Arm7RequestBufferFill = 1;
<br/>
         MusicControl.Arm7Busy = 1;
<br/>
         break;
<br/>
      default:
<br/>
         break;
<br/>
   }
<br/>
<br/>
   SCHANNEL_LENGTH( 0 ) = MusicChunkSize &gt;&gt; 2;
<br/>
<br/>
   Segment = ! Segment;
<br/>
}
<br/>
<br/>
//---------------------------------------------------------------------------------
<br/>
int main(int argc, char ** argv) {
<br/>
//---------------------------------------------------------------------------------
<br/>
   MusicControl.Arm9StartMusic = 0;
<br/>
   MusicControl.Arm9StopMusic = 0;
<br/>
   MusicControl.Arm9Busy = 0;
<br/>
   MusicControl.Arm7RequestBufferFill = 0;
<br/>
   MusicControl.Arm7Busy = 0;
<br/>
   MusicControl.Buffer = ( void* ) 0;
<br/>
   MusicControl.Length = 0;
<br/>
   MusicControl.Rate = 0;
<br/>
   MusicControl.Segment = 0;
<br/>
<br/>
   // Reset the clock if needed
<br/>
   rtcReset();
<br/>
<br/>
   //enable sound
<br/>
   powerON(POWER_SOUND);
<br/>
   SOUND_CR = SOUND_ENABLE | SOUND_VOL(0x7F);
<br/>
   IPC-&gt;soundData = 0;
<br/>
<br/>
   irqInit();
<br/>
   irqSet(IRQ_VBLANK, VblankHandler);
<br/>
   SetYtrigger(80);
<br/>
   vcount = 80;
<br/>
   irqSet(IRQ_VCOUNT, VcountHandler);
<br/>
   irqSet( IRQ_TIMER1, IRQTimer1 );
<br/>
   irqEnable(IRQ_VBLANK | IRQ_VCOUNT | IRQ_TIMER1);
<br/>
<br/>
   // Keep the ARM7 idle
<br/>
   while ( 1 ) {
<br/>
      swiWaitForVBlank( );
<br/>
<br/>
      if ( MusicControl.Arm9StartMusic == 1 ) {
<br/>
         SCHANNEL_TIMER( 0 ) = SOUND_FREQ( 22050 );
<br/>
         SCHANNEL_SOURCE( 0 ) = ( u32 ) MusicControl.Buffer;
<br/>
         SCHANNEL_LENGTH( 0 ) = ( u32 ) MusicControl.Length &gt;&gt; 2;
<br/>
         SCHANNEL_REPEAT_POINT( 0 ) = ( u32 ) 0;
<br/>
         SCHANNEL_CR( 0 ) = SCHANNEL_ENABLE | SOUND_VOL( 0x7F ) | SOUND_PAN( 63 ) | SOUND_REPEAT | SOUND_FORMAT_ADPCM;
<br/>
   
<br/>
         TIMER0_DATA = TIMER_FREQ( 22050 ) * 2;
<br/>
         TIMER0_CR = TIMER_DIV_1 | TIMER_ENABLE;
<br/>
   
<br/>
         TIMER1_DATA = 0x10000 - 65535;
<br/>
         TIMER1_CR = TIMER_CASCADE | TIMER_IRQ_REQ | TIMER_ENABLE;
<br/>
<br/>
         MusicControl.Arm9StartMusic = 0;
<br/>
      }
<br/>
   }
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I obviously have no idea what I'm doing :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#137423 - Diddl - Sat Aug 11, 2007 6:39 pm</h4>
    <div class="postbody"><span class="postbody">I know you want to implement music with a sampled variant. The better way would be to play this midi data in the WL6 files. So no other files are required for playing wolf3d and no audio rights are broken.
<br/>
<br/>
<br/>
I have found a IMF player source here: <a class="postlink" href="http://www.stud.uni-karlsruhe.de/~uvaue/chaos/downloads.html" target="_blank">click</a>
<br/>
<br/>
IMF is the music data format from wolfenstein WL3 and WL6 files. The format is very midi like but is special for this OPL chip within Adlib sound cards (fm synthese).
<br/>
<br/>
<br/>
Additionally I found a Source for an OPL emulator: <a class="postlink" href="http://bisqwit.iki.fi/source/opl3emu.html" target="_blank">click</a>
<br/>
<br/>
Both source codes would it do. We could play music directly like original Wolfenstein 3d on an old PC.
<br/>
<br/>
Maybe a source of an NES emulator would also help, cause a NES also had a fm synthese audio chip with OPL2 support.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#137431 - Lazy1 - Sat Aug 11, 2007 8:20 pm</h4>
    <div class="postbody"><span class="postbody">The ARM7 does not have enough power to emulate the OPL2 chip, at least not without lots of optimizations that go way beyond my skill level.
<br/>
<br/>
There will be no licensing issues since the IMF utilities will be released as a separate package and require the user to do all of the converting.
<br/>
<br/>
RAW ADPCM audio works fine if it's loaded all into memory, however some songs are too large and must be streamed.
<br/>
Unfortunately I still cannot get this to work.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#137437 - tepples - Sat Aug 11, 2007 9:04 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Lazy1 wrote:</b></span></td> </tr> <tr> <td class="quote">The ARM7 does not have enough power to emulate the OPL2 chip, at least not without lots of optimizations that go way beyond my skill level.</td> </tr></table><span class="postbody">
<br/>
Then go for high level emulation. Recognize which instruments they're trying to make, and match them up to sampled instruments taken from some synthesizer's sound bank.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#137447 - Lazy1 - Sat Aug 11, 2007 9:45 pm</h4>
    <div class="postbody"><span class="postbody">That may be possible, but that may be for a later date.
<br/>
In the meantime adpcm audio should be fine for music, but I have no idea why streaming is not working properly.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#137499 - Diddl - Sun Aug 12, 2007 6:00 pm</h4>
    <div class="postbody"><span class="postbody">Streaming means, reading from SD card? I tought libfat also works for ARM7? In the libfat source are #ifdef ARM7 statements?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#137501 - Lazy1 - Sun Aug 12, 2007 6:49 pm</h4>
    <div class="postbody"><span class="postbody">I need libfat on the arm9 only, the problem is not access to the filesystem but when to load audio into the buffer.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#137516 - Diddl - Sun Aug 12, 2007 9:33 pm</h4>
    <div class="postbody"><span class="postbody">ARM9 could ARM7 give a path to a sound and ARM7 plays sound directly from this file?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#137518 - Lazy1 - Sun Aug 12, 2007 9:46 pm</h4>
    <div class="postbody"><span class="postbody">Both CPUs cannot use libfat at the same time (correction?) and Wolfenstein needs the ARM9 to load resources from disk.
<br/>
Even if I could get libfat on the ARM7 it would make no difference since the problem is knowing when to fill the buffer with audio.
<br/>
<br/>
I can think of two things that could be wrong:
<br/>
1) Timing is waaay off/incorrect
<br/>
2) The method I use is completely wrong</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#137522 - DekuTree64 - Sun Aug 12, 2007 10:44 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Lazy1 wrote:</b></span></td> </tr> <tr> <td class="quote">I can think of two things that could be wrong: 
<br/>
1) Timing is waaay off/incorrect 
<br/>
2) The method I use is completely wrong</td> </tr></table><span class="postbody">
<br/>
Or 3) all of the above :)
<br/>
<br/>
After a quick look at the code, I can see a couple things wrong with the timing. First, the sound channel eats data 4 bytes at a time, so a chunk size of 65535 won't work. Second, this bit of code:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">         TIMER0_DATA = TIMER_FREQ( 22050 ) * 2; 
<br/>
         TIMER0_CR = TIMER_DIV_1 | TIMER_ENABLE; 
<br/>
    
<br/>
         TIMER1_DATA = 0x10000 - 65535; 
<br/>
         TIMER1_CR = TIMER_CASCADE | TIMER_IRQ_REQ | TIMER_ENABLE; 
<br/>
</td> </tr></table><span class="postbody">
<br/>
I think should be using <span style="font-weight: bold">SOUND</span>_FREQ( 22050  ) * 2, to match timer0 exactly to the sound channel. Also, timer1's data should use the chunk size constant, because that 0x10000 - 65535 confused me at first :)
<br/>
<br/>
But even with that, it will not work. You can't stream ADPCM continuously, because when the channel loops back to the start of the buffer, it restores the ADPCM state from that time. So you basically have 2 options:
<br/>
1) Split the source data into frames, and restart the sound channel for each frame.
<br/>
2) Decode the chunk in software.
<br/>
<br/>
For the frame based method, the best I can think of is to write a little PC tool to run on the ADPCM file. Basically software-decode the whole thing, and poke in a word with the decoder state at the start of each frame in the compressed data. <a class="postlink" href="http://nocash.emubase.de/gbatek.htm#dssoundnotes" target="_blank">GBATek</a> has the format of the decoder state word.
<br/>
Then each time you refill the buffer and restart the sound channel, it will start up with whatever the decoder state should be at that point in the stream.<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#137523 - Lazy1 - Sun Aug 12, 2007 11:23 pm</h4>
    <div class="postbody"><span class="postbody">Thanks for all the information, I will try and write a software decoder and see how that goes :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#137603 - zefrench - Mon Aug 13, 2007 10:31 pm</h4>
    <div class="postbody"><span class="postbody">Maybe look at the source of Scummvm for DS?  AgentQ implemented acpm music playback from files located on a dldi based fat system, might be worth looking at since I beleive source code is what you are after.
<br/>
<br/>
ScummVM DS port 0.10.0a is the latest</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#137731 - Lazy1 - Wed Aug 15, 2007 3:11 am</h4>
    <div class="postbody"><span class="postbody">Couldn't I stream the audio data in, but instead of setting the channel to repeat I track the song length and restart the process manually when it ends?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#138433 - zefrench - Fri Aug 24, 2007 3:32 am</h4>
    <div class="postbody"><span class="postbody">Well I finally looked it up and here are the files I think you want to look at:
<br/>
<br/>
<br/>
scummvm-0.10.0a\backends\platform\ds\arm9\source\cdaudio.cpp
<br/>
<br/>
and
<br/>
<br/>
scummvm-0.10.0a\backends\platform\ds\arm7\source\main.cpp
<br/>
<br/>
<br/>
Search for "adpcm" in each file and you should find all the relevant functions.
<br/>
<br/>
<br/>
Source is located at <a class="postlink" href="http://prdownloads.sourceforge.net/scummvm/scummvm-0.10.0a.tar.bz2?download" target="_blank">http://prdownloads.sourceforge.net/scummvm/scummvm-0.10.0a.tar.bz2?download</a>
<br/>
<br/>
I hope this helps</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#138437 - Lazy1 - Fri Aug 24, 2007 3:52 am</h4>
    <div class="postbody"><span class="postbody">Thanks.
<br/>
I was actually writing a proper adpcm decoder which supported ms ima-adpcm wav files oddly enough.
<br/>
Though due to a recent mysterious source loss I have to re-add features missing since the last backup I did.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
