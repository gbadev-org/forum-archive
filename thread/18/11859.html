<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Problem Showing Many Sprites - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>DS development > Problem Showing Many Sprites</h2>
<div id="posts">
<div class="post">
    <h4>#111081 - spagnutty - Mon Dec 04, 2006 12:28 am</h4>
    <div class="postbody"><span class="postbody">For part of my program I'm working on drawing a number pad on the DS for id entry.  I'm having a problem drawing more than 8 sprites.  Each button is a 64x64 sprite loaded from a pcx file.  They share the same color palette.  The first 8 sprites draw correctly, but sprites 9 and 0 incorrectly show up as 1 and 2.
<br/>
<br/>
I'm pretty sure that the problem is that I am using up all of my sprite memory space.  From what I've gathered on the forums you can get around the memory limitation by enabling DISPLAY_SPR_1D_SIZE_256.  Unfortunately when I try to put that into videoSetMode, my images mess up.  Only part of the sprite is drawn and pieces of other sprites are drawn with it.
<br/>
<br/>
What exactly do I need to do to so I can show more sprites?
<br/>
<br/>
Here's my hopefully relevant code:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">//simple sprite struct
<br/>
typedef struct {
<br/>
   int x,y;
<br/>
   int dx, dy;
<br/>
   SpriteEntry* oam;   
<br/>
   int gfxID;
<br/>
}Sprite;
<br/>
<br/>
void initOAM(void) {
<br/>
   int i;
<br/>
   for(i = 0; i &lt; 128; i++) {
<br/>
      OAMCopy[i].attribute[0] = ATTR0_DISABLED;
<br/>
   }   
<br/>
}
<br/>
<br/>
void updateOAM(void) {
<br/>
   unsigned int i;
<br/>
   
<br/>
   for(i = 0; i &lt; 128 * sizeof(SpriteEntry) / 4 ; i++) {
<br/>
      ((uint32*)OAM)[i] = ((uint32*)OAMCopy)[i];
<br/>
   }
<br/>
}
<br/>
<br/>
void MoveSprite(Sprite* sp) {
<br/>
   int x = sp-&gt;x;
<br/>
   int y = sp-&gt;y;
<br/>
   
<br/>
   sp-&gt;oam-&gt;attribute[1] &amp;= 0xFE00;
<br/>
   sp-&gt;oam-&gt;attribute[1] |= x;
<br/>
   
<br/>
   sp-&gt;oam-&gt;attribute[0] &amp;= 0xFF00;
<br/>
   sp-&gt;oam-&gt;attribute[0] |= y;
<br/>
} 
<br/>
<br/>
/* Set up the bottom screen as a frame buffer, and set up
<br/>
* the top screen as a text console.
<br/>
*/
<br/>
void video_setup () {
<br/>
    // put our main screen on the bottom
<br/>
    lcdSwap ();
<br/>
   
<br/>
    // set the sub background up for text display
<br/>
    videoSetModeSub (MODE_0_2D | DISPLAY_BG0_ACTIVE);
<br/>
    // set the main screen for two extended rotation backgrounds and sprites
<br/>
   videoSetMode (MODE_5_2D |
<br/>
              DISPLAY_SPR_1D | // DISPLAY_SPR_1D_SIZE_256 ?
<br/>
              DISPLAY_SPR_ACTIVE |
<br/>
              DISPLAY_BG3_ACTIVE |
<br/>
              DISPLAY_BG2_ACTIVE);
<br/>
   // set up the memory banks
<br/>
    vramSetMainBanks (VRAM_A_MAIN_BG,
<br/>
                 VRAM_B_MAIN_BG,
<br/>
                 VRAM_C_SUB_BG,
<br/>
                 VRAM_D_LCD);
<br/>
   
<br/>
    // tell the DS that background 3 is:
<br/>
    // a 16 bit bitmap of size 256*256 pixels,
<br/>
    // at memory base 0
<br/>
    // at the most visible priority
<br/>
    BG3_CR = BG_BMP16_256x256 | BG_BMP_BASE (0) | BG_PRIORITY (0);
<br/>
    mainFrontLayer = (u16*) BG_BMP_RAM (0);
<br/>
    // tell the DS that background 2 is:
<br/>
    // a 16 bit bitmap of size 256*256 pixels,
<br/>
    // at memory base 8
<br/>
    // at the 2nd most visible priority
<br/>
    BG2_CR = BG_BMP16_256x256 | BG_BMP_BASE (8) | BG_PRIORITY (1);
<br/>
    mainBackLayer = (u16*) BG_BMP_RAM (8);
<br/>
   
<br/>
    // since MODE_5_2D uses rotation backgrounds, we have to specify all this
<br/>
    // crap just to get the displays to show up
<br/>
    BG3_XDX = 1 &lt;&lt; 8;
<br/>
    BG3_XDY = 0;
<br/>
    BG3_YDX = 0;
<br/>
    BG3_YDY = 1 &lt;&lt; 8;
<br/>
    BG2_XDX = 1 &lt;&lt; 8;
<br/>
    BG2_XDY = 0;
<br/>
    BG2_YDX = 0;
<br/>
    BG2_YDY = 1 &lt;&lt; 8;
<br/>
   
<br/>
   // start of by clearing everything
<br/>
   int x, y;
<br/>
    for (y = 0; y &lt; 256; y++)
<br/>
        for (x = 0; x &lt; 256; x++) {
<br/>
         mainBackLayer [x * 256 + y] = 0;
<br/>
         mainFrontLayer [x * 256 + y] = 0;
<br/>
      }
<br/>
}
<br/>
<br/>
void getImageData (sImage * images) {
<br/>
   //load our pcx file into an image
<br/>
   loadPCX((u8*)numpad1_pcx, &amp;images[0]);
<br/>
   loadPCX((u8*)numpad2_pcx, &amp;images[1]);
<br/>
   loadPCX((u8*)numpad3_pcx, &amp;images[2]);
<br/>
   loadPCX((u8*)numpad4_pcx, &amp;images[3]);
<br/>
   loadPCX((u8*)numpad5_pcx, &amp;images[4]);
<br/>
   loadPCX((u8*)numpad6_pcx, &amp;images[5]);
<br/>
   loadPCX((u8*)numpad7_pcx, &amp;images[6]);
<br/>
   loadPCX((u8*)numpad8_pcx, &amp;images[7]);
<br/>
   loadPCX((u8*)numpad9_pcx, &amp;images[8]);
<br/>
   loadPCX((u8*)numpad0_pcx, &amp;images[9]);
<br/>
   
<br/>
   //tile it so it is usefull as sprite data
<br/>
   int i;
<br/>
   for (i = 0; i &lt; NUM_SPRITES; i++)
<br/>
      imageTileData(&amp;images[i]);   
<br/>
}
<br/>
<br/>
static int ds_show_numpad (lua_State *L) {
<br/>
   vramSetBankE(VRAM_E_MAIN_SPRITE);
<br/>
      
<br/>
   Sprite sprites[NUM_SPRITES];
<br/>
   sImage images[NUM_SPRITES];
<br/>
   
<br/>
   getImageData(images);
<br/>
   
<br/>
   // Initialize the colors of the Sprite palette
<br/>
   int i;
<br/>
   int j;
<br/>
   for(i = 0; i &lt; 256; i++)
<br/>
      SPRITE_PALETTE[i] = images[0].palette[i];
<br/>
   // Sprite initialisation
<br/>
   for (j = 0; j &lt; NUM_SPRITES; j++)
<br/>
      for(i = j*64*32; i &lt; 64*32*(j+1); i++)
<br/>
         SPRITE_GFX[i] = images[j].data16[i - 64*32*j];
<br/>
   
<br/>
   initOAM();
<br/>
   
<br/>
   for(i = 0; i &lt; NUM_SPRITES; i++) {      
<br/>
      sprites[i].oam = &amp;OAMCopy[i];
<br/>
      sprites[i].gfxID = i*128;
<br/>
      
<br/>
      //set up our sprites OAM entry attributes
<br/>
      sprites[i].oam-&gt;attribute[0] = ATTR0_COLOR_256 | ATTR0_SQUARE;  
<br/>
      sprites[i].oam-&gt;attribute[1] = ATTR1_SIZE_64;
<br/>
      sprites[i].oam-&gt;attribute[2] = sprites[i].gfxID;
<br/>
   }
<br/>
   
<br/>
   position_sprites(sprites);
<br/>
   
<br/>
   swiWaitForVBlank();   
<br/>
   updateOAM();
<br/>
   
<br/>
   return 1;
<br/>
}
<br/>
<br/>
static int ds_setup (lua_State *L) {
<br/>
    irq_setup ();
<br/>
    video_setup ();
<br/>
    console_setup ();
<br/>
    sound_setup ();
<br/>
   
<br/>
    return 1;
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
Thank you!</span><span class="gensmall"><br/><br/>Last edited by spagnutty on Mon Dec 04, 2006 5:15 pm; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#111083 - Lick - Mon Dec 04, 2006 12:33 am</h4>
    <div class="postbody"><span class="postbody">What about setting a VRAM bank to VRAM_x_MAIN_SPRITE?<br/>_________________<br/><a class="postlink" href="http://licklick.wordpress.com" target="_blank">http://licklick.wordpress.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#111104 - spagnutty - Mon Dec 04, 2006 3:21 am</h4>
    <div class="postbody"><span class="postbody">I set vramE to MAIN_SPRITE at the beginning of ds_show_numpad.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#111106 - DekuTree64 - Mon Dec 04, 2006 3:35 am</h4>
    <div class="postbody"><span class="postbody">Yeah, you'll need to use DISPLAY_SPR_1D_SIZE_64 or higher to reference more than 8 64x64, 8-bit sprites. Basically what that does is make the 'starting char' in attribute2 refer to larger units. That means that you'll need to scale down your starting char values to be referencing the same VRAM addresses.
<br/>
<br/>
Normally the starting char is in 32 byte units, but if you bump it up to 64 bytes (which is enough to reach all of the 64KB VRAM E), then you'll need to divide your starting char values by 2.<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#111116 - spagnutty - Mon Dec 04, 2006 5:43 am</h4>
    <div class="postbody"><span class="postbody">Deku, thank you so much for your quick response.  It really helped me to understand.  Unfortunately, I still can't get things to come out correctly when I play with my numbers.  I keep on getting slices of images.  Maybe I'm just doing something dumb.
<br/>
<br/>
If I change DISPLAY_SPR_1D to DISPLAY_SPR_1D_SIZE_64, how should I change in this code to get things to work?
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
for(i = 0; i &lt; 256; i++)
<br/>
   SPRITE_PALETTE[i] = images[0].palette[i];
<br/>
// Sprite initialisation
<br/>
for (j = 0; j &lt; NUM_SPRITES; j++)
<br/>
   for(i = j*64*32; i &lt; 64*32*(j+1); i++)
<br/>
      SPRITE_GFX[i] = images[j].data16[i - 64*32*j];
<br/>
<br/>
initOAM();
<br/>
<br/>
for(i = 0; i &lt; NUM_SPRITES; i++) {      
<br/>
   sprites[i].oam = &amp;OAMCopy[i];
<br/>
   sprites[i].gfxID = i*128;
<br/>
<br/>
   //set up our sprites OAM entry attributes
<br/>
   sprites[i].oam-&gt;attribute[0] = ATTR0_COLOR_256 | ATTR0_SQUARE;  
<br/>
   sprites[i].oam-&gt;attribute[1] = ATTR1_SIZE_64;
<br/>
   sprites[i].oam-&gt;attribute[2] = sprites[i].gfxID;
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
Thank you!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#111125 - DekuTree64 - Mon Dec 04, 2006 7:19 am</h4>
    <div class="postbody"><span class="postbody">Try initializing sprites[i].gfxID to i*64 instead of i*128 (the logic being that the sprite is 64wide x 64tall x 1byte per pixel, or 4096 bytes, divided by 64 bytes per char start, gives you 64).
<br/>
<br/>
It's strange that you'd be getting strips though. I'd expect it to just show every other sprite since the addresses are basically doubled. Although I guess that does mean the later ones are going past where you've copied data into, so who knows what may be out there.<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#111128 - spagnutty - Mon Dec 04, 2006 8:21 am</h4>
    <div class="postbody"><span class="postbody">I tried i * 64 but...it didn't work.  I'm still getting strips of images.  I'm going to play around with things in the morning and see if I can make any progress.  In the least I'll come back with a more descriptive photo.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#111143 - Dark Knight ez - Mon Dec 04, 2006 11:07 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">// Sprite initialisation 
<br/>
for (j = 0; j &lt; NUM_SPRITES; j++) 
<br/>
   for(i = j*64*32; i &lt; 64*32*(j+1); i++) 
<br/>
      SPRITE_GFX[i] = images[j].data16[i - 64*32*j]; </td> </tr></table><span class="postbody">
<br/>
Pure madness. ;p
<br/>
I'd say, go for something more readable.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">// Sprite initialisation 
<br/>
for (j = 0; j &lt; NUM_SPRITES; j++) 
<br/>
   for(i =0; i &lt; 64*32; i++) 
<br/>
      SPRITE_GFX[j*64*32 + i] = images[j].data16[i]; </td> </tr></table><span class="postbody">
<br/>
I think that's the same thing... but a lot more readable.
<br/>
A more descriptive photo to the problem would indeed be nice though.<br/>_________________<br/><span style="font-size: 9px; line-height: normal"><a class="postlink" href="http://amplituds.drunkencoders.com" target="_blank">AmplituDS website</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#111169 - spagnutty - Mon Dec 04, 2006 5:14 pm</h4>
    <div class="postbody"><span class="postbody">Ooo, thank you Dark Knight.  That is a lot more readable.  :D
<br/>
<br/>
Okay, all the code is the same as in the first post except for the following two methods:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
void video_setup () {
<br/>
    // put our main screen on the bottom
<br/>
    lcdSwap ();
<br/>
   
<br/>
    // set the sub background up for text display
<br/>
    videoSetModeSub (MODE_0_2D | DISPLAY_BG0_ACTIVE);
<br/>
    // set the main screen for two extended rotation backgrounds and sprites
<br/>
   videoSetMode (MODE_5_2D |
<br/>
              DISPLAY_SPR_1D_SIZE_64 |  /////
<br/>
              DISPLAY_SPR_ACTIVE |
<br/>
              DISPLAY_BG3_ACTIVE |
<br/>
              DISPLAY_BG2_ACTIVE);
<br/>
   // set up the memory banks
<br/>
    vramSetMainBanks (VRAM_A_MAIN_BG,
<br/>
                 VRAM_B_MAIN_BG,
<br/>
                 VRAM_C_SUB_BG,
<br/>
                 VRAM_D_LCD);
<br/>
   
<br/>
    // tell the DS that background 3 is:
<br/>
    // a 16 bit bitmap of size 256*256 pixels,
<br/>
    // at memory base 0
<br/>
    // at the most visible priority
<br/>
    BG3_CR = BG_BMP16_256x256 | BG_BMP_BASE (0) | BG_PRIORITY (0);
<br/>
    mainFrontLayer = (u16*) BG_BMP_RAM (0);
<br/>
    // tell the DS that background 2 is:
<br/>
    // a 16 bit bitmap of size 256*256 pixels,
<br/>
    // at memory base 8
<br/>
    // at the 2nd most visible priority
<br/>
    BG2_CR = BG_BMP16_256x256 | BG_BMP_BASE (8) | BG_PRIORITY (1);
<br/>
    mainBackLayer = (u16*) BG_BMP_RAM (8);
<br/>
   
<br/>
    // since MODE_5_2D uses rotation backgrounds, we have to specify all this
<br/>
    // crap just to get the displays to show up
<br/>
    BG3_XDX = 1 &lt;&lt; 8;
<br/>
    BG3_XDY = 0;
<br/>
    BG3_YDX = 0;
<br/>
    BG3_YDY = 1 &lt;&lt; 8;
<br/>
    BG2_XDX = 1 &lt;&lt; 8;
<br/>
    BG2_XDY = 0;
<br/>
    BG2_YDX = 0;
<br/>
    BG2_YDY = 1 &lt;&lt; 8;
<br/>
   
<br/>
   // start of by clearing everything
<br/>
   int x, y;
<br/>
    for (y = 0; y &lt; 256; y++)
<br/>
        for (x = 0; x &lt; 256; x++) {
<br/>
         mainBackLayer [x * 256 + y] = 0;
<br/>
         mainFrontLayer [x * 256 + y] = 0;
<br/>
      }
<br/>
}
<br/>
<br/>
static int ds_show_numpad (lua_State *L) {
<br/>
   vramSetBankE(VRAM_E_MAIN_SPRITE);
<br/>
      
<br/>
   Sprite sprites[NUM_SPRITES];
<br/>
   sImage images[NUM_SPRITES];
<br/>
   
<br/>
   getImageData(images);
<br/>
   
<br/>
   // Initialize the colors of the Sprite palette
<br/>
   int i;
<br/>
   int j;
<br/>
   for(i = 0; i &lt; 256; i++)
<br/>
      SPRITE_PALETTE[i] = images[0].palette[i];
<br/>
   // Sprite initialisation
<br/>
   for (j = 0; j &lt; NUM_SPRITES; j++)
<br/>
      for(i =0; i &lt; 64*32; i++)
<br/>
         SPRITE_GFX[j*64*32 + i] = images[j].data16[i];
<br/>
   
<br/>
   initOAM();
<br/>
   
<br/>
   for(i = 0; i &lt; NUM_SPRITES; i++) {      
<br/>
      sprites[i].oam = &amp;OAMCopy[i];
<br/>
      sprites[i].gfxID = i*64; /////
<br/>
      
<br/>
      //set up our sprites OAM entry attributes
<br/>
      sprites[i].oam-&gt;attribute[0] = ATTR0_COLOR_256 | ATTR0_SQUARE;  
<br/>
      sprites[i].oam-&gt;attribute[1] = ATTR1_SIZE_64;
<br/>
      sprites[i].oam-&gt;attribute[2] = sprites[i].gfxID;
<br/>
   }
<br/>
   
<br/>
   position_sprites(sprites);
<br/>
   
<br/>
   swiWaitForVBlank();   
<br/>
   updateOAM();
<br/>
   
<br/>
   return 1;
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Which ends up looking like this:
<br/>
<a class="postlink" href="http://www.flickr.com/photos/spagnutty/314063841/" target="_blank">http://www.flickr.com/photos/spagnutty/314063841/</a>
<br/>
<br/>
Just for reference, this is the image that I started out with:
<br/>
<a class="postlink" href="http://www.flickr.com/photos/spagnutty/314063845/" target="_blank">http://www.flickr.com/photos/spagnutty/314063845/</a>
<br/>
<br/>
Anybody have any ideas?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#111181 - Lick - Mon Dec 04, 2006 6:00 pm</h4>
    <div class="postbody"><span class="postbody">Woops, sorry.<br/>_________________<br/><a class="postlink" href="http://licklick.wordpress.com" target="_blank">http://licklick.wordpress.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#111188 - Dark Knight ez - Mon Dec 04, 2006 7:13 pm</h4>
    <div class="postbody"><span class="postbody">Alright... I'm just gonna go over your code now.
<br/>
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">// put our main screen on the bottom 
<br/>
lcdSwap ();</td> </tr></table><span class="postbody">
<br/>
Maybe that works in your case, but it should actually be
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">// put our main screen on the bottom 
<br/>
lcdMainOnBottom();</td> </tr></table><span class="postbody">
<br/>
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">sprites[i].oam = &amp;OAMCopy[i]; </td> </tr></table><span class="postbody">
<br/>
Where is OAMCopy defined?
<br/>
<br/>
<br/>
There are so many odd things in your code (a sprite's attributes are set in various locations) that I'd think it to be wise if you first concentrated on getting only the 1 to show up.
<br/>
If even showing only 1 sprite fails for you, try to only load in the graphics for the 1-button to make sure it's not the loading in of graphics that is at fault.<br/>_________________<br/><span style="font-size: 9px; line-height: normal"><a class="postlink" href="http://amplituds.drunkencoders.com" target="_blank">AmplituDS website</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#111235 - spagnutty - Tue Dec 05, 2006 2:39 am</h4>
    <div class="postbody"><span class="postbody">Here's the code cut down to show only 1 sprite.  Everything that deals with OAMCopy is also included.
<br/>
<br/>
As I suspected, I now have only one image, and that one image is showing with missing strips just the same as before.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#include "numpad1_pcx.h"
<br/>
<br/>
SpriteEntry OAMCopy[128];
<br/>
<br/>
//simple sprite struct
<br/>
typedef struct {
<br/>
   int x,y;            //location 
<br/>
   int dx, dy;         //speed
<br/>
   SpriteEntry* oam;   
<br/>
   int gfxID;             //graphics lovation
<br/>
}Sprite;
<br/>
<br/>
void initOAM(void) {
<br/>
   int i;   
<br/>
   for(i = 0; i &lt; 128; i++) {
<br/>
      OAMCopy[i].attribute[0] = ATTR0_DISABLED;
<br/>
   }   
<br/>
}
<br/>
<br/>
void updateOAM(void) {
<br/>
   unsigned int i;
<br/>
   
<br/>
   for(i = 0; i &lt; 128 * sizeof(SpriteEntry) / 4 ; i++) {
<br/>
      ((uint32*)OAM)[i] = ((uint32*)OAMCopy)[i];
<br/>
   }
<br/>
}
<br/>
<br/>
void MoveSprite(Sprite* sp) {
<br/>
   int x = sp-&gt;x;
<br/>
   int y = sp-&gt;y;
<br/>
   
<br/>
   sp-&gt;oam-&gt;attribute[1] &amp;= 0xFE00;
<br/>
   sp-&gt;oam-&gt;attribute[1] |= x;
<br/>
   
<br/>
   sp-&gt;oam-&gt;attribute[0] &amp;= 0xFF00;
<br/>
   sp-&gt;oam-&gt;attribute[0] |= y;
<br/>
} 
<br/>
<br/>
void video_setup () {
<br/>
    // put our main screen on the bottom
<br/>
    lcdMainOnBottom();  // :D
<br/>
   
<br/>
    // set the sub background up for text display
<br/>
    videoSetModeSub (MODE_0_2D | DISPLAY_BG0_ACTIVE);
<br/>
    // set the main screen for two extended rotation backgrounds and sprites
<br/>
   videoSetMode (MODE_5_2D |
<br/>
              DISPLAY_SPR_1D_SIZE_64 |
<br/>
              DISPLAY_SPR_ACTIVE |
<br/>
              DISPLAY_BG3_ACTIVE |
<br/>
              DISPLAY_BG2_ACTIVE);
<br/>
   // set up the memory banks
<br/>
    vramSetMainBanks (VRAM_A_MAIN_BG,
<br/>
                 VRAM_B_MAIN_BG,
<br/>
                 VRAM_C_SUB_BG,
<br/>
                 VRAM_D_LCD);
<br/>
   
<br/>
    // tell the DS that background 3 is:
<br/>
    // a 16 bit bitmap of size 256*256 pixels,
<br/>
    // at memory base 0
<br/>
    // at the most visible priority
<br/>
    BG3_CR = BG_BMP16_256x256 | BG_BMP_BASE (0) | BG_PRIORITY (0);
<br/>
    mainFrontLayer = (u16*) BG_BMP_RAM (0);
<br/>
    // tell the DS that background 2 is:
<br/>
    // a 16 bit bitmap of size 256*256 pixels,
<br/>
    // at memory base 8
<br/>
    // at the 2nd most visible priority
<br/>
    BG2_CR = BG_BMP16_256x256 | BG_BMP_BASE (8) | BG_PRIORITY (1);
<br/>
    mainBackLayer = (u16*) BG_BMP_RAM (8);
<br/>
   
<br/>
    // since MODE_5_2D uses rotation backgrounds, we have to specify all this
<br/>
    // crap just to get the displays to show up
<br/>
    BG3_XDX = 1 &lt;&lt; 8;
<br/>
    BG3_XDY = 0;
<br/>
    BG3_YDX = 0;
<br/>
    BG3_YDY = 1 &lt;&lt; 8;
<br/>
    BG2_XDX = 1 &lt;&lt; 8;
<br/>
    BG2_XDY = 0;
<br/>
    BG2_YDX = 0;
<br/>
    BG2_YDY = 1 &lt;&lt; 8;
<br/>
   
<br/>
   // start of by clearing everything
<br/>
   int x, y;
<br/>
    for (y = 0; y &lt; 256; y++)
<br/>
        for (x = 0; x &lt; 256; x++) {
<br/>
         mainBackLayer [x * 256 + y] = 0;
<br/>
         mainFrontLayer [x * 256 + y] = 0;
<br/>
      }
<br/>
}
<br/>
<br/>
static int ds_show_numpad (lua_State *L) {
<br/>
   vramSetBankE(VRAM_E_MAIN_SPRITE);
<br/>
      
<br/>
   Sprite sprites[1];
<br/>
   
<br/>
   sImage numpad1;
<br/>
   loadPCX((u8*)numpad1_pcx, &amp;numpad1);
<br/>
   imageTileData(&amp;numpad1);
<br/>
   
<br/>
   // Initialize the colors of the Sprite palette
<br/>
   int i;
<br/>
   for(i = 0; i &lt; 256; i++)
<br/>
      SPRITE_PALETTE[i] = numpad1.palette[i];
<br/>
   // Sprite initialisation
<br/>
   for(i =0; i &lt; 64*32; i++)
<br/>
      SPRITE_GFX[i] = numpad1.data16[i];
<br/>
   
<br/>
   initOAM();
<br/>
   
<br/>
   sprites[0].oam = &amp;OAMCopy[0];
<br/>
   sprites[0].gfxID = 0;
<br/>
<br/>
   //set up our sprites OAM entry attributes
<br/>
   sprites[0].oam-&gt;attribute[0] = ATTR0_COLOR_256 | ATTR0_SQUARE;  
<br/>
   sprites[0].oam-&gt;attribute[1] = ATTR1_SIZE_64;
<br/>
   sprites[0].oam-&gt;attribute[2] = sprites[0].gfxID;
<br/>
<br/>
   sprites[0].x = 0;
<br/>
   sprites[0].y = 0;
<br/>
   
<br/>
   MoveSprite(&amp;sprites[0]);
<br/>
   
<br/>
   swiWaitForVBlank();   
<br/>
   updateOAM();
<br/>
   
<br/>
   return 1;
<br/>
}
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#111265 - Dark Knight ez - Tue Dec 05, 2006 10:36 am</h4>
    <div class="postbody"><span class="postbody">Are the pcx files stored as 8-bit images?
<br/>
<br/>
Anyway, take a look again at your posted shots.
<br/>
The first 1 is not just "half of 1".
<br/>
The flaw is more apparent at the 2 below it.
<br/>
<br/>
I *think* something like this happens:
<br/>
First 8 lines of your pcx image is shown.
<br/>
- 8 lines are skipped -
<br/>
Next 8 lines of your pcx image is shown.
<br/>
- 8 lines are skipped -
<br/>
Next [... etc]
<br/>
<br/>
This results in what you see. (Half the height of an image, but not a proper looking half.)
<br/>
To me, this means that the image is not stored as it should be in SPRITE_GFX.
<br/>
This could either be by the use of a wrong format pcx (check if it's 8-bit or not), by loadPCX being faulty, and/or by imageTileData being faulty.
<br/>
My guess is imageTileData, but don't slap me silly for saying that if I'm wrong.
<br/>
You probably should convert the graphics yourself instead of doing it in the code on the DS. Use gfx2gba which can spit out a graphics.bin and a graphics_palette.bin file. That should give proper results.<br/>_________________<br/><span style="font-size: 9px; line-height: normal"><a class="postlink" href="http://amplituds.drunkencoders.com" target="_blank">AmplituDS website</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#131487 - mml - Sat Jun 16, 2007 4:22 am</h4>
    <div class="postbody"><span class="postbody">I don't know if you ever solved your problem here, but I just got bitten by this exact issue myself, and since the three other threads on the issue have no solution either I figured I'd post the solution.
<br/>
<br/>
The problem is your mode setting:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">   videoSetMode (MODE_5_2D |
<br/>
              DISPLAY_SPR_1D_SIZE_64 |  /////
<br/>
              DISPLAY_SPR_ACTIVE |
<br/>
              DISPLAY_BG3_ACTIVE |
<br/>
              DISPLAY_BG2_ACTIVE); </td> </tr></table><span class="postbody">
<br/>
<br/>
If you read <a class="postlink" href="http://nocash.emubase.de/gbatek.htm#dsvideoobjs" target="_blank">gbatek</a> <span style="font-style: italic">very</span> carefully, you'll notice that in order to address 64K of 1D vram with the OAM you need to set bits <span style="font-weight: bold">4</span> and <span style="font-weight: bold">20-21</span> in the display control register (this is what videoSetMode is for):
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">OBJ Tile Mapping (DISPCNT.4,20-21):
<br/>
<br/>
  Bit4  Bit20-21  Dimension Boundary Total ;Notes
<br/>
  0     x         2D        32       32K   ;Same as GBA 2D Mapping
<br/>
  1     0         1D        32       32K   ;Same as GBA 1D Mapping
<br/>
  1     1         1D        64       64K
<br/>
  1     2         1D        128      128K
<br/>
  1     3         1D        256      256K  ;Engine B: 128K max
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
However!  If you then check nds/arm9/video.h for the definitions of the macros for doing this, you'll notice the following:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#define DISPLAY_SPR_1D              (1 &lt;&lt; 4)
<br/>
...
<br/>
#define DISPLAY_SPR_1D_SIZE_64      (1 &lt;&lt; 20)</td> </tr></table><span class="postbody">
<br/>
<br/>
Notice that DISPLAY_SPR_1D_SIZE_64 does <span style="font-style: italic">not</span> set bit 4!
<br/>
<br/>
Thus, your mode setting above is effectively saying "I want to use <span style="font-weight: bold">2D</span> mode", since bit 4 isn't being set; and since bits 20-21 are apparently ignored when bit 4 isn't set (at least, that's how I interpret the x in the table above), you're also not addressing any extra memory anyway!
<br/>
<br/>
So the fix to make this work is simply to set both DISPLAY_SPR_1D and DISPLAY_SPR_1D_SIZE_64:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">   videoSetMode (MODE_5_2D |
<br/>
              DISPLAY_SPR_1D |          ////// &lt;-- make it 1D
<br/>
              DISPLAY_SPR_1D_SIZE_64 |  /////
<br/>
              DISPLAY_SPR_ACTIVE |
<br/>
              DISPLAY_BG3_ACTIVE |
<br/>
              DISPLAY_BG2_ACTIVE); </td> </tr></table><span class="postbody">
<br/>
<br/>
Hopefully I've saved someone, somewhere a couple of hours of confusion :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#131491 - spagnutty - Sat Jun 16, 2007 4:40 am</h4>
    <div class="postbody"><span class="postbody">I abandoned that approach looooong ago, and opted for a functional but ugly workaround.
<br/>
<br/>
But thank you for the explanation!  I'm very glad to hear it.  It will make any future projects I do much easier.
<br/>
<br/>
Great job!</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
