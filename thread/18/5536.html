<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>DS fixed point math? - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > DS fixed point math?</h2>
<div id="posts">
<div class="post">
    <h4>#41141 - rize - Mon Apr 25, 2005 10:28 pm</h4>
    <div class="postbody"><span class="postbody">I'm wondering about the fixed point math and the math co processor.  I will attempt to answer my own questions and if anyone knows that my answers are correct, please say so.
<br/>
<br/>
I see the typedef:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">typedef int  f32;             // 1.19.12 fixed point for matricies
<br/>
#define intof32(n)           ((n) &lt;&lt; 12)
<br/>
#define f32toint(n)          ((n) &gt;&gt; 12)
<br/>
#define floatof32(n)         ((f32)((n) * (1 &lt;&lt; 12)))
<br/>
#define f32tofloat(n)        (((float)(n)) / (float)(1&lt;&lt;12))</td> </tr></table><span class="postbody">
<br/>
<br/>
Should I be using f32 instead of double and/or float at all times?  I'm thinking yes unless I need more precision than 12 bits on the right side of the decimal.
<br/>
<br/>
I don't have a lot of C experience.  When I do division using the symbol / is that always software division or is it designed to invoke the hardware division typedefs in math.h?  I'm thinking that / always uses software division.
<br/>
<br/>
What's the best way to make an f32 constant?  Should I just make a float constant and convert to f32? using floatof32(n)?  I'm thinking yes.
<br/>
<br/>
(f32)1234.56 doesn't make a useful f32 constant does it?  I think it just makes a float using the value 1234.56 and changes the type without multiplying by 2^12 (giving me some garbage value).
<br/>
<br/>
I see that intof32 simply shifts left 12 spots.  Does this work for negative numbers (i.e. does the format 1.19.12 use two's compliment or is it assumed that no one needs negative f32 values)?  I'm assuming that it does work because the fixed point type is really just a different way of interpretted an integer (that is shifting left by 12 before doing math and shifting back before using the integer value so that the 12 low bits are used to retain precision on the right side of the decimal.
<br/>
<br/>
What happens if I use / on two f32's?  I'm thinking it will do a software integer divide (or else give me a type error) which will produce accurate results because the format works as I mentioned above.  If it gives a type error, I assume that typecasting as int and then back to f32 will work.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#41149 - sajiimori - Mon Apr 25, 2005 11:37 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Should I be using f32 instead of double and/or float at all times? I'm thinking yes unless I need more precision than 12 bits on the right side of the decimal.</td> </tr></table><span class="postbody">If you need more than 12 bits of fraction, then just treat the value as if more bits are fractional.  That's the trick behind fixed point: you pretend that some of the bits are fractional, even though C (and the CPU) just treat it like a regular integer.
<br/>
<br/>
Don't use floats or doubles at runtime.  It's ok to use a floating point value if you're sure that the compiler will optimize it out.  For instance:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">int x = (int)(3.5 * 12.34);  // math is done at compile time</td> </tr></table><span class="postbody">
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">When I do division using the symbol / is that always software division or is it designed to invoke the hardware division typedefs in math.h?</td> </tr></table><span class="postbody">It'll use the compiler's default software divide.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">What's the best way to make an f32 constant? Should I just make a float constant and convert to f32? using floatof32(n)?</td> </tr></table><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">const fx32 value = floatof32(1.5);</td> </tr></table><span class="postbody">
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">(f32)1234.56 doesn't make a useful f32 constant does it?</td> </tr></table><span class="postbody">The fractional part of the float will be dropped giving the integer 1234.  Then if you treat the low 12 bits of the integer as fractional then it is 1234/(1 &lt;&lt; 12), or approximately 0.3.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">I see that intof32 simply shifts left 12 spots. Does this work for negative numbers (i.e. does the format 1.19.12 use two's compliment or is it assumed that no one needs negative f32 values)?</td> </tr></table><span class="postbody">Yes.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">What happens if I use / on two f32's?</td> </tr></table><span class="postbody">It will do a regular integer divide, which is not conceptually correct if the low 12 bits are supposed to be fractional.
<br/>
<br/>
I would suggest experimenting with fixed point values on your computer, so you can get a feel for how the math works out.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#41154 - rize - Tue Apr 26, 2005 12:14 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">If you need more than 12 bits of fraction, then just treat the value as if more bits are fractional.</td> </tr></table><span class="postbody">
<br/>
<br/>
Yes I understand.  However, the math coprocessor specifically requires the format 1.19.12 so it must be shifted back to that format before being used with the coprocessor I assume.  I actually figured out how to use fixed point decimal on my own about two years ago without realizing what it was called.  I figured it was a good trick that had already been figured out.  Nice to see it pop up here!
<br/>
<br/>
Floats and doubles appear to work at run time, but they wouldn't be efficient so I will avoid using them except possibly for quick debug output and that sort of thing.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">[ dividing f32 by f32 using / ] will do a regular integer divide, which is not conceptually correct if the low 12 bits are supposed to be fractional. </td> </tr></table><span class="postbody">
<br/>
<br/>
Of course you're right.  It's like doing 0.5 * 0.5 on paper.  I get 25 but have to account for moving the decimal twice not once.  
<br/>
<br/>
So + and - will work between f32's, but for * and / I need to shift the result right or left by twelve respectively (unless I use hardware divide in which case that is done for me).
<br/>
<br/>
I think that's everything.  Thanks for clearing that last one up for me especially.  That would have been a pain.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#41164 - rize - Tue Apr 26, 2005 1:54 am</h4>
    <div class="postbody"><span class="postbody">Ok, I tried out the following four lines of code and only the first three work.  The fourth, which should use the hardware to divide two f32's and produce an f32 result doesn't seem to work right.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">ty = f32toint(  floatof32( (float)IPC-&gt;touchY/(float)17.508 )  ) -14;
<br/>
<br/>
ty = f32toint(  (intof32(IPC-&gt;touchY)/floatof32(17.508)) &lt;&lt; 12  ) -14;
<br/>
<br/>
ty =             div32(intof32(IPC-&gt;touchY), floatof32(17.508) )  ) -14;
<br/>
<br/>
ty = f32toint(  divf32(intof32(IPC-&gt;touchY), floatof32(17.508) )  ) -14;</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#41176 - rize - Tue Apr 26, 2005 2:36 am</h4>
    <div class="postbody"><span class="postbody">After the = vs == thing earlier today I hate bringing this up but if divf32 takes two f32's and returns an f32 why is the DIV_CR being set to DIV_64_32?
<br/>
<br/>
And why is DIV_NUMERATOR64 being set to an f32 left shifted by 12?
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">///////////////////////////////////////
<br/>
//  Fixed point divide
<br/>
//  Takes 1.19.12 numerator and denominator
<br/>
//  and returns 1.19.12 result
<br/>
static inline f32 divf32(f32 num, f32 den)
<br/>
{
<br/>
   DIV_CR = DIV_64_32;
<br/>
   
<br/>
   while(DIV_CR &amp; DIV_BUSY);
<br/>
<br/>
   DIV_NUMERATOR64 = ((int64)num) &lt;&lt; 12;
<br/>
   DIV_DENOMINATOR32 = den;
<br/>
<br/>
   while(DIV_CR &amp; DIV_BUSY);
<br/>
<br/>
   return (DIV_RESULT32);
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
It would seem to me that the integer version below could do what the one above claims to do by simply shifting the result left by 12 before returning it:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">///////////////////////////////////////
<br/>
//  Interger divide
<br/>
//  Takes a 32 bit numerator and 32 bit
<br/>
//   denominator and returns 32 bit result
<br/>
static inline int32 div32(int32 num, int32 den)
<br/>
{
<br/>
   DIV_CR = DIV_32_32;
<br/>
   
<br/>
   while(DIV_CR &amp; DIV_BUSY);
<br/>
<br/>
   DIV_NUMERATOR32 = num;
<br/>
   DIV_DENOMINATOR32 = den;
<br/>
<br/>
   while(DIV_CR &amp; DIV_BUSY);
<br/>
<br/>
   return (DIV_RESULT32);
<br/>
}</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#41181 - sajiimori - Tue Apr 26, 2005 3:26 am</h4>
    <div class="postbody"><span class="postbody">When multiplying or dividing two fx32 values it's good to use a 64 bit workspace to reduce the loss of precision.  Note that if you simply do the divide and then shift the result left 12 bits, you've lost all fractional precision.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#41183 - rize - Tue Apr 26, 2005 3:32 am</h4>
    <div class="postbody"><span class="postbody">True.  Can't believe I missed that.  It works in the case I'm using it for because I was going to int anyway (trying to get an accurate input point from the touch screen).
<br/>
<br/>
So why doesn't the first one (divf32) work for me?  It doesn't seem to return a proper f32 value.
<br/>
<br/>
I'll try to test it with some values I'm certain are proper f32 variables.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
