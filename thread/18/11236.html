<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>[RESOLVED!] Odd polygon clipping behavior... - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>DS development > [RESOLVED!] Odd polygon clipping behavior...</h2>
<div id="posts">
<div class="post">
    <h4>#103553 - Izhido - Fri Sep 22, 2006 8:08 pm</h4>
    <div class="postbody"><span class="postbody">Hi! Me, again :)
<br/>
<br/>
First, I'd like to apologize in advance if this was already asked before. You see, English is not my native language, and I'm just a newbie on the DS scene, so no matter how hard I try, sometimes I can't seem to find previously posted answers to issues I'm having with my programs. And, sometimes, looking at how quick you answer my posts, I feel like I should have tried harder to find the answer by myself :). 
<br/>
<br/>
Now, on to the issue:
<br/>
<br/>
This program:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#include &lt;nds.h&gt;
<br/>
<br/>
extern "C"
<br/>
int main()
<br/>
{
<br/>
   bool IsRunning;
<br/>
   float i;
<br/>
   float j;
<br/>
<br/>
   powerON(POWER_ALL);
<br/>
   videoSetMode(MODE_0_3D);
<br/>
   glViewPort(0,0,255,191);
<br/>
   glClearColor(0,0,0);
<br/>
   glClearDepth(0x7FFF);
<br/>
   IsRunning = true;
<br/>
   while(IsRunning)
<br/>
   {
<br/>
      glReset();
<br/>
      glPolyFmt(POLY_ALPHA(31) | POLY_CULL_NONE);
<br/>
      glMatrixMode(GL_PROJECTION);
<br/>
      glLoadIdentity();
<br/>
      gluPerspective(36.0, 256.0 / 192.0, 0.01, 6.4);
<br/>
      glMatrixMode(GL_MODELVIEW);
<br/>
      glPushMatrix();
<br/>
      glLoadIdentity();
<br/>
      glTranslatef(0,-1,0);
<br/>
      glBegin(GL_TRIANGLES);
<br/>
      for(i = -4; i &lt; 4; i++)
<br/>
      {
<br/>
         for(j = -4; j &lt; 4; j++)
<br/>
         {
<br/>
            glColor3f(0.8,0.1,0.1);
<br/>
            glVertex3f(i, 0, j);
<br/>
            glVertex3f(i + 1, 0, j);
<br/>
            glVertex3f(i + 1, 0, j + 1);
<br/>
            glColor3f(0.1,0.1,0.8);
<br/>
            glVertex3f(i + 1, 0, j + 1);
<br/>
            glVertex3f(i, 0, j + 1);
<br/>
            glVertex3f(i, 0, j);
<br/>
         };
<br/>
      };
<br/>
      glEnd();
<br/>
      glPopMatrix(1);
<br/>
      glFlush();
<br/>
      swiWaitForVBlank();
<br/>
   };
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
was compiled with the latest devkitPro as of today (Sep. 12, 2006). And this is what my DS shows at the top screen:
<br/>
<br/>
(Link to where the image's posted:)
<br/>
<a class="postlink" href="http://img217.imageshack.us/my.php?image=onhardwaremk5.png" target="_blank">http://img217.imageshack.us/my.php?image=onhardwaremk5.png</a>
<br/>
<br/>
The image was actually taken from emulation, but it shows exactly what is seen in current hardware. 
<br/>
<br/>
Any idea what could be happening here? The program (if I did it correctly) should draw a 8x8 "floor", of which I should see a 4x8 zone, since the camera's at center of it, at 1 unit above the "floor". However, many of the tiles at the left of the screen are not there... like they were clipped away from the scene. Why's that?
<br/>
<br/>
This program was meant to illustrate an issue on a project I'm currently working on, where this odd clipping behavior also occurs. I have two versions of the code, one for Windows, one for DS. The GL code for both versions is the same, save for one line:
<br/>
<br/>
DS: 
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">gluPerspective(36.0, 256.0 / 192.0, 0.01, 6.4);</td> </tr></table><span class="postbody">
<br/>
<br/>
Windows:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">gluPerspective(72.0, 256.0 / 192.0, 0.01, 6.4);</td> </tr></table><span class="postbody">
<br/>
<br/>
Would this change have any impact on what I'm seeing at my DS? Actually, I was forced into doing the change because, if I used the Windows version on the DS, the perspective of the scene would appear way too distorted. Would this affect somehow the way polygon clipping works? 
<br/>
<br/>
I'm stuck at this point. I can't think of any workarounds for this. Any help will be greatly appreciated!
<br/>
<br/>
EDIT: Changed the URL of the image. Thanks, Lick.</span><span class="gensmall"><br/><br/>Last edited by Izhido on Tue Sep 26, 2006 12:08 am; edited 2 times in total</span></div>    
</div>
<div class="post">
    <h4>#103554 - Lick - Fri Sep 22, 2006 8:15 pm</h4>
    <div class="postbody"><span class="postbody">"Sorry, but you do not have permission to use this feature. If you are not logged in, you may do so using the form below if available."
<br/>
<br/>
Could you upload the image to ImageShack.us or something?<br/>_________________<br/><a class="postlink" href="http://licklick.wordpress.com" target="_blank">http://licklick.wordpress.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#103561 - Izhido - Fri Sep 22, 2006 8:52 pm</h4>
    <div class="postbody"><span class="postbody">Yep! Done.
<br/>
<br/>
<a class="postlink" href="http://img217.imageshack.us/my.php?image=onhardwaremk5.png" target="_blank">http://img217.imageshack.us/my.php?image=onhardwaremk5.png</a>
<br/>
<br/>
Apologies for the inconvenience.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#103590 - john_ward - Fri Sep 22, 2006 10:32 pm</h4>
    <div class="postbody"><span class="postbody">Hi Izhido,
<br/>
<br/>
I've played about with your code - if you change the 3rd parameter (distance from viewer to near clipping plane) of your gluPerspective call to 0.025 (instead of 0.01), I think you get the desired result:
<br/>
<br/>
gluPerspective(36.0, 256.0 / 192.0, 0.025, 6.4);
<br/>
<br/>
Why? Sorry, don't know - maybe somebody else can help with the explanation...<br/>_________________<br/>Michael, I've got the pistols</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#103600 - Izhido - Fri Sep 22, 2006 11:18 pm</h4>
    <div class="postbody"><span class="postbody">Yep. Verified... almost. The last tile at the left was still missing... so I changed the 0.025 to 0.04, and guess what? All tiles were shown... by now :) Thanks a lot, john!
<br/>
<br/>
Hmm... I'm conscious that DS's 3D hardware is not very flexible, what with 16-bit fixed-point vertex coords, colors, 32-bit matrix component values, and so on. However, I'm not really convinced the hardware is to blame for this... um... let's call it "extreme clipping" :) After all, emulation showed that too... Can someone here illustrate us about that?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#103707 - HyperHacker - Sat Sep 23, 2006 11:44 pm</h4>
    <div class="postbody"><span class="postbody">A good emulator will show exactly what the hardware does.<br/>_________________<br/>I'm a PSP hacker now, but I still &lt;3 DS.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#103804 - tepples - Sun Sep 24, 2006 7:19 pm</h4>
    <div class="postbody"><span class="postbody">True, but a good emulator is not available to the public.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#104014 - Izhido - Tue Sep 26, 2006 12:26 am</h4>
    <div class="postbody"><span class="postbody">Hey! I think I finally found an answer for this issue. libnds's gluPerspective(), it seems, has a bug. And, to be honest, it's not the author's fault. I think it has to do with the calculations behind the gluPerspective() function, that when done in fixed point, probably using hardware's sin() &amp; cos() functions (not sure, I'm just theorizing here...), they give us a not very appropiate projection matrix.
<br/>
<br/>
How do I know that's what happened? Easy... I discarded the gluPerspective() call, and implemented all the calculations myself, with my own trigonometric functions. And it worked!!! :)
<br/>
<br/>
So, here it is the new (and... improved???) program with the issue corrected, for your coding pleasure (hehe). Beware... it growed a little bit :) 
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#include &lt;nds.h&gt;
<br/>
<br/>
#define Pi 3.1415926535897932384626433832795028841971693993751058209749445923078164062862089986280348253421170679
<br/>
<br/>
extern "C"
<br/>
double Sin(double Angle)
<br/>
{
<br/>
   bool Positive;
<br/>
   double Degree;
<br/>
   double Numerator;
<br/>
   double Denominator;
<br/>
   double Result;
<br/>
<br/>
   while(Angle &lt; (-Pi))
<br/>
   {
<br/>
      Angle = Angle + Pi;
<br/>
   };
<br/>
   while(Angle &gt; Pi)
<br/>
   {
<br/>
      Angle = Angle - Pi;
<br/>
   };
<br/>
   Positive = true;
<br/>
   Degree = 1;
<br/>
   Numerator = Angle;
<br/>
   Denominator = 1;
<br/>
   Result = Angle;
<br/>
   while(Degree &lt; 9)
<br/>
   {
<br/>
      Positive = !Positive;
<br/>
      Degree = Degree + 1;
<br/>
      Numerator = Numerator * Angle;
<br/>
      Denominator = Denominator * Degree;
<br/>
      Degree = Degree + 1;
<br/>
      Numerator = Numerator * Angle;
<br/>
      Denominator = Denominator * Degree;
<br/>
      if(Positive)
<br/>
      {
<br/>
         Result = Result + (Numerator / Denominator);
<br/>
      } else
<br/>
      {
<br/>
         Result = Result - (Numerator / Denominator);
<br/>
      };
<br/>
   };
<br/>
   return Result;
<br/>
}
<br/>
<br/>
extern "C"
<br/>
double Cos(double Angle)
<br/>
{
<br/>
   bool Positive;
<br/>
   double Degree;
<br/>
   double Numerator;
<br/>
   double Denominator;
<br/>
   double Result;
<br/>
<br/>
   while(Angle &lt; (-Pi))
<br/>
   {
<br/>
      Angle = Angle + Pi;
<br/>
   };
<br/>
   while(Angle &gt; Pi)
<br/>
   {
<br/>
      Angle = Angle - Pi;
<br/>
   };
<br/>
   Positive = true;
<br/>
   Degree = 0;
<br/>
   Numerator = 1;
<br/>
   Denominator = 1;
<br/>
   Result = 1;
<br/>
   while(Degree &lt; 10)
<br/>
   {
<br/>
      Positive = !Positive;
<br/>
      Degree = Degree + 1;
<br/>
      Numerator = Numerator * Angle;
<br/>
      Denominator = Denominator * Degree;
<br/>
      Degree = Degree + 1;
<br/>
      Numerator = Numerator * Angle;
<br/>
      Denominator = Denominator * Degree;
<br/>
      if(Positive)
<br/>
      {
<br/>
         Result = Result + (Numerator / Denominator);
<br/>
      } else
<br/>
      {
<br/>
         Result = Result - (Numerator / Denominator);
<br/>
      };
<br/>
   };
<br/>
   return Result;
<br/>
}
<br/>
<br/>
extern "C"
<br/>
int main()
<br/>
{
<br/>
   bool IsRunning;
<br/>
   float i;
<br/>
   float j;
<br/>
   float f;
<br/>
   m4x4 m;
<br/>
   float near;
<br/>
   float far;
<br/>
<br/>
   powerON(POWER_ALL);
<br/>
   videoSetMode(MODE_0_3D);
<br/>
   glViewPort(0,0,255,191);
<br/>
   glClearColor(0,0,0);
<br/>
   glClearDepth(0x7FFF);
<br/>
   IsRunning = true;
<br/>
   while(IsRunning)
<br/>
   {
<br/>
      glReset();
<br/>
      glPolyFmt(POLY_ALPHA(31) | POLY_CULL_NONE);
<br/>
      glMatrixMode(GL_PROJECTION);
<br/>
      f = Cos(( 72.0 * Pi)/360) / Sin(( 72.0 * Pi)/360);
<br/>
      near = 0.01;
<br/>
      far = 6.4;
<br/>
      m.m[0] = floattof32(f / (256.0 / 192.0));
<br/>
      m.m[1] = floattof32(0);
<br/>
      m.m[2] = floattof32(0);
<br/>
      m.m[3] = floattof32(0);
<br/>
      m.m[4] = floattof32(0);
<br/>
      m.m[5] = floattof32(f);
<br/>
      m.m[6] = floattof32(0);
<br/>
      m.m[7] = floattof32(0);
<br/>
      m.m[8] = floattof32(0);
<br/>
      m.m[9] = floattof32(0);
<br/>
      m.m[10] = floattof32((near + far) / (near - far));
<br/>
      m.m[11] = floattof32(-1);
<br/>
      m.m[12] = floattof32(0);
<br/>
      m.m[13] = floattof32(0);
<br/>
      m.m[14] = floattof32((2 * near * far) / (near - far));
<br/>
      m.m[15] = floattof32(0);
<br/>
      glLoadMatrix4x4(&amp;m);
<br/>
      glMatrixMode(GL_MODELVIEW);
<br/>
      glPushMatrix();
<br/>
      glLoadIdentity();
<br/>
      glTranslatef(0,-1,0);
<br/>
      glBegin(GL_TRIANGLES);
<br/>
      for(i = -4; i &lt; 4; i++)
<br/>
      {
<br/>
         for(j = -4; j &lt; 4; j++)
<br/>
         {
<br/>
            glColor3f(0.8,0.1,0.1);
<br/>
            glVertex3f(i, 0, j);
<br/>
            glVertex3f(i + 1, 0, j);
<br/>
            glVertex3f(i + 1, 0, j + 1);
<br/>
            glColor3f(0.1,0.1,0.8);
<br/>
            glVertex3f(i + 1, 0, j + 1);
<br/>
            glVertex3f(i, 0, j + 1);
<br/>
            glVertex3f(i, 0, j);
<br/>
         };
<br/>
      };
<br/>
      glEnd();
<br/>
      glPopMatrix(1);
<br/>
      glFlush();
<br/>
      swiWaitForVBlank();
<br/>
   };
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
As for the final screenshot, well, I think you'll have to build it and see it for yourselves... :)
<br/>
<br/>
Thanks everyone for your patience!</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
