<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Using 20:12 fixpoint with Cross / Dot products - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>DS development > Using 20:12 fixpoint with Cross / Dot products</h2>
<div id="posts">
<div class="post">
    <h4>#146209 - a128 - Fri Nov 30, 2007 3:06 pm</h4>
    <div class="postbody"><span class="postbody">While using 20:12 fixpoint math ....I sometimes have overflows while computing vector cross products or dot products 
<br/>
<br/>
  multiplications and a sum of i.e. </span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">a*a + b*b + c*c</td> </tr></table><span class="postbody">   will produce overflows sometimes
<br/>
<br/>
does someone have an idea how to avoid this ?
<br/>
<br/>
a trivial solution is to use "float" ..but is there a better solution?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146212 - simonjhall - Fri Nov 30, 2007 4:53 pm</h4>
    <div class="postbody"><span class="postbody">err....isn't this the same as <a href="http://forum.gbadev.org/viewtopic.php?t=14086" target="_blank">http://forum.gbadev.org/viewtopic.php?t=14086</a> ;-)
<br/>
Did you managed to sort it out before, of have the overflow problems come back?<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146214 - keldon - Fri Nov 30, 2007 5:56 pm</h4>
    <div class="postbody"><span class="postbody">Are you remembering to shift afterwards, and keeping tabs on where the point is after an operation? If it is overflowing after the shift then you may need to work with less magnitude and more fractional bits; at least after the operation.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146307 - a128 - Sun Dec 02, 2007 3:42 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>keldon wrote:</b></span></td> </tr> <tr> <td class="quote">Are you remembering to shift afterwards, and keeping tabs on where the point is after an operation? </td> </tr></table><span class="postbody">
<br/>
<br/>
keldon what do you mean with "tabs"
<br/>
<br/>
Oh yes ...what I did wrong was
<br/>
<br/>
for every a*a+b*b.... ..I did mulf32(a,a)+mulf32(b,b)
<br/>
<br/>
this is wrong
<br/>
<br/>
I should do 
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
((long long)a*(long long)a+(long long)b*(long long)b)&gt;&gt;12
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
but his also tends to not fitting with 20:12 because the 20bit magnitude overflows?!
<br/>
<br/>
maybe I am not getting somethink right:
<br/>
(still searchin for my brain in my apparment..not found yet:-) )[/code]</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146315 - DiscoStew - Sun Dec 02, 2007 6:52 pm</h4>
    <div class="postbody"><span class="postbody">Using mulf32 is a good way to get started with 1:19:12 fixed-point math. You just need to make sure that any value you use is in the same format as well, so that you can shift the same amount each time.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">((long long)a * (long long)a + (long long)b * (long long)b)&gt;&gt; 12</td> </tr></table><span class="postbody">
<br/>
<br/>
does the exact same thing (as far as results go) as
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">((long long)a * (long long)a) &gt;&gt; 12 + ((long long)b * (long long)b)) &gt;&gt; 12    (2 x mulf32 function)</td> </tr></table><span class="postbody">
<br/>
<br/>
The difference is how they are done.<br/>_________________<br/><span style="font-weight: bold">DS</span> - It's all about <span style="font-weight: bold">D</span>isco<span style="font-weight: bold">S</span>tew</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146319 - Peter - Sun Dec 02, 2007 7:27 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>DiscoStew wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">((long long)a * (long long)a + (long long)b * (long long)b)&gt;&gt; 12</td> </tr></table><span class="postbody">
<br/>
does the exact same thing (as far as results go) as
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">((long long)a * (long long)a) &gt;&gt; 12 + ((long long)b * (long long)b)) &gt;&gt; 12    (2 x mulf32 function)</td> </tr></table><span class="postbody">
<br/>
</span></td> </tr></table><span class="postbody">
<br/>
I don't think so, for example:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
((long long)a * (long long)a + (long long)b * (long long)b)&gt;&gt; 12
<br/>
<br/>
8192 = 2*4096 (2 in fixed poin 1.19.12)
<br/>
32768 = (8192*8192 + 8192*8192) / 4096
<br/>
</td> </tr></table><span class="postbody">
<br/>
But it should have been 8. The result has actually 24bits fraction, correct would be:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
((long long)a * (long long)a + (long long)b * (long long)b)&gt;&gt; 24
<br/>
</td> </tr></table><span class="postbody"><br/>_________________<br/>Kind Regards,
<br/>
Peter</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146322 - DiscoStew - Sun Dec 02, 2007 7:44 pm</h4>
    <div class="postbody"><span class="postbody">But (32768 &gt;&gt; 12) does equal 8 though. 32768 is 8 in 1:19:12 fixed point.
<br/>
<br/>
And using the other method results in the same value
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">32768 = (8192 * 8192) &gt;&gt; 12 + (8192 * 8192) &gt;&gt; 12</td> </tr></table><span class="postbody">
<br/>
<br/>
It would be a 24-bit fraction is that plus sign in the middle was a multiple sign, I think.<br/>_________________<br/><span style="font-weight: bold">DS</span> - It's all about <span style="font-weight: bold">D</span>isco<span style="font-weight: bold">S</span>tew</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146323 - Peter - Sun Dec 02, 2007 7:56 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>DiscoStew wrote:</b></span></td> </tr> <tr> <td class="quote">But (32768 &gt;&gt; 12) does equal 8 though. 32768 is 8 in 1:19:12 fixed point.</td> </tr></table><span class="postbody">
<br/>
eeeks, yes of course. What was I thinking.<br/>_________________<br/>Kind Regards,
<br/>
Peter</span><span class="gensmall"><br/><br/>Last edited by Peter on Sun Dec 02, 2007 10:57 pm; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#146332 - tepples - Sun Dec 02, 2007 10:11 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>a128 wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>keldon wrote:</b></span></td> </tr> <tr> <td class="quote">Are you remembering to shift afterwards, and keeping tabs on where the point is after an operation? </td> </tr></table><span class="postbody">
<br/>
keldon what do you mean with "tabs"</span></td> </tr></table><span class="postbody">
<br/>
<a class="postlink" href="http://idioms.thefreedictionary.com/keep+tabs+on" target="_blank">idiom: keep tabs on</a><br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146383 - a128 - Mon Dec 03, 2007 11:55 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>DiscoStew wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">((long long)a * (long long)a + (long long)b * (long long)b)&gt;&gt; 12</td> </tr></table><span class="postbody">
<br/>
<br/>
does the exact same thing (as far as results go) as
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">((long long)a * (long long)a) &gt;&gt; 12 + ((long long)b * (long long)b)) &gt;&gt; 12    (2 x mulf32 function)</td> </tr></table><span class="postbody">
<br/>
<br/>
The difference is how they are done.</span></td> </tr></table><span class="postbody">
<br/>
<br/>
I guess the main difference is cpu speed ...you shift only 1x</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146522 - a128 - Wed Dec 05, 2007 10:00 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>simonjhall wrote:</b></span></td> </tr> <tr> <td class="quote">err....isn't this the same as <a href="http://forum.gbadev.org/viewtopic.php?t=14086" target="_blank">http://forum.gbadev.org/viewtopic.php?t=14086</a> ;-)
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Thats correct....
<br/>
<br/>
I have one last question regarding to fixed_point 19:13 usage in your Quake1 port .
<br/>
<br/>
you do in mathlib.c
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">dist2.value = ((long long)p-&gt;normal[0].value*(long long)emaxs[0].value + (long long)p-&gt;normal[1].value*(long long)emaxs[1].value + (long long)p-&gt;normal[2].value*(long long)emaxs[2].value) / FP_SCALE;
<br/>
</td> </tr></table><span class="postbody">
<br/>
why the division ? is it more preceise then shifting ? I guess so?!
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">dist2.value = ((long long)p-&gt;normal[0].value*(long long)emaxs[0].value + (long long)p-&gt;normal[1].value*(long long)emaxs[1].value + (long long)p-&gt;normal[2].value*(long long)emaxs[2].value) &gt;&gt;13;
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146523 - kusma - Wed Dec 05, 2007 10:39 am</h4>
    <div class="postbody"><span class="postbody">If FP_SCALE is (1 &lt;&lt; 13), my guess would be either because of programming semantics (the compiler generates the same code anyway -- but only for unsigned integer dividends), or to fix the negative value case (with shifts, negative values gets off-by-one compared to the division).
<br/>
<br/>
One could argue that conceptually it's a scale, not some bit-manipulation which is what the shift operator is mainly for. But to be honest, I think fixed point math is kind of a special case and that using shifts directly often is clearer since it's the more common way of doing it. And since it's slightly faster (usually compiles to something like "x &gt;&gt; y" instead of "x &gt;&gt; y + (x &lt; 0 ? 1 : 0)") and the error is "acceptable" (1 ULP), I just find the shift even more appealing.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146524 - simonjhall - Wed Dec 05, 2007 11:11 am</h4>
    <div class="postbody"><span class="postbody">The float- to fixed-point conversion of Quake happened over a period of about six months, and when I started it I just did it willy-nilly. After getting some code from kusma then making an overloaded fixed point class, I got a lot more consistent at how I did it. That's why in later code you'll see me just shifting by FP_SHIFT (or whatever it's called).
<br/>
<br/>
Tbh I would hope that when dividing and integer by (the immediate) 8192 the compiler would just stick in a right shift by 13 places. If it doesn't (I'm sure it wouldn't) then it needs to be changed.
<br/>
I'd imagine that the result would be exactly the same regardless of whether a shift or integer divide were used. I normally only see imprecise divides when using floating-point...<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146526 - kusma - Wed Dec 05, 2007 11:42 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>simonjhall wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
I'd imagine that the result would be exactly the same regardless of whether a shift or integer divide were used. I normally only see imprecise divides when using floating-point...</td> </tr></table><span class="postbody">
<br/>
That's only true for unsigned integers where you shift in zeros at the top (when right-shifting). For signed integers you shift in the sign-bit, and negative values converge at -1 (all bits high), not 0 as you would expect.</span><span class="gensmall"><br/><br/>Last edited by kusma on Wed Dec 05, 2007 11:44 am; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#146527 - Lino - Wed Dec 05, 2007 11:44 am</h4>
    <div class="postbody"><span class="postbody">You can use the asr.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146528 - kusma - Wed Dec 05, 2007 11:47 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Lino wrote:</b></span></td> </tr> <tr> <td class="quote">You can use the asr.</td> </tr></table><span class="postbody">
<br/>
A right-shift on a signed value already results in an ASR. Where are you trying to go with this?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146529 - Lino - Wed Dec 05, 2007 11:55 am</h4>
    <div class="postbody"><span class="postbody">I have said if you have problems with right shift of signed inetger, you can use the asr instruction. Otherwise the logical right shift puts all zeros in the top, you lose the sign.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146530 - simonjhall - Wed Dec 05, 2007 12:05 pm</h4>
    <div class="postbody"><span class="postbody">Yes that's true. However the type in my fixed point class is an unsigned int, so I guess that's why I've not had weird problems yet ;-)
<br/>
But yeah, I did discover these "shifting down the top bit" problems the other day at work when doing endian flipping. Took me ages to track down! Grr...<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146531 - kusma - Wed Dec 05, 2007 12:20 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Lino wrote:</b></span></td> </tr> <tr> <td class="quote">I have said if you have problems with right shift of signed inetger, you can use the asr instruction. Otherwise the logical right shift puts all zeros in the top, you lose the sign.</td> </tr></table><span class="postbody">
<br/>
No, because this is already what the compiler does. The compiler uses the right instruction for the right data. If you get an lsr shitf-modifier or instruction, you have a problem in your source code. No need for low-level hackery to get this working correctly.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146532 - Lino - Wed Dec 05, 2007 12:23 pm</h4>
    <div class="postbody"><span class="postbody">With my compiler if i use 
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code"> 
<br/>
u32 i;
<br/>
i = (signed long)i &gt;&gt; 16;
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
it uses asr insetad of lsr. no devkitarm</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146538 - kusma - Wed Dec 05, 2007 2:26 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Lino wrote:</b></span></td> </tr> <tr> <td class="quote">it uses asr insetad of lsr. no devkitarm</td> </tr></table><span class="postbody">
<br/>
That is correct and as expected. The cast-operator has higher precedence, so you're shifting a signed value. ASR is for signed values LSR is for unsigned values. As said already, the compilers already handle this correctly, so there's no point in pulling in the assembly instructions in what is already a discussion on the C/C++ level.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
