<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>StellaDS Atari 2600 Emulator Port - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>DS development > StellaDS Atari 2600 Emulator Port</h2>
<div id="posts">
<div class="post">
    <h4>#52124 - TheChuckster - Sat Aug 27, 2005 12:10 am</h4>
    <div class="postbody"><span class="postbody"><span style="font-weight: bold"><span style="color: blue"><span style="font-size: 21px; line-height: normal">New web site!</span> <a href="http://thechuckster.homelinux.com/stellads/" target="_blank">http://thechuckster.homelinux.com/stellads/</a></span></span>
<br/>
<br/>
I am working on a port of the Atari 2600 emulator Stella. So far almost the entire code base has been ported. Download a ROM and put it in the data directory. Name it "pacman.bin" and recompile. The emulator will load, MD5 sum, and execute it.
<br/>
<br/>
What's left? I am having problems with the frame buffer so no visuals. It's a problem with the ported emulator code, not the DS framebuffer because I can write to the DS framebuffer fine. The source code is in the zip; perhaps, you could take a look. Namely, the TIA.cpp file is what handles the Atari's framebuffer. I honestly don't know what's the matter, but then again, this is my first real DS project.
<br/>
<br/>
Also, sound and controls need to be implemented. Shouldn't be too hard -- at least the controls. I am not going to start on these features until I get framebuffer working though.
<br/>
<br/>
Download the source code and binaries at:
<br/>
<a href="http://thechuckster.homelinux.com/atarids.zip" target="_blank">http://thechuckster.homelinux.com/atarids.zip</a>
<br/>
Consider this the alpha version.
<br/>
<br/>
EDIT: Update with added debug info -- registers and instructions just to prove that the dang thing works!</span><span class="gensmall"><br/><br/>Last edited by TheChuckster on Sun Aug 28, 2005 3:02 am; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#52145 - GPFerror - Sat Aug 27, 2005 8:41 am</h4>
    <div class="postbody"><span class="postbody">replace your updateframebuffer() function with the below code works on hardware. just needs to be seriously optimized :)
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void updateframebuffer()
<br/>
{
<br/>
  int i = 0;
<br/>
  int j = 0;
<br/>
  uInt8* buffer=theConsole-&gt;myMediaSource-&gt;currentFrameBuffer();
<br/>
  uInt16* buffer2=VRAM_A;
<br/>
  int x=0,y=0;
<br/>
  int x2=0,y2=0;
<br/>
  int h=210;
<br/>
  int w=160;
<br/>
  uInt8* line;
<br/>
  uInt16* l2;
<br/>
  buffer += y * w + x;
<br/>
  buffer2 += y2 * 256 + x2;
<br/>
  for(i = 0; i &lt; h; ++i) {
<br/>
    line = buffer + (w * i);
<br/>
   l2 = buffer2 + (256 * i);
<br/>
    for(j = 0; j &lt; w; ++j) {
<br/>
        uInt8 v = *line++;
<br/>
      *l2++=RGB15(myPaletteR[v],myPaletteG[v],myPaletteB[v]);
<br/>
      
<br/>
    }
<br/>
  }
<br/>
<br/>
<br/>
<br/>
}</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#52153 - TheChuckster - Sat Aug 27, 2005 2:23 pm</h4>
    <div class="postbody"><span class="postbody">You're getting visuals from the emulated game? iDeaS just displays all black. Thank you for the function.
<br/>
<br/>
EDIT: Got somebody to test it on their hardware. It works! I wish I could do more but it won't work in emulators and Neo Flash won't replace my defective Slim Loader which is a shame because I'll never get to enjoy my work. Guess the community will just have to wait for sound, scaling, optimizations, controls.
<br/>
<br/>
Even with it as an extended rotation background instead of a framebuffer it's still not showing up in iDeaS. Dualis crashes and DSEmu won't display anything at all.
<br/>
<br/>
<a href="http://thechuckster.homelinux.com/atarids.jpg" target="_blank">http://thechuckster.homelinux.com/atarids.jpg</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#52157 - Wraggster - Sat Aug 27, 2005 4:24 pm</h4>
    <div class="postbody"><span class="postbody">Awesome stuff, i mirrored your release and posted news here --&gt;  <a href="http://nintendo-ds.dcemu.co.uk/" target="_blank">http://nintendo-ds.dcemu.co.uk/</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#52159 - TheChuckster - Sat Aug 27, 2005 5:16 pm</h4>
    <div class="postbody"><span class="postbody">You can actually play ET now! <a href="http://thechuckster.homelinux.com/chuck.jpg" target="_blank">http://thechuckster.homelinux.com/chuck.jpg</a>
<br/>
<br/>
So as you can see, I got controls working but the framebuffer still needs optimized. I will work on that now. Hopefully, the framebuffer is what's slowing things down. My plan is to only draw the updated portions each frame and to use an extended rotation background on Mode 5 instead of the FB0.
<br/>
<br/>
If the emulated processor or the C++ emulator core code are the bottlenecks and the code needs a drastic rewrite, this project will surely grind to a halt. I have no experience whatsoever with optimizing for embedded systems or even with ARM assembly for that matter.
<br/>
<br/>
By the way, the latest ROM can be found at <a href="http://thechuckster.homelinux.com/atarids.nds" target="_blank">http://thechuckster.homelinux.com/atarids.nds</a>
<br/>
<br/>
Forget the old source code zip. I will update it once my framebuffer optimizations are in place.
<br/>
<br/>
<span style="font-weight: bold">UPDATE:</span>
<br/>
The emulator has been quite optimized and plays at a smooth playable speed now thanks to a faster framebuffer drawing routine. I will continue to work on it though and add sound.
<br/>
<br/>
I need to order a Wifi card to do more complete experimentation because there's pretty much no hope at all of getting a replacement Neo Flash.
<br/>
<br/>
As promised, I have released the source code:
<br/>
<a href="http://thechuckster.homelinux.com/atarids.zip" target="_blank">http://thechuckster.homelinux.com/atarids.zip</a>
<br/>
<br/>
Feel free to try some optimization of your own! :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#52161 - GPFerror - Sat Aug 27, 2005 7:54 pm</h4>
    <div class="postbody"><span class="postbody">cool, glad it helped.
<br/>
<br/>
Yeah I wasn't able to get it to work in the emulators either, so I had someone on irc test it on hardware before I posted my code :)
<br/>
<br/>
I run into the same problem with my neo pocket emulator, but it now works in dsemu. 
<br/>
<br/>
One thing to try is to make the emulated frame buffer, have a width of 256 and apply the color directly as its being created. then you can just use  a dmacopy or a swifastcopy to copy it to vram, which might speed it up some.
<br/>
<br/>
Troy</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#52176 - Wraggster - Sat Aug 27, 2005 11:37 pm</h4>
    <div class="postbody"><span class="postbody">awesome work, ive once again mirrored the release and screens here --&gt; <a href="http://nintendo-ds.dcemu.co.uk/stellads.shtml" target="_blank">http://nintendo-ds.dcemu.co.uk/stellads.shtml</a>
<br/>
<br/>
I also submitted this news to Joystiq.com and they posted it, so your famous :)
<br/>
<br/>
i do have one request could you number your releases or date them as for all emu sites its easier to see whats new etc :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#52180 - mrnull - Sun Aug 28, 2005 2:41 am</h4>
    <div class="postbody"><span class="postbody">I don't see any binaries, just source!
<br/>
<br/>
I recently moved and don't have access to my ol' computer.  Please help!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#52181 - TheChuckster - Sun Aug 28, 2005 3:02 am</h4>
    <div class="postbody"><span class="postbody">Try the new web site for binaries. <a href="http://thechuckster.homelinux.com/stellads/" target="_blank">http://thechuckster.homelinux.com/stellads/</a>
<br/>
<br/>
I managed to get it to work in Dualis by removing -mthumb from the Makefile. Problem is it's still running slower than the actual games -- at least in the emulator. Can anyone else that has the hardware confirm if it's running quite a bit slower in the emulator than the hardware or if it's running just as  slowly on both?
<br/>
<br/>
Looks like even more optimization work is necessary.
<br/>
<br/>
Also, a Mode 5 hardware scale factor of 3 &lt;&lt; 7 seems to make it smaller even though it SHOULD make it 1.5x larger. Is this true only to Dualis or does it malfunction on the hardware as well? Perhaps I'm using the wrong scale factor. Is 3 &lt;&lt; 7 correct for a factor 1.5?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#52203 - wintermute - Sun Aug 28, 2005 11:41 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>TheChuckster wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
Also, a Mode 5 hardware scale factor of 3 &lt;&lt; 7 seems to make it smaller even though it SHOULD make it 1.5x larger. Is this true only to Dualis or does it malfunction on the hardware as well? Perhaps I'm using the wrong scale factor. Is 3 &lt;&lt; 7 correct for a factor 1.5?</td> </tr></table><span class="postbody">
<br/>
<br/>
<a href="http://user.chem.tue.nl/jakvijn/tonc/affine.htm" target="_blank">http://user.chem.tue.nl/jakvijn/tonc/affine.htm</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#52236 - gladius - Sun Aug 28, 2005 5:10 pm</h4>
    <div class="postbody"><span class="postbody">The scale factors are actually the amount the DS adds after each pixel to the x and y co-ordinates.  To get a scale factor of 1.5, you actually want to add ~0.66667 each pixel.  Or converting to fixed point (1/1.5 * 256) you want 171.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#52263 - TheChuckster - Sun Aug 28, 2005 11:33 pm</h4>
    <div class="postbody"><span class="postbody">Works beautifully. Thanks.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#52267 - tepples - Mon Aug 29, 2005 1:01 am</h4>
    <div class="postbody"><span class="postbody">And you might want to change the horizontal constant offset each frame by a fraction of a pixel so that the player doesn't see an obvious pattern of 2, 1, 2, 1, 2, 1 repeated pixels in the A2600's two bitmapped objects. This technique, used (albeit in the other direction) by PocketNES, may look flickery on emulators, but it'll look OK on a real DS.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#70031 - TheChuckster - Fri Feb 03, 2006 9:34 pm</h4>
    <div class="postbody"><span class="postbody">I just added GBAMP/M3/etc. support. Download the new release at my site.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#70035 - nmain - Fri Feb 03, 2006 9:52 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tepples wrote:</b></span></td> </tr> <tr> <td class="quote">And you might want to change the horizontal constant offset each frame by a fraction of a pixel so that the player doesn't see an obvious pattern of 2, 1, 2, 1, 2, 1 repeated pixels in the A2600's two bitmapped objects. This technique, used (albeit in the other direction) by PocketNES, may look flickery on emulators, but it'll look OK on a real DS.</td> </tr></table><span class="postbody">
<br/>
<br/>
It's the same idea, but pocketnes doesn't use an affine bg to do it (since it doesn't need any horizontal scaling), just modifies the vofs of a text bg every scanline by hdma.  It does look pretty good on real hardware.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#101152 - ratx - Sun Sep 03, 2006 9:35 am</h4>
    <div class="postbody"><span class="postbody">I made a special version with FAT access for EZ4 users: 
<br/>
<br/>
<a href="http://l33t.spod.org/ratx/stellaEZ4.ds.gba" target="_blank">http://l33t.spod.org/ratx/stellaEZ4.ds.gba</a></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
