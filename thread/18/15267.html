<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Nintendo's signing bug - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > Nintendo's signing bug</h2>
<div id="posts">
<div class="post">
    <h4>#153206 - Lick - Wed Mar 26, 2008 12:22 pm</h4>
    <div class="postbody"><span class="postbody">Hey guys, I just came across <a class="postlink" href="http://wiibrew.org/index.php?title=Signing_bug" target="_blank">this article</a>.
<br/>
<br/>
Is it somehow applicable to the DS?<br/>_________________<br/><a class="postlink" href="http://licklick.wordpress.com" target="_blank">http://licklick.wordpress.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#153207 - pepsiman - Wed Mar 26, 2008 12:30 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Lick wrote:</b></span></td> </tr> <tr> <td class="quote">I just came across <a class="postlink" href="http://wiibrew.org/index.php?title=Signing_bug" target="_blank">this article</a>.
<br/>
<br/>
Is it somehow applicable to the DS?</td> </tr></table><span class="postbody">
<br/>
I asked sgstair, he agreed it was possible, but doesn't know either way.
<br/>
<br/>
I'd be surprised if the DS had this bug and firefly or loopy hadn't noticed.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#153208 - Lick - Wed Mar 26, 2008 12:40 pm</h4>
    <div class="postbody"><span class="postbody">Well, I'm surprised that Nintendo's programmers missed this to begin with. ;)
<br/>
<br/>
If a test were to be written, how would it work?<br/>_________________<br/><a class="postlink" href="http://licklick.wordpress.com" target="_blank">http://licklick.wordpress.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#153220 - pepsiman - Wed Mar 26, 2008 3:59 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Lick wrote:</b></span></td> </tr> <tr> <td class="quote">Well, I'm surprised that Nintendo's programmers missed this to begin with. ;)
<br/>
<br/>
If a test were to be written, how would it work?</td> </tr></table><span class="postbody">
<br/>
<br/>
You need to create an nds with a header with a "combined hash" that starts with 0x0 and also set the signature in the nds to all zeros.
<br/>
<br/>
<br/>
ndstool can calculate and display the hashes for you:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
printf("DS Download Play(TM) / Wireless MultiBoot signature: %s\n", ok ? "OK" : "INVALID");
<br/>
if (!ok)
<br/>
{
<br/>
 printf("header hash:    \t"); for (int i=0; i&lt;SHA1_DIGEST_SIZE; i++) printf("%02X", (sha_parts + 0*SHA1_DIGEST_SIZE)[i]); printf("\n");
<br/>
 printf("ARM9 hash:      \t"); for (int i=0; i&lt;SHA1_DIGEST_SIZE; i++) printf("%02X", (sha_parts + 1*SHA1_DIGEST_SIZE)[i]); printf("\n");
<br/>
 printf("ARM7 hash:      \t"); for (int i=0; i&lt;SHA1_DIGEST_SIZE; i++) printf("%02X", (sha_parts + 2*SHA1_DIGEST_SIZE)[i]); printf("\n");
<br/>
 printf("combined hash:  \t"); for (int i=0; i&lt;SHA1_DIGEST_SIZE; i++) printf("%02X", sha_final[i]); printf("\n");
<br/>
 printf("signature hash: \t"); for (int i=0; i&lt;SHA1_DIGEST_SIZE; i++) printf("%02X", sha1_from_sig[i]); printf("\n");
<br/>
}
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#153246 - yellowstar - Wed Mar 26, 2008 10:57 pm</h4>
    <div class="postbody"><span class="postbody">You can try to make a test .nds with <a class="postlink" href="http://users.belgacom.net/bn931507/nds_rsa_1_1.zip" target="_blank">this</a> too. You would edit the nds every iteration if needed, then use the this tool to verify. Then you would keep repeating until you get a valid signature, then you would test it on hardware and hope it works.(Found the link off of DCEmu via Google)
<br/>
<br/>
But, before you use it, you need to modify the tool so it has the same bug that the DS might have. Change memcmp to strcmp on line 419 in source code.(More changes might be needed, I'm not sure, I haven't tried anything yet with this)
<br/>
(You'll need Dev-Cpp/GNU to compile, and OpenSSL too.)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#153421 - Sausage Boy - Sun Mar 30, 2008 3:41 am</h4>
    <div class="postbody"><span class="postbody">I wrote a little test-app, and, as expected, it doesn't work. At least not on a DS lite, heh. In case anyone is curious, you can get it at <a class="postlink" href="http://blog.dev-scene.com/gaspcubed/files/2008/03/fakesign.zip" target="_blank">http://blog.dev-scene.com/gaspcubed/files/2008/03/fakesign.zip</a><br/>_________________<br/>"no offense, but this is the gayest game ever"</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#153463 - pepsiman - Mon Mar 31, 2008 11:23 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Sausage Boy wrote:</b></span></td> </tr> <tr> <td class="quote">I wrote a little test-app, and, as expected, it doesn't work. At least not on a DS lite, heh. In case anyone is curious, you can get it at <a class="postlink" href="http://blog.dev-scene.com/gaspcubed/files/2008/03/fakesign.zip" target="_blank">http://blog.dev-scene.com/gaspcubed/files/2008/03/fakesign.zip</a></td> </tr></table><span class="postbody">
<br/>
<br/>
The combined hash doesn't start with 0:
<br/>
<br/>
ndstool -v -i hello_fakesign.nds
<br/>
Header information:
<br/>
...
<br/>
DS Download Play(TM) / Wireless MultiBoot signature: INVALID
<br/>
header hash    : 65174EC1BC5ECA4154338D3FC71B806B1AE49095
<br/>
ARM9 hash      : 3518BC6FF213AEE8FCE73F94DC20CE04C7F25846
<br/>
ARM7 hash      : ED1A03F88F33A42A90A1B9BBEB7F16147F83C1C2
<br/>
combined hash  : FB0857CC5A692514DCBD3ECFE3FB084C88574AE5
<br/>
signature hash : 005DA96768DB813140DFEB6518F36DE6E9570860</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#153475 - Sausage Boy - Mon Mar 31, 2008 3:09 pm</h4>
    <div class="postbody"><span class="postbody">Hmm, I have to admit that I'm very unsure about this. The program yellowstar linked to, FireFly's ndsrsa, gives me this output:
<br/>
<br/>
$ ndsrsa verify nintendo hello_fakesign.nds
<br/>
<br/>
file      = hello_fakesign.nds
<br/>
hash 1    = 005DA96768DB813140DFEB6518F36DE6E9570860
<br/>
hash 2    = 001F49D5D3EFAA9DD520765CBFA4FF8988C991F0
<br/>
signature = wrong
<br/>
<br/>
Perhaps you know more than me about how all these hashes fit together?<br/>_________________<br/>"no offense, but this is the gayest game ever"</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#153476 - pepsiman - Mon Mar 31, 2008 3:27 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Sausage Boy wrote:</b></span></td> </tr> <tr> <td class="quote">Perhaps you know more than me about how all these hashes fit together?</td> </tr></table><span class="postbody">
<br/>
Nope.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#153493 - Lick - Mon Mar 31, 2008 10:22 pm</h4>
    <div class="postbody"><span class="postbody">Uhmm.. Not sure if this helps but '0' != '\0'. 
<br/>
<br/>
The hash should not appear when outputted like a zero-terminated string.<br/>_________________<br/><a class="postlink" href="http://licklick.wordpress.com" target="_blank">http://licklick.wordpress.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#153519 - pepsiman - Tue Apr 01, 2008 10:28 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Lick wrote:</b></span></td> </tr> <tr> <td class="quote">Uhmm.. Not sure if this helps but '0' != '\0'. 
<br/>
<br/>
The hash should not appear when outputted like a zero-terminated string.</td> </tr></table><span class="postbody">
<br/>
This is the hexadecimal representation of the hash, it really does start with 8 0 bits.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#153530 - Lick - Tue Apr 01, 2008 12:56 pm</h4>
    <div class="postbody"><span class="postbody">LOL. *ashamed* It was an early April fools joke, alright? XD<br/>_________________<br/><a class="postlink" href="http://licklick.wordpress.com" target="_blank">http://licklick.wordpress.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#153579 - HyperHacker - Wed Apr 02, 2008 8:17 am</h4>
    <div class="postbody"><span class="postbody">Does strcmp(SomeString, "") work, though? The way I understood it you set the <span style="font-style: italic">second</span> byte of the hash to zero, so the system only verifies the first byte, which is easy to brute-force.<br/>_________________<br/>I'm a PSP hacker now, but I still &lt;3 DS.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#153582 - pepsiman - Wed Apr 02, 2008 9:40 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>HyperHacker wrote:</b></span></td> </tr> <tr> <td class="quote">Does strcmp(SomeString, "") work, though? The way I understood it you set the <span style="font-style: italic">second</span> byte of the hash to zero, so the system only verifies the first byte, which is easy to brute-force.</td> </tr></table><span class="postbody">
<br/>
<br/>
strncmp("","",20) returns 0;
<br/>
strncmp("a","",20) returns 1;
<br/>
strncmp("a","a",20) returns 0;
<br/>
<br/>
You can set the second byte to 0, but you have to do the same to the signature. So you'd need to brute-force 16 bits instead of 8.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#153599 - Sausage Boy - Wed Apr 02, 2008 6:06 pm</h4>
    <div class="postbody"><span class="postbody">According to my findings, hash2 and combined hash are supposed to be the same, and are indeed on the commercial multiboot demo I tried. It seems like ndsrsa and ndstool are doing something a little different, that leads to the same result most of the time. I wonder how the DS does it...
<br/>
<br/>
Edit:
<br/>
Ok, I think I've sorted it out. Turns out ndstool calculates the arm9 hash differently depending on the romtype, and ndsrsa only calculates it the multiboot way. I tried fakesigning a commercial demo, and both ndstool and ndsrsa agreed that the hashes started with 0x00, unfortunately the DS refused it.<br/>_________________<br/>"no offense, but this is the gayest game ever"</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#153689 - tepples - Thu Apr 03, 2008 11:54 pm</h4>
    <div class="postbody"><span class="postbody">The people who made FlashMe have disassembled the part of the firmware responsible for RSA checks. Has anybody else disassembled it in order to check definitively whether this flaw is present?<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#153751 - olimar - Sat Apr 05, 2008 5:22 am</h4>
    <div class="postbody"><span class="postbody"></span><span class="gensmall"><br/><br/>Last edited by olimar on Wed Aug 20, 2008 10:55 pm; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#153754 - caitsith2 - Sat Apr 05, 2008 8:53 am</h4>
    <div class="postbody"><span class="postbody">Had to have been a different programmer, one that doesn't know the difference between strcmp and memcmp, that did the wii rsa verification then.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#153756 - TwentySeven - Sat Apr 05, 2008 10:21 am</h4>
    <div class="postbody"><span class="postbody">Amusing that they bothered with a really nice sha1 algo and then strcmp'd the results..
<br/>
<br/>
Anyway, thats that then.  No signing bug on the DS.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#153762 - HyperHacker - Sat Apr 05, 2008 2:59 pm</h4>
    <div class="postbody"><span class="postbody">I wonder if it was the same guy responsible for the sprintf() name bug in MP:H? :-p<br/>_________________<br/>I'm a PSP hacker now, but I still &lt;3 DS.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
