<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Using EFSlib with an emulator - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>DS development > Using EFSlib with an emulator</h2>
<div id="posts">
<div class="post">
    <h4>#153518 - HLMetroid - Tue Apr 01, 2008 10:17 am</h4>
    <div class="postbody"><span class="postbody">Does anyone know how to get EFSlib working with iDeaS, or any other NDS emulator?
<br/>
<br/>
I am trying to run the PAlib EFSlib example, but when I run it in iDeaS, it just freezes at "Please wait, searching NDS...".
<br/>
<br/>
If anyone could help me getting iDeaS to read the files from EFSlib, that would be great.
<br/>
<br/>
Thanks.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#153570 - silent_code - Wed Apr 02, 2008 3:01 am</h4>
    <div class="postbody"><span class="postbody">try no$gba instead. every time i use ideas to check my code, it crashes. i stopped trying recently. :^C
<br/>
dualis is also ok, if you don't have heave 3D stuff.
<br/>
no$ is the way to go (imho) when it comes to an emulator, at least for now.
<br/>
<br/>
good luck and happy coding!</span><span class="gensmall"><br/><br/>Last edited by silent_code on Wed Apr 02, 2008 4:57 am; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#153571 - bsder - Wed Apr 02, 2008 4:16 am</h4>
    <div class="postbody"><span class="postbody">I would also recommend looking at desmume.
<br/>
<a href="http://desmume.org/" target="_blank">http://desmume.org/</a>
<br/>
<br/>
The best part is that it is completely open source, so you can instrument your code any way you want.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#153574 - SevenString - Wed Apr 02, 2008 6:55 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>silent_code wrote:</b></span></td> </tr> <tr> <td class="quote">try no$gba instead. every time i use ideas to check my code, it crashes. i stopped trying recently. :^C
<br/>
dualis is also ok, if you don't have heave 3D stuff.
<br/>
no$ is the way to go (imho) when it comes to an emulator, at least for now.
<br/>
<br/>
good luck and happy coding!</td> </tr></table><span class="postbody">
<br/>
<br/>
Yeah, I'm very impressed by no$gba.  It's currently my emulator of choice.<br/>_________________<br/><span style="font-style: italic">"Artificial Intelligence is no match for natural stupidity."</span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#153581 - HLMetroid - Wed Apr 02, 2008 9:31 am</h4>
    <div class="postbody"><span class="postbody">Thanks for your help so far.
<br/>
<br/>
I tried some stuff, but I've gotten stuck now.
<br/>
<br/>
I'm using this batch file to patch the .ds.gba file to try and get it working with no$gba.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
call build_fcsr.bat fat.img fcsr
<br/>
<br/>
padbin 512 test.ds.gba
<br/>
<br/>
copy /b test.ds.gba + fat.img test_debug.ds.gba
<br/>
<br/>
dlditool fcsr.dldi test_debug.ds.gba
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I've found out that changing this in efs_lib.h:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#define EFS_fopen(n)        fopen(n, "rb+")
<br/>
</td> </tr></table><span class="postbody">
<br/>
to just "rb" allows me to see the files, but obviously doesn't let me write 16 bytes to a file. And it also doesn't seem to show the contents of the files either.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
FAT init ok
<br/>
EFS init ok
<br/>
found NDS path:
<br/>
<br/>
/test.txt content: ''
<br/>
/folder/test.txt content:
<br/>
<br/>
write test done! : 0 bytes
<br/>
<br/>
/folder/test.txt new content:
<br/>
writehere16bytes
<br/>
<br/>
Listing '/list/' directory:
<br/>
DIR : .
<br/>
DIR : ..
<br/>
FILE: FILE1.TXT
<br/>
FILE: FILE2.TXT
<br/>
FILE: FILE3.TXT
<br/>
DIR : testfolder
<br/>
end of directory.
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
So does anybody know how to get EFSlib working so that I can read &amp; write to files properly?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#153587 - wintermute - Wed Apr 02, 2008 2:52 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>HLMetroid wrote:</b></span></td> </tr> <tr> <td class="quote">Thanks for your help so far.
<br/>
<br/>
I tried some stuff, but I've gotten stuck now.
<br/>
<br/>
I'm using this batch file to patch the .ds.gba file to try and get it working with no$gba.
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
There's no need to create a .ds.gba file. Provided you don't add a wifi banner to the binary ( -o opyion in ndstool ) then .nds will work perfectly well.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
I've found out that changing this in efs_lib.h:
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#define EFS_fopen(n)        fopen(n, "rb+")
<br/>
</td> </tr></table><span class="postbody">
<br/>
</span></td> </tr></table><span class="postbody">
<br/>
<br/>
I don't know about anyone else but that macro disturbs the heck out of me.  What on earth does that define gain?
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
So does anybody know how to get EFSlib working so that I can read &amp; write to files properly?</td> </tr></table><span class="postbody">
<br/>
<br/>
EFSlib is read only<br/>_________________<br/><a class="postlink" href="http://www.devkitpro.org/" target="_blank">devkitPro - professional toolchains at amateur prices</a>
<br/>
<a class="postlink" href="http://wiki.devkitpro.org/index.php/IRC" target="_blank">devkitPro IRC support</a>
<br/>
<a class="postlink" href="http://davejmurphy.com/" target="_blank">Personal Blog</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#153593 - Noda - Wed Apr 02, 2008 4:40 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>wintermute wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
I've found out that changing this in efs_lib.h:
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#define EFS_fopen(n)        fopen(n, "rb+")
<br/>
</td> </tr></table><span class="postbody">
<br/>
</span></td> </tr></table><span class="postbody">
<br/>
<br/>
I don't know about anyone else but that macro disturbs the heck out of me.  What on earth does that define gain?
<br/>
</span></td> </tr></table><span class="postbody">
<br/>
<br/>
Simply because it allows to switch to libfat read/write by simply defining #define EFS_USE_REAL_FAT, for such case.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
So does anybody know how to get EFSlib working so that I can read &amp; write to files properly?</td> </tr></table><span class="postbody">
<br/>
<br/>
EFSlib is read only</span></td> </tr></table><span class="postbody">
<br/>
<br/>
Wrong, EFSlib support writing, as long as the space is pre-allocated. To test it on emulators that support libfat, juste use the define written up there (uncomment it on efslib.h") so it will works as standard libfat, which makes it easier to use on emulators.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#153598 - wintermute - Wed Apr 02, 2008 5:48 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Noda wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
Simply because it allows to switch to libfat read/write by simply defining #define EFS_USE_REAL_FAT, for such case.
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
And how exactly does that differ from using the normal stdio functions with out such random oddness? It's perfectly possible to change the default device based on runtime conditions.
<br/>
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
Wrong, EFSlib support writing, as long as the space is pre-allocated. To test it on emulators that support libfat, juste use the define written up there (uncomment it on efslib.h") so it will works as standard libfat, which makes it easier to use on emulators.</td> </tr></table><span class="postbody">
<br/>
<br/>
That's just *nasty*. In any case you should be testing your code on hardware as much as possible, none of the open source emulators are anywhere near usable or accurate enough to be trusted.<br/>_________________<br/><a class="postlink" href="http://www.devkitpro.org/" target="_blank">devkitPro - professional toolchains at amateur prices</a>
<br/>
<a class="postlink" href="http://wiki.devkitpro.org/index.php/IRC" target="_blank">devkitPro IRC support</a>
<br/>
<a class="postlink" href="http://davejmurphy.com/" target="_blank">Personal Blog</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#153605 - HLMetroid - Wed Apr 02, 2008 8:23 pm</h4>
    <div class="postbody"><span class="postbody">Alright, I'll explain the problem I have now.
<br/>
<br/>
Basically, I've been reading this page to try and remedy my problem:
<br/>
<a class="postlink" href="http://forum.gbadev.org/viewtopic.php?t=13195&amp;postdays=0&amp;postorder=asc&amp;highlight=efslib&amp;start=60" target="_blank">http://forum.gbadev.org/viewtopic.php?t=13195&amp;postdays=0&amp;postorder=asc&amp;highlight=efslib&amp;start=60</a>
<br/>
<br/>
Now, I read a bit down the page where Marcel24 says that "rb+" causes him problems with reading the files, and to change it to "rb".
<br/>
<br/>
So that's what I did, and it let me see the files, but not write to them, which could explain why the write test fails.
<br/>
<br/>
But what I want to know is how I can leave it at "rb+" and still manage to see and write to files?
<br/>
<br/>
I also read on the same page that bob_fossil mentions there is a bug in the EFS_GetFileSize function when EFS_REAL_FAT_MODE is #defined.
<br/>
<br/>
It doesn't seem to be fixed yet, so it could be attributing to the fact that I can't seem to read files either (I think the /test.txt content should be 'EFS Ok!' instead of '').
<br/>
<br/>
Thanks for your replies so far guys.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#153636 - Blash - Thu Apr 03, 2008 8:33 am</h4>
    <div class="postbody"><span class="postbody">I had the same problem few days ago so i can sympathize
<br/>
First let "rb+" as it is. That's not the problem
<br/>
<br/>
Try this code for the example
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">   
<br/>
int size;
<br/>
size = EFS_GetFileSize(file);
<br/>
EFS_fseek(file,0,SEEK_SET);
<br/>
buffer = (u8*)malloc(size);
<br/>
EFS_fread(buffer, 1, size, file);
<br/>
buffer[size-1] = '\0';
<br/>
iprintf("\n/test.txt content: '%s'\n", buffer);
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#153639 - HLMetroid - Thu Apr 03, 2008 9:51 am</h4>
    <div class="postbody"><span class="postbody">Well I just tried that now. It didn't seem to fix the problem. Thanks though.
<br/>
<br/>
I think the problem is to do with it not finding files, eg. it fails on this line:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">if (file != NULL)
<br/>
</td> </tr></table><span class="postbody">
<br/>
Because I can list the directories fine, just not the files in "rb+" mode.
<br/>
<br/>
So this is how I am opening the files, basically the same as the example I think:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">file = EFS_fopen("test.txt");
<br/>
        if(file != NULL) {
<br/>
<br/>
                  int size;
<br/>
                  size = EFS_GetFileSize(file);
<br/>
                  EFS_fseek(file,0,SEEK_SET);
<br/>
                  buffer = (u8*)malloc(size);
<br/>
                  EFS_fread(buffer, 1, size, file);
<br/>
                  buffer[size-1] = '\0';
<br/>
                  iprintf("\n/test.txt content: '%s'\n", buffer);
<br/>
                  free(buffer);
<br/>
                  EFS_fclose(file);
<br/>
            }</td> </tr></table><span class="postbody">
<br/>
So I was thinking the problem was either with EFSlib, or with my batch file.
<br/>
<br/>
So here's my batch file:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">call build.bat
<br/>
<br/>
call build_fcsr.bat fat.img efsroot
<br/>
<br/>
padbin 512 efs_lib.nds
<br/>
<br/>
copy /b efs_lib.nds + fat.img efs_lib_debug.nds
<br/>
<br/>
dlditool fcsr.dldi efs_lib_debug.nds</td> </tr></table><span class="postbody">
<br/>
<br/>
Am I missing a step from either of these things?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#153640 - Blash - Thu Apr 03, 2008 9:55 am</h4>
    <div class="postbody"><span class="postbody">Have you copied first efs_lib.nds in your efsroot directory?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#153703 - HLMetroid - Fri Apr 04, 2008 4:19 am</h4>
    <div class="postbody"><span class="postbody">Well, doing that gave me better results, thanks.
<br/>
<br/>
But still only in "rb" mode.
<br/>
<br/>
So are these the right steps? Are there some I should add or shouldn't do?
<br/>
<br/>
1. Run Build.bat (builds and efs patches) 
<br/>
2. Copy the efs_lib.nds into efsroot
<br/>
3. Run build_fcsr.bat (builds the efsroot directory into efsroot.img)
<br/>
4. In the root directory, do a "copy /b efs_lib.nds efs_lib_ds.nds"
<br/>
5. Run padbin 512 efs_lib_ds.nds
<br/>
6. Run copy /b efs_lib_ds.nds + efsroot.img efs_debug.nds
<br/>
7. dlditool fcsr efs_debug.nds
<br/>
<br/>
Once I've done these I then load efs_debug.nds up in no$gba. If I have efs_lib.h in "rb+" mode it still doesn't work though.
<br/>
<br/>
So since I think it has to do with the file being detected as null, maybe it could be that I'm missing/shouldn't do a step, the Makefile I'm using could be wrong in some way, or some code is wrong.
<br/>
<br/>
Thanks for your help so far guys.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#153705 - Noda - Fri Apr 04, 2008 5:04 am</h4>
    <div class="postbody"><span class="postbody">Writing is not supported by emulators (ideas accept rb+, but writing has no effect), so you have to test on real ds those functions.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#153708 - HLMetroid - Fri Apr 04, 2008 5:45 am</h4>
    <div class="postbody"><span class="postbody">Ok, that would mean that it seems to work then. Thanks everyone for your help.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
