<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>trouble with grit and tile maps - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>DS development > trouble with grit and tile maps</h2>
<div id="posts">
<div class="post">
    <h4>#169981 - 0xdeadbeef - Thu Aug 20, 2009 3:24 pm</h4>
    <div class="postbody"><span class="postbody">I was experimenting a little with grit and had moderate success converting bitmaps for use in an NDS project. However when I started using grit for converting a bitmap to a tiled map I ran into some trouble.
<br/>
<br/>
The image I'm feeding grit is a 256x192 png file. I'm processing the image wth the following parameters:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
-gt
<br/>
-gB8
<br/>
-ps0
<br/>
-pe31
<br/>
-m
<br/>
-mu16
<br/>
-mLf
<br/>
-mu16
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I'm using the following code to copy the map, tiles and palette into their respective memory:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
void copyTileMap() {
<br/>
  const int DMA_CHANNEL = 3;
<br/>
<br/>
  DC_FlushAll();
<br/>
  dmaCopyHalfWords(DMA_CHANNEL, tileMap, (u16*) BG_MAP_RAM(0), tileMapLen);
<br/>
  dmaCopyHalfWords(DMA_CHANNEL, tile, (u16*) BG_BMP_RAM(1), tileLen);
<br/>
  dmaCopyHalfWords(DMA_CHANNEL, tilePal, BG_PALETTE, tilePalLen);
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I've initialised the background as follows:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
void initTileMap() {
<br/>
  videoSetMode(MODE_5_2D | DISPLAY_BG2_ACTIVE);
<br/>
  vramSetBAnkA(VRAM_A_MAIN_BG_0x06000000);
<br/>
  REG_BG2CNT = BG_BMP8_256x256, | BG_BMP_BASE(1) | BG_MAP_BASE(0) | BG_PRIORITY(2);
<br/>
  REG_BG2PA = 1 &lt;&lt; 8;
<br/>
  REG_BG2PB = 0;
<br/>
  REG_BG2PC = 0;
<br/>
  REG_BG2PD = 1 &lt;&lt; 8;
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
So I basicly call initTileMap() first followed by a call to copyTileMap. The results is garbled output on the main screen. The only peculiar thing I'm trying right now is to use only the first 32 entries in the palette, since I want to set up another background with a bitmap that will need other colors.
<br/>
<br/>
The other thing I'm doing is copying some bitmaps to memory every 15 frames on the subscreen, but that works and disabling those calls doesn't seem to make a difference.
<br/>
<br/>
Do any of you see where I'm doing something wrong?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#169990 - Cearn - Thu Aug 20, 2009 8:12 pm</h4>
    <div class="postbody"><span class="postbody">There are two issues that I can see right now. 
<br/>
<br/>
First, bitmaps aren't tilemaps. The flags you're giving grit are for tilemaps, but the background is set up for bitmaps, and copyTileMap() again assumes tilemaps. 
<br/>
<br/>
Second, be careful when using the BG_TILE_x, BG_MAP_x and BG_BMP_x macros. There is some overlap in what they actually do. In BGxCNT, the map and bmp fields use the same bits (8-12). `BG_MAP_BASE(0) | BG_BMP_BASE(1) ' is the same as just BG_MAP_BASE(1) or BG_BMP_BASE(1), namely (1&lt;&lt;8). For the x_RAM() macros, BG_TILE_RAM() and BG_BMP_RAM() give the same results (0x06000000+(n)*0x4000). 
<br/>
<br/>
Decide which one you want: bitmaps or tilemaps. Then choose your settings accordingly.
<br/>
<br/>
For tilemaps, use BG_TILE_x() and BG_MAP_x(); for bitmaps, only use BG_BMP_x().</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#169992 - 0xdeadbeef - Thu Aug 20, 2009 8:55 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Cearn wrote:</b></span></td> </tr> <tr> <td class="quote">First, bitmaps aren't tilemaps. The flags you're giving grit are for tilemaps, but the background is set up for bitmaps, and copyTileMap() again assumes tilemaps.</td> </tr></table><span class="postbody">
<br/>
<br/>
The moment I read this I figured out what I did wrong.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">REG_BG2CNT = BG_RS_32x32 | BG_TILE_BASE(1) | BG_MAP_BASE(0) | BG_PRIORITY(2)</td> </tr></table><span class="postbody">
<br/>
<br/>
<br/>
And then 
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Cearn wrote:</b></span></td> </tr> <tr> <td class="quote">For tilemaps, use BG_TILE_x() and BG_MAP_x(); for bitmaps, only use BG_BMP_x().</td> </tr></table><span class="postbody">
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">dmaCopyHalfWords(DMA_CHANNEL, tile, (u16*) BG_TILE_RAM(1), tileLen);</td> </tr></table><span class="postbody">
<br/>
<br/>
That fixed my problems. Thanks a lot, I was getting pretty frustrated by this.
<br/>
<br/>
Would you know if it's possible to debug using arm-eabi-gdb ? At the moment what I do is program -&gt; compile -&gt; test on no$gba, but I'm pretty sure that at some point in the future I'm going to make a bug where a debugger might be handy.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
