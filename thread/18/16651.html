<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Setting camera/view for picking - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > Setting camera/view for picking</h2>
<div id="posts">
<div class="post">
    <h4>#168636 - Drovor - Tue May 12, 2009 4:42 pm</h4>
    <div class="postbody"><span class="postbody">I'm new to 3d programming and I'm having some trouble ordering the OpenGL calls properly.  I'm hoping I'm doing something obviously wrong with the camera, but I haven't been able to figure it out.
<br/>
<br/>
I have implemented 3D picking using the algorithm in the picking demo where I render a 1 pixel viewport around the cursor and check if it changes after each polygon is drawn (genius idea!).
<br/>
<br/>
It works 100% when the camera has z&lt;0, but when I start to move my camera around (specifically along the z-axis through the x/y plane) it fails.
<br/>
<br/>
Here is all the relevant code (I think!)
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
// main loop
<br/>
while (1)
<br/>
{
<br/>
     // snip: touch/key handling
<br/>
<br/>
    // these just call glLight
<br/>
    light0.set();
<br/>
    light1.set();
<br/>
  
<br/>
    glViewport(0,0,255,191); // set the viewport to fullscreen
<br/>
    glMatrixMode(GL_PROJECTION);
<br/>
    glLoadIdentity();
<br/>
<br/>
    // this just calls gluPerspective...
<br/>
    cam.Perspective()
<br/>
<br/>
    //change cull mode / enable lights
<br/>
      glPolyFmt(POLY_ALPHA(31) | POLY_CULL_FRONT | light0.getPolyFmtFlag() | light1.getPolyFmtFlag()  | POLY_ID(1));
<br/>
<br/>
    // Set the current matrix to be the model matrix
<br/>
    glMatrixMode(GL_MODELVIEW);
<br/>
    glLoadIdentity();
<br/>
<br/>
    // gluLookAt, location (0,0, variable-z), looking at origin, y=up
<br/>
    cam.render();
<br/>
<br/>
    // draws a grid of quads, essentially a bunch of 3D tiles
<br/>
    ug-&gt;draw()
<br/>
<br/>
<br/>
    // This only half works
<br/>
    if( held &amp; KEY_TOUCH)
<br/>
      ug-&gt;pickPoint(touchXY.px, touchXY.py, cam);
<br/>
<br/>
    swiWaitForVBlank();
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Here is my picking code, I'm moving the camera along the Z-axis and when z&lt;0 it works 100%, but when z&gt;0 it doesn't.  <span style="font-weight: bold">I think because I'm setting up my camera wrong.</span>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
bool UndergroundDrawGrid::pickPoint(int x, int y, Camera &amp;cam)
<br/>
{
<br/>
  // This flag makes it so "startCheck" and "endCheck" are called
<br/>
  // before and after every polygon is drawn
<br/>
  pickMode = true;
<br/>
<br/>
<br/>
    int viewport[]={0,0,255,191}; // used later for gluPickMatrix()
<br/>
    glViewport(0,192,0,192); // set the viewport to fullscreen
<br/>
    glMatrixMode(GL_PROJECTION);
<br/>
    glLoadIdentity();
<br/>
      // render only what is below the cursor
<br/>
    gluPickMatrix(x,(191-y),4,4,viewport);
<br/>
      // same perspective as the earlier call
<br/>
    cam.Perspective();
<br/>
    glMatrixMode(GL_MODELVIEW);
<br/>
<br/>
    // where do I setup the camera?? It doesn't work at all if I put either of these 2 calls in.
<br/>
//    glLoadIdentity();
<br/>
//    cam.render();
<br/>
<br/>
  // de-select the previously selected object.
<br/>
  if (picked)
<br/>
     picked-&gt;picked = false;
<br/>
<br/>
<br/>
  // "pickMode" flags will do the magic
<br/>
  // using the same draw() function it enables startCheck() and endCheck() to be
<br/>
  // called before/after each polygon and save the object which is picked
<br/>
  // to "picked"
<br/>
  draw();
<br/>
<br/>
  // if it was hit, mark the new object as picked.
<br/>
  // also will mark the old one if a new one wasn't set.
<br/>
  if (picked)
<br/>
    picked-&gt;picked = true;
<br/>
<br/>
  pickMode = false;
<br/>
<br/>
  return endCheck();
<br/>
}
<br/>
<br/>
<br/>
<br/>
// These are pretty much lifted straight from the picking demo:
<br/>
void UndergroundDrawGrid::startCheck()
<br/>
{
<br/>
  while(PosTestBusy()); // wait for the position test to finish
<br/>
  while(GFX_BUSY); // wait for all the polygons from the last object to be drawn
<br/>
  PosTest_Asynch(0,0,0); // start a position test at the current translated position
<br/>
  polyCount = GFX_POLYGON_RAM_USAGE; // save the polygon count
<br/>
}
<br/>
<br/>
bool UndergroundDrawGrid::endCheck()
<br/>
{
<br/>
  while(GFX_BUSY); // wait for all the polygons to get drawn
<br/>
  while(PosTestBusy()); // wait for the position test to finish
<br/>
  if(GFX_POLYGON_RAM_USAGE&gt;polyCount) // if a polygon was drawn
<br/>
  {
<br/>
    {
<br/>
      // this is currently the closest object under the cursor!
<br/>
      closeW=PosTestWresult();
<br/>
      return true;
<br/>
    }
<br/>
  }
<br/>
  return false;
<br/>
}
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#168642 - Drovor - Tue May 12, 2009 8:36 pm</h4>
    <div class="postbody"><span class="postbody">I was trying to optimize by only drawing 1 side of the cubes during the picking check, and I'm guessing the rectangle is only visible from one side so there was nothing to hit.
<br/>
<br/>
After removing this and drawing the scene normally picking works the it is supposed to.
<br/>
<br/>
*Edit*
<br/>
Added this right before drawing my simplified scene and it did the trick:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
  // opaque polygons, no culling, this fixes my problems.
<br/>
  glPolyFmt(POLY_ALPHA(31) | POLY_CULL_NONE);
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
