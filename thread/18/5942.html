<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Working on an NDS savefile backup program. - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>DS development > Working on an NDS savefile backup program.</h2>
<div id="posts">
<div class="post">
    <h4>#44799 - Dark Knight ez - Sun Jun 05, 2005 2:33 pm</h4>
    <div class="postbody"><span class="postbody">I've coded the interface and some other parts of a backup program that lets one store NDS saves on a GBA flashcard, and also to write it back. I ran into a few problems though, since I'm new to coding C and coding for NDS, so I was wondering if you guys could help me out on these issues.
<br/>
<br/>
First of all, it was recommended to use this line of code
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">if (memcmp((void*)0x080000AC, "PASS", 4) == 0) {}</td> </tr></table><span class="postbody">
<br/>
However, I don't know where the function memcmp is stored, and how to 'link' to it. Could you give me a quick how-to on that?
<br/>
<br/>
Further more, I've noticed that in ndslib with the cardReadEeprom and cardWriteEeprom functions, there is a comment in its proximity directed at darkfader on fixing some stuff. Do the two functions I just mentioned require any fixing before I can use them, or do they work properly yet?
<br/>
<br/>
With cardWriteEeprom it is noted that it doesn't work for small Eeproms. How small are we talking about here? It could affect some of my code. Does the same apply to cardReadEeprom?
<br/>
<br/>
Further more, if anyone of you would be willing to review my code so far, I'd be ever so grateful. I've been programming in Java for quite some time, but most of what I've done so far in this program right now was guesswork and copy-paste (built in a day), but it all seems to work so far (tested it on hardware). Especially the (so far) actual saving and back-up part will need checking, since those are the only parts that could cause unwanted 'damage'.
<br/>
<br/>
Thanks in advance,
<br/>
Dark Knight ez.
<br/>
<br/>
<br/>
P.S.
<br/>
This is a link to the current source for this project, so you could review it / look it through. I'd really appreciate it.
<br/>
<a href="http://www.few.vu.nl/~ssstolk/temp/main.cpp" target="_blank">http://www.few.vu.nl/~ssstolk/temp/main.cpp</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#44804 - tepples - Sun Jun 05, 2005 4:11 pm</h4>
    <div class="postbody"><span class="postbody">memcmp() is in libc, which is linked by default to all programs. To bring in its prototype, do #include &lt;string.h&gt; (in C) or #include &lt;cstring&gt; (in C++).
<br/>
<br/>
Based on what I know about EEPROM save on the GBA, I'm guessing that the smaller EEPROMs might require a shorter address to be sent.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#44807 - strager - Sun Jun 05, 2005 5:03 pm</h4>
    <div class="postbody"><span class="postbody">A faster method is to compare it as if it were an integer:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">if(*(u32 *)(0x080000AC) == (u32)('PASS')) {}</td> </tr></table><span class="postbody">
<br/>
Or you could pack into a define.  It confuses me on why people don't use this method...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#44809 - Dark Knight ez - Sun Jun 05, 2005 6:40 pm</h4>
    <div class="postbody"><span class="postbody">That particular line of code causes the warning "multi-character character constant", when I try to build it. Probably due to comparing a (u32) with a (u32 *), or something.
<br/>
I guess I'll use the include for now, unless you could give a non-warning giving version of that.
<br/>
<br/>
Thanks to both of you.
<br/>
<br/>
Would still like information on the other issues.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#44810 - tepples - Sun Jun 05, 2005 6:52 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>strager wrote:</b></span></td> </tr> <tr> <td class="quote">A faster method is to compare it as if it were an integer:
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">if(*(u32 *)(0x080000AC) == (u32)('PASS')) {}</td> </tr></table><span class="postbody">
<br/>
Or you could pack into a define.  It confuses me on why people don't use this method...</span></td> </tr></table><span class="postbody">
<br/>
Several reasons: <ul><li>The value of a multicharacter literal is implementation-defined. You can't be sure whether a particular toolchain will need 'PASS' or 'SSAP' without reading the manual every time you upgrade; in fact, GCC breaks the C standard by <a class="postlink" href="http://gcc.gnu.org/onlinedocs/gcc-3.4.4/gcc/Characters-implementation.html#Characters-implementation" target="_blank">failing to document its behavior</a>. </li><li>A lot of people don't know of the <span style="font-weight: bold">-Wno-multichar</span> option to suppress the warning that Dark Knight ez mentions. </li></ul><br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#45182 - Dark Knight ez - Wed Jun 08, 2005 10:35 am</h4>
    <div class="postbody"><span class="postbody">I just realised that this save backup program isn't all that useful. For savefiles of the size of 512 bytes, you'd already need 10 runs (saving 56 bytes per run with this program), which is kind of doable, but for savegames larger than that.... it would be madness.
<br/>
<br/>
Unless someone knows how to be able to save way larger chunks of data on the gba flashcard's sram, this program will be useless. (Although I still intend to use it for a specific game I own, with a savesize of 512 bytes.)
<br/>
<br/>
Further more, I've had a glance at the NDS Tech Wiki on the DS card registers for writing and reading a savegame, and now I understand why ndslib mentioned "fixing" of the write and read functions: the functinos of the registers aren't fully understood, it seems (or not yet updated at the site).</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#45213 - josath - Wed Jun 08, 2005 6:05 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Dark Knight ez wrote:</b></span></td> </tr> <tr> <td class="quote">I just realised that this save backup program isn't all that useful. For savefiles of the size of 512 bytes, you'd already need 10 runs (saving 56 bytes per run with this program), which is kind of doable, but for savegames larger than that.... it would be madness.</td> </tr></table><span class="postbody">
<br/>
<br/>
I don't see a problem, ever heard of 'for' loops?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#45227 - wintermute - Wed Jun 08, 2005 8:44 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tepples wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>strager wrote:</b></span></td> </tr> <tr> <td class="quote">A faster method is to compare it as if it were an integer:
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">if(*(u32 *)(0x080000AC) == (u32)('PASS')) {}</td> </tr></table><span class="postbody">
<br/>
Or you could pack into a define.  It confuses me on why people don't use this method...</span></td> </tr></table><span class="postbody">
<br/>
Several reasons: <ul><li>The value of a multicharacter literal is implementation-defined. You can't be sure whether a particular toolchain will need 'PASS' or 'SSAP' without reading the manual every time you upgrade;
<br/>
</li></ul></span></td> </tr></table><span class="postbody">
<br/>
<br/>
the order of multichar literals has nothing to do with implementation, it's defined by the endianness of the system.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
 in fact, GCC breaks the C standard by <a class="postlink" href="http://gcc.gnu.org/onlinedocs/gcc-3.4.4/gcc/Characters-implementation.html#Characters-implementation" target="_blank">failing to document its behavior</a>. <li>A lot of people don't know of the <span style="font-weight: bold">-Wno-multichar</span> option to suppress the warning that Dark Knight ez mentions. </li></td> </tr></table><span class="postbody">
<br/>
<br/>
given that gcc is a multisystem compiler and works in the endianness of the system you're compiling for, I fail to see how gcc can document this.
<br/>
<br/>
code for the DS 
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">if(*(u32 *)(0x080000AC) == (u32)('SSAP')) {}</td> </tr></table><span class="postbody">
<br/>
<br/>
<br/>
it's little endian. Stragers method will obviously only work on big endian systems.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#45230 - natrium42 - Wed Jun 08, 2005 8:51 pm</h4>
    <div class="postbody"><span class="postbody">Bah, you can always do this if unsure:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">if(*(u32 *)(0x080000AC) == (u32)('SSAP') || *(u32 *)(0x080000AC) == (u32)('PASS')) {}</td> </tr></table><span class="postbody">
<br/>
Who cares about some demo named "SSAP" :P<br/>_________________<br/><a class="postlink" href="http://www.natrium42.com" target="_blank">www.natrium42.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#45232 - strager - Wed Jun 08, 2005 9:05 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>wintermute wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">if(*(u32 *)(0x080000AC) == (u32)('SSAP')) {}</td> </tr></table><span class="postbody">
<br/>
it's little endian. Stragers method will obviously only work on big endian systems.</span></td> </tr></table><span class="postbody">
<br/>
Like DOS :-)
<br/>
<br/>
You could just add a bit in the IPC-&gt;buttons (bit 7?) that signals that it is OK to write to SRAM.  It would save a few instructions (maybe) and speed the code up (maybe), but it will have its cons (haven't found any yet but more work for the ARM7).
<br/>
<br/>
No matter.  Anyone can use whichever method they choose.  It's not like it is required to have super-optimized memcmp.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#45236 - dagamer34 - Wed Jun 08, 2005 9:39 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>strager wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>wintermute wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">if(*(u32 *)(0x080000AC) == (u32)('SSAP')) {}</td> </tr></table><span class="postbody">
<br/>
it's little endian. Stragers method will obviously only work on big endian systems.</span></td> </tr></table><span class="postbody">
<br/>
Like DOS :-)
<br/>
<br/>
You could just add a bit in the IPC-&gt;buttons (bit 7?) that signals that it is OK to write to SRAM.  It would save a few instructions (maybe) and speed the code up (maybe), but it will have its cons (haven't found any yet but more work for the ARM7).
<br/>
<br/>
No matter.  Anyone can use whichever method they choose.  It's not like it is required to have super-optimized memcmp.</span></td> </tr></table><span class="postbody">
<br/>
<br/>
It would still need to be checked every second or so, as to prevent from writing to a commercial game's SRAM if the game pak is swapped for some odd reason.<br/>_________________<br/>Little kids and Playstation 2's don't mix. :(</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#45237 - Diskun - Wed Jun 08, 2005 9:47 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>dagamer34 wrote:</b></span></td> </tr> <tr> <td class="quote">It would still need to be checked every second or so, as to prevent from writing to a commercial game's SRAM if the game pak is swapped for some odd reason.</td> </tr></table><span class="postbody">Why bother? Every game that uses save function reads "Don't switch off your DS nor remove the game card from the slot" (or whatever). If the user swaps the game during the backup process is HIS problem, not the coder's.
<br/>
<br/>
Do it easy.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#45262 - tepples - Thu Jun 09, 2005 3:00 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>wintermute wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tepples wrote:</b></span></td> </tr> <tr> <td class="quote">The value of a multicharacter literal is implementation-defined. You can't be sure whether a particular toolchain will need 'PASS' or 'SSAP' without reading the manual every time you upgrade;</td> </tr></table><span class="postbody">
<br/>
the order of multichar literals has nothing to do with implementation, it's defined by the endianness of the system.</span></td> </tr></table><span class="postbody">
<br/>
The C standard states that the value is implementation defined. A compiler is free to turn 'PASS' into 'P' 'A' 'S' 'S', 'S' 'S' 'A' 'P', or anything else, as long as the manual documents the behavior. The endianness of the system doesn't matter for this purpose.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">in fact, GCC breaks the C standard by <a class="postlink" href="http://gcc.gnu.org/onlinedocs/gcc-3.4.4/gcc/Characters-implementation.html#Characters-implementation" target="_blank">failing to document its behavior</a>.</td> </tr></table><span class="postbody">
<br/>
given that gcc is a multisystem compiler and works in the endianness of the system you're compiling for, I fail to see how gcc can document this.</span></td> </tr></table><span class="postbody">
<br/>
I would expect something to the effect of the following: "On SYSTEM1, SYSTEM2, and SYSTEM3, multicharacter literals are packed with earlier character codes in more significant bits. On SYSTEM4, SYSTEM5, and SYSTEM6, multicharacter literals are packed with earlier character codes in less significant bits."<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#45271 - wintermute - Thu Jun 09, 2005 3:42 am</h4>
    <div class="postbody"><span class="postbody">mkay, apologies. I seem to have been mixing up system memory behaviour with the compiler behaviour and assumed that multi-char literals were placed in the register with the first character as msb.
<br/>
<br/>
<a href="http://gcc.gnu.org/onlinedocs/cpp/Implementation_002ddefined-behavior.html" target="_blank">http://gcc.gnu.org/onlinedocs/cpp/Implementation_002ddefined-behavior.html</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#45319 - Dark Knight ez - Thu Jun 09, 2005 4:38 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>josath wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Dark Knight ez wrote:</b></span></td> </tr> <tr> <td class="quote">I just realised that this save backup program isn't all that useful. For savefiles of the size of 512 bytes, you'd already need 10 runs (saving 56 bytes per run with this program), which is kind of doable, but for savegames larger than that.... it would be madness.</td> </tr></table><span class="postbody">
<br/>
<br/>
I don't see a problem, ever heard of 'for' loops?</span></td> </tr></table><span class="postbody">
<br/>
<br/>
<br/>
Yes, but I don't know how to allocate more size for saving purposes on the gba flashcard's sram, than 64bytes... nor how to address it. Didn't I mention that somewhere in this post?
<br/>
If there's a way to do that, then yes, I could use a for-loop for example.
<br/>
<br/>
<br/>
edit:
<br/>
My bad. Stupid me. GBA saveram is usually 64 Kbytes, not 64 bytes.
<br/>
*whaps self*</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
