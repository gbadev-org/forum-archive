<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Writing a performance analyser - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>DS development > Writing a performance analyser</h2>
<div id="posts">
<div class="post">
    <h4>#112721 - simonjhall - Tue Dec 19, 2006 8:51 pm</h4>
    <div class="postbody"><span class="postbody">I'm reaching the stage with my Quake port where the performance is starting to become my main focus. Yeah, you're gonna automatically say that it's in the rendering, but that's not actually true :-)
<br/>
As I can't whip out a profiler to see what's going on (I seem to remember gprof moaning at me when linking), I'm thinking about rolling my own. An alternate method of properly finding bottlenecks in the code would be to add profiling support to an emulator (not too hard...).
<br/>
<br/>
The most obvious way to do this would be to add a custom epilogue and prologue to each function, but I can't find an obvious way of telling gcc that I'd like to do this.
<br/>
<br/>
So...has anyone ever set up their own prologue with gcc? I can see options for other architectures, just not ARM.
<br/>
<br/>
----
<br/>
Oh another way would be to replace all bl-s/bx-s with a dash of code but I'd like to do it properly for once :-D<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#112722 - spectre1989 - Tue Dec 19, 2006 8:52 pm</h4>
    <div class="postbody"><span class="postbody">Not quite sure how to solve your problem, but just wanted to say it sounds like an awesome idea :)<br/>_________________<br/><a class="postlink" href="http://www.pro-test.org.uk/" target="_blank">Pro-test: Standing up for science, standing up for what's right</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#112729 - nornagon - Tue Dec 19, 2006 11:03 pm</h4>
    <div class="postbody"><span class="postbody">The US$1750 version of no$gba has a profiler :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#112737 - simonjhall - Tue Dec 19, 2006 11:28 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">The US$1750 version of no$gba has a profiler :)</td> </tr></table><span class="postbody">Sweet! Although I'll be damned if I'll buy it - I'd much rather write my own emulator!
<br/>
<br/>
But anyway, I couldn't seem to find an obvious way into the gcc prolog so I decided to have a proper look at the insides of gprof. Yeah, linker errors (fixed with stub functions), then power-on errors, then what looked like corrupt instructions...
<br/>
But I'm making progress! After stepping through a simple function in the debugger I think I can see what's going on - gcc inserts the address of a piece of memory directly after the branch to the performance-timing function. Time to rewrite my (stub) performance-timer in (my rusty) assembler :-)
<br/>
<br/>
This looks easier than I expected...<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#112740 - tepples - Tue Dec 19, 2006 11:50 pm</h4>
    <div class="postbody"><span class="postbody">Profiling on a GBA or DS is a matter of reading VCOUNT at various points in the game loop.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#112744 - simonjhall - Tue Dec 19, 2006 11:58 pm</h4>
    <div class="postbody"><span class="postbody">Yeah, that's the easy option! (ie similar to what I'm already doing...)
<br/>
I really want something which prints out a big list of all the functions called and the amount of milliseconds spent in them, how many times called etc.
<br/>
<br/>
What does VCOUNT actually do (ie when is it what value if you get my gist)? What happens if it's value is read and then read again after exactly one vertical blank - will VCOUNT be the same both times it's read?<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#112748 - tepples - Wed Dec 20, 2006 12:03 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>simonjhall wrote:</b></span></td> </tr> <tr> <td class="quote">What does VCOUNT actually do (ie when is it what value if you get my gist)?</td> </tr></table><span class="postbody">
<br/>
The value of VCOUNT is the Y position of the scanline that the 2D engine is (GBA) or 2D engines are (DS) rendering.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">What happens if it's value is read and then read again after exactly one vertical blank - will VCOUNT be the same both times it's read?</td> </tr></table><span class="postbody">
<br/>
Yes.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#112749 - Dark Knight ez - Wed Dec 20, 2006 12:04 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">VCOUNT - Vertical Counter (Read only)
<br/>
<span style="font-weight: bold">Indicates the currently drawn scanline</span>, values in range from 160-227 indicate 'hidden' scanlines within VBlank area.</td> </tr></table><span class="postbody">
<br/>
<br/>
edit: Tepples beat me to it. :)<br/>_________________<br/><span style="font-size: 9px; line-height: normal"><a class="postlink" href="http://amplituds.drunkencoders.com" target="_blank">AmplituDS website</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#112755 - simonjhall - Wed Dec 20, 2006 12:28 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">VCOUNT - Vertical Counter (Read only)
<br/>
<span style="font-weight: bold">Indicates the currently drawn scanline</span>, values in range from 160-227 indicate 'hidden' scanlines within VBlank area.</td> </tr></table><span class="postbody">So what would the value be when it's at scanline 191? Scanlines 0 to 191 are visible, right? I always assumed the screen was 256x192...<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#112757 - sasq - Wed Dec 20, 2006 12:40 am</h4>
    <div class="postbody"><span class="postbody">Another way is to us a timer interrupt and store the location of the PC and use that to look up which function was interrupted and count how many times each function was interrupted.
<br/>
Not as exact but requires no changes to the code.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#112767 - tepples - Wed Dec 20, 2006 1:34 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>simonjhall wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">VCOUNT - Vertical Counter (Read only)
<br/>
<span style="font-weight: bold">Indicates the currently drawn scanline</span>, values in range from 160-227 indicate 'hidden' scanlines within VBlank area.</td> </tr></table><span class="postbody">So what would the value be when it's at scanline 191?</span></td> </tr></table><span class="postbody">
<br/>
191. On the DS, this scanline is visible; on the GBA, it isn't.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Scanlines 0 to 191 are visible, right? I always assumed the screen was 256x192...</td> </tr></table><span class="postbody">
<br/>
GBA screen is 160 lines plus 68 blank lines. DS screen is 192 lines plus 71 blank lines.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#112773 - simonjhall - Wed Dec 20, 2006 2:09 am</h4>
    <div class="postbody"><span class="postbody">Reading the docs on nocash, it seems that the non-visble scanlines don't trigger an interrupt - can anyone confirm this? It'll be a bit of a crap time base if the the gap between 0, 1, 2, 3, 4....191 is consistent then there's suddenly a long gap from 192 to 0 again!<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#112779 - tepples - Wed Dec 20, 2006 3:25 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>simonjhall wrote:</b></span></td> </tr> <tr> <td class="quote">Reading the docs on nocash, it seems that the non-visble scanlines don't trigger an interrupt - can anyone confirm this? It'll be a bit of a crap time base if the the gap between 0, 1, 2, 3, 4....191 is consistent then there's suddenly a long gap from 192 to 0 again!</td> </tr></table><span class="postbody">
<br/>
At least on the GBA, hblank DMA is paused during vblank, but the vcount is <span style="font-style: italic">not</span> paused (..., 159, 160, 161, ..., 226, 227, 0, ...), and neither are hblank interrupts.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#112827 - simonjhall - Wed Dec 20, 2006 4:53 pm</h4>
    <div class="postbody"><span class="postbody">Yar! Thar be profiling!
<br/>
I've got it working nicely now - I run my program, it stops after a while, dumps the results to a file and I can check out the results on the PC. Here's an example of what I get:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">Loading symbols from squake ... OK
<br/>
Seen 3118 symbols, stored 1891 function offsets
<br/>
        address      calls seconds function
<br/>
        0x2050a7c,      1, 0.0000, quake_main
<br/>
        0x2050a18,   2441, 0.9714, Sys_Printf
<br/>
        0x20153f8,      1, 0.3109, Host_Init
<br/>
        0x200734c,    121, 0.0211, Cmd_AddCommand
<br/>
        0x200bb64,    121, 0.0097, Cvar_VariableString
<br/>
        0x200ba00,    332, 0.0266, Cvar_FindVar
<br/>
        0x2007e88,      1, 0.0006, Cbuf_Init
<br/>
        0x2007438,      1, 0.0001, Cmd_Init
<br/>
        0x204d574,      1, 0.0018, V_Init
<br/>
        0x200ba90,    131, 0.0372, Cvar_RegisterVariable
<br/>
        0x20072c0,    131, 0.0113, Cmd_Exists
<br/>
        0x204d460,      3, 0.0409, BuildGammaTable
<br/>
        0x2006dec,      1, 0.0004, Chase_Init
<br/>
        0x2013f68,      1, 0.0000, Host_InitVCR
<br/>
        0x200b108,     36, 0.1166, Con_Printf</td> </tr></table><span class="postbody">
<br/>
At the moment I can only see how much time has been spent between the beginning and exit of a function, and that includes all the time spent in child functions. It's a bit crap but it'll do for now... Oh and the executable size is pretty epic now - including all this profiling code has increased its size by like 20%. Not cool.
<br/>
Apparently there's support for per-line profiling in gcc - that'd be really useful but I doubt I'd be able to get both the executable and data in memory at the same time :-(
<br/>
<br/>
EDIT: the method mentioned by sasq would be probably best if I wanted high-resolution timing, plus the executable wouldn't be any larger. Dunno how fast I can set a timer though.<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#112863 - simonjhall - Wed Dec 20, 2006 10:19 pm</h4>
    <div class="postbody"><span class="postbody">I've done yet more work on the profiler and I think it's pretty much finished now. You can now get the self time, call traces, etc for every function run by your program - and it seems pretty accurate too! Quickest project ever :-D
<br/>
<br/>
And I'm thinking of releasing both this and Quake 1 at the same time, and probably re-releasing the debugger too (with ARM7 goodness). Stay tuned!
<br/>
<br/>
I'd still like per-line (ie, pc) profiling, but I don't think that's gonna happen. I'd also like to do hit counting on the floating-point emulation functions inserted by the compiler, but I'd need to be able to recompile libgcc to do that. Any chance of getting profile versions of this with the next devkitpro?<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#112874 - chishm - Thu Dec 21, 2006 12:03 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>simonjhall wrote:</b></span></td> </tr> <tr> <td class="quote">And I'm thinking of releasing both this and Quake 1 at the same time, and probably re-releasing the debugger too (with ARM7 goodness). Stay tuned!</td> </tr></table><span class="postbody">
<br/>
How's the lawyer situation going with that?<br/>_________________<br/><a class="postlink" href="http://chishm.drunkencoders.com" target="_blank">http://chishm.drunkencoders.com</a>
<br/>
<a class="postlink" href="http://dldi.drunkencoders.com" target="_blank">http://dldi.drunkencoders.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#113058 - simonjhall - Fri Dec 22, 2006 4:26 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>chishm wrote:</b></span></td> </tr> <tr> <td class="quote">How's the lawyer situation going with that?</td> </tr></table><span class="postbody">
<br/>
Err... Yeah...<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#113996 - Puyo - Tue Jan 02, 2007 2:59 pm</h4>
    <div class="postbody"><span class="postbody">Hello simonjhall! Any improvments on this one?
<br/>
I was wondering about how this works? Is it some kind of library? Will it be compatible with DevkitPro`s gcc? Interested in trying it out.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#113998 - simonjhall - Tue Jan 02, 2007 3:39 pm</h4>
    <div class="postbody"><span class="postbody">Nah, I sorta finished it! There's also so little code needed I didn't even bother putting it in a library!
<br/>
<br/>
It doesn't use gcc's -pg option (or whatever the profile option is) as I couldn't find any docs as to the format of the gprof data that should be emitted. Also it only inserts a stub at the beginning of the function, and not at the end. I couldn't figure out how to do the things I wanted with just that (I needed an exit call) so I found another way...
<br/>
<br/>
gcc has an function instrumentation option which inserts a call to a function of your choice on entry and exit of every function (that is built with the option). That's cool, but you need to store for every function a few bits of data like time spent, number of hits etc. You could keep this in some kind of array, but you'd have to search for that entry every time the function is hit, or use some kind of hash table. So what I really wanted was an easily findable word of memory for every function. I could then put in that word a pointer to where the real stats are stored (my array). gcc also provides an option to push the name of the function directly before each function so I basically trash that and put my pointer in there :-)
<br/>
<br/>
When a function is exited the amount of time spent in it is computed by taking the current time minus the entry time minus the time spent in child functions. The time is measured in hblanks. It's surprisingly accurate and slows down Quake by just a few percent. At some predetermined point (eg after 100 frames) I then dump the results. On the PC I have a perl script which parses the output and makes it all nice and readable.
<br/>
<br/>
It's been a complete godsend as there are some functions I never realised were expensive!
<br/>
Have a read of this, as this is where I derived the core function hook info from:
<br/>
<a href="http://www.logix.cz/michal/devel/CygProfiler/" target="_blank">http://www.logix.cz/michal/devel/CygProfiler/</a>
<br/>
It only does half of the job though (does a fprintf on entry and exit, that's it) so I had to fill out the rest.
<br/>
<br/>
Oh and my version doesn't work in thumb at the moment but by the looks of it it's gcc's fault!<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#114039 - HyperHacker - Wed Jan 03, 2007 3:02 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>simonjhall wrote:</b></span></td> </tr> <tr> <td class="quote">gcc also provides an option to push the name of the function directly before each function</td> </tr></table><span class="postbody">
<br/>
o_o and how do I activate that?<br/>_________________<br/>I'm a PSP hacker now, but I still &lt;3 DS.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#114128 - simonjhall - Thu Jan 04, 2007 10:07 am</h4>
    <div class="postbody"><span class="postbody">Sorry about the delay. I think it's something like -mpoke-function-name.
<br/>
I'll paste the code up here when I get back from work, if you like.
<br/>
<br/>
It'd be nice to not have to use this option, as it increases the file size a bit more than I'd like... And I still have to fix the thumb support. Once I've done that I'll be able to see which functions perform best in which mode.<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#114486 - Epicenter - Mon Jan 08, 2007 9:06 am</h4>
    <div class="postbody"><span class="postbody">This might be too simplistic for your needs but have you considered just having the program dump a 'log' file to your SD card with a report of performance? I use a profiling system in a game I wrote for PC (will probably be porting to Dreamcast) that, during each frame, times how long the major elements of generating that frame took and writes it out to a file. I don't capture every frame as I'd be writing 60 lines of text a second to the log. But I do just grab sort of a cross section of them to get an idea of the where the major slowdown is happening.
<br/>
<br/>
EDIT: looks like you already solved your problem. way to not read the thread. :D Go me.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#114494 - simonjhall - Mon Jan 08, 2007 1:30 pm</h4>
    <div class="postbody"><span class="postbody">Haha! What I wanted was a general-purpose profiler which found out exactly which functions were slow... I already knew which parts of the game were slow :-)
<br/>
<br/>
I still never got round to posting the code for this thing here...<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#115636 - Puyo - Thu Jan 18, 2007 1:26 am</h4>
    <div class="postbody"><span class="postbody">Hi! Back again. Done everything as you suggested. And it`s probably working allright. Could this be true (for test.c from cygprofiler):
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">On enter:
<br/>
<br/>
             strtVC   ---   level
<br/>
+ notmain      153    0    1
<br/>
+ function3    159    0    2
<br/>
+ function2    161    0    3
<br/>
+ function1    162    0    4
<br/>
On exit:
<br/>
<br/>
             VCspent      VCOUNT
<br/>
- function1     2     2    164
<br/>
- function2     2     2    165
<br/>
- function3     5     5    166
<br/>
- notmain       10    10    168
<br/>
</td> </tr></table><span class="postbody">
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">int function1 (void)
<br/>
{ return 0; }
<br/>
<br/>
int function2 (void)
<br/>
{ return function1 () + 1; }
<br/>
<br/>
int function3 (void)
<br/>
{ return function2 () + 1; }
<br/>
<br/>
int notmain (void)
<br/>
{ return function3 (); }</td> </tr></table><span class="postbody">
<br/>
And a question - do you count HBlanks too? I mean if function takes more than one HBlank to exit, you would never know that with VCount only, right?
<br/>
<span style="font-weight: bold">EDIT:</span> Posted "mine" test.c.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#115671 - simonjhall - Thu Jan 18, 2007 8:43 am</h4>
    <div class="postbody"><span class="postbody">Ah, it looks like you're recording the total amount of time spent in function X and all sub-functions and then printing this time out for each function. (it looks like that anyway - stop me if I'm wrong!)
<br/>
<br/>
What you really want to record is the 'self time' of a function - the amount of time spent in the function but not including any of the functions called from that function. Imagine if you have a recursive function which calls itself a hundred times then calls something expensive - the total time recorded by the recursive function will be much higher than the run time of the program! So in order to figure out the time for a function you do (exit_time - entry_time) - time_spent_in_all_subfunctions (which may be recursive)
<br/>
<br/>
Even if I've read your results wrong, kudos on the profiling!
<br/>
Oh and I do use the horizontal blanking interrupt. I find this combined with the prolog and epilog code increase the demo runtime (on Q) by about 10%. The results do look very accurate though, so hblanks are the way forward :-)
<br/>
<br/>
EDIT: there's a case which I spent ages getting the bugs out of. Dig this:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">function x
<br/>
{
<br/>
    y();
<br/>
    z();
<br/>
}
<br/>
<br/>
function y()
<br/>
{
<br/>
   whatever
<br/>
}
<br/>
<br/>
function z()
<br/>
{
<br/>
   whatever
<br/>
}
<br/>
</td> </tr></table><span class="postbody">I forgot that a function can call more than one function! It prevented me from calculating the self time properly.<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#116140 - theli - Mon Jan 22, 2007 11:20 am</h4>
    <div class="postbody"><span class="postbody">o_O erhmm.. can someone release the code you used for profiling?
<br/>
simonjhall? Puyo?
<br/>
please? :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#116142 - simonjhall - Mon Jan 22, 2007 12:17 pm</h4>
    <div class="postbody"><span class="postbody">I keep meaning to but I've been dead busy recently!
<br/>
I'll try and stick it up here later when I get back from work.<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#116168 - Puyo - Mon Jan 22, 2007 8:42 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Ah, it looks like you're recording the total amount of time spent in function X and all sub-functions and then printing this time out for each function. (it looks like that anyway - stop me if I'm wrong!) </td> </tr></table><span class="postbody">
<br/>
You knew it, I was doing exactly that =). Except that I thought I was handling all sub-functions. Guess not. Oh well... And printing for every function originally was producing all those extra VCounts. And your test case acts like it should. Thanks for help.
<br/>
<br/>
<span style="font-weight: bold">theli:</span>
<br/>
Sure, you can download example <a class="postlink" href="http://foromoh.narod.ru/profiler.zip" target="_blank">here.</a> It`s probably have a few bugs left &amp; warnings to remove, but I never bothered about `em. Only file that have profiling enabled in example is test.c (see makefile). By default it outputs to file "profile.txt" in root dir. You can remove DUMP define and change OUTPUT define to stdout, to print results on screen.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#116171 - simonjhall - Mon Jan 22, 2007 9:54 pm</h4>
    <div class="postbody"><span class="postbody">Should I post mine too, so we can compare? I'm kinda wary of putting files in my webspace in case my ISP gets arsey over quotas etc... (again)
<br/>
I guess they are only a few kilobytes in size though...<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#116181 - Puyo - Tue Jan 23, 2007 12:12 am</h4>
    <div class="postbody"><span class="postbody">Ofcourse. I`m interested, wanna check for if results differ. If you wan`t you can upload it to free hosting, but i don`t think that few KB will get you in trouble with ISP.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#116184 - simonjhall - Tue Jan 23, 2007 12:30 am</h4>
    <div class="postbody"><span class="postbody">Ok, I just uploaded it.
<br/>
<a href="http://myweb.tiscali.co.uk/simonhall/cyg-profile.c" target="_blank">http://myweb.tiscali.co.uk/simonhall/cyg-profile.c</a>
<br/>
<a href="http://myweb.tiscali.co.uk/simonhall/cyg-profile.h" target="_blank">http://myweb.tiscali.co.uk/simonhall/cyg-profile.h</a>
<br/>
<a href="http://myweb.tiscali.co.uk/simonhall/resolve.pl" target="_blank">http://myweb.tiscali.co.uk/simonhall/resolve.pl</a>
<br/>
<br/>
You compile your (ARM-only) regular code with -finstrument-functions -mpoke-function-name. Don't compile the files which handle disk access or anything related to the profiling functions, otherwise you'll get stuck in a loop.
<br/>
<br/>
Initialise the profiler with cygprofile_begin().
<br/>
Start profiling with cygprofile_enable().
<br/>
Stop profiling with cygprofile_disable().
<br/>
Write the results to disk with cygprofile_end().
<br/>
Parse the results (on the PC) with
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">./resolve.pl squake /cygdrive/k/CYGLOG.TXT &gt; /cygdrive/k/sorted.csv</td> </tr></table><span class="postbody">
<br/>
...or something like that :-)
<br/>
<br/>
These files are tailored for Quake btw, so they won't compile outa the box. I normally run my profiling for 700 frames (nearly the length of the Necropolis demo) then write everything to disk - that's why there's some divide-by-700s in the Perl script!
<br/>
<br/>
Oh and thanks go out to the people who wrote the original cyg-profile stuff (before I rewrote all the juicy bits)<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#116364 - Puyo - Wed Jan 24, 2007 8:39 pm</h4>
    <div class="postbody"><span class="postbody">So I did found a lot of bugs in my profiler. Basically because of my misunderstanding of DS hardware &amp; lack of knowledge in C.
<br/>
1st: few posts ago I was asking about HBlank interrupts, but actually I was thinking about using VBlank, simply because it happens more rarely &amp; you could add 262 HBlanks for 1 VBlank + REG_VCOUNT to measure current time. WRONG. Actually VBlank happens at 192 line &amp; that changes a lot. I could probably use it too, but some checking needs to be done than.
<br/>
2nd: saving start time of levels, not functions (solves recursivness).
<br/>
<br/>
[ random C questions ]
<br/>
And shouldn`t '<span style="font-style: italic">fwrite("name", "w")</span>' erase all data from file?
<br/>
What this means:
<br/>
<span style="color: red">warning: array subscript has type 'char'</span>
<br/>
for </span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">// entry is a array of structures &amp; funcName is array of chars
<br/>
entry[i].funcName[30] = 0; // Null-terminate string</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#116369 - simonjhall - Wed Jan 24, 2007 10:05 pm</h4>
    <div class="postbody"><span class="postbody">For the horizontal blank I too was interested in doing the vblank/hblank split thing in order to count the time (eg using VCOUNT), but in the end I just set up an interrupt. When the interrupt occurs it just increases some variable by one.
<br/>
Yeah, calling a one-line function 15000 times per second isn't too efficient, but I don't really care :-)
<br/>
<br/>
And the fwrite thing - shouldn't that be fopen instead? But yeah, it should clear the file and start writing from byte zero. When you save it won't include any of the existing stuff. I think... Or is that "w+"?
<br/>
<br/>
And the subscript warning thing - I think it's talking about either 30 or i (prob i). Can't see why it'd care though...<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#139075 - DragonMinded - Sat Sep 01, 2007 4:12 pm</h4>
    <div class="postbody"><span class="postbody">Was this ever going to be properly hosted?<br/>_________________<br/>Enter the mind of the dragon.
<br/>
<br/>
<a href="http://dragonminded.blogspot.com" target="_blank">http://dragonminded.blogspot.com</a>
<br/>
<br/>
Seriously guys, how hard is it to simply TRY something yourself?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#139127 - simonjhall - Sun Sep 02, 2007 1:42 pm</h4>
    <div class="postbody"><span class="postbody">Yeah, I'm not with tiscali any more so I'm not surprised my web space doesn't work!
<br/>
Here's it hosted on drunkencoders (thanks again to dovoto):
<br/>
<a href="http://quake.drunkencoders.com/profiler/resolve" target="_blank">http://quake.drunkencoders.com/profiler/resolve</a> (perl script)
<br/>
<a href="http://quake.drunkencoders.com/profiler/cyg-profile.c" target="_blank">http://quake.drunkencoders.com/profiler/cyg-profile.c</a>
<br/>
<a href="http://quake.drunkencoders.com/profiler/cyg-profile.h" target="_blank">http://quake.drunkencoders.com/profiler/cyg-profile.h</a>
<br/>
<br/>
Instructions per the post a few above this. It's still Quakified, but shouldn't be hard to convert to whatever you want to run it with.
<br/>
NEW STUFF: it now works in THUMB mode, so you're no longer forced to use ARM mode to get it to work.<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
