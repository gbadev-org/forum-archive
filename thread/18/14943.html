<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>gx_fifo and dma - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > gx_fifo and dma</h2>
<div id="posts">
<div class="post">
    <h4>#150123 - nce - Wed Jan 30, 2008 7:16 am</h4>
    <div class="postbody"><span class="postbody">Hi,
<br/>
<br/>
I'm currently trying to find one good way to render my 3d scene in my project.
<br/>
I've then start to look in the GXFIFO ( it's time.  I've always worked in immediat mode 'til now)
<br/>
<br/>
Reading the gbatek and some of the thread here, I'm starting to get an idea of how to do it.
<br/>
But I have several questions to be sure that I've understood everything correctly.
<br/>
<br/>
<br/>
The main idea is to try to freeze the cpu as less as possible.
<br/>
<br/>
having a scene defines as several block, each block having a displaylist.
<br/>
And a small table saved in DTCM representing the position of each block. ( and some other stuff like the camera frustrum )
<br/>
<br/>
it should be possible to :
<br/>
  1 - find a block to draw and launch a DMA copy on GXFIFO
<br/>
  2 - while the DMA is busy. compute the visiblity of other blocks and put the visible one in a small stack
<br/>
  3 - as soon as the dma is not busy launch a DMA copy of the next block in the stack. and go back to point 2
<br/>
<br/>
If I've understood correctly, if all my data are in DTCM or cache the cpu should be able to continue the computation even during the dma copy. right ?
<br/>
Do I have to put my code in ITCM too ?
<br/>
<br/>
<br/>
Next point is about the gfx fifo it-self. ( I had to read that part a lot of time to understand it :) )
<br/>
<br/>
<br/>
the fifo is 256 entries the dma will wait (without freezing the cpu) until the fifo get 128 entries free and then it will copy 112 words of data.
<br/>
The 112 words will be unpacked and if those unpacked commands fill the fifo the dma and cpu will be frezzed !
<br/>
<br/>
in the gbatek this exemple is used : sending 112 x Packed(00151515h) to GXFIFO would write 336 x Cmd(15h) to the FIFO
<br/>
for me 0x00151515 is not word but dword, this probably means that gbatek use the word "word" for 32bit value and not 16bit like I'm used to. right ?
<br/>
<br/>
so it means that when you build the call list you have to check that each 112 words doesn't unpack in more that 128 entries and you will never freeze you cpu at render time...
<br/>
<br/>
<br/>
<br/>
what do you think about this idea ? 
<br/>
<br/>
<br/>
<br/>
I was also thinking about doing more or less the same thing when rendering my characters.
<br/>
because characters are using skeleton I need the gfx to compute matrix stuff so I can't compute the skeleton at the same time as rendering the character.
<br/>
But maybe I can :
<br/>
<br/>
  1 - compute the skeleton matrix for each characters
<br/>
  2 - set all matrix in the stack for one character
<br/>
  3 - dma the call list
<br/>
  4 - while dma is busy, compute the AI for the next frame
<br/>
  5 - while dma is free back to 2
<br/>
<br/>
<br/>
<br/>
<br/>
one last thought.
<br/>
I know that the BOX_TEST exist. It should be possible for each block to send a box_test and doing something while waiting for the result as for the character and then during the rendering again doing something else.
<br/>
But, what can I do ? that's the question :) During the box_test I could do my collision code, but during the rendering ? 
<br/>
 - not the sound it uses dma too (I think, never played with that yet)
<br/>
 - I was thinking of maybe doing some sort of bloom, but I can't store the buffer in DTCM ( too big )
<br/>
<br/>
any idea ?
<br/>
<br/>
<br/>
what do you thing will be faster ? the first or the second idea ?
<br/>
<br/>
<br/>
<br/>
thanks,<br/>_________________<br/>-jerome-</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#150126 - simonjhall - Wed Jan 30, 2008 9:03 am</h4>
    <div class="postbody"><span class="postbody">Just a quick reply as I have to run to work!
<br/>
a) you're right, you want to freeze the cpu for as little time as possible. By accessing main memory whilst you use dma, you'll slow down both the dma and the regular load/stores. By putting your data in dtcm you'll avoid bus traffic and hopefully everything will go faster
<br/>
<br/>
b) by putting code in itcm, when you get icache misses it won't have to access the bus, slowing down the dma. Remember to put you interrupt handlers in here too if you really want to avoid bus traffic.
<br/>
<br/>
c) remember that dma can't access the stack, dtcm or itcm
<br/>
<br/>
d) the idea of pre-calcing blocks and dmaing them off whist visibility testing is good. That's what I do :-)
<br/>
You could even build the display lists on the second processor. Don't forget about data caching.
<br/>
<br/>
e) the world limit and that packed-&gt;unpacked thing: don't worry. Remember that the thing mentioned about unpacking and running out and slowing down is for commands which have no arguments. I'm sure that the majority of your commands will have arguments, and they don't get packed/unpacked - cos they're just data.
<br/>
<br/>
f) afaik, you can't put a box test in a display list.
<br/>
<br/>
Time to go to work :(<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#150191 - wintermute - Thu Jan 31, 2008 1:08 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>simonjhall wrote:</b></span></td> </tr> <tr> <td class="quote">Just a quick reply as I have to run to work!
<br/>
a) you're right, you want to freeze the cpu for as little time as possible. By accessing main memory whilst you use dma, you'll slow down both the dma and the regular load/stores. By putting your data in dtcm you'll avoid bus traffic and hopefully everything will go faster
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Not entirely true - the CPU will be stalled if it accesses hardware registers which means interrupts will be delayed during DMA. Also remember that data in DTCM reduces the space available for your stack.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
b) by putting code in itcm, when you get icache misses it won't have to access the bus, slowing down the dma. Remember to put you interrupt handlers in here too if you really want to avoid bus traffic.
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
See above. The CPU will be stalled in the dispatcher. The libnds dispatcher is already in itcm.<br/>_________________<br/><a class="postlink" href="http://www.devkitpro.org/" target="_blank">devkitPro - professional toolchains at amateur prices</a>
<br/>
<a class="postlink" href="http://wiki.devkitpro.org/index.php/IRC" target="_blank">devkitPro IRC support</a>
<br/>
<a class="postlink" href="http://davejmurphy.com/" target="_blank">Personal Blog</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#150213 - simonjhall - Thu Jan 31, 2008 9:00 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>wintermute wrote:</b></span></td> </tr> <tr> <td class="quote">Not entirely true - the CPU will be stalled if it accesses hardware registers which means interrupts will be delayed during DMA. Also remember that data in DTCM reduces the space available for your stack.</td> </tr></table><span class="postbody">Oh really! I'd never thought about that actually!
<br/>
<br/>
But yeah I doubt DMA is gonna be noticably faster by doing absolutely zero work on the bus - someone wanna knock up an example to see?
<br/>
One way to do it would be to turn off interrupts, stick the code (on both cpus) in a tight loop and get a bunch of DMA transfers all going from different addresses. If the time they take (combined) is noticably longer than the time they would do if you were run sequentially then...you see where I'm going here!<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#150427 - nce - Mon Feb 04, 2008 11:19 am</h4>
    <div class="postbody"><span class="postbody">Hi,
<br/>
<br/>
and thx for your replies  :) 
<br/>
<br/>
I'v continued to think about this idea.  
<br/>
From what you said, it looks probably quite complex to get a dma working really in parallele with the cpu.
<br/>
<br/>
So the new idea :
<br/>
- I could maybe cut the environment in block of 256 entries.
<br/>
- copy those 256 entries with a memcpy (some thread here looks to say that the memcopy is faster than a dma copy)
<br/>
- then do some computation (no need to be in the DTCM anymore) while waiting for the FIFO to be empty.
<br/>
<br/>
<br/>
Is this sound stupid ?<br/>_________________<br/>-jerome-</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#150480 - elhobbs - Tue Feb 05, 2008 2:38 pm</h4>
    <div class="postbody"><span class="postbody">there is an existing thread comparing dma and memcpy in different contexts
<br/>
<br/>
<a class="postlink" href="http://forum.gbadev.org/viewtopic.php?t=13242" target="_blank">http://forum.gbadev.org/viewtopic.php?t=13242</a>
<br/>
<br/>
I think dma is faster from main ram to vram and memcpy is faster to and from main ram</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
