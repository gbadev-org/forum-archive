<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>When things should work and they don't... - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>DS development > When things should work and they don't...</h2>
<div id="posts">
<div class="post">
    <h4>#148865 - onimatrix - Fri Jan 11, 2008 3:49 pm</h4>
    <div class="postbody"><span class="postbody">Hello homebrew community, I'm new to this art and I grew frustrated in the past week trying to solve what is a mystery to me.
<br/>
<br/>
Look at this code, please:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#include &lt;nds.h&gt;
<br/>
#include "graphics.h"
<br/>
#include "defines.h"
<br/>
<br/>
<br/>
int main(void) 
<br/>
{    
<br/>
    powerON(POWER_ALL_2D);
<br/>
    
<br/>
   irqInit();
<br/>
   irqEnable(IRQ_VBLANK);
<br/>
    
<br/>
    videoSetMode(MODE_5_2D | DISPLAY_BG2_ACTIVE);
<br/>
    vramSetBankA(VRAM_A_MAIN_BG);
<br/>
    BG2_CR = BG_BMP16_256x256;
<br/>
    
<br/>
    BG2_XDX = 1 &lt;&lt; 8;
<br/>
    BG2_XDY = 0;
<br/>
    BG2_YDX = 0;
<br/>
    BG2_YDY = 1 &lt;&lt; 8;
<br/>
    BG2_CY = 0;
<br/>
    BG2_CX = 0;
<br/>
    
<br/>
    videoSetModeSub(MODE_5_2D | DISPLAY_BG2_ACTIVE);
<br/>
    vramSetBankC(VRAM_C_SUB_BG);
<br/>
    SUB_BG2_CR = BG_BMP16_256x256;
<br/>
    
<br/>
    SUB_BG2_XDX = 1 &lt;&lt; 8;
<br/>
    SUB_BG2_XDY = 0;
<br/>
    SUB_BG2_YDX = 0;
<br/>
    SUB_BG2_YDY = 1 &lt;&lt; 8;
<br/>
    SUB_BG2_CY = 0;
<br/>
    SUB_BG2_CX = 0;
<br/>
<br/>
    while(1)
<br/>
    {
<br/>
        swiWaitForVBlank();
<br/>
        DrawPixel(12, 12, cWALL);   
<br/>
        DrawPixel(13, 12, cWALL);   
<br/>
        DrawPixel(14, 12, cWALL);   
<br/>
        DrawPixel(15, 12, cWALL);   
<br/>
        DrawPixel(16, 12, cWALL);   
<br/>
        DrawPixel(17, 12, cWALL);           
<br/>
    }
<br/>
    return false;
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
It should be noted that cWALL is defined in defines.h as "RGB15(31, 0, 0) | BIT(15)", that false is defined as 0 in the same file and that DrawPixel is defined in graphics.c as
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void DrawPixel(u8 x, u8 y, u16 color)
<br/>
{
<br/>
    VRAM_A[y * SCREEN_WIDTH + x] = color;
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
The thing is that this code works in iDeaS, but not in no$gba nor in the real hardware.
<br/>
<br/>
As you can see, I'm just messing around giving my first steps in this area.
<br/>
My job keeps me chained to J2ME and I need some fresh air.</span><span class="gensmall"><br/><br/>Last edited by onimatrix on Fri Jan 11, 2008 5:01 pm; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#148867 - eKid - Fri Jan 11, 2008 4:11 pm</h4>
    <div class="postbody"><span class="postbody">Your problem is:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">VRAM_A[y * SCREEN_WIDTH + x] = color;</td> </tr></table><span class="postbody">
<br/>
It should be changed to:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">BG_GFX[y * SCREEN_WIDTH + x] = color;</td> </tr></table><span class="postbody">
<br/>
VRAM_A is a pointer for when the bank is set to 'LCDC' mode. BG_GFX is a pointer for when the bank is set for background graphics. :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#148869 - onimatrix - Fri Jan 11, 2008 4:13 pm</h4>
    <div class="postbody"><span class="postbody">Ohhhh, that makes sense.
<br/>
<br/>
Thank you eKid, I was going to stick my stylus into my ear.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#148873 - onimatrix - Fri Jan 11, 2008 5:00 pm</h4>
    <div class="postbody"><span class="postbody">Sorry to be such a newbie, but I'm having a wierd problem with my code. When SIZE_X and SIZE_Y are 124, the DS shows what it should, but when they are 125 it crashes and burns. The rest of the code remains the same, and subDrawPixel draws to BG_GFX_SUB instead of BG_GFX.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">    s8 terrain[SIZE_X][SIZE_Y];
<br/>
    
<br/>
    s16 cX;
<br/>
    s16 cY;
<br/>
    
<br/>
    for (cY = 0; cY &lt; SIZE_Y; cY++)
<br/>
    {
<br/>
        for (cX = 0; cX &lt; SIZE_X; cX++)
<br/>
        {
<br/>
            terrain[cX][cY] = EMPTY;
<br/>
        }
<br/>
    }
<br/>
<br/>
    terrain[12][12] = WALL;
<br/>
    terrain[12][13] = WALL;
<br/>
    terrain[12][14] = WALL;
<br/>
    terrain[12][15] = WALL;
<br/>
    terrain[12][15] = WALL;
<br/>
<br/>
    while(true)
<br/>
    {
<br/>
        swiWaitForVBlank();
<br/>
        
<br/>
        for (cY = 0; cY &lt; SIZE_Y; cY++)
<br/>
        {
<br/>
            for (cX = 0; cX &lt; SIZE_X; cX++)
<br/>
            {
<br/>
                if (terrain[cX][cY] == EMPTY)
<br/>
                {
<br/>
                    DrawPixel(cX, cY, cEMPTY);
<br/>
                    subDrawPixel(cX, cY, cEMPTY);
<br/>
                }
<br/>
                if (terrain[cX][cY] == WALL)
<br/>
                {
<br/>
                    DrawPixel(cX, cY, cWALL);
<br/>
                    subDrawPixel(cX, cY, cWALL);
<br/>
                }               
<br/>
            }
<br/>
        }
<br/>
    }
<br/>
    </td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#148876 - eKid - Fri Jan 11, 2008 5:07 pm</h4>
    <div class="postbody"><span class="postbody">You are probably using too much stack memory, theres only 16kb of stack space afaik. 125*125 = almost 16kb. Try moving terrain to a global spot outside the function.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#148878 - onimatrix - Fri Jan 11, 2008 5:10 pm</h4>
    <div class="postbody"><span class="postbody">It worked! :D
<br/>
<br/>
You rock eKid, thanks for your time and experience :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#149120 - silent_code - Tue Jan 15, 2008 5:07 pm</h4>
    <div class="postbody"><span class="postbody">or (in general) you could allocate heap memory by using a pointer and new/delete. ;^)
<br/>
well, if the data is used rather frequently you could still stick to the global array.
<br/>
i'm a bit mixed right now... wouldn't a static declaration of the local variable help that too? that way that data wouldn't be global or file global (a static global) and still wouln't use up stack memory. ... or am i wrong? (can't remember static function variable allocation anymore! got to read that up!)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#149121 - onimatrix - Tue Jan 15, 2008 5:10 pm</h4>
    <div class="postbody"><span class="postbody">I finally used the extern global variable approach, as this is the most used variable in my tilemap editor. BTW, is coming along nicely. I have only to find out how can I save data directly to a file in my R4.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#149147 - tepples - Wed Jan 16, 2008 1:11 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>onimatrix wrote:</b></span></td> </tr> <tr> <td class="quote">I have only to find out how can I save data directly to a file in my R4.</td> </tr></table><span class="postbody">
<br/>
Do you want to see a quick "hello world" example, which uses <a class="postlink" href="http://chishm.drunkencoders.com/libfat/" target="_blank">libfat</a> to write a text file called "/data/hello/hello.txt"?<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#149186 - onimatrix - Wed Jan 16, 2008 2:08 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tepples wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>onimatrix wrote:</b></span></td> </tr> <tr> <td class="quote">I have only to find out how can I save data directly to a file in my R4.</td> </tr></table><span class="postbody">
<br/>
Do you want to see a quick "hello world" example, which uses <a class="postlink" href="http://chishm.drunkencoders.com/libfat/" target="_blank">libfat</a> to write a text file called "/data/hello/hello.txt"?</span></td> </tr></table><span class="postbody">
<br/>
<br/>
I remembered all my saturday nights writing software in C, so fprintf worked perfectly for text mode.
<br/>
<br/>
The thing is that my file will be conformed by the following data:
<br/>
<br/>
<span style="font-weight: bold">Header</span>
<br/>
ID: 2 bytes
<br/>
Width: 2 bytes
<br/>
Height: 2 bytes
<br/>
X Position in the general map: 2 bytes
<br/>
Y Position in the general map: 2 bytes
<br/>
Initial X Position of the viewport: 2 bytes
<br/>
Initial Y Position of the viewport: 2 bytes
<br/>
<br/>
<span style="font-weight: bold">Tile map</span>
<br/>
Lossless compresion of a 2D array.
<br/>
Tile header: 2 bytes
<br/>
Tile data: 2 bytes
<br/>
<br/>
<span style="font-weight: bold">Item list</span>
<br/>
Item header: 4 bytes
<br/>
Item data: 4 bytes
<br/>
<br/>
Text mode is kind of out of the question :P</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#149187 - kusma - Wed Jan 16, 2008 2:16 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>onimatrix wrote:</b></span></td> </tr> <tr> <td class="quote">Text mode is kind of out of the question :P</td> </tr></table><span class="postbody">
<br/>
<br/>
look up fwrite() and fread(). They're what you'll need to write binary files. Also make sure you open your file in binary mode (as in fopen(filename, "w<span style="font-weight: bold">b</span>")), as on some platforms bit 8 of every byte gets removed in ascii mode.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#149188 - onimatrix - Wed Jan 16, 2008 2:20 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>kusma wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>onimatrix wrote:</b></span></td> </tr> <tr> <td class="quote">Text mode is kind of out of the question :P</td> </tr></table><span class="postbody">
<br/>
<br/>
look up fwrite() and fread(). They're what you'll need to write binary files. Also make sure you open your file in binary mode (as in fopen(filename, "w<span style="font-weight: bold">b</span>")), as on some platforms bit 8 of every byte gets removed in ascii mode.</span></td> </tr></table><span class="postbody">
<br/>
<br/>
Yep, I was thinking about them. I'm searching the web for examples on a nice way to pack all this data without going rabid monkey :)
<br/>
<br/>
Thanks kusma.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#149199 - PypeBros - Wed Jan 16, 2008 5:38 pm</h4>
    <div class="postbody"><span class="postbody">it might not be a very good tutorial, but i can offer <a class="postlink" href="http://dsgametools.cvs.sourceforge.net/dsgametools/runMe/arm9/source/SpriteSet.cpp?view=markup&amp;pathrev=dkp-r20" target="_blank">this code</a> as an example of reading "packed" structures out of a file.
<br/>
<br/>
As for "packing the data" in the file, i typically <a class="postlink" href="http://dsgametools.cvs.sourceforge.net/dsgametools/runMe/imlib2spr.pl?revision=1.1.2.6&amp;view=markup&amp;pathrev=dkp-r20" target="_blank">use perl functions</a>, but simply producing array of bytes on a PC (from another C program) and fwrite()ing them to the file would be fine too.<br/>_________________<br/><a class="postlink" href="http://sylvainhb.blogspot.com/p/sprite-editor.html" target="_blank"> SEDS: Sprite Edition on DS</a> :: <a class="postlink" href="http://sylvainhb.blogspot.com/search/label/modplayer" target="_blank">modplayer</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#149202 - onimatrix - Wed Jan 16, 2008 5:45 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>PypeBros wrote:</b></span></td> </tr> <tr> <td class="quote">it might not be a very good tutorial, but i can offer <a class="postlink" href="http://dsgametools.cvs.sourceforge.net/dsgametools/runMe/arm9/source/SpriteSet.cpp?view=markup&amp;pathrev=dkp-r20" target="_blank">this code</a> as an example of reading "packed" structures out of a file.
<br/>
<br/>
As for "packing the data" in the file, i typically <a class="postlink" href="http://dsgametools.cvs.sourceforge.net/dsgametools/runMe/imlib2spr.pl?revision=1.1.2.6&amp;view=markup&amp;pathrev=dkp-r20" target="_blank">use perl functions</a>, but simply producing array of bytes on a PC (from another C program) and fwrite()ing them to the file would be fine too.</td> </tr></table><span class="postbody">
<br/>
<br/>
Funny, I didn't know that there was an interpreter of Perl to use in the DS :S
<br/>
I don't need that kind of sofistication anyways, I'm thinking of fwriting all the bytes continously and parsing the stuff as it gets fread. After all, I would only need to add the size of the tile map data in the header, as it is the only place where the size will change (Lossless compression and it's variable bit rate... ??u)
<br/>
<br/>
Thanks for the tip PypeBros :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#149253 - PypeBros - Thu Jan 17, 2008 9:55 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>onimatrix wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
Funny, I didn't know that there was an interpreter of Perl to use in the DS :S
<br/>
</td> </tr></table><span class="postbody">
<br/>
Not yet, to my best knowledge, except maybe for DSLinux ;)
<br/>
Not that it would be hard to do, but i doubt i'd be of any use
<br/>
<br/>
No, i was suggesting preparing the binary data with a scripted language (e.g. Perl) <span style="font-style: italic">on your PC</span> (rather than building a C file where you typed the data in a large array and that write them on disk).<br/>_________________<br/><a class="postlink" href="http://sylvainhb.blogspot.com/p/sprite-editor.html" target="_blank"> SEDS: Sprite Edition on DS</a> :: <a class="postlink" href="http://sylvainhb.blogspot.com/search/label/modplayer" target="_blank">modplayer</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#149264 - onimatrix - Thu Jan 17, 2008 2:09 pm</h4>
    <div class="postbody"><span class="postbody">Trouble is that this is going to be sort of a suite of apps <span style="font-weight: bold">for the DS</span> to develop new content for my game. Tile map editor, tile editor, scripting engine (REALLY BASIC just now) and both an enemy and an item's editor too.
<br/>
<br/>
<br/>
BTW, last night I got the thing working. Making the map resizeable was the biggest challenge, having to change from a 2D array to a dynamic list (As I couldn't declare the array using non constant values :) )</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#149265 - PypeBros - Thu Jan 17, 2008 2:39 pm</h4>
    <div class="postbody"><span class="postbody">Lol. Exactly the kind of things i'm trying to achieve myself.
<br/>
<br/>
I already have a <a class="postlink" href="http://sylvainhb.blogspot.com/2007/10/seds-user-guide-01a.html" target="_blank">"tile editor" started</a>, and <a class="postlink" href="http://dsgametools.cvs.sourceforge.net/dsgametools/runMe/test.cmd?revision=1.1.2.9&amp;view=markup&amp;pathrev=dkp-r20" target="_blank">very basic scripting engine</a>. So far, i just import maps from flat pictures with the perl tool mentionned above.
<br/>
<br/>
Let me know if you're open to a collaboration ...<br/>_________________<br/><a class="postlink" href="http://sylvainhb.blogspot.com/p/sprite-editor.html" target="_blank"> SEDS: Sprite Edition on DS</a> :: <a class="postlink" href="http://sylvainhb.blogspot.com/search/label/modplayer" target="_blank">modplayer</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#149266 - onimatrix - Thu Jan 17, 2008 2:57 pm</h4>
    <div class="postbody"><span class="postbody">I'm always open to collaboration.
<br/>
If you need to know how I achieved something just ask.
<br/>
For the moment we are, like, 12 people in the project, though I'm currently the only one that can tell VRAM from his ass.
<br/>
<br/>
BTW, nice tile designer :D</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
