<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>template arm9 makefile confusion (w.r.t grit) - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>DS development > template arm9 makefile confusion (w.r.t grit)</h2>
<div id="posts">
<div class="post">
    <h4>#171240 - Ant6n - Mon Nov 09, 2009 3:26 am</h4>
    <div class="postbody"><span class="postbody">The current template makefile for an arm9 project is
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#---------------------------------------------------------------------------------
<br/>
.SUFFIXES:
<br/>
#---------------------------------------------------------------------------------
<br/>
<br/>
ifeq ($(strip $(DEVKITARM)),)
<br/>
$(error "Please set DEVKITARM in your environment. export DEVKITARM=&lt;path to&gt;devkitARM")
<br/>
endif
<br/>
<br/>
include $(DEVKITARM)/ds_rules
<br/>
<br/>
#---------------------------------------------------------------------------------
<br/>
# TARGET is the name of the output
<br/>
# BUILD is the directory where object files &amp; intermediate files will be placed
<br/>
# SOURCES is a list of directories containing source code
<br/>
# INCLUDES is a list of directories containing extra header files
<br/>
# DATA is a list of directories containing binary files embedded using bin2o
<br/>
# GRAPHICS is a list of directories containing image files to be converted with grit
<br/>
#---------------------------------------------------------------------------------
<br/>
TARGET      :=   $(shell basename $(CURDIR))
<br/>
BUILD      :=   build
<br/>
SOURCES      :=   source
<br/>
INCLUDES   :=   include
<br/>
DATA      :=   data  
<br/>
GRAPHICS   :=   gfx  
<br/>
<br/>
#---------------------------------------------------------------------------------
<br/>
# options for code generation
<br/>
#---------------------------------------------------------------------------------
<br/>
ARCH   :=   -mthumb -mthumb-interwork
<br/>
<br/>
CFLAGS   :=   -g -Wall\
<br/>
       -march=armv5te -mtune=arm946e-s -fomit-frame-pointer\
<br/>
      -ffast-math \
<br/>
      $(ARCH)
<br/>
<br/>
CFLAGS   +=   $(INCLUDE) -DARM9
<br/>
CXXFLAGS   := $(CFLAGS) -fno-rtti -fno-exceptions
<br/>
<br/>
ASFLAGS   :=   -g $(ARCH)
<br/>
LDFLAGS   =   -specs=ds_arm9.specs -g $(ARCH) -Wl,-Map,$(notdir $*.map)
<br/>
<br/>
#---------------------------------------------------------------------------------
<br/>
# any extra libraries we wish to link with the project (order is important)
<br/>
#---------------------------------------------------------------------------------
<br/>
LIBS   :=    -lnds9
<br/>
 
<br/>
 
<br/>
#---------------------------------------------------------------------------------
<br/>
# list of directories containing libraries, this must be the top level containing
<br/>
# include and lib
<br/>
#---------------------------------------------------------------------------------
<br/>
LIBDIRS   :=   $(LIBNDS)
<br/>
 
<br/>
#---------------------------------------------------------------------------------
<br/>
# no real need to edit anything past this point unless you need to add additional
<br/>
# rules for different file extensions
<br/>
#---------------------------------------------------------------------------------
<br/>
ifneq ($(BUILD),$(notdir $(CURDIR)))
<br/>
#---------------------------------------------------------------------------------
<br/>
<br/>
export OUTPUT   :=   $(CURDIR)/$(TARGET)
<br/>
<br/>
export VPATH   :=   $(foreach dir,$(SOURCES),$(CURDIR)/$(dir)) \
<br/>
               $(foreach dir,$(DATA),$(CURDIR)/$(dir)) \
<br/>
               $(foreach dir,$(GRAPHICS),$(CURDIR)/$(dir))
<br/>
<br/>
export DEPSDIR   :=   $(CURDIR)/$(BUILD)
<br/>
<br/>
CFILES      :=   $(foreach dir,$(SOURCES),$(notdir $(wildcard $(dir)/*.c)))
<br/>
CPPFILES   :=   $(foreach dir,$(SOURCES),$(notdir $(wildcard $(dir)/*.cpp)))
<br/>
PNGFILES   :=   $(foreach dir,$(SOURCES),$(notdir $(wildcard $(dir)/*.png)))
<br/>
SFILES      :=   $(foreach dir,$(SOURCES),$(notdir $(wildcard $(dir)/*.s)))
<br/>
BINFILES   :=   $(foreach dir,$(DATA),$(notdir $(wildcard $(dir)/*.*)))
<br/>
 
<br/>
#---------------------------------------------------------------------------------
<br/>
# use CXX for linking C++ projects, CC for standard C
<br/>
#---------------------------------------------------------------------------------
<br/>
ifeq ($(strip $(CPPFILES)),)
<br/>
#---------------------------------------------------------------------------------
<br/>
   export LD   :=   $(CC)
<br/>
#---------------------------------------------------------------------------------
<br/>
else
<br/>
#---------------------------------------------------------------------------------
<br/>
   export LD   :=   $(CXX)
<br/>
#---------------------------------------------------------------------------------
<br/>
endif
<br/>
#---------------------------------------------------------------------------------
<br/>
<br/>
export OFILES   :=   $(addsuffix .o,$(BINFILES)) \
<br/>
               $(addsuffix .o,$(PNGFILES)) \
<br/>
               $(CPPFILES:.cpp=.o) $(CFILES:.c=.o) $(SFILES:.s=.o)
<br/>
 
<br/>
export INCLUDE   :=   $(foreach dir,$(INCLUDES),-iquote $(CURDIR)/$(dir)) \
<br/>
               $(foreach dir,$(LIBDIRS),-I$(dir)/include) \
<br/>
               -I$(CURDIR)/$(BUILD)
<br/>
 
<br/>
export LIBPATHS   :=   $(foreach dir,$(LIBDIRS),-L$(dir)/lib)
<br/>
<br/>
icons := $(wildcard *.bmp)
<br/>
<br/>
ifneq (,$(findstring $(TARGET).bmp,$(icons)))
<br/>
   export GAME_ICON := $(CURDIR)/$(TARGET).bmp
<br/>
else
<br/>
   ifneq (,$(findstring icon.bmp,$(icons)))
<br/>
      export GAME_ICON := $(CURDIR)/icon.bmp
<br/>
   endif
<br/>
endif
<br/>
 
<br/>
.PHONY: $(BUILD) clean
<br/>
 
<br/>
#---------------------------------------------------------------------------------
<br/>
$(BUILD):
<br/>
   @[ -d $@ ] || mkdir -p $@
<br/>
   @make --no-print-directory -C $(BUILD) -f $(CURDIR)/Makefile
<br/>
 
<br/>
#---------------------------------------------------------------------------------
<br/>
clean:
<br/>
   @echo clean ...
<br/>
   @rm -fr $(BUILD) $(TARGET).elf $(TARGET).nds $(TARGET).arm9
<br/>
<br/>
#---------------------------------------------------------------------------------
<br/>
else
<br/>
 
<br/>
#---------------------------------------------------------------------------------
<br/>
# main targets
<br/>
#---------------------------------------------------------------------------------
<br/>
$(OUTPUT).nds   :    $(OUTPUT).arm9
<br/>
$(OUTPUT).arm9   :   $(OUTPUT).elf
<br/>
$(OUTPUT).elf   :   $(OFILES)
<br/>
 
<br/>
#---------------------------------------------------------------------------------
<br/>
%.bin.o   :   %.bin
<br/>
#---------------------------------------------------------------------------------
<br/>
   @echo $(notdir $&lt;)
<br/>
   $(bin2o)
<br/>
<br/>
#---------------------------------------------------------------------------------
<br/>
# This rule creates assembly source files using grit
<br/>
# grit takes an image file and a .grit describing how the file is to be processed
<br/>
# add additional rules like this for each image extension
<br/>
# you use in the graphics folders
<br/>
#---------------------------------------------------------------------------------
<br/>
%.s %.h   : %.png %.grit
<br/>
#---------------------------------------------------------------------------------
<br/>
   grit $&lt; -fts -o$*
<br/>
<br/>
-include $(DEPSDIR)/*.d
<br/>
 
<br/>
#---------------------------------------------------------------------------------------
<br/>
endif
<br/>
#---------------------------------------------------------------------------------------
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I am not really good with make, and a bit confused. The comment says that 'gfx' should be the folder where graphics files are, but pngfiles seem to find png files in the source folder. I think that's why it won't find files i put in the gfx folder.
<br/>
So I tried to change the definition to
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">PNGFILES   :=   $(foreach dir,$(GRAPHICS),$(notdir $(wildcard $(dir)/*.png)))</td> </tr></table><span class="postbody">
<br/>
but now make complains that there is "No rule to make target `&lt;someimage&gt;.png.o', needed by `&lt;somedirectory&gt;/arm9.elf". I think that again is related to grit outputting .s files, and not .o files.
<br/>
<br/>
<br/>
Am I using this template in the wrong way (i.e. by assuming image.png and image.grit in the gfx directory), or is there something amiss with the template makefile??
<br/>
<br/>
help would be appreciated,
<br/>
anton</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#171263 - wintermute - Tue Nov 10, 2009 3:43 pm</h4>
    <div class="postbody"><span class="postbody">The $(addsuffix part was intended for files converted using the bin2o macros, you have no rule which details how to create .png.o from .png.
<br/>
<br/>
You can either use $(PNGFILES:.png=.o) instead of $(addsuffix .o,$(PNGFILES)) or modify the grit rule to %.png.s %.h   : %.png %.grit<br/>_________________<br/><a class="postlink" href="http://www.devkitpro.org/" target="_blank">devkitPro - professional toolchains at amateur prices</a>
<br/>
<a class="postlink" href="http://wiki.devkitpro.org/index.php/IRC" target="_blank">devkitPro IRC support</a>
<br/>
<a class="postlink" href="http://davejmurphy.com/" target="_blank">Personal Blog</a></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
