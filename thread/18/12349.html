<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Works on emulator but not on a real hardware [solved] - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>DS development > Works on emulator but not on a real hardware [solved]</h2>
<div id="posts">
<div class="post">
    <h4>#117389 - Zubrow - Sun Feb 04, 2007 4:44 pm</h4>
    <div class="postbody"><span class="postbody">Here's my noob problem: I'm learning nds coding, to begin I'm trying to display a basic sprite on the main screen and make it move with the sub screen.
<br/>
<br/>
My code looks like this
<br/>
Main.cpp:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
void OnIrq(void) 
<br/>
{   
<br/>
  if(REG_IF &amp; IRQ_VBLANK)
<br/>
  {
<br/>
    VBLANK_INTR_WAIT_FLAGS |= IRQ_VBLANK;
<br/>
    REG_IF |= IRQ_VBLANK;
<br/>
  }
<br/>
}
<br/>
<br/>
int main(void)
<br/>
{
<br/>
  irqInit();
<br/>
  irqSet(IRQ_VBLANK, OnIrq);
<br/>
<br/>
  powerON(POWER_ALL_2D);
<br/>
  videoSetMode(MODE_3_2D|DISPLAY_SPR_ACTIVE|DISPLAY_SPR_1D|DISPLAY_SPR_1D_LAYOUT);
<br/>
  vramSetBankA(VRAM_A_MAIN_SPRITE);
<br/>
<br/>
  for (int i = 0; i &lt; 128; ++i)
<br/>
  {
<br/>
    sSpriteEntry* pSprite = reinterpret_cast&lt;sSpriteEntry*&gt;(reinterpret_cast&lt;u8*&gt;(OAM) + i * sizeof (sSpriteEntry));
<br/>
    pSprite-&gt;attribute[0] = ATTR0_DISABLED;
<br/>
  }
<br/>
<br/>
  for (int i = 0; i &lt; 128; ++i)
<br/>
  {
<br/>
    sSpriteEntry* pSprite = reinterpret_cast&lt;sSpriteEntry*&gt;(reinterpret_cast&lt;u8*&gt;(OAM_SUB) + i * sizeof (sSpriteEntry));
<br/>
    pSprite-&gt;attribute[0] = ATTR0_DISABLED; 
<br/>
  }
<br/>
<br/>
  swiCopy(ProphetTiles, SPRITE_GFX, ProphetTilesLen);
<br/>
  swiCopy(ProphetPal, SPRITE_PALETTE, ProphetPalLen);
<br/>
<br/>
  CSprite Prophet1(ATTR0_COLOR_256|ATTR0_SQUARE|(SCREEN_WIDTH &gt;&gt; 1) - 96, ATTR1_SIZE_64|(SCREEN_HEIGHT &gt;&gt; 1), 0|ATTR2_ALPHA(1));
<br/>
  CSprite Prophet2(ATTR0_COLOR_256|ATTR0_SQUARE|(SCREEN_WIDTH &gt;&gt; 1) - 32, ATTR1_SIZE_64|(SCREEN_HEIGHT &gt;&gt; 1), 128|ATTR2_ALPHA(1));
<br/>
<br/>
  Prophet1.Update();
<br/>
  Prophet2.Update();
<br/>
<br/>
  touchPosition tp;
<br/>
<br/>
  for (;;)
<br/>
  {
<br/>
    tp = touchReadXY();
<br/>
    if (tp.x != 0 &amp;&amp; tp.y != 0)
<br/>
    {
<br/>
      Prophet1.GoTo(tp.px, tp.py);
<br/>
      Prophet2.GoTo(tp.px, tp.py+64);
<br/>
      Prophet1.Update();
<br/>
      Prophet2.Update();
<br/>
    }
<br/>
  }
<br/>
<br/>
  return 0;
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I use my own class to handle sprite
<br/>
<br/>
Sprite.cpp: (ripped)
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
CSprite::CSprite(u16 Attr0, u16 Attr1, u16 Attr2)
<br/>
{
<br/>
  m_SpriteEntry.attribute[0] = Attr0;
<br/>
  m_SpriteEntry.attribute[1] = Attr1;
<br/>
  m_SpriteEntry.attribute[2] = Attr2;
<br/>
<br/>
  m_SpriteRotation.hdx = 256;
<br/>
  m_SpriteRotation.hdy = 0;
<br/>
  m_SpriteRotation.vdx = 0;
<br/>
  m_SpriteRotation.vdy = 256;
<br/>
<br/>
  static u16 Id;
<br/>
  m_SpriteId = Id++;
<br/>
}
<br/>
<br/>
void CSprite::Update(void)
<br/>
{
<br/>
  dmaCopy(&amp;m_SpriteEntry, OAM + ((sizeof (sSpriteEntry) &gt;&gt; 1) * m_SpriteId), sizeof (sSpriteEntry));
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
That's work with many emulator (like Dualis), but I get a black screen on my NDS ( I use a M3 Simply to run my code ).
<br/>
So what's wrong with my code ?
<br/>
<br/>
Thanks.</span><span class="gensmall"><br/><br/>Last edited by Zubrow on Mon Feb 05, 2007 10:26 am; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#117391 - tepples - Sun Feb 04, 2007 4:53 pm</h4>
    <div class="postbody"><span class="postbody">I can't see the content of SPRITE_PALETTE, but I can tell you that Dualis has a bug. At one point in the development of LOCKJAW DS, I found that if sprites are turned on, the backdrop in Dualis uses color 0 from the sprite palette instead of (correct) color 0 from the background palette. The text wouldn't show up. Copying background color 0 into sprite color 0 fixed this.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#117422 - Zubrow - Sun Feb 04, 2007 8:41 pm</h4>
    <div class="postbody"><span class="postbody">Thanks for your reply, here's the content of the palette
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
const unsigned short ProphetPal[256]=
<br/>
{
<br/>
   0x7C1F,0x654D,0x2890,0x1E3A,0x5B3B,0x1486,0x2E56,0x7FBD,
<br/>
   0x1065,0x1C64,0x40C7,0x1935,0x0421,0x0421,0x0421,0x0421,
<br/>
   0x0840,0x0842,0x0842,0x0842,0x0842,0x0842,0x0842,0x0842,
<br/>
   0x0C63,0x0C63,0x0C63,0x0C63,0x0C63,0x0C63,0x0C63,0x0C63,
<br/>
   0x1084,0x1084,0x1084,0x1084,0x1084,0x1084,0x1084,0x1084,
<br/>
   0x14A5,0x14A5,0x14A5,0x14A5,0x14A5,0x14A5,0x14A5,0x14A5,
<br/>
   0x18C6,0x18C6,0x18C6,0x18C6,0x18C6,0x18C6,0x18C6,0x18C6,
<br/>
   0x1CE7,0x1CE7,0x1CE7,0x1CE7,0x1CE7,0x1CE7,0x1CE7,0x1CE7,
<br/>
...
<br/>
};
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I tried with many emulators and I get <a class="postlink" href="http://darkfantasy.free.fr/screenshots/nds/emu/nds_pb0.png" target="_blank">this</a>.
<br/>
My problem is that I have a black screen on my real NDS, I guess I forgot something with OAM.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#117425 - tepples - Sun Feb 04, 2007 8:55 pm</h4>
    <div class="postbody"><span class="postbody">Have you got a similar program to work in GBA mode?<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#117448 - Quirky - Sun Feb 04, 2007 10:21 pm</h4>
    <div class="postbody"><span class="postbody">I had similar problems with sprites, you may need a DC_Flush before copying to OAM. My own Sprite update does this:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void Sprite::update() const
<br/>
{
<br/>
  if (!valid()) return;
<br/>
  SpriteEntry * oam = (SpriteEntry*)m_OAM;
<br/>
  DC_FlushRange(&amp;s_sprites[m_screen][m_index],sizeof(SpriteEntry));
<br/>
  dmaCopy(&amp;s_sprites[m_screen][m_index], &amp;oam[m_index], sizeof(SpriteEntry));
<br/>
}
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#117455 - Zubrow - Sun Feb 04, 2007 10:53 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tepples wrote:</b></span></td> </tr> <tr> <td class="quote">Have you got a similar program to work in GBA mode?</td> </tr></table><span class="postbody">
<br/>
No, I have a slot1 linker, so I can't run homebrew in GBA mode.
<br/>
<br/>
Quirky: I added <span style="font-weight: bold">DC_FlushAll()</span> in my update routine, but it still doesn't work.
<br/>
<br/>
Thanks for your advise.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#117458 - Mighty Max - Sun Feb 04, 2007 11:07 pm</h4>
    <div class="postbody"><span class="postbody">You are declaring CProphet and thus the sprite data within the main() routine, causing it to be created in Stack. The stack is exclusively accessible by the arm9 (DTCM). Afaik DMA does not work for this memory.<br/>_________________<br/><a class="postlink" href="http://mightymax.org/gbamp_multiboot.html" target="_blank">GBAMP Multiboot</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#117515 - Zubrow - Mon Feb 05, 2007 7:42 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Mighty Max wrote:</b></span></td> </tr> <tr> <td class="quote">You are declaring CProphet and thus the sprite data within the main() routine, causing it to be created in Stack. The stack is exclusively accessible by the arm9 (DTCM). Afaik DMA does not work for this memory.</td> </tr></table><span class="postbody">
<br/>
You're right, I changed the <span style="font-weight: bold">dmaCopy</span> to <span style="font-weight: bold">swiCopy</span> and now it works just like a charm. Thanks a lot! You solve my problem.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
