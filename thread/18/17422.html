<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>fopen not reading whole file - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > fopen not reading whole file</h2>
<div id="posts">
<div class="post">
    <h4>#175496 - Scribe - Sat Dec 04, 2010 5:00 pm</h4>
    <div class="postbody"><span class="postbody">Hi guys,
<br/>
<br/>
I've just written a universal image converter to uncompressed xBGR 16bit for use with the DS.
<br/>
<br/>
I'm using libfat to load in these image files but am finding the use of fread is returning EOF too early. In my example the filesize should be 98312 bytes but it's falling 6156 bytes short.
<br/>
<br/>
I've confirmed that the image file size after conversion is correct and that the size data being fed in is also correct.
<br/>
<br/>
This leads me to assume the issue is with either libfat or the virtual fat system script I'm using to run this code on an emulator (I don't currently have a DS available).
<br/>
<br/>
The build steps for the virtual filesystem are thus:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
cd fcsrimage
<br/>
<br/>
padbin.exe 512 ../NDS_Template.nds
<br/>
<br/>
CALL build.bat image.img ..\Filesystem
<br/>
<br/>
copy /b ..\NDS_Template.nds + image.img ..\NDS_Template.ds.gba
<br/>
<br/>
dlditool.exe fcsr.dldi ..\NDS_Template.ds.gba
<br/>
<br/>
cd ..
<br/>
</td> </tr></table><span class="postbody">
<br/>
build.bat =
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
@echo off
<br/>
REM 
<br/>
REM based on davr http://blog.davr.org/ linux code and shell script
<br/>
REM by Troy(GPF) http://gpf.dcemu.co.uk
<br/>
REM
<br/>
<br/>
echo Builds a FAT disk image from a given directory.
<br/>
IF "%1" == "" goto ERROR
<br/>
IF "%2" == "" goto ERROR
<br/>
for /f "tokens=3,4*" %%a in ( 'dir /w /s /-C %2 ^| tail -n 2 ^| head -n 1') do @set info=%%a
<br/>
set /A size="%info%+64"
<br/>
echo %size%
<br/>
<br/>
if /I %size% LSS 10000Â  ( set /A size="10000" )
<br/>
<br/>
echo Creating image
<br/>
mkdosfs.exe %1 %size%
<br/>
add_to_disk_image.exe %1 %2
<br/>
rem 'bless' the image so it is recognized by FCSR driver, and sets up SRAM overlay
<br/>
<br/>
echo Blessing image
<br/>
bless.exe %1
<br/>
echo "FAT12 image built as %1 from %2"
<br/>
goto :end
<br/>
<br/>
:ERROR
<br/>
echo usage: build.bat name.img dirname
<br/>
goto :end
<br/>
<br/>
:tobig
<br/>
echo directory size to large , remove some files and try again
<br/>
goto :end
<br/>
<br/>
<br/>
:end
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Any ideas what could be causing this issue guys?
<br/>
<br/>
Many thanks</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#175497 - Quirky - Sat Dec 04, 2010 6:27 pm</h4>
    <div class="postbody"><span class="postbody">Is the file definitely that size on the SD card? I know I've had problems where files are actually corrupt and reading them back even on a PC gives errors.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#175498 - Sektor - Sat Dec 04, 2010 11:04 pm</h4>
    <div class="postbody"><span class="postbody">He's not using an SD card. It could be a problem with the emulator or FCSR. Try nitrofs or real hardware.<br/>_________________<br/><span style="font-size: 9px; line-height: normal"><a class="postlink" href="http://gtamp.com/DS" target="_blank">GTAMP.com/DS</a></span></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
