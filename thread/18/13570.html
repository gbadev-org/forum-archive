<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Multiple .c files [solved for now... <_< >_>] - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>DS development > Multiple .c files [solved for now... <_< >_>]</h2>
<div id="posts">
<div class="post">
    <h4>#133083 - HyperHacker - Tue Jul 03, 2007 4:23 am</h4>
    <div class="postbody"><span class="postbody">If I'm using the default makefile, how can I have multiple .c files? In /arm9/source I have my main source file and I want to have some others in there too instead of cramming everything into one file. Both need main.h though and this doesn't seem possible: if I include it into both, it complains about multiple definitions (even though I used #ifndef/#define/#endif to prevent this &lt;_&lt;), if I don't one of them complains about this and that not being defined because it's all in main.h. I can just name the other ones like file.c.foo and include them into the main file, but I thought one of the main reasons to use a makefile was to avoid that?<br/>_________________<br/>I'm a PSP hacker now, but I still &lt;3 DS.</span><span class="gensmall"><br/><br/>Last edited by HyperHacker on Mon Jul 09, 2007 6:16 am; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#133086 - wintermute - Tue Jul 03, 2007 4:43 am</h4>
    <div class="postbody"><span class="postbody">Well, here's the thing ...
<br/>
<br/>
Header guards only prevent a header from being included in one source file more than once. The compiler can't tell that you already included the header in some other source file.
<br/>
<br/>
Headers are for typedefs, function prototypes, externs for data arrays, macros and static inline function bodies. If you put normal code or data in there then you get multiple definitions.
<br/>
<br/>
I highly recommend getting a good book on C/C++ and not relying on GBA/DS related tutorials. You've learned some terrible habits from some spectacularly bad tutorials.<br/>_________________<br/><a class="postlink" href="http://www.devkitpro.org/" target="_blank">devkitPro - professional toolchains at amateur prices</a>
<br/>
<a class="postlink" href="http://wiki.devkitpro.org/index.php/IRC" target="_blank">devkitPro IRC support</a>
<br/>
<a class="postlink" href="http://davejmurphy.com/" target="_blank">Personal Blog</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#133087 - HyperHacker - Tue Jul 03, 2007 4:45 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>wintermute wrote:</b></span></td> </tr> <tr> <td class="quote">Headers are for typedefs, function prototypes, externs for data arrays, macros and static inline function bodies. If you put normal code or data in there then you get multiple definitions.</td> </tr></table><span class="postbody">There's no code in my headers. o_O It's the typedefs and prototypes and macros that are needed in both files.<br/>_________________<br/>I'm a PSP hacker now, but I still &lt;3 DS.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#133088 - StoneCypher - Tue Jul 03, 2007 4:51 am</h4>
    <div class="postbody"><span class="postbody">You're creating redundant copies of exportable symbols by #including them into multiple translation units.  Get a c/c++ book and look up extern.  (Edited: I wrote export the first time, like a dumbass.)<br/>_________________<br/>Quidquid Latine dictum sit, altum Sonatur
<br/>
<a href="http://feeds.feedburner.com/StoneHome.gif">[Images not permitted - Click here to view it]</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#133092 - Dwedit - Tue Jul 03, 2007 5:50 am</h4>
    <div class="postbody"><span class="postbody">ot: Does the 'export' keyword actually do anything other than cause Visual C++ to display "Internal compiler error"?<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#133099 - OOPMan - Tue Jul 03, 2007 7:41 am</h4>
    <div class="postbody"><span class="postbody">Er...extern is used primarily in C programming, if I recall...
<br/>
<br/>
C++ is, in terms of compiler function, quite a different language...
<br/>
<br/>
I've not really used extern much myself...
<br/>
<br/>
HyperHacker's problem is kinda confusing, because I know I've done what he wants to do, often and with no problems...<br/>_________________<br/>"My boot, your face..." - Attributed to OOPMan, Emperor of Eroticon VI
<br/>
<br/>
You can find my NDS homebrew projects <a class="postlink" href="http://blog.dev-scene.com/oopman/" target="_blank">here...</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#133103 - Rajveer - Tue Jul 03, 2007 8:12 am</h4>
    <div class="postbody"><span class="postbody">Just to make sure, you're not including the source files in the makefile are you?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#133105 - Cearn - Tue Jul 03, 2007 11:22 am</h4>
    <div class="postbody"><span class="postbody">When you move code around between files, it's often a good idea to 'make clean' the whole project afterwards. Sometimes the old object files (the .o things) are still used, with the old symbols in them.
<br/>
<br/>
Another thing to watch for is that you might be compiling the same file twice. Wintermute's makefiles scan the SOURCES directories and add all the C files in it to the CFILES list (i.e., the list of files to compile). If there are double entries in CFILES, nothing you do inside the those C-files is going to matter.
<br/>
<br/>
The errors messages tell you which item(s) is offending to the compiler's eyes. Read the messages and use that information to find and fix the problem.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#133134 - dannyboy - Tue Jul 03, 2007 7:16 pm</h4>
    <div class="postbody"><span class="postbody">Can you post your .h file that is causing the multiple definitions?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#133416 - M3d10n - Fri Jul 06, 2007 2:30 am</h4>
    <div class="postbody"><span class="postbody">I have a C++ project using multiple .cpp and .h files shared among them without any problems. It's a port of an friend's Mac game using Objective C, Cocoa and OpenGL and the original source files' names and organization was kept almost intact for the port without problems.
<br/>
<br/>
There might be something wrong with your .h file or your makefile.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#133448 - HyperHacker - Fri Jul 06, 2007 7:12 am</h4>
    <div class="postbody"><span class="postbody">k, here's the header file, yes it's a huge mess and the IPC messaging system sucks but hey, it's a work in progress. :-p
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#ifndef _MAIN_H_
<br/>
#define _MAIN_H_
<br/>
<br/>
//-----------------------#DEFINES-----------------------
<br/>
#define MEMZERO(buf, len) memset(buf, 0, len)
<br/>
#define KEY_DEBUG         BIT(14)
<br/>
<br/>
#define WIFI_FRAME_COUNT   (5*60) //how many frames to wait for a response to a command
<br/>
#define MENU_STACK_MAX      32
<br/>
#define OPTIONS_PER_PAGE   18 //number of menu options that can fit on the screen at once.
<br/>
<br/>
#define SCHANNEL_WAVEDUTY(n) (n &lt;&lt; 24)
<br/>
#define LESSEROF(x, y) (x &lt; y ? x : y)
<br/>
#define GREATEROF(x, y) (x &gt; y ? x : y)
<br/>
<br/>
#define CONSOLEFLAGS (CONSOLE_32x32 | CONSOLE_BG(0) | CONSOLE_SCREENBASE(15) | CONSOLE_CHARBASE(0) | CONSOLE_GRADIENT)
<br/>
<br/>
#if ARM9 //these are only defined for ARM7
<br/>
#define PM_SOUND_PWR      BIT(0)    // Power the sound hardware (needed to hear stuff in GBA mode too)
<br/>
#define PM_SOUND_VOL      BIT(1)    // ?
<br/>
#define PM_BACKLIGHT_BOTTOM   BIT(2)    // Enable the top backlight if set
<br/>
#define PM_BACKLIGHT_TOP   BIT(3)    // Enable the bottom backlight if set
<br/>
#define PM_SYSTEM_PWR      BIT(6)    // Turn the power *off* if set
<br/>
<br/>
#define GBA_BORDER_DATA      ((u16*)0x6020000) //VRAM address our borders will be stored at
<br/>
#endif
<br/>
<br/>
//Copied from Moonshell
<br/>
#define PM_NDSLITE_ADR (4)
<br/>
#define PM_NDSLITE_ISLITE BIT(6)
<br/>
#define PM_NDSLITE_BRIGHTNESS(x) ((x &amp; 0x03)&lt;&lt;0)
<br/>
#define PM_NDSLITE_BRIGHTNESS_MASK (PM_NDSLITE_BRIGHTNESS(3))
<br/>
<br/>
//Bits of system info in A9_INIT
<br/>
#define SI_GBAONBOTTOM   0x00000001   //GBA screen is on bottom
<br/>
#define SI_DSLITE      0x00000002   //Running on DS Lite
<br/>
<br/>
//Wifi control
<br/>
#define WIFIPARAM_SYNC   0
<br/>
#define WIFIPARAM_INIT   1
<br/>
#define WIFIPARAM_STOP   2
<br/>
<br/>
//Debug
<br/>
#define A7_STACK_DUMP_NUMWORDS 138 //Number of words that can be displayed in an ARM7 stack dump
<br/>
<br/>
//-----------------------LIBRARY INCLUDES-----------------------
<br/>
#include &lt;nds.h&gt;
<br/>
#include &lt;stdio.h&gt;
<br/>
#include &lt;stdlib.h&gt;
<br/>
#include &lt;malloc.h&gt;
<br/>
#include &lt;string.h&gt;
<br/>
//#include &lt;cartreset_nolibfat.h&gt;
<br/>
//#include &lt;cartreset.h&gt;
<br/>
<br/>
#if ARM9
<br/>
#include &lt;stdarg.h&gt;
<br/>
#include &lt;dswifi9.h&gt;
<br/>
#include &lt;nds/arm9/libConsole.h&gt;
<br/>
#include &lt;fat.h&gt;
<br/>
#include &lt;sys/dir.h&gt;
<br/>
#include &lt;unistd.h&gt;
<br/>
<br/>
#else //ARM7
<br/>
#include &lt;dswifi7.h&gt;
<br/>
<br/>
#endif //ARM7
<br/>
<br/>
//-----------------------STRUCT DEFINITIONS-----------------------
<br/>
typedef struct {
<br/>
   u32 A7MessageCount;      //ARM7 messages processed
<br/>
   u32 A9MessageCount;      //ARM9 messages processed
<br/>
   u32 A7FrameCount;      //Number of frames executed on ARM7
<br/>
   u32 A9FrameCount;      //Number of frames executed on ARM9
<br/>
   u32 TickCount;         //System run time in msec
<br/>
   bool WifiEnabled;      //Whether wifi is enabled
<br/>
<br/>
   u32 ButtonsPressed;      //Buttons pressed this frame
<br/>
   u32 ButtonsHeld;      //Buttons held &gt;1 frame
<br/>
   s16 TouchX, TouchY;      //Touch X/Y position
<br/>
   s16 TouchZ1, TouchZ2;   //Touch Z panels
<br/>
   u32 Temperature;      //System temperature
<br/>
<br/>
   union { //Current time
<br/>
      struct {
<br/>
         u8 Time_Command;
<br/>
         u8 Time_Year;
<br/>
         u8 Time_Month;
<br/>
         u8 Time_Day;
<br/>
         u8 Time_Incr;
<br/>
         u8 Time_Hour;
<br/>
         u8 Time_Minute;
<br/>
         u8 Time_Second;
<br/>
      };
<br/>
      u8 TimeData[8];
<br/>
   };
<br/>
<br/>
   u32 SysInfo;         //Information about system settings passed from ARM7 at bootup (any of SI_xxx).
<br/>
} CustomIPCData;
<br/>
<br/>
static inline CustomIPCData volatile * getIPC2() {
<br/>
   return (CustomIPCData volatile *)(IPC + sizeof(TransferRegion));
<br/>
}
<br/>
<br/>
#define IPC2 getIPC2()
<br/>
<br/>
<br/>
//Information for the Quickboot menu
<br/>
typedef struct {
<br/>
   char Name[30]; //Name to show in menu
<br/>
   char Desc[129]; //Description to show in menu.
<br/>
   char Section[129]; //Name of INI section.
<br/>
} QuickbootData;
<br/>
<br/>
<br/>
//Keys for KeyRepeat[]
<br/>
typedef enum {
<br/>
   KR_A = 0,
<br/>
   KR_B,
<br/>
   KR_SELECT,
<br/>
   KR_START,
<br/>
   KR_RIGHT,
<br/>
   KR_LEFT,
<br/>
   KR_UP,
<br/>
   KR_DOWN,
<br/>
   KR_R,
<br/>
   KR_L,
<br/>
   KR_X,
<br/>
   KR_Y,
<br/>
   NUM_KEYS
<br/>
} KeyID;
<br/>
<br/>
//ARM7 messages
<br/>
/* Messages are in this format: 1 byte message ID, 1 byte # of parameters,
<br/>
2 bytes not used yet, then parameters (each 32 bits).
<br/>
Return values are the parameters of an A7_RETURN or A9_RETURN message. */
<br/>
typedef enum {
<br/>
   A7_NULL,         //Dummy message, no parameters.
<br/>
   A7_INIT,         //Used to pass some data from ARM9 at startup. Param1=Pointer to ARM7StackDump.
<br/>
   A7_RETURN,         //Return value from a message; param1=message being responded to, others=return value.
<br/>
   A7_CHECK,         //Used to check that ARM7 is still responding. Return value=anything; just returns a value to let ARM9 know it's still going.
<br/>
   A7_ERROR,         //Notification that something bad happened; usually an invalid message was received. Param1=0 if invalid message.
<br/>
   A7_GBAMODE,         //Reboot into GBA mode, no parameters.
<br/>
   A7_SETPOWER,      //Change power settings; param1=0 to write, 1 to AND, 2 to OR, 3 to XOR; param2=bitflags. Note that System Power bit is reversed; 1=turn off.
<br/>
   A7_GETPOWER,      //Retrieve power settings; no parameters, returns power bitflags. Note that System Power bit is 0 on Phat and 1 on Lite(?).
<br/>
   A7_SETVOLUME,      //Set sound volume; param1=bits 0-6 set master sound volume, 7=1 to enable sound, 0 to disable.
<br/>
   A7_GETVOLUME,      //Retrieve sound volume; return bits 0-6=master volume, 7=1 if enabled, 0 if disabled.
<br/>
   A7_SETSOUND,      //Set flags for a sound channel; param1=channel (low 4 bits), param2=flags, param3=source, param4=length.
<br/>
   A7_GETSOUNDFLAGS,   //Get flags for a sound channel; param1=channel (low 4 bits), return1=flags, return2=source, return3=length.
<br/>
   A7_BOOTNDS,         //Enter wait loop to boot .nds file on GBAMP.
<br/>
   A7_WIFICTRL,      //Wifi control messages; see below for params.
<br/>
<br/>
   //Higher-level system control commands
<br/>
   A7_BACKLIGHT      //Set backlight brightness. Param1=Top light, Param2=Bottom light (-1=no change, 0=off, 1=on), Param3=Brightness (0-3 or -1 for no change, ignored if not DSLite)
<br/>
} A7_MESSAGE;
<br/>
<br/>
/*
<br/>
Bitmask for A7_SETSOUND and A7_GETSOUND:
<br/>
evvvvvvv pppppppw wwffffff ffffffft
<br/>
<br/>
e=enable (1) or disable (0)
<br/>
v=volume, 0=silent to 127=max
<br/>
p=pan, 64=middle
<br/>
w=wave duty, 0 to 6 (7=no sound)
<br/>
f=frequqncy, 8 to 65528h
<br/>
t=0 for standard mode, 1 for PSG (tone) mode (channels 8-13) or white noise (channel 14, 15)
<br/>
Source and Length parameters are optional, and aren't used in PSG mode.
<br/>
<br/>
<br/>
Parameters for A7_WIFICTRL:
<br/>
WIFIPARAM_SYNC: Call Wifi_Sync().
<br/>
WIFIPARAM_INIT: Pass Param2 to Wifi_Init(); turn on wifi hardware.
<br/>
WIFIPARAM_STOP: Turn off wifi hardware.
<br/>
*/
<br/>
<br/>
<br/>
//ARM9 messages (same format as ARM7)
<br/>
typedef enum {
<br/>
   A9_NULL,         //Dummy message, no parameters.
<br/>
   A9_INIT,         //ARM7 ready notification at startup, no parameters. IPC2-&gt;SysInfo is valid once this arrives.
<br/>
   A9_RETURN,         //Return value from a message; param1=message being responded to, others=return value.
<br/>
   A9_CHECK,         //Used to check that ARM9 is still responding. Return value=anything; just returns a value to let ARM7 know it's still going.
<br/>
   A9_ERROR,         //Notification that something bad happened, usually an invalid message was received. Param1=0 if invalid message, 1-4 if invalid parameter..
<br/>
   A9_FATALERROR,      //Notification that ARM7 has crashed. Param1=Error code, Param2=Stack pointer, Param3=Pointer to stack dump in main RAM since ARM9 can't read the real stack
<br/>
   A9_WIFISYNC         //Signal that Wifi_Sync() needs to be called.
<br/>
} A9_MESSAGE;
<br/>
<br/>
<br/>
#if ARM9
<br/>
enum Border {
<br/>
   BD_SOLID = -1,
<br/>
   BD_FILE,
<br/>
   BD_RED,
<br/>
   BD_GREEN,
<br/>
   BD_BLUE,
<br/>
   BD_YELLOW,
<br/>
   BD_PURPLE,
<br/>
   BD_MAX
<br/>
};
<br/>
<br/>
//BootFile(), BootMenu() etc return codes
<br/>
typedef enum {
<br/>
   BE_UNKNOWN_ERROR = 0,
<br/>
   BE_NOT_FOUND,         //File not found
<br/>
   BE_FMT_NOT_SUPPORTED,   //File format not supported
<br/>
   BE_CARD_NOT_SUPPORTED,   //Card not supported (also if e.g. .GBA file when no Slot-2 RAM)
<br/>
   BE_INVALID_FILE,      //Corrupt or invalid file
<br/>
   BE_NO_CARD,            //No DS card inserted
<br/>
   BE_NULL_PTR,         //NULL pointer passed
<br/>
   BE_INVALID_LOADER,      //Invalid loader specified
<br/>
   BE_MAX               //Last item (not actually returned)
<br/>
} BOOTERROR;
<br/>
#endif //ARM9
<br/>
<br/>
<br/>
//Loaders
<br/>
typedef enum {
<br/>
   LOAD_REBOOTLIB = 0,      //Rebootlib
<br/>
   LOAD_GBAMP,            //GBAMP hack loader
<br/>
   LOAD_MAX            //Last item
<br/>
} LOADER;
<br/>
<br/>
typedef struct {
<br/>
   char SSID[33];
<br/>
   char WEPKey[16];
<br/>
   bool AutoIP;
<br/>
   u32 IPAddr;
<br/>
   u32 SubnetMask;
<br/>
   u32 Gateway;
<br/>
   bool AutoDNS;
<br/>
   u32 PrimaryDNS;
<br/>
   u32 SecondaryDNS;
<br/>
} APSettings;
<br/>
<br/>
<br/>
//-----------------------OTHER HEADER INCLUDES-----------------------
<br/>
//#include "..\..\general\memory.h"
<br/>
//#include "..\..\general\_memory.h"
<br/>
#include "reboot.h"
<br/>
#if ARM7
<br/>
<br/>
#else //ARM9
<br/>
<br/>
#include "menu.h"
<br/>
#endif //ARM9
<br/>
<br/>
//-----------------------CONSTANTS-----------------------
<br/>
#if ARM7 //ndslib only declares this for ARM9 &lt;_&lt;
<br/>
typedef enum KEYPAD_BITS {
<br/>
  KEY_A      = BIT(0),  /*!&lt; keypad A button */
<br/>
  KEY_B      = BIT(1),  /*!&lt; keypad B button */
<br/>
  KEY_SELECT = BIT(2),  /*!&lt; keypad SELECT button*/
<br/>
  KEY_START  = BIT(3),  /*!&lt; keypad START button*/
<br/>
  KEY_RIGHT  = BIT(4),  /*!&lt; keypad RIGHT button*/
<br/>
  KEY_LEFT   = BIT(5),  /*!&lt; keypad LEFT button*/
<br/>
  KEY_UP     = BIT(6),  /*!&lt; keypad UP button*/
<br/>
  KEY_DOWN   = BIT(7),  /*!&lt; keypad DOWN button*/
<br/>
  KEY_R      = BIT(8),  /*!&lt; RIGHT shoulder button*/
<br/>
  KEY_L      = BIT(9),  /*!&lt; LEFT shoulder button*/
<br/>
  KEY_X      = BIT(10), /*!&lt; keypad X button*/
<br/>
  KEY_Y      = BIT(11), /*!&lt; keypad Y button*/
<br/>
  KEY_TOUCH  = BIT(12), /*!&lt; touchscreen pendown*/
<br/>
  KEY_LID    = BIT(13), /*!&lt; lid state*/
<br/>
} KEYPAD_BITS;
<br/>
<br/>
#else
<br/>
const char* OnOff[] = {"Off", "On"};
<br/>
const char* LightLevelStr[] = {"Low", "Med", "High", "Max"};
<br/>
const char* MainScreenStr[] = {"Bottom", "Top"};
<br/>
const char* BootError[] = {
<br/>
   "Unknown error.",
<br/>
   "File not found.",
<br/>
   "File type not supported.",
<br/>
   "Not supported on this card.",
<br/>
   "Corrupt or invalid file.",
<br/>
   "No card inserted.",
<br/>
   "NULL pointer passed (bug!)",
<br/>
   "Invalid loader specified."
<br/>
};
<br/>
const char* LoaderName[] = {"Rebootlib", "GBAMP"};
<br/>
<br/>
#endif //ARM9
<br/>
<br/>
//-----------------------GLOBAL VARS-----------------------
<br/>
#if ARM9
<br/>
volatile bool A7Init = false;
<br/>
<br/>
//System settings
<br/>
s8 GBABorder = BD_SOLID;
<br/>
char GBABorderFile[1024]; //Path to border file
<br/>
u8 BorderR = 0, BorderG = 0, BorderB = 0; //Colours for solid border
<br/>
bool TopLight = true, BottomLight = true; //Backlights on/off
<br/>
s8 LightBright = 3; //Brightness level
<br/>
bool EnableSound = true;
<br/>
bool GBAROMOwner = true, GBASRAMOwner = true, NDSCardOwner = true; //false=ARM7 true=ARM9
<br/>
bool MainScreenTop = true; //False = main screen on bottom
<br/>
char SaveDownloadPath[1024]; //Path to save wireless downloads to; empty string = don't save
<br/>
bool UseINI = true; //Whether settings in bootmenu.ini for the current game should override current ones
<br/>
<br/>
//Menu state
<br/>
//Note: No checks are done to ensure the menu stack does not overflow, so ensure it doesn't.
<br/>
u16 MenuStack[MENU_STACK_MAX];   //Array of which menus have been opened
<br/>
u16 MenuSel[MENU_STACK_MAX];//Which option was selected on each
<br/>
u16 MenuNumOptions[MENU_STACK_MAX]; //How many options are in the current menu
<br/>
u8 MenuStackPos = 0;
<br/>
s16 MenuOptionTouched = -1; //Which option was touched, -1 = none.
<br/>
s8 TouchXTile = -1, TouchYTile = -1; //Tile coords touched, -1 = not touched.
<br/>
QuickbootData* Quickboot = NULL;
<br/>
u32 NumQuickboot = 0; //Number of Quickboot entries in INI
<br/>
<br/>
//Files
<br/>
bool FATMounted = false;
<br/>
char** Filename = NULL; //pointer to array of pointers to file names
<br/>
u32 NumFiles = 0;
<br/>
char CurrentDir[256];
<br/>
FILE* File = NULL;
<br/>
<br/>
//Booting
<br/>
LOADER DefaultLoader = LOAD_REBOOTLIB;
<br/>
<br/>
//Wifi
<br/>
u8 MACAddress[6];
<br/>
u8 WifiAPNum = 1; //0 = custom AP, 1-3 = firmware APs
<br/>
APSettings WifiAP[4]; //WifiAPNum = index into this
<br/>
s32 NumAPsFound = 0; //Number of APs found when scanning
<br/>
<br/>
//Keys
<br/>
u16 KeysPressed = 0, KeysHeld = 0;
<br/>
u16 KeyRepeatDelay = 256, KeyRepeatSpeed = 100; //milliseconds
<br/>
u16 KeyRepeat[NUM_KEYS];
<br/>
bool EnableKeyRepeat[NUM_KEYS];
<br/>
char Password[17]; //Digit string: 0=A 1=B 2=Right 3=Left 4=Up 5=Down 6=L 7=R 8=X 9=Y
<br/>
u32 PwdTries = 3; //Number of attempts allowed
<br/>
bool PwdPowerOff = true; //After all attempts expired: true=power off, false=reject even correct password
<br/>
<br/>
//Startup message
<br/>
char* StartMsg = NULL; //Text to show below password prompt
<br/>
bool ForceStartMsg = false; //If true and no password, the message is shown anyway (press any key to continue).
<br/>
bool ScrollStartMsg = false; //If true the message will scroll by on the menu screen.
<br/>
u32 StartMsgDelay = 10; //How many frames to wait before advancing to next letter when scrolling
<br/>
<br/>
//Debug
<br/>
bool DebugMode = false;
<br/>
u32 ARM7StackDump[A7_STACK_DUMP_NUMWORDS]; //ARM7 will dump its stack into here on failure
<br/>
<br/>
#else //ARM7
<br/>
u32 ASMHackery; //Global variable doing what should be done by a local one if I could figure out how &gt;_&gt;
<br/>
u32* ARM7StackDump = 0; //Pointer to the real ARM7StackDump
<br/>
<br/>
#endif
<br/>
<br/>
<br/>
<br/>
//-----------------------FUNCTION PROTOTYPES-----------------------
<br/>
#if ARM7
<br/>
int main(int argc, char** argv);
<br/>
void DoA7Message(A7_MESSAGE Message, u8 NumParams, u32 Param1, u32 Param2, u32 Param3, u32 Param4, bool FromA9);
<br/>
void SendA9Message(A9_MESSAGE Message, u8 NumParams, u32 Param1, u32 Param2, u32 Param3, u32 Param4);
<br/>
void VBlankInterrupt();
<br/>
void Timer3Interrupt();
<br/>
void WifiInterrupt();
<br/>
void syncRTC();
<br/>
bool A7InitWifi(u32 A9Param);
<br/>
void _A7WifiSync();
<br/>
void FatalError(u32 Code);
<br/>
<br/>
#elif ARM9
<br/>
int main(int argc, char** argv);
<br/>
void DrawMenu(u32 ID, u32 Selected);
<br/>
void EnterMenu(u32 ID);
<br/>
void PasswordPrompt();
<br/>
bool ReadConfigFile(char* Section);
<br/>
s32 ListDirectory(char* Dir);
<br/>
s32 filenamecmpi(char* str1, char* str2);
<br/>
void ApplySystemSettings(bool NoUnmount);
<br/>
void CheckMessages();
<br/>
void DoA9Message(A9_MESSAGE Message, u8 NumParams, u32 Param1, u32 Param2, u32 Param3, u32 Param4, bool FromA7);
<br/>
void SendA7Message(A7_MESSAGE Message, u8 NumParams, u32 Param1, u32 Param2, u32 Param3, u32 Param4);
<br/>
void VBlankInterrupt();
<br/>
bool InitWifi();
<br/>
bool StopWifi();
<br/>
void _A9WifiSync();
<br/>
<br/>
//boot.c
<br/>
BOOTERROR BootFile(LOADER Loader, char* File);
<br/>
bool IsLoaderSupported(LOADER Loader);
<br/>
BOOTERROR BootMenu();
<br/>
void BootGBAMode();
<br/>
BOOTERROR BootDSCard();
<br/>
void PowerOff();
<br/>
<br/>
#endif //not ARM7
<br/>
<br/>
#endif //_MAIN_H_
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
The makefile is just the standard one, except I've added a bit to automatically apply a DLDI patch and run WMB.<br/>_________________<br/>I'm a PSP hacker now, but I still &lt;3 DS.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#133474 - mml - Fri Jul 06, 2007 10:52 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">const char* OnOff[] = {"Off", "On"};
<br/>
...
<br/>
const char* LoaderName[] = {"Rebootlib", "GBAMP"};</td> </tr></table><span class="postbody">
<br/>
<br/>
and everything from
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">//-----------------------GLOBAL VARS-----------------------</td> </tr></table><span class="postbody">
<br/>
<br/>
down to 
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">//-----------------------FUNCTION PROTOTYPES-----------------------</td> </tr></table><span class="postbody">
<br/>
<br/>
should not be in your .h file.  These are variable <span style="font-style: italic">definitions</span>; variables may only be defined once.  This is why when you include this .h from multiple source files, the compiler whinges about "multiple definitions"
<br/>
<br/>
You can have multiple <span style="font-style: italic">declarations</span> of a variable, but not multiple <span style="font-style: italic">definitions</span>.  Hint: the solution involves the keyword <span style="font-weight: bold">extern</span> as advised by someone earlier. :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#133542 - HyperHacker - Sat Jul 07, 2007 12:19 am</h4>
    <div class="postbody"><span class="postbody">Where should they be then?<br/>_________________<br/>I'm a PSP hacker now, but I still &lt;3 DS.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#133546 - masscat - Sat Jul 07, 2007 12:59 am</h4>
    <div class="postbody"><span class="postbody">If you want to make a variable available globally then define the instance of the variable (telling the compiler to assign it memory and give it a name) in some C source file outside of any functions (eg main.c). This should only get compiled once and therefore there will only be a single definition of the variable:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">...
<br/>
some code
<br/>
...
<br/>
int some_global_var;
<br/>
...
<br/>
...
<br/>
some more code
<br/>
...
<br/>
...</td> </tr></table><span class="postbody">
<br/>
<br/>
Then declare the existence of the variable in a header file using the 'extern' keyword.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">extern int some_global_var;</td> </tr></table><span class="postbody">
<br/>
This tells the compiler the size and type of 'some_global_var' allowing it to be used within the code that includes the header file but indicates that it is defined elsewhere (in main.c in this case) and the actual instance will be picked up during linking.
<br/>
<br/>
<br/>
Now a whole other discussion, should you be using global data or not.
<br/>
I personally strongly dislike global data. It can make code very hard to understand and maintain (even to the original author) as it is not obvious where and in what order a variable's value can change. Only ever use it in very well defined circumstances, i.e. you know (and comment) exact why and how the variable will change and this behaviour will not change in the future.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#133547 - HyperHacker - Sat Jul 07, 2007 1:15 am</h4>
    <div class="postbody"><span class="postbody">Yeah, a lot of this code is subject to change. Merging some things into structs and classes and whatnot. Come to think of it at least one of those isn't even used anymore... this is what happens when you base something on old code. :-S
<br/>
<br/>
Anyway extern fixed it (thanks), but I have another question: how do I access local variables in inline ASM? The compiler must be mangling their names or something because just referencing them by name doesn't work as it does with globals.<br/>_________________<br/>I'm a PSP hacker now, but I still &lt;3 DS.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#133687 - masscat - Sun Jul 08, 2007 12:29 am</h4>
    <div class="postbody"><span class="postbody">Here is a <a class="postlink" href="http://www.ibiblio.org/gferg/ldp/GCC-Inline-Assembly-HOWTO.html" target="_blank">gcc inline assembly howto</a>, i386 based but gives the syntax and principles. <a class="postlink" href="http://www.ethernut.de/en/documents/arm-inline-asm.html" target="_blank">And another one</a>.
<br/>
You can find some examples of ARM inline assembly in the <a class="postlink" href="http://forum.gbadev.org/viewtopic.php?t=10765&amp;postdays=0&amp;postorder=asc&amp;start=30" target="_blank">gdb debug stub code</a>.
<br/>
Only use assembly for fun (in a strange sense of the word), when need to access some specific functions of the processor/platform (eg cache flushing) or when you really need to optimise something and you know you can do it better than the compiler.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#133704 - HyperHacker - Sun Jul 08, 2007 1:11 am</h4>
    <div class="postbody"><span class="postbody">Thanks. I see this note in the first one:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">int a=10, b;
<br/>
asm ("movl %1, %%eax; 
<br/>
   movl %%eax, %0;"
<br/>
   :"=r"(b)        /* output */
<br/>
   :"r"(a)         /* input */
<br/>
   :"%eax"         /* clobbered register */
<br/>
);</td> </tr></table><span class="postbody">
<br/>
When I tried this, I got "undefined reference to r4", even though there was no "r4" to be found. I don't still have the exact code that caused it, but I'll try to reproduce it after dinner.
<br/>
<br/>
All I'm trying to do now is get the stack pointer to perform a dump, but I'll probably need to do other things inline later, so I may as well know how.<br/>_________________<br/>I'm a PSP hacker now, but I still &lt;3 DS.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#133709 - masscat - Sun Jul 08, 2007 1:43 am</h4>
    <div class="postbody"><span class="postbody">The first link is for inline i386 assembly, only the syntax and concepts are applicable. The second link gives ARM assembly examples.
<br/>
Here is the code to get the stack pointer (I think):
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">uint32_t getStackPtr( void) {
<br/>
  uint32_t stack_ptr;
<br/>
<br/>
  asm ( "mov %0, sp"
<br/>
        : "=r" (stack_ptr)
<br/>
        :
<br/>
        );
<br/>
<br/>
  return stack_ptr;
<br/>
}</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#133844 - HyperHacker - Mon Jul 09, 2007 6:16 am</h4>
    <div class="postbody"><span class="postbody">Yeah, that got it. The r4 thing was just caused by a dumb typo. &lt;_&lt; Thanks.<br/>_________________<br/>I'm a PSP hacker now, but I still &lt;3 DS.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#133847 - HyperHacker - Mon Jul 09, 2007 7:11 am</h4>
    <div class="postbody"><span class="postbody">I spoke too soon. Somehow, this is enough to corrupt the stack:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">u32 foo;
<br/>
__asm (
<br/>
      ".arm\n"
<br/>
      "mov %0, sp\n"
<br/>
: "=r" (foo));</td> </tr></table><span class="postbody">
<br/>
<br/>
I was able to get it not to cause corruption like so:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">u32 foo;
<br/>
u32* bar = &amp;foo;
<br/>
__asm (
<br/>
      ".arm\n"
<br/>
      "str sp, [%0]\n"
<br/>
: "=r" (bar);</td> </tr></table><span class="postbody">
<br/>
But the result is obviously wrong (0x20). :-( The addresses displayed by the default exception handler don't help much either; addr2line tells me they're in my VBlank interrupt handler (even when interrupts are disabled) on lines that either wouldn't be getting executed or don't even have anything on them.
<br/>
<br/>
The effects vary from printing a load of gibberish instead of the stack pointer to freezing to data abort. The first especially tells me the stack or possibly registers are getting stomped on. Using a global variable doesn't help, so it's not like it's storing to the wrong place. I wonder if the compiler isn't doing something silly like optimizing the variable out entirely because it doesn't realize the ASM is using it (even though it's listed as an output). &gt;_&gt;
<br/>
<br/>
As for debugging it in an emulator, none of them even get that far. They don't seem to support IPC FIFO. O_o<br/>_________________<br/>I'm a PSP hacker now, but I still &lt;3 DS.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
