<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Remove unused functions/dead code - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > Remove unused functions/dead code</h2>
<div id="posts">
<div class="post">
    <h4>#147547 - Peter - Sat Dec 22, 2007 5:57 pm</h4>
    <div class="postbody"><span class="postbody">I wonder how I can get devkitarm r21 to remove unused functions. 
<br/>
<br/>
If I remember correctly, GCC could only remove entire unused compilation units, but not seperate unused functions from those. That would make sense, because there are several projects that put every function in a seperate source file. So I did the same with my matrix module today (some functions are unused), but it didn't change anything to the final .nds filesize.
<br/>
<br/>
So I went one step further and created a new project using the arm9 template from the devkitpro examples, added three .cpp files with the functions:
<br/>
<ul>
<br/>
* Unused0();
<br/>
* Unused1();
<br/>
* Unused2(); (calls Unused1)
<br/>
</ul>
<br/>
<br/>
None of those functions is called anywhere. When I clean/make the project, its filesize grew. I tried some compiler and linker switches that I found thru google and think are related to it (I'm not an expert with toolchain stuff), but it still doesn't change anything on the size:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
CFLAGS += -ffunction-sections -fdata-sections
<br/>
LDFLAGS += --gc-sections -fssa -fssa-ccp -fssa-dce
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
This is the test project: <a class="postlink" href="http://www.console-dev.de/tmp/remove_unused_functions_test.zip" target="_blank">click here to download</a>
<br/>
<br/>
Any idea what I'm doing wrong?<br/>_________________<br/>Kind Regards,
<br/>
Peter</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#147564 - freemaan - Sun Dec 23, 2007 11:58 am</h4>
    <div class="postbody"><span class="postbody">You should use "-Wl,--gc-sections", not just "--gc-sections" :)<br/>_________________<br/>My other nickname: davido2</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#147565 - Peter - Sun Dec 23, 2007 1:48 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>freemaan wrote:</b></span></td> </tr> <tr> <td class="quote">You should use "-Wl,--gc-sections", not just "--gc-sections" :)</td> </tr></table><span class="postbody">
<br/>
The -Wl switch is a compiler switch, which instructs gcc/g++ to forward the --gc-sections parameter to the linker. Since I didn't add --gc-sections to the compiler flags (CFLAGS), but to the linker flags (LDFLAGS), I do not need -Wl. However, I wasn't really sure so I tested it, but it didn't change anything. Thanks anyway!<br/>_________________<br/>Kind Regards,
<br/>
Peter</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#147609 - wintermute - Mon Dec 24, 2007 12:11 pm</h4>
    <div class="postbody"><span class="postbody">That's a fairly common misunderstanding - gcc &amp; g++ are not compilers but rather drivers which run the other parts of the toolchain.
<br/>
<br/>
The devkitPro build system links code using these drivers rather than calling the linker directly so the LDFLAGS variable contains flags used during the link stage of the build and not linker flags specifically. This is the <span style="font-weight: bold">proper</span> way to link using a gcc based toolchain - using the linker directly bypasses the parts of the compiler suite which know where libraries are located and which system libraries contain circular depencies.
<br/>
<br/>
I just checked your example here and the -Wl,--gc-sections option saved 1336 bytes.
<br/>
<br/>
When you're comparing things like this you need to make sure that you clean the project and rebuild it from scratch. I get bitten by that one on a regular basis - my personal favourite is making a copy of a project for testing then spending 10 minutes trying to figure out why my code changes aren't being compiled ;)<br/>_________________<br/><a class="postlink" href="http://www.devkitpro.org/" target="_blank">devkitPro - professional toolchains at amateur prices</a>
<br/>
<a class="postlink" href="http://wiki.devkitpro.org/index.php/IRC" target="_blank">devkitPro IRC support</a>
<br/>
<a class="postlink" href="http://davejmurphy.com/" target="_blank">Personal Blog</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#147610 - kusma - Mon Dec 24, 2007 12:49 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>wintermute wrote:</b></span></td> </tr> <tr> <td class="quote">I just checked your example here and the -Wl,--gc-sections option saved 1336 bytes.</td> </tr></table><span class="postbody">
<br/>
Ouch, off by one!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#147611 - chishm - Mon Dec 24, 2007 1:07 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>kusma wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>wintermute wrote:</b></span></td> </tr> <tr> <td class="quote">I just checked your example here and the -Wl,--gc-sections option saved 1336 bytes.</td> </tr></table><span class="postbody">
<br/>
Ouch, off by one!</span></td> </tr></table><span class="postbody">
<br/>
Yeah, those damn half-word alignments ruin all the fun.<br/>_________________<br/><a class="postlink" href="http://chishm.drunkencoders.com" target="_blank">http://chishm.drunkencoders.com</a>
<br/>
<a class="postlink" href="http://dldi.drunkencoders.com" target="_blank">http://dldi.drunkencoders.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#147613 - Peter - Mon Dec 24, 2007 1:25 pm</h4>
    <div class="postbody"><span class="postbody">Indeed it works, yay!<br/>_________________<br/>Kind Regards,
<br/>
Peter</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
