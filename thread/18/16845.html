<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Passing an address pointer from ARM9 to ARM7..? - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>DS development > Passing an address pointer from ARM9 to ARM7..?</h2>
<div id="posts">
<div class="post">
    <h4>#170156 - Ruben - Fri Sep 04, 2009 9:48 am</h4>
    <div class="postbody"><span class="postbody">Hi~
<br/>
<br/>
So I started porting XMid to the DS but I need to have an address from a variable on the ARM9 exec and, since the ARM7 and ARM9 execs must be compiled separately, I can't seem to be able to do this without using FIFO, but I was wondering.. Since I'll only need this once during setting up of sound (that is, setting up the hardware channels), is there any other way to do this?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170158 - headspin - Fri Sep 04, 2009 5:59 pm</h4>
    <div class="postbody"><span class="postbody">Are you using the latest libnds? If so then just use FIFO. You can take a look at the example used in libxm7 <a class="postlink" href="http://wcms.teleion.it/users/cgq/nds/libxm7/" target="_blank">here</a> which uses a custom FIFO command to send over a pointer to a struct used on the ARM7.
<br/>
<br/>
The older method is using shared memory (IPC) which is at 0x027FF000. You can take a look at older libnds source and see how they use a struct in IPC to share memory with the ARM7. It's not the recommended method to communicate with the ARM7 anymore though.
<br/>
<br/>
You will need to use the "combined" template example from devkitARM to do custom stuff on the ARM7.<br/>_________________<br/><a class="postlink" href="http://headsoft.com.au/index.php?category=warhawk" target="_blank">Warhawk DS</a> | <a class="postlink" href="http://headsoft.com.au/index.php?category=mmll" target="_blank">Manic Miner: The Lost Levels</a> | <a class="postlink" href="http://headsoft.com.au/index.php?category=tdg" target="_blank">The Detective Game</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170223 - Ruben - Wed Sep 09, 2009 12:17 pm</h4>
    <div class="postbody"><span class="postbody">Hm, well I've been trying to use FIFO, but I think I've broken the code somewhere along the line.. anyone care to point me in the right direction?
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">@ File: XMid_Comm7.s
<br/>
<br/>
/******************************/
<br/>
/* XMid v1.08f                */
<br/>
/******************************/
<br/>
#include "XMidLib.h"
<br/>
#include "XMid_Internal.inc"
<br/>
/******************************/
<br/>
<br/>
.global   XMid_FIFO_Receive7
<br/>
.global   XMid_FIFO_Req7
<br/>
.global __XMid_FIFO7_Tbl
<br/>
<br/>
/******************************/
<br/>
.text
<br/>
.align
<br/>
.arm
<br/>
/******************************/
<br/>
<br/>
XMid_FIFO_Receive7:
<br/>
   adr     r1, __XMid_FIFO7_Tbl @ fetch FIFO buffer adr
<br/>
   mov     r2, #0x20            @ queue length
<br/>
1: ldr     r3, [r1], #0x04      @ *buffer
<br/>
   cmp     r3, #0x00            @ if(*buffer != 0) {
<br/>
   subnes  r2, r2, #0x01        @   if(--max) loop
<br/>
   bne     1b                   @ }
<br/>
   cmp     r3, #0x00            @ if(!hit end)
<br/>
   streq   r0, [r1, #-0x04]     @   store
<br/>
   bx      lr
<br/>
<br/>
__XMid_FIFO7_Tbl:
<br/>
   .space   32*4
<br/>
<br/>
.align
<br/>
.size XMid_FIFO_Receive7, .-XMid_FIFO_Receive7
<br/>
<br/>
/******************************/
<br/>
<br/>
XMid_FIFO_Req7:
<br/>
   adr     r1, __XMid_FIFO7_Tbl @ adr buffer
<br/>
   mov     r2, #0x20            @ size of queue
<br/>
1: ldr     r3, [r1], #0x04      @ *buffer
<br/>
   cmp     r0, r3, lsr #0x1C    @ if(buffer-&gt;type != type) {
<br/>
   subnes  r2, r2, #0x01        @   if(--max) loop
<br/>
   bne     1b                   @ }
<br/>
   cmp     r0, r3, lsr #0x1C    @ double check type
<br/>
   mov     r0, #0x00            @ clear return value
<br/>
   streq   r0, [r1, #-0x04]     @ if(ty == bf-&gt;ty) clear from tbl
<br/>
   biceq   r0, r3, #0xF0000000  @ return (buffer &amp; ~type_mask)
<br/>
   bx      lr
<br/>
<br/>
.align
<br/>
.size XMid_FIFO_Req7, .-XMid_FIFO_Req7
<br/>
<br/>
/******************************/
<br/>
/* EOF                        */
<br/>
</td> </tr></table><span class="postbody">
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">@ File: XMid_Comm9.s
<br/>
<br/>
/******************************/
<br/>
/* XMid v1.08f                */
<br/>
/******************************/
<br/>
#include "XMidLib.h"
<br/>
#include "XMid_Internal.inc"
<br/>
/******************************/
<br/>
<br/>
.global XMid_FIFO_Receive9
<br/>
<br/>
/******************************/
<br/>
.text
<br/>
.align
<br/>
.arm
<br/>
/******************************/
<br/>
<br/>
XMid_FIFO_Receive9:
<br/>
   cmp     r0, #FIFO_UPDATE
<br/>
   beq     1f                      @ on update, skip return value
<br/>
   adr     r1, 2f                  @ fetch table pointer
<br/>
   ldr     r1, [r1, r0, lsl #0x02] @ load value from idx
<br/>
   orr     r1, r1, r0, lsl #0x1C   @ ORR with type
<br/>
   mov     r0, #FIFO_CHAN          @ FIFO chan (8)
<br/>
   stmfd   sp!, {lr}               @ save lr
<br/>
   blx     fifoSendValue32         @ return value (8, ptr + type&lt;&lt;28)
<br/>
   ldmfd   sp!, {lr}
<br/>
   bx      lr
<br/>
1: stmfd   sp!, {lr}
<br/>
   blx     XMid_Song               @ update players
<br/>
   ldmfd   sp!, {lr}
<br/>
   bx      lr
<br/>
2: .word   __XMid_Var @ FIFO_VARADR
<br/>
   .word   __XMid_Chn @ FIFO_CHNADR
<br/>
   .word   __XMid_Bfr @ FIFO_BFRADR
<br/>
<br/>
.size XMid_FIFO_Receive9, .-XMid_FIFO_Receive9
<br/>
<br/>
/******************************/
<br/>
/* EOF                        */
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
All I plan for them to do is:
<br/>
The ARM7 sends a request for an address (out of VAR/CHN/BFR), the ARM9 returns the address into the ARM7 FIFO, and then I look through the list for the address I wanted.
<br/>
<br/>
For example, I use this in the ARM7 initialization code:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">@ setup FIFO handler
<br/>
   mov      r0, #FIFO_CHAN
<br/>
   ldr      r1, =XMid_FIFO_Receive7
<br/>
   ldr      r2, =fifoSetValue32Handler
<br/>
   bl      .Lexit_r2
<br/>
   
<br/>
@ request buffer address
<br/>
   mov      r0, #FIFO_CHAN
<br/>
   mov      r1, #FIFO_BFRADR
<br/>
   ldr      r2, =fifoSendValue32
<br/>
   bl      .Lexit_r2
<br/>
<br/>
@ wait until it shows up
<br/>
1: mov      r0, #FIFO_BFRADR
<br/>
   ldr      r2, =XMid_FIFO_Req7
<br/>
   bl      .Lexit_r2
<br/>
   mov      r2, r0
<br/>
   beq      1b @ &lt;----- Never goes past that</td> </tr></table><span class="postbody">
<br/>
<br/>
All the ARM9 does with FIFO in init is this
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">mov      r0, #FIFO_CHAN
<br/>
ldr      r1, =XMid_FIFO_Receive9
<br/>
ldr      r2, =fifoSetValue32Handler
<br/>
blx      r2</td> </tr></table><span class="postbody">
<br/>
<br/>
Btw, sorry for the code spam, but I just can't figure out any other way to explain without linking a bunch of files &gt;&gt;'</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
