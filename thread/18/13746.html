<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Booting GBA with custom borders - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>DS development > Booting GBA with custom borders</h2>
<div id="posts">
<div class="post">
    <h4>#135382 - yellowstar - Mon Jul 23, 2007 1:20 am</h4>
    <div class="postbody"><span class="postbody"><span style="font-weight: bold">The problem in this post is
<br/>
not the problem I am having right now.
<br/>
See my second post for my current problem.</span>
<br/>
<br/>
I need some help with booting GBA homebrew.
<br/>
<br/>
How do I boot GBA homebrew?
<br/>
<br/>
I know how to boot the Game Pak.
<br/>
<br/>
<span style="font-weight: bold">EDIT:</span>
<br/>
I only have a Slot-1 device.
<br/>
<br/>
For Slot-2 devices,
<br/>
I only have commercial Game Paks.</span><span class="gensmall"><br/><br/>Last edited by yellowstar on Sat Jul 28, 2007 11:59 pm; edited 3 times in total</span></div>    
</div>
<div class="post">
    <h4>#135392 - tepples - Mon Jul 23, 2007 2:01 am</h4>
    <div class="postbody"><span class="postbody">Which flash equipment are you using in SLOT-2?<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#135394 - yellowstar - Mon Jul 23, 2007 2:08 am</h4>
    <div class="postbody"><span class="postbody">I only have a Slot-1 device.
<br/>
<br/>
For Slot-2 devices,
<br/>
I only have commercial Game Paks.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#135397 - dantheman - Mon Jul 23, 2007 2:46 am</h4>
    <div class="postbody"><span class="postbody">You can only boot GBA homebrew if you have a homebrew device in slot-2.  You cannot launch it from a slot-1 device.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#135443 - spinal_cord - Mon Jul 23, 2007 12:27 pm</h4>
    <div class="postbody"><span class="postbody">dantheman is right. The GBA hardware does not know slot-1 exists and has absolutely no access to it.<br/>_________________<br/>I'm not a boring person, it's just that boring things keep happening to me.
<br/>
<a class="postlink" href="http://spinal.dizidesigns.co.uk/" target="_blank">Homepage</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#135862 - tepples - Thu Jul 26, 2007 9:26 pm</h4>
    <div class="postbody"><span class="postbody">Solution: Buy the EZ-FLASH 3-in-1 card.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#136087 - yellowstar - Sat Jul 28, 2007 11:56 pm</h4>
    <div class="postbody"><span class="postbody">I now am now having a differen't problem.
<br/>
<br/>
I am trying to boot Game Paks,(GBA)
<br/>
with custom borders,
<br/>
but it won't work.
<br/>
<br/>
Booting works fine,
<br/>
it's the border that won't work.
<br/>
<br/>
The border that is displayed is a normal,
<br/>
black border.
<br/>
<br/>
Here's how I am doing it:
<br/>
<br/>
ARM9:
<br/>
<br/>
For booting GBA,
<br/>
the ARM9 calls PreGBA,
<br/>
then CommandBootGBA.
<br/>
CommandBootGBA
<br/>
does stuff for initializing for
<br/>
booting and the custom border,
<br/>
then it sends a message
<br/>
to the ARM7,
<br/>
telling it to boot the GBA slot.
<br/>
<br/>
<br/>
Here's the data palette vars:
<br/>
(These vars are initialized in a init function.)
<br/>
(My code converts paletted data to 16 bit data.)
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
u16 *data = NULL;
<br/>
unsigned char *data2 = NULL;
<br/>
u16 *palette = NULL;
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
<br/>
void PreGBA()
<br/>
{
<br/>
<br/>
DIR_ITER *dir;
<br/>
char str[256];
<br/>
char str2[256];
<br/>
strcpy(str,"");
<br/>
strcpy(str2,"");
<br/>
<br/>
sprintf(str,"/GameBooter/Extras/GBA/Games/%s/A/",GBA_HEADER.title);
<br/>
<br/>
dir = diropen(str);
<br/>
<br/>
if(dir!=NULL)
<br/>
{
<br/>
<br/>
<br/>
dirclose(dir);
<br/>
<br/>
FILE *f = NULL;
<br/>
int size = 0;
<br/>
sprintf(str2,"%s%s",str,"Pic.raw");
<br/>
f = fopen(str2,"rb");
<br/>
if(f==NULL)
<br/>
return;
<br/>
<br/>
size = GetFileSize(f);
<br/>
<br/>
if(size!=256*192)
<br/>
{
<br/>
FAT_init_success = false;
<br/>
fclose(f);
<br/>
return;
<br/>
}
<br/>
<br/>
fread(data2,1,256*192,f);
<br/>
<br/>
fclose(f);
<br/>
<br/>
sprintf(str2,"%s%s",str,"master.pal");
<br/>
<br/>
size = 0;
<br/>
<br/>
f = fopen(str2,"rb");
<br/>
if(f==NULL)
<br/>
return;
<br/>
<br/>
size = GetFileSize(f);
<br/>
<br/>
fread(palette,2,size/2,f);
<br/>
<br/>
fclose(f);
<br/>
<br/>
for(int i=0; i &lt; 256*192; i++)
<br/>
{
<br/>
<br/>
data[i] = palette[data2[i]];
<br/>
<br/>
}
<br/>
<br/>
<br/>
}
<br/>
<br/>
<br/>
}
<br/>
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Here's the code for CommandBootGBA:
<br/>
(FAT_init_success is the value fatInitDefault returns.)
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
<br/>
void CommandBootGBA()
<br/>
{
<br/>
<br/>
u16 clear = 0x0000; 
<br/>
u32 *VRAMA = (u32 *)0x06000000; 
<br/>
u32 *VRAMB = (u32 *)0x06020000; 
<br/>
u32 *VRAMC = (u32 *)0x06040000; 
<br/>
u32 *VRAMD = (u32 *)0x06060000; 
<br/>
vramSetMainBanks( VRAM_A_MAIN_BG, VRAM_B_MAIN_BG, 
<br/>
VRAM_C_MAIN_BG, VRAM_D_MAIN_BG);
<br/>
<br/>
<br/>
memset(VRAMA, clear, 256*256*2); 
<br/>
memset(VRAMB, clear, 256*256*2); 
<br/>
<br/>
memset(VRAMC, clear, 256*256*2); 
<br/>
memset(VRAMD, clear, 256*256*2); 
<br/>
vramSetMainBanks( VRAM_A_MAIN_BG, VRAM_B_MAIN_BG, 
<br/>
VRAM_C_ARM7, VRAM_D_ARM7);
<br/>
<br/>
if(FAT_init_success)
<br/>
{
<br/>
<br/>
videoSetMode(MODE_5_2D);
<br/>
<br/>
dmaCopy((u16*)data,VRAM_A,256*192*2);
<br/>
dmaCopy((u16*)data,VRAM_B,256*192*2);
<br/>
<br/>
}
<br/>
<br/>
if(PersonalData-&gt;_user_data.gbaScreen) { 
<br/>
lcdMainOnBottom(); 
<br/>
} 
<br/>
REG_EXEMEMCNT = (0xa08f); 
<br/>
<br/>
commandControl-&gt;processed = false;
<br/>
<br/>
commandControl-&gt;mode = false;
<br/>
<br/>
commandControl-&gt;fire = true;
<br/>
<br/>
sysSetCartOwner(false);
<br/>
<br/>
}
<br/>
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
ARM7:
<br/>
<br/>
I can't post any code for the ARM7,
<br/>
as for some reason the source files
<br/>
got corrupted,
<br/>
and they can't be read anymore.
<br/>
I have backups
<br/>
on a differen't computer,
<br/>
but I don't have access to it.
<br/>
<br/>
Basicly the ARM7
<br/>
does the normal GBA booting stuff.
<br/>
It does this when it receives the
<br/>
message from the ARM9 to boot.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#136120 - chuckstudios - Sun Jul 29, 2007 1:46 pm</h4>
    <div class="postbody"><span class="postbody">My code probably has some unnecessary steps, but this how I boot to GBA with borders:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void injectBorder(void) {
<br/>
   EFS_FILE* borderFile;
<br/>
   char* borderData = malloc(98304);
<br/>
   memset(borderData, 0, 98304);
<br/>
   borderFile = EFS_fopen("/border.bin");
<br/>
   EFS_fread(borderData, 1, 98304, borderFile);
<br/>
   EFS_fclose(borderFile);
<br/>
   
<br/>
   videoSetMode(MODE_5_2D | DISPLAY_BG3_ACTIVE);
<br/>
   videoSetModeSub(MODE_5_2D | DISPLAY_BG3_ACTIVE);
<br/>
   vramSetMainBanks(VRAM_A_MAIN_BG_0x06000000, VRAM_B_MAIN_BG_0x06020000, VRAM_C_SUB_BG_0x06200000, VRAM_D_LCD);
<br/>
<br/>
   // for the main screen
<br/>
   BG3_CR = BG_BMP16_256x256 | BG_BMP_BASE(0) | BG_WRAP_OFF;
<br/>
   BG3_XDX = 1 &lt;&lt; 8; //scale x
<br/>
   BG3_XDY = 0; //rotation x
<br/>
   BG3_YDX = 0; //rotation y
<br/>
   BG3_YDY = 1 &lt;&lt; 8; //scale y
<br/>
   BG3_CX = 0; //translation x
<br/>
   BG3_CY = 0; //translation y
<br/>
<br/>
   // actually using it as a back buffer, but to see it as a viewable BG in no$...
<br/>
   BG2_CR = BG_BMP16_256x256 | BG_BMP_BASE(8) | BG_WRAP_OFF;
<br/>
   BG2_XDX = 1 &lt;&lt; 8; //scale x
<br/>
   BG2_XDY = 0; //rotation x
<br/>
   BG2_YDX = 0; //rotation y
<br/>
   BG2_YDY = 1 &lt;&lt; 8; //scale y
<br/>
   BG2_CX = 0; //translation x
<br/>
   BG2_CY = 0; //translation y
<br/>
   
<br/>
   dmaCopy(borderData, (uint16*)BG_BMP_RAM(0), 256*192*2);
<br/>
   dmaCopy(borderData, (uint16*)BG_BMP_RAM(8), 256*192*2);
<br/>
<br/>
}      
<br/>
      
<br/>
void bootGBA(void){
<br/>
   iprintf("Starting execution.\n");
<br/>
   //swiDelay(0x200000);
<br/>
   //hardware_init();
<br/>
   sysSetBusOwners(BUS_OWNER_ARM7,BUS_OWNER_ARM7);
<br/>
   if(PersonalData-&gt;_user_data.gbaScreen)
<br/>
      REG_POWERCNT=1;
<br/>
   else
<br/>
      REG_POWERCNT=POWER_SWAP_LCDS|1;
<br/>
   IPC_ARM9=IPC_GBA;
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
border.bin is converted with GRIT with the following commands:
<br/>
<br/>
grit border.bmp -ftbin -fh! -gB16</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
