<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Trouble with Tiles / Font - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > Trouble with Tiles / Font</h2>
<div id="posts">
<div class="post">
    <h4>#165986 - Doogle - Thu Jan 15, 2009 7:20 am</h4>
    <div class="postbody"><span class="postbody">I'm having some difficulties establishing a Font using Tiles.
<br/>
I've been through the tutorials and examples and think I know what I'm doing but the results indicate that I do not and that I'm missing something fairly fundamental. 
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
void initVideo(){
<br/>
<br/>
   powerOn(POWER_ALL_2D);
<br/>
   
<br/>
   vramSetMainBanks(VRAM_A_MAIN_BG_0x06000000,
<br/>
                     VRAM_B_MAIN_BG_0x06020000,
<br/>
                     VRAM_C_SUB_BG_0x06200000,
<br/>
                     VRAM_D_LCD);
<br/>
<br/>
    /*  Set the video mode on the main screen. */
<br/>
    videoSetMode(MODE_0_2D | // Set the graphics mode to Mode 0
<br/>
                 DISPLAY_BG2_ACTIVE); // Enable BG2 for display
<br/>
<br/>
    /*  Set the video mode on the sub screen. */
<br/>
    videoSetModeSub(MODE_0_2D | // Set the graphics mode to Mode 0
<br/>
                    DISPLAY_BG2_ACTIVE); // Enable BG2 for display
<br/>
}
<br/>
<br/>
uint16* map; //Pointer to the main screen Map
<br/>
uint16* sub_map; //Pointer to the sub-screen Map
<br/>
<br/>
void initBackgrounds() {
<br/>
<br/>
   REG_BG2CNT = BG_COLOR_256 | 
<br/>
             BG_TILE_BASE(0) | 
<br/>
             BG_MAP_BASE(20) |
<br/>
             BG_PRIORITY(3);
<br/>
            
<br/>
   REG_BG2X = 0; //main screen origin
<br/>
   REG_BG2Y = 0;
<br/>
   
<br/>
   REG_BG2CNT_SUB = BG_COLOR_256 |
<br/>
                BG_TILE_BASE(0) |
<br/>
                BG_MAP_BASE(20) |
<br/>
                BG_PRIORITY(3);
<br/>
               
<br/>
   REG_BG2X_SUB = 0; //sub-screen origin
<br/>
   REG_BG2Y_SUB = 0;
<br/>
   
<br/>
   uint16* tile = (uint16 *) BG_TILE_RAM(0); //Initialise a pointer to the Tile Ram
<br/>
   map = (uint16 *) BG_MAP_RAM(20); //Initialise the pointer to the main screen Map
<br/>
   uint16* sub_tile = (uint16 *) BG_TILE_RAM_SUB(0); // Initialise a ponter to the sub-screen Tile Ram
<br/>
   sub_map = (uint16 *) BG_MAP_RAM_SUB(20); //Initialise the pointer to the sub-screen Map
<br/>
<br/>
   int i;
<br/>
   /*
<br/>
   Populate the main and sub-screen tile Ram
<br/>
   */
<br/>
   for(i=0;i&lt;font3TilesLen/sizeof(uint16);i++){
<br/>
      tile[i]=sub_tile[i]=font3Tiles[i];
<br/>
   }
<br/>
   /*
<br/>
   Populate the main and sub-screen Palettes
<br/>
   */
<br/>
   for(i = 0;i&lt;font3PalLen/sizeof(uint16);i++){
<br/>
      BG_PALETTE[i]=BG_PALETTE_SUB[i]=font3Pal[i];
<br/>
   }
<br/>
}
<br/>
void PrintMsg() {
<br/>
<br/>
   int i;
<br/>
   int j;
<br/>
   
<br/>
   char* msg[] = {
<br/>
    "0123456789",
<br/>
    "ABCDEFGHIJKLMNOPQRSTUVWXYZ",
<br/>
    "abcdefghijklmnopqrstuvwxyz",
<br/>
  };
<br/>
  /*
<br/>
  Print to the main screen
<br/>
  */
<br/>
   for(i = 0; i &lt; sizeof(msg); ++i) {
<br/>
      for(j = 0; msg[i][j] != '\0'; ++j) {
<br/>
          map[j + (i * 32)] = msg[i][j]-' ' ;   //Font starts with a space character
<br/>
                                               //so we have to subtract the offset
<br/>
<br/>
      }
<br/>
   }
<br/>
   swiWaitForVBlank();
<br/>
}
<br/>
int main(void) 
<br/>
{
<br/>
   initVideo();
<br/>
   initBackgrounds();
<br/>
   PrintMsg();
<br/>
   return ;
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
The result is a pink background of some wierd character and black space and other wierd characters where the text should be displayed. Clearly either I'm not putting the tiles where I think I am, or I'm not mapping to them correctly.
<br/>
I'm using the Font.bmp and .Grit file from the nds/2D/customfont example.(renamed to 'font3')
<br/>
Any suggestions where I'm going wrong, or pointers to additional tutorials / information would be appreciated.
<br/>
Thanks.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#165990 - samel - Thu Jan 15, 2009 6:33 pm</h4>
    <div class="postbody"><span class="postbody">for(i=0;i&lt;font3TilesLen/sizeof(uint16);i++){
<br/>
      tile[i]=sub_tile[i]=font3Tiles[i];
<br/>
   } 
<br/>
<br/>
should not be
<br/>
<br/>
for(i=0;i&lt;font3TilesLen;i++){
<br/>
      tile[i]=sub_tile[i]=font3Tiles[i];
<br/>
   } 
<br/>
<br/>
and tile should not be u8* ?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#165992 - Cearn - Thu Jan 15, 2009 7:21 pm</h4>
    <div class="postbody"><span class="postbody">The problem is here: 
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Doogle wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">   uint16* tile = (uint16 *) BG_TILE_RAM(0); //Initialise a pointer to the Tile Ram
<br/>
   uint16* sub_tile = (uint16 *) BG_TILE_RAM_SUB(0); // Initialise a ponter to the sub-screen Tile Ram
<br/>
<br/>
   ...
<br/>
<br/>
   int i;
<br/>
   // Populate the main and sub-screen tile Ram
<br/>
   for(i=0;i&lt;font3TilesLen/sizeof(uint16);i++){
<br/>
      tile[i]= sub_tile[i]= font3Tiles[i];
<br/>
   }
<br/>
</td> </tr></table><span class="postbody"></span></td> </tr></table><span class="postbody">
<br/>
The exported tiles are an u32 array, but you're copying them into an u16 array, causing you to lose half of the data. If you create your own copy loops, make sure the source and destination units are the same. Better yet, use a dedicated copier like dmaCopyWords (or even the standard memcpy) for large copies. These will be considerably faster, use less code and you won't have to worry about how the arrays are defined.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">// memcpy example (args: dst, src, size):
<br/>
#include &lt;stdlib.h&gt;
<br/>
memcpy(BG_TILE_RAM(0), font3Tiles, font3TilesLen);
<br/>
<br/>
// dma example (args: channel, src, dst, size)
<br/>
dmaCopyWords(3, font3Tiles, BG_TILE_RAM(0), font3TilesLen);</td> </tr></table><span class="postbody">
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>samel wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">for(i=0;i&lt;font3TilesLen/sizeof(uint16);i++){
<br/>
    tile[i]= sub_tile[i]= font3Tiles[i];
<br/>
}</td> </tr></table><span class="postbody">
<br/>
should not be
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">for(i=0;i&lt;font3TilesLen;i++){
<br/>
    tile[i]= sub_tile[i]= font3Tiles[i];
<br/>
}</td> </tr></table><span class="postbody">
<br/>
and tile should not be u8* ?</span></td> </tr></table><span class="postbody">
<br/>
No; partly for the same reasons as given above, but also because you can't write in byte-size chunks to VRAM, OAM or the palette.  There's also the speed issue: byte copies require twice as many loop iterations as halfword copies for a given array-size and as such are roughly twice as slow.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#165993 - Doogle - Thu Jan 15, 2009 7:24 pm</h4>
    <div class="postbody"><span class="postbody">Thanks for the response. Unfortunately, having made the changes the result is very similar, with the exception that I just get the pink background with no text at all.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#165997 - elhobbs - Thu Jan 15, 2009 7:44 pm</h4>
    <div class="postbody"><span class="postbody">do you have a priority issue on the background? you are using BG_PRIORITY(3) which is the lowest priority. Is another background covering your background?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#165998 - Doogle - Thu Jan 15, 2009 7:59 pm</h4>
    <div class="postbody"><span class="postbody">Thanks for the responses. I've changed the population of the Tile Ram to 
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
   dmaCopyWords(3, font3Tiles, BG_TILE_RAM(0), font3TilesLen);
<br/>
   dmaCopyWords(3, font3Tiles, BG_TILE_RAM_SUB(0), font3TilesLen);
<br/>
</td> </tr></table><span class="postbody">
<br/>
and also changed the Priority (although there are no other backgrounds)
<br/>
<br/>
I'm still getting the pink background and wierd characters.
<br/>
<br/>
I've got a feling that I'm missing something fairly fundamental.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#166000 - elhobbs - Thu Jan 15, 2009 9:42 pm</h4>
    <div class="postbody"><span class="postbody">I patched up your code to work on desmume - see below
<br/>
the main issues were you were not setting your backgrounds correctly. the tiles are 4 bit not 8bit and you were also not loading the palette for either screen. also sizeof(msg) is not correct for your print loop.
<br/>
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">/*---------------------------------------------------------------------------------
<br/>
<br/>
   Simple console print demo
<br/>
   -- dovoto
<br/>
<br/>
---------------------------------------------------------------------------------*/
<br/>
#include &lt;nds.h&gt;
<br/>
#include &lt;stdio.h&gt;
<br/>
<br/>
#include "font3.h"
<br/>
<br/>
//---------------------------------------------------------------------------------
<br/>
void initVideo(){ 
<br/>
<br/>
   powerOn(POWER_ALL_2D); 
<br/>
    
<br/>
   vramSetMainBanks(VRAM_A_MAIN_BG_0x06000000, 
<br/>
                     VRAM_B_MAIN_BG_0x06020000, 
<br/>
                     VRAM_C_SUB_BG_0x06200000, 
<br/>
                     VRAM_D_LCD); 
<br/>
<br/>
    /*  Set the video mode on the main screen. */ 
<br/>
    videoSetMode(MODE_0_2D | // Set the graphics mode to Mode 0 
<br/>
                 DISPLAY_BG2_ACTIVE); // Enable BG2 for display 
<br/>
<br/>
    /*  Set the video mode on the sub screen. */ 
<br/>
    videoSetModeSub(MODE_0_2D | // Set the graphics mode to Mode 0 
<br/>
                    DISPLAY_BG2_ACTIVE); // Enable BG2 for display 
<br/>
} 
<br/>
<br/>
uint16* map; //Pointer to the main screen Map 
<br/>
uint16* sub_map; //Pointer to the sub-screen Map 
<br/>
<br/>
void initBackgrounds() { 
<br/>
<br/>
   REG_BG2CNT = BG_32x32 | BG_COLOR_16 | 
<br/>
             BG_TILE_BASE(0) | 
<br/>
             BG_MAP_BASE(20) | 
<br/>
             BG_PRIORITY(3); 
<br/>
             
<br/>
   REG_BG2X = 0; //main screen origin 
<br/>
   REG_BG2Y = 0; 
<br/>
    
<br/>
   REG_BG2CNT_SUB = BG_32x32| BG_COLOR_16 | 
<br/>
                BG_TILE_BASE(0) | 
<br/>
                BG_MAP_BASE(20) | 
<br/>
                BG_PRIORITY(3); 
<br/>
                
<br/>
   REG_BG2X_SUB = 0; //sub-screen origin 
<br/>
   REG_BG2Y_SUB = 0; 
<br/>
    
<br/>
   uint16* tile = (uint16 *) BG_TILE_RAM(0); //Initialise a pointer to the Tile Ram 
<br/>
   map = (uint16 *) BG_MAP_RAM(20); //Initialise the pointer to the main screen Map 
<br/>
   uint16* sub_tile = (uint16 *) BG_TILE_RAM_SUB(0); // Initialise a ponter to the sub-screen Tile Ram 
<br/>
   sub_map = (uint16 *) BG_MAP_RAM_SUB(20); //Initialise the pointer to the sub-screen Map 
<br/>
<br/>
   int i; 
<br/>
   /* 
<br/>
   Populate the main and sub-screen tile Ram 
<br/>
   */ 
<br/>
   dmaCopyWords(3, font3Pal, BG_PALETTE, font3PalLen);
<br/>
   dmaCopyWords(3, font3Pal, BG_PALETTE_SUB, font3PalLen);
<br/>
   
<br/>
   dmaCopyWords(3, font3Tiles, BG_TILE_RAM(0), font3TilesLen); 
<br/>
   dmaCopyWords(3, font3Tiles, BG_TILE_RAM_SUB(0), font3TilesLen); 
<br/>
} 
<br/>
void PrintMsg() { 
<br/>
<br/>
   int i; 
<br/>
   int j; 
<br/>
    
<br/>
   char* msg[] = { 
<br/>
    "0123456789", 
<br/>
    "ABCDEFGHIJKLMNOPQRSTUVWXYZ", 
<br/>
    "abcdefghijklmnopqrstuvwxyz", 
<br/>
  }; 
<br/>
  /* 
<br/>
  Print to the main screen 
<br/>
  */ 
<br/>
   for(i = 0; i &lt; /*sizeof(msg)*/ 3; ++i) { 
<br/>
      for(j = 0; msg[i][j] != '\0'; ++j) { 
<br/>
          map[j + (i * 32)] = msg[i][j]-' ' ;   //Font starts with a space character 
<br/>
                                               //so we have to subtract the offset 
<br/>
<br/>
      } 
<br/>
   } 
<br/>
  /* 
<br/>
  Print to the sub screen 
<br/>
  */ 
<br/>
   for(i = 0; i &lt; /*sizeof(msg)*/ 3; ++i) { 
<br/>
      for(j = 0; msg[i][j] != '\0'; ++j) { 
<br/>
          sub_map[j + (i * 32)] = msg[i][j]-' ' ;   //Font starts with a space character 
<br/>
                                               //so we have to subtract the offset 
<br/>
<br/>
      } 
<br/>
   } 
<br/>
   swiWaitForVBlank(); 
<br/>
} 
<br/>
int main(void) 
<br/>
{ 
<br/>
   initVideo(); 
<br/>
   initBackgrounds(); 
<br/>
   PrintMsg(); 
<br/>
   return 0; 
<br/>
} </td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#166002 - Doogle - Thu Jan 15, 2009 9:57 pm</h4>
    <div class="postbody"><span class="postbody">Many thanks, your patches have solved the problem. I'm going to have to look at it closely to make sure I understand exactly where I went wrong.
<br/>
<br/>
(You may have gathered that I'm new to this as well as being new to C as a language. (I do have the book though))
<br/>
<br/>
Saying that, it's great fun !! Thanks again.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#166041 - Doogle - Sun Jan 18, 2009 1:19 pm</h4>
    <div class="postbody"><span class="postbody">My latest issue is associated with using the default Keyboard on the bottom screen. After defining the keyboard etc on issuing keyboardInit(kb); the bottom screen displays a series of blue and black 'blobs'. On executing keyboardShow(), bits of the keyboard are displayed.
<br/>
<br/>
I'm guessing that it's something to do with mapping (or merging BGs together). According to the keyboard.h file its default BG is BG3 and the Map offset is 30, whereas I'm using BG2 and a Map offset of 20.
<br/>
Any ideas?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#166045 - dovoto - Sun Jan 18, 2009 6:46 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Doogle wrote:</b></span></td> </tr> <tr> <td class="quote">My latest issue is associated with using the default Keyboard on the bottom screen. After defining the keyboard etc on issuing keyboardInit(kb); the bottom screen displays a series of blue and black 'blobs'. On executing keyboardShow(), bits of the keyboard are displayed.
<br/>
<br/>
I'm guessing that it's something to do with mapping (or merging BGs together). According to the keyboard.h file its default BG is BG3 and the Map offset is 30, whereas I'm using BG2 and a Map offset of 20.
<br/>
Any ideas?</td> </tr></table><span class="postbody">
<br/>
<br/>
The keyboard code in current release has a few issues.  These have been corrected new release is forthcomming<br/>_________________<br/><a href="http://www.drunkencoders.com" target="_blank">www.drunkencoders.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#166057 - Doogle - Mon Jan 19, 2009 6:26 am</h4>
    <div class="postbody"><span class="postbody">Ah, I see. Thanks for the response. I was beginning to wonder if what little I thought I understood was wrong ! Perhaps an opportunity to make my own keyboard then.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
