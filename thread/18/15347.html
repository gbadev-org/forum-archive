<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Finding 8-bit writes in a elf (heh) - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > Finding 8-bit writes in a elf (heh)</h2>
<div id="posts">
<div class="post">
    <h4>#154042 - simonjhall - Wed Apr 09, 2008 11:08 pm</h4>
    <div class="postbody"><span class="postbody">I was gonna stick this in the RAM library thread, but it's pretty fat.
<br/>
Here's my mini-howto to finding where 8-bit writes are in your elf. Requires awk and the ARM binutils. If you don't know what this means then this likely isn't a problem that affects you!
<br/>
<br/>
Ok, here's the cock-eyed solution I've used on the two games I've done now:
<br/>
<br/>
At your command line (I'm a big Cygwin fan btw) type,
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">arm-eabi-objdump -d my_friend_the.elf | grep strb | awk '{print "0x"$1}' &gt; strbs.txt</td> </tr></table><span class="postbody">
<br/>
This will make a file that contains a lot of lines like,
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">...
<br/>
0x2023de8:
<br/>
0x2023dec:
<br/>
0x2023e20:
<br/>
0x2023e38:
<br/>
0x2023e3c:
<br/>
0x2023e64:
<br/>
0x2023ec0:
<br/>
0x2023ec4:
<br/>
0x2023ec8:
<br/>
0x2023ecc:
<br/>
0x2023ed0:
<br/>
0x20247fc:
<br/>
...</td> </tr></table><span class="postbody">
<br/>
Note the annoying colon. I now fire up this file in a text editor and do a find/replace all on ':' and just replace it with a space or some kind of whitespace. Save strbs.txt.
<br/>
(I realise I could replace this step with a bit of fancy awk in the previous command, but I've forgotten 95% of the awk I did in uni...can anyone help me with this?)
<br/>
My file now looks like
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">...
<br/>
0x2023dec
<br/>
0x2023e20 
<br/>
0x2023e38 
<br/>
0x2023e3c 
<br/>
0x2023e64 
<br/>
0x2023ec0 
<br/>
0x2023ec4 
<br/>
0x2023ec8 
<br/>
0x2023ecc 
<br/>
0x2023ed0 
<br/>
0x20247fc 
<br/>
...</td> </tr></table><span class="postbody">
<br/>
Ok, so this gives us a list of the addresses within the program that contain the strb instruction. Not really that useful... So we use an awesome tool named addr2line to sort this out.
<br/>
<br/>
At your command prompt, type:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">awk '{system("arm-eabi-addr2line -e im_in_love_with_an.elf " $1)}' strbs.txt | sort &gt; strbs2.txt</td> </tr></table><span class="postbody">This may take some time - be patient. Once you're done, strbs2.txt may contain such jollies as:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">...
<br/>
c:/devkitPro/dswifi/arm9/source/wifi_arm9.c:645
<br/>
c:/devkitPro/dswifi/arm9/source/wifi_arm9.c:646
<br/>
c:/devkitPro/dswifi/arm9/source/wifi_arm9.c:887
<br/>
c:/devkitPro/dswifi/arm9/source/wifi_arm9.c:892
<br/>
c:/devkitPro/dswifi/arm9/source/wifi_arm9.c:973
<br/>
c:\Documents and Settings\Simon\workspace\debugger_remote/network_trans.c:135
<br/>
c:\Documents and Settings\Simon\workspace\debugger_remote/network_trans.c:195
<br/>
c:\devkitPro\libnds\include/nds/arm9/videoGL.h:1098
<br/>
c:\devkitPro\libnds\include/nds/arm9/videoGL.h:1098
<br/>
c:\devkitPro\libnds\include/nds/arm9/videoGL.h:1098
<br/>
c:\devkitPro\libnds\include/nds/arm9/videoGL.h:1098
<br/>
c:\devkitPro\libnds\include/nds/arm9/videoGL.h:1104
<br/>
...</td> </tr></table><span class="postbody">These are all the locations of the strb instruction within your elf. Go to these locations within your code and assess if it's going to be a problem, and if it is replace it with either a 16-bit read-modify-write or change your data types to be 16-bit or bigger.
<br/>
<br/>
As this isn't the only offending instruction, repeat for instructions such as strbeq and strbgt (or whatever the objdump syntax is) etc etc. You'll also find that gcc will often insert calls to memcpy and memset (it's in the gcc spec - I'll find a link at some point) so make sure you grep for these calls too.
<br/>
<br/>
Going through the list by hand and fixing the code is the best thing I can then think of doing. I'm sure a more automated solution would be better.
<br/>
<br/>
Hope this helps someone.<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#154043 - Dwedit - Wed Apr 09, 2008 11:26 pm</h4>
    <div class="postbody"><span class="postbody">What about the DS Linux C compiler which changes strb into swpb?<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#154046 - silent_code - Wed Apr 09, 2008 11:47 pm</h4>
    <div class="postbody"><span class="postbody">nice post, thanks a lot!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#154047 - nanou - Thu Apr 10, 2008 12:00 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>simonjhall wrote:</b></span></td> </tr> <tr> <td class="quote">Note the annoying colon.</td> </tr></table><span class="postbody">
<br/>
<br/>
| sed s/://
<br/>
<br/>
s/note/excise/ ;)
<br/>
<br/>
Now you can construct it as a single line if you're sufficiently crazy.<br/>_________________<br/>- nanou</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#154052 - TypeError - Thu Apr 10, 2008 2:26 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Dwedit wrote:</b></span></td> </tr> <tr> <td class="quote">What about the DS Linux C compiler which changes strb into swpb?</td> </tr></table><span class="postbody">
<br/>
<br/>
That would be ideal, but somebody needs to port the GCC patches to the devkitPro compiler.  (I'm assuming binaries created by the dslinux compiler can't be run as bare nds files, right?)  It shouldn't be too hard for somebody who knows what they're doing.  (read: not me)
<br/>
<br/>
The patches are here:
<br/>
<a href="http://dslinux.gits.kiev.ua/trunk/toolchain/8bit/" target="_blank">http://dslinux.gits.kiev.ua/trunk/toolchain/8bit/</a>
<br/>
<br/>
I wonder if .o files from the dslinux compiler could be linked using the DKP linker to give us strb-free .nds files...
<br/>
<br/>
Thanks for sharing your procedure Simon!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#154053 - Lazy1 - Thu Apr 10, 2008 2:33 am</h4>
    <div class="postbody"><span class="postbody">I remember asking Wintermute about that a while ago and if I remember correctly it would require quite a few changes to libnds which is why it would never be included with devkitARM.
<br/>
Besides, it's better this way since it would require those wanting to use the external ram to be more cautious and not use it as an excuse not to optimize their memory usage.
<br/>
<br/>
That ram is very slow and should not be treated as a fast(lol) ticket to porting large applications.
<br/>
If you need the extra ram that bad then you'd be willing to do the method posted in this very thread :D
<br/>
<br/>
Thanks for the guide, it will certainly come in handy.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#154054 - TypeError - Thu Apr 10, 2008 2:54 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Lazy1 wrote:</b></span></td> </tr> <tr> <td class="quote">I remember asking Wintermute about that a while ago and if I remember correctly it would require quite a few changes to libnds which is why it would never be included with devkitARM.</td> </tr></table><span class="postbody">
<br/>
<br/>
I'm with you so far.  If the devs say it'll cause too much pain you've gotta respect that, but...
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
Besides, it's better this way since it would require those wanting to use the external ram to be more cautious and not use it as an excuse not to optimize their memory usage.
<br/>
<br/>
That ram is very slow and should not be treated as a fast(lol) ticket to porting large applications.
<br/>
If you need the extra ram that bad then you'd be willing to do the method posted in this very thread :D
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Oh man, I can't say I agree here.  If you need the ram you need the ram.  If there's a tool that can give you the ram, it's fair game.  If there's a tool that can get you running slowly in 20MB and let you whittle your resources down to 4MB from a position of comfort instead of a position of frustration then it's unequivocally a good thing.  If the memory is "too slow" then the performance problems will be motivation enough for you to not use it unless you absolutely need it.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#154055 - Lazy1 - Thu Apr 10, 2008 4:30 am</h4>
    <div class="postbody"><span class="postbody">You may have a point there, but what is stopping people from building libnds on the dslinux toolchain?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#154056 - TypeError - Thu Apr 10, 2008 4:43 am</h4>
    <div class="postbody"><span class="postbody">I don't know.  Is it possible?  I'm assuming the linker will work differently since there's destined to be an OS involved.  It's worth a shot though.
<br/>
<br/>
I'm actually trying to build dkp r21 with the dslinux patch right now.  I think I've almost got it but I'm not quite done yet.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#154062 - simonjhall - Thu Apr 10, 2008 9:30 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>nanou wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>simonjhall wrote:</b></span></td> </tr> <tr> <td class="quote">Note the annoying colon.</td> </tr></table><span class="postbody">
<br/>
<br/>
| sed s/://
<br/>
<br/>
s/note/excise/ ;)
<br/>
<br/>
Now you can construct it as a single line if you're sufficiently crazy.</span></td> </tr></table><span class="postbody">That's mega. I'll update this later to include this. I had forgotten about (or blanked out) sed!<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#154064 - TypeError - Thu Apr 10, 2008 10:12 am</h4>
    <div class="postbody"><span class="postbody">Bah, stupid newlib won't build with or without the patch.  I've been trying on OS X but maybe I'll switch to my linux machine to see if it'll work there.
<br/>
<br/>
Ok, it's a known bug:
<br/>
<a href="http://forums.devkitpro.org/viewtopic.php?f=15&amp;t=44" target="_blank">http://forums.devkitpro.org/viewtopic.php?f=15&amp;t=44</a>
<br/>
<br/>
Well if anybody wants to try my modified version of the dslinux patch it's here:
<br/>
<a href="http://pastebin.org/28711" target="_blank">http://pastebin.org/28711</a>
<br/>
<br/>
Apply it *after* buildscripts-20080308 patches gcc.  Note that you have to build newlib with make 3.80, not 3.81.  I don't know about the libnds problem people mention in the thread above, but this should be a good start.  
<br/>
<br/>
Grr.  Now it's failing to build g++, not that I care much.  Well, that's it for now.  Must.  Sleep.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#154065 - simonjhall - Thu Apr 10, 2008 10:52 am</h4>
    <div class="postbody"><span class="postbody">Sleep?! It's nearly 11am! Some of us were out of bed at 7am!<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#154092 - TypeError - Thu Apr 10, 2008 11:13 pm</h4>
    <div class="postbody"><span class="postbody">Well, so far so good.  I managed to build a DKP version of gcc with the -mswp-byte-writes option and used it to compile libnds and libfat.  I tried compiling a simple test program and here's what I see:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
Normal compile:
<br/>
[n8gray@golux]% arm-eabi-objdump -d arm9/printf.arm9.elf| grep strb | wc -l
<br/>
     156
<br/>
[n8gray@golux]% arm-eabi-objdump -d arm9/printf.arm9.elf| grep swpb | wc -l
<br/>
      33
<br/>
<br/>
Compile with -mswp-byte-writes:
<br/>
[n8gray@golux]% arm-eabi-objdump -d arm9/printf.arm9.elf| grep strb | wc -l
<br/>
       2
<br/>
[n8gray@golux]% arm-eabi-objdump -d arm9/printf.arm9.elf| grep swpb | wc -l
<br/>
     170
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
The two remaining strb's are in crtstuff.c, part of gcc.  I think they're related to initializers and finalizers, so I don't think they'll cause problems.  The test program runs properly in DeSmuME, but it's *really* simple.  I need to try it on something more complex.
<br/>
<br/>
One thing to mention: this option only works with arm code, not thumb code.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#154100 - tepples - Fri Apr 11, 2008 12:38 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>TypeError wrote:</b></span></td> </tr> <tr> <td class="quote">If there's a tool that can get you running slowly in 20MB and let you whittle your resources down to 4MB from a position of comfort instead of a position of frustration then it's unequivocally a good thing.</td> </tr></table><span class="postbody">
<br/>
There is such a tool, and it is called "porting to the PC".<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
