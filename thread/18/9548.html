<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>mode 5 sprites odd - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > mode 5 sprites odd</h2>
<div id="posts">
<div class="post">
    <h4>#82989 - silent_code - Thu May 11, 2006 6:47 pm</h4>
    <div class="postbody"><span class="postbody">hi!
<br/>
<br/>
i hope someone can help me with a sprites issue. as the subject says i use mode 5 8bit rotation sprites. but somehow they shear oddly. anyone had the same problem and solved it?
<br/>
<br/>
it's strange cuz it doesn't happen to all sprites... looks like something overwrites certain bits or whatever. the rotation attribute in the following pic should be 0!?
<br/>
<br/>
<a href="http://home.pages.at/dunkelkinder/oddsprite.jpg">[Images not permitted - Click here to view it]</a>
<br/>
<br/>
i will post some sources as necessary.
<br/>
<br/>
maybe i screw up the values while writing them in? my sprites have floats for coordinates (i know that floats suck and i'll change that as soon as i have fixed a few other things). when updating oam i do it like (just and example)
<br/>
<br/>
...
<br/>
x = (int16)((int)(player.x - 29.0f));
<br/>
...
<br/>
spriteEntry-&gt;attribute[1] &amp;= 0xFE00;
<br/>
spriteEntry-&gt;attribute[1] |= (x &amp; 0x01FF);
<br/>
...
<br/>
<br/>
for each coordinate, where player is a float and x an int16... casting is sh*t, i know, but it's just a first implementation. ;) the double int casting is the result of trieing ANYTHING the syntax won't forbid to use...
<br/>
<br/>
please don't tell me to read up on sprites, cuz i have done that already, but if you have some good resource (that isn't already like ten times on the forum) it was nice of you to post it.
<br/>
<br/>
thanks in advance!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#84591 - silent_code - Tue May 23, 2006 3:16 pm</h4>
    <div class="postbody"><span class="postbody">not rotating the sprites helps... but as soon as a sprite is rotated (let's say by 0/512 as u16) it starts looking odd again...
<br/>
<br/>
seems like i've to solve it myself :(</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#84821 - tepples - Wed May 24, 2006 10:20 pm</h4>
    <div class="postbody"><span class="postbody">Have you managed to get similar code working on Game Boy Advance?<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#85077 - silent_code - Fri May 26, 2006 10:28 pm</h4>
    <div class="postbody"><span class="postbody">nope, in my gba days i used not to work with hardware rotation (i made some demos with out rotation at all or isometric demos, where the rotation had to be prebacked in the sprites).
<br/>
<br/>
i'm using the standard functions found everywhere... i don't know what's wrong... i use the sprite entry and sprite rotation structures provided by libnds. then i assign a sprite rotation index to my sprites (there are only 32 of them distributed over all 128 sprite entries, right?) and rotate them... maybe some sources will make it clear:
<br/>
<br/>
the entity class:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">class ent
<br/>
{
<br/>
public:
<br/>
   float x, y, vx, vy;
<br/>
<br/>
   u16 r;              // rotation
<br/>
<br/>
        ... some other attributes of int and float (health etc.)...
<br/>
<br/>
   SpriteEntry* m_oam;
<br/>
   u16 m_gfxID;      // graphics id (location of the first tile of the sprites gfx)
<br/>
<br/>
   void create(SpriteEntry* oam, u16 gfxID);
<br/>
<br/>
        ... some other methods...
<br/>
};
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
the create method:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void ent::create(SpriteEntry* oam, u16 gfxID)
<br/>
{
<br/>
   if(oam != NULL)
<br/>
   {
<br/>
      m_oam = oam;
<br/>
      m_gfxID = gfxID;
<br/>
<br/>
      m_oam-&gt;attribute[0] = ATTR0_COLOR_256 | ATTR0_ROTSCALE_DOUBLE | 256;
<br/>
      m_oam-&gt;attribute[1] = ATTR1_ROTDATA(0) | ATTR1_SIZE_32 | 84;
<br/>
      m_oam-&gt;attribute[2] = ATTR2_PRIORITY(1) | m_gfxID;
<br/>
<br/>
      rotateSprite((SpriteRotation*)m_oam, 0);  // &lt;- will cause sprite to look odd
<br/>
      setSpritePriority(m_oam, 1);  // won't do a thing, as well as ATTR2_PRIORITY(1) [s. a.] ????!!!!
<br/>
   }
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
yes, i'm still using floats (shame on me), but it's running and as long as i can't get rid (and understand it) of that odd behaviour, i don't see why i should change it ;)
<br/>
<br/>
i mean everything has a type, i cast where necessary, so there shouldn't be any problem... man, that sucks.
<br/>
<br/>
another example:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">SpriteEntry *sgShot;
<br/>
<br/>
...
<br/>
<br/>
sgShot = &amp;spritesMain[1];
<br/>
<br/>
sgShot-&gt;attribute[0] = ATTR0_COLOR_256 | ATTR0_ROTSCALE_DOUBLE | 91;
<br/>
sgShot-&gt;attribute[1] = ATTR1_ROTDATA(1) | ATTR1_SIZE_8 | 256;
<br/>
sgShot-&gt;attribute[2] = 128;
<br/>
<br/>
rotateSprite((SpriteRotation*)sgShot, 0);  // same goes for this
<br/>
setSpritePriority(sgShot, 0);  // and this!
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
the sprite rotation procedure:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void rotateSprite(SpriteRotation *spriteRotation, u16 angle)
<br/>
{
<br/>
   s16 s = -SIN[angle &amp; 0x1FF] &gt;&gt; 4;
<br/>
   s16 c = COS[angle &amp; 0x1FF] &gt;&gt; 4;
<br/>
<br/>
   spriteRotation-&gt;hdx = c;
<br/>
   spriteRotation-&gt;hdy = -s;
<br/>
   spriteRotation-&gt;vdx = s;
<br/>
   spriteRotation-&gt;vdy = c;
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
it makes  me crazy!!!
<br/>
<br/>
thanks for any help or tips (hell, even random suggestions are welcome)!
<br/>
<br/>
Rob
<br/>
<br/>
<br/>
ps: i just found a nice statement on mega etk's site: "-Added some frames to weapons to avoid rotation code" that's kinda ironic, isn't it? I NEED hardware rotation though... (i don't know why he wants to avoid it, though)</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
