<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Card communication, uninitialized state. - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>DS development > Card communication, uninitialized state.</h2>
<div id="posts">
<div class="post">
    <h4>#161274 - thoduv - Thu Jul 31, 2008 5:49 pm</h4>
    <div class="postbody"><span class="postbody">Hi!
<br/>
<br/>
I would like to boot DS card, but in order to do so, I have to load/decrypt the secure area.
<br/>
I grabed code from ndstool in order to encrypt KEY1 commands, but have troubles when the card is in "KEY1" mode.
<br/>
<br/>
Here's what I do:
<br/>
 - dummy command (0x9f...)
<br/>
 - read header
<br/>
 - read ID (first): getting ID: 80 3F 00 80, which is correct.
<br/>
 - switch into KEY1 mode, and init ndstool encrypter that way:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">   init1(gamecode);
<br/>
   arg2[1] &lt;&lt;= 1;
<br/>
   arg2[2] &gt;&gt;= 1;   
<br/>
   init2(card_hash, arg2);
<br/>
</td> </tr></table><span class="postbody">
<br/>
(all these functions are in encryption.cpp from ndstool source)
<br/>
All my following command are then KEY1-encrypted with "encrypt" function from ndstool code.
<br/>
<br/>
- then, I switch KEY2 on (command 0x4) with all random parameters set to 0 (easier). I set up seed registers, and then "commit" seed changes with bit15 of CARD_CR2.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">   
<br/>
// informations taken from gbatek here...
<br/>
u64 seed0 = (0 &lt;&lt; 15) + 0x6000 + (card_header-&gt;encryption_seed &amp; 7);
<br/>
   u64 seed1 = 0x5C879B9B05LL;
<br/>
   CARD_1B0 = (u32)(seed0 &amp; 0xFFFFFFFF);
<br/>
   CARD_1B4 = (u32)(seed1 &amp; 0xFFFFFFFF);
<br/>
   CARD_1B8 = (u16)(seed0 &gt;&gt; 32);
<br/>
   CARD_1BA = (u16)(seed1 &gt;&gt; 32);
<br/>
</td> </tr></table><span class="postbody">
<br/>
- finally, i try to read card ID again (2nd Get ROM Chip ID, command 0x1...), and then, I only get FF FF FF FF (no matter how much data I ask in CARD_CR2: i only get more FF's).
<br/>
<br/>
Is ndstool code unusable for KEY1 (Gbatek states that KEY1 encryption is the same as secure area decryption, so it should be OK) ? Is my initialisation of KEY2 wrong ? Any other ideas ?
<br/>
<br/>
Thanks !</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161443 - jrobot - Sun Aug 03, 2008 11:21 pm</h4>
    <div class="postbody"><span class="postbody">ooh are you working on a slot-1 cart??</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
