<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Colors! IO crashes/corruption - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>DS development > Colors! IO crashes/corruption</h2>
<div id="posts">
<div class="post">
    <h4>#136355 - Jesse - Tue Jul 31, 2007 9:09 pm</h4>
    <div class="postbody"><span class="postbody">I've been struggling to make my drawing-app <a class="postlink" href="http://www.collectingsmiles.com/colors" target="_blank">Colors!</a> compatible with a bunch of different flash-cards. It seems as saving images to flash crashes or gets corrupted on some cards. Finally, I got hold of a G6 Real 1GB card today that seems to have this problem and manage to narrow down the problem. 
<br/>
<br/>
Not surprisingly it seems like a fwrite() call in libpng locks up for some reason. While it works flawlessly on my M3 simply, it seems like the G6 can't handle the io calls or something. I would guess it is a DLDI problem, but I can't be sure. I also managed to crash through stress-testing with fwrites() using different size and memory alignments, but I didn't mange to narrow that down into a standalone version. 
<br/>
<br/>
I need help in solving this. I have built a small stripped-down project where this occurs and hope someone has any idea. Also, if someone with SuperCard Lite and SuperCard 2GB could test if the test-app goes through I would be happy, since there seems to be a problem with them as well. The archive contains the source as a compiled version. I'm really getting frustrated with this, so if anyone has any ideas, let me know.
<br/>
<br/>
<a class="postlink" href="http://www.collectingsmiles.com/colors/pngtest.rar" target="_blank">http://www.collectingsmiles.com/colors/pngtest.rar</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#136364 - masscat - Tue Jul 31, 2007 10:07 pm</h4>
    <div class="postbody"><span class="postbody">I cannot help with solving the problem but a possible work around could be avoiding the fwrite in libpng by buffering the libpng output in memory and then writing to the file with a single fwrite call. If the NDS libpng port is the same as the desktop you will be able to set the libpng write function with png_set_write_fn (see <a class="postlink" href="http://www.libpng.org/pub/png/libpng-1.2.5-manual.html#section-5.1" target="_blank">here</a> for more info).</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#136367 - Lazy1 - Tue Jul 31, 2007 11:09 pm</h4>
    <div class="postbody"><span class="postbody">Your problem may be the same that my port of Wolfenstein has with certain flash carts.
<br/>
If the cart's DLDI driver does not support unaligned reads/writes you could get corruption, try running the DLDI tester on the G6 and see what it says.
<br/>
<br/>
<a href="http://dldi.drunkencoders.com/index.php?title=Testing_instructions" target="_blank">http://dldi.drunkencoders.com/index.php?title=Testing_instructions</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#136371 - dy - Tue Jul 31, 2007 11:53 pm</h4>
    <div class="postbody"><span class="postbody">i patched it with SuperCardLite dldi and this is what came up on the screen
<br/>
<br/>
writing test.png
<br/>
8 bytes (at 0xb003c28) - ok
<br/>
4 bytes (at 0xb003bcc) - ok
<br/>
4 bytes (at 0x2034ce2) - ok
<br/>
13 bytes (at 0xb003c0b) - ok
<br/>
4 bytes (at 0xb003bcc) - ok
<br/>
4 bytes (at 0xb003bdc) - ok
<br/>
4 bytes (at 0x2034ce7) - ok
<br/>
8192 bytes (at 0x2083558) - ok
<br/>
<br/>
without it patched though it shows an error thingy.....
<br/>
<br/>
so does all the ok mean its fixed? ill be cheking back in about 10hrs so if there is anything new i can test it immediately</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#136385 - jetboy - Wed Aug 01, 2007 7:41 am</h4>
    <div class="postbody"><span class="postbody">Tested on Super Card DS ONE
<br/>
<br/>
All png tester tests were ok on my 2MB card.
<br/>
All png tester tests were ok on my 1MB card.
<br/>
<br/>
Tests with dldi_tester:
<br/>
1MB card: Cant handle unaligned reads
<br/>
2MB card: Cant handle unaligned reads
<br/>
<br/>
I presume if it cannot handle unaligned reads, it cannot handle unaligned writes too.<br/>_________________<br/>Colors! gallery -&gt; <a href="http://colors.collectingsmiles.com" target="_blank">http://colors.collectingsmiles.com</a>
<br/>
Any questions? Try <a href="http://colors.collectingsmiles.com/faq.php" target="_blank">http://colors.collectingsmiles.com/faq.php</a> first, or official forums <a href="http://forum.brombra.net" target="_blank">http://forum.brombra.net</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#136392 - Jesse - Wed Aug 01, 2007 10:28 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Lazy1 wrote:</b></span></td> </tr> <tr> <td class="quote">If the cart's DLDI driver does not support unaligned reads/writes you could get corruption, try running the DLDI tester on the G6 and see what it says.</td> </tr></table><span class="postbody">
<br/>
Thanks for the tip. I tried doing that, and the testprogram crashes when it gets to Unanligned write...
<br/>
<br/>
Ok. That means there's not much I can do about this and it seems like both G6 and SuperCard DLDI drivers needs to be updated.
<br/>
<br/>
Thanks all!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#136393 - Jesse - Wed Aug 01, 2007 10:33 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>masscat wrote:</b></span></td> </tr> <tr> <td class="quote">I cannot help with solving the problem but a possible work around could be avoiding the fwrite in libpng by buffering the libpng output in memory and then writing to the file with a single fwrite call.</td> </tr></table><span class="postbody">
<br/>
Yes, now that I know that unaligned writes are the problem I could probably do that. I don't have the 512kb of memory required to do a full buffer, but with some fancy coding I could stream it through a 16k buffer or something.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#136398 - kusma - Wed Aug 01, 2007 11:11 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Jesse wrote:</b></span></td> </tr> <tr> <td class="quote">Yes, now that I know that unaligned writes are the problem I could probably do that.</td> </tr></table><span class="postbody">
<br/>
Wouldn't it be better to fix the DLDIs?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#136406 - tepples - Wed Aug 01, 2007 12:53 pm</h4>
    <div class="postbody"><span class="postbody">How would one go about fixing the DLDIs if the source code is not available?<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#136409 - kusma - Wed Aug 01, 2007 1:16 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tepples wrote:</b></span></td> </tr> <tr> <td class="quote">How would one go about fixing the DLDIs if the source code is not available?</td> </tr></table><span class="postbody">
<br/>
Good point. However, I do believe that reverse-engineering the binary-only DLDIs and patching them would be more future proof.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#136410 - Jesse - Wed Aug 01, 2007 1:27 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>kusma wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Jesse wrote:</b></span></td> </tr> <tr> <td class="quote">Yes, now that I know that unaligned writes are the problem I could probably do that.</td> </tr></table><span class="postbody">
<br/>
Wouldn't it be better to fix the DLDIs?</span></td> </tr></table><span class="postbody">
<br/>
Yes, of course. But I wouldn't know how and I'm starting to receive hate-mail. ;)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#136414 - Lazy1 - Wed Aug 01, 2007 2:24 pm</h4>
    <div class="postbody"><span class="postbody">People send hate mail because something that is free doesn't work properly on their crappy hardware?
<br/>
I wouldn't hack a workaround either, all that does is let companies get away with writing buggy drivers rather than force the issue.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#136419 - Jesse - Wed Aug 01, 2007 3:39 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Lazy1 wrote:</b></span></td> </tr> <tr> <td class="quote">People send hate mail because something that is free doesn't work properly on their crappy hardware?</td> </tr></table><span class="postbody">
<br/>
Nah. That was just a joke. People are very nice and helpful, just like here.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
