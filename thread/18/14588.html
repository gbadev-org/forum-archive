<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>ITCM, and code meant to go there that is too big - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > ITCM, and code meant to go there that is too big</h2>
<div id="posts">
<div class="post">
    <h4>#146021 - DiscoStew - Tue Nov 27, 2007 8:27 pm</h4>
    <div class="postbody"><span class="postbody">Looking over my projects, I've wondered how I could gain some more speed from them, and for some reason, I ended up looking into the build folder, and found out something really odd. It appeared that the object file that contained all the code I wanted in ITCM was, to my surprise, almost 64KB big. Considering that the code portion of ITCM could only hold 32KB, this lead me to removes all traces that put code from this file into ITCM, and it seemed it made not one single difference in how my program ran (program-wise and speed-wise). It felt like this whole time, I've been running this code in main RAM.
<br/>
<br/>
A silly question, but because of this, am I to assume that if code is too large to fit in ITCM, it will just not put it there (even a portion of the code), and put it in main RAM? I really hope so, because that means that I can adjust this section of my code so everything that definitely needs to be there can be there, and everything else can be moved off to main RAM.<br/>_________________<br/><span style="font-weight: bold">DS</span> - It's all about <span style="font-weight: bold">D</span>isco<span style="font-weight: bold">S</span>tew</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146023 - tepples - Tue Nov 27, 2007 8:33 pm</h4>
    <div class="postbody"><span class="postbody">You could always run arm-eabi-nm on your arm[#].elf to see whether a function is being put in ITCM or in EWRAM.
<br/>
<br/>
EDIT: generalized<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"><br/><br/>Last edited by tepples on Tue Nov 27, 2007 10:46 pm; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#146038 - DiscoStew - Tue Nov 27, 2007 10:45 pm</h4>
    <div class="postbody"><span class="postbody">It's actually part of my arm9 code, but that shouldn't make a difference. I'll look into it when I get the chance today. thx.<br/>_________________<br/><span style="font-weight: bold">DS</span> - It's all about <span style="font-weight: bold">D</span>isco<span style="font-weight: bold">S</span>tew</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146047 - ingramb - Wed Nov 28, 2007 12:05 am</h4>
    <div class="postbody"><span class="postbody">I've seen the linker error when I have too much code in ITCM.  It has never just silently moved code from ITCM to ram for me.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146055 - chishm - Wed Nov 28, 2007 2:29 am</h4>
    <div class="postbody"><span class="postbody">Object files are always bigger than the code they contain, due to link symbols and the like. If the code in your main loop is small enough, it will all fit into the instruction cache, which gives the same speed as ITCM. Alternatively, if you're doing many memory accesses over a large address range and not much processing, then data access time may be the limiting factor for the execution speed.<br/>_________________<br/><a class="postlink" href="http://chishm.drunkencoders.com" target="_blank">http://chishm.drunkencoders.com</a>
<br/>
<a class="postlink" href="http://dldi.drunkencoders.com" target="_blank">http://dldi.drunkencoders.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146162 - DiscoStew - Thu Nov 29, 2007 9:52 pm</h4>
    <div class="postbody"><span class="postbody">Well drat! After checking with tepples suggestion, it turns out that it does fit into ITCM as it only takes up about 8.5KB of space, and if I'm correct, even if I don't set it specifically into ITCM, it will get cached, and run just as fast, which is why I didn't see any change when removing it out of ITCM. But, isn't the instruction cache only about 8KB big? How would my function fit into there if it is 1/2 a KB bigger?
<br/>
<br/>
Anyways there is a lot of accessing of the main RAM in my code, and although I've tried putting information into it as sequentially as possible, it still seems a little slow. Considering there is the cache for both instruction and data (8KB and 4KB), maybe I can put the data cache to some use, unless it is already in use. I just am not sure how to do it.<br/>_________________<br/><span style="font-weight: bold">DS</span> - It's all about <span style="font-weight: bold">D</span>isco<span style="font-weight: bold">S</span>tew</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146174 - simonjhall - Fri Nov 30, 2007 1:05 am</h4>
    <div class="postbody"><span class="postbody">I think the advantage to ITCM was from the gba days, where there was a lack of cache. Having this should make a big difference when you lack cache, but will likely not be too noticeable if it is present. So I don't there's a mecha streisand benefit for the DS.
<br/>
<br/>
However,
<br/>
- the instruction cache is small, and by using ITCM you can be sure that there's no wait whilst it "loads it into the cache" since it's already in the fast memory
<br/>
- it won't pollute the real caches (right?) so you effectively get more cache
<br/>
- it's 32kb extra free RAM, which can always be handy<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146175 - tepples - Fri Nov 30, 2007 2:27 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>simonjhall wrote:</b></span></td> </tr> <tr> <td class="quote">Having [a block of guaranteed fast instruction memory] should make a big difference when you lack cache, but will likely not be too noticeable if it is present. So I don't there's a mecha streisand benefit for the DS.</td> </tr></table><span class="postbody">
<br/>
Good point. So are you <a class="postlink" href="http://en.wikipedia.org/wiki/Mecha-Streisand" target="_blank">Robert Smith</a>, or <a class="postlink" href="http://www.google.com/search?q=coldplay+clocks+lyrics" target="_blank">are you part of the disease</a>?
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">However,
<br/>
- the instruction cache is small, and by using ITCM you can be sure that there's no wait whilst it "loads it into the cache" since it's already in the fast memory</td> </tr></table><span class="postbody">
<br/>
Are you talking about compulsory misses (first load which takes less than a frame) or capacity misses (subroutine gets evicted by another subroutine)?
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">- it won't pollute the real caches (right?) so you effectively get more cache</td> </tr></table><span class="postbody">
<br/>
Has anyone done benchmarks to verify this?<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146179 - chishm - Fri Nov 30, 2007 2:44 am</h4>
    <div class="postbody"><span class="postbody">The cache is set not to do anything for code/data in either DTCM or ITCM. This is all set up for you by the crt0.<br/>_________________<br/><a class="postlink" href="http://chishm.drunkencoders.com" target="_blank">http://chishm.drunkencoders.com</a>
<br/>
<a class="postlink" href="http://dldi.drunkencoders.com" target="_blank">http://dldi.drunkencoders.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146197 - simonjhall - Fri Nov 30, 2007 10:52 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tepples wrote:</b></span></td> </tr> <tr> <td class="quote">Good point. So are you <a class="postlink" href="http://en.wikipedia.org/wiki/Mecha-Streisand" target="_blank">Robert Smith</a>, or <a class="postlink" href="http://www.google.com/search?q=coldplay+clocks+lyrics" target="_blank">are you part of the disease</a>?</td> </tr></table><span class="postbody">Robert Smith walked right past me at work once! My boss was bouncing around in his chair asking me "did you see him? That was ROBERT SMITH!" Who?
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Are you talking about compulsory misses (first load which takes less than a frame) or capacity misses (subroutine gets evicted by another subroutine)?</td> </tr></table><span class="postbody">Both...
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Has anyone done benchmarks to verify this?</td> </tr></table><span class="postbody">I did some dozy tests to see how much better code runs from ITCM, but the performance of the code was quite dependent on the locality of the data so there wasn't a huge difference. However I've done a load of cycle timings on all the different types of RAM and the speed of DTCM-style memory is comparable to that of cached main memory, just without the start up cost.<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146198 - masscat - Fri Nov 30, 2007 11:09 am</h4>
    <div class="postbody"><span class="postbody">To get the best performance from the ITCM you have to take care with code that you put in it. Quoting the ARM946S-E tech ref:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">5.5.2 Data accesses to Instruction TCM
<br/>
Data accesses to the Instruction TCM can either be reads or writes.
<br/>
Data access to the Instruction TCM can introduce stall cycles to the ARM946E-S
<br/>
processor.
<br/>
<br/>
5.5.3 Stall cycles for Instruction TCM accesses
<br/>
Simultaneous instruction fetch and data reads of the Instruction TCM incur a single stall
<br/>
cycle. This is because the Instruction TCM is a single port memory, which can only
<br/>
return a single word of memory per clock cycle. This is shown in Figure 5-3 on
<br/>
page 5-10.
<br/>
</td> </tr></table><span class="postbody">
<br/>
GCC can generate ldr instructions that load data from within the machine code. It does this to load a register with some immediate value, for example the base address for further memory accesses or some mask/comparison value.
<br/>
<br/>
The size of the code does not indicate how much performance gain it will get by the presence of a cache. It is the structure of/path through the code that matters.
<br/>
For example a loop (less than the size of the cache) that is taken a number of times will benefit from a cache as it willl be loaded into the cache on the first iteration and then happily sit in the cache for each subsequent iteration.
<br/>
<br/>
Generally, if you want something to run faster always start at the larger scale and make sure you are doing things as efficiently as you know how. Poking around with the ITCM and cache may give benefits but requires that you know the path through your code at the machine code level and the operation of the target CPU.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
