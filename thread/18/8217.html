<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Makefile Question - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > Makefile Question</h2>
<div id="posts">
<div class="post">
    <h4>#67977 - Rinky - Sat Jan 21, 2006 9:20 pm</h4>
    <div class="postbody"><span class="postbody">I have to say that despite having been programming since I was a very young kid (on all manner of systems) makefiles always give me grief.
<br/>
<br/>
I'm stuck. I tend to use the DS makefile examples from DoubleC 
<br/>
<br/>
For example:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
# Makefile for demo1.nds
<br/>
# DoubleC [Removed the email address for posting]
<br/>
NDSLIB_INCLUDE=$(DEVKITPRO)/libnds/include
<br/>
NDSLIB_LIB=$(DEVKITPRO)/libnds/lib
<br/>
<br/>
all: demo1.nds.gba
<br/>
<br/>
arm7_main.o: arm7_main.cpp
<br/>
   arm-elf-g++ -g -Wall -O2 -mcpu=arm7tdmi -mtune=arm7tdmi -fomit-frame-pointer -ffast-math -mthumb-interwork -I$(NDSLIB_INCLUDE) -DARM7 -c arm7_main.cpp -oarm7_main.o
<br/>
<br/>
arm7.elf: arm7_main.o
<br/>
   arm-elf-g++ -g -mthumb-interwork -mno-fpu -specs=ds_arm7.specs arm7_main.o -L$(NDSLIB_LIB) -lnds7 -oarm7.elf
<br/>
<br/>
arm7.bin: arm7.elf
<br/>
   arm-elf-objcopy -O binary arm7.elf arm7.bin
<br/>
<br/>
arm9_main.o: arm9_main.cpp
<br/>
   arm-elf-g++ -g -Wall -O2 -mcpu=arm9tdmi -mtune=arm9tdmi -fomit-frame-pointer -ffast-math -mthumb-interwork -I$(NDSLIB_INCLUDE) -DARM9 -c arm9_main.cpp -oarm9_main.o
<br/>
<br/>
arm9.elf: arm9_main.o
<br/>
   arm-elf-g++ -g -mthumb-interwork -mno-fpu -specs=ds_arm9.specs arm9_main.o -L$(NDSLIB_LIB) -lnds9 -o arm9.elf
<br/>
<br/>
arm9.bin: arm9.elf
<br/>
   arm-elf-objcopy -O binary arm9.elf arm9.bin
<br/>
<br/>
demo1.nds: arm7.bin arm9.bin 
<br/>
   ndstool -c demo1.nds -9 arm9.bin -7 arm7.bin
<br/>
<br/>
demo1.nds.gba: demo1.nds
<br/>
   dsbuild demo1.nds -o demo1.nds.gba
<br/>
<br/>
clean:
<br/>
   rm -f *.bin
<br/>
   rm -f *.elf
<br/>
   rm -f *.o
<br/>
   rm -f *~
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
(and expand on them as needed) but I can't figure out how to link in an assembly .s file. 
<br/>
<br/>
One of my test ARM9 programs declares an extern reference to a bunch of assembly in a .s file. But the compiler (understandably) says it can't find the code.
<br/>
<br/>
Would anyone mind putting me out of my misery? :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#67989 - DekuTree64 - Sat Jan 21, 2006 10:26 pm</h4>
    <div class="postbody"><span class="postbody">Sounds like your makefile is fine. I think the problem is that the .cpp file is expecting all the symbol names to be mangled, but .s files output symbols as-is (C-style).
<br/>
<br/>
Try declaring the functions as extern "C" in the .cpp file, like
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">extern "C" int Function(int arg);</td> </tr></table><span class="postbody">
<br/>
Or for a whole bunch of them, and to make it compile in both .c and .cpp files, you can do like
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#ifdef __cplusplus
<br/>
extern "C" {
<br/>
#endif
<br/>
<br/>
extern int Function1(int arg);
<br/>
extern int Function2(int arg);
<br/>
extern int Function3(int arg);
<br/>
<br/>
#ifdef __cplusplus
<br/>
}
<br/>
#endif</td> </tr></table><span class="postbody">
<br/>
__cplusplus is defined automagically by the compiler when building .cpp files. The second method is better to use in headers so you can mix C and C++ if you feel like it. I usually only use the first style if I'm externing one or two functions in a single .cpp file.<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
