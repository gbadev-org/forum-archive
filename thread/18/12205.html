<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>How are multiple backgrounds done? - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>DS development > How are multiple backgrounds done?</h2>
<div id="posts">
<div class="post">
    <h4>#115849 - philip - Fri Jan 19, 2007 4:23 pm</h4>
    <div class="postbody"><span class="postbody">I want to have two 16 bit backgrounds on my main screen. I've been looking at the tutorial at: <a href="http://www.double.co.nz/nintendo_ds/nds_develop10.html" target="_blank">http://www.double.co.nz/nintendo_ds/nds_develop10.html</a>
<br/>
<br/>
That example only covers one background, so I guess I can create two doing the following:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
videoSetMode(MODE_5_2D | DISPLAY_BG2_ACTIVE | DISPLAY_BG3_ACTIVE);
<br/>
vramSetBankA(VRAM_A_MAIN_BG_0x6000000);
<br/>
BG2_CR = BG_BMP16_256x256;
<br/>
BG3_CR = BG_BMP16_256x256;
<br/>
</td> </tr></table><span class="postbody">
<br/>
I would then set registers for scaling etc.
<br/>
<br/>
Except that there won't be enough memory to do two 16 bit backgrounds, so how do I allocate a second VRAM bank?
<br/>
<br/>
Also, what memory do I write to in order to draw to BG3? The example only writes to BG2 using the BG_GFX define.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#115851 - Lick - Fri Jan 19, 2007 4:55 pm</h4>
    <div class="postbody"><span class="postbody">There are 5 questions you need to ask when using backgrounds:
<br/>
<br/>
<span style="font-weight: bold">1) Have you assigned enough videomemory with the memorybanks?</span>
<br/>
- Visit Dev-Scene.com for the <a class="postlink" href="http://dev-scene.com/NDS/DOCgraphicmodes#VRAM" target="_blank">VRAM tables</a> and see if the memory is enough to hold your <a class="postlink" href="http://dev-scene.com/NDS/DOCgraphicmodes#Background_Types" target="_blank">Background Types</a> (check the table for memory usage of each type).
<br/>
Use vramSetBankA/B/C/D/E/F/G/H/I to assign the videomemory. Check out the VRAM table for parameters for each of those functions. Example:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">vramSetBankB(VRAM_B_MAIN_BG_0x6020000);</td> </tr></table><span class="postbody">
<br/>
<br/>
<span style="font-weight: bold">2) Did you set the right blockbase for the background-controlregister?</span>
<br/>
- Visit Dev-Scene.com for the <a class="postlink" href="http://dev-scene.com/NDS/DOCgraphicmodes#Parameters_For_The_CR" target="_blank">parameters for the background-controlregisters</a>. 
<br/>
If you're using multiple backgrounds, you need to use BG_TILE_BASE and BG_MAP_BASE (tiled backgrounds) or BG_BMP_BASE (bitmap backgrounds), to specify the offset in the BG_GFX. The offset is calculated in blocks. For example, the BG_GFX starts at 0x06000000, and you want a bitmap background that starts at 0x06000000 + offset, then you must specify that by using BGx_CR = ... | BG_BMP_BASE(block). block depends on the offset. Read more about blocks.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">BG0_CR =  BG_BMP16_128x128 | BG_BMP_BASE(0) | BG_PRIORITY(0);
<br/>
BG1_CR =  BG_BMP16_128x128 | BG_BMP_BASE(16) | BG_PRIORITY(1);</td> </tr></table><span class="postbody">
<br/>
<br/>
<span style="font-weight: bold">3) Did you write your data to the correct offset?</span>
<br/>
- Like I just said, the blockbase and offset have to point to the same location. If you set the block like BG_BMP_BASE(n), you can use BG_BMP_RAM(n) to get a pointer to the correct location. So write your data to BG_BMP_RAM(n), BG_TILE_RAM(n), BG_MAP_RAM(n).
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">memcpy(BG_BMP_RAM(0), data_bin, data_bin_size);
<br/>
memcpy(BG_BMP_RAM(16), data2_bin, data2_bin_size);</td> </tr></table><span class="postbody">
<br/>
<br/>
<span style="font-weight: bold">4) Are the priorities set?</span>
<br/>
- If you enabled more than 1 background, then you have to worry about the priority (order) of the background.
<br/>
Use BG_PRIORITY(n) to set a value of 0, 1, 2 or 3. Note that a priority of 0 (highest) will be drawn over a priority of 3 (lowest).
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">BG0_CR =  BG_BMP16_128x128 | BG_BMP_BASE(0) | BG_PRIORITY(0);
<br/>
BG1_CR =  BG_BMP16_128x128 | BG_BMP_BASE(16) | BG_PRIORITY(1);</td> </tr></table><span class="postbody">
<br/>
<br/>
<span style="font-weight: bold">5) If you're using an <span style="font-style: italic">Extended Rotation BG</span>, don't forget to set transform variables!</span>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">// Transforming the BG: default
<br/>
BG3_XDX = (1&lt;&lt;8);   // fixed point 8.8
<br/>
BG3_XDY = 0;
<br/>
BG3_YDX = 0;
<br/>
BG3_YDY = (1&lt;&lt;8);   // fixed point 8.8
<br/>
<br/>
// Positioning the BG: default
<br/>
BG3_CX = 0;         // negative value = positive offset
<br/>
BG3_CY = 0;         // so x(-10) will move it pixelx(10)</td> </tr></table><span class="postbody">
<br/>
<br/>
[edit] Re-reading my own post, I found out that I suck at explaining! XD<br/>_________________<br/><a class="postlink" href="http://licklick.wordpress.com" target="_blank">http://licklick.wordpress.com</a></span><span class="gensmall"><br/><br/>Last edited by Lick on Fri Jan 26, 2007 6:08 pm; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#116074 - philip - Sun Jan 21, 2007 6:33 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Lick wrote:</b></span></td> </tr> <tr> <td class="quote">There are 4 questions you need to ask when using backgrounds:
<br/>
<br/>
<span style="font-weight: bold">1) Have you assigned enough videomemory with the memorybanks?</span>
<br/>
</td> </tr></table><span class="postbody">
<br/>
So I would use the following for two 16bit backgrounds:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
vramSetBankA(VRAM_A_MAIN_BG_0x6000000);
<br/>
vramSetBankB(VRAM_B_MAIN_BG_0x6020000);
<br/>
</td> </tr></table><span class="postbody">
<br/>
Is that right?
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
<span style="font-weight: bold">2) Did you set the right blockbase for the background-controlregister?</span>
<br/>
- Visit Dev-Scene.com for the <a class="postlink" href="http://dev-scene.com/NDS/DOCgraphicmodes#Parameters_For_The_CR" target="_blank">parameters for the background-controlregisters</a>. 
<br/>
If you're using multiple backgrounds, you need to use BG_TILE_BASE and BG_MAP_BASE (tiled backgrounds) or BG_BMP_BASE (bitmap backgrounds), to specify the offset in the BG_GFX. The offset is calculated in blocks. 
<br/>
</td> </tr></table><span class="postbody">
<br/>
So I would use:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
BG2_CR = BG_BMP16_256x256 | BG_BMP_BASE(0) | BG_PRIORITY(0)
<br/>
BG3_CR = BG_BMP16_256x256 | BG_BMP_BASE(64) | BG_PRIORITY(1)
<br/>
</td> </tr></table><span class="postbody">
<br/>
Because the backgrounds are 128k in size?
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
<span style="font-weight: bold">3) Did you write your data to the correct offset?</span>
<br/>
- Like I just said, the blockbase and offset have to point to the same location. If you set the block like BG_BMP_BASE(n), you can use BG_BMP_RAM(n) to get a pointer to the correct location. So write your data to BG_BMP_RAM(n), BG_TILE_RAM(n), BG_MAP_RAM(n).
<br/>
</td> </tr></table><span class="postbody">
<br/>
Right, so I just write data to address BG_BMP_RAM(64) to draw background 3?
<br/>
<br/>
Okay, I think I understand now. Thanks a lot, I'll give it a try!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#116158 - philip - Mon Jan 22, 2007 6:00 pm</h4>
    <div class="postbody"><span class="postbody">Would I be right in assuming that if I used <span style="font-weight: bold">8-bit</span> backgrounds instead, I could make parts of them transparent by just clearing bit 15 in one of the palette colours, and using that colour to make areas transparent?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#116163 - Sausage Boy - Mon Jan 22, 2007 6:48 pm</h4>
    <div class="postbody"><span class="postbody">No :P
<br/>
<br/>
Actually, transparency with 8-bit backgrounds work by setting a pixel to palette entry 0. No matter what you have in palette at 0, the pixel will be transparent. But, palette index 0 controls the background color, the color that shows up when no other pixels are shown.<br/>_________________<br/>"no offense, but this is the gayest game ever"</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#116166 - Lick - Mon Jan 22, 2007 7:28 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>philip wrote:</b></span></td> </tr> <tr> <td class="quote">Would I be right in assuming that if I used <span style="font-weight: bold">8-bit</span> backgrounds instead, I could make parts of them transparent by just clearing bit 15 in one of the palette colours, and using that colour to make areas transparent?</td> </tr></table><span class="postbody">
<br/>
<br/>
In 8-bit backgrounds, each pixel is 1 byte (8bit) and contains an index to the background palette (BG_PALETTE). Like Sausage Boy said, BG_PALETTE[0] is transparent, so simply set the byte/pixel to 0. (You might still see a color, because BG_PALETTE[0] is also the 'no color' color. Like Sausage Boy said.)
<br/>
<br/>
In 16-bit backgrounds, each pixel is 2 bytes (16bit) and contains the color of that pixel. 1-5-5-5 is the number of bits for A-R-G-B (or A-B-G-R). So the bit at the left is the alpha bit; by setting it to 1 makes the pixel visible, setting it to 0 makes it invisible.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">1 | 00011 | 00011 | 00011  =  visible
<br/>
0 | 00011 | 00011 | 00011   = invisible
<br/>
<br/>
visible   = (3&lt;&lt;10) | (3&lt;&lt;5) | 3 | (1&lt;&lt;15);
<br/>
invisible = (3&lt;&lt;10) | (3&lt;&lt;5) | 3;
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Some of the DS screens are ABGR. On the DS Lite, both screens are. On the regular DS, only the top screen is.<br/>_________________<br/><a class="postlink" href="http://licklick.wordpress.com" target="_blank">http://licklick.wordpress.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#116177 - Sausage Boy - Mon Jan 22, 2007 10:28 pm</h4>
    <div class="postbody"><span class="postbody">Note that the RGB/BGR stuff doesn't really affect your programming in any way. The pixels are stored the same way, it's just the little color dots in the lcd's that are arranged differently. The only time you need to care about this is if you're trying to do subpixel rendering.<br/>_________________<br/>"no offense, but this is the gayest game ever"</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#116183 - Lick - Tue Jan 23, 2007 12:28 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Sausage Boy wrote:</b></span></td> </tr> <tr> <td class="quote">Note that the RGB/BGR stuff doesn't really affect your programming in any way. The pixels are stored the same way, it's just the little color dots in the lcd's that are arranged differently. The only time you need to care about this is if you're trying to do subpixel rendering.</td> </tr></table><span class="postbody">
<br/>
<br/>
Hmmm.. So the pixels on screen are BGR, but the values are still ARGB? I think I had that confused for quite a while until a second ago, hehe. Thanks Sausage Man.<br/>_________________<br/><a class="postlink" href="http://licklick.wordpress.com" target="_blank">http://licklick.wordpress.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#116200 - tepples - Tue Jan 23, 2007 2:43 am</h4>
    <div class="postbody"><span class="postbody">They're RGBA, little-endian.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#116244 - philip - Tue Jan 23, 2007 5:17 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Lick wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
<span style="font-weight: bold">3) Did you write your data to the correct offset?</span>
<br/>
- Like I just said, the blockbase and offset have to point to the same location. If you set the block like BG_BMP_BASE(n), you can use BG_BMP_RAM(n) to get a pointer to the correct location. So write your data to BG_BMP_RAM(n), BG_TILE_RAM(n), BG_MAP_RAM(n).
<br/>
</td> </tr></table><span class="postbody">
<br/>
The guide you linked to says each block is 2K, but in video.h, the BG_BMP_RAM() macros is defined thus:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#define BG_BMP_RAM(base)  (((base)*0x4000) + 0x06000000)
<br/>
</td> </tr></table><span class="postbody">
<br/>
Which indicates they're actually 16K. Huh?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#116247 - Mr Snowflake - Tue Jan 23, 2007 5:39 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>philip wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
In 16-bit backgrounds, each pixel is 2 bytes (16bit) and contains the color of that pixel. 1-5-5-5 is the number of bits for A-R-G-B (or A-B-G-R). So the bit at the left is the alpha bit; by setting it to 1 makes the pixel visible, setting it to 0 makes it invisible.
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">1 | 00011 | 00011 | 00011  =  visible
<br/>
0 | 00011 | 00011 | 00011   = invisible
<br/>
<br/>
visible   = (3&lt;&lt;10) | (3&lt;&lt;5) | 3 | (1&lt;&lt;15);
<br/>
invisible = (3&lt;&lt;10) | (3&lt;&lt;5) | 3;
<br/>
</td> </tr></table><span class="postbody"></span></td> </tr></table><span class="postbody">I get this, but which converter proggie allows sets the correct alpha values? Or should I always do it myself?<br/>_________________<br/><a class="postlink" href="http://www.mrsnowflake.be" target="_blank">http://www.mrsnowflake.be</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#116252 - tepples - Tue Jan 23, 2007 6:04 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>philip wrote:</b></span></td> </tr> <tr> <td class="quote">The guide you linked to says each block is 2K, but in video.h, the BG_BMP_RAM() macros is defined thus:
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#define BG_BMP_RAM(base)  (((base)*0x4000) + 0x06000000)
<br/>
</td> </tr></table><span class="postbody">
<br/>
Which indicates they're actually 16K. Huh?</span></td> </tr></table><span class="postbody">
<br/>
On at least the GBA in tile modes, each map block is 2 KiB, while each tile data block is 16 KiB. Extended rotation may screw with this rule of thumb.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#116317 - Lick - Wed Jan 24, 2007 11:14 am</h4>
    <div class="postbody"><span class="postbody">The link was wrong about that. Whatever the libnds headers say<span style="font-weight: bold"> about the 2D hardware</span>, is probably right. So map blocks = 2 KiB, tile/bmp blocks = 16 KiB.<br/>_________________<br/><a class="postlink" href="http://licklick.wordpress.com" target="_blank">http://licklick.wordpress.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#116336 - philip - Wed Jan 24, 2007 3:34 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Lick wrote:</b></span></td> </tr> <tr> <td class="quote">The link was wrong about that. Whatever the libnds headers say<span style="font-weight: bold"> about the 2D hardware</span>, is probably right. So map blocks = 2 KiB, tile/bmp blocks = 16 KiB.</td> </tr></table><span class="postbody">
<br/>
But when I set the background control registers, do I still deal with the blocks as 2k or 16k?
<br/>
<br/>
So is it:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
BG3_CR = BG_BMP16_256x256 | BG_BMP_BASE(64) | BG_PRIORITY(1) 
<br/>
</td> </tr></table><span class="postbody">
<br/>
or:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
BG3_CR = BG_BMP16_256x256 | BG_BMP_BASE(8) | BG_PRIORITY(1) 
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
??</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#116339 - philip - Wed Jan 24, 2007 4:05 pm</h4>
    <div class="postbody"><span class="postbody">Answering my own question, it should be BG_BMP_BASE(8)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#116544 - Lick - Fri Jan 26, 2007 6:05 pm</h4>
    <div class="postbody"><span class="postbody"><span style="font-weight: bold">5) If you're using an <span style="font-style: italic">Extended Rotation BG</span>, don't forget to set transform variables!</span>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">// Transforming the BG: default
<br/>
BG3_XDX = (1&lt;&lt;8);   // fixed point 8.8
<br/>
BG3_XDY = 0;
<br/>
BG3_YDX = 0;
<br/>
BG3_YDY = (1&lt;&lt;8);   // fixed point 8.8
<br/>
<br/>
// Positioning the BG: default
<br/>
BG3_CX = 0;         // negative value = positive offset
<br/>
BG3_CY = 0;         // so x(-10) will move it pixelx(10)</td> </tr></table><span class="postbody"><br/>_________________<br/><a class="postlink" href="http://licklick.wordpress.com" target="_blank">http://licklick.wordpress.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#117225 - philip - Fri Feb 02, 2007 3:23 pm</h4>
    <div class="postbody"><span class="postbody">Thanks everyone, I've got it working now. Cheers!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#117294 - JessTicular - Sat Feb 03, 2007 12:06 pm</h4>
    <div class="postbody"><span class="postbody">Lick, thanks for the explination of the Palettes.
<br/>
<br/>
Even though it was only breif it made something in my mind click that until this point I simply didn't understand.
<br/>
<br/>
Cheers,
<br/>
Jess.<br/>_________________<br/><span style="font-size: 9px; line-height: normal"><span style="font-weight: bold">Nintendo DS &amp; Dominos :: <a class="postlink" href="http://dsdominos.sourceforge.net" target="_blank">DS Dominos</a></span>
<br/>
<a class="postlink" href="http://jt0.org" target="_blank">http://jt0.org</a></span></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
