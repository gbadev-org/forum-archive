<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>mode5 / multiple backgrounds - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > mode5 / multiple backgrounds</h2>
<div id="posts">
<div class="post">
    <h4>#115684 - nio101 - Thu Jan 18, 2007 11:38 am</h4>
    <div class="postbody"><span class="postbody">Hello,
<br/>
<br/>
I'm quite new to DS dev, and I try to use a 512x512 8bit background along with a 256x256 8bit one on the main screen.
<br/>
<br/>
The idea is to switch from one background to another by using priorities...
<br/>
<br/>
I use the following code :
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
videoSetMode(MODE_5_2D | DISPLAY_BG3_ACTIVE | DISPLAY_BG2_ACTIVE );
<br/>
   
<br/>
   vramSetMainBanks(VRAM_A_MAIN_BG, VRAM_B_MAIN_BG,
<br/>
                     VRAM_C_SUB_BG , VRAM_D_MAIN_BG);
<br/>
   
<br/>
   BG3_CR = BG_BMP8_512x512 | BG_BMP_BASE(0) | BG_PRIORITY(3);
<br/>
<br/>
        BG3_XDX = 1 &lt;&lt; 8;
<br/>
        BG3_XDY = 0;
<br/>
        BG3_YDX = 0;
<br/>
        BG3_YDY = 1 &lt;&lt; 8;
<br/>
        BG3_CX = 64 &lt;&lt; 8;
<br/>
        BG3_CY = 64 &lt;&lt; 8;
<br/>
        
<br/>
  dmaCopy(512x512Bitmap_bin, BG_GFX, 512*512);
<br/>
  dmaCopy(Master_Pal_bin, BG_PALETTE, 256*2);
<br/>
   
<br/>
   BG2_CR = BG_BMP8_256x256 | BG_BMP_BASE(16) | BG_PRIORITY(0); 
<br/>
<br/>
        BG2_XDX = 1 &lt;&lt; 8;
<br/>
        BG2_XDY = 0;
<br/>
        BG2_YDX = 0;
<br/>
        BG2_YDY = 1 &lt;&lt; 8;
<br/>
        BG2_CX = 0;
<br/>
        BG2_CY = 32 &lt;&lt; 8;
<br/>
        
<br/>
  dmaCopy(256x256Bitmap_bin, VRAM_D , 256*256);
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
But the second background doesn't show up...
<br/>
<br/>
I've read tutorials and a lot of topics about background setups, but I couldn't find the solution...
<br/>
<br/>
Thanks for your help!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#115686 - Lick - Thu Jan 18, 2007 11:42 am</h4>
    <div class="postbody"><span class="postbody">Copy the second backgrounds data, per 2 bytes, while setting bit15 (which is the alpha bit). Also, for the right BG_BMP_BASE, you can use BG_BMP_RAM(n) for this purpose.
<br/>
<br/>
for(...)
<br/>
  ((u16*)BG_BMP_RAM(16))[i] = ((u16*)data)[i] | (1&lt;&lt;15);<br/>_________________<br/><a class="postlink" href="http://licklick.wordpress.com" target="_blank">http://licklick.wordpress.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#115689 - nio101 - Thu Jan 18, 2007 11:59 am</h4>
    <div class="postbody"><span class="postbody">Thanks for your answer but it still doesn't work...
<br/>
<br/>
-EDIT- : It doesn't work with Dualis, BUT it DOES work with NDESMUME ! I'm curious to know why !?!
<br/>
<br/>
For my understanding, why should we set the bit15 for the second background, and not for the first one ?
<br/>
<br/>
Thanks!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#115690 - Lick - Thu Jan 18, 2007 12:14 pm</h4>
    <div class="postbody"><span class="postbody">Oops, sorry. I was mistaken (thought you were using 16bit). Just try this:
<br/>
<br/>
dmaCopy(256x256Bitmap_bin, (u16*)(BG_BMP_RAM(16)), 256*256);<br/>_________________<br/><a class="postlink" href="http://licklick.wordpress.com" target="_blank">http://licklick.wordpress.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#115692 - nio101 - Thu Jan 18, 2007 12:32 pm</h4>
    <div class="postbody"><span class="postbody">Great, it's working ! thanks !
<br/>
<br/>
Now I have 2 backgrounds, I've tried to switch from one to another, but I didn't manage to do it !?! I've tried using setvideomode (but I guess it shouldn't be used that way) and altering BG2_CR and BG3_CR to modify BG_PRIORITY(X), but it didn't work...
<br/>
<br/>
If anybody can help... thanks again !
<br/>
<br/>
(too bad DEV Scene tutorials didn't do further day4...)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#115698 - Dark Knight ez - Thu Jan 18, 2007 1:41 pm</h4>
    <div class="postbody"><span class="postbody">If you have BG_PRIORITY(0), the BG is the top-most background shown.
<br/>
If you have BG_PRIORITY(3), it is the bottom-most background shown.
<br/>
Values in between are possible, with an ordering effect.
<br/>
<br/>
So yes, you have to set the BG_PRIORITY, and make sure you set the priorities right. I guess people might think the values to work the other way around.
<br/>
If you think you set the values right, post some code here so people can comment on it.<br/>_________________<br/><span style="font-size: 9px; line-height: normal"><a class="postlink" href="http://amplituds.drunkencoders.com" target="_blank">AmplituDS website</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#115701 - HyperHacker - Thu Jan 18, 2007 1:48 pm</h4>
    <div class="postbody"><span class="postbody">You have allocated 320K of VRAM for this, correct? 512x512 backgrounds are painful on VRAM usage; even at 8-bit that's 256K.<br/>_________________<br/>I'm a PSP hacker now, but I still &lt;3 DS.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#115706 - nio101 - Thu Jan 18, 2007 2:26 pm</h4>
    <div class="postbody"><span class="postbody">Yes, tu sum it up, I need to switch between a 512x512/8bit background and a "simple" 256x256/8bit on the main screen.
<br/>
<br/>
The following code I use doesn't allow to switch priorities... I only tested it with Dualis and NdesMume (since I don't have my DS with me ATM).
<br/>
<br/>
BTW, Dualis doesn't show the second background, while NdesMume does. Perhaps it's due to the fact that I'm heavy on VRAM with my 512x512 8 bit bitmap...?
<br/>
<br/>
Thanks.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">   videoSetMode(MODE_5_2D | DISPLAY_BG3_ACTIVE | DISPLAY_BG2_ACTIVE );   
<br/>
   
<br/>
   vramSetMainBanks(VRAM_A_MAIN_BG, VRAM_B_MAIN_BG,
<br/>
                     VRAM_C_SUB_BG , VRAM_D_MAIN_BG);
<br/>
   
<br/>
   BG3_CR = BG_BMP8_512x512 | BG_BMP_BASE(0) | BG_PRIORITY(1);
<br/>
<br/>
        BG3_XDX = 1 &lt;&lt; 8;
<br/>
        BG3_XDY = 0;
<br/>
        BG3_YDX = 0;
<br/>
        BG3_YDY = 1 &lt;&lt; 8;
<br/>
        BG3_CX = 64 &lt;&lt; 8;
<br/>
        BG3_CY = 64 &lt;&lt; 8;
<br/>
        
<br/>
  dmaCopy(Master_Pal_bin, BG_PALETTE, 256*2);      
<br/>
  dmaCopy(LargeBitmap_bin, BG_GFX, 512*512);
<br/>
   
<br/>
   BG2_CR = BG_BMP8_256x256 | BG_BMP_BASE(16) | BG_PRIORITY(0); 
<br/>
<br/>
        BG2_XDX = 1 &lt;&lt; 8;
<br/>
        BG2_XDY = 0;
<br/>
        BG2_YDX = 0;
<br/>
        BG2_YDY = 1 &lt;&lt; 8;
<br/>
        BG2_CX = 0;
<br/>
        BG2_CY = 32 &lt;&lt; 8;
<br/>
        
<br/>
 dmaCopy(NormalBitmap_bin, (u16*)(BG_BMP_RAM(16)), 256*256);
<br/>
<br/>
   
<br/>
   videoSetModeSub(MODE_0_2D | DISPLAY_BG0_ACTIVE);
<br/>
   
<br/>
  SUB_BG0_CR = BG_MAP_BASE(31);
<br/>
   BG_PALETTE_SUB[255] = RGB15(31,31,31);
<br/>
   BG_PALETTE_SUB[0] = RGB15(0,0,0);
<br/>
<br/>
   consoleInitDefault((u16*)SCREEN_BASE_BLOCK_SUB(31), (u16*)CHAR_BASE_BLOCK_SUB(0), 16);
<br/>
<br/>
 while(1)
<br/>
  {
<br/>
     scanKeys();
<br/>
     if (keysHeld() &amp; KEY_UP)
<br/>
     {
<br/>
        //videoSetMode(MODE_5_2D | DISPLAY_BG3_ACTIVE);
<br/>
        BG2_CR = BG_BMP8_256x256 | BG_BMP_BASE(16) | BG_PRIORITY(0); 
<br/>
        iprintf("BG2 : front ?\n");
<br/>
     }
<br/>
<br/>
     if (keysHeld() &amp; KEY_DOWN)
<br/>
     {
<br/>
        //videoSetMode(MODE_5_2D | DISPLAY_BG2_ACTIVE);
<br/>
        BG2_CR = BG_BMP8_256x256 | BG_BMP_BASE(16) | BG_PRIORITY(3);
<br/>
        iprintf("BG2 : bottom?\n");
<br/>
     }     
<br/>
     
<br/>
     swiWaitForVBlank();
<br/>
   }</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#115719 - nio101 - Thu Jan 18, 2007 6:02 pm</h4>
    <div class="postbody"><span class="postbody">I did some tests and it seems that the priority stuff works in my configuration only with images stored on BG_BMP_BASE(X) with X &lt; 16, even if I have 24x 16k that are allocated to MAIN_BG (VRAM_A, B &amp; D)...
<br/>
<br/>
I don't know why but if someone can help...
<br/>
<br/>
thanks.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#115739 - strager - Thu Jan 18, 2007 9:20 pm</h4>
    <div class="postbody"><span class="postbody">In your loop, you are setting BG2's priority to either 3 or 0.  BG3's priority is always 3.  If BG3's priority is 3, BG0-BG2 (and sprites) will be displayed over it.  This is because BG's have relative priorities depending on their number.  They function just like the standard priorities.  BG3 has a relative priority of 3, and BG2 has a relative priority of 2 (for example). Since layeres of higher priorities are displayed "further back," BG2 is in front of BG3.  The relative priorities are overridden by the BG's set priority.
<br/>
<br/>
A simple solution to your problem is to set BG3's priority to 2.  That way, if BG2's priority is 0, it will be displayed in front of BG3.  If BG2's priority is 3, it will be displayed behind BG3.
<br/>
<br/>
I hope this is somewhat clear.  I'm not sure I understand my explanation myself.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#115764 - HyperHacker - Fri Jan 19, 2007 12:12 am</h4>
    <div class="postbody"><span class="postbody">So what you're saying is if all four backgrounds are set to the same priority, BG3 &gt; BG2 &gt; BG1 &gt; BG0?<br/>_________________<br/>I'm a PSP hacker now, but I still &lt;3 DS.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#115776 - strager - Fri Jan 19, 2007 1:10 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>HyperHacker wrote:</b></span></td> </tr> <tr> <td class="quote">So what you're saying is if all four backgrounds are set to the same priority, BG3 &gt; BG2 &gt; BG1 &gt; BG0?</td> </tr></table><span class="postbody">
<br/>
<br/>
In the order of drawing, yes.
<br/>
<br/>
Since the higher priority backgrounds are drawn first, and the lower priority backgrounds after them, the lower priority backgrounds are shown in front of the higher priority backgrounds, because that BG only cares for its own transparency mask.
<br/>
<br/>
So, if all four backgrounds have the same priority, BG0 will be displayed closes to the viewer (in the front), followed by BG1, BG2, and BG3.
<br/>
<br/>
Though I could be completely wrong on this.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#115817 - nio101 - Fri Jan 19, 2007 9:34 am</h4>
    <div class="postbody"><span class="postbody">I managed to keep my largebitmap on 512x384 instead of 512x512, and that allowed me to use some blocks of VRAMA+VRAMB to hold my second background... In this case, the priority switch is working perfectly...
<br/>
<br/>
Thanks for your answers...</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
