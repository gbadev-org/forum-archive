<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Getting files to NOT show up as a directory - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > Getting files to NOT show up as a directory</h2>
<div id="posts">
<div class="post">
    <h4>#165273 - DiscoStew - Mon Dec 15, 2008 10:31 pm</h4>
    <div class="postbody"><span class="postbody">I just got finished with using Maxmod to stream WAV files (PCM specific) from a specific location using libfat, but now I want to be able to allow the user to go through directories to search for compatible WAV files to play.
<br/>
<br/>
I started with the libfat example that scans the root directory for folders and files and displays them as such, but I'm having a bit of trouble when opendir doesn't use the root directory. Everything read with a different directory is showing up as folders, both folders and files.
<br/>
<br/>
This is the simple change I made...
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">DIR *pdir;
<br/>
   
<br/>
   struct dirent *pent;
<br/>
   struct stat statbuf;
<br/>
<br/>
   //pdir=opendir("/");
<br/>
   pdir=opendir("/data/");   &lt;-----------------------
<br/>
   if (pdir)
<br/>
   {
<br/>
      while ((pent=readdir(pdir))!=NULL)
<br/>
      {
<br/>
         stat(pent-&gt;d_name,&amp;statbuf);
<br/>
          if(strcmp(".", pent-&gt;d_name) == 0 || strcmp("..", pent-&gt;d_name) == 0)
<br/>
             continue;
<br/>
          if(S_ISDIR(statbuf.st_mode))
<br/>
            iprintf("%s &lt;dir&gt;\n", pent-&gt;d_name);
<br/>
            if(!(S_ISDIR(statbuf.st_mode)))
<br/>
               iprintf("%s %ld\n", pent-&gt;d_name, statbuf.st_size);
<br/>
      }
<br/>
      closedir(pdir);
<br/>
   } else {
<br/>
      iprintf ("opendir() failure; terminating\n");
<br/>
   }
<br/>
<br/>
   while(1)
<br/>
      swiWaitForVBlank();</td> </tr></table><span class="postbody">
<br/>
<br/>
Am I doing something wrong? Also, if I am to switch to a new directory, would I need to close the current one, and then reopen the new one with opendir?<br/>_________________<br/><span style="font-weight: bold">DS</span> - It's all about <span style="font-weight: bold">D</span>isco<span style="font-weight: bold">S</span>tew</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#165274 - nanou - Mon Dec 15, 2008 11:08 pm</h4>
    <div class="postbody"><span class="postbody">That's ... odd. Aside from the fact that everything is listed as a directory, are you getting the correct list of items?
<br/>
<br/>
If you're throwing out the directory handle, then yes, you should certainly close it first. IMO, unless you're still in the middle of processing the contents (i.e. in the main while loop there--which would only cause trouble anyway) then you should close it before opening up a new one.<br/>_________________<br/>- nanou</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#165278 - DiscoStew - Mon Dec 15, 2008 11:47 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>nanou wrote:</b></span></td> </tr> <tr> <td class="quote">That's ... odd. Aside from the fact that everything is listed as a directory, are you getting the correct list of items?
<br/>
<br/>
If you're throwing out the directory handle, then yes, you should certainly close it first. IMO, unless you're still in the middle of processing the contents (i.e. in the main while loop there--which would only cause trouble anyway) then you should close it before opening up a new one.</td> </tr></table><span class="postbody">
<br/>
<br/>
So far, I'm seeing all the files in the current directory used, but unless opendir() is given just "/", S_ISDIR() is returning true for everything.
<br/>
<br/>
With switching to a different directory, I was just making sure that I needed to close then open, rather than doing something else like chdir or other things of that nature.<br/>_________________<br/><span style="font-weight: bold">DS</span> - It's all about <span style="font-weight: bold">D</span>isco<span style="font-weight: bold">S</span>tew</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#165281 - nanou - Tue Dec 16, 2008 1:33 am</h4>
    <div class="postbody"><span class="postbody">Okay, I feel stupid for not noticing this earlier.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">stat(pent-&gt;d_name,&amp;statbuf);</td> </tr></table><span class="postbody">
<br/>
<br/>
This assumes you're at the root level. The call to stat() fails since the directory is missing from the path, so statbuf is never getting updated (after checking . and .., which are directories.)
<br/>
<br/>
You can either use the full path when calling stat() or chdir() then opendir(".") should work.<br/>_________________<br/>- nanou</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#165286 - DiscoStew - Tue Dec 16, 2008 5:14 am</h4>
    <div class="postbody"><span class="postbody">Thanks, that helped a lot.<br/>_________________<br/><span style="font-weight: bold">DS</span> - It's all about <span style="font-weight: bold">D</span>isco<span style="font-weight: bold">S</span>tew</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
