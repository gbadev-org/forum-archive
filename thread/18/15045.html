<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>MD2 as a bin - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > MD2 as a bin</h2>
<div id="posts">
<div class="post">
    <h4>#151153 - iprice - Wed Feb 20, 2008 1:19 am</h4>
    <div class="postbody"><span class="postbody">I have quite happily been using MD2 files in efs section and reading them in when I need them... but I need to include an MD2 as a bin so it is in main memory... are there any examples of MD2 as bins out there?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#151173 - nipil - Wed Feb 20, 2008 2:02 pm</h4>
    <div class="postbody"><span class="postbody">i'd say, simply put it in a 'data' folder ?<br/>_________________<br/>NDS Lite Gold/Silver, MK5/R4DS, MSI PC54G2, D-Link DI-624</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#151188 - iprice - Wed Feb 20, 2008 6:19 pm</h4>
    <div class="postbody"><span class="postbody">What makefile commands are needed....
<br/>
<br/>
and how can I read chunks of the bin file similar to efs_read.....</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#151191 - iprice - Wed Feb 20, 2008 6:48 pm</h4>
    <div class="postbody"><span class="postbody">Yeah OK so the makefile is quite easy.... but how can I get chunks of the bin file such as the header, triangles etc from the bin? efs_read uses seek and read but I don't know how to do that with a bin file in memory, not in efs....</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#151204 - yellowstar - Wed Feb 20, 2008 10:56 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
u8 *stream = (u8*)md2_bin;//Change this to the name of your md2 file
<br/>
<br/>
//For reading data into structs, do this:
<br/>
SSomeStruct *somestruct=NULL;
<br/>
somestruct = (*SSomeStruct)pos;
<br/>
<br/>
//For buffers and similar things, do something like this:
<br/>
u8 *somebuffer = (u8*)malloc(18);
<br/>
memcpy(somebuffer,stream,18);
<br/>
//For copying into single bytes, do this:
<br/>
u8 my_byte = *stream;
<br/>
<br/>
//After every read like above, you must increase the value of stream
<br/>
//by the number of bytes read.
<br/>
//Structs
<br/>
stream += sizeof(SSomeStruct);
<br/>
//Buffers
<br/>
stream += 18;//18 should be replaced by the actual number of the bytes read
<br/>
//Single bytes
<br/>
stream++;
<br/>
<br/>
//For seeking, simply do an addition or substraction operation on stream, or a = operation.
<br/>
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#151205 - iprice - Wed Feb 20, 2008 11:10 pm</h4>
    <div class="postbody"><span class="postbody">This is the start of the MD2 code with efs
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">EFS_FILE* file;
<br/>
<br/>
file = EFS_fopen(Filename);
<br/>
<br/>
EFS_fread(&amp;Models[num].header, 1, sizeof (md2_header_t), file);
<br/>
   
<br/>
Models[num].texcoords = (md2_texCoord_t *)malloc (sizeof (md2_texCoord_t) * Models[num].header.num_st);
<br/>
Models[num].triangles = (md2_triangle_t *)malloc (sizeof (md2_triangle_t) * Models[num].header.num_tris);
<br/>
Models[num].frames = (md2_frame_t *)malloc (sizeof(md2_frame_t) * Models[num].header.num_frames);
<br/>
   
<br/>
EFS_fseek(file, Models[num].header.offset_st, SEEK_SET);
<br/>
EFS_fread(Models[num].texcoords, Models[num].header.num_st, sizeof (md2_texCoord_t), file);
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I am trying to convert it to read an MD2 that has been compiled into the memory as a bin. Thanks for the help, I'll have a look at it again.
<br/>
<br/>
Anyone has any other help, please let me know.
<br/>
<br/>
Cheers</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#151256 - iprice - Fri Feb 22, 2008 1:34 am</h4>
    <div class="postbody"><span class="postbody"></span><span class="gensmall"><br/><br/>Last edited by iprice on Sun Feb 24, 2008 4:27 pm; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#151365 - iprice - Sun Feb 24, 2008 4:27 pm</h4>
    <div class="postbody"><span class="postbody">Anyone got any spare time?
<br/>
<br/>
Cheers.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#151368 - DiscoStew - Sun Feb 24, 2008 6:49 pm</h4>
    <div class="postbody"><span class="postbody">What was wrong with your most recent code? If I remembered how it looked, that was pretty similar to how I'd deal with loading a binary file into a section of memory, and parsing out bits of data for reading.<br/>_________________<br/><span style="font-weight: bold">DS</span> - It's all about <span style="font-weight: bold">D</span>isco<span style="font-weight: bold">S</span>tew</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#151375 - iprice - Sun Feb 24, 2008 9:06 pm</h4>
    <div class="postbody"><span class="postbody">This first bits of data are OK but very long winded.... but later I try to replace:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">EFS_fread(Models[num].frames[i].verts, Models[num].header.num_vertices, sizeof(md2_vertex_t), file);
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
with:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">for (uu = 0; uu &lt; Models[num].header.num_vertices; uu++)
<br/>
{
<br/>
memcpy(somebuffer,stream,sizeof(unsigned char));
<br/>
Models[num].frames[i].verts-&gt;v[0] = *somebuffer;
<br/>
stream += sizeof(unsigned char); 
<br/>
memcpy(somebuffer,stream,sizeof(unsigned char));
<br/>
Models[num].frames[i].verts-&gt;v[1] = *somebuffer;
<br/>
stream += sizeof(unsigned char); 
<br/>
memcpy(somebuffer,stream,sizeof(unsigned char));
<br/>
Models[num].frames[i].verts-&gt;v[2] = *somebuffer;
<br/>
stream += sizeof(unsigned char); 
<br/>
memcpy(somebuffer,stream,sizeof(unsigned char));
<br/>
Models[num].frames[i].verts-&gt;normalIndex = *somebuffer;
<br/>
stream += sizeof(unsigned char); 
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
but the verts are pointers in the structure and it's just not right.......
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">typedef struct
<br/>
{
<br/>
md2_header_t header;
<br/>
md2_texCoord_t *texcoords;
<br/>
md2_triangle_t *triangles;
<br/>
md2_frame_t *frames;//this bit
<br/>
nds_texCoord_t *uvs;
<br/>
nds_triangle_t *tris;
<br/>
nds_frame_t *frms;
<br/>
}MD2Entity;
<br/>
</td> </tr></table><span class="postbody">
<br/>
is the MD2
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">typedef struct
<br/>
{
<br/>
  vec3_t          scale;
<br/>
  vec3_t          translate;
<br/>
  char            name[16];
<br/>
  md2_vertex_t    *verts;//verts are a pointer
<br/>
} md2_frame_t;</td> </tr></table><span class="postbody">
<br/>
//this is the frame
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">typedef struct
<br/>
{
<br/>
  unsigned char v[3];
<br/>
  unsigned char normalIndex;
<br/>
} md2_vertex_t;
<br/>
</td> </tr></table><span class="postbody">
<br/>
//this is one the verts in the frame
<br/>
<br/>
my code just isn't right and I'm not sure how to fix it.... I assume I am re-writing the same vert over top of itself each time.....
<br/>
<br/>
any ideas? anyone want the full source to laugh at my terrible coding?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#151379 - yellowstar - Sun Feb 24, 2008 9:36 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>iprice wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
but the verts are pointers in the structure and it's just not right....... 
<br/>
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
Models[num].frames[i].verts-&gt;v[0] = *somebuffer; 
<br/>
</td> </tr></table><span class="postbody">
<br/>
</span></td> </tr></table><span class="postbody">
<br/>
<br/>
The answer is at the start of the loop...
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
for (uu = 0; uu &lt; Models[num].header.num_vertices; uu++) 
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
verts[uu].v[0]
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I've wrote a MD2 loader before, just not on the DS.(PC)
<br/>
(And it's been a long time since I even looked at that code, however...)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#151381 - iprice - Sun Feb 24, 2008 9:58 pm</h4>
    <div class="postbody"><span class="postbody">Thanks.... before I wasn't getting anything displayed.... now I have garbled polys but I'm getting there.
<br/>
<br/>
Thanks... I'll keep going through it  :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#151492 - yellowstar - Wed Feb 27, 2008 9:41 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>iprice wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
I'm trying to replace this:
<br/>
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">EFS_fread(Models[num].frames[i].verts, Models[num].header.num_vertices, sizeof(md2_vertex_t), file);
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
with this:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">for(...){...}
<br/>
</td> </tr></table><span class="postbody">
<br/>
</span></td> </tr></table><span class="postbody">
<br/>
<br/>
Try this:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
memcpy(Models[num].frames[i].verts, stream, (int)(Models[num].header.num_vertices * sizeof(md2_vertex_t)));
<br/>
stream += (int)(Models[num].header.num_vertices * sizeof(md2_vertex_t));
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#151496 - iprice - Wed Feb 27, 2008 10:18 pm</h4>
    <div class="postbody"><span class="postbody">Hmmm, when I output the verts to screen I am getting lots of -1 values which I assume are overflow values that are too big for the type..... but the types for the data are correct as it works with efs, so I must still be reading the wrong values from the bin file......
<br/>
<br/>
thanks for the idea, but still no joy  :(
<br/>
<br/>
<br/>
Hang on.....
<br/>
<br/>
I was reading the scale wrong, as an int, not a float , so it was overflowing...... works! yay.
<br/>
<br/>
Thanks for all your help yellowstar!</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
