<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Optimization - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>DS development > Optimization</h2>
<div id="posts">
<div class="post">
    <h4>#97474 - ProblemBaby - Thu Aug 10, 2006 1:38 am</h4>
    <div class="postbody"><span class="postbody">Hi
<br/>
My program needs a heavy speed up! I think I need to speed up the current code about 8 times or more cause some things isnt added yet. Currently all code and data is placed in Main Memory how much can I gain by using the everything fastest the DS can achieve? 
<br/>
<br/>
Then Ive some general questions that think could me made better
<br/>
<br/>
1. Often Ive two check if a register is between 2 values is there some better way to do that instead of having two compares and two condbranches, I was trying to think if I could use some logic operator if the two "between"-values where powers of two, but I couldn't figure out anything. Any ideas?
<br/>
<br/>
2. Often I want to load/store a WORD but Ive to shift a register to get the address so Ive to do first a Shift and then a Shift in the LDR/STR to get it WORD-aligned, is there a way to force the address to be aligned or something.
<br/>
<br/>
Example:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
MOV r2, r10, LSR#11
<br/>
BIC r0, r10, #0xF800
<br/>
ADD r10, r10, #1
<br/>
LDR r2, [r12, r2, LSL#2]
<br/>
LDRB r1, [r2, r0]
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Is it something I can remove here?
<br/>
<br/>
All small improvements you can think of are very welcome, even if I havent talked about it here!
<br/>
<br/>
Thanks</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#97477 - Mighty Max - Thu Aug 10, 2006 2:19 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>ProblemBaby wrote:</b></span></td> </tr> <tr> <td class="quote">Hi
<br/>
My program needs a heavy speed up! I think I need to speed up the current code about 8 times or more cause some things isnt added yet. 
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
You should rethink your logic's and the used algorithms instead of nitpicking with assembler then.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
MOV r2, r10, LSR#11
<br/>
BIC r0, r10, #0xF800
<br/>
ADD r10, r10, #1
<br/>
LDR r2, [r12, r2, LSL#2]
<br/>
LDRB r1, [r2, r0]
<br/>
</td> </tr></table><span class="postbody">
<br/>
</span></td> </tr></table><span class="postbody">
<br/>
<br/>
Thats a good example, the code itself isn't much tuneable. However just slighty reorganising:
<br/>
<br/>
Put the 32 seperated tables in a continous chain, the access can now be (1x 64kB instead of 32x 2kB)
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
LDR r2,[r12]
<br/>
LDRB r1, [r10,r2],#1
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Next step would now be to check if r2 can be stored somewhere other then [r12]. It keeps constant now for every byte access so maybe you can move that LDR outside of a loop, or at least write/read it from DTCM (Stack)<br/>_________________<br/><a class="postlink" href="http://mightymax.org/gbamp_multiboot.html" target="_blank">GBAMP Multiboot</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#97478 - ProblemBaby - Thu Aug 10, 2006 2:26 am</h4>
    <div class="postbody"><span class="postbody">The problem is that this pointers may change over time, I could copy instead of having pointers, but I aint sure that it would speed it up
<br/>
but I'll probably try, thanks!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#97488 - sajiimori - Thu Aug 10, 2006 3:37 am</h4>
    <div class="postbody"><span class="postbody">You need to find out where your program is spending its time.  Otherwise, you're most likely wasting your effort.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#97499 - tepples - Thu Aug 10, 2006 4:43 am</h4>
    <div class="postbody"><span class="postbody">What you want is a profiler. For each stage in the frame computation, check VCOUNT to see how much time has elapsed. Then repeat the process for each stage within that stage.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#97541 - ProblemBaby - Thu Aug 10, 2006 11:10 am</h4>
    <div class="postbody"><span class="postbody">But I know exactly where the time is spent, its in my "render screen"-routine. its a routine that is called about 28000 times a frame, and even fully optimized code in that function takes a hell lot of time, so I need faster memory.
<br/>
Ive simply set up a timer that count cycles each frame in steps of 64.
<br/>
<br/>
The program runs in about 6200~ when rendering are off. If I add a LDRH + 3 STRH to VRAM to the rendering routine Iam up at 11900 and more complicated things really have to be done to calculate pixels.
<br/>
<br/>
Ive thinked of another way that could make it work fairly well, But that requires that I can control the hardware rendering. I need it to wait to draw each scanline Ive tried something like 
<br/>
<br/>
if (myScanline &gt;= 0 &amp;&amp; myScanline &lt; 192)
<br/>
while (VCOUNT != myScanline);
<br/>
<br/>
in a HBlank interrupt, but I couldn't manage it to work at all</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#97689 - sajiimori - Fri Aug 11, 2006 1:09 am</h4>
    <div class="postbody"><span class="postbody">Cool, timing your code is a good thing.  ^_^
<br/>
<br/>
As for optimization, especially of the 8x sort, discussions should start with algorithms.  The very very last thing to discuss is low-level cycle counting.
<br/>
<br/>
What does "render screen" do, specifically?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#97743 - Mighty Max - Fri Aug 11, 2006 11:40 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>ProblemBaby wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
if (myScanline &gt;= 0 &amp;&amp; myScanline &lt; 192)
<br/>
while (VCOUNT != myScanline);
<br/>
<br/>
in a HBlank interrupt, but I couldn't manage it to work at all</td> </tr></table><span class="postbody">
<br/>
<br/>
You shouldn't stall the cpu in the irq state with the while(). If the hblank is not the one you need, just leave it alone. Only act when the current hblank is the needed:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
if (myScanline &gt;= 0 &amp;&amp; myScanline &lt; 192)
<br/>
if (VCOUNT == myScanline) {
<br/>
Â  ...
<br/>
}
<br/>
</td> </tr></table><span class="postbody"><br/>_________________<br/><a class="postlink" href="http://mightymax.org/gbamp_multiboot.html" target="_blank">GBAMP Multiboot</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#98500 - DynamicStability - Tue Aug 15, 2006 5:27 pm</h4>
    <div class="postbody"><span class="postbody">I'd like to see said 28000 / frame 'renderScreen' code...or hear what its doing.
<br/>
<br/>
Find ways to reduce the number of compares....  You probably have a lot of redundant calculations also.<br/>_________________<br/>Framebuffer is dead.
<br/>
DynaStab.DrunkenCoders.com</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
