<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Booting into GBA mode - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > Booting into GBA mode</h2>
<div id="posts">
<div class="post">
    <h4>#161875 - cornaljoe - Sat Aug 16, 2008 2:33 pm</h4>
    <div class="postbody"><span class="postbody">I'm using DevkitARM r21 and I can compile this code but GBA mode doesn't boot properly.  I get a white screen on the screen set for GBA in the firmware and a black screen on the other.  I can hear the GBA startup logo but nothing else just a white screen.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
ARM9
<br/>
<br/>
#include &lt;nds.h&gt;
<br/>
<br/>
int main(void) {
<br/>
    if(((PERSONAL_DATA *)0x023FFC80)-&gt;_user_data.gbaScreen) {
<br/>
            REG_POWERCNT &amp;= ~POWER_SWAP_LCDS;
<br/>
    }
<br/>
    else {
<br/>
            REG_POWERCNT |= POWER_SWAP_LCDS;
<br/>
    }
<br/>
    return 0;
<br/>
}
<br/>
<br/>
ARM7
<br/>
<br/>
#include &lt;nds.h&gt;
<br/>
<br/>
int main(void) {
<br/>
    uint8 current, backlight;
<br/>
    if(((PERSONAL_DATA *)0x023FFC80)-&gt;_user_data.gbaScreen) {
<br/>
            backlight = ~PM_BACKLIGHT_TOP;
<br/>
    }
<br/>
    else {
<br/>
            backlight = ~PM_BACKLIGHT_BOTTOM;
<br/>
    }
<br/>
    // Reset the clock if needed
<br/>
    rtcReset();
<br/>
<br/>
    //enable sound
<br/>
    powerON(POWER_SOUND);
<br/>
    SOUND_CR = SOUND_ENABLE | SOUND_VOL(0x7F);
<br/>
<br/>
    REG_SPICNT = SPI_ENABLE | SPI_DEVICE_POWER | SPI_BAUD_1MHz | SPI_CONTINUOUS;
<br/>
    REG_SPIDATA = 0x80;
<br/>
<br/>
    SerialWaitBusy();
<br/>
    REG_SPICNT = SPI_ENABLE | SPI_DEVICE_POWER | SPI_BAUD_1MHz ;
<br/>
    REG_SPIDATA = 0;
<br/>
<br/>
    SerialWaitBusy();
<br/>
    current = REG_SPIDATA &amp; 0xff;
<br/>
<br/>
    current = current &amp; backlight;
<br/>
<br/>
    SerialWaitBusy();
<br/>
    REG_SPICNT = SPI_ENABLE | SPI_DEVICE_POWER | SPI_BAUD_1MHZ | SPI_CONTINUOUS;
<br/>
    REG_SPIDATA = 0;
<br/>
    SerialWaitBusy();
<br/>
    REG_SPICNT = SPI_ENABLE | SPI_DEVICE_POWER | SPI_BAUD_1MHZ;
<br/>
    REG_SPIDATA = current;
<br/>
<br/>
    SerialWaitBusy();
<br/>
    swiSwitchToGBAMode();
<br/>
<br/>
    return 0;
<br/>
}</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161889 - spinal_cord - Sun Aug 17, 2008 12:15 am</h4>
    <div class="postbody"><span class="postbody">if you can hear the sound, and you have one white screen and one black, it seems to me that your screens are the wrong way round. Try <span style="font-style: italic">not</span> switching them.<br/>_________________<br/>I'm not a boring person, it's just that boring things keep happening to me.
<br/>
<a class="postlink" href="http://spinal.dizidesigns.co.uk/" target="_blank">Homepage</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161901 - cornaljoe - Mon Aug 18, 2008 2:18 am</h4>
    <div class="postbody"><span class="postbody">The problem seems to be the code to initiate the bottom screen.  If the top screen is set in the firmware it shows fine.  I just removed the check for the firmware setting and put it on the top screen.
<br/>
<br/>
But now there is another problem.  When it boots the Nintendo logo doesn't appear and it freezes at the GBA logo.  I tested it on anotherr DS and it works.  I believe this GBA boot code isn't compatible with newer DSL. Anyone know how this can be fixed?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161902 - chuckstudios - Mon Aug 18, 2008 3:06 am</h4>
    <div class="postbody"><span class="postbody">Try executing readUserSettings() before accessing the gbaScreen variable (it's used in the combined template).
<br/>
<br/>
However, I remembered having a similar issue and checked some old source:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
   // read User Settings from firmware
<br/>
   //readUserSettings();
<br/>
   // what the fuck, wintermute? - this fubars PersonalData-&gt;_user_data.gbaScreen for some reason</td> </tr></table><span class="postbody">
<br/>
<br/>
But maybe your issue is the exact opposite of mine - your loader destroys that data and readUserSettings works fine now?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161948 - cornaljoe - Wed Aug 20, 2008 12:37 am</h4>
    <div class="postbody"><span class="postbody">Weird...  I just went ahead and compiled the code in my project and it works.  If I compile it as a standalone it still malfunctions.
<br/>
<br/>
I still have the problem with it not working on new DSL and some garbage gfx appearing in the border.  I'll look into the problem and try to find a fix.  I'll try clearing VRAM before the boot.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
