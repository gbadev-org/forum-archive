<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Help, glLight. - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > Help, glLight.</h2>
<div id="posts">
<div class="post">
    <h4>#158015 - AntonioND - Tue Jun 03, 2008 3:25 pm</h4>
    <div class="postbody"><span class="postbody">Hello everybody!
<br/>
<br/>
I'm coding a 3D game, but I just can't make the lights work in real DS (in iDeaS they seem to work...). I have read all 3D examples of libnds where light is used, and changed my code a lots of times, but it's the same, I always see my 3D scene in it's normal colors...
<br/>
<br/>
Thanks for your help.
<br/>
<br/>
<br/>
Note: I haven't tried no$gba because my game uses FAT, I don't know how to use fscr dldi and I don't want to learn only for this, i usually check on ds using wifiloader.
<br/>
<br/>
Note 2: I'm spanish, if you don't understand something, just tell me and I'll try to explain myself better.
<br/>
<br/>
---------------------
<br/>
Here is my code:
<br/>
---------------------
<br/>
<br/>
Before this, I init PAlib.
<br/>
<br/>
I use this to init 3D mode:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
int texture[128];
<br/>
<br/>
void My_Init_3D()
<br/>
{
<br/>
lcdMainOnTop();
<br/>
videoSetMode(MODE_0_3D);
<br/>
vramSetBankA(VRAM_A_TEXTURE);
<br/>
vramSetBankB(VRAM_B_TEXTURE);
<br/>
<br/>
glInit();
<br/>
glEnable(GL_TEXTURE_2D | GL_ANTIALIAS | GL_BLEND);
<br/>
glClearColor(0,0,0,31); 
<br/>
glClearPolyID(63); 
<br/>
glClearDepth(GL_MAX_DEPTH);
<br/>
glViewport(0,0,255,191);
<br/>
<br/>
glGenTextures(128, &amp;texture[0]);
<br/>
<br/>
glMatrixMode(GL_PROJECTION);
<br/>
glLoadIdentity();
<br/>
gluPerspective(70, 256.0 / 192.0, 0.1, 40);
<br/>
<br/>
glMaterialf(GL_AMBIENT, RGB15(16,16,16));
<br/>
glMaterialf(GL_DIFFUSE, RGB15(20,20,20));
<br/>
glMaterialf(GL_SPECULAR, BIT(15) | RGB15(8,8,8));
<br/>
glMaterialf(GL_EMISSION, RGB15(5,5,5));
<br/>
glMaterialShinyness();
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
<br/>
I call this function in the main loop once a frame:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void 3D()
<br/>
{
<br/>
glMatrixMode(GL_MODELVIEW);
<br/>
glLoadIdentity();
<br/>
gluLookAt(  -12.0, 4.0, 0.0,   
<br/>
         8.0, 0.0, 0.0,   
<br/>
         0.0, 1.0, 0.0);   
<br/>
<br/>
//This is only for testing...
<br/>
if(Pad.Held.X) glLight(0, RGB15(31, 0,0) , 0, floattov10(-1.0), 0);
<br/>
else glLight(0, RGB15(1, 0,0) , 0, floattov10(-1.0), 0);
<br/>
if(Pad.Held.B) glLight(1, RGB15(0, 31, 0) , 0, floattov10(-1.0), 0);
<br/>
else glLight(1, RGB15(0, 1, 0) , 0, floattov10(-1.0), 0);
<br/>
if(Pad.Held.Y) glLight(2, RGB15(0, 0, 31) , 0, floattov10(-1.0), 0);
<br/>
else glLight(2, RGB15(0, 0, 1) , 0, floattov10(-1.0), 0);
<br/>
<br/>
glPolyFmt(POLY_ID(1) | POLY_ALPHA(31) | POLY_CULL_BACK | POLY_FORMAT_LIGHT0| POLY_FORMAT_LIGHT1| POLY_FORMAT_LIGHT2);
<br/>
<br/>
<br/>
Draw_Objects();
<br/>
/*For example:
<br/>
glBegin(GL_QUADS);
<br/>
glNormal3f(0,1,0);
<br/>
glColor3f(1,0,0); 
<br/>
glVertex3f(-8,0,-8);
<br/>
glColor3f(0,1,0); 
<br/>
glVertex3f(-8,0,8);
<br/>
glColor3f(0,0,1); 
<br/>
glVertex3f(8,0,8);
<br/>
glColor3f(1,1,0); 
<br/>
glVertex3f(8,0,-8);
<br/>
glEnd();
<br/>
*/
<br/>
<br/>
glFlush(0);
<br/>
}</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#158020 - elhobbs - Tue Jun 03, 2008 5:38 pm</h4>
    <div class="postbody"><span class="postbody">I think this is your problem
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">floattov10(-1.0)</td> </tr></table><span class="postbody">
<br/>
the values for the light vectors are 10 bit - 1 bit for the sign and 9 bits for the fractional value. In other words there is no whole number piece. so you need to use a value slightly smaller (in magnitude) than -1.0 like -0.99. the floattov10 macro handles values &gt; 0.998 correctly but it does not handle values &lt;= -0.998 correctly.
<br/>
<br/>
here is the macro for reference:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#define floattov10(n)        ((n&gt;.998) ? 0x1FF : ((v10)((n)*(1&lt;&lt;9)))) /*!&lt; \brief convert float to v10 */
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#158021 - DiscoStew - Tue Jun 03, 2008 5:44 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">glNormal3f(0,1,0);
<br/>
glColor3f(1,0,0); </td> </tr></table><span class="postbody">
<br/>
<br/>
One thing to take note with the NDS is that glNormal and glColor cannot be used together, because they share the same spot when entering vertex data. While glColor write the color directly, glNormal calculates the color using the active lights and it's own vector inputted. You've called glNormal once, but right after, you called glColor, which overwrites any color calculation made by glNormal. If you know how normals are calculated on the NDS, you "could" essentially mix the two via software.<br/>_________________<br/><span style="font-weight: bold">DS</span> - It's all about <span style="font-weight: bold">D</span>isco<span style="font-weight: bold">S</span>tew</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#158022 - AntonioND - Tue Jun 03, 2008 6:02 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>elhobbs wrote:</b></span></td> </tr> <tr> <td class="quote">[...]</td> </tr></table><span class="postbody">
<br/>
I didn't know that, but even changing the values it doesn't work... It's another thing:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>DiscoStew wrote:</b></span></td> </tr> <tr> <td class="quote">[...]</td> </tr></table><span class="postbody">
<br/>
Thanks for your comment... I thought that if I used lights and colours in the same polygon I wouldn's see the colors and see the lights.
<br/>
<br/>
If I take out glColor3f(1,0,0); in that quad, I can see the light. This made me think... The problem with the other objects (displayed using glCallList) is that the callList modify their colour and I can't apply light in them... I'm converting them with this:
<br/>
<a href="http://forum.gbadev.org/viewtopic.php?t=14947" target="_blank">http://forum.gbadev.org/viewtopic.php?t=14947</a>
<br/>
I'll made an app that removes the things I don't want. I think I can do it. :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#158023 - DiscoStew - Tue Jun 03, 2008 6:18 pm</h4>
    <div class="postbody"><span class="postbody">In a way, glNormal is an extention to glColor (though not directly), in which the end result is a color value that is written into the buffer to be executed by the hardware. glColor will overwrite glNormal, and vice versa. That's why they can't be mixed together normally.<br/>_________________<br/><span style="font-weight: bold">DS</span> - It's all about <span style="font-weight: bold">D</span>isco<span style="font-weight: bold">S</span>tew</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#158030 - silent_code - Tue Jun 03, 2008 7:40 pm</h4>
    <div class="postbody"><span class="postbody">but you can use the color you would like to set with glColor() and make it the material's diffuse color and still have lighting work correctly. ;^)
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>gbatek wrote:</b></span></td> </tr> <tr> <td class="quote">40004C0h - Cmd 30h - DIF_AMB - MaterialColor0 - Diffuse/Ambient Reflect. (W)
<br/>
<br/>
  0-4   Diffuse Reflection Red     ;\light(s) that directly hits the polygon,
<br/>
  5-9   Diffuse Reflection Green   ; ie. max when NormalVector has opposite
<br/>
  10-14 Diffuse Reflection Blue    ;/direction of LightVector
<br/>
  15    Set Vertex Color (0=No, 1=Set Diffuse Reflection Color as Vertex Color)
<br/>
  16-20 Ambient Reflection Red     ;\light(s) that indirectly hits the polygon,
<br/>
  21-25 Ambient Reflection Green   ; ie. assuming that light is reflected by
<br/>
  26-30 Ambient Reflection Blue    ;/walls/floor, regardless of LightVector
<br/>
  31    Not used
<br/>
<br/>
With Bit15 set, the lower 15bits are applied as VertexColor (exactly as when when executing the Color command), the purpose is to use it as default color (eg. when outcommenting the Normal command), normally, when using lighting, the color setting gets overwritten (as soon as executing the Normal command).</td> </tr></table><span class="postbody"><br/>_________________<br/><span style="font-size: 9px; line-height: normal"><span style="text-decoration: underline"><span style="font-weight: bold"></span></span> July 5th 08: "<span style="font-weight: bold">Volumetric Shadow Demo</span>" 1.6.0 (final) source released
<br/>
June 5th 08: "<span style="font-weight: bold">Zombie NDS</span>" WIP released!
<br/>
It's all on my page, just click <span style="font-weight: bold">WWW</span> below.</span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#158035 - AntonioND - Tue Jun 03, 2008 8:05 pm</h4>
    <div class="postbody"><span class="postbody">I don't know how to do that XD (i'm noob at this).
<br/>
Instead I'll code my own app to delete FIFO_COLOR and its arguments from a callList. I've been looking at libnds and I think I understand how it works.
<br/>
Isn't it ironic? :P</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#158036 - silent_code - Tue Jun 03, 2008 9:03 pm</h4>
    <div class="postbody"><span class="postbody">there's a demo on my site that uses this "technique". :^)
<br/>
you are free to check it out. it's really easy to do.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">   glMaterialf(GL_AMBIENT, RGB15(0, 0, 0));
<br/>
   glMaterialf(GL_DIFFUSE, RGB15(31, 31, 31));
<br/>
   glMaterialf(GL_SPECULAR, RGB15(0, 0, 0) | BIT(15)); // notice the additional BIT(15)!
<br/>
   glMaterialf(GL_EMISSION, RGB15(0, 0, 0));
<br/>
</td> </tr></table><span class="postbody"><br/>_________________<br/><span style="font-size: 9px; line-height: normal"><span style="text-decoration: underline"><span style="font-weight: bold"></span></span> July 5th 08: "<span style="font-weight: bold">Volumetric Shadow Demo</span>" 1.6.0 (final) source released
<br/>
June 5th 08: "<span style="font-weight: bold">Zombie NDS</span>" WIP released!
<br/>
It's all on my page, just click <span style="font-weight: bold">WWW</span> below.</span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#158083 - AntonioND - Wed Jun 04, 2008 2:59 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>silent_code wrote:</b></span></td> </tr> <tr> <td class="quote">there's a demo on my site that uses this "technique". :^)
<br/>
you are free to check it out. it's really easy to do.
<br/>
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">   glMaterialf(GL_AMBIENT, RGB15(0, 0, 0));
<br/>
   glMaterialf(GL_DIFFUSE, RGB15(31, 31, 31));
<br/>
   glMaterialf(GL_SPECULAR, RGB15(0, 0, 0) | BIT(15)); // notice the additional BIT(15)!
<br/>
   glMaterialf(GL_EMISSION, RGB15(0, 0, 0));
<br/>
</td> </tr></table><span class="postbody"></span></td> </tr></table><span class="postbody">
<br/>
<br/>
It doesn't work, I don't know why. But...
<br/>
<br/>
Yesterday I investigated a bit, and now I understand perfectly the way callLists work. I managed to fix one simple model, and this afternoon I'll make an app to do the same to all my models. ^^
<br/>
<br/>
EDIT: Half-done :P.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#158100 - silent_code - Wed Jun 04, 2008 10:11 pm</h4>
    <div class="postbody"><span class="postbody">what doesn't work? the material or the demo?
<br/>
<br/>
if it's the demo, run it in no$gba. you won't be able to see all features, as some of them aren't emulated, yet, but you'll be able to see that you can change the material color and still get perfectly valid lighting. :^)
<br/>
<br/>
if it's the material command, there are some restrictions in some cases and you need to set the normal it again, after issuing certain commands:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>gbatek wrote:</b></span></td> </tr> <tr> <td class="quote">When using lighting, the Normal command must be re-executed after switching Lighting on/off, or after changing light/material parameters.</td> </tr></table><span class="postbody">
<br/>
<br/>
NOTE: (in case it wasn't clear before) don't use the glColor() command! you have to set the color with the material!<br/>_________________<br/><span style="font-size: 9px; line-height: normal"><span style="text-decoration: underline"><span style="font-weight: bold"></span></span> July 5th 08: "<span style="font-weight: bold">Volumetric Shadow Demo</span>" 1.6.0 (final) source released
<br/>
June 5th 08: "<span style="font-weight: bold">Zombie NDS</span>" WIP released!
<br/>
It's all on my page, just click <span style="font-weight: bold">WWW</span> below.</span></span><span class="gensmall"><br/><br/>Last edited by silent_code on Wed Jun 04, 2008 10:15 pm; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#158101 - AntonioND - Wed Jun 04, 2008 10:15 pm</h4>
    <div class="postbody"><span class="postbody">Even if I put your code, my models from callLists are shown as before.
<br/>
<br/>
In addition, I prefer to fix my callLists and set the material propierties I want.
<br/>
I have almost finished my program to do this, so don't worry.
<br/>
<br/>
EDIT: It's finished. It calculates bad the final size, but it works!! As soon as I fix it and I fix some models to test it i'll upload it.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#158103 - silent_code - Wed Jun 04, 2008 10:53 pm</h4>
    <div class="postbody"><span class="postbody">yes, you have to set the material command in a dl, that's right. :^)
<br/>
i was ignoring the fact that you use dl, my bad. ;^)
<br/>
<br/>
happy coding! :^)<br/>_________________<br/><span style="font-size: 9px; line-height: normal"><span style="text-decoration: underline"><span style="font-weight: bold"></span></span> July 5th 08: "<span style="font-weight: bold">Volumetric Shadow Demo</span>" 1.6.0 (final) source released
<br/>
June 5th 08: "<span style="font-weight: bold">Zombie NDS</span>" WIP released!
<br/>
It's all on my page, just click <span style="font-weight: bold">WWW</span> below.</span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#158138 - AntonioND - Thu Jun 05, 2008 2:43 pm</h4>
    <div class="postbody"><span class="postbody"><a href="http://forum.gbadev.org/viewtopic.php?p=158137#158137" target="_blank">http://forum.gbadev.org/viewtopic.php?p=158137#158137</a>
<br/>
<br/>
I have uploaded my program. If someone wants to modify it feel free to do it. ^^</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
