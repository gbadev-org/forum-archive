<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Audio solutions - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>DS development > Audio solutions</h2>
<div id="posts">
<div class="post">
    <h4>#82978 - Lazy1 - Thu May 11, 2006 5:26 pm</h4>
    <div class="postbody"><span class="postbody">Take a listen to this file:
<br/>
<a href="http://lazyone.drunkencoders.com/files/getthem.ogg" target="_blank">http://lazyone.drunkencoders.com/files/getthem.ogg</a>
<br/>
<br/>
That is a music track from wolfenstein 3D converted from IMF using winamp and an IMF reading plugin.
<br/>
I'll be honest here, sound programming is not my thing and the only reason my wolf3d port had any sound at all was because wntrmute added it (thx btw).
<br/>
<br/>
I cannot run the <a class="postlink" href="http://en.wikipedia.org/wiki/YM3812" target="_blank">YM3812</a> emulator on the arm9 since all of it's resources are spent running the software renderer.
<br/>
Ideally, the arm9 would tell the arm7 which track to play and decode leaving valuable time free for the renderer.
<br/>
<br/>
From what I understand, this is the basic format of an IMF music file:
<br/>
<br/>
[Header]
<br/>
Adlib command count : word
<br/>
<br/>
[Adlib command]
<br/>
Pause length : halfword
<br/>
Adlib register : byte
<br/>
Adlib value : byte
<br/>
<br/>
[IMF File]
<br/>
Header
<br/>
Adlib command
<br/>
Adlib command
<br/>
Adlib command
<br/>
...
<br/>
...
<br/>
...
<br/>
ect
<br/>
<br/>
Could be wrong on that though since I haven't played with it for a few days.
<br/>
<br/>
I'm just looking for options now while I re-write my wolf3d port which is going well so far:
<br/>
<br/>
Done:
<br/>
Change 320x200 display to 256x192
<br/>
Remove statusbar
<br/>
Uses different files now for i/o and timecount code ( ie. win32/io.c )
<br/>
<br/>
Working on:
<br/>
Menu customizations
<br/>
Re-arranging screens to fit into 256x192
<br/>
<br/>
Todo:
<br/>
Find a way to display 320x200 images on a 256x192 display
<br/>
Sampled sounds
<br/>
PC Speaker ( maybe the PSG on the DS could emulate this? )
<br/>
Adlib music ( why this topic exists )
<br/>
Adlib sounds ( ^^^ )
<br/>
New statusbar on sub screen
<br/>
<br/>
Any ideas on formats which IMF would convert nicely too and be playable on the arm7 would be VERY appreciated.
<br/>
Wolf3d needs it's original music!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#83182 - Lazy1 - Sat May 13, 2006 10:16 pm</h4>
    <div class="postbody"><span class="postbody">Hmm, still no ideas for music?
<br/>
<br/>
I have decided on a way to get the adlib sounds working (picking up treasure,keys,knife sounds,ect) without the cost of adlib emulation.
<br/>
I will write a pre-converter which will turn the adlib sound data into raw PCM data which will be loaded from the cf as needed (I'll do some caching to reduce reads though).
<br/>
<br/>
Getting sound to work under win32 has been extremely difficult so far (really wish waveOutWrite would block), but with what I have learned the next nds port will have positioned audio and hacked adlib sounds. Maybe music if I/someone can come up with an idea on how to do it. 
<br/>
<br/>
Another issue is that sound requires a thread, since threading is difficult on the nds, would a timer interrupt do?
<br/>
I don't know, audio is still very new to me :/</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#83217 - TwinD - Sun May 14, 2006 4:19 am</h4>
    <div class="postbody"><span class="postbody">Yeah, that will work, IIRC that's how most of the music libs on the GBA did it, so should work similarly for DS.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#83221 - tepples - Sun May 14, 2006 7:33 am</h4>
    <div class="postbody"><span class="postbody">Most GBA mixer libraries either . The display frequencies on the GBA (280896 cycles per frame) had <a class="postlink" href="http://www.pineight.com/gba/samplerates/" target="_blank">quite a few "nice" factors</a> that allowed use of the vertical blank interrupt instead of a dedicated sample-counting timer. But on the DS, you will need to use a timer because <a class="postlink" href="http://www.bottledlight.com/ds/index.php/Video/Screens" target="_blank">560190 cycles</a> doesn't have near as many factors.
<br/>
<br/>
Can a DS sampled sound channel fire an interrupt every time it loops? I can't seem to understand everything in <a class="postlink" href="http://nocash.emubase.de/gbatek.htm#dssound" target="_blank">GBATEK's description of DS sound</a>. Or would I need to use a separate timer for this and hope that there isn't a glitch?<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#83239 - Lazy1 - Sun May 14, 2006 11:08 am</h4>
    <div class="postbody"><span class="postbody">Hmm, still playing with audio win32 side but Im wondering how I'll do it on the nds...
<br/>
The way the sdl/linux port worked was by copying sound data into a 512 sample audio buffer and writing it to /dev/dsp.
<br/>
I asked the author why his sound thread didn't sleep and he says its because writing to /dev/dsp will block.
<br/>
That explains why I had problems with waveOutWrite which just returns immediately, that and buffer sizes/latency are annoying too.
<br/>
<br/>
So, the basic idea is to:
<br/>
Get the audio sample
<br/>
Convert it to 16 bit stereo
<br/>
Send buffer to sound hardware for playback
<br/>
Wait until sound hardware has finished playing
<br/>
<br/>
I know how to do steps 1, 2 and maybe 3 - but 4 I have no idea.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#83273 - gladius - Sun May 14, 2006 10:59 pm</h4>
    <div class="postbody"><span class="postbody">There are plenty of sound examples out there for the DS.
<br/>
<br/>
The basic idea is you have 16 sound channels available.  Each sound channel gets pointed at a section of memory which contains the sound data, then you tell it to start playing.  It's pretty simple actually.
<br/>
<br/>
Custom mixing is a bit more tricky, in that you have to set up some timers with IRQ callbacks to let you know when to put more data into the sound buffer.  You set the timer up to fire at halfway through the buffer play time, then fill in the half of the buffer that just finished with new sound data.  You can set the sound channel to loop, which will give the effect of continuous sound playback.
<br/>
<br/>
I still think porting the YM3812 emulator to run on the ARM7 would be feasible.  You might need a bit of asm to get the speed up, but it would be feasible.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#83281 - Lazy1 - Mon May 15, 2006 12:05 am</h4>
    <div class="postbody"><span class="postbody">Well, after thinking about it maybe software mixing is not needed.
<br/>
The only reason I was going to use it was because of positioned audio, but that can be done by adjusting the panning or volume.
<br/>
I don't really need to handle the sound in 4kb pages either, in the old port wntrmute hacked it to load the entire sample at once. That is probably the best way to do things rather than overcomplicate everything.
<br/>
<br/>
I'll give the YM3812 emulator another try though, since my adlib sound converter will require it anyway.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
