<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>bitmap sprite and attribute2 index - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > bitmap sprite and attribute2 index</h2>
<div id="posts">
<div class="post">
    <h4>#139839 - ghuldan - Mon Sep 10, 2007 6:17 pm</h4>
    <div class="postbody"><span class="postbody">Hi everyone,
<br/>
<br/>
I tried to display 35 bmp_sprites (32x32) with this code.
<br/>
Sprites are filled correctly into VRAM : 
<br/>
- from tilenum 0 to 15 for sprite1
<br/>
- from tilenum 16 to 31 for sprite2 etc etc ...
<br/>
<br/>
But i need to put (firstTilenum * 4) on oam attribute2 to make its displayed correctly.
<br/>
And sprite index Attribute2 can only go from 0 to 1024 : so my 17th sprite overlap on first instead of the 65th
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#include &lt;PA9.h&gt;
<br/>
<br/>
#include "gfx/all_gfx.h"
<br/>
#include "gfx/all_gfx.c"
<br/>
<br/>
<br/>
//Main...
<br/>
int main(void){
<br/>
<br/>
   PA_Init(); //PAlib Init...
<br/>
   PA_InitVBL(); //VBL Init...
<br/>
   
<br/>
   videoSetMode( MODE_0_2D |
<br/>
                  DISPLAY_BG0_ACTIVE |
<br/>
                  DISPLAY_SPR_ACTIVE |
<br/>
                  DISPLAY_SPR_1D |
<br/>
                  DISPLAY_SPR_1D_BMP |
<br/>
                  DISPLAY_SPR_1D_SIZE_64
<br/>
                );
<br/>
                     
<br/>
   unsigned short * gfx = (unsigned short*)malloc(sizeof(unsigned short) * 32 * 32);
<br/>
                     
<br/>
   int i, k, l, w = 7, h = 5;
<br/>
   for(l = 0; l &lt; h; l ++)
<br/>
      for(k = 0; k &lt; w; k ++) {
<br/>
         PA_obj[0][k + w * l].atr0 = ATTR0_BMP | ATTR0_ROTSCALE | (l * 35 + 5); 
<br/>
         PA_obj[0][k + w * l].atr1 = ATTR1_SIZE_32 | (k * 35 + 5);
<br/>
         PA_obj[0][k + w * l].atr2 = ATTR2_ALPHA(1) | PA_CreateGfx(0, gfx, OBJ_SIZE_32X32, 2) * 1;
<br/>
            
<br/>
         // red 32*32 square for 1d bitmap mode
<br/>
         for(i = 0; i &lt; 32 * 32; i++)
<br/>
            gfx[i] = ship_Sprite[i];//RGB15(31 - 3*(k + w * l)/4, 3*(k + w * l)/4, 3*(k + w * l)/4) | (1 &lt;&lt; 15);
<br/>
            
<br/>
         PA_UpdateGfx(0, PA_GetSpriteGfx(0, k + w * l), (void*)gfx); 
<br/>
      }
<br/>
<br/>
                     
<br/>
   while(1){ // Infinite loop
<br/>
      PA_WaitForVBL();
<br/>
   }
<br/>
   return 0;
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
I tried to change that thing "DISPLAY_SPR_1D_SIZE_64" to anything i could find but it doesnt do anything different.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#139866 - nce - Tue Sep 11, 2007 12:35 am</h4>
    <div class="postbody"><span class="postbody">DISPLAY_SPR_1D_SIZE_64
<br/>
tells that you will use 64Ko of memory and then map your atrib2 to enter just in this range
<br/>
<br/>
now you want to display 35 * 32 * 32 (*2 for the 16bit color)  you are using 70Ko just too much
<br/>
<br/>
that means that you want to use the 128 Ko
<br/>
that means 
<br/>
DISPLAY_SPR_1D_SIZE_128
<br/>
<br/>
and your atrib2 will be map on 128 Ko
<br/>
You can try then to use (firstTilenum * 2)
<br/>
<br/>
<br/>
PS:  thinking about that normally you should succeed to put your first 32 sprite in the 64Ko memory that's means that normaly you shouldn't overlap at the 17th sprite..... There is probably something wrong in the first place.  But I never used PAlib so I don't know what are the paremeters and what it return.<br/>_________________<br/>-jerome-</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#139870 - ghuldan - Tue Sep 11, 2007 1:22 am</h4>
    <div class="postbody"><span class="postbody">This is the PAlib initialisation :
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">videoSetMode(  MODE_0_2D | 
<br/>
      DISPLAY_SPR_ACTIVE | 
<br/>
      DISPLAY_SPR_1D |   
<br/>
      DISPLAY_SPR_1D_SIZE_128 |
<br/>
      DISPLAY_SPR_1D_BMP
<br/>
                    );
<br/>
videoSetModeSub(  MODE_0_2D | 
<br/>
      DISPLAY_SPR_ACTIVE |
<br/>
      DISPLAY_SPR_1D |
<br/>
      DISPLAY_SPR_1D_SIZE_128 |
<br/>
      DISPLAY_SPR_1D_BMP
<br/>
                    );
<br/>
<br/>
vramSetMainBanks(VRAM_A_MAIN_SPRITE,VRAM_B_MAIN_BG_0x06000000,VRAM_C_SUB_BG,VRAM_D_SUB_SPRITE);</td> </tr></table><span class="postbody">
<br/>
<br/>
I already tried with &lt;DISPLAY_SPR_1D_SIZE_128&gt; and &lt;DISPLAY_SPR_1D_SIZE_256&gt; : it does not chnge anything, i have to set  attribute2 to x4.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#139880 - nce - Tue Sep 11, 2007 4:51 am</h4>
    <div class="postbody"><span class="postbody">that means that the error si somewhere here I guess: 
<br/>
PA_CreateGfx(0, gfx, OBJ_SIZE_32X32, 2)
<br/>
<br/>
I don't know the parameters for that, but I guess that it's not copying the sprite in the correct place on the memory....
<br/>
<br/>
Could be something else, but if changing your memory type don't change your id type that means that something is moving the data somewhere to keep the id type constant ( and then left some white space between each sprite in memory )<br/>_________________<br/>-jerome-</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#139900 - ghuldan - Tue Sep 11, 2007 11:14 am</h4>
    <div class="postbody"><span class="postbody">here is the VRAM viewer of desmume :
<br/>
<a class="postlink" href="http://img374.imageshack.us/my.php?image=tileviewerdj2.png" target="_blank">[img=http://img374.imageshack.us/img374/9809/tileviewerdj2.th.png]</a>
<br/>
<br/>
here is the sprites displayed, with PA_CreateGFX returned values :
<br/>
<a class="postlink" href="http://img205.imageshack.us/my.php?image=desmumeoo2.png" target="_blank">[img=http://img205.imageshack.us/img205/5370/desmumeoo2.th.png]</a>
<br/>
<br/>
here is the sprites displayed, with index X4 in OAMindex :
<br/>
<a class="postlink" href="http://img205.imageshack.us/my.php?image=desmumex4vm5.png" target="_blank">[img=http://img205.imageshack.us/img205/9671/desmumex4vm5.th.png]</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#139957 - nce - Wed Sep 12, 2007 1:11 am</h4>
    <div class="postbody"><span class="postbody">Ok I'm completly out of idea on this one ....
<br/>
<br/>
I can tell you what I do myself and you can check if something come to your mind.
<br/>
<br/>
I'm working only with 256colors sprite never tried 16bit, but I guess there is no difference here ( except you have to multiply by 2 your size )
<br/>
<br/>
so I'm taking a bank for the sprite ( my case bank D for subsprite 128Ko and bank E for main sprite 64Ko )
<br/>
<br/>
take the subsprite case :
<br/>
1st sprite will be written at (bankD + 0)  and attribute2 will receive 0
<br/>
2nd sprite will be written at (bankD + (32*32)) and attribute 2 will receive (32*32 / 128) = 8  ( the 128 comes from the DISPLAY_SPR_1D_SIZE_128 )
<br/>
<br/>
the main screen I do the same except I divide by 64 of course....
<br/>
<br/>
The last guess I can do is this ATTR0_ROTSCALE  doesn't double the size to do the rotation ? ( probably not, if my memory is good it exist also a ATT0_ROTSCALE_DOUBLE_SIZE or something like that )<br/>_________________<br/>-jerome-</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#139997 - ghuldan - Wed Sep 12, 2007 2:10 pm</h4>
    <div class="postbody"><span class="postbody">ATTR0_ROTSCALE does not double the size, ATT0_ROTSCALE_DOUBLE_SIZE does. But theorically it does not affect size of VRAM that is used.
<br/>
<br/>
However i removed ATTR0_ROTSCALE from initialization of my sprites ... and obtained some ugly results : the sprite seems to be displayed in 2d mode .....
<br/>
<a class="postlink" href="http://img255.imageshack.us/my.php?image=desmumewithoutrotox6.png" target="_blank">[img=http://img255.imageshack.us/img255/4662/desmumewithoutrotox6.th.png]</a>
<br/>
<br/>
This one is with the X4 on attr2 index
<br/>
<a class="postlink" href="http://img341.imageshack.us/my.php?image=desmumewithoutrotx4ly4.png" target="_blank">[img=http://img341.imageshack.us/img341/9135/desmumewithoutrotx4ly4.th.png]</a>
<br/>
<br/>
Really weird, i tried too to display a real sprite instead of the red square, the thing that appears where the red square was is the whole new sprite, not a part of it.
<br/>
<a class="postlink" href="http://img259.imageshack.us/my.php?image=desmumewithoutrot2bl7.png" target="_blank">[img=http://img259.imageshack.us/img259/3851/desmumewithoutrot2bl7.th.png]</a>
<br/>
<br/>
<br/>
Since DISPLAY_SPR_1D is the setting for indexed sprite mode
<br/>
I think DISPLAY_SPR_1D_SIZE_128 is too, it would explain why it does not affect 16bits sprites.
<br/>
Plus in libnds/../video.h i saw DISPLAY_SPR_1D_BMP_SIZE_128 and DISPLAY_SPR_1D_BMP_SIZE_256, and i saw a changement on 16bits sprites.
<br/>
<br/>
<br/>
Here is my vramSetMainBanks setting
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">vramSetMainBanks(   VRAM_A_MAIN_SPRITE,        //A and B maped consecutivly as sprite memory
<br/>
                        VRAM_B_MAIN_SPRITE,        //this gives us 256KB which is the max
<br/>
                        VRAM_C_MAIN_BG_0x06000000, //map C to background memory
<br/>
                        VRAM_D_LCD                 //not using D
<br/>
                        );</td> </tr></table><span class="postbody">
<br/>
<br/>
could you tell me how must set the videoMode and how large are VRAM_A and VRAM_B ? Apparently there is 256kb for the sum ...
<br/>
<br/>
Ghuldan ... really most</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
