<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>2 Noob questions regarding sprite rotation - Answered - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > 2 Noob questions regarding sprite rotation - Answered</h2>
<div id="posts">
<div class="post">
    <h4>#136428 - mr_munk - Wed Aug 01, 2007 5:45 pm</h4>
    <div class="postbody"><span class="postbody">Hi,
<br/>
<br/>
I have been working through the 'Introduction to DS Development Tutorial' Chapter six. I wondered if anyone could tell me what the following code in the tutorial is for ? (I added the comments btw)
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">//rotate a sprite
<br/>
void rotateSprite(SpriteRotation * spriteRotation, u16 angle)
<br/>
{
<br/>
   s16 s = -SIN[angle &amp; 0x1FF] &gt;&gt; 4; //bitmask lower 9 bits of u16 (&amp; 0001 1111 1111)
<br/>
                            //then divide Sine by 8
<br/>
   s16 c =  COS[angle &amp; 0x1FF] &gt;&gt; 4; //bitmask lower 9 bits of u16 (&amp; 0001 1111 1111)
<br/>
                            //then divide Cosine by 8
<br/>
<br/>
   spriteRotation-&gt;hdx =  c; 
<br/>
   spriteRotation-&gt;hdy = -s; 
<br/>
   spriteRotation-&gt;vdx =  s; 
<br/>
   spriteRotation-&gt;vdy =  c;
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
Specifically, why is it necessary to bitmask and shift the incoming U16 var angle?
<br/>
<br/>
My second question regards the ATTR1_ROTDATA(n) constant, from the #define in ndslib/video.h I think that this sets the upper 7 bitsof a sprite entry register (?) but what does this mean for the sprites attributes ?
<br/>
<br/>
Any help appreciated - I just want to develop my understanding of what the code I am writing actually does.</span><span class="gensmall"><br/><br/>Last edited by mr_munk on Wed Aug 01, 2007 8:00 pm; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#136431 - Cearn - Wed Aug 01, 2007 7:17 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>mr_munk wrote:</b></span></td> </tr> <tr> <td class="quote">Specifically, why is it necessary to bitmask and shift the incoming U16 var angle?</td> </tr></table><span class="postbody"> For rotation, you need cons and cosine data. Because the C functions for these are slow (<span style="font-style: italic">very</span> slow), libnds uses 512-entry look-up tables instead. The angle is simply the index for the tables. Since reading beyond the boundaries of an array is bad, we take angle%LUTSIZE -- because LUTSIZE is a power of two here, this can be done with an AND instead of a costly modulo. The shift by 4 is required because the NDS affine registers are in 8.8 <a class="postlink" href="http://en.wikipedia.org/wiki/Fixed-point_math" target="_blank">fixed point</a> format, but the arrays are in 4.12.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>mr_munk wrote:</b></span></td> </tr> <tr> <td class="quote">My second question regards the ATTR1_ROTDATA(n) constant, from the #define in ndslib/video.h I think that this sets the upper 7 bits of a sprite entry register (?) but what does this mean for the sprites attributes ?</td> </tr></table><span class="postbody">There are 32 available affine matrices for sprites, and you can select which one a particular sprite uses with bits 8-13 from attribute 1. The ATTR1_ROTDATA() macro just assumes you don't try to use an index over 31.
<br/>
<br/>
For more details, see <a class="postlink" href="http://www.coranac.com/tonc/text/affine.htm" target="_blank">tonc:affine matrix</a> and <a class="postlink" href="http://www.coranac.com/tonc/text/affobj.htm" target="_blank">tonc: affine objects</a>. Yes, those are for GBA, but the NDS has much of the same hardware.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#136434 - mr_munk - Wed Aug 01, 2007 8:00 pm</h4>
    <div class="postbody"><span class="postbody">Excellent, many thanks Cearn :)
<br/>
<br/>
For anyone else searching this topic, I found <a class="postlink" href="http://scholar.hw.ac.uk/site/computing/topic20.asp?outline=url" target="_blank">this</a> tutorial on fixed-point a little  easier to understand as a beginner.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#141118 - jonezer4 - Sat Sep 22, 2007 8:25 am</h4>
    <div class="postbody"><span class="postbody">To resurrect an old topic, I'm having a bit of trouble with this section.
<br/>
<br/>
I think I understand it pretty clearly, however, when I feed an angle into the rotatesprite function, I get unexpected rotations.
<br/>
<br/>
For instance, 90 will result in what appears to be around a 45?.
<br/>
135 looks like about 100?.
<br/>
180 looks like 135?.
<br/>
And so on.
<br/>
<br/>
Am I missing something? I'm using patatersoft's demo as a basis, but I have changed from rotscale_double sprites to just rotscale, is that the problem?
<br/>
<br/>
Pertinent code:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">   for (int n = 0; n &lt; NUM_SPRITES; n++)
<br/>
   {
<br/>
   spriteEntry[n].attribute[0] =     ATTR0_COLOR_256 
<br/>
                           | ATTR0_ROTSCALE   //_DOUBLE 
<br/>
                           | 0;            //Setting Y to zero for now 
<br/>
                           
<br/>
   spriteEntry[n].attribute[1] =     ATTR1_ROTDATA(n)   //Giving each sprite a unique rot value
<br/>
                           | ATTR1_SIZE_64      //sprite size is 64
<br/>
                           | 0;            //Setting X to zero for now
<br/>
            
<br/>
   spriteEntry[n].attribute[2] = spriteGfxID * n;
<br/>
<br/>
   setSpritePriority(&amp;spriteEntry[n],1);            //setting all sprites to lowest priority
<br/>
   
<br/>
   dmaCopy(cards_bin+4096*n,   
<br/>
   &amp;SPRITE_GFX[64*64/2 * n],                     // div. by 2 because of 16bit addressing
<br/>
   64*64);
<br/>
   
<br/>
   hideSprite(&amp;spriteEntry[n], true);               //hide all sprites upon initialization
<br/>
<br/>
   rotateSprite(&amp;spriteRotation[n], 135);
<br/>
<br/>
<br/>
   }</td> </tr></table><span class="postbody">
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void rotateSprite(SpriteRotation * spriteRotation, u16 angle)
<br/>
{
<br/>
<br/>
   s16 s = -SIN[angle &amp; 0x1FF] &gt;&gt; 4;            
<br/>
   s16 c =  COS[angle &amp; 0x1FF] &gt;&gt; 4;                                 
<br/>
   spriteRotation-&gt;hdx =  c;
<br/>
   spriteRotation-&gt;hdy = -s;
<br/>
   spriteRotation-&gt;vdx =  s;
<br/>
   spriteRotation-&gt;vdy =  c;
<br/>
}</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#141120 - Corsix - Sat Sep 22, 2007 9:29 am</h4>
    <div class="postbody"><span class="postbody">You seem to be making the assumption that angle is given in degrees.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#141123 - jonezer4 - Sat Sep 22, 2007 10:10 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Corsix wrote:</b></span></td> </tr> <tr> <td class="quote">You seem to be making the assumption that angle is given in degrees.</td> </tr></table><span class="postbody">
<br/>
<br/>
I thought it was? I tried rads and that didn't appear to work out either.
<br/>
<br/>
1.57 rotates them just barely, which to my understanding would equate to 90? degrees. 3.14 rotates them just a hair more, which would be 180?, right?
<br/>
<br/>
I've also tried 157, thinking maybe the u16 is an int that wants rads not in floating point form, but that doesn't work either, looks like about 120? then.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#141134 - Cearn - Sat Sep 22, 2007 1:09 pm</h4>
    <div class="postbody"><span class="postbody">The libnds LUTs for sines and cosines divide the circle into 512 units, not 360 or 2π (powers of two are easier to deal with, that's why). Don't think in terms of degrees, but in circle-fractions: a full rotation is 512 (0x200), half rotation is 256 (0x100), etc. 45? is an eighth of a circle, so that's 64 (0x40).</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#141137 - jonezer4 - Sat Sep 22, 2007 1:44 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Cearn wrote:</b></span></td> </tr> <tr> <td class="quote">The libnds LUTs for sines and cosines divide the circle into 512 units, not 360 or 2π (powers of two are easier to deal with, that's why). Don't think in terms of degrees, but in circle-fractions: a full rotation is 512 (0x200), half rotation is 256 (0x100), etc. 45? is an eighth of a circle, so that's 64 (0x40).</td> </tr></table><span class="postbody">
<br/>
<br/>
Ah great, thank you! I think I recall now a 512 actually being in there at some point, don't know how that got lost, but thanks very much.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#141158 - tepples - Sat Sep 22, 2007 7:17 pm</h4>
    <div class="postbody"><span class="postbody">Previous discussion: <a class="postlink" href="http://forum.gbadev.org/viewtopic.php?p=60636#60636" target="_blank">brads</a><br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
