<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Stencil Shadow Casting - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>DS development > Stencil Shadow Casting</h2>
<div id="posts">
<div class="post">
    <h4>#159631 - zeruda - Thu Jul 03, 2008 6:33 am</h4>
    <div class="postbody"><span class="postbody">I'm trying to get shadow casting using the hardware working but it eludes me. Here is what I am doing so far:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
    glPushMatrix();
<br/>
        BoxPos = CharacterPosition;
<br/>
        glColor3f(1,0,0);
<br/>
        glPolyFmt(POLY_ALPHA(1) | POLY_SHADOW | (1&lt;&lt;14));
<br/>
        DrawOutCube(0, 0.03, BoxPos);
<br/>
    glPopMatrix(1);
<br/>
<br/>
    glPolyFmt(POLY_ALPHA(30) | CULL_BACK | POLY_ID(8) | LIGHT_0);
<br/>
    glPushMatrix();
<br/>
        BoxPos.z -= 0.1;
<br/>
        glColor3f(0,1,0);
<br/>
        DrawOutCube(0, 0.03, BoxPos); // &lt;draw quad&gt;
<br/>
    glPopMatrix(1);
<br/>
<br/>
    glPushMatrix();
<br/>
        glColor3f(0.9,0.9,0.9);
<br/>
        BoxPos = CVector(4.0, 0.0, 0.0);
<br/>
        glPolyFmt(SETALPHA(30) | CULL_BACK | POLY_ID(12) | LIGHT_0);
<br/>
        DrawOutCube(0, 3, BoxPos); // 100 times the other cubes size
<br/>
    glPopMatrix(1);
<br/>
<br/>
    glColor3f(1,1,1);
<br/>
    glPolyFmt(SETALPHA(30) | POLY_FOG | CULL_BACK | LIGHT_0 | POLY_ID(17));
<br/>
    glPushMatrix();
<br/>
        Texture.Bind(Texture.texture[0]);
<br/>
        DrawLandscape()
<br/>
    glPopMatrix(1);
<br/>
<br/>
    Texture.Bind(Texture.texture[1]);
<br/>
    glPushMatrix();     // Draw Kazir
<br/>
        glPolyFmt(SETALPHA(30) | POLY_FOG | CULL_BACK | LIGHT_0 | POLY_ID(11));
<br/>
        DrawCharacter();
<br/>
    glPopMatrix(1);
<br/>
<br/>
    glFlush(GL_TRANS_MANUALSORT | GL_WBUFFERING);
<br/>
    // or glFlush(GL_TRANS_MANUALSORT);
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
So theres a character that moves around. A shadow box that surrounds the character. A normal box offset on the z axis to the character. A terrain, and a giant box.
<br/>
<br/>
I get some strange results.
<br/>
The character and terrain show as normal.
<br/>
The shadow box is invisible and does nothing.
<br/>
The giant box which should be white is normally invisible, but if I move so that it is in between the camera and the terrain, it is clipped to the terrain by the stencil. So where there is no terrain the box is invisible, where there is terrain I can see white.
<br/>
The same happens with the character.
<br/>
The other green box is stencilled to the terrain. So if in the sky it is invisible, any parts overlapping the terrain green shows. If both the white and green box overlap, they are invisible, and if they both overlap the terrain the white box wins the fight and white shows.
<br/>
<br/>
Any suggestions on what I'm doing wrong? I get some sort of stencilling, but no projection of any kind of shadows. Is the algorithm/approach correct? 
<br/>
<br/>
Thanks</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#159641 - ritz - Thu Jul 03, 2008 2:25 pm</h4>
    <div class="postbody"><span class="postbody">You need to draw the shadow twice, culled differently in the following order:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">... some code ...
<br/>
<br/>
GFX_POLY_FORMAT = POLY_SHADOW | POLY_CULL_FRONT | V_POLY_ALPHA(plya) | BIT(12) | BIT(13) | POLY_FOG | V_POLY_ID(0);
<br/>
v_drawvoid(pso-&gt;svdp);
<br/>
<br/>
GFX_POLY_FORMAT = POLY_SHADOW | POLY_CULL_BACK | V_POLY_ALPHA(plya) | BIT(12) | BIT(13) | POLY_FOG | V_POLY_ID(scpid);
<br/>
v_drawvoid(pso-&gt;svdp);
<br/>
<br/>
... more code ...</td> </tr></table><span class="postbody">
<br/>
This is just a copy and paste from my stuff. You probably don't need the other things depending on your program.
<br/>
<br/>
Oh, and you need to use glFlush(GL_TRANS_MANUALSORT);</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#159649 - silent_code - Thu Jul 03, 2008 2:58 pm</h4>
    <div class="postbody"><span class="postbody">Did you see my "Volumetric Shadow Demo"? It's on my website, sources and builds are available, along with a little tutorial. I hope that helps. :^)
<br/>
<br/>
Could you post any images? It sounds like you are setting the attributes wrong, but I am not sure.<br/>_________________<br/><span style="font-size: 9px; line-height: normal"><span style="text-decoration: underline"><span style="font-weight: bold"></span></span> July 5th 08: "<span style="font-weight: bold">Volumetric Shadow Demo</span>" 1.6.0 (final) source released
<br/>
June 5th 08: "<span style="font-weight: bold">Zombie NDS</span>" WIP released!
<br/>
It's all on my page, just click <span style="font-weight: bold">WWW</span> below.</span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#159659 - zeruda - Thu Jul 03, 2008 7:28 pm</h4>
    <div class="postbody"><span class="postbody">I've already got predefined volumetric meshes working. I was misunderstanding while experimenting. What I want to do is project the shadow of a character onto a 3D terrain. Once I've done that then the stencil would clip it onto the terrain accurately. So what I'm missing is dynamically generating a volumetric mesh.
<br/>
<br/>
Would I have to do it in "software" as in calculate the individual vertices of a shadow volume?
<br/>
<br/>
Or is it possible to change some status settings, maybe load a light matrix of some kind and then fire my normal character mesh and let the DS do it? (if that makes sense)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#159662 - silent_code - Thu Jul 03, 2008 9:20 pm</h4>
    <div class="postbody"><span class="postbody">You could render the same mesh, but with a "squish" matrix. ;^)
<br/>
That means the matrix would either (simple case) "eliminate" the Y coordinate by setting all (local model space) Ys to 0 (and then displace the mesh accordingly, so that it appears on the *flat* ground) or (more complex case) the matrix would procect all vertices to the plane defined by the ground's normal...
<br/>
Effectively, you would have to define some oriented "flat space" with some "cool" base vectors and all that maps a volume onto a plane. ;^)
<br/>
<br/>
You just have to look up shadow projection on the web and you'll find a ton of implementations with free sources.
<br/>
<br/>
Good luck. :^)<br/>_________________<br/><span style="font-size: 9px; line-height: normal"><span style="text-decoration: underline"><span style="font-weight: bold"></span></span> July 5th 08: "<span style="font-weight: bold">Volumetric Shadow Demo</span>" 1.6.0 (final) source released
<br/>
June 5th 08: "<span style="font-weight: bold">Zombie NDS</span>" WIP released!
<br/>
It's all on my page, just click <span style="font-weight: bold">WWW</span> below.</span></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
