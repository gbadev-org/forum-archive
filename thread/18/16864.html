<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>libz (zlib) uncompress() problems - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > libz (zlib) uncompress() problems</h2>
<div id="posts">
<div class="post">
    <h4>#170304 - sverx - Wed Sep 16, 2009 2:46 pm</h4>
    <div class="postbody"><span class="postbody">Hi!
<br/>
  is there anybody who's using libz (zlib port to NDS) <span style="font-style: italic">uncompress()</span> function? I'm experiencing strange problems with it... (the decompression seems to work ok but the function gives error instead...)
<br/>
<br/>
I'm using version 1.2.3, which I guess is the latest.
<br/>
<br/>
Thanks!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170310 - kusma - Wed Sep 16, 2009 3:34 pm</h4>
    <div class="postbody"><span class="postbody">What's wrong with using plain old zlib and it's deflate()-function?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170311 - sverx - Wed Sep 16, 2009 3:42 pm</h4>
    <div class="postbody"><span class="postbody">I was searching the easier way to decompress a small amount of data (some KB) that it's already in memory, and I've read <a class="postlink" href="http://www.zlib.net/manual.html#uncompress" target="_blank">this</a> about uncompress() function.
<br/>
<br/>
Do you suggest using another way? I'm a complete newbie on that...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170313 - kusma - Wed Sep 16, 2009 4:07 pm</h4>
    <div class="postbody"><span class="postbody">Nah, it should probably be OK. But my guess would be that some of the parameters are wrong - what error do you get?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170316 - FluBBa - Wed Sep 16, 2009 5:00 pm</h4>
    <div class="postbody"><span class="postbody">I used "puff" (as I also wanted to decompress from RAM to RAM) which is some kind of school example on how zlib compression works.<br/>_________________<br/>I probably suck, my not is a programmer.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170337 - sverx - Thu Sep 17, 2009 9:01 am</h4>
    <div class="postbody"><span class="postbody">kusma: I'm getting Z_DATA_ERROR, which should mean that my input stream (the compressed data) is 'bad'. But now I'm thinking it's a CRC problem, going to run some tests today...
<br/>
<br/>
About 'puff'... well, I didn't know that. But it says it's slower... thanks fluBBa for the advice anyway :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170339 - sverx - Thu Sep 17, 2009 11:56 am</h4>
    <div class="postbody"><span class="postbody">well, it seems to me that the problem is that the uncompress() functions uses inflate() functions that compute a so called 'adler32' crc but my data ends with a 'normal' crc32.
<br/>
<br/>
I think I'm going to modify the library source... or is that something important I am missing? I've got a strange feeling...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170341 - sverx - Thu Sep 17, 2009 2:17 pm</h4>
    <div class="postbody"><span class="postbody">Ok, I'm really lacking ideas. Maybe I can borrow someone else ideas?
<br/>
<br/>
I've got a .gz file already loaded in RAM (I don't want to use filesystems for this project) and I want to uncompress the file that there's in it.
<br/>
<br/>
zlib gives functions to access a .gz file, but on filesystems.
<br/>
<br/>
zlib gives functions to uncompress from memory to memory, but it doesn't work with my .gz file as it is. But if I remove the .gz header (the first 10 bytes) and I add a custom header (two bytes) then I can uncompress the file that there's in it: it's correct and it's also fast. But the function complains that it's failing (I guess it's because of the different type of CRC at the end of the data)
<br/>
<br/>
Any help?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170353 - sverx - Fri Sep 18, 2009 9:26 am</h4>
    <div class="postbody"><span class="postbody">Ok, it turns out that maybe there's a bug somewhere in the zlib code... or in the port maybe?...
<br/>
<br/>
I've read the sources and I understood uncompress() should be able to work on a gz file too: it uses inflate() which checks for gz headers... but it's failing at this. So I changed one line (in inflate.c) from
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">if ((state-&gt;wrap &amp; 2) &amp;&amp; hold == 0x8b1f) {  /* gzip header */</td> </tr></table><span class="postbody">
<br/>
<br/>
to
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">if (hold == 0x8b1f) {  /* gzip header */</td> </tr></table><span class="postbody">
<br/>
<br/>
and now it works correctly. Decodes the .gz file perfectly and returns no error. BTW I stil don't know why it works now and what was the meaning of that code I removed.
<br/>
<br/>
So I'm leaving it here, maybe somebody has a comment to add...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170369 - headspin - Sat Sep 19, 2009 7:07 pm</h4>
    <div class="postbody"><span class="postbody">I think there must be a problem with this lib on the DS or there is something else were missing. Your right though changing that line and it works.<br/>_________________<br/><a class="postlink" href="http://headsoft.com.au/index.php?category=warhawk" target="_blank">Warhawk DS</a> | <a class="postlink" href="http://headsoft.com.au/index.php?category=mmll" target="_blank">Manic Miner: The Lost Levels</a> | <a class="postlink" href="http://headsoft.com.au/index.php?category=tdg" target="_blank">The Detective Game</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170418 - wintermute - Tue Sep 22, 2009 10:12 am</h4>
    <div class="postbody"><span class="postbody">Are you sure you're not missing something here?
<br/>
<br/>
That sounds rather like you're not preparing the compressed data in a supported manner.<br/>_________________<br/><a class="postlink" href="http://www.devkitpro.org/" target="_blank">devkitPro - professional toolchains at amateur prices</a>
<br/>
<a class="postlink" href="http://wiki.devkitpro.org/index.php/IRC" target="_blank">devkitPro IRC support</a>
<br/>
<a class="postlink" href="http://davejmurphy.com/" target="_blank">Personal Blog</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170419 - sverx - Tue Sep 22, 2009 11:14 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>wintermute wrote:</b></span></td> </tr> <tr> <td class="quote">Are you sure you're not missing something here?</td> </tr></table><span class="postbody">
<br/>
<br/>
No, I'm not sure unfortunatly.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>wintermute wrote:</b></span></td> </tr> <tr> <td class="quote">That sounds rather like you're not preparing the compressed data in a supported manner.</td> </tr></table><span class="postbody">
<br/>
<br/>
zlib documentation also says, about <a class="postlink" href="http://www.zlib.net/manual.html#uncompress" target="_blank">uncompress()</a>:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">This function can be used to decompress a whole file at once if the input file is mmap'ed.</td> </tr></table><span class="postbody">
<br/>
and I think this means something like "if you've got a <span style="font-weight: bold">gz</span> file somewhere in your memory you can use this function to decompress it".
<br/>
<br/>
Of course maybe I'm not following the correct procedure... in fact for instance I'm not calling gzopen() or gzread() since I'm not using a filesystem... maybe inflate() was expecting me to do that before using it for decompressing a gz file?
<br/>
<br/>
I don't know. What I do know is that in inflate() function source there's the code needed for decoding all the gz headers... but it won't be executed if you don't remove that
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">(state-&gt;wrap &amp; 2)</td> </tr></table><span class="postbody">
<br/>
check.
<br/>
<br/>
Finally, I'm also sure that the gz file I prepare (using -nv9 command line options) it's correct: I checked his header with an hex editor comparing it to what's expected (<a class="postlink" href="http://www.faqs.org/rfcs/rfc1952.html" target="_blank">RFC 1952</a>) and, most important, I get it decompressed perfectly after all!
<br/>
<br/>
No more ideas, personally.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170421 - SteveH - Tue Sep 22, 2009 11:48 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>sverx wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>wintermute wrote:</b></span></td> </tr> <tr> <td class="quote">Are you sure you're not missing something here?</td> </tr></table><span class="postbody">
<br/>
Of course maybe I'm not following the correct procedure... in fact for instance I'm not calling gzopen() or gzread() since I'm not using a filesystem... maybe inflate() was expecting me to do that before using it for decompressing a gz file?
<br/>
<br/>
I don't know. What I do know is that in inflate() function source there's the code needed for decoding all the gz headers... but it won't be executed if you don't remove that
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">(state-&gt;wrap &amp; 2)</td> </tr></table><span class="postbody">
<br/>
check.
<br/>
<br/>
Finally, I'm also sure that the gz file I prepare (using -nv9 command line options) it's correct: I checked his header with an hex editor comparing it to what's expected (<a class="postlink" href="http://www.faqs.org/rfcs/rfc1952.html" target="_blank">RFC 1952</a>) and, most important, I get it decompressed perfectly after all!
<br/>
<br/>
No more ideas, personally.</span></td> </tr></table><span class="postbody">
<br/>
<br/>
I know that in the zip library I used on a project on windows you had to call the zipOpen() functions even on a memory mapped file as it setup some initial pointers in a handler with offsets to the zip file list, etc.  Try going though the correct process from open to close, if your still experiencing issues then something is wrong with your zip file or your zlib implementation.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170422 - sverx - Tue Sep 22, 2009 12:04 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>SteveH wrote:</b></span></td> </tr> <tr> <td class="quote">Try going though the correct process from open to close, if your still experiencing issues then something is wrong with your zip file or your zlib implementation.</td> </tr></table><span class="postbody">
<br/>
<br/>
How can I open my gz file which is already in memory? zlib has got gzopen() function, which wants a path to the file (so I think this requires a filesystem) and gzdopen() which requires a file descriptor, that I do not have of course. Is there some function I'm missing?
<br/>
<br/>
Thanks!</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
