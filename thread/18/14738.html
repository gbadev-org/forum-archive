<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Odd problems connecting to a web host from the DS. - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>DS development > Odd problems connecting to a web host from the DS.</h2>
<div id="posts">
<div class="post">
    <h4>#147847 - chatterbug89 - Sat Dec 29, 2007 1:22 am</h4>
    <div class="postbody"><span class="postbody">EDIT2:  After a few hours, it seems to be working again how it use to work on the DS.  Though, this behavior still seems weird considering it worked on multiple computers just fine (all of my network).
<br/>
<br/>
I am working on a project for the Nintendo DS that communicates with a PHP script on my host.  Things were working perfectly for the most part but now suddenly my program cannot communicate with my host at all.
<br/>
<br/>
First of all, before I continue, I should note I'm using PA_Lib and it's PA_GetHTTP function.  
<br/>
<br/>
Now, here's what's really weird.  Placing the script on my personal server and having the DS execute it works great, but it just hangs when executing the exact same script on my server (that use to work yesterday).  Running the PHP script from my browser works perfectly on the other hand.
<br/>
<br/>
Another odd thing that I have had to deal with is PA_GetHTTP seems to return some "junk" about the length of the incomming data when receiving data from the host in question (which is Total Choice Hosting).  However, this extra data doesn't seem to be present when getting pages from my personal server and this extra data never shows up when using a web browser.
<br/>
<br/>
I'm just completely stumped as to why my host would be giving me such weird problems.  I may just end up finding somewhere else to host my PHP app that communicates with my project (my personal server's connection is a tad slow and unreliable...).
<br/>
<br/>
Here is the PA_Lib function in question....the problem most likly lies in it.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
int PA_GetHTTP(char *buffer, char *adress)
<br/>
{
<br/>
    int sock;
<br/>
    char serveur[256];
<br/>
    char buffer3[256];
<br/>
    int pos = get_HTTP_serveur(serveur,adress);
<br/>
    PA_InitSocket(&amp;sock,serveur,80,PA_NONBLOCKING_TCP);
<br/>
    char buffer2[256];
<br/>
    sprintf(buffer2, "GET %s HTTP/1.1\r\nhost: %s\r\nAccept: */*\r\n\r\n",adress+pos,serveur);
<br/>
    send(sock,buffer2,256,0);
<br/>
    strcpy(buffer,"");
<br/>
    while(search_word(buffer3,"\r\n\r\n",0) == -1)
<br/>
    {
<br/>
       memset(buffer3,0,sizeof(buffer3));
<br/>
       recv(sock,buffer3,256,0);
<br/>
    }
<br/>
    int poshtml = search_word(buffer3,"\r\n\r\n",0)+4;
<br/>
    strcat(buffer,buffer3+poshtml);
<br/>
    while(search_word(buffer,"&lt;/html&gt;",0) == -1 &amp;&amp; search_word(buffer,"&lt;/HTML&gt;",0) == -1)
<br/>
    {
<br/>
    memset(buffer3,0,sizeof(buffer3));
<br/>
    if(recv(sock,buffer3,256,0)&lt;1)
<br/>
       break;
<br/>
    strcat(buffer,buffer3);
<br/>
    }
<br/>
    if(sock) closesocket(sock);
<br/>
       //closesocket(sock);
<br/>
   return 1;
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
int get_HTTP_serveur(char *buffer, char *buffer2)
<br/>
{
<br/>
    int i,depart=0;
<br/>
    if(search_word(buffer2,"http://",0)!=-1)
<br/>
       depart+=7;
<br/>
    for(i = depart; buffer2[i] != '\0' &amp;&amp; buffer2[i] != '/' &amp;&amp; buffer2[i] != '\\'; i++)
<br/>
    {
<br/>
          buffer[i-depart]=buffer2[i];
<br/>
    }
<br/>
    buffer[i-depart]='\0';
<br/>
return i;
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
int search_word(char *mot1, char *mot2, int depart){
<br/>
   int i,j,erreur=1;
<br/>
   for(i=depart;i&lt;strlen(mot1);i++){
<br/>
   
<br/>
      if(mot1[i]==mot2[0]){
<br/>
         erreur=0;
<br/>
         
<br/>
         for(j=0;j&lt;strlen(mot2);j++) 
<br/>
            if(mot2[j]!=mot1[i+j]) 
<br/>
               erreur=1;
<br/>
               
<br/>
         if(erreur==0)
<br/>
            return i;
<br/>
      }
<br/>
   }
<br/>
   return -1;
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
int PA_InitSocket(int *sock,char *host,int port,int mode)
<br/>
{
<br/>
     unsigned long ip;
<br/>
     struct     sockaddr_in    servaddr;   
<br/>
     *sock = socket(AF_INET, SOCK_STREAM, 0);
<br/>
     if(IS_INETADDR(host))
<br/>
       ip = PA_chartoip(host);
<br/>
     else
<br/>
       ip = *(unsigned long *)gethostbyname(host)-&gt;h_addr_list[0];
<br/>
       
<br/>
     servaddr.sin_family = AF_INET;
<br/>
     servaddr.sin_port = htons(port);     
<br/>
     servaddr.sin_addr.s_addr = ip;
<br/>
     
<br/>
     if(mode == PA_NORMAL_TCP)
<br/>
     {
<br/>
     if(connect(*sock, (struct sockaddr *) &amp;servaddr, sizeof(servaddr))==0)
<br/>
        return 1;
<br/>
     }
<br/>
     else if(mode == PA_NONBLOCKING_TCP)
<br/>
     {
<br/>
     if(connect(*sock, (struct sockaddr *) &amp;servaddr, sizeof(servaddr))==0)
<br/>
        {
<br/>
        int i = 1;
<br/>
        ioctl(*sock, FIONBIO, &amp;i);
<br/>
        return 1;
<br/>
        }
<br/>
     }
<br/>
     
<br/>
        
<br/>
return 0;
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Any suggestions, tips, or help would be appreciated.  The site in question where the file is hosted is at cybernetresources.com.
<br/>
<br/>
EDIT:  I have done numerous tests by just calling PA_GetHTTP and the bare-bones of what needs to be called to get things up and running.  So...the problem shouldn't lie in my code at all.  PA_GetHTTP simply hangs when it tries to get pages from my host.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#147875 - tepples - Sat Dec 29, 2007 5:41 pm</h4>
    <div class="postbody"><span class="postbody">Your description of the response as "some 'junk' about the length of the incomming data" makes me think it has something to do with <a class="postlink" href="https://developers.sun.com/mobility/midp/questions/chunking/" target="_blank">HTTP/1.1 chunked encoding</a>, which HTTP servers use when they don't know how big the Content-Length will be. Does PA_GetHTTP support this?<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#147879 - chatterbug89 - Sat Dec 29, 2007 6:09 pm</h4>
    <div class="postbody"><span class="postbody">I used <a href="http://web-sniffer.net/" target="_blank">http://web-sniffer.net/</a> to check out what was being sent in the header of my site (and specifically, with the script I'm talking with), and it does seem to be chuked.
<br/>
<br/>
All PA_Gethttp seems to be doing is reading from the response untill it no longer finds \r\n\r\n in the input, which it must assume is the end of the header and the beginning of the content.  So, after that, there is the chunk information, something like 5     Content bla bla bla   0.  This isen't a huge deal, since all I have to do is clear out the first number(s) and spaces, and get rid of the end (which I have already done and it works how it should for me).  I have no clue why it's looking for &lt;/html&gt; (not having any of those tags in the response doesn't mess up anything from what I can see...adding them does mess up things though).
<br/>
<br/>
This doesn't explain the weird "dead periods" my server is giving me with just my DS every so often.  I suppose it could have been a passing thing or my router was just acting up (though, I also tried it in an emulator supporting wifi and it didn't work during those times either...).
<br/>
<br/>
Anyways, I think we can safely conclude that PA_GetHTTP doesn't properly support chunking.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#147886 - thegamefreak0134 - Sat Dec 29, 2007 9:59 pm</h4>
    <div class="postbody"><span class="postbody">What you might try is doing an HTTP 1.0 request, instead of a 1.1 request. Chunking support was added with the 1.1 standard, and I've found that doing an HTTP 1.0 request will cause the web server not to send data this way. However, depending on how PAlib is set up, you may have to use it's lower functions to send a request out this way. (Or you could just mod your copy of the function.) This will also cause the server to not default to sending compressed data, which has given me issues in the past.
<br/>
<br/>
-gamefreak<br/>_________________<br/>What if the hokey-pokey really is what it's all about?
<br/>
<br/>
[url=http:/www.darknovagames.com/index.php?action=recruit&amp;clanid=1]Support Zeta on DarkNova![/url]</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
