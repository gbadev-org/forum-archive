<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>GDB stub for Desmume - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>DS development > GDB stub for Desmume</h2>
<div id="posts">
<div class="post">
    <h4>#110574 - masscat - Wed Nov 29, 2006 12:19 pm</h4>
    <div class="postbody"><strong class="text-strong">PLEASE NOTE:</strong>The GDB stub in desmume discussed in this thread is old, you can find information on a newer version <a class="postlink" href="http://forums.desmume.org/viewtopic.php?id=85">here</a>.<br/>
<br/>
I have added a GDB stub to desmume so you can now use it to do debugging on your PC.<br/>
<strong class="text-strong">Currently it has only been integrated into the GTK version of desmume (linux only? - other builds are likely to be broken and not build/run).</strong><br/>
The stub can only do stepping, instruction breakpoints, continue and stopping a running target. There is no setting register and memory values or memory watchpoints yet.<br/>
One reason I developed this was to provide a tool to investigate the NDS itself, i.e. stepping through code to see how it sets things up.<br/>
<br/>
<strong class="text-strong">EDIT:</strong> If you use Windows you can get a binary from <a class="postlink" href="http://masscat.afraid.org/ninds/bins/desmume_gdbstub.zip">here</a>. The patch below does not contain the Windows code.<br/>
<br/>
<strong class="text-strong">Building and patching Desmume source</strong><br/>
You need to get and be able to build the Desmume for he sourceforge repository. When asked for a password by cvs just hit return. Change to tthe directory where you want the desmume source to be placed and do the following.
<div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code> cvs -d&amp;#58;pserver&amp;#58;anonymous@desmume.cvs.sourceforge.net&amp;#58;/cvsroot/desmume login
 cvs -z3 -d&amp;#58;pserver&amp;#58;anonymous@desmume.cvs.sourceforge.net&amp;#58;/cvsroot/desmume co -D 2006-11-27 -P desmume
</code></pre></div>
This will create a copy of the desmume source with files no later than their 2006-11-27 version, i.e. the same source as the gdb stub is being developed against. Make sure that you can build the source by running the <em class="text-italics">configure</em> script in the <em class="text-italics">desmume</em> directory - resolve any missing libraries and the like until the script completes successfully.<br/>
<br/>
Download the <a class="postlink" href="http://masscat.afraid.org/ninds/tars/desmume_gdbstub_20061129.tar.bz2">tarball</a> containing the gdbstub code and patch. Change into the <em class="text-italics">desmume</em> directory and extract the tarball.
<div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>tar -xvjf path_to_tarball/desmume_gdbstub_20061129.tar.bz2</code></pre></div>
This will create the <em class="text-italics">src/gdb_stub</em> directory and its contents and the <em class="text-italics">gdbstub_20061129.patch</em> patch file. Finally run the patch file to patch the desmume source.
<div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>patch -p0 &lt;gdbstub_20061129.patch</code></pre></div>
Rerun the <em class="text-italics">configure</em> script and type <em class="text-italics">make</em> to build the GDB stub enabled Desmume.<br/>
<br/>
<strong class="text-strong">Using the GDB stub</strong><br/>
The GDB stub creates two TCP sockets for GDB to connect to. The one at port 20000 is for the ARM7 and the one at port 20001 is for the ARM9 (only the ARM9 stub is active as delivered - to disable/enable the stub for each ARM edit <em class="text-italics">/src/gtk/main.c</em> at line 1313. This shows the ARM9 been activated).<br/>
Run <em class="text-italics">desmume</em> and load the <em class="text-italics">.nds</em> file you wish to debug. Press the <em class="text-italics">play</em> button. The emulation will start running but nothing will appear on screen as the ARM9 is stalled until GDB connects and tells it to run.<br/>
Get yourself a ARM aware version of GDB or Insight (see <a class="postlink" href="http://forum.gbadev.org/viewtopic.php?t=10765">here</a> and <a class="postlink" href="http://masscat.afraid.org/ninds/debug_stub.php">here</a> for info on how to get one or build one). Run GDB with the <em class="text-italics">.elf</em> ile corresponding to the ARM9 code (optional) and connect to the stub as follows.
<div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>target remote 127.0.0.1&amp;#58;20001</code></pre></div>
If you issue the <em class="text-italics">continue</em> command desmume will leap into life. You can now debug to your heart's delight.</div>    
</div>
<div class="post">
    <h4>#110627 - GPFerror - Thu Nov 30, 2006 12:13 am</h4>
    <div class="postbody">awesome work, wish I had a way to run this, i took a look at trying to get it working on windows but I haven't been able to get the gtk/sdl version to build on windows, and then the matter of converting the linux socket code to winsock is beyond my experience unfortunetly.<br/>
<br/>
<br/>
Troy(GPF)</div>    
</div>
<div class="post">
    <h4>#110661 - Ryan FB - Thu Nov 30, 2006 4:50 am</h4>
    <div class="postbody">Thanks, this is working great for me so far. I can see it being very useful for development.<br/>
<br/>
Is there any way to suppress the packet debugging information? I tried playing with "set debug remote" and the various other debug variables in gdb but wasn't able to turn it off.</div>    
</div>
<div class="post">
    <h4>#110683 - masscat - Thu Nov 30, 2006 11:47 am</h4>
    <div class="postbody"><blockquote><div><cite>Ryan FB wrote:</cite>Is there any way to suppress the packet debugging information?</div></blockquote>
If you mean the stuff like:
<div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>Processing packet ?
Putting packet size 3 S05
Processing packet H
Putting packet size 0
Processing packet g</code></pre></div>
The only way to stop that is to edit <em class="text-italics">src/gdb_stub/gdbstub.c</em> and comment out any <em class="text-italics">LOG</em> calls. Since this is still in development I have not gone through and removed them.<br/>
<blockquote><div><cite>GPFerror wrote:</cite>... and then the matter of converting the linux socket code to winsock</div></blockquote>
From a quick look at winsock, I believe the conversion should not be too hard as the calls are similar.<br/>
The trickier part is the Emulation to GDB stub thread communications. Under Linux this is done using a pipe. This is nice and easy and means the GDB stub thread has a single wait point, the call to <em class="text-italics">select</em>. Under Windows, I believe, this pipe would need to be a socket in order to be used with the <em class="text-italics">select</em> call. This creates a complication as a thread would be required for creating this communications socket.<br/>
There may be a better way of doing this under Windows and still leave the GDB stub code similar between both versions.</div>    
</div>
<div class="post">
    <h4>#110703 - masscat - Thu Nov 30, 2006 7:55 pm</h4>
    <div class="postbody"><a class="postlink" href="http://masscat.afraid.org/ninds/bins/desmume_gdbstub.zip">Here</a> is a binary for you lucky Windows users out there.<br/>
Works for me on a Windows XP machine and, strangely enough, under WINE on Linux.</div>    
</div>
<div class="post">
    <h4>#110724 - GPFerror - Thu Nov 30, 2006 11:57 pm</h4>
    <div class="postbody"><blockquote><div><cite>masscat wrote:</cite><a class="postlink" href="http://masscat.afraid.org/ninds/bins/desmume_gdbstub.zip">Here</a> is a binary for you lucky Windows users out there.<br/>
Works for me on a Windows XP machine and, strangely enough, under WINE on Linux.</div></blockquote>

cool works great, just as I finally got the gtk build working on windows and was about to apply your patch lol and try to learn sockets :)<br/>
<br/>
the gtk version on windows is extremly slow, look forward to your source diffs for gdb :)<br/>
<br/>
Thanks,<br/>
Troy(GPF)</div>    
</div>
<div class="post">
    <h4>#110772 - masscat - Fri Dec 01, 2006 12:38 pm</h4>
    <div class="postbody"><a class="postlink" href="http://masscat.afraid.org/ninds/tars/desmume_win_gdbstub.tar.bz2">Here</a> is a patch for the Windows version of the source (should work for both Windows and Linux). This is against the main Desmume CVS dated 2006-11-27.<br/>
<br/>
Having posted over on the Desmume sourceforge forums it looks like the GDB stub code may get put into the main CVS (after a bit of tweaking and tidying). If this happens I will not post further source changes here.</div>    
</div>
<div class="post">
    <h4>#110794 - GPFerror - Fri Dec 01, 2006 4:44 pm</h4>
    <div class="postbody"><blockquote><div><cite>masscat wrote:</cite><a class="postlink" href="http://masscat.afraid.org/ninds/tars/desmume_win_gdbstub.tar.bz2">Here</a> is a patch for the Windows version of the source (should work for both Windows and Linux). This is against the main Desmume CVS dated 2006-11-27.<br/>
<br/>
Having posted over on the Desmume sourceforge forums it looks like the GDB stub code may get put into the main CVS (after a bit of tweaking and tidying). If this happens I will not post further source changes here.</div></blockquote>

great job, thanks again for all your gdb work in hardware as well :)<br/>
<br/>
Troy(GPF)</div>    
</div>
<div class="post">
    <h4>#118246 - masscat - Sun Feb 11, 2007 2:51 pm</h4>
    <div class="postbody">Been working of the DeSmuME GDB stub again. This version should be better (can step code and not go stepping into the interrupt handler).<br/>
<br/>
Go to the <a class="postlink" href="http://desmume.sourceforge.net/forums/index.php?action=vthread&amp;forum=1&amp;topic=144">DeSmuME forums</a> for further info and download.</div>    
</div>
<div class="post">
    <h4>#126550 - masscat - Tue Apr 24, 2007 12:07 pm</h4>
    <div class="postbody">I have updated the <a class="postlink" href="http://forums.desmume.org/viewtopic.php?id=85">GDB stub in Desmume</a>.<br/>
<br/>
Please use, test and post comments over on the <a class="postlink" href="http://forums.desmume.org/viewtopic.php?id=85">Desmume forums</a>.</div>    
</div>
<div class="post">
    <h4>#126553 - LiraNuna - Tue Apr 24, 2007 12:21 pm</h4>
    <div class="postbody">holy shit batman!<br/>
Great work!</div>    
</div>
<div class="post">
    <h4>#126658 - Jevin - Wed Apr 25, 2007 6:59 pm</h4>
    <div class="postbody">thank you so much! :D</div>    
</div>
<div class="post">
    <h4>#128574 - masscat - Sat May 12, 2007 10:53 pm</h4>
    <div class="postbody">Following the release of Desmume 0.7, I have updated Desmume + GDB stub to the same code base. I have built a Windows binary too.<br/>
<br/>
<a class="postlink" href="http://forums.desmume.org/viewtopic.php?id=85">Pop over to the Desmume formums</a>.</div>    
</div>
<div class="post">
    <h4>#128647 - Jevin - Sun May 13, 2007 8:29 pm</h4>
    <div class="postbody">The sources don't compile on OS X for some reason. The latest CVS works fine though (minus OpenGL =()<br/>
<br/>
make output: <a class="postlink" href="http://pastebin.ca/486113">http://pastebin.ca/486113</a><br/>
<br/>
configure info:
<div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>checking for gzopen in -lz... yes
checking for zzip_open in -lzzip... no
checking for sdl-config... /sw/bin/sdl-config
checking GL/gl.h usability... no
checking GL/gl.h presence... no
checking for GL/gl.h... no
checking GL/glu.h usability... no
checking GL/glu.h presence... no
checking for GL/glu.h... no
checking for pkg-config... pkg-config
checking for pkg-config... /sw/bin/pkg-config
checking pkg-config is at least version 0.9.0... yes
checking for GTK... yes
checking for GTKGLEXT... no
checking for GTHREAD... yes
checking for gdk_gl_init in -lgdkglext-x11-1.0... no
checking for LIBGLADE... no
checking whether to enable maintainer-specific portions of Makefiles... no</code></pre></div></div>    
</div>
<div class="post">
    <h4>#128657 - masscat - Sun May 13, 2007 10:19 pm</h4>
    <div class="postbody">Can you try this:<br/>
<br/>
In <em class="text-italics">src/cli/main.c</em> add the <em class="text-italics">SDL_thread.h</em> include file.<br/>
<br/>
For example, change:<br/>
<div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>#include "SDL.h"
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;
#include &lt;libgen.h&gt;</code></pre></div>
to
<div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>#include "SDL.h"
#include "SDL_thread.h"
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;
#include &lt;libgen.h&gt;</code></pre></div>

This is not explicitly needed under Linux but maybe under OSX.<br/>
<br/>
<strong class="text-strong">PS:</strong> for OpenGL support for 3D emulation in the GTK port you need the gtkGLext library. A quick search for "OSX gtkGLext" lead to <a class="postlink" href="http://gtkglext.darwinports.com/">this page</a>. I do not know if that is usable by you or if there is another source to install it from though.</div>    
</div>
</div>

    </body>
</html>
