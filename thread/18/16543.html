<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Extended palettes for sprites - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > Extended palettes for sprites</h2>
<div id="posts">
<div class="post">
    <h4>#167535 - SturmxHawke - Tue Mar 17, 2009 5:30 pm</h4>
    <div class="postbody"><span class="postbody">Hello, I've been looking around the interwebs for a while, have found some tutorials, but I'm not sure I've found something that works yet. I'm trying to use extended palettes on sprites, but so far I've only seen it used on BackGrounds, is it even possible to use on sprites and if it is, then can someone either point me in the right direction or explain to me how it's done?
<br/>
<br/>
So far I have this:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void X_copyExtPal(const unsigned short * pal, int palnr, int size, int screen)
<br/>
{
<br/>
   if (screen == 1)
<br/>
   {
<br/>
      vramSetBankG(VRAM_G_LCD);
<br/>
      memcpy(VRAM_G, pal, size);
<br/>
      vramSetBankG(VRAM_G_SPRITE_EXT_PALETTE);
<br/>
   }
<br/>
<br/>
   if(screen == 0)
<br/>
   {
<br/>
      vramSetBankI(VRAM_I_LCD);
<br/>
      memcpy(VRAM_I, pal, size);
<br/>
      vramSetBankI(VRAM_I_SUB_SPRITE_EXT_PALETTE);
<br/>
   }
<br/>
}
<br/>
</td> </tr></table><span class="postbody"><br/>_________________<br/><span style="font-style: italic">Who's that?
<br/>
<br/>
<span style="font-weight: bold">It's superdude!</span></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167537 - Miked0801 - Tue Mar 17, 2009 5:41 pm</h4>
    <div class="postbody"><span class="postbody">Yes it's possible as we do it all the time.  I don't have any source to give you, but can tell you the process is nearly identical to that of BG land and will let someone else give you an example.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167540 - Tommmie - Tue Mar 17, 2009 7:19 pm</h4>
    <div class="postbody"><span class="postbody">i will send it to you(yes i've been a long time off line)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167550 - Emmanuel - Wed Mar 18, 2009 3:00 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void loadSpritePal(bool main, const char* path, u8 palette, SpriteColorFormat color){
<br/>
        FILE* gfx;
<br/>
   int i, size;
<br/>
   u8* buffer;
<br/>
   gfx = fopen(path, "rb");
<br/>
   if(gfx != NULL) {
<br/>
      fseek(gfx, 0, SEEK_END);
<br/>
      size = ftell(gfx); 
<br/>
      fseek(gfx, 0, SEEK_SET);
<br/>
      
<br/>
      buffer = new u8[size];
<br/>
      
<br/>
      i = 0;
<br/>
      while(i &lt; size) {
<br/>
         fread(&amp;buffer[i], 1, 1, gfx);
<br/>
         i++;
<br/>
      }
<br/>
      if(main){
<br/>
         if(color != SpriteColorFormat_256Color){
<br/>
            memcpy(SPRITE_PALETTE+palette*16, /* screen palette*/
<br/>
                     buffer, size);
<br/>
         }else{
<br/>
            vramSetBankF(VRAM_F_LCD);
<br/>
            memcpy(VRAM_F_EXT_PALETTE[palette], /* screen palette*/
<br/>
                     buffer, size);
<br/>
            vramSetBankF(VRAM_F_SPRITE_EXT_PALETTE);
<br/>
         }
<br/>
      }else{
<br/>
         if(color != SpriteColorFormat_256Color){
<br/>
            memcpy(SPRITE_PALETTE_SUB+palette*16, /* screen palette*/
<br/>
                        buffer, size);
<br/>
         }else{
<br/>
            vramSetBankI(VRAM_I_LCD);
<br/>
            memcpy(VRAM_I+palette*16, /* screen palette*/
<br/>
                     buffer, size);
<br/>
            vramSetBankI(VRAM_I_SUB_SPRITE_EXT_PALETTE);
<br/>
         }
<br/>
      }
<br/>
      delete[] buffer;
<br/>
      buffer = NULL;
<br/>
      fclose(gfx);
<br/>
   }else{
<br/>
      iprintf("File NULL");
<br/>
   }
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
That's my code for loading the palette from FAT... however, the I bank is not working... even though DSemuMe shows the palette loads correctly, the sprites are not able to make use of it...
<br/>
<br/>
Also:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">//Ext palette sprite
<br/>
   vramSetBankF(VRAM_F_SPRITE_EXT_PALETTE);
<br/>
   vramSetBankI(VRAM_I_SUB_SPRITE_EXT_PALETTE);</td> </tr></table><span class="postbody">
<br/>
This one maps the vrams accordingly
<br/>
And
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">REG_DISPCNT |= DISPLAY_SPR_EXT_PALETTE; /* Tell the main screen to use
<br/>
                     extended palettes for sprites*/
<br/>
   REG_DISPCNT_SUB |= DISPLAY_SPR_EXT_PALETTE; /* Tell the sub screen to use
<br/>
                     extended palettes for sprites*/
<br/>
   oamInit(&amp;oamMain, SpriteMapping_1D_256, true);
<br/>
   oamInit(&amp;oamSub, SpriteMapping_1D_256, true);</td> </tr></table><span class="postbody">
<br/>
and the oamInit's true is for enabling extended pallete...
<br/>
<br/>
NOTE: Change the news and deletes with mallocs and frees accordingly if you use plain C
<br/>
BTW, I'm thinking on releasing a small lib (bad news C++ only)... everyone always ask about extended palettes *and I still have my sub ext palette not working for sprites*
<br/>
It would combine Bgs, Sprites and Collision Maps WITH FAT/EFS loading WITH Extended Palette
<br/>
<br/>
It would at least serve as a nice example... even though I think libnds is good enough... but, I remember when I started *which, wasn't too long ago* that was the stuff I took longer to get used to...
<br/>
<br/>
The code works... for me at least... I might have skipped some part... it uses the latest libnds...</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
