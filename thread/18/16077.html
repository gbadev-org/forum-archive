<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>accessing data from binaries - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>DS development > accessing data from binaries</h2>
<div id="posts">
<div class="post">
    <h4>#163144 - gauauu - Tue Sep 23, 2008 9:52 pm</h4>
    <div class="postbody"><span class="postbody">I've got binary audio data that I'm compiling into my game, but which isn't working right.  Maybe somebody can tell me what's wrong.
<br/>
<br/>
I have some audio files.  I'm using $(bin2o) from devkitArm's base_rules to convert it to an object file to link in.
<br/>
<br/>
The assembly that is created by bin2s looks like:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
/* Generated by BIN2S - please don't edit directly */
<br/>
   .section .rodata
<br/>
   .balign 4
<br/>
   .global thunk_wav_size
<br/>
   .global thunk_wav
<br/>
thunk_wav:
<br/>
   .byte  70, 79, 82, 77,  0,  0, 29, 78, 65, 73, 70, 70, 67, 79, 77, 77
<br/>
   .byte   0,  0,  0, 18,  0,  1,  0,  0, 28,226,  0,  8, 64, 14,172, 68
<br/>
...snip....
<br/>
   .byte 253,254,255,  1,  1,  2,  3,  3,  4,  4,  4,  3,  2,  1,  0,255
<br/>
   .byte 255,254,253,252,250,  0
<br/>
<br/>
   .global thunk_wav_end
<br/>
thunk_wav_end:
<br/>
<br/>
thunk_wav_size: .int 7510
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
As far as I understand, I should then be able to access it from C:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
extern const u32 thunk_wav_size;
<br/>
<br/>
displayNumber(thunk_wav_size);
<br/>
if (thunk_wav_size == 7510)
<br/>
{
<br/>
      //it SHOULD get here...but doesn't
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
The value of thunk_wav_size that I get when I read it, though, is 16391510.  The pointer to the beginning of the binary blob is also wrong.
<br/>
<br/>
What makes it more odd is that there are about 10 sound files.  Two or three of them work fine.  The others are all messed up in similar ways.
<br/>
<br/>
Any ideas what's going on, or what I'm doing wrong?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#163156 - gauauu - Wed Sep 24, 2008 4:05 am</h4>
    <div class="postbody"><span class="postbody">Well, I still don't know what the problem was, but I tried using the <a class="postlink" href="http://www.gbadev.org/tools.php?showinfo=68" target="_blank">bin2o.exe tool</a> from the tools section of gbadev, instead of using the bin2o rule from devkitArm, and it works for me now.
<br/>
<br/>
I'd still be interested to know what the problem was, but my issue is solved.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#163167 - Cearn - Wed Sep 24, 2008 9:19 am</h4>
    <div class="postbody"><span class="postbody">The issue is word <a class="postlink" href="http://www.arm.com/support/faqip/3661.html" target="_blank">alignment</a>. This is the situation in hex. Addresses are on the left and the placement of the size is shown in brackets.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">00001D40  FD FE FF 01  01 02 03 03  04 04 04 03  02 01 00 FF
<br/>
00001D50  FF FE FD FC  FA 00[56 1D  00 00]
<br/>
</td> </tr></table><span class="postbody">
<br/>
As you can see, the thunk_wav_size starts in the middle of a word. When reading the word via LDR, the data used will start at <span style="font-style: italic">address</span>&amp;~3 (meaning 1D54 to 1D57), giving 1D5600FA. These are then rotated for the off-alignment to give 00FA1D56, which is 16391510 in decimal.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#163172 - gauauu - Wed Sep 24, 2008 1:32 pm</h4>
    <div class="postbody"><span class="postbody">Thanks, Cearn, I wondered if that might have something to do with it.  
<br/>
<br/>
What does .balign 4 do if not align it on word boundaries?  Is there some other way to specify that it should be word aligned?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#163173 - Cearn - Wed Sep 24, 2008 1:47 pm</h4>
    <div class="postbody"><span class="postbody">.balign aligns the <span style="font-style: italic">next</span> label to the selected boundary. It doesn't do anything for later ones.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#163175 - gauauu - Wed Sep 24, 2008 3:06 pm</h4>
    <div class="postbody"><span class="postbody">Aaah, makes sense.  Again, thanks for all your help!
<br/>
<br/>
So it looks like then, to use the bin2o rule, the binary files must be padded to a word boundary.  Does anyone know why the assembly files produced by bin2s don't add another .balign 4 before the size label, which seems to me to be the "obvious" fix?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#163185 - tepples - Wed Sep 24, 2008 8:38 pm</h4>
    <div class="postbody"><span class="postbody">When I wrote bin2s for <a class="postlink" href="http://www.pineight.com/gba/#gbfs" target="_blank">GBFS</a>, I originally had it put _size (originally called _len) <span style="font-style: italic">above</span> the data, so that both the size and the data would be aligned to 4 bytes as required by the ARM ABI. In June 2005 (<a class="postlink" href="http://devkitpro.cvs.sourceforge.net/devkitpro/tools/gba/?hideattic=0" target="_blank">source</a>), WinterMute picked up the GBFS tools and incorporated them into devkitARM. The <a class="postlink" href="http://devkitpro.cvs.sourceforge.net/devkitpro/tools/general/bin2s.c?view=log" target="_blank">revision history of devkitPro bin2s</a> shows that revision 1.4 (February 2008) moved _size to the bottom in order to guarantee that the data is aligned, even on platforms where the data needs to be aligned to 8 bytes or bigger. I guess I never noticed the change because most file formats that I have used with bin2s are specified to be a multiple of 4 bytes in size: .wav is 4 bytes, .chr (tiled graphics data) is 32 bytes, .gbfs is 16 bytes, etc. Apparently, revision 1.6 (September 2008) fixed the _size alignment, so it should end up fixed if and when devkitARM R24 becomes available through devkitProUpdater.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
