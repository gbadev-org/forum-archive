<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Chishm, can you explain some MP code? [Renamed] - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>DS development > Chishm, can you explain some MP code? [Renamed]</h2>
<div id="posts">
<div class="post">
    <h4>#75003 - swzte - Thu Mar 09, 2006 9:56 am</h4>
    <div class="postbody"><span class="postbody">Chism, I have read the MP code written by you! 
<br/>
ARM7 execute the follow code:
<br/>
<br/>
<span style="font-style: italic">*((vu32*)0x027FFE04) = (u32)0xE59FF018;	// ldr pc, 0x027FFE24
<br/>
*((vu32*)0x027FFE24) = (u32)0x027FFE04;	// Set ARM9 Loop address
<br/>
__asm volatile("bx %0" : : "r" (0x027FFE04) );</span>
<br/>
<br/>
Can ARM9 enter a loop? 0xE59FF018 is disasemblled as 
<br/>
ldr pc,.+0x20  Here, ldr pc,0x027ffe24
<br/>
<br/>
However, [0x027ffe24]=0x027ffe04?
<br/>
<br/>
Can you explain? 
<br/>
Thanks a lot!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#75007 - chishm - Thu Mar 09, 2006 10:21 am</h4>
    <div class="postbody"><span class="postbody">What that code does is load the 32 bit value from 0x20 bytes ahead into the program counter (if you don't understand ASM). This basically jumps to whatever address is stored at 0x027FFE24. Since the instruction is located at 0x027FFE04 and it keeps jumping to 0x027FFE04, it will stay in a loop. However, as soon as another number is written to 0x027FFE24, it will jump to that address, breaking out of the loop.<br/>_________________<br/><a class="postlink" href="http://chishm.drunkencoders.com" target="_blank">http://chishm.drunkencoders.com</a>
<br/>
<a class="postlink" href="http://dldi.drunkencoders.com" target="_blank">http://dldi.drunkencoders.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#75009 - swzte - Thu Mar 09, 2006 11:27 am</h4>
    <div class="postbody"><span class="postbody">Thank you for you explanation,chishm! 
<br/>
0xE59FF018 is disambled as ldr pc, 0x027ffe24
<br/>
After this instruction is executed, pc=[0x027ffe24],not pc=0x027ffe24?
<br/>
Thanks!
<br/>
I have another question: 
<br/>
in loadBinary_ARM7,in the end, you copy ndsHeader(from CF) to NDSHEADER(0x027ffe00). Before the copy,[0x027ffe04]=0xe59ff018.
<br/>
After the copy, the value at  0x027ffe04 may be changged.
<br/>
<br/>
However, in startBinary_ARM7
<br/>
<br/>
((u32*)NDS_HEAD)[0x24&gt;&gt;2] = TEMP_ARM9_START_ADDRESS;
<br/>
<br/>
The physical address of NDS_HEAD[0x24] is 0x027ffe24.You want the PC of ARM9 to jump to [0x027ffe24](Here,[address] means the vaue at  address). If the value at 0x027ffe04 is 0xE59FF018 ,
<br/>
it can do. But the value at  0x027ffe04  is not  0xE59FF018 again because of the copy ahead. Can you the PC(ARM9) jump to ARM9 entry?
<br/>
<br/>
Chishm, can you give an explanation?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#75012 - chishm - Thu Mar 09, 2006 12:35 pm</h4>
    <div class="postbody"><span class="postbody">Well in C, ldr pc, 0x027ffe24 would be pc = *(vu32*)0x027ffe24
<br/>
<br/>
Also, when loading the file, the ARM9 is put into a new wait loop in a function not inside the NDS header. It waits for the ARM9 start address to become non-zero. The file loader stores the ARM9 start address in TEMP_ARM9_START_ADDRESS and sets the value in the header to 0, so that the ARM9 will continue to wait for the ARM7. This is to allow the ARM7 to finish doing what it needs to do. It then exectutes:
<br/>
<br/>
((u32*)NDS_HEAD)[0x24&gt;&gt;2] = TEMP_ARM9_START_ADDRESS;
<br/>
<br/>
to make the ARM9 jump to the loaded binary.<br/>_________________<br/><a class="postlink" href="http://chishm.drunkencoders.com" target="_blank">http://chishm.drunkencoders.com</a>
<br/>
<a class="postlink" href="http://dldi.drunkencoders.com" target="_blank">http://dldi.drunkencoders.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#75014 - swzte - Thu Mar 09, 2006 1:06 pm</h4>
    <div class="postbody"><span class="postbody">Chishm! Look here.
<br/>
In the end of loadBinary_ARM7 function,you write as follows 
<br/>
<br/>
<span style="font-style: italic"><span style="font-weight: bold">dmaCopyWords(3, (void*)ndsHeader, (void*)NDS_HEAD, 0x170);</span></span>
<br/>
<br/>
After this dma transfer, the value at 0x027ffe04 is changed and the value at 0x027ffe24 is also changed. Is ARM9 still in loop.
<br/>
<br/>
I'm not clear here.
<br/>
<br/>
Can you give an explanation? Thanks!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#75017 - chishm - Thu Mar 09, 2006 2:33 pm</h4>
    <div class="postbody"><span class="postbody">Yes, the ARM9 is still in a loop, because it has already changed where it loops.<br/>_________________<br/><a class="postlink" href="http://chishm.drunkencoders.com" target="_blank">http://chishm.drunkencoders.com</a>
<br/>
<a class="postlink" href="http://dldi.drunkencoders.com" target="_blank">http://dldi.drunkencoders.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#75088 - swzte - Fri Mar 10, 2006 1:44 am</h4>
    <div class="postbody"><span class="postbody">Thanks,Chishm!
<br/>
Can you show me your purpose of the follow code?
<br/>
<br/>
WAIT_CR = 0xE880;
<br/>
<br/>
(*(vu32*)0x027FFE24) = 0;
<br/>
<br/>
while(DISP_Y!=191);
<br/>
while(DISP_Y==191);
<br/>
while ( (*(vu32*)0x027FFE24) == 0 );
<br/>
<br/>
while(DISP_Y!=191);
<br/>
while(DISP_Y==191);
<br/>
<br/>
__asm volatile("bx %0" : : "r" (*(vu32*)0x027FFE24));</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#75098 - natrium42 - Fri Mar 10, 2006 2:54 am</h4>
    <div class="postbody"><span class="postbody">This looks like synchronization on blanks (between CPU cores).<br/>_________________<br/><a class="postlink" href="http://www.natrium42.com" target="_blank">www.natrium42.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#75102 - HyperHacker - Fri Mar 10, 2006 3:31 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>swzte wrote:</b></span></td> </tr> <tr> <td class="quote">while(DISP_Y!=191);
<br/>
while(DISP_Y==191);</td> </tr></table><span class="postbody">
<br/>
Why do so many programs use this? It appears to just wait for line 192... why not <span style="font-style: italic">while(DISP_Y != 192);</span> then?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#75112 - swzte - Fri Mar 10, 2006 4:18 am</h4>
    <div class="postbody"><span class="postbody">natrium42 ,you say it intends for synchronization on blanks.
<br/>
<br/>
When is the value of DISP_Y  changed?
<br/>
Is it changed in the vblank interrupt routine?
<br/>
<br/>
Can you give an explanation? 
<br/>
<br/>
I havn't the vblank interrupt code , so I don'n know how it works!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#75114 - natrium42 - Fri Mar 10, 2006 5:29 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>swzte wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
When is the value of DISP_Y  changed?
<br/>
Is it changed in the vblank interrupt routine?
<br/>
</td> </tr></table><span class="postbody">
<br/>
It's a register that is changed by the hardware on each HBlank as the GPU draws horizontal lines.
<br/>
<br/>
The screen is 256x192 and a wait for that register to become 191 is essentialy a "busy-wait VSync".<br/>_________________<br/><a class="postlink" href="http://www.natrium42.com" target="_blank">www.natrium42.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#75117 - gladius - Fri Mar 10, 2006 6:01 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>HyperHacker wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>swzte wrote:</b></span></td> </tr> <tr> <td class="quote">while(DISP_Y!=191);
<br/>
while(DISP_Y==191);</td> </tr></table><span class="postbody">
<br/>
Why do so many programs use this? It appears to just wait for line 192... why not <span style="font-style: italic">while(DISP_Y != 192);</span> then?</span></td> </tr></table><span class="postbody">
<br/>
If your program is fast enough that it finishes while the scanline is still 192, then you'll fall right out of != 192 again.  The other method ensures you'll wait a full frame.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#75127 - chishm - Fri Mar 10, 2006 9:24 am</h4>
    <div class="postbody"><span class="postbody">That code is used in the GBAMP firmware replacement, and is based on Darkain's MultiNDS loader. 
<br/>
This code:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">while(DISP_Y!=191);
<br/>
while(DISP_Y==191);</td> </tr></table><span class="postbody">
<br/>
is used by both CPUs for syncronisation so that they start at the same time.
<br/>
It is used instead of SwiVBlankIntrWait because interrupts are disabled for the loader.<br/>_________________<br/><a class="postlink" href="http://chishm.drunkencoders.com" target="_blank">http://chishm.drunkencoders.com</a>
<br/>
<a class="postlink" href="http://dldi.drunkencoders.com" target="_blank">http://dldi.drunkencoders.com</a></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
