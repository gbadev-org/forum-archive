<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>"dirnext" corrupts stack! - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > "dirnext" corrupts stack!</h2>
<div id="posts">
<div class="post">
    <h4>#161417 - Dwedit - Sun Aug 03, 2008 3:34 am</h4>
    <div class="postbody"><span class="postbody">When I call "dirnext" using the FCSR dldi driver, memory on the stack gets corrupted, and a block of data gets written to address 0.
<br/>
<br/>
More specifically:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
int find_next_file(char filename[])
<br/>
{
<br/>
   if (dir_global==NULL)
<br/>
   {
<br/>
      return find_first_file(filename);
<br/>
   }
<br/>
   struct stat st;
<br/>
   int type;
<br/>
<br/>
   int err=dirnext(dir_global,filename,&amp;st);
<br/>
<br/>
   if (err==-1)
<br/>
   {
<br/>
      free_dir_iterator();
<br/>
      return 0;
<br/>
   }
<br/>
   else
<br/>
   {
<br/>
      type = (st.st_mode &amp; S_IFDIR) ? 2 : 1;
<br/>
   }
<br/>
   return type;
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
If I allocate a big dummy array on the stack before calling dirnext, I get no bad effects.  If I don't, I get a corrupted stack.<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"><br/><br/>Last edited by Dwedit on Sun Aug 03, 2008 8:54 pm; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#161441 - Dwedit - Sun Aug 03, 2008 8:17 pm</h4>
    <div class="postbody"><span class="postbody">I think I have more insight here...
<br/>
<br/>
"Sizeof (stat)" is 64, but more than 64 bytes get overwritten when you call dirnext.
<br/>
<br/>
So far, I've seen the 4 bytes AFTER the 64 byte struct getting zeroed out.  This is a major bug.<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161469 - preussie - Mon Aug 04, 2008 5:11 pm</h4>
    <div class="postbody"><span class="postbody">I can confirm the problem ( r23b ). I had the same here. After I inserted some dummy bytes after the stat struct it worked...<br/>_________________<br/><a class="postlink" href="http://preussie.miscstuff.de/ds//" target="_blank">My NDS Homebrew projects...</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161470 - cheesethulhu - Mon Aug 04, 2008 5:55 pm</h4>
    <div class="postbody"><span class="postbody">The latest NDS binary of libfat, libfat-nds-20070127, was built with 32-bit dev_t, but devkitARM r23b (and maybe other releases) has 16-bit dev_t.  Two members of struct stat are of type dev_t, so four bytes after get zeroed and data within the struct is at the wrong location.
<br/>
<br/>
A couple quick workarounds include rebuilding libfat from source, downgrading to an old devkitARM, or using a custom struct stat.  A real fix will probably involve a new release of devkitARM, since libfat uses st_dev for a 4 byte device ID, and is therefore "correct".</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161502 - CmdrKrool - Tue Aug 05, 2008 7:01 am</h4>
    <div class="postbody"><span class="postbody">I ran into this as well today. It's a happy coincidence that you folks are here discussing this just now otherwise I might still be pulling my hair out.
<br/>
<br/>
I'm also seeing (ie. just from practical tests and printf) 4 bytes getting zeroed after the stat struct.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#165695 - ritz - Sun Jan 04, 2009 3:43 am</h4>
    <div class="postbody"><span class="postbody">I updated to devkitARM 24 recently and have discovered this exact same behaviour when calling dirnext() within EFS lib's SearchDirectory(). I've tried the precompiled libfat and compiled my own from source (1.0.3 and 1.0.4)... no luck. This worked fine for me in 23b. Anything else I can do or try?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#165710 - elhobbs - Sun Jan 04, 2009 11:58 pm</h4>
    <div class="postbody"><span class="postbody">I ran into the same problem. I had to change to opendir and readdir - which is used in the libfat example code.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#165727 - ritz - Mon Jan 05, 2009 4:34 pm</h4>
    <div class="postbody"><span class="postbody">Cool, thanks for the helpful info.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
