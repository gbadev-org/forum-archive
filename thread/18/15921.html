<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Why is my data moving? - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > Why is my data moving?</h2>
<div id="posts">
<div class="post">
    <h4>#161588 - DiscoStew - Wed Aug 06, 2008 9:34 pm</h4>
    <div class="postbody"><span class="postbody">Ok, I've found some really odd behavior when working on my DS projects. The location of variables in memory are shifting. The data in them remain intact, but anything to do with addresses are shifting.
<br/>
<br/>
I noticed this odd behavior when I was fixing a few bugs in my program that dealt with shortcut pointers directed to data in memory that was loaded from a file. At the beginning of a function, the variable was in an area of memory, but when I checked that variable's address at the end of the function, it had shifted a couple dozen bytes. I checked other variables and structures, and the same thing was happening to them too, shifting the same number of bytes. However, it seems that it's only happening in one of my functions that gets called only once for the moment. Like I said before, all the data remains intact, so even with these shifting addresses, the data is shifting with them, staying in harmony.
<br/>
<br/>
Although it is hardly affecting my DS programming, it was just something odd that I stumbled across.<br/>_________________<br/><span style="font-weight: bold">DS</span> - It's all about <span style="font-weight: bold">D</span>isco<span style="font-weight: bold">S</span>tew</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161589 - Dwedit - Wed Aug 06, 2008 9:37 pm</h4>
    <div class="postbody"><span class="postbody">I think you may have a memory leak.<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161590 - DiscoStew - Wed Aug 06, 2008 9:39 pm</h4>
    <div class="postbody"><span class="postbody">I don't think it's a memory leak, because it's even affecting variables that are declared at the start of the program, even before any memory allocation via malloc and such.<br/>_________________<br/><span style="font-weight: bold">DS</span> - It's all about <span style="font-weight: bold">D</span>isco<span style="font-weight: bold">S</span>tew</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161594 - silent_code - Wed Aug 06, 2008 10:13 pm</h4>
    <div class="postbody"><span class="postbody">I got helped by posting some sources yesterday (also very odd behaviour - it turned out to be a silly little mistake) and I believe you could be helped when posting something, too. :^)<br/>_________________<br/><span style="font-size: 9px; line-height: normal"><span style="text-decoration: underline"><span style="font-weight: bold"></span></span> July 5th 08: "<span style="font-weight: bold">Volumetric Shadow Demo</span>" 1.6.0 (final) source released
<br/>
June 5th 08: "<span style="font-weight: bold">Zombie NDS</span>" WIP released!
<br/>
It's all on my page, just click <span style="font-weight: bold">WWW</span> below.</span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161598 - DiscoStew - Wed Aug 06, 2008 11:19 pm</h4>
    <div class="postbody"><span class="postbody">When I get home today, I'll put something together.<br/>_________________<br/><span style="font-weight: bold">DS</span> - It's all about <span style="font-weight: bold">D</span>isco<span style="font-weight: bold">S</span>tew</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161606 - DiscoStew - Thu Aug 07, 2008 4:29 am</h4>
    <div class="postbody"><span class="postbody">Ok, I think I have something small enough that can show it.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">   unsigned int fsInfo;
<br/>
   unsigned int fsSize = 0;
<br/>
<br/>
   if(!fatInitDefault())
<br/>
   {   iprintf("\x1b[9;0HFile System initialization failed."); while(1);   }
<br/>
<br/>
   //1st two-liner
<br/>
   iprintf("\x1b[9;0HTest -&gt; %04X", &amp;fsSize);
<br/>
   while(1);
<br/>
      
<br/>
   FILE *levels = fopen("/data/level001.dat", "rb");
<br/>
   if(levels == NULL)
<br/>
   {   iprintf("\x1b[9;0HCould not open the Level files."); while(1);      }
<br/>
   fread((void*)&amp;fsInfo, 4, 1, levels);
<br/>
   if((fsInfo != 0x00000000) )
<br/>
   {   iprintf("\x1b[9;0HFound incompatible Level file.");    }
<br/>
   fclose(levels);
<br/>
<br/>
   //2nd two-liner
<br/>
   iprintf("\x1b[9;0HTest -&gt; %04X", &amp;fsSize);
<br/>
   while(1);
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
It's messy, I know, but when I run this as is, the first "iprint" that uses '&amp;fsSize' gives the address in one area of memory (and of course, because of that while loop, nothing else happens. But, should that two-liner be commented out, when the code get to the 2nd two-liner with 'iprint' and the while statement, the address of fsSize shifts a couple of words over.
<br/>
<br/>
My usual code isn't like this, but the shift in addresses is even larger over smaller sections of code. When I first encountered this odd behavior, it was with moving only a single 'two-liner' from one place in code to another a few lines down, and a greater shift in addresses were showing. Even addresses of addresses were shifting when nothing was being done with them after being set once and left alone.
<br/>
<br/>
The only thing I can see that could be showing this distortion is something with 'iprintf', and dealing with addresses. If that is the case, then I need a better method for examining them.<br/>_________________<br/><span style="font-weight: bold">DS</span> - It's all about <span style="font-weight: bold">D</span>isco<span style="font-weight: bold">S</span>tew</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161644 - M3d10n - Fri Aug 08, 2008 10:42 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">iprintf("\x1b[9;0HTest -&gt; %04X", &amp;fsSize); </td> </tr></table><span class="postbody">
<br/>
The printed values will change everytime because you're printing the location of &amp;fsSize, which is a pointer to fsSize that's being created temporarily on each iprintf call and most likely resides on a register.
<br/>
<br/>
It's more or less like you're doing this:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
int foobar = 100;
<br/>
int *foo = &amp;foobar;
<br/>
int *bar = &amp;foobar;
<br/>
</td> </tr></table><span class="postbody">
<br/>
The variables "foo" and "bar" are pointers pointing to the same location in memory (foobar), but each one resides on a different area of memory. That's what you're seeing in your iprintf() calls.
<br/>
<br/>
Summing up: don't add "&amp;" to your iprintf() parameters, all you're gonna see is the address of some register.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161646 - josath - Sat Aug 09, 2008 2:11 am</h4>
    <div class="postbody"><span class="postbody">I think M3d10n is wrong. &amp;foobar should always give you the address of foobar. If you did: </span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">int *foo = &amp;foobar;
<br/>
int *bar = &amp;foobar;
<br/>
iprintf("%08X %08X\n", foo, bar);</td> </tr></table><span class="postbody">
<br/>
You should get the same exact address printed twice
<br/>
<br/>
Now here's where I'm confused. Are you actually printing out the address of a particular variable in two different places in your code and getting different addresses, <span style="font-weight: bold">in the same compiled program</span>? Because you said </span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">But, should that two-liner be commented out</td> </tr></table><span class="postbody"> and that makes me think you are commenting out the first iprintf statement. If you change code around, then of course the compiler might decide to put things in memory differently, due to whatever it thinks is most optimal. It may be that simply moving an iprintf statement around makes the compiler decide to place a variable one place or another. But the key thing is that the address should not change within a single program.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161648 - DiscoStew - Sat Aug 09, 2008 3:55 am</h4>
    <div class="postbody"><span class="postbody">The variable I am getting the address of is not changing places in the program. The one I'm specifically checking is the very first in the function. My major test of it was having 6 iprintf statements throughout the function, each accessing the address of the first variable, with the last statement with the while loop. In that, all the iprintf statements show the same address, but as I start commenting out the iprintf from the bottom up (and moving the while loop to the previous statement) from 6 iprintfs to 1 iprintf, they all show the same address, but that particular address is not the same as it was before with a different number of iprintf statements. And with that, the shift in the address has been from 4 bytes to even a 100 byte difference.
<br/>
<br/>
You think it might just be how the compiler deals with iprintf? Considering the nature of the iprintf function vs others, it isn't quite limited to how many values you can put into it, only that you have as many in the string to place each into.<br/>_________________<br/><span style="font-weight: bold">DS</span> - It's all about <span style="font-weight: bold">D</span>isco<span style="font-weight: bold">S</span>tew</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161649 - josath - Sat Aug 09, 2008 4:46 am</h4>
    <div class="postbody"><span class="postbody">I don't think it's iprintf in particular causing the problem, it's just that the compiler randomly places variables in memory, and changing code that references that variable in any way can change the place it decides to put it in memory.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161650 - sgeos - Sat Aug 09, 2008 6:27 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>josath wrote:</b></span></td> </tr> <tr> <td class="quote">it's just that the compiler randomly places variables in memory,</td> </tr></table><span class="postbody">
<br/>
The compiler systematically places variables in memory, and to the best of my knowledge compilers have almost complete freedom when it comes to where and how they place things.  What can and can not be done is in the <a class="postlink" href="http://www.open-std.org/JTC1/SC22/WG14/www/docs/n1256.pdf" target="_blank">C standard</a>, if you care to read it.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>josath wrote:</b></span></td> </tr> <tr> <td class="quote">and changing code that references that variable in any way can change the place it decides to put it in memory.</td> </tr></table><span class="postbody">
<br/>
Adding and deleting lines, reordering lines, etc, can and probably will change where the compiler decides to put things, depending on what you are doing.  Commenting out a line is the same as deleting it as far as the compiler is concerned.  Comments become whitespace.  Whitespace should have no effect on the resulting output.
<br/>
<br/>
Because small changes can completely change where variable are located, things like gameshark codes don't work with different language versions of the same game, even if 99% of source code and data is exactly the same.  Recompiling with changes changes things.  =)
<br/>
<br/>
FWIW, anything that lives on the stack will probably change locations during the life of a single program execution.
<br/>
<br/>
-Brendan</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161651 - zeruda - Sat Aug 09, 2008 7:21 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>M3d10n wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
int foobar = 100;
<br/>
int *foo = &amp;foobar;
<br/>
int *bar = &amp;foobar;
<br/>
</td> </tr></table><span class="postbody">
<br/>
The variables "foo" and "bar" are pointers pointing to the same location in memory (foobar), but each one resides on a different area of memory. That's what you're seeing in your iprintf() calls.</span></td> </tr></table><span class="postbody">
<br/>
<br/>
foo and bar in this case both point to the address of foobar. If you print foo and bar you will get the same value, &amp;foobar. If you printed &amp;foo and &amp;bar then you would get two seperate addresses of foo and bar.
<br/>
<br/>
I'd suggest try the tests by setting a pointer to fsSize and do your print tests with that.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">   unsigned int fsSize = 0;
<br/>
   unsigned int *PointertofsSize = &amp;fsSize;
<br/>
<br/>
   iprintf("\x1b[9;0HTest -&gt; %04X", PointertofsSize);
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Seems the most likely culprit is the iprintf statement although it could be the fread. It could be the memory management but when you do unsigned int fsSize = 0; that should create the variable in memory and assign 0 to it there and then, so I don't really see why changes later in the function would be the cause. Oh, and when unexpected behaviour occurs a make clean, make can sometimes fix it, just in case you ain't tried that.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161653 - silent_code - Sat Aug 09, 2008 9:38 am</h4>
    <div class="postbody"><span class="postbody">I don't know if somebody had pointed this out already, but there's %p for printing pointers.<br/>_________________<br/><span style="font-size: 9px; line-height: normal"><span style="text-decoration: underline"><span style="font-weight: bold"></span></span> July 5th 08: "<span style="font-weight: bold">Volumetric Shadow Demo</span>" 1.6.0 (final) source released
<br/>
June 5th 08: "<span style="font-weight: bold">Zombie NDS</span>" WIP released!
<br/>
It's all on my page, just click <span style="font-weight: bold">WWW</span> below.</span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161655 - Cearn - Sat Aug 09, 2008 11:17 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>zeruda wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">   unsigned int fsSize = 0;
<br/>
   unsigned int *PointertofsSize = &amp;fsSize;
<br/>
<br/>
   iprintf("\x1b[9;0HTest -&gt; %04X", PointertofsSize);
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Seems the most likely culprit is the iprintf statement although it could be the fread. It could be the memory management ... but when you do unsigned int fsSize = 0; that should create the variable in memory and assign 0 to it there ... </span></td> </tr></table><span class="postbody">
<br/>
This isn't quite true. In general, local variables don't go in memory at all but in registers. There are some exceptions to this, one of them being when you take the address of it (like in the second line). In that case, like M3d10n said, a temp variable is allocated on the stack and referenced via an offset from the stack pointer (<span style="font-style: italic">SP</span>+<span style="font-style: italic">x</span>).
<br/>
<br/>
The address on the stack pointer depends on a number of things, mainly the level of function calls. Inside a function, GCC tends to assign the local stack at the top of a function so that <span style="font-style: italic">SP</span> won't change in its scope. However, the amount of local stack space and how it is used can change when the function is altered. For example, this is what I get when I compile DiscoStew's code with and without the first two-liner:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">@ With 1st two-liner
<br/>
   push   {lr}             @ - decrease SP by 16
<br/>
   sub   sp, sp, #12       @ /
<br/>
   mov   r3, #0
<br/>
   str   r3, [sp, #4]      @ Put fsSize on stack. &amp;fsSize= SP+4
<br/>
   bl   fatInitDefault
<br/>
   cmp   r0, #0
<br/>
   bne   .L48
<br/>
   ldr   r0, .L52
<br/>
   bl   iprintf
<br/>
... more
<br/>
</td> </tr></table><span class="postbody">and
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">@ Without 1st two-liner
<br/>
   push   {r4, lr}          @ - decrease SP by 16
<br/>
   sub   sp, sp, #8         @ /
<br/>
   mov   r3, #0
<br/>
   str   r3, [sp]           @ Put fsSize on stack. &amp;fsSize= SP
<br/>
   bl   fatInitDefault
<br/>
   cmp   r0, #0
<br/>
   bne   .L48
<br/>
   ldr   r0, .L57
<br/>
   bl   iprintf
<br/>
... more
<br/>
</td> </tr></table><span class="postbody">
<br/>
In both cases, <span style="font-style: italic">SP</span> decreases by 16, but in the former the zero is placed at <span style="font-style: italic">SP</span>+4, where as it goes in <span style="font-style: italic">SP</span>+0 in the latter: a difference of 4 bytes. If you allocate local arrays, the difference will be even larger.
<br/>
<br/>
@ DiscoStew:
<br/>
What are the addresses of your shifting variables? Are they in main RAM or on the stack? Are they global or local?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161659 - M3d10n - Sat Aug 09, 2008 2:08 pm</h4>
    <div class="postbody"><span class="postbody">Indeed, most likely your local variable is on a register and printing a pointer to it won't return the same result everytime. Getting a pointer to it in another variable might force the compiler to lock it down on the stack or something.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161672 - Sunray - Sat Aug 09, 2008 10:16 pm</h4>
    <div class="postbody"><span class="postbody">Try making it <span style="font-weight: bold">volatile</span>.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
