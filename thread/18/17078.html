<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Custom SWI handler troubles - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>DS development > Custom SWI handler troubles</h2>
<div id="posts">
<div class="post">
    <h4>#172241 - fincs - Tue Jan 26, 2010 9:43 pm</h4>
    <div class="postbody"><span class="postbody">Hi,
<br/>
I hate that my first post is something as obscure as this, but I'm having trouble trying to install a custom SWI handler on the DS. I'm using devkitARM r27 and libnds 1.4.0.
<br/>
The problem is that the custom handler never gets executed. This is how I install it:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">   SystemVectors.swi = (u32) __SWIHandler;
<br/>
   setVectorBase(0); // clear the high vector bit in the CP15 control register</td> </tr></table><span class="postbody">
<br/>
I then used the no$gba debugger (with the appropiate BIOS ROMs) to see what was wrong with my program. The SWI instruction jumps to 0xFFFF0008 (BIOS) instead of 0x00000008 (libnds vectors) although I cleared the V bit in the CP15. Real hardware (DSi) exposes the same problem, whilst other emulators run my code fine. I've tried everything: hacking the linker script, ds_arm9_crt0.s, vectorbase.s, mpusetup.s, searching this forum, re-reading gbatek, reading the official ARM documentation, nothing. I've been struggling my head for like a week for something that might just be a one-byte problem.
<br/>
<br/>
PD: vectorbase.s is wrong although it doesn't affect program execution (FIQs are never fired), here's a fix:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">(..snip..)
<br/>
   .global      SystemVectors
<br/>
   
<br/>
   ldr r15,vec_reset
<br/>
   ldr r15,vec_undefined
<br/>
   ldr r15,vec_swi
<br/>
   ldr r15,vec_prefetch_abort
<br/>
   ldr r15,vec_data_abort
<br/>
   .word 0 @ &lt;&lt;-- added line
<br/>
   ldr r15,vec_irq
<br/>
   ldr r15,vec_fiq
<br/>
<br/>
SystemVectors:
<br/>
vec_reset:
<br/>
   .word   0xFFFF0000
<br/>
vec_undefined:
<br/>
   .word   0xFFFF0004
<br/>
vec_swi:
<br/>
   .word   0xFFFF0008
<br/>
vec_prefetch_abort:
<br/>
   .word   0xFFFF000C
<br/>
vec_data_abort:
<br/>
   .word   0xFFFF0010
<br/>
vec_irq:
<br/>
   .word   0xFFFF0018 @ &lt;&lt;--changed address
<br/>
vec_fiq:
<br/>
   .word   0xFFFF001C @ &lt;&lt;--changed address
<br/>
(..snip..)</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#172242 - Dwedit - Tue Jan 26, 2010 10:29 pm</h4>
    <div class="postbody"><span class="postbody">Maybe NO$GBA has bugs here?  The ARM reference does indeed say that PC should become 00000008.
<br/>
I know that the debugger seems to ignore the current memory mapping and protection settings when displaying memory.<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#172243 - fincs - Tue Jan 26, 2010 10:33 pm</h4>
    <div class="postbody"><span class="postbody">Real hardware also suffers from this problem.
<br/>
There's a PU section which covers the 00000000 vectors, so no PU problem.
<br/>
The code in <a class="postlink" href="http://forum.gbadev.org/viewtopic.php?t=11820" target="_blank">this thread</a> appears to work in real hardware and use the same trick...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#172263 - fincs - Wed Jan 27, 2010 10:35 pm</h4>
    <div class="postbody"><span class="postbody">Ok, I've decided to include a test project which can be downloaded from <a class="postlink" href="http://www.quickfilepost.com/download.do?get=22355b3061cb5965b8fb3ed9b2ff6aa6" target="_blank">here</a>.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#172770 - wintermute - Tue Mar 02, 2010 1:19 pm</h4>
    <div class="postbody"><span class="postbody">Works for me on hardware, both DS &amp; DSi, libnds 1.4.1 &amp; devkitARM r28.
<br/>
<br/>
Good catch on the vector stuff, flaming ARM docs don't exactly make that obvious :/ I've just committed that to svn, will be part of libnds 1.4.2, thanks. If you do catch anything else could you submit a patch to the SF patch tracker, things get noticed and fixed much quicker that way.<br/>_________________<br/><a class="postlink" href="http://www.devkitpro.org/" target="_blank">devkitPro - professional toolchains at amateur prices</a>
<br/>
<a class="postlink" href="http://wiki.devkitpro.org/index.php/IRC" target="_blank">devkitPro IRC support</a>
<br/>
<a class="postlink" href="http://davejmurphy.com/" target="_blank">Personal Blog</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#172774 - fincs - Tue Mar 02, 2010 3:48 pm</h4>
    <div class="postbody"><span class="postbody">Yeah, I somehow managed to run the wrong version of my code. It now works.
<br/>
I can confirm no$gba doesn't do custom exception vectors.
<br/>
Anyway, thanks for your wonderful toolchains and libraries.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#172791 - Exophase - Wed Mar 03, 2010 4:50 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>fincs wrote:</b></span></td> </tr> <tr> <td class="quote">Yeah, I somehow managed to run the wrong version of my code. It now works.
<br/>
I can confirm no$gba doesn't do custom exception vectors.
<br/>
Anyway, thanks for your wonderful toolchains and libraries.</td> </tr></table><span class="postbody">
<br/>
<br/>
I'm just curious, but what was the problem? Surprising bit about No$..</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#172796 - fincs - Wed Mar 03, 2010 9:58 pm</h4>
    <div class="postbody"><span class="postbody">no$gba ignores the V bit in the cp15 control register (that means, it forces 0xFFFF0000 (BIOS) as the exception vector base address).
<br/>
About the "wrong version of my code", I recall it had some sort of issue with the stack, I can't really remember.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
