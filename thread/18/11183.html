<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Standard C time()-replacement needs review [renamed] - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > Standard C time()-replacement needs review [renamed]</h2>
<div id="posts">
<div class="post">
    <h4>#102980 - Lick - Mon Sep 18, 2006 12:27 pm</h4>
    <div class="postbody"><span class="postbody">As the current standard ctime functions don't work, I've wrote a very unclean hack that does the same as time(), at least that's what it should do.
<br/>
<br/>
Is there anything wrong with it? Can it be optimized?
<br/>
<br/>
<span style="font-style: italic">ndsx_time.h</span></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#ifndef _NDSX_TIME_
<br/>
#define _NDSX_TIME_
<br/>
<br/>
#define ISLEAP(y)           (!((y) % 4) &amp;&amp; (((y) % 100) || !((y) % 400)))
<br/>
#define DAY2S(dys)          u32((dys) * 86400)
<br/>
#define HOURS2S(hrs)        u32((hrs) * 3600)
<br/>
#define MINUTES2S(min)      u32((min) * 60)
<br/>
<br/>
u16 mdays[]   = { 0, 31, 59, 90, 120, 151, 181, 212, 243, 273, 304, 334, 365 };
<br/>
u16 mdays_leap[] = { 0, 31, 60, 91, 121, 152, 182, 213, 244, 274, 305, 335, 366 };
<br/>
<br/>
#define rtc24hours ((IPC-&gt;rtc_hours &gt; 51) ? IPC-&gt;rtc_hours-40 : IPC-&gt;rtc_hours)
<br/>
<br/>
u32 NDSX_time()
<br/>
{
<br/>
    static u32 year_shit1 = (IPC-&gt;rtc_year+30) / 4; // get number of 4-years
<br/>
    static u32 year_shit2 = (IPC-&gt;rtc_year+30) % 4; // rest of 4-years (1, 2, 3 are important)
<br/>
    u32 years_in_sec = year_shit1 * (31536000*3 + 31622400);
<br/>
    if(year_shit2 == 1)
<br/>
        years_in_sec += 31536000; // normal year
<br/>
    else if(year_shit2 == 2)
<br/>
        years_in_sec += 31536000 + 31622400; // normal year + leap year
<br/>
    else if(year_shit2 == 3)
<br/>
        years_in_sec += 31536000*2 + 31622400; // normal year * 2 + leap year
<br/>
<br/>
    return 
<br/>
        years_in_sec
<br/>
        + ISLEAP(IPC-&gt;rtc_year+2000) ?
<br/>
            DAY2S(mdays_leap[IPC-&gt;rtc_month-1]) : DAY2S(mdays[IPC-&gt;rtc_month-1])
<br/>
        + DAY2S(IPC-&gt;rtc_day-1)
<br/>
        + HOURS2S(rtc24hours)
<br/>
        + MINUTES2S(IPC-&gt;rtc_minutes)
<br/>
        + IPC-&gt;rtc_seconds
<br/>
        ;
<br/>
}
<br/>
<br/>
<br/>
#endif
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
BTW, you're free to use this code in your project!<br/>_________________<br/><a class="postlink" href="http://licklick.wordpress.com" target="_blank">http://licklick.wordpress.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#103514 - Lick - Fri Sep 22, 2006 3:49 pm</h4>
    <div class="postbody"><span class="postbody">Okay this is the definite one. The code in my last post did not ( ) the ISLEAP part, that's why it failed.
<br/>
<br/>
Use it! ;)
<br/>
<br/>
<a class="postlink" href="http://lick.huuf.net/ndsx_time.h" target="_blank">http://lick.huuf.net/ndsx_time.h</a><br/>_________________<br/><a class="postlink" href="http://licklick.wordpress.com" target="_blank">http://licklick.wordpress.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#103577 - !cube - Fri Sep 22, 2006 9:42 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Lick wrote:</b></span></td> </tr> <tr> <td class="quote">Is there anything wrong with it? Can it be optimized?</td> </tr></table><span class="postbody">
<br/>
<br/>
Well you can change the divisions by four into bit shifts and modulus by 4 into bitwise AND atleast.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#103579 - tepples - Fri Sep 22, 2006 9:51 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>!cube wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Lick wrote:</b></span></td> </tr> <tr> <td class="quote">Is there anything wrong with it? Can it be optimized?</td> </tr></table><span class="postbody">
<br/>
Well you can change the divisions by four into bit shifts and modulus by 4 into bitwise AND atleast.</span></td> </tr></table><span class="postbody">
<br/>
Are you sure that the compiler isn't already doing that at -O2?<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#103580 - Lick - Fri Sep 22, 2006 9:52 pm</h4>
    <div class="postbody"><span class="postbody">I'll change that..
<br/>
<br/>
I actually think the compiler will do it automatically, but hey, it's worth a try. Thanks! ;)
<br/>
<br/>
- Lick<br/>_________________<br/><a class="postlink" href="http://licklick.wordpress.com" target="_blank">http://licklick.wordpress.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#103899 - knight0fdragon - Mon Sep 25, 2006 7:11 am</h4>
    <div class="postbody"><span class="postbody">hey at least give me credit for helping you bastard hahaha :-p<br/>_________________<br/><a href="http://www.myspace.com/knight0fdragonds" target="_blank">http://www.myspace.com/knight0fdragonds</a>
<br/>
<br/>
MK DS FC: Dragon 330772 075464 
<br/>
AC WW FC: Anthony SamsClub 1933-3433-9458 
<br/>
MPFH: Dragon 0215 4231 1206</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#103934 - Lick - Mon Sep 25, 2006 3:08 pm</h4>
    <div class="postbody"><span class="postbody">* gives cookie to knight0fdragon *
<br/>
<br/>
 B)<br/>_________________<br/><a class="postlink" href="http://licklick.wordpress.com" target="_blank">http://licklick.wordpress.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#104228 - sasq - Wed Sep 27, 2006 8:13 am</h4>
    <div class="postbody"><span class="postbody">Actually, since IPC is volatile is really not a good idea to use it directly in the macros like that, its get read multiple times. This made the above code not work for me at all until I first read out the IPC info into local variables.
<br/>
<br/>
Also, it is C++ only becuase of the long() cast operators and the static variables (which I also don't see any reason to use).</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#104237 - Lick - Wed Sep 27, 2006 10:36 am</h4>
    <div class="postbody"><span class="postbody">I'm very open to any improvements, as it's only better for everyone to have the finest code available.So sasq, could I invite you to write a better version?<br/>_________________<br/><a class="postlink" href="http://licklick.wordpress.com" target="_blank">http://licklick.wordpress.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#104252 - !cube - Wed Sep 27, 2006 1:32 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Lick wrote:</b></span></td> </tr> <tr> <td class="quote">I actually think the compiler will do it automatically, but hey, it's worth a try.</td> </tr></table><span class="postbody">
<br/>
<br/>
I wouldn't trust a compiler to optimize anything :) Too many a time have I stumbled into the compiler "optimizing" the code to a standstill..</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#104258 - kevinc - Wed Sep 27, 2006 2:58 pm</h4>
    <div class="postbody"><span class="postbody">You could make mdays a const. And I agree with sasq's volatile/static suggestions.
<br/>
<br/>
You should rewrite your numeric constants as #defines, too. "31536000*3 + 31622400" is a bit hard to parse.
<br/>
<br/>
<br/>
// btw: ISLEAP(x) can be simplified to:
<br/>
<br/>
#define ISLEAP(x) (!(x % 25 ? x &amp; 3 : x &amp; 15))
<br/>
<br/>
That way, you only use the evil modulo once.<br/>_________________<br/><a class="postlink" href="http://akzeac.blogspot.com" target="_blank">http://akzeac.blogspot.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#104448 - onigiri - Fri Sep 29, 2006 7:16 am</h4>
    <div class="postbody"><span class="postbody">I'm really lazy and went with using the existing mktime to help me make a drop in replacement for the standard time(time_t *inTime).
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
time_t timeNDS(time_t *inTime) {
<br/>
    time_t current_time;
<br/>
    struct tm timeinfo;
<br/>
  
<br/>
    timeinfo.tm_year = (IPC-&gt;rtc_year)+100; 
<br/>
    timeinfo.tm_mon = IPC-&gt;rtc_month-1;
<br/>
    timeinfo.tm_mday = IPC-&gt;rtc_day;
<br/>
    
<br/>
    if (IPC-&gt;rtc_hours &lt;= 11) {
<br/>
        timeinfo.tm_hour = IPC-&gt;rtc_hours;
<br/>
    }
<br/>
    else {
<br/>
        timeinfo.tm_hour = IPC-&gt;rtc_hours-40;
<br/>
    }
<br/>
    timeinfo.tm_min = IPC-&gt;rtc_minutes;
<br/>
    timeinfo.tm_sec = IPC-&gt;rtc_seconds;
<br/>
    timeinfo.tm_isdst = -1;
<br/>
  
<br/>
    current_time = mktime(&amp;timeinfo);
<br/>
    return current_time;
<br/>
}
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
