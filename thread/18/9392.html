<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Source for iprintf? - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>DS development > Source for iprintf?</h2>
<div id="posts">
<div class="post">
    <h4>#81338 - Chris Holmes - Fri Apr 28, 2006 3:12 pm</h4>
    <div class="postbody"><span class="postbody">I was digging through libnds, and I can't find the source for iprintf.  I'm having a lot of problems with that particular function.. specifically, it's freezing Dualis for a lot of very simple print statements.  I'm guessing that there's probably a buffer overflow or something like that in there, and I wanted to look into it.
<br/>
<br/>
Can someone point me to where I can actually find the source for that?  I grepped through all the files in the libnds project and couldn't find it.
<br/>
<br/>
  Thanks,
<br/>
    Chris</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#81344 - wintermute - Fri Apr 28, 2006 4:12 pm</h4>
    <div class="postbody"><span class="postbody">Can you supply some examples of simple print statements that freeze Dualis?
<br/>
<br/>
Does the code work on hardware?
<br/>
<br/>
Never assume that problems running code in emulators equates to problems with the code.
<br/>
<br/>
iprintf is provided by newlib - the C library used by devkitARM. Code in libnds (console.c) hooks into newlib to provide the actual output from the stdio functions.<br/>_________________<br/><a class="postlink" href="http://www.devkitpro.org/" target="_blank">devkitPro - professional toolchains at amateur prices</a>
<br/>
<a class="postlink" href="http://wiki.devkitpro.org/index.php/IRC" target="_blank">devkitPro IRC support</a>
<br/>
<a class="postlink" href="http://davejmurphy.com/" target="_blank">Personal Blog</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#81345 - knight0fdragon - Fri Apr 28, 2006 4:20 pm</h4>
    <div class="postbody"><span class="postbody">i had this problem too. by any chance did u rebuild libnds<br/>_________________<br/><a href="http://www.myspace.com/knight0fdragonds" target="_blank">http://www.myspace.com/knight0fdragonds</a>
<br/>
<br/>
MK DS FC: Dragon 330772 075464 
<br/>
AC WW FC: Anthony SamsClub 1933-3433-9458 
<br/>
MPFH: Dragon 0215 4231 1206</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#81347 - wintermute - Fri Apr 28, 2006 4:30 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>knight0fdragon wrote:</b></span></td> </tr> <tr> <td class="quote">i had this problem too. by any chance did u rebuild libnds</td> </tr></table><span class="postbody">
<br/>
<br/>
Exactly what problem did you have?
<br/>
<br/>
Did rebuilding cause the problem or fix it?
<br/>
<br/>
What source did you rebuild from?<br/>_________________<br/><a class="postlink" href="http://www.devkitpro.org/" target="_blank">devkitPro - professional toolchains at amateur prices</a>
<br/>
<a class="postlink" href="http://wiki.devkitpro.org/index.php/IRC" target="_blank">devkitPro IRC support</a>
<br/>
<a class="postlink" href="http://davejmurphy.com/" target="_blank">Personal Blog</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#81350 - Chris Holmes - Fri Apr 28, 2006 4:51 pm</h4>
    <div class="postbody"><span class="postbody">I haven't tested this on hardware lately, but the code runs fine on my machine at home, but not the machine I'm running on here.  I just got the latest version of devkitarm/libnds/libgba from sourceforge.  I tried running the devkitpro updater, but it pulled down invalid tarballs.  So, I downloaded the latest stable devkitarm and unzipped it, so I have a fresh build.
<br/>
<br/>
<br/>
Anyway, what I'm doing is catching 10 reads from the touchpad that are different and summing up the move differences between each move (i.e. XSum += (touchPosition-&gt;X - LastX );
<br/>
<br/>
iprintf("XSum %d YSum %d", XSum, YSum ); // This freezes under Dualis
<br/>
<br/>
iprintf("XSum %04X YSum %04X", XSum, YSum ); // This does not freeze
<br/>
<br/>
<br/>
For some reason, the first statement worked at home this morning.  I think it might be something on this machine because iprintf, when the number is not zero, tends to freeze under Dualis on this machine.
<br/>
<br/>
  Chris</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#81364 - tepples - Fri Apr 28, 2006 7:10 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Chris Holmes wrote:</b></span></td> </tr> <tr> <td class="quote">iprintf("XSum %d YSum %d", XSum, YSum ); // This freezes under Dualis</td> </tr></table><span class="postbody">
<br/>
The common algorithm for converting decimal numbers to binary requires division, and if Dualis doesn't support an equivalent to the DS BIOS, then Dualis is incompatible with your toolchain and/or library.
<br/>
<br/>
EDIT for correctness<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"><br/><br/>Last edited by tepples on Sat Apr 29, 2006 3:37 pm; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#81370 - Chris Holmes - Fri Apr 28, 2006 7:56 pm</h4>
    <div class="postbody"><span class="postbody">Except it works under Dualis at home on an older devkitpro build and fails on this machine under Dualis with the latest devkitpro build.  Therefore, it is not Dualis at fault.
<br/>
<br/>
  Chris</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#81380 - wintermute - Fri Apr 28, 2006 10:14 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tepples wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Chris Holmes wrote:</b></span></td> </tr> <tr> <td class="quote">iprintf("XSum %d YSum %d", XSum, YSum ); // This freezes under Dualis</td> </tr></table><span class="postbody">
<br/>
The common algorithm for converting decimal numbers to binary requires division, and if Dualis doesn't support the DS hardware division registers, then Dualis is incompatible with your toolchain.</span></td> </tr></table><span class="postbody">
<br/>
<br/>
Incorrect.
<br/>
<br/>
1. The toolchain is a generic arm-elf compiler and knows nothing about the intended target hardware. Various linkscripts and crt0 files are provided for different targets.
<br/>
<br/>
2. libnds contains code which overrides the standard division routines with bios calls *not* code to use the division registers.
<br/>
<br/>
Dualis emulation of bios calls could potentially be at fault but I haven't experienced any trouble in that regard here.<br/>_________________<br/><a class="postlink" href="http://www.devkitpro.org/" target="_blank">devkitPro - professional toolchains at amateur prices</a>
<br/>
<a class="postlink" href="http://wiki.devkitpro.org/index.php/IRC" target="_blank">devkitPro IRC support</a>
<br/>
<a class="postlink" href="http://davejmurphy.com/" target="_blank">Personal Blog</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#81382 - Chris Holmes - Fri Apr 28, 2006 10:28 pm</h4>
    <div class="postbody"><span class="postbody">My point is just that the same code runs fine on Dualis on one machine and not another.  That more or less exempts Dualis and the code from being the culprit of it not working.
<br/>
<br/>
I must have something setup wrong in my toolchain unless there is a bug in libnds somewhere.  I don't understand how iprint can possibly fail though.  I figure that whatever hooks it and reads it might be causing the problem.  On one machine, everything is fine, but on the other, iprintf almost always freezes Dualis.  
<br/>
<br/>
Do you have any idea of why that might happen?
<br/>
<br/>
  Chris</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#81385 - tepples - Fri Apr 28, 2006 10:44 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Chris Holmes wrote:</b></span></td> </tr> <tr> <td class="quote">My point is just that the same code runs fine on Dualis on one machine and not another.</td> </tr></table><span class="postbody">
<br/>
Are you sure that they're the same code? Have you tried computing the .nds files' md5sum?
<br/>
<br/>
If you're using different versions of devkitPro on the two machines, then you're probably using two different versions of libnbs. A later version of libnds may have more dependencies on (possibly unemulated) DS BIOS and DS hardware registers than an earlier version.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">I must have something setup wrong in my toolchain unless there is a bug in libnds somewhere.</td> </tr></table><span class="postbody">
<br/>
If something works on a Game Boy Advance but fails on VisualBoyAdvance, then it is a bug in VisualBoyAdvance. Likewise, if something works on a Nintendo DS but fails on Dualis, then it is a bug in Dualis.
<br/>
<br/>
Or do you expect wintermute to make workarounds in libnds for emulator bugs?<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#81386 - Chris Holmes - Fri Apr 28, 2006 10:58 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Are you sure that they're the same code? Have you tried computing the .nds files' md5sum?</td> </tr></table><span class="postbody">
<br/>
<br/>
It's all my code and it's coming out of my subversion repository.  I'm sure that all of my code is the same.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Or do you expect wintermute to make workarounds in libnds for emulator bugs?</td> </tr></table><span class="postbody">
<br/>
<br/>
My point is that there is a bug somewhere and I would appreciate help tracking it down.  I don't care where the bug is.  I don't care if it's a Dualis bug or a libnds bug or something wrong with my setup.  
<br/>
<br/>
The minute I said Dualis, everyone started blaming it immediately.  Dualis runs one build fine and the other build does not.  Maybe the newer/newest release of libnds changed something that Dualis isn't implementing correctly.  Maybe libnds has a legitimate bug that Dualis is executing faithfully.  Please don't get defensive about it.
<br/>
<br/>
Now, I dug through console.c a little, and it didn't make much sense to me.  I'm not sure how iprintf links into it, so I can't start tracing the code.
<br/>
Where do I start?
<br/>
<br/>
  Chris</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#81387 - tepples - Fri Apr 28, 2006 11:07 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Chris Holmes wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Are you sure that they're the same code? Have you tried computing the .nds files' md5sum?</td> </tr></table><span class="postbody">
<br/>
It's all my code and it's coming out of my subversion repository.  I'm sure that all of my code is the same.</span></td> </tr></table><span class="postbody">
<br/>
All of the <span style="font-style: italic">source</span> code, or all of the <span style="font-style: italic">binary</span> code? All of <span style="font-style: italic">your</span> code, or all of <span style="font-style: italic">wintermute's</span> code?
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Or do you expect wintermute to make workarounds in libnds for emulator bugs?</td> </tr></table><span class="postbody">
<br/>
<br/>
My point is that there is a bug somewhere and I would appreciate help tracking it down.  I don't care where the bug is.  I don't care if it's a Dualis bug or a libnds bug or something wrong with my setup.</span></td> </tr></table><span class="postbody">
<br/>
If a behavior differs in any way between the Nintendo DS and Dualis, then this is a Dualis bug.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">The minute I said Dualis, everyone started blaming it immediately.</td> </tr></table><span class="postbody">
<br/>
Because the current emulators are notorious for being inaccurate as libnds gains features that connect to different parts of the DS hardware.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Maybe the newer/newest release of libnds changed something that Dualis isn't implementing correctly.</td> </tr></table><span class="postbody">
<br/>
This is in fact the case.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Now, I dug through console.c a little, and it didn't make much sense to me.  I'm not sure how iprintf links into it, so I can't start tracing the code.
<br/>
Where do I start?</td> </tr></table><span class="postbody">
<br/>
Go look for a function called __divsi3().<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#81396 - Chris Holmes - Fri Apr 28, 2006 11:45 pm</h4>
    <div class="postbody"><span class="postbody">So, what you're saying is that N versions ago, libnds changed to use hardware division and that Dualis doesn't support that.  Therefore, 
<br/>
<br/>
for(int i = 0; i &lt; 100; i++ ) {
<br/>
  iprintf("%d", i);
<br/>
}
<br/>
<br/>
should fail on Dualis for all libnds after some version M until such a time as Dualis implements the hardware divide registers?
<br/>
<br/>
That would explain why 0 prints but larger numbers (should be greater than 9) would fail.
<br/>
<br/>
Correct?
<br/>
<br/>
  Chris</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#81412 - ecurtz - Sat Apr 29, 2006 1:48 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>wintermute wrote:</b></span></td> </tr> <tr> <td class="quote">2. libnds contains code which overrides the standard division routines with bios calls *not* code to use the division registers.</td> </tr></table><span class="postbody">
<br/>
<br/>
Why is that? Isn't the overhead of making the bios call huge compared to using the division registers, even if you wait on the busy flag? (Just curious, I'm only using divf32, which seems to use the registers.)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#81417 - DekuTree64 - Sat Apr 29, 2006 2:05 am</h4>
    <div class="postbody"><span class="postbody">[quote="ecurtz"]Isn't the overhead of making the bios call huge compared to using the division registers, even if you wait on the busy flag?[quote]
<br/>
Yep. Overriding / to use the registers is slightly dangerous though, because you don't really realize you're using them. An interrupt can fire off while it's waiting on the busy flag, and if that interrupt does any divides, then when you exit back out, the value you were waiting on is no longer there. Leads to some very random crashes :)
<br/>
<br/>
If you want to use the divider in an interrupt, be sure to read out the division regs first and restore them before returning.<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#81426 - knight0fdragon - Sat Apr 29, 2006 3:01 am</h4>
    <div class="postbody"><span class="postbody">my problem was when i rebuilt the source code provided, i have this topic somewhere else <a href="http://forum.gbadev.org/viewtopic.php?t=9119&amp;highlight=" target="_blank">http://forum.gbadev.org/viewtopic.php?t=9119&amp;highlight=</a><br/>_________________<br/><a href="http://www.myspace.com/knight0fdragonds" target="_blank">http://www.myspace.com/knight0fdragonds</a>
<br/>
<br/>
MK DS FC: Dragon 330772 075464 
<br/>
AC WW FC: Anthony SamsClub 1933-3433-9458 
<br/>
MPFH: Dragon 0215 4231 1206</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#81428 - wintermute - Sat Apr 29, 2006 3:31 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Chris Holmes wrote:</b></span></td> </tr> <tr> <td class="quote">So, what you're saying is that N versions ago, libnds changed to use hardware division and that Dualis doesn't support that.  Therefore, 
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
What he's saying is wrong
<br/>
<br/>
libnds started using the bios divide function from the 20050804 release - that's August 2005.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
for(int i = 0; i &lt; 100; i++ ) {
<br/>
  iprintf("%d", i);
<br/>
}
<br/>
<br/>
should fail on Dualis for all libnds after some version M until such a time as Dualis implements the hardware divide registers?
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
No, libnds does NOT use the hardware divide registers.
<br/>
<br/>
I've been playing around a bit with some code that appears to cause problems for Dualis, your problem appears similar to the one in this thread  <a href="http://forum.gbadev.org/viewtopic.php?t=9359" target="_blank">http://forum.gbadev.org/viewtopic.php?t=9359</a> .
<br/>
<br/>
My most recent changes to devkitARM broke the current Dualis quite badly in that everything I attempted to run would crash Dualis. I've since provided mic with some test code that breaks and he's fixed some of the issues.
<br/>
<br/>
With my latest iteration of the toolchain &amp; library ( what will be devkitARM r19 and the next libnds release) the code in that thread crashes. The same code runs fine on hardware, no$gba and DeSmuME. I've mailed it to mic so hopefully it will help him find the problem.
<br/>
<br/>
In short, the bug probably lies with Dualis so try one of the other emulators. My personal preference would be no$gba although the current iteration requires the bios images to be present.
<br/>
<br/>
<br/>
<a href="http://nocash.emubase.de/gba.htm" target="_blank">http://nocash.emubase.de/gba.htm</a>
<br/>
<br/>
shareware debugger version - I can't recommend this highly enough if you can follow asm. The full source level version is just a bit beyond the budget of hobbyists.
<br/>
<br/>
<a href="http://nocash.emubase.de/gba-dev.htm" target="_blank">http://nocash.emubase.de/gba-dev.htm</a>
<br/>
<br/>
A bios dumper for gbamp
<br/>
<br/>
<a href="http://pepsiman.pwp.blueyonder.co.uk/bios_dumper.nds" target="_blank">http://pepsiman.pwp.blueyonder.co.uk/bios_dumper.nds</a><br/>_________________<br/><a class="postlink" href="http://www.devkitpro.org/" target="_blank">devkitPro - professional toolchains at amateur prices</a>
<br/>
<a class="postlink" href="http://wiki.devkitpro.org/index.php/IRC" target="_blank">devkitPro IRC support</a>
<br/>
<a class="postlink" href="http://davejmurphy.com/" target="_blank">Personal Blog</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#81500 - Chris Holmes - Sat Apr 29, 2006 4:01 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">In short, the bug probably lies with Dualis so try one of the other emulators. My personal preference would be no$gba although the current iteration requires the bios images to be present.</td> </tr></table><span class="postbody">
<br/>
<br/>
Well, I can follow assembly, so I'll try no$gba as well as the other ones.
<br/>
<br/>
Hopefully Dualis will be patched up as well, but until then I'll try the other ones.
<br/>
<br/>
Thanks much for your help!
<br/>
<br/>
  Chris</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#81510 - knight0fdragon - Sat Apr 29, 2006 5:00 pm</h4>
    <div class="postbody"><span class="postbody">the bug is most likely in dualis, becuase even for me it works on DS, not dualis.  What i find weird though is even if i recompile the stable release, dualis will not use console functions<br/>_________________<br/><a href="http://www.myspace.com/knight0fdragonds" target="_blank">http://www.myspace.com/knight0fdragonds</a>
<br/>
<br/>
MK DS FC: Dragon 330772 075464 
<br/>
AC WW FC: Anthony SamsClub 1933-3433-9458 
<br/>
MPFH: Dragon 0215 4231 1206</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#81626 - Chris Holmes - Sun Apr 30, 2006 6:25 pm</h4>
    <div class="postbody"><span class="postbody">Well, no$gba crashes immediately and DesMume doesn't display the 3D stuff at all.  Also, no$gba claims to not handle any of the DS 3d stuff yet, so there's no point in bothering with that emulator for the time being.
<br/>
<br/>
Hopefully Dualis will start working again soon, but until then, I'm just going to write a custom print statement that will handle printing values for me.  Besides, it won't hurt to have a custom overload to print v16 values anyway.  I doubt anyone else wants it, but I'll post the code if there are any requests.
<br/>
<br/>
  Chris</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#82214 - Chris Holmes - Thu May 04, 2006 4:24 pm</h4>
    <div class="postbody"><span class="postbody">This issue is resolved as of the latest build of Dualis.
<br/>
<br/>
  Chris</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
