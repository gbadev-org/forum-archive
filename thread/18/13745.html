<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Help! Wireless, bootloader, icon, and Download Play Client - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > Help! Wireless, bootloader, icon, and Download Play Client</h2>
<div id="posts">
<div class="post">
    <h4>#135377 - yellowstar - Sun Jul 22, 2007 10:58 pm</h4>
    <div class="postbody"><span class="postbody">I have some questions and problems.
<br/>
These questions and problems
<br/>
have to do with <a class="postlink" href="http://forum.gbadev.org/viewtopic.php?t=11946" target="_blank">wireless</a>, a bootloader, icon, and a Download Play Client.
<br/>
<br/>
NOTE:
<br/>
I have moved the section about my Download Play Client's
<br/>
Auth bug,
<br/>
to a differen't topic.
<br/>
This topic it was moved to is titled:
<br/>
<a class="postlink" href="http://forum.gbadev.org/viewtopic.php?t=13767" target="_blank">"Help! Wireless and Download Play Client"</a>
<br/>
<br/>
I did that because the total length of
<br/>
the starting post for the original post was
<br/>
very long.
<br/>
<br/>
1.
<br/>
I am trying to make a DS Download Play Client,
<br/>
for Juglak's <a class="postlink" href="http://forum.gbadev.org/viewtopic.php?t=11946" target="_blank">WMB Host.</a>
<br/>
<br/>
All these problems are in this client.
<br/>
<br/>
My client is based on Juglak's WMB Host,
<br/>
for local wireless.
<br/>
Like Juglak's WMB Host,
<br/>
my program's graphics is an console.
<br/>
<br/>
Here's my problems:
<br/>
<br/>
1a.
<br/>
<br/>
I don't have a bootloader for my client.
<br/>
Which means my client can't boot the downloaded
<br/>
programs.
<br/>
<br/>
In DS Download Play,
<br/>
when it sends the NDS file,
<br/>
it is not a normal NDS file.
<br/>
It has some things removed.
<br/>
<br/>
See <a class="postlink" href="http://www.bottledlight.com/ds/index.php/Main/Wireless" target="_blank">here</a> for details.
<br/>
On that web page,
<br/>
click the DS Download Play protocol link
<br/>
for details on the download format and the protocol.
<br/>
<br/>
I need some links to some bootloaders.(the download URL for them)
<br/>
<br/>
I can't use crishm's,
<br/>
since most games(homebrew)
<br/>
don't use FAT.
<br/>
<br/>
I know I would have to
<br/>
convert the downloaded data to
<br/>
a NDS struct for any bootloader to
<br/>
work right.
<br/>
<br/>
My client dosen't get to the boot part yet,
<br/>
as I haven't gotten that far.
<br/>
<br/>
Also,
<br/>
it dosen't even make it past Authication.
<br/>
It worked once, but after that it stopped working.
<br/>
See the second section below this one
<br/>
for details.
<br/>
<br/>
My client scans every channel,
<br/>
so it can detect the official games.
<br/>
But since homebrew local wireless is a lot
<br/>
slower than the official games,
<br/>
it can't communicate with them
<br/>
in DS Download Play.(At least for the downloading part.)
<br/>
<br/>
<br/>
1b.
<br/>
My client isn't displaying the icon correctly.
<br/>
<br/>
I am using a sprite for displaying the icon.
<br/>
The icon it displays looks nothing like
<br/>
it would in the official client in the firmware.
<br/>
<br/>
Here's the code I am using:
<br/>
<br/>
This is the function that recieves the beacons.
<br/>
<br/>
It copies the important data into the ADC
<br/>
struct pointed to by the ad parameter.
<br/>
<br/>
The ADC struct is an struct which contains important
<br/>
stuff from the beacons.
<br/>
That includes the ad,
<br/>
the hostname, gamename,
<br/>
total players, max players, and etc.
<br/>
There is an global ADC var.
<br/>
<br/>
There is a timer(timer2)
<br/>
which calls this function.(In the IRQ handler for it)
<br/>
It passes the address of that global ADC var,
<br/>
to that function.
<br/>
<br/>
This timer gets triggered every second.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
<br/>
bool RecieveBeacon(ADC *ad) {
<br/>
<br/>
   unsigned char *b,*d;
<br/>
   struct beacon *bc;
<br/>
   struct ds_element *ds;
<br/>
   int i;
<br/>
   
<br/>
   if(!fire)
<br/>
   fire=true;
<br/>
   
<br/>
   b=NULL;
<br/>
   
<br/>
   b = RXNextFrame(&amp;sz);
<br/>
   
<br/>
   if(b==NULL)
<br/>
   return 0;
<br/>
   
<br/>
   if(sz!=188)
<br/>
   return 0;
<br/>
   
<br/>
   //b = (unsigned char *) Xmalloc(188);
<br/>
   bc = (struct beacon *) (unsigned int) b;
<br/>
   
<br/>
   for(i=0;i&lt;188;i++) {
<br/>
      beacon[i] = b[i];
<br/>
   }
<br/>
   
<br/>
   ds = (struct ds_element *) (unsigned int) &amp;beacon[52];
<br/>
<br/>
   int seq = ds-&gt;sequence_number;
<br/>
<br/>
   //ds-&gt;sequence_number = seq;
<br/>
   //ds-&gt;advert_sequence_number = seq;
<br/>
   
<br/>
   //b[42] = 13; // channel we're broadcasting on
<br/>
   if (seq == 9) {
<br/>
      //if(ds-&gt;non_advert!=2)
<br/>
      //return 0;
<br/>
      
<br/>
      //ds-&gt;data_size = 1;
<br/>
      ad-&gt;total_players = ds-&gt;advert_sequence_number; // Total players at this point.
<br/>
   }
<br/>
   else {
<br/>
      if (seq == 8) {
<br/>
         //ds-&gt;data_size = 72;
<br/>
      }
<br/>
      else {
<br/>
         //ds-&gt;data_size = 98;
<br/>
      }
<br/>
      
<br/>
      //if(ds-&gt;non_advert!=0)
<br/>
      //return 0;
<br/>
   }
<br/>
<br/>
   //ds-&gt;connected_clients = connected_clients;
<br/>
   
<br/>
   if (seq == 9) {
<br/>
      //for(i=0;i&lt;98;i++) ds-&gt;data[i] = 0;
<br/>
   }
<br/>
   else {
<br/>
      // copy data from ad into beacon
<br/>
      d = (unsigned char *) (unsigned int) &amp;ad-&gt;AD;
<br/>
      d += 98*seq;
<br/>
      if (seq == 8) {
<br/>
         for(i=0;i&lt;72;i++)  d[i] = ds-&gt;data[i];
<br/>
         for(i=72;i&lt;98;i++) ds-&gt;data[i] = 0;
<br/>
      }
<br/>
      else {
<br/>
         for(i=0;i&lt;98;i++) d[i] = ds-&gt;data[i];
<br/>
      }
<br/>
   }
<br/>
   
<br/>
   ad-&gt;max_players = ad-&gt;AD.max_players;
<br/>
   
<br/>
   ad-&gt;hostname_len = ad-&gt;AD.hostname_len;
<br/>
   
<br/>
   //strcpy(ad-&gt;hostname,"");
<br/>
   int I = 0;
<br/>
   for(int i = 0; i &lt;= 10; i++)
<br/>
   {
<br/>
   ad-&gt;hostname[i] = ((char*)ad-&gt;AD.hostname)[I];
<br/>
   I+=2;
<br/>
   }
<br/>
   
<br/>
   
<br/>
   
<br/>
   
<br/>
   unsigned char len = 0;
<br/>
   bool con = true;
<br/>
   
<br/>
   //strcpy(ad-&gt;hostname,"");
<br/>
   I = 0;
<br/>
   for(int i = 0; i &lt;= 48; i++)
<br/>
   {
<br/>
   ad-&gt;game_name[i] = ((char*)ad-&gt;AD.game_name)[I];
<br/>
   I+=2;
<br/>
   
<br/>
    if(con)
<br/>
    {
<br/>
     if(ad-&gt;game_name[i]==0)
<br/>
     {
<br/>
     con=false;
<br/>
     
<br/>
     }
<br/>
     else
<br/>
     {
<br/>
     len++;
<br/>
     }
<br/>
    }
<br/>
   }
<br/>
   
<br/>
   ad-&gt;game_name_len = len;
<br/>
   
<br/>
   len = 0;
<br/>
   
<br/>
   con = true;
<br/>
   
<br/>
   //strcpy(ad-&gt;hostname,"");
<br/>
   I = 0;
<br/>
   for(int i = 0; i &lt;= 96; i++)
<br/>
   {
<br/>
   ad-&gt;game_description[i] = ((char*)ad-&gt;AD.game_description)[I];
<br/>
   I+=2;
<br/>
   
<br/>
   if(con)
<br/>
    {
<br/>
     if(ad-&gt;game_description[i]==0)
<br/>
     {
<br/>
     con=false;
<br/>
     
<br/>
     }
<br/>
     else
<br/>
     {
<br/>
     len++;
<br/>
     }
<br/>
    }
<br/>
   
<br/>
   }
<br/>
   
<br/>
   ad-&gt;game_description_len = len;
<br/>
   
<br/>
   //ds-&gt;checksum = computeBeaconChecksum((unsigned short *) (unsigned int)(((unsigned int)&amp;ds-&gt;data[0])-4), (ds-&gt;data_size+4)/2);
<br/>
<br/>
   if(seq==0)//To optimize
<br/>
   {
<br/>
   
<br/>
   IconDraw(&amp;the_ad,1);
<br/>
   
<br/>
   }
<br/>
<br/>
   // think we're done...
<br/>
   //bc-&gt;seq = bec_seq&lt;&lt;4;
<br/>
   //bec_seq++;
<br/>
   
<br/>
   copy_mac(ad-&gt;host_mac,bc-&gt;srcmac);
<br/>
   //copy_mac(bc-&gt;bssmac,mymac);
<br/>
   
<br/>
   //SendFrame(b,188);
<br/>
   //Xfree(b);
<br/>
   
<br/>
   
<br/>
   
<br/>
   return 1;
<br/>
}
<br/>
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Here's the function which
<br/>
copies the ad icon into the sprite:
<br/>
<br/>
detect is wether or not an beacon was detected.
<br/>
If so, it copies the icon into the sprite.
<br/>
If not, it clears the sprite, making it invisible.
<br/>
<br/>
ad is the address of the ADC struct to use.
<br/>
When called,
<br/>
it is always the address of the global ADC struct.
<br/>
<br/>
scpy is an modified version of bytecpy.
<br/>
It is the same,
<br/>
except it copies 16 bits instead of bytes.
<br/>
I tried using dmaCopy,
<br/>
but that didn't do anything.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
__attribute__((section (".ewram"),long_call)) 
<br/>
void scpy(void* in_dst, const void *in_src, unsigned int length) 
<br/>
{ //short copy(u16)
<br/>
  u16 *src = (u16 *)in_src; 
<br/>
  u16 *dst = (u16 *)in_dst; 
<br/>
<br/>
  for(; length &gt; 0; length--) 
<br/>
    *dst++ = *src++;
<br/>
}
<br/>
<br/>
void IconDraw(ADC *ad, bool detect)
<br/>
{
<br/>
<br/>
if(detect)
<br/>
{
<br/>
<br/>
position.x = SCREEN_WIDTH/2 - 64;
<br/>
position.y = SCREEN_HEIGHT/2 - 64;
<br/>
position.angle = 0;
<br/>
<br/>
int GfxID = 64;
<br/>
<br/>
<br/>
spritesMain[0].attribute[0] = 
<br/>
ATTR0_COLOR_256 | //Paletted
<br/>
//ATTR0_ROTSCALE_DOUBLE | //Enable rotscale
<br/>
(int)position.y;
<br/>
<br/>
spritesMain[0].attribute[1] = 
<br/>
//ATTR1_ROTDATA(0) | //Rot info is in first index of rot data.
<br/>
ATTR1_SIZE_32 | //32X32
<br/>
(int)position.x;
<br/>
<br/>
spritesMain[0].attribute[2] = GfxID;
<br/>
<br/>
scpy(
<br/>
      //source
<br/>
      (uint16*)SPRITE_PALETTE_SUB+1,//target
<br/>
      &amp;ad-&gt;AD.icon_pallete[1],
<br/>
      15
<br/>
      );
<br/>
<br/>
scpy(
<br/>
      //source
<br/>
      &amp;SPRITE_GFX_SUB[GfxID * 16],
<br/>
      &amp;ad-&gt;AD.icon,//target
<br/>
      512
<br/>
      );
<br/>
<br/>
updateOAM(spritesMain);
<br/>
<br/>
<br/>
}
<br/>
else
<br/>
{
<br/>
<br/>
memset(&amp;spritesMain[0],sizeof(SpriteEntry),0);
<br/>
<br/>
}
<br/>
<br/>
}
<br/>
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Here's the init code for video and etc.
<br/>
<br/>
Sprites:
<br/>
initOAM sets every field in the spritesMain and spriteRotationsMain structs
<br/>
to 0.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
void initSprites()
<br/>
{
<br/>
<br/>
<br/>
initOAM(spritesMain,spriteRotationsMain);
<br/>
<br/>
IconDraw(&amp;the_ad,0);
<br/>
<br/>
<br/>
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
<br/>
Video:
<br/>
Since this client is based on Juglak's WMB Host,
<br/>
it uses his libriyo for wireless and video.
<br/>
When I try using videoSetModeSub with this program,
<br/>
it won't work right with libriyo.
<br/>
<br/>
That is why I have to OR the SUB_DISPLAY_CR
<br/>
register.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
void initVideo() {
<br/>
<br/>
//enable vram and map it to the right places
<br/>
    /*vramSetMainBanks(   VRAM_A_MAIN_BG_0x06000000,      //map A and B to main background memory
<br/>
                        VRAM_B_MAIN_BG_0x06020000,      //this gives us 256KB which is a healthy amount for 16-bit gfx
<br/>
                        VRAM_C_SUB_BG_0x06200000,      //map C to sub background memory
<br/>
                        VRAM_D_LCD                  //map D to LCD free space
<br/>
                  //allows adjacent banks to overflow into D if a bug like that was ever to occur
<br/>
                        );*/
<br/>
   
<br/>
   //map a bank for use with sprites
<br/>
   vramSetBankI(VRAM_I_SUB_SPRITE); //mapping E to main sprites gives us 64k for sprites
<br/>
   //(64k is the max space that 1024 tiles take up in 256 color mode)
<br/>
   
<br/>
   //set the video mode
<br/>
    //videoSetModeSub(  MODE_5_2D | 
<br/>
                   SUB_DISPLAY_CR |= (
<br/>
               DISPLAY_SPR_ACTIVE |    //turn on sprites
<br/>
                   //DISPLAY_BG3_ACTIVE |    //turn on background 3
<br/>
                   DISPLAY_SPR_1D);          //this is used when in tile mode
<br/>
               //);
<br/>
   
<br/>
   //videoSetMode(MODE_5_2D | DISPLAY_BG3_ACTIVE);
<br/>
<br/>
}
<br/>
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"><br/><br/>Last edited by yellowstar on Sun Jul 29, 2007 10:45 pm; edited 4 times in total</span></div>    
</div>
<div class="post">
    <h4>#135514 - yellowstar - Tue Jul 24, 2007 3:40 am</h4>
    <div class="postbody"><span class="postbody">In my first post,
<br/>
I have added a section asking for help about
<br/>
my client's Authication bug.(The bug that stops it from sending
<br/>
the Authication requests.)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#135578 - yellowstar - Tue Jul 24, 2007 8:09 pm</h4>
    <div class="postbody"><span class="postbody">This post was about my client's Auth bug.
<br/>
<br/>
It has been moved to my topic for that bug.
<br/>
See my first post for details
<br/>
on the link for the topic.</span><span class="gensmall"><br/><br/>Last edited by yellowstar on Tue Jul 24, 2007 11:40 pm; edited 2 times in total</span></div>    
</div>
<div class="post">
    <h4>#135593 - Lynx - Tue Jul 24, 2007 10:20 pm</h4>
    <div class="postbody"><span class="postbody">holy long post batman!<br/>_________________<br/><a class="postlink" href="http://www.ndshb.com" target="_blank">NDS Homebrew Roms &amp; Reviews</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#135609 - yellowstar - Tue Jul 24, 2007 11:37 pm</h4>
    <div class="postbody"><span class="postbody">I have moved the section about my client's Auth bug
<br/>
to a differen't topic.
<br/>
<br/>
See the top of my first post for details.
<br/>
<br/>
The other sections are still in this topic.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#135662 - Sektor - Wed Jul 25, 2007 10:41 am</h4>
    <div class="postbody"><span class="postbody">Why do you make your posts so thin?  Go easy on the enter key, save if for dividing paragraphs.  You can just keep typing, the text will wrap around to the next line if it needs to.<br/>_________________<br/><span style="font-size: 9px; line-height: normal"><a class="postlink" href="http://gtamp.com/DS" target="_blank">GTAMP.com/DS</a></span></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
