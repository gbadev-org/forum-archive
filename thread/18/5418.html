<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Why large malloc (new) call fail on DS [FIXED] - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>DS development > Why large malloc (new) call fail on DS [FIXED]</h2>
<div id="posts">
<div class="post">
    <h4>#39714 - Darkain - Mon Apr 11, 2005 6:17 pm</h4>
    <div class="postbody"><span class="postbody">I was playing around w/  the addresses that malloc returned:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">0x02001010 - first malloc
<br/>
0x020010C0 - class instance (new)
<br/>
0x02001100 - buffer instance (malloc, 0x16000 bytes, end address 0x02017100, right thru MAIN and other functions)
<br/>
0x02034FBB - ROM DATA1
<br/>
0x02033ECB - ROM DATA2
<br/>
0x0200811C - MAIN function pointer</td> </tr></table><span class="postbody">
<br/>
<br/>
I was wondering why using <span style="font-weight: bold">malloc</span> (or <span style="font-weight: bold">new</span> which calls malloc) was failing for anything that was about 12kb or larger.
<br/>
<br/>
malloc starts allocating things at offset about 0x1000, and the ARM9 bin is copied to an offset of 0x4000.  Because of this, we are limited to 12kb of RAM before we start over-writing the code segment copied into RAM.
<br/>
<br/>
i'm no expert on how the crt0 is setup for the ARM9, but *something* has to change.  if the starting address for memory allocation has to be static, at least make it at offset 0x100000, which is exactly 1MB into RAM. this would allow for 1MB ARM9.bin, 2.5MB for RAM, and 512KB for ARM7.bin
<br/>
<br/>
<br/>
<span style="font-weight: bold">[EDIT]</span>
<br/>
<a class="postlink" href="http://cvs.sourceforge.net/viewcvs.py/devkitpro/buildscripts/dka-crtls/ds_arm9.ld" target="_blank">http://cvs.sourceforge.net/viewcvs.py/devkitpro/buildscripts/dka-crtls/ds_arm9.ld</a>
<br/>
Thanx to WntrMute, the bug is now gone.  There should be no more problems with malloc/new (untill you try to use more than 3.5MB of RAM :P)<br/>_________________<br/>-=- Darkain Dragoon -=-
<br/>
<a class="postlink" href="http://www.darkain.com" target="_blank">http://www.darkain.com</a>
<br/>
<a class="postlink" href="http://ds.darkain.com/hack" target="_blank">DarkStar</a> for <a class="postlink" href="http://ds.darkain.com" target="_blank">Nintendo DS</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#40417 - Pacifist - Mon Apr 18, 2005 8:49 pm</h4>
    <div class="postbody"><span class="postbody">I appologise for not knowing what the hell I'm doing but:
<br/>
<br/>
I'm having problems with this 12 kb memory limit and would love to use the fixed linker script provided to fix it.  Unfortunately I don't know what linker scripts are or what to do with them.
<br/>
<br/>
Does anyone feel like coddling the noob?  it would be much appreciated.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#40439 - wintermute - Mon Apr 18, 2005 10:08 pm</h4>
    <div class="postbody"><span class="postbody">copy the file over the ds_arm9.ld found in &lt;path to devkitARM&gt;/arm-elf/lib
<br/>
<br/>
done :P</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#40443 - Pacifist - Mon Apr 18, 2005 10:13 pm</h4>
    <div class="postbody"><span class="postbody">So simple yet so baffling for the clueless.
<br/>
<br/>
thank you a great deal!</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
