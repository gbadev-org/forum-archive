<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Doubts on sub screen about double buffering - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>DS development > Doubts on sub screen about double buffering</h2>
<div id="posts">
<div class="post">
    <h4>#129126 - odelot - Sat May 19, 2007 6:28 am</h4>
    <div class="postbody"><span class="postbody">Hi,
<br/>
<br/>
I am new on DS developement... 
<br/>
<br/>
i want to map the main and the sub screen on extended backgrounds with 16 bits to use as framebuffer..
<br/>
<br/>
I saw that in main screen i have a lot of possible banks to use, but in the sub screen i just have the bank C.. is it correct?? So i cant have 2 framebuffers on sub screen and just change the SUB_BGx_CR to point to it, as i can do with main screen???
<br/>
<br/>
the other doubt is if I can use text with extended background, running on mode 5, in both of screens???
<br/>
<br/>
EDIT &lt;add doubt&gt;: can I use others banks to use more memory on sub screen, like use the memory after 0x06220000 (end of C back for BG)??? how i say that in SUB_BGx_CR???
<br/>
<br/>
thanks in advance</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#129144 - tepples - Sat May 19, 2007 4:40 pm</h4>
    <div class="postbody"><span class="postbody">If you can't double buffer a 16-bit full-screen bitmap on the sub screen, you might want to use a second buffer in main RAM and then copy it in using HDMA. But I wonder whether you are in fact using the most efficient method of doing what you want to do. What are you going to be putting on each screen?<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#129149 - odelot - Sat May 19, 2007 6:21 pm</h4>
    <div class="postbody"><span class="postbody">i will do a windows system...
<br/>
<br/>
i tried to put  a framebuffer on memory but when i try it on emulator it gives a (rom crash error)...
<br/>
<br/>
i just be sad that i cant use the text provided by ndslib on both screen using them with extended background...
<br/>
<br/>
well here is my code... i dont know if it is 100% right but it works ;-)  wish that it help someone
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">//Coded by Odelot - (Brazil) - 19/05/2007 - DSVideo.h
<br/>
#ifndef __DSVIDEO_H
<br/>
#define __DSVIDEO_H
<br/>
<br/>
#include &lt;nds.h&gt;
<br/>
<br/>
class DSVideo
<br/>
{
<br/>
public:
<br/>
   void init ()
<br/>
   {
<br/>
      //initialing this variable that will help us with the swapBuffers of double buffering of main screen
<br/>
      m_drawingMainScr1=true;
<br/>
<br/>
      //initializing the main screen with mode5 and extended backgrounds
<br/>
      videoSetMode(MODE_5_2D | DISPLAY_BG3_ACTIVE);   
<br/>
      //initializing the sub screen with mode5 and extended backgrounds
<br/>
      videoSetModeSub(MODE_5_2D  |  DISPLAY_BG3_ACTIVE);   
<br/>
<br/>
      //initializing the bank A, B and C. Note that C bank is set to be used in sub screen
<br/>
      vramSetBankA (VRAM_A_MAIN_BG_0x06000000); 
<br/>
      vramSetBankB (VRAM_B_MAIN_BG_0x06020000);
<br/>
      vramSetBankC (VRAM_C_SUB_BG_0x06200000);
<br/>
      
<br/>
      //BG3_CR (main screen) is a complicated register... it has a lot of information.
<br/>
      //what we need to know is that, with OR operation, we make it, and it
<br/>
      //will works like a pointer for what the DS need to show on background (BG)
<br/>
      //layer, in case, the Background 3 that we enabled on videoSetMode
<br/>
      BG3_CR = BG_BMP16_256x256 | BG_BMP_BASE(0)  |  BG_PRIORITY(3);  
<br/>
<br/>
      //here we have data about scale, rotation, etc
<br/>
      //about the background... i dont know how to use 
<br/>
      //it yet, and i didn need it yet too
<br/>
      BG3_XDX = 0; 
<br/>
      BG3_XDY = 1 &lt;&lt; 8; 
<br/>
      BG3_YDY = 0; 
<br/>
      BG3_YDX = 1 &lt;&lt; 8;
<br/>
<br/>
      //same as BG3_CR, but for sub screen (0x06200000 is the adreess of 
<br/>
      //the begining of C bank)
<br/>
      SUB_BG3_CR = BG_BMP16_256x256 | 0x06200000|  BG_PRIORITY(3); 
<br/>
<br/>
<br/>
      //same as BG3_XDX etc...
<br/>
      SUB_BG3_XDX = 0; 
<br/>
      SUB_BG3_XDY = 1 &lt;&lt; 8; 
<br/>
      SUB_BG3_YDY = 0; 
<br/>
      SUB_BG3_YDX = 1 &lt;&lt; 8;
<br/>
<br/>
      //applying the pointers to framebuffers
<br/>
      m_fbMainScr1= (u16*)BG_BMP_RAM(0); //point to init of bank A, or 0x06000000
<br/>
      m_fbMainScr2= (u16*)BG_BMP_RAM(8); //point to init of bank B, or 0x06020000
<br/>
      m_fbSubScr= (u16*) 0x06200000; //point to init of bank c, or 0x06200000
<br/>
      m_fbMainScr = m_fbMainScr2; //actual framebuffer is back B
<br/>
<br/>
      int i=0;
<br/>
      //paint the screens with blue color (just to test.. there is a fast way to do this)
<br/>
      for(i = 0; i &lt; 256 * 256; i++)
<br/>
         m_fbMainScr1[i] = RGB15(0,0,31) | BIT(15);
<br/>
      for(i = 0; i &lt; 256 * 256; i++)
<br/>
         m_fbMainScr2[i] = RGB15(0,0,31) | BIT(15);
<br/>
      for(i = 0; i &lt; 256 * 256; i++)
<br/>
         m_fbSubScr[i] = RGB15(0,0,31) | BIT(15);
<br/>
<br/>
   }
<br/>
<br/>
   void swapBuffers ( )
<br/>
   {
<br/>
      m_drawingMainScr1=!m_drawingMainScr1;
<br/>
      if (m_drawingMainScr1)
<br/>
      {
<br/>
            //changing the back buffer pointer
<br/>
         m_fbMainScr=m_fbMainScr2;
<br/>
         //if we are drawing now main screen 1, so here we are updating the DS pointer to it
<br/>
         BG3_CR = BG_BMP16_256x256 | BG_BMP_BASE(0)  |  BG_PRIORITY(3);  
<br/>
      }
<br/>
      else
<br/>
      {   
<br/>
         m_fbMainScr=m_fbMainScr1;
<br/>
         BG3_CR = BG_BMP16_256x256 | BG_BMP_BASE(8)  |  BG_PRIORITY(3);
<br/>
      }
<br/>
      //if you'd like to use the virtual framebuffer for the sub screen, copy it here 
<br/>
      
<br/>
<br/>
   }
<br/>
<br/>
<br/>
    //just to test
<br/>
   void drawRectangleMainScreen (int posX, int posY, int sizeX, int sizeY, u16 color)
<br/>
   {
<br/>
      //handle out of limits rectangle
<br/>
<br/>
      for (int i=posX; i&lt;posX+sizeX; i+=1)
<br/>
         for (int j=posY; j&lt;posY+sizeY; j+=1)
<br/>
            m_fbMainScr[i*256+j]= color;
<br/>
<br/>
   }
<br/>
<br/>
private:
<br/>
   //main screen framebuffer  #1
<br/>
   u16* m_fbMainScr1;
<br/>
<br/>
   //main screen framebuffer  #2
<br/>
   u16* m_fbMainScr2;
<br/>
<br/>
   //main screen framebuffer actual
<br/>
   u16* m_fbMainScr;
<br/>
<br/>
   //sub screen framebuffer 
<br/>
   u16* m_fbSubScr;
<br/>
<br/>
   //emulated sub screen framebuffer  (it is crashing the rom ? )
<br/>
   //u16 m_fbSubScrEmulated [256*256];//use or not use it, it is the question
<br/>
<br/>
   bool m_drawingMainScr1;
<br/>
<br/>
};
<br/>
<br/>
<br/>
#endif</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#129514 - jespa - Wed May 23, 2007 10:58 am</h4>
    <div class="postbody"><span class="postbody">Hi,
<br/>
<br/>
I has been tested your code and works fine one my "iris" emulator.
<br/>
But I founded an incomplete code in your init video and swap screens.
<br/>
<br/>
You have to wait VBlank before to swap the screens. The code that is absent I show it now,
<br/>
<br/>
<br/>
void DSVideo::init(void)
<br/>
{
<br/>
<br/>
     	irqInit();
<br/>
        irqSet(IRQ_VBLANK, 0);
<br/>
<br/>
        ....
<br/>
}
<br/>
<br/>
void DSvideo::SwapBuffers(void)
<br/>
{
<br/>
<br/>
       swiWaitForVBlank();
<br/>
<br/>
        ....
<br/>
<br/>
<br/>
}
<br/>
<br/>
I hope that I have helped you in some thing.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#129533 - odelot - Wed May 23, 2007 4:14 pm</h4>
    <div class="postbody"><span class="postbody">hi.. thanks.. i am glad that some one tested the code and gave a feedback
<br/>
<br/>
I had put this code to wait de vblank interrupt outside the DSVideo class, that?s way it isnt there.. but is a good idea to put inside the DSVideo.. thanks..
<br/>
<br/>
one guy said that we can do double buffering on sub screen in hardware with sprites (like the do to make 3D on both screen)... i won't  try right know (if someone wants to updates this code with this, feel free to make it), but probably i will try it son (one week or two)
<br/>
<br/>
ah, I updated this code, and put tile based char to use to write text on both screen and tile based keyboard on both screen too... and to save memory i put the both tile information in one tile bank and used two maps and two pallets to represent them.. (here is the example with just the tile based chars working <a href="http://forum.gbadev.org/viewtopic.php?t=13253" target="_blank">http://forum.gbadev.org/viewtopic.php?t=13253</a>)
<br/>
<br/>
if you want, i can upload it... but i need to finish yet the stylus event and the keyboard test to give the keys events from keyboard</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
