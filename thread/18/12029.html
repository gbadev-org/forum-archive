<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Tweening code needs optimization - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > Tweening code needs optimization</h2>
<div id="posts">
<div class="post">
    <h4>#113319 - Lick - Tue Dec 26, 2006 4:07 pm</h4>
    <div class="postbody"><span class="postbody">I've ported some ActionScript tweening code (originally written by Robert Penner) to C, and it's now time to optimize it.
<br/>
<br/>
<a href="http://rafb.net/p/7ERmrV74.html" target="_blank">http://rafb.net/p/7ERmrV74.html</a> - <a class="postlink" href="http://rafb.net/p/7ERmrV74.html" target="_blank">tween.c</a>
<br/>
<a href="http://rafb.net/p/rDb5ug58.html" target="_blank">http://rafb.net/p/rDb5ug58.html</a> - <a class="postlink" href="http://rafb.net/p/rDb5ug58.html" target="_blank">tween.h</a>
<br/>
<br/>
Anyone know where to start? Fixed-point? ARM assembly?
<br/>
<br/>
<span style="font-weight: bold">By the way, it's works already. So if you want to use it, go ahead!</span><br/>_________________<br/><a class="postlink" href="http://licklick.wordpress.com" target="_blank">http://licklick.wordpress.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#113322 - strager - Tue Dec 26, 2006 4:57 pm</h4>
    <div class="postbody"><span class="postbody">I'd suggest you start converting all those floats into fixed-point integers, then using LUT's in-place of those costly trig. functions, perhaps optimizing the calls to sqrt32 along the way.
<br/>
After this you could optimize with ARM assembly.  THUMB doesn't seem practical to me, with a lot of shifts (for fixed-point conversion) and multiplies everywhere.
<br/>
<br/>
Take it one function at a time, and be sure to check that everything works properly after every change.  You don't want to learn the hard way...
<br/>
<br/>
If you want to use C++, a fixed point class may help in the conversion (convert from float to fixed easily, and vice versa, with simple typecasting).  Of course, you can bring it back to C once everything is working fine.
<br/>
<br/>
Just some suggestions from an inexperienced programmer.  =X</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#113331 - Lick - Tue Dec 26, 2006 8:03 pm</h4>
    <div class="postbody"><span class="postbody">Doing the floating point -&gt; fixed point conversion right now. It seems so backwards adding much more lines for supposedly faster execution speed.
<br/>
Hope it really matters.<br/>_________________<br/><a class="postlink" href="http://licklick.wordpress.com" target="_blank">http://licklick.wordpress.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#113334 - OOPMan - Tue Dec 26, 2006 8:29 pm</h4>
    <div class="postbody"><span class="postbody">For floating-to-fixed I'd guess it does, since software emu of Floating Point is sloooooooooooooow...
<br/>
<br/>
I'd try and avoid the SQRTs if possible as well...<br/>_________________<br/>"My boot, your face..." - Attributed to OOPMan, Emperor of Eroticon VI
<br/>
<br/>
You can find my NDS homebrew projects <a class="postlink" href="http://blog.dev-scene.com/oopman/" target="_blank">here...</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#113339 - sajiimori - Tue Dec 26, 2006 9:26 pm</h4>
    <div class="postbody"><span class="postbody">Lick, going by your "lines of code" measurement of speed, which of these functions is the fastest, and which is the slowest?</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">int test1(int n)
<br/>
{
<br/>
  for(int i = 0; i &lt; 100; ++i)
<br/>
    n += 5;
<br/>
}
<br/>
<br/>
int test2(int n)
<br/>
{
<br/>
  ++n;
<br/>
  ++n;
<br/>
  ++n;
<br/>
  ++n;
<br/>
  return n;
<br/>
}
<br/>
<br/>
int test3(int n)
<br/>
{
<br/>
  int f(int);
<br/>
  return f(n);
<br/>
}</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#113343 - Lick - Tue Dec 26, 2006 9:58 pm</h4>
    <div class="postbody"><span class="postbody">Well, it's not lines of code. More of, the amount of operations. A simple multiply * by the compiler vs. all those fixed point operations.<br/>_________________<br/><a class="postlink" href="http://licklick.wordpress.com" target="_blank">http://licklick.wordpress.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#113346 - Lick - Tue Dec 26, 2006 10:19 pm</h4>
    <div class="postbody"><span class="postbody"><a class="postlink" href="http://www.box.net/public/at6hsza9lh" target="_blank">Here</a> is the almost fixed-point (I haven't fully converted sine and circular easing yet) binary + source.
<br/>
I'm going to finish the conversion later this week (will only take a few minutes) and then I'll compare it to the original floating point implementation.
<br/>
That should be interesting.
<br/>
<br/>
- Lick<br/>_________________<br/><a class="postlink" href="http://licklick.wordpress.com" target="_blank">http://licklick.wordpress.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#113347 - sajiimori - Tue Dec 26, 2006 10:33 pm</h4>
    <div class="postbody"><span class="postbody">If only using a language with built-in floating-point operations automatically imbued processors with FPUs!  Such magic would certainly reduce the cost of manufacturing.
<br/>
<br/>
Alas, compilers must produce code that actually runs on the target processors, in this case by inserting calls to functions that perform floating-point math using a long series of integer instructions.
<br/>
<br/>
<span style="font-weight: bold">gcc -S</span> is your friend.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#113356 - tepples - Tue Dec 26, 2006 11:59 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Lick wrote:</b></span></td> </tr> <tr> <td class="quote">Well, it's not lines of code. More of, the amount of operations. A simple multiply * by the compiler vs. all those fixed point operations.</td> </tr></table><span class="postbody">
<br/>
Then make your own C++ class that overrides operator *. The DS has enough RAM for C++'s overhead to be worth it.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#113358 - Lick - Wed Dec 27, 2006 12:04 am</h4>
    <div class="postbody"><span class="postbody">That would be easy to do (much easier), but I restricted myself to C this time. Just to make it more portable. (And perhaps for later use on the ARM7)<br/>_________________<br/><a class="postlink" href="http://licklick.wordpress.com" target="_blank">http://licklick.wordpress.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#113361 - kusma - Wed Dec 27, 2006 1:36 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Lick wrote:</b></span></td> </tr> <tr> <td class="quote">That would be easy to do (much easier), but I restricted myself to C this time. Just to make it more portable. (And perhaps for later use on the ARM7)</td> </tr></table><span class="postbody">
<br/>
<br/>
The ARM7 also has no problems running C++-code. As long as you're gcc-based, there's no portability-reason to prefer C over C++ either. Sure, pure C is neat if you consider porting your code to some obscure micro-controller, but I strongly doubt that's the case. Myself, I'm using a templated fixed point class for "seamless" switching between float and fixed point arithmetic, and it's really worth it. One compile-time define, and you'll find out if your bug is due to fixed point range/precision-issues or not. And you'll be able to add assertions on overflows etc. It's REALLY convenient for the non-critical code in your projects.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#113368 - tepples - Wed Dec 27, 2006 3:00 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>kusma wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Lick wrote:</b></span></td> </tr> <tr> <td class="quote">That would be easy to do (much easier), but I restricted myself to C this time. Just to make it more portable. (And perhaps for later use on the ARM7)</td> </tr></table><span class="postbody">
<br/>
The ARM7 also has no problems running C++-code.</span></td> </tr></table><span class="postbody">
<br/>
I compiled the source code of one of the simplest libnds examples as C and as C++, and the C++ was 7 times bigger. (Results on GCC targeting Windows, on the other hand, contradicted this.) This is a problem if you're trying to fit your entire ARM7 program into its IWRAM. Do you want me to build a test case?<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#113371 - kusma - Wed Dec 27, 2006 3:07 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tepples wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>kusma wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Lick wrote:</b></span></td> </tr> <tr> <td class="quote">That would be easy to do (much easier), but I restricted myself to C this time. Just to make it more portable. (And perhaps for later use on the ARM7)</td> </tr></table><span class="postbody">
<br/>
The ARM7 also has no problems running C++-code.</span></td> </tr></table><span class="postbody">
<br/>
I compiled the source code of one of the simplest libnds examples as C and as C++, and the C++ was 7 times bigger. (Results on GCC targeting Windows, on the other hand, contradicted this.) This is a problem if you're trying to fit your entire ARM7 program into its IWRAM. Do you want me to build a test case?</span></td> </tr></table><span class="postbody">
<br/>
<br/>
I have, and I've found no size-issues as long as you remember to disable rtti and exceptions.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#113383 - HyperHacker - Wed Dec 27, 2006 6:38 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>sajiimori wrote:</b></span></td> </tr> <tr> <td class="quote">Lick, going by your "lines of code" measurement of speed, which of these functions is the fastest, and which is the slowest?<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">int test1(int n)
<br/>
{
<br/>
  for(int i = 0; i &lt; 100; ++i)
<br/>
    n += 5;
<br/>
}
<br/>
<br/>
int test2(int n)
<br/>
{
<br/>
  ++n;
<br/>
  ++n;
<br/>
  ++n;
<br/>
  ++n;
<br/>
  return n;
<br/>
}
<br/>
<br/>
int test3(int n)
<br/>
{
<br/>
  int f(int);
<br/>
  return f(n);
<br/>
}</td> </tr></table><span class="postbody"></span></td> </tr></table><span class="postbody">
<br/>
<br/>
Well the first one never returns its result so it's not of much use. The second would be optimized to "return n+4", and I'm not sure what the third even does.<br/>_________________<br/>I'm a PSP hacker now, but I still &lt;3 DS.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#113388 - sajiimori - Wed Dec 27, 2006 7:33 am</h4>
    <div class="postbody"><span class="postbody">HyperHacker, the first example does return, though the compiler may warn, the second example depends on the compiler and options (which is part of the point), and the whole point of the third example is that you don't know how fast it is even if you look at the compiler's output.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#113787 - dXtr - Sat Dec 30, 2006 4:28 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tepples wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
I compiled the source code of one of the simplest libnds examples as C and as C++, and the C++ was 7 times bigger. (Results on GCC targeting Windows, on the other hand, contradicted this.) This is a problem if you're trying to fit your entire ARM7 program into its IWRAM. Do you want me to build a test case?</td> </tr></table><span class="postbody">
<br/>
<br/>
did you try to strip out all the "junk", like the rtti and exception support?<br/>_________________<br/>go back to coding and stop screaming wolf :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#113790 - tepples - Sat Dec 30, 2006 4:41 pm</h4>
    <div class="postbody"><span class="postbody">Shouldn't the compiler strip out exception support if there isn't any throw in the project and RTTI support if there aren't any virtual methods in the project?<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#113968 - sajiimori - Tue Jan 02, 2007 12:20 am</h4>
    <div class="postbody"><span class="postbody">Stripping out stack unwinding code would be a job for the linker, and whether it's even possible depends on the way exceptions are implemented on the platform.  I've always had to specify -fno-exceptions.
<br/>
<br/>
Not sure about RTTI; it's worth checking out if you don't need dynamic_cast.  (I use it often enough to leave RTTI on.)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#131325 - a128 - Thu Jun 14, 2007 11:18 am</h4>
    <div class="postbody"><span class="postbody"><a class="postlink" href="http://www.freewebtown.com/festival2005/fixed.tgz" target="_blank">http://www.freewebtown.com/festival2005/fixed.tgz</a>
<br/>
<br/>
a fixedpoint C++ class 
<br/>
includes  some test code....works fine I guess
<br/>
includes sin,cos stuff on top of libnds</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
