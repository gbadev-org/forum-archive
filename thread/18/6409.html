<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Wrong scale for Touchscreen on all homebrew roms - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > Wrong scale for Touchscreen on all homebrew roms</h2>
<div id="posts">
<div class="post">
    <h4>#49072 - Dwedit - Tue Jul 26, 2005 6:04 am</h4>
    <div class="postbody"><span class="postbody">The scale for calibration is totally out of whack.  Clicking on the edge instead clicks on a pixel around 16 pixels towards the center of the screen.  So drawing a box in DS paint instead draws a box about 16 pixels away from the edge in all directions.  It's also impossible to click on buttons at the top or bottom or sides of the screen.
<br/>
Sounds like buggy touchscreen code in a common nds library.
<br/>
Commercial games work perfectly, aside from the occasional problem where it spontaneously moves to the bottom of the screen for one frame.
<br/>
<br/>
Edit: Doing a re-calibrate fixed the problems, but why was it broken for non-commercial games in the first place?<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"><br/><br/>Last edited by Dwedit on Tue Jul 26, 2005 6:54 am; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#49075 - dovoto - Tue Jul 26, 2005 6:38 am</h4>
    <div class="postbody"><span class="postbody">Seems dead-on to me.  Did you forget to recalibrate after doing flashme?<br/>_________________<br/><a href="http://www.drunkencoders.com" target="_blank">www.drunkencoders.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#49091 - Freakreation - Tue Jul 26, 2005 11:05 am</h4>
    <div class="postbody"><span class="postbody">I think I have this problem, I updated my firmware before trying battleship DS and I assumed there was a problem with the code (since I hadn't previousely tried any demos before using FlashMe). I never read anything about having to re-calibrate the touch screen.
<br/>
<br/>
Looking again at the FlashMe instructions it doesn't mention it on there at all. I shall try it out now tho. =)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#49105 - dovoto - Tue Jul 26, 2005 3:59 pm</h4>
    <div class="postbody"><span class="postbody">Flashme over-writes all those settings....hopefully this is the only issue. Let me know if it does not fix it and then we will look into the ndslib code and see if we cant find the cause.<br/>_________________<br/><a href="http://www.drunkencoders.com" target="_blank">www.drunkencoders.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#49110 - MrAdults - Tue Jul 26, 2005 5:22 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Flashme over-writes all those settings....hopefully this is the only issue. Let me know if it does not fix it and then we will look into the ndslib code and see if we cant find the cause.</td> </tr></table><span class="postbody">
<br/>
<br/>
I have this issue with my touchscreen as well. It's perfectly accurate in commercial games (such as Super Mario 64), but homebrew stuff seems to not scale to the edges properly so everything is more toward the center than it should be.
<br/>
<br/>
I haven't used FlashMe, and it's also worth noting that I've never manually calibrated my DS. I'm wondering if maybe the location in memory that calibration data is read from (as we do things now) is only valid if the system has been manually calibrated already. I've been meaning to do some testing on this myself but I haven't gotten around to it yet.
<br/>
<br/>
-Rich</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#49112 - dovoto - Tue Jul 26, 2005 5:27 pm</h4>
    <div class="postbody"><span class="postbody">I will look at me ds more closely tonight.  Maybe i just have not noticed this error.<br/>_________________<br/><a href="http://www.drunkencoders.com" target="_blank">www.drunkencoders.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#49117 - natrium42 - Tue Jul 26, 2005 5:59 pm</h4>
    <div class="postbody"><span class="postbody">I think it's because of different calibration points. Precalibrated DS uses calibration points 16 pixels from the edge, but manual calibration has control points that are 32 pixels from the edge. Anyway, it can be fixed with a corrected calculation routine, AFAIK.
<br/>
<br/>
EDIT: I might be wrong with the numbers.<br/>_________________<br/><a class="postlink" href="http://www.natrium42.com" target="_blank">www.natrium42.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#49119 - Sausage Boy - Tue Jul 26, 2005 6:16 pm</h4>
    <div class="postbody"><span class="postbody">Yes! Finally other people have my problem!
<br/>
<br/>
I get the same thing exactly, perfect calibration in commercial games. In homebrew games, the touch is moved slightly towards the center, depending on how far away from it you touch. I've tried recalibrating, I've even tried calibrating it wrong so it would be right, but nothing works...<br/>_________________<br/>"no offense, but this is the gayest game ever"</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#49123 - natrium42 - Tue Jul 26, 2005 6:34 pm</h4>
    <div class="postbody"><span class="postbody">There are a few more registers besides TOUCH_CAL_xx that give the location of control points. Currenty, those registers are not used and it's assumed that the control points used for callibration were at one certain location.
<br/>
<br/>
Don't have the registers at hand right now, though...<br/>_________________<br/><a class="postlink" href="http://www.natrium42.com" target="_blank">www.natrium42.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#49126 - Freakreation - Tue Jul 26, 2005 6:43 pm</h4>
    <div class="postbody"><span class="postbody">yep I just re-calibrated and still have the same problem with Battleships mainly towards the bottom of the screen it seems to be distorted.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#49131 - natrium42 - Tue Jul 26, 2005 6:57 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Freakreation wrote:</b></span></td> </tr> <tr> <td class="quote">yep I just re-calibrated and still have the same problem with Battleships mainly towards the bottom of the screen it seems to be distorted.</td> </tr></table><span class="postbody">
<br/>
Battleship has a very poor touchscreen routine... I should really start working on it again :)<br/>_________________<br/><a class="postlink" href="http://www.natrium42.com" target="_blank">www.natrium42.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#49284 - natrium42 - Thu Jul 28, 2005 5:05 am</h4>
    <div class="postbody"><span class="postbody">Here is the correct way to read touchscreen. Should also work with factory calibrated DS.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#define SCREEN_WIDTH   256
<br/>
#define SCREEN_HEIGHT   192
<br/>
<br/>
// those are pixel positions of the two points you click when calibrating
<br/>
#define TOUCH_CNTRL_X1   (*(vu8*)0x027FFCDC)
<br/>
#define TOUCH_CNTRL_Y1   (*(vu8*)0x027FFCDD)
<br/>
#define TOUCH_CNTRL_X2   (*(vu8*)0x027FFCE2)
<br/>
#define TOUCH_CNTRL_Y2   (*(vu8*)0x027FFCE3)
<br/>
<br/>
// those are the corresponding touchscreen values:
<br/>
#define TOUCH_CAL_X1   (*(vu16*)0x027FFCD8)
<br/>
#define TOUCH_CAL_Y1   (*(vu16*)0x027FFCDA)
<br/>
#define TOUCH_CAL_X2   (*(vu16*)0x027FFCDE)
<br/>
#define TOUCH_CAL_Y2   (*(vu16*)0x027FFCE0)
<br/>
<br/>
// linear mapping can be used to go from touchscreen position to pixel position
<br/>
<br/>
// precalculate some values
<br/>
static int16 TOUCH_WIDTH  = TOUCH_CAL_X2 - TOUCH_CAL_X1;
<br/>
static int16 TOUCH_HEIGHT = TOUCH_CAL_Y2 - TOUCH_CAL_Y1;
<br/>
static int16 CNTRL_WIDTH  = TOUCH_CNTRL_X2 - TOUCH_CNTRL_X1;
<br/>
static int16 CNTRL_HEIGHT = TOUCH_CNTRL_Y2 - TOUCH_CNTRL_Y1;
<br/>
<br/>
<br/>
// reading pixel position:
<br/>
int16 x = (IPC-&gt;touchX - (int16) TOUCH_CAL_X1) * CNTRL_WIDTH  / TOUCH_WIDTH  + (int16) TOUCH_CNTRL_X1;
<br/>
int16 y = (IPC-&gt;touchY - (int16) TOUCH_CAL_Y1) * CNTRL_HEIGHT / TOUCH_HEIGHT + (int16) TOUCH_CNTRL_Y1;
<br/>
</td> </tr></table><span class="postbody"><br/>_________________<br/><a class="postlink" href="http://www.natrium42.com" target="_blank">www.natrium42.com</a></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
