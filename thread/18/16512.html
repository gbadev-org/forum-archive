<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Custom routine for KEY_LID and defaultExceptionHandler - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > Custom routine for KEY_LID and defaultExceptionHandler</h2>
<div id="posts">
<div class="post">
    <h4>#167228 - Echo49 - Fri Mar 06, 2009 6:31 am</h4>
    <div class="postbody"><span class="postbody">libnds has a built in routine when it detects a lid close, but how can I write my own?</span><span class="gensmall"><br/><br/>Last edited by Echo49 on Fri Mar 06, 2009 10:13 pm; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#167229 - Dwedit - Fri Mar 06, 2009 9:05 am</h4>
    <div class="postbody"><span class="postbody">The normal process is that the ARM7 checks if the screen has been closed for 20 frames, then sends the ARM9 a request for sleep mode.
<br/>
Then the ARM9 sends a sleep confirmation to the ARM7, which makes the ARM7 put the system to sleep.
<br/>
<br/>
You will need to replace Libnds's default ARM9 FIFO_PM handler with your own.
<br/>
The default handler checks if the message is PM_REQ_SLEEP, then tells the ARM9 to call systemSleep(), which tells the ARM7 to put the system in sleep mode.
<br/>
<br/>
Your replacement handler should look like this:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
void MY_powerValueHandler(u32 value, void* data){
<br/>
    switch(value)
<br/>
    {
<br/>
        case PM_REQ_SLEEP:
<br/>
        {
<br/>
            //Your Code Here
<br/>
        }
<br/>
        break;
<br/>
        default:
<br/>
        {
<br/>
            powerValueHandler(value,data); //call the default power value handler for other cases
<br/>
        }
<br/>
    }
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
Note: the only case handled by libnds's ARM9 powerValueHandler is sleep mode request, so this example code to handle the default case does absolutely nothing, but if the LibNDS team ever adds anything more here, it will be future-ready.
<br/>
<br/>
When you want the DS to sleep, call systemSleep().  If you don't call systemSleep within 20 frames of receiving a sleep request, the ARM7 will repeatedly send you a sleep request every 20 frames.
<br/>
<br/>
My reccomendation for the "Your Code Here" is to just set a flag, and let the normal code handle the request.  For example, you could pause game logic, play a sound effect, wait for the sound effect to finish, then enter sleep mode.  You can also check if the screen has been opened since you started playing the sound effect, and make it not sleep.
<br/>
<br/>
To install the replacement for powerValueHandler, run this:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
    fifoSetValue32Handler(FIFO_PM, MY_powerValueHandler, 0);
<br/>
</td> </tr></table><span class="postbody"><br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167245 - Echo49 - Fri Mar 06, 2009 10:13 pm</h4>
    <div class="postbody"><span class="postbody">Thank you, I will be trying that.
<br/>
<br/>
On the note of custom handlers, how would I go about modifying the defaultExceptionHandler to dumping the register and stack information not to the screen, but to a file? Is this possible?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167294 - Echo49 - Sun Mar 08, 2009 10:26 am</h4>
    <div class="postbody"><span class="postbody">OK, I've poked around and found the setExceptionHandler() and the defaultHandler() functions, the latter from which (I think) I can copy most of the dumping code.
<br/>
<br/>
I guess the question now is, can I use file operations inside the handler? For example, calling fopen()/fclose() and replacing the iprintf() with fprintf()?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#168571 - FluBBa - Wed May 06, 2009 1:57 pm</h4>
    <div class="postbody"><span class="postbody">Sorry for hijacking this old thread but it was the only one I found that had anything to do with systemSleep.
<br/>
What should I do if I want to put the NDS to sleep without it being closed?
<br/>
I tried to call systemSleep from the ARM9 but it didn't work at all, on HW the screen flashes once and on No$GBA the sound just stops working.
<br/>
So is there any message I should send to the ARM7 or how can this be done?
<br/>
(I want to have a autosleep timeout, waking up by either closing/opening the lid or a key combo).<br/>_________________<br/>I probably suck, my not is a programmer.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#168572 - elhobbs - Wed May 06, 2009 3:25 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>FluBBa wrote:</b></span></td> </tr> <tr> <td class="quote">Sorry for hijacking this old thread but it was the only one I found that had anything to do with systemSleep.
<br/>
What should I do if I want to put the NDS to sleep without it being closed?
<br/>
I tried to call systemSleep from the ARM9 but it didn't work at all, on HW the screen flashes once and on No$GBA the sound just stops working.
<br/>
So is there any message I should send to the ARM7 or how can this be done?
<br/>
(I want to have a autosleep timeout, waking up by either closing/opening the lid or a key combo).</td> </tr></table><span class="postbody">the systemSleep functionality is hardcoded to wake on IRQ_LID. I am not sure if this will prevent it from sleeping since the lid is never closed. you could try a custom handler on the arm7 that wakes on IRQ_KEYS instead.
<br/>
<br/>
you may already know this (and it does not appear to be related to your current issue) but sleeping on lid close is not on by default. it needs to be enabled by sending PM_REQ_SLEEP_ENABLE to the arm7.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#168573 - FluBBa - Wed May 06, 2009 4:33 pm</h4>
    <div class="postbody"><span class="postbody">Hmmm, I can see a potential problem about the lid open/close checking, maybe I have to skip that function.
<br/>
About sleeping when closing the lid, I haven't touched anything about the ARM7 yet but it works as is and I was hoping I wouldn't need to code anything specific for the ARM7 now that libnds is starting to support most common tasks.<br/>_________________<br/>I probably suck, my not is a programmer.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#168574 - elhobbs - Wed May 06, 2009 5:09 pm</h4>
    <div class="postbody"><span class="postbody">if you are trying to save battery - maybe just turn off the backlights instead.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#168576 - FluBBa - Wed May 06, 2009 9:40 pm</h4>
    <div class="postbody"><span class="postbody">I guess I just do something like that instead.<br/>_________________<br/>I probably suck, my not is a programmer.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#168577 - Dwedit - Wed May 06, 2009 11:06 pm</h4>
    <div class="postbody"><span class="postbody">deleteme<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#168584 - a128 - Thu May 07, 2009 5:39 pm</h4>
    <div class="postbody"><span class="postbody">Powermanagment  was all done very well here
<br/>
<br/>
<a href="http://meraman.dip.jp/index.php?NDS_POWER_ENG" target="_blank">http://meraman.dip.jp/index.php?NDS_POWER_ENG</a><br/>_________________<br/>"Hey! It compiles! Ship it!"</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#169117 - Echo49 - Sat Jun 20, 2009 12:52 pm</h4>
    <div class="postbody"><span class="postbody">Reviving this...
<br/>
<br/>
At the moment, if defaultExceptionHandler is used to dump register information on a crash, No$gba doesn't display the text. There's a problem with my code that somehow only seems to crash No$gba, but not hardware.
<br/>
<br/>
Since Martin's disappeared, I can't grab a debug copy of No$gba. Is there anything I can do to find out the state of the emulator when it crashes? Does <a class="postlink" href="http://libnds.devkitpro.org/a00069.html" target="_blank">nocashMessage()</a> only work with the debugger version of No$gba?
<br/>
<br/>
Also, I think the crash only started happening after I updated to r26. I compiled using r26 an older version of my game which I know worked fine on No$gba when compiled with r25, which crashed in the same manner.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
