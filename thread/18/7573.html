<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Messed texture loading md2 - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>DS development > Messed texture loading md2</h2>
<div id="posts">
<div class="post">
    <h4>#61727 - Webez - Tue Nov 22, 2005 10:09 pm</h4>
    <div class="postbody"><span class="postbody">Hi. 
<br/>
<br/>
Let's see if someone can help me this time (it seems I ask boring questions). I'm doing a direct md2 loader for nds. I put  .md2 and .pcx files in the data directory so they can be converted to .bin. The .pcx is 256x256, 8 bits. The model shows ok but there is something wrong with the texture mapping. 
<br/>
<br/>
This piece of code shows how textcoords are loaded from md2
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">   for (i=0;i&lt;md2Header-&gt;numTexCoords;i++){
<br/>
      memcpy(m_pTexCoords, &amp;file[indice+(i*sizeof(tMd2TexCoord))], sizeof(tMd2TexCoord));   
<br/>
      mesh-&gt;maps.push_back(new DS_TexMap(intot16(m_pTexCoords-&gt;u),intot16(256-m_pTexCoords-&gt;v)));
<br/>
      
<br/>
   }</td> </tr></table><span class="postbody">
<br/>
<br/>
This is how texcoords are used
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">glTexCoord2t16(mesh-&gt;maps[mesh-&gt;mapIndex[i]-&gt;indexA]-&gt;u,mesh-&gt;maps[mesh-&gt;mapIndex[i]-&gt;indexA]-&gt;v);</td> </tr></table><span class="postbody">
<br/>
<br/>
And texture is loaded like this
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">   sImage file;  
<br/>
   int texture,sizeX,sizeY;
<br/>
<br/>
   loadPCX((u8*)name, &amp;file);
<br/>
<br/>
   image8to16(&amp;file);
<br/>
<br/>
   switch (file.height){
<br/>
      case 8: sizeX= TEXTURE_SIZE_8;
<br/>
            break;
<br/>
      case 16: sizeX= TEXTURE_SIZE_16; 
<br/>
            break;
<br/>
      case 32: sizeX= TEXTURE_SIZE_32;
<br/>
            break;
<br/>
      case 64: sizeX= TEXTURE_SIZE_64;
<br/>
            break;
<br/>
      case 128: sizeX= TEXTURE_SIZE_128;
<br/>
            break;
<br/>
      case 256: sizeX= TEXTURE_SIZE_256;
<br/>
            break;            
<br/>
      case 512: sizeX= TEXTURE_SIZE_512;
<br/>
            break;            
<br/>
      case 1024: sizeX= TEXTURE_SIZE_1024; 
<br/>
            break;
<br/>
      default: return 0;
<br/>
   }
<br/>
<br/>
   switch (file.width){
<br/>
      case 8: sizeY= TEXTURE_SIZE_8;
<br/>
            break;
<br/>
      case 16: sizeY= TEXTURE_SIZE_16; 
<br/>
            break;
<br/>
      case 32: sizeY= TEXTURE_SIZE_32;
<br/>
            break;
<br/>
      case 64: sizeY= TEXTURE_SIZE_64;
<br/>
            break;
<br/>
      case 128: sizeY= TEXTURE_SIZE_128;
<br/>
            break;
<br/>
      case 256: sizeY= TEXTURE_SIZE_256;
<br/>
            break;            
<br/>
      case 512: sizeY= TEXTURE_SIZE_512;
<br/>
            break;            
<br/>
      case 1024: sizeY= TEXTURE_SIZE_1024; 
<br/>
            break;
<br/>
      default: return 0;
<br/>
   }
<br/>
<br/>
   glGenTextures(1, &amp;texture);
<br/>
   glBindTexture(0, texture);
<br/>
<br/>
   glTexImage2D(0, 0, GL_RGB, sizeX , sizeY, 0, TEXGEN_TEXCOORD, file.data8);
<br/>
<br/>
   imageDestroy(&amp;file);</td> </tr></table><span class="postbody">
<br/>
<br/>
<br/>
<br/>
I also have upload a demo that shows the problem.
<br/>
<br/>
<a class="postlink" href="http://www.4shared.com/file/506245/312bee26/md2.html" target="_blank">http://www.4shared.com/file/506245/312bee26/md2.html</a>
<br/>
<br/>
Thanks</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#61821 - duencil - Thu Nov 24, 2005 12:34 am</h4>
    <div class="postbody"><span class="postbody">what's the range of your texture coords?  Discounting tiling they should be scaled to 0-255 for your 256x256 texture ), not 0-1</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#61866 - Webez - Thu Nov 24, 2005 10:21 am</h4>
    <div class="postbody"><span class="postbody">I was using the texture coords as you get them from the md2 file (because as far as I know they are 0-255). The only thing I do is flipping v coord as it is done in all loaders I have seen.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#61908 - duencil - Thu Nov 24, 2005 10:16 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Webez wrote:</b></span></td> </tr> <tr> <td class="quote">I was using the texture coords as you get them from the md2 file (because as far as I know they are 0-255). The only thing I do is flipping v coord as it is done in all loaders I have seen.</td> </tr></table><span class="postbody">
<br/>
<br/>
Right, I wasn't aware of the md2 file format specs.  Anyway if your data's coming in in the range 0-255 and you want to flip the v, it should be 255-v, not 256. That's probably not your issue, as most of your uvs would be more or less correct.  What are you seeing?
<br/>
<br/>
obvious question, you're using a temporary pointer to read the text coords to in the loading (m_pTexCoords).  What is that, a member variable pointing to a temporary variable? If its an array, its no problem, but it is pointing to something, right?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#61909 - Webez - Thu Nov 24, 2005 10:38 pm</h4>
    <div class="postbody"><span class="postbody">I have already changed 256 to 255 and it was the same as before. As for the other thing I use a pointer to load values into a vector. I have checked that those values are the same I have kept in the vector when drawing the model
<br/>
<br/>
This exactly how it is quake coords are loaded once I have read the header
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">   tMd2TexCoord *m_pTexCoords = new tMd2TexCoord;
<br/>
   indice=md2Header-&gt;offsetTexCoords;   
<br/>
<br/>
   for (i=0;i&lt;md2Header-&gt;numTexCoords;i++){
<br/>
      memcpy(m_pTexCoords, &amp;file[indice+(i*sizeof(tMd2TexCoord))], sizeof(tMd2TexCoord));   
<br/>
      mesh-&gt;maps.push_back(new DS_TexMap(intot16(m_pTexCoords-&gt;u),intot16(255-m_pTexCoords-&gt;v)));
<br/>
   }
<br/>
delete m_pTexCoords;</td> </tr></table><span class="postbody">
<br/>
<br/>
<br/>
The class where I keep data
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">class DS_Mesh  
<br/>
{
<br/>
public:
<br/>
   std::vector &lt;DS_Vertex *&gt; vertex;
<br/>
   std::vector &lt;DS_Index *&gt; polIndex;
<br/>
   std::vector &lt;DS_Index *&gt; mapIndex;
<br/>
   std::vector &lt;DS_TexMap *&gt; maps;
<br/>
         ........
<br/>
</td> </tr></table><span class="postbody">
<br/>
For drawing models
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">      glBegin(GL_TRIANGLE);
<br/>
      for(unsigned int i = 0; i &lt; mesh-&gt;polIndex.size(); i++){
<br/>
         glTexCoord2t16(mesh-&gt;maps[mesh-&gt;mapIndex[i]-&gt;indexA]-&gt;u,mesh-&gt;maps[mesh-&gt;mapIndex[i]-&gt;indexA]-&gt;v);
<br/>
         glVertex3v16(mesh-&gt;vertex[mesh-&gt;polIndex[i]-&gt;indexA+frame]-&gt;x, mesh-&gt;vertex[mesh-&gt;polIndex[i]-&gt;indexA+frame]-&gt;y, mesh-&gt;vertex[mesh-&gt;polIndex[i]-&gt;indexA+frame]-&gt;z );
<br/>
         glTexCoord2t16(mesh-&gt;maps[mesh-&gt;mapIndex[i]-&gt;indexB]-&gt;u,mesh-&gt;maps[mesh-&gt;mapIndex[i]-&gt;indexB]-&gt;v);
<br/>
         glVertex3v16(mesh-&gt;vertex[mesh-&gt;polIndex[i]-&gt;indexB+frame]-&gt;x, mesh-&gt;vertex[mesh-&gt;polIndex[i]-&gt;indexB+frame]-&gt;y, mesh-&gt;vertex[mesh-&gt;polIndex[i]-&gt;indexB+frame]-&gt;z );
<br/>
         glTexCoord2t16(mesh-&gt;maps[mesh-&gt;mapIndex[i]-&gt;indexC]-&gt;u,mesh-&gt;maps[mesh-&gt;mapIndex[i]-&gt;indexC]-&gt;v);
<br/>
         glVertex3v16(mesh-&gt;vertex[mesh-&gt;polIndex[i]-&gt;indexC+frame]-&gt;x, mesh-&gt;vertex[mesh-&gt;polIndex[i]-&gt;indexC+frame]-&gt;y, mesh-&gt;vertex[mesh-&gt;polIndex[i]-&gt;indexC+frame]-&gt;z );   
<br/>
      }
<br/>
glEnd();</td> </tr></table><span class="postbody">
<br/>
<br/>
<br/>
Thanks</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#62015 - Webez - Sat Nov 26, 2005 2:59 pm</h4>
    <div class="postbody"><span class="postbody">Finally I have found the problem. I have had to rotate the texture 90? left beacuse u,v coords in libnds are not the same as u,v coords  in opengl.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
