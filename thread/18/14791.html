<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Texture incorrect when drawn from file different than loaded - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > Texture incorrect when drawn from file different than loaded</h2>
<div id="posts">
<div class="post">
    <h4>#148457 - stevens - Sun Jan 06, 2008 12:40 am</h4>
    <div class="postbody"><span class="postbody">I restructured my program so it's not one big file.  Once I did this textures aren't displayed properly.  I'm at a loss as to why.  I wrote a sample program which shows this behavior.
<br/>
<br/>
The program displays two quads one drawn from an inner class and one from an external class.  The quad drawn from the inner class (ModelLocal) works fine, but the quad draw from the external class (Model) doesn't.
<br/>
<br/>
Any idea what I'm doing wrong?
<br/>
<br/>
Thanks!
<br/>
<br/>
main.cpp
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#include &lt;nds.h&gt;
<br/>
#include &lt;nds/arm9/image.h&gt;
<br/>
#include &lt;stdlib.h&gt;
<br/>
<br/>
#include "test_pcx.h"
<br/>
#include "Model.h"
<br/>
<br/>
int texture[1];
<br/>
<br/>
class ModelLocal
<br/>
{
<br/>
public:
<br/>
    int texture;
<br/>
    float tx,ty,tz;
<br/>
    
<br/>
    void draw()
<br/>
    {
<br/>
        float w = 1.0f;
<br/>
        float h = 1.0f;
<br/>
        float l = 1.0f;
<br/>
<br/>
        float x = tx - w / 2;
<br/>
        float y = ty - h / 2;
<br/>
        float z = tz - l / 2;
<br/>
<br/>
        glBindTexture(GL_TEXTURE_2D, texture);
<br/>
        glColor3f(1.0f,1.0f,1.0f);
<br/>
<br/>
        glBegin(GL_QUADS);      
<br/>
            glTexCoord2f(1.0f, 1.0f); glVertex3f(x+w, y,   z);
<br/>
            glTexCoord2f(1.0f, 0.0f); glVertex3f(x+w, y+h, z); 
<br/>
            glTexCoord2f(0.0f, 0.0f); glVertex3f(x,     y+h, z);
<br/>
            glTexCoord2f(0.0f, 1.0f); glVertex3f(x,     y,   z);
<br/>
        glEnd();
<br/>
    }
<br/>
<br/>
    void init(int text, float x, float y, float z)
<br/>
    {
<br/>
        texture = text;
<br/>
        tx = x;
<br/>
        ty = y;
<br/>
        tz = z;
<br/>
    }
<br/>
<br/>
    ModelLocal() {}
<br/>
};
<br/>
<br/>
int loadTexture(const u8* image, int* text, int width, int height)
<br/>
{
<br/>
    sImage pcx;
<br/>
<br/>
    loadPCX((u8*)image, &amp;pcx);
<br/>
<br/>
    image8to16(&amp;pcx);
<br/>
<br/>
    glGenTextures(1, text);
<br/>
    glBindTexture(0, *text);
<br/>
    
<br/>
    glTexImage2D(0, 0, GL_RGB, width, height, 0, TEXGEN_TEXCOORD, pcx.image.data8);
<br/>
<br/>
    imageDestroy(&amp;pcx);
<br/>
<br/>
    return *text;
<br/>
}
<br/>
    
<br/>
Model model;
<br/>
ModelLocal modelLocal;
<br/>
<br/>
void Initialize(void)   
<br/>
{
<br/>
    powerON(POWER_ALL);
<br/>
<br/>
    videoSetMode(MODE_0_3D);
<br/>
    vramSetBankA(VRAM_A_TEXTURE);
<br/>
    vramSetBankB(VRAM_B_TEXTURE);
<br/>
<br/>
    irqInit();
<br/>
    irqSet(IRQ_VBLANK, 0);
<br/>
<br/>
    glInit();
<br/>
<br/>
    glEnable(GL_TEXTURE_2D);
<br/>
<br/>
    glViewport(0,0,255,191);
<br/>
<br/>
    glEnable(GL_ANTIALIAS);
<br/>
<br/>
    glClearColor(31,31,31,31);
<br/>
    glClearPolyID(63);
<br/>
    glClearDepth(GL_MAX_DEPTH);
<br/>
<br/>
    loadTexture(test_pcx, &amp;texture[0], TEXTURE_SIZE_128, TEXTURE_SIZE_128);
<br/>
<br/>
    model.init(texture[0], -1.0f, 0.0f, -2.0f);
<br/>
    modelLocal.init(texture[0], 1.0f, 0.0f, -2.0f);
<br/>
    
<br/>
    return;
<br/>
}
<br/>
<br/>
void Draw3d()
<br/>
{
<br/>
    glMatrixMode(GL_PROJECTION);
<br/>
    glLoadIdentity();
<br/>
    
<br/>
    gluPerspective(70, 256.0 / 192.0, 0.1, 100);
<br/>
    
<br/>
    glLight(0, RGB15(31,31,31) , 0, floattov10(-1.0), 0);
<br/>
    glLight(1, RGB15(31,31,31) , 0, 0, floattov10(-1.0));
<br/>
    glLight(2, RGB15(31,31,31) , 0, 0, floattov10(1.0));
<br/>
    
<br/>
    glMaterialf(GL_AMBIENT, RGB15(5,5,5));
<br/>
    glMaterialf(GL_DIFFUSE, RGB15(12,12,19));
<br/>
    glMaterialf(GL_SPECULAR, BIT(15) | RGB15(21,21,31));
<br/>
    glMaterialf(GL_EMISSION, RGB15(0,0,0));
<br/>
    
<br/>
    glPolyFmt(POLY_ALPHA(31) | POLY_CULL_BACK | POLY_FORMAT_LIGHT0 | POLY_FORMAT_LIGHT1 | POLY_FORMAT_LIGHT2);
<br/>
<br/>
    glMatrixMode(GL_TEXTURE);
<br/>
    glLoadIdentity();    
<br/>
<br/>
    glMatrixMode(GL_MODELVIEW);
<br/>
    glLoadIdentity();    
<br/>
    
<br/>
    gluLookAtf32(0, 0, 0, floattof32(0.0f), floattof32(0.0f), floattof32(-1.0f), floattof32( 0), floattof32( 1), floattof32( 0));
<br/>
    
<br/>
    model.draw();
<br/>
    modelLocal.draw();
<br/>
}
<br/>
<br/>
void Draw()
<br/>
{
<br/>
    Draw3d();
<br/>
    
<br/>
    glFlush(0);
<br/>
<br/>
    swiWaitForVBlank();
<br/>
}
<br/>
<br/>
int main()
<br/>
{
<br/>
    Initialize();
<br/>
<br/>
    while (1) 
<br/>
    {
<br/>
        Draw();
<br/>
    }
<br/>
<br/>
    return 0;
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Model.h
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#include &lt;nds.h&gt;
<br/>
<br/>
class Model
<br/>
{
<br/>
public:
<br/>
    int texture;
<br/>
    float tx,ty,tz;
<br/>
    
<br/>
    void draw();
<br/>
    void init(int text, float x, float y, float z);
<br/>
    
<br/>
    Model();
<br/>
};
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Model.cpp
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#include &lt;nds.h&gt;
<br/>
#include &lt;stdlib.h&gt;
<br/>
<br/>
#include "Model.h"
<br/>
<br/>
void Model::draw()
<br/>
{
<br/>
    float w = 1.0f;
<br/>
    float h = 1.0f;
<br/>
    float l = 1.0f;
<br/>
<br/>
    float x = tx - w / 2;
<br/>
    float y = ty - h / 2;
<br/>
    float z = tz - l / 2;
<br/>
<br/>
    glBindTexture(GL_TEXTURE_2D, texture);
<br/>
    glColor3f(1.0f,1.0f,1.0f);
<br/>
<br/>
    glBegin(GL_QUADS);      
<br/>
        glTexCoord2f(1.0f, 1.0f); glVertex3f(x+w, y,   z);
<br/>
        glTexCoord2f(1.0f, 0.0f); glVertex3f(x+w, y+h, z); 
<br/>
        glTexCoord2f(0.0f, 0.0f); glVertex3f(x,     y+h, z);
<br/>
        glTexCoord2f(0.0f, 1.0f); glVertex3f(x,     y,   z);
<br/>
    glEnd();
<br/>
}
<br/>
    
<br/>
void Model::init(int text, float x, float y, float z)
<br/>
{
<br/>
    texture = text;
<br/>
    tx = x;
<br/>
    ty = y;
<br/>
    tz = z;    
<br/>
}
<br/>
    
<br/>
Model::Model() {}
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#148464 - strager - Sun Jan 06, 2008 2:44 am</h4>
    <div class="postbody"><span class="postbody">Does the code work the same if you comment out the call to one of Model::draw() or ModelLocal::draw()?  Will it work if those calls are swapped?  What happens if you change the position of the quads (e.g. swap them)?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#148467 - stevens - Sun Jan 06, 2008 3:10 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>strager wrote:</b></span></td> </tr> <tr> <td class="quote">Does the code work the same if you comment out the call to one of Model::draw() or ModelLocal::draw()?  Will it work if those calls are swapped?  What happens if you change the position of the quads (e.g. swap them)?</td> </tr></table><span class="postbody">
<br/>
<br/>
Neither the call order or the lack of one or the other effects which will display the texture.  The position of the quad doesn't effect it either.  ModelLocal is the only one which displays properly.
<br/>
<br/>
One thing I should elaborated on, it displays something.  It's just not correct. I'm not sure if it's a distorted view of the correct texture or it's displaying the wrong area of memory.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#148714 - stevens - Wed Jan 09, 2008 6:35 am</h4>
    <div class="postbody"><span class="postbody">I have somewhat of a solution to my problem.  A few print lines showed me the glGlob global was not initialized in the Model class.  If I add
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
    glGlob = glGetGlobals();
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
to Model:init() it works.
<br/>
<br/>
Anyone know why I need to do this?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#148732 - elhobbs - Wed Jan 09, 2008 3:49 pm</h4>
    <div class="postbody"><span class="postbody">I think this is because of the definition of glGlob in videogl.h
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
// Pointer to global data for videoGL
<br/>
static gl_hidden_globals* glGlob = 0;
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
since it is declared as static in the header file a new instance is created for each file that the header is included in. glTexCoord2f should probably not be declared as an inline function in the header file as it would need to be in videogl.c for the the correct instance of glGlob to be used. this function appears to be the only one that references glGlob outside of videogl.c. you would be better off using glTexCoord2t16 anyway and dropping floats all together. however, this should be fixed in libnds.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#148739 - nipil - Wed Jan 09, 2008 5:58 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>elhobbs wrote:</b></span></td> </tr> <tr> <td class="quote">since it is declared as static in the header file a new instance is created for each file that the header is included in.</td> </tr></table><span class="postbody">
<br/>
I just learnt something here. I'm so used to declare a global variable in one file
<br/>
and use extern in another to access it, that i never quite realize or wondered
<br/>
what would happen if i declared it without the extern keyword...
<br/>
Thanks for the info.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#148772 - stevens - Thu Jan 10, 2008 3:51 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>elhobbs wrote:</b></span></td> </tr> <tr> <td class="quote"> you would be better off using glTexCoord2t16 anyway and dropping floats all together. however, this should be fixed in libnds.</td> </tr></table><span class="postbody">
<br/>
<br/>
I took your advice and converted everything to fixed point.  I knew fixed point was faster, but wow I didn't realize how much faster.  Thanks!</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
