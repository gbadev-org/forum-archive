<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Beginner OAM problems (SOLVED) - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > Beginner OAM problems (SOLVED)</h2>
<div id="posts">
<div class="post">
    <h4>#148894 - rook02 - Fri Jan 11, 2008 7:13 pm</h4>
    <div class="postbody"><span class="postbody">Okay, I'm not sure what I'm doing wrong. I've been trying to see how exactly the OAM works, so that I'll be able to just throw in arrays of pixel data in it. However, I can't even seem to load a small 8x8 sprite into it correctly. 
<br/>
<br/>
The sprite displays, but it's broken in vertical lines or something.
<br/>
<br/>
Here's what I did after doing initOAM();
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
   int index = 0;
<br/>
   oam[index].attribute[0] = ATTR0_COLOR_256 | ATTR0_ROTSCALE;
<br/>
   oam[index].attribute[1] = ATTR1_ROTDATA(0) | ATTR1_SIZE_8;
<br/>
   oam[index].attribute[2] = 0;
<br/>
<br/>
   const unsigned short palette[2]=
<br/>
   {
<br/>
      0x001,0x01F,
<br/>
   };
<br/>
<br/>
   const unsigned char test[64]=
<br/>
   {
<br/>
      0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,
<br/>
      0x01,0x01,0x00,0x01,0x01,0x00,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,
<br/>
      0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x00,0x00,0x00,0x00,0x01,0x01,
<br/>
      0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,
<br/>
   };
<br/>
<br/>
   dmaCopy ( palette, SPRITE_PALETTE, 2 * sizeof ( unsigned short ) );
<br/>
   dmaCopy ( test, &amp;SPRITE_GFX[0 * 16], 64 * sizeof ( unsigned char ));
<br/>
<br/>
   swiWaitForVBlank();
<br/>
   updateOAM();</td> </tr></table><span class="postbody">
<br/>
<br/>
What did I miss here? Any help would be appreciated.</span><span class="gensmall"><br/><br/>Last edited by rook02 on Fri Jan 25, 2008 8:03 pm; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#148895 - eKid - Fri Jan 11, 2008 7:23 pm</h4>
    <div class="postbody"><span class="postbody">What is initOAM()?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#148900 - theoxylo - Fri Jan 11, 2008 7:45 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>eKid wrote:</b></span></td> </tr> <tr> <td class="quote">What is initOAM()?</td> </tr></table><span class="postbody">
<br/>
<br/>
I think he means from patatersoft 6.0 <a class="postlink" href="http://patatersoft.info/manual_online.html#id2534738" target="_blank">http://patatersoft.info/manual_online.html#id2534738</a>, cut and pasted here:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void initOAM(tOAM * oam) {
<br/>
    /*
<br/>
     * For all 128 sprites on the DS, disable and clear any attributes they 
<br/>
     * might have. This prevents any garbage from being displayed and gives 
<br/>
     * us a clean slate to work with.
<br/>
     */
<br/>
    for (int i = 0; i &lt; SPRITE_COUNT; i++) {
<br/>
        oam-&gt;spriteBuffer[i].attribute[0] = ATTR0_DISABLED;
<br/>
        oam-&gt;spriteBuffer[i].attribute[1] = 0;
<br/>
        oam-&gt;spriteBuffer[i].attribute[2] = 0;
<br/>
    }
<br/>
    for (int i = 0; i &lt; MATRIX_COUNT; i++) {
<br/>
        /* If you look carefully, you'll see this is that affine trasformation
<br/>
         * matrix again. We initialize it to the identity matrix, as we did
<br/>
         * with backgrounds
<br/>
         */
<br/>
        oam-&gt;matrixBuffer[i].hdx = 1 &lt;&lt; 8;
<br/>
        oam-&gt;matrixBuffer[i].hdy = 0;
<br/>
        oam-&gt;matrixBuffer[i].vdx = 0;
<br/>
        oam-&gt;matrixBuffer[i].vdy = 1 &lt;&lt; 8;
<br/>
    }
<br/>
<br/>
    /* Be sure to wait for vblank before trying to update the OAM. */
<br/>
    swiWaitForVBlank();
<br/>
    updateOAM(oam);
<br/>
}</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#148901 - Cearn - Fri Jan 11, 2008 7:57 pm</h4>
    <div class="postbody"><span class="postbody">The initOAM() found in the libnds examples do not set the OAM affine matrices. Without that matrix affine sprites (ATTR0_ROTSCALE or ATTR0_ROTSCALE_DOUBLE) will just use the center pixel's color for the whole sprite (see also <a class="postlink" href="http://www.coranac.com/tonc/text/affobj.htm" target="_blank">tonc : affine objects</a>). Use the initOAM() version theoxylo pasted.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#148902 - eKid - Fri Jan 11, 2008 8:00 pm</h4>
    <div class="postbody"><span class="postbody">Ah, okay, thanks.
<br/>
I still can't pinpoint the problem with the current information :(. More source code please :P
<br/>
The first snippet posted looks correct, the problem must be elsewhere.
<br/>
<br/>
edit: oops 1 post too late</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#148914 - tepples - Fri Jan 11, 2008 10:27 pm</h4>
    <div class="postbody"><span class="postbody">Perhaps if you do it without rot/scale, it might be easier to figure things out.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#148934 - rook02 - Sat Jan 12, 2008 6:12 am</h4>
    <div class="postbody"><span class="postbody">Sadly, there isn't much else as this is mostly test code. 
<br/>
<br/>
This is how I set up my writable copy of the OAM:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">   SpriteEntry oam[128];
<br/>
   SpriteRotation *spriteRotation = (SpriteRotation*)oam;
<br/>
<br/>
   int i;
<br/>
   for (i = 0; i &lt; 128; i++) {
<br/>
      oam[i].attribute[0] = ATTR0_DISABLED;
<br/>
      oam[i].attribute[1] = 0;
<br/>
      oam[i].attribute[2] = 0;
<br/>
   }
<br/>
   for (i = 0; i &lt; 32; i++) {
<br/>
      spriteRotation[i].hdx = 1&lt;&lt;8;
<br/>
      spriteRotation[i].hdy = 0;
<br/>
      spriteRotation[i].vdx = 0;
<br/>
      spriteRotation[i].vdy = 1&lt;&lt;8;
<br/>
   }
<br/>
   swiWaitForVBlank();
<br/>
   updateOAM ( oam );</td> </tr></table><span class="postbody">
<br/>
<br/>
And here's. the updateOAM code:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void updateOAM( SpriteEntry * oam )
<br/>
{
<br/>
   DC_FlushAll();
<br/>
   dmaCopy(oam, OAM, 128*sizeof(SpriteEntry));
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
And the VRAM banks are configured the way they are  in the Patatersoft manual. That's about it. :|</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#148935 - eKid - Sat Jan 12, 2008 6:22 am</h4>
    <div class="postbody"><span class="postbody">That code looks correct, may I see your whole main() function? The problem is most likely in there. Also, a screenshot of the broken sprite might help.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#148938 - rook02 - Sat Jan 12, 2008 6:39 am</h4>
    <div class="postbody"><span class="postbody">That's about it, really, but I guess there's no harm in posting the whole thing..
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">int main ()
<br/>
{
<br/>
   powerON(POWER_ALL_2D);
<br/>
<br/>
   irqInit();
<br/>
   irqSet(IRQ_VBLANK, 0);
<br/>
   lcdMainOnBottom();
<br/>
<br/>
   vramSetMainBanks(VRAM_A_MAIN_BG_0x06000000,
<br/>
                     VRAM_B_MAIN_BG_0x06020000,
<br/>
                     VRAM_C_SUB_BG_0x06200000,
<br/>
                     VRAM_D_LCD);
<br/>
<br/>
   vramSetBankE(VRAM_E_MAIN_SPRITE);
<br/>
<br/>
   /*  Set the video mode on the main screen. */
<br/>
   videoSetMode(MODE_5_2D | // Set the graphics mode to Mode 5
<br/>
                 DISPLAY_BG2_ACTIVE | // Enable BG2 for display
<br/>
                 DISPLAY_BG3_ACTIVE | // Enable BG3 for display
<br/>
                 DISPLAY_SPR_ACTIVE | // Enable sprites for display
<br/>
                 DISPLAY_SPR_1D       // Enable 1D tiled sprites
<br/>
                 );
<br/>
<br/>
   /*  Set the video mode on the sub screen. */
<br/>
   videoSetModeSub(MODE_5_2D | // Set the graphics mode to Mode 5
<br/>
                    DISPLAY_BG3_ACTIVE); // Enable BG3 for display
<br/>
               */
<br/>
   videoSetModeSub(MODE_0_2D | DISPLAY_BG0_ACTIVE);
<br/>
   consoleDemoInit();
<br/>
<br/>
   swiWaitForVBlank();
<br/>
<br/>
   SpriteEntry oam[128];
<br/>
   SpriteRotation *spriteRotation = (SpriteRotation*)oam;
<br/>
<br/>
   int i;
<br/>
   for (i = 0; i &lt; 128; i++) {
<br/>
      oam[i].attribute[0] = ATTR0_DISABLED;
<br/>
      oam[i].attribute[1] = 0;
<br/>
      oam[i].attribute[2] = 0;
<br/>
   }
<br/>
   for (i = 0; i &lt; 32; i++) {
<br/>
      spriteRotation[i].hdx = 1&lt;&lt;8;
<br/>
      spriteRotation[i].hdy = 0;
<br/>
      spriteRotation[i].vdx = 0;
<br/>
      spriteRotation[i].vdy = 1&lt;&lt;8;
<br/>
   }
<br/>
   swiWaitForVBlank();
<br/>
   updateOAM ( oam );
<br/>
<br/>
   int index = 0;
<br/>
<br/>
   oam[index].attribute[0] = ATTR0_COLOR_256 | ATTR0_ROTSCALE;
<br/>
   oam[index].attribute[1] = ATTR1_ROTDATA(0) | ATTR1_SIZE_8;
<br/>
   oam[index].attribute[2] = 0;
<br/>
<br/>
<br/>
   const unsigned short palette[2]=
<br/>
   {
<br/>
      0x001,0x01F,
<br/>
   };
<br/>
<br/>
   const unsigned char test[64]=
<br/>
   {
<br/>
      0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,
<br/>
      0x01,0x01,0x00,0x01,0x01,0x00,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,
<br/>
      0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x00,0x00,0x00,0x00,0x01,0x01,
<br/>
      0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,
<br/>
   };
<br/>
<br/>
   dmaCopy ( palette, SPRITE_PALETTE, 2 * sizeof ( unsigned short ) );
<br/>
   dmaCopy ( test, &amp;SPRITE_GFX[0 * 16], 64 * sizeof ( unsigned char ));
<br/>
<br/>
   swiWaitForVBlank();
<br/>
   updateOAM();
<br/>
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
It looks like this:
<br/>
<a href="http://i254.photobucket.com/albums/hh92/rookthedemokid/nogba.png" target="_blank">http://i254.photobucket.com/albums/hh92/rookthedemokid/nogba.png</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#148940 - eKid - Sat Jan 12, 2008 7:33 am</h4>
    <div class="postbody"><span class="postbody">I found the problem.
<br/>
updateOAM uses dma to copy the sprites to OAM memory. But DMA cannot transfer data from the arm9 stack space. You are declaring 'oam' inside the main function, so its going into the stack space. 
<br/>
The garbled sprite that you saw is just a bunch of uninitialized 16-color sprites (the OAM memory never got updated).
<br/>
To fix this, either move 'oam' outside of the main function to global memory, or change the dmaCopy in updateOAM to a software copy:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void updateOAM( SpriteEntry * oam )
<br/>
{
<br/>
   DC_FlushAll();
<br/>
   int i;
<br/>
   for( i = 0; i &lt; 128*(sizeof(SpriteEntry)/2); i++ )
<br/>
   {
<br/>
      OAM[i] = ((u16*)oam)[i];
<br/>
   }
<br/>
}
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#148941 - rook02 - Sat Jan 12, 2008 8:04 am</h4>
    <div class="postbody"><span class="postbody">Ahh... I never would've figured that one out myself. Thanks. :D</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
