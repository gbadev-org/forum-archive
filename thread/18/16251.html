<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Render To Texture example. - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>DS development > Render To Texture example.</h2>
<div id="posts">
<div class="post">
    <h4>#165063 - AntonioND - Mon Dec 08, 2008 4:03 pm</h4>
    <div class="postbody"><span class="postbody">Hello!
<br/>
<br/>
I was bored this morning and I did this rtt example, I hope you like it. Source code is included (I used the Textured_Cube example of libnds) but it's a bit messy.
<br/>
<br/>
Controls:
<br/>
A/B: Scale small cube.
<br/>
Pad: Rotate small cube.
<br/>
<br/>
Download:
<br/>
<a href="http://antoniond.drunkencoders.com/files/rtt_example.rar" target="_blank">http://antoniond.drunkencoders.com/files/rtt_example.rar</a>
<br/>
<br/>
Capture:
<br/>
<a href="http://antoniond.drunkencoders.com/files/rtt.png" target="_blank">http://antoniond.drunkencoders.com/files/rtt.png</a>
<br/>
<br/>
Bye!
<br/>
<br/>
<br/>
<br/>
PS: Ti-Ra-Nog, here you are. :P</span><span class="gensmall"><br/><br/>Last edited by AntonioND on Wed Dec 10, 2008 4:44 pm; edited 3 times in total</span></div>    
</div>
<div class="post">
    <h4>#165064 - TiRaNog - Mon Dec 08, 2008 4:24 pm</h4>
    <div class="postbody"><span class="postbody">Yeah!! I love it!!
<br/>
<br/>
Many thanks AntonioND :D
<br/>
<br/>
See you!! ;-)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#165091 - Maximus32 - Tue Dec 09, 2008 7:57 pm</h4>
    <div class="postbody"><span class="postbody">Very interesting!
<br/>
<br/>
I see you're using VSYNC for both the texture and the real scene, doesn't this reduce the framerate from 60 to 30 fps? If so, would it be possible to capture the texture without using VSYNC?
<br/>
<br/>
Does every rendered texture require an entire VRAM bank?<br/>_________________<br/>Bricks-OS, Operating System for Game Consoles</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#165095 - AntonioND - Tue Dec 09, 2008 8:43 pm</h4>
    <div class="postbody"><span class="postbody">I think you can't do it run at 60 fps. If you want to capture anything, you have to display it first. If you do so, you need to use a VRAM bank to save the image displayed on the screen and another one for the texture. If you want more textures, you don't need to use an entire bank, just tell the display capture register to save the data in another location inside the same bank.
<br/>
<br/>
If I am wrong, please tell me.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#165097 - Maximus32 - Tue Dec 09, 2008 9:19 pm</h4>
    <div class="postbody"><span class="postbody">I don't think you need to actually display it first, it just needs to be rendered. The SourceA bit from the capture register selects: 0) the display, or 1) the 3D engine.<br/>_________________<br/>Bricks-OS, Operating System for Game Consoles</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#165105 - AntonioND - Tue Dec 09, 2008 9:53 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Maximus32 wrote:</b></span></td> </tr> <tr> <td class="quote">I don't think you need to actually display it first, it just needs to be rendered. The SourceA bit from the capture register selects: 0) the display, or 1) the 3D engine.</td> </tr></table><span class="postbody">
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>gbatek wrote:</b></span></td> </tr> <tr> <td class="quote">   24    Source A          (0=Graphics Screen BG+3D+OBJ, 1=3D Screen) </td> </tr></table><span class="postbody">
<br/>
<br/>
What I understand from reading this is that if I enable that bit, only the 3D image displayed on the screen is captured.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#165117 - DiscoStew - Wed Dec 10, 2008 5:06 am</h4>
    <div class="postbody"><span class="postbody">I wonder. What if using a single screen (the main screen) with BG0 and BG2 active, having BG2 "over" BG0 so BG0 is "hid", then alternating frames as you have it AntonioND with drawing cube to capture into VRAM_B to be used as a texture, then drawing cube using captured texture, and capturing the real scene into VRAM_C, and displaying the VRAM_C content onto BG2? BG0 will continue to alternate the 3D data, but BG2 will be in front of it, hiding that alternating sequence, and it will show the final result.<br/>_________________<br/><span style="font-weight: bold">DS</span> - It's all about <span style="font-weight: bold">D</span>isco<span style="font-weight: bold">S</span>tew</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#165129 - AntonioND - Wed Dec 10, 2008 4:43 pm</h4>
    <div class="postbody"><span class="postbody">Yeah, that's a good idea. New version in the first post ^^.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#165134 - DiscoStew - Wed Dec 10, 2008 8:22 pm</h4>
    <div class="postbody"><span class="postbody">Cool. Looks much cleaner now, hehe.
<br/>
<br/>
I congratulate you on getting this to work, but the one thing that is bugging me about it is that it's running at 15FPS, not 30FPS. My assumption behind this is that you not only do a combined glFlush and swiWaitForVBlank to make sure that the 3D data gets rendered for the texture, which takes a frame, but afterwards, you use the capture hardware, and wait for that to go full circle, which takes up another frame, totaling 2. Combine this with that same method with rendering the real scene and capturing it, and that takes up another 2 for a total of 4 frames per completion. Hence, 15FPS.
<br/>
<br/>
I'm looking at your code now to see if there is a way around this.
<br/>
<br/>
<br/>
EDIT:
<br/>
<br/>
Heh, I "sorta" got it fixed by making a little change. The previous code was...
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">swiWaitForVBlank();
<br/>
         
<br/>
         vramSetBankC(VRAM_C_LCD);  //Scene goes to VRAM_C
<br/>
         REG_DISPCAPCNT=DCAP_BANK(2)|DCAP_ENABLE|DCAP_SIZE(3)|DCAP_SRC(1);
<br/>
         while(REG_DISPCAPCNT &amp; DCAP_ENABLE);
<br/>
         vramSetBankC(VRAM_C_MAIN_BG_0x06000000); </td> </tr></table><span class="postbody">
<br/>
What I did was removed waiting for the capture hardware to finish, and moved the swiWaitForVBlank into that position to now have...
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">vramSetBankC(VRAM_C_LCD);  //Scene goes to VRAM_C
<br/>
         REG_DISPCAPCNT=DCAP_BANK(2)|DCAP_ENABLE|DCAP_SIZE(3)|DCAP_SRC(1);
<br/>
         swiWaitForVBlank();
<br/>
         vramSetBankC(VRAM_C_MAIN_BG_0x06000000); </td> </tr></table><span class="postbody">
<br/>
<br/>
I did the same change to portion with the cube getting captured to be used as a texture, and now, it all runs at 30FPS. The side-effect to this is that the "outer" color from the use of ClearColor seem to have swapped as well, so even though clearing with green for use with the captured cubed to texture is now showing blue instead of green, and vice versa for the actual scene. It's probably because glClearColor is not tied in to glFlush as actual geometry is, and is most likely linked to the H-Blank.<br/>_________________<br/><span style="font-weight: bold">DS</span> - It's all about <span style="font-weight: bold">D</span>isco<span style="font-weight: bold">S</span>tew</span><span class="gensmall"><br/><br/>Last edited by DiscoStew on Wed Dec 10, 2008 8:47 pm; edited 2 times in total</span></div>    
</div>
<div class="post">
    <h4>#165136 - Maxxie - Wed Dec 10, 2008 8:34 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>AntonioND wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
What I understand from reading this is that if I enable that bit, only the 3D image displayed on the screen is captured.</td> </tr></table><span class="postbody">
<br/>
<br/>
If you take a look at the <a class="postlink" href="http://nocash.emubase.de/gbatek.htm#dsvideodisplaysystemblockdiagram" target="_blank">block diagram</a>
<br/>
<br/>
You will notice that the capture will work (at least if gbatek is right there) with the 3d as source, even if BG0 is disabled for display in the layering process.<br/>_________________<br/><a class="postlink" href="http://nintendods.desperate-programmers.com/doku.php?id=wireless_io_map" target="_blank">Trying  to bring more detail into understanding the wireless hardware</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#165137 - DiscoStew - Wed Dec 10, 2008 8:39 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Maxxie wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>AntonioND wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
What I understand from reading this is that if I enable that bit, only the 3D image displayed on the screen is captured.</td> </tr></table><span class="postbody">
<br/>
<br/>
If you take a look at the <a class="postlink" href="http://nocash.emubase.de/gbatek.htm#dsvideodisplaysystemblockdiagram" target="_blank">block diagram</a>
<br/>
<br/>
You will notice that the capture will work (at least if gbatek is right there) with the 3d as source, even if BG0 is disabled for display in the layering process.</span></td> </tr></table><span class="postbody">
<br/>
<br/>
So its just a matter of not using MODE_5_3D, and going with MODE_5_2D | ENABLE_3D then?<br/>_________________<br/><span style="font-weight: bold">DS</span> - It's all about <span style="font-weight: bold">D</span>isco<span style="font-weight: bold">S</span>tew</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#165138 - Maxxie - Wed Dec 10, 2008 8:44 pm</h4>
    <div class="postbody"><span class="postbody">That's at least what i read out of gbatek. Haven't tried tho :p<br/>_________________<br/><a class="postlink" href="http://nintendods.desperate-programmers.com/doku.php?id=wireless_io_map" target="_blank">Trying  to bring more detail into understanding the wireless hardware</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#165139 - AntonioND - Wed Dec 10, 2008 8:52 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Maxxie wrote:</b></span></td> </tr> <tr> <td class="quote">That's at least what i read out of gbatek. Haven't tried tho :p</td> </tr></table><span class="postbody">
<br/>
I tried with MODE_5_2D and it works, but only half of frames the image is displayed. The rest of frames the screen is black. I'll try with framebuffer mode.
<br/>
<br/>
EDIT: Framebuffer mode OK. ;)  Thank you both. I'm trying to fix that thing about clear colors.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#165143 - DiscoStew - Wed Dec 10, 2008 9:20 pm</h4>
    <div class="postbody"><span class="postbody">I believe I got the ClearColor portion fixed (this is still using MODE_5_3D), but I did quite a bit of rearranging with the code to get it to work fine. This is what I came up with...
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">      if(framecount &amp; 1)            //--------'real' scene-----------
<br/>
         {
<br/>
<br/>
         swiWaitForVBlank();
<br/>
         
<br/>
         vramSetBankB(VRAM_B_LCD);  //Texture goes to VRAM_B
<br/>
         vramSetBankC(VRAM_C_MAIN_BG_0x06000000); 
<br/>
         REG_DISPCAPCNT=DCAP_BANK(1)|DCAP_ENABLE|DCAP_SIZE(3)|DCAP_SRC(1);
<br/>
         
<br/>
         glClearColor(0,0,31,31);
<br/>
      
<br/>
         glViewport(0,0,255,192);
<br/>
         
<br/>
         glMatrixMode(GL_PROJECTION);
<br/>
         glLoadIdentity();
<br/>
         gluPerspective(70, 256.0 / 192.0, 0.1, 40);
<br/>
         
<br/>
         glMatrixMode(GL_MODELVIEW);
<br/>
         glLoadIdentity();
<br/>
               
<br/>
      //---------------------------------------------------------------------      
<br/>
         
<br/>
         gluLookAt(   0.0, 0.0, 1.0,      //camera possition 
<br/>
               0.0, 0.0, 0.0,      //look at
<br/>
               0.0, 1.0, 0.0);      //up
<br/>
         
<br/>
         //move it away from the camera
<br/>
         glTranslate3f32(0, 0, floattof32(-1));
<br/>
         
<br/>
         glRotateX(rx);
<br/>
         glRotateY(ry);
<br/>
         
<br/>
         GFX_TEX_FORMAT = (GL_RGBA&lt;&lt;26) | ((TEXTURE_SIZE_128)&lt;&lt;20) | 
<br/>
            ((TEXTURE_SIZE_128)&lt;&lt;23) | (((int)VRAM_B) &gt;&gt; 3);      
<br/>
      
<br/>
         DrawCube();
<br/>
         
<br/>
         glFlush(0);
<br/>
<br/>
         } 
<br/>
      else                    //---------texture scene---------
<br/>
         {
<br/>
         
<br/>
         swiWaitForVBlank();
<br/>
         
<br/>
         vramSetBankB(VRAM_B_TEXTURE);
<br/>
         vramSetBankC(VRAM_C_LCD);  //Scene goes to VRAM_C
<br/>
         REG_DISPCAPCNT=DCAP_BANK(2)|DCAP_ENABLE|DCAP_SIZE(3)|DCAP_SRC(1);
<br/>
         
<br/>
         glClearColor(0,31,0,31);
<br/>
         
<br/>
         glViewport(0,64,128,192);
<br/>
         
<br/>
         glMatrixMode(GL_PROJECTION);
<br/>
         
<br/>
         glLoadIdentity();
<br/>
         gluPerspective(70, 128/128, 0.1, 40);
<br/>
         
<br/>
         glMatrixMode(GL_MODELVIEW);
<br/>
         glLoadIdentity();
<br/>
         
<br/>
      //---------------------------------------------------------------------
<br/>
   
<br/>
         gluLookAt(   0.0, 0.0, 1.0,      //camera possition 
<br/>
               0.0, 0.0, 0.0,      //look at
<br/>
               0.0, 1.0, 0.0);      //up
<br/>
         
<br/>
         //move it away from the camera
<br/>
         glTranslate3f32(0, 0, floattof32(-1));
<br/>
               
<br/>
         glRotateX(rotateX);
<br/>
         glRotateY(rotateY);
<br/>
         
<br/>
         glScalef(scale,scale,scale);
<br/>
         
<br/>
         glBindTexture(0, textureID);
<br/>
         
<br/>
         DrawCube();
<br/>
         
<br/>
         glFlush(0);
<br/>
         
<br/>
         }</td> </tr></table><span class="postbody">
<br/>
<br/>
It looks odd from what it originally looked like, but it makes sense to me. Basically, each section starts right at the VBlank, and right afterwards, the display capture hardware is set up to deal with everything that was set up "in the last frame", while afterwards, the current frame is being dealt with.<br/>_________________<br/><span style="font-weight: bold">DS</span> - It's all about <span style="font-weight: bold">D</span>isco<span style="font-weight: bold">S</span>tew</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#165150 - AntonioND - Wed Dec 10, 2008 10:36 pm</h4>
    <div class="postbody"><span class="postbody">Yeah, I understand. ;)
<br/>
<br/>
Fixed and uploaded (again). I've put a define to change between framebuffer mode and mode 5+3D. Thanks for your help, DiscoStew.
<br/>
<br/>
BTW, at the begining I didn't notice it was running at 15 fps. XD
<br/>
<br/>
EDIT: Updated to work with latest libnds.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
