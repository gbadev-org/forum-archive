<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Rewrite some system functions for the NDS - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>DS development > Rewrite some system functions for the NDS</h2>
<div id="posts">
<div class="post">
    <h4>#161380 - ferrand.d - Sat Aug 02, 2008 3:29 pm</h4>
    <div class="postbody"><span class="postbody">Hello !
<br/>
I am continuing the project LMP-ng, and i added SQLite to my project. Unfortunately, it needs some system functions to acces files, etc... that are not in my devkitARM environment.
<br/>
<br/>
The three functions i'm trying to rewrite are <span style="font-weight: bold">sleep</span>, <span style="font-weight: bold">fsync</span> and <span style="font-weight: bold">ftruncate</span>. I've already rewritten sleep like that :
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">unsigned sleep(unsigned int seconds)
<br/>
{
<br/>
   int i, j;
<br/>
   
<br/>
   for (i = 0; i &lt; seconds; i++)
<br/>
      for (j = 0; j &lt;60; j++)
<br/>
         swiWaitForVBlank();
<br/>
   
<br/>
   return 0;
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
Have you got ideas for the other functions ?
<br/>
Thanks very much.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161382 - Dwedit - Sat Aug 02, 2008 5:58 pm</h4>
    <div class="postbody"><span class="postbody">Whenever you do an fflush or fclose, the file is synced to disk immediately, so fsync would probably be blank.<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161398 - silent_code - Sat Aug 02, 2008 11:21 pm</h4>
    <div class="postbody"><span class="postbody">Your sleep function will only work for 60hz games, though it might be useful in some cases. :^)<br/>_________________<br/><span style="font-size: 9px; line-height: normal"><span style="text-decoration: underline"><span style="font-weight: bold"></span></span> July 5th 08: "<span style="font-weight: bold">Volumetric Shadow Demo</span>" 1.6.0 (final) source released
<br/>
June 5th 08: "<span style="font-weight: bold">Zombie NDS</span>" WIP released!
<br/>
It's all on my page, just click <span style="font-weight: bold">WWW</span> below.</span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161400 - DiscoStew - Sat Aug 02, 2008 11:32 pm</h4>
    <div class="postbody"><span class="postbody">Since swiWatiForVBlank is fixed for ~60hz, would it make much of a difference?<br/>_________________<br/><span style="font-weight: bold">DS</span> - It's all about <span style="font-weight: bold">D</span>isco<span style="font-weight: bold">S</span>tew</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161403 - silent_code - Sat Aug 02, 2008 11:37 pm</h4>
    <div class="postbody"><span class="postbody">What is the bahaviour with a 30hz game then? I don't have the time to test it now, it's bed time (0:36), so I hope you have the answer.
<br/>
Also, I had kind of a s.y day, so my thinking machine is idle most of the time right now.<br/>_________________<br/><span style="font-size: 9px; line-height: normal"><span style="text-decoration: underline"><span style="font-weight: bold"></span></span> July 5th 08: "<span style="font-weight: bold">Volumetric Shadow Demo</span>" 1.6.0 (final) source released
<br/>
June 5th 08: "<span style="font-weight: bold">Zombie NDS</span>" WIP released!
<br/>
It's all on my page, just click <span style="font-weight: bold">WWW</span> below.</span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161406 - Dwedit - Sat Aug 02, 2008 11:57 pm</h4>
    <div class="postbody"><span class="postbody">NDS doesn't have any PAL region, every NDS has a vblank time of 59.8261Hz.
<br/>
But why do you need a Sleep function?  Isn't calling sleep just a way to tell the OS that you want your process to give up its time slice?  There's no OS on the DS, unless you count dslinux.<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161407 - silent_code - Sun Aug 03, 2008 12:08 am</h4>
    <div class="postbody"><span class="postbody">In my current demo, the framrate is 30 hz (for now). Won't that affect anything?
<br/>
<br/>
I guess what you are trying to say is, that the interrupt will fire anyway, so it's still valid and independent of the frame rate.
<br/>
In that case, I take back my comment.
<br/>
Sorry! :^D<br/>_________________<br/><span style="font-size: 9px; line-height: normal"><span style="text-decoration: underline"><span style="font-weight: bold"></span></span> July 5th 08: "<span style="font-weight: bold">Volumetric Shadow Demo</span>" 1.6.0 (final) source released
<br/>
June 5th 08: "<span style="font-weight: bold">Zombie NDS</span>" WIP released!
<br/>
It's all on my page, just click <span style="font-weight: bold">WWW</span> below.</span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161414 - Lazy1 - Sun Aug 03, 2008 3:07 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Dwedit wrote:</b></span></td> </tr> <tr> <td class="quote">NDS doesn't have any PAL region, every NDS has a vblank time of 59.8261Hz.
<br/>
But why do you need a Sleep function?  Isn't calling sleep just a way to tell the OS that you want your process to give up its time slice?  There's no OS on the DS, unless you count dslinux.</td> </tr></table><span class="postbody">
<br/>
<br/>
I think what he means is devkitARM does not provide some functions that are used by SQLite.
<br/>
When I tried to get libsndfile on the ds it would not work because ftruncate is missing so I hope you find a good solution :D</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161415 - Dwedit - Sun Aug 03, 2008 3:14 am</h4>
    <div class="postbody"><span class="postbody">Rephrasing:  Why do you even need a NON BLANK sleep function?<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161419 - tepples - Sun Aug 03, 2008 4:03 am</h4>
    <div class="postbody"><span class="postbody">If it's SQLite, I can see where these functions might be used. <ul><li>ftruncate() is used for chopping off the end of a file that has become smaller without having to copy and rename. This might take place when a program runs VACUUM on a database to compact and repair it. </li><li>fsync() is used to make sure that writes to a database or journal have actually taken effect on the storage medium (the D in ACID). </li><li>I think SQLite might use sleep() for file locking: poll the file every second or so until it shows not locked or until a timeout expires. This is important for database files on a CIFS share, but libnds is most commonly used as a single-tasking operating environment incapable of mounting network shares, and a program on such a system might not need the locking. </li></ul><br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161430 - ferrand.d - Sun Aug 03, 2008 11:41 am</h4>
    <div class="postbody"><span class="postbody">Thanks to all for your replies.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Rephrasing: Why do you even need a NON BLANK sleep function</td> </tr></table><span class="postbody">
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">If it's SQLite, I can see where these functions might be used.
<br/>
<br/>
    * ftruncate() is used for chopping off the end of a file that has become smaller without having to copy and rename. This might take place when a program runs VACUUM on a database to compact and repair it.
<br/>
    * fsync() is used to make sure that writes to a database or journal have actually taken effect on the storage medium (the D in ACID).
<br/>
    * I think SQLite might use sleep() for file locking: poll the file every second or so until it shows not locked or until a timeout expires. This is important for database files on a CIFS share, but libnds is most commonly used as a single-tasking operating environment incapable of mounting network shares, and a program on such a system might not need the locking. </td> </tr></table><span class="postbody">
<br/>
<br/>
<br/>
I need a sleep (and a ftruncate, and a fsync) function because SQLite needs it. But I don't need complex features like VACUUM or locking... so is there a way to disable this in SQLite ? If I understand well, I'll just need fsync ?
<br/>
<br/>
For the moment I tried to rewrite it like that (with Dwedit indications) :
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">int fsync(int fd)
<br/>
{
<br/>
   FILE* stream;
<br/>
   
<br/>
   stream = fdopen(fd, "r");
<br/>
   fflush(stream);
<br/>
   
<br/>
   return 0;
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
It is dirty code, but it might work (like sleep())...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161438 - Dwedit - Sun Aug 03, 2008 6:48 pm</h4>
    <div class="postbody"><span class="postbody">I think this has to do with libfat not supporting posix style file IO instead of C standard library IO.<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161472 - ferrand.d - Mon Aug 04, 2008 6:27 pm</h4>
    <div class="postbody"><span class="postbody">I've found a workaround for <span style="font-weight: bold">fsync()</span>.
<br/>
I just added the flag <span style="font-style: italic">O_SYNC</span> to the <span style="font-weight: bold">open()</span> function and now, all data should be written directly to the file without any buffer.
<br/>
<br/>
Have you got any ideas for the last function, <span style="font-weight: bold">ftruncate()</span> ?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161473 - Dwedit - Mon Aug 04, 2008 7:12 pm</h4>
    <div class="postbody"><span class="postbody">There isn't any code in labfat anywhere to handle the truncate operation, there is only code to remove all the clusters from the chain and set the size to zero.
<br/>
<br/>
A truncate operation running on a FAT file system would follow the cluster chains, then break the cluster chain after a specified point, marking the remaining space as free, then change the file size from the file's directory entry.  If it enlarged the file, it would instead need to append zeroes.<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161489 - zeruda - Mon Aug 04, 2008 10:30 pm</h4>
    <div class="postbody"><span class="postbody">I don't know but maybe <a class="postlink" href="http://takuto.info/libnds/arm7/bios_8h.html#c352dbc09a082f4e43b91e87510e3263" target="_blank">swidelay</a> will be of use? 
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>silent_code wrote:</b></span></td> </tr> <tr> <td class="quote">Your sleep function will only work for 60hz games, though it might be useful in some cases. :^)</td> </tr></table><span class="postbody">
<br/>
<br/>
That's incorrect. When swiWaitforVBlank() returns it doesn't go back to the start of main(). It will continue on from where it left off. In the case given it returns at the for loop. It will go through another iteration which takes a few cycles and then it will hit swiWaitforVBlank() again. So it will be locked at 60 fps in the for loop, and once the loop ends the framerate will depend on whatever code is being called after that.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161504 - silent_code - Tue Aug 05, 2008 8:03 am</h4>
    <div class="postbody"><span class="postbody">I know that. Please read my other comments. :^)
<br/>
<br/>
Btw: Have you ever seen an NDS program go below 30 hz? I don't think that saying "the game loop get's locked at 60 hz" is correct, because it gets synchronised to the refresh rate, at a fraction of the latter (60, 30, 15 etc).
<br/>
E.g., if you stall the graphics hardware, your game only runs at half speed.
<br/>
<br/>
My question was, if that would somehow have any influence on that sleep function implementation, but I guess it does not.<br/>_________________<br/><span style="font-size: 9px; line-height: normal"><span style="text-decoration: underline"><span style="font-weight: bold"></span></span> July 5th 08: "<span style="font-weight: bold">Volumetric Shadow Demo</span>" 1.6.0 (final) source released
<br/>
June 5th 08: "<span style="font-weight: bold">Zombie NDS</span>" WIP released!
<br/>
It's all on my page, just click <span style="font-weight: bold">WWW</span> below.</span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161506 - zeruda - Tue Aug 05, 2008 10:42 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>silent_code wrote:</b></span></td> </tr> <tr> <td class="quote">I don't think that saying "the game loop get's locked at 60 hz" is correct</td> </tr></table><span class="postbody">
<br/>
<br/>
It's not the "game loop" that gets locked. It is the local for loop.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">unsigned sleep(unsigned int seconds)
<br/>
{
<br/>
   int i, j;
<br/>
   
<br/>
   for (i = 0; i &lt; seconds; i++)
<br/>
      for (j = 0; j &lt;60; j++)
<br/>
         swiWaitForVBlank();
<br/>
   
<br/>
   return 0;</td> </tr></table><span class="postbody">
<br/>
<br/>
So say you enter the loop with seconds = 10. i = 0 and j = 0. swiWaitForVBlank() is called so the hardware goes to sleep till VBlank. The VBlank does it's thing and returns to the loop which increments. j = 1. swiWaitForVBlank() again so goes to sleep. VBlank does it's thing(basically nothing) and returns. j = 2. VBlank and so on till j = 60. This means 60 VBlanks have been done and 1 second has passed. Goes to outer loop now i = 1 and then back to the inner loop j = 0. This continues for another 9 seconds.
<br/>
<br/>
What speed the rest of the game runs at is irrelevant since for 10 seconds none of it has been called at all. It has been stuck inside this sleep function inside the for loop.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161508 - ferrand.d - Tue Aug 05, 2008 11:39 am</h4>
    <div class="postbody"><span class="postbody">Sorry I'm french, so I don't really understand your debate ^^
<br/>
Do you mean that my sleep() function works ? Or have I to rewrite it ?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161513 - silent_code - Tue Aug 05, 2008 6:05 pm</h4>
    <div class="postbody"><span class="postbody">@ zeruda: Oh, now I understand what you mean! Sorry for my ignorance of the inner loop. You are right. I guess I took the wording a bit too literally the other day... now that I think of it, it's something totally differnt from what I thought about (that was not about the sleep function implementation, let's not bloat the thread any further with it.) :?D
<br/>
<br/>
The function seems to be correct.<br/>_________________<br/><span style="font-size: 9px; line-height: normal"><span style="text-decoration: underline"><span style="font-weight: bold"></span></span> July 5th 08: "<span style="font-weight: bold">Volumetric Shadow Demo</span>" 1.6.0 (final) source released
<br/>
June 5th 08: "<span style="font-weight: bold">Zombie NDS</span>" WIP released!
<br/>
It's all on my page, just click <span style="font-weight: bold">WWW</span> below.</span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161516 - vuurrobin - Tue Aug 05, 2008 7:28 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">unsigned sleep(unsigned int seconds)
<br/>
{
<br/>
   int i, j;
<br/>
   
<br/>
   for (i = 0; i &lt; seconds; i++)
<br/>
      for (j = 0; j &lt;60; j++)
<br/>
         swiWaitForVBlank();
<br/>
   
<br/>
   return 0;</td> </tr></table><span class="postbody">
<br/>
<br/>
why would you use 2 for loops when 1 would be enough. if fact, I think that you could replace the entire function with a define:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#define sleep(seconds) for(int i=0;i&lt;((seconds)*60);i++){swiWaitForVBlank()}</td> </tr></table><span class="postbody">
<br/>
<br/>
wouldn't this be easier?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161518 - zeruda - Tue Aug 05, 2008 8:01 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>ferrand.d wrote:</b></span></td> </tr> <tr> <td class="quote">Sorry I'm french, so I don't really understand your debate ^^
<br/>
Do you mean that my sleep() function works ? Or have I to rewrite it ?</td> </tr></table><span class="postbody">
<br/>
<br/>
Depends on the accuracy you need. Each frame on the DS is 1/60 of a second. So for example 10 seconds would be 600 frames. The first call to swiwaitforvblank in that loop however will be made part way through a frame,  So the function will delay 599 complete frames and 1 partial frame. Or somewhere between 9.98333 seconds and 10.00 seconds. If that's enough accuracy then it'll work. If you need to be more precise maybe you can use swiDelay().
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">#define sleep(seconds) for(int i=0;i&lt;((seconds)*60);i++){swiWaitForVBlank()}
<br/>
wouldn't this be easier?</td> </tr></table><span class="postbody">
<br/>
Yes.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161521 - Dwedit - Tue Aug 05, 2008 9:29 pm</h4>
    <div class="postbody"><span class="postbody">Sleep is used as a way to synchronize processes in a multithreading system.  Leave that function blank, because you don't have a multithreading system.<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161523 - ferrand.d - Tue Aug 05, 2008 10:40 pm</h4>
    <div class="postbody"><span class="postbody">Okay. Thanks a lot for your advices about <span style="font-weight: bold">sleep()</span>.
<br/>
I'm rewriting <span style="font-weight: bold">ftruncate()</span> with the help of the libfat source code, I'll tell you if I have a problem ;)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161536 - josath - Wed Aug 06, 2008 2:13 am</h4>
    <div class="postbody"><span class="postbody">It seems to me ftruncate could be implemented simply like this:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
int ftruncate(int fd, int length) {
<br/>
   u8 byte;
<br/>
   lseek(fd, length, SEEK_SET);
<br/>
   read(fd, &amp;byte, 1);
<br/>
   lseek(fd, length, SEEK_SET);
<br/>
   write(fd, &amp;byte, 1);
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
If I'm correct in assuming writing to the middle of a file will truncate the file at that point.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161538 - HyperHacker - Wed Aug 06, 2008 2:52 am</h4>
    <div class="postbody"><span class="postbody">I just want to suggest you look over <a class="postlink" href="http://forum.gbadev.org/viewtopic.php?p=152744&amp;highlight=text#152744" target="_blank">my ideas for a music player</a>, especially with regards to the interface. LMP's one big annoyance for me is that it has that fancy bitmap interface that seems to take up a lot of CPU time to draw, and doesn't seem to be using interrupts to process input. So there are some songs that take up so much CPU power the buttons simply don't work because it never gets around to processing input.
<br/>
Also, there are several places in my playlist where a song will start at the wrong sampling rate for a few seconds, and a couple where it will stay that way the entire time (with the buttons not responding). The workaround is to pause before the previous song ends, skip to the one after it, play, and skip back. Hopefully you can look into this.
<br/>
<br/>
LMP is one of the most useful homebrews out there :P glad to see someone working on it again.<br/>_________________<br/>I'm a PSP hacker now, but I still &lt;3 DS.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161570 - ferrand.d - Wed Aug 06, 2008 3:48 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>josath wrote:</b></span></td> </tr> <tr> <td class="quote">It seems to me ftruncate could be implemented simply like this:
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
int ftruncate(int fd, int length) {
<br/>
   u8 byte;
<br/>
   lseek(fd, length, SEEK_SET);
<br/>
   read(fd, &amp;byte, 1);
<br/>
   lseek(fd, length, SEEK_SET);
<br/>
   write(fd, &amp;byte, 1);
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
If I'm correct in assuming writing to the middle of a file will truncate the file at that point.</span></td> </tr></table><span class="postbody">
<br/>
<br/>
Thanks for your code.
<br/>
Correct me if i'm wrong, but if length is lower than the size of the file, this is not gonna truncate the file... In this case I thought I just had to write EOF where I want, but it seems a bit brutal... What do you think ?
<br/>
<br/>
@HyperHacker :
<br/>
I read your suggestions, you have great ideas. I'll try to optimize LMP-ng but for the moment, I'm focusing on the menus of LMP-ng. (In fact, I spent a lot of time trying to understand the code, because it's difficult to continue a project when its code isn't commented ^^ and I haven't understood everything yet). But I'll optimize it later ;)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161635 - ninjalj - Fri Aug 08, 2008 4:56 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>ferrand.d wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
Thanks for your code.
<br/>
Correct me if i'm wrong, but if length is lower than the size of the file, this is not gonna truncate the file... In this case I thought I just had to write EOF where I want, but it seems a bit brutal... What do you think ?
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
That won't work. As someone said earlier, you have to follow the cluster chain on the FAT, free now unused clusters by setting it to 0 on the FAT, mark the current last cluster as last cluster on FAT (FFFF for FAT16 IIRC) and set the new file length on the dir entry.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161637 - kusma - Fri Aug 08, 2008 6:22 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>vuurrobin wrote:</b></span></td> </tr> <tr> <td class="quote">why would you use 2 for loops when 1 would be enough. if fact, I think that you could replace the entire function with a define:
<br/>
</td> </tr></table><span class="postbody">
<br/>
Why not? It's easier to read the logic, and I don't see how you gain anything useful by removing a loop in this case.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>vuurrobin wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#define sleep(seconds) for(int i=0;i&lt;((seconds)*60);i++){swiWaitForVBlank()}</td> </tr></table><span class="postbody">
<br/>
wouldn't this be easier?</span></td> </tr></table><span class="postbody">
<br/>
No, using a macro is just type-unsafe (for the parameters) and generally trickier to debug. Using the preprocessor to implement function calls is just wrong in cases like this.
<br/>
<br/>
Your macro also has a defect. Try to compile the following code with your macro, and see how it fails (this works just fine when you use a function):
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
if (true) sleep(10);
<br/>
else printf("not sleeping");
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
It can be solved by wrapping the macro-"function" inside a "do{...}while(0)"-loop, though.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#162556 - ferrand.d - Thu Sep 04, 2008 9:40 pm</h4>
    <div class="postbody"><span class="postbody">Hello everybody.
<br/>
I had temporarily stopped the development of my version of LMP-ng during the rest of the holidays, because it was taking a lot of my time, but now that the school year has begun, I'd really like to finish it (at least, make it start on the DS without any error !), so I need your help.
<br/>
I have done a lot of researches about FAT filesystem, clusters, I watched the code of libfat, etc... but I still can't find how to do, even with the procedure you gave me. Please help me with some code or anything...
<br/>
<br/>
Thanks very much for your help anyway !</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#162557 - josath - Thu Sep 04, 2008 9:50 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>ferrand.d wrote:</b></span></td> </tr> <tr> <td class="quote">Hello everybody.
<br/>
I had temporarily stopped the development of my version of LMP-ng during the rest of the holidays, because it was taking a lot of my time, but now that the school year has begun, I'd really like to finish it</td> </tr></table><span class="postbody">
<br/>
<br/>
huh...you're saying you have more free time during the school year, than during your holidays? :P</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
