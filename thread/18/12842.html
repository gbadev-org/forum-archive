<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>3D transparency and backgrounds - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>DS development > 3D transparency and backgrounds</h2>
<div id="posts">
<div class="post">
    <h4>#123378 - Noda - Tue Mar 27, 2007 7:51 pm</h4>
    <div class="postbody"><span class="postbody">Could you tell me if it's possible to alpha blend a 3D object with a tiled background?
<br/>
<br/>
I recently rewrote my game engine to use 3D quads insteads of OAM sprites for more flexibility, but I can't manage to make those 'fake' sprites transparent over the tiled background like I did with 2D sprites :/
<br/>
<br/>
If you know how to do this, please help me, thanks a lot ;)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#123398 - silent_code - Tue Mar 27, 2007 10:02 pm</h4>
    <div class="postbody"><span class="postbody">i already hate myself for that answer: search the forum. it is there. *sorry*
<br/>
<br/>
ps: yes, you can.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#123404 - Noda - Tue Mar 27, 2007 10:40 pm</h4>
    <div class="postbody"><span class="postbody">Thanks, that's all I needed to know then ;) I'll make some searches...
<br/>
<br/>
edit: sorry, but it seems that I have no luck with searches... :( I tried to read quite a lot subjects but then none of them answers my question.
<br/>
Could I ask you to point me some topics, or at least some keywords for my search (I used combinations of 3D, transparency, alpha blending, backgrounds, no luck)
<br/>
<br/>
thanks a lot.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#123581 - qw3rty - Thu Mar 29, 2007 7:56 am</h4>
    <div class="postbody"><span class="postbody">The search-engine of DSdev.org sucks - I almost never find the info I'm after , and also bug other people with stupid questions ;)
<br/>
<br/>
I'll try to help :
<br/>
<br/>
On the NDS you can do either BG-BG blending.
<br/>
The COMPLETE 3d-scene can be used as "background" too.
<br/>
you can't unfortunately do per-polygon blending against an background.
<br/>
At least not with BG-BG-blending.
<br/>
<br/>
You can however make the polygons transparent at rendering - which may be what you want...(glPolyFmt(alpha(xx),....); )
<br/>
Draw you Background you want to be the "lowest" part with the lowest priority (BG_PRIORITY3).
<br/>
The 3d-BG needs a higher priority (BG_PRIORITY0).
<br/>
(BG_PRIRITY0 will be drawn on top of BG_PRIORITY3)
<br/>
<br/>
I hope I could help.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#123758 - Payk - Fri Mar 30, 2007 9:52 pm</h4>
    <div class="postbody"><span class="postbody">If you update devkitpro, you can choose on clearcolor-function a blend value from 0 to 31(its the 4th argument...totaly new since antialias works). If you choose 0 you should directly see a bg behind the polygone.
<br/>
<br/>
<br/>
If now the polygone it self has blending between 1 and 30 (polyfmt blending) it should be semitransparent to the bg.
<br/>
(notice: i didnt tested it !)
<br/>
<br/>
BTW: Noda you did a great game ;)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#123765 - silent_code - Fri Mar 30, 2007 10:58 pm</h4>
    <div class="postbody"><span class="postbody">another solution is the socalled "clear image". that is, instead of a single colored clear plane, you can set up an entire image (aswell as an depth image - think resident evil etc) that will clear the display. now, any part of the scene you don't draw to will contain that image. downpart: you have to use 2 whole vram banks, as each, the color and depth image, need to be a 15/16bit full resolution bitmap. :^|</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#124009 - Noda - Mon Apr 02, 2007 1:37 pm</h4>
    <div class="postbody"><span class="postbody">Thanks, I'll check Payk solution as I already use all 4 vram banks ;) And I know how to do BG-BG blending but I only want specific polys to be transparent over the BG ^^
<br/>
<br/>
I'll report if it works as it may be useful for other people or future requests.
<br/>
<br/>
PS: You did a great job too Payk, your 3d engine is quite impressive ^^</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#124963 - Payk - Tue Apr 10, 2007 12:21 pm</h4>
    <div class="postbody"><span class="postbody">:D thanx Noda. And congrats btw. I really think your game is the better one, the gameplay is still fun for me :D</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#125198 - RavenWorks - Thu Apr 12, 2007 1:47 am</h4>
    <div class="postbody"><span class="postbody">Have you still not succeeded? I've got a 2D engine running on transparent quads. I'll see what I can do to help if you're still having trouble.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#151521 - TwentySeven - Thu Feb 28, 2008 6:36 am</h4>
    <div class="postbody"><span class="postbody">*necro bump* 
<br/>
<br/>
I'm running into this, and another weird issue as well.  I've searched the forums and updated my setup a little, but the basic problems remain.
<br/>
<br/>
I have a 3d layer floating over two Tiled BGs. 
<br/>
<br/>
I try and render a texture quad with a 16bit alphacutout texture, that works fine.   Once I turn on per poly alpha translucency, things start going weird:
<br/>
<br/>
Specifically, at values of ALPHA_POLY(22 to 31) the quad remains fully opaque, except for the textures alpha cutout.
<br/>
<br/>
At values of ALPHA_POLY(0 to 21) the quad disapears completely.
<br/>
<br/>
I noticed in the nehe lesson 8 it uses a glClearColor alpha of 31, making the 3d background fully opaque.  When I tried this, it indeed blends correctly against the ClearCcolor (black) but of course I want the 3d layer transparent..
<br/>
<br/>
Here's my setup:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
<br/>
glInit();
<br/>
   
<br/>
//Enable texturing
<br/>
glEnable(GL_TEXTURE_2D);
<br/>
<br/>
// setup the rear plane
<br/>
glClearColor(0,0,0,0); 
<br/>
glClearPolyID(63); // BG must have a unique polygon ID for AA to work
<br/>
glClearDepth(0x7FFF);
<br/>
glViewport(0,0,255,191);
<br/>
<br/>
//camera junk
<br/>
glMatrixMode(GL_PROJECTION);
<br/>
glLoadIdentity();
<br/>
glOrtho(0,255,191,0,-512,1024);
<br/>
glTranslatef(0,0,-1024);
<br/>
///
<br/>
<br/>
while (1)
<br/>
{
<br/>
glEnable(GL_BLEND);
<br/>
glAlphaFunc(BLEND_ALPHA);
<br/>
glPolyFmt(POLY_ALPHA(15) | POLY_CULL_NONE | POLY_ID(0)  );
<br/>
<br/>
//bind a texture
<br/>
glBegin(GL_QUAD);
<br/>
// ~~ draw some stuff
<br/>
glEnd();
<br/>
<br/>
glFlush(0) ;
<br/>
//glFlush(GL_TRANS_MANUALSORT);    //Makes no difference
<br/>
swiWaitForVBlank();      
<br/>
}
<br/>
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#151533 - Cydrak - Thu Feb 28, 2008 4:56 pm</h4>
    <div class="postbody"><span class="postbody">What's BLEND_ALPHA for? glAlphaFunc controls the alpha test. Alpha less than the threshold isn't rendered. Maybe that's what you're seeing?
<br/>
<br/>
Having tried this--alpha test applies to the poly, not the texture alone, so it seems a POLY_ALPHA less than glAlphaFunc will never show up. This is more obvious with A5I3 / A3I5 textures, which can have fractional alpha (like color, it's further modulated by the poly's).
<br/>
<br/>
Also, a transparent "clear color" isn't enough. You still need to tell the layer engine to _use_ the alpha, by setting BLEND_CR:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
glClearColor(0, 0, 0, 0);
<br/>
glClearDepth(0x7fff);
<br/>
glClearPolyID(63);
<br/>
glEnable(GL_BLEND);
<br/>
<br/>
/* unless needed--like all glEnable*, this is scene global */
<br/>
glDisable(GL_ALPHA_TEST);  
<br/>
glAlphaFunc(0);
<br/>
<br/>
BG0_CR = BG_PRIORITY(m);
<br/>
BGx_CR = ... | BG_PRIORITY(n);  /* n &gt; m */
<br/>
BLEND_CR = BLEND_ALPHA | BLEND_SRC_BG0 | BLEND_DST_*;
<br/>
<br/>
glPolyFmt(POLY_ID(x) | POLY_ALPHA(y) | ...);
<br/>
glBegin(...);
<br/>
</td> </tr></table><span class="postbody">
<br/>
When 3D on BG0 is selected as a source (and it appears atop any "dest"), it is always a per-pixel alpha blend, ignoring BLEND_AB, BLEND_Y and the blend mode. This might not be true of other matched "blending pairs", though...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#151559 - TwentySeven - Fri Feb 29, 2008 4:44 am</h4>
    <div class="postbody"><span class="postbody">Ok, thankyou very much for the tips Crydak.
<br/>
<br/>
My BG_CR's now have BLEND_ALPHA, and Ive done alot of messing around with BLEND_CR, but I still can't get things working correctly.
<br/>
<br/>
Could someone possibly provide some demo source of this working?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#151580 - M3d10n - Fri Feb 29, 2008 6:53 pm</h4>
    <div class="postbody"><span class="postbody">Make sure the priorities are correct, so the tiled BG renders below the 3D BG. Also, are you testing on hardware? I wouldn't trust emulators for such graphic effect (exaple: none of the emulators emulate fog properly yet).</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#151589 - TwentySeven - Sat Mar 01, 2008 12:30 am</h4>
    <div class="postbody"><span class="postbody">Yeah theres definately a difference between the hardware and the emulators. 
<br/>
<br/>
My BG's are rendering in the correct order, things are rendering opaquely just fine.
<br/>
<br/>
Its when I introduce polyalpha and attempt to see the tile bg's through the translucent polys, that it just either renders them completely opaque or not at all.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#151596 - Cydrak - Sat Mar 01, 2008 2:39 am</h4>
    <div class="postbody"><span class="postbody">BLEND_ALPHA goes in BLEND_CR, not BGx_CR. (Was that what you meant?)
<br/>
<br/>
<a class="postlink" href="http://draci.chaosnet.org/code/ex-3dblend.zip" target="_blank">http://draci.chaosnet.org/code/ex-3dblend.zip</a>
<br/>
<br/>
Here, hopefully this works. Don't bother with the emulators. Even the lovely NO$GBA gets it wrong. :/
<br/>
<br/>
I actually found some quirks with this (see source comments). Briefly, the DS' blending is normal for RGB, but alpha is treated rather curiously. My guess would be out.A = MAX(source.A, dest.A). Notice when touching, that it's never possible to fully hide the BG... and how stuff seems not to blend outside the quads, because the alpha stays constant.
<br/>
<br/>
You can also see (watch the quads at the very end of the trail) the thing with alpha + poly IDs, and how it leads to "draw behind" effects. This seems order or Z-dependent. Like if I draw quads of ID 0, 1, then 0; and 1 sits in the middle of the stack, then the IDs may not clash as usual.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#151597 - TwentySeven - Sat Mar 01, 2008 3:07 am</h4>
    <div class="postbody"><span class="postbody">And the winner is Cydrak!  Thankyou so much for taking the time to put that sample together, it let me fix what I was doing wrong in about 30 seconds :D
<br/>
<br/>
BLEND_CR accepts multiple DST_ flags.  I had been experimenting with a single DST at a time. &gt;_&lt;
<br/>
I've added all of the required DST_BGs and DST_BACKDROP and its working now.
<br/>
<br/>
Thankyou so much!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#151599 - TwentySeven - Sat Mar 01, 2008 3:35 am</h4>
    <div class="postbody"><span class="postbody">Small Update: No$GBA 2.6a seems to get it right.  The version I was using before (2.5x?) was goofing it badly.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#151601 - Cydrak - Sat Mar 01, 2008 4:05 am</h4>
    <div class="postbody"><span class="postbody">Heh, welcome. :)
<br/>
<br/>
BLEND_CR is an odd beast, and takes any combination of anything. It will only blend once, but it can make different choices. As I understand, <span style="font-style: italic">for each pixel</span> it looks at the layers and sprite visible there (literally--so index or alpha 0 is invisible). Then, for blending it considers the top two; for fades, just the top of the stack...
<br/>
<br/>
(ed: you're right, release notes say blends/ids are addressed in 2.6a... I still have 2.6)</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
