<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Odd quad rendering behavior - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > Odd quad rendering behavior</h2>
<div id="posts">
<div class="post">
    <h4>#116446 - NeX - Thu Jan 25, 2007 9:02 pm</h4>
    <div class="postbody"><span class="postbody">This works in an emulator; on hardware nothing appears.
<br/>
The array TRACKMESH is a v16 array; nothing unusual there.  In Dualis, the track displays perfectly.  If I set the first vertex to a fixed position, the DS draws a single line across the screen - like one of the quads is stick thin.  It is no where near as messed up in Dualis... it just does exactly what I expect it to.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
      //draw the obj
<br/>
      glBegin(GL_QUAD_STRIP);
<br/>
         u8 i=0;
<br/>
         while(i&lt;22)
<br/>
         {
<br/>
            glColor3b(255,0,0);
<br/>
            glVertex3v16(trackmesh[i][0][0],trackmesh[i][0][1],trackmesh[i][0][2]);
<br/>
<br/>
            glColor3b(0,255,0);
<br/>
            glVertex3v16(trackmesh[i][1][0],trackmesh[i][1][1],trackmesh[i][1][2]);
<br/>
         i++;
<br/>
         }
<br/>
<br/>
<br/>
      glEnd();
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I could check the array with a console output, but there is unfortunately no v16tofloat command, so all I get is jibberish.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#116451 - simonjhall - Thu Jan 25, 2007 9:49 pm</h4>
    <div class="postbody"><span class="postbody">As a v16 is a 4.12 format number, if you want it in floating-point format I'd just divide it by 4096. If you just shift it left by 12 bits you'll only get the whole number part.
<br/>
So,
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">v16 anus;
<br/>
...
<br/>
float number = (float)anus / 4096.</td> </tr></table><span class="postbody">Cha'mone.
<br/>
<br/>
Dunno about the rendering problem however...<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#116461 - Rajveer - Thu Jan 25, 2007 11:18 pm</h4>
    <div class="postbody"><span class="postbody">Just to make sure, I had a problem where models were a scanline thick on the ds and perfect on dualis (or ideas, i forget) and its when I first got into programming on the DS where I didnt use fixed point values (i.e. 4096 instead of 1) with those commands.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#116554 - NeX - Fri Jan 26, 2007 8:33 pm</h4>
    <div class="postbody"><span class="postbody">Hmm... I noticed a red dot, and realized it was the track being compressed into one point.  So I made it console display the exact data being turned into the track (signed 8 bit accuracy).  Guess what.  It's all zero.  But it's right on Dualis...
<br/>
<br/>
I'm using this to shift the data into the array-
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
   u8 track[1024];
<br/>
<br/>
      const void *track_raw = gbfs_get_obj(&amp;data_gbfs, "ttrack.dsm", NULL);    
<br/>
         DC_FlushAll();
<br/>
         
<br/>
      dmaCopy(track_raw, (void*)track, 200);
<br/>
         DC_FlushAll();
<br/>
</td> </tr></table><span class="postbody">
<br/>
Is dmaCopy a good idea to use in this situation?  And what does the DC_FlushAll() do?  All my other instances of dmaCopy fail without it.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#116572 - simonjhall - Sat Jan 27, 2007 12:10 am</h4>
    <div class="postbody"><span class="postbody">Ah ha! I don't know the specifics of this dmaCopy function, but if it's non-blocking then that could be the cause of your problem. Try just doing a regular memcpy first to see if you still get problems.
<br/>
<br/>
The DC_FlushAll tells the ARM9's MPU co-pro to flush the CPU's data cache to memory. I doubt the MPU waits for pending DMAs to finish before doing this.
<br/>
<br/>
Also (again, don't know DS specifics), but other platforms I've worked with require the source and destination addresses to be aligned to 'good' values (eg 16 bytes) and the transfer size to be a multiple of some nice size (eg 16 bytes). Again, try memcpy. You shouldn't need a cache flush with that and you won't need aligned addresses.
<br/>
<br/>
The reason it may work on an emulator is that DMAs can often be coded as just plain DMAs - ie instant. This isn't the case on real hardware...<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#116714 - NeX - Sun Jan 28, 2007 8:17 pm</h4>
    <div class="postbody"><span class="postbody">Thanks!  I wouldn't have figured this out on my own.  Bad DMAcopy!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#116715 - tepples - Sun Jan 28, 2007 8:20 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>simonjhall wrote:</b></span></td> </tr> <tr> <td class="quote">Also (again, don't know DS specifics), but other platforms I've worked with require the source and destination addresses to be aligned to 'good' values (eg 16 bytes) and the transfer size to be a multiple of some nice size (eg 16 bytes).</td> </tr></table><span class="postbody">
<br/>
DMAs on at least Game Boy Advance use 4-byte alignment.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#116761 - wintermute - Mon Jan 29, 2007 5:02 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>NeX wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
Is dmaCopy a good idea to use in this situation?  And what does the DC_FlushAll() do?  All my other instances of dmaCopy fail without it.</td> </tr></table><span class="postbody">
<br/>
<br/>
DC_FlushAll() flushes all pending writes in the data cache to memory and is a bit overkill. DC_FlushRange( base address, size ) should be used in preference.
<br/>
<br/>
The cache requires flushing when you wish to DMA <span style="font-weight: bold">from</span> a region of memory which has been manipulated by the CPU.
<br/>
<br/>
You should use DC_InvalidateRange( base address, size ) when you wish the CPU to manipulate a region of memory which has been changed by DMAing <span style="font-weight: bold">to</span> it.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tepples wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
DMAs on at least Game Boy Advance use 4-byte alignment.
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Unless they're 16bit DMAs in which case it's 2 byte alignment.<br/>_________________<br/><a class="postlink" href="http://www.devkitpro.org/" target="_blank">devkitPro - professional toolchains at amateur prices</a>
<br/>
<a class="postlink" href="http://wiki.devkitpro.org/index.php/IRC" target="_blank">devkitPro IRC support</a>
<br/>
<a class="postlink" href="http://davejmurphy.com/" target="_blank">Personal Blog</a></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
