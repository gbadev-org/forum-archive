<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Re-initializing the DS Hardware - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>DS development > Re-initializing the DS Hardware</h2>
<div id="posts">
<div class="post">
    <h4>#163640 - cornaljoe - Tue Oct 07, 2008 2:29 pm</h4>
    <div class="postbody"><span class="postbody">When using this code to boot into GBA mode from DS mode, some carts don't reboot properly.  They hang at the GBA logo with no Nintendo logo.  I believe the problem is the way these carts partially boot the DS firmware.  Is there a way to completely reboot the DS with the firmware intact to insure GBA mode doesn't freeze?
<br/>
<br/>
ARM9</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">inline void clearmem(u32 dest, u32 size)
<br/>
{   int i=0;
<br/>
   swiFastCopy(&amp;i, (u32*)dest, 0x01000000 | (size&gt;&gt;2));
<br/>
}
<br/>
<br/>
void main()
<br/>
{  sysSetBusOwners(BUS_OWNER_ARM7,BUS_OWNER_ARM7);
<br/>
   swiDelay(0x200000);
<br/>
   REG_IME=0;
<br/>
   REG_IE=0;
<br/>
   REG_DISPSTAT=0;
<br/>
   DISPLAY_CR=0;
<br/>
   SUB_DISPLAY_CR=0;
<br/>
   
<br/>
   clearmem(0x40000B0, 0x30);
<br/>
   
<br/>
   REG_POWERCNT=1;
<br/>
   VRAM_CR=0x80808080;
<br/>
   VRAM_E_CR=0x80;
<br/>
   VRAM_F_CR=0x80;
<br/>
   VRAM_G_CR=0x80;
<br/>
   VRAM_H_CR=0x80;
<br/>
   VRAM_I_CR=0x80;
<br/>
   clearmem(0x6800000,0xA4000);
<br/>
   VRAM_CR=0;
<br/>
   VRAM_E_CR=0;
<br/>
   VRAM_F_CR=0;
<br/>
   VRAM_G_CR=0;
<br/>
   VRAM_H_CR=0;
<br/>
   VRAM_I_CR=0;
<br/>
   
<br/>
   REG_POWERCNT=POWER_SWAP_LCDS | POWER_ALL_2D;
<br/>
   clearmem(0x5000000, 0x800);
<br/>
   clearmem(0x7000000, 0x800);
<br/>
   
<br/>
   if(((PERSONAL_DATA *)0x023FFC80)-&gt;_user_data.gbaScreen)
<br/>
   {   REG_POWERCNT &amp;= ~POWER_SWAP_LCDS;
<br/>
   }else
<br/>
   {   REG_POWERCNT |= POWER_SWAP_LCDS;
<br/>
   }
<br/>
   
<br/>
   REG_IPC_FIFO_TX = 0x88888888;
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
ARM7</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void main()
<br/>
{   uint8 current, backlight;
<br/>
   
<br/>
   if(((PERSONAL_DATA *)0x023FFC80)-&gt;_user_data.gbaScreen)
<br/>
   {   backlight = ~PM_BACKLIGHT_TOP;
<br/>
   }else
<br/>
   {   backlight = ~PM_BACKLIGHT_BOTTOM;
<br/>
   }
<br/>
   
<br/>
   // Reset the clock if needed
<br/>
   rtcReset();
<br/>
<br/>
   //enable sound
<br/>
   powerON(POWER_SOUND);
<br/>
   SOUND_CR = SOUND_ENABLE | SOUND_VOL(0x7F);
<br/>
<br/>
   REG_SPICNT = SPI_ENABLE | SPI_DEVICE_POWER | SPI_BAUD_1MHz | SPI_CONTINUOUS;
<br/>
   REG_SPIDATA = 0x80;
<br/>
<br/>
   SerialWaitBusy();
<br/>
   REG_SPICNT = SPI_ENABLE | SPI_DEVICE_POWER | SPI_BAUD_1MHz ;
<br/>
   REG_SPIDATA = 0;
<br/>
<br/>
   SerialWaitBusy();
<br/>
   current = REG_SPIDATA &amp; 0xff;
<br/>
<br/>
   current = current &amp; backlight;
<br/>
<br/>
   SerialWaitBusy();
<br/>
   REG_SPICNT = SPI_ENABLE | SPI_DEVICE_POWER | SPI_BAUD_1MHZ | SPI_CONTINUOUS;
<br/>
   REG_SPIDATA = 0;
<br/>
   SerialWaitBusy();
<br/>
   REG_SPICNT = SPI_ENABLE | SPI_DEVICE_POWER | SPI_BAUD_1MHZ;
<br/>
   REG_SPIDATA = current;
<br/>
<br/>
   SerialWaitBusy();
<br/>
   swiSwitchToGBAMode();
<br/>
}</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#163712 - hacker013 - Thu Oct 09, 2008 5:18 pm</h4>
    <div class="postbody"><span class="postbody">that can't<br/>_________________<br/><a class="postlink" href="http://imetal.nl/" target="_blank">Website / Blog</a>
<br/>
<br/>
Let the nds be with you.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
