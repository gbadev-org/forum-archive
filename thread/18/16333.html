<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Coding a game in pure asm using DevKitPro - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>DS development > Coding a game in pure asm using DevKitPro</h2>
<div id="posts">
<div class="post">
    <h4>#165773 - headspin - Tue Jan 06, 2009 3:46 pm</h4>
    <div class="postbody"><span class="postbody">A friend and I decided to try and rewrite an old C64 game he wrote (Warhawk) to the NDS. I wanted to use the very latest DevKitPro and have got a few demos working so far. Since there are very few examples written in pure asm for DS (that we can find) we are learning as we go. We wanted to write it in asm because he has a background in assembly and for the challenge. My background is C so I'm learning asm as I go.
<br/>
<br/>
Now we are at the point where we want a level of the game scrolling up both screens. The demo is using a 64x64 tile mode and doing dmaCopy's each 256 lines scrolled for maximum speed. We are using grit's -mLs option so the data is stored in screen blocks ready for dmaCopy'ing. For some reason when I try to scroll BG1 where I'm writing the map data to (as stated in the REG_BG1CNT / REG_BG1CNT_SUB registers) it's actually writing the data to BG0. I can tell this because when I change the scroll registers to REG_BG0VOFS / REG_BG0VOFS_SUB it starts scrolling the map. It just doesn't match up with how the BG's have been assigned. It leads us to believe that the BG's must use certain areas in VRAM but I can't find any documenation to back that theory up.
<br/>
<br/>
So I decided to write the demo in C to see if we had messed up in some way. Apart from the screens needing an lcdSwap() the C code seemed to work fine. It's written a bit strangely to keep the code as close to the asm version as possible.
<br/>
<br/>
Another thing is we can't seem to get vblank working on hardware. Even running the C version on hardware it does not wait for vblank. That is using the "combined template" example from DevKitPro as the starting point. It scrolls the entire level in under a second. It runs fine in an emulator.
<br/>
<br/>
I'm going to attach both the asm and C version so hopefully someone can take a look and help in some way. Thanks for your time :)
<br/>
<br/>
<a href="http://members.iinet.net.au/~freeaxs/nds/leveltest.png">[Images not permitted - Click here to view it]</a>
<br/>
<a class="postlink" href="http://members.iinet.net.au/~freeaxs/nds/leveltest_asm.zip" target="_blank">leveltest_asm.zip</a>
<br/>
<a class="postlink" href="http://members.iinet.net.au/~freeaxs/nds/leveltest_c.zip" target="_blank">leveltest_c.zip</a><br/>_________________<br/><a class="postlink" href="http://headsoft.com.au/index.php?category=warhawk" target="_blank">Warhawk DS</a> | <a class="postlink" href="http://headsoft.com.au/index.php?category=mmll" target="_blank">Manic Miner: The Lost Levels</a> | <a class="postlink" href="http://headsoft.com.au/index.php?category=tdg" target="_blank">The Detective Game</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#165774 - dovoto - Tue Jan 06, 2009 4:23 pm</h4>
    <div class="postbody"><span class="postbody">Well, a quick glance tells me you are treating the background scroll registers as readable...they are write only.  This is definitly going to cause you issues although I am not certain if this could cause the issue you are describing.
<br/>
<br/>
Background tile and graphics can only be placed in memory set aside for that engines backgrounds....there is no way for a sub background to use or share the tiles or map in a main background for instance.<br/>_________________<br/><a href="http://www.drunkencoders.com" target="_blank">www.drunkencoders.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#165775 - shaymanjw - Tue Jan 06, 2009 4:39 pm</h4>
    <div class="postbody"><span class="postbody">I think you might need an irqEnable(IRQ_VBLANK) at the start of main() somewhere (for the VBLANK problem obviously) (I could be wrong).</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#165776 - dovoto - Tue Jan 06, 2009 4:50 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>shaymanjw wrote:</b></span></td> </tr> <tr> <td class="quote">I think you might need an irqEnable(IRQ_VBLANK) at the start of main() somewhere (for the VBLANK problem obviously) (I could be wrong).</td> </tr></table><span class="postbody">
<br/>
<br/>
This is no longer required as irqs are initialized and the vblank irq enabled prior to main as of the last release of libnds.<br/>_________________<br/><a href="http://www.drunkencoders.com" target="_blank">www.drunkencoders.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#165781 - headspin - Tue Jan 06, 2009 6:48 pm</h4>
    <div class="postbody"><span class="postbody">Wow I didn't know the scroll registers were read only. Are you sure thats right? The asm code that reads from them is working just not in the background we expect it to. And it's run on hardware before so how can that be?
<br/>
<br/>
Also we are not using the swiWaitForVBlank() because we are not linking in libnds for the asm project. So we were trying to use a modified example from GBAGuy's asm tutorial for the GBA.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">    ldr r0, =REG_VCOUNT
<br/>
waitVBlank:                           
<br/>
    ldrh r2, [r0]                        @ read REG_VCOUNT into r2
<br/>
    cmp r2, #(SCREEN_HEIGHT + 1)        @ 193 is, of course, the first scanline of vblank
<br/>
    bne waitVBlank                        @ loop if r2 is not equal to (NE condition) 193</td> </tr></table><span class="postbody">
<br/>
<br/>
It doesn't work, and I also tried to modify another version which I translated from C
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">// C Code
<br/>
<br/>
void waitForVBlank(void)
<br/>
{
<br/>
    while(!(REG_DISPSTAT &amp; DISP_IN_VBLANK));
<br/>
    while((REG_DISPSTAT &amp; DISP_IN_VBLANK));
<br/>
}
<br/>
<br/>
@ My (possibly wrong) translation to asm
<br/>
<br/>
    ldr r0, =REG_DISPSTAT
<br/>
waitVBlankA:
<br/>
    ldr r1, [r0]
<br/>
    tst r1, #DISP_IN_VBLANK
<br/>
    bne waitVBlankA
<br/>
waitVBlankB:
<br/>
    ldr r1, [r0]
<br/>
    tst r1, #DISP_IN_VBLANK
<br/>
    beq waitVBlankB</td> </tr></table><span class="postbody">
<br/>
<br/>
Again it didn't work but whats even stranger is the swiWaitForVBlank() in the C version which *does* use libnds still doesn't seem to be waiting for vblank on hardware. So it's like we are screwing something up somewere.
<br/>
<br/>
In the demo were not sharing any map or tile data as were using the macro's BG_TILE_RAM(n), BG_TILE_RAM_SUB(n), BG_MAP_RAM(n), BG_MAP_RAM_SUB(n) to make sure we write to the correct location for each screen.
<br/>
<br/>
Is there something that libnds does that we should be doing? I copied the initSystem() routine into our app (minus the interrupt code) but that didn't help. If the scroll regs are read only I guess that's a good place to start - it's easy enough to create a variable to keep track of it.<br/>_________________<br/><a class="postlink" href="http://headsoft.com.au/index.php?category=warhawk" target="_blank">Warhawk DS</a> | <a class="postlink" href="http://headsoft.com.au/index.php?category=mmll" target="_blank">Manic Miner: The Lost Levels</a> | <a class="postlink" href="http://headsoft.com.au/index.php?category=tdg" target="_blank">The Detective Game</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#165794 - Chase-san - Wed Jan 07, 2009 1:44 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>headspin wrote:</b></span></td> </tr> <tr> <td class="quote">Wow I didn't know the scroll registers were read only. Are you sure thats right? The asm code that reads from them is working just not in the background we expect it to. And it's run on hardware before so how can that be?</td> </tr></table><span class="postbody">
<br/>
<br/>
He said WRITE only, not read only.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#165801 - headspin - Wed Jan 07, 2009 8:03 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Chase-san wrote:</b></span></td> </tr> <tr> <td class="quote">He said WRITE only, not read only.</td> </tr></table><span class="postbody">
<br/>
<br/>
That was obviously a typo ;)<br/>_________________<br/><a class="postlink" href="http://headsoft.com.au/index.php?category=warhawk" target="_blank">Warhawk DS</a> | <a class="postlink" href="http://headsoft.com.au/index.php?category=mmll" target="_blank">Manic Miner: The Lost Levels</a> | <a class="postlink" href="http://headsoft.com.au/index.php?category=tdg" target="_blank">The Detective Game</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#165807 - Flash - Wed Jan 07, 2009 9:37 am</h4>
    <div class="postbody"><span class="postbody">The thing about the scroll registers is that our scroll routine relys on the reading of them to update the bit scroll and check for the background block scroll on a page basis, and this works? If the registers are write only then I cannot see how this code would work?
<br/>
<br/>
We have 2 main problems at the moment that have been driving both HK and I crazy for the last week,
<br/>
<br/>
No matter what we do with checks for VBLANK in the code, the game runs much too fast during emulation and faster still on real hardware. I have successfuly split every raster line to perform as BGxHOFS on a per-line basis to create an old-school raster wobble, and this works fine - Indicating that the VBLANK check works? The problem is in the code posted prior, we are trying to check for the screen base, then do our code, and return to execution. But this is not leaving the update as 1/60th for some reason.
<br/>
<br/>
Secondly, access to BG0 and BG2 works as expected, but we cannot appear to make use of BG1 and BG3. Our scroll code works fine using BG0 (and BG0 + BG2 in current version) but what is strange is that swapping the scroll to BG1 causes the display of garbage, where we were expecting it to work the same but on BG1? Checking the MAP and data in Dualis shows that this is still mapped to BG0? Regardless of the setting of the BG1 and BG3 flags, the code carries on working with BG0 and BG2?
<br/>
<br/>
Any help in this would be very welcome as this has now become a major stumbling block in the progression of this code!
<br/>
<br/>
Thanks in advance!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#165808 - eKid - Wed Jan 07, 2009 10:26 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Flash wrote:</b></span></td> </tr> <tr> <td class="quote">The thing about the scroll registers is that our scroll routine relys on the reading of them to update the bit scroll and check for the background block scroll on a page basis, and this works? If the registers are write only then I cannot see how this code would work?</td> </tr></table><span class="postbody">
<br/>
GBAtek says that they are read only (gba specific), I just confirmed this for DS. So you must be missing something...
<br/>
<br/>
The reason why you can't use BG1/BG3 is because you are writing the wrong sized data to the registers.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">   ldr r0, =REG_BG1CNT            @ Set main screen BG0 format to be 64x64 tiles at base address
<br/>
   ldr r1, =(BG_COLOR_16 | BG_64x64 | BG_MAP_BASE(4) | BG_TILE_BASE(5) | BG_PRIORITY(1))
<br/>
   str r1, [r0]
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
This is a 32-bit write, the registers are 16-bit, REG_BG1CNT/BG3CNT are 'mis-aligned' by 2 bytes. When you write 32 bits to a misaligned address then the write will be force-aligned (i think there may be some other weird behavior sometimes too [with different processor versions])...
<br/>
<br/>
Anyway, what's going on is when you write to bg1/bg3cnt it is actually writing the half-word to BG0/BG2CNT and zero filling (the top half-word of your data is zero) the BG1/BG3CNT. To fix, write 16-bits instead with the 'strh' opcode.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#165810 - headspin - Wed Jan 07, 2009 11:02 am</h4>
    <div class="postbody"><span class="postbody">eKid: Thanks alot mate! The funny thing is I swore that I checked those registers and was certain they were 32bit. But you were right looking in background.h we can see.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#define REG_BG0CNT (*(vu16*)0x4000008)</td> </tr></table><span class="postbody">
<br/>
<br/>
So using strh fixed that and now the scrolling works :) Can't believe we missed that actually.
<br/>
<br/>
Now if the scroll registers are write only that might be causing other issues. I'll look into it, thanks again.<br/>_________________<br/><a class="postlink" href="http://headsoft.com.au/index.php?category=warhawk" target="_blank">Warhawk DS</a> | <a class="postlink" href="http://headsoft.com.au/index.php?category=mmll" target="_blank">Manic Miner: The Lost Levels</a> | <a class="postlink" href="http://headsoft.com.au/index.php?category=tdg" target="_blank">The Detective Game</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#165812 - headspin - Wed Jan 07, 2009 12:20 pm</h4>
    <div class="postbody"><span class="postbody">Yep, I changed the code to use a variable instead of attempting to read the scroll registers and vblank now works and it scrolls nice and smoothly on hardware! Thanks to everyone who helped. I'm sure we'll be back with more questions in the near future ;)<br/>_________________<br/><a class="postlink" href="http://headsoft.com.au/index.php?category=warhawk" target="_blank">Warhawk DS</a> | <a class="postlink" href="http://headsoft.com.au/index.php?category=mmll" target="_blank">Manic Miner: The Lost Levels</a> | <a class="postlink" href="http://headsoft.com.au/index.php?category=tdg" target="_blank">The Detective Game</a></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
