<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Popping sounds in streaming.. [Solved] - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>DS development > Popping sounds in streaming.. [Solved]</h2>
<div id="posts">
<div class="post">
    <h4>#149642 - sowee - Wed Jan 23, 2008 5:59 am</h4>
    <div class="postbody"><span class="postbody">I set up streaming code using vblank, fifo, and a timer, theres a counter for every time the code runs through the vblank but it seems to stop at 5...i've been debugging for a while now and can't seem to find the problem
<br/>
<br/>
my arm7 main method:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">readUserSettings();
<br/>
   powerON(POWER_SOUND);
<br/>
   writePowerManagement(PM_CONTROL_REG, ( readPowerManagement(PM_CONTROL_REG) &amp; ~PM_SOUND_MUTE ) | PM_SOUND_AMP );
<br/>
   SOUND_CR = SOUND_ENABLE | SOUND_VOL(0x7F);
<br/>
<br/>
   irqInit();
<br/>
   initClockIRQ();
<br/>
<br/>
   SetYtrigger(80);
<br/>
   
<br/>
   irqSet(IRQ_VCOUNT , VcountHandler);
<br/>
   irqSet(IRQ_VBLANK, VblankHandler);
<br/>
   irqSet(IRQ_FIFO_NOT_EMPTY, SoundFifoHandler);
<br/>
   irqEnable(IRQ_VBLANK);
<br/>
   irqEnable(IRQ_VCOUNT);
<br/>
   irqEnable(IRQ_FIFO_NOT_EMPTY);
<br/>
<br/>
   REG_IPC_FIFO_CR = IPC_FIFO_ENABLE | IPC_FIFO_SEND_CLEAR | IPC_FIFO_RECV_IRQ;
<br/>
   
<br/>
   SoundSetTimer(0);
<br/>
   while (1) swiWaitForVBlank();
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
vblankHandler does this:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">   if(sharedSoundControl-&gt;stream.cmd &amp; INIT)
<br/>
   {
<br/>
      SoundSetTimer(sharedSoundControl-&gt;stream.period);
<br/>
      sharedSoundControl-&gt;stream.cmd &amp;= ~INIT;
<br/>
   }
<br/>
   else if(sharedSoundControl-&gt;stream.cmd &amp; MIXING)
<br/>
   {
<br/>
      sharedSoundControl-&gt;stream.inswapandmix++;
<br/>
      SoundSwapAndMix();
<br/>
   }
<br/>
   if(sharedSoundControl-&gt;stream.cmd &amp; MIX)
<br/>
   {
<br/>
      StreamSound(&amp;sharedSoundControl-&gt;stream);
<br/>
      sharedSoundControl-&gt;stream.cmd &amp;= ~MIX;
<br/>
      sharedSoundControl-&gt;stream.cmd |= MIXING;
<br/>
   }</td> </tr></table><span class="postbody">
<br/>
<br/>
and SoundFifoHandler does this:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">u32 command;
<br/>
<br/>
   if (!(REG_IPC_FIFO_CR &amp; IPC_FIFO_RECV_EMPTY))
<br/>
   {
<br/>
      command = REG_IPC_FIFO_RX;
<br/>
      
<br/>
      switch(command)
<br/>
      {
<br/>
      case FIFO_NONE:
<br/>
         break;
<br/>
      case MIXCOMPLETE_ONARM9:
<br/>
         sharedSoundControl-&gt;stream.soundcursor += sharedSoundControl-&gt;stream.numsamples;
<br/>
         if(sharedSoundControl-&gt;stream.bits_per_sample == 8)
<br/>
            while (sharedSoundControl-&gt;stream.soundcursor &gt; sharedSoundControl-&gt;stream.buffersize) sharedSoundControl-&gt;stream.soundcursor -= sharedSoundControl-&gt;stream.buffersize;
<br/>
         else
<br/>
            while (sharedSoundControl-&gt;stream.soundcursor &gt; (sharedSoundControl-&gt;stream.buffersize &gt;&gt; 1)) sharedSoundControl-&gt;stream.soundcursor -= (sharedSoundControl-&gt;stream.buffersize &gt;&gt; 1);
<br/>
         break;
<br/>
      }
<br/>
   }</td> </tr></table><span class="postbody">
<br/>
<br/>
while SoundSetTimer is:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
void SoundSetTimer(int period)
<br/>
{
<br/>
   if(!period)
<br/>
   {
<br/>
      TIMER0_DATA = 0;
<br/>
      TIMER0_CR = 0;
<br/>
      TIMER1_DATA = 0;
<br/>
      TIMER1_CR = 0;
<br/>
   }
<br/>
   else
<br/>
   {
<br/>
      TIMER0_DATA = 0x10000 - (period * 2);
<br/>
      TIMER0_CR = TIMER_ENABLE | TIMER_DIV_1;
<br/>
<br/>
      TIMER1_DATA = 0;
<br/>
      TIMER1_CR = TIMER_ENABLE | TIMER_CASCADE | TIMER_DIV_1;
<br/>
   }
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
My problem seems to be that it gets stuck such that it never enters SoundSwapAndMix() so my program keeps on streaming garbage (popping sound).
<br/>
<br/>
The relevant code in my arm9 main method is this:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
   irqSet(IRQ_VBLANK, VBlankHandler);
<br/>
   irqSet(IRQ_FIFO_NOT_EMPTY, FifoHandler);
<br/>
   irqEnable(IRQ_VBLANK);
<br/>
   irqEnable(IRQ_FIFO_NOT_EMPTY);
<br/>
   
<br/>
   REG_IPC_FIFO_CR = IPC_FIFO_ENABLE | IPC_FIFO_SEND_CLEAR | IPC_FIFO_RECV_IRQ; </td> </tr></table><span class="postbody">
<br/>
<br/>
where VBlankHandler just increments a variable for me to check that it runs continuosly...and that variable gets stuck at 5!
<br/>
FifoHandler looks the same as the one in arm7 and calls a MixSound method when notified with UPDATE_ONARM9 from arm7...and this also never happens.. i don't get what the problem is, can someone help me?</span><span class="gensmall"><br/><br/>Last edited by sowee on Tue Feb 05, 2008 5:27 am; edited 4 times in total</span></div>    
</div>
<div class="post">
    <h4>#150217 - sowee - Thu Jan 31, 2008 1:19 pm</h4>
    <div class="postbody"><span class="postbody">just recycling an old thread i have..
<br/>
*EDIT* 
<br/>
I don't know if this info helps..but it seems when the vblankhandlers of both processors are active, the problem occurs..am i doing something wrong with the vblank interrupt?? i don't get it..</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#150225 - GPFerror - Thu Jan 31, 2008 6:02 pm</h4>
    <div class="postbody"><span class="postbody">looks like your using the same sound streaming code i'm using so maybe the problem is your soundmixing routine is taking to long and another irq is being  fired before its done. What I did in mine was shut of irq's while its mixing and then turn them back on, when there done.
<br/>
<br/>
here is my fifo handler on arm9, the REG_IME = 0; and REG_IME = 1; is what I had to add.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void FiFoHandler(void)
<br/>
{
<br/>
   
<br/>
   u32 command;
<br/>
   while ( !(REG_IPC_FIFO_CR &amp; (IPC_FIFO_RECV_EMPTY)) ) 
<br/>
   {
<br/>
      
<br/>
      command = REG_IPC_FIFO_RX;
<br/>
<br/>
      switch(command)
<br/>
      {
<br/>
      case FIFO_NONE:
<br/>
         break;
<br/>
      case UPDATEON_ARM9:
<br/>
         //printf("FiFoHandler\n");
<br/>
         REG_IME = 0;
<br/>
         MixSound();
<br/>
         REG_IME = 1;
<br/>
         SendCommandToArm7(MIXCOMPLETE_ONARM9);
<br/>
         break;
<br/>
      }
<br/>
   }
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
Troy(GPF)
<br/>
<a href="http://gpf.dcemu.co.uk" target="_blank">http://gpf.dcemu.co.uk</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#150253 - sowee - Fri Feb 01, 2008 4:14 am</h4>
    <div class="postbody"><span class="postbody">Tried putting REG_IME=0 and REG_IME=1 but to no avail, i still have the same problem :(, I tried checking whether mixsound gets called even once, but it doesn't even enter mixsound... maybe i'm doing something wrong with the arm7 portion?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#150263 - sowee - Fri Feb 01, 2008 8:52 am</h4>
    <div class="postbody"><span class="postbody">Ok..another update, it seems theres a problem with the method i use to fill the ring buffer, without this method the vblank and fifo portions seem to work fine and my counters keep on counting... What i wanted to do was to stream from a file but i seem to be doing something wrong. I used fseek to track the current position and just update the current position so next time i fseek it would be after the ones already read, the program seems to lock up because of this
<br/>
<br/>
*EDIT*
<br/>
i could get the music to play now...but theres an awful lot of popping sounds, 1 second pop at the start, and then the music plays...then popping begins to start, accumulating till the end, until in the end theres only popping sounds after the music is done playing ehehehe :P once it loops again though the popping stops, then re-accumulate, any ideas? this is my revised fillringbuffer method
<br/>
<br/>
*EDIT*
<br/>
edit again, it seems fseek is too slow, so i just kept the file open, now theres just one loud pop everytime the music starts, but while its playing theres no popping sound hehe anyone have any idea why theres a pop at the start? :-?</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
