<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>MoveSprite causing garbled sprites (yep, another n00b topic) - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>DS development > MoveSprite causing garbled sprites (yep, another n00b topic)</h2>
<div id="posts">
<div class="post">
    <h4>#108438 - djmcbell - Wed Nov 08, 2006 8:42 pm</h4>
    <div class="postbody"><span class="postbody">Sorry for yet another pointless topic that will probably be answered inside 30 seconds.
<br/>
<br/>
Basically, using the moveSprite function from Patatersoft, code below -
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">//Move a Sprite
<br/>
void moveSprite(SpriteEntry * spriteEntry, u16 x, u16 y)
<br/>
{
<br/>
   spriteEntry-&gt;attribute[1] &amp;= 0xFE00;
<br/>
   spriteEntry-&gt;attribute[1] |= (x &amp; 0x01FF);
<br/>
   spriteEntry-&gt;attribute[0] &amp;= 0xFF00;
<br/>
   spriteEntry-&gt;attribute[0] |= (y &amp; 0x00FF);
<br/>
   updateOAM(spriteEntry);
<br/>
   updateOAM_SUB(spriteEntry);
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
I've added the updateOAM and updateOAM_SUB myself, just to quickly make sure that it works here. And there's a swiWaitForVBlank() in the main code, just after our moveSprite is called. Code for updateOAM and updateOAM_SUB below, but pretty much standard -
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">//Update the OAM - OAM_SUB
<br/>
void updateOAM(SpriteEntry * spriteEntry)
<br/>
{
<br/>
   DC_FlushAll();
<br/>
   dmaCopy(spriteEntry, OAM, 128 * sizeof(SpriteEntry));
<br/>
}
<br/>
<br/>
//Update the OAM - OAM_SUB
<br/>
void updateOAM_SUB(SpriteEntry * spriteEntry)
<br/>
{
<br/>
   DC_FlushAll();
<br/>
   dmaCopy(spriteEntry, OAM_SUB, 128 * sizeof(SpriteEntry));
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
Right, I know this is actually moving the sprites as I want, but unfortunately it seems to be resetting the sprite in the process. Looking in Dualis' OAM tells me the sprites are in the correct places, but it's basically reset the tile - blanked the sprite, the size is back to 8x8 (I assume this is the default) and whatnot. So what I'm basically looking for is something to move the sprite without affecting the rest of attributes 0 and 1, which is what this seems to be doing.
<br/>
<br/>
Thanks in advance for the advice and for putting up with my unfamiliarity with how the DS works (I did get quite used to the GBA though - must just be that I'm using code I'm unfamiliar with).[/code]</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#108444 - Cearn - Wed Nov 08, 2006 9:41 pm</h4>
    <div class="postbody"><span class="postbody">Remove the calls to the update functions from moveSprite(), they do not belong there. moveSprite() should only set the x/y fields of spriteEntry, that's all; wait with updating from the object buffer to OAM (and/or OAM_SUB) until you're done with all the work in the buffer.
<br/>
<br/>
The problem you have is that spriteEntry can be any one of the objects in the buffer, but updateOAM() copies 128 objects to OAM from an object array <span style="font-style: italic">starting</span> at its arguments address. If, say, spriteEntry is the 8th object, then you copy buffered objects 8-136 to OAM objects 0-128 and the combination of 128 copies and the offset is destroying every object in OAM.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
