<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Making FSCR images on OSX? - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>DS development > Making FSCR images on OSX?</h2>
<div id="posts">
<div class="post">
    <h4>#152575 - SiW - Mon Mar 17, 2008 10:00 pm</h4>
    <div class="postbody"><span class="postbody">I'm having the hardest time figuring out how to build FSCR disk image in OSX.  I've tried modifying davr's build.sh script, substituting newfs_msdos for the mkfs.vfat command, but OSX's mount doesn't accept the -o loop parameter.  I think I can use hdiutil to create images but I don't know how to create a FAT12 image that way.
<br/>
<br/>
Any ideas?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#152579 - SiW - Mon Mar 17, 2008 11:17 pm</h4>
    <div class="postbody"><span class="postbody">FWIW, the closest I got was this:
<br/>
<br/>
hdiutil create -srcfolder "<span style="font-style: italic">source files directory</span>" -fs MS-DOS -fsargs "-F 12" -ov <span style="font-style: italic">output image</span>
<br/>
<br/>
<br/>
but it creates a .dmg image which then fails to work when I link it with my .nds file.  Shame, because otherwise this would be a nice single-line command to do it all!
<br/>
<br/>
Until I can figure an alternative I guess I'll just run the Windows files in a virtual machine :|
<br/>
<br/>
(Edited for formatting)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#152594 - sonny_jim - Tue Mar 18, 2008 1:29 am</h4>
    <div class="postbody"><span class="postbody">Have you tried GPF's one?
<br/>
<a href="http://gpf.dcemu.co.uk/files/pc/fcsrimage.zip" target="_blank">http://gpf.dcemu.co.uk/files/pc/fcsrimage.zip</a>
<br/>
<br/>
It has the source for the tools used included so you should be able to recompile them for OSX.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#152612 - SiW - Tue Mar 18, 2008 5:23 am</h4>
    <div class="postbody"><span class="postbody">Unfortunately the source for bfi.exe isn't available, that's the piece of GPF's chain (which is great and I use it under Windows) that is needed to copy the files to the disk image.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#152716 - josath - Thu Mar 20, 2008 12:28 am</h4>
    <div class="postbody"><span class="postbody">Maybe the linux script can be modified to work on OS X? GPF's zip includes a build.sh written by me, linux is great in that you don't need any external apps to build a FAT image.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#152723 - SiW - Thu Mar 20, 2008 2:11 am</h4>
    <div class="postbody"><span class="postbody">Well like my OP says, I did try working from your build.sh script first before checking out GPF's Windows collection of tools.
<br/>
<br/>
I feel like the OSX solution is close, but tantalizingly out of reach.. hopefully somebody can come up with the missing link.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#152987 - Jevin - Sun Mar 23, 2008 9:10 pm</h4>
    <div class="postbody"><span class="postbody">Uhh... I did this about a year ago though I'm fuzzy on the details. I know I got a working image created from <a href="http://search.cpan.org/~hio/IO-DiskImage-Floppy-0.01/bin/fdimage.pl" target="_blank">http://search.cpan.org/~hio/IO-DiskImage-Floppy-0.01/bin/fdimage.pl</a> but I remember there being some limitation. I think the limitation was that it would only make a 1.44MB image, not up to 32MB like FAT12 can do. I remember trying to use hdiutil without much luck. I'll take a look at my IRC logs and Makefiles when I get back to my other machine to see how far I got.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#152989 - SiW - Sun Mar 23, 2008 9:35 pm</h4>
    <div class="postbody"><span class="postbody">Well the "directories are not implemented yet" limitation makes it useless for my needs, but thanks for this, it will come in handy.  If my Perl was any good I'd try and implement directories myself, but I run away screaming from any Perl project longer than 10 lines ;)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#153634 - TypeError - Thu Apr 03, 2008 7:56 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>SiW wrote:</b></span></td> </tr> <tr> <td class="quote">FWIW, the closest I got was this:
<br/>
<br/>
hdiutil create -srcfolder "<span style="font-style: italic">source files directory</span>" -fs MS-DOS -fsargs "-F 12" -ov <span style="font-style: italic">output image</span>
<br/>
<br/>
but it creates a .dmg image which then fails to work when I link it with my .nds file.  Shame, because otherwise this would be a nice single-line command to do it all!
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
As I understood the linux script you need to reserve an extra 64k in the disk image, so that's one problem.  I wrote a (Leopard only, barely) script that *might* work, but I haven't actually *seen* it work yet. :-)  My approach is to mount the disk image and then just copy the raw data from the /dev/diskXs1 device file, which I think should be the stuff we want.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#!/bin/zsh -e
<br/>
# build.sh output.img sourcedatadir
<br/>
# 
<br/>
# Builds a FAT disk image from a given directory.
<br/>
<br/>
if [ $# -lt 2 ]; then
<br/>
    echo "Usage: $0 file.img src-dir"
<br/>
    echo "  Create a FAT disk image from a directory."
<br/>
    exit 1
<br/>
fi
<br/>
<br/>
# calculate size of image needed
<br/>
#SIZE=`du "$2"|cut -f1|tail -n1`
<br/>
SIZE=`du -k $2 | cut -f1 | tail -n1`
<br/>
<br/>
# add 64KB for an overlay
<br/>
SIZE=`expr $SIZE + 64`
<br/>
<br/>
# create empty file
<br/>
echo Creating image with size $SIZE
<br/>
<br/>
# On mac we have to build a dmg and then pull out the FS...
<br/>
hdiutil create -ov -size ${SIZE}k -srcfolder $2 -fs MS-DOS -fsargs '-F 12' $1.dmg
<br/>
hdiutil attach -plist -nomount $1.dmg &gt; $1.plist
<br/>
dvice=`/usr/libexec/PlistBuddy -c 'Print :system-entities:0:dev-entry' $1.plist`
<br/>
# The entries in the system-entities array seem to be randomly ordered, so 
<br/>
# sometimes we get the disk entry (/dev/diskX) and sometimes we get the 
<br/>
# partition entry (/dev/diskXs1).  We want the partition entry.
<br/>
case $dvice in
<br/>
    *s1) ;;
<br/>
    *)  dvice=${dvice}s1 ;;
<br/>
esac
<br/>
echo Attached as partition: $dvice
<br/>
dd if=$dvice of=$1
<br/>
hdiutil detach $dvice
<br/>
rm -f $1.dmg
<br/>
rm -f $1.plist
<br/>
<br/>
echo "$SIZE KB FAT image built as $1 from $2\n"
<br/>
file "$1"
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
It prints a mount error message that is safe to ignore.  Assuming this works you'll still need to "bless" the image with the fcsr patcher.  Let me know if it works for you!</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
