<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Reading in touch coordinates by myself - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > Reading in touch coordinates by myself</h2>
<div id="posts">
<div class="post">
    <h4>#173195 - sylvestersteele - Fri Mar 26, 2010 5:35 am</h4>
    <div class="postbody"><span class="postbody">Hi,
<br/>
<br/>
I want to read in the touch coordinates by myself instead of using the libnds API. 
<br/>
<br/>
I looked up how libnds does it- and pretty much copy pasted that code into my main function. Unfortunately it doesn't work. Following is the code- any help would be appreciated.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
<br/>
#define    REG_SPICNT   (*(vuint16*)0x040001C0)
<br/>
#define    SPI_ENABLE   BIT(15)
<br/>
#define    SPI_BAUD_2MHz   1
<br/>
#define    SPI_DEVICE_TOUCH   (2 &lt;&lt; 8)
<br/>
#define    SPI_CONTINUOUS   BIT(11)
<br/>
#define    REG_SPIDATA   (*(vuint16*)0x040001C2)
<br/>
#define    TSC_MEASURE_X   0xD0
<br/>
#define    SPI_BUSY   BIT(7)
<br/>
<br/>
void SerialWaitBusy(){
<br/>
     
<br/>
       while (REG_SPICNT &amp; SPI_BUSY)
<br/>
         printf ("\nWaiting...");
<br/>
                swiDelay(1);
<br/>
<br/>
}
<br/>
<br/>
<br/>
<br/>
   uint32 oldIME;
<br/>
uint16 result, result2;
<br/>
int ctr=0;
<br/>
 consoleDemoInit();
<br/>
   printf("      Hello DS dev'rs\n");
<br/>
   printf("     \x1b[32mwww.devkitpro.org\n");
<br/>
   printf("   \x1b[32;1mwww.drunkencoders.com\x1b[39m");
<br/>
    
<br/>
<br/>
   while(1) {
<br/>
<br/>
    oldIME = REG_IME;
<br/>
   REG_IME = 0;
<br/>
   SerialWaitBusy();
<br/>
<br/>
   // Write the command and wait for it to complete
<br/>
   REG_SPICNT = SPI_ENABLE | SPI_BAUD_2MHz |  SPI_DEVICE_TOUCH | SPI_CONTINUOUS; //0x8A01;
<br/>
   REG_SPIDATA = TSC_MEASURE_X;
<br/>
   SerialWaitBusy(); 
<br/>
<br/>
   
<br/>
   REG_SPIDATA = 0;
<br/>
   SerialWaitBusy();
<br/>
   result = REG_SPIDATA;
<br/>
<br/>
   
<br/>
   REG_SPICNT = SPI_ENABLE | 0x201;
<br/>
   REG_SPIDATA = 0;
<br/>
   SerialWaitBusy();
<br/>
<br/>
   result2 = REG_SPIDATA &gt;&gt;3;
<br/>
<br/>
   REG_IME = oldIME;
<br/>
<br/>
<br/>
      printf ("\nPosition: %d", (((result &amp; 0x7F) &lt;&lt; 5) | result2));
<br/>
   
<br/>
   
<br/>
      swiWaitForVBlank(); 
<br/>
   }
<br/>
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I took that from the arm7/touch.c uint16 touchRead(uint32 command)  function. <span style="font-weight: bold">The program runs but...</span>
<br/>
<br/>
1- I noticed that if I printf the busy bit immediately after the REG_SPICNT = SPI_ENABLE | SPI_BAUD_2MHz |  SPI_DEVICE_TOUCH | SPI_CONTINUOUS; //0x8A01; EG_SPIDATA = TSC_MEASURE_X; statements it is never set to busy.
<br/>
<br/>
2- Even when I touch the screen it does not return the touched coordinates.
<br/>
<br/>
Thanks,
<br/>
Sylvester[/code]</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#173196 - sylvestersteele - Fri Mar 26, 2010 5:44 am</h4>
    <div class="postbody"><span class="postbody"><span style="font-weight: bold">Correction</span>
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">int main(){
<br/>
<br/>
   uint32 oldIME;
<br/>
uint16 result, result2;
<br/>
.
<br/>
.
<br/>
.
<br/>
.
<br/>
<br/>
}</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#173200 - wintermute - Fri Mar 26, 2010 10:27 am</h4>
    <div class="postbody"><span class="postbody">devkitPro is a vendor, not a library, I corrected your post accordingly.
<br/>
<br/>
The touch screen is only accessible from arm7 code, you can't read it directly from the arm9.<br/>_________________<br/><a class="postlink" href="http://www.devkitpro.org/" target="_blank">devkitPro - professional toolchains at amateur prices</a>
<br/>
<a class="postlink" href="http://wiki.devkitpro.org/index.php/IRC" target="_blank">devkitPro IRC support</a>
<br/>
<a class="postlink" href="http://davejmurphy.com/" target="_blank">Personal Blog</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#173202 - vuurrobin - Fri Mar 26, 2010 10:30 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>sylvestersteele wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
I want to read in the touch coordinates by myself instead of using the libnds API. </td> </tr></table><span class="postbody">
<br/>
<br/>
why do you want to do that?<br/>_________________<br/>my blog:
<br/>
<a href="http://vuurrobin.100webcustomers.com/" target="_blank">http://vuurrobin.100webcustomers.com/</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#173204 - sylvestersteele - Fri Mar 26, 2010 4:49 pm</h4>
    <div class="postbody"><span class="postbody">So- the code runs by default on arm9- but I now need to get it to run on the arm7. How do I do that?
<br/>
<br/>
<br/>
Also- Does only the arm9 have access to the screen? If so then I need to run the display code on arm9 and the touch screen reading code on arm7. How do I do that?
<br/>
<br/>
Thanks,
<br/>
Sylvester</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#173208 - elhobbs - Fri Mar 26, 2010 6:46 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>sylvestersteele wrote:</b></span></td> </tr> <tr> <td class="quote">Also- Does only the arm9 have access to the screen? If so then I need to run the display code on arm9 and the touch screen reading code on arm7. How do I do that?
<br/>
<br/>
Thanks,
<br/>
Sylvester</td> </tr></table><span class="postbody">if you have to ask the question then you are better off using libnds.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#173211 - fincs - Fri Mar 26, 2010 9:52 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>sylvestersteele wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
I want to read in the touch coordinates by myself instead of using the libnds API. 
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
What's so wrong with libnds that several people want to reimplement the wheel?</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
