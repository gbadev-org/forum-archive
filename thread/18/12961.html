<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>delay between 3D and 2D hardware - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > delay between 3D and 2D hardware</h2>
<div id="posts">
<div class="post">
    <h4>#125202 - RavenWorks - Thu Apr 12, 2007 2:05 am</h4>
    <div class="postbody"><span class="postbody">I'm currently working on a 2D game, that renders some elements on quads using the 3D hardware. I'm finding there's a one-frame delay between the graphics done on the 2D hardware and those done on the 3D hardware, but before you answer, I'm already buffering all the 2D elements until the next vblank (so they'll go through at the same time as the 3D instructions do).
<br/>
<br/>
I've got a little pseudocode writeup of the way I'm doing things here: <a href="http://img.ravenworks.ca/3D2D.txt" target="_blank">http://img.ravenworks.ca/3D2D.txt</a>
<br/>
There's also a table that outlines what SHOULD be happening based on my understanding of these things, but the 3D still seems to be one frame behind.
<br/>
<br/>
Any ideas?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#125261 - masscat - Thu Apr 12, 2007 12:47 pm</h4>
    <div class="postbody"><span class="postbody"><span style="font-weight: bold">EDIT:</span> ignore this post as it is not correct :)
<br/>
<br/>
The 3D buffer swap command does not take affect until the following Vblank (see <a class="postlink" href="http://nocash.emubase.de/gbatek.htm#ds3ddisplaycontrol" target="_blank">gbatek</a>).
<br/>
This leads to the following using your current program flow, hence the one frame delay:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">                |--------|--------|----------|------------|
<br/>
                | 2D RAM | 2D OAM | 3D queue | 3D display | 
<br/>
--------|-------|--------|--------|----------|------------|
<br/>
        | START |   --   |   --   |    --    |     --     |
<br/>
FRAME 1 |-------|--------|--------|----------|------------|
<br/>
        |  END  |    1   |   --   |     1    |     --     |
<br/>
--------|-------|--------|--------|----------|------------|
<br/>
--------|-------|--------|--------|----------|------------|
<br/>
        | START |    1   |    1   |     1    |     --     |
<br/>
FRAME 2 |-------|--------|--------|----------|------------|
<br/>
        |  END  |    2   |    1   |     2    |     --     |
<br/>
--------|-------|--------|--------|----------|------------|
<br/>
--------|-------|--------|--------|----------|------------|
<br/>
        | START |    2   |    2   |     2    |      1     |
<br/>
FRAME 3 |-------|--------|--------|----------|------------|
<br/>
        |  END  |    3   |    2   |     3    |      1     |
<br/>
--------|-------|--------|--------|----------|------------|
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
So the control of your program should be something like:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">Some time before vblank:
<br/>
{
<br/>
  Do game logic.
<br/>
  Update 2D RAM.
<br/>
  Issue 3D commands and swap command.
<br/>
}
<br/>
<br/>
Vblank:
<br/>
{
<br/>
  (hardware prepares to display 3D commands issued)
<br/>
  Copy 2D RAM to OAM
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
The importance difference is that on entering Vblank the 3D already has the display for the next frame.
<br/>
If you want to trigger off of vblank you could do something like:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">Vblank:
<br/>
{
<br/>
  copy 2D ram[oldest] to OAM.
<br/>
  2D ram[oldest] = 2D ram[old].
<br/>
  do game logic.
<br/>
  issue 3D commands and swap.
<br/>
  update 2D ram[old].
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
But this would lead to a one frame delay from user input to screen update.</span><span class="gensmall"><br/><br/>Last edited by masscat on Thu Apr 12, 2007 6:11 pm; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#125262 - RavenWorks - Thu Apr 12, 2007 1:00 pm</h4>
    <div class="postbody"><span class="postbody">Do you mean, the 3D refuses to start rendering until a vblank, but it ALSO takes a full vblank interval to *finish* rendering? (I assumed the rendering finished between the vblank interrupt and the drawing of the first scanline..)
<br/>
<br/>
I still don't understand the difference between my example and your first example... the "some time before vblank" for me is the end of the previous vblank function call.
<br/>
<br/>
Thanks! :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#125325 - masscat - Thu Apr 12, 2007 5:52 pm</h4>
    <div class="postbody"><span class="postbody">Apologies, I buggered up my timings. And the two versions are the same.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#125330 - RavenWorks - Thu Apr 12, 2007 6:06 pm</h4>
    <div class="postbody"><span class="postbody">OK, so, that means that there's still no-one who can explain this delay, then ;)
<br/>
<br/>
This means either I'm imagining it, or I'm deviating from my plan in some way I haven't noticed, or just no-one *else* has noticed it yet? (I'm beginning to wonder if it's even worth worrying about..)
<br/>
<br/>
I think I'm going to make a really simple example with one shape occluding another, to prove whether or not this delay exists, then post the source..</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#125342 - DekuTree64 - Thu Apr 12, 2007 6:50 pm</h4>
    <div class="postbody"><span class="postbody">The swap command will only be processed at the moment of VBlank starting, so if you wait until you're already into the VBlank interrupt handler, it's too late.
<br/>
<br/>
Getting 100% guaranteed synchronization (such as for 2 screen 3D) is really tricky, because there's a small period of time just before VBlank starts where all bets are off.<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#125346 - RavenWorks - Thu Apr 12, 2007 6:55 pm</h4>
    <div class="postbody"><span class="postbody">I know it's too late if I wait until I'm in the handler -- that's why I delay all my 2D graphics until the next frame also. The thing to note about my program is that (other than copying the last frame's 2D buffer to live 2D OAM), the vblank is basically just my cue that it's alright to start preparing for the NEXT frame, not that frame. Unless you think that my vblank-triggered game logic is taking so long that I wind up past scanline 185 by the time it's done? (which is a possibility, honestly..)
<br/>
<br/>
<span style="font-weight: bold">edit:</span> maybe I should clarify, I want to know why there's STILL a delay, <span style="font-style: italic">even though</span> I'm already delaying my 2D until the next vblank trigger to line up with the 3D update..</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#125360 - DekuTree64 - Thu Apr 12, 2007 7:56 pm</h4>
    <div class="postbody"><span class="postbody">Wait, so you're doing your entire game logic in the VBlank handler? That can cause weirdness if it runs over, or total destruction if you have nested interrupts enabled. Generally you want your game loop to still function properly regardless of how long it takes to run (for example, loading a level can take a long time and still be considered one game loop).
<br/>
<br/>
I generally go with the style of  do game logic -&gt; set flag -&gt; wait for VBlank. Then the VBlank handler checks the flag to decide if it should update the display. That way VBlank interrupts will still be firing off in the meantime to take care of any other processing that needs to be done, but the video is still synchronized to the game loop.<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#125364 - RavenWorks - Thu Apr 12, 2007 8:51 pm</h4>
    <div class="postbody"><span class="postbody">Well, what I'm actually doing is, the vblank sets a flag for the main{while(1){ }} to catch, and the while(1) is where the logic actually gets executed. But it happens immediately after the (very short) vblank handler, so I just left it there in the pseudocode for simplicity's sake ;P So, yeah, that wasn't quite accurate, but in fact I *used* to do it like that (before I realised it would mess up my other interrupts), and I still had this problem.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#125680 - RavenWorks - Mon Apr 16, 2007 12:20 am</h4>
    <div class="postbody"><span class="postbody">*awkward cough*
<br/>
<br/>
So, umm...
<br/>
<br/>
after a bit of testing, I've realised it was a logic problem. XP
<br/>
<br/>
Sorry to have wasted everyone's time ^^;; Thanks anyway.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
