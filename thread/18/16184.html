<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>read from ds cart using cardPolledTransfer - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>DS development > read from ds cart using cardPolledTransfer</h2>
<div id="posts">
<div class="post">
    <h4>#164412 - pilch - Fri Oct 31, 2008 12:04 am</h4>
    <div class="postbody"><span class="postbody">Hi everyone,
<br/>
<br/>
I know this subject has already been discussed a lot, but I still don't understand some things...
<br/>
<br/>
I tried to read 512 bytes from ds cart using cardPolledTransfer but it didn't work on my DS (though it works on no$gba) : first 4 bytes are 0xfffffc00, followed by 127 0xffffffff.
<br/>
<br/>
I figure it has something to do with encryption (but perhaps I just did an error in my code ?), so I would like to understand how encryption works once for all...
<br/>
<br/>
1) after the boot sequence, transfers use only key2 encryption, which is transparent. So why can't my code read the ds cart ?
<br/>
<br/>
2) is the boot sequence the same for homebrew and released games ? if no, why ?
<br/>
<br/>
thanks for help !
<br/>
<br/>
ps : I know I *should* use LibFat or any other lib, but I would like to understand why my code doesn't work
<br/>
<br/>
<br/>
EDIT :
<br/>
<br/>
I though my code was good since it worked with no$gba, but I forgot CARD_ENCRYPTED and CARD_13 flags.
<br/>
Now I get random values (change each time I start the program), which is still bad...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#164420 - thoduv - Fri Oct 31, 2008 5:10 pm</h4>
    <div class="postbody"><span class="postbody">Are you sure your slot-1 hardware is exposing your ROM data on ds card when running homebrew program ? It could be for instance the card's "firmware"...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#164425 - Funky Gibbon - Fri Oct 31, 2008 11:13 pm</h4>
    <div class="postbody"><span class="postbody">I thought the first 512 byte were not encripted anyway, it's just header data</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#164441 - pilch - Sat Nov 01, 2008 5:52 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>thoduv wrote:</b></span></td> </tr> <tr> <td class="quote">Are you sure your slot-1 hardware is exposing your ROM data on ds card when running homebrew program ? It could be for instance the card's "firmware"...</td> </tr></table><span class="postbody">
<br/>
<br/>
I don't know...
<br/>
But it is possible to run released games (that is why Nintendo don't like these cards, no?), so at least when one releasedGame.nds is run from this card, it can access its ROM data (and not other card data).
<br/>
<br/>
If I don't access ROM data, it would mean that homebrew games are not run the same way than released ones, no ? (hence my 2nd question).
<br/>
<br/>
I read at differents locations (from 0xd200, step of 512 bytes), and before adding CARD_ENCRYPTED and CARD_13 flags, I always get the same data. It would be *strange* to find 0xfffffc00ffffffffffffffffffffffffffffffff.... patterns in the card, repeated every 512 bytes...
<br/>
<br/>
Maybe after adding this 2 flags I still read the same pattern, but it is modified by something related to key2 encryption ?
<br/>
<br/>
<br/>
Does anyone managed to read from cart using libnds function ??</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#164442 - pilch - Sat Nov 01, 2008 5:57 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Funky Gibbon wrote:</b></span></td> </tr> <tr> <td class="quote">I thought the first 512 byte were not encripted anyway, it's just header data</td> </tr></table><span class="postbody">
<br/>
<br/>
perhaps, but I can't get the header that way :
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">B7aaaaaaaa000000h (200h) - Get Data
<br/>
KEY2 encrypted command. The desired ROM address is specifed, MSB first, in parameter bytes (a). <span style="font-weight: bold">Can be used only for addresses 8000h and up, smaller addresses will be silently redirected to address "8000h+(addr AND 1FFh)"</span>. There is no alignment restriction for the address. However, the datastream wraps to the begin of the current 4K block when address+length crosses a 4K boundary (1000h bytes). Returned data is KEY2 encrypted.
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#164454 - yellowstar - Sun Nov 02, 2008 7:27 pm</h4>
    <div class="postbody"><span class="postbody">Try the code from the eeprom example.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>card.h wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
// These commands require the cart to not be initialized yet, which may mean the user
<br/>
// needs to eject and reinsert the cart or they will return random data.
<br/>
void cardRead00(uint32 address, uint32 * destination, uint32 length, uint32 flags);
<br/>
void cardReadHeader(uint8 * header);
<br/>
int cardReadID(uint32 flags);
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>eeprom example's main.cpp wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
//---------------------------------------------------------------------------------
<br/>
int main(void) {
<br/>
//---------------------------------------------------------------------------------
<br/>
   irqInit();
<br/>
   irqSet(IRQ_VBLANK, 0);
<br/>
   irqEnable(IRQ_VBLANK);
<br/>
<br/>
   consoleDemoInit();
<br/>
<br/>
   iprintf("Reading cart info...\n");
<br/>
<br/>
   static u8 header1[512];
<br/>
   static u8 header2[512];
<br/>
<br/>
   sysSetBusOwners(true, true); // give ARM9 access to the cart
<br/>
<br/>
   while(1) {
<br/>
      // Read the header twice to verify.
<br/>
      // If the card is being encrypted, we will get random junk
<br/>
      cardReadHeader(header1);
<br/>
      cardReadHeader(header2);
<br/>
<br/>
      // Make sure we got the same data twice
<br/>
      while(memcmp(header1, header2, 32) != 0) {
<br/>
         // If not, the card needs ejected and reinserted into the DS
<br/>
         iprintf("Please eject &amp; reinsert DS card.\n");
<br/>
         pause();
<br/>
         cardReadHeader(header1);
<br/>
         cardReadHeader(header2);
<br/>
      }
<br/>
<br/>
                ...
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
</span></td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#164505 - pilch - Tue Nov 04, 2008 8:27 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>yellowstar wrote:</b></span></td> </tr> <tr> <td class="quote">Try the code from the eeprom example.
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
My goal is not to read the header nor the chip ID... I don't use the 3 commands that require an uninitialized cart, but 0xb7 key2-encrypted command.
<br/>
<br/>
Anyway, I copied and past this code, and it doesn't work on my ds : I get infinit 0xfffffffff when I try to read the headers... did you try it on your ds ?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#164510 - Cydrak - Tue Nov 04, 2008 9:54 pm</h4>
    <div class="postbody"><span class="postbody">These flashcards tend to require a patcher, right? Since it's loading off flash or microSD or something, there's no guarantee the media can satisfy Nintendo's timing requirements. Also they would have to do encryption all the time, and map the ROM access onto the right flash sectors. Getting consistent data (with encryption off) suggests they didn't do that. Probably instead, they patch commercial games to use some other method--for example, talking to the card over slot-1's serial bus. (Bear in mind I don't have one, I'm just speculating.)
<br/>
<br/>
In that case, Nintendo's commands aren't gonna work.
<br/>
<br/>
Homebrew is actually quite similar. You have to use the card's interface--and unless you want to reverse engineer every card out there, it's far easier to use libfat, and let the users patch in the proper DLDI themselves. Once properly set up, C/C++ file i/o works as you would expect.
<br/>
<br/>
Also see Noda's <a class="postlink" href="http://forum.gbadev.org/viewtopic.php?t=15726" target="_blank">EFS library</a> which lets you read data packed inside the NDS file. It works with emulators, DLDI and ROM-based cards, and acts pretty much like libfat now. AFAIK, this is the same filesystem Nintendo uses, so it's about as close to "official" methods as you can get, if that's what you want...
<br/>
<br/>
A final note: some people (like me) still use FlashMe with a Supercard, so your program would find slot-1 mysteriously empty. :-) In fact, you could be running entirely in RAM, with nothing in either slot at all. (This isn't so common now, but can be done through DS Download Play on an original/FlashMe'd DS, or potentially through some other loader. I do my testing that way all the time.)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#164513 - pilch - Tue Nov 04, 2008 10:59 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Cydrak wrote:</b></span></td> </tr> <tr> <td class="quote">Probably instead, they patch commercial games to use some other method--for example, talking to the card over slot-1's serial bus. (Bear in mind I don't have one, I'm just speculating.)</td> </tr></table><span class="postbody">
<br/>
<br/>
mmhh... you may be right, but patching games is not "easy", no ? I mean, the patched functions must still have the same size (or it will break calling addresses) and *at least* some games don't use fixed flags to acces the cart (warhammer loads from memory a part of the value it writes to ROMCTRL, so how to patch such function ?? and without changing the code size ?)...
<br/>
<br/>
it seems difficult...
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Cydrak wrote:</b></span></td> </tr> <tr> <td class="quote">it's far easier to use libfat (...)</td> </tr></table><span class="postbody">
<br/>
<br/>
yes (and thanks for the links).
<br/>
it is more for curiosity in fact... I would like to understand why it doesn't work.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#164514 - pilch - Tue Nov 04, 2008 11:04 pm</h4>
    <div class="postbody"><span class="postbody">one more test :
<br/>
using the same code as previously to read headers (which didn't work with my flashcard), I ejected the card and replace it with Ace Attorney, Appollo Justice... and it reads its header properly !
<br/>
<br/>
what to think about that ? Is it impossible to use Nintendo's commands as suggested by Cydrak, or does the flashcard need to be initialized before it can *emulate* nds cart, or... ?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#164516 - Cydrak - Tue Nov 04, 2008 11:21 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>pilch wrote:</b></span></td> </tr> <tr> <td class="quote">mmhh... you may be right, but patching games is not "easy", no ?</td> </tr></table><span class="postbody">
<br/>
You'll have to ask them... It must be possible, though, since there are slot-2 cards, which couldn't possibly "emulate" Nintendo's commands then.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>pilch wrote:</b></span></td> </tr> <tr> <td class="quote">I mean, the patched functions must still have the same size</td> </tr></table><span class="postbody">
<br/>
As long as the patch is smaller (most likely hand-coded ASM instead of compiled), it's no problem.
<br/>
<br/>
If most games use the same library (along the lines of EFS) then this would turn out to be a little easier. Are you saying that's not true? Note, I'm not sure about this, but the header might have to be stored in RAM anyway, because it can't be read with encrypted reads. I believe one of the header values is supposed to be written to ROMCTRL as you say, so this doesn't sound game specific.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>pilch wrote:</b></span></td> </tr> <tr> <td class="quote">it is more for curiosity in fact... I would like to understand why it doesn't work.</td> </tr></table><span class="postbody">
<br/>
I guess for curiosity's sake, you could compare files and see what the card's patcher is doing. Or you could get ahold of the DLDI and disassemble that.
<br/>
<br/>
As to why it doesn't work, I don't know for sure, but my bet's on the card having a custom interface, or (at the very least) needing some proprietary initialization like you said.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#164519 - pilch - Wed Nov 05, 2008 12:51 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Cydrak wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
You'll have to ask them... It must be possible, though, since there are slot-2 cards, which couldn't possibly "emulate" Nintendo's commands then.
<br/>
</td> </tr></table><span class="postbody">
<br/>
very interresting ! are you sure this kind of device can run official NDS games ? (I guess you are, but it is just to be sure since it has, as you said, important implications)
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Cydrak wrote:</b></span></td> </tr> <tr> <td class="quote">As long as the patch is smaller (most likely hand-coded ASM instead of compiled), it's no problem. (...)</td> </tr></table><span class="postbody">
<br/>
yes you're right...
<br/>
<br/>
ok, so I will investigate to find if games are patched or not...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#164532 - pilch - Wed Nov 05, 2008 7:31 pm</h4>
    <div class="postbody"><span class="postbody">another test:
<br/>
<br/>
1) I take a binary dump of an official game, look for the sendCommand functions and change one : I always set command[0] to 0xb9 (only b7 and b8 are normaly expected) and it crashs (normal behaviour).
<br/>
<br/>
2) I change the code so that the function still does what it means to do, and it doesn't crash.
<br/>
<br/>
3) I change the code to crash if command[0] is &lt; aa, and it crashs only when aa is &lt;= 0xb8.
<br/>
I change the code to crash if command[0] is &gt;= bb, and it crashs only when bb is &gt;= 0xb7. 
<br/>
<br/>
4) I change the code so that it crashs if command[5,6 or7] != 0, and it doesn't crash.
<br/>
<br/>
<br/>
Conclusions :
<br/>
<br/>
experiments 1 and 2 show that <span style="font-weight: bold">the code is still called</span> (a patcher could change the address of the call), and that it can work or not when modified =&gt; <span style="font-weight: bold">it appears not to be patched</span>
<br/>
<br/>
experiments 3 and 4 show that <span style="font-weight: bold">the DS still sends "normal" commands</span> to the cart (a patcher could have changed the command == the argument passed to sendCommand function)
<br/>
<br/>
So, does the patch option still holds ?? it is not conclusive, but I really doubt that .nds is patched, don't you ?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#164534 - yellowstar - Wed Nov 05, 2008 9:54 pm</h4>
    <div class="postbody"><span class="postbody">Does booting your program, re-inserting your flash card, then reading the header, work?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#164536 - pilch - Wed Nov 05, 2008 11:15 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>yellowstar wrote:</b></span></td> </tr> <tr> <td class="quote">Does booting your program, re-inserting your flash card, then reading the header, work?</td> </tr></table><span class="postbody">
<br/>
<br/>
No (at least not my program header). I use a DS Linker, so I guess all I can expect this way is to read DS Linker program header (if any...)
<br/>
<br/>
But if I reinsert an official cart it reads its header.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#164554 - Cydrak - Fri Nov 07, 2008 2:43 am</h4>
    <div class="postbody"><span class="postbody">Interesting... it certainly is possible it isn't patched. Even so, the flashcard would still need to be initialized and "locked" somehow, so that the official games only see themselves. Which may or may not be done for homebrew, since that expects a different arrangement (namely DLDI, with access to the whole media).
<br/>
<br/>
Worth mention is that the old, slot-2 Supercards come with PC software that explicitly does the patching. I ran a comparison yesterday, and on the ARM7, about 2K of card routines were modified, as expected. The ARM9 binary had been decompressed (!) so it must've been changed too, although I couldn't compare directly because of that.
<br/>
<br/>
Good luck with your card, and don't lose too much sleep over it. :-)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#166654 - yellowstar - Fri Feb 13, 2009 2:31 am</h4>
    <div class="postbody"><span class="postbody">It appears that flash cards patch homebrew. When I tested reading my Acekard 2 header, all I got was all 0xFF bytes. However, when I booted my program with DSO, the header read perfectly.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#166658 - Normmatt - Fri Feb 13, 2009 5:31 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>yellowstar wrote:</b></span></td> </tr> <tr> <td class="quote">It appears that flash cards patch homebrew. When I tested reading my Acekard 2 header, all I got was all 0xFF bytes. However, when I booted my program with DSO, the header read perfectly.</td> </tr></table><span class="postbody">
<br/>
<br/>
No its just that flashcart firmwares don't init the hardware the same as DSO etc and as such some commands don't work on it straight from the firmware.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#166674 - yellowstar - Fri Feb 13, 2009 8:08 pm</h4>
    <div class="postbody"><span class="postbody">Never mind, when I tried dumping the header again, booting directly from the Ackekard, this time the header dumped fine... I disassembled cardPolledTransfer and cardStartTransfer from ram and hw, and compared the assembly with the disassembled cardPolledTransfer and cardStartTransfer under iDeas, and they were identical.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
