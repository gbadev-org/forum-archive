<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Can't draw to 8bit bg - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > Can't draw to 8bit bg</h2>
<div id="posts">
<div class="post">
    <h4>#94406 - Turambar - Mon Jul 24, 2006 7:47 pm</h4>
    <div class="postbody"><span class="postbody">I have a problem with 8 bit backgrounds. I'm trying to draw a red box with this code:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
int main(void) {
<br/>
   irqInit();
<br/>
<br/>
   irqEnable(IRQ_VBLANK);
<br/>
<br/>
   videoSetMode(MODE_5_2D | DISPLAY_BG3_ACTIVE); 
<br/>
   
<br/>
   vramSetMainBanks(   VRAM_A_MAIN_BG_0x6000000, VRAM_B_MAIN_BG_0x6020000, 
<br/>
                  VRAM_C_SUB_BG , VRAM_D_LCD); 
<br/>
<br/>
   BG3_CR = BG_BMP8_512x256;
<br/>
   
<br/>
   BG3_XDX = 1 &lt;&lt; 8;
<br/>
   BG3_XDY = 0;
<br/>
   BG3_YDX = 0;
<br/>
   BG3_YDY = 1 &lt;&lt; 8;
<br/>
   BG3_CX = 0;
<br/>
   BG3_CY = 0;
<br/>
<br/>
   u16* frontBuffer = (u16*)(0x06000000);
<br/>
   
<br/>
   BG_PALETTE[3] = 0x1F;
<br/>
   
<br/>
   //draw a box
<br/>
   for(int iy = 0; iy &lt; 50; iy++)
<br/>
      for(int ix = 0; ix &lt; 50; ix++) 
<br/>
         frontBuffer[iy * 512 + ix] = 3;
<br/>
   
<br/>
   while(1) {
<br/>
      swiWaitForVBlank();
<br/>
   }
<br/>
}</td> </tr></table><span class="postbody">
<br/>
But this doesn't draw the pixels together, since I'm using a u16* buffer, and the pixels are 8bit. Of course I tried changing frontBuffer to a u8*, but then it draws nothing...
<br/>
What's the problem?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#94424 - Lazy1 - Mon Jul 24, 2006 8:28 pm</h4>
    <div class="postbody"><span class="postbody">You have to write 2 pixels at a time in 8bit mode...
<br/>
<br/>
2pixels = ( pixel #1 &lt;&lt; 8 ) | pixel #2</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#94618 - silent_code - Tue Jul 25, 2006 2:56 pm</h4>
    <div class="postbody"><span class="postbody">if you want to draw one pixel, this code works for me:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
((uint16*)SCREEN_BASE_BLOCK(0))[pixel] &amp;= even ? 0xFF00 : 0x00FF; // clear the pixel first or you won't get the right color!
<br/>
<br/>
((uint16*)SCREEN_BASE_BLOCK(0))[pixel] |= even ? color : color &lt;&lt; 8;
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
happy coding ;)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#94738 - Turambar - Wed Jul 26, 2006 12:18 am</h4>
    <div class="postbody"><span class="postbody">Thanks! I was beginning to think I would have to read the adjacent pixel every time I wanted to write one.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#94751 - Cearn - Wed Jul 26, 2006 1:10 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>silent_code wrote:</b></span></td> </tr> <tr> <td class="quote">if you want to draw one pixel, this code works for me:
<br/>
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
((uint16*)SCREEN_BASE_BLOCK(0))[pixel] &amp;= even ? 0xFF00 : 0x00FF; // clear the pixel first or you won't get the right color!
<br/>
<br/>
((uint16*)SCREEN_BASE_BLOCK(0))[pixel] |= even ? color : color &lt;&lt; 8;
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
happy coding ;)</span></td> </tr></table><span class="postbody">
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Turambar wrote:</b></span></td> </tr> <tr> <td class="quote">Thanks! I was beginning to think I would have to read the adjacent pixel every time I wanted to write one.</td> </tr></table><span class="postbody">
<br/>
That code <span style="font-style: italic">is</span> reading the adjacent pixel. Twice (probably). Remember, &amp;= and |= mean reading the thing too.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#94752 - tepples - Wed Jul 26, 2006 1:11 am</h4>
    <div class="postbody"><span class="postbody">In 8-bit extended rotation backgrounds on both the GBA and DS, read-modify-write is the usual operation for writing a single pixel, but you can write a group of two or four at a time. This means horizontal lines (such as in the middle of a rectangle fill, circle fill, polygon fill, or flood fill) are still fast to draw.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#94894 - silent_code - Wed Jul 26, 2006 7:36 pm</h4>
    <div class="postbody"><span class="postbody">well, there is no other way if you want to write single pixels. but this code works for me and i'm drawing like 2k particles (or even more - with some having three to six or more pixels per particle). ;)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#94901 - DekuTree64 - Wed Jul 26, 2006 8:04 pm</h4>
    <div class="postbody"><span class="postbody">On DS, you can write single pixels by turning on the cache for VRAM. AFAIK there are no libnds functions for fiddling with protection region settings, but if you don't mind a bit of assembly, it can be done.<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#94914 - Mighty Max - Wed Jul 26, 2006 9:05 pm</h4>
    <div class="postbody"><span class="postbody">There is a problem with that.
<br/>
<br/>
The VRAM falls into the HW-Registers region (0) and you don't want to have those cached. You'll have to find a region you can drop or merge with another one in order to cache the VRAM.
<br/>
<br/>
You could merge the wram and its mirror, this has the negative, that caching the region the IPC struct is within isnt recommented, and having this combined region uncached slowes down every access to wram.
<br/>
<br/>
:edit: however that enabled my exec_stub now long filenames &amp; such without the need to do this in _slower_ arm7 code (which has native 8bit access to vram) *g* Thanks for the hint<br/>_________________<br/><a class="postlink" href="http://mightymax.org/gbamp_multiboot.html" target="_blank">GBAMP Multiboot</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#94917 - DekuTree64 - Wed Jul 26, 2006 9:28 pm</h4>
    <div class="postbody"><span class="postbody">You could combine IO regs and uncached main RAM by making a giant region that covers the entire memory space. Sort of a catch-all region that has uncached read/write/execute access. The regions have priority, so if 2 overlap, the higher numbered region will be used. So if you use 0 for the catch-all, the rest will still work as before.
<br/>
<br/>
Actually, the only difference between the settings for IO regs, GBA slot, ITCM, DTCM, and uncached main RAM are the read/write/execute settings. Unless you're writing an operating system or something where you actually plan to recover from exceptions, those don't do a whole lot of good anyway.<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#94922 - Mighty Max - Wed Jul 26, 2006 9:55 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>DekuTree64 wrote:</b></span></td> </tr> <tr> <td class="quote">The regions have priority, so if 2 overlap, the higher numbered region will be used. So if you use 0 for the catch-all, the rest will still work as before.
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Just a small correction: the smaller the region the higher its priority. The number is irrelevant for different sized regions.
<br/>
<br/>
Ontop of that, with the current possibility to catch accesses to regions that are not good to access (i.e. NULL pointer references) it might not be wise to disable this feature by a "allow all".<br/>_________________<br/><a class="postlink" href="http://mightymax.org/gbamp_multiboot.html" target="_blank">GBAMP Multiboot</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#94945 - DekuTree64 - Wed Jul 26, 2006 11:41 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Mighty Max wrote:</b></span></td> </tr> <tr> <td class="quote">Just a small correction: the smaller the region the higher its priority. The number is irrelevant for different sized regions.</td> </tr></table><span class="postbody">
<br/>
Where did you read that? The ARM ARM says it's based on region number:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>ARM ARM wrote:</b></span></td> </tr> <tr> <td class="quote">Protection regions can legitimately overlap eachother. If an address lies within more than one protection region, the attributes of the highest-numbered protection region apply to it.</td> </tr></table><span class="postbody">
<br/>
<br/>
For your other comment, I agree null accesses are common enough that they should be trapped. Another place you could maybe snatch a region would be to combine cached main RAM and IWRAM, covering the range from 0x2000000 through 0x3ffffff.
<br/>
<br/>
Either that or leave IWRAM without a region at all, since it's usually more useful to allocate it to ARM7 anyway, so it has more work space without causing conflicts over main RAM. And if you do want it cached, just allocate the user region to it.<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#94997 - Mighty Max - Thu Jul 27, 2006 8:06 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>DekuTree64 wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Mighty Max wrote:</b></span></td> </tr> <tr> <td class="quote">Just a small correction: the smaller the region the higher its priority. The number is irrelevant for different sized regions.</td> </tr></table><span class="postbody">
<br/>
Where did you read that? The ARM ARM says it's based on region number:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>ARM ARM wrote:</b></span></td> </tr> <tr> <td class="quote">Protection regions can legitimately overlap eachother. If an address lies within more than one protection region, the attributes of the highest-numbered protection region apply to it.</td> </tr></table><span class="postbody">
<br/>
</span></td> </tr></table><span class="postbody">
<br/>
<br/>
Hmm indeed, memory was serving me wrong then. sorry<br/>_________________<br/><a class="postlink" href="http://mightymax.org/gbamp_multiboot.html" target="_blank">GBAMP Multiboot</a></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
