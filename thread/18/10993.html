<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>code causes freezing of emulator/DS [Renamed] - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > code causes freezing of emulator/DS [Renamed]</h2>
<div id="posts">
<div class="post">
    <h4>#100734 - pkwong - Wed Aug 30, 2006 4:50 am</h4>
    <div class="postbody"><span class="postbody">i'm using a linked list to store key effects and remove them when the keyup. but for a weird reason, when i press the 8th button(either 8), both the emulator and DS freezes.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
//add
<br/>
for (int i=0; i&lt;8; i++){
<br/>
  if (pressed &amp; keys[i]){
<br/>
    keyEffects.push_back(new keyEffect(i));
<br/>
  }
<br/>
}
<br/>
<br/>
//remove
<br/>
for (int i=0; i&lt;8; i++){
<br/>
  if (released &amp; keys[i]){
<br/>
    list&lt;keyEffect* &gt;::iterator It=keyEffects.begin();
<br/>
    for (;It!=keyEffects.end() &amp;&amp; (*It)-&gt;getChannel()!=i; It++);
<br/>
    delete *It;
<br/>
    keyEffects.erase(It);
<br/>
  }
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
i thought it was the class's problem
<br/>
however, when i put around 10 lines of "new anotherClass();" at my init(),
<br/>
it also freezes.
<br/>
<br/>
am i using too much RAM so that it hangs...?
<br/>
my program is so small now that it had only 2 class, and that just hold a few "short" which shouldn't take up too much mem.
<br/>
<br/>
the biggest part of the program comes from the grahpics, i included them as .c files. is this a bad way to include them?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#100748 - !cube - Wed Aug 30, 2006 8:24 am</h4>
    <div class="postbody"><span class="postbody">Are you sure that the "keys" array is long enough and does actually hold 8 indexes?
<br/>
<br/>
As a side note, you should use ++it instead of it++ because the postfix increment/decrement operators allocate a new object from the stack instead of only accessing the object on which the operator was called.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#100755 - pkwong - Wed Aug 30, 2006 9:17 am</h4>
    <div class="postbody"><span class="postbody">the keys array is long enough
<br/>
<br/>
the weird thing is that it also happens at the code at other place.
<br/>
their common is that it hangs when creating new instance of a class...
<br/>
so i suspect that there's not enough ram left for me...
<br/>
have any other ppl tried this before?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#100756 - dXtr - Wed Aug 30, 2006 9:18 am</h4>
    <div class="postbody"><span class="postbody">I'm not sure if it really is your problem.. but I'm guessing all the dynamic allocation/freeing of memory will fragment the memory and cause problems in the end<br/>_________________<br/>go back to coding and stop screaming wolf :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#100758 - pkwong - Wed Aug 30, 2006 10:23 am</h4>
    <div class="postbody"><span class="postbody">that's really bad
<br/>
seems like i have to them statically...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#100761 - agentq - Wed Aug 30, 2006 12:00 pm</h4>
    <div class="postbody"><span class="postbody">Memory fragmentation?  You serious?  You have 4Mb of RAM and a handful of classes of only a few bytes.  Memory fragmentation will never be an issue.
<br/>
<br/>
The first thing that occurs to me is that you shouldn't havn't constucted your for loop properly:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
//remove
<br/>
for (int i=0; i&lt;8; i++){
<br/>
  if (released &amp; keys[i]){
<br/>
    list&lt;keyEffect* &gt;::iterator It=keyEffects.begin();
<br/>
    for (;It!=keyEffects.end() &amp;&amp; (*It)-&gt;getChannel()!=i; It++) {
<br/>
        delete *It;
<br/>
        keyEffects.erase(It);
<br/>
    }
<br/>
  }
<br/>
} 
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#100769 - pkwong - Wed Aug 30, 2006 12:58 pm</h4>
    <div class="postbody"><span class="postbody">thanks for pointing out.
<br/>
i think i need a better coding style :P
<br/>
<br/>
i see that other ppl are having malloc problems which returns a used memory
<br/>
could this be somehow related?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#100771 - !cube - Wed Aug 30, 2006 1:17 pm</h4>
    <div class="postbody"><span class="postbody">What's in the keys-array anyway? I seriously doubt it's a memory management issue rather than just a logic error in the code. You're running the code on ARM9 right?
<br/>
<br/>
Agentq, the code you wrote is incorrect since the point is not to delete all the objects but just the one where the iterator points to after going through the vector.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#100775 - pkwong - Wed Aug 30, 2006 1:53 pm</h4>
    <div class="postbody"><span class="postbody">here's the code for the keys:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">int keys[]={KEY_L, KEY_LEFT, KEY_UP, KEY_RIGHT, KEY_Y, KEY_X, KEY_B, KEY_A};[</td> </tr></table><span class="postbody">
<br/>
used array coz i want to do key config later
<br/>
<br/>
also, here's my class definition
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">class keyEffect{
<br/>
public:
<br/>
   keyEffect();
<br/>
   keyEffect(short channel);
<br/>
   ~keyEffect();
<br/>
<br/>
   short getChannel(){return channel;}
<br/>
private:
<br/>
   short channel;
<br/>
   short spriteID[5];
<br/>
   short count;
<br/>
};</td> </tr></table><span class="postbody">
<br/>
<br/>
and yeah, i'm running the code in ARM9.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#100778 - !cube - Wed Aug 30, 2006 2:14 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>pkwong wrote:</b></span></td> </tr> <tr> <td class="quote">here's the code for the keys:
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">int keys[]={KEY_L, KEY_LEFT, KEY_UP, KEY_RIGHT, KEY_Y, KEY_X, KEY_B, KEY_A};[</td> </tr></table><span class="postbody"></span></td> </tr></table><span class="postbody">
<br/>
<br/>
Well there's your problem..
<br/>
<br/>
The check in your code:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">if (pressed &amp; keys[i])</td> </tr></table><span class="postbody">
<br/>
will always be true whenever pressed is true. If you do the check in VBLANK or in an IRQ, you'll end up allocating and pushing an enormous amount of keyEffect instances into the vector and eventually run out of memory. The removal has the same bug and will delete everything from the vector every time.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#100781 - dXtr - Wed Aug 30, 2006 2:21 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>agentq wrote:</b></span></td> </tr> <tr> <td class="quote">Memory fragmentation?  You serious?  You have 4Mb of RAM and a handful of classes of only a few bytes.  Memory fragmentation will never be an issue.
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
well.. as I didn't get what his code was suppsoed to do I thought I mention that it _could_ be a problem (I never said that it definetly was that who caused the problem..). all I wanted to lift up was that he should be more sparse with the memory. but enough of that..<br/>_________________<br/>go back to coding and stop screaming wolf :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#100783 - pkwong - Wed Aug 30, 2006 2:27 pm</h4>
    <div class="postbody"><span class="postbody">oops, sorry...
<br/>
forgot to say
<br/>
i used "int pressed = keysDown();" to get the keys
<br/>
so that shouldn't happen, right?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#100786 - !cube - Wed Aug 30, 2006 2:54 pm</h4>
    <div class="postbody"><span class="postbody">In that case if you do the checks in VBLANK, having a key pressed down will create a new instance of keyEffect and push it in the vector 60 times per second. Do you run that code in VBLANK or in an interrupt or where?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#100793 - pkwong - Wed Aug 30, 2006 4:59 pm</h4>
    <div class="postbody"><span class="postbody">ya, but should that be the difference of keyHeld() and keyDown()?
<br/>
i saw in the examples that
<br/>
"int pressed = keysDown();	// buttons pressed this loop"
<br/>
<br/>
i put the code in VBLANK and i checked dualis that it's not creating new sprites(i creates sprites in the constructor), so i think this should not be the problem. thanks for helping~</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#100877 - agentq - Thu Aug 31, 2006 9:45 am</h4>
    <div class="postbody"><span class="postbody">Hang on, if you're creating the object in the Vblank, you could run into quite a few problems.  I don't think the memory manager is interrupt safe, so if you happen to allocate memory in the interrupt handler and in the main program at the same time, you could cause a crash.  
<br/>
<br/>
Also, as a general rule, you should always try and minimise time spent in the interrupt handler, as other interrupts could be delayed if the interrupt takes too long to execute.
<br/>
<br/>
But, more generally, calling the memory manager to allocate space for each keypress is a bit wasteful on processing time, and pretty much unnecessary, as dXtr said.  Each 'new' call is probably padded to 16 bytes (or sometimes more) and so the objects will probably take up a lot more memory than you expect.
<br/>
<br/>
If you want the syntactic convinience of using 'new', you could override the operator and allocate your object from a static pool of 8 or so items.
<br/>
<br/>
Hope this helps you a bit.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#100908 - pkwong - Thu Aug 31, 2006 5:47 pm</h4>
    <div class="postbody"><span class="postbody">(sorry for the bad topic name, thanks for editing it)
<br/>
<br/>
woo~ thanks!
<br/>
i learn much more about the DS from all of you
<br/>
<br/>
agentq:
<br/>
you're right, creating a new instance for each new keypress is a waste of time...i fixed it with using an array of 8 keyEffect. ^^
<br/>
but i'm still a bit curious about why i got this problem...
<br/>
<br/>
i just had another test on my code.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">int main(void) {
<br/>
   powerON(POWER_ALL_2D);
<br/>
   for (int i=0; i&lt;999; i++)
<br/>
      new int();
<br/>
   ........
<br/>
</td> </tr></table><span class="postbody">
<br/>
wow, it hangs right after i press run in the emu.
<br/>
<br/>
then i used TouchTest from the examples as a template, did the same thing, it doesn't even hang if i run it for 9999 times.
<br/>
<br/>
it made me think of the graphics i included. that's the only difference i can spot.
<br/>
the graphics are in .c format and have 2 files for 1 graphic, gfx data and palette, total around 5xxKB text.
<br/>
e.g.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">const unsigned char wbar_Sprite[4096] __attribute__ ((aligned (4))) = {....}</td> </tr></table><span class="postbody">
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">extern unsigned char wbar_Sprite[4096];</td> </tr></table><span class="postbody">
<br/>
<br/>
is it a big problem?
<br/>
<br/>
actually, should i post all my code?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#100989 - pkwong - Fri Sep 01, 2006 11:53 am</h4>
    <div class="postbody"><span class="postbody">lol!
<br/>
guess what, after remove 1 single line, everything went back normal
<br/>
<br/>
bool end=FALSE;
<br/>
<br/>
i got a "bool start=FALSE;"
<br/>
both are global (i know i shouldn't)
<br/>
removing "start" doesn't help...
<br/>
<br/>
want to replicate this funny thing?
<br/>
use "combined" template from the examples,
<br/>
change the arm9 source to cpp
<br/>
add
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">bool end=FALSE;</td> </tr></table><span class="postbody">
<br/>
in the global area, and then put
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">for (int i=0; i&lt;9999; i++)
<br/>
  new int();
<br/>
</td> </tr></table><span class="postbody">
<br/>
in int main()
<br/>
<br/>
run it in the emu or HW, it hangs~ remove the line and try again, it works!
<br/>
i'm using devkitARM r19. i don't know if this just happens in my environment...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#101033 - HyperHacker - Fri Sep 01, 2006 9:06 pm</h4>
    <div class="postbody"><span class="postbody">The only time I ever had malloc() return already-used pointers was when I was writing an array incorrectly and corrupting memory.<br/>_________________<br/>I'm a PSP hacker now, but I still &lt;3 DS.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#101040 - Sausage Boy - Fri Sep 01, 2006 9:43 pm</h4>
    <div class="postbody"><span class="postbody">Works fine for me on hardware, in dualis and in no$gba.
<br/>
<br/>
OS: Windows XP
<br/>
gcc version: arm-eabi-gcc.exe (GCC) 4.1.1 (devkitARM
<br/>
release 19b)
<br/>
ld version: GNU ld version 2.17
<br/>
build environment: MSYS
<br/>
MSYS version: MINGW32_NT-5.1 KRANIUM 1.0.11(0.46/3/2) 2004-04-30 18:55 i686 unknown
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
...
<br/>
<br/>
#include &lt;stdio.h&gt;
<br/>
<br/>
bool end=FALSE;
<br/>
<br/>
//---------------------------------------------------------------------------------
<br/>
int main(void) {
<br/>
//---------------------------------------------------------------------------------
<br/>
<br/>
   for (int i=0; i&lt;9999; i++)
<br/>
      new int(); 
<br/>
<br/>
   touchPosition touchXY;
<br/>
<br/>
   videoSetMode(0);   //not using the main screen
<br/>
<br/>
...
<br/>
</td> </tr></table><span class="postbody"><br/>_________________<br/>"no offense, but this is the gayest game ever"</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#101075 - pkwong - Sat Sep 02, 2006 2:46 am</h4>
    <div class="postbody"><span class="postbody">oops!
<br/>
then it should be a weird problem happening to me only...</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
