<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Audio mixer callback function not interrupt safe - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > Audio mixer callback function not interrupt safe</h2>
<div id="posts">
<div class="post">
    <h4>#129879 - TheChuckster - Mon May 28, 2007 4:59 pm</h4>
    <div class="postbody"><span class="postbody">I finally managed to get sound streaming to work on the DS, but the callback function that generates the audio (via emulation of the Atari 2600 TIA chip) is not interrupt safe.
<br/>
<br/>
I am not quite sure why it is not interrupt safe. What makes a function "interrupt safe"?
<br/>
<br/>
I do know that if I put that function within an interrupt, the DS locks up.
<br/>
<br/>
I tried using a "semaphore" global variable that would tell the emulator to generate (x) sound samples during the next frame into buffer (y) for the sound streaming, but that is too slow.
<br/>
<br/>
I even tried moving the emulator loop into the interrupt code itself (just as a test to satisfy my curiosity). The DS still crashed. Apparently, even if the emulator loop is executed "in sequence" inside the interrupt, it still crashes. Even though the only difference is that it is being called inside an interrupt.
<br/>
<br/>
Which leads me to my next question, can another interrupt interrupt an interrupt in progress? Maybe that's screwing things up...
<br/>
<br/>
Is there a way to work around this? I brainstormed a bit and thought of using filling up a secondary buffer during emulation, and then just having the callback function use that. I'm not sure if that would work, but it would be challenging to know the position of the "sound cursor" within that secondary buffer.
<br/>
<br/>
How have other developers accomplished this? It might just be easier for me to identify what is making the TIA update function "interrupt unsafe". What should I be looking for?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#129880 - tepples - Mon May 28, 2007 5:01 pm</h4>
    <div class="postbody"><span class="postbody">A function is interrupt unsafe if it takes longer than interrupt time to execute it, or if it uses a lot of stack space, or if is not thread safe.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#129881 - TheChuckster - Mon May 28, 2007 5:09 pm</h4>
    <div class="postbody"><span class="postbody">In that case, it probably is taking too long to execute.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#130109 - TheChuckster - Thu May 31, 2007 12:57 am</h4>
    <div class="postbody"><span class="postbody">This is to save any other developers many hours of frustration. I solved the problem by using a ring buffer.
<br/>
<br/>
WinterMute: how is "ring buffer" in any way related to "interrupt safety"?
<br/>
TheChuckster: well
<br/>
TheChuckster: instead of calling the emulator audio callback function in the interrupt
<br/>
TheChuckster: i have it fill up the ring buffer in the main loop
<br/>
TheChuckster: and then i just read in the buffer in the interrupt
<br/>
<br/>
There you have it. If you have an alternative solution in mind, feel free to post it. What I'm doing works beautifully, though, even if it's not the cleanest way of handling this.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
