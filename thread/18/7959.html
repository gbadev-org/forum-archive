<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>libnds glOrtho depth issue - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>DS development > libnds glOrtho depth issue</h2>
<div id="posts">
<div class="post">
    <h4>#65237 - FireSlash - Sun Jan 01, 2006 5:43 am</h4>
    <div class="postbody"><span class="postbody">Has anyone else had trouble with depth in glOrtho?
<br/>
<br/>
It should ignore the Z values for perspective, but its also ignoring them for depth in a weird way... The higher (Y axis) of two polygons gets drawn on top, instead of the proper Z axis.
<br/>
<br/>
Am I just doing something wrong, or is this a known issue? Maybe theres a fix? :)<br/>_________________<br/><a class="postlink" href="http://www.fireslash.net" target="_blank">FireSlash.net</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#65330 - crossraleigh - Mon Jan 02, 2006 2:20 am</h4>
    <div class="postbody"><span class="postbody">Yes, I had the same problem, but both neimod and Extreme Coder confidently assured me that depth with glOrtho worked fine for them. I never figured out what I was doing wrong.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">Depth would start working if I enabled perspective by using
<br/>
<br/>
[2/w 0   0  -1]
<br/>
[0   2/h 0  -1]
<br/>
[0   0  -1   0]
<br/>
[0   0  -1   1]
<br/>
<br/>
instead of
<br/>
<br/>
[2/w 0   0  -1]
<br/>
[0   2/h 0  -1]
<br/>
[0   0  -1   0]
<br/>
[0   0   0   1].</td> </tr></table><span class="postbody"><br/>_________________<br/>My world is black and white, but if I blink fast enough, I see it in grayscale.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#65339 - FireSlash - Mon Jan 02, 2006 4:41 am</h4>
    <div class="postbody"><span class="postbody">Well then, perhaps its time for some code. I'd like to sort out why glOrtho isn't working, instead of just patch it by using a modified perspective matrix :)
<br/>
<br/>
Excuse the mess, I'm still implementing a lot of code, so there are a lot of bits commented out and thrown in at weird spots. This code is based off the Ortho libnds example, and some code from ecurtz.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">int main()
<br/>
{   
<br/>
   touchPosition touch;
<br/>
   // Turn on everything
<br/>
   powerON(POWER_ALL);
<br/>
   
<br/>
   // Setup the Main screen for 3D 
<br/>
   videoSetMode(MODE_0_3D);                
<br/>
<br/>
   videoSetModeSub(MODE_5_2D | DISPLAY_BG2_ACTIVE | DISPLAY_SPR_ACTIVE | DISPLAY_SPR_2D_BMP_256);
<br/>
   SUB_BG2_CR = BG_BMP16_256x256;
<br/>
   SUB_BG2_XDX = 256;
<br/>
   SUB_BG2_XDY = 0;
<br/>
   SUB_BG2_YDX = 0;
<br/>
   SUB_BG2_YDY = 256;
<br/>
   SUB_BG2_CY = 0;
<br/>
   SUB_BG2_CX = 0;
<br/>
      
<br/>
   vramSetMainBanks(VRAM_A_TEXTURE, VRAM_B_LCD, VRAM_C_SUB_BG, VRAM_D_SUB_SPRITE);
<br/>
<br/>
   int y = 0;
<br/>
   int x = 0;
<br/>
   for (y = 0; y &lt; SCREEN_HEIGHT; y++)
<br/>
   for (x = 0; x &lt; SCREEN_WIDTH; x++)
<br/>
   {
<br/>
      BG_GFX_SUB[y * SCREEN_WIDTH + x]  = RGB15(31, x % 32, y % 32) | BIT(15);
<br/>
   }
<br/>
<br/>
   // IRQ basic setup
<br/>
   irqInit();
<br/>
   irqSet(IRQ_VBLANK, 0);
<br/>
<br/>
   glViewPort(0,0,255,191);
<br/>
   
<br/>
   // Specify the Clear Color and Depth 
<br/>
   glClearColor(0,0,0);
<br/>
   glClearDepth(0x7FFF);
<br/>
   
<br/>
   InitSprites();
<br/>
    
<br/>
   int i = 0;
<br/>
   for (y = 0; y &lt; 3; y++)
<br/>
   for (x = 0; x &lt; 4; x++)
<br/>
   {
<br/>
      sprites[i].attribute[0] = ATTR0_BMP | ATTR0_SQUARE | (64 * y);
<br/>
      sprites[i].attribute[1] = ATTR1_SIZE_64 | (64 * x);
<br/>
      sprites[i].attribute[2] = ATTR2_ALPHA(1) | (8 * 32 * y) | (8 * x);
<br/>
      i++;
<br/>
   }
<br/>
   
<br/>
   uint32 frameCount = 0;
<br/>
   dsScene * scene = new dsIntro;
<br/>
   scene-&gt;load(frameCount);
<br/>
   while (1) 
<br/>
   {
<br/>
      // Check if our scene needs changed
<br/>
      if(scene-&gt;getState() == state_UNLOADED)
<br/>
      {
<br/>
         free(scene);
<br/>
         scene = new dsMenu;
<br/>
      }    
<br/>
      // Reset the screen and setup the view
<br/>
      glReset();
<br/>
      scanKeys();
<br/>
      
<br/>
      touch=touchReadXY();
<br/>
        
<br/>
      scene-&gt;touch(touch);
<br/>
<br/>
      glOrtho(0,1,0,1,-6,6);
<br/>
<br/>
      glColor3f(1,1,1);
<br/>
      
<br/>
      glLight(0, RGB15(31,31,31) , 0,    floattov10(-1.0), 0);
<br/>
      glLight(1, RGB15(31,31,31) , 0,     0,   floattov10(-1.0));
<br/>
      glLight(2, RGB15(31,31,31) , 0,     0,   floattov10(1.0));
<br/>
<br/>
      glPushMatrix();
<br/>
      
<br/>
      glMatrixMode(GL_TEXTURE);
<br/>
      glIdentity();
<br/>
      
<br/>
      glMatrixMode(GL_MODELVIEW);
<br/>
<br/>
      //need to set up some material properties since DS does not have them set by default
<br/>
      glMaterialf(GL_AMBIENT, RGB15(16,16,16));
<br/>
      glMaterialf(GL_DIFFUSE, RGB15(16,16,16));
<br/>
      glMaterialf(GL_SPECULAR, BIT(15) | RGB15(8,8,8));
<br/>
      glMaterialf(GL_EMISSION, RGB15(16,16,16));
<br/>
<br/>
      //ds uses a table for shinyness..this generates a half-ass one
<br/>
      glMaterialShinyness();
<br/>
      
<br/>
      
<br/>
      if(!(keysHeld() &amp; KEY_L))
<br/>
         glPolyFmt(POLY_ALPHA(31) | POLY_CULL_NONE  | POLY_FORMAT_LIGHT0| POLY_FORMAT_LIGHT1| POLY_FORMAT_LIGHT2);
<br/>
      else
<br/>
         glPolyFmt(POLY_ALPHA(0)  | POLY_CULL_NONE  | POLY_FORMAT_LIGHT0| POLY_FORMAT_LIGHT1| POLY_FORMAT_LIGHT2);
<br/>
      
<br/>
      // Set the current matrix to be the model matrix
<br/>
      glMatrixMode(GL_MODELVIEW);
<br/>
      
<br/>
      //Push our original Matrix onto the stack (save state)
<br/>
      glPushMatrix();   
<br/>
<br/>
<br/>
      // TODO: Remove reliance on two VRAM banks. It can be done with one, I think.
<br/>
      if (frameCount &amp; 0x1)
<br/>
      {
<br/>
         vramSetBankC(VRAM_C_SUB_BG);
<br/>
         vramSetBankD(VRAM_D_LCD);
<br/>
         SetRegCapture(true, 0, 15, 3, 0, 3, 0, 0);
<br/>
         scene-&gt;draw_top(frameCount);
<br/>
      } else {
<br/>
         vramSetBankC(VRAM_C_LCD);
<br/>
         vramSetBankD(VRAM_D_SUB_SPRITE);
<br/>
         SetRegCapture(true, 0, 15, 2, 0, 3, 0, 0);
<br/>
         scene-&gt;draw_bottom(frameCount);
<br/>
      }
<br/>
      // Pop our Matrix from the stack (restore state)
<br/>
      glPopMatrix(1);
<br/>
      frameCount++;
<br/>
      // flush to screen   
<br/>
      glFlush();
<br/>
      lcdSwap();
<br/>
      UpdateOAM();
<br/>
   }
<br/>
   
<br/>
   return 0;
<br/>
}</td> </tr></table><span class="postbody"><br/>_________________<br/><a class="postlink" href="http://www.fireslash.net" target="_blank">FireSlash.net</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#75626 - MrK - Tue Mar 14, 2006 8:05 pm</h4>
    <div class="postbody"><span class="postbody">I don't know if this is a known response but changing videoGL.inl
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
GL_STATIC_INL void glFlush(void) { GFX_FLUSH = 2; }
<br/>
<br/>
to 
<br/>
<br/>
GL_STATIC_INL void glFlush(void) { GFX_FLUSH = 0; }
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
makes the glOrtho depth sorting work (at least for me). if somebody could confirm this it'd be a nice step into fixing the issue ;)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#75714 - Extreme Coder - Wed Mar 15, 2006 1:20 pm</h4>
    <div class="postbody"><span class="postbody">Did you try this? I sure will:D
<br/>
*Prays it should work*
<br/>
<br/>
EDIT: YES!!!!!!!!!! IT worked! Finally. Thanks a lot:D
<br/>
dovoto/wintermute/whoever in charge of libnds UPDATE THIS;D</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#75802 - dovoto - Thu Mar 16, 2006 3:28 am</h4>
    <div class="postbody"><span class="postbody">hmm...<br/>_________________<br/><a href="http://www.drunkencoders.com" target="_blank">www.drunkencoders.com</a></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
