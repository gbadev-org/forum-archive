<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Compiling problem with inline assembly and smull - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > Compiling problem with inline assembly and smull</h2>
<div id="posts">
<div class="post">
    <h4>#165688 - Kaiser - Sat Jan 03, 2009 9:45 pm</h4>
    <div class="postbody"><span class="postbody">For some reason, GCC seems to throw a fit whenever I am using the SMULL instruction in my inline'ed assembly code:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
typedef int fixed_t;
<br/>
<br/>
fixed_t FixedMul(fixed_t a, fixed_t b)
<br/>
{
<br/>
   __asm ("smull   r2, r3, %0, %1\n"
<br/>
         "mov   %1, r2, lsr #16\n"
<br/>
         "mov   r2, r3, lsl #16\n"
<br/>
         "orr   %0, %1, r2"
<br/>
         : "=r" (a) : "r" (a), "r" (b) : "r2", "r3");
<br/>
<br/>
   return(a);
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
When compiling, GCC would then spew out this message:
<br/>
<br/>
Error: selected processor does not support `smull r4,r5,r0,r0'
<br/>
Error: selected processor does not support `smull r4,r5,r1,r1'
<br/>
<br/>
Anyone could point out any work-arounds for this? I appreciate the help, thanks.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#165690 - Cearn - Sat Jan 03, 2009 11:12 pm</h4>
    <div class="postbody"><span class="postbody">If you're using the standard makefiles, the source files are likely to be compiled as Thumb code, and thumb code doesn't have long-multiply instructions. If you want to compile as ARM, give the file an .arm.c or .arm.cpp extension. That said, if you do C in ARM mode, you can also simply use ((s64)a*b)&gt;&gt;16. This will even work in Thumb mode, but in that case a very slow library routine will be called for the multiplication.
<br/>
<br/>
I'll also mention that inline assembly can be pretty fickle at times. In this case, for example, the syntax isn't quite correct and generates code for a 'smull r2, r3, r0, r0', which is probably not what you are after. If you need stand-alone functions with assembly code, you might as well create a proper assembly file for it, where you won't trip over things like this. Example:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">@ Put this is a file with a .s extension
<br/>
<br/>
    .text               @ In text section
<br/>
    .arm                @ as ARM code
<br/>
    .align              @ align to 4-bytes
<br/>
    .global FixedMul    @ declaration for externa visibility
<br/>
FixedMul:
<br/>
    smull   r2, r3, r0, r1
<br/>
    mov     r0, r3, lsr #16
<br/>
    orr     r0, r2, lsl #16
<br/>
    bx      lr
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#165691 - Kaiser - Sun Jan 04, 2009 1:09 am</h4>
    <div class="postbody"><span class="postbody">I was creating functions in seperate .s (assembly) files before, but I ran into a situation where some GPRs in my functions were getting clobbered and resulted in corrupted data (and crashes).
<br/>
<br/>
I was assuming with inline assembly, I could have more control on what registers I want to set and to avoid clobbering?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#165694 - Dwedit - Sun Jan 04, 2009 2:26 am</h4>
    <div class="postbody"><span class="postbody">Register corruption?  Are you sure you're following the standard convention where r0-r3 and r12 are destroyable, and everything else needs to be preserved when you return?<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#165696 - Kaiser - Sun Jan 04, 2009 4:27 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Dwedit wrote:</b></span></td> </tr> <tr> <td class="quote">Register corruption?  Are you sure you're following the standard convention where r0-r3 and r12 are destroyable, and everything else needs to be preserved when you return?</td> </tr></table><span class="postbody">
<br/>
<br/>
I think I may have missed out on 'preserving'. Can you provide an example of what you mean?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#165697 - wintermute - Sun Jan 04, 2009 5:27 am</h4>
    <div class="postbody"><span class="postbody"><a href="http://infocenter.arm.com/help/topic/com.arm.doc.ihi0042c/IHI0042C_aapcs.pdf" target="_blank">http://infocenter.arm.com/help/topic/com.arm.doc.ihi0042c/IHI0042C_aapcs.pdf</a><br/>_________________<br/><a class="postlink" href="http://www.devkitpro.org/" target="_blank">devkitPro - professional toolchains at amateur prices</a>
<br/>
<a class="postlink" href="http://wiki.devkitpro.org/index.php/IRC" target="_blank">devkitPro IRC support</a>
<br/>
<a class="postlink" href="http://davejmurphy.com/" target="_blank">Personal Blog</a></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
