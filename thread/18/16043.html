<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>BMP Problem - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>DS development > BMP Problem</h2>
<div id="posts">
<div class="post">
    <h4>#162779 - hacker013 - Fri Sep 12, 2008 7:40 pm</h4>
    <div class="postbody"><span class="postbody">Hey everybody,
<br/>
<br/>
I've have some problems with my code to load a <b style="color:#FFA34F">bmp</b> and to draw it. (it is modifyd version of mighty maxs <b style="color:#FFA34F">bmp</b> load code for his os.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#include &lt;hax_fat.h&gt;
<br/>
#include &lt;hax_bmp.h&gt;
<br/>
#include &lt;malloc.h&gt;
<br/>
#include &lt;string.h&gt;
<br/>
<br/>
/*-----------------------------------------------------------------------------------------------------------
<br/>
   hax_load_bmp
<br/>
   
<br/>
   const char* name = filename
<br/>
   bool custom = custom memory adres
<br/>
   unsigned long adress = if custom is true, custom memory adress, else 0
<br/>
  -----------------------------------------------------------------------------------------------------------*/
<br/>
unsigned short *hax_load_bmp(const char* name,bool custom,unsigned long adress)
<br/>
{
<br/>
   FILE *<b style="color:#FFA34F">bmp</b> = fopen(name,"rb") ;
<br/>
   if (!<b style="color:#FFA34F">bmp</b>) return NULL;
<br/>
   unsigned short *screen = NULL;
<br/>
   if (custom==true) {
<br/>
      screen = (unsigned short *)adress ;
<br/>
   } else {
<br/>
      screen = (unsigned short *)malloc(flength(<b style="color:#FFA34F">bmp</b>));
<br/>
   }
<br/>
   fseek(<b style="color:#FFA34F">bmp</b>,54,SEEK_SET) ;
<br/>
   int x,y ;
<br/>
   for (y=191;y&gt;=0;y--) {
<br/>
      for (x=0;x&lt;256;x++) {
<br/>
         unsigned char color[3] ;
<br/>
         fread(&amp;color[0],1,3,<b style="color:#FFA34F">bmp</b>) ;
<br/>
         color[0]/=8 ;
<br/>
         color[1]/=8 ;
<br/>
         color[2]/=8 ;
<br/>
         screen[y*256+x] = 0x8000 | (color[0] &amp; 0x1F) | ((color[1] &amp; 0x1F) &lt;&lt; 5) | ((color[2] &amp; 0x1F) &lt;&lt; 10) ;
<br/>
      } ;
<br/>
   } ;
<br/>
   fclose(<b style="color:#FFA34F">bmp</b>) ;
<br/>
   return screen;
<br/>
}
<br/>
<br/>
void hax_draw_bmp(bool screen,int x, int y, int w, int h, unsigned long adress)
<br/>
{
<br/>
   unsigned short *scr = NULL;
<br/>
   if (screen==0) {
<br/>
      scr = (u16 *)0x06008000;
<br/>
   } else {
<br/>
      scr = (u16 *)0x06208000;
<br/>
   }
<br/>
   unsigned short *mem = (unsigned short *)adress ;
<br/>
   for (y=y;h&gt;=y;h--) {
<br/>
      for (x=x;x&lt;w;x++) {
<br/>
         scr[h*256+x] = *mem;
<br/>
         mem++;
<br/>
      } ;
<br/>
   } ;
<br/>
}
<br/>
<br/>
void hax_remove_bmp(unsigned long adress)
<br/>
{
<br/>
   free((unsigned short *)adress);
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I get when is use hax_draw_bmp a black screen. Can you see the problem?
<br/>
<br/>
gr,
<br/>
<br/>
hacker013<br/>_________________<br/><a class="postlink" href="http://imetal.nl/" target="_blank">Website / Blog</a>
<br/>
<br/>
Let the nds be with you.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#162780 - ingramb - Fri Sep 12, 2008 7:55 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">for (y=y;h&gt;=y;h--) {
<br/>
      for (x=x;x&lt;w;x++) {
<br/>
         scr[h*256+x] = *mem;
<br/>
         mem++;
<br/>
      } ;
<br/>
   } ; </td> </tr></table><span class="postbody">
<br/>
This is messed up.  Try
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">for (int y0 = y; y0 &lt; y + h; y0++) {
<br/>
      for (int x0 = x; x0 &lt; x + w; x0++) {
<br/>
         scr[y0*256+x0] = *mem;
<br/>
         mem++;
<br/>
      }
<br/>
   } </td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#162805 - hacker013 - Sat Sep 13, 2008 10:44 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>ingramb wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">for (y=y;h&gt;=y;h--) {
<br/>
      for (x=x;x&lt;w;x++) {
<br/>
         scr[h*256+x] = *mem;
<br/>
         mem++;
<br/>
      } ;
<br/>
   } ; </td> </tr></table><span class="postbody">
<br/>
This is messed up.  Try
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">for (int y0 = y; y0 &lt; y + h; y0++) {
<br/>
      for (int x0 = x; x0 &lt; x + w; x0++) {
<br/>
         scr[y0*256+x0] = *mem;
<br/>
         mem++;
<br/>
      }
<br/>
   } </td> </tr></table><span class="postbody"></span></td> </tr></table><span class="postbody">
<br/>
<br/>
it doesn't work, i get a black screen again.
<br/>
<br/>
EDIT:
<br/>
<br/>
i'm using to code like this:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">u16 bmp_desktop;
<br/>
<br/>
bmp_desktop=hax_load_bmp("/xsystem/desktop.<b style="color:#FFA34F">bmp</b>",0,0);
<br/>
hax_draw_bmp(0,0,0,256,192,*bmp_desktop); //hanging here</td> </tr></table><span class="postbody"><br/>_________________<br/><a class="postlink" href="http://imetal.nl/" target="_blank">Website / Blog</a>
<br/>
<br/>
Let the nds be with you.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#162827 - koryspansel - Sat Sep 13, 2008 7:19 pm</h4>
    <div class="postbody"><span class="postbody">Your example code has some serious problems and shouldn't even compile (ie. illegal indirection):
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
u16 bmp_desktop;
<br/>
<br/>
bmp_desktop=hax_load_bmp("/xsystem/desktop.<b style="color:#FFA34F">bmp</b>",0,0);
<br/>
hax_draw_bmp(0,0,0,256,192,*bmp_desktop); //hanging here
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Or did you mean for bmp_desktop to be <span style="font-weight: bold">pointer</span> to u16?  If that IS the case, then you have the problem of de-referencing the pointer, which just returns the value at the start of that address, which you then cast back to a pointer (not good!)
<br/>
<br/>
The best solution would be to have your draw_bmp &amp; remove_bmp functions take the actual pointer, instead of casting it to an integer then back again.  Assuming it was a typo in your example code, doing this would have also highlighted the real problem in the first place.  Since you can't pass an integer value as pointer without a cast.
<br/>
<br/>
EDIT: Clarity
<br/>
<br/>
--
<br/>
Kory</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#162828 - hacker013 - Sat Sep 13, 2008 7:24 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>koryspansel wrote:</b></span></td> </tr> <tr> <td class="quote">Your example code has some serious problems and shouldn't even compile (ie. illegal indirection):
<br/>
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
u16 bmp_desktop;
<br/>
<br/>
bmp_desktop=hax_load_bmp("/xsystem/desktop.<b style="color:#FFA34F">bmp</b>",0,0);
<br/>
hax_draw_bmp(0,0,0,256,192,*bmp_desktop); //hanging here
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Or did you mean for bmp_desktop to be <span style="font-weight: bold">pointer</span> to u16?  If that IS the case, then you have the problem of de-referencing the pointer, which just returns the value at the start of that address, which you then cast back to a pointer (not good!)
<br/>
<br/>
The best solution would be to have your draw_bmp &amp; remove_bmp functions take the actual pointer, instead of casting it to an integer then back again.  Assuming it was a typo in your example code, doing this would have also highlighted the real problem in the first place.  Since you can't pass an integer value as pointer without a cast.
<br/>
<br/>
EDIT: Clarity
<br/>
<br/>
--
<br/>
Kory</span></td> </tr></table><span class="postbody">
<br/>
<br/>
Can you give an example because i don't understand somethinf about pointers.<br/>_________________<br/><a class="postlink" href="http://imetal.nl/" target="_blank">Website / Blog</a>
<br/>
<br/>
Let the nds be with you.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#162831 - koryspansel - Sat Sep 13, 2008 7:45 pm</h4>
    <div class="postbody"><span class="postbody">Sure.  Be aware, however, that I haven't really looked at the bitmap code too in-depth so you may have bugs elsewhere too.
<br/>
<br/>
Assuming the code should really look like this (to compile): 
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
u16* bmp_desktop;
<br/>
<br/>
bmp_desktop=hax_load_bmp("/xsystem/desktop.<b style="color:#FFA34F">bmp</b>",0,0);
<br/>
hax_draw_bmp(0,0,0,256,192,*bmp_desktop); //hanging here 
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Note how your hax_load_bmp returns a pointer to the memory where your <b style="color:#FFA34F">bmp</b> has been loaded.  The easiest way to think about pointers is to remember that their value is just a memory address.  So now bmp_desktop contains the memory address for the start of your bitmap.  And as you've already noticed this causes the problem:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
hax_draw_bmp(0,0,0,256,192,*bmp_desktop); //hanging here 
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
The de-reference operator (*) returns the <span style="font-weight: bold">value at the memory location</span> pointed to by the pointer.  The type &amp; size of the value is determined by the type pointed to.  So *bmp_desktop just returns the first u16 of your bitmap.
<br/>
<br/>
Assuming this is a direct color bitmap:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
*bmp_desktop             // returns first pixel
<br/>
*(bmp_desktop + 1)    // returns second pixel
<br/>
*(bmp_desktop + 2)    // returns third pixel
<br/>
...
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
So what you end up doing is reading the color value for the first pixel of the bitmap and casting that to a memory address, which is almost certainly going to be bogus.
<br/>
<br/>
To sum it up, change:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
void hax_draw_bmp(bool screen,int x, int y, int w, int h, unsigned long adress)
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
to
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
void hax_draw_bmp(bool screen,int x, int y, int w, int h, unsigned short* mem) 
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Remove this line in hax_draw_bmp:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
unsigned short *mem = (unsigned short *)adress ;
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
And change the example code to: 
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
u16* bmp_desktop;
<br/>
<br/>
bmp_desktop=hax_load_bmp("/xsystem/desktop.<b style="color:#FFA34F">bmp</b>",0,0);
<br/>
hax_draw_bmp(0,0,0,256,192,bmp_desktop); //hanging here 
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Well, that was quite long.  Hopefully, it makes sense.
<br/>
<br/>
--
<br/>
Kory</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
