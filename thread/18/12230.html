<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>FIFO Problem - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>DS development > FIFO Problem</h2>
<div id="posts">
<div class="post">
    <h4>#116157 - relpats_eht - Mon Jan 22, 2007 5:51 pm</h4>
    <div class="postbody"><span class="postbody">I have been attempting to set up a FIFO sound system but have been running into a bit of trouble. As of now, the queue on the ARM9 side merely fills up, and is never received by the ARM7 (as far as I can tell). I have read through these forums looking for some form of answer, but I still haven't found one.
<br/>
In any event, here is a condensed form of the code, perhaps someone could give me a few pointers.
<br/>
<br/>
ARM7:</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void recvSoundCommand(NDS_SOUND_COMMAND* command){
<br/>
   while((REG_IPC_FIFO_CR &amp; IPC_FIFO_RECV_EMPTY));
<br/>
   command-&gt;command = REG_IPC_FIFO_RX;
<br/>
<br/>
   while((REG_IPC_FIFO_CR &amp; IPC_FIFO_RECV_EMPTY));
<br/>
   command-&gt;voice = REG_IPC_FIFO_RX;
<br/>
<br/>
   while((REG_IPC_FIFO_CR &amp; IPC_FIFO_RECV_EMPTY));
<br/>
   command-&gt;value = REG_IPC_FIFO_RX;
<br/>
}
<br/>
<br/>
void sendSoundCommand(NDS_SOUND_COMMAND command){
<br/>
   while(!(REG_IPC_FIFO_CR &amp; IPC_FIFO_SEND_EMPTY));
<br/>
<br/>
   while((REG_IPC_FIFO_CR &amp; IPC_FIFO_SEND_FULL));
<br/>
   REG_IPC_FIFO_TX = command.command;
<br/>
<br/>
   while((REG_IPC_FIFO_CR &amp; IPC_FIFO_SEND_FULL));
<br/>
   REG_IPC_FIFO_TX = command.voice;
<br/>
<br/>
   while((REG_IPC_FIFO_CR &amp; IPC_FIFO_SEND_FULL));
<br/>
   REG_IPC_FIFO_TX = command.value;
<br/>
}
<br/>
<br/>
void fifoHandler(void){
<br/>
   NDS_SOUND_COMMAND command;
<br/>
   recvSoundCommand(&amp;command);
<br/>
<br/>
   switch(command.command){
<br/>
      // Handle command
<br/>
   }
<br/>
<br/>
   u32 extra;
<br/>
   while(!(REG_IPC_FIFO_CR &amp; IPC_FIFO_RECV_EMPTY)){
<br/>
      extra = REG_IPC_FIFO_RX;
<br/>
   }
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
ARM9:</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void nds_fifo_recv_sound_command(NDS_SOUND_COMMAND* command){
<br/>
   while((REG_IPC_FIFO_CR &amp; IPC_FIFO_RECV_EMPTY));
<br/>
   command-&gt;command = REG_IPC_FIFO_RX;
<br/>
<br/>
   while((REG_IPC_FIFO_CR &amp; IPC_FIFO_RECV_EMPTY));
<br/>
   command-&gt;voice = REG_IPC_FIFO_RX;
<br/>
<br/>
   while((REG_IPC_FIFO_CR &amp; IPC_FIFO_RECV_EMPTY));
<br/>
   command-&gt;value = REG_IPC_FIFO_RX;
<br/>
}
<br/>
<br/>
void nds_fifo_send_sound_command(NDS_SOUND_COMMAND command){
<br/>
   while(!(REG_IPC_FIFO_CR &amp; IPC_FIFO_SEND_EMPTY)); // Eventually, the code hangs here
<br/>
<br/>
   while((REG_IPC_FIFO_CR &amp; IPC_FIFO_SEND_FULL));
<br/>
   REG_IPC_FIFO_TX = command.command;
<br/>
<br/>
   while((REG_IPC_FIFO_CR &amp; IPC_FIFO_SEND_FULL));
<br/>
   REG_IPC_FIFO_TX = command.voice;
<br/>
<br/>
   while((REG_IPC_FIFO_CR &amp; IPC_FIFO_SEND_FULL));
<br/>
   REG_IPC_FIFO_TX = command.value;
<br/>
}
<br/>
<br/>
void nds_fifo_handler(void){
<br/>
   NDS_SOUND_COMMAND command;
<br/>
   nds_fifo_recv_sound_command(&amp;command);
<br/>
<br/>
   switch(command.command){
<br/>
      // Handle Command
<br/>
   }
<br/>
<br/>
   u32 extra;
<br/>
   while(!(REG_IPC_FIFO_CR &amp; IPC_FIFO_RECV_EMPTY)){
<br/>
      extra = REG_IPC_FIFO_RX;
<br/>
   }
<br/>
}</td> </tr></table><span class="postbody"><br/>_________________<br/>- relpats_eht</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#116161 - GrizzlyAdams - Mon Jan 22, 2007 6:37 pm</h4>
    <div class="postbody"><span class="postbody">I would suggest only using the fifo to trigger commands, not to send data. that way every transfer is the same size and you can't have problems with missing data.
<br/>
To send your data I'd suggest using the main ram or shared ram.
<br/>
<br/>
WinterMute sent along a chunk of code to me similar to what I have below. I've been using this in mythremote 0.2
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
enum {
<br/>
   CMD_WAIT,
<br/>
   WIFI_INIT
<br/>
};
<br/>
 
<br/>
u32 fifo_status = CMD_WAIT;
<br/>
<br/>
void arm7_fifo() { // check incoming fifo messages
<br/>
//---------------------------------------------------------------------------------
<br/>
   while ( !(REG_IPC_FIFO_CR &amp; (IPC_FIFO_RECV_EMPTY)) ) {
<br/>
      u32 msg = REG_IPC_FIFO_RX;
<br/>
      REG_IPC_FIFO_TX = msg;
<br/>
 
<br/>
      switch (fifo_status) {
<br/>
         case WIFI_INIT:
<br/>
            REG_IME = 1;   // allow other interrupts
<br/>
            Wifi_Init(msg);
<br/>
            Wifi_SetSyncHandler(arm7_synctoarm9); // allow wifi lib to notify arm9
<br/>
            fifo_status = CMD_WAIT;
<br/>
            break;
<br/>
<br/>
         case CMD_WAIT:
<br/>
            switch(msg) {
<br/>
               case IPC_WIFISYNC7:
<br/>
                  Wifi_Sync();
<br/>
                  break;
<br/>
<br/>
               case IPC_POWEROFF:
<br/>
                  IPC_PowerOff();
<br/>
                  break;
<br/>
<br/>
               case IPC_CARTRESET:
<br/>
                  IPC_CartReset();
<br/>
                  break;
<br/>
<br/>
// ... other IPCs were here
<br/>
<br/>
// this our only exception to the data shouldnt go in FIFO rule:
<br/>
               case IPC_WIFIINIT:
<br/>
                  fifo_status = WIFI_INIT;
<br/>
                  break;
<br/>
            }
<br/>
            break;
<br/>
      }
<br/>
   }
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
on the arm7 I have this chunk being called from a tight loop at the end of the init sequence:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
   for(;;) {
<br/>
      arm7_fifo();
<br/>
      swiWaitForVBlank();
<br/>
   }
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
on the arm9 a similar handler is called from the fifo irq.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#116201 - relpats_eht - Tue Jan 23, 2007 3:01 am</h4>
    <div class="postbody"><span class="postbody">I may end up doing that, but first, I would like to know why what I have isn't working, if only so I have a better understanding of FIFO. At present, I can put this loop</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">u32 extra;
<br/>
while(!(REG_IPC_FIFO_CR &amp; IPC_FIFO_RECV_EMPTY)){
<br/>
   extra = REG_IPC_FIFO_RX;
<br/>
}</td> </tr></table><span class="postbody">in my v blank handler on the ARM7 and still have the code hang infinitely waiting for the queue to be empty on the ARM9, which as far as I can tell, which clearly isn't far enough, shouldn't happen.<br/>_________________<br/>- relpats_eht</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#116237 - Puyo - Tue Jan 23, 2007 4:17 pm</h4>
    <div class="postbody"><span class="postbody">Do you turn it on? Something like: </span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">REG_IPC_FIFO_CR = IPC_FIFO_ENABLE | IPC_FIFO_SEND_CLEAR;</td> </tr></table><span class="postbody">
<br/>
Because your code should work. And read Chris Double tutorials if you want to understand fifo.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#116239 - Mighty Max - Tue Jan 23, 2007 4:41 pm</h4>
    <div class="postbody"><span class="postbody">If i understand it correctly, IF is not updated when a interrupt occures when IME is disabled.
<br/>
<br/>
This leads to the problem: If you are handling an IRQ on the target side, at the moment the source sends something, the IRQ gets not issued on the other side, as IME is set to 0 in the default interrupt Dispatcher.
<br/>
<br/>
Thus your fifo is never touched on the target side
<br/>
<br/>
See <a href="http://devkitpro.cvs.sourceforge.net/devkitpro/libnds/source/common/interruptDispatcher.s?revision=1.9&amp;view=markup" target="_blank">http://devkitpro.cvs.sourceforge.net/devkitpro/libnds/source/common/interruptDispatcher.s?revision=1.9&amp;view=markup</a>
<br/>
Line  74 disables irqs, and line 144 enables it again. All code inbetween these points (including your irq handlers) is unable to receive or remember any irq request.
<br/>
<br/>
The I-Flag should instead be used, so the CPU won't jump to the new irq, while we are handling the last, but still remembers that an irq happened in the meanwhile.<br/>_________________<br/><a class="postlink" href="http://mightymax.org/gbamp_multiboot.html" target="_blank">GBAMP Multiboot</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#116254 - relpats_eht - Tue Jan 23, 2007 6:25 pm</h4>
    <div class="postbody"><span class="postbody">Puyo: Yes, I do turn FIFO on via code similar to the following on both processors.</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">REG_IPC_FIFO_CR = IPC_FIFO_ENABLE | IPC_FIFO_SEND_CLEAR | IPC_FIFO_RECV_IRQ;
<br/>
irqSet(IRQ_FIFO_NOT_EMPTY, fifoHandler);
<br/>
irqEnable(IRQ_FIFO_NOT_EMPTY);</td> </tr></table><span class="postbody"> Also, I have read Chris Double's tutorials on the subject.
<br/>
<br/>
Mighty Max: That may be true, but what are the odds of my IRQ being sent at that exact time thousands of times in sequence? In any case, what is the I-Flag and how would I use it?<br/>_________________<br/>- relpats_eht</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#116255 - Mighty Max - Tue Jan 23, 2007 6:50 pm</h4>
    <div class="postbody"><span class="postbody">The odds are not really bad, i.e. if you try to send something in the arm9 vblank, the arm7 might be in vblank too and vice versa.
<br/>
<br/>
The PSR bit is documented in the arm references. But i wouldnt recommend playing with it, if you don't knowit allready. There is an easier workaround available:
<br/>
<br/>
Enable the ipc sync irq  on both sides and issue an sync irq on the other side everytime you have been waiting for some time and nothing happens. This ipc sync should cause you to check the fifo in the same way as the fifo not empty irq. This way you can "politly remember" the other side if he didnt "hear" the other irqs.<br/>_________________<br/><a class="postlink" href="http://mightymax.org/gbamp_multiboot.html" target="_blank">GBAMP Multiboot</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#116262 - relpats_eht - Tue Jan 23, 2007 9:20 pm</h4>
    <div class="postbody"><span class="postbody">Thank you, MightyMax, that fixed the problem.<br/>_________________<br/>- relpats_eht</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
