<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>trying to get all the files - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>DS development > trying to get all the files</h2>
<div id="posts">
<div class="post">
    <h4>#110725 - Lick - Fri Dec 01, 2006 12:15 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void getFileListRecursive(char *filter) {
<br/>
   freeFileList();
<br/>
    u32 depth = 0;
<br/>
    
<br/>
   int type = FAT_FindFirstFileLFN(fileName);
<br/>
    
<br/>
   while(1)
<br/>
    {        
<br/>
        if(type == FT_NONE)
<br/>
        {
<br/>
            if(depth == 0)
<br/>
                return;
<br/>
            else
<br/>
            {
<br/>
                FAT_chdir("..");
<br/>
                depth--;
<br/>
                type = FAT_FindNextFileLFN(fileName);
<br/>
                continue;
<br/>
            }
<br/>
        }
<br/>
        else if(type == FT_DIR)
<br/>
        {
<br/>
            strcat(fileName, "/");
<br/>
            if(FAT_chdir(fileName)) 
<br/>
            {
<br/>
                depth++;
<br/>
                type = FAT_FindFirstFileLFN(fileName);
<br/>
                continue;
<br/>
            }
<br/>
        }
<br/>
        else if(type == FT_FILE)
<br/>
        {
<br/>
          addFile(type, fileName, filter);
<br/>
        }
<br/>
        
<br/>
        type = FAT_FindNextFileLFN(fileName);
<br/>
   }
<br/>
}
<br/>
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
This code somehow hangs. Anyone see anything weird about it?<br/>_________________<br/><a class="postlink" href="http://licklick.wordpress.com" target="_blank">http://licklick.wordpress.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#110734 - gmiller - Fri Dec 01, 2006 1:15 am</h4>
    <div class="postbody"><span class="postbody">Is "filter" somehow used to get the "filename"?  Is there some init function that needs to be called with "filter" to set the selection mask?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#110737 - josath - Fri Dec 01, 2006 2:25 am</h4>
    <div class="postbody"><span class="postbody">perhaps FindFile stuff gets reset after a chdir?
<br/>
<br/>
So say you read files in this order:
<br/>
<br/>
/blah.txt -&gt; addFile
<br/>
/someDir/ -&gt; chdir(someDir)
<br/>
/someDir/another.txt -&gt; addfile
<br/>
NONE -&gt; chdir(..)
<br/>
<br/>
at this point, it will start listing the files in / again, from the begining?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#110764 - Mighty Max - Fri Dec 01, 2006 10:44 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
                FAT_chdir("..");
<br/>
                depth--;
<br/>
                type = FAT_FindNextFileLFN(fileName);
<br/>
                continue; 
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
This code will not resume searching from where you left the directory.
<br/>
You have to use FindFirstFileLFN again and iterate through until you come to the point where you left the dir and continue from there.<br/>_________________<br/><a class="postlink" href="http://mightymax.org/gbamp_multiboot.html" target="_blank">GBAMP Multiboot</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#110776 - chishm - Fri Dec 01, 2006 1:47 pm</h4>
    <div class="postbody"><span class="postbody">Yet another reason I rewrote gba_nds_fat to libfat. FindFirstFile and FindNextFile are not reentrant. Worst still, calling any other function which works with file or directory names (chdir, fopen) will overwrite te FindNextFile data.<br/>_________________<br/><a class="postlink" href="http://chishm.drunkencoders.com" target="_blank">http://chishm.drunkencoders.com</a>
<br/>
<a class="postlink" href="http://dldi.drunkencoders.com" target="_blank">http://dldi.drunkencoders.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#110806 - tepples - Fri Dec 01, 2006 8:52 pm</h4>
    <div class="postbody"><span class="postbody">So how do I take advantage of it? If it requires compiling devkitARM pre-R20 from CVS, do you have a step-by-step guide to doing this on Microsoft Windows?<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#110829 - Lick - Sat Dec 02, 2006 12:32 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void getFileListRecursive(char *filter) {
<br/>
//---------------------------------------------------------------------------------
<br/>
   freeFileList();
<br/>
    u32 depth = 0;
<br/>
    u32 position[32] = {0};
<br/>
    
<br/>
   int type = FAT_FindFirstFile(fileName);
<br/>
    
<br/>
   while(1)
<br/>
    {        
<br/>
        if(type == FT_NONE)
<br/>
        {
<br/>
            if(depth == 0)
<br/>
                return;
<br/>
            else
<br/>
            {
<br/>
                FAT_chdir("..");
<br/>
                depth--;
<br/>
                type = FAT_FindFirstFile(fileName);
<br/>
                for(u32 i=0; i&lt;position[depth]; i++)
<br/>
                    type = FAT_FindNextFile(fileName);
<br/>
                continue;
<br/>
            }
<br/>
        }
<br/>
        else if(type == FT_DIR)
<br/>
        {
<br/>
            position[depth]++;
<br/>
            FAT_chdir(fileName);
<br/>
            depth++;
<br/>
            type = FAT_FindFirstFile(fileName);
<br/>
            position[depth] = 0;
<br/>
            continue;
<br/>
        }
<br/>
        else if(type == FT_FILE)
<br/>
        {
<br/>
            position[depth]++;
<br/>
          addFile(type, fileName, filter);
<br/>
        }
<br/>
        
<br/>
        type = FAT_FindNextFile(fileName);
<br/>
   }
<br/>
}
<br/>
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I added (unoptimized) position memorization, but it's still hanging. Why?!<br/>_________________<br/><a class="postlink" href="http://licklick.wordpress.com" target="_blank">http://licklick.wordpress.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#110832 - Lick - Sat Dec 02, 2006 12:45 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">//---------------------------------------------------------------------------------
<br/>
// Returns all FILES that include filter
<br/>
void getFileListRecursive(char *filter) {
<br/>
//---------------------------------------------------------------------------------
<br/>
   freeFileList();
<br/>
    u32 depth = 0;
<br/>
    u32 position[32] = {0};
<br/>
    
<br/>
   int type = FAT_FindFirstFile(fileName);
<br/>
   
<br/>
   while(1)
<br/>
    {        
<br/>
        if(type == FT_NONE)
<br/>
        {
<br/>
            if(depth == 0)
<br/>
                return;
<br/>
            else
<br/>
            {
<br/>
                FAT_chdir("..");
<br/>
                depth--;
<br/>
                type = FAT_FindFirstFile(fileName);
<br/>
                for(u32 i=0; i&lt;position[depth]; i++)
<br/>
                    type = FAT_FindNextFile(fileName);
<br/>
                continue;
<br/>
            }
<br/>
        }
<br/>
        else if(type == FT_DIR)
<br/>
        {
<br/>
            position[depth]++;
<br/>
            if(strcmp(fileName, ".")!=0 &amp;&amp; strcmp(fileName, "..")!=0)
<br/>
            {                
<br/>
                FAT_chdir(fileName);
<br/>
                depth++;
<br/>
                type = FAT_FindFirstFile(fileName);
<br/>
                position[depth] = 0;
<br/>
                continue;
<br/>
            }
<br/>
        }
<br/>
        else if(type == FT_FILE)
<br/>
        {            
<br/>
            position[depth]++;
<br/>
          addFile(type, fileName, filter);
<br/>
        }
<br/>
        
<br/>
        type = FAT_FindNextFile(fileName);
<br/>
   }
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
<span style="font-size: 18px; line-height: normal">It works! </span> Thanks to davr giving me advice on printing the results instead of just taking wild guesses, I found that the code hang at "." and ".."! I didn't take those stupid relative directories into account when debugging. BLEEEGH!!<br/>_________________<br/><a class="postlink" href="http://licklick.wordpress.com" target="_blank">http://licklick.wordpress.com</a></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
