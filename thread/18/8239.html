<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Coding in ASM - how? - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > Coding in ASM - how?</h2>
<div id="posts">
<div class="post">
    <h4>#68218 - HyperHacker - Mon Jan 23, 2006 3:05 am</h4>
    <div class="postbody"><span class="postbody">It's been my plan for a while to write some emulators for the DS... however given the CPU-intensive nature of emulation, I imagine it might be better to code in ARM/Thumb ASM. The question is how? Like what do I have to put in my source files for the assembler to accept it properly, and what do I assemble it with? (I have DevkitPro, which I imagine must include an assembler...) I've done programs in raw ASM on the old Gameboy (Z80; in fact, all my GB programs were ASM) but it was with a very simplified assembler, basically you just had to do this:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">CPU GBZ80
<br/>
FNAME "something.gbc"
<br/>
whatever: EQU $C000
<br/>
ld a,whatever
<br/>
ldi (hl),a
<br/>
etc etc etc</td> </tr></table><span class="postbody">
<br/>
In most other ASM source I find I see all this .section and .bss and such, and I have no idea what any of that's supposed to mean...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#68223 - El Hobito - Mon Jan 23, 2006 3:23 am</h4>
    <div class="postbody"><span class="postbody">check out the hexends source code i believe thats got some assembler in it</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#68234 - sajiimori - Mon Jan 23, 2006 3:54 am</h4>
    <div class="postbody"><span class="postbody">Also try writing some things in C and compiling them with -S to see how they're implemented in assembly.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#68236 - DekuTree64 - Mon Jan 23, 2006 4:15 am</h4>
    <div class="postbody"><span class="postbody">Here's a very basic assembly function that you can put into a .s file and compile:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">.text
<br/>
.arm
<br/>
.align 2
<br/>
.global ThisIsAFunction
<br/>
ThisIsAFunction:
<br/>
bx lr</td> </tr></table><span class="postbody">
<br/>
Which can then be externed in a .c file like so, and called like a normal function:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">extern void ThisIsAFunction();</td> </tr></table><span class="postbody">
<br/>
Or if it's in a .cpp file, you'll need to tell the compiler that the function's name isn't mangled:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">extern "C" void ThisIsAFunction();</td> </tr></table><span class="postbody">
<br/>
If you want to pass arguments into a function, they go into r0-r3. Arguments above that go onto the stack, which is kind of complicated so just keep it to 4 args or less for now.
<br/>
<br/>
r0 is the return value for the function, so if you want to add 2 numbers together and return the result, you could do something like:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">.text
<br/>
.arm
<br/>
.align 2
<br/>
.global AddSomeNumbers
<br/>
AddSomeNumbers:
<br/>
add r0, r0, r1    @ r0 and r1 are the first 2 args passed 
<br/>
bx lr             @ in, and r0 is the return value</td> </tr></table><span class="postbody">
<br/>
And the C prototype would look something like this:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">extern int AddSomeNumbers(int number1, int number2);</td> </tr></table><span class="postbody">
<br/>
Pretty straightforward. Just start writing some code and you'll get the hang of it in no time :)<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#68238 - Dwedit - Mon Jan 23, 2006 4:58 am</h4>
    <div class="postbody"><span class="postbody">For an example of a well-written emulator, read the source code to an open-source GBA emulator, such as PocketNES, Goomba, SMSAdvance, or Foon.<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#68239 - HyperHacker - Mon Jan 23, 2006 5:04 am</h4>
    <div class="postbody"><span class="postbody">Oh, you can include ASM source files? I knew you could have it inline... How do you do this, just write the code in a .s file and #include it?
<br/>
<br/>
Also why does every message board ever made get flood control wrong? Editing isn't posting! -_-</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#68241 - DekuTree64 - Mon Jan 23, 2006 5:28 am</h4>
    <div class="postbody"><span class="postbody">No, don't #include it in a .c file, that's no different than just typing the assembly code in the .c file in the first place. Compile the .s file by itself, either by calling as.exe directly, or calling gcc on it and letting that figure out it's an assembly file by the extension.
<br/>
<br/>
The nice thing about calling gcc is that if you name it with an uppercase .S extension, it will run the C preprocessor on it before passing down to as.exe.<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#68255 - agentq - Mon Jan 23, 2006 10:22 am</h4>
    <div class="postbody"><span class="postbody">An example of inline assembler can be found in the ScummVM source code.  Do a search for asm in all the files to find it, I'm sorry I don't have access to the code base at the moment to tell you exactly where it is.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#68306 - Ethos - Mon Jan 23, 2006 6:16 pm</h4>
    <div class="postbody"><span class="postbody">Also this source has asm files, gasm compatible...
<br/>
<br/>
<a class="postlink" href="http://ethos.oddigytitanium.com/dsboy/DSBoy0.1.zip" target="_blank"> Here </a><br/>_________________<br/><a class="postlink" href="http://ethos.oddigytitanium.com" target="_blank">Ethos' Homepage (Demos/NDS 3D Tutorial)</a></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
