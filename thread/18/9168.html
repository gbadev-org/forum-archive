<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>-mcpu=arm946e-s (Anyone help?) - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > -mcpu=arm946e-s (Anyone help?)</h2>
<div id="posts">
<div class="post">
    <h4>#78695 - acox - Sun Apr 09, 2006 12:37 am</h4>
    <div class="postbody"><span class="postbody">I have some inline assembly that uses a v5 ARM instruction.
<br/>
<br/>
If I stick with the default arm920T flags, gcc barfs over the instruction.
<br/>
<br/>
If I set the cpu as in the topic of this post, linking fails as many people must have seen before (reproduced below).
<br/>
<br/>
I obv. am not using VFPU instructions and in fact I can live without any floating point at all if that could fix me problem.
<br/>
<br/>
Can anyone help me either:
<br/>
<br/>
1) Trick gcc into letting the v5 instruction pass while compiling for 920T.
<br/>
<br/>
2) Make the arm946e-s target work.
<br/>
<br/>
Thanks a lot.
<br/>
Andrew
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
$ make
<br/>
linking fixed.elf
<br/>
j:\devkitpro\devkitarm\bin\..\lib\gcc\arm-elf\4.0.2\..\..\..\..\arm-elf\bin\ld.e
<br/>
xe: ERROR: main.o uses VFP instructions, whereas k:/my_devkitPro/fixed/fixed.elf
<br/>
 does not
<br/>
j:\devkitpro\devkitarm\bin\..\lib\gcc\arm-elf\4.0.2\..\..\..\..\arm-elf\bin\ld.e
<br/>
xe: failed to merge target specific data of file main.o
<br/>
make[1]: *** [/k/my_devkitPro/fixed/fixed.elf] Error 1
<br/>
make: *** [build] Error 2
<br/>
</td> </tr></table><span class="postbody"><br/>_________________<br/><a class="postlink" href="http://www.btinternet.com/~ahcox/GBA/" target="_blank">3D on GBA</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#78709 - DekuTree64 - Sun Apr 09, 2006 1:49 am</h4>
    <div class="postbody"><span class="postbody">I'm also interested in this. I managed to get it working by using ld to link instead of g++, but then I can't use C++, and I haven't been able to get any standard libraries to link properly with that. Not that I really want to use either those anyway, but still.
<br/>
<br/>
As for a temporary workaround, you can look up the opcodes in the ARM architecture reference manual (I have a pdf I could email you if you can't find it, PM me) and encode them manually, just like .word 0x12345678. Not that bad if you make macros for them.<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#78715 - acox - Sun Apr 09, 2006 2:58 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>DekuTree64 wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
As for a temporary workaround, you can look up the opcodes in the ARM architecture reference manual (I have a pdf I could email you if you can't find it, PM me) and encode them manually, just like .word 0x12345678. Not that bad if you make macros for them.</td> </tr></table><span class="postbody">
<br/>
<br/>
Thanks, tried this and nothing barfs even when I stuck junk into the instruction stream. Only problem I have is that all my registers were being assigned for me by gcc, but with this method I'll have to pin two down. But if nothing better comes along this will save my bacon.
<br/>
<br/>
I got the ARM ARM recently. I think it is Samsung that have it online among the docs for one of their ARM SOCs.<br/>_________________<br/><a class="postlink" href="http://www.btinternet.com/~ahcox/GBA/" target="_blank">3D on GBA</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#80044 - acox - Tue Apr 18, 2006 7:32 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>DekuTree64 wrote:</b></span></td> </tr> <tr> <td class="quote">I'm also interested in this. I managed to get it working by using ld to link instead of g++, but then I can't use C++, and I haven't been able to get any standard libraries to link properly with that. Not that I really want to use either those anyway, but still.
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I stirred the flags a number of ways and got a clean compile with the following ( even the "clz" v5 instruction in the assembly without encoding it in hex):
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
ARCH   :=   -marm -mthumb-interwork \
<br/>
-march=armv5te
<br/>
</td> </tr></table><span class="postbody">
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
<br/>
CFLAGS   :=   -g -Wall -O2\
<br/>
         -mtune=arm946e-s -mhard-float -mfpu=fpe2 -fomit-frame-pointer\
<br/>
         -ffast-math \
<br/>
         $(ARCH)
<br/>
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I don't know yet if this will make valid fpu code though.<br/>_________________<br/><a class="postlink" href="http://www.btinternet.com/~ahcox/GBA/" target="_blank">3D on GBA</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#80124 - wintermute - Wed Apr 19, 2006 12:26 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#---------------------------------------------------------------------------------
<br/>
# options for code generation
<br/>
#---------------------------------------------------------------------------------
<br/>
ARCH   :=   -mthumb -mthumb-interwork \
<br/>
         -march=armv5te -mtune=arm946e-s -Wa,-mfpu=fpa 
<br/>
<br/>
CFLAGS   :=   -save-temps -g -Wall -O2\
<br/>
          -fomit-frame-pointer\
<br/>
         -ffast-math \
<br/>
         $(ARCH)
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
allows everything to link.
<br/>
<br/>
Note the -Wa,-mfpu=fpa - this passes the parameter to the assembler, forcing it to mark the output as hard fpa while leaving the compiler in the default soft float ( but marked as hard ) . You don't want these parameters being used on the compiler as it will generate hardware floating point instructions.
<br/>
<br/>
The built code works on hardware.
<br/>
<br/>
I need to do a bit more testing on this and determine the best way to solve this whole issue. It might involve adding another set of libraries to the multilib options so we have both vfp and fpa marked libraries to link against.<br/>_________________<br/><a class="postlink" href="http://www.devkitpro.org/" target="_blank">devkitPro - professional toolchains at amateur prices</a>
<br/>
<a class="postlink" href="http://wiki.devkitpro.org/index.php/IRC" target="_blank">devkitPro IRC support</a>
<br/>
<a class="postlink" href="http://davejmurphy.com/" target="_blank">Personal Blog</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#80133 - acox - Wed Apr 19, 2006 2:30 am</h4>
    <div class="postbody"><span class="postbody">Thanks. I was about to ask what the set of options to compile soft but mark hard was on the other topic.
<br/>
<br/>
This combination builds for me :).<br/>_________________<br/><a class="postlink" href="http://www.btinternet.com/~ahcox/GBA/" target="_blank">3D on GBA</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#87884 - wintermute - Fri Jun 16, 2006 6:14 am</h4>
    <div class="postbody"><span class="postbody">You'll be happy to know that the recent move to eabi fixes all this nonsense and -march=armv5te -mtune=arm946e-s now does what it says on the tin :)<br/>_________________<br/><a class="postlink" href="http://www.devkitpro.org/" target="_blank">devkitPro - professional toolchains at amateur prices</a>
<br/>
<a class="postlink" href="http://wiki.devkitpro.org/index.php/IRC" target="_blank">devkitPro IRC support</a>
<br/>
<a class="postlink" href="http://davejmurphy.com/" target="_blank">Personal Blog</a></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
