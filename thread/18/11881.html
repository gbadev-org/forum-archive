<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>A question about array allocation, new and C vs. C++ - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > A question about array allocation, new and C vs. C++</h2>
<div id="posts">
<div class="post">
    <h4>#111322 - OOPMan - Tue Dec 05, 2006 6:12 pm</h4>
    <div class="postbody"><span class="postbody">Hey there, something I'm working on looks like, at a future point, it may
<br/>
require the use of dynamically-sized arrays.
<br/>
<br/>
Now, if I recall, this is easy enough to do in C++ as follows:
<br/>
<br/>
int *blah = new int[somenumber];
<br/>
<br/>
However, I'd like to avoid using C++, in case the compiler decides to try and link in the C++ libs, etc...
<br/>
<br/>
So, can I do the above in C using malloc(), or is there some trick to it?
<br/>
<br/>
Alternatively, could I just go ahead and use the C++ method without any performance worries since the only actually piece of C++ I need is the new and delete operators in this context.
<br/>
<br/>
Or have I gotten C++ completely mixed up with Java with regards to basic array allocation? (For some reason I keep getting this feeling...)<br/>_________________<br/>"My boot, your face..." - Attributed to OOPMan, Emperor of Eroticon VI
<br/>
<br/>
You can find my NDS homebrew projects <a class="postlink" href="http://blog.dev-scene.com/oopman/" target="_blank">here...</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#111325 - Mighty Max - Tue Dec 05, 2006 6:21 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>OOPMan wrote:</b></span></td> </tr> <tr> <td class="quote">int *blah = new int[somenumber];
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
int *blah = (int *)malloc(somenumber * sizeof(int)) ;
<br/>
<br/>
Or basically
<br/>
#define NEW(size,type) (type *)malloc((size) * sizeof(type))
<br/>
<br/>
PS: Dont forget to do a free() instead of delete. After allocating via malloc.<br/>_________________<br/><a class="postlink" href="http://mightymax.org/gbamp_multiboot.html" target="_blank">GBAMP Multiboot</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#111327 - kusma - Tue Dec 05, 2006 6:23 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
*int blah = new int[somenumber];
<br/>
</td> </tr></table><span class="postbody">
<br/>
is practically identical to:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
*int blah = (int *)malloc(sizeof(int) * somenumber);
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#111330 - OOPMan - Tue Dec 05, 2006 6:31 pm</h4>
    <div class="postbody"><span class="postbody">Right, okay, thanks for that guys. One more question on this...
<br/>
<br/>
If I recall, in C++ you can then access blah using the array method, as opposed to using pointer math...
<br/>
<br/>
Will this be possible in C as well?<br/>_________________<br/>"My boot, your face..." - Attributed to OOPMan, Emperor of Eroticon VI
<br/>
<br/>
You can find my NDS homebrew projects <a class="postlink" href="http://blog.dev-scene.com/oopman/" target="_blank">here...</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#111331 - Lick - Tue Dec 05, 2006 6:35 pm</h4>
    <div class="postbody"><span class="postbody">I think C++ learned that feature (pointer as array access) from C. So yes.<br/>_________________<br/><a class="postlink" href="http://licklick.wordpress.com" target="_blank">http://licklick.wordpress.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#111335 - OOPMan - Tue Dec 05, 2006 6:45 pm</h4>
    <div class="postbody"><span class="postbody">Okay, thanks.
<br/>
<br/>
My C is *really* rusty. Bloody universities are all about C++ and Java nowadays, so my C is more than 4 years out of practise :-)<br/>_________________<br/>"My boot, your face..." - Attributed to OOPMan, Emperor of Eroticon VI
<br/>
<br/>
You can find my NDS homebrew projects <a class="postlink" href="http://blog.dev-scene.com/oopman/" target="_blank">here...</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#111336 - sirpoonga - Tue Dec 05, 2006 6:45 pm</h4>
    <div class="postbody"><span class="postbody">I haven't worked in C or C++ for years.  What is the advantage of using a pointer to the array instead of just saying int blah[somenumber];?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#111337 - OOPMan - Tue Dec 05, 2006 6:47 pm</h4>
    <div class="postbody"><span class="postbody">Is there an advantage? 
<br/>
<br/>
I guess the disadvantage would be that you can fry the memory in an environment that allocates memory in a funny way.
<br/>
<br/>
Is this actually a problem on the DS, though?
<br/>
<br/>
I mean, there's no MMU, so does memory ever get mapped non-linearly for things like arrays or malloc()s?<br/>_________________<br/>"My boot, your face..." - Attributed to OOPMan, Emperor of Eroticon VI
<br/>
<br/>
You can find my NDS homebrew projects <a class="postlink" href="http://blog.dev-scene.com/oopman/" target="_blank">here...</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#111345 - kusma - Tue Dec 05, 2006 7:23 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>sirpoonga wrote:</b></span></td> </tr> <tr> <td class="quote">I haven't worked in C or C++ for years.  What is the advantage of using a pointer to the array instead of just saying int blah[somenumber];?</td> </tr></table><span class="postbody">
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
int blah[somenumber];
<br/>
</td> </tr></table><span class="postbody">
<br/>
is non-standard (at least not supported in c89 - the newest well-supported c-standard).
<br/>
<br/>
Edit: non-standard as long as somenumber is a variable and not a constant, that is.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#111348 - OOPMan - Tue Dec 05, 2006 7:36 pm</h4>
    <div class="postbody"><span class="postbody">I thought C99 was considered well-supported now?<br/>_________________<br/>"My boot, your face..." - Attributed to OOPMan, Emperor of Eroticon VI
<br/>
<br/>
You can find my NDS homebrew projects <a class="postlink" href="http://blog.dev-scene.com/oopman/" target="_blank">here...</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#111354 - sajiimori - Tue Dec 05, 2006 7:52 pm</h4>
    <div class="postbody"><span class="postbody">Use dynamic allocation when it's appropriate.  Here are some possible reasons:
<br/>
<br/>
- You don't know the size of the array until runtime.
<br/>
<br/>
- You don't know how many arrays you want until runtime.
<br/>
<br/>
- You don't want to have the allocation take up memory all the time; only when it's needed.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#111365 - OOPMan - Tue Dec 05, 2006 9:58 pm</h4>
    <div class="postbody"><span class="postbody">Mmmmmm, good points to keep in mind saja. Dynamic allocation is all good, as long as you keep a tight handle on the deallocation end of things, since memory leaks are not a good thing :-)
<br/>
<br/>
On the plus side, I guess bare-metal DS software doesn't always need to clean up certain allocated resources, since the system is reset when loading new software :-)
<br/>
<br/>
EDIT: Now that I think about it, this thread is kind of in the wrong forum. Should have probably been in C/C++. My bad :-(<br/>_________________<br/>"My boot, your face..." - Attributed to OOPMan, Emperor of Eroticon VI
<br/>
<br/>
You can find my NDS homebrew projects <a class="postlink" href="http://blog.dev-scene.com/oopman/" target="_blank">here...</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#111368 - sajiimori - Tue Dec 05, 2006 10:43 pm</h4>
    <div class="postbody"><span class="postbody">RAII makes memory leaks all but extinct.  I used to think garbage collection was the only way dynamic allocation could be safe, but my tune has changed with a better understanding of C++.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#111379 - kusma - Wed Dec 06, 2006 1:29 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>OOPMan wrote:</b></span></td> </tr> <tr> <td class="quote">I thought C99 was considered well-supported now?</td> </tr></table><span class="postbody">
<br/>
<br/>
Nope, there's really only a few compilers who implement larger portions of C99. Neither msvc nor gcc - arguably the two most commonly used C compilers - support more than just a sub-set of the C99-functionality. And in the embedded world it's even worse.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#111406 - OOPMan - Wed Dec 06, 2006 8:31 am</h4>
    <div class="postbody"><span class="postbody">I guess that's beauracracy for you. Someone makes a standard and it then takes 15 years for it to be implemented widely :-)<br/>_________________<br/>"My boot, your face..." - Attributed to OOPMan, Emperor of Eroticon VI
<br/>
<br/>
You can find my NDS homebrew projects <a class="postlink" href="http://blog.dev-scene.com/oopman/" target="_blank">here...</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#111426 - masscat - Wed Dec 06, 2006 12:14 pm</h4>
    <div class="postbody"><span class="postbody">There is also:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void *calloc(size_t nmemb, size_t size);</td> </tr></table><span class="postbody">
<br/>
Which allocates memory for 'nmemb' number of elements of size 'size'.
<br/>
<br/>
Some things to consider when using dynamic allocation other than leaking memory.
<br/>
It is not immediately obvious at build time the memory footprint of the program. On the DS this is important as, unlike a PC, you have rather limited memory resources.
<br/>
You have to cope with the case where the allocation fails in a pleasant manner. If this is not be possible then you have to stop the cases where memory will become exhausted from happening.
<br/>
There is an overhead in the call. If you are using it in time critical code think about redesigning your code to move the allocation outside the fast bit.
<br/>
The memory heap can become fragmented meaning that you cannot allocate sufficient memory in a single continuous block. This depends on the allocation algorithm of the malloc call, the way you arrange your <span style="font-style: italic">malloc</span> and <span style="font-style: italic">free</span> calls and the relative lifespans of the allocated memory blocks. If you are doing lots of allocation and deallocation it may be better to allocated a block of memory and then write your own allocation and deallocation functions to operate on this.
<br/>
<br/>
In general, on the DS and other similar limited resource systems give more thought to how your use of dynamic allocation will impact the system.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>sirpoonga wrote:</b></span></td> </tr> <tr> <td class="quote">What is the advantage of using a pointer to the array instead of just saying int blah[somenumber];?</td> </tr></table><span class="postbody">
<br/>
Some of it is programming style, some people like thinking using pointers.
<br/>
One nice thing about being able to use pointers as arrays is that it is very easy to lay an array over a block of memory.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">struct some_struct *a_ptr = (struct some_struct *)some_mem_address;
<br/>
for ( a number of times) {
<br/>
  /* do something to a_ptr[index] element */
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
<span style="font-weight: bold">EDIT:</span> wrongly assigned the quote to sajiimori, apologies.</span><span class="gensmall"><br/><br/>Last edited by masscat on Wed Dec 06, 2006 9:50 pm; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#111457 - sajiimori - Wed Dec 06, 2006 7:02 pm</h4>
    <div class="postbody"><span class="postbody">masscat, you misquoted me.  ;)
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">It is not immediately obvious at build time the memory footprint of the program. On the DS this is important as, unlike a PC, you have rather limited memory resources.</td> </tr></table><span class="postbody">This is important on PC as well, believe me!  I'm not sure how the myth got started that you don't need to think about memory on a PC, but it sure seems like a popular one.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">You have to cope with the case where the allocation fails in a pleasant manner.</td> </tr></table><span class="postbody">All my games assert on the success of memory allocations.  I don't know of any games that try to recover.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">If you are doing lots of allocation and deallocation it may be better to allocated a block of memory and then write your own allocation and deallocation functions to operate on this.</td> </tr></table><span class="postbody">This is only worth doing if you know something that malloc doesn't, and you can take advantage of it to reduce fragmentation or otherwise solve a problem.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">...on the DS and other similar limited resource systems...</td> </tr></table><span class="postbody">Where do I get one of these implied <span style="font-style: italic">unlimited</span> resource systems?  ;)
<br/>
<br/>
About pointers and arrays: It's better to think of arrays as degrading to pointers when you use them.  a[i] is *(a+i).</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#111474 - sirpoonga - Wed Dec 06, 2006 9:38 pm</h4>
    <div class="postbody"><span class="postbody">Well, you guys certainly answered my question :)
<br/>
Like I said, it's been a long time since I did C and C++. You guys just jogged my memory on why you'd want an array pointer, dynamic allocation.  Thanks.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
