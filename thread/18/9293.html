<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>SCSD DMA? - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > SCSD DMA?</h2>
<div id="posts">
<div class="post">
    <h4>#80115 - linus - Tue Apr 18, 2006 10:07 pm</h4>
    <div class="postbody"><span class="postbody">Does anyone know if SCSD has DMA and if it does do we know how to use it? Its not in chishms driver so I assume nobodies found it but do we know if its there? Any info is helpful cheers.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#80119 - tepples - Tue Apr 18, 2006 11:02 pm</h4>
    <div class="postbody"><span class="postbody">The SD cards generally operate by bit-banging directly on the SPI lines.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#158626 - SoLo2 - Sun Jun 15, 2008 2:20 am</h4>
    <div class="postbody"><span class="postbody">Hello!
<br/>
<br/>
<br/>
I see in Chishm's "C" code that these lines
<br/>
are addressed at 0x040001A0 and 0x040001B0.
<br/>
The registers for SPI actually start at 4000180h.
<br/>
These I know by the only references available:
<br/>
GBATEK.
<br/>
<br/>
Then I see that the card requires some commands: 
<br/>
5 and up to 8 bytes are written to 0x040001A8:
<br/>
40001A8h - NDS7/NDS9 - Gamecard bus 8-byte Command Out
<br/>
<br/>
Has anybody specifications of these 
<br/>
card commands? :)
<br/>
<br/>
Is this the same method for reading/writing
<br/>
sectors to SuperCards for the GBA?
<br/>
<br/>
Maybe the GBA used DMA, it didn't seem
<br/>
so difficult as for the NDS...
<br/>
<br/>
<br/>
Greetings,
<br/>
SoLo2<br/>_________________<br/>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<br/>
Visit:
<br/>
<a href="http://thebitsclub.tripod.com" target="_blank">http://thebitsclub.tripod.com</a>
<br/>
<a href="http://biis.tripod.com" target="_blank">http://biis.tripod.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#158628 - tepples - Sun Jun 15, 2008 2:28 am</h4>
    <div class="postbody"><span class="postbody">Are you talking about SuperCard SD (SLOT-2) or SuperCard DS One (SLOT-1)?<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#158639 - elhobbs - Sun Jun 15, 2008 1:30 pm</h4>
    <div class="postbody"><span class="postbody">doesn't the supercard site have some code downloads? I think I remember looking at that once - I may be think of another card though.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#158649 - SoLo2 - Sun Jun 15, 2008 7:28 pm</h4>
    <div class="postbody"><span class="postbody">Hello!
<br/>
<br/>
<br/>
The talk is about SC DS ONE, mainly.
<br/>
But there must be some card read/write
<br/>
code for the other cards, too.
<br/>
<br/>
Do you know the real site URL of
<br/>
the Super Card creators?
<br/>
I think they should have the drivers,
<br/>
or the command codes.
<br/>
<br/>
<br/>
Greetings,
<br/>
SoLo2<br/>_________________<br/>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<br/>
Visit:
<br/>
<a href="http://thebitsclub.tripod.com" target="_blank">http://thebitsclub.tripod.com</a>
<br/>
<a href="http://biis.tripod.com" target="_blank">http://biis.tripod.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#158705 - Mohammad - Mon Jun 16, 2008 6:13 pm</h4>
    <div class="postbody"><span class="postbody">no SCSD stands for Supercard SD, which is slot-2
<br/>
<br/>
edit: supercard website supercard.cn</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#158713 - SoLo2 - Mon Jun 16, 2008 7:53 pm</h4>
    <div class="postbody"><span class="postbody">Hello!
<br/>
<br/>
<br/>
Sorry, talk is about SC SD, slot-2.
<br/>
<br/>
Are there any specifications for this cartridge? 
<br/>
Does it use control commands over an SPI bus, too?
<br/>
<br/>
I remember it to be more easy, more DMA alike.
<br/>
<br/>
<br/>
Greetings,
<br/>
SoLo2<br/>_________________<br/>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<br/>
Visit:
<br/>
<a href="http://thebitsclub.tripod.com" target="_blank">http://thebitsclub.tripod.com</a>
<br/>
<a href="http://biis.tripod.com" target="_blank">http://biis.tripod.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#158715 - Maxxie - Mon Jun 16, 2008 8:07 pm</h4>
    <div class="postbody"><span class="postbody">The SC SD needs to generate a clock signal by "hand"
<br/>
<br/>
I don't think you can do this with profit with DMA. (you might be able to by preparing a special buffer that includes these clock generation on writes, but that would be more expensive then the actual write)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#158849 - SoLo2 - Thu Jun 19, 2008 12:25 pm</h4>
    <div class="postbody"><span class="postbody">Hello!
<br/>
<br/>
<br/>
I see in Moonshell code and also in gbatek.txt
<br/>
that DMA3 of the NDS could be something like
<br/>
linus asked. It looks like it is THE DMA channel
<br/>
to read/write(?) from ROM cartridges...
<br/>
<br/>
Look at:
<br/>
moonshell15_src/arm9/source/extmem.cpp
<br/>
it has a _wish_, at least for EZ4, to be able
<br/>
to use DMA3 for the purpose.
<br/>
<br/>
Confirmation?
<br/>
:)
<br/>
<br/>
<br/>
Greetings,
<br/>
SoLo2<br/>_________________<br/>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<br/>
Visit:
<br/>
<a href="http://thebitsclub.tripod.com" target="_blank">http://thebitsclub.tripod.com</a>
<br/>
<a href="http://biis.tripod.com" target="_blank">http://biis.tripod.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#158851 - SoLo2 - Thu Jun 19, 2008 12:38 pm</h4>
    <div class="postbody"><span class="postbody">Hello!
<br/>
<br/>
<br/>
As I read more of it, here is more of it...
<br/>
<br/>
An excerpt of source file
<br/>
moonshell15_src/arm9/source/extmem.cpp
<br/>
uses:
<br/>
<br/>
<br/>
      SetSC_UNLOCK(SSC_SDRAM);
<br/>
      MemCopy16DMA3(pSrcData,pDstData,DstSize);
<br/>
      SetSC_UNLOCK(SSC_CF);
<br/>
<br/>
<br/>
Where SetSC_UNLOCK() is an ugly function
<br/>
writing to the last word of the 32MB of the
<br/>
cartridge ROM... 
<br/>
<br/>
While MemCopy16DMA3() to be found in
<br/>
moonshell15_src/arm9/source/memtool.cpp
<br/>
says:
<br/>
<br/>
<br/>
    DMA3_SRC = (uint32)_src;
<br/>
    DMA3_DEST = (uint32)_dst;
<br/>
    DMA3_CR = DMA_ENABLE | DMA_SRC_INC | DMA_DST_INC | DMA_16_BIT | (prcdiv&gt;&gt;1);
<br/>
    while(DMA3_CR &amp; DMA_BUSY);
<br/>
   [...]
<br/>
<br/>
<br/>
And uses the DMA3 channel for the purpose
<br/>
of writing to the cartridge FLASH, supposedly.
<br/>
<br/>
I haven't working further into it, as I had the
<br/>
wish to use the known SPI command controled,
<br/>
bus controled way of read/write, just to see
<br/>
if it works, first.
<br/>
<br/>
<br/>
Greetings,
<br/>
SoLo2<br/>_________________<br/>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<br/>
Visit:
<br/>
<a href="http://thebitsclub.tripod.com" target="_blank">http://thebitsclub.tripod.com</a>
<br/>
<a href="http://biis.tripod.com" target="_blank">http://biis.tripod.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#158852 - Maxxie - Thu Jun 19, 2008 12:52 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>SoLo2 wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
Where SetSC_UNLOCK() is an ugly function
<br/>
writing to the last word of the 32MB of the
<br/>
cartridge ROM... 
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
It's changing the control register which part of the hardware occupies the addressrange.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
And uses the DMA3 channel for the purpose
<br/>
of writing to the cartridge FLASH, supposedly.
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
This is not what it does. it is writing to the previously mapped SDRAM (volatile memory) and then switches the hardware back to a mode where the SD-Card hardware can be accessed again.
<br/>
<br/>
SDRAM: volatile RAM, accessed by directly accessing GBA address space
<br/>
SD-Card: non-volatile flash memory, accessed by a serial interface indirectly through some few registers within GBA address space.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#158864 - SoLo2 - Thu Jun 19, 2008 7:48 pm</h4>
    <div class="postbody"><span class="postbody">Hello!
<br/>
<br/>
<br/>
<br/>
Another possibility is in the file
<br/>
moonshell15_src/arm9/source/directdisk.cpp
<br/>
<br/>
This has the function:
<br/>
<br/>
static inline void Flashw8(u32 adr,u8 data)
<br/>
{
<br/>
  GBACartRAM[0x5555]=0xaa; // to CMD1
<br/>
  GBACartRAM[0x2aaa]=0x55; // to CMD2
<br/>
  GBACartRAM[0x5555]=0xa0; // to PROGRAM
<br/>
  GBACartRAM[adr]=data;
<br/>
}
<br/>
<br/>
Which supposedly writes to a Flash memory,
<br/>
and using some commands. As if it were the SPI,
<br/>
but it isn't.
<br/>
<br/>
CartWrite_AutoSelect() uses a call to Flashw8().
<br/>
And CartFormat() uses CartWrite_AutoSelect().
<br/>
<br/>
But these could be functions for the GBA Flash
<br/>
memory cart, instead of the NDS.
<br/>
<br/>
<br/>
<br/>
Greetings,
<br/>
SoLo2<br/>_________________<br/>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<br/>
Visit:
<br/>
<a href="http://thebitsclub.tripod.com" target="_blank">http://thebitsclub.tripod.com</a>
<br/>
<a href="http://biis.tripod.com" target="_blank">http://biis.tripod.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#158866 - SoLo2 - Thu Jun 19, 2008 8:02 pm</h4>
    <div class="postbody"><span class="postbody">Hello!
<br/>
<br/>
<br/>
Finally, there is a 4th method in this
<br/>
fantastic moonshell source code.
<br/>
<br/>
It is by calling: active_interface-&gt;fn_ReadSectors()
<br/>
<br/>
which uses and interface and then the
<br/>
functions fn_ReadSectors() or fn_WriteSectors()
<br/>
<br/>
And these lead to :
<br/>
<br/>
moonshell15_src/arm9/source/gba_nds_fat_2006-02-09_unicode_M3SD_ReadAlignDetect/ThirdPartyDriver/SCDS.cpp
<br/>
<br/>
which is again the way of using SPI bus 
<br/>
with control commands to read/write.
<br/>
As used by libFAT and dldi drivers.
<br/>
<br/>
Unlock remains the funny writing to the 
<br/>
32MB end Word with:
<br/>
<br/>
0x09FFFFFE;
<br/>
    *unlockAddress = 0xA55A ;
<br/>
    *unlockAddress = 0xA55A ;
<br/>
    *unlockAddress = 0x3 ;
<br/>
    *unlockAddress = 0x3 ;
<br/>
<br/>
:)
<br/>
<br/>
With control commands like: 
<br/>
0x34 to read
<br/>
0x35 to write
<br/>
...
<br/>
<br/>
not defined anywhere except in this driver!
<br/>
<br/>
<br/>
<br/>
Greetings,
<br/>
SoLo2<br/>_________________<br/>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<br/>
Visit:
<br/>
<a href="http://thebitsclub.tripod.com" target="_blank">http://thebitsclub.tripod.com</a>
<br/>
<a href="http://biis.tripod.com" target="_blank">http://biis.tripod.com</a></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
