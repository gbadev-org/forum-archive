<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>libfat to access slot1 AND slot2 - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>DS development > libfat to access slot1 AND slot2</h2>
<div id="posts">
<div class="post">
    <h4>#118543 - thing - Wed Feb 14, 2007 4:43 am</h4>
    <div class="postbody"><span class="postbody">Hello,
<br/>
<br/>
First of all, I'm new to NDS and development and libfat so please take this into account :)
<br/>
<br/>
I'm playing with libfat and I managed to do basic stuff like printing the contents of a directory (huray!) So my next step was to play a bit with partitions and try to list the root of a DSX on slot1 AND a SCL on slot2. For that I've written a basic app that mainly does the following:
<br/>
<br/>
1. call 'fatInitDefault()'
<br/>
- this should mount slot1 (default) and slot2, right?
<br/>
<br/>
2. call 'diropen("fat0:/")' and use 'dirnext()' to interact over structure
<br/>
<br/>
3. call 'diropen("fat1:/")' and use 'dirnext()' exactly like in step '2'.
<br/>
<br/>
4. call 'fatUnmount()' to unmount the devices
<br/>
<br/>
(should I post the source? - it's full of debug printouts right now...)
<br/>
<br/>
<br/>
On DSX (with or without DLDI patch)
<br/>
- step 1 OK
<br/>
- step 2 OK: dump slot1 contents
<br/>
- step 3 Not OK: dump slot1 contents too!
<br/>
- step 4 OK
<br/>
<br/>
On SCL (with DLDI patch)
<br/>
- step1 OK
<br/>
- step2 Not OK: dump slot2 contents (shouldn't it be slot1?)
<br/>
- step3 Not OK: 'diropen()' call fails
<br/>
- step4 Not Ok: fails to unmount 'PI_SLOT_1'
<br/>
<br/>
<br/>
So, what am I missing to get the two carts working altogether?  And how can I apply DLDI patch for, say, DSX AND SCL??
<br/>
<br/>
Thanks a lot for the help,
<br/>
Thing</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#118549 - chishm - Wed Feb 14, 2007 5:10 am</h4>
    <div class="postbody"><span class="postbody">You actually want fat1:/ for Slot-1 and fat2:/ for Slot-2. fat0:/ is the same as fat:/, which will depend on the whichever device mounted first or was set as the default.<br/>_________________<br/><a class="postlink" href="http://chishm.drunkencoders.com" target="_blank">http://chishm.drunkencoders.com</a>
<br/>
<a class="postlink" href="http://dldi.drunkencoders.com" target="_blank">http://dldi.drunkencoders.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#118554 - thing - Wed Feb 14, 2007 6:04 am</h4>
    <div class="postbody"><span class="postbody">Oooups!! :)
<br/>
<br/>
Thanks, Chishm!
<br/>
Now I'm getting the proper device identification through:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">char *_getDeviceType(char *partition, char *device) {
<br/>
  struct stat st;
<br/>
  if(stat(partition, &amp;st) == 0) {
<br/>
    strncpy(device, (char *)&amp;st.st_dev, 4);
<br/>
    device[4] = '\0';
<br/>
  } else {
<br/>
    // Something went wrong
<br/>
    strcpy(device, "N/A");
<br/>
  }
<br/>
  return device;
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
But I'm still having the DLDI patching problem: If I patch the app with SCL DLDI, DSX in slot1 is not recognized; if I patch the app with DSX DLDI, SCL is not properly identified, etc...
<br/>
<br/>
How should I patch an app that is supposed to access the two devices?
<br/>
<br/>
Thanks!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#118556 - chishm - Wed Feb 14, 2007 6:43 am</h4>
    <div class="postbody"><span class="postbody">Unfortunately there's no way to do it. That's one of the current limitations of DLDI.<br/>_________________<br/><a class="postlink" href="http://chishm.drunkencoders.com" target="_blank">http://chishm.drunkencoders.com</a>
<br/>
<a class="postlink" href="http://dldi.drunkencoders.com" target="_blank">http://dldi.drunkencoders.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#118558 - thing - Wed Feb 14, 2007 7:07 am</h4>
    <div class="postbody"><span class="postbody">Hmm... Okay... 
<br/>
It was a fun start anyway :)
<br/>
<br/>
Well, my initial idea was to try copying files from one device to another... any  idea if a pre-DLDI libfat could do that?
<br/>
<br/>
Thanks.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#118564 - Diddl - Wed Feb 14, 2007 8:52 am</h4>
    <div class="postbody"><span class="postbody">For this DLDI must be redesigned. You have to allocate memory for two possible driver (DLDI slot1, DLDI slot) and you need two different idetnification strigs (Chishm1/Chishm2). The DLDI driver itself knows if it is for slot 1 or 2, I think I saw a flag for this.
<br/>
<br/>
The DLDI patch program has to look into the choosen DLDI file if it is written for slot1 or slot2 and patch the correct memory slot.
<br/>
<br/>
LIBFAT must be changed to look into both memory slots ...
<br/>
<br/>
### 
<br/>
<br/>
many work for Chishm ...  ;)
<br/>
<br/>
but I think it's feasible and it would be very nice!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#118565 - Diddl - Wed Feb 14, 2007 8:59 am</h4>
    <div class="postbody"><span class="postbody">After this it would be nice do code a "midnight commander for NDS". With copy/rename/move function between slot 1 and slot 2 or between different directories.
<br/>
<br/>
Maybe with FTP connect ...
<br/>
<br/>
Maybe with link to another DS over Wifi ...
<br/>
<br/>
Maybe with Firelink support! Firelink is a Slot 2 Modul which comes with this DS Linker card (slot 1 solution). Firelink has a USB connector and could connect to a PC, a external harddisk, a photo camera, a printer ...
<br/>
<br/>
Maybe with DSerial Suport. This would be the USB connector for slot 1 ...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#118567 - OOPMan - Wed Feb 14, 2007 9:12 am</h4>
    <div class="postbody"><span class="postbody">I noticed the Firelink myself recently. It looks cool, kinda like a DS-X but with 1 gigabyte of memory, as opposed to 512 mebabytes. Still, there's no trace of any kind of FAT drivers, source or anything on the site.
<br/>
<br/>
I'd mark it as dodgy until that's cleared up...<br/>_________________<br/>"My boot, your face..." - Attributed to OOPMan, Emperor of Eroticon VI
<br/>
<br/>
You can find my NDS homebrew projects <a class="postlink" href="http://blog.dev-scene.com/oopman/" target="_blank">here...</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#118570 - chishm - Wed Feb 14, 2007 9:40 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>thing wrote:</b></span></td> </tr> <tr> <td class="quote">Well, my initial idea was to try copying files from one device to another... any  idea if a pre-DLDI libfat could do that?</td> </tr></table><span class="postbody">
<br/>
libfat can do that now, with the condition being that at least one of the slots use one of the built in drivers (MPCF, SCCF, SCSD, M3CF, M3SD, NJSD, NMMC).
<br/>
<br/>
Diddl: It doesn't need 2 identification strings, but the patcher would need a slight modification.<br/>_________________<br/><a class="postlink" href="http://chishm.drunkencoders.com" target="_blank">http://chishm.drunkencoders.com</a>
<br/>
<a class="postlink" href="http://dldi.drunkencoders.com" target="_blank">http://dldi.drunkencoders.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#118571 - Diddl - Wed Feb 14, 2007 9:43 am</h4>
    <div class="postbody"><span class="postbody">It is a wonderful solution for developer. You only need to compile, upload and test. Without any laod/unload card and such things.
<br/>
<br/>
<br/>
There are old gba_nds_fat sources and a DLDI file for it. Moonshell and DS organizer works fine. But there is only read support for it in the moment. Allegedly there is a lib with write support provided from ncard, search for "NCard fatio" in google ...
<br/>
<br/>
There are over 5 companies which provide exactly the same hardware under different names: DS linker, MK5 from NeoFlash, NCard, DS Firecard, PIRATECARD ...   all this are exactly the same. You can change the firmware as desired.
<br/>
<br/>
PIRATECARD ist on of the cheapest. The 16G costs GBP44.90, the 2GB card GBP24.90. You don't need a additional TF or SD card. look at PIRACY-DOT-NET.
<br/>
<br/>
<span style="font-weight: bold">[Product name and web site removed by MOD because the manufacturer's web site carries pirated ROMs]</span></span><span class="gensmall"><br/><br/>Last edited by Diddl on Wed Feb 14, 2007 9:51 am; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#118572 - Diddl - Wed Feb 14, 2007 9:46 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>chishm wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
libfat can do that now, with the condition being that at least one of the slots use one of the built in drivers (MPCF, SCCF, SCSD, M3CF, M3SD, NJSD, NMMC).</td> </tr></table><span class="postbody">
<br/>
<br/>
oh, so it should be no problem, cause most people use a SC or a M3 solution for slot 2. :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#118589 - thing - Wed Feb 14, 2007 1:17 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Diddl wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>chishm wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
libfat can do that now, with the condition being that at least one of the slots use one of the built in drivers (MPCF, SCCF, SCSD, M3CF, M3SD, NJSD, NMMC).</td> </tr></table><span class="postbody">
<br/>
<br/>
oh, so it should be no problem, cause most people use a SC or a M3 solution for slot 2. :)</span></td> </tr></table><span class="postbody">
<br/>
<br/>
That might be a silly question, but in my case I have a DSX and SCL... Well, the SCL does need to be patched, but the DSX seems to work fine with the built in drivers (at least it doesn't need a patch). So doesn't this setup qualify for the "condition being at least one of the slots using the built in drivers"?
<br/>
<br/>
Launching from DSX, if I patch with SCL DLDI it just hangs at 'fatInitDefault()'; and with no patch or DSX patch it gets slot1 for 'fat1' and 'fat2'.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#118590 - chishm - Wed Feb 14, 2007 1:27 pm</h4>
    <div class="postbody"><span class="postbody">The DS-X is special. It does it's own internal patching, and overwrites the original libfat drivers with it's own when you load a file. Unfortunately, this causes weird problems, as you described.<br/>_________________<br/><a class="postlink" href="http://chishm.drunkencoders.com" target="_blank">http://chishm.drunkencoders.com</a>
<br/>
<a class="postlink" href="http://dldi.drunkencoders.com" target="_blank">http://dldi.drunkencoders.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#118593 - thing - Wed Feb 14, 2007 1:55 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>chishm wrote:</b></span></td> </tr> <tr> <td class="quote">The DS-X is special. It does it's own internal patching, and overwrites the original libfat drivers with it's own when you load a file. Unfortunately, this causes weird problems, as you described.</td> </tr></table><span class="postbody">
<br/>
<br/>
Ahh... ok. 
<br/>
Good to know, thanks... So I guess I've picked the wrong devices... ;)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#118596 - cory1492 - Wed Feb 14, 2007 2:26 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>OOPMan wrote:</b></span></td> </tr> <tr> <td class="quote">I noticed the Firelink myself recently. It looks cool, kinda like a DS-X but with 1 gigabyte of memory, as opposed to 512 mebabytes. Still, there's no trace of any kind of FAT drivers, source or anything on the site.
<br/>
<br/>
I'd mark it as dodgy until that's cleared up...</td> </tr></table><span class="postbody">
<br/>
I read the DSLinker/Neo MK5 dldi drivers work with the Firelink, quite possibly the USB protocols (gamepad/mousepad apps) that were sourced as well. The DLDI is read only though...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#118602 - Diddl - Wed Feb 14, 2007 3:20 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>cory1492 wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
... quite possibly the USB protocols (gamepad/mousepad apps) that were sourced as well...</td> </tr></table><span class="postbody">
<br/>
<br/>
Right, this source are also available now. but much to my regret the USB removable drive source is not available. 
<br/>
<br/>
I was in hope I can use firelink for my other slot 1 solutions also.
<br/>
<br/>
But now it's clear, fireline uses for USB a standard chip from Philips: ISP1581 - I have downloaded the datasheet so maybe I can access it from own code.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#118638 - HyperHacker - Thu Feb 15, 2007 1:14 am</h4>
    <div class="postbody"><span class="postbody">Will future versions of libFAT provide the ability to patch in two drivers?<br/>_________________<br/>I'm a PSP hacker now, but I still &lt;3 DS.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#118647 - thing - Thu Feb 15, 2007 2:27 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>HyperHacker wrote:</b></span></td> </tr> <tr> <td class="quote">Will future versions of libFAT provide the ability to patch in two drivers?</td> </tr></table><span class="postbody">
<br/>
<br/>
That would be very nice :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#118658 - OOPMan - Thu Feb 15, 2007 9:16 am</h4>
    <div class="postbody"><span class="postbody">Er, correct me if I'm wrong, but isn't libfat's current support for SLOT-2 devices pretty complete? I mean, most of them work with both read and write access, right?
<br/>
<br/>
So....
<br/>
<br/>
Why do we need to be able to patch two drivers in?
<br/>
<br/>
What I mean is, new SLOT-2 devices will probably be rare output now and hence the current SLOT-2 support level is probably pretty much fine. 
<br/>
<br/>
In other words, for people with one device, SLOT-1 or SLOT-2, the DLDI stuff is great. For people with two devices, a SLOT-1 *and* a SLOT-2, the current DLDI+old drivers is still pretty usable, right...?
<br/>
<br/>
Or am I missing something?
<br/>
<br/>
I was under the impression that at present one can use two devices pretty easily in the form of *some* SLOT-1 solution (Excluding that naughty DS-X anyway) and a supported SLOT-2 solution...
<br/>
<br/>
I guess having two drivers patchable-in would be consistent though, which is a good reason I suppose :-)
<br/>
<br/>
Blah :-)<br/>_________________<br/>"My boot, your face..." - Attributed to OOPMan, Emperor of Eroticon VI
<br/>
<br/>
You can find my NDS homebrew projects <a class="postlink" href="http://blog.dev-scene.com/oopman/" target="_blank">here...</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#118662 - Diddl - Thu Feb 15, 2007 9:44 am</h4>
    <div class="postbody"><span class="postbody">you are right. but who says there will no more slot 2 solution in future?
<br/>
<br/>
and of course, the code will be smaller if there is no unused io-driver code in  it ...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#118708 - dantheman - Thu Feb 15, 2007 10:52 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>OOPMan wrote:</b></span></td> </tr> <tr> <td class="quote">I was under the impression that at present one can use two devices pretty easily in the form of *some* SLOT-1 solution (Excluding that naughty DS-X anyway) and a supported SLOT-2 solution...</td> </tr></table><span class="postbody">
<br/>
<br/>
The DS-X team recently released a DS-X DLDI file, and despite some slight issues in the first one, Chishm and a DS-X coder worked together to improve both the DLDI file itself and the way libfat handles certain processes regarding initialization (okay, I'm not a coder, I'm not entirely sure what got fixed).  But the point is, from what I can tell, the DS-X actually helped improve the entire DLDI system as a whole.  
<br/>
<br/>
I read on their forums that DS-X users can now use NitroTracker perfectly, which was impossible earlier, among other homebrew programs that were giving them issues previously.
<br/>
<br/>
That's not to say that I like the product.  Just wanted to bring some recent happenings to your attention.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#118739 - OOPMan - Fri Feb 16, 2007 9:37 am</h4>
    <div class="postbody"><span class="postbody">Nice catch dan :-)
<br/>
<br/>
I was mainly referring to the problems experienced by a previous dev in this thread...
<br/>
<br/>
It's nice to hear that DS-X users are getting better compatibility now. Still, their dodgy in-stream driver patching didn't help for a while :-)<br/>_________________<br/>"My boot, your face..." - Attributed to OOPMan, Emperor of Eroticon VI
<br/>
<br/>
You can find my NDS homebrew projects <a class="postlink" href="http://blog.dev-scene.com/oopman/" target="_blank">here...</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#118747 - kusma - Fri Feb 16, 2007 11:29 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>dantheman wrote:</b></span></td> </tr> <tr> <td class="quote">okay, I'm not a coder, I'm not entirely sure what got fixed
<br/>
</td> </tr></table><span class="postbody">
<br/>
What got fixed was unaligned access to the card.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>dantheman wrote:</b></span></td> </tr> <tr> <td class="quote">But the point is, from what I can tell, the DS-X actually helped improve the entire DLDI system as a whole.  
<br/>
</td> </tr></table><span class="postbody">
<br/>
Some unhandled error codes and a clarity-issue in the documentation was spotted. No "big" things were improved AFAIK.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
