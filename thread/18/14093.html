<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>interlockin' (ARM9 pipeline optimizations) - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > interlockin' (ARM9 pipeline optimizations)</h2>
<div id="posts">
<div class="post">
    <h4>#139576 - DekuTree64 - Fri Sep 07, 2007 6:23 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>In <a class="postlink" href="http://forum.gbadev.org/viewtopic.php?p=139540#139540" target="_blank">this post</a>, kusma wrote:</b></span></td> </tr> <tr> <td class="quote">...and there you lost the single cycle-beauty of SMLAWx, it's only single-cycle if you don't use the result in the next instruction :)</td> </tr></table><span class="postbody">
<br/>
Oops, nice catch :)
<br/>
The first 2 are ok, since the accumulate term isn't accessed until the second cycle, but the last 2 will indeed interlock. I think it would be good to get it working using this version though, then we can go and reorder things to avoid that. r12 and r14 are still unused, so it should be pretty easy.<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#139582 - simonjhall - Fri Sep 07, 2007 7:40 pm</h4>
    <div class="postbody"><span class="postbody">I can't remember who told me, but I thought that in the DS implementation of the ARM ISA instructions didn't have any latency? As in the units within the chip weren't pipelined - for instance, if you did add $1 $2 $3, $1 would be ready to use in the next instruction without any hazards (although it wouldn't necessarily be in the next clock cycle).
<br/>
<br/>
If you can't use the result of a SMLAWx in the next instruction, does this mean that other instructions have similar latencies? How about loads and stores? I know that they take a long time, but am I going to gain anything by pipelining loads and stores?
<br/>
<br/>
&lt;/off topic&gt;<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#139586 - tepples - Fri Sep 07, 2007 8:29 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>simonjhall wrote:</b></span></td> </tr> <tr> <td class="quote">I can't remember who told me, but I thought that in the DS implementation of the ARM ISA instructions didn't have any latency?</td> </tr></table><span class="postbody">
<br/>
That was true of the ARM7. The ARM9 is a more complicated beast, and it likely has interlocks so that it can speed up the average case while maintaining correctness and not introducing "delay slot" semantics into the architecture like on MIPS.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote"> As in the units within the chip weren't pipelined - for instance, if you did add $1 $2 $3, $1 would be ready to use in the next instruction without any hazards (although it wouldn't necessarily be in the next clock cycle).</td> </tr></table><span class="postbody">
<br/>
Add is also one of the "16 simple ALU operations".
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">If you can't use the result of a SMLAWx in the next instruction, does this mean that other instructions have similar latencies?</td> </tr></table><span class="postbody">
<br/>
A multiply-add is much more complicated than an add.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">How about loads and stores? I know that they take a long time, but am I going to gain anything by pipelining loads and stores?</td> </tr></table><span class="postbody">
<br/>
All I can suggest here is profile it and see. I used to do this a lot back in the GBA days when I had more time to spare (didn't have to entertain little cousins, didn't have a housemate's talk radio eating up my concentration, etc.).<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#139589 - DekuTree64 - Fri Sep 07, 2007 8:44 pm</h4>
    <div class="postbody"><span class="postbody">Tepples: Maybe split this to a seperate topic to discuss ARM9 cycle times?
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>simonjhall wrote:</b></span></td> </tr> <tr> <td class="quote">I can't remember who told me, but I thought that in the DS implementation of the ARM ISA instructions didn't have any latency?</td> </tr></table><span class="postbody">
<br/>
AFAIK, it's a feature of the ARM9 core, and can't be changed.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">If you can't use the result of a SMLAWx in the next instruction, does this mean that other instructions have similar latencies? How about loads and stores?</td> </tr></table><span class="postbody">
<br/>
Yep. Loads take 3 cycles, but are effectively single-cycle if you don't use the result right away. I ran some tests on this before to verify it. I can't remember how it interacts with waitstates though...
<br/>
<br/>
Since store has no result, I think it's pretty much always single-cycle, at least when using the write buffer, or if the data being written to is in the cache or DTCM. It may stall if it actually has to wait for memory to finish writing though.<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#139592 - simonjhall - Fri Sep 07, 2007 9:41 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tepples wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>simonjhall wrote:</b></span></td> </tr> <tr> <td class="quote">I can't remember who told me, but I thought that in the DS implementation of the ARM ISA instructions didn't have any latency?</td> </tr></table><span class="postbody">
<br/>
That was true of the ARM7. The ARM9 is a more complicated beast, and it likely has interlocks so that it can speed up the average case while maintaining correctness and not introducing "delay slot" semantics into the architecture like on MIPS.</span></td> </tr></table><span class="postbody">Ah ok. I remember documentation about the ARM9 saying how it has a five-stage pipeline (versus the three- on the '7) but I've never heard anyone talking about pipelining code in order to avoid stalls.
<br/>
Also if you look at the assembled output of a program at a first glance it seems that there's no pipelining of the code going on. If indeed there are RAW hazards from loads is there any chance of some compiler switch which'll allow you to set how long you expect a read to take? (allowing the compiler to schedule a big gap until the result of the load is used, eg for slow memory)
<br/>
<br/>
So if you say that add is one of the 16 fast operations, is there a list somewhere saying what takes how long?
<br/>
<br/>
EDIT: <a href="http://infocenter.arm.com/help/index.jsp?topic=/com.arm.doc.ddi0240b/ch01s01s01.html" target="_blank">http://infocenter.arm.com/help/index.jsp?topic=/com.arm.doc.ddi0240b/ch01s01s01.html</a> and <a href="http://infocenter.arm.com/help/topic/com.arm.doc.ddi0240b/DDI0240A.pdf" target="_blank">http://infocenter.arm.com/help/topic/com.arm.doc.ddi0240b/DDI0240A.pdf</a><br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#139604 - tepples - Sat Sep 08, 2007 1:57 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>simonjhall wrote:</b></span></td> </tr> <tr> <td class="quote">Also if you look at the assembled output of a program at a first glance it seems that there's no pipelining of the code going on. If indeed there are RAW hazards from loads is there any chance of some compiler switch which'll allow you to set how long you expect a read to take? (allowing the compiler to schedule a big gap until the result of the load is used, eg for slow memory)</td> </tr></table><span class="postbody">
<br/>
You could start with the <a class="postlink" href="http://gcc.gnu.org/onlinedocs/gcc-4.1.2/gcc/Optimize-Options.html" target="_blank">optimizer section of the GCC 4.1.x manual</a>. The option -fschedule-insns2 appears to do what you ask for; -O2 is supposed to enable this. (-O3 makes inlining too aggressive for my tastes.) Adding -fweb -frename-registers might allow the use of more registers to hide load delays if your algorithm is memory-bound rather than register-bound.
<br/>
<br/>
How do you have -march and -mtune set up? The makefile from the devkitARM DS templates recommends -march=armv5te -mtune=arm946e-s.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">So if you say that add is one of the 16 fast operations, is there a list somewhere saying what takes how long?</td> </tr></table><span class="postbody">
<br/>
I was referring to the <a class="postlink" href="http://nocash.emubase.de/gbatek.htm#thumb4aluoperations" target="_blank">Thumb type 4 instructions</a> and their ARM counterparts.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
