<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>ASM - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>DS development > ASM</h2>
<div id="posts">
<div class="post">
    <h4>#77351 - ProblemBaby - Thu Mar 30, 2006 3:57 pm</h4>
    <div class="postbody"><span class="postbody">Hello
<br/>
<br/>
I want to optimize some code. First Ive to ask about the arm7...
<br/>
All arm7 code have to be putted in some kind of IWRAM do this mean that all arm7 code is in arm-mode? if not is it like for the GBA some memory that executes arm code better?
<br/>
<br/>
And Ive the same question for arm9, where should i put arm code to get the best performence?
<br/>
<br/>
Last I just want to make sure that this is the correct values to measure performence (in percent with two decimals) so Usage = 100 means 1%
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
REG_TM3D = 0;
<br/>
REG_TM3CNT = 0x81;
<br/>
<br/>
// Some code
<br/>
<br/>
Usage = REG_TM3D;
<br/>
REG_TM3CNT = 0;
<br/>
Usage = (((Usage&lt;&lt;6)*10000) / 1123584);
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#77363 - acox - Thu Mar 30, 2006 5:39 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>ProblemBaby wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
All arm7 code have to be putted in some kind of IWRAM do this mean that all arm7 code is in arm-mode? if not is it like for the GBA some memory that executes arm code better?
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Your ARM7 code can be ARM or thumb as you like. The problem with the 4MB EWRAM on the DS is that only one processor can access it at a time. It has to be locked. So the default is to put all ARM 7 code in the 64KB IWRAM.
<br/>
You can see this here:
<br/>
devkitPro/devkitARM/arm-elf/lib/ds_arm7.ld
<br/>
<br/>
I don't think there is anywhere even better you can put your ARM7 code.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
And Ive the same question for arm9, where should i put arm code to get the best performence?
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Since we have a cache now on DS, maybe the default is fine. But there is a fast chunk of memory for code: the <span style="font-weight: bold">ITCM</span>. Use section <span style="font-weight: bold">itcm</span> to get your code in there.
<br/>
<br/>
There is also a fast place for data, called <span style="font-weight: bold">DTCM</span> and accessed with the <span style="font-weight: bold">dtcm</span> section similarly.<br/>_________________<br/><a class="postlink" href="http://www.btinternet.com/~ahcox/GBA/" target="_blank">3D on GBA</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#77389 - ProblemBaby - Thu Mar 30, 2006 11:08 pm</h4>
    <div class="postbody"><span class="postbody">Thanks for the answer, just want to make sure...
<br/>
1.
<br/>
do the 64kb IWRAM for the arm7 executes arm code faster then thumb code?
<br/>
<br/>
2. is ITCM and DTCM only accessable by the arm9?
<br/>
<br/>
3. When using DTCM or (any kind of RAM). is it possible to allocate and free in asm? I need a quite big and fast accesable buffer.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#77390 - DekuTree64 - Thu Mar 30, 2006 11:17 pm</h4>
    <div class="postbody"><span class="postbody">IWRAM has a 32-bit bus, so access time for ARM and THUMB instructions is the same, and ARM can generally do more work in the same number of instructions so it will win.
<br/>
<br/>
For ARM9, the cache does help a lot with running ARM code from main RAM, but main RAM is so slow it may still be faster to use THUMB anyway. I haven't done any profiling to verify though, and all the games I've worked on used ARM pretty much exclusively.
<br/>
<br/>
EDIT: Dang it, you edited your post while I was typing :)
<br/>
<br/>
2. Yes, ITCM and DTCM are ARM9-only. Also, you can store data in ITCM if you want, but executing and loading from it at the same time will stall one cycle. You can't execute from DTCM, but using it solves the stalling problem.
<br/>
<br/>
3. Depends entirely on your engine. Normally the stack is in DTCM, so just creating a local array will allocate some of it. Or you can make a large global array in DTCM and write a memory manager to manage dynamic allocation in it. Or just use the array like a secondary stack by making a global variable that points into it, and add/subtract from the pointer to push/pop things.<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"><br/><br/>Last edited by DekuTree64 on Thu Mar 30, 2006 11:25 pm; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#77391 - tepples - Thu Mar 30, 2006 11:19 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>ProblemBaby wrote:</b></span></td> </tr> <tr> <td class="quote">do the 64kb IWRAM for the arm7 executes arm code faster then thumb code?</td> </tr></table><span class="postbody">
<br/>
ARM7 IWRAM, ARM9 ITCM, and ARM9 cached memory are all 32-bit 0-wait-state memories and will execute ARM instructions at the same rate as Thumb instructions. However, it usually takes more instructions to express a given algorithm with Thumb instructions than with ARM instructions, so you're better off going with ARM instructions for signal processing inner loops if you can afford the memory.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#77396 - ProblemBaby - Fri Mar 31, 2006 1:39 am</h4>
    <div class="postbody"><span class="postbody">Thanks for the replies.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>DekuTree64 wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
3. Depends entirely on your engine. Normally the stack is in DTCM, so just creating a local array will allocate some of it. Or you can make a large global array in DTCM and write a memory manager to manage dynamic allocation in it. Or just use the array like a secondary stack by making a global variable that points into it, and add/subtract from the pointer to push/pop things.
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Local Stack, how is that done?
<br/>
Then I've to ask is some nice way to make a global buffer without a forced main memory location that is accesable from both processors?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#77398 - DekuTree64 - Fri Mar 31, 2006 2:07 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>ProblemBaby wrote:</b></span></td> </tr> <tr> <td class="quote">Local Stack, how is that done?</td> </tr></table><span class="postbody">
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">u8 *stack = topAddress;
<br/>
<br/>
void Monkey()
<br/>
{
<br/>
    u8 *arrayOf500Bytes;
<br/>
<br/>
    stack -= 500;   // Allocate space on the stack
<br/>
    arrayOf500Bytes = stack;
<br/>
<br/>
    // ... Do stuff
<br/>
<br/>
    stack += 500;    // Free space from the stack
<br/>
}</td> </tr></table><span class="postbody">
<br/>
Although the real advantage is that you don't have to free the data at the end of the function. So like when entering a menu, you can claim some persistent variable space, and keep it until you exit the menu. malloc works too, but I like the simplicity and predictableness of a stack. 
<br/>
<br/>
Usually I keep a stack like this in main RAM, so I can use it for any large local arrays in functions so I don't have to worry about the real stack overflowing. Would be good in DTCM too, so you can use run-time allocation without the overhead and fragmentation risk of a dynamic manager.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Then I've to ask is some nice way to make a global buffer without a forced main memory location that is accesable from both processors?</td> </tr></table><span class="postbody">
<br/>
The easiest way I know is to add variables to the IPC struct, or make a custom shared struct and place it right after IPC so they both know where it is. Then you can make a global array on one processor, and during startup store a pointer to it in the shared data for the other processor to check.<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#77478 - HyperHacker - Sat Apr 01, 2006 6:12 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>DekuTree64 wrote:</b></span></td> </tr> <tr> <td class="quote">The easiest way I know is to add variables to the IPC struct, or make a custom shared struct and place it right after IPC so they both know where it is.</td> </tr></table><span class="postbody">
<br/>
What I do is just add "#ifndef IPC" and "#endif" around the IPC struct definition, then define my own in my header files. You have to keep some things for various code to work though.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
