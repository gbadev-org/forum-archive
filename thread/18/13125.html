<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>typedef struct crashes my rom! - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>DS development > typedef struct crashes my rom!</h2>
<div id="posts">
<div class="post">
    <h4>#127595 - Lotti - Thu May 03, 2007 1:59 pm</h4>
    <div class="postbody"><span class="postbody">here is the code! 
<br/>
<br/>
0 compile errors or warnings
<br/>
<br/>
when i run this rom with no$gba i've got: "the rom-image has crashed"
<br/>
<br/>
when i run this on nds i got black screens.
<br/>
<br/>
this is the code:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
// Includes
<br/>
#include &lt;PA9.h&gt;       // Include for PA_Lib
<br/>
#include &lt;fat.h&gt;
<br/>
<br/>
typedef struct 
<br/>
{
<br/>
   char question[512];
<br/>
   char A[512];
<br/>
   char B[512];
<br/>
   char C[512];
<br/>
   char D[512];
<br/>
   u8   answer;   
<br/>
   u8   done;
<br/>
} entry;
<br/>
<br/>
// Function: main()
<br/>
int main(int argc, char ** argv)
<br/>
{
<br/>
   u8 fatok=0;
<br/>
   u16 totdomande=0;             
<br/>
   entry domande[100];
<br/>
<br/>
   PA_Init();    // Initializes PA_Lib
<br/>
   PA_InitVBL(); // Initializes a standard VBL
<br/>
<br/>
   PA_InitText(1, 0);  // Initialise the text system on the top screen
<br/>
   PA_InitText(0, 0);  // Initialise the text system on the bottom screen
<br/>
   
<br/>
   PA_WaitForVBL();
<br/>
   
<br/>
   PA_OutputText(0,7,11,"Welcome to WWTBAFM!");      
<br/>
   PA_OutputText(1, 0, 0, "Initializing Fat...");
<br/>
<br/>
   if (!fatInitDefault()) //Initialise fat library
<br/>
      {
<br/>
         PA_OutputText(1, 0, 1, "Fat Error");
<br/>
         PA_OutputText(1, 0, 2, "Do you have patched this rom");
<br/>
         PA_OutputText(1, 0, 3, "with the correct DLDI driver?");
<br/>
      }
<br/>
   else
<br/>
        {PA_OutputText(1, 0, 1, "Fat OK!"); fatok=1;}
<br/>
<br/>
<br/>
if (fatok)
<br/>
{   
<br/>
   char filename[] = "/WWTBAFM/questions.txt";   
<br/>
   FILE* file = fopen (filename, "r");   
<br/>
   
<br/>
   if(file==NULL) PA_OutputText(1,0,2,"Unable to open %s", filename);
<br/>
   else 
<br/>
   {
<br/>
     PA_OutputText(1,0,2,"Opening %s", filename);
<br/>
     PA_OutputText(1,0,3,"Loading from file");
<br/>
     char c[512];
<br/>
     while(!feof(file))
<br/>
     { 
<br/>
//crashing part
<br/>
        fgets(domande[totdomande].question, 512, file);
<br/>
        fgets(domande[totdomande].A, 512, file);
<br/>
        fgets(domande[totdomande].B, 512, file);
<br/>
        fgets(domande[totdomande].C, 512, file);
<br/>
        fgets(domande[totdomande].D, 512, file);
<br/>
         fgets(c, 512, file);
<br/>
        domande[totdomande].answer=c[0]-48;
<br/>
        domande[totdomande].done=0;
<br/>
        totdomande++;
<br/>
//end crashing part
<br/>
     }
<br/>
     fclose(file);
<br/>
   
<br/>
     PA_OutputText(1,0,4,"Load Complete!");
<br/>
     PA_OutputText(1,0,5,"Press Start to begin");   
<br/>
     PA_WaitFor(Pad.Newpress.Start);     
<br/>
   
<br/>
   u8 i,j,givenanswer;
<br/>
   u16 correctanswers=0;
<br/>
   for (i=0;i&lt;totdomande;i++)
<br/>
   {
<br/>
      PA_InitText(1, 0);  // Initialise the text system on the top screen
<br/>
      PA_InitText(0, 0);  // Initialise the text system on the bottom screen
<br/>
<br/>
      PA_OutputText(0,1,22,"Correct Answers: %03d", correctanswers);
<br/>
      
<br/>
      do {j=PA_RandMax(totdomande);}
<br/>
      while (domande[j].done==1);
<br/>
      PA_OutputText(1,0,1,"Question N.%03d", i);
<br/>
      PA_BoxText(1, 2, 3, 29, 21, domande[j].question, (29 - 2)*(21 - 3));   
<br/>
      PA_OutputText(0,1,2, "A) %s", domande[j].A);
<br/>
      PA_OutputText(0,1,4, "B) %s", domande[j].B);
<br/>
      PA_OutputText(0,1,6, "X) %s", domande[j].C);
<br/>
      PA_OutputText(0,1,8, "Y) %s", domande[j].D);                  
<br/>
      
<br/>
      givenanswer=0;      
<br/>
      while (givenanswer==0)
<br/>
      {
<br/>
         if (Pad.Newpress.A)  givenanswer=1;
<br/>
          else if (Pad.Newpress.B)  givenanswer=2;
<br/>
          else if (Pad.Newpress.X)  givenanswer=3;
<br/>
         else if (Pad.Newpress.Y)  givenanswer=4;
<br/>
         else givenanswer=0;
<br/>
      }      
<br/>
      domande[j].done=1;
<br/>
      
<br/>
      if (givenanswer==domande[j].answer) correctanswers++;
<br/>
   }         
<br/>
  }
<br/>
}      
<br/>
      
<br/>
   // Infinite loop to keep the program running
<br/>
   while (1)
<br/>
   {
<br/>
      PA_WaitForVBL();
<br/>
   }
<br/>
   
<br/>
   return 0;
<br/>
} // End of main()
<br/>
</td> </tr></table><span class="postbody"><br/>_________________<br/><a href="http://lottisden.blogspot.com/" target="_blank">http://lottisden.blogspot.com/</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#127601 - Lick - Thu May 03, 2007 2:30 pm</h4>
    <div class="postbody"><span class="postbody">Try declaring entry domande[100]; like this:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">static entry domande[100]; </td> </tr></table><span class="postbody"> or </span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">entry *domande = new entry[100];</td> </tr></table><span class="postbody"> or </span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">entry *domande = (entry*)malloc(sizeof(entry) * 100);</td> </tr></table><span class="postbody"><br/>_________________<br/><a class="postlink" href="http://licklick.wordpress.com" target="_blank">http://licklick.wordpress.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#127607 - Lotti - Thu May 03, 2007 3:06 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Lick wrote:</b></span></td> </tr> <tr> <td class="quote">Try declaring entry domande[100]; like this:
<br/>
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">static entry domande[100]; </td> </tr></table><span class="postbody"> or </span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">entry *domande = new entry[100];</td> </tr></table><span class="postbody"> or </span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">entry *domande = (entry*)malloc(sizeof(entry) * 100);</td> </tr></table><span class="postbody"></span></td> </tr></table><span class="postbody">
<br/>
they seems to work. expect for the "new" (that i abitually use) because it isn't declared.. what libreries i have to add to use "new" function?<br/>_________________<br/><a href="http://lottisden.blogspot.com/" target="_blank">http://lottisden.blogspot.com/</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#127610 - tepples - Thu May 03, 2007 3:32 pm</h4>
    <div class="postbody"><span class="postbody">You have to name your files to end in ".cpp" and compile and link with g++ in order for new to work. No, I don't know what triggers linking with g++ in wintermute's build system.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#127617 - Lick - Thu May 03, 2007 4:24 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tepples wrote:</b></span></td> </tr> <tr> <td class="quote"><span style="font-weight: bold">You have to name your files to end in ".cpp" </span>and compile and link with g++ in order for new to work. No, I don't know what triggers linking with g++ in wintermute's build system.</td> </tr></table><span class="postbody">
<br/>
<span style="font-weight: bold">That</span> should do the  trick, but Lotti is using PALib so his Makefiles may not be the same.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#127627 - Rajveer - Thu May 03, 2007 5:49 pm</h4>
    <div class="postbody"><span class="postbody">I haven't had the greatest of luck with the PALib and it's makefile. It seems to do weird things like placing data in DTCM, a problem I had not long ago. I would suggest using libnds without PALib if you can and compiling with one of the template libnds makefiles, it doesn't look like you use alot of different PALib commands, mainly for outputting text and so on. But if you insist on using PALib then sorry I'm of no use!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#127660 - Lotti - Thu May 03, 2007 10:48 pm</h4>
    <div class="postbody"><span class="postbody">well actually i need palib just to output text. then this game will use backgrounds and 2d sprites. i don't know how to code this with libnds. the biggest problem is that there isn't any supereasy tutorial :) but this is another topic of discussion :P i'll try the "new" function with .cpp.
<br/>
<br/>
i tried the other 2 but the program never fills in the structs. they're always blank :\<br/>_________________<br/><a href="http://lottisden.blogspot.com/" target="_blank">http://lottisden.blogspot.com/</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#127695 - tepples - Fri May 04, 2007 3:12 am</h4>
    <div class="postbody"><span class="postbody">There are ways to output text other than palib. Do you know how to draw the alphabet in tiles?<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#127699 - HyperHacker - Fri May 04, 2007 4:42 am</h4>
    <div class="postbody"><span class="postbody">FYI, the problem is you run out of stack space. Your struct is (512*5)+2 = 2562 bytes, and you declare 100 of them (256,200 bytes, ~250.1 KB) as a local variable. Locals get put on the stack and I can assure you the stack is not 250 KB. (Anyone know how big it is?)<br/>_________________<br/>I'm a PSP hacker now, but I still &lt;3 DS.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#127717 - simonjhall - Fri May 04, 2007 7:56 am</h4>
    <div class="postbody"><span class="postbody">normally, 16k :-D<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#127729 - Lotti - Fri May 04, 2007 10:24 am</h4>
    <div class="postbody"><span class="postbody">however it works! i used the new function. structs aren't blank. and i declared 100 of them :P
<br/>
<br/>
thank you for the support. you will see this nice homebrew in the future 2-3 months :)<br/>_________________<br/><a href="http://lottisden.blogspot.com/" target="_blank">http://lottisden.blogspot.com/</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#127742 - Lick - Fri May 04, 2007 12:32 pm</h4>
    <div class="postbody"><span class="postbody">When you use 'static' or simply allocate memory with 'new' or 'malloc', the data is NOT put on the stack. I am not really sure where the 'static' data goes, but allocated data goes into the Main RAM. 
<br/>
<br/>
So congratulations, you're using the Main RAM. :D<br/>_________________<br/><a class="postlink" href="http://licklick.wordpress.com" target="_blank">http://licklick.wordpress.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#127748 - tepples - Fri May 04, 2007 1:34 pm</h4>
    <div class="postbody"><span class="postbody">'static' data goes alongside global variables, that is, in main memory.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#127784 - HyperHacker - Sat May 05, 2007 12:02 am</h4>
    <div class="postbody"><span class="postbody">Doing this:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void DoSomethingCool() {
<br/>
static int foo;
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
is the same as doing this:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">int foo;
<br/>
void DoSomethingCool() {
<br/>
[...]
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
except that in the first case, foo can only be accessed within DoSomethingCool(), and you can have other variables named foo elsewhere. Otherwise it behaves the same: the variable is stored in main memory and retains its value between calls.<br/>_________________<br/>I'm a PSP hacker now, but I still &lt;3 DS.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#127787 - Lotti - Sat May 05, 2007 12:37 am</h4>
    <div class="postbody"><span class="postbody"><a href="http://lotti.altervista.org/" target="_blank">http://lotti.altervista.org/</a>  -&gt; the homebrew that i'm developing.
<br/>
<br/>
pls contribute :)<br/>_________________<br/><a href="http://lottisden.blogspot.com/" target="_blank">http://lottisden.blogspot.com/</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#127790 - Rajveer - Sat May 05, 2007 1:33 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>HyperHacker wrote:</b></span></td> </tr> <tr> <td class="quote">Doing this:
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void DoSomethingCool() {
<br/>
static int foo;
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
is the same as doing this:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">int foo;
<br/>
void DoSomethingCool() {
<br/>
[...]
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
except that in the first case, foo can only be accessed within DoSomethingCool(), and you can have other variables named foo elsewhere. Otherwise it behaves the same: the variable is stored in main memory and retains its value between calls.</span></td> </tr></table><span class="postbody">
<br/>
<br/>
So you can have multiple static variables called "foo" each declared in a separate function but existing globally, and specific foos are called in those functions retaining it's last value (as its "global")?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#127813 - HyperHacker - Sat May 05, 2007 8:40 am</h4>
    <div class="postbody"><span class="postbody">Yes, if you mean what I think you mean. It's as if the compiler simply prepends the function name, so in this case:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">int foo = 42;
<br/>
void DoSomethingCool() {
<br/>
static int foo = 1337;
<br/>
[...]
<br/>
foo = 27;
<br/>
}
<br/>
<br/>
void DoSomethingElse() {
<br/>
static int foo;
<br/>
[...]
<br/>
foo = 69;
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
It's as if you wrote this:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">int foo = 42;
<br/>
int DoSomethingCool_foo = 1337;
<br/>
int DoSomethingElse_foo;
<br/>
<br/>
void DoSomethingCool() {
<br/>
[...]
<br/>
DoSomethingCool_foo = 27;
<br/>
}
<br/>
<br/>
void DoSomethingElse() {
<br/>
[...]
<br/>
DoSomethingElse_foo = 69;
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
I imagine that's how the preprocessor handles it, but I've never checked.<br/>_________________<br/>I'm a PSP hacker now, but I still &lt;3 DS.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#127823 - Lick - Sat May 05, 2007 11:14 am</h4>
    <div class="postbody"><span class="postbody">To use the global variable you use this "::foo". (Not entirely sure if it works in C, but sure it works in C++).<br/>_________________<br/><a class="postlink" href="http://licklick.wordpress.com" target="_blank">http://licklick.wordpress.com</a></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
