<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Determine free file system space? - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>DS development > Determine free file system space?</h2>
<div id="posts">
<div class="post">
    <h4>#104062 - bjoerngiesler - Tue Sep 26, 2006 8:15 am</h4>
    <div class="postbody"><span class="postbody">Is there a way to determine the free file system space on a FAT-formatted card? I haven't found any so far...
<br/>
<br/>
TIA!<br/>_________________<br/><a class="postlink" href="http://giesler.biz/~bjoern/en/sw_dsftp.html" target="_blank">DSFTP homepage</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#104070 - chishm - Tue Sep 26, 2006 10:51 am</h4>
    <div class="postbody"><span class="postbody">Manually or through a library?
<br/>
<br/>
Manually:
<br/>
Scan the FAT and add total the number of empty clusters, then multiply that by the number of bytes per cluster.
<br/>
<br/>
Through a library:
<br/>
Not doable with gba_nds_fat or libfat. Is there even a POSIX function for this?<br/>_________________<br/><a class="postlink" href="http://chishm.drunkencoders.com" target="_blank">http://chishm.drunkencoders.com</a>
<br/>
<a class="postlink" href="http://dldi.drunkencoders.com" target="_blank">http://dldi.drunkencoders.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#104077 - bjoerngiesler - Tue Sep 26, 2006 11:40 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>chishm wrote:</b></span></td> </tr> <tr> <td class="quote">Manually:
<br/>
Scan the FAT and add total the number of empty clusters, then multiply that by the number of bytes per cluster.</td> </tr></table><span class="postbody">
<br/>
<br/>
Right. I had hoped there was a library call for this.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Not doable with gba_nds_fat or libfat. Is there even a POSIX function for this?</td> </tr></table><span class="postbody">
<br/>
<br/>
Well, there is statfs(), which is in BSD and Linux. 
<br/>
<br/>
<a class="postlink" href="http://linux.about.com/library/cmd/blcmdl2_statfs.htm" target="_blank">http://linux.about.com/library/cmd/blcmdl2_statfs.htm</a>
<br/>
<br/>
Not in POSIX, as far as I can see. Since such a call is very useful whether standard or not, would it be a lot of hassle to put it into the library nonetheless?
<br/>
<br/>
EDIT: It's in POSIX after all, it seems: <a class="postlink" href="http://www.rcsnet.net/c5-1.0/doc/html/ManPages/hman2posix/statfs.2posix.html" target="_blank">http://www.rcsnet.net/c5-1.0/doc/html/ManPages/hman2posix/statfs.2posix.html</a>. With a very different definition of struct statfs, though.<br/>_________________<br/><a class="postlink" href="http://giesler.biz/~bjoern/en/sw_dsftp.html" target="_blank">DSFTP homepage</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#104128 - TJ - Tue Sep 26, 2006 6:33 pm</h4>
    <div class="postbody"><span class="postbody">Certainly does seem like the kind of call that belongs in the lib.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#104243 - chishm - Wed Sep 27, 2006 11:30 am</h4>
    <div class="postbody"><span class="postbody">Hmm, it's actually statvfs() now (statfs() is deprecated). Unfortunately it is pretty hard to add functionality to libfat, due to the requirement for calls to go through newlib (eg file listing).<br/>_________________<br/><a class="postlink" href="http://chishm.drunkencoders.com" target="_blank">http://chishm.drunkencoders.com</a>
<br/>
<a class="postlink" href="http://dldi.drunkencoders.com" target="_blank">http://dldi.drunkencoders.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#104296 - tepples - Wed Sep 27, 2006 9:09 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>chishm wrote:</b></span></td> </tr> <tr> <td class="quote"> it is pretty hard to add functionality to libfat, due to the requirement for calls to go through newlib</td> </tr></table><span class="postbody">
<br/>
You could implement things through something like the /proc file system in Linux, where the file system exposes a fake directory (or drive letter) that appears to contain text files. Likewise, you could set up reading from directories so that fopen("/", "r") returns a newline-delimited list of files in the folder, similar to what MS-DOS or Windows Command Prompt gives when you "dir /b".
<br/>
<br/>
Everything is a file.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#104362 - chishm - Thu Sep 28, 2006 10:41 am</h4>
    <div class="postbody"><span class="postbody">Devices (as in, file systems, terminals, etc) in DevkitPro are given individual names, such as "fat:" or "stdin:". They are not all part of one directory tree. 
<br/>
<br/>
Having libfat fake a /proc directory adds unnecessary complications to the file tree. "fat:/" is the root of the FAT device, not the root of the entire device tree. What happens if a "fat:/proc/" directory actually exists? It would be posible to add a second device to the device table specifically for "proc:", but what happens if another file system device driver tries to do the same?
<br/>
<br/>
If directories are treated as files then either only the filenames are readable as though it's a text file, or more data is obtainable through a proprietry format. Specific directory listing functions are much better.<br/>_________________<br/><a class="postlink" href="http://chishm.drunkencoders.com" target="_blank">http://chishm.drunkencoders.com</a>
<br/>
<a class="postlink" href="http://dldi.drunkencoders.com" target="_blank">http://dldi.drunkencoders.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#104404 - tepples - Thu Sep 28, 2006 6:52 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>chishm wrote:</b></span></td> </tr> <tr> <td class="quote">Having libfat fake a /proc directory adds unnecessary complications to the file tree. "fat:/" is the root of the FAT device, not the root of the entire device tree. What happens if a "fat:/proc/" directory actually exists?</td> </tr></table><span class="postbody">
<br/>
Then you could use a character in the pseudo-directory name that's not legal in an MS-FAT file name.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">It would be posible to add a second device to the device table specifically for "proc:", but what happens if another file system device driver tries to do the same?</td> </tr></table><span class="postbody">
<br/>
But are there any other file system device drivers? However, I'm beginning to think you're right that a dedicated way to estimate free space on a volume should be added.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">If directories are treated as files then either only the filenames are readable as though it's a text file, or more data is obtainable through a proprietry format.</td> </tr></table><span class="postbody">
<br/>
I was imagining a while loop with fgets() and stat().
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Specific directory listing functions are much better.</td> </tr></table><span class="postbody">
<br/>
They're not "much better" if no version of devkitPro that uses them is available.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#104431 - chishm - Fri Sep 29, 2006 3:05 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tepples wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Specific directory listing functions are much better.</td> </tr></table><span class="postbody">
<br/>
They're not "much better" if no version of devkitPro that uses them is available.</span></td> </tr></table><span class="postbody">
<br/>
If we're talking ugly hacks to get around the lack of DKP updates then I could just write temporary wrapper functions that call the FAT directory listing functions directly, rather than using the correct method of going through the device table.
<br/>
<br/>
For the curious, the functions that (will eventually) get called through the device table are in <a class="postlink" href="http://devkitpro.cvs.sourceforge.net/devkitpro/libfat/source/fatdir.h?revision=1.2&amp;view=markup" target="_blank">fatdir.h</a>.<br/>_________________<br/><a class="postlink" href="http://chishm.drunkencoders.com" target="_blank">http://chishm.drunkencoders.com</a>
<br/>
<a class="postlink" href="http://dldi.drunkencoders.com" target="_blank">http://dldi.drunkencoders.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#104435 - tepples - Fri Sep 29, 2006 4:08 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>chishm wrote:</b></span></td> </tr> <tr> <td class="quote">I could just write temporary wrapper functions that call the FAT directory listing functions directly, rather than using the correct method of going through the device table.</td> </tr></table><span class="postbody">
<br/>
IMHO, such wrappers would be at least as good as the old gba_nds_fat way of doing things. It's not unprecedented, as several file systems on Linux have various specialized syscalls that don't go through the VFS.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
