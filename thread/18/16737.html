<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Readin garbage from files - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > Readin garbage from files</h2>
<div id="posts">
<div class="post">
    <h4>#169236 - DiscoStew - Wed Jun 24, 2009 9:23 pm</h4>
    <div class="postbody"><span class="postbody">This is an odd problem for me, because it's a problem that "sometimes" happens. It's not random, as I can duplicate the error by reading each file in a particular order. Changing the order may bring up the error earlier or later, and the file the error comes up with in one order doesn't occur in another order, as some other file brings it up instead.
<br/>
<br/>
Anyways, this came up when working on a decompression method for my project. I haven't had any problems with the algorithm when it ran on the PC, but on the DS (hardware and emulator), the problem occurs "sometimes". I spent weeks on trying to fix it, thinking it was my algorithm......until just today when I thought about making duplicate copies of each file, reading them alongside the originals (ignoring my decompression algorithm altogether), and comparing the value read from one with the other.
<br/>
<br/>
The result? I think I'm reading garbage because the value between the 2 doesn't match, which is odd, because the garbage is read midway through the files, not at the beginning. Has anyone else been reading "garbage" from files? The functions I use for this are fopen, fclose, and fread (which will only read 1 byte at a time).<br/>_________________<br/><span style="font-weight: bold">DS</span> - It's all about <span style="font-weight: bold">D</span>isco<span style="font-weight: bold">S</span>tew</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#169239 - elhobbs - Wed Jun 24, 2009 10:08 pm</h4>
    <div class="postbody"><span class="postbody">If the error is occuring on hardware and emulators alike then I would say it is probably stack corruption.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#169262 - DiscoStew - Thu Jun 25, 2009 9:43 pm</h4>
    <div class="postbody"><span class="postbody">If it is stack corruption, then maybe you can help me figure out what I'm doing wrong.
<br/>
<br/>
I made a small test program that does one thing; Examines 2 files that have equal contents, and errors if the 2 bytes that are read don't match. The files in question that I'm using have a 4 byte header that give the size of the file (minus the header itself), so I read those 4 bytes on both files, then loop through the rest of the files one byte at a time, comparing the 2 8-bit values together.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#include &lt;nds.h&gt;
<br/>
#include &lt;fat.h&gt;
<br/>
<br/>
#include &lt;stdio.h&gt;
<br/>
<br/>
<br/>
int fget8( FILE* fin ) {
<br/>
   u8 a[1];
<br/>
   fread( a, 1, 1, fin );
<br/>
   return a[0];
<br/>
}
<br/>
<br/>
int fget16( FILE* fin ) {
<br/>
   return fget8( fin ) | ( fget8( fin ) &lt;&lt; 8 );
<br/>
}
<br/>
<br/>
u32 fget32( FILE* fin ) {
<br/>
   return fget16( fin ) | ( fget16( fin ) &lt;&lt; 16 );
<br/>
}
<br/>
<br/>
<br/>
<br/>
int examine_Files( const char *file1, const char *file2 ) {
<br/>
<br/>
   FILE *fin1 = fopen( file1, "rb" );
<br/>
   FILE *fin2 = fopen( file2, "rb" );
<br/>
<br/>
   int fSize1 = fget32( fin1 );
<br/>
   int fSize2 = fget32( fin2 );
<br/>
<br/>
   sassert( fSize1 == fSize2, "Files not same size" );
<br/>
<br/>
   int fPos = 0;
<br/>
   while( fPos &lt; fSize1 )
<br/>
   {
<br/>
      sassert( feof( fin1 ) == feof( fin2 ), "One ended before the other." );
<br/>
      int test1 = fget8( fin1 );
<br/>
      int test2 = fget8( fin2 );
<br/>
      sassert( test1 == test2, "Corruption detected." );
<br/>
      fPos++;
<br/>
   }
<br/>
<br/>
   fclose( fin2 );
<br/>
   fclose( fin1 );
<br/>
<br/>
   iprintf( "good\n" );
<br/>
   return 1;
<br/>
}
<br/>
<br/>
<br/>
int main(void) {
<br/>
<br/>
   consoleDemoInit();
<br/>
   if( !fatInitDefault() ) {
<br/>
      iprintf( "FAT is required.\n" );
<br/>
      while( 1 ) swiWaitForVBlank();
<br/>
   }
<br/>
<br/>
   while(1) {
<br/>
      swiWaitForVBlank();
<br/>
<br/>
      scanKeys();
<br/>
      int keysd = keysDown();
<br/>
   
<br/>
      if( keysd &amp; KEY_UP )
<br/>
         examine_Files( "test1a.dat", "test1b.dat" );
<br/>
      else if( keysd &amp; KEY_RIGHT )
<br/>
         examine_Files( "test2a.dat", "test2b.dat" );
<br/>
      else if( keysd &amp; KEY_DOWN )
<br/>
         examine_Files( "test3a.dat", "test3b.dat" );
<br/>
      else if( keysd &amp; KEY_LEFT )
<br/>
         examine_Files( "test4a.dat", "test4b.dat" );
<br/>
   }
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
When I try the "test1" or "test2" files first, it errors, but if I reset and try "test3" before "test1", I get no error on either, but "test3" before "test2" errors on "test2". The errors will always pop up at the right times when the same pattern for examining the files (by user input) is done.
<br/>
<br/>
I'm assuming that I am doing something wrong in my code, and I don't even recognize it.<br/>_________________<br/><span style="font-weight: bold">DS</span> - It's all about <span style="font-weight: bold">D</span>isco<span style="font-weight: bold">S</span>tew</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#169267 - ingramb - Fri Jun 26, 2009 1:12 am</h4>
    <div class="postbody"><span class="postbody">This probably won't do anything, but you could try
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">int fget8( FILE* fin ) {
<br/>
<span style="font-weight: bold">static</span> u8 a[1];
<br/>
   fread( a, 1, 1, fin );
<br/>
   return a[0];
<br/>
} </td> </tr></table><span class="postbody">
<br/>
<br/>
Just in case freading into the stack (DTCM) is causing problems.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#169268 - DiscoStew - Fri Jun 26, 2009 1:43 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>ingramb wrote:</b></span></td> </tr> <tr> <td class="quote">This probably won't do anything</td> </tr></table><span class="postbody">
<br/>
<br/>
I beg to differ. I tried your change, and over the hundred tests I did (pattern and random), I have yet to see it error again. Until further notice, I believe you've fixed my problem. Thanks.<br/>_________________<br/><span style="font-weight: bold">DS</span> - It's all about <span style="font-weight: bold">D</span>isco<span style="font-weight: bold">S</span>tew</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#169269 - elhobbs - Fri Jun 26, 2009 1:59 am</h4>
    <div class="postbody"><span class="postbody">I think you may have an issue with sign extension on your return values. fget8 and fget16 return signed int values. I think they should be unsigned int or u8 and u16 respectively.
<br/>
<br/>
try reading a file in and writing it back to a different file. then check the results in a hex editor. if sign extension is the issue then you will probably see a lot of 0xff values in the file you write back.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#169271 - DiscoStew - Fri Jun 26, 2009 5:38 am</h4>
    <div class="postbody"><span class="postbody">The stuff I've been doing atm hasn't been using any particular format outside of just reading the 3 types, but I see your point if I plan to read specific format straight from a file.<br/>_________________<br/><span style="font-weight: bold">DS</span> - It's all about <span style="font-weight: bold">D</span>isco<span style="font-weight: bold">S</span>tew</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
