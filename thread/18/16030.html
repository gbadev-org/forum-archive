<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Removing transparency? - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>DS development > Removing transparency?</h2>
<div id="posts">
<div class="post">
    <h4>#162692 - spinal_cord - Tue Sep 09, 2008 1:55 pm</h4>
    <div class="postbody"><span class="postbody">Just a quick noobish question, is there a way to stop color 0 from being transparent? 
<br/>
<br/>
Failing that, is there a super-hyper-mega fast way of doing this? -
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
   int temp=0;
<br/>
   for(temp=0; temp&lt;512*282; temp++)
<br/>
   {
<br/>
      if(bufmem[temp]==0)bufmem[temp]=16;
<br/>
   }
<br/>
</td> </tr></table><span class="postbody"><br/>_________________<br/>I'm not a boring person, it's just that boring things keep happening to me.
<br/>
<a class="postlink" href="http://spinal.dizidesigns.co.uk/" target="_blank">Homepage</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#162695 - Maxxie - Tue Sep 09, 2008 4:03 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>spinal_cord wrote:</b></span></td> </tr> <tr> <td class="quote">Just a quick noobish question, is there a way to stop color 0 from being transparent? 
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
By disabling background color and lower backgrounds. If there is nothing the NDS can set into the transparent areas, it leaves them how they are (with color)
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
Failing that, is there a super-hyper-mega fast way of doing this? -
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
   int temp=0;
<br/>
   for(temp=0; temp&lt;512*282; temp++)
<br/>
   {
<br/>
      if(bufmem[temp]==0)bufmem[temp]=16;
<br/>
   }
<br/>
</td> </tr></table><span class="postbody"></span></td> </tr></table><span class="postbody">
<br/>
<br/>
If you are doing this in a buffer in 16+bit access memory, you could read a full (h)word, check each byte and write a full (h)word. Saves you memory accesses, as you use the full information on one read instead of throwing parts away again. Reduces the looping amount, but increases the arithmetic useage per iteration.<br/>_________________<br/><a class="postlink" href="http://nintendods.desperate-programmers.com/doku.php?id=wireless_io_map" target="_blank">Trying  to bring more detail into understanding the wireless hardware</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#162697 - Miked0801 - Tue Sep 09, 2008 6:00 pm</h4>
    <div class="postbody"><span class="postbody">Hyper fast suggestions:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
u32 *tempPtr = (u32 *)bufmem;
<br/>
<br/>
for(int i=0; i&lt;512*282/2; i++)
<br/>
{
<br/>
    u32 foo = *tempPtr;
<br/>
    if((foo &amp; 0xFFFF) == 0) foo |= 0x10;
<br/>
    if((foo &gt;&gt; 16) == 0) foo |= 0x100000;
<br/>
    *tempPtr = foo;
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
This will be a little faster than just doing the 16-bit test you are already doing.  Taking it further though:
<br/>
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
stmfd sp!,[r4-r11,lr]
<br/>
mov lr, 512*282/2/12
<br/>
ldr r0,tempBuf
<br/>
<br/>
loop1:
<br/>
ldm r0,[r1-r12]
<br/>
<br/>
tst r1,0xFFFF
<br/>
orrne r1,r1,0x10
<br/>
tst r1,0xFFFF0000
<br/>
orrne r1,r1,0x100000
<br/>
<br/>
tst r2,0xFFFF
<br/>
orrne r2,r2,0x10
<br/>
tst r2,0xFFFF0000
<br/>
orrne r2,r2,0x100000
<br/>
<br/>
...
<br/>
<br/>
tst r12,0xFFFF
<br/>
orrne r12,r12,0x10
<br/>
tst r12,0xFFFF0000
<br/>
orrne r12,r12,0x100000
<br/>
<br/>
stm r0!,[r1-r12]
<br/>
<br/>
subs lr,lr,1
<br/>
bne loop1
<br/>
<br/>
ldmfd sp!,[r4-r11,lr]
<br/>
<br/>
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I'm at home so the op-codes may be a bit off, but the idea is correct.  This will get the access down to roughly 4.1ish cycles per half-word.  The method you have is 8 cycles on a non-write and 9 cycles on a write.
<br/>
<br/>
Most of the savings is from the loop unroll.  Unrolling yours 8-12 times and doing just half-words (ldrh, cmp 0, strneh) would be 5 cycles on a write and 6 on a pass with about .1 cycles added for overhead, so the unrolled 32-bit method is a bit faster.
<br/>
<br/>
I'll look at this more later.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#162698 - Maxxie - Tue Sep 09, 2008 6:36 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Miked0801 wrote:</b></span></td> </tr> <tr> <td class="quote">Hyper fast suggestions:
<br/>
<br/>
This will be a little faster than just doing the 16-bit test you are already doing.  Taking it further though:
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I'd think if he uses paletted colors (not the map entries as the resolution is too hight), he'd use 8bit color per pixel.)
<br/>
<br/>
Nontheless, the effect is the same (even greater)<br/>_________________<br/><a class="postlink" href="http://nintendods.desperate-programmers.com/doku.php?id=wireless_io_map" target="_blank">Trying  to bring more detail into understanding the wireless hardware</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#162701 - Miked0801 - Tue Sep 09, 2008 7:32 pm</h4>
    <div class="postbody"><span class="postbody">Yep - Here's the breakdown for that
<br/>
<br/>
ldrb 3 ; bufmem[temp]
<br/>
cmp 1 ; == 0
<br/>
orne 1 ; if, assign 16
<br/>
strneb 1 or 2 - probably around 1.1 ; if, assign 16
<br/>
adds 1 ; temp++
<br/>
cmp ; &lt; 512*282
<br/>
bne 3 ; next loop
<br/>
--------
<br/>
11 - 12 cycles per color (11.1 I'd guess meaning 1 in 10 bytes is '0')
<br/>
<br/>
to
<br/>
<br/>
ldm 0.3125 cycles ; 15 cycles for 48 bytes 
<br/>
tst    1
<br/>
orrne 1
<br/>
stm 0.2917 cycles ; 14 cycles once every 48 bytes
<br/>
sub   0.021 ; 1 cycle every 48 bytes
<br/>
bne   0.0625 ; 3 cycles every 48 bytes
<br/>
--------------
<br/>
2.6875 cycles per color
<br/>
<br/>
so a little more than 4x faster than original code.
<br/>
<br/>
If assembly is daunting, just changing the code backwards to 0 SHOULD save 1 cycle per, but many compilers are too stupid to catch this.  Also, unrolling say 8 times would get another couple cycles quickly.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#162704 - TwentySeven - Tue Sep 09, 2008 10:10 pm</h4>
    <div class="postbody"><span class="postbody">Impressive.
<br/>
<br/>
It's even faster if you fix the problem at the art pipeline stage.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#162707 - Maxxie - Wed Sep 10, 2008 5:23 am</h4>
    <div class="postbody"><span class="postbody">One would think that this solution only works if you actually have the data earlier then runtime. 
<br/>
<br/>
There is no hint that lets us assume that.<br/>_________________<br/><a class="postlink" href="http://nintendods.desperate-programmers.com/doku.php?id=wireless_io_map" target="_blank">Trying  to bring more detail into understanding the wireless hardware</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#162708 - TwentySeven - Wed Sep 10, 2008 6:38 am</h4>
    <div class="postbody"><span class="postbody">When you hear hoofbeats, think Horses, not zebras :)
<br/>
<br/>
I'll bet you a cookie it's not run time generated image data.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#162709 - eKid - Wed Sep 10, 2008 7:52 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
.macro cvt_wd src, dest, base
<br/>
        bic     \dest, \base, \src, lsl#4       // 1
<br/>
        bic     \dest, \src, lsl#3              // +1
<br/>
        bic     \dest, \src, lsl#2              // +1
<br/>
        bic     \dest, \src, lsl#1              // +1
<br/>
        orr     \dest, \src                     // +1
<br/>
.endm                                           // [5]
<br/>
<br/>
//------------------------------------------------------------
<br/>
convert_data:                           // convert_data( u32* data )
<br/>
//------------------------------------------------------------
<br/>
        stmfd   sp!, {r4-r6,lr}         // 4 save regs
<br/>
        ldr     r6,=0x10101010          // 2 load base number
<br/>
        mov     r3, #512*282/4/16       // 1 fixed length
<br/>
        ldr     r2,=tempBuff            // 2 get address
<br/>
<br/>
loop:                                   // [repeat 2256 times]
<br/>
//-------------------------------------------------------------
<br/>
.rept 8                                 // [repeat 8 times]
<br/>
        ldrd    r0, [r2]                // 2 
<br/>
        cvt_wd  r0,r4,r6                // 5
<br/>
        cvt_wd  r1,r5,r6                // 5
<br/>
        strd    r4, [r2], #4            // 2
<br/>
.endr                                   // [14 cycles]
<br/>
        subs    r3, #1                  // 1
<br/>
        bne     loop                    // 3
<br/>
//-------------------------------------------------------------
<br/>
        ldmfd   sp!, {r4-r6, pc}        // 7
<br/>
                                        // [261708 cycles (1.81/entry)]
<br/>
.pool
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
this is fun :P
<br/>
<br/>
Assumes that input is 4-bit values stored in 8-bit entries.
<br/>
<br/>
The 1.81 cycles/entry is assuming all memory access time (32-bit) is 1 cycle, so it should probably slow down a bit for cache misses, and slow down a lot if the memory is in uncached VRAM...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#162710 - spinal_cord - Wed Sep 10, 2008 11:09 am</h4>
    <div class="postbody"><span class="postbody">You guys seem to have had fun with this. What it is, is the 8bit image buffer from frodods, im using 2 layers resized at different offsets and 50% alpha, the problem is that colour 0 is transparent and cant be alpha'd with anything.
<br/>
<br/>
I'm still trying to track down where the buffer is being created in the first place, but i'm not a super-leet coder like a lot of you guys, so much of it just looks like a complete mess to me.
<br/>
<br/>
as for assuming 4bit numbers, i should have made that clearer, its all 8bit pixel values, apparently the palette is repeated 16 times.<br/>_________________<br/>I'm not a boring person, it's just that boring things keep happening to me.
<br/>
<a class="postlink" href="http://spinal.dizidesigns.co.uk/" target="_blank">Homepage</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#162712 - tepples - Wed Sep 10, 2008 11:51 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>spinal_cord wrote:</b></span></td> </tr> <tr> <td class="quote">What it is, is the 8bit image buffer from frodods</td> </tr></table><span class="postbody">
<br/>
If you know that your source uses colors 0-15, as a C64 emulator might, you could just OR all 32-bit words in the buffer with 0xF0F0F0F0 so that it uses colors 240-255. But once you get this port feature complete and mostly tested, you can announce that you have made "the first working 64 emulator for DS". (<a class="postlink" href="http://www.gametrailers.com/player/35929.html" target="_blank">AVGN could tell you the ambiguity is intentional</a>.)
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>spinal_cord wrote:</b></span></td> </tr> <tr> <td class="quote">im using 2 layers resized at different offsets and 50% alpha</td> </tr></table><span class="postbody">
<br/>
So you're doing α-Lerp (<span style="font-weight: bold">alpha</span> blending of a layer against itself, possibly combined with flicker scaling, to approximate <span style="font-weight: bold">l</span>inear int<span style="font-weight: bold">erp</span>olation), as seen in <a class="postlink" href="http://pinocchio.jk0.org/gbaforum/alpha-lerp.zip" target="_blank">my demo</a> and then in nesDS.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>spinal_cord wrote:</b></span></td> </tr> <tr> <td class="quote">the problem is that colour 0 is transparent and cant be alpha'd with anything.</td> </tr></table><span class="postbody">
<br/>
Blend has two layers: "source" (top) and "destination" (second-from-top). Try setting BLEND_CR to blend the "backdrop" (color 0 areas) as a "destination" layer (BLEND_DST_BACKDROP). That worked for my prototype implementation of α-Lerp.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#162713 - spinal_cord - Wed Sep 10, 2008 1:44 pm</h4>
    <div class="postbody"><span class="postbody">but wouldn't i loose the other layer if i blend to the backdrop? i went for this option because i couldnt get the flickering working properly.<br/>_________________<br/>I'm not a boring person, it's just that boring things keep happening to me.
<br/>
<a class="postlink" href="http://spinal.dizidesigns.co.uk/" target="_blank">Homepage</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#162718 - tepples - Wed Sep 10, 2008 7:37 pm</h4>
    <div class="postbody"><span class="postbody">If you have layer 1 over layer 2, you get (layer 1 * 8 + layer 2 * 8)/16, which is what you currently have (and want). But if you blend with the background as a DST, you can get (layer 1 * 8 + backdrop * 8)/16 and  (layer 2 * 8 + backdrop * 8)/16, which is also what you want.
<br/>
<br/>
What was working improperly about your attempts to flicker? I want to help you with this because adding a bit of flicker makes α-Lerp look even better.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#162719 - spinal_cord - Wed Sep 10, 2008 7:56 pm</h4>
    <div class="postbody"><span class="postbody">i dont know much at all about interrupts, i tried using the exsisting vbl in the frodo source already, but it didnt seem to be ticking anywhere near fast enough, and all attempts to add my own failed. i also tried using a timer, but that want in sync either, so it jittered now and then.
<br/>
<br/>
Should i pm you the source so you can have a look?<br/>_________________<br/>I'm not a boring person, it's just that boring things keep happening to me.
<br/>
<a class="postlink" href="http://spinal.dizidesigns.co.uk/" target="_blank">Homepage</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#162721 - Miked0801 - Wed Sep 10, 2008 9:38 pm</h4>
    <div class="postbody"><span class="postbody">ekid, your code does not check if the value is non-zero before adding in the offset.  The original code leaves values 1-255 alone but changes 0 to 16.  Yours just changes things :)
<br/>
<br/>
Loads also take 3 cycles, not 2 as per gbatek.
<br/>
<br/>
Also, where's 4-bit specified?  It's a good guess though looking at the 16-assignment value.  Finally, eat a few more registers and use ldm/stms to further eat away your cycles per unit.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#162722 - Maxxie - Wed Sep 10, 2008 9:45 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Miked0801 wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
<br/>
Also, where's 4-bit specified?  It's a good guess though looking at the 16-assignment value.  </td> </tr></table><span class="postbody">
<br/>
<br/>
Actually not. 16 translates to 0 if it is stored into a 4 bit unsigned integer, in which case you wouldn't change anything.<br/>_________________<br/><a class="postlink" href="http://nintendods.desperate-programmers.com/doku.php?id=wireless_io_map" target="_blank">Trying  to bring more detail into understanding the wireless hardware</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#162740 - Miked0801 - Thu Sep 11, 2008 6:21 pm</h4>
    <div class="postbody"><span class="postbody">Was assuming a 4-bit color with the 4 bit as a flag - probably alpha.  But you are correct, if straight 4-bit, 2 colors per byte, then that would do evil.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#162781 - spinal_cord - Fri Sep 12, 2008 8:21 pm</h4>
    <div class="postbody"><span class="postbody">so can 
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
   bufmem = (uint8*)malloc(512*512); // forgot to mention this bit before
<br/>
<br/>
<br/>
   int temp=0;
<br/>
   for(temp=0; temp&lt;512*282; temp++)
<br/>
   {
<br/>
      if(bufmem[temp]==0)bufmem[temp]=16;
<br/>
   } 
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
not be done super fast?<br/>_________________<br/>I'm not a boring person, it's just that boring things keep happening to me.
<br/>
<a class="postlink" href="http://spinal.dizidesigns.co.uk/" target="_blank">Homepage</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#162792 - keldon - Fri Sep 12, 2008 11:45 pm</h4>
    <div class="postbody"><span class="postbody">Hmm; can you not just increment them all and change the palette instead?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#162793 - spinal_cord - Sat Sep 13, 2008 1:03 am</h4>
    <div class="postbody"><span class="postbody">The palette is repeated 16 times so all 256 entries are taken up by the 16 color palette. I'm not in any way sure why this is, but i assume its to speed up something or other. I tried moving all the entries up 1, but then the last entry wraps round to 0 so then sometimes light grey is then transparent instead.<br/>_________________<br/>I'm not a boring person, it's just that boring things keep happening to me.
<br/>
<a class="postlink" href="http://spinal.dizidesigns.co.uk/" target="_blank">Homepage</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#162913 - Cearn - Tue Sep 16, 2008 9:22 am</h4>
    <div class="postbody"><span class="postbody">Instead of adding, try ORring by 16 (0r 0x10101010 for speed). This will make everything use the odd palette groups. ORring by 0xF0F0F0F0 would shift everything to the 0xF0-0xFF range, leaving the rest of the palette for other purposes.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#162914 - spinal_cord - Tue Sep 16, 2008 9:32 am</h4>
    <div class="postbody"><span class="postbody">Doesn't matter any more, i got flickering working.<br/>_________________<br/>I'm not a boring person, it's just that boring things keep happening to me.
<br/>
<a class="postlink" href="http://spinal.dizidesigns.co.uk/" target="_blank">Homepage</a></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
