<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>[Lib] Advanced Sound Library released - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > [Lib] Advanced Sound Library released</h2>
<div id="posts">
<div class="post">
    <h4>#146333 - Noda - Sun Dec 02, 2007 10:23 pm</h4>
    <div class="postbody"><span class="postbody">Hi,
<br/>
<br/>
As I announced some times ago in the mp3 thread, here is finally the release of my new library.
<br/>
<br/>
<span style="font-style: italic">Features:</span>
<br/>
<br/>
<span style="font-weight: bold">* MP3 engine:</span>
<br/>
  - mp3 is decoded on the arm7, so use nearly no CPU time on the arm9
<br/>
  - stereo &amp; surround modes available (surround works even for mono mp3s)
<br/>
  - up to 44Khz/stereo/96Kbps, though I recommend using 32Khz/stereo/80Kbps max, which is enough for the DS and works great with up to +25%/-100% pitching
<br/>
  - support real-time pitching (changing the playing speed of the mp3)
<br/>
  - support real-time volume and panning change
<br/>
  - the mp3 can be paused and restarted
<br/>
  - the mp3 can be set to loop automatically
<br/>
  - support playing from RAM and streaming from FAT or EFS
<br/>
  - you can disable the mp3 engine if you want, to get 2 more channels
<br/>
<span style="font-weight: bold">
<br/>
* Audio engine:</span>
<br/>
  - can use the whole 16 DS channel or only the first half (so you can use an external mod player, for example)
<br/>
  - support standard or surround/fx mode (16 channels in standard mode (-2 if mp3), 8 in surround/fx mode (-1 if mp3))
<br/>
  - simple sound playing using a priority system: if no channel is available, stop a sound that has less priority than the new one to play it, or skip it if all sounds have more priority.
<br/>
  - possibility to reserve a particular channel so it won't be used in the channel pool by the priority playing system. You can then manage the reserved sound channels manually.
<br/>
  - surround or pseudo-reverb can be activated per sound (works great with  mono sounds)
<br/>
  - support real-time volume, panning and pitch modifications for each sound
<br/>
  - support sound looping
<br/>
<br/>
<br/>
I'm open to any suggestions on how to improve it ;)
<br/>
<br/>
<span style="font-weight: bold">Download link:</span>
<br/>
<a href="http://noda.free.fr/nds/as_lib_template_v1.0.rar" target="_blank">http://noda.free.fr/nds/as_lib_template_v1.0.rar</a>
<br/>
<br/>
The lib comes with a template and a example of what you can do with it.
<br/>
<br/>
It didn't tested it exhaustively, so feel free to report any bug.
<br/>
<br/>
<span style="font-weight: bold">Credits:</span>
<br/>
    - IPC sound system and streaming is based on cold_as_ice streaming example
<br/>
    - audio stream filling / mp3 decoding based on ThomasS mp3 decoding example
<br/>
    - ASM stereo desinterleave function was made by Thoduv</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146335 - Peter - Sun Dec 02, 2007 11:08 pm</h4>
    <div class="postbody"><span class="postbody">I have not really a question regarding the audio system, but I found the following lines in as_lib9.h and I wonder why you declare all inline functions as extern:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
extern inline void AS_ReserveChannel(u8 channel) 
<br/>
{ 
<br/>
    IPC_Sound-&gt;chan[channel].reserved = true; 
<br/>
}
<br/>
</td> </tr></table><span class="postbody"><br/>_________________<br/>Kind Regards,
<br/>
Peter</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146336 - Lick - Sun Dec 02, 2007 11:16 pm</h4>
    <div class="postbody"><span class="postbody">This lib sounds awesome! Have you planned support for formats other than mp3?<br/>_________________<br/><a class="postlink" href="http://licklick.wordpress.com" target="_blank">http://licklick.wordpress.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146337 - Noda - Sun Dec 02, 2007 11:18 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Peter wrote:</b></span></td> </tr> <tr> <td class="quote">I have not really a question regarding the audio system, but I found the following lines in as_lib9.h and I wonder why you declare all inline functions as extern:
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
extern inline void AS_ReserveChannel(u8 channel) 
<br/>
{ 
<br/>
    IPC_Sound-&gt;chan[channel].reserved = true; 
<br/>
}
<br/>
</td> </tr></table><span class="postbody"></span></td> </tr></table><span class="postbody">
<br/>
<br/>
That's because if you use it in a cpp project and rename the file from .c to .cpp (not necessary), the inline functions need to be declared as extern in cpp in order to be used on other files ;)
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Lick wrote:</b></span></td> </tr> <tr> <td class="quote">This lib sounds awesome! Have you planned support for formats other than mp3?</td> </tr></table><span class="postbody">
<br/>
<br/>
I've done it mainly to fit my needs, so not for now..
<br/>
<br/>
what formats would you have wanted? .ogg needs too much memory for the arm7, but I may consider adding later a mod player which could be used instead of the mp3 player.</span><span class="gensmall"><br/><br/>Last edited by Noda on Sun Dec 02, 2007 11:22 pm; edited 2 times in total</span></div>    
</div>
<div class="post">
    <h4>#146338 - Noda - Sun Dec 02, 2007 11:20 pm</h4>
    <div class="postbody"><span class="postbody">[please delete this post, sorry for the double post]</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146340 - NeX - Sun Dec 02, 2007 11:27 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">surround</td> </tr></table><span class="postbody">
<br/>
Please tell me how on Earth the DS can output surround with two speakers and stereo headphones.<br/>_________________<br/><a class="postlink" href="http://www.mediafire.com/?cuyb10fzdz2" target="_blank">Strummer</a> or <a class="postlink" href="http://www.mediafire.com/?71zxcztscix" target="_blank">Drummer?</a>.  
<br/>
Or maybe you would rather play with sand? <a class="postlink" href="http://www.mediafire.com/?a05z5wmdvxm" target="_blank">Sandscape is for you in that case.</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146341 - Noda - Sun Dec 02, 2007 11:31 pm</h4>
    <div class="postbody"><span class="postbody"><a href="http://en.wikipedia.org/wiki/Virtual_surround" target="_blank">http://en.wikipedia.org/wiki/Virtual_surround</a>
<br/>
<br/>
Surround is enabled in most commercial games, though the method used is litlle different.
<br/>
<br/>
I'm not talking about 5.1 DTS ;)
<br/>
<br/>
Actually, 2 speakers/headphone is enough: remember, you only have 2 ears, right? there is some algorithms which can provide exact 3D sound placement using simple headphones, the perception of the sound in space is related the frequencies/delay perceived.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146343 - yellowstar - Mon Dec 03, 2007 12:21 am</h4>
    <div class="postbody"><span class="postbody">I'm having problems with the example.
<br/>
<br/>
It won't play the mp3 from fat.
<br/>
Instead,
<br/>
it only plays the built-in mp3.
<br/>
<br/>
I uncommented the define for this,
<br/>
and rebuilt it.
<br/>
<br/>
I have the mp3 in the correct place,
<br/>
and it is named correctly.
<br/>
<br/>
I found this on line 117 in the example:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
AS_MP3StreamPlay("test.mp3");
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Shouldn't there be a / for the root?("/test.mp3")
<br/>
<br/>
I tried fixing that,
<br/>
but it still won't work.
<br/>
<br/>
Even commenting out
<br/>
all the lines for the fat define
<br/>
won't fix it.(that includes the function call to
<br/>
play the built-in mp3.)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146348 - Noda - Mon Dec 03, 2007 1:21 am</h4>
    <div class="postbody"><span class="postbody">Huh?
<br/>
<br/>
I just tried it, you just need to uncomment the define, then rebuild it and you're done. 
<br/>
<br/>
I tested it under no$gba with fcsr driver, on my DS-X and on my MK5, it just works fine loading the file "test.mp3" at the root of the card..
<br/>
<br/>
What version of DKP are you using?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146350 - yellowstar - Mon Dec 03, 2007 1:32 am</h4>
    <div class="postbody"><span class="postbody">DKA r21.
<br/>
<br/>
I tested it on my DS-X.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146351 - Noda - Mon Dec 03, 2007 1:42 am</h4>
    <div class="postbody"><span class="postbody">I've only tested the lib under DKA r20 (I have a school project due in 2 weeks and I don't want to mess with the update for now), maybe that's the problem, though I don't saw any major changes in r21 which could cause that.. 
<br/>
<br/>
Can anyone using DKA r21 confirm that the example is not working with fat with just uncommenting the define?
<br/>
<br/>
EDIT: how, I saw that you use a DS-X.. is your DS-X set to automatically runs the last .nds launched? if that's the case, then hold A at startup and reload the example with the loader. The DS-X has some memory where the homebrews are put on, and sometimes when you update it you need to reload the file through the loader so the file is reload in this "cache" memory (I noticed that some time ago). I think that is your problem</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146354 - yellowstar - Mon Dec 03, 2007 2:02 am</h4>
    <div class="postbody"><span class="postbody">It still won't work,
<br/>
with booting the example manually.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146356 - Noda - Mon Dec 03, 2007 2:11 am</h4>
    <div class="postbody"><span class="postbody">What it does? does it show a "fat init error?"</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146359 - spinal_cord - Mon Dec 03, 2007 3:01 am</h4>
    <div class="postbody"><span class="postbody">How much of a pain would this be to get working with palib? I assume it would mean removing some of palibs arm7 stuff, or is it likely to fit?<br/>_________________<br/>I'm not a boring person, it's just that boring things keep happening to me.
<br/>
<a class="postlink" href="http://spinal.dizidesigns.co.uk/" target="_blank">Homepage</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146364 - Noda - Mon Dec 03, 2007 4:34 am</h4>
    <div class="postbody"><span class="postbody">basically, you just need to get rid of PALib's modplayer to free up some space on the arm7 binary, and change the IPC structure location so it doesn't conflicts with the PALib's one.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146380 - chishm - Mon Dec 03, 2007 8:04 am</h4>
    <div class="postbody"><span class="postbody">There's not enough free RAM on the ARM7 for the Helix decoder in DKA r21. I get around this by using VRAM bank D as the heap location for the ARM7. To do this, in arm9/source/main.c, add the following line at the start of main ()
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">// Give 128KiB of VRAM to the ARM7
<br/>
vramSetBankD(VRAM_D_ARM7_0x06000000);</td> </tr></table><span class="postbody">
<br/>
That gives the RAM to the ARM7. Now in arm7/source/main.c, add the following at the top of the source file.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#include &lt;string.h&gt;      // For memset
<br/>
#define VRAM_START ((char*)0x06000000)
<br/>
#define VRAM_END ((char*)0x06020000)
<br/>
extern char *fake_heap_start;
<br/>
extern char *fake_heap_end;</td> </tr></table><span class="postbody">
<br/>
Then add the following to the start of main ()
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">// Wait for VRAM to become available
<br/>
while ((*(vuint8*)0x04000240 &amp; 0x02) == 0);
<br/>
// Clear VRAM
<br/>
memset (VRAM_START, 0, VRAM_END - VRAM_START);
<br/>
// Use VRAM as heap
<br/>
fake_heap_start = VRAM_START;
<br/>
fake_heap_end = VRAM_END;</td> </tr></table><span class="postbody">
<br/>
<br/>
Finally, you'll need to bypass the ARM9's data cache for the ARM7 to be able to access the data correctly. Since the ARM9 is only writing to the buffer once then never touching the data again, the best way to do this is to use an uncached mirror of EXRAM.
<br/>
<br/>
After the line 
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">mp3filebuffer = (u8*)memalign(4, AS_FILEBUFFER_SIZE * 2);   // 2 buffers, to swap</td> </tr></table><span class="postbody">
<br/>
add the following line
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">mp3filebuffer = (u8*)((int)mp3filebuffer | 0x00400000);   // Bypass cache</td> </tr></table><span class="postbody"><br/>_________________<br/><a class="postlink" href="http://chishm.drunkencoders.com" target="_blank">http://chishm.drunkencoders.com</a>
<br/>
<a class="postlink" href="http://dldi.drunkencoders.com" target="_blank">http://dldi.drunkencoders.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146386 - Noda - Mon Dec 03, 2007 1:52 pm</h4>
    <div class="postbody"><span class="postbody">Thanks for the precision, but why less memory is available on the arm7 since DKP r21? what has been added?
<br/>
<br/>
It's really disappointing for me since I don't want to waste a full VRAM bank just to have the mp3 player working, wheras in DKP r20 it's not needed. :/
<br/>
<br/>
<br/>
And your remark concerning the cache is interesting, but what are the benefits? since only arm7 will access the data I don't see where the problem is?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146405 - yellowstar - Mon Dec 03, 2007 8:28 pm</h4>
    <div class="postbody"><span class="postbody">Here's the problem:
<br/>
<br/>
Instead of playing the mp3 from fat,
<br/>
it only plays the built-in mp3.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146408 - Noda - Mon Dec 03, 2007 9:53 pm</h4>
    <div class="postbody"><span class="postbody">yellowstar&gt; I was talking about Chism's post.
<br/>
<br/>
Concerning your problem, I actually don't see how it's possible as the AS_MP3StreamPlay() and AS_MP3DirectPlay() are completely different functions, so if you call AS_MP3StreamPlay("test.mp3") it's impossible that the built-in mp3 is played!
<br/>
<br/>
Have you tested your binary under no$gba or ideas? does it give the same result?
<br/>
<br/>
And as Chism pointed out, there may be some modifications to do to make it work with DKP r21 apparently (I won't be able to check this for some weeks as I first have to finish my school project under DKP r20..)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146424 - melw - Tue Dec 04, 2007 12:34 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Noda wrote:</b></span></td> </tr> <tr> <td class="quote">And as Chism pointed out, there may be some modifications to do to make it work with DKP r21 apparently (I won't be able to check this for some weeks as I first have to finish my school project under DKP r20..)</td> </tr></table><span class="postbody">
<br/>
Just confirming Chishm's observations here. Compiling the original example with DKA r21 gives no mp3 playback. Again, adding Chishm's VRAM trickery and recompiling will give you sound back.
<br/>
<br/>
Coincidently, I'm just in a need of mp3 player for a project that uses lot of memory on the graphics front, and losing one full VRAM bank to ARM7 is something that makes me consider other options for sound playback. Hopefully there is another way to go around this problem - it'd be interesting to know what has been changed between DKA r20 and r21 and where the ARM7 has lost its memory. :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146425 - Noda - Tue Dec 04, 2007 12:41 am</h4>
    <div class="postbody"><span class="postbody">Thanks, I'm also really wondering what changed and eats the arm7's RAM.
<br/>
<br/>
Anyway, I always have the solution (if nothing can be done to recover the lost ram) to allocate the needed space with the arm9 and pass it to arm7 via IPC (like I do for the audio &amp; file buffers), so there won't be no need for a VRAM bank.
<br/>
<br/>
I guess r21 users will have to wait the end of the project so I can correct this ;)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146426 - Lick - Tue Dec 04, 2007 1:11 am</h4>
    <div class="postbody"><span class="postbody">Just wondering, did you enable the Helix decoder's ARM assembly routines?<br/>_________________<br/><a class="postlink" href="http://licklick.wordpress.com" target="_blank">http://licklick.wordpress.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146428 - Noda - Tue Dec 04, 2007 3:03 am</h4>
    <div class="postbody"><span class="postbody">Yes.
<br/>
<br/>
By the way, can someone can telle me the size of the compiled arm7 binary with devkitARM r21?
<br/>
<br/>
I still think it's strange that there's not enough ram, as with devkitARM r20 the binary is ~52Ko, and use less than 4Ko of ram (the audio &amp; file buffers are allocated on arm9), so this should fit in 64Ko without any problem, and I don't think there's more than 8Ko more ram space used by r21, isn't there?
<br/>
<br/>
<span style="font-weight: bold">[corrected terminology -- MOD]</span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146442 - melw - Tue Dec 04, 2007 7:53 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Noda wrote:</b></span></td> </tr> <tr> <td class="quote">By the way, can someone can telle me the size of the compiled arm7 binary with the DKP r21?</td> </tr></table><span class="postbody">
<br/>
<b style="color:#FFA34F">aslib</b>.arm7:  58 800 / 58 864 bytes - (original / modified)
<br/>
<br/>
EDIT: The most obvious workaround: Setting -Os in arm7 makefile -&gt; <b style="color:#FFA34F">aslib</b>.arm7 55 632 bytes and the original version works as well. 3 kilos seems to make a difference in this case. No idea if turning size optimization affects performance in any way, tested only with accompanied test.mp3.</span><span class="gensmall"><br/><br/>Last edited by melw on Tue Dec 04, 2007 8:02 am; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#146443 - wintermute - Tue Dec 04, 2007 7:58 am</h4>
    <div class="postbody"><span class="postbody">There's no such thing as DKP r21.
<br/>
<br/>
Personally I think mp3 is an unsuitable format for DS game music anyway - the memory and processor requirements push things a bit close to the edge to do much else.<br/>_________________<br/><a class="postlink" href="http://www.devkitpro.org/" target="_blank">devkitPro - professional toolchains at amateur prices</a>
<br/>
<a class="postlink" href="http://wiki.devkitpro.org/index.php/IRC" target="_blank">devkitPro IRC support</a>
<br/>
<a class="postlink" href="http://davejmurphy.com/" target="_blank">Personal Blog</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146465 - Noda - Tue Dec 04, 2007 4:37 pm</h4>
    <div class="postbody"><span class="postbody">Decoding a 22Khz/stereo/64Kbps use less than 50% of the arm7 CPU, so it's very suitable for me, and there's enough free CPU time to run dswifi/liblobby I think.
<br/>
<br/>
The only thing that really bothers me is that 64K restriction for the arm7: I would really love to have the choice of putting the arm7 binary in main ram and using those 64K only as heap for the arm7. Moonshell has an arm7 binary which is more than 300K in size (but compiled with ADS), so that should be possible right?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146472 - ecurtz - Tue Dec 04, 2007 5:30 pm</h4>
    <div class="postbody"><span class="postbody">WARNING: This was written on the bus this morning and I almost never do any assembly programming, so it's guarenteed to have a bug or two.
<br/>
<br/>
(All that indexing in the loop was driving me nuts)
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
// desinterleave a stereo source (thanks to Thoduv for the code)
<br/>
// version 2 by ecurtz (optimized loop)
<br/>
asm (
<br/>
"@--------------------------------------------------------------------------------------\n"
<br/>
"    .text                                                                              \n"
<br/>
"    .arm                                                                               \n"
<br/>
"                                                                                       \n"
<br/>
"@ desinterleave an mp3 stereo source                                                   \n"
<br/>
"@ r0 = interleaved data, r1 = left, r2 = right, r3 = len                               \n"
<br/>
"                                                                                       \n"
<br/>
"    .global AS_StereoDesinterleave                                                     \n"
<br/>
"                                                                                       \n"
<br/>
"AS_StereoDesinterleave :                                                               \n"
<br/>
"    stmfd sp!, {r5-r11}                                                                \n"
<br/>
"                                                                                       \n"
<br/>
"@ get the 3 low bits of len                                                            \n"
<br/>
"    ands r5, r3, #7                                                                    \n"
<br/>
"@ if 0 jump to the loop                                                                \n"
<br/>
"    beq _loop                                                                          \n"
<br/>
"@ load data, we know r5 won't be used in incomplete loop                               \n"
<br/>
"    ldmia r0, {r6-r12}                                                                 \n"
<br/>
"@ adjust data and len by amount we're actually using                                   \n"
<br/>
"    add  r0, r5, lsl #2                                                                \n"
<br/>
"    sub  r3, r5                                                                        \n"
<br/>
"@ r5 = 8 - r5 (amount of loop to skip)                                                 \n"
<br/>
"    rsb  r5, #8                                                                        \n"
<br/>
"@ r5 = r5 * 3 instructions per sample                                                  \n"
<br/>
"    add  r5, r5, lsl #1                                                                \n"
<br/>
"@ slam the pc forward into the loop (automatically skips next instruction)             \n"
<br/>
"    add pc, r5, lsl #2                                                                 \n"
<br/>
"                                                                                       \n"
<br/>
"_loop:                                                                                 \n"
<br/>
"    ldmia r0!, {r5-r12}                                                                \n"
<br/>
"                                                                                       \n"
<br/>
"    strh r5, [r1], #2                                                                  \n"
<br/>
"    mov r5, r5, lsr #16                                                                \n"
<br/>
"    strh  r5, [r2], #2                                                                 \n"
<br/>
"                                                                                       \n"
<br/>
"    strh r6, [r1], #2                                                                  \n"
<br/>
"    mov r6, r6, lsr #16                                                                \n"
<br/>
"    strh  r6, [r2], #2                                                                 \n"
<br/>
"                                                                                       \n"
<br/>
"    strh r7, [r1], #2                                                                  \n"
<br/>
"    mov r7, r7, lsr #16                                                                \n"
<br/>
"    strh  r7, [r2], #2                                                                 \n"
<br/>
"                                                                                       \n"
<br/>
"    strh r8, [r1], #2                                                                  \n"
<br/>
"    mov r8, r8, lsr #16                                                                \n"
<br/>
"    strh  r8, [r2], #2                                                                 \n"
<br/>
"                                                                                       \n"
<br/>
"    strh r9, [r1], #2                                                                  \n"
<br/>
"    mov r9, r9, lsr #16                                                                \n"
<br/>
"    strh  r9, [r2], #2                                                                 \n"
<br/>
"                                                                                       \n"
<br/>
"    strh r10, [r1], #2                                                                 \n"
<br/>
"    mov r10, r10, lsr #16                                                              \n"
<br/>
"    strh  r10, [r2], #2                                                                \n"
<br/>
"                                                                                       \n"
<br/>
"    strh r11, [r1], #2                                                                 \n"
<br/>
"    mov r11, r10, lsr #16                                                              \n"
<br/>
"    strh  r11, [r2], #2                                                                \n"
<br/>
"                                                                                       \n"
<br/>
"    strh r12, [r1], #2                                                                 \n"
<br/>
"    mov r12, r12, lsr #16                                                              \n"
<br/>
"    strh  r12, [r2], #2                                                                \n"
<br/>
"                                                                                       \n"
<br/>
"    subs r3, #8                                                                        \n"
<br/>
"    bne _loop                                                                          \n"
<br/>
"                                                                                       \n"
<br/>
"    ldmia sp!, {r5-r11}                                                                \n"
<br/>
"    bx lr                                                                              \n"
<br/>
"@--------------------------------------------------------------------------------------\n"
<br/>
);
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146479 - yellowstar - Tue Dec 04, 2007 8:12 pm</h4>
    <div class="postbody"><span class="postbody">I have found out why it was doing that previously.
<br/>
<br/>
I forgot to copy the newly-compiled nds to my card.
<br/>
(I always have a command in my Makefiles
<br/>
to copy it to my card for me)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146482 - Echo49 - Tue Dec 04, 2007 8:26 pm</h4>
    <div class="postbody"><span class="postbody">Have you thought about adding streaming raw sound data from the flashcart? Also, is it possible to play both an MP3 and SFX at the same time?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146483 - wintermute - Tue Dec 04, 2007 8:29 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Noda wrote:</b></span></td> </tr> <tr> <td class="quote">Decoding a 22Khz/stereo/64Kbps use less than 50% of the arm7 CPU, so it's very suitable for me, and there's enough free CPU time to run dswifi/liblobby I think.
<br/>
<br/>
The only thing that really bothers me is that 64K restriction for the arm7: I would really love to have the choice of putting the arm7 binary in main ram and using those 64K only as heap for the arm7. Moonshell has an arm7 binary which is more than 300K in size (but compiled with ADS), so that should be possible right?</td> </tr></table><span class="postbody">
<br/>
<br/>
We're using 96K for the arm7.
<br/>
<br/>
Running the arm7 in main RAM has a detrimental effect on both processors.<br/>_________________<br/><a class="postlink" href="http://www.devkitpro.org/" target="_blank">devkitPro - professional toolchains at amateur prices</a>
<br/>
<a class="postlink" href="http://wiki.devkitpro.org/index.php/IRC" target="_blank">devkitPro IRC support</a>
<br/>
<a class="postlink" href="http://davejmurphy.com/" target="_blank">Personal Blog</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146490 - tepples - Tue Dec 04, 2007 8:55 pm</h4>
    <div class="postbody"><span class="postbody">Can an MP3 decoder on the ARM7 be broken into overlay sections that are copied from main RAM to ARM7 RAM as each pass of MP3 decoding (huffman, rescaling, imdct, polyphase) completes? Would it be helpful?<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146497 - Noda - Tue Dec 04, 2007 10:53 pm</h4>
    <div class="postbody"><span class="postbody">Echo49&gt; raw sound streaming is useless since you can have mp3 for free, and yes you sure can use mp3 &amp; sfx at the same time.
<br/>
<br/>
wintermute&gt; 96K? then the 58K of the binary + 4~5K of heap used for variable should not cause any problem! maybe there's a problem here, and heap adress is incorrect then?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146498 - tepples - Tue Dec 04, 2007 11:09 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Noda wrote:</b></span></td> </tr> <tr> <td class="quote">Echo49&gt; raw sound streaming is useless since you can have mp3 for free, and yes you sure can use mp3 &amp; sfx at the same time.</td> </tr></table><span class="postbody">
<br/>
But what about comparatively long sound effects, such as a rain loop or voice acting? One can't have multiple MP3s at once, right?<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146506 - Noda - Wed Dec 05, 2007 2:27 am</h4>
    <div class="postbody"><span class="postbody">tepples&gt; yeah, we can have 2 mp3 at a time, I was think of having a wav file streaming instead of the mp3. I could add a raw streaming channel, but the problem lies with the timers: 2 timers are already used to stream the mp3, and the others are needed for the dswifi lib :/</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146509 - tepples - Wed Dec 05, 2007 3:18 am</h4>
    <div class="postbody"><span class="postbody">In that case, you might want to have software mix the two streams into a ring buffer.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146513 - Noda - Wed Dec 05, 2007 4:07 am</h4>
    <div class="postbody"><span class="postbody">that's not the problem, it's that if the 2 sources streamed use different sample rate I need to set up different timings to know when to regenerate the ring buffers, and that impossible because we only have 4 timers (2 used for the first stream, and the others by the dswifi lib)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146515 - tepples - Wed Dec 05, 2007 4:14 am</h4>
    <div class="postbody"><span class="postbody">Mixers on the GBA had to handle multiple sample rates the hard way, yet AAS could still mix a 4 channel mod in 5% of CPU time.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146655 - chishm - Fri Dec 07, 2007 9:54 am</h4>
    <div class="postbody"><span class="postbody">Could someone who is still using DKA r20 compile this then tell me the offset of _end in the ARM7 binary. You can find this info from the file arm7/build/.map. Look for _end then report the address next to it. This will help me figure out how much memory the MP3 decoder is using when compiled in r20 vs r21.<br/>_________________<br/><a class="postlink" href="http://chishm.drunkencoders.com" target="_blank">http://chishm.drunkencoders.com</a>
<br/>
<a class="postlink" href="http://dldi.drunkencoders.com" target="_blank">http://dldi.drunkencoders.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146657 - masscat - Fri Dec 07, 2007 11:27 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>chishm wrote:</b></span></td> </tr> <tr> <td class="quote">Could someone who is still using DKA r20 compile this then tell me the offset of _end in the ARM7 binary. You can find this info from the file arm7/build/.map. Look for _end then report the address next to it. This will help me figure out how much memory the MP3 decoder is using when compiled in r20 vs r21.</td> </tr></table><span class="postbody">
<br/>
A bit of the arm7 .map from a r20 compile:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">                0x038066fc                . = ALIGN (0x4)
<br/>
                0x038066fc                __bss_end = .
<br/>
                0x038066fc                __bss_end__ = .
<br/>
                0x038066fc                _end = .
<br/>
                0x038066fc                __end__ = .
<br/>
                0x038066fc                PROVIDE (end, _end)
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
<span style="font-weight: bold">Edit:</span> you can get the entire .map file <a class="postlink" href="http://masscat.afraid.org/ninds/aslib_1_0.map.txt" target="_blank">here</a>.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146659 - chishm - Fri Dec 07, 2007 11:44 am</h4>
    <div class="postbody"><span class="postbody">In r21, with the changes I suggest previously, the size is 0x03807970, which is 4724 bytes difference. I'm not sure what caused such a large size change, but that is the cause of memory overflows when compiling with r21.<br/>_________________<br/><a class="postlink" href="http://chishm.drunkencoders.com" target="_blank">http://chishm.drunkencoders.com</a>
<br/>
<a class="postlink" href="http://dldi.drunkencoders.com" target="_blank">http://dldi.drunkencoders.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146688 - Noda - Fri Dec 07, 2007 5:54 pm</h4>
    <div class="postbody"><span class="postbody">Ok, so I'll just move the allocated buffers in main ram and let the arm9 allocate it, but that bothers me as when the arm7 access main ram, it slows down the arm9..
<br/>
<br/>
But the way, do you know of much memory (rom+ram) is required for the dswifi/liblobby library?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146691 - kusma - Fri Dec 07, 2007 6:50 pm</h4>
    <div class="postbody"><span class="postbody">i think generating a map-file with both dka r20 and r21 and inspect the differences could be really useful here.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146704 - melw - Fri Dec 07, 2007 10:30 pm</h4>
    <div class="postbody"><span class="postbody">The biggest difference in .map files seems to be mktime that's still absent in DKA r20.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code"> .text          0x038012ec      0x7e4 c:/devkitpro/devkitarm/bin/../lib/gcc/arm-eabi/4.1.2/../../../../arm-eabi/lib\libg.a(lib_a-mktime.o)
<br/>
                0x038016a4                mktime
<br/>
 .text          0x03801ad0      0x848 c:/devkitpro/devkitarm/bin/../lib/gcc/arm-eabi/4.1.2/../../../../arm-eabi/lib\libg.a(lib_a-mktm_r.o)
<br/>
                0x03801ad0                __tzcalc_limits
<br/>
                0x03801d40                _mktm_r
<br/>
 .text          0x03802318        0x8</td> </tr></table><span class="postbody">
<br/>
i.e. 4140 bytes.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146947 - ThomasS - Tue Dec 11, 2007 9:12 pm</h4>
    <div class="postbody"><span class="postbody">I've succeeded to use this with PALib. To solve the memory-on-arm7 problem, I've let the arm9 pass the arm7 a pointer to a volatile part of main RAM and modified the helix function AllocateBuffers in real/buffers.c to locate its structures there instead of using malloc (I've already successfully used this with my own mp3 stuff).
<br/>
The sounds work fine. However, the mp3 included in the download doesn't work anymore. It plays very shortly, then stutters, and crashes no$gba or shuts down a real DS. MP3's with lower quality do work, however. Is this the normal behaviour if the decoding is too slow (because of using main RAM) or is something else wrong with it? If so, do you have a guess what it could be?<br/>_________________<br/>&lt;<a class="postlink" href="http://palib.info/forum/modules/newbb/viewtopic.php?viewmode=flat&amp;type=&amp;topic_id=3108&amp;forum=10" target="_blank">dsFont</a>&gt; &lt;<a class="postlink" href="http://palib.info/forum/modules/newbb/viewtopic.php?topic_id=2451&amp;forum=9" target="_blank">Game Collection</a>&gt;</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146959 - Noda - Wed Dec 12, 2007 2:58 am</h4>
    <div class="postbody"><span class="postbody">What you have done is what is was planning to do correct this issue ;)
<br/>
<br/>
The stuttering appear when the arm7 is too slow to decode the the mp3, and may lead to a crash, but never a shutdown, that's strange...
<br/>
<br/>
and concerning the example, the performance when using the main ram should be sufficient to decode the demo mp3 properly (it's 32kHz, stereo 80kbps), I'll investigate this problem when I'll update to r21.
<br/>
But in-game, using main ram for the mp3 structure could affect the arm9 performance as the memory cannot be accessed by both processors at the same time, AFAIK.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146992 - masscat - Wed Dec 12, 2007 7:36 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Noda wrote:</b></span></td> </tr> <tr> <td class="quote">But in-game, using main ram for the mp3 structure could affect the arm9 performance as the memory cannot be accessed by both processors at the same time, AFAIK.</td> </tr></table><span class="postbody">
<br/>
I wonder how this does affect the performance. Just thinking, it may not be that bad.
<br/>
<br/>
If the ARM7 is only accessing data in main memory then it will only be reading/writing main memory every few instructions.
<br/>
Since the ARM9 is normally running with its caches enabled it may be able to continue executing even when the ARM7 is blocking main memory.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#147113 - thoduv - Fri Dec 14, 2007 5:46 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>ThomasS wrote:</b></span></td> </tr> <tr> <td class="quote">mp3 included in the download doesn't work anymore. It plays very shortly, then stutters, and crashes no$gba or shuts down a real DS. MP3's with lower quality do work, however. Is this the normal behaviour if the decoding is too slow (because of using main RAM) or is something else wrong with it? If so, do you have a guess what it could be?</td> </tr></table><span class="postbody">
<br/>
I'm having exactly this problem with my own integration of HelixMP3... I haven't figured how to solve it yet...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#147126 - Noda - Fri Dec 14, 2007 8:16 pm</h4>
    <div class="postbody"><span class="postbody">The problem with this is simple and can't really be avoided: if the mp3 decoder is too slow, there will a moment the audio buffer will be refilled while in the same time being read by the sound hardware... crash.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#147151 - Michoko - Sat Dec 15, 2007 11:46 am</h4>
    <div class="postbody"><span class="postbody">Noda, what did you use to encode the MP3 you put as an example in your lib please?
<br/>
<br/>
I tried to replace the MP3 you're using with mines, to do a quick check. I get some normal results if I encode my MP3 as mono (using DBPowerAmp + LAME 3.97 encoder), but if I use the same settings with stereo option, I only can hear a slow tune with "metallic" sound.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#147162 - ThomasS - Sat Dec 15, 2007 6:03 pm</h4>
    <div class="postbody"><span class="postbody">What I've found out so far about my issues:
<br/>
<br/>
The problems depend on the version of LAME used to encode the MP3 and if the file is mono or stereo (the bitrate isn't the problem):
<br/>
<br/>
Official example with chism's changes:
<br/>
3.95 and 3.97: mono works, stereo works
<br/>
3.92: mono works, stereo doesn't get recognized as stereo and is played as mono
<br/>
<br/>
My PALib implementation:
<br/>
3.95 and 3.97: mono works, stereo crashes
<br/>
3.92: mono works, stereo doesn't get recognized as stereo and is played as mono
<br/>
<br/>
Michoko's "metallic" sound is also most likely a stereo file played as mono. To solve this, replace the following code:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">            // gather information about the format
<br/>
            MP3GetNextFrameInfo(hMP3Decoder, &amp;mp3FrameInfo, IPC_Sound-&gt;mp3.mp3buffer);
<br/>
            stereo = mp3FrameInfo.nChans &gt;&gt; 1;</td> </tr></table><span class="postbody">
<br/>
in as_lib7.c with
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">            // find the first sync word
<br/>
            u32 offset = MP3FindSyncWord(readPtr, bytesLeft);
<br/>
            readPtr += offset;
<br/>
            bytesLeft -= offset;
<br/>
    
<br/>
            // gather information about the format
<br/>
            MP3GetNextFrameInfo(hMP3Decoder, &amp;mp3FrameInfo, readPtr);
<br/>
            stereo = mp3FrameInfo.nChans &gt;&gt; 1;</td> </tr></table><span class="postbody">
<br/>
Now my stereo files from the version 3.92 got recognized correctly.
<br/>
<br/>
I've still not solved the second issue, that stereo files crash my program.
<br/>
The problem seems to be that numsamples gets too big (at all bitrates, even 30kbps), and then the program writes data behind the mixbuffer and crashes.
<br/>
I can improve the situation by increasing AS_AUDIOBUFFER_SIZE in as_lib9.h, then it doesn't crash anymore, but it still stutters from time to time and writes data behind the buffer.
<br/>
I didn't get why this still happens then yet. Maybe a timer issue? But the PALib arm7 code doesn't seem to set any of the timers ...<br/>_________________<br/>&lt;<a class="postlink" href="http://palib.info/forum/modules/newbb/viewtopic.php?viewmode=flat&amp;type=&amp;topic_id=3108&amp;forum=10" target="_blank">dsFont</a>&gt; &lt;<a class="postlink" href="http://palib.info/forum/modules/newbb/viewtopic.php?topic_id=2451&amp;forum=9" target="_blank">Game Collection</a>&gt;</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#147165 - Noda - Sat Dec 15, 2007 6:27 pm</h4>
    <div class="postbody"><span class="postbody">The problem with PALib is that they do various other things in the VBL loop, so this eats some CPU power I think... also, it include the WifiLib which make use of timers! so that may be the problem..
<br/>
<br/>
My mp3 was encoded with Wavelab 5.0, which use Lame (don't know the versiion though).
<br/>
<br/>
But it plays fine on my DS (and some others), but one has crackling problem with the exacct same binary, which is quite strange :/
<br/>
<br/>
<br/>
And thanks for the .92 fix, I wasn't aware of that problem, I'll correct that in the lib.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#147181 - chishm - Sun Dec 16, 2007 1:47 am</h4>
    <div class="postbody"><span class="postbody">I strongly advise against having the sound mixer called from a vblank or vcount interrupt. Depending on how your interrupt handler is set up, if the mixer runs over time (longer than 1/60th of a second) during an interrupt, it will get called again, while the first one is still processing. Since it is definitely not re-entrant, you'll get data corruption, leading to crashes. Alternatively, it will delay all other interrupts from being processed until it is finished, including IPC FIFO and IPC structure updates.
<br/>
<br/>
Stick the call to the mixer in your main loop instead. This way, it won't prevent interrupts from occurring, and it won't be called more than once at a time. The worst that can happen is the audio decoding falls behind slightly for one or two frames, but provided you have a large enough decode buffer and the MP3 is not too complex for the ARM7 to actually handle, the decoder should catch up with the next call to the mixer.<br/>_________________<br/><a class="postlink" href="http://chishm.drunkencoders.com" target="_blank">http://chishm.drunkencoders.com</a>
<br/>
<a class="postlink" href="http://dldi.drunkencoders.com" target="_blank">http://dldi.drunkencoders.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#147209 - Noda - Sun Dec 16, 2007 7:36 am</h4>
    <div class="postbody"><span class="postbody">The sound mixer which handle the audio stream &amp; decode the mp3 is already in the main loop and not called by an interrupt ;) on the vblank IRQ there's only the code which set up the sound channels and change the channels parameters (volume, pan etc..) which is way faster than 1/60s, so the problem is not here.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#147500 - Noda - Fri Dec 21, 2007 7:28 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>ecurtz wrote:</b></span></td> </tr> <tr> <td class="quote">WARNING: This was written on the bus this morning and I almost never do any assembly programming, so it's guarenteed to have a bug or two.
<br/>
<br/>
(All that indexing in the loop was driving me nuts)
<br/>
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
// desinterleave a stereo source (thanks to Thoduv for the code)
<br/>
// version 2 by ecurtz (optimized loop)
<br/>
asm (
<br/>
"@--------------------------------------------------------------------------------------\n"
<br/>
"    .text                                                                              \n"
<br/>
"    .arm                                                                               \n"
<br/>
"                                                                                       \n"
<br/>
"@ desinterleave an mp3 stereo source                                                   \n"
<br/>
"@ r0 = interleaved data, r1 = left, r2 = right, r3 = len                               \n"
<br/>
"                                                                                       \n"
<br/>
"    .global AS_StereoDesinterleave                                                     \n"
<br/>
"                                                                                       \n"
<br/>
"AS_StereoDesinterleave :                                                               \n"
<br/>
"    stmfd sp!, {r5-r11}                                                                \n"
<br/>
"                                                                                       \n"
<br/>
"@ get the 3 low bits of len                                                            \n"
<br/>
"    ands r5, r3, #7                                                                    \n"
<br/>
"@ if 0 jump to the loop                                                                \n"
<br/>
"    beq _loop                                                                          \n"
<br/>
"@ load data, we know r5 won't be used in incomplete loop                               \n"
<br/>
"    ldmia r0, {r6-r12}                                                                 \n"
<br/>
"@ adjust data and len by amount we're actually using                                   \n"
<br/>
"    add  r0, r5, lsl #2                                                                \n"
<br/>
"    sub  r3, r5                                                                        \n"
<br/>
"@ r5 = 8 - r5 (amount of loop to skip)                                                 \n"
<br/>
"    rsb  r5, #8                                                                        \n"
<br/>
"@ r5 = r5 * 3 instructions per sample                                                  \n"
<br/>
"    add  r5, r5, lsl #1                                                                \n"
<br/>
"@ slam the pc forward into the loop (automatically skips next instruction)             \n"
<br/>
"    add pc, r5, lsl #2                                                                 \n"
<br/>
"                                                                                       \n"
<br/>
"_loop:                                                                                 \n"
<br/>
"    ldmia r0!, {r5-r12}                                                                \n"
<br/>
"                                                                                       \n"
<br/>
"    strh r5, [r1], #2                                                                  \n"
<br/>
"    mov r5, r5, lsr #16                                                                \n"
<br/>
"    strh  r5, [r2], #2                                                                 \n"
<br/>
"                                                                                       \n"
<br/>
"    strh r6, [r1], #2                                                                  \n"
<br/>
"    mov r6, r6, lsr #16                                                                \n"
<br/>
"    strh  r6, [r2], #2                                                                 \n"
<br/>
"                                                                                       \n"
<br/>
"    strh r7, [r1], #2                                                                  \n"
<br/>
"    mov r7, r7, lsr #16                                                                \n"
<br/>
"    strh  r7, [r2], #2                                                                 \n"
<br/>
"                                                                                       \n"
<br/>
"    strh r8, [r1], #2                                                                  \n"
<br/>
"    mov r8, r8, lsr #16                                                                \n"
<br/>
"    strh  r8, [r2], #2                                                                 \n"
<br/>
"                                                                                       \n"
<br/>
"    strh r9, [r1], #2                                                                  \n"
<br/>
"    mov r9, r9, lsr #16                                                                \n"
<br/>
"    strh  r9, [r2], #2                                                                 \n"
<br/>
"                                                                                       \n"
<br/>
"    strh r10, [r1], #2                                                                 \n"
<br/>
"    mov r10, r10, lsr #16                                                              \n"
<br/>
"    strh  r10, [r2], #2                                                                \n"
<br/>
"                                                                                       \n"
<br/>
"    strh r11, [r1], #2                                                                 \n"
<br/>
"    mov r11, r10, lsr #16                                                              \n"
<br/>
"    strh  r11, [r2], #2                                                                \n"
<br/>
"                                                                                       \n"
<br/>
"    strh r12, [r1], #2                                                                 \n"
<br/>
"    mov r12, r12, lsr #16                                                              \n"
<br/>
"    strh  r12, [r2], #2                                                                \n"
<br/>
"                                                                                       \n"
<br/>
"    subs r3, #8                                                                        \n"
<br/>
"    bne _loop                                                                          \n"
<br/>
"                                                                                       \n"
<br/>
"    ldmia sp!, {r5-r11}                                                                \n"
<br/>
"    bx lr                                                                              \n"
<br/>
"@--------------------------------------------------------------------------------------\n"
<br/>
);
<br/>
</td> </tr></table><span class="postbody"></span></td> </tr></table><span class="postbody">
<br/>
<br/>
just tried, it crashes the emu/DS.
<br/>
<br/>
BTW, I added an arm7 init function as M3S/R4 cards don't seem to clear the memory before loading the .nds files.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#147503 - ecurtz - Fri Dec 21, 2007 8:55 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Noda wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>ecurtz wrote:</b></span></td> </tr> <tr> <td class="quote">WARNING: This was written on the bus this morning and I almost never do any assembly programming, so it's guarenteed to have a bug or two.
<br/>
<br/>
(All that indexing in the loop was driving me nuts)
<br/>
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
just tried, it crashes the emu/DS.
<br/>
<br/>
BTW, I added an arm7 init function as M3S/R4 cards don't seem to clear the memory before loading the .nds files.</span></td> </tr></table><span class="postbody">
<br/>
<br/>
Bah, I'll fix it as soon as I get a chance to actually compile and test. As I mentioned it was just typed in during my commute.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#147512 - ecurtz - Fri Dec 21, 2007 10:48 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
// desinterleave a stereo source (thanks to Thoduv for the code)
<br/>
// version 2 by ecurtz (optimized loop)
<br/>
asm (
<br/>
"@--------------------------------------------------------------------------------------\n"
<br/>
"    .text                                                                              \n"
<br/>
"    .arm                                                                               \n"
<br/>
"                                                                                       \n"
<br/>
"@ desinterleave an mp3 stereo source                                                   \n"
<br/>
"@ r0 = interleaved data, r1 = left, r2 = right, r3 = len                               \n"
<br/>
"                                                                                       \n"
<br/>
"    .global AS_StereoDesinterleave                                                     \n"
<br/>
"                                                                                       \n"
<br/>
"AS_StereoDesinterleave :                                                               \n"
<br/>
"    stmfd sp!, {r4-r11}                                                                \n"
<br/>
"                                                                                       \n"
<br/>
"@ get the 3 low bits of len                                                            \n"
<br/>
"    ands r4, r3, #7                                                                    \n"
<br/>
"@ if 0 jump to the loop                                                                \n"
<br/>
"    beq _loop                                                                          \n"
<br/>
"@ r4 = 8 - r4 (amount of loop to skip)                                                 \n"
<br/>
"    rsb  r4, #8                                                                        \n"
<br/>
"@ adjust data to include what we're actually using                                     \n"
<br/>
"    sub  r0, r4, lsl #2                                                                \n"
<br/>
"@ load data                                                                            \n"
<br/>
"    ldmia r0!, {r5-r12}                                                                \n"
<br/>
"@ bump count as if we were completing full loop                                        \n"
<br/>
"    add  r3, r4                                                                        \n"
<br/>
"@ r4 = r4 * 3 instructions per sample                                                  \n"
<br/>
"    add  r4, r4, lsl #1                                                                \n"
<br/>
"@ slam the pc forward into the loop (automatically skips next instruction)             \n"
<br/>
"    add pc, r4, lsl #2                                                                 \n"
<br/>
"                                                                                       \n"
<br/>
"_loop:                                                                                 \n"
<br/>
"    ldmia r0!, {r5-r12}                                                                \n"
<br/>
"                                                                                       \n"
<br/>
"    strh r5, [r1], #2                                                                  \n"
<br/>
"    mov r5, r5, lsr #16                                                                \n"
<br/>
"    strh  r5, [r2], #2                                                                 \n"
<br/>
"                                                                                       \n"
<br/>
"    strh r6, [r1], #2                                                                  \n"
<br/>
"    mov r6, r6, lsr #16                                                                \n"
<br/>
"    strh  r6, [r2], #2                                                                 \n"
<br/>
"                                                                                       \n"
<br/>
"    strh r7, [r1], #2                                                                  \n"
<br/>
"    mov r7, r7, lsr #16                                                                \n"
<br/>
"    strh  r7, [r2], #2                                                                 \n"
<br/>
"                                                                                       \n"
<br/>
"    strh r8, [r1], #2                                                                  \n"
<br/>
"    mov r8, r8, lsr #16                                                                \n"
<br/>
"    strh  r8, [r2], #2                                                                 \n"
<br/>
"                                                                                       \n"
<br/>
"    strh r9, [r1], #2                                                                  \n"
<br/>
"    mov r9, r9, lsr #16                                                                \n"
<br/>
"    strh  r9, [r2], #2                                                                 \n"
<br/>
"                                                                                       \n"
<br/>
"    strh r10, [r1], #2                                                                 \n"
<br/>
"    mov r10, r10, lsr #16                                                              \n"
<br/>
"    strh  r10, [r2], #2                                                                \n"
<br/>
"                                                                                       \n"
<br/>
"    strh r11, [r1], #2                                                                 \n"
<br/>
"    mov r11, r11, lsr #16                                                              \n"
<br/>
"    strh  r11, [r2], #2                                                                \n"
<br/>
"                                                                                       \n"
<br/>
"    strh r12, [r1], #2                                                                 \n"
<br/>
"    mov r12, r12, lsr #16                                                              \n"
<br/>
"    strh  r12, [r2], #2                                                                \n"
<br/>
"                                                                                       \n"
<br/>
"    subs r3, #8                                                                        \n"
<br/>
"    bne _loop                                                                          \n"
<br/>
"                                                                                       \n"
<br/>
"    ldmia sp!, {r4-r11}                                                                \n"
<br/>
"    bx lr                                                                              \n"
<br/>
"@--------------------------------------------------------------------------------------\n"
<br/>
);</td> </tr></table><span class="postbody">
<br/>
<br/>
I think that fixed it. The bug was with the condition code checking the loop, it went negative if there wasn't an even amount of data. Is there a condition code for a postive result (not zero or negative?) that's what I need for this, but I just modified the loop value so it thinks it's completed 8 steps on the partial case.
<br/>
<br/>
edit -&gt; OK, tested new code against the original for 1-31 samples, looks good at this point. &lt;-</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#148056 - Michoko - Tue Jan 01, 2008 3:29 pm</h4>
    <div class="postbody"><span class="postbody">Hi,
<br/>
<br/>
First of all, Happy New Year! :)
<br/>
<br/>
I'm currently testing the <b style="color:#FFA34F">ASlib</b> port made by Thomas for usage with PAlib. And I think I encountered a problem which is not PAlib related but more global.
<br/>
<br/>
I'm using EFSlib for storing many small texts files in my ROM. Depending on the actions in my game, I load those small text files (it's an adventure book project). I'm streaming an MP3 file at the same time. Under NO$GBA + FCSR + Libfat mode only (for both EFS and <b style="color:#FFA34F">ASlib</b>), everything works fine. But when I want to switch to full EFS implementation on real DS hardware, I get random freezes whenever I try to load text files while the music is streaming.
<br/>
<br/>
I was suspecting a bug due to concurrent access to two files in the EFS file system at the same time, so I left the "#define AS_USE_EFS" line commented, so <b style="color:#FFA34F">ASlib</b> uses pure libfat access. I kept the rest of the code untouched (so the text files are still loaded using EFS) and copied the MP3 file directly on my linker. And it seems to work fine, which may confirm that it's an issue related to the access to an EFS file while MP3 is streaming using EFS at the same time.
<br/>
<br/>
Noda, do you think it would be necessary to add some kind of simple lockup system in EFSlib to prevent this bug?
<br/>
<br/>
Thanks for your reply! :)
<br/>
Michoko</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#148100 - Noda - Wed Jan 02, 2008 7:20 am</h4>
    <div class="postbody"><span class="postbody">Hi ;)
<br/>
<br/>
Just quickly because I just came back from NY (yeah I was on Time Square 8-p): the EFS support in <b style="color:#FFA34F">ASLib</b> has not been tested, so I think that's it, I'll check that, multiple file access should not be a problem ;)
<br/>
<br/>
happy new year everyone ^^</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#148236 - melw - Thu Jan 03, 2008 9:01 pm</h4>
    <div class="postbody"><span class="postbody">Few more remarks using <b style="color:#FFA34F">ASlib</b> with DKA R21: If you don't want to waste extra VRAM bank for arm7 as with Chishm's version, one possibility is to comment rtcReset() from arm7 main (that is, if realtime clock isn't needed in your project). This cuts the arm7 size with 4kb, which seems to be enough for Helix decoder to function properly.
<br/>
<br/>
Another remark what comes to highest possible bitrates: Streaming from the disk results far more often to decoding errors than direct play from the memory. I didn't look at the inner workings, but perhaps there should be a larger buffer for streaming from the disk or reading more in advance to help with the performance? With M3Lite and 1Gb Kingston MicroSD card I had problems playing as low as 40kbit mono MP3's, glitches and decoding errors all around, and 56kbit mono MP3 crashing almost immediately.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#148239 - Lazy1 - Thu Jan 03, 2008 9:10 pm</h4>
    <div class="postbody"><span class="postbody">Maybe it just needs to be fed more often on the arm9 side, maybe start a timer and update every 1-4ms.
<br/>
The first version of my decoder checked if the arm7 needed to be fed during hblank and that seemed to work fine for 128kbps mono MP3s.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#148396 - Michoko - Sat Jan 05, 2008 11:02 am</h4>
    <div class="postbody"><span class="postbody">I take my words back, now even when streaming in pure libfat mode I get freezes and lockups if I try to load files from EFS at the same time.
<br/>
<br/>
So it appears to be a broader issue happening when you try to access data from the linker both from a random file AND your MP3. It doesn't occur all the time, but probably when the decoding buffer tries to refill itself.
<br/>
<br/>
It seems I'm stuck for now and I'll have to stick with MP3 fully loaded in RAM.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#148446 - DekuTree64 - Sat Jan 05, 2008 9:13 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Michoko wrote:</b></span></td> </tr> <tr> <td class="quote">So it appears to be a broader issue happening when you try to access data from the linker both from a random file AND your MP3. It doesn't occur all the time, but probably when the decoding buffer tries to refill itself.</td> </tr></table><span class="postbody">
<br/>
File systems and interrupts are old enemies. Can you stream the MP3 data from your main loop on the ARM9? Maybe keep a big buffer of compressed data in memory, and then just let ARM7 eat up little bits of it at a time from an interrupt or whatever it likes to do.<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#148479 - chishm - Sun Jan 06, 2008 7:55 am</h4>
    <div class="postbody"><span class="postbody">It appears that EFSlib is using a single FILE* for all libfat calls, with seeks at the start of each read. This is why you get massive slow down when reading another file in the NitroFS at the same time. Seeks are an expensive operation when they jump backwards or make a large jump forwards.
<br/>
<br/>
As an efficiency improvement, I suggest EFSlib be recoded to use one libfat file handle for the NitroFS directory and create a new one (by opening the NDS file again) for each NitroFS file opened. This should be an optional setting, as there can also be efficiency gains by using the one libfat file handle for all operations, eg when many NitroFS files are opened, read, then closed at once.<br/>_________________<br/><a class="postlink" href="http://chishm.drunkencoders.com" target="_blank">http://chishm.drunkencoders.com</a>
<br/>
<a class="postlink" href="http://dldi.drunkencoders.com" target="_blank">http://dldi.drunkencoders.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#148513 - Noda - Sun Jan 06, 2008 5:06 pm</h4>
    <div class="postbody"><span class="postbody">Nice suggestion, I'll dig that for a future release ;)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#148515 - Michoko - Sun Jan 06, 2008 5:20 pm</h4>
    <div class="postbody"><span class="postbody">Nice indeed! We can't wait! ;)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#148668 - kusma - Tue Jan 08, 2008 6:11 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>melw wrote:</b></span></td> </tr> <tr> <td class="quote">The biggest difference in .map files seems to be mktime that's still absent in DKA r20.
<br/>
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code"> .text          0x038012ec      0x7e4 c:/devkitpro/devkitarm/bin/../lib/gcc/arm-eabi/4.1.2/../../../../arm-eabi/lib\libg.a(lib_a-mktime.o)
<br/>
                0x038016a4                mktime
<br/>
 .text          0x03801ad0      0x848 c:/devkitpro/devkitarm/bin/../lib/gcc/arm-eabi/4.1.2/../../../../arm-eabi/lib\libg.a(lib_a-mktm_r.o)
<br/>
                0x03801ad0                __tzcalc_limits
<br/>
                0x03801d40                _mktm_r
<br/>
 .text          0x03802318        0x8</td> </tr></table><span class="postbody">
<br/>
i.e. 4140 bytes.</span></td> </tr></table><span class="postbody">
<br/>
<br/>
Just noticed this, all mktime-stuff dissapears for me if I remove the call to initClockIRQ() btw. If you need those 4k and RTC is not needed, you might save this memory.
<br/>
<br/>
edit: and for this libs example, that would most likely be rtcReset(), but I haven't tested that.
<br/>
<br/>
edit2: ...but apparently melw had. I didn't see that until now, sorry ;)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#149478 - Jesse - Sun Jan 20, 2008 8:48 pm</h4>
    <div class="postbody"><span class="postbody">I'm having trouble getting the example-project to compile &amp; run. The included .nds works fine, but when I try to compile it myself there is constant noise in the speakers while running the app, and starting a sample generates even more noise (sometimes resembling the original sample). I did a fresh install of devkitPro and tried both the suggested fixes for the devkitARM r21 problems (even though that looked like another issue). chisms' fix locked up in the waiting for VRAM loop. I'm running a M3 Simply and a R4 revolution. Also, I found a small update to the lib on the download site, but that didn't help and just made it lock up in the waiting for Arm7 loop.
<br/>
<br/>
I feels like it should be something wrong with my setup, since the included .nds works and other seems to have been able to compile it properly, but I can't figure what it could be. Anyone has any ideas?<br/>_________________<br/><a href="http://www.collectingsmiles.com/colors" target="_blank">http://www.collectingsmiles.com/colors</a> &amp; <a href="http://www.collectingsmiles.com/hyena" target="_blank">http://www.collectingsmiles.com/hyena</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#149502 - Noda - Mon Jan 21, 2008 6:00 am</h4>
    <div class="postbody"><span class="postbody">you have a M3S/R4 card, right? It's because your card doesn't clear memory before loading the homebrew, causing wrong values in my variables. I have fixed this by doing a safe initilization sequence on both processors in the current (soon to be released) version.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#149515 - Jesse - Mon Jan 21, 2008 1:32 pm</h4>
    <div class="postbody"><span class="postbody">Thanks, I'm looking forward to testing it. Still, I don't understand how that can explain that the included .nds works while the one I build don't.<br/>_________________<br/><a href="http://www.collectingsmiles.com/colors" target="_blank">http://www.collectingsmiles.com/colors</a> &amp; <a href="http://www.collectingsmiles.com/hyena" target="_blank">http://www.collectingsmiles.com/hyena</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#149953 - Jesse - Sun Jan 27, 2008 10:21 pm</h4>
    <div class="postbody"><span class="postbody">Ok. I got this working at last. I still don't know why my the original version never compiled properly for me, but after integrating the fixes I found and debugging the lib to understand what was missing, it is working as it should on my R4.
<br/>
<br/>
With both liblobby and libwifi (as well as my need for a RTC) in there is not enough memory on the Arm7. With the VRAM trick it worked as it should though, but I wish there was a cheaper way.
<br/>
<br/>
But anyway, thanks a bunch Noda, the thing I'm working on right now would have been meaningless without a mp3-lib. :)
<br/>
<br/>
Edit: I also get this metallic-like sound when playing a 16khz mono-mp3. It feels like one speaker is lagging behind. Here's the link if anyone wants to test it: <a href="http://www.collectingsmiles.com/temp/mono.rar" target="_blank">http://www.collectingsmiles.com/temp/mono.rar</a>
<br/>
Edit2: I'm having problems playing multiple mp3's after each other. I can't find a good way to write a IsPlaying function, since the status-variable doesn't change until the Arm7 has processed the play-command.<br/>_________________<br/><a href="http://www.collectingsmiles.com/colors" target="_blank">http://www.collectingsmiles.com/colors</a> &amp; <a href="http://www.collectingsmiles.com/hyena" target="_blank">http://www.collectingsmiles.com/hyena</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#149985 - Jesse - Mon Jan 28, 2008 12:41 pm</h4>
    <div class="postbody"><span class="postbody">I guess my app is a real stress-test for this thing as I play many short mp3s after each other.
<br/>
<br/>
Right now I'm looking at instability problems in about 10% of the times I start playing. The lib sometimes reports MP3ST_DECODE_ERROR and sometimes it just crashes the Arm7. The mentioned problems about interrupts and file-system doesn't apply if you only read data on the Arm9 in the main thread, right?
<br/>
<br/>
By the way. What's the best way for the Arm9 to generally keep track of what's happening on the Arm7? Right now I'm sending a FIFO command in Vblank every 2 seconds to determine if the Arm7 has crashed.
<br/>
<br/>
EDIT: Juming to conclusions again... Instability is basically gone. I backtracked in the posts and found out about the Arm7/Arm9 cache issue, and also the AS_MP3StreamPlay function I completely missed. I still get decode-error 1 in 10, but only on the first sample weirdly enough.<br/>_________________<br/><a href="http://www.collectingsmiles.com/colors" target="_blank">http://www.collectingsmiles.com/colors</a> &amp; <a href="http://www.collectingsmiles.com/hyena" target="_blank">http://www.collectingsmiles.com/hyena</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#149989 - kusma - Mon Jan 28, 2008 2:04 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Jesse wrote:</b></span></td> </tr> <tr> <td class="quote">I guess my app is a real stress-test for this thing as I play many short mp3s after each other.</td> </tr></table><span class="postbody">
<br/>
This strikes me as a bad idea, since MP3-streams really don't have any well-defined starts and stops. The usual way to cope with this is to add silence to the beginning and end of the streams, but that won't work well if you want the different sounds stitched together to sound continuous. Maybe I'm not understanding what you're doing, though.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#149997 - Jesse - Mon Jan 28, 2008 6:12 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>kusma wrote:</b></span></td> </tr> <tr> <td class="quote">This strikes me as a bad idea, since MP3-streams really don't have any well-defined starts and stops.</td> </tr></table><span class="postbody">
<br/>
Well, I'm only stitching together voice, so I'm hopefully fine. Thanks for the heads-up.<br/>_________________<br/><a href="http://www.collectingsmiles.com/colors" target="_blank">http://www.collectingsmiles.com/colors</a> &amp; <a href="http://www.collectingsmiles.com/hyena" target="_blank">http://www.collectingsmiles.com/hyena</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#150002 - Noda - Mon Jan 28, 2008 7:23 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Jesse wrote:</b></span></td> </tr> <tr> <td class="quote">Ok. I got this working at last. I still don't know why my the original version never compiled properly for me, but after integrating the fixes I found and debugging the lib to understand what was missing, it is working as it should on my R4.
<br/>
<br/>
With both liblobby and libwifi (as well as my need for a RTC) in there is not enough memory on the Arm7. With the VRAM trick it worked as it should though, but I wish there was a cheaper way.
<br/>
<br/>
But anyway, thanks a bunch Noda, the thing I'm working on right now would have been meaningless without a mp3-lib. :)
<br/>
<br/>
Edit: I also get this metallic-like sound when playing a 16khz mono-mp3. It feels like one speaker is lagging behind. Here's the link if anyone wants to test it: <a href="http://www.collectingsmiles.com/temp/mono.rar" target="_blank">http://www.collectingsmiles.com/temp/mono.rar</a>
<br/>
Edit2: I'm having problems playing multiple mp3's after each other. I can't find a good way to write a IsPlaying function, since the status-variable doesn't change until the Arm7 has processed the play-command.</td> </tr></table><span class="postbody">
<br/>
<br/>
The mettalic sound is a stereo detection problem which appears with some version of Lame. It has been corrected in the (yet to released) current version.
<br/>
<br/>
Concerning the isPlaying() function:
<br/>
<br/>
inline bool isMP3Playing() { return (AS_GetMP3Status() &amp; MP3ST_PLAYING); }</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#150011 - Jesse - Mon Jan 28, 2008 9:54 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Noda wrote:</b></span></td> </tr> <tr> <td class="quote">The mettalic sound is a stereo detection problem which appears with some version of Lame. It has been corrected in the (yet to released) current version.</td> </tr></table><span class="postbody">
<br/>
Oh, I thought that was only the other way around. My sounds are mono. I hope you are right! :)
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Noda wrote:</b></span></td> </tr> <tr> <td class="quote">Concerning the isPlaying() function:
<br/>
<br/>
inline bool isMP3Playing() { return (AS_GetMP3Status() &amp; MP3ST_PLAYING); }</td> </tr></table><span class="postbody">
<br/>
That doesn't work since the status doens't set until Arm7 has processed the command. If I would use this, and check to early it would report that it isn't playing (I need to know that it has _finished_ playing). Right now I get around this by waiting a vbl after starting playing. That works ok for now.
<br/>
<br/>
Thanks.<br/>_________________<br/><a href="http://www.collectingsmiles.com/colors" target="_blank">http://www.collectingsmiles.com/colors</a> &amp; <a href="http://www.collectingsmiles.com/hyena" target="_blank">http://www.collectingsmiles.com/hyena</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#150465 - Jesse - Mon Feb 04, 2008 11:19 pm</h4>
    <div class="postbody"><span class="postbody">I managed to fix the metallic sound. It was due to mp3s always being played in with the surround delay, which cause the two speakers to play out of sync. A small hack in the arm7 code fixed that for me.
<br/>
<br/>
I've released an app using this lib now: <a href="http://forum.gbadev.org/viewtopic.php?t=14979" target="_blank">http://forum.gbadev.org/viewtopic.php?t=14979</a>
<br/>
<br/>
Thanks.<br/>_________________<br/><a href="http://www.collectingsmiles.com/colors" target="_blank">http://www.collectingsmiles.com/colors</a> &amp; <a href="http://www.collectingsmiles.com/hyena" target="_blank">http://www.collectingsmiles.com/hyena</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#150467 - Noda - Mon Feb 04, 2008 11:30 pm</h4>
    <div class="postbody"><span class="postbody">Could you post that hack please?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#150468 - Jesse - Mon Feb 04, 2008 11:38 pm</h4>
    <div class="postbody"><span class="postbody">Well, I don't think it's very usable for you, but I just replaced</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">IPC_Sound-&gt;chan[IPC_Sound-&gt;mp3.channelR].snd.delay = IPC_Sound-&gt;mp3.delay;
<br/>
IPC_Sound-&gt;chan[IPC_Sound-&gt;mp3.channelR].cmd |= SNDCMD_DELAY;</td> </tr></table><span class="postbody">with</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">IPC_Sound-&gt;chan[IPC_Sound-&gt;mp3.channelR].snd.delay = 0;
<br/>
IPC_Sound-&gt;chan[IPC_Sound-&gt;mp3.channelR].cmd |= SNDCMD_PLAY;</td> </tr></table><span class="postbody">
<br/>
And thereby removing all surround possibilites. I guess a proper fix would be to:
<br/>
1. Not post a delay command if mp3 is on mono or mp3.delay is already 0
<br/>
2. Fix so that surround is not used if the surround flag isn't specified in Init.<br/>_________________<br/><a href="http://www.collectingsmiles.com/colors" target="_blank">http://www.collectingsmiles.com/colors</a> &amp; <a href="http://www.collectingsmiles.com/hyena" target="_blank">http://www.collectingsmiles.com/hyena</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#150473 - Noda - Tue Feb 05, 2008 2:10 am</h4>
    <div class="postbody"><span class="postbody">Surround works fine even with mono mp3's, but it may lead to some strange effect in particular cases (like your metallic sound).
<br/>
<br/>
The correct way to do this is to use this command:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">// set the default mp3 delay mode (warning: high values can cause glitches)
<br/>
void AS_SetMP3Delay(u8 delay);</td> </tr></table><span class="postbody">
<br/>
<br/>
Just call SetMP3Delay(AS_NO_DELAY); and you're done, no need for your correction.
<br/>
<br/>
If the delay is already 0, then it has the same effect as SNDCMD_PLAY.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#150635 - wondersye - Sat Feb 09, 2008 12:38 am</h4>
    <div class="postbody"><span class="postbody">Hi,
<br/>
<br/>
I just wanted to share an alternate implementation of a mp3 player on the ARM7. It is by no means as complete as Noda's Advanced Sound Library (for my project, no need of stereo, surround, etc.) but, being more lightweight, the .bin fits in 61 ko. I tried to choose reliable and efficient solutions, all details are listed <a class="postlink" href="http://osdl.sourceforge.net/main/documentation/OSDL/OSDL-generic/Helix-OSDL/helix-osdl.html" target="_blank">here</a>.
<br/>
<br/>
By the way, many thanks to Noda, ThomasS, DekuTree64 and al for sharing their knowledge !</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#153258 - Massif - Thu Mar 27, 2008 4:30 am</h4>
    <div class="postbody"><span class="postbody">I'm having some issues with AS_SetMP3Loop().
<br/>
<br/>
I have one song that loops during the game. This works fine. However, when the game is over I stop it, set loop to false, then play another MP3. This song also loops even though it shouldn't. 
<br/>
<br/>
NOTE: I also tried changing the AS_SetMP3Loop(true) to false, but the first song still loops. If I remove the call entirely, it doesn't loop.
<br/>
<br/>
 Am I using the loop command incorrectly?
<br/>
<br/>
Here's the snippet that is loading the first and second MP3s:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
AS_MP3Stop();
<br/>
AS_SetMP3Loop(true);
<br/>
AS_MP3DirectPlay((u8*)ragingcards_80kbps_32kHz_mono_mp3, (u32)ragingcards_80kbps_32kHz_mono_mp3_size);
<br/>
<br/>
<br/>
...
<br/>
<br/>
AS_MP3Stop();
<br/>
AS_SetMP3Loop(false);
<br/>
AS_MP3DirectPlay((u8*)victory_80kbps_32kHz_mono_mp3, (u32)victory_80kbps_32kHz_mono_mp3_size);
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
EDIT: Nevermind, I didn't even bother to check the inner workings of the function. It sets loop to true regardless of what is passed in.<br/>_________________<br/>Massif - It means mountain.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#153264 - TheMagnitude - Thu Mar 27, 2008 12:16 pm</h4>
    <div class="postbody"><span class="postbody">Wow, a MP3 codec for DS, nice job!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#154194 - melw - Sat Apr 12, 2008 7:34 pm</h4>
    <div class="postbody"><span class="postbody">I just noticed that in all of the projects I've used ASlib there's significant problems with R4DS - I have no idea if this general problem or just something related to this adapter / sd card, as there hasn't been other complaints, but running the AS_MP3Engine() on ARM7 causes continuous rumble noise. This is also true even if there's no playback, the noise exists always. In one of the project I also get immediate crash on R4. Using default exception handler gives a red screen but no text, however the noise keeps on going even after the crash.
<br/>
<br/>
All of the applications I tested run perfectly on M3 Lite, which is also my primary development adapter. Any ideas?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#154195 - SiW - Sat Apr 12, 2008 7:48 pm</h4>
    <div class="postbody"><span class="postbody">I'm using ASlib with the R4DS.  I'm having some issues (instability mostly - sometimes MP3 audio just cuts out), but I put them down to my code - do you have any examples of your projects I can try out?
<br/>
<br/>
I can't say I'm experiencing this rumble noise though.  Which version of ASlib are you using?  There is updated code on <a class="postlink" href="http://noda.free.fr/nds/" target="_blank">Noda's site</a> and I'm using the latest.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#154196 - melw - Sat Apr 12, 2008 8:00 pm</h4>
    <div class="postbody"><span class="postbody">For example <a class="postlink" href="http://dicewars.drunkencoders.com/index.php?page=snowflakes" target="_blank">this one</a>. Although I just realized I'm probably using an old version, so let's see if compiling with the latest version helps here...
<br/>
<br/>
EDIT: Unzipped the newest aslib.rar (10/03/08) and now there's no sound, just blank screen and nothing seems to work even on the M3 Lite. :) Did anything change in the template or in the way how the library should be used?
<br/>
<br/>
EDIT 2: This seems to be the case even with the template. Did the upgrade break / add something that prevents ASlib from working with devkitARM R21? I'm bit confused now with all the simultaneous versions, what should be used and what works. The original v1.0 is so far the only one that I've used succesfully with R21, but gives the problems described before with R4DS.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#154201 - Noda - Sat Apr 12, 2008 8:55 pm</h4>
    <div class="postbody"><span class="postbody">yes, the latest released ASLib version does not work with DKP r21. I've already fixed the problem, but still didn't released it yet as I'm quite busy with school work for now :/</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#154209 - SiW - Sat Apr 12, 2008 10:13 pm</h4>
    <div class="postbody"><span class="postbody">Sorry melw, I should have said I was also using the ARM7 fixes mentioned in this thread (either disabling the use of the RTC, or optimizing for size instead of speed) so that the ARM7 binary is small enough in r21.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#154214 - melw - Sat Apr 12, 2008 10:45 pm</h4>
    <div class="postbody"><span class="postbody">SiW, No RTC used either, so ARM7 size isn't a problem. 
<br/>
<br/>
Noda, if you have the latest development / test version laying around somewhere, I'd be more than willing to help with testing.
<br/>
<br/>
Until then, I guess I'll just rollback to older version and forget R4DS for a while... not in such a big hurry anyways.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#154224 - SiW - Sun Apr 13, 2008 12:58 am</h4>
    <div class="postbody"><span class="postbody">I just tested snowflakes on my R4 and did indeed get the background "roar".
<br/>
<br/>
As to getting the current ASlib (or as current as you have available to download, Noda :)) running on r21, make sure you call AS_Init() in your ARM7 startup.  I also have an IPC-&gt;sounddata = 0; after enabling the sound control register.  I think that's all I had to do, based on some quick diff'ing</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#154236 - melw - Sun Apr 13, 2008 8:39 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>SiW wrote:</b></span></td> </tr> <tr> <td class="quote">As to getting the current ASlib running on r21, make sure you call AS_Init() in your ARM7 startup.</td> </tr></table><span class="postbody">
<br/>
Thanks, this did the trick! Noda, having an updated template available for v1.1 would be a good idea, as the only/old one available doesn't call AS_Init() on the ARM7 side...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#154255 - Noda - Sun Apr 13, 2008 6:28 pm</h4>
    <div class="postbody"><span class="postbody">Yes, I forgot this as I made the update quickly to fix M3/R4 problems ;)
<br/>
I think the next release will be available in the next weeks...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#154256 - wintermute - Sun Apr 13, 2008 6:59 pm</h4>
    <div class="postbody"><span class="postbody">Please don't.
<br/>
<br/>
Forthcoming libnds updates will trash this library completely<br/>_________________<br/><a class="postlink" href="http://www.devkitpro.org/" target="_blank">devkitPro - professional toolchains at amateur prices</a>
<br/>
<a class="postlink" href="http://wiki.devkitpro.org/index.php/IRC" target="_blank">devkitPro IRC support</a>
<br/>
<a class="postlink" href="http://davejmurphy.com/" target="_blank">Personal Blog</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#154257 - Noda - Sun Apr 13, 2008 7:12 pm</h4>
    <div class="postbody"><span class="postbody">Then I'll update it.
<br/>
<br/>
I don't really understand why you put so much efforts to prevent people from releasing their own lib why may be useful for some other. Even if it's not perfect, having the choice of what to use is better than not having it...
<br/>
<br/>
And I know the next libnds update will throw away the current IPC struct to use IPC FIFO instead, but that's not a big to update my lib to work with it as it's only a matter of command sync, nothing else.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#154262 - wintermute - Sun Apr 13, 2008 8:35 pm</h4>
    <div class="postbody"><span class="postbody">Some libs are completely unsuitable for the DS ...
<br/>
<br/>
It's not about preventing people releasing their own libs, it's about trying to get people to stop releasing crap that frustrates developers when they realise all this stuff is too resource intensive and has to be ripped out again.<br/>_________________<br/><a class="postlink" href="http://www.devkitpro.org/" target="_blank">devkitPro - professional toolchains at amateur prices</a>
<br/>
<a class="postlink" href="http://wiki.devkitpro.org/index.php/IRC" target="_blank">devkitPro IRC support</a>
<br/>
<a class="postlink" href="http://davejmurphy.com/" target="_blank">Personal Blog</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#154265 - SiW - Sun Apr 13, 2008 9:25 pm</h4>
    <div class="postbody"><span class="postbody">Don't you think this is a rather presumptious attitude though?  Having had to support my own software before I do understand where you're coming from, but it seems a little insulting to assume that everybody who makes use of this particular lib is unaware of the problems or suitability.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#154275 - tepples - Sun Apr 13, 2008 11:44 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>wintermute wrote:</b></span></td> </tr> <tr> <td class="quote">It's not about preventing people releasing their own libs, it's about trying to get people to stop releasing crap that frustrates developers</td> </tr></table><span class="postbody">
<br/>
Do you have any tips for making interesting "libs" without making "crap that frustrates developers"<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#154284 - Doom5 - Mon Apr 14, 2008 2:37 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>wintermute wrote:</b></span></td> </tr> <tr> <td class="quote">Some libs are completely unsuitable for the DS ...
<br/>
<br/>
It's not about preventing people releasing their own libs, it's about trying to get people to stop releasing crap that frustrates developers when they realise all this stuff is too resource intensive and has to be ripped out again.</td> </tr></table><span class="postbody">
<br/>
<br/>
It's not as if it'll be built into the official libnds and you'd be <span style="font-weight: bold">forced</span> to use the library. If more amateur developers, or ones who feel the library does what it needs for them, what's the issue?
<br/>
<br/>
If you want to design your own sound system is your homebrew, as most developers do, that's your prerogative.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#154302 - Michoko - Mon Apr 14, 2008 11:22 am</h4>
    <div class="postbody"><span class="postbody">A new ASlib update? This is great news! 
<br/>
<br/>
&lt;sarcasm&gt;
<br/>
(but I suppose I must be totally stupid and ignorant to think that way :P)
<br/>
&lt;/sarcasm&gt;
<br/>
<br/>
Can't wait for the release. Thanks Noda for your cool libs (EFSLib and ASLib were really life savers for me)
<br/>
<br/>
Cheers
<br/>
Michoko</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#154305 - thoduv - Mon Apr 14, 2008 1:30 pm</h4>
    <div class="postbody"><span class="postbody">I don't understand why ASlib is as bas as you say. I've never encountered any problems you mention while using it. It is also quite simple to build: it's only one quite light source file for each CPU.
<br/>
The only problem could be the IPC system, which is memory-based and statically located, but still, I don't care since it manages to do exactly what I want it to do, and is easy to integrate to a project.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#154308 - melw - Mon Apr 14, 2008 4:10 pm</h4>
    <div class="postbody"><span class="postbody">Naeh, Wintermute is just cranky as this library doesn't fall into same philosophy as libnds - as in, everyone should be able to use it and it should not limit the developer in any way. I don't want to stir this dev-politics any further, but no matter of personal opinions, there's clearly plenty of projects where MP3 playback is useful. Better let the developers make their decisions, aight?
<br/>
<br/>
BTW. Same applies for liblobby (that is also going to get broken after forthcoming libnds updates). But as long as the promised new dswifi library with ad-hoc connectivity is not here, I'm more than happy to use it.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#163602 - a128 - Mon Oct 06, 2008 9:49 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>chishm wrote:</b></span></td> </tr> <tr> <td class="quote">In r21, with the changes I suggest previously, the size is 0x03807970, which is 4724 bytes difference. I'm not sure what caused such a large size change, but that is the cause of memory overflows when compiling with r21.</td> </tr></table><span class="postbody">
<br/>
<br/>
as wintermute already said devkitARM R21 uses 96K for ARM7
<br/>
<br/>
so it has to be working?!!!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#165231 - Echo49 - Sat Dec 13, 2008 9:06 pm</h4>
    <div class="postbody"><span class="postbody">One year after my last post, I decided to try this out (finally). I got what appears to be the latest version from <a class="postlink" href="http://noda.free.fr/nds/" target="_blank">http://noda.free.fr/nds/</a>, but I've hit a few snags.
<br/>
<br/>
Sometimes, changes to my other code causes the mp3 to suddenly stop for no reason at all. Commenting out iprintf()s seems to fix this. Is this because it's not decoding in time? Sampling rate jumps to 0 when this happens, perhaps it's not reading any more data from my file? Maybe it runs out of RAM. Most likely I won't need to use VRAM_D, does chishm's hack still work on this release?
<br/>
<br/>
If I use AS_SetMP3Rate() at all, the mp3 will instantly stop working (weird sounds associated with data corruption in previous posts), usually leading to a crash.
<br/>
<br/>
I had a problem with sampling rate being read correctly but actual playback at half the speed, but it seems to work fine for the test mp3 so I'll need to see if this is a problem with Audacity instead.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#165239 - a128 - Sun Dec 14, 2008 10:16 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Echo49 wrote:</b></span></td> </tr> <tr> <td class="quote">One year after my last post, I decided to try this out (finally). I got what appears to be the latest version from <a class="postlink" href="http://noda.free.fr/nds/" target="_blank">http://noda.free.fr/nds/</a>, but I've hit a few snags.
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
<br/>
maybe try this mp3/sfx lib from isabella (eric) it seems fine
<br/>
<br/>
<a class="postlink" href="http://blea.ch/wiki/index.php/Thmp3" target="_blank">http://blea.ch/wiki/index.php/Thmp3</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#165991 - a128 - Thu Jan 15, 2009 7:03 pm</h4>
    <div class="postbody"><span class="postbody">BUG FIX if you change the rate and using AS_SoundDirectPlay
<br/>
<br/>
as_lib9.c
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">// play a sound directly using the given channel
<br/>
void AS_SoundDirectPlay(u8 chan, SoundInfo sound)
<br/>
{
<br/>
    IPC_Sound-&gt;chan[chan].snd = sound;
<br/>
    IPC_Sound-&gt;chan[chan].busy = true;
<br/>
    IPC_Sound-&gt;chan[chan].cmd = SNDCMD_PLAY;
<br/>
    IPC_Sound-&gt;chan[chan].volume = sound.volume;
<br/>
    
<br/>
    if(IPC_Sound-&gt;surround) {
<br/>
        IPC_Sound-&gt;chan[chan + IPC_Sound-&gt;num_chan].snd = sound;
<br/>
        IPC_Sound-&gt;chan[chan + IPC_Sound-&gt;num_chan].busy = true;
<br/>
        IPC_Sound-&gt;chan[chan + IPC_Sound-&gt;num_chan].cmd = SNDCMD_DELAY;
<br/>
<br/>
        // set the correct surround volume &amp; pan
<br/>
        AS_SetSoundVolume(chan, sound.volume);
<br/>
<br/>
//NEW BUG FIX?!!!
<br/>
   // set the correct surround rate
<br/>
       AS_SetSoundRate(chan, sound.rate);
<br/>
        
<br/>
    } else {
<br/>
        IPC_Sound-&gt;chan[chan].pan = sound.pan;
<br/>
 IPC_Sound-&gt;chan[chan].snd.rate = sound.rate;//NEW BUG FIX?!!!
<br/>
    }
<br/>
}</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#166009 - chatterbug89 - Fri Jan 16, 2009 4:51 am</h4>
    <div class="postbody"><span class="postbody">I noticed someone on the PAlib forums also had this issue but it was never resolved:
<br/>
<br/>
In a nutshell I am not able to stop an mp3, so, if I do something like this:
<br/>
AS_MP3DirectPlay((u8*)test, (u32)test_size); 
<br/>
and then stop it later on with 
<br/>
AS_MP3Stop(); 
<br/>
it never stops and just keeps playing.  Also, if the mp3 ends and I call AS_MP3DirectPlay((u8*)test, (u32)test_size);  again the song starts playing (as would be expected).
<br/>
<br/>
If i'm using streaming when I use stop I get either a crash or a nice little loop of the last couple seconds of the song playing over and over again.
<br/>
<br/>
I've been digging through forum posts and trying all kinds of random things with no luck.  All the sound playing stuff seems to work just fine however, but...any volume changing stuff, panning, etc. with sounds or mp3's seems to not work.  In fact, it doesn't even seem to work in the PALib demo.  What's weird is others are reporting this to work.  If anyone has any idea what I could try it'd be appreciated (I posted on the PAlib forums also, but somehow I don't think I'll get an answer there).
<br/>
<br/>
EDIT: Yes, I have tested everything on real hardware and I have been using no$gba as my emulator
<br/>
<br/>
EDIT2:  I seemed to have created a temporary solution to my problem that allows me to change the song by simply jut changign the file being read at any random point like this:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
if(mp3file)
<br/>
         FILE_CLOSE(mp3file);
<br/>
<br/>
      mp3file = FILE_OPEN("testtwo.mp3");
<br/>
<br/>
      if(mp3file) {
<br/>
              // start playing
<br/>
         IPC_Sound-&gt;mp3.stream = true;
<br/>
         IPC_Sound-&gt;mp3.cmd = MP3CMD_PLAY;
<br/>
      }
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Now, this is a quick and dirty solution that would work for now..however, I'm not sure if because I cahnged the stream mid-way like this if the file will still play to the very end.  Could anyone make a suggestion for this quick and dirty fix (unlless you know how to fix my real initial problem).
<br/>
<br/>
EDIT3:  Yeah, I thought this would happen.  If the file is suspose to end in a couple seconds and you start streaming from another file that's longer, it will end when the first file was suspose to end...so...i need to update those variables somehow without breaking anything.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#166394 - hacker013 - Sat Feb 07, 2009 9:52 am</h4>
    <div class="postbody"><span class="postbody">is it already tested of this still works with the newest DKA ?<br/>_________________<br/><a class="postlink" href="http://imetal.nl/" target="_blank">Website / Blog</a>
<br/>
<br/>
Let the nds be with you.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#166396 - AxemRed - Sat Feb 07, 2009 11:12 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>hacker013 wrote:</b></span></td> </tr> <tr> <td class="quote">is it already tested of this still works with the newest DKA ?</td> </tr></table><span class="postbody">
<br/>
It's possible to modify it to work, but not really worth the effort unless you absolutely need MP3 support for your game.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#166403 - hacker013 - Sat Feb 07, 2009 1:20 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>AxemRed wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>hacker013 wrote:</b></span></td> </tr> <tr> <td class="quote">is it already tested of this still works with the newest DKA ?</td> </tr></table><span class="postbody">
<br/>
It's possible to modify it to work, but not really worth the effort unless you absolutely need MP3 support for your game.</span></td> </tr></table><span class="postbody">
<br/>
<br/>
why do you say it is it not worth?<br/>_________________<br/><a class="postlink" href="http://imetal.nl/" target="_blank">Website / Blog</a>
<br/>
<br/>
Let the nds be with you.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#166783 - a128 - Tue Feb 17, 2009 6:42 pm</h4>
    <div class="postbody"><span class="postbody">I like AS lib for sound fx because it already has surround , reverb via a tricky delay trick.
<br/>
<br/>
anyway.
<br/>
<br/>
<br/>
here is a wav file loader using FAT  for it
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">SoundInfo* AS_LoadWav(const char *filename) </td> </tr></table><span class="postbody">
<br/>
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">//--- WAV loading 
<br/>
<br/>
//Audio sample structure type
<br/>
typedef struct _thSample_t {
<br/>
   u32    start;      //start of sample in ram
<br/>
   u32    loopstart;   //where to start looping sample (bytes from start of sample)
<br/>
   int   len;      //number of samples in sample
<br/>
   int   rate;      //sample rate (in hz, converted on arm7 side, mebbe shoiuld be u16 like the actual reg?)
<br/>
//   char   level;      //default volume
<br/>
//   char   pan;      //left/rightpan
<br/>
   u32   opts;      //
<br/>
} thSample_t;
<br/>
<br/>
//for reading wav data
<br/>
typedef struct _riffHeader_t {
<br/>
   char   id[4];
<br/>
   u32   len;
<br/>
   char   type[4];
<br/>
} riffHeader_t;
<br/>
<br/>
//riff chunk header
<br/>
typedef   struct _riffChunkHdr_t {
<br/>
   char   type[4];
<br/>
   u32   len;
<br/>
} riffChunkHdr_t;
<br/>
<br/>
typedef struct _adpcmHeader_t {
<br/>
<br/>
    s16         firstSample;
<br/>
<br/>
    char        stepTableIndex;
<br/>
<br/>
    char        reserved;
<br/>
<br/>
} adpcmHeader_t; 
<br/>
<br/>
<br/>
//wave specific header
<br/>
typedef struct _riffWaveFmt_t {
<br/>
   u16   formatTag;   //always 0x01
<br/>
   u16   channels;   //number of channels
<br/>
   u32   rate;      //sample rate in hz
<br/>
   u32   bytesPerSec;   //bytes per second
<br/>
   u16   bytesPerSample;   //bytes per sample 1=8bitmono, 2=8bitstereo or 16bitmono, 4-16bitstereo (block alignment for adpcm)
<br/>
   u16   bitsPerSamp;   //bitsper sample
<br/>
} riffWaveFmt_t;
<br/>
<br/>
<br/>
//bytesPerSample possibilities (these name sux &gt;_&gt;)
<br/>
#define WAVE_8      0x1   //8bit mono for sure
<br/>
#define WAVE_8_16   0x2   //8bit stereo or 16 bit mono wth?! (use bitsPerSamp for more detail)
<br/>
#define WAVE_16      0x4   //16 bit stereo for sure
<br/>
<br/>
//
<br/>
<br/>
//formatTag vales
<br/>
#define WAVE_FORMAT_PCM      0x0001   //pcm data
<br/>
//only adpcm supported on ds
<br/>
#define WAVE_FORMAT_MULAW   0x0101   //IBM mu-Law
<br/>
#define WAVE_FORMAT_ALAW   0x0102   //IBM a-Law format
<br/>
#define WAVE_FORMAT_ADPCM   0x0103   //IBM AVC Adaptive Differntial PCM 
<br/>
<br/>
//inline sub function to help simplify wave messyness +_+
<br/>
inline void _SampleLoadWav8mono(FILE *fp, s8 *smpbuf, SoundInfo *smp, int len) {
<br/>
   int c=0;
<br/>
   fread(smpbuf,1,len,fp);
<br/>
   do {   
<br/>
      *smpbuf=*smpbuf-0x80;
<br/>
      smpbuf++;
<br/>
   } while(++c&lt;len);
<br/>
   smp-&gt;size=len;
<br/>
   smp-&gt;format=AS_PCM_8BIT;
<br/>
}
<br/>
<br/>
//inline sub function to help simplify wave format messyness +_+
<br/>
inline void _SampleLoadWav16mono(FILE *fp, s16 *smpbuf, SoundInfo *smp, int len) {
<br/>
   len&gt;&gt;=1;
<br/>
   fread(smpbuf,2,len,fp);   //whaddaya know... microsoft stores wav data as 16 bit signed, while it stores 8bit unsigned... W T F?!?
<br/>
   smp-&gt;size=len;
<br/>
   smp-&gt;format=AS_PCM_16BIT;
<br/>
}
<br/>
<br/>
//create SoundInfo from wav
<br/>
//taken from thaudio9.c from Isabella. thanx!
<br/>
SoundInfo* AS_LoadWav(const char *name) 
<br/>
{
<br/>
   MSG("AS_LoadWav\n"); 
<br/>
<br/>
   if(as_default_rate==0) {
<br/>
      MSG("Error: You have to AS_INit() first\n"); 
<br/>
      for(;;);
<br/>
   
<br/>
   }
<br/>
<br/>
   SoundInfo *snd;
<br/>
   FILE *fp;
<br/>
   //MSG("gonna open it...\n");
<br/>
   if((fp=fopen(name,"rb"))!=NULL) {
<br/>
      //MSG("reading header\n");
<br/>
      riffHeader_t riffHeader;
<br/>
      fread(&amp;riffHeader,sizeof(riffHeader_t),1,fp);
<br/>
      if((strncmp(riffHeader.id,"RIFF",4)==0)&amp;&amp;(strncmp(riffHeader.type,"WAVE",4)==0)) {
<br/>
         //MSG("reading chunk header\n");
<br/>
         riffChunkHdr_t riffChunkHdr;
<br/>
         fread(&amp;riffChunkHdr,sizeof(riffChunkHdr_t),1,fp);
<br/>
         if(strncmp(riffChunkHdr.type,"fmt ",4)==0) {
<br/>
            riffWaveFmt_t riffWaveFmt;
<br/>
            //MSG("reading riff wave fmt\n");
<br/>
            fread(&amp;riffWaveFmt,sizeof(riffWaveFmt_t),1,fp);
<br/>
            riffChunkHdr.len-=sizeof(riffWaveFmt_t);   //len = remainder in case any extra data after format struct
<br/>
            //MSG("reading chunk header again %04x %d\n",ftell(fp),riffChunkHdr.len-sizeof(riffWaveFmt_t));
<br/>
            do {
<br/>
               fseek(fp,riffChunkHdr.len,SEEK_CUR);   //get over this... 
<br/>
               fread(&amp;riffChunkHdr,sizeof(riffChunkHdr_t),1,fp);
<br/>
               if(feof(fp)) {
<br/>
                  MSG("unexpected end of .wav file!\n");
<br/>
                  return(NULL);
<br/>
               }                  
<br/>
            } while(strncmp(riffChunkHdr.type,"data",4)!=0);
<br/>
            //riffChunkHdr.len should == size of ALL wav data in bytes
<br/>
            //go ahead here and malloc for thSample_t struct as well ^^
<br/>
<br/>
            //todo: fix bugs here!!! malloc size may not include adpcm header... buff offset not right at all either..
<br/>
<br/>
            snd=(thSample_t *)malloc(riffChunkHdr.len+sizeof(SoundInfo)+3);
<br/>
            if(snd) {
<br/>
               u32 buff=(((u32)snd)+sizeof(SoundInfo)+3)&amp;~0x3;   //consolidate mallocs
<br/>
               //MSG("m:%08x,b:%08x\n",retval,buff);
<br/>
               //MSG("reading %d bytes of data @%dhz type:%04x\n",riffChunkHdr.len,riffWaveFmt.rate,riffWaveFmt.formatTag);
<br/>
               if(riffWaveFmt.formatTag==WAVE_FORMAT_PCM) {
<br/>
                  if(riffWaveFmt.bytesPerSample==WAVE_8) {
<br/>
                     MSG("8bit wave\n");
<br/>
   
<br/>
                     _SampleLoadWav8mono(fp,(s8*)buff, snd,riffChunkHdr.len);
<br/>
                  } else if(riffWaveFmt.bytesPerSample==WAVE_8_16) {
<br/>
                     MSG("16bit wave\n");
<br/>
   
<br/>
                     _SampleLoadWav16mono(fp,(s16*)buff,snd, riffChunkHdr.len);
<br/>
                     //8stereo unsupported for now anyway!! (need auto channel selection first..)
<br/>
                  } else {
<br/>
                     //16stereo unsupported!
<br/>
                  }
<br/>
               }  else { //i cant deal w/this format u_u;;
<br/>
                  MSG("Unsupported .wav format!\n");
<br/>
                  free(snd);
<br/>
                  return(NULL);
<br/>
               }                     
<br/>
                     
<br/>
               snd-&gt;data=buff;
<br/>
               snd-&gt;rate=riffWaveFmt.rate;//ok?
<br/>
               
<br/>
               snd-&gt;volume=127;
<br/>
               snd-&gt;pan=64;
<br/>
               snd-&gt;loop=0;
<br/>
               //   (counted in words, ie. N*4 bytes)
<br/>
               //snd-&gt;loopstart=0;
<br/>
                    snd-&gt;priority=0;
<br/>
               snd-&gt;delay=as_default_delay;
<br/>
<br/>
               MSG("wav loaded with rate %d!\n",snd-&gt;rate);
<br/>
            } else {
<br/>
               //      MSG("cannot malloc %d bytes for wav file! :/\n",riffChunkHdr.len);
<br/>
            }
<br/>
<br/>
         }
<br/>
      } else {
<br/>
         //MSG("%s is not a .wave file!\n",name);
<br/>
      }
<br/>
      fclose(fp);
<br/>
   }
<br/>
<br/>
   return snd;
<br/>
}
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#166787 - hacker013 - Tue Feb 17, 2009 8:00 pm</h4>
    <div class="postbody"><span class="postbody">aslib doesn't work anymore with the newest devkitARM<br/>_________________<br/><a class="postlink" href="http://imetal.nl/" target="_blank">Website / Blog</a>
<br/>
<br/>
Let the nds be with you.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#166790 - a128 - Tue Feb 17, 2009 11:10 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>hacker013 wrote:</b></span></td> </tr> <tr> <td class="quote">aslib doesn't work anymore with the newest devkitARM</td> </tr></table><span class="postbody">
<br/>
<br/>
it work with devkitARM but it does not work with the latest libnds...use the older libnds ...like I do....</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#166814 - wintermute - Thu Feb 19, 2009 1:36 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>a128 wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>hacker013 wrote:</b></span></td> </tr> <tr> <td class="quote">aslib doesn't work anymore with the newest devkitARM</td> </tr></table><span class="postbody">
<br/>
<br/>
it work with devkitARM but it does not work with the latest libnds...use the older libnds ...like I do....</span></td> </tr></table><span class="postbody">
<br/>
<br/>
Please don't advise people to use old releases. This causes major support issues.<br/>_________________<br/><a class="postlink" href="http://www.devkitpro.org/" target="_blank">devkitPro - professional toolchains at amateur prices</a>
<br/>
<a class="postlink" href="http://wiki.devkitpro.org/index.php/IRC" target="_blank">devkitPro IRC support</a>
<br/>
<a class="postlink" href="http://davejmurphy.com/" target="_blank">Personal Blog</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#166864 - a128 - Sat Feb 21, 2009 9:55 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>wintermute wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>a128 wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>hacker013 wrote:</b></span></td> </tr> <tr> <td class="quote">aslib doesn't work anymore with the newest devkitARM</td> </tr></table><span class="postbody">
<br/>
<br/>
it work with devkitARM but it does not work with the latest libnds...use the older libnds ...like I do....</span></td> </tr></table><span class="postbody">
<br/>
<br/>
Please don't advise people to use old releases. This causes major support issues.</span></td> </tr></table><span class="postbody">
<br/>
<br/>
Ok, you mean using an older version does not drive the new libnds further?! I do not think so.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#166870 - TwentySeven - Sat Feb 21, 2009 1:53 pm</h4>
    <div class="postbody"><span class="postbody">Please dont start this crap again.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167517 - Dud86 - Mon Mar 16, 2009 9:46 pm</h4>
    <div class="postbody"><span class="postbody">Is there anyway of getting the DS to play 128kbps or higher Mp3 files?? As im making a DJ game and sound quality is really important!
<br/>
<br/>
Cheers Duds!!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167528 - renatobs - Tue Mar 17, 2009 2:05 pm</h4>
    <div class="postbody"><span class="postbody">Hi. I?d like to know if I could and how to do to play a mp3, stop in a certain point of this ( save this point ), play another mp3 for a time, stop this and go back to the first mp3, but contnue by the point where it was ?! Could someone help me with this ?!? Could I improve the code to it or the code already have this ( and I don?t know ) ?!?
<br/>
Another thing: when I need to stop many times one mp3 to play another, the AS_lib stop to play and don?t play more. Why ?!? I need to wait some special moment to stop a mp3 to play another one ?!?!
<br/>
<br/>
Thanks !!!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167554 - AxemRed - Wed Mar 18, 2009 8:24 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>renatobs wrote:</b></span></td> </tr> <tr> <td class="quote">Another thing: when I need to stop many times one mp3 to play another, the AS_lib stop to play and don?t play more. Why ?!? I need to wait some special moment to stop a mp3 to play another one ?!?!</td> </tr></table><span class="postbody">
<br/>
AS_MP3Stop is broken: It doesn't set mp3file to NULL, so FILE_CLOSE is called twice on the same file handle if you stop and then play another mp3.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167579 - renatobs - Wed Mar 18, 2009 9:51 pm</h4>
    <div class="postbody"><span class="postbody">hunnn... ok, but what have I do to resolve (arrange) this ?!? Sorry for my lack of knowledge !
<br/>
And the other question ? Somebody that could help me ?!?!
<br/>
Thanks !!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167609 - renatobs - Thu Mar 19, 2009 10:03 pm</h4>
    <div class="postbody"><span class="postbody">Well, it?s possible to get a peace of the RAM ( like 1 Mb ), create a "volatile variable" and using the FAT ( libfat / EFS )  read and put there the mp3 music and play direct form RAM ? Cuz I could not do the ASlib play mp3 stream, but I have space in the RAM to change the mp3. Have some way to convert the mp3 files to "*.o" ( this is the files that the ASlib read ), put in a directory and use the libfat to change the file in the  RAM and play with with MP3DirectPlay ( using a pointer )... ?!? I think that this will help a lot of people like me. I?m doing a remake of the game "Shining Force 2" ( the name is Shining Force 2 Tribute and have some videos on YOU TUBE ) and I love the ASlib. The problem is that I already reach the top of RAM put only 2 mp3?s music on the game, and I need to make a lot of more things and put a lot of more musics, but I?d like to use MP3, not WAV. I have sucess to use ASlib together my code, but until now I didn?t use libfat for nothing.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#168657 - renatobs - Wed May 13, 2009 4:39 pm</h4>
    <div class="postbody"><span class="postbody">My ASLIb is working !!! And with EFSLib... the ony thing that I did was his:
<br/>
<br/>
as_lib9.h
<br/>
<br/>
// locate the IPC structure after the libnds one
<br/>
#define IPC_Sound   ((IPC_SoundSystem*)((u32)(IPC) + sizeof(TransferRegion)))
<br/>
<br/>
// file access functions
<br/>
<br/>
/*
<br/>
#ifdef AS_USE_EFS
<br/>
<br/>
// use EFSlib functions
<br/>
#define MP3FILE                         EFS_FILE
<br/>
#define FILE_CLOSE(f)                   EFS_fclose(f)
<br/>
#define FILE_OPEN(f)                    EFS_fopen(f)
<br/>
#define FILE_READ(buf, size, num, f)    EFS_fread(buf, size, num, f)
<br/>
#define FILE_SEEK(f, pos, off)          EFS_fseek(f, pos, off)
<br/>
#define FILE_TELL(f)                    EFS_ftell(f)
<br/>
<br/>
#else  */
<br/>
<br/>
// use libfat functions
<br/>
#define MP3FILE                         FILE
<br/>
#define FILE_CLOSE(f)                   fclose(f)
<br/>
#define FILE_OPEN(f)                    fopen(f, "rb")
<br/>
#define FILE_READ(buf, size, num, f)    fread(buf, size, num, f)
<br/>
#define FILE_SEEK(f, pos, off)          fseek(f, pos, off)
<br/>
#define FILE_TELL(f)                    ftell(f)
<br/>
<br/>
//#endif
<br/>
<br/>
<br/>
I disable all the AS_USE_EFS macros. The EFS works with the FAT normal macros. The problem that I?m having now is when I need use the EFS to load some VRAM datas while the MP3 is playing. Some times all sounds stop or the game freeze. The other thing is when one MP3 stop to play another, so all sounds stop too. These problems happen sometimes, not often.
<br/>
Some ideia ? What need I do to can use swiCopy, dmaCopy, memCopy without problem even when I?m using EFS ?
<br/>
<br/>
The ASLib is fantastic cuz I can play MP3 while do sound effects too. Please, someone that is ESXCELENT with C coding improve this !!! Where is NODA ?!?!?</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
