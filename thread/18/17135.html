<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>How do I access DOS attribute bit with libfat? - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > How do I access DOS attribute bit with libfat?</h2>
<div id="posts">
<div class="post">
    <h4>#172384 - Pate - Thu Feb 04, 2010 5:54 am</h4>
    <div class="postbody"><span class="postbody">Hi!
<br/>
<br/>
A simple question: How do I change the ARCHIVE attribute of a file using libFAT?
<br/>
<br/>
In my DSx86 emulator I need to support the DOS chmod command <a href="http://www.ctyme.com/intr/rb-2803.htm" target="_blank">http://www.ctyme.com/intr/rb-2803.htm</a> which uses the DOS-style FAT attribute bits. If I have understood correctly, libFAT exports the UNIX-style chmod <a href="http://www.opengroup.org/onlinepubs/000095399/functions/chmod.html" target="_blank">http://www.opengroup.org/onlinepubs/000095399/functions/chmod.html</a> which does not handle the ARCHIVE attribute. Internally libFAT seems to behave just like the DOS version (as FAT is based on DOS features), but what is the best way to access the internals of libFAT from my program?
<br/>
<br/>
Thanks!
<br/>
<br/>
Pate<br/>_________________<br/><ul><li>Now working on DSx86 <a href="http://dsx86.patrickaalto.com" target="_blank">http://dsx86.patrickaalto.com</a>
<br/>
</li><li>Get LineWarsDS from <a href="http://linewars.patrickaalto.com" target="_blank">http://linewars.patrickaalto.com</a></li></ul></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#172390 - elhobbs - Thu Feb 04, 2010 9:21 am</h4>
    <div class="postbody"><span class="postbody">If you do not find a better way this may be a place to start... _FAT_syncToDisc in fatfile.c from the libfat source does appear to modify the archive bit. it gets called when a file is closed and it needs to be flushed to disc. it reads the directory entry from disc changes some things then writes it back to disc.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#172395 - Pate - Thu Feb 04, 2010 2:53 pm</h4>
    <div class="postbody"><span class="postbody">Ok, thanks for the pointer! I'd certainly prefer to stay away from the libFAT internals, but I guess I can't avoid it completely.
<br/>
<br/>
Pate<br/>_________________<br/><ul><li>Now working on DSx86 <a href="http://dsx86.patrickaalto.com" target="_blank">http://dsx86.patrickaalto.com</a>
<br/>
</li><li>Get LineWarsDS from <a href="http://linewars.patrickaalto.com" target="_blank">http://linewars.patrickaalto.com</a></li></ul></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#172397 - elhobbs - Thu Feb 04, 2010 3:38 pm</h4>
    <div class="postbody"><span class="postbody">I may be wrong, but I do not think that modifying file attributes is in the std c library. I think it is OS specific. so perhaps an addition to libfat is in order?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#172404 - ninjalj - Fri Feb 05, 2010 12:50 am</h4>
    <div class="postbody"><span class="postbody">The ARCHIVE bit is indeed DOS-specific. 
<br/>
<br/>
My understanding of this issue goes:
<br/>
<br/>
- devkitARM apparently uses newlib,which, if it is the newlib I think, is a RedHat project for an embedded ISO-C (no Posix stuff) library.
<br/>
<br/>
- newlib has a struct devoptab_t which contains methods for device operations. It is defined in trunk/buildscripts/dkarm-eabi/patches/newlib-1.17.0.patch, as:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">+typedef struct {
<br/>
+       const char *name;
<br/>
+       int     structSize;
<br/>
+       int (*open_r)(struct _reent *r, void *fileStruct, const char *path, int flags, int mode);
<br/>
+       int (*close_r)(struct _reent *r, int fd);
<br/>
+       ssize_t (*write_r)(struct _reent *r, int fd, const char *ptr, size_t len);
<br/>
+       ssize_t (*read_r)(struct _reent *r, int fd, char *ptr, size_t len);
<br/>
+       off_t (*seek_r)(struct _reent *r, int fd, off_t pos, int dir);
<br/>
+       int (*fstat_r)(struct _reent *r, int fd, struct stat *st);
<br/>
+       int (*stat_r)(struct _reent *r, const char *file, struct stat *st);
<br/>
+       int (*link_r)(struct _reent *r, const char *existing, const char  *newLink);
<br/>
+       int (*unlink_r)(struct _reent *r, const char *name);
<br/>
+       int (*chdir_r)(struct _reent *r, const char *name);
<br/>
+       int (*rename_r) (struct _reent *r, const char *oldName, const char *newName);
<br/>
+       int (*mkdir_r) (struct _reent *r, const char *path, int mode);
<br/>
+
<br/>
+       int dirStateSize;
<br/>
+
<br/>
+       DIR_ITER* (*diropen_r)(struct _reent *r, DIR_ITER *dirState, const char *path);
<br/>
+       int (*dirreset_r)(struct _reent *r, DIR_ITER *dirState);
<br/>
+       int (*dirnext_r)(struct _reent *r, DIR_ITER *dirState, char *filename, struct stat *filestat);
<br/>
+       int (*dirclose_r)(struct _reent *r, DIR_ITER *dirState);
<br/>
+       int (*statvfs_r)(struct _reent *r, const char *path, struct statvfs *buf);
<br/>
+       int (*ftruncate_r)(struct _reent *r, int fd, off_t len);
<br/>
+       int (*fsync_r)(struct _reent *r, int fd);
<br/>
+       void *deviceData;
<br/>
+} devoptab_t;
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
So, no {Set,Get}Attributes here.
<br/>
<br/>
-libfat registers itself with newlib via a devoptab.
<br/>
<br/>
So, you'd need to add a couple of new fields to the devoptab_t struct. It won't get upstreamed in newlib, since it is so OS-specific.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#172406 - elhobbs - Fri Feb 05, 2010 1:10 am</h4>
    <div class="postbody"><span class="postbody">wouldn't making a SetFileAttribute function in libfat make more sense then modifying newlib? certainly much less work.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#172408 - ninjalj - Fri Feb 05, 2010 1:34 am</h4>
    <div class="postbody"><span class="postbody">I just got too carried looking if there was a proper way to do it, and once I found there wasn't, I didn't even think of stepping back. So much for posting this late at night.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#172409 - Dwedit - Fri Feb 05, 2010 1:49 am</h4>
    <div class="postbody"><span class="postbody">GBA_NDS_FAT had the ability to get and set attributes, why not libfat?<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#172771 - wintermute - Tue Mar 02, 2010 1:37 pm</h4>
    <div class="postbody"><span class="postbody">Digging around I found the POSIX (f)chflags functions which seem suitable, I'll look into implementing these soon.<br/>_________________<br/><a class="postlink" href="http://www.devkitpro.org/" target="_blank">devkitPro - professional toolchains at amateur prices</a>
<br/>
<a class="postlink" href="http://wiki.devkitpro.org/index.php/IRC" target="_blank">devkitPro IRC support</a>
<br/>
<a class="postlink" href="http://davejmurphy.com/" target="_blank">Personal Blog</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#172834 - ninjalj - Sat Mar 06, 2010 3:44 pm</h4>
    <div class="postbody"><span class="postbody">&lt;pedantic&gt;
<br/>
chflags is not in POSIX, it's BSD 4.4.
<br/>
&lt;/pedantic&gt;</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#172836 - wintermute - Sat Mar 06, 2010 4:36 pm</h4>
    <div class="postbody"><span class="postbody">some of the documentation seems to imply that it's a BSD derived function that's been added to POSIX but, either way, seems like a suitable means for setting hidden &amp; archive attributes for us :p
<br/>
<br/>
Actually though, I can't seem to find a standard way to access these flags, if I'm going to have to extend st_mode in stat to show the flags I might as well just extend the flags recognised by chmod. Any thoughts?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#173079 - wintermute - Fri Mar 19, 2010 6:11 pm</h4>
    <div class="postbody"><span class="postbody">Found it in the end, there's an st_flags entry in the stat structure for these flags.
<br/>
<br/>
Just finished adding the extensions to newlib, now for some testing. devkitARM r29 &amp; libfat 1.0.8 should support this :)
<br/>
<br/>
also bumping this thread so I can find it again.
<br/>
<br/>
edit: and now I'm pulling the (f)chflags functions again, this isn't the solution I thought it was going to be, fatGetAttr &amp; fatSetAttr functions for libfat will work better. There isn't access to all the DOS flags with the bsd functions and the SF_ARCHIVED bit has the opposite sense to thd DOS one :/<br/>_________________<br/><a class="postlink" href="http://www.devkitpro.org/" target="_blank">devkitPro - professional toolchains at amateur prices</a>
<br/>
<a class="postlink" href="http://wiki.devkitpro.org/index.php/IRC" target="_blank">devkitPro IRC support</a>
<br/>
<a class="postlink" href="http://davejmurphy.com/" target="_blank">Personal Blog</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#173147 - Pate - Wed Mar 24, 2010 5:55 am</h4>
    <div class="postbody"><span class="postbody">Cool, thanks for working on this issue, and sorry I haven't been following this thread more closely, been busy with other issues.
<br/>
<br/>
So, do I understand correctly, next release should have fatGetAttr and fatSetAttr, but the current devkitARM r29 version does not yet?
<br/>
<br/>
Thanks again!
<br/>
<br/>
Pate<br/>_________________<br/><ul><li>Now working on DSx86 <a href="http://dsx86.patrickaalto.com" target="_blank">http://dsx86.patrickaalto.com</a>
<br/>
</li><li>Get LineWarsDS from <a href="http://linewars.patrickaalto.com" target="_blank">http://linewars.patrickaalto.com</a></li></ul></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#173175 - wintermute - Wed Mar 24, 2010 11:21 pm</h4>
    <div class="postbody"><span class="postbody">I've decided to add these functions to libfat rather than chain them through newlib since they're FAT specific and there appears to be no suitable standard function to handle the flags. The next libfat update should include them, hopefully pretty soon.<br/>_________________<br/><a class="postlink" href="http://www.devkitpro.org/" target="_blank">devkitPro - professional toolchains at amateur prices</a>
<br/>
<a class="postlink" href="http://wiki.devkitpro.org/index.php/IRC" target="_blank">devkitPro IRC support</a>
<br/>
<a class="postlink" href="http://davejmurphy.com/" target="_blank">Personal Blog</a></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
