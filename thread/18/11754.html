<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>I need advice to choose sound format for my game - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > I need advice to choose sound format for my game</h2>
<div id="posts">
<div class="post">
    <h4>#109633 - Lupi - Sun Nov 19, 2006 10:50 pm</h4>
    <div class="postbody"><span class="postbody">My situation:
<br/>
<br/>
I'm doing a musical game, is a Elite Beat Agents/Osu! Tatakae! Ouendan clone. This means I want to load wav/raw/mp3 in my proyect, and the most important thing, I want people to upload their own songs in the specified format via the SD/CF card (this means reading data with the FAT libraries) and if posible via chunks of song.
<br/>
<br/>
The game must also be somehow sincronized with the secuence executing in the ARM9 (the circles you have to tap in the right moment), so the hardware must always be at 100% speed (this excludes the mp3 option I believe).
<br/>
<br/>
Considering that I have no idea of how to decode a compressed audio or a different format to be able to be played in the Nintendo DS, what is my best option for format.
<br/>
<br/>
Thanks in advance.
<br/>
<br/>
PD: I have tried <a class="postlink" href="http://www.wotsit.org/search.asp?s=music" target="_blank">http://www.wotsit.org/search.asp?s=music</a> and tried to read RIFF WAVE format, but I don't get a word of what it says.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#109648 - tepples - Mon Nov 20, 2006 12:41 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Lupi wrote:</b></span></td> </tr> <tr> <td class="quote">I'm doing a musical game, is a Elite Beat Agents/Osu! Tatakae! Ouendan clone.</td> </tr></table><span class="postbody">
<br/>
Stop. DDR is patented, and Konami has successfully sued someone over it. Is EBA patented?
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">This means I want to load wav/raw/mp3 in my proyect, and the most important thing, I want people to upload their own songs in the specified format via the SD/CF card (this means reading data with the FAT libraries)</td> </tr></table><span class="postbody">
<br/>
It also means using CF cards. The library that has full support for SD cards does not support reading a list of files on the card.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">The game must also be somehow sincronized with the secuence executing in the ARM9 (the circles you have to tap in the right moment), so the hardware must always be at 100% speed (this excludes the mp3 option I believe).</td> </tr></table><span class="postbody">
<br/>
If you decode up to a second ahead (at 32000 Hz that's 125 KiB) into a circular buffer, you can always pretend the hardware is 100% speed.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Considering that I have no idea of how to decode a compressed audio or a different format to be able to be played in the Nintendo DS, what is my best option for format.</td> </tr></table><span class="postbody">
<br/>
If you want the absolute fastest compressed audio stream format to decode, consider porting my <a class="postlink" href="http://www.pineight.com/gba/#8ad" target="_blank">8ad player</a>.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#109655 - Lupi - Mon Nov 20, 2006 1:05 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Stop. DDR is patented, and Konami has successfully sued someone over it. Is EBA patented? </td> </tr></table><span class="postbody">
<br/>
<br/>
I'm not going to sell it or anything, it would be a free musical game with posibilities to add your own songs ;)
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">It also means using CF cards. The library that has full support for SD cards does not support reading a list of files on the card.</td> </tr></table><span class="postbody">
<br/>
<br/>
I'm using rein gba_nds_fat libraries, and works well in my Supercard SD :S
<br/>
I think it also has a few functions to get a filelist ready, if not I can find a different method
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">If you decode up to a second ahead (at 32000 Hz that's 125 KiB) into a circular buffer, you can always pretend the hardware is 100% speed. 
<br/>
<br/>
<br/>
If you want the absolute fastest compressed audio stream format to decode, consider porting my 8ad player.
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Well, I have seen your code, and considering I don't have much knowledge about GBA, I think I couldn't port it :P, I'll try to load directly from RAW for the moment and see how it progresses.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#109676 - Lick - Mon Nov 20, 2006 4:54 am</h4>
    <div class="postbody"><span class="postbody">I've had it with those "your game plays like mine so I'll sue you" kind of bullshit. I rather see you develop a great game and receive a C&amp;D letter from those people, at least you know that you're good enough to get sued. Then you can even write a blog about it and get famous! I mean, <span style="font-style: italic">really famous</span>!<br/>_________________<br/><a class="postlink" href="http://licklick.wordpress.com" target="_blank">http://licklick.wordpress.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#109687 - Lupi - Mon Nov 20, 2006 9:37 am</h4>
    <div class="postbody"><span class="postbody">I don't want to be famous, I want to make a good game, that's it...
<br/>
:P</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#109695 - silent_code - Mon Nov 20, 2006 1:01 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Lupi wrote:</b></span></td> </tr> <tr> <td class="quote">I don't want to be famous, I want to make a good game, that's it...
<br/>
:P</td> </tr></table><span class="postbody">
<br/>
<br/>
you're soooooo right! good games, that's what we need! :D</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#109753 - Lupi - Tue Nov 21, 2006 12:13 am</h4>
    <div class="postbody"><span class="postbody">Well, I have tried several settings to try to make it sound continuosly:
<br/>
The raw I'm trying to play is a 22050Hz 16 bit PCM raw song
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
u32 PlaySong(FAT_FILE * SONG, u32 fileorigin){
<br/>
   u16 * BUFFER = new u16 [22050];
<br/>
   FAT_fseek (SONG,0,fileorigin);
<br/>
   FAT_fread ((void *)BUFFER, sizeof(u16), 22050, SONG);
<br/>
   TransferSoundData * sound = new TransferSoundData();
<br/>
   sound-&gt;data = BUFFER;
<br/>
   sound-&gt;len = 22050;
<br/>
   sound-&gt;rate = 22050; 
<br/>
   sound-&gt;vol = 127; 
<br/>
   sound-&gt;pan = 64;
<br/>
   sound-&gt;format = 0; 
<br/>
   playSound(sound);
<br/>
   
<br/>
   delete [] BUFFER;
<br/>
   delete[]sound;
<br/>
   return (FAT_ftell(SONG));
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
And here is how I use it in the Arm9 code:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
BEFORE THE MAIN GAME LOOP...
<br/>
<br/>
FAT_FILE * SONG;
<br/>
SONG = FAT_fopen ("cancion.raw", "r");
<br/>
u32 position = 0;
<br/>
u32 contador = 0;
<br/>
<br/>
<br/>
<br/>
<br/>
INSIDE THE MAIN GAME LOOP...
<br/>
<br/>
contador++;
<br/>
if (contador%60 == 0)
<br/>
   position = PlaySong(SONG,position);
<br/>
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
What I get with this is a strange sound, lets say this is the song:
<br/>
<br/>
|-----------------------------------------------------------|
<br/>
<br/>
Then it does play by chunks of song, one chunk is played, one isn't...
<br/>
<br/>
 Play........|Not sounding..|Play........|Not sounding..
<br/>
|-----------------------------------------------------------|
<br/>
<br/>
I actually can sing the song and follow it when is sounding and when its not...
<br/>
what's wrong with this code?
<br/>
<br/>
<span style="font-weight: bold">Thanks in advance</span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#109756 - Lick - Tue Nov 21, 2006 12:32 am</h4>
    <div class="postbody"><span class="postbody">I don't think you need to or should allocate memory every second. 
<br/>
<br/>
It might be your delete[]s being called too soon. Use <span style="font-weight: bold">one</span> TransferSoundData struct and allocate <span style="font-weight: bold">one</span> array of 22050 shorts. Do this <span style="font-weight: bold">beforehand</span>, NOT while you're mainlooping.
<br/>
Each frame you would simply update the contents in the array. The TransferSoundData stays EXACTLY the same.<br/>_________________<br/><a class="postlink" href="http://licklick.wordpress.com" target="_blank">http://licklick.wordpress.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#109770 - josath - Tue Nov 21, 2006 3:16 am</h4>
    <div class="postbody"><span class="postbody">Lick is right about the memory allocation issues, but there's a more fundamental problem with your code: It will only work if your sound data will load instantly. Unfortunately, it takes some time to load (even if the time is very small).
<br/>
<br/>
Here is what is happening:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">|--play second #1---||---load second #2---||----play second #2---||----load second #3----|</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#109783 - tepples - Tue Nov 21, 2006 5:46 am</h4>
    <div class="postbody"><span class="postbody">You need to keep two buffers: one that loads and one that plays.
<br/>
<br/>
I would also recommend against 22050 Hz for some technical reasons related to how the DS DAC (digital to analog converter) works. Better rates are 16384 Hz and 32768 Hz.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#109802 - Kir - Tue Nov 21, 2006 9:33 am</h4>
    <div class="postbody"><span class="postbody">Would it be better to use ADPCM compressed music instead of raw ? Because if I remember correctly , DS already supports this compression format via hardware (at least Neimod's DSTek says so - <a href="http://neimod.com/dstek/" target="_blank">http://neimod.com/dstek/</a> ). And Ouendan/EBA songs are encoded in ADPCM.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#109825 - tepples - Tue Nov 21, 2006 2:54 pm</h4>
    <div class="postbody"><span class="postbody">The problem with decoding ADPCM in hardware is that the codec is stateful, and it's hard to start one packet precisely when the previous packet ends.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#109981 - Lupi - Thu Nov 23, 2006 10:51 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>josath wrote:</b></span></td> </tr> <tr> <td class="quote">Lick is right about the memory allocation issues, but there's a more fundamental problem with your code: It will only work if your sound data will load instantly. Unfortunately, it takes some time to load (even if the time is very small).
<br/>
<br/>
Here is what is happening:
<br/>
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">|--play second #1---||---load second #2---||----play second #2---||----load second #3----|</td> </tr></table><span class="postbody"></span></td> </tr></table><span class="postbody">
<br/>
<br/>
Actually, that's not happening, what is happening is this:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">|--play second #1---||---load second #2??---||----play second #[b]3[/b]---||----load second #4??----||--play second #[b]5[/b]---||---load second #6??---||----play second #7---||----load second #8??----|</td> </tr></table><span class="postbody">
<br/>
<br/>
And the game doesn't stop, since I can see my sprites doing what they have to do and no stops, I think it may be some problem with the channel I'm trying to load and play the sound being busy, but I have no idea of how to fix this.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#109984 - ProblemBaby - Fri Nov 24, 2006 12:23 am</h4>
    <div class="postbody"><span class="postbody">Just a question about game play, have you thought anything about tempo/beat and how to generate an actual "beat-track" (dont know what to call it) for a song? Letting the user have to find out the exact BPM by himself sounds like pain, and consider changed is in thempo makes it even harder.
<br/>
<br/>
Not to spoil your idea, but wouldnt it better to make a game based on modules if you are going to let people load their own songs?
<br/>
<br/>
Maybe you have a good idea how to solve this that I couldnt think about;)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#109985 - tepples - Fri Nov 24, 2006 12:27 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>ProblemBaby wrote:</b></span></td> </tr> <tr> <td class="quote">Just a question about game play, have you thought anything about tempo/beat and how to generate an actual "beat-track" (dont know what to call it) for a song? Letting the user have to find out the exact BPM by himself sounds like pain, and consider changed is in thempo makes it even harder.</td> </tr></table><span class="postbody">
<br/>
Yet StepMania users on bemanistyle.com manage to figure it out.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Not to spoil your idea, but wouldnt it better to make a game based on modules if you are going to let people load their own songs?</td> </tr></table><span class="postbody">
<br/>
And watch people ask how to import their CD rips. I tried supporting MOD, XM, S3M, and IT background music in a PC game that I made, yet I still got repeated requests for some sort of straight recording.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#109987 - ProblemBaby - Fri Nov 24, 2006 12:43 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
Yet StepMania users on bemanistyle.com manage to figure it out. 
<br/>
</td> </tr></table><span class="postbody">
<br/>
You mean find out BPM from a stream? well I guess that scanning through for peaks is thw way, but still sounds hard to make it accurate and not letting the system be tricked by something.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
And watch people ask how to import their CD rips. I tried supporting MOD, XM, S3M, and IT background music in a PC game that I made, yet I still got repeated requests for some sort of straight recording.
<br/>
</td> </tr></table><span class="postbody">
<br/>
well you know how people are "wouldnt it be better if the in-game graphics looked like the prerendered movies." ^^
<br/>
<br/>
Its boring to know that you will never know if the song will work good, and probably most songs will be somehow inaccurate. an alternative that would be really fun though, would be to be able to load nsfs, that would be so cool!</span><span class="gensmall"><br/><br/>Last edited by ProblemBaby on Fri Nov 24, 2006 12:52 am; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#109988 - tepples - Fri Nov 24, 2006 12:52 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>ProblemBaby wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Yet StepMania users on bemanistyle.com manage to figure it out. </td> </tr></table><span class="postbody">
<br/>
You mean find out BPM from a stream? well I guess that scanning through for peaks is thw way, but still sounds hard to make it accurate and not letting the system be tricked by something.</span></td> </tr></table><span class="postbody">
<br/>
No, StepMania uses BPM change commands in the .sm file. A lot of people on Bemanistyle use <a class="postlink" href="http://www.pineight.com/dwi/" target="_blank">times2bpm</a>, a tool I wrote to convert a list of times (one every 8 beats) into a list of BPM changes.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">And watch people ask how to import their CD rips. I tried supporting MOD, XM, S3M, and IT background music in a PC game that I made, yet I still got repeated requests for some sort of straight recording.</td> </tr></table><span class="postbody">
<br/>
well you know how people are "wouldnt it be better if the in-game graphics looked like the prerendered movies." ^^</span></td> </tr></table><span class="postbody">
<br/>
Except Rare actually took people up on that offer in <span style="font-style: italic">Donkey Kong Country</span> by using prerendered movies to create sprite cels.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#109989 - ProblemBaby - Fri Nov 24, 2006 1:09 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
No, StepMania uses BPM change commands in the .sm file. A lot of people on Bemanistyle use times2bpm, a tool I wrote to convert a list of times (one every 8 beats) into a list of BPM changes. 
<br/>
</td> </tr></table><span class="postbody">
<br/>
My point is, that it is hard to find the times (or BPM) for a song in the first place, well if you havent record it yourself.
<br/>
A normal user dont want to fiddle with finding out tempos or time they just want it to work.
<br/>
Maybe we talk about different things?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#109998 - tepples - Fri Nov 24, 2006 3:56 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>ProblemBaby wrote:</b></span></td> </tr> <tr> <td class="quote">A normal user dont want to fiddle with finding out tempos or time they just want it to work.</td> </tr></table><span class="postbody">
<br/>
And in the typical use of a configurable rhythm game, the pirate providing the song has already done the work so that all the normal users can benefit.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#110147 - bsder - Sun Nov 26, 2006 12:08 am</h4>
    <div class="postbody"><span class="postbody">Back to the original question, if I were selecting a music format, I'd use Ogg Vorbis.  I believe that Ogg Vorbis has the capacity for fairly exact timestamping.  Also, Ogg Vorbis takes less MIPS to decode (at the cost of some RAM and a larger initial startup-a good tradeoff on the DS).
<br/>
<br/>
With Tremor and DSWifi, I can stream a 64K average Ogg Stream and play it back at 22050 and still have some idle time left over.
<br/>
<br/>
I actually ported the Tremor library to the DS.  If you have the ability to take a Mercurial repository, I could pack it up for you.
<br/>
<br/>
This doesn't solve the circular buffering problem, though.  You have to start a free running interrupt timer on the ARM7 which is synchronized to the sound timer (unless someone has found a sound interrupt).  The interrupt timer is used to signal the ARM9 when the samples are played and the ARM7 needs more data.  I use the SYNC system to communicate back sound status.
<br/>
<br/>
Here is what I used on the ARM7.  I set up two circular buffers in uncached  memory space at 0x2600000 (left channel) and 0x2680000 (right channel).
<br/>
<br/>
WARNING: This code causes the libnds IPC system to break (it doesn't sample the touch screen, buttons, etc.).  You have been warned!
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#include &lt;nds.h&gt;
<br/>
<br/>
#include &lt;dswifi7.h&gt;
<br/>
<br/>
#define PURE_TIMER_CASCADE (1&lt;&lt;2)
<br/>
<br/>
#define PURE_TIMER_DIV_1 0
<br/>
#define PURE_TIMER_DIV_64 1
<br/>
#define PURE_TIMER_DIV_256 2
<br/>
#define PURE_TIMER_DIV_1024 3
<br/>
<br/>
// Note: this is close to 0x2000000 which libnds uses (&lt;.1% error)
<br/>
#define BUS_CLK_HZ 33513982
<br/>
<br/>
// The sound timer ticks at 1/2 the bus clock rate.
<br/>
// The sound timer counts *UP* from the SCHANNEL_TIMER value.
<br/>
// When the value reaches 0, the sound system outputs the sample and reloads.
<br/>
// Therefore, the value for SCHANNEL_TIMER should be 0 - ticks.
<br/>
#define SOUND_HZ_TO_BUS_TICKS(f) BUS_CLK_HZ/((f))
<br/>
#define SOUND_HZ_TO_SOUND_TICKS(f) SOUND_HZ_TO_BUS_TICKS((f))/2
<br/>
#define SOUND_HZ_TO_TIMER(f) 0-SOUND_HZ_TO_BUS_TICKS((f))
<br/>
#define SOUND_HZ_TO_SCHANNEL_TIMER(f) 0-SOUND_HZ_TO_SOUND_TICKS((f))
<br/>
<br/>
#define SOUND_SAMPLE_RATE 22050
<br/>
<br/>
const u16 soundSampleRate = SOUND_SAMPLE_RATE;
<br/>
const u16 soundTimer = SOUND_HZ_TO_TIMER(SOUND_SAMPLE_RATE);
<br/>
const u16 soundChannelTimer = SOUND_HZ_TO_SCHANNEL_TIMER(SOUND_SAMPLE_RATE);
<br/>
<br/>
#define SAMPLES_PER_MEMORY_FRAME 32768
<br/>
#define FRAME_TIMER -(SAMPLES_PER_MEMORY_FRAME)
<br/>
<br/>
const u16 samplesPerMemoryFrame = SAMPLES_PER_MEMORY_FRAME;
<br/>
const u16 frameTimer = FRAME_TIMER;
<br/>
<br/>
// const u16 samplesPerMemoryFrameScaler = 1024;
<br/>
// const u16 soundTimerBusTicksPerMemoryFrame =
<br/>
//                             soundTimerBusTicksPerSample *
<br/>
//                             (samplesPerMemoryFrame / samplesPerMemoryFrameScaler) ; 
<br/>
// const u16 timer2BusTicksPerMemoryFrameValue = (u16)(-soundTimerBusTicksPerMemoryFrame);
<br/>
<br/>
volatile u32 soundMemoryFrameCount = 0;
<br/>
<br/>
void initSoundAndTimers() {
<br/>
  // Initialize the sound system
<br/>
  SOUND_CR = SOUND_ENABLE | SOUND_VOL(0x7f);
<br/>
<br/>
  u8* leftStart  = (u8*) 0x02600000;
<br/>
  u8* rightStart = (u8*) 0x02680000;
<br/>
<br/>
  u8* leftEnd  = (u8*) 0x02680000;
<br/>
  u8* rightEnd = (u8*) 0x02700000;
<br/>
    
<br/>
<br/>
  SCHANNEL_CR(0) = 0;
<br/>
  SCHANNEL_TIMER(0) = soundChannelTimer;
<br/>
  SCHANNEL_SOURCE(0) = (u32)leftStart;
<br/>
  SCHANNEL_LENGTH(0) = (u32)(leftEnd - leftStart) &gt;&gt; 2;
<br/>
  SCHANNEL_REPEAT_POINT(0) = 0;
<br/>
<br/>
  SCHANNEL_CR(1) = 0;
<br/>
  SCHANNEL_TIMER(1) = soundChannelTimer;
<br/>
  SCHANNEL_SOURCE(1) = (u32)rightStart;
<br/>
  SCHANNEL_LENGTH(1) = (u32)(rightEnd - rightStart) &gt;&gt; 2;
<br/>
  SCHANNEL_REPEAT_POINT(1) = 0;
<br/>
<br/>
  // Initialize timers but do not start
<br/>
<br/>
  // Set up timer 1 to count up samples
<br/>
  TIMER1_CR = 0;
<br/>
  // FIXME: Why the +1?  Supposedly, the sound timer runs at 1/2
<br/>
  // the bus frequency (which drives the normal timers).  Empirically,
<br/>
  // this causes the sound to slip relative to the timer.  The error
<br/>
  // is cancelled out by the +1?  Where does it come from?  I don't
<br/>
  // know.  Possibly there is a 1 bus cycle delay as the timer reloads a
<br/>
  // data value.
<br/>
  TIMER1_DATA = (soundTimer+1);
<br/>
<br/>
  // Set up timer 2 to count up "memory frames"
<br/>
  TIMER2_CR = 0;
<br/>
  TIMER2_DATA = frameTimer;
<br/>
  TIMER2_CR = TIMER_IRQ_REQ | PURE_TIMER_CASCADE;
<br/>
<br/>
  // Set up timer 3 to count overflows from timer 2
<br/>
  TIMER3_CR = 0;
<br/>
  TIMER3_DATA = 0;
<br/>
  TIMER3_CR = PURE_TIMER_CASCADE;
<br/>
<br/>
  soundMemoryFrameCount = 0;
<br/>
}
<br/>
<br/>
<br/>
void irqAcknowledge(u32 irqBits) {
<br/>
  REG_IF = irqBits;
<br/>
}
<br/>
<br/>
#define START_SOUND 1
<br/>
#define END_SOUND 2
<br/>
<br/>
const int startSound = START_SOUND;
<br/>
const int endSound = END_SOUND;
<br/>
<br/>
void ihIPC(void) {
<br/>
  u32 syncCommand = IPC_GetSync();
<br/>
<br/>
  switch(syncCommand) {
<br/>
  case START_SOUND:
<br/>
    // Start other timers--not time critical as it is a cascade
<br/>
    TIMER3_CR |= TIMER_ENABLE;
<br/>
    TIMER2_CR |= TIMER_ENABLE;
<br/>
<br/>
    // Might want to actually turn off interrupts so that this
<br/>
    // all occurs as close to simultaneously as possible
<br/>
<br/>
    TIMER1_CR = TIMER_ENABLE;
<br/>
<br/>
    SCHANNEL_CR(0) = SCHANNEL_ENABLE | SOUND_REPEAT |
<br/>
      SOUND_VOL(0x7f) | SOUND_PAN(0) | SOUND_16BIT;
<br/>
    SCHANNEL_CR(1) = SCHANNEL_ENABLE | SOUND_REPEAT |
<br/>
      SOUND_VOL(0x7f) | SOUND_PAN(0x7f) | SOUND_16BIT;
<br/>
  
<br/>
    break;
<br/>
  case END_SOUND:
<br/>
    TIMER1_CR = 0;
<br/>
    SCHANNEL_CR(0) = 0;
<br/>
    SCHANNEL_CR(1) = 0;
<br/>
<br/>
    TIMER3_CR &amp;= ~TIMER_ENABLE;
<br/>
    TIMER2_CR &amp;= ~TIMER_ENABLE;
<br/>
<br/>
    // Reset system for next start command
<br/>
    initSoundAndTimers();
<br/>
<br/>
    break;
<br/>
  }
<br/>
<br/>
<br/>
  // Flag the fact that we have handled the interrupt
<br/>
  irqAcknowledge(IRQ_IPC_SYNC);  
<br/>
}
<br/>
<br/>
void ihTimer2(void) {
<br/>
  // Use counter rather than burn an entire timer
<br/>
  IPC_SendSync(soundMemoryFrameCount &amp; 0x7);
<br/>
<br/>
  ++soundMemoryFrameCount;
<br/>
  irqAcknowledge(IRQ_TIMER2);
<br/>
}
<br/>
<br/>
void ihVBlank(void) {
<br/>
  Wifi_Update(); // update wireless in vblank
<br/>
<br/>
  irqAcknowledge(IRQ_VBLANK);
<br/>
}
<br/>
<br/>
// ****************WIFI STUFF**************** 
<br/>
// callback to allow wifi library to notify arm9
<br/>
void arm7_synctoarm9() {
<br/>
  // send fifo message
<br/>
  REG_IPC_FIFO_TX = 0x87654321;
<br/>
}
<br/>
<br/>
// interrupt handler to allow incoming notifications from arm9
<br/>
void arm7_fifo() { // check incoming fifo messages
<br/>
  u32 msg = REG_IPC_FIFO_RX;
<br/>
  if(msg==0x87654321) {
<br/>
    Wifi_Sync();
<br/>
  }
<br/>
}
<br/>
<br/>
void fifoInit() {
<br/>
  // enable &amp; prepare fifo asap
<br/>
  REG_IPC_FIFO_CR = IPC_FIFO_ENABLE | IPC_FIFO_SEND_CLEAR;
<br/>
}
<br/>
<br/>
void wifiInit() {
<br/>
  // sync with arm9 and init wifi
<br/>
  u32 fifo_temp;   
<br/>
<br/>
  while(1) { // wait for magic number
<br/>
    while(REG_IPC_FIFO_CR&amp;IPC_FIFO_RECV_EMPTY) {
<br/>
      swiWaitForVBlank();
<br/>
    }
<br/>
<br/>
    fifo_temp=REG_IPC_FIFO_RX;
<br/>
    if(fifo_temp==0x12345678) break;
<br/>
  }
<br/>
<br/>
  while(REG_IPC_FIFO_CR&amp;IPC_FIFO_RECV_EMPTY) {
<br/>
    swiWaitForVBlank();
<br/>
  }
<br/>
<br/>
  fifo_temp=REG_IPC_FIFO_RX; // give next value to wifi_init
<br/>
  Wifi_Init(fifo_temp);
<br/>
  
<br/>
  irqSet(IRQ_FIFO_NOT_EMPTY, arm7_fifo); // set up fifo irq
<br/>
  irqEnable(IRQ_FIFO_NOT_EMPTY);
<br/>
  REG_IPC_FIFO_CR = IPC_FIFO_ENABLE | IPC_FIFO_RECV_IRQ;
<br/>
  
<br/>
  Wifi_SetSyncHandler(arm7_synctoarm9); // allow wifi lib to notify arm9
<br/>
  // arm7 wifi init complete
<br/>
}
<br/>
<br/>
<br/>
int main(void) {
<br/>
  fifoInit();
<br/>
<br/>
  // FIXME: Reset clock if needed (WHY?)
<br/>
  rtcReset();
<br/>
<br/>
  powerON(POWER_SOUND);
<br/>
<br/>
  irqInit();
<br/>
  irqSet(IRQ_VBLANK, ihVBlank);
<br/>
  irqEnable(IRQ_VBLANK);
<br/>
  irqSet(IRQ_IPC_SYNC, ihIPC);
<br/>
  irqEnable(IRQ_IPC_SYNC);
<br/>
  irqSet(IRQ_TIMER2, ihTimer2);
<br/>
  irqEnable(IRQ_TIMER2);
<br/>
<br/>
  // set up wifi interrupt
<br/>
  irqSet(IRQ_WIFI, Wifi_Interrupt);
<br/>
  irqEnable(IRQ_WIFI);
<br/>
<br/>
  initSoundAndTimers();
<br/>
<br/>
  // wifiInit needs VBlank and wifi running
<br/>
  wifiInit();
<br/>
<br/>
  // Enable incoming SYNC interrupt
<br/>
  REG_IPC_SYNC = IPC_SYNC_IRQ_ENABLE;
<br/>
<br/>
  int vBlankCount = 0;
<br/>
  while(1) {
<br/>
    ++vBlankCount;
<br/>
<br/>
    swiWaitForVBlank();
<br/>
  }
<br/>
<br/>
  return 0;
<br/>
}
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#110157 - Lupi - Sun Nov 26, 2006 2:25 am</h4>
    <div class="postbody"><span class="postbody">Ok, I managed to understand the PCM WAV format (it was hard, my first time decoding a wav)
<br/>
<br/>
I also managed to play the wav PCM song in my Nintendo DS second by second using the wav header data.
<br/>
But it still lacks "perfection". Every time a second of sound ends, the DS stop sound and inmediately start the new second of sound (the game continue as normal, so it's not about loading, it's about SYNC)
<br/>
<br/>
I'm thinking about implementing the sound loading directly on the ARM7. Does the gba_nds_fat.h lib works on arm7?
<br/>
To do this I have to make some kind of comunication between ARM7 and ARM9 with the IRQ_IPC_SYNC, right?
<br/>
But how will the process be? I can't figure it out
<br/>
<br/>
Thanks a lot for all your help :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#110168 - K-Duke - Sun Nov 26, 2006 5:37 am</h4>
    <div class="postbody"><span class="postbody">Hi Lupi,
<br/>
<br/>
although wav-files are easy to handle because of their lack of compression they are a bad choice exactly because of that missing compression.
<br/>
First of the files are huge and I mean !!HUGE!!
<br/>
Second: Resulting from the big filesize the DS has to handle with a lot of data to send at least some little sound to the boxes. So the handheld has to work with the sound a lot rendering the DS to work almost at full capacity for a complete song (well actually depending on the quality).
<br/>
<br/>
Like bsder I would recommend Ogg Vorbis as it is pretty good to handle, has nice compression and is free to use (no licensing or such).
<br/>
<br/>
Correct me if I'm seeing something wrong at this :-D
<br/>
<br/>
cheers
<br/>
K-Duke</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#110175 - Lupi - Sun Nov 26, 2006 12:37 pm</h4>
    <div class="postbody"><span class="postbody">Hi K-Duke, I have been searching some info about ogg. I have found that the most used is the vorbis
<br/>
I went to ogg page to find some info about the structure to read it, but I don't understand a thing of it &gt;_&gt;;;
<br/>
<br/>
I also found a libvorbis or something like that, if that is to decode and encode raw audio from ogg and ogg from raw, could it be possible to somehow import that libraries into my proyect?
<br/>
<br/>
Though I don't think that would solve the syncronization problem, but I should start trying the ogg audio.
<br/>
<br/>
Thanks a lot to all and excuse my english please ^_^</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
