<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Simple Profiler - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > Simple Profiler</h2>
<div id="posts">
<div class="post">
    <h4>#162344 - RobinWatts - Mon Sep 01, 2008 1:20 am</h4>
    <div class="postbody"><span class="postbody">Hi all,
<br/>
<br/>
I've just written the guts of a simple processor sampling profiler for the NDS (hugely inspired by TickProf, by Julian Smith, for various systems).
<br/>
<br/>
Initially it's intended simply to point to areas of tuna-vids that might benefit from tuning, but it could well be useful to other coders.
<br/>
<br/>
I still need to write the tool to take the binary output and combine it with the linker mapfile to produce a nice textual output, but the binary data it's producing looks plausible.
<br/>
<br/>
Anyone interested in beta (well, alpha!) testing it please speak now...
<br/>
<br/>
Robin</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#162390 - RobinWatts - Mon Sep 01, 2008 8:43 pm</h4>
    <div class="postbody"><span class="postbody">I've just got the analysis thing working too, so it seems appropriate for a post with some more details...
<br/>
<br/>
To use the profiler, in the arm9 code, you add the following line:
<br/>
<br/>
 Profiler_autoInit();
<br/>
<br/>
Then, at the end of the program, you do:
<br/>
<br/>
 Profiler_fin();
<br/>
<br/>
Avoid calling irqInit(); within your code, because Profiler_autoInit(); does that for you.
<br/>
<br/>
Then compile, deploy, and run your program. The program should run as normal, but on closedown, it'll dump a file 'PROFILE9' onto your memory card.
<br/>
<br/>
Take this file, and do:
<br/>
<br/>
  annotate PROFILE9 mapfile
<br/>
<br/>
where mapfile is the mapfile produced by the link stage.
<br/>
<br/>
This will output timings for your program, first listing by address, then by percentage of time spent.
<br/>
<br/>
For instance, for Tuna-Vids-1.1, it gives:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
Profile by Address
<br/>
01000000 (  0.00%:      0) Profile_passThru
<br/>
0100001c (  0.00%:      0) Profile_getSp
<br/>
01000024 (  0.00%:      0) Profile_offsetFinderWaitLoop
<br/>
01000034 (  0.00%:      0) Profile_offsetFinderWaitLoopEnd
<br/>
01000038 (  0.00%:      0) Profile_tick
<br/>
010000f0 ( 17.78%:   6217) yv12_to_rgb555_asm
<br/>
01000230 (  0.00%:      0) irqTable
<br/>
010002f8 (  0.04%:     13) IntrMain
<br/>
01000424 (  0.11%:     37) init_vlc_tables
<br/>
01000abc (  0.17%:     58) check_resync_marker
<br/>
[Snip]
<br/>
<br/>
Profile by Time
<br/>
010000f0 ( 17.78%:   6217) yv12_to_rgb555_asm
<br/>
02033330 ( 11.82%:   4135) simple_idct_ARM
<br/>
02035580 ( 10.35%:   3619) _M3CF_startup
<br/>
0200a6a8 (  7.59%:   2653) interpolate8x8_halfpel_hv_c
<br/>
0202d724 (  6.96%:   2433) transfer_16to8copy_c
<br/>
0202cf40 (  6.63%:   2320) dequant_h263_intra_c
<br/>
0202d960 (  6.19%:   2163) transfer_16to8add_c
<br/>
02047770 (  5.54%:   1938) memcpy
<br/>
0204293c (  4.81%:   1683) scanKeys
<br/>
02001b04 (  4.23%:   1478) play_movie
<br/>
020479b0 (  3.56%:   1246) memset
<br/>
[Snip]
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Robin</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#162495 - kleph - Wed Sep 03, 2008 11:37 pm</h4>
    <div class="postbody"><span class="postbody">hello Robin,
<br/>
<br/>
I am pretty interested in testing your profiler.
<br/>
I was just looking for a tool like this a few days ago :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#162504 - RobinWatts - Thu Sep 04, 2008 1:26 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>kleph wrote:</b></span></td> </tr> <tr> <td class="quote">hello Robin,
<br/>
<br/>
I am pretty interested in testing your profiler.
<br/>
I was just looking for a tool like this a few days ago :)</td> </tr></table><span class="postbody">
<br/>
<br/>
I've PM'd you with a location for an archive. Let me know how you get on.
<br/>
<br/>
Robin</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#162516 - a128 - Thu Sep 04, 2008 7:41 am</h4>
    <div class="postbody"><span class="postbody">why not post the archive link here?!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#162529 - RobinWatts - Thu Sep 04, 2008 12:38 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>a128 wrote:</b></span></td> </tr> <tr> <td class="quote">why not post the archive link here?!</td> </tr></table><span class="postbody">
<br/>
<br/>
Cos I haven't sorted out a proper distribution yet. When I get a license sorted, and decent instructions, I'll do a proper distribution, and post a link.
<br/>
<br/>
Until then I'd like to keep track of who's laughing at my code. :)
<br/>
<br/>
Robin</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#162555 - kleph - Thu Sep 04, 2008 9:27 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>RobinWatts wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>kleph wrote:</b></span></td> </tr> <tr> <td class="quote">hello Robin,
<br/>
<br/>
I am pretty interested in testing your profiler.
<br/>
I was just looking for a tool like this a few days ago :)</td> </tr></table><span class="postbody">
<br/>
<br/>
I've PM'd you with a location for an archive. Let me know how you get on.
<br/>
<br/>
Robin</span></td> </tr></table><span class="postbody">
<br/>
<br/>
<br/>
thanks 
<br/>
<br/>
I just tried it with my current project but unfortunately a linking error occurs.
<br/>
Since i've messed a bir with the linker in porting a few library I suspected my build. 
<br/>
I tried with a few other simple program (in this case a simple file copier i wrote to test my microSD card) and the same error occurs
<br/>
<br/>
Here is the error message :
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
profile9.o: In function `Profile_init':
<br/>
/home/kleph/progs/ds/filecp/./profile9.c:177: relocation truncated to fit: R_ARM_THM_CALL against symbol `Profile_offsetFinderWaitLoop' defined in .itcm section in profileARM9.o
<br/>
collect2: ld returned 1 exit status
<br/>
make[1]: *** [/home/kleph/progs/ds/filecp/filecp.elf] Error 1
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I don't understand the meaning of that message.
<br/>
<br/>
I am a pretty tired tonight so I'll try to investigate more during the weekend.
<br/>
<br/>
<br/>
By the way, the annotate program compile fairly well :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#162563 - RobinWatts - Fri Sep 05, 2008 1:08 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>kleph wrote:</b></span></td> </tr> <tr> <td class="quote">I just tried it with my current project but unfortunately a linking error occurs.
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
profile9.o: In function `Profile_init':
<br/>
/home/kleph/progs/ds/filecp/./profile9.c:177: relocation truncated to fit: R_ARM_THM_CALL against symbol `Profile_offsetFinderWaitLoop' defined in .itcm section in profileARM9.o
<br/>
collect2: ld returned 1 exit status
<br/>
make[1]: *** [/home/kleph/progs/ds/filecp/filecp.elf] Error 1
<br/>
</td> </tr></table><span class="postbody">
<br/>
</span></td> </tr></table><span class="postbody">
<br/>
<br/>
That's saying, I think, that it's trying to call an ARM routine (my assembly code) from a Thumb routine (Profile9.c), and not being able to fit the offset into the instruction.
<br/>
<br/>
The simple solution is, I think, to ensure that Profile9.c is built as ARM, not thumb.
<br/>
<br/>
If you post your makefile, I'll try and figure out the runes to make it work (and when I fail, someone with more clue than me can look :) ).
<br/>
<br/>
Robin</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#162567 - Cearn - Fri Sep 05, 2008 10:08 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>RobinWatts wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>kleph wrote:</b></span></td> </tr> <tr> <td class="quote">I just tried it with my current project but unfortunately a linking error occurs.
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
profile9.o: In function `Profile_init':
<br/>
/home/kleph/progs/ds/filecp/./profile9.c:177: relocation truncated to fit: R_ARM_THM_CALL against symbol `Profile_offsetFinderWaitLoop' defined in .itcm section in profileARM9.o
<br/>
collect2: ld returned 1 exit status
<br/>
make[1]: *** [/home/kleph/progs/ds/filecp/filecp.elf] Error 1
<br/>
</td> </tr></table><span class="postbody">
<br/>
</span></td> </tr></table><span class="postbody">
<br/>
<br/>
That's saying, I think, that it's trying to call an ARM routine (my assembly code) from a Thumb routine (Profile9.c), and not being able to fit the offset into the instruction.
<br/>
</span></td> </tr></table><span class="postbody">
<br/>
That's not quite it. Jumps between ARM and Thumb code shouldn't be a problem, but jumping between sections is. From the looks of it Profile_offsetFinderWaitLoop is in ITCM but its caller presumably isn't. The reverse (calling main RAM code from ITCM) has the similar problems. The ITCM_CODE macro should have taken care of this, but perhaps something else is going on as well.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#162575 - RobinWatts - Fri Sep 05, 2008 11:15 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Cearn wrote:</b></span></td> </tr> <tr> <td class="quote">That's not quite it. Jumps between ARM and Thumb code shouldn't be a problem, but jumping between sections is. From the looks of it Profile_offsetFinderWaitLoop is in ITCM but its caller presumably isn't. The reverse (calling main RAM code from ITCM) has the similar problems. The ITCM_CODE macro should have taken care of this, but perhaps something else is going on as well.</td> </tr></table><span class="postbody">
<br/>
<br/>
Yes, it's jumping between sections that's causing the problem.
<br/>
<br/>
If memory serves though, jumps in ARM code can safely jump further than ones from thumb code (24 bit offset rather than 22).
<br/>
<br/>
So swapping to using ARM code for profile9.c should (could?) solve it, I hope.
<br/>
<br/>
I'll check out the ITCM_CODE macro later though; thanks for that.
<br/>
<br/>
Robin</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#162662 - RobinWatts - Mon Sep 08, 2008 12:38 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>RobinWatts wrote:</b></span></td> </tr> <tr> <td class="quote">I'll check out the ITCM_CODE macro later though; thanks for that.</td> </tr></table><span class="postbody">
<br/>
<br/>
New version up in the same place, that uses the ITCM_CODE macro.
<br/>
<br/>
Robin</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#162687 - kleph - Tue Sep 09, 2008 7:53 am</h4>
    <div class="postbody"><span class="postbody">The new version compiles well. (I still had troubles with the assember file while compiling profile9.c in arm mode)
<br/>
<br/>
However, the program seems to crash before returning from Profile_init().
<br/>
<br/>
The real DS stay silent after the four iprintf().
<br/>
desmume reports : main (arm_instructions.c:243): Undefined instruction: 93004B25
<br/>
<br/>
I did not test with simple programs this time, i'll do that tonight i think.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#162926 - Lazy1 - Tue Sep 16, 2008 3:38 pm</h4>
    <div class="postbody"><span class="postbody">Can I get a copy of this profiler?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#162933 - RobinWatts - Tue Sep 16, 2008 5:24 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Lazy1 wrote:</b></span></td> </tr> <tr> <td class="quote">Can I get a copy of this profiler?</td> </tr></table><span class="postbody">
<br/>
<br/>
Link sent via PM.
<br/>
<br/>
Robin</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
