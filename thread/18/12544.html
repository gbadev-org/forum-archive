<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>stencil shadows & scissor testing [RENAMED] - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > stencil shadows & scissor testing [RENAMED]</h2>
<div id="posts">
<div class="post">
    <h4>#119598 - silent_code - Sat Feb 24, 2007 4:30 pm</h4>
    <div class="postbody"><span class="postbody">hi there!
<br/>
<br/>
now that i have colored shadows fully working i wonder if it's possible to use the hardwares stencil ability (i intentionally ommit the word stencil buffer) e.g. for stuff like portal rendering.
<br/>
if not, is there something like scissor or alpha testing (not speaking alpha blending)?
<br/>
also, is it possible to set a blendmode (like modulate, add etc) for polygons? i saw that it's possible to set for backgrounds (fade to black/white etc).
<br/>
<br/>
thanks for answering my questions.</span><span class="gensmall"><br/><br/>Last edited by silent_code on Mon Mar 12, 2007 9:08 pm; edited 3 times in total</span></div>    
</div>
<div class="post">
    <h4>#119690 - gabebear - Sun Feb 25, 2007 8:56 am</h4>
    <div class="postbody"><span class="postbody">Making a glScissor function should be relatively easy by setting the viewport to a section of the screen and then using gluPickMatrix so that the correct section of the screen is still rendered. I'll work on this tonight.
<br/>
<br/>
videogl already has glAlphaFunc, you don't have to enable it with glEnable and it only implements GL_GREATER.
<br/>
<br/>
How did you implement shadows, did you use the DS's stencil buffer?
<br/>
<br/>
The DS does have a limited stencil buffer that should be able to implement John Carmac's volumetric shadow technique ( <a href="http://developer.nvidia.com/attach/6832" target="_blank">http://developer.nvidia.com/attach/6832</a> )
<br/>
<br/>
Carmac's technique breaks down to:
<br/>
1. "Draw back sides, doing nothing with depth pass and incrementing with depth fail."
<br/>
2. "Draw front sides, doing nothing with depth pass and decrementing with depth fail."
<br/>
<br/>
So Carmac's technique only requires a 1-bit stencil buffer.
<br/>
<br/>
You access the stencil buffer by setting a polygon attribute before drawing and then using polygon IDs to "somehow" control the increment/decrement  of the stencil buffer. ( <a href="http://nocash.emubase.de/gbatek.htm#ds3dpolygonattributes" target="_blank">http://nocash.emubase.de/gbatek.htm#ds3dpolygonattributes</a> )
<br/>
<br/>
I still haven't fully figured shadows out, but I think I'm close.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#119709 - tepples - Sun Feb 25, 2007 2:34 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>gabebear wrote:</b></span></td> </tr> <tr> <td class="quote">The DS does have a limited stencil buffer that should be able to implement John Carmac's volumetric shadow technique ( <a href="http://developer.nvidia.com/attach/6832" target="_blank">http://developer.nvidia.com/attach/6832</a> )</td> </tr></table><span class="postbody">
<br/>
But doesn't Creative Labs own exclusive rights in that method?<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#119744 - gabebear - Sun Feb 25, 2007 8:21 pm</h4>
    <div class="postbody"><span class="postbody">Damn, looks like you are right... in the US anyways. The patent will run out October 13, 2019; I'll have to stop trying to figure this out until then.
<br/>
<br/>
<a class="postlink" href="http://patft.uspto.gov/netacgi/nph-Parser?Sect1=PTO2&amp;Sect2=HITOFF&amp;p=1&amp;u=%2Fnetahtml%2FPTO%2Fsearch-bool.html&amp;r=13&amp;f=G&amp;l=50&amp;co1=AND&amp;d=PTXT&amp;s1=6384822&amp;OS=6384822&amp;RS=6384822" target="_blank">US Patent 6384822</a> and foreign counterparts</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#119809 - gabebear - Mon Feb 26, 2007 3:24 pm</h4>
    <div class="postbody"><span class="postbody">I saw the glScissor() I had written sitting there and realized I never came back here to explain why it's not making it into videogl right now.
<br/>
<br/>
You can create a scissored box with the following code:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">const int vport[]= {0, 0, 255, 191};
<br/>
m4x4 pjMatrix;
<br/>
glViewPort(x, y, width, height);
<br/>
glGetFixed(GL_GET_MATRIX_PROJECTION, pjMatrix.m);
<br/>
glMatrixMode(GL_PROJECTION);
<br/>
glLoadIdentity();
<br/>
gluPickMatrix(x + (width / 2), y + (height / 2), width, height, vport);
<br/>
glMultMatrix4x4(&amp;pjMatrix);
<br/>
glMatrixMode(GL_MODELVIEW);</td> </tr></table><span class="postbody">You go back to normal view with:</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">glViewPort(0,0,255,191);
<br/>
glMatrixMode(GL_PROJECTION);
<br/>
glLoadMatrix4x4(&amp;pjMatrix);
<br/>
glMatrixMode(GL_MODELVIEW);</td> </tr></table><span class="postbody">
<br/>
the x , y, width, and height are the dimensions you want for the scissored section. Making this monkey code transparent to other programmers would require a lot more code, so you won't see glScissor in videogl very soon.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#119924 - silent_code - Tue Feb 27, 2007 3:10 pm</h4>
    <div class="postbody"><span class="postbody">thanks a lot gabebear, i'll have a look at the code asap.
<br/>
<br/>
shadows: yes, i use the nds' hardware shadows. but unfortunately it doesn't work like on the pc (there's no stencil buffer, like ther's no depth buffer). you have two special polygon attributes, one for masking and one for shadows. it basically works like the depth pass (aka z-pass) algorithm (as opposed to "carmaks reverse" / creatives depth fail). the problem is, that i need to implement z-fail in order to do what i need to in my engine. i haven't experimented enough with it, so i can't tell if it's possible to implement z-fail, yet.
<br/>
another problem is, that the hardware will color the "stenciled" fragments with the shadows color, rendering it only useful for shadows and thelike. unless i have overlooked something, though.
<br/>
i also get strange shadowing artifacts (some groups of fragments don't get shaded under some circumstances) that i haven't solved, yet, but i have an idea why this could happen.
<br/>
<br/>
btw: i'm lucky to live in europe. software patents are, imo, worth nothing to mankind, except to those who "money milk" them. i hope there'll never be software patents in europe.
<br/>
<br/>
---
<br/>
<br/>
MERGED WITH FOLLOWING POSTS:
<br/>
<br/>
now, if we could set the blendmode to modulate (is it possible???) and the shadowcolor to white (we can do that one), we could use the hw shadows as a regular stencil buffer. so, anyone knows about polygon blending modes?
<br/>
<br/>
---
<br/>
<br/>
gabebear: i tested your code, but it looks like the libnds build i have doesn't have gluPickMatrix(). i'll have to take a look at the more recent builds.
<br/>
<br/>
when i comment out the line in question i get a problem. the viewport is the size i set it to, but it will draw the whole scene and distort it. i guess gluPickMatrix() restricts drawing to a specified area (at leats that's what it does in open gl), but does it correct the distorsion, too? (i don't think so, though i am not sure.)
<br/>
<br/>
i haven't played enough with the settings (values). maybe i'd just have to do some additional calculations to get it right - maybe not. can you help?
<br/>
<br/>
EDIT: i just checked libnds over at devkitpro.org and saw that pick matrix has been added and i've been missing some updates... :s thanks anyway!</span><span class="gensmall"><br/><br/>Last edited by silent_code on Mon Mar 12, 2007 8:01 pm; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#121201 - gabebear - Sat Mar 10, 2007 4:19 am</h4>
    <div class="postbody"><span class="postbody">gluPickMatrix() to gets any size area from the current view so, yes, gluPickMatrix() does fix the distortion.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#121494 - silent_code - Mon Mar 12, 2007 7:08 pm</h4>
    <div class="postbody"><span class="postbody">first of all, thank you for your help, gabebear!
<br/>
unfortuanately it doesn't. i upgraded to the newest devkit and libs recently and tried your code. it works fine with any (reasonable) width and height, but as soon as i set x or y to non 0, the projection gets screwed up.
<br/>
<br/>
some code:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
m4x4 pjMatrix;
<br/>
const int vport[] = {0, 0, 255, 191};
<br/>
<br/>
...
<br/>
<br/>
works fine --&gt; setScissor(0, 0, 223, 178);
<br/>
OR
<br/>
breaks projection --&gt; setScissor(32, 32, 223, 178);
<br/>
drawMesh(dude);
<br/>
resetScissor();
<br/>
<br/>
where:
<br/>
<br/>
inline void setScissor(uint8 x, uint8 y, uint8 width, uint8 height)
<br/>
{
<br/>
   glGetFixed(GL_GET_MATRIX_PROJECTION, pjMatrix.m);
<br/>
   glMatrixMode(GL_PROJECTION);
<br/>
   glViewPort(x, y, width, height);
<br/>
   glLoadIdentity();
<br/>
<br/>
   gluPickMatrix(x + (width &gt;&gt; 1), y + (height &gt;&gt; 1), width, height, (int*)vport);
<br/>
<br/>
   glMultMatrix4x4(&amp;pjMatrix);
<br/>
   glMatrixMode(GL_MODELVIEW);
<br/>
}
<br/>
<br/>
<br/>
inline void resetScissor(void)
<br/>
{
<br/>
   glMatrixMode(GL_PROJECTION);
<br/>
   glViewPort(0, 0, 255, 191);
<br/>
   glLoadMatrix4x4(&amp;pjMatrix);
<br/>
   glMatrixMode(GL_MODELVIEW);
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
draw mesh does nothing fancy, just sets the regular poly attributes and draws triangles (no matrix operations).
<br/>
<br/>
the only two matrix operations i do in the whole code (besides the scissor test) are on the modelview matrix and they can be considered safe.
<br/>
<br/>
i tried to fix it for hours. maybe there's something missing/wrong in the pick matrix function? i mean the whole scissor setting and resetting makes perfectly sense, so what now? please HELP!
<br/>
<br/>
NOTE: i don't nest it, everything is just as shown above.
<br/>
<br/>
<br/>
--&gt; SHADOWS &lt;--:
<br/>
<br/>
i have tried to make a z-fail equivalent, but didn't succeed, yet. the problem is that you can't increase or decrease the stencil manually and you most unfortuanately can't configure the stencil operation mode. it will always do z-pass. so i have to solve it algorithmically (that will require some tricky math and projections)... not cool.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#121578 - gabebear - Tue Mar 13, 2007 8:05 am</h4>
    <div class="postbody"><span class="postbody">Ya, edge cases will mess with you, I have an example here that takes into account when you are trying to go past the edge of the DS's max viewport.
<br/>
<br/>
<a href="http://www.ghearing.com/Scissor_Test.zip" target="_blank">http://www.ghearing.com/Scissor_Test.zip</a> ( needs CVS libnds )
<br/>
<a href="http://www.ghearing.com/Scissor_Test.nds" target="_blank">http://www.ghearing.com/Scissor_Test.nds</a>
<br/>
<br/>
- Touch the screen to select where to scissor the teapot
<br/>
- A/B/X/Y resize the scissor area
<br/>
- D-Pad rotates everything
<br/>
<br/>
the cone isn't included in the scissor test.
<br/>
the teapot is not clipped when you aren't touching the screen.
<br/>
<br/>
I guess this could be a libnds example if I reworked and cleaned it up a bit.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#121853 - silent_code - Thu Mar 15, 2007 8:31 am</h4>
    <div class="postbody"><span class="postbody">i guess by "edge cases" you mean that i cross the screen borders, but i don't. everything is contained within the visible area. as i said, as long as x and y are set to 0 in the setScissor(...) function things work as expected. in any other case everything looks like crap.
<br/>
<br/>
thanks for posting your code again, i'll check it out. maybe there's something missing that is present in you code. i mean you said it works, so i have to have a bug in there. ;D</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#122078 - gabebear - Fri Mar 16, 2007 10:14 pm</h4>
    <div class="postbody"><span class="postbody">Ahh, in my original code I meant for
<br/>
glGetFixed(GL_GET_MATRIX_PROJECTION, pjMatrix.m); 
<br/>
to only be executed once.  pjMatrix should contain the regular projection matrix you wanted to use for your scene. I'd need to see the rest of your code to see exactly what was happening. If you kept grabbing the projection matrix that already had a picking matrix applied against it then I think it would behave like you said, I think.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#122164 - silent_code - Sat Mar 17, 2007 2:55 pm</h4>
    <div class="postbody"><span class="postbody">it shouldn't make any difference, as i only call it once (once in setScissors, and setScissors is called once, along with resetScissors). again, the problem only occurs when setting x and/or y to non-zero. i haven't looked at your code, yet. i'll be home today, so i'll test it and should i find the "bug" i'll post it here asap.
<br/>
<br/>
i guess even if one called it several times, it shouldn't cause problems as long as it's not nested. we'll see what i can find out today.</span><span class="gensmall"><br/><br/>Last edited by silent_code on Tue Mar 20, 2007 11:02 am; edited 2 times in total</span></div>    
</div>
<div class="post">
    <h4>#122469 - silent_code - Mon Mar 19, 2007 3:41 pm</h4>
    <div class="postbody"><span class="postbody">ok, it works now... although the afore mentioned edge cases don't work now and unfortunately you can't have a fulscreen scissor test.
<br/>
<br/>
the latter one can be fixes by using ints instead of unsigned chars.
<br/>
<br/>
the first problem, though, is still bugging me.
<br/>
<br/>
gabebear, it seems all i needed were the extra calculations you did (all this differnece stuff) to get it to work with non-zero x and y. i didn't have time to look too much into it, so i don't know what makes the difference. but i guess it lies within diff[]. ;^)
<br/>
<br/>
your precompiled binary worked well, but i couldn't get it to work when recompiled with my setup (most recent devkit and libs). there were functions missing and i tried to replace them, but it didn't help. i was just curious what setup you used when doing this?
<br/>
<br/>
next mission: solving the edge cases. i'm not sure if your demo handles them right, because the scene isn't able to reflect it (that's why i tried to recompile your code). enabling scissor testing would help a lot of ppl (of cause including me and e.g. anyone else writing portal engines for nds) and i'll at least want to try to make things work.
<br/>
<br/>
EDIT: got it working yesterday. it was my fault, i had some type issues, that's all. everything works as expected! lots of thanks to gabebear! i'll release my version very soon.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
