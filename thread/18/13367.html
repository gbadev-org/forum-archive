<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Correct settings for RAW sound - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>DS development > Correct settings for RAW sound</h2>
<div id="posts">
<div class="post">
    <h4>#130631 - tondopie - Tue Jun 05, 2007 10:48 pm</h4>
    <div class="postbody"><span class="postbody">WHat are the corrct settings for the RAW files used in NDS sound?
<br/>
I need to know Channels(Mono, Stereo?) Sample Rate and encoder.<br/>_________________<br/><span style="font-weight: bold">Development Blog:</span> <a class="postlink" href="http://teendev.org" target="_blank">http://teendev.org</a>
<br/>
<span style="font-weight: bold">Homebrew Podcast:</span> <a class="postlink" href="http://homebrewcast.net" target="_blank">http://homebrewcast.net</a>
<br/>
<span style="font-weight: bold">Web Design:</span> <a class="postlink" href="http://xtendesign.net" target="_blank">http://xtendesign.net</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#130639 - DragonMinded - Wed Jun 06, 2007 1:07 am</h4>
    <div class="postbody"><span class="postbody">That depends on the raw sample you use...<br/>_________________<br/>Enter the mind of the dragon.
<br/>
<br/>
<a href="http://dragonminded.blogspot.com" target="_blank">http://dragonminded.blogspot.com</a>
<br/>
<br/>
Seriously guys, how hard is it to simply TRY something yourself?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#130640 - tondopie - Wed Jun 06, 2007 1:46 am</h4>
    <div class="postbody"><span class="postbody">i guess I will just have to try stuff ou myself then...<br/>_________________<br/><span style="font-weight: bold">Development Blog:</span> <a class="postlink" href="http://teendev.org" target="_blank">http://teendev.org</a>
<br/>
<span style="font-weight: bold">Homebrew Podcast:</span> <a class="postlink" href="http://homebrewcast.net" target="_blank">http://homebrewcast.net</a>
<br/>
<span style="font-weight: bold">Web Design:</span> <a class="postlink" href="http://xtendesign.net" target="_blank">http://xtendesign.net</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#130645 - tepples - Wed Jun 06, 2007 3:15 am</h4>
    <div class="postbody"><span class="postbody"><ul><li>Channels: 1 </li><li>Sample rate: any, up to 32768 Hz </li><li>Formats: 8-bit signed with no header, 16-bit signed with no header, IMA ADPCM with a header as described in GBATEK </li></ul><br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#130647 - tondopie - Wed Jun 06, 2007 3:38 am</h4>
    <div class="postbody"><span class="postbody">thanks, it works!<br/>_________________<br/><span style="font-weight: bold">Development Blog:</span> <a class="postlink" href="http://teendev.org" target="_blank">http://teendev.org</a>
<br/>
<span style="font-weight: bold">Homebrew Podcast:</span> <a class="postlink" href="http://homebrewcast.net" target="_blank">http://homebrewcast.net</a>
<br/>
<span style="font-weight: bold">Web Design:</span> <a class="postlink" href="http://xtendesign.net" target="_blank">http://xtendesign.net</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#130685 - NeX - Wed Jun 06, 2007 5:14 pm</h4>
    <div class="postbody"><span class="postbody">I use 44100hz 16-bit samples with 1 channel.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#130688 - Dood77 - Wed Jun 06, 2007 6:02 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tepples wrote:</b></span></td> </tr> <tr> <td class="quote">up to 32768 Hz</td> </tr></table><span class="postbody">
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>NeX wrote:</b></span></td> </tr> <tr> <td class="quote">I use 44100hz</td> </tr></table><span class="postbody">
<br/>
Overkill? :-/<br/>_________________<br/>If I use a term wrong or something then feel free to correct, I?m not much of a programmer.
<br/>
<span style="font-size: 9px; line-height: normal">
<br/>
Original DS Phat obtained on day of release + flashme v7
<br/>
Supercard: miniSD, Kingston 1GB, Kingston 2GB
<br/>
Ralink chipset PCI NIC
<br/>
</span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#130707 - tepples - Wed Jun 06, 2007 10:04 pm</h4>
    <div class="postbody"><span class="postbody">Any sound played through the DS sound hardware at a frequency other than 32768 Hz will be resampled to 32768 Hz with nearest-neighbor algorithm.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#130714 - NeX - Wed Jun 06, 2007 11:26 pm</h4>
    <div class="postbody"><span class="postbody">Oh, well.  It sounds pretty good anyway.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#130719 - Dood77 - Thu Jun 07, 2007 12:51 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tepples wrote:</b></span></td> </tr> <tr> <td class="quote">Any sound played through the DS sound hardware at a frequency other than 32768 Hz will be resampled to 32768 Hz with nearest-neighbor algorithm.</td> </tr></table><span class="postbody">
<br/>
Does this cost cycles?<br/>_________________<br/>If I use a term wrong or something then feel free to correct, I?m not much of a programmer.
<br/>
<span style="font-size: 9px; line-height: normal">
<br/>
Original DS Phat obtained on day of release + flashme v7
<br/>
Supercard: miniSD, Kingston 1GB, Kingston 2GB
<br/>
Ralink chipset PCI NIC
<br/>
</span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#130911 - tepples - Sat Jun 09, 2007 5:13 am</h4>
    <div class="postbody"><span class="postbody">Fetching samples from RAM always costs cycles. It has since the NES. A higher sample rate means the hardware must perform more fetches per second.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#131189 - norfair - Tue Jun 12, 2007 2:23 am</h4>
    <div class="postbody"><span class="postbody">I'm wondering what buffer size I should use if I want to time buffer swapping on the vblank. For a 32768Hz rate, with 16 bit signed samples, how big should the buffer be?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#131191 - tepples - Tue Jun 12, 2007 2:47 am</h4>
    <div class="postbody"><span class="postbody">Vblank triggered buffer swapping is not recommended on Nintendo DS because 2*3*5*71*263 = 560190 cycles per frame isn't exactly a nice round number. It's better to use a timer. The opening theme of <span style="font-style: italic">Animal Crossing Wild World</span> appears to use segments of roughly 1 kilosample.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#131199 - DekuTree64 - Tue Jun 12, 2007 4:11 am</h4>
    <div class="postbody"><span class="postbody">DS has hardware looping though, so you don't need to use timer interrupts to restart the DMA like you did on GBA if you didn't synchronize with VBlank. Just cascade a couple of timers together (with the low timer running at the same rate as the sound channel) and read the value of the upper timer each VBlank to keep track of how many samples have been played.<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#131201 - norfair - Tue Jun 12, 2007 4:20 am</h4>
    <div class="postbody"><span class="postbody">Thank you for the replies!
<br/>
<br/>
Deku, I was in fact trying to extend the theory in your GBA sound tutorial to the DS. Thanks for the clarification :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#131244 - tepples - Tue Jun 12, 2007 11:32 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>DekuTree64 wrote:</b></span></td> </tr> <tr> <td class="quote">DS has hardware looping though, so you don't need to use timer interrupts to restart the DMA like you did on GBA if you didn't synchronize with VBlank.</td> </tr></table><span class="postbody">
<br/>
But how well does this hardware looping work with an ADPCM stream?<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#131254 - DekuTree64 - Wed Jun 13, 2007 1:36 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tepples wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>DekuTree64 wrote:</b></span></td> </tr> <tr> <td class="quote">DS has hardware looping though, so you don't need to use timer interrupts to restart the DMA like you did on GBA if you didn't synchronize with VBlank.</td> </tr></table><span class="postbody">
<br/>
But how well does this hardware looping work with an ADPCM stream?</span></td> </tr></table><span class="postbody">
<br/>
Not very well. The hardware looping saves the state of the decoder when it hits the loop point, and then restores it on each repetition. And you can't read back the decoder state either, so you can't even restart the channel with a timer interrupt when the buffer wraps.
<br/>
<br/>
One way I can think of to do it is to encode your data in frames that each start with the decoder in the same state. Then make your ring buffer equal to the frame size (plus 4 bytes for the initial ADPCM header), and stream data into it during VBlank with the sample counter method I mentioned before.
<br/>
<br/>
You might need to do a bit of extra processing on the data before encoding, to make sure there are no pops at frame boundaries (i.e. if your chosen frame start state has the sample value at 0, and the previous frame ended with 32000, then you'd get a loud pop). One trick you can use for that sort of thing is to look ahead and behind the frame boundary for a sample value that's close enough to 0, and then insert/remove single samples at random locations to line it up.<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#131255 - tepples - Wed Jun 13, 2007 3:50 am</h4>
    <div class="postbody"><span class="postbody">In that case, it might just be easier to decode the ADPCM in software.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
