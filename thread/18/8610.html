<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>File Reading on the DS with GBFS - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > File Reading on the DS with GBFS</h2>
<div id="posts">
<div class="post">
    <h4>#72154 - genfish - Thu Feb 16, 2006 7:18 pm</h4>
    <div class="postbody"><span class="postbody">Is it possible to use fopen and fread on the DS with GBFS?
<br/>
<br/>
I have written a TGA reading function and want to try to get 16bit tga sprites displayed in framebuffer mode.
<br/>
<br/>
As fopen usually takes a const char*, would i be able to pass a uint8* for example to open and read the file?
<br/>
<br/>
thanks for your help
<br/>
<br/>
edit: If not, how do any of u guys do file reading?<br/>_________________<br/>there is no rl only afk</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#72161 - Webez - Thu Feb 16, 2006 7:51 pm</h4>
    <div class="postbody"><span class="postbody">I load files using gbfs and then read bytes with memcpy.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#72162 - waruwaru - Thu Feb 16, 2006 7:52 pm</h4>
    <div class="postbody"><span class="postbody">Can't you replace/abstract all the fopen/fread/fclose calls in the TGA reading function with your own calls to <a class="postlink" href="http://www.double.co.nz/nintendo_ds/nds_develop6.html" target="_blank">functions in this example</a>?[/url]</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#72166 - GPFerror - Thu Feb 16, 2006 8:34 pm</h4>
    <div class="postbody"><span class="postbody">you could use my romdiskfs port, it uses stdio like functions that are all prefaced with KOS_ (ie KOS_fopen KOS_fread) etc
<br/>
<br/>
<a class="postlink" href="http://gpf.dcemu.co.uk/ndsromdisk.shtml" target="_blank">http://gpf.dcemu.co.uk/ndsromdisk.shtml</a>
<br/>
<br/>
and also the FAT lib uses FAT_fopen etc . But then again it wouldn't be that difficult to write a abstract api that sits on top of gbfs as well.
<br/>
<br/>
Troy(GPF)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#72175 - Webez - Thu Feb 16, 2006 10:02 pm</h4>
    <div class="postbody"><span class="postbody">I have made this right now for gbfs
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
struct GBFSFILE{
<br/>
   u8 *data;
<br/>
   int index;
<br/>
   u32 length;
<br/>
};
<br/>
<br/>
GBFSFILE * fopen (const char * filename){
<br/>
   GBFSFILE *file=new GBFSFILE();
<br/>
   file-&gt;data=(u8*)gbfs_get_obj(gbfs_file,filename,&amp;file-&gt;length);
<br/>
   file-&gt;index=0;
<br/>
         return file;
<br/>
}
<br/>
<br/>
<br/>
int  fread(void * buffer, size_t size, size_t count, GBFSFILE *file){
<br/>
   memcpy(buffer,&amp;file-&gt;data[file-&gt;index],size*count);
<br/>
   file-&gt;index+=size*count;
<br/>
}
<br/>
<br/>
int  fseek (GBFSFILE * file , long offset , int origin ){
<br/>
   switch (origin)
<br/>
   {
<br/>
      case 0 : file-&gt;index=0+offset; 
<br/>
         break;
<br/>
      case 1 : file-&gt;index+=offset; 
<br/>
         break;
<br/>
      case 2 : file-&gt;index=file-&gt;length+offset; 
<br/>
         break;
<br/>
<br/>
   }
<br/>
   
<br/>
}
<br/>
<br/>
int  DS_Loader::fclose (GBFSFILE * file){
<br/>
   file-&gt;data=NULL;
<br/>
   delete file;
<br/>
}
<br/>
<br/>
////////////////////
<br/>
GBFSFILE *file;
<br/>
file=fopen("name.extension");
<br/>
fseek(file,10,SEEK_CUR);
<br/>
int variable[3];
<br/>
fread(variable,4,3,file);
<br/>
fclose(file);
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I don't know how useful they are.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#72178 - Lazy1 - Thu Feb 16, 2006 10:31 pm</h4>
    <div class="postbody"><span class="postbody">I'm currently working on a filesystem wrapper which should do basically the same thing.
<br/>
The idea is to call Initialize() on each supported filesystem, if Initialize() returns nonzero the correct filesystem has been detected and you can use stdio like functions without worrying about FS specific details.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
void blah( void ) {
<br/>
   DS_FILE fileHandle = 0;
<br/>
<br/>
   fileHandle = FS-&gt;fopen( "/test.bin", F_READONLY );
<br/>
   ...
<br/>
   ...
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Currently I have chishm's FAT driver working and the GBFS wrappers are completed but untested.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#72183 - genfish - Thu Feb 16, 2006 10:49 pm</h4>
    <div class="postbody"><span class="postbody">ooo some helpful stuff, thanks guys. I'll give a couple of them a shot.<br/>_________________<br/>there is no rl only afk</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#72208 - tepples - Fri Feb 17, 2006 1:32 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Lazy1 wrote:</b></span></td> </tr> <tr> <td class="quote">I'm currently working on a filesystem wrapper which should do basically the same thing.
<br/>
The idea is to call Initialize() on each supported filesystem</td> </tr></table><span class="postbody">
<br/>
Good idea. What license? And are you planning to make it DS-specific or C++-only or both?<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#72211 - Lazy1 - Fri Feb 17, 2006 1:48 am</h4>
    <div class="postbody"><span class="postbody">License: I haven't decided on a license or if I'll use one.
<br/>
DS Specific: At the moment yes, though it would be easy to port it.
<br/>
C++ only: It is written in C.
<br/>
<br/>
I have no idea when I'll finish it, gotta figure out how to test GBFS without a flashcart.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#72220 - tepples - Fri Feb 17, 2006 2:10 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Lazy1 wrote:</b></span></td> </tr> <tr> <td class="quote">License: I haven't decided on a license or if I'll use one.</td> </tr></table><span class="postbody">
<br/>
You need to use a license, even if it's just a permissive license a la zlib, because the copyright law assumes "all rights reserved" unless the author states otherwise.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">DS Specific: At the moment yes, though it would be easy to port it.
<br/>
[...]
<br/>
I have no idea when I'll finish it, gotta figure out how to test GBFS without a flashcart.</td> </tr></table><span class="postbody">
<br/>
At least on Game Boy Advance, GBFS works in multiboot mode. For instance, Tetanus On Drugs accesses a GBFS file in EWRAM. This gives you yet another reason not to make it DS-specific. I asked because I wanted to use it for GSM Player and Luminesweeper, both GBA programs, so that I could consolidate the GBFS version and the (future) GBAMP version.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">C++ only: It is written in C.</td> </tr></table><span class="postbody">
<br/>
I was confused by the FS-&gt; part.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#72256 - Lazy1 - Fri Feb 17, 2006 6:30 am</h4>
    <div class="postbody"><span class="postbody">FS is just a pointer to filesystem functions like fopen, fclose, fread, ect...
<br/>
I was thinking though, if I build the filesystem code as generic arm - could I put the FS pointer somewhere in memory where both CPUs can access it?
<br/>
<br/>
That way I wouldn't need to have the library compiled into the arm7 aswell as the arm9 along with the FS drivers which take up quite a bit of space.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#73323 - genfish - Fri Feb 24, 2006 7:46 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Webez wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
fseek(file,10,SEEK_CUR);
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
what does this function do exactly, what is 'offset' and 'origin'.
<br/>
<br/>
thanks :)<br/>_________________<br/>there is no rl only afk</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#73328 - josath - Fri Feb 24, 2006 8:30 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>genfish wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Webez wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
fseek(file,10,SEEK_CUR);
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
what does this function do exactly, what is 'offset' and 'origin'.
<br/>
<br/>
thanks :)</span></td> </tr></table><span class="postbody">
<br/>
<br/>
<a href="http://www.google.com/search?q=fseek" target="_blank">http://www.google.com/search?q=fseek</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#73339 - genfish - Fri Feb 24, 2006 10:40 pm</h4>
    <div class="postbody"><span class="postbody">still not having any luck, gettin late now so im gonna give GPFerror's romdisk a shot tomorrow. I dunno if im using gbfs right or not, but do i basically do this... ?
<br/>
<br/>
- make the .gbfs file e.g. gbfs test.gbfs test.txt
<br/>
- compile my code
<br/>
- padbin the .nds file
<br/>
- use cat to append the gbfs e.g. cat test.nds test.gbfs &gt;test_tmp.nds
<br/>
- move back to original filename from the tmp using mv
<br/>
- then dsbuild, and trasnfer to the flash cart.
<br/>
<br/>
is that right?<br/>_________________<br/>there is no rl only afk</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#73342 - Webez - Fri Feb 24, 2006 11:00 pm</h4>
    <div class="postbody"><span class="postbody">This is what I do
<br/>
<br/>
gbfs.exe temp.gbfs files/*.* 
<br/>
padbin 256 nds.nds      
<br/>
cat nds.nds temp.gbfs &gt;temp.nds
<br/>
del temp.gbfs
<br/>
del nds.nds
<br/>
cat ndsmall.bin temp.nds &gt;nds.ds.gba
<br/>
<br/>
Try it with an example that already works, but using gbfs instead of a header and .bin</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#73464 - genfish - Sat Feb 25, 2006 9:16 pm</h4>
    <div class="postbody"><span class="postbody">call me stupid, but once i have gone through these steps, the only thing i send to the neoflash cart is the test.ds.gba file yes?
<br/>
<br/>
also webez, why have u appended a .bin file in the example above if it uses gbfs?
<br/>
<br/>
thanks again :/
<br/>
<br/>
edit: thought i better include some code...
<br/>
<br/>
i've simplified it so much now, i just have:
<br/>
<br/>
arm9main:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
   char str[] = { 's', 't', 'r', 'i', 'n', 'g', '\0' };
<br/>
<br/>
   WAIT_CR &amp;= ~0x80;
<br/>
<br/>
   GBFS_FILE const *gbfs_file = find_first_gbfs_file((void*)0x08000000);
<br/>
   u8 *data = (u8*)gbfs_get_obj(gbfs_file, "test.txt", NULL);
<br/>
   memcpy(str, data, 5);
<br/>
<br/>
<br/>
   iprintf("\n\n\tHello World!\n");
<br/>
   iprintf("Filereading Test: %s\n", str);
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
then i've been doing this...
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
<br/>
gbfs tga.gbfs test.txt
<br/>
<br/>
padbin 256 DStga.nds
<br/>
<br/>
cat DStga.nds tga.gbfs &gt;DStga_tmp.nds
<br/>
<br/>
mv DStga_tmp.nds DStga.nds
<br/>
<br/>
dsbuild DStga.nds -o DStga.nds.gba
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
(test.txt contains just the word hello)
<br/>
<br/>
i then transfer DStga.nds.gba to my neoflash using the NEO Power Kit, and the output is:
<br/>
Hello World!
<br/>
Filereading test: _____g
<br/>
<br/>
edit2: (hehe) after reading a few forums threads, could it be that im using the libnds template makefiles to compile my code? just another random thought in the desparation of solving my problem :/<br/>_________________<br/>there is no rl only afk</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#73477 - Webez - Sun Feb 26, 2006 12:09 am</h4>
    <div class="postbody"><span class="postbody">It is a loader for flashcarts. I don't know if it still necessary but I use it.
<br/>
<br/>
<a class="postlink" href="http://darkfader.net/ds/files/ndsmall.bin" target="_blank">http://darkfader.net/ds/files/ndsmall.bin</a>
<br/>
<br/>
I use libnds templates and they work perfectly. Try the commands I have put before. You could also try the .nds file in desmume</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#73555 - genfish - Sun Feb 26, 2006 5:27 pm</h4>
    <div class="postbody"><span class="postbody">i knew i wasnt crazy!!!! lol
<br/>
<br/>
i tried an old nds file from this program in desmume, and it worked!
<br/>
<br/>
the text displays is "hellog" which is right as i only told it to copy 5 chars.
<br/>
<br/>
Only thing is tho, it didnt have the framebuffer mode active on the main screen. Does desmume not supprt framebuffer mode?<br/>_________________<br/>there is no rl only afk</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#73562 - Webez - Sun Feb 26, 2006 6:16 pm</h4>
    <div class="postbody"><span class="postbody">There are 2 versions of desmume. Try both of them. You could also try  the new version of dualis that it finally supports gbfs</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#73565 - genfish - Sun Feb 26, 2006 6:22 pm</h4>
    <div class="postbody"><span class="postbody">dualis works, which is good. i just tried it now.
<br/>
<br/>
At least i can get on with developing and worry about transferring to the neoflash later.
<br/>
<br/>
thanks for all your help, its much appreciated.<br/>_________________<br/>there is no rl only afk</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#74216 - genfish - Fri Mar 03, 2006 4:15 pm</h4>
    <div class="postbody"><span class="postbody">update on this... i got it to work :D
<br/>
<br/>
i simplified it to have a text file containing 'hello' and just read that.
<br/>
<br/>
the problem was, i was appending the gbfs file to the .nds BEFORE i ran dsbuild. this is bad!!
<br/>
<br/>
So for those of you with a neoflash kit, how it should be done....
<br/>
1. compile your code (with a makefile)
<br/>
2. create the .gbfs file
<br/>
3. run dsbuild on your .nds file
<br/>
4. padbin the .ds.gba file
<br/>
5. append the gbfs file to the .ds.gba file.
<br/>
6. trasnfer using neopowerkit
<br/>
7. et voila<br/>_________________<br/>there is no rl only afk</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#89547 - JessTicular - Sun Jun 25, 2006 12:37 pm</h4>
    <div class="postbody"><span class="postbody">Hey there,
<br/>
<br/>
I know it's a 3 1/2 month old thread, and I hate to bump it like this, but...
<br/>
<br/>
You can now automate this whole process for every build;
<br/>
<br/>
I just the other day made a modification to the template combined Makefile provided by wintermute via the CVS examples.
<br/>
(The Makefile that you use as a control to call the Makefiles for the arm7 &amp; arm9's individually)
<br/>
<br/>
It's a basic fix that forces a dependancy to be added at the highest level - The .ds.gba file must first be built, then the gbfs archive can be created, then it can be appended.
<br/>
<br/>
Simply make sure you have the gbfs.exe &amp; padbin.exe in your devkitARM/bin directory, create a folder called 'data' at your top-most level of source to hold all the files to be gbfs'd, and use this Makefile to put it all together.
<br/>
<br/>
<a class="postlink" href="http://jt0.org/dl/ds/makefile/Makefile.zip" target="_blank">Download the Makefile</a>
<br/>
<br/>
<br/>
The final output file with the gbfs appended will now be &lt;ProjectName&gt;.gbfs.ds.gba
<br/>
Along with keeping your un-gbfs'd &lt;ProjectName&gt;.ds.gba &amp; &lt;ProjectName&gt;.nds binaries in tact.
<br/>
<br/>
Also, if you don't have any files in the /data directory, gbfs will throw an error. But, don't worry, it just means that it couldn't find anything to append, so it didn't append anything :P
<br/>
<br/>
<br/>
That explanation in plain english;
<br/>
Your directory should have been:
<br/>
<br/>
- ./arm7/
<br/>
- ./arm9/
<br/>
- ./Makefile
<br/>
<br/>
and now, it should be:
<br/>
<br/>
- ./arm7/
<br/>
- ./arm9/
<br/>
- ./data/
<br/>
- ./Makefile <span style="font-style: italic">(The new Makefile)</span>
<br/>
<br/>
<br/>
<br/>
<br/>
... Enjoy :)</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
