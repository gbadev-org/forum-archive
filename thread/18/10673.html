<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Help wanted: fog - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>DS development > Help wanted: fog</h2>
<div id="posts">
<div class="post">
    <h4>#96627 - ecurtz - Fri Aug 04, 2006 6:26 am</h4>
    <div class="postbody"><span class="postbody">Has anybody done anything with fogging in 3d scenes? I haven't been able to find any information about how to enable it.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#96915 - omaremad - Sun Aug 06, 2006 3:43 pm</h4>
    <div class="postbody"><span class="postbody">for fog i would do the following ( this is my own technique which i theorised but never tested)
<br/>
<br/>
I would have a huge quad inclinded at a 45 deg angle to the camera
<br/>
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
  /
<br/>
C-------/(top)
<br/>
  \       /
<br/>
         /
<br/>
        /(bottom)
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
the quad would be the same colour as the fog, and for a volumetric effect rather than bland fog you could use POLYFRMT and set the polyalpha to higher on the lower polygons of the quad(the bottom ones)
<br/>
<br/>
you could even use a fog texture 
<br/>
<br/>
:)[/code]</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#97044 - ecurtz - Mon Aug 07, 2006 4:32 pm</h4>
    <div class="postbody"><span class="postbody">Thanks, but I'm actually interested in using the hardware fog. Anybody have even the registers? I'd be willing to do some testing.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#97059 - omaremad - Mon Aug 07, 2006 7:04 pm</h4>
    <div class="postbody"><span class="postbody">I dont think the fog registers have been found yet, besides hw fog is ugly, compare resident evil 4 fog to hw fog, RE4 is polygonal based like mine therefore could be textured and depth based</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#97623 - dovoto - Thu Aug 10, 2006 9:08 pm</h4>
    <div class="postbody"><span class="postbody">I have done a hardware fog demo...I will see if i can locate or reproduce the source.  I had updated libnds but had a bit of data loss prior to checkin.<br/>_________________<br/><a href="http://www.drunkencoders.com" target="_blank">www.drunkencoders.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#97715 - ecurtz - Fri Aug 11, 2006 6:16 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>dovoto wrote:</b></span></td> </tr> <tr> <td class="quote">I have done a hardware fog demo...I will see if i can locate or reproduce the source.  I had updated libnds but had a bit of data loss prior to checkin.</td> </tr></table><span class="postbody">
<br/>
<br/>
Excellent, thanks. It's really what I need for this particular application.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#97779 - dj-ceejay - Fri Aug 11, 2006 2:44 pm</h4>
    <div class="postbody"><span class="postbody">You could use a set of fog billboards throughout your level with their alpha levels based on their distance from the camera (transparent when near the camera, opaque when far away from the camera). You would have to watch the fillrate as you would need the billboards quite big to cover the screen.<br/>_________________<br/>Fruit Machine Games:
<br/>
<a class="postlink" href="http://www.fmsoftware.info/" target="_blank">http://www.fmsoftware.info/</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#97810 - omaremad - Fri Aug 11, 2006 6:31 pm</h4>
    <div class="postbody"><span class="postbody">Because the ds uses some sort of weird scan line renderer it stays always at 60fps no matter the texturing lighting etc... (provdidng you are under 2000 polies)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#97887 - M3d10n - Sat Aug 12, 2006 4:26 am</h4>
    <div class="postbody"><span class="postbody">Even so, polygons will only blend against one with a different ID (I think the ID specifies at which order they'll get blended during render, but I haven't tested that), and since there are only 64 unique IDs, you'll get 64 overlapping  planes at most.
<br/>
<br/>
Finding out how to get the hardware per-pixel fog to work would be great, since it looks very good (MP:H makes very good use of it for mood and depth).</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#97903 - crossraleigh - Sat Aug 12, 2006 8:22 am</h4>
    <div class="postbody"><span class="postbody">Sometime recently (I guess with the release of no$gba 2.3), Martin Korth quietly added a <a class="postlink" href="http://nocash.emubase.de/gbatek.htm#ds3dvideo" target="_blank">3D section</a> to GBATEK which has info on hardware fog.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#97957 - dak - Sat Aug 12, 2006 3:48 pm</h4>
    <div class="postbody"><span class="postbody">I've been playing around with the fog registers as documented on GBATEK, but have not gotten very far myself.  I enabled bits 6 and 7 in the GFX_CONTROL (enabling alpha fogging effects), but enabling bit 15 on GFX_POLY_FMT (to enable poly-fogs) simply seems to clear my screen of any polygons at all!
<br/>
<br/>
I assume fog color wouldn't have to be set as I'm using alpha fog (but I set it anyway just in case to red).  The tech documents make mention that bits 8-11 in GFX_CONTROL (fog shift?) are related somehow to the FOG_OFFSET.  My knowledge in this area is VERY little and I assumed that fog offset is the distance between the eye and the fog (if so, what is the data type?).  Anyway; anyother explorers have any insight they unearthed on this?
<br/>
<br/>
XD I'm anxiously waiting for Dovoto to slap some sample code up here to play with!
<br/>
<br/>
-dak</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#97974 - omaremad - Sat Aug 12, 2006 5:10 pm</h4>
    <div class="postbody"><span class="postbody">hey if you want to activate fog on the background as a testing method before we manage polygons use this
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
<br/>
4000350h - CLEAR_COLOR - Clear Color Attribute Register (W)
<br/>
<br/>
  0-4    Clear Color, Red
<br/>
  5-9    Clear Color, Green
<br/>
  10-14  Clear Color, Blue
<br/>
<span style="font-weight: bold">15     Fog (enables Fog to the rear-plane) (doesn't affect Fog of polygons)</span>
<br/>
  16-20  Alpha
<br/>
  21-23  Not used
<br/>
  24-29  Clear Polygon ID (affects edge-marking, at the screen-edges?)
<br/>
  30-31  Not used
<br/>
</td> </tr></table><span class="postbody">[/b]</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#97976 - omaremad - Sat Aug 12, 2006 5:21 pm</h4>
    <div class="postbody"><span class="postbody">the fog offset probably describes the polygon ID the fog should act on
<br/>
<br/>
Seems the set up is similar to toon edges where you enable edges then
<br/>
<br/>
yo specify the color and the id shifted by &gt;&gt;3
<br/>
<br/>
so maybe the offset defines the poly id the fog should work on
<br/>
<br/>
btw i would drool if we can use this in some way useful
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
13    Polygon/Vertex RAM Overflow    (0=None, 1=Overflow/Acknowledge)
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#98042 - ecurtz - Sat Aug 12, 2006 9:59 pm</h4>
    <div class="postbody"><span class="postbody">Thanks everybody, haven't got the specifics worked out yet, but it seems to work. Here are the relevant bits of my project...
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#define POLY_FOG  (1&lt;&lt;15)
<br/>
<br/>
#define GL_FOG_ALPHA    (1&lt;&lt;6)
<br/>
#define GL_FOG          (1&lt;&lt;7)
<br/>
#define GL_FOG_SHIFT(n)   ((n)&lt;&lt;8)
<br/>
<br/>
#define GL_RDLINE_UNDERFLOW   (1&lt;&lt;12)
<br/>
#define GL_VERTEX_OVERFLOW    (1&lt;&lt;13)
<br/>
<br/>
#define GFX_FOG_COLOR   (*(vuint32*) 0x04000358)
<br/>
#define GFX_FOG_OFFSET  (*(vuint32*) 0x0400035C)
<br/>
#define GFX_FOG_TABLE   ((vuint8*)  0x04000360)
<br/>
<br/>
void glFogColor(uint8 red, uint8 green, uint8 blue, uint8 alpha) { GFX_FOG_COLOR = (red) | ((green)&lt;&lt;5) | ((blue)&lt;&lt;10) | ((alpha)&lt;&lt;16); }
<br/>
void glFogDepth(uint16 depth) { GFX_FOG_OFFSET = depth; }
<br/>
<br/>
<br/>
// Set up the fog stuff
<br/>
   glFogColor(63, 0, 0, 31);
<br/>
   glFogDepth(0x400);
<br/>
   int i;
<br/>
   for (i = 0; i &lt; 32; i++) {
<br/>
      GFX_FOG_TABLE[i] = i&lt;&lt;2;
<br/>
   }
<br/>
<br/>
<br/>
      GFX_CONTROL = GL_FOG | GL_FOG_SHIFT(3) | GL_RDLINE_UNDERFLOW | GL_VERTEX_OVERFLOW | GL_TEXTURE_2D /*| GL_BLEND*/;
<br/>
<br/>
      glPolyFmt(POLY_ALPHA(31) | POLY_FOG | POLY_ID(2) | culling | POLY_FORMAT_LIGHT0 | POLY_FORMAT_LIGHT1 | POLY_FORMAT_LIGHT2);
<br/>
         glBegin(GL_TRIANGLE_STRIP);
<br/>
<br/>
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
GL_FOG_SHIFT() seems to actually be a shift, larger values mean smaller fog bands, it wasn't working with a shift of 0. I'm not sure exactly how the scales correspond to the vertex scales yet, I just played with numbers until it looked ok.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
