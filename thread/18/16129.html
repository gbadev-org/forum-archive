<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Fixed point ray plane collision - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>DS development > Fixed point ray plane collision</h2>
<div id="posts">
<div class="post">
    <h4>#163820 - 3dfx - Sun Oct 12, 2008 11:28 pm</h4>
    <div class="postbody"><span class="postbody">Hey guys I'm using the ray plane collision test  based on <a href="http://www.flipcode.com/archives/Point-Plane_Collision.shtml" target="_blank">http://www.flipcode.com/archives/Point-Plane_Collision.shtml</a>  .
<br/>
And I'm having a rough time getting it working properly.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
typedef struct {
<br/>
     int32 x, y, z;
<br/>
}VECTOR32;
<br/>
<br/>
typedef struct {
<br/>
   VECTOR32 points[4];
<br/>
   VECTOR32 normal;
<br/>
   int d;
<br/>
}Plane;
<br/>
<br/>
<br/>
void calcPlaneD(Plane *plane){
<br/>
   plane-&gt;d = dotProd(&amp;plane-&gt;points[0], &amp;plane-&gt;normal);
<br/>
}
<br/>
void calcPlaneNormal(Plane *plane){
<br/>
   VECTOR32 points[2];
<br/>
   points[0].x = plane-&gt;points[1].x - plane-&gt;points[0].x;
<br/>
   points[0].y = plane-&gt;points[1].y - plane-&gt;points[0].y;
<br/>
   points[0].z = plane-&gt;points[1].z - plane-&gt;points[0].z;
<br/>
   
<br/>
   points[1].x = plane-&gt;points[2].x - plane-&gt;points[1].x;
<br/>
   points[1].y = plane-&gt;points[2].y - plane-&gt;points[1].y;
<br/>
   points[1].z = plane-&gt;points[2].z - plane-&gt;points[1].z;
<br/>
   
<br/>
   plane-&gt;normal.x = mulf32(points[0].y, points[1].z) - mulf32(points[1].y, points[0].z);
<br/>
   plane-&gt;normal.y = mulf32(points[0].z, points[1].x) - mulf32(points[1].z, points[0].x);
<br/>
   plane-&gt;normal.z = mulf32(points[0].x, points[1].y) - mulf32(points[1].x, points[0].y);
<br/>
   normalizeVector(&amp;plane-&gt;normal);
<br/>
}
<br/>
<br/>
int32 dotProd(VECTOR32 *one, VECTOR32 *two)
<br/>
{
<br/>
   return mulf32(one-&gt;x, two-&gt;x) + mulf32(one-&gt;y, two-&gt;y) + mulf32(one-&gt;z, two-&gt;z);
<br/>
}
<br/>
void normalizeVector(VECTOR32 *vec)
<br/>
{
<br/>
   // magnitude = sqrt ( Ax^2 + Ay^2 + Az^2 )
<br/>
   int32 magnitude = sqrtf32( mulf32(vec-&gt;x, vec-&gt;x) + mulf32(vec-&gt;y, vec-&gt;y) + mulf32(vec-&gt;z, vec-&gt;z) );
<br/>
<br/>
   vec-&gt;x = divf32(vec-&gt;x, magnitude);
<br/>
   vec-&gt;y = divf32(vec-&gt;y, magnitude);
<br/>
   vec-&gt;z = divf32(vec-&gt;z, magnitude);
<br/>
}
<br/>
int distToIntersection(Plane *plane, VECTOR32 *startingPt, VECTOR32 *dir){  //
<br/>
   int32 denom = dotProd(&amp;plane-&gt;normal, dir);
<br/>
   if(absV(denom == 0)){ 
<br/>
      return -1;
<br/>
   }
<br/>
   int numer = dotProd(&amp;plane-&gt;normal, startingPt) + plane-&gt;d;
<br/>
   return (-div32(numer, denom));
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
It seems to only work when the normal is 0, 4096, 0.  
<br/>
I checked it(made it print out stuff) and seems like distToIntersection doesnt give me the right result. Any ideas why?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#163821 - silent_code - Sun Oct 12, 2008 11:39 pm</h4>
    <div class="postbody"><span class="postbody">What does absV in "if(absV(denom == 0))" mean?<br/>_________________<br/><span style="font-size: 9px; line-height: normal"><span style="text-decoration: underline"><span style="font-weight: bold"></span></span> July 5th 08: "<span style="font-weight: bold">Volumetric Shadow Demo</span>" 1.6.0 (final) source released
<br/>
June 5th 08: "<span style="font-weight: bold">Zombie NDS</span>" WIP released!
<br/>
It's all on my page, just click <span style="font-weight: bold">WWW</span> below.</span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#163822 - 3dfx - Sun Oct 12, 2008 11:43 pm</h4>
    <div class="postbody"><span class="postbody">Whoops typo, it's if absV(denom) == 0) well i wasnt checking for 0 as much as I was gonna check for less than a small value.
<br/>
So I meant absV(denom) &lt; smallVal;</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#163860 - TwentySeven - Mon Oct 13, 2008 10:14 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
void calcPlaneNormal(Plane *plane){ 
<br/>
   VECTOR32 CA; 
<br/>
   VECTOR32 CB; 
<br/>
<br/>
   //C-A
<br/>
   CA.x = plane-&gt;points[2].x - plane-&gt;points[0].x; 
<br/>
   CA.y = plane-&gt;points[2].y - plane-&gt;points[0].y; 
<br/>
   CA.z = plane-&gt;points[2].z - plane-&gt;points[0].z; 
<br/>
    
<br/>
   //C-B
<br/>
   CB.x = plane-&gt;points[2].x - plane-&gt;points[1].x; 
<br/>
   CB.y = plane-&gt;points[2].y - plane-&gt;points[1].y; 
<br/>
   CB.z = plane-&gt;points[2].z - plane-&gt;points[1].z; 
<br/>
 
<br/>
    //crossprod
<br/>
    plane-&gt;normal.x = mulf32(CA.y,CB.z) - mulf32(CA.z, CB.y); 
<br/>
    plane-&gt;normal.y = mulf32(CA.z, CB.x) - mulf32(CA.x, CB.z); 
<br/>
    plane-&gt;normal.z = mulf32(CA.x, CB.y) - mulf32(CA.y, CB.x); 
<br/>
<br/>
    normalizeVector(&amp;plane-&gt;normal); 
<br/>
} </td> </tr></table><span class="postbody">
<br/>
<br/>
Thats just modified after checking it against my own functions.  Your math *may* be correct but I'm absolutely sure that is ^</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#163861 - TwentySeven - Mon Oct 13, 2008 10:28 pm</h4>
    <div class="postbody"><span class="postbody">The other issue is that your addition inside your normalize function could be overflowing..</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#163862 - 3dfx - Mon Oct 13, 2008 11:14 pm</h4>
    <div class="postbody"><span class="postbody">Thanks for the help. Doing the cross prod your way didnt change anyhting unfortunately, but I was changing my coordinates randomly to see if it would do anything. Also my coordinates are small values (none larger than (7&lt;&lt;12)).
<br/>
<br/>
And oddly enough, the points  (0, 0, -7), (0, 0, 7), (7, 0, 7), (7,0, -7) in fixed pt  would give the normal (-2896, 2896, 0). So far so good. When using the collision with this plane, it worked!
<br/>
<br/>
But using the points (0, 0, -7), (0, 0, 7), (7, 7, 7), (7,7, -7) gave the proper normal of 2896 2896 but the collision would be wrong, that is, the collision distance was far too great. The distance was actually the distance it would be if the plane was upside down.
<br/>
So I'm largely confused why the first set of coordinates works.
<br/>
My position is above the plane in the ydir and within the plane coordinates in the x and z direction. My direction vector is (0,-4096,0).</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#163864 - TwentySeven - Mon Oct 13, 2008 11:53 pm</h4>
    <div class="postbody"><span class="postbody">Could you be running into winding order issues then?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#163869 - 3dfx - Tue Oct 14, 2008 2:19 am</h4>
    <div class="postbody"><span class="postbody">I have no clue why, but setting the plane's d to -d solved all my problems.
<br/>
Weird stuff. I'd love to know why, but I guess I have to content myself with a solution. :D
<br/>
<br/>
Thanks all!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#163903 - silent_code - Tue Oct 14, 2008 8:08 pm</h4>
    <div class="postbody"><span class="postbody">Maybe it's because of
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">distance = |ax + by + cz + d|</td> </tr></table><span class="postbody">
<br/>
and
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">d = a + b + c
<br/>
with (a,b,c) normalized</td> </tr></table><span class="postbody">
<br/>
I have only glanced over your implementation, though.
<br/>
<br/>
Check your absV, too.<br/>_________________<br/><span style="font-size: 9px; line-height: normal"><span style="text-decoration: underline"><span style="font-weight: bold"></span></span> July 5th 08: "<span style="font-weight: bold">Volumetric Shadow Demo</span>" 1.6.0 (final) source released
<br/>
June 5th 08: "<span style="font-weight: bold">Zombie NDS</span>" WIP released!
<br/>
It's all on my page, just click <span style="font-weight: bold">WWW</span> below.</span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#163919 - sajiimori - Wed Oct 15, 2008 3:56 am</h4>
    <div class="postbody"><span class="postbody">3dfx, try doing the math by hand for a very simple case, like the x=2 plane (that is, n=(1,0,0) and d=-2), and a ray going along -x from (3,0,0).
<br/>
<br/>
Quick sanity checks like that usually get the basic test working, leaving only degenerate cases to deal with.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
