<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>DS Timer question - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > DS Timer question</h2>
<div id="posts">
<div class="post">
    <h4>#45235 - GPFerror - Wed Jun 08, 2005 9:26 pm</h4>
    <div class="postbody"><span class="postbody">I found an example of using timers for GBA
<br/>
<br/>
Iv tried to convert it to DS timers, im sure that its not correct since the doubling of the clock speed so I need so help with the correct shift in the define I believe.
<br/>
<br/>
Thanks
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#define timers2ms(tlow,thigh) ((tlow&gt;&gt;4)+(thigh&lt;&lt;12))
<br/>
<br/>
void StartTimers(void)
<br/>
{
<br/>
   TIMER0_DATA=0;
<br/>
   TIMER1_DATA=0;
<br/>
   TIMER0_CR=TIMER_CASCADE;
<br/>
   TIMER1_CR=TIMER_DIV_1024;
<br/>
}
<br/>
<br/>
Uint32 GetTicks(void)
<br/>
{
<br/>
   return timers2ms(TIMER0_DATA, TIMER1_DATA);
<br/>
}
<br/>
<br/>
void Pause(Uint32 ms)
<br/>
{
<br/>
   int now;
<br/>
   now=timers2ms(TIMER0_DATA, TIMER1_DATA);
<br/>
   while(timers2ms(TIMER0_DATA, TIMER1_DATA)&lt;now+ms);
<br/>
} </td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#46136 - GPFerror - Mon Jun 20, 2005 6:24 pm</h4>
    <div class="postbody"><span class="postbody">ok i finally had a chance to test it out, still dont think the shifts are correct since the original example was based on a 16384 Hz timer since the DS is around 33 MHZ timer i think I need to change the timer2ms define to account for that but im not sure how to.
<br/>
<br/>
I'v tested the below code, calling starttimers and then calling pause and it is pausing for a couple of seconds correctly, running in Ideas and dualis dont have the necessary hardware to test it on my DS yet though.
<br/>
<br/>
Thanks,
<br/>
Troy 
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">typedef unsigned int   Uint32; 
<br/>
#define timers2ms(tlow,thigh) ((tlow&gt;&gt;4)+(thigh&lt;&lt;12)) 
<br/>
<br/>
void StartTimers(void) 
<br/>
{ 
<br/>
   TIMER0_DATA=0; 
<br/>
   TIMER1_DATA=0; 
<br/>
   TIMER0_CR=TIMER_DIV_1024; 
<br/>
   TIMER1_CR=TIMER_CASCADE;
<br/>
} 
<br/>
<br/>
Uint32 GetTicks(void) 
<br/>
{ 
<br/>
   return timers2ms(TIMER0_DATA, TIMER1_DATA); 
<br/>
} 
<br/>
<br/>
void Pause(Uint32 ms) 
<br/>
{ 
<br/>
   Uint32 now; 
<br/>
   now=timers2ms(TIMER0_DATA, TIMER1_DATA); 
<br/>
   while((Uint32)timers2ms(TIMER0_DATA, TIMER1_DATA)&lt;now+ms); 
<br/>
} </td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#46139 - DekuTree64 - Mon Jun 20, 2005 6:51 pm</h4>
    <div class="postbody"><span class="postbody">I think all you need to do is 
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#define timers2ms(tlow,thigh) ((tlow&gt;&gt;5)+(thigh&lt;&lt;11))</td> </tr></table><span class="postbody">
<br/>
<br/>
Another way to do the same thing (unless the compiler decides to do a signed shift right) would be 
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">(tlow | (thigh&lt;&lt;16)) &gt;&gt; 5</td> </tr></table><span class="postbody">
<br/>
which I think is a little clearer what it means. Just puts them together into a 32-bit value, and divides by 32 (or 16 in the case of the original).<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#46143 - GPFerror - Mon Jun 20, 2005 8:10 pm</h4>
    <div class="postbody"><span class="postbody">cool, thanks that appears to work fine in the emulators. Now of course im doing the old 1 mississippi , 2 etc :) to compare it.
<br/>
<br/>
Troy</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#66609 - Rinky - Thu Jan 12, 2006 12:58 pm</h4>
    <div class="postbody"><span class="postbody">Er... I'm lost.
<br/>
<br/>
I looked at DoubleC's tutorial where he sets up a timer to record from the microphone at 16kHz
<br/>
TIMER0_DATA = 0xFC7F;
<br/>
<br/>
What I don't get is why 0xFC7F is 16kHz??? I'm told the DS uses a central timer at 33.4MHz but that isn't helping. Maybe a missed a maths lesson that I now wish I hadn't. :)
<br/>
<br/>
If you set
<br/>
TIMER0_DATA = 1;
<br/>
Then what's the frequency there? 4Hz? 
<br/>
<br/>
I did a quick test - set Timer0 to 1 (whatever that is) and had a printf run on every IRQ. result = very very quick iterations of the printf.
<br/>
<br/>
Wrote a littlercounter delay i.e. incrementing a variable on_irq and only calling the pritnf when it gets to preset point. With a delay of 1000 it outputs slightly quicker than once per second. 
<br/>
<br/>
So now I'm even more confused.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#66616 - strager - Thu Jan 12, 2006 2:15 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Rinky wrote:</b></span></td> </tr> <tr> <td class="quote">Er... I'm lost.
<br/>
<br/>
I looked at DoubleC's tutorial where he sets up a timer to record from the microphone at 16kHz
<br/>
TIMER0_DATA = 0xFC7F;
<br/>
<br/>
What I don't get is why 0xFC7F is 16kHz??? I'm told the DS uses a central timer at 33.4MHz but that isn't helping. Maybe a missed a maths lesson that I now wish I hadn't. :)</td> </tr></table><span class="postbody">
<br/>
<br/>
The DS's timer clock is around 33MHz, yes.  The problem is that you don't know how the timer data is set up.  Don't worry, I didn't know for a while, either.  ;)
<br/>
<br/>
Simply put, the DS increments each timer's data (TIMER?_DATA) if that timer is enabled.  If the timer 'overflows,' or gets reset back to 0, an interrupt is fired (if it was enabled for that timer), and all DMAs are checked to see if they depend on a timer.  (I'm not sure if this is the right order of events, though.  You'd have to do more research.)
<br/>
<br/>
So, here's a little formula to calculate the frequency from the TIMER?_DATA:
<br/>
<span style="font-style: italic">freq = cpu / (65536 - data)</span>
<br/>
<br/>
If you plug in your data there, you would get:
<br/>
<span style="font-style: italic">freq ~= (33.514MHz) / (65536 - 0xFC7F)
<br/>
freq ~= (33.514MHz) / (897)
<br/>
freq ~= 39,177.230840580Hz
<br/>
freq ~= 39kHz</span>
<br/>
<br/>
This is way off of the 16kHz...  Perhaps DoubleC assumed that the timers were slower?
<br/>
Anyways, you can reverse the formula to calculate the data.  I think that a macro is provided somewhere in <span style="font-style: italic">nds/timers.h</span>, called <span style="font-style: italic">TIMER_FREQ</span> or something similar.
<br/>
<br/>
Happy coding,
<br/>
strager</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#66619 - Rinky - Thu Jan 12, 2006 2:42 pm</h4>
    <div class="postbody"><span class="postbody">Thanks Stager,
<br/>
<br/>
It all makes a little more sense now. Back to the playing.. er... I mean "coding". :D</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#66727 - wintermute - Fri Jan 13, 2006 6:03 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>strager wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Rinky wrote:</b></span></td> </tr> <tr> <td class="quote">Er... I'm lost.
<br/>
<br/>
I looked at DoubleC's tutorial where he sets up a timer to record from the microphone at 16kHz
<br/>
TIMER0_DATA = 0xFC7F;
<br/>
<br/>
What I don't get is why 0xFC7F is 16kHz??? I'm told the DS uses a central timer at 33.4MHz but that isn't helping. Maybe a missed a maths lesson that I now wish I hadn't. :)</td> </tr></table><span class="postbody">
<br/>
<br/>
The DS's timer clock is around 33MHz, yes.  The problem is that you don't know how the timer data is set up.  Don't worry, I didn't know for a while, either.  ;)
<br/>
<br/>
Simply put, the DS increments each timer's data (TIMER?_DATA) if that timer is enabled.  If the timer 'overflows,' or gets reset back to 0, an interrupt is fired (if it was enabled for that timer), and all DMAs are checked to see if they depend on a timer.  (I'm not sure if this is the right order of events, though.  You'd have to do more research.)
<br/>
<br/>
So, here's a little formula to calculate the frequency from the TIMER?_DATA:
<br/>
<span style="font-style: italic">freq = cpu / (65536 - data)</span>
<br/>
<br/>
If you plug in your data there, you would get:
<br/>
<span style="font-style: italic">freq ~= (33.514MHz) / (65536 - 0xFC7F)
<br/>
freq ~= (33.514MHz) / (897)
<br/>
freq ~= 39,177.230840580Hz
<br/>
freq ~= 39kHz</span>
<br/>
<br/>
This is way off of the 16kHz...  Perhaps DoubleC assumed that the timers were slower?
<br/>
Anyways, you can reverse the formula to calculate the data.  I think that a macro is provided somewhere in <span style="font-style: italic">nds/timers.h</span>, called <span style="font-style: italic">TIMER_FREQ</span> or something similar.
<br/>
<br/>
Happy coding,
<br/>
strager</span></td> </tr></table><span class="postbody">
<br/>
<br/>
it's 0xF7CF not 0xFC7F
<br/>
<br/>
the timers count up each system clock, when they overflow an interrupt is generated.
<br/>
<br/>
0x10000 - 0xfc7f = 0x831 ( or 2097)
<br/>
<br/>
33514000/2097 = 15981.8789</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#66759 - Rinky - Fri Jan 13, 2006 9:53 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>wintermute wrote:</b></span></td> </tr> <tr> <td class="quote">it's 0xF7CF not 0xFC7F</td> </tr></table><span class="postbody">Whoops - typo. Well spotted. :)</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
