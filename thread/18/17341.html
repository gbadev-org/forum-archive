<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>How to implement custom malloc / free? - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>DS development > How to implement custom malloc / free?</h2>
<div id="posts">
<div class="post">
    <h4>#174860 - Dirbaio - Mon Jul 26, 2010 4:13 pm</h4>
    <div class="postbody"><span class="postbody">So, basically I want to replace libc's malloc and free functions with mine.
<br/>
(I'm using latest devkitpro and libnds)
<br/>
I've had no success no far.
<br/>
<br/>
Googling around i got these two solutions, which i tried without success:
<br/>
<br/>
"Malloc hooks": They don't seem to exist in DevkitARM...
<br/>
Redefining malloc/free and making them link before the lib ones: Works for my code, but other parts of libc (printf-related) call weird functions called _malloc_r or _free_r which i guess are part of the internal logic for malloc and free... I'm not catching those calls, so it doesnt work...
<br/>
<br/>
<br/>
BTW, you're probably asking why in the world I want that. I want it for two different things:
<br/>
<br/>
- For debugging: I have weird memory corruption issues :(
<br/>
- For ROM Hacking (in particular NSMB Hacking): I've set up some linker scripts that allow me to write some asm/c/c++ code and insert it into the game. I need malloc/free to call the actuall malloc/free from the game, or i can't use dynamic memory, libc, libfat and lots of cool things i'd like to use...
<br/>
<br/>
What would you suggest? Ive read blogs of people that have mentioned that they have done it, so it must be possible ...
<br/>
Thanks in advance!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#174872 - LOst? - Tue Jul 27, 2010 3:28 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Dirbaio wrote:</b></span></td> </tr> <tr> <td class="quote">- For ROM Hacking (in particular NSMB Hacking): I've set up some linker scripts that allow me to write some asm/c/c++ code and insert it into the game. I need malloc/free to call the actuall malloc/free from the game, or i can't use dynamic memory, libc, libfat and lots of cool things i'd like to use...
<br/>
</td> </tr></table><span class="postbody">
<br/>
You know this is not a hacking forum. 
<br/>
I can tell you that NSMB isn't using malloc/free from devkitpro. But it does use some kind of dynamic size allocation. When I found out about that, I got kinda sad, because I am a fan of fixed size pools for games (for speed and debugging of course).<br/>_________________<br/><span style="font-style: italic">Exceptions are fun</span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#174873 - Dirbaio - Tue Jul 27, 2010 6:05 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>LOst? wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Dirbaio wrote:</b></span></td> </tr> <tr> <td class="quote">- For ROM Hacking (in particular NSMB Hacking): I've set up some linker scripts that allow me to write some asm/c/c++ code and insert it into the game. I need malloc/free to call the actuall malloc/free from the game, or i can't use dynamic memory, libc, libfat and lots of cool things i'd like to use...
<br/>
</td> </tr></table><span class="postbody">
<br/>
You know this is not a hacking forum. 
<br/>
I can tell you that NSMB isn't using malloc/free from devkitpro. But it does use some kind of dynamic size allocation. When I found out about that, I got kinda sad, because I am a fan of fixed size pools for games (for speed and debugging of course).</span></td> </tr></table><span class="postbody">
<br/>
<br/>
I know that NSMB isn't using libc heaps. I have located the functions that do the equivalent of malloc/free, and I know how to call them from my c++ code.
<br/>
<br/>
I just want to be able to define two functions in my code that will be called instead of devkitpro's libc malloc/free. Independantly of NSMB hacking.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#174875 - Dwedit - Wed Jul 28, 2010 4:22 am</h4>
    <div class="postbody"><span class="postbody">You can look at a disassembly of NewLib to see what is calling the parts of malloc.
<br/>
Use arm-eabi-ar to extract libg.a into its .o files, then arm-eabi-objdump to disassemble the .o files.  The old batch command "for %F in (*.o) do ..." command might help.
<br/>
Then use a good text editor with a "Find in Files" feature.
<br/>
<br/>
Also check what extra calls GCC is introducing into the code by building with the -S option so you can see the asm code.
<br/>
<br/>
Don't forget to kill crap like __aeabi_atexit, I think that might call malloc_r somewhere.<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
