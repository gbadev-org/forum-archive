<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Specifics of time() - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > Specifics of time()</h2>
<div id="posts">
<div class="post">
    <h4>#161992 - Musturd12 - Fri Aug 22, 2008 8:53 pm</h4>
    <div class="postbody"><span class="postbody">I have some questions about the time() function.
<br/>
<br/>
Can someone tell me what the time() function returns? How fast is it (roughly how many clock cycles to run it)? Would it be fast enough to grab a time and every hundredth of a second and subtract from a previous time (as in keep grabbing times until time = time + 100 sort of thing)
<br/>
If I paused a song and played it again every 100th of a second would it sound distorted? Is there any nice documentation about time()?
<br/>
<br/>
Thanks.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161993 - Griffin - Fri Aug 22, 2008 9:06 pm</h4>
    <div class="postbody"><span class="postbody">Time is correct to one second (if you're talking about the one in time.h that is).</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161994 - Musturd12 - Fri Aug 22, 2008 9:11 pm</h4>
    <div class="postbody"><span class="postbody">Is there anyway to wait for a certain amount of milliseconds?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161995 - tepples - Fri Aug 22, 2008 9:14 pm</h4>
    <div class="postbody"><span class="postbody">time() returns the number of seconds since midnight on January 1, 1970.
<br/>
<br/>
I just looked at the <a class="postlink" href="http://devkitpro.cvs.sourceforge.net/devkitpro/libnds/source/arm7/clock.c?view=markup" target="_blank">libnds clock code</a>. Currently, the ARM7 updates the UNIX time in shared memory and the ARM9 picks it up from there inside dkarm-eabi's patch to libgloss. (In future libnds, this will apparently change to the ARM9 using the ARM7 as a server through the FIFO.)
<br/>
<br/>
If you want to use centiseconds or milliseconds to time game events, try counting in vblank units (16.7 ms) instead.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161996 - Musturd12 - Fri Aug 22, 2008 9:20 pm</h4>
    <div class="postbody"><span class="postbody">so if I do:
<br/>
WaitForVBlank();
<br/>
WaitForVBlank();
<br/>
WaitForVBlank();
<br/>
WaitForVBlank();
<br/>
WaitForVBlank();
<br/>
WaitForVBlank();
<br/>
<br/>
It would wait 100.2 msecs?
<br/>
Is there anyway I can play an mp3 file while it is waiting for vblank?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161997 - Griffin - Fri Aug 22, 2008 9:24 pm</h4>
    <div class="postbody"><span class="postbody">The sound hardware (probably) will keep running while you're waiting for the vblank. It may be easier to just have a timer that you increase by 1/60 every frame and use that for synchronising time events.</span><span class="gensmall"><br/><br/>Last edited by Griffin on Fri Aug 22, 2008 9:25 pm; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#161998 - tepples - Fri Aug 22, 2008 9:24 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Musturd12 wrote:</b></span></td> </tr> <tr> <td class="quote">so if I do:
<br/>
WaitForVBlank();
<br/>
WaitForVBlank();
<br/>
WaitForVBlank();
<br/>
WaitForVBlank();
<br/>
WaitForVBlank();
<br/>
WaitForVBlank();
<br/>
<br/>
It would wait 100.2 msecs?</td> </tr></table><span class="postbody">
<br/>
Yes, plus or minus a few fractions of a millisecond. The DS screen is redrawn 60 times a second, and swiWaitForVBlank() waits for <a class="postlink" href="http://en.wikipedia.org/wiki/Vertical_blank_interrupt" target="_blank">the interrupt that the DS video chip sends at the end of each redraw</a>.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Is there anyway I can play an mp3 file while it is waiting for vblank?</td> </tr></table><span class="postbody">
<br/>
Repeat these steps over and over: <ul><li>In the ARM9 program, decode a short piece of the MP3 file. </li><li>Tell the ARM7 program the address of this short piece. </li><li>Wait for vertical blank. </li></ul>
<br/>
A rumored future version of libnds will make step 2 straightforward.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161999 - Musturd12 - Fri Aug 22, 2008 10:36 pm</h4>
    <div class="postbody"><span class="postbody">Let BPM = 120
<br/>
1,002,000 VBlanks (16.7 ms) = 1 minute
<br/>
120 * x = 1,002,000
<br/>
x = 8350
<br/>
8350 VBlanks per Beat??? 
<br/>
<br/>
Can someone verify this? (Please! I am killing myself over figuring this out)
<br/>
<br/>
And how would I: </span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Tell the ARM7 program the address of this short piece. </td> </tr></table><span class="postbody">?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#162001 - tepples - Fri Aug 22, 2008 11:17 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Musturd12 wrote:</b></span></td> </tr> <tr> <td class="quote">1,002,000 VBlanks (16.7 ms) = 1 minute</td> </tr></table><span class="postbody">
<br/>
No. There are 60 vblanks in a second, and 60 seconds in a minute, so 3600 vblanks in a minute.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">And how would I: <table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Tell the ARM7 program the address of this short piece. </td> </tr></table><span class="postbody">?</span></td> </tr></table><span class="postbody">
<br/>
First look up <a class="postlink" href="http://en.wikipedia.org/wiki/Circular_buffer" target="_blank">circular buffer</a> in Wikipedia. Make a circular buffer long enough to hold about a quarter second of decoded audio (two buffers if you're using stereo), and have the ARM7 write to the sound registers to play it in loop mode.
<br/>
<br/>
I just checked for devkitARM and libnds updates today. It appears there is still <span style="font-weight: bold">no</span> standard way to tell the ARM7 the address of this buffer. One can play sounds with playSound(), but they can't loop because a TransferSoundData (defined in &lt;nds/ipc.h&gt;) has no field for looping. In fact, the standard ARM7 code (.../examples/nds/templates/combined/arm7/source/template.c) forces SOUND_ONE_SHOT mode.
<br/>
<br/>
So you'll have to write your own code that either passes the address in some part of shared memory (such as the IPC struct) or passes it through the FIFO. You'll have to write code for both the ARM7 and ARM9 (a "combined" project, not an "ARM9-only" project) to do this. Wintermute, the maintainer of devkitARM and libnds, claims that a future version of libnds will get rid of the IPC struct and introduce a standard way of handling FIFO messaging, so you <span style="font-weight: bold">will have to change</span> your buffer playing code once you have updated libnds to this version.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#162003 - Musturd12 - Sat Aug 23, 2008 12:30 am</h4>
    <div class="postbody"><span class="postbody">OK 60 per second.
<br/>
I'll try to make the code...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#162008 - Cydrak - Sat Aug 23, 2008 2:13 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tepples wrote:</b></span></td> </tr> <tr> <td class="quote">* In the ARM9 program, decode a short piece of the MP3 file.
<br/>
* Tell the ARM7 program the address of this short piece.
<br/>
* Wait for vertical blank.</td> </tr></table><span class="postbody">
<br/>
For the most part, this will work. However, I found it problematic, and I think not as simple as it seems. (Apologies if the following turns out to be too tangential to the discussion.)
<br/>
<br/>
MP3 comes in "frames" of around 1000 samples, IIRC. At 44Khz this is about 1/44 sec = 23msec. That's not synchronized with vblank, and probably not with your sound buffer either. It's certainly longer than a DS frame.
<br/>
<br/>
So the trouble I ran into (and I don't know if all decoders do this) is that Helix  appears to decode entire frames at once. Since the above are out of sync, CPU load can fluctuate rather uncomfortably between vblanks. If the bitrate is high enough, I've noticed it tends to spill over and miss the next vblank.
<br/>
<br/>
Naturally, this will make everything else lag. It can even cause skipping, for example if it spills and you hit the *next* swiWaitForVBlank(), right after one just happened. In that case I think you can "lose" whole frames of CPU time... even if you "should" have had enough to begin with!
<br/>
<br/>
I've noticed those symptoms in other players too (not that this guarantees I'm doing it <span style="font-style: italic">right</span> :-), and unfortunately I'm not sure what to suggest. Maybe someone else could chime in? The only solutions that occur to me, short of lower bitrates, are daunting. :/</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#162012 - tepples - Sat Aug 23, 2008 6:45 am</h4>
    <div class="postbody"><span class="postbody">The solution depends. Are you trying to use MP3s as music in a game or other app, or are you trying to make an MP3 player app designed just to play MP3s?<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#162031 - Musturd12 - Sat Aug 23, 2008 6:30 pm</h4>
    <div class="postbody"><span class="postbody">I'm making a guitar hero clone and I want mp3 custom song support.
<br/>
So a game, yes.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#162032 - tepples - Sat Aug 23, 2008 6:35 pm</h4>
    <div class="postbody"><span class="postbody">Then you might have to make a transcoder that reduces the complexity of decoding, such as 128 kbps 44 kHz MP3 to 64 kbps 32 kHz MP2. GH for DS has all its songs transcoded to two 28 kHz mono Ogg Vorbis streams if I remember correctly.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#162051 - fluff - Sun Aug 24, 2008 9:00 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tepples wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Musturd12 wrote:</b></span></td> </tr> <tr> <td class="quote">so if I do:
<br/>
WaitForVBlank();
<br/>
WaitForVBlank();
<br/>
WaitForVBlank();
<br/>
WaitForVBlank();
<br/>
WaitForVBlank();
<br/>
WaitForVBlank();
<br/>
<br/>
It would wait 100.2 msecs?</td> </tr></table><span class="postbody">
<br/>
Yes, plus or minus a few fractions of a millisecond.</span></td> </tr></table><span class="postbody">
<br/>
<br/>
And minus between 0 and 16.7ms, depending on the active line at the time of the first call.
<br/>
<br/>
This may not be relevant to the original question, and I haven't tried using it myself, but isn't there a VLINE reg you can read? Seems to me you could use that to get accuracy down to 16.7ms/256 = 0.065ms.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#162070 - Musturd12 - Sun Aug 24, 2008 9:20 pm</h4>
    <div class="postbody"><span class="postbody">Don't DPG files have mp2 sound?
<br/>
Could I just look at Moonshell's source and take a little code from there?
<br/>
Can anyone find a working link to download Moonshell's source?</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
