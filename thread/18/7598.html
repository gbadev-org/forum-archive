<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>DSEMU 0.4.8 (Modulus - SWI 9) Bios call problem. - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>DS development > DSEMU 0.4.8 (Modulus - SWI 9) Bios call problem.</h2>
<div id="posts">
<div class="post">
    <h4>#61945 - winneymj - Fri Nov 25, 2005 5:17 pm</h4>
    <div class="postbody"><span class="postbody">Hi,
<br/>
I am fairly new to DS development but have been a C/ASM/JAVA program for some 15 years. 
<br/>
I am using DevKitPro/DevKitArm r17, DsEMU 0.4.8 and ndslib 20051018.
<br/>
I have been having persistent problems with the Modulus (%) and divide (/) not returning back correct results.
<br/>
Example (1 % 10) keeps returning 0, and as we all know it should return 1.
<br/>
I traced/debugged  the assember code to the SWI 9, bios call and here is what I am seeing.
<br/>
<br/>
R00 - loaded with numerator (example = 1)
<br/>
R01 - loaded with divisor (example = 10)
<br/>
Call made to SWI 9
<br/>
R00 - now has 10
<br/>
R01 - now has 0
<br/>
<br/>
According to documentation I found on the BIOS at ndslib, the SWI 9 call is supposed to return the remainder in R01 (see below), and should contain value 1, not zero.  I am not sure the R00 register is correct either.
<br/>
<br/>
//////////////////////////////////////////////////////////////////////
<br/>
//
<br/>
// swi 0x09: Divide (returns result in r0, remainder in r1)
<br/>
//
<br/>
// int Divide(int numerator, int divisor);
<br/>
//   returns numerator / divisor
<br/>
//
<br/>
// int Remainder(int numerator, int divisor);
<br/>
//   returns numerator % divisor
<br/>
//
<br/>
// void DivMod(int numerator, int divisor, int * result, int * remainder);
<br/>
//   sets *result = numerator / divisor and remainder = numerator % divisor
<br/>
//
<br/>
//////////////////////////////////////////////////////////////////////
<br/>
<br/>
I saw from the DSEMU posts that 0.4.8, was to correct a SWI divide bug.  What was the bug?
<br/>
<br/>
Thanks for anyhelp.  This has been frustrating me for the last couple of weeks.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#61947 - Ethos - Fri Nov 25, 2005 6:02 pm</h4>
    <div class="postbody"><span class="postbody">Hmmm...Java was released in 1994....max 11 years :P
<br/>
<br/>
11 years ago I was programming Mac II's with Pascal...lol<br/>_________________<br/><a class="postlink" href="http://ethos.oddigytitanium.com" target="_blank">Ethos' Homepage (Demos/NDS 3D Tutorial)</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#61961 - winneymj - Fri Nov 25, 2005 10:12 pm</h4>
    <div class="postbody"><span class="postbody">Started with Pascal, ASM/ Followed by C, C++ and now Java.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#61984 - LOst? - Sat Nov 26, 2005 5:24 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>winneymj wrote:</b></span></td> </tr> <tr> <td class="quote">Started with Pascal, ASM/ Followed by C, C++ and now Java.</td> </tr></table><span class="postbody">
<br/>
I started with basic, then C, then C++, and now HTML.
<br/>
My life is complete!<br/>_________________<br/><span style="font-style: italic">Exceptions are fun</span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#61990 - doublec - Sat Nov 26, 2005 7:38 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>winneymj wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
R00 - loaded with numerator (example = 1)
<br/>
R01 - loaded with divisor (example = 10)
<br/>
Call made to SWI 9
<br/>
R00 - now has 10
<br/>
R01 - now has 0
<br/>
<br/>
According to documentation I found on the BIOS at ndslib, the SWI 9 call is supposed to return the remainder in R01 (see below), and should contain value 1, not zero.  I am not sure the R00 register is correct either.</td> </tr></table><span class="postbody">
<br/>
<br/>
Looking at the code in DSEmu it seems to be putting the data in R00 and R01 as expected. The x86 idiv instruction stores the remainder in EDX and the result in EAX (from <a href="http://nasm.sourceforge.net/doc/html/nasmdocb.html#section-B.4.117" target="_blank">http://nasm.sourceforge.net/doc/html/nasmdocb.html#section-B.4.117</a>). The DSEmu code does:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
                mov [arm9reg+0*4],eax
<br/>
                mov [arm9reg+1*4],edx
<br/>
</td> </tr></table><span class="postbody">
<br/>
This puts the remainder in R1 and the result in R0. This is correct I think. What is probably going wrong is that the intial register data is incorrect. DSEmu is expecting r1 to be divided by r0. Should it be the other way around? I don't have libnds handy to check how it sets it up for the call. I'll check later. The documentation you listed doesn't unfortunately list what registers should be setup for the call.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#62029 - wintermute - Sat Nov 26, 2005 5:55 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>doublec wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
This puts the remainder in R1 and the result in R0. This is correct I think. What is probably going wrong is that the intial register data is incorrect. DSEmu is expecting r1 to be divided by r0. Should it be the other way around? I don't have libnds handy to check how it sets it up for the call. I'll check later. The documentation you listed doesn't unfortunately list what registers should be setup for the call.</td> </tr></table><span class="postbody">
<br/>
<br/>
Yes, it's the other way round.
<br/>
<br/>
<a href="http://nocash.emubase.de/gbatek.htm#biosarithmeticfunctions" target="_blank">http://nocash.emubase.de/gbatek.htm#biosarithmeticfunctions</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#62041 - winneymj - Sat Nov 26, 2005 7:25 pm</h4>
    <div class="postbody"><span class="postbody">After more playing I found that if I swap the operands of the modulus and Div it works, ok.
<br/>
EXAMPLE:
<br/>
<br/>
1 % 10 gives wrong result 
<br/>
10 % 1 gives right result for 1 % 10
<br/>
<br/>
This seems to indicate the the registers used in the Modulus and Div are around the wrong way.
<br/>
Looking the the responses above seems to also indicate this. 
<br/>
The only question I have now is, is it the compiler, or DSEMU?
<br/>
<br/>
Thanks</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#62052 - wintermute - Sat Nov 26, 2005 10:42 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>winneymj wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
The only question I have now is, is it the compiler, or DSEMU?
<br/>
<br/>
Thanks</td> </tr></table><span class="postbody">
<br/>
<br/>
See the previous two messages</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#62065 - doublec - Sun Nov 27, 2005 2:48 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">The only question I have now is, is it the compiler, or DSEMU? </td> </tr></table><span class="postbody">
<br/>
<br/>
Definitely DSEmu. I've fixed it and am pushing a patch through to the darcs repository now. If you are able to build from source this will fix it. If not let me know and I'll do a quick bug fix build.
<br/>
<br/>
Darcs repository details here:
<br/>
<br/>
<a href="http://www.double.co.nz/nintendo_ds/dsemu.html#source" target="_blank">http://www.double.co.nz/nintendo_ds/dsemu.html#source</a>
<br/>
<br/>
Chris.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#62125 - winneymj - Sun Nov 27, 2005 5:36 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Definitely DSEmu. I've fixed it and am pushing a patch through to the darcs repository now. If you are able to build from source this will fix it. If not let me know and I'll do a quick bug fix build. </td> </tr></table><span class="postbody">
<br/>
Thanks for the help with the modulus problem.  The response is great.
<br/>
I have not been building from the source, so would appreciate a quick bug fix build.  I do not want you to do this if it takes too much work, as I have a simple work around, swapping the operands, until you do a more formal release.  I leave it up to you.  If you think it warants a release go ahead.
<br/>
And thanks once again for the quick response.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
