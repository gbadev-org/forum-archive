<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>gba_nds_lib and non-ascii long file name - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>DS development > gba_nds_lib and non-ascii long file name</h2>
<div id="posts">
<div class="post">
    <h4>#108515 - sectionboy - Thu Nov 09, 2006 8:34 pm</h4>
    <div class="postbody"><span class="postbody">HI, I need some help with gba_nds_lib and non-ascii long filename.  Basicly, the lib works find with Chinese character names if I fread/fwrite it using its short name. But when I want to get the long name, the lib returns some strange chars.  It works flawlessly with ascii filename, long or short. Does someone have any idea?
<br/>
<br/>
PS: Chinese chars are nothing but chars greater than 128 (thus non-ascii), and two chars to represent one Chinese character.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#108517 - tepples - Thu Nov 09, 2006 8:48 pm</h4>
    <div class="postbody"><span class="postbody">Are the characters encoded in UTF-8 encoding?<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#108541 - sectionboy - Thu Nov 09, 2006 11:36 pm</h4>
    <div class="postbody"><span class="postbody">Yes, you are right. Thanks!  But... seems it only return the lower byte of the 2-byte UTF8 code :(</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#108551 - chishm - Fri Nov 10, 2006 12:49 am</h4>
    <div class="postbody"><span class="postbody">gba_nds_fat is deliberately limited to 8 bits per character, despite VFAT's 16 bits per character. This is to remain compatible with the char-based strings used by the standard file functions (fopen, chdir, etc.).<br/>_________________<br/><a class="postlink" href="http://chishm.drunkencoders.com" target="_blank">http://chishm.drunkencoders.com</a>
<br/>
<a class="postlink" href="http://dldi.drunkencoders.com" target="_blank">http://dldi.drunkencoders.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#108572 - sectionboy - Fri Nov 10, 2006 4:05 am</h4>
    <div class="postbody"><span class="postbody">Thank you for clearing that for me.  Will you add 2-byte charachter support in new libfat?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#108588 - chishm - Fri Nov 10, 2006 8:47 am</h4>
    <div class="postbody"><span class="postbody">Most likely not, as I am even more restricted in the interfaces that I can provide.<br/>_________________<br/><a class="postlink" href="http://chishm.drunkencoders.com" target="_blank">http://chishm.drunkencoders.com</a>
<br/>
<a class="postlink" href="http://dldi.drunkencoders.com" target="_blank">http://dldi.drunkencoders.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#108624 - Dwedit - Fri Nov 10, 2006 4:35 pm</h4>
    <div class="postbody"><span class="postbody">I've just rewritten many pieces of the library to try to support wide characters, but I haven't tested it, or even compiled it yet.  It will probably spit out tons of compiler errors, and may have bugs.  Want a copy?
<br/>
<br/>
Note that short file names are still ascii only, only long names get unicode.  So don't call the functions that operate on short file names. (Why do those functions even exist anyway?)<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#108627 - sectionboy - Fri Nov 10, 2006 6:00 pm</h4>
    <div class="postbody"><span class="postbody">Thank you all!
<br/>
@chishm: What a pitty. Is there any practical reason you don't wanna do that?
<br/>
@Dwedit: Thank you again for your kind sharing. But I don't have any knowledge about FAT format/ flash memory, I am just using your guys' wonderful works, and enjoy programming my puppy book reader.  
<br/>
<br/>
Keep up the good works!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#108656 - chishm - Sat Nov 11, 2006 12:34 am</h4>
    <div class="postbody"><span class="postbody">Dwedit:
<br/>
Are you talking about functions exported from gba_nds_fat that operate only on short filenames, specifically FindFirstFile and FindNextFile? That's because they only needed a 13 character buffer to hold the output filename, which will uniquely identify the file. All functions in libfat operate on the long filename if it exists.
<br/>
<br/>
sectionboy:
<br/>
I am no longer maintaining gba_nds_fat. libfat is restricted to the interfaces provided by libc in DevkitPro, which all use 8 bit character strings.<br/>_________________<br/><a class="postlink" href="http://chishm.drunkencoders.com" target="_blank">http://chishm.drunkencoders.com</a>
<br/>
<a class="postlink" href="http://dldi.drunkencoders.com" target="_blank">http://dldi.drunkencoders.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#108668 - tepples - Sat Nov 11, 2006 3:47 am</h4>
    <div class="postbody"><span class="postbody">Is not a UTF-8 encoded string an "8-bit string"? Or which part of the C standard would this violate?<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#108683 - chishm - Sat Nov 11, 2006 6:05 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tepples wrote:</b></span></td> </tr> <tr> <td class="quote">Is not a UTF-8 encoded string an "8-bit string"? Or which part of the C standard would this violate?</td> </tr></table><span class="postbody">
<br/>
None, I suppose. I must admit, I am not overly knowledgable about locales in POSIX/C. If you can tell me how to convert the 16-bit Unicode characters in a long filename to a UTF-8 encoded string (and back again) using standard functions provided in libc or other parts of DevkitPro, I may add an option for  UTF-8 encoded Unicode string support. This will, however, double the space required to internally store a path and triple the needed string buffer length needed for strings passed to/from external functions.<br/>_________________<br/><a class="postlink" href="http://chishm.drunkencoders.com" target="_blank">http://chishm.drunkencoders.com</a>
<br/>
<a class="postlink" href="http://dldi.drunkencoders.com" target="_blank">http://dldi.drunkencoders.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#108731 - tepples - Sat Nov 11, 2006 6:25 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>chishm wrote:</b></span></td> </tr> <tr> <td class="quote">If you can tell me how to convert the 16-bit Unicode characters in a long filename to a UTF-8 encoded string (and back again) using standard functions provided in libc or other parts of DevkitPro</td> </tr></table><span class="postbody">
<br/>
It's not too hard to write your own UTF-8 encoding functions. However, you will need to watch out for "surrogates", or UTF-16 code words in 0xD800 through 0xD8FF, and convert those to single code points before converting them to UTF-8. Permissively licensed for reading and writing UTF-8 strings can be found in the <a class="postlink" href="http://alleg.sf.net/" target="_blank">Allegro library</a> or in <a class="postlink" href="ftp://www.unicode.org/Public/PROGRAMS/CVTUTF/" target="_blank">Unicode.org's examples</a>.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">I may add an option for  UTF-8 encoded Unicode string support. This will, however, double the space required to internally store a path</td> </tr></table><span class="postbody">
<br/>
Isn't the space used to store the nickname in the DS firmware doubled as well?<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#108770 - chishm - Sun Nov 12, 2006 12:19 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tepples wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">I may add an option for  UTF-8 encoded Unicode string support. This will, however, double the space required to internally store a path</td> </tr></table><span class="postbody">
<br/>
Isn't the space used to store the nickname in the DS firmware doubled as well?</span></td> </tr></table><span class="postbody">
<br/>
Yes, but a firmware nickname is 13 characters long, versus 256 characters for a long filename.<br/>_________________<br/><a class="postlink" href="http://chishm.drunkencoders.com" target="_blank">http://chishm.drunkencoders.com</a>
<br/>
<a class="postlink" href="http://dldi.drunkencoders.com" target="_blank">http://dldi.drunkencoders.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#108776 - Lick - Sun Nov 12, 2006 12:49 am</h4>
    <div class="postbody"><span class="postbody">O gee.. 512 BYTES!
<br/>
<br/>
[/stupid comment] =P<br/>_________________<br/><a class="postlink" href="http://licklick.wordpress.com" target="_blank">http://licklick.wordpress.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#108826 - chishm - Sun Nov 12, 2006 6:39 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Lick wrote:</b></span></td> </tr> <tr> <td class="quote">O gee.. 512 BYTES!
<br/>
<br/>
[/stupid comment] =P</td> </tr></table><span class="postbody">
<br/>
Multiplied by however many directory entries are needed to parse the paths supplied to a function (up to 4 directory entries total, if you assume 2 paths to a function and 1 directory entry each for iterating the path and returning the found file). This is all placed on the 16KB of stack space given to the ARM9. So that's 13% of the stack used simply for storing filenames in a library function called by the user's code.
<br/>
<br/>
I've seen many people (including myself) have bugs appear due to stack overflows, and they aren't easy to trace (without a good debugger). I'm trying not to contribute to that problem. 
<br/>
<br/>
I may end up having to malloc the space required instead.<br/>_________________<br/><a class="postlink" href="http://chishm.drunkencoders.com" target="_blank">http://chishm.drunkencoders.com</a>
<br/>
<a class="postlink" href="http://dldi.drunkencoders.com" target="_blank">http://dldi.drunkencoders.com</a></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
