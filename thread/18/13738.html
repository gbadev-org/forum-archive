<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Enabling data caching on gba slot does sweet nothing - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > Enabling data caching on gba slot does sweet nothing</h2>
<div id="posts">
<div class="post">
    <h4>#135294 - simonjhall - Sat Jul 21, 2007 11:41 pm</h4>
    <div class="postbody"><span class="postbody">Hi guys,
<br/>
<br/>
I've been trying to improve performance by enabling data caching for slot-2 RAM...but I've been having no luck.
<br/>
<br/>
After looking through ds/ds_arm9_crt0.s I can see that the gba slot is set up as protection region three with this:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">   @-------------------------------------------------------------------------
<br/>
   @ Region 3 - DS Accessory (GBA Cart)
<br/>
   @-------------------------------------------------------------------------
<br/>
   ldr   r0,=( PAGE_128M | 0x08000000 | 1)   
<br/>
   mcr   p15, 0, r0, c6, c3, 0</td> </tr></table><span class="postbody">
<br/>
After looking again at that file, gbatek and the ARM reference manual I ought to be able to turn on data caching for that region with just
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">ldr   r0,=0b00001110
<br/>
mcr   p15, 0, r0, c3, c0, 0</td> </tr></table><span class="postbody">but this does nothing for performance. In fact I think it may actually make it very slightly worse...
<br/>
<br/>
In sure I'm limited by the performance of that memory, as the game has taken a turn for the worse since moving wholly to slot-2 memory. Plus, if I just decrease the memory wait states performance increases by 25%.
<br/>
<br/>
Any hints as to what I'm doing wrong?
<br/>
<br/>
<span style="font-weight: bold">[Clarified subject. FA means "fantastic attack", or an attempt to make all steps with perfect timing, in the In The Groove community. -- MOD]</span><br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#135298 - Lick - Sat Jul 21, 2007 11:58 pm</h4>
    <div class="postbody"><span class="postbody">I wouldn't recommend decreasing the wait states. EZ's fail when you do that and access RAM -&gt; FAT -&gt; RAM -&gt; etc.
<br/>
<br/>
I really hate myself for deleting the code I had. It was working, and the performance equaled cached main ram!<br/>_________________<br/><a class="postlink" href="http://licklick.wordpress.com" target="_blank">http://licklick.wordpress.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#135350 - simonjhall - Sun Jul 22, 2007 5:44 pm</h4>
    <div class="postbody"><span class="postbody">Yeah, what was the failing EZ thing you were talking about before? Decreasing the wait states on my EZ 3-in-1 seems to work fine (although my SC won't handle any changes at all).
<br/>
Also since the 3-in-1 has no FAT support for the slot-2 part of the solution, I should never have to lock/unlock except when I start the game.
<br/>
But obviously just cos it works on my card, doesn't mean it'll function on anyone else's! I'm wondering about exposing the controls to adjust the wait states (as it really does boost performance) but I don't want angry mails from people telling me their card is fuxored.
<br/>
<br/>
So, does anyone actually know about enabling caching? I think it'll make the world of difference to performance!<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#135353 - Lick - Sun Jul 22, 2007 6:09 pm</h4>
    <div class="postbody"><span class="postbody">I have an EZ Lite 4 Deluxe and lowered waitstates crash it. 
<br/>
Maybe you could talk to WinterMute..?<br/>_________________<br/><a class="postlink" href="http://licklick.wordpress.com" target="_blank">http://licklick.wordpress.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#135360 - wintermute - Sun Jul 22, 2007 7:07 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>simonjhall wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
<br/>
After looking through ds/ds_arm9_crt0.s I can see that the gba slot is set up as protection region three with this:
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">   @-------------------------------------------------------------------------
<br/>
   @ Region 3 - DS Accessory (GBA Cart)
<br/>
   @-------------------------------------------------------------------------
<br/>
   ldr   r0,=( PAGE_128M | 0x08000000 | 1)   
<br/>
   mcr   p15, 0, r0, c6, c3, 0</td> </tr></table><span class="postbody">
<br/>
After looking again at that file, gbatek and the ARM reference manual I ought to be able to turn on data caching for that region with just
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">ldr   r0,=0b00001110
<br/>
mcr   p15, 0, r0, c3, c0, 0</td> </tr></table><span class="postbody">but this does nothing for performance. In fact I think it may actually make it very slightly worse...
<br/>
<br/>
</span></td> </tr></table><span class="postbody">
<br/>
<br/>
That's the write buffer, not the cache. Not entirely sure how you missed the cache setting if you were reading the arm9 crt0 source :P
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
   @-------------------------------------------------------------------------
<br/>
   @ DCache &amp; ICache enable
<br/>
   @-------------------------------------------------------------------------
<br/>
   ldr   r0,=0b01000010
<br/>
   mcr   p15, 0, r0, c2, c0, 0
<br/>
   mcr   p15, 0, r0, c2, c0, 1
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
the last opcode sets the cache type - 0 for data, 1 for instruction. Set bit 3 to enable caching for region 3.<br/>_________________<br/><a class="postlink" href="http://www.devkitpro.org/" target="_blank">devkitPro - professional toolchains at amateur prices</a>
<br/>
<a class="postlink" href="http://wiki.devkitpro.org/index.php/IRC" target="_blank">devkitPro IRC support</a>
<br/>
<a class="postlink" href="http://davejmurphy.com/" target="_blank">Personal Blog</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#135362 - simonjhall - Sun Jul 22, 2007 7:41 pm</h4>
    <div class="postbody"><span class="postbody">Oops forgot to mention that I'd tried that too! For some reason I posted the write buffer stuff instead...
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">__asm__ __volatile__ (
<br/>
      "ldr   r0,=0b01001010\n"
<br/>
      "mcr   p15, 0, r0, c2, c0, 0\n");</td> </tr></table><span class="postbody">...was the magic code I used.
<br/>
Also, does using the write buffer improve improve performance? Again, doesn't seem to do a lot for me.
<br/>
<br/>
Maybe my data's too random to cache well...<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
