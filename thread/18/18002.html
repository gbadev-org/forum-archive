<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>NDSBios-Function: CpuFastSet-Bug - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>DS development > NDSBios-Function: CpuFastSet-Bug</h2>
<div id="posts">
<div class="post">
    <h4>#178206 - Jim - Sun Jul 27, 2014 5:16 am</h4>
    <div class="postbody">Hi,<br/>
<br/>
I wondered what the reason for the bug in the Bios-Function "CpuFastSet" of the NDS was (<a class="postlink" href="http://problemkaputt.de/gbatek.htm#biosmemorycopy">Description in GBATEK</a>). Now that I have the NDS9-Bios disassembled I finally found the answer and wanted to share it here.<br/>
Maybe with the result that some people use a corrected version in the future.<br/>
<br/>
Here is the Code. It can be found in NDS9-Bios on address 0x940.
<div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>CpuFastSet&amp;#58;
b940&amp;#58;
		stmdb	sp!, &amp;#123;r4, r5, r6, r7, r8, r9, r10, lr&amp;#125;
		mov		r10, r2, lsl #11
		add		lr, r1, r10, lsr #9
		mov		r10, r10, lsr #14
		add		r10, r1, r10, lsl #3

		movs	r2, r2, lsr #25	@ Test if Bit 24 is set &amp;#40;fixed source address&amp;#41;
		bcc		b998
		ldr		r2, &amp;#91;r0&amp;#93;		@ Copy from fixed source
		mov		r3, r2
		mov		r4, r2
		mov		r5, r2
		mov		r6, r2
		mov		r7, r2
		mov		r8, r2
		mov		r9, r2
b97C&amp;#58;
		cmp		r1, r10
		stmltia	r1!, &amp;#123;r2, r3, r4, r5, r6, r7, r8, r9&amp;#125;
		blt		b97C
b988&amp;#58;							@ copy the rest
		cmp	r1, lr
		stmltia	r1!, &amp;#123;r2&amp;#125;
		blt		b988
		b		b9B8
b998&amp;#58;							@ Copy from a not fixed source
		cmp	r1, r10
		ldmltia	r0!, &amp;#123;r2, r3, r4, r5, r6, r7, r8, r9&amp;#125;
		stmltia	r1!, &amp;#123;r2, r3, r4, r5, r6, r7, r8, r9&amp;#125;
		blt		b998
b9A8&amp;#58; 							@ copy the rest
		cmp	r1, lr
		ldmltia	r0!, &amp;#123;r2&amp;#125;
		stmltia	r1!, &amp;#123;r2&amp;#125;
		blt	b9A8
b9B8&amp;#58;
		ldmia	sp!, &amp;#123;r4, r5, r6, r7, r8, r9, r10, lr&amp;#125;
		bx	lr
</code></pre></div>

The important part is the first 5 lines, or more correctly the 2nd - 5th line.<br/>
r10 and lr are calculated to have the end addresses were the memory has to be copied. lr is a multiple of 4 and r10 is a multiple of 32 (or should be).<br/>
<br/>
Here is an example of these 4 lines:<br/>
r1 is just the destination address to add the offset to<br/>
r2 is the length or number of words to copy<br/>
lr is the right end address of the destination<br/>
r10 should be the right end address that is divisable by 32
<div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>@ r2 = 81

@ r10 = 81 &lt;&lt; 11
@ lr = r1 + r10 = r1 + &amp;#40;81 &lt;&lt; 11&amp;#41; &gt;&gt; 9 = r1 + 81 &lt;&lt; 2 = r1 + 81*4 = r1 + 324
@ r10 = &amp;#40;r10 &gt;&gt; 14&amp;#41; = &amp;#40;81 &lt;&lt; 11&amp;#41; &gt;&gt; 14 = 81 &gt;&gt; 3 = 10
@ r10 = r1 + &amp;#40;r10 &lt;&lt; 3&amp;#41; = r1 + 10 &lt;&lt; 3 = r1 + 80</code></pre></div>

r10 is r1 + 80 instead of r1 + 320 as it should be.<br/>
<br/>
So the correct calculation at the last line should be a shift to the left by 5 not only 3 (that's the reason why only a quarter of the bytes is copied the fast way):
<div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>@ r10 = r1 + &amp;#40;r10 &lt;&lt; 5&amp;#41; = r1 + 10 &lt;&lt; 5 = r1 + 10 &lt;&lt; 5 = r1 + 320

or in ASM
		add		r10, r1, r10, lsl #3</code></pre></div>

So that's just what I found out, in the end it wasn't much but at least I know the reason now. Hope that is also interesting for someone else.</div>    
</div>
</div>

    </body>
</html>
