<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>fifo breaking wifi? - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > fifo breaking wifi?</h2>
<div id="posts">
<div class="post">
    <h4>#168474 - Toaster Mage - Thu Apr 30, 2009 1:53 am</h4>
    <div class="postbody"><span class="postbody">When I try and use wifi with the following code, it just sits on Wifi_InitDefault till it fails, but when I comment out the other fifo handling code the wifi works as expected.
<br/>
I have spent the last few days trying things to see if I can find what the problem is. I failed horribly so here I am.
<br/>
<br/>
arm7/main.c:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#include &lt;nds.h&gt;
<br/>
#include &lt;dswifi7.h&gt;
<br/>
<br/>
#include "as_lib7.h"
<br/>
#include "../common/fifo.h"
<br/>
<br/>
<br/>
u8 isOldDS = 0;
<br/>
u8 backlight = 1;
<br/>
<br/>
void vCountHandler() {
<br/>
    u16 pressed = REG_KEYXY;
<br/>
<br/>
    inputGetAndSend();
<br/>
<br/>
    //Sleep mode
<br/>
    if (pressed &amp; BIT(7)) {
<br/>
        systemSleep();
<br/>
    }
<br/>
}
<br/>
<br/>
void vBlankHandler() {
<br/>
    AS_SoundVBL();
<br/>
    Wifi_Update();
<br/>
}
<br/>
<br/>
int main(int argc, char** argv) {
<br/>
    irqInit();
<br/>
    fifoInit();
<br/>
    
<br/>
    readUserSettings();
<br/>
    initClockIRQ();
<br/>
    SetYtrigger(80);
<br/>
<br/>
    //Setup FIFO
<br/>
    installWifiFIFO();
<br/>
    installSystemFIFO();
<br/>
<br/>
    //installSoundFIFO();
<br/>
    //mmInstall(FIFO_MAXMOD);
<br/>
<br/>
    //Setup IRQ
<br/>
    irqSet(IRQ_VCOUNT, vCountHandler);
<br/>
    irqSet(IRQ_VBLANK, vBlankHandler);
<br/>
    irqEnable(IRQ_VBLANK | IRQ_VCOUNT | IRQ_NETWORK);
<br/>
<br/>
    //Send backlight state
<br/>
    isOldDS = !(readPowerManagement(4) &amp; BIT(6));
<br/>
    backlight = isOldDS ? 3 : readPowerManagement(4);
<br/>
    fifoSendValue32(TCOMMON_FIFO_CHANNEL_ARM9, MSG_TOGGLE_BACKLIGHT);
<br/>
    fifoSendValue32(TCOMMON_FIFO_CHANNEL_ARM9, backlight);
<br/>
<br/>
    //Enable sound
<br/>
    REG_SOUNDCNT = SOUND_ENABLE | SOUND_VOL(0x7F);
<br/>
<br/>
    do {
<br/>
        if (fifoCheckValue32(TCOMMON_FIFO_CHANNEL_ARM7)) {
<br/>
            u32 value = fifoGetValue32(TCOMMON_FIFO_CHANNEL_ARM7);
<br/>
<br/>
            // ==== comment from here ====
<br/>
            switch (value) {
<br/>
            case MSG_TOGGLE_BACKLIGHT:
<br/>
                if (isOldDS) {
<br/>
                    u32 power = readPowerManagement(PM_CONTROL_REG) &amp; ~(PM_BACKLIGHT_TOP|PM_BACKLIGHT_BOTTOM);
<br/>
                    if (backlight) {
<br/>
                        backlight = 0;
<br/>
                    } else {
<br/>
                        backlight = 3;
<br/>
                        power = power | PM_BACKLIGHT_TOP | PM_BACKLIGHT_BOTTOM;
<br/>
                    }
<br/>
                    writePowerManagement(PM_CONTROL_REG, power);
<br/>
                } else {
<br/>
                    backlight = ((backlight+1) &amp; 0x3); //b should be in range 0..3
<br/>
                    writePowerManagement(4, backlight);
<br/>
                }
<br/>
                fifoSendValue32(TCOMMON_FIFO_CHANNEL_ARM9, MSG_TOGGLE_BACKLIGHT);
<br/>
                fifoSendValue32(TCOMMON_FIFO_CHANNEL_ARM9, backlight);
<br/>
                break;
<br/>
            case MSG_INIT_SOUND_ARM7:
<br/>
                while (!fifoCheckValue32(TCOMMON_FIFO_CHANNEL_ARM7));
<br/>
                int v = fifoGetValue32(TCOMMON_FIFO_CHANNEL_ARM7);
<br/>
                AS_Init((IPC_SoundSystem*)v);
<br/>
                break;
<br/>
            }
<br/>
            // ==== down to here ====
<br/>
        }
<br/>
<br/>
        swiWaitForVBlank();
<br/>
        AS_MP3Engine();
<br/>
    } while(1);
<br/>
}
<br/>
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
<br/>
I have also noticed just having the relevant code in the program breaks it, even if it isn`t called.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#168477 - elhobbs - Thu Apr 30, 2009 3:05 am</h4>
    <div class="postbody"><span class="postbody">why are you constantly polling for fifo messages? is there a reason you do not want to setup a handler to be called on fifo interrupts?
<br/>
<br/>
fifoSetValue32Handler or fifoSetDatamsgHandler depending on the data being sent.
<br/>
<br/>
however, I think this might point to an issue that I have been experiencing with fifo and wifi myself. I think that the fifo code does not properly disable and enable interrupts. the fifo sets IME to 0 to disable interrupts then sets it 1 when it is done. the wifi code saves IME then sets it 0 to disable interrupts. dswifi then restores the saved value when it is done. I think the fifo code can enable interrupts when dswifi has it enabled. particulary when the syncfunction is called in dswifi while interrupts are disabled.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#168490 - AxemRed - Thu Apr 30, 2009 8:07 pm</h4>
    <div class="postbody"><span class="postbody">You're probably running out of memory on the ARM7. TouhouDS uses the same ARM7 code, but with SHRINK_AS_LIB enabled and SUPPORT_BACKLIGHT disabled.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
