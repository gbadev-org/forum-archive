<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>program randomly freezes - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>DS development > program randomly freezes</h2>
<div id="posts">
<div class="post">
    <h4>#169721 - vuurrobin - Fri Jul 31, 2009 3:55 pm</h4>
    <div class="postbody"><span class="postbody">hello everybody
<br/>
<br/>
I have a program that somehow freezes and I can't figure out why. the program displays some explosions on the screen by creating some ExposionSprite objects and calling its update function. if I put the objects on the stack (either sepparate or in an array), it works. if I use new or malloc+placement new, it works. if I use my AllocRawMem (which just calls malloc) and manually call placement new, it works. 
<br/>
if I use my AllocMem (which calls AllocRawMem and placement new), it freezes. if I use my LiteVector or std::vector, it freezes.
<br/>
<br/>
it always freezes during the update function, but the problem can't be in there or else it would freeze all the time. I also doubt it is my memory functions or LiteVector, seeing as std::vector doesn't uses those functions, and I asume std::vector doesn't have bugs. 
<br/>
<br/>
I tried the program on no$gba and on my original ds, and they both freezes. sometimes it freezes after about 30 iterations/vblanks and sometimes after 2 or 3 vblanks. but it always freezes within a second. 
<br/>
<br/>
I've kinda run out of options to try, so I hope that someone has any idea what could go wrong, or is willing to run the program in his debugger to see what the program is doing. 
<br/>
<br/>
here is the program:
<br/>
<br/>
<a href="http://www.megaupload.com/?d=VWZNM110" target="_blank">http://www.megaupload.com/?d=VWZNM110</a>
<br/>
<br/>
edit: if anybody wants to see the code, just say so and I'll post what you need.
<br/>
<br/>
<br/>
can somebody please help me?
<br/>
<br/>
vuurrobin</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#169722 - sgeos - Fri Jul 31, 2009 5:50 pm</h4>
    <div class="postbody"><span class="postbody">A memory leak, perhaps?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#169725 - vuurrobin - Fri Jul 31, 2009 7:00 pm</h4>
    <div class="postbody"><span class="postbody">I'm not allocating or releasing anything in the loop, and using the functions I found here:
<br/>
<a href="http://forum.gbadev.org/viewtopic.php?t=14438&amp;highlight=getmemfree" target="_blank">http://forum.gbadev.org/viewtopic.php?t=14438&amp;highlight=getmemfree</a>
<br/>
<br/>
I can see that the free memory (the number returned by getMemFree()) stays consistent (at 3824072). so I don't think that its a memory leak.
<br/>
<br/>
could this have something to do with static/global data? or the cache messing something up? I assume that there isn't anything wrong with the standard c rand() function, right?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#169726 - sgeos - Fri Jul 31, 2009 7:15 pm</h4>
    <div class="postbody"><span class="postbody">Clearly something isn't being done right, and it could be anything.  rand() shouldn't be a problem, but you might be doing something silly with the result.
<br/>
<br/>
My advice is sleep on it and go through your code tommorow, slowly and carefully.  Look for off by one errors.  The bug is probably in some code you assume is solid and are not focusing on.
<br/>
<br/>
<span style="font-weight: bold">EDIT:</span> You have all compiler warnings enabled, right?  The gcc option for that is <span style="font-weight: bold">-Wall</span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#169743 - Cearn - Sat Aug 01, 2009 8:58 am</h4>
    <div class="postbody"><span class="postbody">no$gba seems to get stuck at the loop at 0200:3188, which I think is part of the function starting(?) at 0200:3144. It calls 0200:30CC a lot, so that one may have something to do with it as well.
<br/>
<br/>
If you could provide the functions at those locations and the structs they use, that might be helpful. The template makefiles should produce a mapfile where you can find the names of the functions at those addresses.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#169744 - vuurrobin - Sat Aug 01, 2009 1:47 pm</h4>
    <div class="postbody"><span class="postbody">I looked at the map file, and searching for those adresses didn't gave me any results. after looking for it myself, I could find the following block:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">.text          0x02002db0      0x47c c:/programs/devkitPro/libnds/lib\libnds9.a(sprite.o)
<br/>
                0x02002db0                oamDisable
<br/>
                0x02002e44                oamClear
<br/>
                0x0200305c                oamRotateScale
<br/>
                0x02002e10                oamGetGfxPtr
<br/>
                0x02002de0                oamEnable
<br/>
                0x02002e6c                oamGfxPtrToOffset
<br/>
                0x020030bc                oamUpdate
<br/>
                0x02003120                oamInit
<br/>
                0x02002e9c                oamSet
<br/>
 .text          0x0200322c      0x45c c:/programs/devkitPro/libnds/lib\libnds9.a(sprite_alloc.o)
<br/>
                0x02003258                oamCountFragments
<br/>
                0x02003444                oamAllocReset
<br/>
                0x020032a4                oamFreeGfx
<br/>
                0x02003478                oamAllocateGfx
<br/>
 .text          0x02003688       0xdc c:/programs/devkitPro/libnds/lib\libnds9.a(system.o)
<br/>
                0x02003720                systemMsgHandler
<br/>
                0x020036c8                powerOn
<br/>
                0x02003710                powerValueHandler
<br/>
                0x02003688                ledBlink
<br/>
                0x020036f8                systemSleep
<br/>
                0x0200369c                powerOff</td> </tr></table><span class="postbody">
<br/>
<br/>
but those are all from libnds. however, I did change the project a few times, so the adresses probably shifted a bit. 
<br/>
<br/>
I do know the function of where it freezes: 
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void ExplosionSprite::update()
<br/>
{
<br/>
    cout &lt;&lt; "in update" &lt;&lt; endl;
<br/>
<br/>
    if(explosionVBlankPassed == vblankPerExplosion)
<br/>
    {
<br/>
        cout &lt;&lt; "displaying" &lt;&lt; endl;
<br/>
        //the sprite is displaying an explosion
<br/>
        frameVBlanksPassed++;
<br/>
        if(frameVBlanksPassed == vblankPerFrame)
<br/>
        {
<br/>
            //time for the next frame, or wait if the explosion is over
<br/>
            register uint newFrame = (getCurrentFrame() + 1);
<br/>
            if(newFrame == MAX_FRAMES)
<br/>
            {
<br/>
                //the explosion is over, so we make the sprite invisible,
<br/>
                //and wait a number of vblanks
<br/>
                setVisible(false);
<br/>
                explosionVBlankPassed = 0;
<br/>
            }
<br/>
            else
<br/>
            {
<br/>
                //set the next frame
<br/>
                setFrame(newFrame);
<br/>
            }
<br/>
<br/>
            frameVBlanksPassed = 0;
<br/>
        }
<br/>
    }
<br/>
    else
<br/>
    {
<br/>
        cout &lt;&lt; "waiting" &lt;&lt; endl;
<br/>
        //the sprite is waiting between explosions
<br/>
        explosionVBlankPassed++;
<br/>
        if(explosionVBlankPassed == vblankPerExplosion)
<br/>
        {
<br/>
            //waiting is over, so we set the first frame, set the sprite visible
<br/>
            //and randomly set the position, frame time(number of vblanks to wait per frame)
<br/>
            //and wait time(number of vblanks to wait after the explosion finished)
<br/>
            using libOOP::randInt;
<br/>
            setFrame(0).setVisible(true);
<br/>
            setPosition(randInt(0, (SCREEN_WIDTH - getWidth())), randInt(0, (SCREEN_HEIGHT - getHeight())));
<br/>
            vblankPerFrame = randInt(5,10);
<br/>
            vblankPerExplosion = randInt(10, 60);
<br/>
            explosionVBlankPassed = vblankPerExplosion;
<br/>
        }
<br/>
    }
<br/>
<br/>
    cout &lt;&lt; "Sprite::update" &lt;&lt; endl;
<br/>
    Sprite::update();
<br/>
    cout &lt;&lt; "end Sprite::update" &lt;&lt; endl;
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
everytime it freezes, it displayed 'waiting' or 'displaying' as last (mostly waiting), but it never reaches 'Sprite::update'.
<br/>
the problem is that the function itself if fine. it works when I put the ExplosionSprite on the stack, and on the heap works on some occasions. if I change the way the object is created, the update function freezes within a second.
<br/>
<br/>
<br/>
@sgeos, yes I have all warnings turned on.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#169749 - LOst? - Sat Aug 01, 2009 10:13 pm</h4>
    <div class="postbody"><span class="postbody">vuurrobin, are explosionVBlankPassed, vblankPerExplosion, frameVBlanksPassed, vblankPerFrame declared volatile? If they are not, and they are updated inside an interrupt, undefined (random) results will follow. 
<br/>
<br/>
Also, using cout might be a bad idea? printf() is probably better. I just don't know how much cout takes as an ostream object and how buffered the output will be. printf() might buffer too, so I don't know.<br/>_________________<br/><span style="font-style: italic">Exceptions are fun</span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#169755 - elhobbs - Sun Aug 02, 2009 12:57 am</h4>
    <div class="postbody"><span class="postbody">are you usuing defaultExceptionHandler to catch exceptions like stack overflows and invalid memory accesses?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#169756 - vuurrobin - Sun Aug 02, 2009 1:32 am</h4>
    <div class="postbody"><span class="postbody">I've found and fixed the problem :D .
<br/>
<br/>
the problem was that I didn't handled passing the ownership of the vram correctly in the copy constructor. because of this, it tried to release the vram every vblank (I'm using libnds vram allocating functions). this led to either using or releasing vram that was already released, or to oam getting a NULL pointer to the graphics. fixing the copy constructor also fixed the bug. 
<br/>
<br/>
@LOst?, they aren't declared volatile, but they also aren't updated inside an interupt. 
<br/>
<br/>
and yes, cout is bloated but otherwise fine. and I find it easier to use than printf(). and seeing that it was just temporarily I chose to use it. and I'll probably create my own text routines sooner or later.
<br/>
<br/>
<br/>
@elhobbs, yes I use defaultExceptionHandler() to catch those things. it catches hardware exceptions, right?
<br/>
<br/>
<br/>
Thank you everybody for your help!!! :D</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#169766 - elhobbs - Sun Aug 02, 2009 10:19 pm</h4>
    <div class="postbody"><span class="postbody">yes, hardware exceptions.
<br/>
<br/>
libnds has a function to allocate teture memory but it does not have a function to free it - am I mistaken?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#169767 - TwentySeven - Sun Aug 02, 2009 11:06 pm</h4>
    <div class="postbody"><span class="postbody">void glResetTextures(void);</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#169768 - vuurrobin - Sun Aug 02, 2009 11:54 pm</h4>
    <div class="postbody"><span class="postbody">I don't know anything about textures, but I'm using <a class="postlink" href="http://libnds.devkitpro.org/a00100.html#d7bab0e9a12a2cada8c3dfb369b2af3a" target="_blank">oamAllocateGfx</a> and <a class="postlink" href="http://libnds.devkitpro.org/a00100.html#59fd9a8198aaa729575448ca7fa55027" target="_blank">oamFreeGfx</a> to allocate vram for my sprites.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
