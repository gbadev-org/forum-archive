<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>3D Tearing - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > 3D Tearing</h2>
<div id="posts">
<div class="post">
    <h4>#159049 - ritz - Tue Jun 24, 2008 10:48 pm</h4>
    <div class="postbody"><span class="postbody">Hi all,
<br/>
<br/>
I'm hoping for some help or ideas on a problem that I've been having with visual tearing in my 3D project. I've written a small program that reproduces the same problem that exists in my regular project. Using triangle strips, I put four squares together (i.e. floor tiles). Use the pen to rotate the view around and you'll see the tearing.
<br/>
<br/>
Screenshot of the tearing: <a class="postlink" href="http://www.daftcode.net/tear.jpg" target="_blank">tear.jpg</a>
<br/>
Rom of the tearing program: <a class="postlink" href="http://www.daftcode.net/tear.zip" target="_blank">tear.zip</a>
<br/>
Code of the tearing program: <a class="postlink" href="http://www.daftcode.net/tear.c" target="_blank">tear.c</a>
<br/>
This is my actual project: <a class="postlink" href="http://www.daftcode.net/sonic_r233.zip" target="_blank">sonic_r233.zip</a>
<br/>
<br/>
I currently believe it's related to matrix imprecision, but I'm not sure.</span><span class="gensmall"><br/><br/>Last edited by ritz on Wed Jun 25, 2008 11:20 pm; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#159051 - TwentySeven - Tue Jun 24, 2008 11:03 pm</h4>
    <div class="postbody"><span class="postbody">Yep!  It's a precision issue.   Typically it only shows up on t-junctions in geometry (where one vert sits on an edge of another polygon), but rendering a quad like you've done there by positioning it with a matrix is what the issue is.
<br/>
<br/>
This even happens on pc video cards when you try and create a flush seam like that by drawing "models" fitted together by matrixes, because theres small imprecisions in the transform that mean the final screen X and Y of what should be a shared vert isn't 100% the same.
<br/>
<br/>
Anyway, the solution is to render your quad tiles using world space coordinates for your vertexes.
<br/>
<br/>
ie:
<br/>
<br/>
DrawQuad(-2,-2,2,2);  //x1,y1,x2,y2
<br/>
DrawQuad(2,-2,4,2);
<br/>
DrawQuad(4,-2,6,2);
<br/>
<br/>
p.s. your project looks kickass!  very nice!</span><span class="gensmall"><br/><br/>Last edited by TwentySeven on Tue Jun 24, 2008 11:19 pm; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#159053 - ritz - Tue Jun 24, 2008 11:15 pm</h4>
    <div class="postbody"><span class="postbody">Thanks for the info/clarification. I see how your example would work, it makes sense.
<br/>
<br/>
However, my tiles are filled with inner geometry that can span the full 16-bit range (-8 to 7.999). Have a look at my original project I posted above and you'll see what I mean. I'm stitching them together to produce full towns/rooms/etc.
<br/>
<br/>
Is there any ideas out there as to how I could alleviate this tearing problem?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#159054 - relpats_eht - Tue Jun 24, 2008 11:18 pm</h4>
    <div class="postbody"><span class="postbody">Use triangle strips instead of quads, that should work.
<br/>
<br/>
[edit]
<br/>
Bah, didn't read, I just looked at the pictures.
<br/>
<br/>
There is really no reason for those triangle-strip-quadrangles to not share vertices. Just draw them as one, longer triangle strip.<br/>_________________<br/>- relpats_eht</span><span class="gensmall"><br/><br/>Last edited by relpats_eht on Tue Jun 24, 2008 11:20 pm; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#159055 - ritz - Tue Jun 24, 2008 11:19 pm</h4>
    <div class="postbody"><span class="postbody">I am :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#159056 - relpats_eht - Tue Jun 24, 2008 11:25 pm</h4>
    <div class="postbody"><span class="postbody">See the edit above. 
<br/>
<br/>
Also, making sure the vertices are the same by using some form of indexing wouldn't hurt.
<br/>
<br/>
I had the same problem when I wrote a geomipmapping class. I solved it by making long triangle strips and storing all vertices in one place and calling them up with indices. Also, to get as much use out of the limited range as possible, I stored the vertices as smaller values and used a matrix scale before drawing.<br/>_________________<br/>- relpats_eht</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#159057 - TwentySeven - Tue Jun 24, 2008 11:30 pm</h4>
    <div class="postbody"><span class="postbody">Aye, it really is a pickle of a situation because you'd run into the same issue on the pc, it'd just be less noticable due to the PC's higher resolution and higher precision geometry pipeline.
<br/>
<br/>
You using high frequency detail in your ground textures helps alot, for example I didn't actually notice any cracking running around your .nds.
<br/>
<br/>
However, that's not really a solution is it?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#159058 - silent_code - Tue Jun 24, 2008 11:43 pm</h4>
    <div class="postbody"><span class="postbody">Just a small hint: Your problem is not tearing (that is yet another problem that has to do with disabled vertical synchronisation - which is not present on the NDS), is is rather polygon (or better: primitive) "gaping". ;^)<br/>_________________<br/><span style="font-size: 9px; line-height: normal"><span style="text-decoration: underline"><span style="font-weight: bold"></span></span> July 5th 08: "<span style="font-weight: bold">Volumetric Shadow Demo</span>" 1.6.0 (final) source released
<br/>
June 5th 08: "<span style="font-weight: bold">Zombie NDS</span>" WIP released!
<br/>
It's all on my page, just click <span style="font-weight: bold">WWW</span> below.</span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#159060 - kusma - Wed Jun 25, 2008 12:08 am</h4>
    <div class="postbody"><span class="postbody">By carefully tailoring your matrices in fixed-point, you should be able to get completely rid of the problem. But it might be easier just to extend the geometry slightly until the problem isn't noticeable any more ;)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#159062 - DensitY - Wed Jun 25, 2008 1:18 am</h4>
    <div class="postbody"><span class="postbody">yeah looks like a precision problem, go fixed point. you can either adjust the texture coords or texture matrix so the texture is slightly larger then the quad, so any precision errors and round snapping don't result in gaps.
<br/>
<br/>
Edit:
<br/>
<br/>
of course you aren't doing strip quad rendering, so you could result in something like
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
---- ----
<br/>
|   ||    |
<br/>
---- ----
<br/>
</td> </tr></table><span class="postbody">
<br/>
    ^ vertex precision problems can result in a gap anywhere along here.
<br/>
<br/>
strip rendering would fix that up
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
--------
<br/>
|   |   |
<br/>
--------
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#159083 - ritz - Wed Jun 25, 2008 5:13 am</h4>
    <div class="postbody"><span class="postbody">Thanks for the hints and tips so far.
<br/>
<br/>
In my actual project I use indexed vertices so there's no dups or wasted space. All my models/objects are made up of multiple meshes which are all triangle stripped. The tearing/seams/gaps that I refer to only show up on the object's boundaries and not within it (basically where I stitch together each of these 'big' models/objects into their final world coords - a diff trans matrix for each). So that's why I believe that it is most likely matrix precision. I hope that makes sense :)
<br/>
<br/>
I'll try fudging with my transform matrices tomorrow and see. I dunno. I added glScalef32(4098) to some areas for fun and it helped a fair bit but still shows an unacceptable (to me) amount especially when my clear color is bright white. It's much easier to see the white bleed through that way.
<br/>
<br/>
Just to be clear, when I refer to tiles/object I'm referring to lots of geometry that could potentially fill up from -8 to 7.9 in the 16bit range. Then I put it together like a rubix cube with transform matrices. Sorta. Kinda.
<br/>
<br/>
@TwentySeven - Thanks!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#159089 - TwentySeven - Wed Jun 25, 2008 6:37 am</h4>
    <div class="postbody"><span class="postbody">Well, I think you're not going to be able to fix it without modifying your artpath some.  
<br/>
If it were me, I'd do the following:
<br/>
<br/>
* Use a more neutral clear color.  Dark greys a better choice then bright white :)
<br/>
* For the majority of your tile models, remove the "ground plane" quad from them and render the terrain that uses them as strips, or, at the very least, using worldspace coords and triangles.  It'll bugger up your art path a little bit but better to do it now then 500 tile models in..
<br/>
* For the tile models that have holes in them or arn't a clean ground plane quad (so you can't generate the mesh in software) you can either scale the model up a little bit on the x/y plane to cover the crack, or just eat it for the few tiles it occurs on.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#159091 - nce - Wed Jun 25, 2008 10:39 am</h4>
    <div class="postbody"><span class="postbody">It exist an other solution on pc...
<br/>
<br/>
extend your geometry border vertically and repeat the uv on them... 
<br/>
<br/>
( I gess that my explanation is kind of crap ^_^ so here is a paper about the chunk quadtree where I've seen that technique for the first time :
<br/>
<br/>
<a class="postlink" href="http://tulrich.com/geekstuff/chunklod.html" target="_blank">http://tulrich.com/geekstuff/chunklod.html</a>
<br/>
<br/>
the pdf is at the bottom of the page.
<br/>
Check the way he resolves the cracks between chunks )
<br/>
<br/>
I implemented this paper long time ago on pc and I was thinking about doing that on ds but it looks a little expensive for the ds but maybe the crack filling technique will suit your needs.<br/>_________________<br/>-jerome-</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#159094 - silent_code - Wed Jun 25, 2008 11:28 am</h4>
    <div class="postbody"><span class="postbody">Btw: The gaps are generated by the resterizing engine. Due to different interpolation values in different primitive setups (e.g. used vertex' positions), the boundary pixels might not align propperly. This is a sub pixel accuracy problem.<br/>_________________<br/><span style="font-size: 9px; line-height: normal"><span style="text-decoration: underline"><span style="font-weight: bold"></span></span> July 5th 08: "<span style="font-weight: bold">Volumetric Shadow Demo</span>" 1.6.0 (final) source released
<br/>
June 5th 08: "<span style="font-weight: bold">Zombie NDS</span>" WIP released!
<br/>
It's all on my page, just click <span style="font-weight: bold">WWW</span> below.</span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#159103 - elhobbs - Wed Jun 25, 2008 2:52 pm</h4>
    <div class="postbody"><span class="postbody">for me this mainly occurs when triangles intersect the view frustum and get clipped by the hardware. for some reason the same edges shared by two different triangle will be projected differently by the hardware even though they are using the exact same vertices and matrices. the effect is more noticeable closer to the viewpoint and when they are large triangles.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#159135 - ritz - Wed Jun 25, 2008 11:23 pm</h4>
    <div class="postbody"><span class="postbody">Thanks all for the info and help. I'll let you know if I figure out something suitable.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
