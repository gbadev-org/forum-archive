<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Card reading with R4 - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>DS development > Card reading with R4</h2>
<div id="posts">
<div class="post">
    <h4>#161452 - monocasa - Mon Aug 04, 2008 3:13 am</h4>
    <div class="postbody"><span class="postbody">So, I'm in the process of writing a library for reading from the embedded filesystem in .nds rom images.  But, I've ran into an issue reading on real hardware (it works on all of th emulators that I've tried).  When reading from the card (and being loaded from an R4) all I get is the same hex string (017047C2F5FFFFEA00009FE51EFF2FE1 for the first sixteen bytes at least).  All of my reads thus far are just the File Allocation Table and File Name Table, so I don't think that its an encryption issue (though I could be quite wrong).  Are there any special hoops that I have to jump through to read off an R4?  Am I even right thinking that the R4 is my problem?
<br/>
<br/>
Gratci, in advance.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161453 - tepples - Mon Aug 04, 2008 4:12 am</h4>
    <div class="postbody"><span class="postbody">Have you just tried opening the .nds file using libfat and reading the NitroFS that way?<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161457 - Dwedit - Mon Aug 04, 2008 4:32 am</h4>
    <div class="postbody"><span class="postbody">I don't think the R4 even attempts to simulate the actual DS card communication protocol beyond booting initially.  After it boots, it just uses some custom protocol to read and write sectors.<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161458 - monocasa - Mon Aug 04, 2008 4:39 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Dwedit wrote:</b></span></td> </tr> <tr> <td class="quote">I don't think the R4 even attempts to simulate the actual DS card communication protocol beyond booting initially.  After it boots, it just uses some custom protocol to read and write sectors.</td> </tr></table><span class="postbody">
<br/>
<br/>
Well, it has to do at least the stuff included in the .nds, or else commercial games wouldn't work on it (and they wouldn't be getting sued).</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161459 - monocasa - Mon Aug 04, 2008 4:55 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tepples wrote:</b></span></td> </tr> <tr> <td class="quote">Have you just tried opening the .nds file using libfat and reading the NitroFS that way?</td> </tr></table><span class="postbody">
<br/>
<br/>
Are you saying reading the .nds through libfat (and it directly reading the fat filesystem on the sd card), or does libfat have a way to read from the NitroFS directly from the currently being run?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#161465 - josath - Mon Aug 04, 2008 4:32 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>monocasa wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Dwedit wrote:</b></span></td> </tr> <tr> <td class="quote">I don't think the R4 even attempts to simulate the actual DS card communication protocol beyond booting initially.  After it boots, it just uses some custom protocol to read and write sectors.</td> </tr></table><span class="postbody">
<br/>
<br/>
Well, it has to do at least the stuff included in the .nds, or else commercial games wouldn't work on it (and they wouldn't be getting sued).</span></td> </tr></table><span class="postbody">
<br/>
<br/>
Unfortunately, they don't emulate an actual game cart. They modify the commercial games to use their custom protocol. Really the only way you can write code that will work on all flashcarts is to use libnds. (Not counting a few really old flashcarts, and a few old slot-2 GBA flashcarts)
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>monocasa wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tepples wrote:</b></span></td> </tr> <tr> <td class="quote">Have you just tried opening the .nds file using libfat and reading the NitroFS that way?</td> </tr></table><span class="postbody">
<br/>
<br/>
Are you saying reading the .nds through libfat (and it directly reading the fat filesystem on the sd card), or does libfat have a way to read from the NitroFS directly from the currently being run?</span></td> </tr></table><span class="postbody">
<br/>
<br/>
Yes, the idea is basically:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
fatInitDefault();
<br/>
FILE *nds = fopen("mygame.nds", "r");
<br/>
// read NDS header
<br/>
// fseek to nitroFS start
<br/>
// read needed data from nitroFS
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
One issue is finding mygame.nds in the first place. EFS does some crazy hacks to automatically find it, that work in most cases and is not terribly inefficient. There is "argv support" coming Real Soon Now(TM) to libnds/devkitarm, with the downside that this code will also need to be added to the various homebrew loaders.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
