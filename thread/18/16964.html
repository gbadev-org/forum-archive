<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>undefined reference to `__aeabi_ldivmod etc. - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>DS development > undefined reference to `__aeabi_ldivmod etc.</h2>
<div id="posts">
<div class="post">
    <h4>#171335 - Tommmie - Fri Nov 13, 2009 9:44 pm</h4>
    <div class="postbody"><span class="postbody">Hey everyone, 
<br/>
<br/>
when I tried to compile Position Independent code I got these undefined references:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">undefined reference to `__aeabi_ldivmod'
<br/>
undefined reference to `__errno'
<br/>
undefined reference to `__aeabi_idiv'</td> </tr></table><span class="postbody">
<br/>
<br/>
what's the solution for a proper compilation?
<br/>
<br/>
regards,
<br/>
<br/>
Tomdev
<br/>
<br/>
<span style="font-weight: bold">edit</span> adding -lgcc seems to solve this erros but I still have errors like this:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">undefined reference to `__ctype_ptr__?</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#171351 - hacker013 - Sun Nov 15, 2009 5:32 pm</h4>
    <div class="postbody"><span class="postbody">remove -nostdlib from the makefile and everything will work again :')<br/>_________________<br/><a class="postlink" href="http://imetal.nl/" target="_blank">Website / Blog</a>
<br/>
<br/>
Let the nds be with you.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#171354 - Tommmie - Sun Nov 15, 2009 7:02 pm</h4>
    <div class="postbody"><span class="postbody">that let my nds crash, also Wintermute says that fPIC + code out of the standard lib is not stable. So the only solution is to not use code out of the standard lib:(</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#171356 - elhobbs - Mon Nov 16, 2009 2:31 am</h4>
    <div class="postbody"><span class="postbody">Why do you want position independent code anyway? Just curious...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#171363 - Tommmie - Mon Nov 16, 2009 7:31 am</h4>
    <div class="postbody"><span class="postbody">For a plugin(I'm working with a pluginloader which works but not with this one)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#171366 - elhobbs - Mon Nov 16, 2009 10:28 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Tommmie wrote:</b></span></td> </tr> <tr> <td class="quote">For a plugin(I'm working with a pluginloader which works but not with this one)</td> </tr></table><span class="postbody">I understand the plugin part, but the rest does not make sense to me. 
<br/>
<br/>
In any case one approach is to import all of the stdlib funtions into the plugin. You could build a struct with pointers to functions like malloc and free and printf, etc. and pass it to the plugin when it is loaded. Keep on mind that debugging relocated code is really difficult.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#171370 - Tommmie - Mon Nov 16, 2009 4:15 pm</h4>
    <div class="postbody"><span class="postbody">Ok to be clear: I want to compile tremor so that I have a plugin which can decode ogg files. I already have a file called "defines.h" which contains the following:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#define malloc x-&gt;xmalloc
<br/>
#define free x-&gt;xfree
<br/>
#define calloc x-&gt;xcalloc
<br/>
#define realloc x-&gt;xrealloc
<br/>
#define fgetc std-&gt;fgetc
<br/>
#define fopen std-&gt;fopen
<br/>
#define fread std-&gt;fread
<br/>
#define fclose std-&gt;fclose
<br/>
#define fseek std-&gt;fseek
<br/>
#define ftell std-&gt;ftell
<br/>
#define fwrite std-&gt;fwrite
<br/>
#define memset std-&gt;memset
<br/>
#undef memcpy
<br/>
#define memcpy std-&gt;memcpy
<br/>
#define memcmp std-&gt;memcmp
<br/>
#define memchr std-&gt;memchr
<br/>
#define sprintf std-&gt;sprintf
<br/>
#define fprintf std-&gt;fprintf
<br/>
#define vprintf std-&gt;vprintf
<br/>
#define iprintf std-&gt;iprintf
<br/>
#define strcpy std-&gt;strcpy
<br/>
#define strlen std-&gt;strlen
<br/>
#define strchr std-&gt;strchr
<br/>
#define strstr std-&gt;strstr
<br/>
#define strcat std-&gt;strcat</td> </tr></table><span class="postbody">
<br/>
<br/>
i replace &lt;stdio.h&gt; and &lt;stdlib.h&gt; in the tremor source files with "defines.h". So the files do not use code out of these files. But the problem is, when I've done this I still get this error: 
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">d:/dsi/devkitpro/devkitarm/bin/../lib/gcc/arm-eabi/4.4.0/../../../../arm-eabi/li
<br/>
b\libc.a(lib_a-abort.o): In function `abort':
<br/>
(.text+0xc): undefined reference to `_exit'
<br/>
d:/dsi/devkitpro/devkitarm/bin/../lib/gcc/arm-eabi/4.4.0/../../../../arm-eabi/li
<br/>
b\libc.a(lib_a-signal.o): In function `_raise_r':
<br/>
(.text+0x7c): undefined reference to `_getpid_r'
<br/>
d:/dsi/devkitpro/devkitarm/bin/../lib/gcc/arm-eabi/4.4.0/../../../../arm-eabi/li
<br/>
b\libc.a(lib_a-signal.o): In function `_raise_r':
<br/>
(.text+0x8c): undefined reference to `_kill_r'
<br/>
d:/dsi/devkitpro/devkitarm/bin/../lib/gcc/arm-eabi/4.4.0/../../../../arm-eabi/li
<br/>
b\libc.a(lib_a-mallocr.o): In function `_malloc_r':
<br/>
(.text+0x400): undefined reference to `_sbrk_r'
<br/>
d:/dsi/devkitpro/devkitarm/bin/../lib/gcc/arm-eabi/4.4.0/../../../../arm-eabi/li
<br/>
b\libc.a(lib_a-mallocr.o): In function `_malloc_r':
<br/>
(.text+0x47c): undefined reference to `_sbrk_r'
<br/>
d:/dsi/devkitpro/devkitarm/bin/../lib/gcc/arm-eabi/4.4.0/../../../../arm-eabi/li
<br/>
b\libc.a(lib_a-freer.o): In function `_malloc_trim_r':
<br/>
(.text+0x48): undefined reference to `_sbrk_r'
<br/>
d:/dsi/devkitpro/devkitarm/bin/../lib/gcc/arm-eabi/4.4.0/../../../../arm-eabi/li
<br/>
b\libc.a(lib_a-freer.o): In function `_malloc_trim_r':
<br/>
(.text+0x78): undefined reference to `_sbrk_r'
<br/>
d:/dsi/devkitpro/devkitarm/bin/../lib/gcc/arm-eabi/4.4.0/../../../../arm-eabi/li
<br/>
b\libc.a(lib_a-freer.o): In function `_malloc_trim_r':
<br/>
(.text+0xbc): undefined reference to `_sbrk_r'
<br/>
collect2: ld returned 1 exit status</td> </tr></table><span class="postbody">
<br/>
<br/>
it's complaining about some malloc thingies, which I've never heard of, but how can that be if the source files do not use the malloc out of stdio.h but just a pointer? 
<br/>
<br/>
btw, you're the one who made dsli, how did you manage to include division when you have -nostdlib in your makefile ?  I've to include the standard lib -lgcc to have support for it. And why do you have selected to tune for the arm7 in the dsli plugin makefile and not the arm9? does the code run from the arm7? To be precise I'm talking about this part:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">CFLAGS   :=   -g -Wall -O2\
<br/>
         -mcpu=arm7tdmi -mtune=arm7tdmi -fomit-frame-pointer\
<br/>
         -ffast-math \
<br/>
         $(ARCH)
<br/>
<br/>
CFLAGS   +=   $(INCLUDE) -DARM9 -fPIC // define arm9 but tune for the arm7?</td> </tr></table><span class="postbody">
<br/>
<br/>
Tommmie</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#171372 - elhobbs - Mon Nov 16, 2009 5:29 pm</h4>
    <div class="postbody"><span class="postbody">I would image that tremor is using malloc internally to dynamically allocate memory. you will need to replace all of the malloc and free calls using the import method that I described earlier. use a search engine if you do not know what malloc is. malloc_r is used internally for calls to malloc.
<br/>
<br/>
like I said before __ctype_ptr__ is defined in libg - you will need to comeup with a solution for that on your own - like removing the depenancy from the source code.
<br/>
<br/>
how did I include division? I included libgcc - ignorance is bliss. it appeared to work fine for what I was using it for. A better approach would probably be to include code for the missing functions. the ds does have some sort of coprocessor for <a class="postlink" href="http://nocash.emubase.de/gbatek.htm#dsmaths" target="_blank">division</a>. though it would need to be used carefully - not in interrupts, etc.
<br/>
<br/>
why did I build for the arm7? because that is what dldi uses and I knew it worked. I think I made it pretty obvious that I stole nearly all of the code from dldi.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#171374 - Tommmie - Mon Nov 16, 2009 6:41 pm</h4>
    <div class="postbody"><span class="postbody">I know what malloc is even what alloca is so that's not the problem is(I think the problem is my bad English). So why should I replace the malloc calls if I DON'T include &lt;stdio.h&gt; &amp; &lt;stdlib.h&gt; but "defines.h&gt; where malloc is declare d as a pointer to the malloc function in the pluginloader? 
<br/>
and maybe I should use the libnds functions for the division. also I really have no idea what to do with __ctype_ptr__. Furtthermore this is your makefile for the plugin:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#---------------------------------------------------------------------------------
<br/>
.SUFFIXES:
<br/>
#---------------------------------------------------------------------------------
<br/>
<br/>
ifeq ($(strip $(DEVKITARM)),)
<br/>
$(error "Please set DEVKITARM in your environment. export DEVKITARM=&lt;path to&gt;devkitARM)
<br/>
endif
<br/>
<br/>
include $(DEVKITARM)/ds_rules
<br/>
<br/>
#---------------------------------------------------------------------------------
<br/>
# TARGET is the name of the output
<br/>
# BUILD is the directory where object files &amp; intermediate files will be placed
<br/>
# SOURCES is a list of directories containing source code
<br/>
# DATA is a list of directories containing data files
<br/>
# INCLUDES is a list of directories containing header files
<br/>
# SPECS is the directory containing the important build and link files
<br/>
#---------------------------------------------------------------------------------
<br/>
export TARGET      :=   $(shell basename $(CURDIR))
<br/>
BUILD      :=   build
<br/>
SOURCES      :=   source
<br/>
DATA      :=   data
<br/>
INCLUDES   :=   include
<br/>
<br/>
<br/>
#---------------------------------------------------------------------------------
<br/>
# options for code generation
<br/>
#---------------------------------------------------------------------------------
<br/>
ARCH   :=   -mthumb-interwork
<br/>
<br/>
CFLAGS   :=   -g -Wall -O2\
<br/>
         -mcpu=arm7tdmi -mtune=arm7tdmi -fomit-frame-pointer\
<br/>
         -ffast-math \
<br/>
         $(ARCH)
<br/>
<br/>
CFLAGS   +=   $(INCLUDE) -DARM9 -fPIC
<br/>
<br/>
CXXFLAGS   := $(CFLAGS) -fno-rtti -fno-exceptions
<br/>
<br/>
ASFLAGS   :=   -g $(ARCH)
<br/>
LDFLAGS   =   -nostartfiles -nostdlib -T $(CURDIR)/../dsli.ld -g $(ARCH) -Wl,-Map,$(TARGET).map
<br/>
<br/>
LIBS   := -lnds9
<br/>
<br/>
#---------------------------------------------------------------------------------
<br/>
# list of directories containing libraries, this must be the top level containing
<br/>
# include and lib
<br/>
#---------------------------------------------------------------------------------
<br/>
LIBDIRS   :=   $(LIBNDS)
<br/>
 
<br/>
  
<br/>
#---------------------------------------------------------------------------------
<br/>
# no real need to edit anything past this point unless you need to add additional
<br/>
# rules for different file extensions
<br/>
#---------------------------------------------------------------------------------
<br/>
ifneq ($(BUILD),$(notdir $(CURDIR)))
<br/>
#---------------------------------------------------------------------------------
<br/>
 
<br/>
export OUTPUT   :=   $(CURDIR)/$(TARGET)
<br/>
<br/>
export VPATH   :=   $(foreach dir,$(SOURCES),$(CURDIR)/$(dir)) \
<br/>
         $(foreach dir,$(DATA),$(CURDIR)/$(dir))
<br/>
<br/>
export DEPSDIR   :=   $(CURDIR)/$(BUILD)
<br/>
<br/>
CFILES      :=   $(foreach dir,$(SOURCES),$(notdir $(wildcard $(dir)/*.c)))
<br/>
CPPFILES   :=   $(foreach dir,$(SOURCES),$(notdir $(wildcard $(dir)/*.cpp)))
<br/>
SFILES      :=   $(foreach dir,$(SOURCES),$(notdir $(wildcard $(dir)/*.s)))
<br/>
BINFILES   :=   $(foreach dir,$(DATA),$(notdir $(wildcard $(dir)/*.*)))
<br/>
<br/>
#---------------------------------------------------------------------------------
<br/>
# use CXX for linking C++ projects, CC for standard C
<br/>
#---------------------------------------------------------------------------------
<br/>
ifeq ($(strip $(CPPFILES)),)
<br/>
#---------------------------------------------------------------------------------
<br/>
   export LD   :=   $(CC)
<br/>
#---------------------------------------------------------------------------------
<br/>
else
<br/>
#---------------------------------------------------------------------------------
<br/>
   export LD   :=   $(CXX)
<br/>
#---------------------------------------------------------------------------------
<br/>
endif
<br/>
#---------------------------------------------------------------------------------
<br/>
<br/>
export OFILES   :=   $(addsuffix .o,$(BINFILES)) \
<br/>
         $(CPPFILES:.cpp=.o) $(CFILES:.c=.o) $(SFILES:.s=.o)
<br/>
<br/>
export INCLUDE   :=   $(foreach dir,$(INCLUDES),-I$(CURDIR)/$(dir)) \
<br/>
         $(foreach dir,$(LIBDIRS),-I$(dir)/include) \
<br/>
         -I$(CURDIR)/$(BUILD)
<br/>
<br/>
export LIBPATHS   :=   $(foreach dir,$(LIBDIRS),-L$(dir)/lib)
<br/>
<br/>
.PHONY: $(BUILD) clean all
<br/>
 
<br/>
#---------------------------------------------------------------------------------
<br/>
all: $(BUILD)
<br/>
<br/>
$(BUILD):
<br/>
   @[ -d $@ ] || mkdir -p $@
<br/>
   @make --no-print-directory -C $(BUILD) -f $(CURDIR)/Makefile
<br/>
 
<br/>
#---------------------------------------------------------------------------------
<br/>
clean:
<br/>
   @echo clean ...
<br/>
   @rm -fr $(BUILD) $(TARGET).dsli $(TARGET).elf
<br/>
 
<br/>
 
<br/>
#---------------------------------------------------------------------------------
<br/>
else
<br/>
 
<br/>
DEPENDS   :=   $(OFILES:.o=.d)
<br/>
 
<br/>
#---------------------------------------------------------------------------------
<br/>
# main targets
<br/>
#---------------------------------------------------------------------------------
<br/>
$(OUTPUT).dsli   :   $(OUTPUT).elf
<br/>
$(OUTPUT).elf   :   $(OFILES)
<br/>
<br/>
<br/>
#---------------------------------------------------------------------------------
<br/>
%.dsli: %.elf
<br/>
   @$(OBJCOPY) -O binary $&lt; $@
<br/>
   @echo built ... $(notdir $@)
<br/>
 
<br/>
<br/>
-include $(DEPENDS)
<br/>
<br/>
 
<br/>
#---------------------------------------------------------------------------------------
<br/>
endif
<br/>
#---------------------------------------------------------------------------------------</td> </tr></table><span class="postbody">
<br/>
<br/>
I don't see the include of lgcc, so what trick have you done? 
<br/>
about _malloc_r(that was something I didn't know of, the malloc thingies:)) you say that it's used for internally calls to malloc, can you give me example of a function doing that?
<br/>
<br/>
Tommmie</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#171375 - elhobbs - Mon Nov 16, 2009 7:21 pm</h4>
    <div class="postbody"><span class="postbody">the files you have are from an older version which actually links to libnds. the files you have are the proof of concept code that I dumped and ran away from. and there are actual problems with it. the main problem being that it does not allocate space for the bss section. so, it dies pretty quickly for all but the most trivial examples.
<br/>
<br/>
It does not matter which files you include, at some point you are referencing malloc so the linker is looking for it. are you using -nostartfiles in your makefile? you should be, it prevents the need for main and the code that calls it. malloc and sbrk (which is used to get memory for malloc) may be referenced by this.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#171376 - Tommmie - Mon Nov 16, 2009 7:30 pm</h4>
    <div class="postbody"><span class="postbody">yes I'm using -nostartfiles in my makefile. Shall I upload the code I'm trying to compile on my site?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#171379 - elhobbs - Mon Nov 16, 2009 10:13 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Tommmie wrote:</b></span></td> </tr> <tr> <td class="quote">yes I'm using -nostartfiles in my makefile. Shall I upload the code I'm trying to compile on my site?</td> </tr></table><span class="postbody">sure, I will take a look - not that I can promise a solution ;)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#171380 - Dwedit - Mon Nov 16, 2009 10:28 pm</h4>
    <div class="postbody"><span class="postbody">Compile to ASM (use the -S switch) and see where those calls actually occur.  GCC often sticks in library function calls during compilation.<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#171381 - Tommmie - Tue Nov 17, 2009 7:30 am</h4>
    <div class="postbody"><span class="postbody">Thanks for the tip:) will try it in the afternoon</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
