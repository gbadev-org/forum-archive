<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>NDS ARM9 Cache, strange behaviour with NO$GBA - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > NDS ARM9 Cache, strange behaviour with NO$GBA</h2>
<div id="posts">
<div class="post">
    <h4>#158495 - sverx - Thu Jun 12, 2008 10:17 am</h4>
    <div class="postbody"><span class="postbody">Hi there... I'm back once more with my newbie questions.
<br/>
<br/>
This time I've got to ask the forum about the ARM9 <span style="font-weight: bold">Cache</span>.
<br/>
I've already read the really interesting (and clear!) topic <a class="postlink" href="http://forum.gbadev.org/viewtopic.php?t=15294" target="_blank">here</a>, and I've read, mainly, about flushing the data cache
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">DC_FlushAll()</td> </tr></table><span class="postbody">
<br/>
and/or ORing 0x400000 to a memory address to 'bypass' the cache so <span style="font-style: italic">really</span> accessing the memory content.
<br/>
<br/>
In my little program they <span style="font-weight: bold">both</span> work but on the NO$GBA emulator, when I use the 'ORing 0x400000' system, the numbers of Total Errors (you know, the F3 key...) immediatly goes from the 0 I had before to some thousand... and I see no reasons at all :|
<br/>
<br/>
You see... I would like not to use the DC_FlushAll() because I just need -sometimes- to access a memory area where -constantly- the ARM7 writes different values, so I guess I shouldn't <span style="font-style: italic">disturb</span> the cache for that... I hope you understand what I mean... :|
<br/>
<span style="font-size: 7px; line-height: normal">(yes, I had to study English better when in high school...)</span>
<br/>
<br/>
Any help/hint will be appreciated! :)
<br/>
<br/>
Thanks! Ciao :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#158497 - Maxxie - Thu Jun 12, 2008 10:28 am</h4>
    <div class="postbody"><span class="postbody">DC_Flush*() would overwrite the values the ARM7 put there.
<br/>
DC_Invalidate*() on the otherhand lose some other data you've had in the arm9 datachache
<br/>
<br/>
<br/>
On such situations, you should avoid intermixing cached and noncached memory access. Do this by allocating your shared buffer with memalign to the size of a cacheline (32 Bytes). Make sure to allocate full cachelines (only multiples of 32 Bytes) otherwise access to the cached version of the mem could happen through other malloced.
<br/>
Read/Write from the mirror.
<br/>
<br/>
Then you can safely access the non cached mirror of that memory after an initial flush.
<br/>
This is because other then your access to the mirror noone access the cahed version and therefor the cache is never again used for that memory.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#158500 - sverx - Thu Jun 12, 2008 10:54 am</h4>
    <div class="postbody"><span class="postbody">Thanks for the answer... still I've got some doubts...
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Maxxie wrote:</b></span></td> </tr> <tr> <td class="quote">DC_Flush*() would overwrite the values the ARM7 put there.</td> </tr></table><span class="postbody">
<br/>
<br/>
mmm... I <span style="font-weight: bold">never</span> write (with ARM9) to that location... could overwrite happen? :|
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Maxxie wrote:</b></span></td> </tr> <tr> <td class="quote">On such situations, you should avoid intermixing cached and noncached memory access.</td> </tr></table><span class="postbody">
<br/>
<br/>
The reason isn't clear to me. I obviously want that the ARM9 cache to work, i just don't want it to cache while <span style="font-weight: bold">reading</span> from that specific memory location where ARM7 writes values... I would like to avoid flushing/invalidating caches, instead...
<br/>
<br/>
Thanks :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#158501 - Maxxie - Thu Jun 12, 2008 11:02 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>sverx wrote:</b></span></td> </tr> <tr> <td class="quote">Thanks for the answer... still I've got some doubts...
<br/>
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Maxxie wrote:</b></span></td> </tr> <tr> <td class="quote">DC_Flush*() would overwrite the values the ARM7 put there.</td> </tr></table><span class="postbody">
<br/>
<br/>
mmm... I <span style="font-weight: bold">never</span> write (with ARM9) to that location... could overwrite happen? :|
<br/>
</span></td> </tr></table><span class="postbody">
<br/>
<br/>
There might be other data changed in the same cacheline. This will cause the whole cacheline to be written back.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Maxxie wrote:</b></span></td> </tr> <tr> <td class="quote">On such situations, you should avoid intermixing cached and noncached memory access.</td> </tr></table><span class="postbody">
<br/>
<br/>
The reason isn't clear to me. I obviously want that the ARM9 cache to work, i just don't want it to cache while <span style="font-weight: bold">reading</span> from that specific memory location where ARM7 writes values... I would like to avoid flushing/invalidating caches, instead...
<br/>
<br/>
Thanks :)</span></td> </tr></table><span class="postbody">
<br/>
<br/>
This is exactly what i suggest (The flush is only once on init, and only needed for the the affected cachelines). You reserve whole cacheline-blocks, so they are not shared with other data, and thus will never be flagged (by access) to be written back due to other data "near" your shared.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#158508 - sverx - Thu Jun 12, 2008 1:34 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Maxxie wrote:</b></span></td> </tr> <tr> <td class="quote">There might be other data changed in the same cacheline. This will cause the whole cacheline to be written back.</td> </tr></table><span class="postbody">
<br/>
<br/>
... that's interesting! But this <span style="font-style: italic">could</span> happen only if ARM9 did a write operation on a memory address close enough to the data that shouldn't be overwritten, right? (it seems to me I've read that a cache line is only 32 bytes...)
<br/>
<br/>
and about that:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Maxxie wrote:</b></span></td> </tr> <tr> <td class="quote">You reserve whole cacheline-blocks, so they are not shared with other data, and thus will never be flagged (by access) to be written back due to other data "near" your shared.</td> </tr></table><span class="postbody">
<br/>
<br/>
I'm not really sure I understand... it's that related to what I said before? You mean I should reserve a block which should be 32*n bytes? And what about alignment? Should I check that malloc() returns me a 'cache line aligned' block?
<br/>
<br/>
Thanks once more :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#158509 - Maxxie - Thu Jun 12, 2008 1:40 pm</h4>
    <div class="postbody"><span class="postbody">Yes that's right.
<br/>
<br/>
Use memalign(32,desiredSize) instead of malloc(desiredSize) to align the data at cacheline borders.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#158510 - sverx - Thu Jun 12, 2008 2:01 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Maxxie wrote:</b></span></td> </tr> <tr> <td class="quote">Use memalign(32,desiredSize) instead of malloc(desiredSize) to align the data at cacheline borders.</td> </tr></table><span class="postbody">
<br/>
<br/>
Wonderful, I didn't know about that :) Thanks :)
<br/>
<br/>
BTW, does anybody has an idea about why happens that?
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">In my little program they both work but on the NO$GBA emulator, when I use the 'ORing 0x400000' system, the numbers of Total Errors (you know, the F3 key...) immediatly goes from the 0 I had before to some thousand... and I see no reasons at all :|</td> </tr></table><span class="postbody">
<br/>
<br/>
Thanks once more :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#158569 - sverx - Fri Jun 13, 2008 3:03 pm</h4>
    <div class="postbody"><span class="postbody">... just two more questions, to be sure...
<br/>
<br/>
1) Are
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">malloc (k)</td> </tr></table><span class="postbody">
<br/>
and
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">memalign (4,k)</td> </tr></table><span class="postbody">
<br/>
always the same thing on NDS, right? (Both ARM9 and ARM7 I guess...)
<br/>
<br/>
2) Does the cache <span style="font-style: italic">interfere</span> when reading/writing to the OAM and the OAM_SUB? I mean, if I write to the OAM, should I flush to ensure data gets really written there?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#158570 - Maxxie - Fri Jun 13, 2008 3:13 pm</h4>
    <div class="postbody"><span class="postbody">The effect of both should be the same.
<br/>
<br/>
You do not need to care about cache for OAM and such. The ds9 crt0 only sets the cacheable bit for region 1 and 6, which are 
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
   @-------------------------------------------------------------------------
<br/>
   @ Region 1 - Main Memory
<br/>
   @-------------------------------------------------------------------------
<br/>
   ldr   r0,=( PAGE_4M | 0x02000000 | 1)   
<br/>
[...]
<br/>
   @-------------------------------------------------------------------------
<br/>
   @ Region 6 - System ROM
<br/>
   @-------------------------------------------------------------------------
<br/>
   ldr   r0,=( PAGE_32K | 0xFFFF0000 | 1)   
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Every other memory location does not include cache.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
