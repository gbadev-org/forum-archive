<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>FreeType2 Library [updated 24 April] - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>DS development > FreeType2 Library [updated 24 April]</h2>
<div id="posts">
<div class="post">
    <h4>#126473 - Lick - Mon Apr 23, 2007 2:45 pm</h4>
    <div class="postbody"><span class="postbody">_________________________
<br/>
<span style="font-size: 9px; line-height: normal">Updated 24 april:</span>
<br/>
<br/>
<span style="font-weight: bold">Download FreeType2 library:</span>
<br/>
<a class="postlink" href="http://lickr.org/files/freetype2/freetype2.zip" target="_blank">FreeType2 core</a>
<br/>
<a class="postlink" href="http://lickr.org/files/freetype2/freetype2_full.zip" target="_blank">FreeType2 full</a> (use this one)
<br/>
<br/>
The Full version contains all the available modules, except for the GZIP-module and the gzip-dependent PCF-module. I couldn't get it to compile that module, maybe someone else can.
<br/>
<br/>
<span style="font-weight: bold">Download demo:</span>
<br/>
<a class="postlink" href="http://lickr.org/files/freetype2/ft_test.nds" target="_blank">Demo displays Chinese characters with color</a>
<br/>
<br/>
_________________________
<br/>
<span style="font-size: 9px; line-height: normal">Original message:</span>
<br/>
<br/>
I have successfully <a class="postlink" href="http://lickr.org/files/freetype2/freetype2.zip" target="_blank">ported FreeType2</a> to the DS. However I have stripped out some of its features. You can examine the source and rebuild the library if you want to. 
<br/>
To rebuild with different options, edit the files in /include/freetype/config/*.h. Also, in the /source/ directory, you have to rename some directories/files removing the "_DISABLED" that I added onto them to prevent compilation.
<br/>
<br/>
Anyway, FreeType2 (2.3.4) that *should* support:
<br/>
- TrueType, OpenType and Windows Fonts.
<br/>
- Monotone vs Antialiased rendering.
<br/>
<br/>
<a class="postlink" href="http://freetype.sourceforge.net/freetype2/docs/tutorial/step1.html" target="_blank">FreeType2 Tutorial</a>
<br/>
<br/>
I have only tested the initialization of FreeType2 and loaded a font. That all works, but I haven't tried anything beyond that. I kind of released this in a hurry, since I don't have a lot of time on my hands. I will try to squeeze in a font rendering demo this week.
<br/>
<br/>
- Lick
<br/>
<br/>
<span style="font-size: 18px; line-height: normal">Oh shit!</span> Forgot to include the <a class="postlink" href="http://freetype.sourceforge.net/license.html" target="_blank">License</a><br/>_________________<br/><a class="postlink" href="http://licklick.wordpress.com" target="_blank">http://licklick.wordpress.com</a></span><span class="gensmall"><br/><br/>Last edited by Lick on Wed Apr 25, 2007 6:22 pm; edited 4 times in total</span></div>    
</div>
<div class="post">
    <h4>#126477 - Lick - Mon Apr 23, 2007 4:42 pm</h4>
    <div class="postbody"><span class="postbody"><span style="font-size: 18px; line-height: normal">Demo </span>because I couldn't <a class="postlink" href="http://lickr.org/files/freetype2/freetype2_test.zip" target="_blank">resist it</a>. Extract the files to the root and DLDI patch the binary.
<br/>
<br/>
<a class="postlink" href="http://lickr.org/files/freetype2/scr.png" target="_blank">Photoshot #1</a> (Times)
<br/>
<a class="postlink" href="http://lickr.org/files/freetype2/scr2.png" target="_blank">Photoshot #2</a> (Matura MT named "times.ttf")
<br/>
<br/>
BTW: The fonts have 256 levels of alpha, but in my demo I reduced that to 4 levels (if-elseif-elseif-else). So some fonts may render looking like there's no alpha (antialiasing).<br/>_________________<br/><a class="postlink" href="http://licklick.wordpress.com" target="_blank">http://licklick.wordpress.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#126650 - Stuk - Wed Apr 25, 2007 4:25 pm</h4>
    <div class="postbody"><span class="postbody">Ooo, this looks awesome. Will have to try it out at some point :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#126655 - Cobalt - Wed Apr 25, 2007 6:06 pm</h4>
    <div class="postbody"><span class="postbody">That's freakin' excellent!  I'm looking forward to playing with this...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#126672 - dext3r - Wed Apr 25, 2007 10:13 pm</h4>
    <div class="postbody"><span class="postbody">cool. i was also trying to get this to compile to a library. with the code based from <a href="http://svn.navi.cx/misc/trunk/nds/freetype-test/" target="_blank">http://svn.navi.cx/misc/trunk/nds/freetype-test/</a> i was able to compile a working <a class="postlink" href="http://www.dext3r.net/backup/freetype-test.nds" target="_blank">demo</a> with color 
<br/>
<br/>
Are you doing the 4level color in the Chinese character demo?
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">  for (i=width; i; i--) {
<br/>
     
<br/>
       uint8 r = *(src++) &gt;&gt; 3;
<br/>
       uint8 g = *(src++) &gt;&gt; 3;
<br/>
      uint8 b = *(src++) &gt;&gt; 3;
<br/>
 
<br/>
       uint8 rb = ((*dest &amp; 0x1F)) ;
<br/>
        uint8 gb = ((*dest &gt;&gt; 5) &amp; 0x1F);
<br/>
       uint8 bb = ((*dest &gt;&gt; 10) &amp; 0x1F);
<br/>
         
<br/>
       uint8 input_red = 0xFF &gt;&gt; 3;
<br/>
       uint8 input_green = 0xFF &gt;&gt; 3;
<br/>
       uint8 input_blue = 0xFF &gt;&gt; 3;
<br/>
       
<br/>
         if(r|g|b)       
<br/>
       *dest = RGB15((input_red * r/31 + (31 - r) * rb / 31),(input_green * g/31 + (31 - g) * gb / 31),(input_blue * b/31 + (31 - b) *bb / 31) );
<br/>
    
<br/>
    dest++;
<br/>
   }   </td> </tr></table><span class="postbody">
<br/>
<br/>
thats how i did the color in my test. are you doing it the same?
<br/>
<br/>
i will take a look at your stuff so i can learn how to make it into a library, good job and thanks</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#126674 - Lick - Wed Apr 25, 2007 10:24 pm</h4>
    <div class="postbody"><span class="postbody">I'm using this code. It's a modified version from the site you mentioned. ;)
<br/>
<br/>
It uses wide characters (wchar_t). 
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#define FT_FLOOR(x)     (((x) &amp; -64) / 64)
<br/>
#define FT_CEIL(x)      ((((x) + 63) &amp; -64) / 64)
<br/>
#define FT_FIXED(x)     ((x) * 64)
<br/>
u16 *ft_buffer = BG_GFX;
<br/>
u16 ft_buffer_w = SCREEN_WIDTH;
<br/>
u16 ft_buffer_h = SCREEN_HEIGHT;
<br/>
u32 ft_pen_r = 0;
<br/>
u32 ft_pen_g = 0;
<br/>
u32 ft_pen_b = 0;
<br/>
<br/>
//---------------------------------------------------------------------------------
<br/>
void ft_print_c(FT_Bitmap *bitmap, s32 x, s32 y)
<br/>
//---------------------------------------------------------------------------------
<br/>
{
<br/>
    u8 *src = bitmap-&gt;buffer;
<br/>
    u16 *dest = &amp;ft_buffer[y*ft_buffer_w + x];
<br/>
    s32 width = bitmap-&gt;width;
<br/>
    s32 height = bitmap-&gt;rows;
<br/>
    s32 pitch = bitmap-&gt;pitch;
<br/>
    
<br/>
    s32 j, k;
<br/>
    u16 *pixel, r, g, b;
<br/>
    
<br/>
    if(bitmap-&gt;pitch &gt;= 0)
<br/>
    {
<br/>
        for(j=0; j&lt;height; j++)
<br/>
        {
<br/>
            for(k=0; k&lt;width; k++)
<br/>
            {
<br/>
                u8 opaque = src[k];
<br/>
                if(opaque)
<br/>
                {
<br/>
                    pixel = &amp;dest[j*ft_buffer_w + k];
<br/>
                    r = ((*pixel)&amp;31)*(255-opaque) + ft_pen_r*opaque;
<br/>
                    g = ((*pixel&gt;&gt;5)&amp;31)*(255-opaque) + ft_pen_g*opaque;
<br/>
                    b = ((*pixel&gt;&gt;10)&amp;31)*(255-opaque) + ft_pen_b*opaque;
<br/>
                    r = (r&gt;&gt;8) &amp; 31;
<br/>
                    g = (g&gt;&gt;8) &amp; 31;
<br/>
                    b = (b&gt;&gt;8) &amp; 31;
<br/>
                    *pixel = BIT(15) | RGB15(r,g,b);
<br/>
                }
<br/>
            }
<br/>
            src += pitch;
<br/>
        }
<br/>
    }
<br/>
    else
<br/>
    {
<br/>
        for(j=height-1; j&gt;=0; j--)
<br/>
        {
<br/>
            for(k=0; k&lt;width; k++)
<br/>
            {
<br/>
                u8 opaque = src[k];
<br/>
                if(opaque)
<br/>
                {
<br/>
                    pixel = &amp;dest[j*ft_buffer_w + k];
<br/>
                    r = ((*pixel)&amp;31)*(255-opaque) + ft_pen_r*opaque;
<br/>
                    g = ((*pixel&gt;&gt;5)&amp;31)*(255-opaque) + ft_pen_g*opaque;
<br/>
                    b = ((*pixel&gt;&gt;10)&amp;31)*(255-opaque) + ft_pen_b*opaque;
<br/>
                    r = (r&gt;&gt;8) &amp; 31;
<br/>
                    g = (g&gt;&gt;8) &amp; 31;
<br/>
                    b = (b&gt;&gt;8) &amp; 31;
<br/>
                    *pixel = BIT(15) | RGB15(r,g,b);
<br/>
                }
<br/>
            }
<br/>
            src += pitch;
<br/>
        }
<br/>
    }
<br/>
}
<br/>
<br/>
//---------------------------------------------------------------------------------
<br/>
void ft_printf(FT_Face face, s32 x, s32 y, const wchar_t *string)
<br/>
//---------------------------------------------------------------------------------
<br/>
{
<br/>
    if(string == 0)
<br/>
        return;
<br/>
<br/>
    int ascent = FT_CEIL(FT_MulFix(face-&gt;bbox.yMax, face-&gt;size-&gt;metrics.y_scale));
<br/>
    y += ascent;
<br/>
<br/>
    u32 i;
<br/>
    for(i=0; string[i] != 0; i++)
<br/>
    {
<br/>
        if(string[i] == L' ')
<br/>
        {
<br/>
           x += ascent&gt;&gt;1;
<br/>
            continue;
<br/>
        }
<br/>
        else if(string[i] == L'\n')
<br/>
        {
<br/>
            y += ascent;
<br/>
            continue;
<br/>
        }
<br/>
       FT_Load_Char(face, string[i], FT_LOAD_RENDER);
<br/>
<br/>
       ft_print_c(&amp;face-&gt;glyph-&gt;bitmap,
<br/>
                   x,// + FT_FLOOR(face-&gt;glyph-&gt;metrics.horiBearingX),
<br/>
                y - FT_FLOOR(face-&gt;glyph-&gt;metrics.horiBearingY));
<br/>
<br/>
       x += FT_CEIL(face-&gt;glyph-&gt;metrics.width)+1;
<br/>
    }
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
As you can see, I haven't implemented the real "printf".<br/>_________________<br/><a class="postlink" href="http://licklick.wordpress.com" target="_blank">http://licklick.wordpress.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#126747 - felix123 - Thu Apr 26, 2007 8:06 am</h4>
    <div class="postbody"><span class="postbody">Can't you choose a more suitable phrase? :)
<br/>
Does it work with Traditional Chinese?<br/>_________________<br/><a class="postlink" href="http://en.wikipedia.org/wiki/NDSh" target="_blank">Nintendo DS homebrew on Wikipedia</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#126766 - Lick - Thu Apr 26, 2007 1:11 pm</h4>
    <div class="postbody"><span class="postbody">As far as I know, GB2312 only contains Simplified Chinese. You can always use Unicode, Big 5, UCS 4. But those fonts are too big to fit in the Main RAM. I'm not sure how well FreeType2 works in the external RAM. Not sure if it will work at all. It should work though, as I just read this from the FreeType API reference:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote"><span style="font-weight: bold">FT_New_Memory_Face</span>
<br/>
<br/>
This function calls FT_Open_Face to open a font which has been loaded into memory.
<br/>
<br/>
...
<br/>
...
<br/>
<br/>
note
<br/>
<span style="text-decoration: underline"><span style="font-weight: bold">
<br/>
You must not deallocate the memory before calling FT_Done_Face.</span></span></td> </tr></table><span class="postbody">
<br/>
<br/>
So it might work if the font is loaded into External RAM which gives you enough room for fonts of 8MB to 32MB.<br/>_________________<br/><a class="postlink" href="http://licklick.wordpress.com" target="_blank">http://licklick.wordpress.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#127679 - Zarxrax - Fri May 04, 2007 12:55 am</h4>
    <div class="postbody"><span class="postbody">Hmmm... I tried messing around with this, but I'm really not sure how to get started. What all do I need to do in order to get this up and running? Any sample code I could look over?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#127739 - Lick - Fri May 04, 2007 12:17 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">// INIT FreeType2
<br/>
    FT_Library library;
<br/>
    FT_Error   error;
<br/>
    FT_Face    face;
<br/>
    
<br/>
<br/>
    error = FT_Init_FreeType(&amp;library);
<br/>
    if(error)
<br/>
        return error;
<br/>
<br/>
    error = FT_New_Memory_Face(library, arial_ttf_bin, arial_ttf_bin_size, 0, &amp;face);
<br/>
    if(error)
<br/>
        return error;
<br/>
<br/>
   FT_Set_Pixel_Sizes(face, 0, 14);
<br/>
<br/>
<br/>
// RENDER Text
<br/>
    const char *string = "Hello universe!";
<br/>
    int x = 3;
<br/>
    int y = 3; // at [3, 3]
<br/>
    
<br/>
    int ascent = FT_CEIL(FT_MulFix(face.bbox.yMax, face.size-&gt;metrics.y_scale));
<br/>
    y += ascent;      // add ascent to y coordinate
<br/>
<br/>
<br/>
    for(int i=0; string[i] != 0; i++)
<br/>
    {
<br/>
        if(string[i] == ' ')
<br/>
        {
<br/>
           x += ascent/2;
<br/>
            continue;
<br/>
        }
<br/>
        else if(string[i] == '\n')
<br/>
        {
<br/>
            y += ascent;
<br/>
            continue;
<br/>
        }
<br/>
        else
<br/>
        {
<br/>
           FT_Load_Char(&amp;face, string[i], FT_LOAD_RENDER | // tell FreeType2 to render internally
<br/>
                                           FT_LOAD_TARGET_NORMAL); // grayscale 0-255
<br/>
            
<br/>
            u8 *src = (u8 *)face.glyph-&gt;bitmap;
<br/>
            u16 *dest = BG_GFX;
<br/>
<br/>
            int j, k;
<br/>
            u16 *pixel, r, g, b;
<br/>
<br/>
            if(bitmap-&gt;pitch &gt;= 0)
<br/>
            {
<br/>
                for(j=0; j&lt;bitmap-&gt;rows; j++)
<br/>
                {
<br/>
                    for(k=0; k&lt;bitmap-&gt;width; k++)
<br/>
                    {
<br/>
                        u8 alpha = src[k]; // 0-255
<br/>
                        if(alpha)
<br/>
                        {
<br/>
                            pixel = &amp;dest[j*ft_buffer_w + k];   // original pixel
<br/>
                            
<br/>
                            r = ((*pixel)&amp;31)*(255-alpha)     + 255*alpha; // blend algorithm, our color is red
<br/>
                            g = ((*pixel&gt;&gt;5)&amp;31)*(255-alpha)  + 0*alpha;
<br/>
                            b = ((*pixel&gt;&gt;10)&amp;31)*(255-alpha) + 0*alpha;
<br/>
                            
<br/>
                            r = (r&gt;&gt;8) &amp; 31; // convert to R5G5B5
<br/>
                            g = (g&gt;&gt;8) &amp; 31;
<br/>
                            b = (b&gt;&gt;8) &amp; 31;
<br/>
                            *pixel = BIT(15) | RGB15(r,g,b); // write pixel
<br/>
                        }
<br/>
                    }
<br/>
                    src += pitch;
<br/>
                }
<br/>
            }
<br/>
<br/>
           x += FT_CEIL(face.glyph-&gt;metrics.width) + 1; // add incorrect but cheap letterspacing
<br/>
       }
<br/>
    }
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
This should get you started. It's very linear code that you can cut into smaller functions. I even included my blending code. The biggest time-consumer I found to be FT_Load_Char, which does the internal rendering. Maybe there's a way to bypass it, or optimize it internally with ARM assembly.<br/>_________________<br/><a class="postlink" href="http://licklick.wordpress.com" target="_blank">http://licklick.wordpress.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#136133 - rhaleblian - Sun Jul 29, 2007 3:33 pm</h4>
    <div class="postbody"><span class="postbody">Thanks Lick, this port allowed me to make progress with a DS ebook reader. Looks pretty ok.
<br/>
<br/>
<a href="http://eris.kicks-ass.net" target="_blank">http://eris.kicks-ass.net</a>    ( see project pages re dslibris)
<br/>
<br/>
I tried to use this port on Ubuntu in an effort to move to linux from mingw and encountered problems with functions defined more than once. In comparison, the current distro of freetype builds ok for arm-eabi on Ubuntu but my code fails at runtime when trying to create a new Face.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#140358 - rhaleblian - Sat Sep 15, 2007 4:37 pm</h4>
    <div class="postbody"><span class="postbody">link from above moved
<br/>
<br/>
<a href="http://rhaleblian.wordpress.com" target="_blank">http://rhaleblian.wordpress.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#140778 - rhaleblian - Wed Sep 19, 2007 7:31 pm</h4>
    <div class="postbody"><span class="postbody">i've been able to compile 2.3.5 --without-zlib and am using it in dslibris. in case anyone wants this version.<br/>_________________<br/>[ <a href="http://rhaleblian.wordpress.com" target="_blank">http://rhaleblian.wordpress.com</a> ]</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
