<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>256 colors palette  [solved] - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>DS development > 256 colors palette  [solved]</h2>
<div id="posts">
<div class="post">
    <h4>#151760 - doudou - Tue Mar 04, 2008 7:41 pm</h4>
    <div class="postbody"><span class="postbody">I want to upgrade my game from using 16 colors backgrounds (4 layers for each screen) to 256 colors. 
<br/>
<br/>
Does the DS have 4 256 colors palettes slots per screen? (or I have to split the 256 colors between my 4 layers).</span><span class="gensmall"><br/><br/>Last edited by doudou on Sat Jul 05, 2008 7:13 pm; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#151770 - tepples - Tue Mar 04, 2008 8:39 pm</h4>
    <div class="postbody"><span class="postbody">The GBA has one 256-color palette for the background and one for the sprites. The DS has one of each for each of the two 2D cores: one for main background, one for main sprites, one for sub background, and one for sub sprites. But the DS also has "extended palettes".<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#151776 - doudou - Tue Mar 04, 2008 9:50 pm</h4>
    <div class="postbody"><span class="postbody">Thanks tepples.
<br/>
<br/>
Can you tell me more about "extended palettes" or refer me to a post that gives good info about it (just typing in the search gives a lot of junk)?
<br/>
<br/>
I already use 256 colors for the sprites in both screens. What I would like to do is use 256 colors per layer in both screens if possible. Otherwise, I will use 64 colors (or different setup) per layer.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#151804 - doudou - Wed Mar 05, 2008 2:30 am</h4>
    <div class="postbody"><span class="postbody">The best I have so far on extended palettes is:
<br/>
<br/>
<a href="http://nocash.emubase.de/gbatek.htm#dsvideoextendedpalettes" target="_blank">http://nocash.emubase.de/gbatek.htm#dsvideoextendedpalettes</a>
<br/>
<br/>
If I could have some code sample of a proper way to use it, it would be appreciated.
<br/>
<br/>
I would also like to know if there are reasons that would prevent from using it (ex: slow access, complexity of use, etc.)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#151809 - M3d10n - Wed Mar 05, 2008 4:20 am</h4>
    <div class="postbody"><span class="postbody">I never tried using them myself, but this is what I understand from GBATEK:
<br/>
<br/>
- Extended palettes allow 16 256 color palettes (just like the 16-color mode allows 16 16-color palettes)
<br/>
- You use 16-bit map entries, setting bits 12-15 to select the palette per tile, just like in the 16/16-color mode
<br/>
- You allocate your palettes in 4 "slots" of 8K (16 palettes) each.
<br/>
- Each BG layer will use a different slot (BG 0 will use slot 0.
<br/>
<br/>
It doesn't sounds too complicated, and the only major differences to 16x16 palette mode is the slot stuff (and that you need to set the VRAM bank mode to LCD before writing your palettes to it). 
<br/>
<br/>
From what I understand, you'll have 64 palettes written one after the other at the allocated VRAM bank. BG0 will use palettes 0-15, BG1 will use palettes 16-31, BG2 will use 32-47 and BG3 will use 48-64. Optionally, you can have BG0 use slot2 and BG1 use slot3.
<br/>
<br/>
The main issue, IMO, would be setting up an art pipeline to take full advantage of extended BG palettes (extended sprite palettes are easier to use in that regard). You can easily use unique 256 color palettes for each BG, but using 16 unique palettes for each BG is a lot harder. 
<br/>
<br/>
Maybe a tool which takes a tilemap and uses quantization to calculate 16 optimal palettes for the whole image, taking the tiles in consideration.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#151854 - doudou - Thu Mar 06, 2008 12:38 am</h4>
    <div class="postbody"><span class="postbody">Thanks, this should be really useful. 
<br/>
<br/>
Just to confirm it's right, did somebody already try it?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#151867 - doudou - Thu Mar 06, 2008 2:17 am</h4>
    <div class="postbody"><span class="postbody">I'm now having the same issue has many had on the forum. I works when there is no palette offset (bg 0) but otherwise, I only have black. 
<br/>
<br/>
I tested on the subscreen, using VRAM_H. You can have a look at my code. I tried with bg 2, using palIndex = 32 according to M3d10n instructions.
<br/>
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
   if(mScreen == kNDSTopScreen)
<br/>
   {
<br/>
      vramSetBankF(VRAM_F_LCD);
<br/>
      DMACopy16((void*) palette, VRAM_F + (palIndex * 256*2), 256);   // Copy palette data ... 
<br/>
      vramSetBankF(VRAM_F_BG_EXT_PALETTE);
<br/>
   }
<br/>
   else // bottom screen.
<br/>
   {
<br/>
      vramSetBankH(VRAM_H_LCD);
<br/>
      DMACopy16((void*) palette, VRAM_H + (palIndex * 256*2), 256);   // Copy palette data ... 
<br/>
      vramSetBankH(VRAM_H_SUB_BG_EXT_PALETTE);
<br/>
   }
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#151870 - Cydrak - Thu Mar 06, 2008 5:27 am</h4>
    <div class="postbody"><span class="postbody">VRAM_x constants are typed as uint16*. So you're adding a halfword, not a byte offset... are you sure you want the factor of 2?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#151957 - doudou - Fri Mar 07, 2008 12:41 am</h4>
    <div class="postbody"><span class="postbody">You are absolutely right Cydrak. Thank you, it now works fine!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#152654 - doudou - Wed Mar 19, 2008 12:53 am</h4>
    <div class="postbody"><span class="postbody">I had good results until I tried to use extended palettes in the top screen. To have the 32k required to store the 64x256 colors palettes, I use the VRAM slots F and G (16k each). 
<br/>
<br/>
When I look the palette data in my DS emulator, I see that my palettes are loaded at Main EXT 0 and Main EXT 1 (palette 0), but I want to laod layer 2 and 3 palettes so I try for Main EXT 2 and Main EXT 3 (palette 0) with my palette indices at 32 and 48. 
<br/>
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">   if(mScreen == kNDSTopScreen)
<br/>
   {
<br/>
      if(palIndex &lt; 32)
<br/>
      {
<br/>
         vramSetBankF(VRAM_F_LCD);
<br/>
         DMACopy16((void*) palette, VRAM_F + (palIndex * 256), 256);
<br/>
         vramSetBankF(VRAM_F_BG_EXT_PALETTE);
<br/>
      }
<br/>
      else
<br/>
      {
<br/>
         vramSetBankG(VRAM_G_LCD);
<br/>
         DMACopy16((void*) palette, VRAM_G + ((palIndex - 32) * 256), 256); 
<br/>
         vramSetBankG(VRAM_G_BG_EXT_PALETTE);
<br/>
      }
<br/>
   }</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#152655 - Cydrak - Wed Mar 19, 2008 2:19 am</h4>
    <div class="postbody"><span class="postbody">F and G will work, but the libnds default puts both in the same place (first 16k of the target). To do it properly, you need some offsets... check the prior topic on <a class="postlink" href="http://forum.gbadev.org/viewtopic.php?p=139422&amp;highlight=#139422" target="_blank">palette slots</a>.
<br/>
<br/>
Other possibilities are using bank E (if you don't mind wasting half of it). Or you can try to map F or G alone at +16k. This is useful as BG0/BG1 have a flag to share the upper slots (<a class="postlink" href="http://nocash.emubase.de/gbatek.htm#dsvideobgmodescontrol" target="_blank">DStek:DS BG modes</a>, near bottom).</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#152671 - TwentySeven - Wed Mar 19, 2008 5:22 am</h4>
    <div class="postbody"><span class="postbody">Yeah I used bank F and the shared slots too.  Who needs more then 16 palettes anyway!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#152713 - doudou - Wed Mar 19, 2008 11:21 pm</h4>
    <div class="postbody"><span class="postbody">TwentySeven: it's not that I want more than 16 palettes, I actualy only need 4, my problem is about the auto-mapping of layers to palettes indices.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#152719 - Cydrak - Thu Mar 20, 2008 1:32 am</h4>
    <div class="postbody"><span class="postbody">I threw up an <a class="postlink" href="http://draci.chaosnet.org/code/ex-extpal.zip" target="_blank">example</a> if that would help. It shows several useful bank setups, and how to make the sharing work.
<br/>
<br/>
Y: switch bank usage (E, F+G, F or G)
<br/>
X: toggle BG0's palette (0 or 2)
<br/>
A: toggle BG1's palette (1 or 3)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#152745 - TwentySeven - Thu Mar 20, 2008 10:30 am</h4>
    <div class="postbody"><span class="postbody"><a href="http://liranuna.drunkencoders.com/nds-2d-tuts/lesson-3/" target="_blank">http://liranuna.drunkencoders.com/nds-2d-tuts/lesson-3/</a>
<br/>
<br/>
Specifically, bits 12,13,14,15 specify which extended palette slot to use per tile.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#152843 - doudou - Fri Mar 21, 2008 4:26 pm</h4>
    <div class="postbody"><span class="postbody">It's now all working. Cydrak was right about the libnds issue about VRAM_G and VRAM_F being mapped at the same location. The following code fixes my issue:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">if(palIndex &lt; 32)
<br/>
      {
<br/>
         vramSetBankF(VRAM_F_LCD);
<br/>
         DMACopy16((void*) palette, VRAM_F + (palIndex * 256), 256);   // Copy palette data ... 
<br/>
         vramSetBankF((VRAM_F_TYPE) (VRAM_F_BG_EXT_PALETTE | VRAM_OFFSET(0)));
<br/>
      }
<br/>
      else
<br/>
      {
<br/>
         vramSetBankF(VRAM_F_LCD);
<br/>
         DMACopy16((void*) palette, VRAM_F + ((palIndex - 32) * 256), 256);   // Copy palette data ... 
<br/>
         vramSetBankF((VRAM_F_TYPE) (VRAM_F_BG_EXT_PALETTE | VRAM_OFFSET(1)));
<br/>
      }</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
