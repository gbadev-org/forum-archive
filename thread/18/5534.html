<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>some questions and strange if statement behavior? - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>DS development > some questions and strange if statement behavior?</h2>
<div id="posts">
<div class="post">
    <h4>#41133 - rize - Mon Apr 25, 2005 8:56 pm</h4>
    <div class="postbody"><span class="postbody">I was playing with the hello world demo (using dualis) and trying out a few things.
<br/>
<br/>
First let me ask a few basic questions.  I thought I read somewhere that only the ARM7 can retrieve touch input, yet there is no ARM7 code in this demo and it is getting touch input via IPC-&gt;touchX etc.   Am I misunderstanding something?
<br/>
<br/>
Second, the first line sets the video mode and is commented "not using the main screen".  However, I thought video mode was set independantly of screen.  I enabled the main screen as well without changing the video mode and there seems to be no problems.
<br/>
<br/>
Third, is there a trunc or round function somewhere?  If not, is there a better method than what I used below (aside from putting that mess into a macro of course).
<br/>
<br/>
[edit: the problem below is solved... go ahead and laugh, I should have known better]
<br/>
<br/>
Anyway, onto the strange if behavior.  I'm taking the uncalibrated touch input storing it in integers tx and ty and using the following:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">tx = tx/14;
<br/>
ty = f32toint(floatof32((float)(IPC-&gt;touchY)/(float)17.508))-14;</td> </tr></table><span class="postbody">
<br/>
<br/>
... to recalibrate the touch input for dualis.  It apparently works great giving me X values from 1 to 256 and Y values from 1 to 192.  However the minus 14 caused the Y value to default to -14 instead of 0.  So I threw an if statement in...  just to make it look nice.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">if (ty = -14) ty = 0;</td> </tr></table><span class="postbody">
<br/>
<br/>
For some reason the branch is never taken and ty is set to 0 no matter where I touch the (emulated) screen.  I even checked the hex value and tried:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">if (ty = 0xFFFFFFF2) ty = 0;</td> </tr></table><span class="postbody">
<br/>
<br/>
That doesn't work either.  However, the following three if statements work fine:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">if (ty != -14); else ty = 0;
<br/>
<br/>
if (ty &gt; 0); else ty = 0;
<br/>
<br/>
if (ty &lt; 1) ty = 0; //I should have used this one to begin with</td> </tr></table><span class="postbody">
<br/>
<br/>
To verify that the touch input is what I think it should be, I'm printing the results out in dec and hex and also modifying the screen colors depending on the values of tx and ty.  Everything works perfectly except the original two if statements.  The problem occurs on dualis and ideas.
<br/>
<br/>
I figure its either some subtle syntax or type problem or else some kind of compiler error.
<br/>
<br/>
Here's the complete modified helloworld code I'm using:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
//////////////////////////////////////////////////////////////////////
<br/>
// Simple consol print demo
<br/>
// -- dovoto (modified by rize)
<br/>
//////////////////////////////////////////////////////////////////////
<br/>
<br/>
#include &lt;NDS/NDS.h&gt;
<br/>
<br/>
#include &lt;NDS/ARM9/console.h&gt; //basic print funcionality
<br/>
<br/>
int main(void)
<br/>
{
<br/>
   videoSetMode(0); //not using the main screen 
<br/>
   //\\rize: afiak, video mode has nothing to do with a particular screen
<br/>
   
<br/>
      //sub bg 0 will be used to print text   
<br/>
   videoSetModeSub(MODE_0_2D | DISPLAY_BG0_ACTIVE);
<br/>
   vramSetBankC(VRAM_C_SUB_BG); 
<br/>
   SUB_BG0_CR = BG_MAP_BASE(31);   
<br/>
   
<br/>
     //main screen initialized as well
<br/>
   videoSetMode(MODE_0_2D | DISPLAY_BG0_ACTIVE);        
<br/>
   vramSetBankC(VRAM_C_MAIN_BG);
<br/>
   BG0_CR = BG_MAP_BASE(31);      
<br/>
<br/>
     //set up the SUB palette just once (i0 for BG i255 for text color)
<br/>
   BG_PALETTE_SUB[0] = RGB15(31,31,31);     
<br/>
   BG_PALETTE_SUB[255] = RGB15(0,0,0);   
<br/>
<br/>
       while(1)
<br/>
   {
<br/>
      int tx, ty;   
<br/>
   
<br/>
      consoleInitDefault((u16*)SCREEN_BASE_BLOCK_SUB(31),
<br/>
                     (u16*)CHAR_BASE_BLOCK_SUB(0), 16);         
<br/>
      consolePrintSet(0,0);      
<br/>
      consolePrintf("\n   Hello World - Hijacked\n");
<br/>
      
<br/>
      tx = IPC-&gt;touchX/14;
<br/>
      ty = f32toint(floatof32((float)(IPC-&gt;touchY)/(float)17.508))-14;
<br/>
//      if (ty = -14) ty = 0;
<br/>
//      if (ty = 0xFFFFFFF2) ty = 0;
<br/>
//      if (ty != -14); else ty = 0;
<br/>
//      if (ty &gt;= 1); else ty = 0;
<br/>
      if (ty &lt; 1) ty = 0;
<br/>
      
<br/>
      consolePrintSet(0,10);      
<br/>
      consolePrintf(" DEC Touch x =  %d      \n", tx);
<br/>
      consolePrintf(" DEC Touch y =  %d      \n\n", ty);      
<br/>
      consolePrintf(" HEX Touch x =  %X      \n", tx);
<br/>
      consolePrintf(" HEX Touch y =  %X      \n\n", ty);            
<br/>
<br/>
          //BG based on touch input; text inverse of BG
<br/>
      BG_PALETTE[0] = RGB15(tx/9, (tx+ty)/15, ty/7);
<br/>
      BG_PALETTE[255] = ~BG_PALETTE[0] &amp; (0xFFFF &gt;&gt; 1);
<br/>
      
<br/>
      consoleInitDefault((u16*)SCREEN_BASE_BLOCK(31),
<br/>
                           (u16*)CHAR_BASE_BLOCK(0), 16);               
<br/>
      consolePrintSet(0,22);
<br/>
      consolePrintf(" BG COLOR = %04X\n", BG_PALETTE[0]);      
<br/>
   }
<br/>
   return 0;
<br/>
}
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"><br/><br/>Last edited by rize on Mon Apr 25, 2005 11:55 pm; edited 3 times in total</span></div>    
</div>
<div class="post">
    <h4>#41134 - Cleon I - Mon Apr 25, 2005 9:14 pm</h4>
    <div class="postbody"><span class="postbody">= is assignment in C, ty = -14 stores 14 into ty.  It always returns the value of ty.  You want equality, ==, which returns a boolean (actually an integer that's either 1 or 0, but it's the same difference).</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#41136 - rize - Mon Apr 25, 2005 9:38 pm</h4>
    <div class="postbody"><span class="postbody">Well, at least I made over 30 people laugh their asses off!  I can't believe I missed that, thanks.
<br/>
<br/>
If anyone would be so kind as to answer my first three questions I would appreciate it.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#41137 - Sebbo - Mon Apr 25, 2005 9:50 pm</h4>
    <div class="postbody"><span class="postbody">the hello world example in your ndslib\examples folder does have arm7 code that sits there and monitors the touchpad among other things and sends the data to the arm9
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
//////////////////////////////////////////////////////////////////////
<br/>
// Simple ARM7 stub (sends RTC, TSC, and X/Y data to the ARM 9)
<br/>
// -- joat
<br/>
//////////////////////////////////////////////////////////////////////
<br/>
<br/>
#include &lt;NDS/NDS.h&gt;
<br/>
<br/>
#include &lt;NDS/ARM7/BIOS.h&gt;
<br/>
#include &lt;NDS/ARM7/touch.h&gt;
<br/>
#include &lt;NDS/ARM7/clock.h&gt;
<br/>
<br/>
//////////////////////////////////////////////////////////////////////
<br/>
<br/>
void InterruptHandler(void) {
<br/>
  int t1, t2;
<br/>
  static int heartbeat = 0;
<br/>
<br/>
  if (IF &amp; IRQ_VBLANK) {
<br/>
    // Update the heartbeat
<br/>
    heartbeat++;
<br/>
    IPC-&gt;heartbeat = heartbeat;
<br/>
<br/>
    // Read the X/Y buttons and the /PENIRQ line
<br/>
    IPC-&gt;buttons = XKEYS;
<br/>
<br/>
    // Read the touch screen
<br/>
    IPC-&gt;touchX = touchRead(TSC_MEASURE_X);
<br/>
    IPC-&gt;touchY = touchRead(TSC_MEASURE_Y);
<br/>
    IPC-&gt;touchZ1 = touchRead(TSC_MEASURE_Z1);
<br/>
    IPC-&gt;touchZ2 = touchRead(TSC_MEASURE_Z2);
<br/>
<br/>
    // Read the time
<br/>
    rtcGetTime((uint8 *)IPC-&gt;curtime);
<br/>
    BCDToInteger((uint8 *)&amp;(IPC-&gt;curtime[1]), 7);
<br/>
 
<br/>
    // Read the temperature
<br/>
    IPC-&gt;temperature = touchReadTemperature(t1, t2);
<br/>
    IPC-&gt;tdiode1 = t1;
<br/>
    IPC-&gt;tdiode2 = t2;
<br/>
  }
<br/>
<br/>
  // Acknowledge interrupts
<br/>
  IF = IF;
<br/>
}
<br/>
<br/>
//////////////////////////////////////////////////////////////////////
<br/>
<br/>
int main(int argc, char ** argv) {
<br/>
  // Reset the clock if needed
<br/>
  rtcReset();
<br/>
<br/>
  // Set up the interrupt handler
<br/>
  IME = 0;
<br/>
  IRQ_HANDLER = &amp;InterruptHandler;
<br/>
  IE = IRQ_VBLANK;
<br/>
  IF = ~0;
<br/>
  DISP_SR = DISP_VBLANK_IRQ;
<br/>
  IME = 1;
<br/>
<br/>
  // Keep the ARM7 out of main RAM
<br/>
  while (1) swiWaitForVBlank();
<br/>
  return 0;
<br/>
}
<br/>
<br/>
//////////////////////////////////////////////////////////////////////
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
if your just using their example hello world code and modding that then that might be your answer, otherwise i'd guess that when you makefile it grabs an arm7 template that looks something like that *shrugs*</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#41138 - rize - Mon Apr 25, 2005 10:05 pm</h4>
    <div class="postbody"><span class="postbody">Ah, default arm7.  Thank you I didn't notice that.  It's probably included and linked in the makefile (or whatever).  Thanks.
<br/>
<br/>
That just leaves the following two questions:
<br/>
<br/>
Devoto used this line in helloworld:
<br/>
<br/>
videoSetMode(0); //not using the main screen
<br/>
<br/>
I didn't think videoSetMode had anything to do with a particular screen though.  And I didnt' set the mode again for the main screen which I have working in the modified demo.
<br/>
<br/>
Btw, don't worry about the trunc round thing.  I'm going to start a new thread because I have a lot of questions about the DS fixed point formats.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#41140 - josath - Mon Apr 25, 2005 10:23 pm</h4>
    <div class="postbody"><span class="postbody">there's:
<br/>
videoSetMode(MODE) - sets the screen mode for the main screen
<br/>
and
<br/>
videoSetModeSub(MODE) - sets the screen mode for the sub screen.
<br/>
<br/>
the two screens are separate. also they can be swapped (so the top screen could be main and the bottom sub, or you could swap it with lcdSwap() and have the top be the sub and the bottom be the main)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#41142 - rize - Mon Apr 25, 2005 10:29 pm</h4>
    <div class="postbody"><span class="postbody">in that case, the helloworld demo contains an error.  It uses the sub screen (which appears as the top) but uses a call to videoSetMode which is for main.
<br/>
<br/>
I imagine it works becuase the mode defaults to 0 anyway.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#41150 - Cleon I - Mon Apr 25, 2005 11:48 pm</h4>
    <div class="postbody"><span class="postbody">That sounds pretty similar to the issue of hardware/emulator differences discussed in <a class="postlink" href="http://forum.gbadev.org/viewtopic.php?t=5387&amp;sid=e4d97a380b7c23e2afcc1f36186f81c8" target="_blank">this thread</a>.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>dovoto wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
what causes the LCD to 2D core mapping is somewhat missunderstood at the moment. By default (POWER_CR set to all on) the main is assigned to the bottom and sub to the top. Bit 15 of power control will cause them to swap...but other bits of power control also seem to cause this swapping as well as certain combinations of screenmodes. More specific details should surface in next few days. For now just check your power control setting and if it is correct:
<br/>
<br/>
#ifdef EMULATOR
<br/>
lcdSwap();
<br/>
#endif
<br/>
<br/>
ugly but works.
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Maybe it's just an emulator problem?  Do you have the ability to test on hardware to see if you get the same result?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#41152 - rize - Mon Apr 25, 2005 11:58 pm</h4>
    <div class="postbody"><span class="postbody">Oh yeah; I understand that there are some issues about which screen is which and what the defaults are.
<br/>
<br/>
The error in dovoto's helloworld (unles I'm mistaken) is that he is setting up the screen marked as SUB but uses a call for the "MAIN" screen to set the video mode by accident.
<br/>
<br/>
Btw, I don't have the ability to use the DS itself yet (everyone's sold out of passthroughs!)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#41153 - josath - Tue Apr 26, 2005 12:05 am</h4>
    <div class="postbody"><span class="postbody">i don't think you understand....he's calling:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">        videoSetMode(0); </td> </tr></table><span class="postbody">
<br/>
to turn off the main screen and then
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">        videoSetModeSub(MODE_0_2D | DISPLAY_BG0_ACTIVE); </td> </tr></table><span class="postbody">
<br/>
<br/>
to set the sub screen to 2D Mode, with BG0 active. He then draws on the sub screen, which is set up.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#41155 - rize - Tue Apr 26, 2005 12:17 am</h4>
    <div class="postbody"><span class="postbody">Ah, I thought he was trying to set a mode FOR the sub screen.  Thanks for clearing that up.  The call to videoSetModeSub should have made that clear to me.
<br/>
<br/>
This is why I haven't moved beyond toying with Hello World yet... I didn't do any GBA dev so I'm still trying to master the basics.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
