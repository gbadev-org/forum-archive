<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Simple Context Switching Issues - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>DS development > Simple Context Switching Issues</h2>
<div id="posts">
<div class="post">
    <h4>#128272 - Sarev0k - Thu May 10, 2007 6:09 am</h4>
    <div class="postbody"><span class="postbody">Hello,
<br/>
<br/>
I'm new to the ARM platform and I've implemented a very simple context switcher, but I when I spin off my first thread the execution of my application becomes very sporadic.
<br/>
<br/>
Here's the code I'm using to switch out the current stack pointer and spin off my new thread.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">asm
<br/>
(
<br/>
   // changing the stack pointer to point to the new thread
<br/>
   "ldr sp, =thdCurrent\n"
<br/>
   "ldr sp, [sp]\n"
<br/>
   "ldr sp, [sp, #8]\n"
<br/>
<br/>
   // popping the current thread's context off the stack
<br/>
   "ldmfd sp!, {r0-r12, pc}\n"
<br/>
);
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Where thdCurrent is a global instance of a thread structure that I have pointing to the thread I wish to spin off.  In this structure I've dynamically allocated memory for the stack and positioned the address and the stack pointer such that once those items were all popped off the stack, that thread's entry function would be placed into my program counter and I would start executing my thread.
<br/>
<br/>
I'm able to get to that function just fine, however when I start using printf, the ANSI escape sequences (that allow me to position my console output) completely stop working.
<br/>
<br/>
Is there something fundamentally wrong with the way I'm trying to spin off my first thread?
<br/>
<br/>
Thanks in advance for your help.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#128290 - simonjhall - Thu May 10, 2007 9:16 am</h4>
    <div class="postbody"><span class="postbody">I dunno if it's related, but when I move $sp printf stops working properly for me (in particular print floats), so maybe this is somehow related?<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#128309 - tepples - Thu May 10, 2007 2:30 pm</h4>
    <div class="postbody"><span class="postbody">You can try to narrow it down to the floating-point library by using iprintf instead of printf. (The iprintf function is like printf, except iprintf doesn't handle floating-point formats.)<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#128348 - Sarev0k - Thu May 10, 2007 10:39 pm</h4>
    <div class="postbody"><span class="postbody">I've been playing around with how I'm spinning off my first thread and I've found that as long as I don't change my stack pointer the system doesn't behave erratically.  However, the moment I do change my stack pointer things start behaving strangely.
<br/>
<br/>
Is there some registers in some of the other processing modes I need to change in order to successfully spin off a thread?  All the examples I've seen do things with software interrupts, but is that really necessary to spin off a thread?</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
