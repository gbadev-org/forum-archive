<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Fixing a makefile to use maxmod - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>DS development > Fixing a makefile to use maxmod</h2>
<div id="posts">
<div class="post">
    <h4>#176208 - ant512 - Mon May 09, 2011 9:15 pm</h4>
    <div class="postbody"><span class="postbody">I posted this over at devkitpro.org but haven't had any replies as yet, so I thought I'd give it a try over here.
<br/>
<br/>
Can anyone tell me how to modify this makefile so that it converts all wav files in the directory "sfx" into a soundbank and includes that in the final ROM?  Makefiles really aren't my thing...
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
# WoopsiGfx Makefile                               ex:set ts=4 sw=4:
<br/>
# builds the WoopsiGfx test applications, and should be sufficient for most
<br/>
# needs - options are switched on/off with USE_ constants.
<br/>
<br/>
# set the texts that appear in the loader menus
<br/>
TEXT1       := Earth Shaker DS
<br/>
TEXT2       := Using WoopsiGfx
<br/>
TEXT3       := ant.simianzombie.com
<br/>
<br/>
# 4-bit-deep bitmap file to use as icon in loader menus
<br/>
ICON       := $(DEVKITPRO)/libwoopsigfx/icon/logo.bmp
<br/>
<br/>
#-------------------------------------------------------------------------------
<br/>
# TARGET is the name of the output file
<br/>
# BUILD is the directory where object files &amp; intermediate files will be placed
<br/>
# RELEASE is where the binary files will be placed
<br/>
# SOURCES is a list of directories containing source code
<br/>
# INCLUDES is a list of directories containing extra header files
<br/>
# DEFINES is a set of -Dsym[=value] settings to pass to the compilers
<br/>
#-------------------------------------------------------------------------------
<br/>
<br/>
TARGET      :=   $(shell basename $(CURDIR))
<br/>
BUILD      :=   build
<br/>
RELEASE     :=  Release
<br/>
SOURCES      :=   src src/bmp data gfx
<br/>
INCLUDES   :=   include include/bmp include/blocks include/levels
<br/>
DEFINES      :=
<br/>
<br/>
# we do *not* do -o thing - WinterMute points out that this stops our
<br/>
# resultant .nds from working on some loaders.  By default, ndstool puts boot
<br/>
# code into the wifi-logospace and since its not visible anywhere else, its
<br/>
# downright churlish for us to overwrite it.  If you want to, put it back, but
<br/>
# its not the default.
<br/>
# LOGO      := -o $(CURDIR)/../data/logo_wifi.bmp
<br/>
<br/>
#===============================================================================
<br/>
# options for code generation - unlikely you'll want to change this
<br/>
#===============================================================================
<br/>
<br/>
ARCH      :=   -mthumb-interwork
<br/>
<br/>
# uncomment to generate debugging information
<br/>
#MINUSG      :=   -g
<br/>
<br/>
# baseline flags for 
<br/>
CFLAGS      :=   $(MINUSG) $(ARCH) \
<br/>
            -Wall -O2 \
<br/>
            -mcpu=arm9tdmi -mtune=arm9tdmi -fomit-frame-pointer \
<br/>
            -ffast-math
<br/>
<br/>
CFLAGS      +=   -DARM9
<br/>
ASFLAGS      :=   $(MINUSG) $(ARCH)
<br/>
LDFLAGS      :=   $(MINUSG) $(ARCH) -mno-fpu
<br/>
<br/>
# enable dead-code stripping
<br/>
CFLAGS      +=   -ffunction-sections -fdata-sections
<br/>
LDFLAGS      +=   -Wl,--gc-sections
<br/>
<br/>
# link map (optional)
<br/>
# LDFLAGS      +=   -Wl,-Map,$(OUTPUT).map
<br/>
<br/>
#===============================================================================
<br/>
# no real need to edit anything past this point unless you need to add 
<br/>
# additional rules for different file extensions
<br/>
#===============================================================================
<br/>
<br/>
# disable all default rules
<br/>
.SUFFIXES:
<br/>
<br/>
# ensure that we can see the compiler toolset
<br/>
PATH       := $(DEVKITARM)/bin:$(PATH)
<br/>
<br/>
ifneq ($(BUILD),$(notdir $(CURDIR)))
<br/>
<br/>
# from here on, any symbols we want to propagate into the real build must be
<br/>
# exported - all the lines above the 'ifneq' are evaluated in both cases...
<br/>
<br/>
# directory name is used to construct the target.nds filename
<br/>
export OUTPUT   :=   $(CURDIR)/$(RELEASE)/$(TARGET)
<br/>
<br/>
# name the GNU toolset
<br/>
PREFIX         :=   arm-eabi-
<br/>
export CC      :=   $(PREFIX)gcc
<br/>
export CXX      :=   $(PREFIX)g++
<br/>
export AR      :=   $(PREFIX)ar
<br/>
export OBJCOPY   :=   $(PREFIX)objcopy
<br/>
export LD      :=   $(CXX)
<br/>
<br/>
# scan source directory for all possible source files (things we can turn into .o) 
<br/>
CFILES         :=   $(foreach dir,$(SOURCES),$(notdir $(wildcard $(dir)/*.c)))
<br/>
CPPFILES      :=   $(foreach dir,$(SOURCES),$(notdir $(wildcard $(dir)/*.cpp)))
<br/>
SFILES         :=   $(foreach dir,$(SOURCES),$(notdir $(wildcard $(dir)/*.s)))
<br/>
PCXFILES      :=   $(foreach dir,$(SOURCES),$(notdir $(wildcard $(dir)/*.pcx)))
<br/>
BINFILES      :=   $(foreach dir,$(SOURCES),$(notdir $(wildcard $(dir)/*.bin)))
<br/>
PALFILES      :=   $(foreach dir,$(SOURCES),$(notdir $(wildcard $(dir)/*.pal)))
<br/>
RAWFILES      :=   $(foreach dir,$(SOURCES),$(notdir $(wildcard $(dir)/*.raw)))
<br/>
MAPFILES      :=   $(foreach dir,$(SOURCES),$(notdir $(wildcard $(dir)/*.map)))
<br/>
JPEGFILES      :=   $(foreach dir,$(SOURCES),$(notdir $(wildcard $(dir)/*.jpg)))
<br/>
MODFILES      :=   $(foreach dir,$(SOURCES),$(notdir $(wildcard $(dir)/*.mod)))
<br/>
GIFFILES      :=   $(foreach dir,$(SOURCES),$(notdir $(wildcard $(dir)/*.gif)))
<br/>
BMPFILES      :=   $(foreach dir,$(SOURCES),$(notdir $(wildcard $(dir)/*.bmp)))
<br/>
<br/>
# build list of .o filenames 
<br/>
export OFILES   :=   $(MAPFILES:.map=.o) $(RAWFILES:.raw=.o) $(PALFILES:.pal=.o)\
<br/>
               $(BINFILES:.bin=.o) $(PCXFILES:.pcx=.o) $(JPEGFILES:.jpg=.o)\
<br/>
               $(MODFILES:.mod=.o) $(GIFFILES:.gif=.o) $(BMPFILES:.bmp=.o)\
<br/>
               $(CPPFILES:.cpp=.o) $(CFILES:.c=.o) $(SFILES:.s=.o)
<br/>
 
<br/>
#-------------------------------------------------------------------------------
<br/>
# standard magic to run the build from a build directory - this works because
<br/>
# we poke all the source directories into VPATH
<br/>
export VPATH   :=   $(foreach dir,$(SOURCES),$(CURDIR)/$(dir))
<br/>
<br/>
.PHONY: $(BUILD) clean rebuild
<br/>
 
<br/>
$(BUILD): $(CURDIR)/$(RELEASE)
<br/>
   @[ -d $@ ] || mkdir -p $@
<br/>
   @make --no-print-directory -C $(BUILD) -f $(CURDIR)/makefile
<br/>
<br/>
$(CURDIR)/$(RELEASE):
<br/>
   @-mkdir -p $(CURDIR)/$(RELEASE)
<br/>
 
<br/>
clean:
<br/>
   @echo Cleaning... $(TARGET)
<br/>
   @rm -fr $(BUILD) *.elf *.*ds* $(RELEASE)/*.*ds*
<br/>
 
<br/>
rebuild: clean $(BUILD)
<br/>
<br/>
#-------------------------------------------------------------------------------
<br/>
<br/>
else   # executing in the build directory
<br/>
 
<br/>
#-------------------------------------------------------------------------------
<br/>
# main targets
<br/>
#-------------------------------------------------------------------------------
<br/>
<br/>
$(OUTPUT).nds      :    $(OFILES)
<br/>
 
<br/>
#-------------------------------------------------------------------------------
<br/>
# every directory mentioned in INCLUDES and LIBDIRS is expected to have a corresponding
<br/>
# ./include directory which needs to be passed with -I to the C(++) compiler
<br/>
#-------------------------------------------------------------------------------
<br/>
LIBDIRS      += $(DEVKITPRO)/libnds
<br/>
LIBDIRS      += $(DEVKITPRO)/libwoopsigfx
<br/>
<br/>
# add all directories specified in INCLUDES and SOURCES
<br/>
_INCS      += $(foreach dir,$(INCLUDES),-I$(CURDIR)/../$(dir))
<br/>
_INCS      += $(foreach dir,$(SOURCES),-I$(CURDIR)/../$(dir))
<br/>
<br/>
# add all directories specified in LIBDIRS
<br/>
_INCS      += $(foreach dir,$(LIBDIRS),-I$(dir)/include)
<br/>
_INCS      += $(foreach dir,$(LIBDIRS),-I$(dir)/include/nds)
<br/>
<br/>
# and the build directory
<br/>
_INCS      += -I$(CURDIR)/$(BUILD)
<br/>
<br/>
#-------------------------------------------------------------------------------
<br/>
# every directory mentioned in LIBDIRS is expected to have a corresponding
<br/>
# ./lib directory which needs to be passed with -L to the linker
<br/>
#-------------------------------------------------------------------------------
<br/>
_LPATHS      :=   $(foreach dir,$(LIBDIRS),-L$(dir)/lib)
<br/>
<br/>
#-------------------------------------------------------------------------------
<br/>
# look at the various options that have been selected and switch in the
<br/>
# appropriate -D, -I, -l and -L options
<br/>
#-------------------------------------------------------------------------------
<br/>
<br/>
_DEFS      = $(DEFINES)
<br/>
<br/>
# use WoopsiGfx
<br/>
_INCS      += -I$(DEVKITPRO)/libwoopsigfx/include
<br/>
_LIBS      += -L$(DEVKITPRO)/libwoopsigfx/lib -lwoopsigfx
<br/>
<br/>
# and of course we need libnds
<br/>
_LIBS      += -lnds9
<br/>
<br/>
# this makes it easier to type the ndstool command line
<br/>
_BANNER       := -b $(ICON) "$(TEXT1);$(TEXT2);$(TEXT3)"
<br/>
<br/>
#-------------------------------------------------------------------------------
<br/>
# rule to build a .nds binary - forces the link every time because we don't have proper
<br/>
# dependencies in here...
<br/>
%.nds: $(OFILES)
<br/>
   @echo Linking...
<br/>
   @$(LD) $(LDFLAGS) -specs=ds_arm9.specs $(OFILES) $(_LPATHS) $(_LIBS) -o $(TARGET).elf
<br/>
   @$(OBJCOPY) -O binary $(TARGET).elf $(TARGET).bin
<br/>
   @ndstool -c $@ -9 $(TARGET).bin $(_ARM7BIN) $(LOGO) $(_BANNER)
<br/>
   @echo Built: $(notdir $(OUTPUT)).nds
<br/>
 
<br/>
#-------------------------------------------------------------------------------
<br/>
# rule to compile C++
<br/>
#
<br/>
%.o : %.cpp
<br/>
   @echo Compiling $(notdir $&lt;)
<br/>
   @$(CXX) -MMD -MF $*.d -MP $(CFLAGS) $(_DEFS) $(_INCS) -c $&lt; -o$@
<br/>
 
<br/>
#-------------------------------------------------------------------------------
<br/>
# rule to compile C
<br/>
#
<br/>
%.o : %.c
<br/>
   @echo Compiling $(notdir $&lt;)
<br/>
   @$(CC) -MMD -MF $*.d -MP $(CFLAGS) $(_DEFS) $(_INCS) -c $&lt; -o$@
<br/>
 
<br/>
#-------------------------------------------------------------------------------
<br/>
# rule to compile Assembler
<br/>
#
<br/>
%.o : %.s
<br/>
   @echo Assembling $(notdir $&lt;)
<br/>
   @$(CC) -MMD -MF $*.d -MP $(ASFLAGS) $(_DEFS) $(_INCS) -c $&lt; -o$@
<br/>
<br/>
#-------------------------------------------------------------------------------
<br/>
# utility function to convert arbitrary data file to .o
<br/>
#
<br/>
define bin2o
<br/>
   cp $(&lt;) $(*).tmp
<br/>
   $(OBJCOPY) -I binary -O elf32-littlearm -B arm \
<br/>
      --rename-section .data=.rodata \
<br/>
      --redefine-sym _binary_$*_tmp_start=$*\
<br/>
      --redefine-sym _binary_$*_tmp_end=$*_end\
<br/>
      --redefine-sym _binary_$*_tmp_size=$*_size\
<br/>
      $(*).tmp $(@)
<br/>
   echo "extern const u8" $(*)"[];" &gt; $(*).h
<br/>
   echo "extern const u32" $(*)_size[]";" &gt;&gt; $(*).h
<br/>
   rm $(*).tmp
<br/>
endef
<br/>
 
<br/>
#-------------------------------------------------------------------------------
<br/>
%.o   :   %.pcx
<br/>
#-------------------------------------------------------------------------------
<br/>
   @echo Converting $(notdir $&lt;)
<br/>
   @$(bin2o)
<br/>
 
<br/>
#-------------------------------------------------------------------------------
<br/>
%.o   :   %.bin
<br/>
#-------------------------------------------------------------------------------
<br/>
   @echo Converting $(notdir $&lt;)
<br/>
   @$(bin2o)
<br/>
 
<br/>
#-------------------------------------------------------------------------------
<br/>
%.o   :   %.raw
<br/>
#-------------------------------------------------------------------------------
<br/>
   @echo Converting $(notdir $&lt;)
<br/>
   @$(bin2o)
<br/>
 
<br/>
#-------------------------------------------------------------------------------
<br/>
%.o   :   %.pal
<br/>
#-------------------------------------------------------------------------------
<br/>
   @echo Converting $(notdir $&lt;)
<br/>
   @$(bin2o)
<br/>
 
<br/>
#-------------------------------------------------------------------------------
<br/>
%.o   :   %.map
<br/>
#-------------------------------------------------------------------------------
<br/>
   @echo Converting $(notdir $&lt;)
<br/>
   @$(bin2o)
<br/>
<br/>
#-------------------------------------------------------------------------------
<br/>
%.o   :   %.mdl
<br/>
#-------------------------------------------------------------------------------
<br/>
   @echo Converting $(notdir $&lt;)
<br/>
   @$(bin2o)
<br/>
<br/>
#-------------------------------------------------------------------------------
<br/>
%.o   :   %.jpg
<br/>
#-------------------------------------------------------------------------------
<br/>
   @echo Converting $(notdir $&lt;)
<br/>
   @$(bin2o)
<br/>
<br/>
#-------------------------------------------------------------------------------
<br/>
%.o   :   %.mod
<br/>
#-------------------------------------------------------------------------------
<br/>
   @echo Converting $(notdir $&lt;)
<br/>
   @$(bin2o)
<br/>
<br/>
#-------------------------------------------------------------------------------
<br/>
%.o   :   %.gif
<br/>
#-------------------------------------------------------------------------------
<br/>
   @echo Converting $(notdir $&lt;)
<br/>
   @$(bin2o)
<br/>
<br/>
#-------------------------------------------------------------------------------
<br/>
%.o   :   %.bmp
<br/>
#-------------------------------------------------------------------------------
<br/>
   @echo Converting $(notdir $&lt;)
<br/>
   @$(bin2o)
<br/>
<br/>
#-------------------------------------------------------------------------------
<br/>
# now include all the dependency files, one per object file - we assume that the
<br/>
# .d file is next to the .o file, which is what our C/C++/Assembler rules are
<br/>
# set up to do...
<br/>
#
<br/>
DEPENDS   := $(OFILES:.o=.d)
<br/>
-include $(DEPENDS) 
<br/>
<br/>
endif
<br/>
<br/>
################################################################################
<br/>
# This makefile the following environment variables
<br/>
#
<br/>
# $(DEVKITPRO) points to your devkitPro environment
<br/>
# $(DEVKITARM) points to the ARM toolset
<br/>
#
<br/>
################################################################################
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#176211 - SchmendrickSchmuck - Wed May 11, 2011 11:34 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
# WoopsiGfx Makefile                               ex:set ts=4 sw=4:
<br/>
# builds the WoopsiGfx test applications, and should be sufficient for most
<br/>
# needs - options are switched on/off with USE_ constants.
<br/>
<br/>
# set the texts that appear in the loader menus
<br/>
TEXT1       := Earth Shaker DS
<br/>
TEXT2       := Using WoopsiGfx
<br/>
TEXT3       := ant.simianzombie.com
<br/>
<br/>
# 4-bit-deep bitmap file to use as icon in loader menus
<br/>
ICON       := $(DEVKITPRO)/libwoopsigfx/icon/logo.bmp
<br/>
<br/>
#-------------------------------------------------------------------------------
<br/>
# TARGET is the name of the output file
<br/>
# BUILD is the directory where object files &amp; intermediate files will be placed
<br/>
# RELEASE is where the binary files will be placed
<br/>
# SOURCES is a list of directories containing source code
<br/>
# INCLUDES is a list of directories containing extra header files
<br/>
# DEFINES is a set of -Dsym[=value] settings to pass to the compilers
<br/>
#-------------------------------------------------------------------------------
<br/>
<br/>
TARGET      :=   $(shell basename $(CURDIR))
<br/>
BUILD      :=   build
<br/>
RELEASE     :=  Release
<br/>
SOURCES      :=   src src/bmp data gfx
<br/>
INCLUDES   :=   include include/bmp include/blocks include/levels
<br/>
DEFINES      :=
<br/>
MUSIC       :=  sfx
<br/>
<br/>
# we do *not* do -o thing - WinterMute points out that this stops our
<br/>
# resultant .nds from working on some loaders.  By default, ndstool puts boot
<br/>
# code into the wifi-logospace and since its not visible anywhere else, its
<br/>
# downright churlish for us to overwrite it.  If you want to, put it back, but
<br/>
# its not the default.
<br/>
# LOGO      := -o $(CURDIR)/../data/logo_wifi.bmp
<br/>
<br/>
#===============================================================================
<br/>
# options for code generation - unlikely you'll want to change this
<br/>
#===============================================================================
<br/>
<br/>
ARCH      :=   -mthumb-interwork
<br/>
<br/>
# uncomment to generate debugging information
<br/>
#MINUSG      :=   -g
<br/>
<br/>
# baseline flags for 
<br/>
CFLAGS      :=   $(MINUSG) $(ARCH) \
<br/>
            -Wall -O2 \
<br/>
            -mcpu=arm9tdmi -mtune=arm9tdmi -fomit-frame-pointer \
<br/>
            -ffast-math
<br/>
<br/>
CFLAGS      +=   -DARM9
<br/>
ASFLAGS      :=   $(MINUSG) $(ARCH)
<br/>
LDFLAGS      :=   $(MINUSG) $(ARCH) -mno-fpu
<br/>
<br/>
# enable dead-code stripping
<br/>
CFLAGS      +=   -ffunction-sections -fdata-sections
<br/>
LDFLAGS      +=   -Wl,--gc-sections
<br/>
<br/>
# link map (optional)
<br/>
# LDFLAGS      +=   -Wl,-Map,$(OUTPUT).map
<br/>
<br/>
#===============================================================================
<br/>
# no real need to edit anything past this point unless you need to add 
<br/>
# additional rules for different file extensions
<br/>
#===============================================================================
<br/>
<br/>
# disable all default rules
<br/>
.SUFFIXES:
<br/>
<br/>
# ensure that we can see the compiler toolset
<br/>
PATH       := $(DEVKITARM)/bin:$(PATH)
<br/>
<br/>
ifneq ($(BUILD),$(notdir $(CURDIR)))
<br/>
<br/>
# from here on, any symbols we want to propagate into the real build must be
<br/>
# exported - all the lines above the 'ifneq' are evaluated in both cases...
<br/>
<br/>
# directory name is used to construct the target.nds filename
<br/>
export OUTPUT   :=   $(CURDIR)/$(RELEASE)/$(TARGET)
<br/>
<br/>
# name the GNU toolset
<br/>
PREFIX         :=   arm-eabi-
<br/>
export CC      :=   $(PREFIX)gcc
<br/>
export CXX      :=   $(PREFIX)g++
<br/>
export AR      :=   $(PREFIX)ar
<br/>
export OBJCOPY   :=   $(PREFIX)objcopy
<br/>
export LD      :=   $(CXX)
<br/>
<br/>
# scan source directory for all possible source files (things we can turn into .o) 
<br/>
CFILES         :=   $(foreach dir,$(SOURCES),$(notdir $(wildcard $(dir)/*.c)))
<br/>
CPPFILES      :=   $(foreach dir,$(SOURCES),$(notdir $(wildcard $(dir)/*.cpp)))
<br/>
SFILES         :=   $(foreach dir,$(SOURCES),$(notdir $(wildcard $(dir)/*.s)))
<br/>
PCXFILES      :=   $(foreach dir,$(SOURCES),$(notdir $(wildcard $(dir)/*.pcx)))
<br/>
PALFILES      :=   $(foreach dir,$(SOURCES),$(notdir $(wildcard $(dir)/*.pal)))
<br/>
RAWFILES      :=   $(foreach dir,$(SOURCES),$(notdir $(wildcard $(dir)/*.raw)))
<br/>
MAPFILES      :=   $(foreach dir,$(SOURCES),$(notdir $(wildcard $(dir)/*.map)))
<br/>
JPEGFILES      :=   $(foreach dir,$(SOURCES),$(notdir $(wildcard $(dir)/*.jpg)))
<br/>
MODFILES      :=   $(foreach dir,$(SOURCES),$(notdir $(wildcard $(dir)/*.mod)))
<br/>
GIFFILES      :=   $(foreach dir,$(SOURCES),$(notdir $(wildcard $(dir)/*.gif)))
<br/>
BMPFILES      :=   $(foreach dir,$(SOURCES),$(notdir $(wildcard $(dir)/*.bmp)))
<br/>
BINFILES   :=   $(foreach dir,$(SOURCES),$(notdir $(wildcard $(dir)/*.*))) soundbank.bin
<br/>
 
<br/>
export AUDIOFILES   :=   $(foreach dir,$(notdir $(wildcard $(MUSIC)/*.*)),$(CURDIR)/$(MUSIC)/$(dir))
<br/>
<br/>
# build list of .o filenames 
<br/>
export OFILES   :=   $(MAPFILES:.map=.o) $(RAWFILES:.raw=.o) $(PALFILES:.pal=.o)\
<br/>
               $(BINFILES:.bin=.o) $(PCXFILES:.pcx=.o) $(JPEGFILES:.jpg=.o)\
<br/>
               $(MODFILES:.mod=.o) $(GIFFILES:.gif=.o) $(BMPFILES:.bmp=.o)\
<br/>
               $(CPPFILES:.cpp=.o) $(CFILES:.c=.o) $(SFILES:.s=.o)
<br/>
 
<br/>
#-------------------------------------------------------------------------------
<br/>
# standard magic to run the build from a build directory - this works because
<br/>
# we poke all the source directories into VPATH
<br/>
export VPATH   :=   $(foreach dir,$(SOURCES),$(CURDIR)/$(dir))
<br/>
<br/>
.PHONY: $(BUILD) clean rebuild
<br/>
 
<br/>
$(BUILD): $(CURDIR)/$(RELEASE)
<br/>
   @[ -d $@ ] || mkdir -p $@
<br/>
   @make --no-print-directory -C $(BUILD) -f $(CURDIR)/makefile
<br/>
<br/>
$(CURDIR)/$(RELEASE):
<br/>
   @-mkdir -p $(CURDIR)/$(RELEASE)
<br/>
 
<br/>
clean:
<br/>
   @echo Cleaning... $(TARGET)
<br/>
   @rm -fr $(BUILD) *.elf *.*ds* $(RELEASE)/*.*ds*
<br/>
 
<br/>
rebuild: clean $(BUILD)
<br/>
<br/>
#-------------------------------------------------------------------------------
<br/>
<br/>
else   # executing in the build directory
<br/>
 
<br/>
#-------------------------------------------------------------------------------
<br/>
# main targets
<br/>
#-------------------------------------------------------------------------------
<br/>
<br/>
$(OUTPUT).nds      :    $(OFILES)
<br/>
 
<br/>
#---------------------------------------------------------------------------------
<br/>
# rule to build soundbank from music files
<br/>
#---------------------------------------------------------------------------------
<br/>
soundbank.bin : $(AUDIOFILES)
<br/>
#---------------------------------------------------------------------------------
<br/>
   @mmutil $^ -d -osoundbank.bin -hsoundbank.h
<br/>
<br/>
#-------------------------------------------------------------------------------
<br/>
# every directory mentioned in INCLUDES and LIBDIRS is expected to have a corresponding
<br/>
# ./include directory which needs to be passed with -I to the C(++) compiler
<br/>
#-------------------------------------------------------------------------------
<br/>
LIBDIRS      += $(DEVKITPRO)/libnds
<br/>
LIBDIRS      += $(DEVKITPRO)/libwoopsigfx
<br/>
<br/>
# add all directories specified in INCLUDES and SOURCES
<br/>
_INCS      += $(foreach dir,$(INCLUDES),-I$(CURDIR)/../$(dir))
<br/>
_INCS      += $(foreach dir,$(SOURCES),-I$(CURDIR)/../$(dir))
<br/>
<br/>
# add all directories specified in LIBDIRS
<br/>
_INCS      += $(foreach dir,$(LIBDIRS),-I$(dir)/include)
<br/>
_INCS      += $(foreach dir,$(LIBDIRS),-I$(dir)/include/nds)
<br/>
<br/>
# and the build directory
<br/>
_INCS      += -I$(CURDIR)/$(BUILD)
<br/>
<br/>
#-------------------------------------------------------------------------------
<br/>
# every directory mentioned in LIBDIRS is expected to have a corresponding
<br/>
# ./lib directory which needs to be passed with -L to the linker
<br/>
#-------------------------------------------------------------------------------
<br/>
_LPATHS      :=   $(foreach dir,$(LIBDIRS),-L$(dir)/lib)
<br/>
<br/>
#-------------------------------------------------------------------------------
<br/>
# look at the various options that have been selected and switch in the
<br/>
# appropriate -D, -I, -l and -L options
<br/>
#-------------------------------------------------------------------------------
<br/>
<br/>
_DEFS      = $(DEFINES)
<br/>
<br/>
# use WoopsiGfx
<br/>
_INCS      += -I$(DEVKITPRO)/libwoopsigfx/include
<br/>
_LIBS      += -L$(DEVKITPRO)/libwoopsigfx/lib -lwoopsigfx
<br/>
<br/>
# and of course we need libnds
<br/>
_LIBS      += -lnds9 -lmm9
<br/>
<br/>
# this makes it easier to type the ndstool command line
<br/>
_BANNER       := -b $(ICON) "$(TEXT1);$(TEXT2);$(TEXT3)"
<br/>
<br/>
#-------------------------------------------------------------------------------
<br/>
# rule to build a .nds binary - forces the link every time because we don't have proper
<br/>
# dependencies in here...
<br/>
%.nds: $(OFILES)
<br/>
   @echo Linking...
<br/>
   @$(LD) $(LDFLAGS) -specs=ds_arm9.specs $(OFILES) $(_LPATHS) $(_LIBS) -o $(TARGET).elf
<br/>
   @$(OBJCOPY) -O binary $(TARGET).elf $(TARGET).bin
<br/>
   @ndstool -c $@ -9 $(TARGET).bin $(_ARM7BIN) $(LOGO) $(_BANNER)
<br/>
   @echo Built: $(notdir $(OUTPUT)).nds
<br/>
 
<br/>
#-------------------------------------------------------------------------------
<br/>
# rule to compile C++
<br/>
#
<br/>
%.o : %.cpp
<br/>
   @echo Compiling $(notdir $&lt;)
<br/>
   @$(CXX) -MMD -MF $*.d -MP $(CFLAGS) $(_DEFS) $(_INCS) -c $&lt; -o$@
<br/>
 
<br/>
#-------------------------------------------------------------------------------
<br/>
# rule to compile C
<br/>
#
<br/>
%.o : %.c
<br/>
   @echo Compiling $(notdir $&lt;)
<br/>
   @$(CC) -MMD -MF $*.d -MP $(CFLAGS) $(_DEFS) $(_INCS) -c $&lt; -o$@
<br/>
 
<br/>
#-------------------------------------------------------------------------------
<br/>
# rule to compile Assembler
<br/>
#
<br/>
%.o : %.s
<br/>
   @echo Assembling $(notdir $&lt;)
<br/>
   @$(CC) -MMD -MF $*.d -MP $(ASFLAGS) $(_DEFS) $(_INCS) -c $&lt; -o$@
<br/>
<br/>
#-------------------------------------------------------------------------------
<br/>
# utility function to convert arbitrary data file to .o
<br/>
#
<br/>
define bin2o
<br/>
   cp $(&lt;) $(*).tmp
<br/>
   $(OBJCOPY) -I binary -O elf32-littlearm -B arm \
<br/>
      --rename-section .data=.rodata \
<br/>
      --redefine-sym _binary_$*_tmp_start=$*\
<br/>
      --redefine-sym _binary_$*_tmp_end=$*_end\
<br/>
      --redefine-sym _binary_$*_tmp_size=$*_size\
<br/>
      $(*).tmp $(@)
<br/>
   echo "extern const u8" $(*)"[];" &gt; $(*).h
<br/>
   echo "extern const u32" $(*)_size[]";" &gt;&gt; $(*).h
<br/>
   rm $(*).tmp
<br/>
endef
<br/>
 
<br/>
#-------------------------------------------------------------------------------
<br/>
%.o   :   %.pcx
<br/>
#-------------------------------------------------------------------------------
<br/>
   @echo Converting $(notdir $&lt;)
<br/>
   @$(bin2o)
<br/>
 
<br/>
#-------------------------------------------------------------------------------
<br/>
%.o   :   %.bin
<br/>
#-------------------------------------------------------------------------------
<br/>
   @echo Converting $(notdir $&lt;)
<br/>
   @$(bin2o)
<br/>
 
<br/>
#-------------------------------------------------------------------------------
<br/>
%.o   :   %.raw
<br/>
#-------------------------------------------------------------------------------
<br/>
   @echo Converting $(notdir $&lt;)
<br/>
   @$(bin2o)
<br/>
 
<br/>
#-------------------------------------------------------------------------------
<br/>
%.o   :   %.pal
<br/>
#-------------------------------------------------------------------------------
<br/>
   @echo Converting $(notdir $&lt;)
<br/>
   @$(bin2o)
<br/>
 
<br/>
#-------------------------------------------------------------------------------
<br/>
%.o   :   %.map
<br/>
#-------------------------------------------------------------------------------
<br/>
   @echo Converting $(notdir $&lt;)
<br/>
   @$(bin2o)
<br/>
<br/>
#-------------------------------------------------------------------------------
<br/>
%.o   :   %.mdl
<br/>
#-------------------------------------------------------------------------------
<br/>
   @echo Converting $(notdir $&lt;)
<br/>
   @$(bin2o)
<br/>
<br/>
#-------------------------------------------------------------------------------
<br/>
%.o   :   %.jpg
<br/>
#-------------------------------------------------------------------------------
<br/>
   @echo Converting $(notdir $&lt;)
<br/>
   @$(bin2o)
<br/>
<br/>
#-------------------------------------------------------------------------------
<br/>
%.o   :   %.mod
<br/>
#-------------------------------------------------------------------------------
<br/>
   @echo Converting $(notdir $&lt;)
<br/>
   @$(bin2o)
<br/>
<br/>
#-------------------------------------------------------------------------------
<br/>
%.o   :   %.gif
<br/>
#-------------------------------------------------------------------------------
<br/>
   @echo Converting $(notdir $&lt;)
<br/>
   @$(bin2o)
<br/>
<br/>
#-------------------------------------------------------------------------------
<br/>
%.o   :   %.bmp
<br/>
#-------------------------------------------------------------------------------
<br/>
   @echo Converting $(notdir $&lt;)
<br/>
   @$(bin2o)
<br/>
<br/>
#-------------------------------------------------------------------------------
<br/>
# now include all the dependency files, one per object file - we assume that the
<br/>
# .d file is next to the .o file, which is what our C/C++/Assembler rules are
<br/>
# set up to do...
<br/>
#
<br/>
DEPENDS   := $(OFILES:.o=.d)
<br/>
-include $(DEPENDS) 
<br/>
<br/>
endif
<br/>
<br/>
################################################################################
<br/>
# This makefile the following environment variables
<br/>
#
<br/>
# $(DEVKITPRO) points to your devkitPro environment
<br/>
# $(DEVKITARM) points to the ARM toolset
<br/>
#
<br/>
################################################################################
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
That should do it. Note that I'm not exactly all that well-known in the area of makefiles, but I pasted in the parts of code that I use for maxmod.
<br/>
<br/>
Changes:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
SOURCES      :=   src src/bmp data gfx 
<br/>
INCLUDES   :=   include include/bmp include/blocks include/levels 
<br/>
DEFINES      := 
<br/>
[b]MUSIC       :=  sfx[/b]
<br/>
<br/>
[...]
<br/>
<br/>
GIFFILES      :=   $(foreach dir,$(SOURCES),$(notdir $(wildcard $(dir)/*.gif)))
<br/>
BMPFILES      :=   $(foreach dir,$(SOURCES),$(notdir $(wildcard $(dir)/*.bmp)))
<br/>
[b]BINFILES   :=   $(foreach dir,$(SOURCES),$(notdir $(wildcard $(dir)/*.*))) soundbank.bin
<br/>
 
<br/>
export AUDIOFILES   :=   $(foreach dir,$(notdir $(wildcard $(MUSIC)/*.*)),$(CURDIR)/$(MUSIC)/$(dir))[/b]
<br/>
<br/>
[...]
<br/>
<br/>
#-------------------------------------------------------------------------------
<br/>
# main targets
<br/>
#-------------------------------------------------------------------------------
<br/>
<br/>
$(OUTPUT).nds      :    $(OFILES)
<br/>
 
<br/>
[b]#---------------------------------------------------------------------------------
<br/>
# rule to build soundbank from music files
<br/>
#---------------------------------------------------------------------------------
<br/>
soundbank.bin : $(AUDIOFILES)
<br/>
#---------------------------------------------------------------------------------
<br/>
   @mmutil $^ -d -osoundbank.bin -hsoundbank.h[/b]
<br/>
<br/>
[...]
<br/>
<br/>
# use WoopsiGfx
<br/>
_INCS      += -I$(DEVKITPRO)/libwoopsigfx/include
<br/>
_LIBS      += -L$(DEVKITPRO)/libwoopsigfx/lib -lwoopsigfx
<br/>
<br/>
# and of course we need libnds
<br/>
_LIBS      += -lnds9 [b]-lmm9[/b]
<br/>
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
If I missed anything, I'm sure someone else will be able to help you out. I must say your makefile seems a little overkill, perhaps because you don't have the 'include $(DEVKITARM)/ds_rules' part or something; my makefile's a lot shorter.<br/>_________________<br/><a href="http://DSLiero.DennisvanZwieten.com" target="_blank">http://DSLiero.DennisvanZwieten.com</a> - Liero for NDS!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#176212 - ant512 - Thu May 12, 2011 9:33 am</h4>
    <div class="postbody"><span class="postbody">Thanks very much for that, I'll give it a go.  The makefile probably contains a lot of junk that the PALib guys put in, as I think I got the original from there.  Various other people have changed it over time.  I tried to replace it with a makefile from the libnds maxmod examples but kept coming across weird errors.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
