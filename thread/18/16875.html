<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Trying to display a buffer from main memory - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>DS development > Trying to display a buffer from main memory</h2>
<div id="posts">
<div class="post">
    <h4>#170377 - DiscoStew - Sun Sep 20, 2009 8:54 am</h4>
    <div class="postbody"><span class="postbody">This is what I have currently...
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">int main(void) {
<br/>
<br/>
   lcdMainOnTop();
<br/>
<br/>
   u16 *mmBuffer = new u16[ 256 * 192 ];
<br/>
   for( int y = 0; y &lt; 192; y++ )
<br/>
   {
<br/>
      for( int x = 0; x &lt; 256; x++ )
<br/>
      {
<br/>
         if( y &amp; 0x10 )
<br/>
            mmBuffer[ x + ( y * 256 ) ] = ( 0x1F &lt;&lt; 0 ) | ( 0x00 &lt;&lt; 5 ) | ( 0x00 &lt;&lt; 10 );
<br/>
         else
<br/>
            mmBuffer[ x + ( y * 256 ) ] = ( 0x1F &lt;&lt; 0 ) | ( 0x1F &lt;&lt; 5 ) | ( 0x00 &lt;&lt; 10 );
<br/>
      }
<br/>
   }
<br/>
<br/>
   videoSetMode( MODE_FIFO );
<br/>
<br/>
   while( 1 ) {
<br/>
      swiWaitForVBlank();
<br/>
<br/>
      DMA0_SRC = (u32)mmBuffer;
<br/>
      DMA0_DEST = REG_DISP_MMEM_FIFO;
<br/>
      DMA0_CR = DMA_DISP_FIFO | DMA_32_BIT | DMA_ENABLE | 4;
<br/>
      
<br/>
   }
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
What this should do is display red and yellow bars across the screen. But that's not the case I'm seeing. On emu, I get a white screen, and on hardware, I get a black screen. Anyone know what I'm doing wrong?
<br/>
<br/>
Setup info was taken from <a class="postlink" href="http://nocash.emubase.de/gbatek.htm#dsvideocaptureandmainmemorydisplaymode" target="_blank">GBATek</a> (after the Video Capture section)<br/>_________________<br/><span style="font-weight: bold">DS</span> - It's all about <span style="font-weight: bold">D</span>isco<span style="font-weight: bold">S</span>tew</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170378 - headspin - Sun Sep 20, 2009 9:27 am</h4>
    <div class="postbody"><span class="postbody">If your in X1B5G5R5 mode bit 15 is a single alpha bit. So you need to OR in BIT(15) or (1 &lt;&lt; 15).<br/>_________________<br/><a class="postlink" href="http://headsoft.com.au/index.php?category=warhawk" target="_blank">Warhawk DS</a> | <a class="postlink" href="http://headsoft.com.au/index.php?category=mmll" target="_blank">Manic Miner: The Lost Levels</a> | <a class="postlink" href="http://headsoft.com.au/index.php?category=tdg" target="_blank">The Detective Game</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170381 - DiscoStew - Sun Sep 20, 2009 5:18 pm</h4>
    <div class="postbody"><span class="postbody">There is no alpha bit when using the Main Memory Display, at least that's what it says in GBATek. Nevertheless, I tried it. Nothing changed.<br/>_________________<br/><span style="font-weight: bold">DS</span> - It's all about <span style="font-weight: bold">D</span>isco<span style="font-weight: bold">S</span>tew</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170384 - headspin - Sun Sep 20, 2009 7:16 pm</h4>
    <div class="postbody"><span class="postbody">Ah yes I see
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">The FIFO can receive 4 words (8 pixels) at a time, each pixel is a 15bit RGB value (the upper bit, bit15, is unused)</td> </tr></table><span class="postbody">
<br/>
<br/>
I've never played with that video mode so I can't help sorry.<br/>_________________<br/><a class="postlink" href="http://headsoft.com.au/index.php?category=warhawk" target="_blank">Warhawk DS</a> | <a class="postlink" href="http://headsoft.com.au/index.php?category=mmll" target="_blank">Manic Miner: The Lost Levels</a> | <a class="postlink" href="http://headsoft.com.au/index.php?category=tdg" target="_blank">The Detective Game</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170386 - Miked0801 - Sun Sep 20, 2009 7:21 pm</h4>
    <div class="postbody"><span class="postbody">I'll take a look on Monday if no one here has an answer.  We've done some video mode capture stuff and I may be able to offer some insight then...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170388 - DekuTree64 - Sun Sep 20, 2009 9:20 pm</h4>
    <div class="postbody"><span class="postbody">Have you tried different DMA channels? On GBA, only DMA 1 and 2 are wired to be able to trigger by the sound FIFOs. Display FIFO might have a special channel too.
<br/>
<br/>
EDIT: Oh, and don't you need to set the dest mode to fixed address since the FIFO is only one register?<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170391 - DiscoStew - Mon Sep 21, 2009 12:51 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>DekuTree64 wrote:</b></span></td> </tr> <tr> <td class="quote">Have you tried different DMA channels? On GBA, only DMA 1 and 2 are wired to be able to trigger by the sound FIFOs. Display FIFO might have a special channel too.
<br/>
<br/>
EDIT: Oh, and don't you need to set the dest mode to fixed address since the FIFO is only one register?</td> </tr></table><span class="postbody">
<br/>
<br/>
I tried each of the 4 channels, but they all gave me the same result.
<br/>
<br/>
As far as the fixed destination address is concerned, I wasn't sure if that was needed, because I had thought that by setting the control to Main Memory Display, it would do that itself. But, it doesn't hurt to try. Unfortunately, it changed nothing.<br/>_________________<br/><span style="font-weight: bold">DS</span> - It's all about <span style="font-weight: bold">D</span>isco<span style="font-weight: bold">S</span>tew</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170428 - DiscoStew - Wed Sep 23, 2009 5:47 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Miked0801 wrote:</b></span></td> </tr> <tr> <td class="quote">I'll take a look on Monday if no one here has an answer.  We've done some video mode capture stuff and I may be able to offer some insight then...</td> </tr></table><span class="postbody">
<br/>
<br/>
Any progress? I've been trying out a couple of different things, including the method described by GBATek of having the Main Memory Display as Source B in capturing, and having the main display showing the contents of a particular VRAM bank (frame buffer mode). Excluding the line for the display capture, the frame buffer shows the content of the vram bank, but once I include that line, it's back to showing nothing.  :(
<br/>
<br/>
I have a feeling that something is missing in the set up, but I have no idea what it is.<br/>_________________<br/><span style="font-weight: bold">DS</span> - It's all about <span style="font-weight: bold">D</span>isco<span style="font-weight: bold">S</span>tew</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170429 - sverx - Wed Sep 23, 2009 6:26 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>DiscoStew wrote:</b></span></td> </tr> <tr> <td class="quote">I have a feeling that something is missing in the set up, but I have no idea what it is.</td> </tr></table><span class="postbody">
<br/>
<br/>
DMA transfer length? (how many words should be moved...)
<br/>
<a href="http://nocash.emubase.de/gbatek.htm#gbadmatransfers" target="_blank">http://nocash.emubase.de/gbatek.htm#gbadmatransfers</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170430 - DiscoStew - Wed Sep 23, 2009 10:43 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>sverx wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>DiscoStew wrote:</b></span></td> </tr> <tr> <td class="quote">I have a feeling that something is missing in the set up, but I have no idea what it is.</td> </tr></table><span class="postbody">
<br/>
<br/>
DMA transfer length? (how many words should be moved...)
<br/>
<a href="http://nocash.emubase.de/gbatek.htm#gbadmatransfers" target="_blank">http://nocash.emubase.de/gbatek.htm#gbadmatransfers</a></span></td> </tr></table><span class="postbody">
<br/>
<br/>
It says to set it to 4, as that is how many words can fit into the FIFO (8 pixels per go). With that, and setting the mode to Main Memory Display, it is to start when it is requested, and continues to copy in 4 words each time until the screen is refreshed (at scanline 192 if I'm not mistaken).<br/>_________________<br/><span style="font-weight: bold">DS</span> - It's all about <span style="font-weight: bold">D</span>isco<span style="font-weight: bold">S</span>tew</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170431 - Miked0801 - Wed Sep 23, 2009 11:05 pm</h4>
    <div class="postbody"><span class="postbody">Got nothing for you.  The only times we do screen capture stuff, we're using API calls to handle it.  Sorry.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170432 - Cydrak - Wed Sep 23, 2009 11:28 pm</h4>
    <div class="postbody"><span class="postbody">Yeah, this isn't well emulated. I found some old code kicking around that mentions the same whitescreens. Display capture (especially the "background" form of it, which is the apparent purpose of these modes) often gives emulators fits as well. Is that the use you had in mind?
<br/>
<br/>
As for the setup, I can't imagine any possible way this could be a single transfer. The FIFO wants 4 words at a time, so surely it must be hand-feeding it throughout the frame? In other words, it sounds a lot like HDMA: you'd want DMA_DST_FIX and DMA_REPEAT. (I suppose the GBA did special-case a few things, but the ARM9 channels look pretty generic to me.)
<br/>
<br/>
Okay, see if this works better:</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">    swiWaitForVBlank();
<br/>
      
<br/>
    DMA0_CR = 0;
<br/>
    DMA0_SRC = (u32)mmBuffer; 
<br/>
    DMA0_DEST = (u32)&amp;REG_DISP_MMEM_FIFO;
<br/>
    DMA0_CR = DMA_ENABLE | DMA_DISP_FIFO | DMA_REPEAT | DMA_DST_FIX | DMA_32_BIT | 4;</td> </tr></table><span class="postbody">The repeat will keep it enabled, if my memory serves. You might need to forcibly toggle DMA0_CR to reinitialize the address each frame. Also, check that address--REG_DISP_MMEM_FIFO looks to be an lvalue, not a pointer.
<br/>
<br/>
As I said--it's almost certainly hand-feeding the display. This has some implications, and (just possibly) a significant caveat. With 8 pixel transfers, and the 33MHz/6 pixel clock, it's going to kick in every 48 bus cycles. And assuming those <span style="font-style: italic">lovely</span> 10,2 timings, that would be 16 cycles--or 33% of the bus cycles outside of blanking periods. In theory, anyhow, I never timed it.
<br/>
<br/>
If that doesn't give you pause, here's the real gotcha. Consider that when I tried this, libnds was still using the old IPC struct. What do you suppose happens if the ARM7 goes anywhere near the RAM while this DMA is running? :-)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170433 - DiscoStew - Thu Sep 24, 2009 12:13 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Cydrak wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">DMA0_DEST = (u32)&amp;REG_DISP_MMEM_FIFO;</td> </tr></table><span class="postbody"></span></td> </tr></table><span class="postbody">
<br/>
<br/>
That was it! This whole time, I thought the #define was a pointer, but after you mentioned it, I checked it again, and saw that you were right. I made that single change, and while it doesn't seems to work on No$GBA (probably because it isn't emulated), it is indeed working on hardware. Thank you very much. If I remember correctly, iDeas may have this emulated somewhat, so I might as well check with that as well.
<br/>
<br/>
An interesting thing I saw after getting it all working is the unusual side-effect if you don't use DMA_REPEAT. As my code above was laid out so that there are horizontal strips of yellow and red, if DMA_REPEAT isn't used, then what ends up showing are thinner "vertical" strips of yellow and red. Then, I tested with 4 different color strips to see what would happen, and it ended up doing the same thing, but only the 1st and 4th colors were showing up. It was fun to see nonetheless.<br/>_________________<br/><span style="font-weight: bold">DS</span> - It's all about <span style="font-weight: bold">D</span>isco<span style="font-weight: bold">S</span>tew</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170436 - headspin - Thu Sep 24, 2009 8:45 pm</h4>
    <div class="postbody"><span class="postbody">Cearn's DMA article might be of interest to you
<br/>
<br/>
<a href="http://www.coranac.com/tonc/text/dma.htm" target="_blank">http://www.coranac.com/tonc/text/dma.htm</a><br/>_________________<br/><a class="postlink" href="http://headsoft.com.au/index.php?category=warhawk" target="_blank">Warhawk DS</a> | <a class="postlink" href="http://headsoft.com.au/index.php?category=mmll" target="_blank">Manic Miner: The Lost Levels</a> | <a class="postlink" href="http://headsoft.com.au/index.php?category=tdg" target="_blank">The Detective Game</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170465 - hacker013 - Mon Sep 28, 2009 8:16 pm</h4>
    <div class="postbody"><span class="postbody">I tryed to use that code for a project of me but instead of a u16 pointer to de main memory I have a u8 pointer to the main memory but it shows only a black screen :( Does somebody know what i'm doing wrong? I already tried various things but they didn't work.<br/>_________________<br/><a class="postlink" href="http://imetal.nl/" target="_blank">Website / Blog</a>
<br/>
<br/>
Let the nds be with you.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170470 - DiscoStew - Mon Sep 28, 2009 10:24 pm</h4>
    <div class="postbody"><span class="postbody">Are you using the code I displayed, but mixed with the adjustments Cydrak pointed out? What about the alignment of the u8 pointer? Maybe it doesn't do anything if the source address isn't properly aligned.<br/>_________________<br/><span style="font-weight: bold">DS</span> - It's all about <span style="font-weight: bold">D</span>isco<span style="font-weight: bold">S</span>tew</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170489 - hacker013 - Tue Sep 29, 2009 3:25 pm</h4>
    <div class="postbody"><span class="postbody">Alignment is correvy I think because if I set it to VRAM_A it just shows but if I want it to show your way it just give me a black screen. And I use Cydrak corrections ;)<br/>_________________<br/><a class="postlink" href="http://imetal.nl/" target="_blank">Website / Blog</a>
<br/>
<br/>
Let the nds be with you.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
