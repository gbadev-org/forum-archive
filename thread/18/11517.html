<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>ENTER THE MATRIX... how to? [libnds videoGL.h ver 1.21] - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > ENTER THE MATRIX... how to? [libnds videoGL.h ver 1.21]</h2>
<div id="posts">
<div class="post">
    <h4>#106809 - silent_code - Mon Oct 23, 2006 5:43 pm</h4>
    <div class="postbody"><span class="postbody">hi!
<br/>
<br/>
now, i've messed a bit with the whole thing (matrices) but i can't find any way to retrieve the current modelview matrix - there is a GL_GET_MATRIX_PROJECTION define for the projection matrix and a GL_GET_MATRIX_ROTATION define, but i don't see a modelview matrix, except in the matrix modes.
<br/>
<br/>
so, how can it be done? can it be done? is there a function or do i have to access the hw directly (write my own function)?
<br/>
<br/>
thanks in advance for your help.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#106813 - DiscoStew - Mon Oct 23, 2006 6:52 pm</h4>
    <div class="postbody"><span class="postbody">I've asked this question some time ago, and supposably you get them as an array from those places in memory. However, I've been unsuccessful in doing so, and since I can't check on hardware, I'm not sure if it is just my code, or the emulator, since all I ever get are 0s. Because of this, I have been doing all my matrix math manually rather than trying to use hardware.
<br/>
<br/>
I would like to also know the correct way to grab data from these too. I'd much rather let hardware do it, as it is faster.<br/>_________________<br/><span style="font-weight: bold">DS</span> - It's all about <span style="font-weight: bold">D</span>isco<span style="font-weight: bold">S</span>tew</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#106821 - silent_code - Mon Oct 23, 2006 7:34 pm</h4>
    <div class="postbody"><span class="postbody">as soon as i get my hw back i'll see what i can find.
<br/>
<br/>
getting the memory area that holds the values and reading them back shouldn't be too hard. i mean you can *write* to it...
<br/>
<br/>
if you posted your code, i could test it for you. you could also post a .nds file.
<br/>
then i'll let you know if it works.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#106844 - Rajveer - Tue Oct 24, 2006 2:49 am</h4>
    <div class="postbody"><span class="postbody">so let me get this straight: performing your own matrix calculations is more costly than using the implemented glTranslate and glRotate functions, because these functions make use of the hardware compared to if i were to just do my own matrix calculations? arent these functions just glMultMatrix e.t.c defines themselves? (which in turn are just mulf32 defines no?)
<br/>
<br/>
oh and im pretty sure it IS the GL_GET_MATRIX_ROTATION command that you want (unless you want the whole 4x4 matrix as opposed to the 3x3 rotation matrix</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#106848 - DiscoStew - Tue Oct 24, 2006 3:52 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Rajveer wrote:</b></span></td> </tr> <tr> <td class="quote">so let me get this straight: performing your own matrix calculations is more costly than using the implemented glTranslate and glRotate functions, because these functions make use of the hardware compared to if i were to just do my own matrix calculations? arent these functions just glMultMatrix e.t.c defines themselves? (which in turn are just mulf32 defines no?)
<br/>
<br/>
oh and im pretty sure it IS the GL_GET_MATRIX_ROTATION command that you want (unless you want the whole 4x4 matrix as opposed to the 3x3 rotation matrix</td> </tr></table><span class="postbody">
<br/>
<br/>
Well, for the things I'm trying to do now, I feel that letting the hardware do the calculations would be better than me doing them manually with my own routine (which is just normal multiplying without extensive optimizing), because I can make use of Pushing/Popping the matrices, plus I hear that matrix multiplying on hardware is faster in terms of cycles spent from supposably being able to do multiple multiplications at one time. Only major reason why I use my own matrix math functions is because I can't get the active matrix from hardware. The GL_GET_MATRIX_PROJECTION register array keeps giving me 0s.
<br/>
<br/>
The hardware has such registers like MATRIX_MULT4x4, that after being written 16 times to it (a 4x4 matrix), it multiplies what you give it with what its active matrix is.<br/>_________________<br/><span style="font-weight: bold">DS</span> - It's all about <span style="font-weight: bold">D</span>isco<span style="font-weight: bold">S</span>tew</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#106954 - silent_code - Wed Oct 25, 2006 6:21 am</h4>
    <div class="postbody"><span class="postbody">well, i don't want the rotation matrix, i want the modelview matrix... and that's a 4x4 matrix including rotation and translation... a plain rotation matrix is pretty useless to me right now. i think i made that clear in the other post...
<br/>
<br/>
@ds: so, do you want me to test your stuff on hw?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#107032 - DiscoStew - Wed Oct 25, 2006 8:54 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>silent_code wrote:</b></span></td> </tr> <tr> <td class="quote">well, i don't want the rotation matrix, i want the modelview matrix... and that's a 4x4 matrix including rotation and translation... a plain rotation matrix is pretty useless to me right now. i think i made that clear in the other post...
<br/>
<br/>
@ds: so, do you want me to test your stuff on hw?</td> </tr></table><span class="postbody">
<br/>
I'm not even sure if how I'm grabbing stuff is even correct. Would this be correct? (I'm at work right now, so I had to think up a quick example off the top of my head)
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
<br/>
f32 grabMatrix[16];
<br/>
GLvector bleh = {4096, 4096, 4096};   // equals 1 unit in the x, y, and z direction
<br/>
int i = 0;
<br/>
<br/>
// Reset the screen and setup the view, blah blah blah
<br/>
<br/>
// then
<br/>
<br/>
glMatrixMode(GL_MODELVIEW);
<br/>
<br/>
glPushMatrix();
<br/>
<br/>
//Just to change the matrix so we don't have all 0s....hopefully
<br/>
glTranslatev(&amp;bleh);
<br/>
<br/>
for ( ; i &lt; 16; i++ )
<br/>
   grabMatrix[i] = GL_GET_MATRIX_PROJECTION[i];
<br/>
<br/>
glPopMatrix(1);
<br/>
<br/>
//Print matrix values to screen
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Set to the modelview, push matrix, translate matrix, grab matrix values, pop matrix, then print recorded matrix values. This is just about how my basic test for trying to get the active matrix is like, but all I get are 0s on the emulators, no matter what I do to the active matrix. The actual test I have for trying to do this was with my Rigid Bones demo, but because I wasn't getting anywhere with the 0s, I made my own matrix math functions so I could retrieve those values. If my example code above is correct in how to get the values, or the correct method is shown, then I'll reset my demo to use this, and then I can send ya the new build for you to test on hardware, silent_code.<br/>_________________<br/><span style="font-weight: bold">DS</span> - It's all about <span style="font-weight: bold">D</span>isco<span style="font-weight: bold">S</span>tew</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#107045 - silent_code - Wed Oct 25, 2006 10:56 pm</h4>
    <div class="postbody"><span class="postbody">well, there's the function
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void glGetFixed(GL_GET_TYPE param, fixed* f);</td> </tr></table><span class="postbody">
<br/>
[\include\nds\arm9\videoGL.h : line 618]
<br/>
<br/>
you can pass it "GL_GET_MATRIX_PROJECTION" (this is just an enumeration, so you can't access it as there's no data!!! it's more like "#define GL_GET_MATRIX_PROJECTION 3" - that isn't a register!) [line 302] for param and an array[16] of "fixed"s where the matrix should go. as far as i understand that, this is it, you should have your matrix now.
<br/>
<br/>
i'm still wondering if the mx hw can be used for any 4x4 / 3x3 mx calcs... that would require to have access to a modelview mx.
<br/>
<br/>
now what i have though about is, that you can load the indentity mx after the reset. then ([possibility] 1) if the projection mx was the identity mx, do your mx math, read back the projection mx, reset it and do all your graphics stuff or (2) if the proj mx was the *real* proj mx (that means it had viewing transformations in it, e.g. like the frustum) just save it, do your math and then multiply your result by the transpose of the former proj mx. that would give you the values without any viewing stuff (there would be some rounding error, though). [if this is BS, tell me and i'll correct it.]
<br/>
<br/>
i assume the 1st path is more likely to be the real thing and thus we wouldn't need any additional modelview mx. just calc your stuff, then load the identity mx and set the projection transforms.
<br/>
<br/>
i don't have any code (yes, i messed with the nds' hw matrices, but i didn't write any line of code), so you'd have to try it out.
<br/>
it was nice of you sharing this piece of code if it worked! ;) and seeing your demo running on hw would definitely be kick ass! bones sound cool :D [actually that's what i want to use it for, too ;p ]
<br/>
<br/>
greets!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#107047 - DiscoStew - Wed Oct 25, 2006 11:25 pm</h4>
    <div class="postbody"><span class="postbody">Well, I already have my little demo up on the DS Misc section, but that is using my own matrix routines, not the hardware. It's just the demo and a few pics though. Don't worry about the background looking green, as that is what it was supposed to do.
<br/>
<br/>
EDIT:
<br/>
Heh, I just got home, and in my code, I used GL_GET_MATRIX_PROJECTION, when I meant to use MATRIX_READ_PROJECTION. I was at work, and I couldn't remember the actual name, but the latter is what I tried using.
<br/>
<br/>
I tried that function, but on Dualis, I get 0s still.  =(<br/>_________________<br/><span style="font-weight: bold">DS</span> - It's all about <span style="font-weight: bold">D</span>isco<span style="font-weight: bold">S</span>tew</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#107087 - silent_code - Thu Oct 26, 2006 12:14 pm</h4>
    <div class="postbody"><span class="postbody">then send it over. ;)
<br/>
<br/>
pm me.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#107127 - DiscoStew - Thu Oct 26, 2006 10:48 pm</h4>
    <div class="postbody"><span class="postbody">My demo (or should I say "visual demonstration") is <a class="postlink" href="http://forum.gbadev.org/viewtopic.php?t=11436" target="_blank">here</a>, but like I said before, that is using my own matrix math functions to get the matrix, not getting from hardware, and my purpose is to grab the matrix from hardware.
<br/>
<br/>
I just can't continue trying this out unless I know what I'm doing is correct. The method to get the matrix looks very simple, but unless I have proof that that is the way to get it, building my demo now using it is a waste of time. Emulators aren't giving me squat because it is either I am doing it wrong, or the feature to get the matrix is unimplemented in them. If it is just unimplemented, that will at least tell me that I can continue, and that I can move over to grabbing from hardware once either the emulators implement it, or I can test on hardware myself.
<br/>
<br/>
Anyone have their own project that uses this feature that could tell me if it is correct, or could tell me how to correctly get the matrix?<br/>_________________<br/><span style="font-weight: bold">DS</span> - It's all about <span style="font-weight: bold">D</span>isco<span style="font-weight: bold">S</span>tew</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#107162 - silent_code - Fri Oct 27, 2006 9:12 am</h4>
    <div class="postbody"><span class="postbody">... i have tried your sw mx demo before my last post ;p i just thought that this is such a small change that you could just build a demo and send it over for testing...
<br/>
<br/>
ok, then i'll have to write my own test. i'll post here as soon as i get some results (may take a while - depends on how much other stuff i have to do).</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#107276 - DiscoStew - Sat Oct 28, 2006 4:35 am</h4>
    <div class="postbody"><span class="postbody">Well, I decide to head over to the forums of Dualis, and asked 'mic', the author of Dualis, about that. He says that the address for MATRIX_READ_PROJECTION is the correct place to grab the matrix. It's just Dualis does not support it, and I also believe other emulators that I've tested with don't have that either as the same results are retrieved.
<br/>
<br/>
So, what I may do is have both the sw matrix math and hardware implementation, and have a single button switch between the two for testing purposed.<br/>_________________<br/><span style="font-weight: bold">DS</span> - It's all about <span style="font-weight: bold">D</span>isco<span style="font-weight: bold">S</span>tew</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#107283 - tepples - Sat Oct 28, 2006 5:53 am</h4>
    <div class="postbody"><span class="postbody">Or you could make a demo that displays a photo of Carrie-Anne Moss as <a class="postlink" href="http://en.wikipedia.org/wiki/Trinity_%28The_Matrix%29" target="_blank">Trinity from <span style="font-style: italic">The Matrix</span></a> with that <a class="postlink" href="http://en.wikipedia.org/wiki/Matrix_digital_rain" target="_blank">green code</a> behind her when run on hardware, and "YOUR EMULATOR SUCKS!" when run on emulators that don't support reading back the model-view matrix. Then spread this demo as a test case.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#107287 - DiscoStew - Sat Oct 28, 2006 7:00 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tepples wrote:</b></span></td> </tr> <tr> <td class="quote">Or you could make a demo that displays a photo of Carrie-Anne Moss as <a class="postlink" href="http://en.wikipedia.org/wiki/Trinity_%28The_Matrix%29" target="_blank">Trinity from <span style="font-style: italic">The Matrix</span></a> with that <a class="postlink" href="http://en.wikipedia.org/wiki/Matrix_digital_rain" target="_blank">green code</a> behind her when run on hardware, and "YOUR EMULATOR SUCKS!" when run on emulators that don't support reading back the model-view matrix. Then spread this demo as a test case.</td> </tr></table><span class="postbody">lol, perhaps have it load the Identity Matrix, and right afterwards if what is read are 0s, have that display? I gotta get me a compatible wireless card just to try that out.   =D<br/>_________________<br/><span style="font-weight: bold">DS</span> - It's all about <span style="font-weight: bold">D</span>isco<span style="font-weight: bold">S</span>tew</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#107308 - Rajveer - Sat Oct 28, 2006 1:01 pm</h4>
    <div class="postbody"><span class="postbody">hold up, i thought u wanted the modelview matrix. so why are you trying to get the projection matrix?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#107309 - silent_code - Sat Oct 28, 2006 1:10 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tepples wrote:</b></span></td> </tr> <tr> <td class="quote">Or you could make a demo that displays a photo of Carrie-Anne Moss as <a class="postlink" href="http://en.wikipedia.org/wiki/Trinity_%28The_Matrix%29" target="_blank">Trinity from <span style="font-style: italic">The Matrix</span></a> with that <a class="postlink" href="http://en.wikipedia.org/wiki/Matrix_digital_rain" target="_blank">green code</a> behind her when run on hardware, and "YOUR EMULATOR SUCKS!" when run on emulators that don't support reading back the model-view matrix. Then spread this demo as a test case.</td> </tr></table><span class="postbody">
<br/>
<br/>
THAT'S GOLD, tepples! *LOL*</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#107335 - DiscoStew - Sat Oct 28, 2006 5:48 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Rajveer wrote:</b></span></td> </tr> <tr> <td class="quote">hold up, i thought u wanted the modelview matrix. so why are you trying to get the projection matrix?</td> </tr></table><span class="postbody">I think what's confusing is the naming convention used for that particular area of memory. According to GBATEK, that location is called CLIPMTX_RESULT, of which, if I understand correctly, can read both the projection matrix and the modelview matrix from that place. To distinguish the two though, my assumption is that using glMatrixMode changes what is read from there, just like how using glMatrixMode allows changes to be made to either the projection or modelview matrix.<br/>_________________<br/><span style="font-weight: bold">DS</span> - It's all about <span style="font-weight: bold">D</span>isco<span style="font-weight: bold">S</span>tew</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#107487 - Rajveer - Mon Oct 30, 2006 3:32 am</h4>
    <div class="postbody"><span class="postbody">ahh right, makes sense. cheers for the explanation :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#107513 - Ted - Mon Oct 30, 2006 12:19 pm</h4>
    <div class="postbody"><span class="postbody">Slightly late to the party, but i tried throwing together a small test for reading the model matrix from  the 3d hardware,
<br/>
and as far as i can tell, it works nice on hardware but not in emulators, they just return zeroes like everyone has said.
<br/>
(tried with dualis and desmume, probably not the latest versions though)
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">// array to store the matrix in
<br/>
fixed matrixData[16];
<br/>
<br/>
// switch to projection matrix and save it
<br/>
glMatrixMode(GL_PROJECTION);
<br/>
glPushMatrix();
<br/>
<br/>
// load identity matrix so we get the modelview matrix when reading
<br/>
glLoadIdentity();
<br/>
<br/>
// wait for 3d-engine to finish before reading
<br/>
while(GFX_STATUS &amp; BIT(27));
<br/>
glGetFixed(GL_GET_MATRIX_PROJECTION, matrixData);
<br/>
<br/>
// restore original projection matrix
<br/>
glPopMatrix(1);</td> </tr></table><span class="postbody">
<br/>
<br/>
If you want to read the projection matrix instead, just change GL_PROJECTION to GL_MODELVIEW.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#107530 - DiscoStew - Mon Oct 30, 2006 4:02 pm</h4>
    <div class="postbody"><span class="postbody">It's goodto have multiple confirmations.  =)<br/>_________________<br/><span style="font-weight: bold">DS</span> - It's all about <span style="font-weight: bold">D</span>isco<span style="font-weight: bold">S</span>tew</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#107546 - silent_code - Mon Oct 30, 2006 7:22 pm</h4>
    <div class="postbody"><span class="postbody">OH, that'S nice :)
<br/>
<br/>
thanks, it helpes a lot! :D</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
