<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>fog and transparence - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > fog and transparence</h2>
<div id="posts">
<div class="post">
    <h4>#149021 - luss - Sun Jan 13, 2008 5:47 pm</h4>
    <div class="postbody"><span class="postbody">Hello everyone,
<br/>
I've learned a lot reading this forum, but now I'm stucked!
<br/>
<br/>
I try to use fog and transparence in the same time and it doesn't work properly... (sorry for poor english speaking)
<br/>
<br/>
For the example, I will use only two plane:
<br/>
<br/>
-plane n?1 for my ground with glPolyFmt(POLY_ID(1) | POLY_ALPHA(31) | POLY_FORMAT_LIGHT0 | POLY_CULL_NONE | POLY_FOG);
<br/>
<br/>
-plane n?2, placed in front of the camera and near it, like a window, with glPolyFmt(POLY_ID(2) | POLY_ALPHA(10) | POLY_FORMAT_LIGHT0 | POLY_CULL_NONE | POLY_FOG);
<br/>
<br/>
It seems the fog is rendered in front of my plane n?2, just like the nds renders first plane n?1, then plane n?2 and finally adds the fog on top of the previous result without taking care of my plane n?2...
<br/>
<br/>
For info, my plane n?2 will always be near the camera. So I don't really need to have fog on it... If it can help to find a solution...
<br/>
<br/>
I can't get ride of this problem...
<br/>
<br/>
Someone have a clue?
<br/>
thanks by advance!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#149027 - M3d10n - Sun Jan 13, 2008 7:47 pm</h4>
    <div class="postbody"><span class="postbody">I never tested fog+transparent polygons, but I know what might be causing your problem.
<br/>
<br/>
The fog on the DS seems to be rendered as a post-processing after the scanline was rendered, blending the scanline's pixels against the color value based on their depth. So, when you draw your ground plane, it writes depth values on the z-buffer. When you render your transparent plane, it doesn't change the depth values, and thus the fog is applied based as if only the ground had been rendered.
<br/>
<br/>
You can make your transparent plane update depth by enabling bit 11 on the polygon attribute, but that might cause the fog to not be rendered on the plane behind. Did you try disabling the fog (POLY_FOG) for the transparent plane?
<br/>
<br/>
<br/>
Hmm... I booted Metroid Prime Hunters (which uses lots of fog) to test and it seems to have no problem fogging alpha-blended polygons. There might be some settings to get around that problem.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#149036 - luss - Sun Jan 13, 2008 11:30 pm</h4>
    <div class="postbody"><span class="postbody">It seems you're right! When enabling bit 11 on my second plane, the fog isn't rendered for the part of the first plane that is behind. But it's a beginning and might be usefull: thanks for this tip! 
<br/>
<br/>
In fact, I try to make a nice glow/lens flare effect... I really want that ^^
<br/>
<br/>
Disabling poly_fog for the second plane didn't change anything: exactly the same result ('cause my 2nd plane is near camera, there's no fog on it when enabling poly_fog).
<br/>
<br/>
Maybe rendering the frame in two pass? But it will use en vram block, isn't it? I hope the framerate can still be at 60fps, like I saw in a demo on this forum. But I won't be really satisfied by this solution because I need memory for textures and it's allready hard to deal with 512Ko max vram memory... :(
<br/>
<br/>
I've played to Metroid Prime Hunters too and I doubt they waste a block memory just for using fog and alpha-blend polygons ^^ maybe i'm wrong...
<br/>
<br/>
I thougt playing with GL_BLEND?? hmm... I've read that playing with GL_BLEND isn't a good solution (in a thread talking about shadow).</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
