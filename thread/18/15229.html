<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Can ARM7 code/data be linked into EWRAM? - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > Can ARM7 code/data be linked into EWRAM?</h2>
<div id="posts">
<div class="post">
    <h4>#152749 - Maximus32 - Thu Mar 20, 2008 11:26 am</h4>
    <div class="postbody"><span class="postbody">Currently the ARM7 code can only be linked in IWRAM by the linker scripts. Since I need more than 64KiB for ARM7 I would like to use the shared EWRAM. I was thinking to split this up:
<br/>
<br/>
ARM9: 3.0MiB or 3.5MiB
<br/>
ARM7: 1.0MiB or 0.5MiB
<br/>
<br/>
 - Is this possible?
<br/>
 - How can this be done in the linker scripts?
<br/>
 - Do the crt0 files need to be changed for this?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#152753 - eKid - Thu Mar 20, 2008 12:32 pm</h4>
    <div class="postbody"><span class="postbody">I don't know if it's possible with devkitARM (two binaries sharing memory space). Also, sharing main ram for code can yield some side effects. Mainly, the memory can only be accessed by one CPU at a time. So, while one CPU is running code, the other will be completely frozen until the active one goes to sleep. I think there's a bit somewhere that controls which CPU has priority for the memory.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#152755 - Dwedit - Thu Mar 20, 2008 12:42 pm</h4>
    <div class="postbody"><span class="postbody">If you're using C++, there are tricks you can use to make your binary a lot smaller.<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#152756 - Maximus32 - Thu Mar 20, 2008 1:08 pm</h4>
    <div class="postbody"><span class="postbody">I am using C++ so making that smaller would be very welcome! I am using                 -fno-rtti and -fno-exceptions, any other tips to making it smaller?
<br/>
<br/>
Still I would like to use EWRAM, since it's a big project, I will eventually need more than 64KiB anyway.
<br/>
<br/>
The performance penalty for sharing EWRAM is acceptable to me.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#152757 - simonjhall - Thu Mar 20, 2008 1:10 pm</h4>
    <div class="postbody"><span class="postbody">You can keep all your code in the ARM9 binary and then pass across a function pointer (via shared memory, the fifo, whatever) and then call it from the ARM7.
<br/>
Just make sure that you've compiled that bit of code (the one that lives in the ARM9 binary) with options that are compatible with the ARM7 instruction set.
<br/>
<br/>
Easy money...<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#152764 - wintermute - Thu Mar 20, 2008 4:09 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Maximus32 wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
Still I would like to use EWRAM, since it's a big project, I will eventually need more than 64KiB anyway.
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I'd think seriously about redesign. To me this would suggest you want to use the ARM7 for something that it's not really suited 
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
The performance penalty for sharing EWRAM is acceptable to me.</td> </tr></table><span class="postbody">
<br/>
<br/>
That performance penalty is rather larger than you might expect.
<br/>
<br/>
To others answering questons like these :- have you considered that perhaps the posters interests might be better served by asking what the final objective is rather than telling him how to achieve something that may lead to major refactoring later?<br/>_________________<br/><a class="postlink" href="http://www.devkitpro.org/" target="_blank">devkitPro - professional toolchains at amateur prices</a>
<br/>
<a class="postlink" href="http://wiki.devkitpro.org/index.php/IRC" target="_blank">devkitPro IRC support</a>
<br/>
<a class="postlink" href="http://davejmurphy.com/" target="_blank">Personal Blog</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#152765 - Maximus32 - Thu Mar 20, 2008 4:30 pm</h4>
    <div class="postbody"><span class="postbody">You are absolutely right. I am trying to use it for something it's not really suited for...
<br/>
<br/>
I'm trying to build an operating system for game consoles (currently runs on gba, nds, ps2, psp, ngc, i386). My goals are to make everyting communicate through message passing (send/receive/reply), this already works.
<br/>
<br/>
The thing is... I'm treating the NDS as TWO systems, with TWO operating systems, communicating through IPC, this way I have multithreading, sleep, etc, etc in ARM7 also.
<br/>
<br/>
I know it would probably be better to keep the ARM7 simple (no OS, just simple execution of commands from ARM9), but it's really cool to see two osses in one DS communicating to eachother, and it's my perfect testing system for message passing between two systems.
<br/>
<br/>
Why should the ARM9 have all 4MiB (and only use ~150KiB now), and the ARM7 have nothing? As I said before performance is not an isue for now, and I intend to put all processing intesive tasks and ISR's into IWRAM, and use the EWRAM for everyting else.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#152769 - wintermute - Thu Mar 20, 2008 5:19 pm</h4>
    <div class="postbody"><span class="postbody">Sounds quite entertaining :)
<br/>
<br/>
Personally I'd tend more towards treating the ARM7 as a peripheral controller than using separate OS components in both. One of the difficulties you end up running into is how to manage main memory if both processors can allocate and free blocks, then there's the bus priority which ends up crippling at least one of the processors.
<br/>
<br/>
The way the default linkscripts &amp; crt0s are set up, the arm7 has 96k of internal RAM and the arm9 controls main memory. This works rather well for our purposes and is much the same route that Nintendo went in the end. Depending on your needs, it's also possible to allocate 256K of VRAM to the arm7 and use that in conjunction with or instead of the 96K the arm7 normally has access to.
<br/>
<br/>
devkitARM is not built for multithreading so you need to be careful with malloc and stdio if you're using things from the standard libraries.
<br/>
<br/>
If you really want to attempt the everything in ewram thing.
<br/>
<br/>
Check the linker script documentation @ <a href="http://sourceware.org/binutils/docs-2.18/ld/Scripts.html#Scripts" target="_blank">http://sourceware.org/binutils/docs-2.18/ld/Scripts.html#Scripts</a> and familiarise yourself with the current scripts, found in devkitARM/arm-eabi/lib ( ds_arm9.ld, ds_arm7.ld ) and the specs fragments.
<br/>
<br/>
You'll need to adjust the crt0 files too, the source for those is in the same place, they should be fairly self explanatory.
<br/>
<br/>
The parameters for ndstool will need to be adjusted for custom start &amp; memory addresses.
<br/>
<br/>
Simon's suggestion is likely to lead to trouble, I made a few attempts to build a single binary way back in the early days but I had a lot of serious head bending problems with it. It's *very* difficult to make sure that code running on the arm9 doesn't call code intended for the arm7 and vice versa. Having said that, the main thing that made me give up on it was how much it crippled performance.
<br/>
<br/>
Apart from that, have fun - sounds like a very interesting little project.<br/>_________________<br/><a class="postlink" href="http://www.devkitpro.org/" target="_blank">devkitPro - professional toolchains at amateur prices</a>
<br/>
<a class="postlink" href="http://wiki.devkitpro.org/index.php/IRC" target="_blank">devkitPro IRC support</a>
<br/>
<a class="postlink" href="http://davejmurphy.com/" target="_blank">Personal Blog</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#152774 - simonjhall - Thu Mar 20, 2008 6:36 pm</h4>
    <div class="postbody"><span class="postbody">Well I always figure people don't want to know my opinion when they ask stuff like this, they just want to know the answer!
<br/>
Plus I'm normally at work when I write messages like this so I ain't got a lot of time to write a long rambling message about how dey is WRONG!
<br/>
<br/>
Pub time ;-)<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#152778 - Maximus32 - Thu Mar 20, 2008 7:41 pm</h4>
    <div class="postbody"><span class="postbody">Managing main memory can be simple. Just divide it statically in the linker script (3MiB for ARM9, 1MiB for ARM7).
<br/>
<br/>
Adding extra video memory is a good idea! That way the performance penalty won't be so big. I'll have to look into the linker scrips though (not my favorite)
<br/>
<br/>
As for memory allocation, I have my own routines for malloc, free, new and delete. Currently ARM9 uses what's left of the 4MiB and ARM7 uses what's left of IWRAM (not much).
<br/>
<br/>
If you're interested you can have a look at the "interesting little project" ;-)
<br/>
<br/>
svn co <a href="https://bricks-os.svn.sourceforge.net/svnroot/bricks-os/trunk" target="_blank">https://bricks-os.svn.sourceforge.net/svnroot/bricks-os/trunk</a> bricks-os</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#152780 - Dwedit - Thu Mar 20, 2008 7:51 pm</h4>
    <div class="postbody"><span class="postbody">Smaller C++ binary: (the short post)
<br/>
#1) Link with -lsupc++ as the first library instead of -lstdc++.  Doing this alone makes a huge difference.  Among other things, you will no longer find lots of C++ error messages dealing with rtti in your binaries.
<br/>
<br/>
#2) Include this C++ code somewhere in your program:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
extern "C" {
<br/>
   void __gxx_personality_v0()
<br/>
   {
<br/>
      
<br/>
   }
<br/>
   void __aeabi_atexit()
<br/>
   {
<br/>
      
<br/>
   }
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
The longer version of this post:
<br/>
To find out what functions you can make blank, look through the .map file your compiler generates.  Whenever a function is linked in from the standard C++ library, it loves it invite a bunch of friends to come along with it.  Here's a line from a .map file:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
c:/devkitpro/devkitarm/bin/../lib/gcc/arm-eabi/4.1.2/../../../../arm-eabi/lib/thumb\libstdc++.a(eh_personality.o)
<br/>
                              main.o (__gxx_personality_v0)
<br/>
</td> </tr></table><span class="postbody">
<br/>
This shows that main.o is asking for __gxx_personality_v0.  Linking to that function adds a bunch of its friends:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
(std::terminate())
<br/>
(__cxxabiv1::__terminate_handler)
<br/>
(__cxxabiv1::__unexpected_handler)
<br/>
(__gnu_cxx::__verbose_terminate_handler())
<br/>
(__cxa_demangle)
<br/>
(__cxa_end_cleanup)
<br/>
(__cxa_bad_typeid)
<br/>
(__cxa_call_terminate)
<br/>
(__cxa_end_catch)
<br/>
(vtable for std::bad_exception)
<br/>
(__cxa_get_globals_fast)
<br/>
(__cxa_rethrow)
<br/>
(__cxa_current_exception_type)
<br/>
(vtable for __cxxabiv1::__class_type_info)
<br/>
(typeinfo for void)
<br/>
(operator delete(void*))
<br/>
(__cxa_free_exception)
<br/>
</td> </tr></table><span class="postbody">
<br/>
The clincher:  In the test program that included this, __gxx_personality_v0 is never called or referred to!
<br/>
If you create your own blank version, the compiler will not try to link it in.
<br/>
<br/>
Another library that shows up commonly is __aebai_atexit().
<br/>
It shows up any time you have global instances of classes, so that your program can destruct them when your program finishes.
<br/>
Only problem is that there's no notion of exit() for NDS programs.  Why bother with the big bunch of code for handling and registering "atexit" events?
<br/>
That's a good one to make blank.<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"><br/><br/>Last edited by Dwedit on Thu Mar 20, 2008 8:14 pm; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#152781 - Maximus32 - Thu Mar 20, 2008 8:08 pm</h4>
    <div class="postbody"><span class="postbody">Thanks, I'll try those as well.
<br/>
<br/>
I already have those for the i386 version, becouse there are no c++ libraries for i386 when building an os. Guess it makes sense using them for the other platforms as well.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#152783 - tepples - Thu Mar 20, 2008 8:24 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>wintermute wrote:</b></span></td> </tr> <tr> <td class="quote">Personally I'd tend more towards treating the ARM7 as a peripheral controller than using separate OS components in both.</td> </tr></table><span class="postbody">
<br/>
Like the IOP of the PlayStation 2 and the MC68000 of the Jaguar, right?
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Dwedit wrote:</b></span></td> </tr> <tr> <td class="quote">Smaller C++ binary: (the short post) </td> </tr></table><span class="postbody">
<br/>
Has anybody looked into how one might port <a class="postlink" href="http://cxx.uclibc.org/" target="_blank">uClibc++</a> to the GBA or DS, so that cout &lt;&lt; "hello world\n"; doesn't take the majority of the GBA's EWRAM like it does with GNU libstdc++?
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Dwedit wrote:</b></span></td> </tr> <tr> <td class="quote">Only problem is that there's no notion of exit() for NDS programs.</td> </tr></table><span class="postbody">
<br/>
Would <a class="postlink" href="http://licklick.wordpress.com/category/rebootlib/" target="_blank">rebootlib</a> count?<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#152786 - wintermute - Thu Mar 20, 2008 8:44 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>simonjhall wrote:</b></span></td> </tr> <tr> <td class="quote">Well I always figure people don't want to know my opinion when they ask stuff like this, they just want to know the answer!
<br/>
Plus I'm normally at work when I write messages like this so I ain't got a lot of time to write a long rambling message about how dey is WRONG!
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
It's not really about wrong, more about how sometimes it's more helpful to suggest a less awkward path to a solution. Many programmers ( including me ) sometimes get stuck on using a particular algorithm when something else might be better suited.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
Pub time ;-)</td> </tr></table><span class="postbody">
<br/>
<br/>
mmm, beer
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Maximus32 wrote:</b></span></td> </tr> <tr> <td class="quote">Managing main memory can be simple. Just divide it statically in the linker script (3MiB for ARM9, 1MiB for ARM7).
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
What if you delegated the ARM9 to memory management and had the ARM7 request blocks? That way you don't really need to make static divisions, especially if the core ARM7 code can fit in the usual 96K.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
If you're interested you can have a look at the "interesting little project" ;-)
<br/>
<br/>
svn co <a href="https://bricks-os.svn.sourceforge.net/svnroot/bricks-os/trunk" target="_blank">https://bricks-os.svn.sourceforge.net/svnroot/bricks-os/trunk</a> bricks-os</td> </tr></table><span class="postbody">
<br/>
<br/>
Quick note - avoid using the -o option to ndstool, that way your .nds file will still run on slot2 cards &amp; no$gba. 
<br/>
<br/>
Also, doesn't google forbid putting adsense stuff in a sponsors/ads box like that? Hate to see you get your account pulled for something so simple.<br/>_________________<br/><a class="postlink" href="http://www.devkitpro.org/" target="_blank">devkitPro - professional toolchains at amateur prices</a>
<br/>
<a class="postlink" href="http://wiki.devkitpro.org/index.php/IRC" target="_blank">devkitPro IRC support</a>
<br/>
<a class="postlink" href="http://davejmurphy.com/" target="_blank">Personal Blog</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#152796 - Maximus32 - Thu Mar 20, 2008 10:57 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">What if you delegated the ARM9 to memory management and had the ARM7 request blocks? That way you don't really need to make static divisions, especially if the core ARM7 code can fit in the usual 96K.</td> </tr></table><span class="postbody">
<br/>
Before IPC is set up I need memory management, plus, what is an OS without memory management.... a library?
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Quick note - avoid using the -o option to ndstool, that way your .nds file will still run on slot2 cards &amp; no$gba. </td> </tr></table><span class="postbody">
<br/>
Wow, you've looked at my code, thanks for the tip!
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Also, doesn't google forbid putting adsense stuff in a sponsors/ads box like that? Hate to see you get your account pulled for something so simple.</td> </tr></table><span class="postbody">
<br/>
Damn, you also looked at my site... needs some serious updating. I wasn't aware of that, I'll look into it when I update my site.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#152842 - Maximus32 - Fri Mar 21, 2008 3:42 pm</h4>
    <div class="postbody"><span class="postbody">Talk about waisting memory!
<br/>
<br/>
Adding __gxx_personality_v0 and __aeabi_atexit saved me <span style="font-weight: bold">4KB</span>.
<br/>
<br/>
Adding __cxa_pure_virtual saved me <span style="font-weight: bold">39KB!!!!!</span> Thats more than half the entire IWRAM, waisted.
<br/>
<br/>
I now have more than enough memory for now!
<br/>
<br/>
Thanks Dwedit!</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
