<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>It froze - but where? - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > It froze - but where?</h2>
<div id="posts">
<div class="post">
    <h4>#144956 - Lazy1 - Fri Nov 09, 2007 8:24 pm</h4>
    <div class="postbody"><span class="postbody">In my random testings I had wolf3d freeze on me, unfortunately I have no idea where it could be happening but I have an idea.
<br/>
<br/>
Is it possible to set up an interrupt so if I press L+R+Start it will write the address of the interrupted instruction to the console?
<br/>
That way I could just use arm-eabi-addr2line to locate the offending code.
<br/>
<br/>
How would I go about doing that?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#144959 - DekuTree64 - Fri Nov 09, 2007 8:48 pm</h4>
    <div class="postbody"><span class="postbody">I can think of a good way, and an evil way.
<br/>
<br/>
The good way is to write your interrupt handler in assembly, count how many things get pushed onto the stack by the BIOS handler and the libnds dispatcher, so you can grab the final return address off the stack directly.
<br/>
<br/>
Here is the evil way:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void KeyInterruptHandler()
<br/>
{
<br/>
    u32 evilArray[1];
<br/>
    for (int i = 0; i &lt; 16; i++)
<br/>
    {
<br/>
        iprintf("%x\n", evilArray[i]);
<br/>
    }
<br/>
}</td> </tr></table><span class="postbody">
<br/>
The idea being that the array goes onto the stack, and then you read off the end of it into whatever else has recently been pushed onto the stack. Then look through the values for ones that look like code addresses. Although you may need to go more than 16 values into the stack to get to the return address, I'm not sure.<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#144963 - Lazy1 - Fri Nov 09, 2007 9:33 pm</h4>
    <div class="postbody"><span class="postbody">Interesting...
<br/>
The evil way does work but as you said it takes a bit of fishing to find the right address.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#144990 - Lazy1 - Sat Nov 10, 2007 3:29 am</h4>
    <div class="postbody"><span class="postbody">That's odd, I found a few valid code addresses in there.
<br/>
How do I do the less-evil one?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#145000 - DekuTree64 - Sat Nov 10, 2007 9:31 am</h4>
    <div class="postbody"><span class="postbody">Hmm, looks like the libnds dispatcher switches to the user stack, so the evil method doesn't even work... but on the other hand it makes the good way a bit easier. I'm pretty sure the BIOS handler just pushes 6 values onto the stack (r0-r3, r12, lr), so we want to the last one there. Here's a quick attempt at a function to do it:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">.arm
<br/>
.align 2
<br/>
.global KeyInterruptHandler
<br/>
KeyInterruptHandler:
<br/>
mrs r1, cpsr         @ Grab the current status register
<br/>
bic r0, r1, #0x1f    @ Clear mode field
<br/>
orr r0, r0, #0x12    @ Set to IRQ mode
<br/>
msr cpsr, r0         @ Write to status register
<br/>
ldr r0, [sp, #5 * 4] @ Load the final return address from the IRQ stack
<br/>
msr cpsr, r1         @ Switch back to the original mode
<br/>
b PrintReturnAddress @ Call a function to print the value</td> </tr></table><span class="postbody">
<br/>
Then PrintReturnAddress can just be a regular C function that takes one u32 argument (i.e. the value in r0). That also uses a fun little trick of just jumping to another function, leaving it to return to your return address. Nothing too special, just saves a couple of instructions... but make sure the function is also compiled as ARM code.<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#145010 - Lazy1 - Sat Nov 10, 2007 12:17 pm</h4>
    <div class="postbody"><span class="postbody">Thanks for your help on this though it does not seem to give a valid address, I have seen:
<br/>
<br/>
0x00000000
<br/>
0x00000001
<br/>
0x000015EF
<br/>
0x40000000
<br/>
0xA3D71910
<br/>
...
<br/>
...
<br/>
ect...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#145080 - Lazy1 - Sun Nov 11, 2007 7:36 am</h4>
    <div class="postbody"><span class="postbody">Just a side note:
<br/>
If someone can get this working I will give you one of my Orange Box gifts (HL2 or HL2:EP1).</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#145086 - simonjhall - Sun Nov 11, 2007 11:54 am</h4>
    <div class="postbody"><span class="postbody">Have you tried the libnds exception handler? Try running that, and seeing if your screen suddenly turns bright red with a load of registers on it!
<br/>
There's a chance your (crashing) code may be doing something illegal, and running that couldn't hurt...<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#145101 - HyperHacker - Sun Nov 11, 2007 5:20 pm</h4>
    <div class="postbody"><span class="postbody">Yeah, during development (unless you've written your own exception handler of course) it's generally a good idea to stick a call to defaultExceptionHandler() at the beginning of main() so you get error screens instead of just weird behaviour. If you aren't using the console, though, you may want to remove it for the release build as it will bring that in which adds a fair bit of size to your binary.
<br/>
<br/>
If you're up to it, building your own handler is even better, since you can display more useful information specific to your program, try to dump it to a file, etc. I'd post mine, but I'm a bit short on time here, so PM me if you want it. It dumps the stack (though I think that's broken &lt;_&lt;), registers, IPC, and a few globals to help tell just what was going on.<br/>_________________<br/>I'm a PSP hacker now, but I still &lt;3 DS.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#145140 - Lazy1 - Mon Nov 12, 2007 12:11 am</h4>
    <div class="postbody"><span class="postbody">I am using the default exception handler but the problem is not a crash.
<br/>
The problem may lie in the timing code but I'm not sure, if the game is stuck in a loop waiting for the time to catch up then this would help me alot.
<br/>
<br/>
It still could be getting locked up elsewhere, which is why this code would help me alot.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#145148 - HyperHacker - Mon Nov 12, 2007 12:30 am</h4>
    <div class="postbody"><span class="postbody">Well the CPU won't just lock up solid (barring some hardware defect), so if it's not triggering an exception, it has to be stuck in a loop somewhere. What you can do is throughout your main loop, set a global variable to __LINE__, and then during VBlank, print the variable on-screen. You could also put it in IPC so ARM7 can, for example, play tones of that frequency times whatever, or you could use a trick I like to use in PC apps:
<br/>
<br/>
#define WRITELINE fprintf(logfile, "%s:%u\n", __FILE__, __LINE__)
<br/>
<br/>
Then just drop WRITELINE; in various places in your code, open the file before calling it, and you'll get a log of what "checkpoints" were passed in what order. (On PC I write it to the console, but same idea.) Only caveat is on the DS, fflush() seems broken (for me at least), so you have to actually close the file to get it to flush to disk. It's hard to close a file when your app is hung, but you could do it in VBlank if a certain button is pressed. (That, and the logfile could fill up a small card quickly, and you definitely don't want to be writing to flash that much in your release version!)
<br/>
<br/>
Also, don't forget you have two CPUs. A trick I use to detect and report endless loops is during each iteration of the main loop, and periodically in long loops, send the other CPU a FIFO message. Each CPU keeps a counter, starting at say 120, decrements it in VBlank, and refills it when it gets this message. If it hits zero you can assume the other CPU has locked up and report the problem. Just don't forget to send the message during things that take more than 120 frames to do. If debugging on an emulator that doesn't handle FIFO properly you can just set the counter to some huge value, so that it won't hit zero for a few hours. (I've found this to be necessary on No$GBA, but I'm using an older version.)<br/>_________________<br/>I'm a PSP hacker now, but I still &lt;3 DS.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#145410 - Lazy1 - Thu Nov 15, 2007 12:42 am</h4>
    <div class="postbody"><span class="postbody">The offer for HL2 or HL2:EP1 still stands if someone can help me out...
<br/>
I cannot find out where it gets stuck and since it happens so infrequently this makes it all that much more annoying.
<br/>
<br/>
Ideally I want to add in a key combo into a test release, that way if it does get stuck the user can press the combo and give me an address so I can finally fix that bug once and for all.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
