<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Makefile Wizard required... - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > Makefile Wizard required...</h2>
<div id="posts">
<div class="post">
    <h4>#104774 - OOPMan - Mon Oct 02, 2006 4:30 pm</h4>
    <div class="postbody"><span class="postbody">Hey all, I've been having some problems with a rather detailed makefile. Basically, I've been adapting a makefile used pretty much as standard in the MTCLib source in order to build demos for the NDS build of the library. After struggling for a while I think I'm pretty close to getting it working, but it seems that one major obstacle remains.
<br/>
<br/>
First off, here's the makefile:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote"># GNU makefile to build MTC app with devkitPro
<br/>
#
<br/>
# REVISION HISTORY
<br/>
#
<br/>
#  No  Date       By   Reason
<br/>
# -------------------------------------------------------------------------
<br/>
#  01  25 Sep 02  lvr  Creation
<br/>
#  02  11 Feb 06  lvr  Modified for SwsMtc
<br/>
#  03  01 Oct 06  acj  Modified for devkitPro
<br/>
# -------------------------------------------------------------------------
<br/>
#
<br/>
# Instructions
<br/>
# ------------
<br/>
# type make -f makefile to use. Add "DEBUG=1" to build at debug.
<br/>
<br/>
# Default to ndebug build
<br/>
#
<br/>
ifndef NDEBUG
<br/>
ifndef DEBUG
<br/>
NDEBUG = 1
<br/>
endif
<br/>
endif
<br/>
<br/>
# Executable
<br/>
TARGET = demo1.nds.gba
<br/>
<br/>
# The filename of this makefile
<br/>
MAKEFILE = makefile
<br/>
<br/>
# The platform
<br/>
PLATFORM = nds
<br/>
<br/>
<br/>
########################
<br/>
# Paths
<br/>
vpath
<br/>
<br/>
ifdef DEBUG
<br/>
OBJ = ./dbg
<br/>
OBJDIR = ./dbg
<br/>
else
<br/>
OBJ = ./rel
<br/>
OBJDIR = ./rel
<br/>
endif
<br/>
vpath %.obj $(OBJ)/
<br/>
vpath %.elf $(OBJ)/
<br/>
vpath %.bin $(OBJ)/
<br/>
vpath %.nds $(OBJ)/
<br/>
<br/>
SRC = ..
<br/>
vpath %.c $(SRC)
<br/>
vpath %.cpp $(SRC)
<br/>
<br/>
INC2 = ../../../include
<br/>
INCLUDE += -I$(INC2)
<br/>
INCLUDE += -I$(DEVKITPRO)/libnds/include
<br/>
vpath %.h $(INC2)
<br/>
<br/>
INC3 = $(DEVKITPRO)/libnds/include
<br/>
INCLUDE += -I$(INC3)
<br/>
vpath %.h $(INC3)
<br/>
<br/>
# Libraries:
<br/>
MTCDIR = ../../../lib/$(PLATFORM)
<br/>
NDSLIB_LIB=$(DEVKITPRO)/libnds/lib
<br/>
<br/>
########################
<br/>
# Objects to build
<br/>
<br/>
APPOBJS = $(OBJ)/demo1.obj
<br/>
ELFOBJS = $(OBJ)/arm9.elf
<br/>
BINOBJS = $(OBJ)/arm9.bin
<br/>
NDSOBJS = $(OBJ)/demo1.nds
<br/>
<br/>
$(TARGET) : $(NDSOBJS)
<br/>
$(NDSOBJS) : $(BINOBJS)
<br/>
$(BINOJS) : $(ELFOBJS)
<br/>
$(ELFOBJS) : $(APPOBJS)
<br/>
<br/>
# Common build options
<br/>
CPPFLAGS += -DMTC_LIB -DNDS -DARM9
<br/>
<br/>
<br/>
########################
<br/>
# Tools
<br/>
<br/>
# C compiler
<br/>
CC = arm-eabi-g++
<br/>
CFLAGS = -c -mcpu=arm9tdmi -mtune=arm9tdmi -ffast-math -mthumb-interwork
<br/>
CCOUT = -o 
<br/>
CPPFLAGS += $(INCLUDE)
<br/>
CSTRICT = -pedantic
<br/>
<br/>
# Warnings
<br/>
CFLAGS += -Wall -W -Wunused\
<br/>
 -Wpointer-arith -Wwrite-strings -Wcast-qual -Wcast-align -Wshadow \
<br/>
 -Wno-nested-externs -Wstrict-prototypes -Wmissing-prototypes -Wmissing-declarations
<br/>
<br/>
# gcc 2.95.2-9 extras.  Linux kernel 2.2.12 ships with gcc 2.7.2
<br/>
CFLAGS += -Wmultichar -Wunknown-pragmas -Wsign-compare
<br/>
<br/>
# C++ compiler
<br/>
CXX = arm-eabi-g++
<br/>
CXXFLAGS = -c -x c++ -mcpu=arm9tdmi -mtune=arm9tdmi -ffast-math -mthumb-interwork
<br/>
CXXSTRICT = -pedantic
<br/>
<br/>
# C++ warnings
<br/>
CXXFLAGS += -Wall -W -Wunused \
<br/>
 -Wpointer-arith -Wwrite-strings -Wcast-qual -Wcast-align -Wshadow \
<br/>
 -ffor-scope \
<br/>
 -Wno-reorder -Wno-ctor-dtor-privacy \
<br/>
 -Wno-effc++ -Wno-old-style-cast
<br/>
<br/>
# NB g++ 2.95.2 doesnt put STL iterators in std:: so force no-honor-std
<br/>
#CXXFLAGS += -fno-honor-std
<br/>
<br/>
# Assembler
<br/>
AS = arm-eabi-as
<br/>
ASFLAGS = 
<br/>
ASOUT = -o 
<br/>
<br/>
# Linker
<br/>
LD = arm-eabi-g++
<br/>
LDFLAGS = -g -mthumb-interwork -mno-fpu -specs=ds_arm9.specs
<br/>
LDOUT = -o 
<br/>
<br/>
# Lib
<br/>
AR = arm-eabi-ar
<br/>
ARFLAGS = r
<br/>
<br/>
# Elf to Bin Objcopy
<br/>
OBJCOPY = arm-eabi-objcopy
<br/>
OBJCOPYFLAGS = 
<br/>
OBJCOPYOUT = -o
<br/>
<br/>
# NDSTool
<br/>
NDSTOOL = ndstool
<br/>
NDSTOOLFLAGS = 
<br/>
NDSTOOLOUT = -c
<br/>
<br/>
# DSBuild
<br/>
DSBUILD = dsbuild
<br/>
DSBUILDFLAGS = 
<br/>
DSBUILDOUT = -o
<br/>
<br/>
ifdef DEBUG
<br/>
<br/>
# Debug options
<br/>
CFLAGS += -ggdb -g3
<br/>
CXXFLAGS += -ggdb -g3
<br/>
CPPFLAGS += -DMTC_DEBUG=$(DEBUG)
<br/>
#ASFLAGS += -defsym MTC_DEBUG=$(DEBUG) --gdwarf2
<br/>
ASFLAGS += -DMTC_DEBUG=$(DEBUG) /Zi
<br/>
LDFLAGS += -ggdb -g3
<br/>
<br/>
ifeq ( 1, 0)
<br/>
#Force C++ compile/link
<br/>
CC = $(CXX)
<br/>
CFLAGS = $(CXXFLAGS)
<br/>
CSTRICT = $(CXXSTRICT)
<br/>
LD = $(CXX)
<br/>
endif
<br/>
<br/>
else
<br/>
<br/>
# Release options
<br/>
CFLAGS += -O3 -fomit-frame-pointer
<br/>
CXXFLAGS += -O3
<br/>
CPPFLAGS += -DNDEBUG
<br/>
ASFLAGS += -DNDEBUG=1
<br/>
LDFLAGS += -s # strip symbols
<br/>
<br/>
endif
<br/>
<br/>
<br/>
########################
<br/>
# SwsMtc library
<br/>
<br/>
ifndef DEBUG
<br/>
MTC = mtcarm9
<br/>
else
<br/>
MTC = mtcarm9d
<br/>
endif
<br/>
<br/>
LIBS = -L$(MTCDIR) -L$(NDSLIB_LIB)
<br/>
LIBS += -l$(MTC) -lnds9
<br/>
<br/>
LIBRARY = $(MTCDIR)/lib$(MTC).a
<br/>
<br/>
$(LIBRARY) :
<br/>
	$(MAKE) -C $(MTCDIR) lib$(MTC).a
<br/>
<br/>
$(TARGET) : $(LIBRARY)
<br/>
<br/>
<br/>
########################
<br/>
# Implicit rules
<br/>
<br/>
.SUFFIXES :
<br/>
.SUFFIXES : .nds .bin .elf .c .cpp .asm .h .obj .a
<br/>
<br/>
$(OBJ)/%.nds : %.bin
<br/>
	$(NDSTOOL) $(NDSTOOLFLAGS) $(NDSTOOLOUT)$@ -9 $&lt;
<br/>
<br/>
$(OBJ)/%.bin : %.elf
<br/>
	$(OBJCOPY) $(OBJCOPYFLAGS) $(OBJCOPYOUT)$@  $&lt;
<br/>
<br/>
$(OBJ)/%.elf : %.obj
<br/>
	$(LD) $(LDFLAGS) $(LDOUT)$@ $^ $(LIBS)
<br/>
<br/>
$(OBJ)/%.obj : %.c
<br/>
	$(CC) $(CSTRICT) $(CFLAGS) $(CPPFLAGS) $(CCOUT)$@ $&lt;
<br/>
<br/>
$(OBJ)/%.obj : %.cpp
<br/>
	$(CXX) $(CXXSTRICT) $(CXXFLAGS) $(CPPFLAGS) $(CCOUT)$@ $&lt;
<br/>
<br/>
$(OBJ)/%.obj : %.asm
<br/>
	$(AS) $(ASFLAGS) $(ASOUT)$@ $&lt;
<br/>
<br/>
########################
<br/>
# Explicit rules for building objects go here.
<br/>
<br/>
all : $(TARGET)
<br/>
<br/>
$(OBJ) :
<br/>
	-mkdir $(OBJDIR)
<br/>
<br/>
$(TARGET) : $(OBJ) $(NDSOBJS)
<br/>
	$(DSBUILD) $(NDSOBJS) $(DSBUILDFLAGS) $(DSBUILDOUT) $@
<br/>
<br/>
$(NDSOBJS) : $(BINOBJS)
<br/>
	$(NDSTOOL) $(NDSTOOLFLAGS) $(NDSTOOLOUT)$@ -9 $&lt;
<br/>
<br/>
$(BINOJS) : $(ELFOBJS)
<br/>
	$(OBJCOPY) $(OBJCOPYFLAGS) $(OBJCOPYOUT)$@ $&lt;
<br/>
<br/>
$(ELFOBJS) : $(APPOBJS)
<br/>
	$(LD) $(LDFLAGS) $(LDOUT)$@ $^ $(LIBS)
<br/>
<br/>
clean :
<br/>
	-rm -r -f $(OBJDIR)
<br/>
	-rm -f $(TARGET)
<br/>
<br/>
<br/>
########################
<br/>
# Dependencies
<br/>
DEPEND = $(OBJ) # $(MAKEFILE)
<br/>
<br/>
$(APPOBJS): $(DEPEND) $(INC2)/mtc.h
<br/>
<br/>
# End of file</td> </tr></table><span class="postbody">
<br/>
<br/>
Right, so there's the makefile. When I run make I get this:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">$ make
<br/>
make: *** No rule to make target `arm9.elf', needed by `rel/arm9.bin'.  Stop.</td> </tr></table><span class="postbody">
<br/>
<br/>
From the looks of it, the problem may be here:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">$(OBJ)/%.elf : %.obj
<br/>
	$(LD) $(LDFLAGS) $(LDOUT)$@ $^ $(LIBS)</td> </tr></table><span class="postbody">
<br/>
<br/>
or here:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">$(ELFOBJS) : $(APPOBJS)
<br/>
	$(LD) $(LDFLAGS) $(LDOUT)$@ $^ $(LIBS)</td> </tr></table><span class="postbody">
<br/>
<br/>
Is this the case? From the looks of it it seems to be having issue with the rule that calls the linked on .obj files, to the extent that it's not bothering to get to the point of actually compiling the source files...
<br/>
<br/>
Or rather, to illustrate it as a chain...
<br/>
<br/>
.nds.gba &lt;- .nds &lt;- .bin &lt;- .elf &lt;.o &lt; .c
<br/>
<br/>
With the problem occurring when make attempts to follow the rule chain from .elf to .o
<br/>
<br/>
Does anyone have any advice on this? What am I doing wrong?
<br/>
<br/>
EDIT: Quote has buggered up the tabs, so don't worry about the makefile's tabbing being screwed (Which causes problems in real life :-)<br/>_________________<br/>"My boot, your face..." - Attributed to OOPMan, Emperor of Eroticon VI
<br/>
<br/>
You can find my NDS homebrew projects <a class="postlink" href="http://blog.dev-scene.com/oopman/" target="_blank">here...</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#104784 - sasq - Mon Oct 02, 2006 4:53 pm</h4>
    <div class="postbody"><span class="postbody">I think the problem is that mix between rules for files in the OBJ-dir and not - ie the elf file is created in the OBJ-dir but the elf-&gt;bin rule looks for it outside the OBJ-dir
<br/>
<br/>
If you want all your created files to end up in the $(OBJ)-dir you need
<br/>
to do this:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
$(OBJ)/%.nds : $(OBJ)/%.bin 
<br/>
$(NDSTOOL) $(NDSTOOLFLAGS) $(NDSTOOLOUT)$@ -9 $&lt; 
<br/>
<br/>
$(OBJ)/%.bin : $(OBJ)/%.elf 
<br/>
$(OBJCOPY) $(OBJCOPYFLAGS) $(OBJCOPYOUT)$@ $&lt; 
<br/>
<br/>
$(OBJ)/%.elf : $(OBJ)/%.obj 
<br/>
$(LD) $(LDFLAGS) $(LDOUT)$@ $^ $(LIBS)
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
or if you want say the bin,elf and nds files outside, and only o-files in OBJ, do this:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
%.nds : %.bin 
<br/>
$(NDSTOOL) $(NDSTOOLFLAGS) $(NDSTOOLOUT)$@ -9 $&lt; 
<br/>
<br/>
%.bin : %.elf 
<br/>
$(OBJCOPY) $(OBJCOPYFLAGS) $(OBJCOPYOUT)$@ $&lt; 
<br/>
<br/>
%.elf : $(OBJ)/%.obj 
<br/>
$(LD) $(LDFLAGS) $(LDOUT)$@ $^ $(LIBS)
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#104790 - OOPMan - Mon Oct 02, 2006 5:53 pm</h4>
    <div class="postbody"><span class="postbody">Thanks for that, it helped...
<br/>
<br/>
I've come across another problem though, a funny one really...
<br/>
<br/>
Changing the makefile as you suggested works fine, but with one caveat.
<br/>
<br/>
Calling make the first time produces:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">$ make
<br/>
mkdir ./rel
<br/>
make: *** No rule to make target `rel/arm9.bin', needed by `demo1.nds'.  Stop.</td> </tr></table><span class="postbody">
<br/>
<br/>
However, running make again works fine. At the moment the makefile is setup to produce and .nds and .nds.gba file in the root directory.
<br/>
<br/>
A dirty fix is to change the $(OBJ) rule as follows:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">$(OBJ) :
<br/>
	-mkdir $(OBJDIR)
<br/>
	make</td> </tr></table><span class="postbody">
<br/>
<br/>
While I'm happy to leave it like this, it would be nice if I could get it working without a recursive call to make.
<br/>
<br/>
From the look if it the error is occuring because the rel directory hasn't registered as being created when the rule to make arm9.bin is called.
<br/>
<br/>
Any suggestions?<br/>_________________<br/>"My boot, your face..." - Attributed to OOPMan, Emperor of Eroticon VI
<br/>
<br/>
You can find my NDS homebrew projects <a class="postlink" href="http://blog.dev-scene.com/oopman/" target="_blank">here...</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#104792 - sasq - Mon Oct 02, 2006 6:06 pm</h4>
    <div class="postbody"><span class="postbody">First its strange that you have both OBJ and OBJDIR that seems to mean the same thing - you can get rid of OBJDIR.
<br/>
<br/>
What you want is this
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
all : $(OBJ) $(TARGET)
<br/>
<br/>
$(OBJ) :
<br/>
    -mkdir $(OBJ)
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#104799 - OOPMan - Mon Oct 02, 2006 8:22 pm</h4>
    <div class="postbody"><span class="postbody">Okay, but doing that doesn't actually have any effect on the problem, it's just a quirk that the author of the makefile uses...<br/>_________________<br/>"My boot, your face..." - Attributed to OOPMan, Emperor of Eroticon VI
<br/>
<br/>
You can find my NDS homebrew projects <a class="postlink" href="http://blog.dev-scene.com/oopman/" target="_blank">here...</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#104804 - sasq - Mon Oct 02, 2006 8:45 pm</h4>
    <div class="postbody"><span class="postbody">yeah but the code I quoted should make sure the objdir is created before the target is built</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#104847 - OOPMan - Tue Oct 03, 2006 7:49 am</h4>
    <div class="postbody"><span class="postbody">Unfortunately I tried that, figuring pretty much the same thing, and it didn't work :-(
<br/>
<br/>
It's a little strange, don't you think?
<br/>
<br/>
Well, anyway, I'm actually happy to leave it using the recursive make call as a fix. It may not look ultra-professional or anything, but it works :-)<br/>_________________<br/>"My boot, your face..." - Attributed to OOPMan, Emperor of Eroticon VI
<br/>
<br/>
You can find my NDS homebrew projects <a class="postlink" href="http://blog.dev-scene.com/oopman/" target="_blank">here...</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#104860 - gmiller - Tue Oct 03, 2006 1:33 pm</h4>
    <div class="postbody"><span class="postbody">Not sure if this would help but to see the actual order that the rules are being evaluated in do a "make -n" in your start state and it will show you the commands without executing them.  You proably already knew this so it is just useless information.  There is also the "-d" switch which will turn on makefile debugging as well.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#104862 - sasq - Tue Oct 03, 2006 3:18 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>OOPMan wrote:</b></span></td> </tr> <tr> <td class="quote">Unfortunately I tried that, figuring pretty much the same thing, and it didn't work :-(
<br/>
<br/>
It's a little strange, don't you think?
<br/>
<br/>
Well, anyway, I'm actually happy to leave it using the recursive make call as a fix. It may not look ultra-professional or anything, but it works :-)</td> </tr></table><span class="postbody">
<br/>
<br/>
Very strange, especially since the Makefile you quoted has the problem described since I think it evalulates the NDSOBJ-dependies of TARGET before the OBJS-dependency - thats why putting it before TARGET int the 'all:' rule instead should have worked...
<br/>
<br/>
You should maybe also try removing these initial rules;
<br/>
<br/>
$(TARGET) : $(NDSOBJS) 
<br/>
$(NDSOBJS) : $(BINOBJS) 
<br/>
$(BINOJS) : $(ELFOBJS) 
<br/>
$(ELFOBJS) : $(APPOBJS)
<br/>
<br/>
since they are repeated later with proper commands after them.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#104926 - OOPMan - Wed Oct 04, 2006 9:53 am</h4>
    <div class="postbody"><span class="postbody">Hmmmmm, removing those initial targets causes the makefile to think it'
<br/>
s trying to build the base MTC library :-) (This is because the next target is for the library :-)
<br/>
<br/>
I also tried adding $(OBJ) to the first $(TARGET) rule, but to no effect...
<br/>
<br/>
Very peculiar...
<br/>
<br/>
Still, at least the recursive make call works :-)<br/>_________________<br/>"My boot, your face..." - Attributed to OOPMan, Emperor of Eroticon VI
<br/>
<br/>
You can find my NDS homebrew projects <a class="postlink" href="http://blog.dev-scene.com/oopman/" target="_blank">here...</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#104931 - sasq - Wed Oct 04, 2006 12:23 pm</h4>
    <div class="postbody"><span class="postbody">Ah, that's true - the ALL rule should normally be the first explicit rule. If you type "make all" it should create the OBJDIR first like expected.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#104961 - masscat - Wed Oct 04, 2006 6:54 pm</h4>
    <div class="postbody"><span class="postbody">If you do not give make a target on the command line then it will set its goal (the target it is ultimately trying to make) as the first target it finds in the makefile. The 'all' target does not have a special meaning, it is just convention that it gets used as the target to make all the top-level targets.
<br/>
<br/>
See the <a class="postlink" href="http://www.gnu.org/software/make/manual/make.html#How-Make-Works" target="_blank">GNU make manual</a> page for full description.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
