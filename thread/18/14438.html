<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>How get how much memory is free? - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>DS development > How get how much memory is free?</h2>
<div id="posts">
<div class="post">
    <h4>#144299 - Programix - Wed Oct 31, 2007 8:46 am</h4>
    <div class="postbody"><span class="postbody">Can I get somehow value of how much ram or vram is free?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#144300 - Mighty Max - Wed Oct 31, 2007 8:58 am</h4>
    <div class="postbody"><span class="postbody">Use meminfo for the wram
<br/>
<br/>
vram is manually assigned. Thus you should allways know how much there is, and how much there is left in the different banks<br/>_________________<br/><a class="postlink" href="http://mightymax.org/gbamp_multiboot.html" target="_blank">GBAMP Multiboot</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#144306 - Programix - Wed Oct 31, 2007 11:38 am</h4>
    <div class="postbody"><span class="postbody">What is meminfo?? :D how to use it?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#144312 - Mighty Max - Wed Oct 31, 2007 1:37 pm</h4>
    <div class="postbody"><span class="postbody">Oh, i memorized the wrong name. It's mallinfo:
<br/>
<br/>
<a href="http://www.delorie.com/djgpp/doc/libc/libc_550.html" target="_blank">http://www.delorie.com/djgpp/doc/libc/libc_550.html</a><br/>_________________<br/><a class="postlink" href="http://mightymax.org/gbamp_multiboot.html" target="_blank">GBAMP Multiboot</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#144314 - Programix - Wed Oct 31, 2007 2:17 pm</h4>
    <div class="postbody"><span class="postbody">Thanks very much!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#144339 - tepples - Wed Oct 31, 2007 7:44 pm</h4>
    <div class="postbody"><span class="postbody">mallinfo doesn't appear to be in &lt;stdlib.h&gt; of devkitARM R20, but it's in &lt;malloc.h&gt;.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#144626 - conejoroy - Sun Nov 04, 2007 11:30 pm</h4>
    <div class="postbody"><span class="postbody">just a question... I'm having a very strange bug that seems to corrupt the stack when I call a function with several parameters which also declares some local variables.
<br/>
<br/>
<span style="font-weight: bold">Using this code:</span>
<br/>
<br/>
struct mallinfo info = mallinfo();
<br/>
<br/>
 printf("Memory in use: %d bytes\n", info.usmblks + info.uordblks);
<br/>
 printf("Total heap size: %d bytes\n", info.arena);
<br/>
<br/>
<span style="font-weight: bold">The output is:</span>
<br/>
<br/>
<span style="font-style: italic">Memory in use: <span style="font-weight: bold">160720 bytes</span>
<br/>
Total heap size: <span style="font-weight: bold">165160 bytes</span></span>
<br/>
<br/>
Well I do use some "new" allocations (around 160kb, yes) but <span style="font-weight: bold">Total heap size 165kb???</span> o_0 this is not correct right? (but it can explain my memory corruption problems though...)
<br/>
<br/>
165kb?? I'm doing something wrong or what t.t?
<br/>
<br/>
Well thanks ^^!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#144653 - Cydrak - Mon Nov 05, 2007 11:18 am</h4>
    <div class="postbody"><span class="postbody">I fussed with this the other day, it seems to be normal behavior.
<br/>
<br/>
On a desktop OS, malloc() obviously must share memory with other apps, it can't just grab it all. Instead, it calls sbrk() to expand the heap. This is the size reported in info.arena (on the DS). It will always be at least a little bigger than your own allocs; malloc() requires some of its own. It could be a lot bigger if stuff was freed in the meantime.
<br/>
<br/>
If you want both used and free RAM, this might help:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#include &lt;unistd.h&gt;
<br/>
#include &lt;malloc.h&gt;
<br/>
<br/>
extern u8 __end__[];        // end of static code and data
<br/>
extern u8 __eheap_end[];    // farthest point to which the heap will grow
<br/>
<br/>
u8* getHeapStart() {
<br/>
   return __end__;
<br/>
}
<br/>
u8* getHeapEnd() {
<br/>
   return (u8*)sbrk(0);
<br/>
}
<br/>
u8* getHeapLimit() {
<br/>
   return __eheap_end;
<br/>
}
<br/>
int getMemUsed() {
<br/>
   struct mallinfo mi = mallinfo();
<br/>
   return mi.uordblks;
<br/>
}
<br/>
int <b style="color:#FFA34F">getMemFree</b>() {
<br/>
   struct mallinfo mi = mallinfo();
<br/>
   return mi.fordblks + (getHeapLimit() - getHeapEnd());
<br/>
}
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167803 - a128 - Sat Mar 28, 2009 8:47 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Cydrak wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
<br/>
If you want both used and free RAM, this might help:
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
THANKS !!! I just used your <b style="color:#FFA34F">getMemFree</b> in my application.....great!!!!!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167806 - Dwedit - Sat Mar 28, 2009 9:46 pm</h4>
    <div class="postbody"><span class="postbody">Just watch out, if you allocate something big, then something little, then deallocate the big thing, you're stuck with a big hole in free ram until you deallocate the little thing too.
<br/>
<br/>
in other words:
<br/>
Allocate A[500,000 bytes]
<br/>
Allocate B[200 bytes]
<br/>
<br/>
Deallocate A
<br/>
You don't get the free ram back from A until you deallocate B as well.
<br/>
<br/>
So try to allocate things in the order you deallocate them if you don't want something like that to happen.<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167807 - nanou - Sun Mar 29, 2009 12:36 am</h4>
    <div class="postbody"><span class="postbody">Are you sure that's right? The description of newlib's malloc suggests (to me anyway) that it will gladly reuse those old chunks. I think the real issue is that region A can't be used as part of a larger allocation because B is allocated between it and any future sbrk'd memory.
<br/>
<br/>
It's easy enough to test:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#define MALLOC_TEST_SIZE 500000
<br/>
<br/>
char *a, *b;
<br/>
a = (char *)malloc(sizeof(char) * MALLOC_TEST_SIZE);
<br/>
for(;;) {
<br/>
  b = (char *)malloc(sizeof(char) * MALLOC_TEST_SIZE);
<br/>
  
<br/>
  if(b==NULL) {
<br/>
    throw_a_fit();
<br/>
  }
<br/>
  
<br/>
  free(a);
<br/>
  a = b;
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
If I'm right that will go on forever without calling throw_a_fit(). (I'd have just tested a!=NULL in the for(), but I wanted to be more obvious than that.)<br/>_________________<br/>- nanou</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167821 - albinofrenchy - Mon Mar 30, 2009 12:22 am</h4>
    <div class="postbody"><span class="postbody">I agree with nanou on this one, I think dwedit is thinking of sbrk's. They can only go up and down, but it will allocate space if it can find a cavity I believe. 
<br/>
<br/>
Would be good to know if I'm wrong though.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167824 - elhobbs - Mon Mar 30, 2009 2:22 am</h4>
    <div class="postbody"><span class="postbody">this information is of limited use at runtime. it can only be used to tell if a malloc will definitely fail. it can not reliably tell if a malloc will succeed. fragmentation will limit the maximum contiguous size that malloc can return. the best way to tell if malloc will succeed is to call malloc. well, that and planning your working set size to not exceed your resources.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
