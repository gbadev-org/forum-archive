<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Wifi - Ad-Hoc (Sending Structures) - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > Wifi - Ad-Hoc (Sending Structures)</h2>
<div id="posts">
<div class="post">
    <h4>#168670 - DarkShadow44 - Thu May 14, 2009 7:30 pm</h4>
    <div class="postbody"><span class="postbody">Hello!
<br/>
I'm trying to send a struct with the wifi functions, but I can't receive them.
<br/>
Do you know what's wrong with this code:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#include &lt;nds.h&gt; 
<br/>
#include &lt;stdio.h&gt; 
<br/>
#include &lt;dswifi9.h&gt; 
<br/>
#include &lt;string.h&gt; 
<br/>
<br/>
<br/>
<br/>
<br/>
typedef struct
<br/>
{
<br/>
   int a;
<br/>
   int b;
<br/>
}structure;
<br/>
<br/>
<br/>
<br/>
structure str1;
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
void Handler(int packetID, int readlength) 
<br/>
{ 
<br/>
   structure str2;
<br/>
   
<br/>
   str2.a=0;
<br/>
   str2.b=0;
<br/>
<br/>
   structure* strPtr2=&amp;str2;
<br/>
<br/>
<br/>
<br/>
   static int bytesRead; 
<br/>
<br/>
   bytesRead = Wifi_RxRawReadPacket(packetID, readlength, (unsigned short*)strPtr2); 
<br/>
<br/>
<br/>
   { 
<br/>
      iprintf("\x1b[1;0H\n Bytes: %d!\nRcv:%d , %d ", bytesRead,str2.a, str2.b); //Test Received Structure
<br/>
   } 
<br/>
} 
<br/>
<br/>
int main(void) 
<br/>
{ 
<br/>
   consoleDemoInit(); 
<br/>
<br/>
   Wifi_InitDefault(false); 
<br/>
   Wifi_SetPromiscuousMode(1); 
<br/>
   Wifi_EnableWifi(); 
<br/>
   Wifi_RawSetPacketHandler(Handler); 
<br/>
   Wifi_SetChannel(10); 
<br/>
<br/>
   iprintf("Press A to start"); 
<br/>
   
<br/>
   while(1) 
<br/>
   { 
<br/>
      scanKeys(); 
<br/>
      int pressed = keysDown(); 
<br/>
      if(pressed &amp; KEY_A) 
<br/>
         break; 
<br/>
   } 
<br/>
<br/>
   iprintf("\x1b[0;0H                      "); 
<br/>
<br/>
   int send = 0; 
<br/>
   int f; 
<br/>
<br/>
   str1.a=99;
<br/>
   str1.b=34;
<br/>
<br/>
   structure*strPtr1=&amp;str1;
<br/>
<br/>
<br/>
   while(1) 
<br/>
   { 
<br/>
      iprintf("\x1b[0;0HSending %d", send); 
<br/>
<br/>
      if(Wifi_RawTxFrameAdHoc(sizeof(structure), 0x0014, (unsigned short*)strPtr1) != 0) 
<br/>
      { 
<br/>
         iprintf("\n\nError calling RawTxFrame\n\n"); 
<br/>
      } 
<br/>
<br/>
      send++;
<br/>
      for(f = 0 ; f &lt; 6 ; f++) 
<br/>
         swiWaitForVBlank(); 
<br/>
   } 
<br/>
<br/>
   return 0; 
<br/>
} 
<br/>
 </td> </tr></table><span class="postbody">
<br/>
<br/>
The function RawTxFrameAdHoc is from here: <a class="postlink" href="http://forum.gbadev.org/viewtopic.php?t=16394&amp;postdays=0&amp;postorder=asc&amp;start=15" target="_blank">http://forum.gbadev.org/viewtopic.php?t=16394&amp;postdays=0&amp;postorder=asc&amp;start=15</a>  (I renamed the function RawTxFrameAdHoc)
<br/>
<br/>
<br/>
Please Help !!!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#168672 - Pete_Lockwood - Fri May 15, 2009 12:08 am</h4>
    <div class="postbody"><span class="postbody">If you have wireless routers around you, there's probably a good chance that code will crash because you'll receive frames from the routers that will be picked up by the Handler function and read into the tiny structure even though the frame is too big (i.e. memory corruption).
<br/>
<br/>
Are you able to get the actual test app that I posted working?  i.e. is the issue only with your changed copy of the code?  Or can't you get my code working either?<br/>_________________<br/>It's not an illusion, it just looks like one.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#168681 - DarkShadow44 - Fri May 15, 2009 4:04 pm</h4>
    <div class="postbody"><span class="postbody">I have the Example code from <a class="postlink" href="http://url" target="_blank">http://forum.gbadev.org/viewtopic.php?t=16394&amp;postdays=0&amp;postorder=asc&amp;start=15</a> .
<br/>
<br/>
I've tried this application and it worked...  
<br/>
It saves the data in  the arry </span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">unsigned short data [4096]</td> </tr></table><span class="postbody">
<br/>
<br/>
<br/>
Where can I download your app ?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#168687 - Pete_Lockwood - Fri May 15, 2009 5:10 pm</h4>
    <div class="postbody"><span class="postbody">Sorry, I meant the test app in that post.  If that worked for you, as it certainly should, perhaps the only issue is that you're using a small buffer to receive data into.  You could try this change to the handler:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
void Handler(int packetID, int readlength)
<br/>
{
<br/>
   static char data[4096];
<br/>
   static int bytesRead;
<br/>
   structure *str2;
<br/>
   
<br/>
   bytesRead = Wifi_RxRawReadPacket(packetID, readlength, (unsigned short *)data);
<br/>
   {
<br/>
      str2 = (structure *)data;
<br/>
      iprintf("\x1b[1;0H\n Bytes: %d!\nRcv:%d , %d ", bytesRead,str2-&gt;a, str2-&gt;b); //Test Received Structure
<br/>
   }
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Note, I haven't even tried compiling this so syntax might be slightly off but this should give you an idea anyway.
<br/>
<br/>
This code would still treat every packet received as if it was a "structure" packet, including packets from Wifi routers so it would still need to be improved to filter out garbage, perhaps by putting a checksum into the structure and validating that when you receive the data.<br/>_________________<br/>It's not an illusion, it just looks like one.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#168690 - DarkShadow44 - Fri May 15, 2009 6:43 pm</h4>
    <div class="postbody"><span class="postbody">Could it also be the wrong size to send the structure ?
<br/>
Or wrong casting ?
<br/>
<br/>
And how can I create a Checksum ?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#168693 - elhobbs - Fri May 15, 2009 9:31 pm</h4>
    <div class="postbody"><span class="postbody">I am not sure if you read the whole thread about how this code works, but you may want to before you invest a lot of time making this work. It sends all of the packets as if they are AP management packets (the ds receives AP management packets by default and none of the exisiting wifi libs can set the filter to receive non-management packets reliably).
<br/>
<br/>
This can have a very detrimental effect on wifi APs and systems connected to said APs that are in range of this transmission. essentially no one is going to want to run your code if you are doing this. if it is just for yourself and you do not need to worry about breaking wifi for those around you then maybe it is not an issue.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#168707 - DarkShadow44 - Sat May 16, 2009 11:25 am</h4>
    <div class="postbody"><span class="postbody">But does it work with a checksum, and how can I use checksums for wifi ?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#168708 - elhobbs - Sat May 16, 2009 2:38 pm</h4>
    <div class="postbody"><span class="postbody">no, it will not help your code work. he is suggesting a checksum to differentiate all of the legitimate AP management frames from the hack ones that this code is sending out.
<br/>
<br/>
most likely your code is dying when it receives the first packet because your buffer is too small. you are assuming all of the packets you receive are yours and of a fixed size.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#168711 - DarkShadow44 - Sat May 16, 2009 5:02 pm</h4>
    <div class="postbody"><span class="postbody">But how could I check if it is my packet ?
<br/>
<br/>
It also hangs, if I use 2 DS for sending and receiving...
<br/>
Sometimes it don't hangs, it displays only wrong values.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#168715 - elhobbs - Sat May 16, 2009 7:09 pm</h4>
    <div class="postbody"><span class="postbody">perhaps you should try your favorite search engine and search for "checksum"... then come back when you have a specific question.
<br/>
<br/>
you may want to take a look at "buffer overflow" too...</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
