<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>HELP! filesystem problem while using interruption handler - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > HELP! filesystem problem while using interruption handler</h2>
<div id="posts">
<div class="post">
    <h4>#154376 - gorgull - Tue Apr 15, 2008 12:09 pm</h4>
    <div class="postbody"><span class="postbody">Hello,
<br/>
<br/>
I'm the ProteinDS author: <a href="http://gorgull.googlepages.com/protein" target="_blank">http://gorgull.googlepages.com/protein</a>
<br/>
and I'm actually stuck on a very very annoying problem, which I guess is related to the Fat library.
<br/>
<br/>
Basically, in arm9 processor, I'm using a fifo interruption handler triggered by an arm7 timer, as an audio callback system. As my program streams audio data from cartridge, fread is called every single audio frame (even several times during each audio frame, when several tracks play at the same time) - no problem with that, it works perfectly well.
<br/>
<br/>
The problem happened when started to call fopen out of the audio callback: sometimes fopen failed (or even crashed); it took me a few days to think fopen call may be interrupted by audio callback, so may be messed up then (am I right?).  
<br/>
<br/>
So I decided to do every filesystem calls in the audio interrupt, in order to avoid fopen to be interrupted during its execution; my guess seemed good: no more fopen failure, but another problem happened: depending on the current processing and the size of the file I want to open, fopen call locks the audio fifo interrupt handling - arm7 timer still goes on, but arm9 side interruption is totally locked (the more processing during the audio frame and the more sized file I want to open, the more chance I got a failure) :-/
<br/>
<br/>
Do I need to push then pop some special registers before every filesystem calls or something like that?
<br/>
<br/>
As I'm more a computer developer, I can't really figure out what's behind filesystem calls on DS hardware. 
<br/>
<br/>
Does anyone have an idea about what I could do about this?
<br/>
<br/>
Thx in advance :-)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#154380 - simonjhall - Tue Apr 15, 2008 1:23 pm</h4>
    <div class="postbody"><span class="postbody">Hang on, so when are you doing the fopen?
<br/>
<br/>
It's okay to do file access in interrupt handlers, as far as I can tell. The interrupts are not nested, y'see. However you need to ensure that file access is not done from multiple threads so don't do file stuff in the main thread as well as interrupt handlers, or if you do make sure you put some kind of locking around all file-related functions.<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#154382 - gorgull - Tue Apr 15, 2008 1:35 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Hang on, so when are you doing the fopen? </td> </tr></table><span class="postbody">
<br/>
<br/>
At first, I was doing fopen calls in the "main" execution thread (the VBlank one), and fread calls in the audio interruption thread --&gt; because interrupt has absolute priority, fread had no problem, but fopen sometimes failed.
<br/>
<br/>
Then I tried to put fopen in the same thread as fread, but when the files are big (several tens MB), interruption is locked after the fopen call (which succeeds anyway).
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">It's okay to do file access in interrupt handlers, as far as I can tell. The interrupts are not nested, y'see. However you need to ensure that file access is not done from multiple threads so don't do file stuff in the main thread as well as interrupt handlers, or if you do make sure you put some kind of locking around all file-related functions.</td> </tr></table><span class="postbody">
<br/>
<br/>
I think the best and easiest for me is to keep fopen calls in main thread, but how to make sure interrupt won't happen in the middle of fopen call then?
<br/>
If it's not possible, why does fopen lock the fifo execution when called in interruption thread?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#154383 - simonjhall - Tue Apr 15, 2008 1:55 pm</h4>
    <div class="postbody"><span class="postbody">The only thread that can be interrupted (ie stopped mid-execution) with the current set-up is the main thread. So if you put anything file-related in there, make sure you put some atomic locks around those calls.<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#154384 - gorgull - Tue Apr 15, 2008 2:17 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">The only thread that can be interrupted (ie stopped mid-execution) with the current set-up is the main thread.</td> </tr></table><span class="postbody">
<br/>
<br/>
I got it - that's what my fopen failed in the first place.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">you put some atomic locks</td> </tr></table><span class="postbody">
<br/>
<br/>
How can I use an atomic lock, as I don't know when an audio callback will happen?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#154387 - thoduv - Tue Apr 15, 2008 4:05 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>gorgull wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">you put some atomic locks</td> </tr></table><span class="postbody">
<br/>
<br/>
How can I use an atomic lock, as I don't know when an audio callback will happen?</span></td> </tr></table><span class="postbody">
<br/>
Lock:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">u32 lock = REG_IME;
<br/>
REG_IME = 0;
<br/>
</td> </tr></table><span class="postbody">
<br/>
Unlock:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">REG_IME = lock;</td> </tr></table><span class="postbody">
<br/>
That way, you can be sure the code between lock/unlock won't be paused by an interruption of any kind.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#154524 - gorgull - Thu Apr 17, 2008 12:47 pm</h4>
    <div class="postbody"><span class="postbody">Ok, thanks for the answer.
<br/>
<br/>
I just tested this lock around fopen, which is called in the main thread. 
<br/>
<br/>
Unfortunately, the result is the same as if I call fopen in the audio thread : the interrupt locks just after the fopen call.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
