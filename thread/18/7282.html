<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Turning off a backlight - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > Turning off a backlight</h2>
<div id="posts">
<div class="post">
    <h4>#58575 - josath - Mon Oct 24, 2005 6:18 pm</h4>
    <div class="postbody"><span class="postbody">I'm trying to turn off a backlight. But for some reason, both backlights, and the sound amp turn off when I do this. The only part I'm not sure about is 3, what is the 'register offset'?
<br/>
From neimod's <a class="postlink" href="http://neimod.com/dstek/dstek2.xml" target="_blank">DSTek</a>:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
Reading and writing powermanagement registers
<br/>
1. Wait until the SPI busy flag is cleared
<br/>
2. Enable SPICNT, with baudrate 1MHz, powermanagement device, 8 clocks, and continuous mode.
<br/>
3. Set SPIDATA to the register offset
<br/>
   a)To read from the PM register, enable bit 7.
<br/>
   b)To write to the PM register, clear bit 7.
<br/>
4. Wait until the SPI busy flag is cleared
<br/>
5. Set SPICNT to single byte mode now
<br/>
6. a)Set SPIDATA to 0
<br/>
   b)Set SPIDATA to the register value you want to write.
<br/>
7. a)Wait until the SPI busy flag is cleared
<br/>
8. a)the lower 8bits of SPIDATA now contain the contents of the PM register.
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
My code (numbers indicate which step it corresponds to):
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
        SerialWaitBusy(); //1
<br/>
        REG_SPICNT = SPI_ENABLE | SPI_BAUD_1MHz | SPI_DEVICE_POWER | SPI_8CLOCKS | SPI_CONTINUOUS; //2
<br/>
        REG_SPIDATA = 0; //3 - is this right?
<br/>
        SerialWaitBusy(); //4
<br/>
        REG_SPICNT = SPI_ENABLE | SPI_BAUD_1MHz | SPI_DEVICE_POWER | SPI_8CLOCKS | SPI_SINGLE_BYTE; //5
<br/>
        REG_SPIDATA = 0; //6a
<br/>
<br/>
        // This line should keep everything on, execpt for the bottom backlight. However, both backlights, and the sound amp turn off
<br/>
        REG_SPIDATA = PM_SOUND_PWR | PM_SOUND_VOL | PM_BACKLIGHT_TOP | PM_LED_CONTROL(0) | PM_SYSTEM_PWR; //6b
<br/>
<br/>
        SerialWaitBusy(); //7
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
FYI: SPI_8CLOCKS and SPI_SINGLE_BYTE are defined to 0, I just added them to be clear what I am doing.
<br/>
<br/>
Any suggestions where I went wrong? What exactly is "register offset"? My guess, is it means the 0 in the line "PM 0H - REG_PM_CONTROL - Powermanagement Control (Register 0h) (R/W)" which is why I'm currently setting it to 0.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#58576 - Mighty Max - Mon Oct 24, 2005 6:21 pm</h4>
    <div class="postbody"><span class="postbody">You only do step 6a when reading and 6b when writing. So remove the 6a line.
<br/>
<br/>
Also, you don't have to wait again, it is again a "a)" step that you only need when reading.<br/>_________________<br/><a class="postlink" href="http://mightymax.org/gbamp_multiboot.html" target="_blank">GBAMP Multiboot</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#58586 - josath - Mon Oct 24, 2005 7:05 pm</h4>
    <div class="postbody"><span class="postbody">Ok, now I'm doing this:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
        SerialWaitBusy(); //1
<br/>
        REG_SPICNT = SPI_ENABLE | SPI_BAUD_1MHz | SPI_DEVICE_POWER | SPI_8CLOCKS | SPI_CONTINUOUS; //2
<br/>
        REG_SPIDATA = 0; //3 - is this right?
<br/>
        SerialWaitBusy(); //4
<br/>
        REG_SPICNT = SPI_ENABLE | SPI_BAUD_1MHz | SPI_DEVICE_POWER | SPI_8CLOCKS | SPI_SINGLE_BYTE; //5
<br/>
<br/>
        // This line should keep everything on, execpt for the bottom backlight. 
<br/>
         REG_SPIDATA = PM_SOUND_PWR | PM_SOUND_VOL | PM_BACKLIGHT_TOP | PM_LED_CONTROL(0) | PM_SYSTEM_PWR; //6b
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
However, now the entire DS shuts down.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#58666 - Kir - Tue Oct 25, 2005 5:31 am</h4>
    <div class="postbody"><span class="postbody">Try to look in the Moonshell code. It has "backlight off on touchscreen when fullscreen video is being played" feature.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#59122 - josath - Sat Oct 29, 2005 8:53 am</h4>
    <div class="postbody"><span class="postbody">Got it to work...
<br/>
I just copied a7sleep.cpp &amp; a7sleep.h from moonshell (but the code was written by SaTa_JP) into my arm7 source folder, then run:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">a7lcd_select(PM_BACKLIGHT_TOP);</td> </tr></table><span class="postbody">
<br/>
and that turns off the bottom backlight. 
<br/>
<br/>
Other stuff in a7sleep is useful as well...like going to sleep when the lid is closed. this stuff (or something similar) should be integrated into libnds. I think the default arm7 should sleep on lid close (if it doesn't already...i'm a bit behind the latest cvs code)</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
