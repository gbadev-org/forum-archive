<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>malloc, EWRAM and ld problems - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > malloc, EWRAM and ld problems</h2>
<div id="posts">
<div class="post">
    <h4>#53791 - xflash - Sun Sep 11, 2005 11:58 pm</h4>
    <div class="postbody"><span class="postbody">Hello,
<br/>
<br/>
I'm currently porting some existing win32 code on the DS. I first try to compile my C++ code "as is".
<br/>
After 2 or 3 liters of coffee, and a sleepless night, I succeed in it.
<br/>
But my code crashs on some NULL return memory allocations.
<br/>
<br/>
While having read on this site all the concern met with malloc, I choose to replace thoses malloc with some static arrays.
<br/>
<span style="font-weight: bold">Before:</span>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">uint8* _itemArray;
<br/>
(...)
<br/>
_itemArray = (uint8*)malloc(MAX_ITEMS);
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
<span style="font-weight: bold">After:</span>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">uint8 _itemArray[MAX_ITEMS];
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
The problem is on the link phase. The linker couldn't place my code in Ewram I think. I've got this error : 
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">ld.exe: address 0x28006e8 of Test_08.arm9.elf section .bss is not within region ewram</td> </tr></table><span class="postbody">
<br/>
<br/>
What can I do? What is the limit of the binaries size to be loaded in EWram ?
<br/>
I already use GBFS (great thanks to Damian Yerrick!!!) to include some heavy datas (near 6MB).
<br/>
Isn't there other memory range where I could place some big temp arrays ? iwram ? the internal DS cache range ?
<br/>
<br/>
Thanks for your help !
<br/>
<br/>
xFlasH</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#53797 - tepples - Mon Sep 12, 2005 1:41 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>xflash wrote:</b></span></td> </tr> <tr> <td class="quote">What can I do? What is the limit of the binaries size to be loaded in EWram ?</td> </tr></table><span class="postbody">
<br/>
GBA EWRAM is 0.25 MiB. Nintendo DS EWRAM is 4 MiB.
<br/>
(1 MiB == 1,048,576 bytes)
<br/>
This has to cover your program, const data (such as a GBFS file inserted with bin2s), global variables, and the heap.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">I already use GBFS (great thanks to Damian Yerrick!!!)</td> </tr></table><span class="postbody">
<br/>
You're welcome.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote"> to include some heavy datas (near 6MB).
<br/>
Isn't there other memory range where I could place some big temp arrays ? iwram ? the internal DS cache range ?</td> </tr></table><span class="postbody">
<br/>
You could use the GBA ROM space (up to 32 MB), or you could use the CF of a GBA Movie Player (up to 2 GB).<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#53824 - xflash - Mon Sep 12, 2005 9:01 am</h4>
    <div class="postbody"><span class="postbody">Hi,
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tepples wrote:</b></span></td> </tr> <tr> <td class="quote">GBA EWRAM is 0.25 MiB. Nintendo DS EWRAM is 4 MiB.
<br/>
(1 MiB == 1,048,576 bytes)
<br/>
This has to cover your program, const data (such as a GBFS file inserted with bin2s), global variables, and the heap.
<br/>
</td> </tr></table><span class="postbody">
<br/>
The maximum memory allocation is about 1.5MBytes (detected under win32), my program is under 250kBytes, I've got some little global variables, but indeed the problem is about the heap which seems to be overfilled.
<br/>
This is why I try to replace malloc with static arrays, whith the issue I've described ...
<br/>
I couldn't understand what is so heavy with my code.
<br/>
I've tried to interpret the memory map generated with -map gcc option
<br/>
But it's a real pain :)
<br/>
Isn't there some docs to describe linkscript sections .bss .sbss .ewram .iwram ?
<br/>
I'm afraid that my code overlaps some Linker sections whitout to be so heavy.
<br/>
<br/>
thanks for your help
<br/>
<br/>
xf</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#53838 - tepples - Mon Sep 12, 2005 2:54 pm</h4>
    <div class="postbody"><span class="postbody">If you have an ELF file for your arm9 segment, try the 'nm' command to see if anything is overflowing RAM that ends at 0x02400000.
<br/>
<br/>
arm-elf-nm -n kitten.elf &gt; kitten.map.txt<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#53883 - xflash - Mon Sep 12, 2005 11:10 pm</h4>
    <div class="postbody"><span class="postbody">Thanks for your help.
<br/>
<br/>
Apparently the result seems to be good : 
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">(...)
<br/>
0208ebb4 B stub
<br/>
0208ebb8 B gGlobalMemoryLength
<br/>
0208ebbc B _currentTimeMillis
<br/>
0208ebc0 B _frameCount
<br/>
0208ebc4 B _pal
<br/>
0208edc4 B buf
<br/>
0208f1c4 B gNbLines
<br/>
0208f1c8 B g_debugMask
<br/>
0208f1cc b keysold
<br/>
0208f1ce b keys
<br/>
0208f1d0 b oldy
<br/>
0208f1d2 b oldx
<br/>
0208f1d4 b _ZZN9__gnu_cxx27__verbose_terminate_handlerEvE11terminating
<br/>
0208f1d8 b emergency_used
<br/>
0208f1dc b emergency_buffer
<br/>
0208f9dc b globals_static
<br/>
0208f9e4 B __new_handler
<br/>
0208f9e8 b fc_static
<br/>
0208f9ec B fake_heap_start
<br/>
0208f9f0 B fake_heap_end
<br/>
0208f9f4 B __malloc_current_mallinfo
<br/>
0208fa1c B __malloc_max_total_mem
<br/>
0208fa20 B __malloc_max_sbrked_mem
<br/>
0208fa24 B __malloc_top_pad
<br/>
0208fa28 b heap_end.2060
<br/>
0208fa2c b openfiles
<br/>
0208facc b monitor_stderr
<br/>
0208fad0 b monitor_stdout
<br/>
0208fad4 b monitor_stdin
<br/>
0208fad8 b std_files_checked
<br/>
0208fadc B _PathLocale
<br/>
0208fae0 B __mlocale_changed
<br/>
0208fae4 B __nlocale_changed
<br/>
0208fae8 A __end__
<br/>
0208fae8 A _end
<br/>
0208fae8 A end
<br/>
023ff000 A __eheap_end
<br/>
02400000 A __ewram_end
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
But it doesn't show the heap allocation (malloc/free) which I was obliged to leave for some really dynamic arrays, unless the .elf is not produced.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#53896 - tepples - Tue Sep 13, 2005 3:20 am</h4>
    <div class="postbody"><span class="postbody">For that, you'll have to monitor the variables whose names start with "__malloc_" at run time.
<br/>
<br/>
But either way, you won't be able to put 6 MB of stuff in a valid .nds file. You'll have to either use a *ds.gba file (if using a flash cart) or load one part at a time from the CF card (if using a GBA Movie Player) or win the <a class="postlink" href="http://sc.tri-bit.com/dswfb" target="_blank">Wi-Fi bounty</a> and load one part at a time from a SMB or HTTP server (if using WMB with FlashMe).<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#53916 - xflash - Tue Sep 13, 2005 9:09 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tepples wrote:</b></span></td> </tr> <tr> <td class="quote">For that, you'll have to monitor the variables whose names start with "__malloc_" at run time.
<br/>
</td> </tr></table><span class="postbody">
<br/>
Do you mean those one ? :
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">__malloc_current_mallinfo 
<br/>
__malloc_max_total_mem 
<br/>
__malloc_max_sbrked_mem 
<br/>
__malloc_top_pad 
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tepples wrote:</b></span></td> </tr> <tr> <td class="quote">But either way, you won't be able to put 6 MB of stuff in a valid .nds file. </td> </tr></table><span class="postbody">
<br/>
Yes I know. At present, my 6MBytes datas are stored on my EZII 256
<br/>
I just upload the nds code with wmb. The datas which I mentionned is some internal engine datas .
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tepples wrote:</b></span></td> </tr> <tr> <td class="quote">win the <a class="postlink" href="http://sc.tri-bit.com/dswfb" target="_blank">Wi-Fi bounty</a> and load one part at a time from a SMB or HTTP server (if using WMB with FlashMe).</td> </tr></table><span class="postbody">I'm not John Carmack:p
<br/>
<br/>
xf</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#53949 - tepples - Tue Sep 13, 2005 8:01 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>xflash wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tepples wrote:</b></span></td> </tr> <tr> <td class="quote">For that, you'll have to monitor the variables whose names start with "__malloc_" at run time.
<br/>
</td> </tr></table><span class="postbody">
<br/>
Do you mean those one ? :
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">__malloc_current_mallinfo 
<br/>
__malloc_max_total_mem 
<br/>
__malloc_max_sbrked_mem 
<br/>
__malloc_top_pad 
<br/>
</td> </tr></table><span class="postbody"></span></td> </tr></table><span class="postbody">
<br/>
Exacticalmente. Put some code in your program to print the values of those variables at various points, and you'll understand how much you're trying to allocate.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
