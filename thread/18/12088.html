<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Newb: Text over ExtRot Background - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>DS development > Newb: Text over ExtRot Background</h2>
<div id="posts">
<div class="post">
    <h4>#114242 - cheapo - Fri Jan 05, 2007 7:39 pm</h4>
    <div class="postbody"><span class="postbody">Heyas!
<br/>
<br/>
I'm trying to print text over a 16bit Extended Rotation Background, but it's not working. Can anyone point me what's wrong? Here's how I'm doing:
<br/>
<br/>
1. I set two main VRAM banks:
<br/>
<br/>
vramSetBankA( VRAM_A_MAIN_BG_0x6000000 );
<br/>
vramSetBankB( VRAM_B_MAIN_BG_0x6020000 );
<br/>
<br/>
2. I set the main screen to use two backgrounds:
<br/>
<br/>
videoSetMode( MODE_5_2D | DISPLAY_BG3_ACTIVE | DISPLAY_BG0_ACTIVE );
<br/>
<br/>
3. Init BG3 CR:
<br/>
<br/>
BG3_CR = BG_BMP16_256x256 | BG_BMP_BASE(0) | BG_PRIORITY(3);
<br/>
BG3_XDX = 1 &lt;&lt; 8;
<br/>
BG3_XDY = 0;
<br/>
BG3_YDX = 0;
<br/>
BG3_YDY = 1 &lt;&lt; 8;
<br/>
BG3_CX = 0;
<br/>
BG3_CY = 0;
<br/>
<br/>
4. Init BG0 CR:
<br/>
<br/>
BG0_CR = BG_MAP_BASE(31) | BG_PRIORITY(0);
<br/>
BG_PALETTE[255] = RGB15(31,31,31);
<br/>
<br/>
5. Init Console:
<br/>
<br/>
consoleInitDefault((u16*)SCREEN_BASE_BLOCK(31), (u16*)CHAR_BASE_BLOCK(0), 16);
<br/>
<br/>
That's it. Then I'm trying to draw something to BG3 (setting pixels using BG_GFX as the buffer) and then writing text over it (using iprintf), but the screen gets all garbled up.
<br/>
<br/>
If I disable all things related to BG0 and text, then BG3 gets painted correctly.
<br/>
<br/>
Thanks for any help!<br/>_________________<br/>There's no place like 127.0.0.1</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#114243 - NeX - Fri Jan 05, 2007 8:00 pm</h4>
    <div class="postbody"><span class="postbody">I do not think you need the second VRAM bank - not sure though.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#114254 - josath - Fri Jan 05, 2007 9:27 pm</h4>
    <div class="postbody"><span class="postbody">BG0 and BG3 are using the same location in VRAM
<br/>
BG3 - BG_BMP_BASE(0)
<br/>
BG0 - BG_TILE_BASE(0) // implied, even though you didn't explicity set it
<br/>
<br/>
you need to move one of them -- you'll need to look up how much VRAM they each use, and how much VRAM you have available, in order to set them correctly so they don't overlap.
<br/>
<br/>
Same with BG_MAP_BASE on BG0 as well, you need to ensure that it doesn't overlap with either of the BMP or TILE bases.
<br/>
<br/>
Final note: make sure to update the consoleInit line as well, if you change the bases of BG0.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#114511 - cheapo - Mon Jan 08, 2007 3:50 pm</h4>
    <div class="postbody"><span class="postbody">Thanks josath, it somewhat worked better now, but I still quite don't get it. Let me explain:
<br/>
<br/>
1. I'm setting two main VRAM banks (128 KB each):
<br/>
<br/>
vramSetBankA( VRAM_A_MAIN_BG_0x6000000 );
<br/>
vramSetBankB( VRAM_B_MAIN_BG_0x6020000 );
<br/>
<br/>
2. I set the main screen to work with two backgrounds:
<br/>
<br/>
videoSetMode( MODE_5_2D | DISPLAY_BG3_ACTIVE | DISPLAY_BG0_ACTIVE );
<br/>
<br/>
3. I initialize BG3 at position 0, which will be (as I understand) the beginning of VRAM_A:
<br/>
<br/>
BG3_CR = BG_BMP16_256x256 | BG_BMP_BASE(0) | BG_PRIORITY(3);
<br/>
<br/>
4. I initialize BG0 at TILE position 8 (if BG3 takes 128 KB / 16 KB blocks, it will take slots 0 thru 7, hence I'm using 8 here, so BG0 starts at the beginning of VRAM_B). I'm using MAP position 16 since I saw an example using TILE 0 and MAP 8, so I just assumed that since I started at 8 I should use 16 for MAP:
<br/>
<br/>
BG0_CR = BG_TILE_BASE(8) | BG_MAP_BASE(16) | BG_PRIORITY(0);
<br/>
<br/>
5. Then I init Console Mode using the same positions for TILE and MAP:
<br/>
<br/>
consoleInitDefault((u16*)SCREEN_BASE_BLOCK(16), (u16*)CHAR_BASE_BLOCK(8), 16);
<br/>
<br/>
---
<br/>
<br/>
Now I can see the text over the things I initially painted in BG3, but it's still wrong, since it's painting a blue horizontal line at about half screen (which shouldn't be there) in BG3 and if I keep painting in BG3 the text disappears randomically.
<br/>
<br/>
I still can't understand what I'm doing wrong. Could you help me?
<br/>
<br/>
Thanks a lot!<br/>_________________<br/>There's no place like 127.0.0.1</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#114513 - cheapo - Mon Jan 08, 2007 4:11 pm</h4>
    <div class="postbody"><span class="postbody">Well, I've found out that if I swap the BG positions, it works. Now BG3 is at BG_BMP_BASE(8) (VRAM_B) and BG0 is at TILE_BASE(0) and MAP_BASE(31) (all in VRAM_A).
<br/>
<br/>
The only thing I had to change is to paint BG3 to (u16*)BG_BMP_RAM(8) (VRAM_B) instead of BG_GFX (VRAM_A), which was the address I was using before.
<br/>
<br/>
But I still don't get why my previous example didn't work.<br/>_________________<br/>There's no place like 127.0.0.1</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#114881 - JessTicular - Thu Jan 11, 2007 6:43 am</h4>
    <div class="postbody"><span class="postbody">I've found the information available at DSPassme.com very usefull for this...
<br/>
<br/>
<a class="postlink" href="http://www.dspassme.com/programmers_guide/tutorial/registers.html" target="_blank">DSPassme Registers Info</a>
<br/>
<br/>
You'll notice from the information there that what you were doing wrong was setting BG0 to be TILE_BASE(8) since it only goes up to 4 :P
<br/>
<br/>
However, changing that wouldn't have helped if you're using BG3 as an extended rotation since it is in bitmap mode rather than tile-mode.
<br/>
<br/>
So, you'd effectively be writing straight over the top of your actual BG data when trying to put BG0's information at anything other than before where you're copying BG3's info to.
<br/>
<br/>
Here's a bit of code that I wrote for my most recent project:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
   // We want an extended-rotation background since we're going to be using sprites
<br/>
   //  &amp; a full-screen background. We can have up to 512x512 on BG3, but since we
<br/>
   //  only want a single full-screen image, then we'll just be using 512x256
<br/>
   //  (which conveiniently fits into just two VRAMs)
<br/>
   videoSetMode(MODE_3_2D | DISPLAY_BG3_ACTIVE | DISPLAY_BG0_ACTIVE | DISPLAY_SPR_ACTIVE | DISPLAY_SPR_1D_BMP);
<br/>
<br/>
   // Setting VRAM A &amp; B to the main BG - givnig us 256KiB, exactly what we need for a 512x256x16 image
<br/>
   // However, we're using the first 6KiB for text-information
<br/>
   // Thus, we need to map an extra 123KiB of memory to the end so that the over-flow from the 256KiB of
<br/>
   //  BG image has somewhere to go.
<br/>
   vramSetBankA(VRAM_A_MAIN_BG_0x6000000);
<br/>
   vramSetBankB(VRAM_B_MAIN_BG_0x6020000);
<br/>
   vramSetBankD(VRAM_D_MAIN_BG_0x6040000);
<br/>
<br/>
   // Setting VRAM E to be sprite memory
<br/>
   // This gives us 64 KiB of Sprite Memory
<br/>
   vramSetBankE(VRAM_E_MAIN_SPRITE);
<br/>
<br/>
   // Make sure our text draws on-top of BG3
<br/>
   // Give the Map base as 2 - ((base)*0x800) + 0x06000000
<br/>
   // Give the Tile base as 0 - ((base)*0x4000) + 0x06000000
<br/>
   // We're setting the Tile base to be the very start of VRAM
<br/>
   // And the map-base to be just past where the tile data ends
<br/>
   BG0_CR = BG_MAP_BASE(2) | BG_TILE_BASE(0) | BG_PRIORITY(0);
<br/>
<br/>
   // Tell the DS that we're using BG3 for a 512x256x16 bitmap
<br/>
   // Turn on Wrapping of the Background as it scrolls
<br/>
   // Give the Map (BMP) base as 3 - ((base)*0x800) + 0x06000000
<br/>
   // This map-base just clears the text-map
<br/>
   // We could set the tile base here to be something (1), but it is pointless
<br/>
   //  since we're using a bitmap, there are no 'tiles' assosciated with it
<br/>
   //  and as such, the tile-base never gets written to or read from.
<br/>
   BG3_CR = BG_BMP_BASE(3) | BG_BMP16_512x256 | BG_PRIORITY(3) | BG_WRAP_ON;</td> </tr></table><span class="postbody">
<br/>
<br/>
Enjoy :)<br/>_________________<br/><span style="font-size: 9px; line-height: normal"><span style="font-weight: bold">Nintendo DS &amp; Dominos :: <a class="postlink" href="http://dsdominos.sourceforge.net" target="_blank">DS Dominos</a></span>
<br/>
<a class="postlink" href="http://jt0.org" target="_blank">http://jt0.org</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#114894 - cheapo - Thu Jan 11, 2007 11:12 am</h4>
    <div class="postbody"><span class="postbody">Hey JessTicular, thanks a lot!
<br/>
<br/>
So, if I get it, I just can't map text TILE and MAP base to VRAM_B, since TILE base only goes up to 3 and MAP base to 31, right? So everytime I want to use tile data on BG0 and bitmap data on BG2/BG3, I always have to put tile data first on the memory, and bitmap data after. Correct?
<br/>
<br/>
BTW, I see in your code that you set MAP base to 2 and TILE base to 0. So by this you mean that TILE data for text only takes 4 KB? I know, for example, that a 256x256x16bit BMP takes 128K of VRAM, but how can I know how much space will the TILE data for text take?
<br/>
<br/>
I'm sorry I keep asking questions even after I made my prog work, but that's just how I am... To make it work is not enough, I need to fully understand what I did... hehehe<br/>_________________<br/>There's no place like 127.0.0.1</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
