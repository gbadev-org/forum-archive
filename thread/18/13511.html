<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>2 questions re visualizing performance - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > 2 questions re visualizing performance</h2>
<div id="posts">
<div class="post">
    <h4>#132232 - sourcerer - Sun Jun 24, 2007 10:07 pm</h4>
    <div class="postbody"><span class="postbody">Hi,
<br/>
I have two questions on which I'd love to see some suggestions.
<br/>
<br/>
1) In order to visualize general performance it's nice to have something to show how far on the frame you are (like changing color 0 or drawing a line). Does anyone have an idea about a general solution to do something like that? I guess the line driven rendering of DS should make something like this possible - maybe set a position of something in the HBL after your processing is done?
<br/>
2) Is there an easy way to access a hi-res timer to profile code?...without ARM7? 
<br/>
<br/>
(sure miss printf functionality to then show that timer without having to have another screen dedicated to showing the info).
<br/>
<br/>
Any input appreciated,
<br/>
Kaj</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#132257 - tepples - Mon Jun 25, 2007 3:18 am</h4>
    <div class="postbody"><span class="postbody">On the GBA, I used to change BG_PALETTE[0] at various points in the frame.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#132279 - Chano Marrano - Mon Jun 25, 2007 1:01 pm</h4>
    <div class="postbody"><span class="postbody">You can enable an interrupt at horizontal blank that increases some counter. If the counter at vertical blank is 92 and the DS has 192 horizontal lines, the CPU usage would be 92/192 = 0.479 =&gt; 48%.
<br/>
<br/>
This approach works well on GBA, but I'm not sure if it works on DS using the two screens.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#132305 - tepples - Mon Jun 25, 2007 7:46 pm</h4>
    <div class="postbody"><span class="postbody">On the DS, pixels are fed to both screens simultaneously. However, there are 192 display lines and 71 vertical blanking lines for a total of 263 lines.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#132310 - Sunray - Mon Jun 25, 2007 8:26 pm</h4>
    <div class="postbody"><span class="postbody">Setup a timer to measure a certain scope or what ever. You now that the frame time is 16 ms (60 fps).
<br/>
<br/>
<br/>
Edit: I post my timer code
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
<br/>
class ScopeTimer
<br/>
{
<br/>
public:
<br/>
   ScopeTimer(const char *pName);
<br/>
   ~ScopeTimer();
<br/>
<br/>
private:
<br/>
   const char *m_pName;
<br/>
};
<br/>
<br/>
<br/>
<br/>
static volatile int g_TimerCounter = 0;
<br/>
static void TimerInterrupt()
<br/>
{
<br/>
   g_TimerCounter++;
<br/>
}
<br/>
<br/>
ScopeTimer::ScopeTimer(const char *pName) : m_pName(pName)
<br/>
{
<br/>
#ifdef DEBUG
<br/>
   if (TIMER3_CR &amp; TIMER_ENABLE)
<br/>
   {
<br/>
      log("ScopeTimer: TIMER3 already enabled!\n");
<br/>
      TIMER3_CR &amp;= ~TIMER_ENABLE;
<br/>
   }
<br/>
#endif
<br/>
   g_TimerCounter = 0;
<br/>
<br/>
   irqSet(IRQ_TIMER3, TimerInterrupt);
<br/>
   irqEnable(IRQ_TIMER3);
<br/>
<br/>
   TIMER3_DATA = TIMER_FREQ(100000);
<br/>
   TIMER3_CR = TIMER_ENABLE | TIMER_IRQ_REQ | TIMER_DIV_1;
<br/>
}
<br/>
<br/>
ScopeTimer::~ScopeTimer()
<br/>
{
<br/>
   TIMER3_CR = 0;
<br/>
   irqDisable(IRQ_TIMER3);
<br/>
<br/>
   log("%s: %.02f ms\n", m_pName, g_TimerCounter * 0.01f);
<br/>
}
<br/>
<br/>
<br/>
<br/>
void SomeFunc()
<br/>
{
<br/>
   ScopeTimer t("SomeFunc");
<br/>
   DoStuff();
<br/>
}
<br/>
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#132320 - HyperHacker - Mon Jun 25, 2007 10:16 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Chano Marrano wrote:</b></span></td> </tr> <tr> <td class="quote">You can enable an interrupt at horizontal blank that increases some counter. If the counter at vertical blank is 92 and the DS has 192 horizontal lines, the CPU usage would be 92/192 = 0.479 =&gt; 48%.
<br/>
<br/>
This approach works well on GBA, but I'm not sure if it works on DS using the two screens.</td> </tr></table><span class="postbody">Interesting, I've been looking for a way to measure CPU usage as a percent. Am I understanding this correctly?
<br/>
1) Once you're finished whatever you're doing for this frame, enable the hblank interrupt, which increments a counter each time it fires.
<br/>
2) In vblank, divide the counter by 263 and multiply by 100 for your percent, then disable the hblank interrupt and reset the counter.
<br/>
<br/>
Is that correct?
<br/>
<br/>
BTW, someone added a debug function to Super Mario World once that I think did basically the same thing. A star appears at the left of the screen, and the further down it is, the higher the CPU usage. I'm guessing he just set the star's Y position to the current scanline before entering the wait-for-vblank loop.<br/>_________________<br/>I'm a PSP hacker now, but I still &lt;3 DS.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#132325 - Chano Marrano - Mon Jun 25, 2007 10:33 pm</h4>
    <div class="postbody"><span class="postbody">Okay, some pseudo code:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">u32 counter;
<br/>
<br/>
void HBLinterruptFunc()
<br/>
{
<br/>
    counter++;
<br/>
}
<br/>
<br/>
void updateScreen()
<br/>
{
<br/>
    ...
<br/>
    printf("CPU: %d%", (counter * 100) / HORIZONTAL_LINES);
<br/>
    waitForVBL();
<br/>
    counter = 0;
<br/>
    ...
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I hope you understand it better. The color change approach only works if the CPU usage is lower than 100%. I have used the counter approach on my GBA engine and it works without problem, and it lets you measure an unlimited CPU usage per frame:
<br/>
<a class="postlink" href="http://eltiosinchorra.sitesled.com/demoGBA.zip" target="_blank">http://eltiosinchorra.sitesled.com/demoGBA.zip</a>
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Once you're finished whatever you're doing for this frame, enable the hblank interrupt, which increments a counter each time it fires.</td> </tr></table><span class="postbody">
<br/>
Nope, the hblank interrupt is always enabled.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#132379 - sourcerer - Tue Jun 26, 2007 10:52 am</h4>
    <div class="postbody"><span class="postbody">That's kinda like what I was looking at now, but I don't quite understand the code.
<br/>
<br/>
Your code seems to assume the timers count in microsecond precision (the 100000 and 0,1f seem to hint at that) or something like that, but I thought they run in system clock frequency or divisions thereof?
<br/>
<br/>
K</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
