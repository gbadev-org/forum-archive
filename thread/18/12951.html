<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Doing stuff in vblank without flicker - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>DS development > Doing stuff in vblank without flicker</h2>
<div id="posts">
<div class="post">
    <h4>#124988 - simonjhall - Tue Apr 10, 2007 6:50 pm</h4>
    <div class="postbody"><span class="postbody">Yo,
<br/>
If I spend ages doing work in the vblank handler, does this stall the update of the actual LCD?
<br/>
At the moment if I upload textures during the vblank (and change banks from texture mode to LCD mode and back again) there's a noticeable flicker for a fraction of a second. I was under the impression that I'm allowed to do whatever I like, for as long as I whilst in a vblank handler!
<br/>
<br/>
Should I do it some other way instead? For instance in the hblank, once vcount goes into the 'dead' bit of the screen which can't be seen?
<br/>
<br/>
Ta guys :-)<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#124991 - Miked0801 - Tue Apr 10, 2007 7:37 pm</h4>
    <div class="postbody"><span class="postbody">There is only so many cycles in the VBlank.  You do not get "as long as you like" to do what you wish.  The flicker no doubt is caused because you are running a fat vblank.  Could very well be the graphic units not updating due to LCDC mde outside of the VBlank period.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#125000 - simonjhall - Tue Apr 10, 2007 8:50 pm</h4>
    <div class="postbody"><span class="postbody">So how long do you reckon I get? 1ms? Less?
<br/>
Maybe it would be better to do it in that hblank dead time after all...<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#125001 - relpats_eht - Tue Apr 10, 2007 8:52 pm</h4>
    <div class="postbody"><span class="postbody">There is even less time in hblank than there is in vblank, much less, in fact. You are better off with some sort of double buffering.<br/>_________________<br/>- relpats_eht</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#125002 - simonjhall - Tue Apr 10, 2007 9:07 pm</h4>
    <div class="postbody"><span class="postbody">I mean like checking in the hblank interrupt to see if VCOUNT has gone into the part of the screen that isn't visible. As soon as this happens, do some stuff...<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#125008 - sajiimori - Tue Apr 10, 2007 9:34 pm</h4>
    <div class="postbody"><span class="postbody">When loading a lot of textures, you may need to split up the work across multiple vblanks.  It helps to have a VRAM transfer manager that you can register new transfer tasks with.  Then it can decide when the transfer should be done.
<br/>
<br/>
When more transfers are queued than can be transferred in a single vblank, you have to decide whether to block until the next vblank (thereby dropping a frame globally), or continue the game with some transfers left incomplete.
<br/>
<br/>
If you allow the game to continue without doing all transfers (in the interest of smooth gameplay), you'll probably want to hide objects that don't have their textures loaded yet.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#125011 - relpats_eht - Tue Apr 10, 2007 9:40 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>simonjhall wrote:</b></span></td> </tr> <tr> <td class="quote">I mean like checking in the hblank interrupt to see if VCOUNT has gone into the part of the screen that isn't visible. As soon as this happens, do some stuff...</td> </tr></table><span class="postbody">
<br/>
<br/>
Yes, I know. I was saying that hblank is a much shorter period of time than vblank, therefore, what you cannot do in a single vblank, you cannot do in a single hblank either. So long as you are writing a manager of some sort to split up loading, which you would be required to do if you chose to use the hblank to load, you may as well continue to use vblank and load more each blank.
<br/>
<br/>
Or, you could go the easier route of double buffering.<br/>_________________<br/>- relpats_eht</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#125015 - masscat - Tue Apr 10, 2007 10:10 pm</h4>
    <div class="postbody"><span class="postbody">I am not sure when the texture memory has to be assigned for the NDS hardware to correctly use it. It will be either when the vertices are being passed and processed by the geometry unit or when you swap buffers (or maybe both).
<br/>
<br/>
To quote gbatek:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">4000540h - Cmd 50h - SWAP_BUFFERS - Swap Rendering Engine Buffer (W)
<br/>
SwapBuffers exchanges the two sets of Polygon/Vertex RAM buffers, that is, the newly defined polygons/vertices are passed to the rendering engine (and will be displayed in following frame(s)). The other buffer is emptied, and passed to the Geometry Engine (to be filled with new polygons/vertices by Geometry Commands).
<br/>
<br/>
  0     Translucent polygon Y-sorting (0=Auto-sort, 1=Manual-sort)
<br/>
  1     Depth Buffering  (0=With Z-value, 1=With W-value)
<br/>
        (mode 1 does not function properly with orthogonal projections)
<br/>
  2-31  Not used
<br/>
<br/>
SwapBuffers isn't executed until next VBlank (Scanline 192) (the Geometry Engine is halted for that duration). SwapBuffers should not be issued within Begin/End.</td> </tr></table><span class="postbody">
<br/>
<br/>
If it is during the buffer swap then changing texture memory during VBlank is not good as this would be when the hardware is using them.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#125022 - DekuTree64 - Tue Apr 10, 2007 11:05 pm</h4>
    <div class="postbody"><span class="postbody">Another gbatek quote:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">4000320h - RDLINES_COUNT - Rendered Line Count Register (R)
<br/>
Rendering starts in scanline 214, the rendered lines are stored in a buffer that can hold up to 48 scanlines. The actual screen output begins after scanline 262, the lines are then read from the buffer and sent to the display. Simultaneously, the rendering engine keeps writing new lines to the buffer (ideally at the same speed than display output, so the buffer would always contain 48 pre-calculated lines).
<br/>
  0-5    Minimum Number (minus 2) of buffered lines in previous frame (0..46)
<br/>
  6-31   Not used
<br/>
<br/>
<br/>
If rendering becomes slower than the display output, then the number of buffered lines decreases. Smaller values in RDLINES indicate that additional load to the rendering engine may cause buffer underflows in further frames, if so, the program should reduce the number of polygons or lights to avoid display glitches.
<br/>
Even if RDLINES becomes zero, it doesn't indicate if buffer underflows have occured; instead, underflows are indicated in DISP3DCNT Bit12.
<br/>
</td> </tr></table><span class="postbody">
<br/>
So you have from scanline 192 to 214 to mess with texture VRAM (about 1.4ms). The textures are continually read throughout the rendering of the frame, so if you ever take them away from the 3D engine, they all show up as black for any lines rendered during that time.
<br/>
<br/>
I agree with sajiimori on hiding any objects that haven't finished loading yet. Since they'll most likely be finished within one or two VBlanks anyway, it shouldn't hurt gameplay to let them function as if they were visible during that time, even if that means attacking the player.<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#125030 - tepples - Wed Apr 11, 2007 12:08 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>DekuTree64 wrote:</b></span></td> </tr> <tr> <td class="quote">I agree with sajiimori on hiding any objects that haven't finished loading yet. Since they'll most likely be finished within one or two VBlanks anyway, it shouldn't hurt gameplay to let them function as if they were visible during that time, even if that means attacking the player.</td> </tr></table><span class="postbody">
<br/>
If a texture hasn't loaded, wouldn't it be better to just draw the object with Gouraud shading than to make the mesh flicker?
<br/>
<br/>
But how fast is a DMA copy to texture memory anyway?<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#125034 - sajiimori - Wed Apr 11, 2007 12:15 am</h4>
    <div class="postbody"><span class="postbody">It depends, but I'd lean toward not drawing them.  I can't imagine why there would be flicker; if the texture is loaded one tick, it should still be loaded for the next tick.
<br/>
<br/>
If a character spawns with a magical-looking special effect around them, delaying their appearance might look better than having them appear untextured for a moment.
<br/>
<br/>
If they spawn due to coming within range of distance clipping, maybe delaying their appearance for a couple ticks won't be noticable; you might get a little closer in the meantime, but they'll still be far away.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#125038 - HyperHacker - Wed Apr 11, 2007 12:18 am</h4>
    <div class="postbody"><span class="postbody">I know this doesn't really apply to Quake but you could always try to work these things into your game. Make gourad shading part of a special effect.<br/>_________________<br/>I'm a PSP hacker now, but I still &lt;3 DS.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#125044 - DekuTree64 - Wed Apr 11, 2007 12:34 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tepples wrote:</b></span></td> </tr> <tr> <td class="quote">But how fast is a DMA copy to texture memory anyway?</td> </tr></table><span class="postbody">
<br/>
I don't remember the exact speed offhand, I think it was something like 16KB you can get down from main RAM.
<br/>
<br/>
VRAM is quite a bit faster than main RAM though, so if you have one of the 16KB banks free, you could load the texture from storage into that, and then DMA from there during VBlank.
<br/>
<br/>
The 16KB shared memory blocks are even faster, plus then maybe you could have the ARM7 help out :)
<br/>
I wonder if writing to two seperate VRAM banks at the same time causes a stall...<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#125094 - simonjhall - Wed Apr 11, 2007 9:34 am</h4>
    <div class="postbody"><span class="postbody">Ta guys, thanks for the help. At the moment my texture manager queues up textures to load, and then loads them during the slack time. I was planning on spreading the actual transfers across several frames, but I just wanted a rough idea of when I should start doing the transfers and how long I've got to do them...
<br/>
So I'm gonna have a go with the VCOUNT &gt; 192 but &lt; 214 thing, and see how that plays out.
<br/>
<br/>
I do like the idea of transferring stuff into one of the unused/useless vram banks and then moving them to the main texture memory when it's allowed to. May as well do something with those extra banks! To make matters worse, the textures are not being moved from main memory to vram - they're being pulled from *disk* on demand. This may sound a bit stupid, but it works well on all my flash cards but I bet there's one person out there who's using a flash card that only gives 1k/s... ;-)
<br/>
<br/>
For the extended-RAM build I intend to pull textures and sounds from that after their initial load.
<br/>
<br/>
The 'what to do when the texture hasn't been loaded' thing is pretty interesting - maybe I should add an option to select what you want to do. At the moment when the texture isn't available I disable texturing on that object, which means it flashes white for one frame. It's quite distracting, esp as the Quake world is quite dark. This is only really an issue for the view weapons though as they're right in front of you and changing weapons takes zero frames to do. It's not a problem for other monsters as the game engine normally renders them before they're actually visible, so you don't see them flashing white. Maybe I <span style="font-style: italic">should</span> just not render the objects when they don't have textures.
<br/>
<br/>
One final annoying thing about this deferred loading thing is sprite animations, eg explosions. By the time the required frame of animation has been loaded, the sprite has moved to the next frame! Don't really know what to do about this...
<br/>
<br/>
EDIT: oh and I didn't think the ARM7 could write to VRAM? I know you can write to C and D when they's assigned as work RAM - how about the others?<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#125102 - silent_code - Wed Apr 11, 2007 12:00 pm</h4>
    <div class="postbody"><span class="postbody">make sure you use a priority queue and some fast path for "immediate" priority. that would be like: low = far away alias &amp; world textures, med = close alias and world, high = whatever, immediate = effects &amp; view models.
<br/>
immediate would stop any other transfers, any others would be worked through from high to low. as stuff gets closer to the player it get a higher priority. i know it's not a very very very good solution, but it's better than just a fifo. it still has some problems though (textures never get loaded under certain circumstances, even though they should have etc.).
<br/>
<br/>
i wish you good luck!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#125104 - masscat - Wed Apr 11, 2007 12:31 pm</h4>
    <div class="postbody"><span class="postbody">Since the rendered lines are buffered will you not actually have more time than scan lines 192 to 214?
<br/>
<br/>
You could have up to (192 - 48) to 214 if the render buffer is fully populated at scan line 144, i.e. all the lines for the remaining display have been rendered.
<br/>
<br/>
This would only work if the rendering engine always starts rendering line 0 at scan line 214 rather than continuing to render from where it got up to (assuming there is no SWAP_BUFFERS write).
<br/>
<br/>
<span style="font-weight: bold">EDIT:</span> misread what RDLINE_COUNT was, since it is the minimum for the previous frame you would risk black textures using it for the current frame.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#125106 - simonjhall - Wed Apr 11, 2007 1:55 pm</h4>
    <div class="postbody"><span class="postbody">Yeah, maybe I'll try unlocking it at various different places for different lengths of time to see if it breaks or not... Ah, homebrew development :-)
<br/>
<br/>
And I did think of some kind of priority system, but not for prioritising the loading of certain textures. More like trying to decide if/when a texture should be discarded...<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#125136 - sajiimori - Wed Apr 11, 2007 6:07 pm</h4>
    <div class="postbody"><span class="postbody">For sprites, I might suggest having them lag by 1 frame overall.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#125144 - DekuTree64 - Wed Apr 11, 2007 7:18 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>simonjhall wrote:</b></span></td> </tr> <tr> <td class="quote">This is only really an issue for the view weapons though as they're right in front of you and changing weapons takes zero frames to do.</td> </tr></table><span class="postbody">
<br/>
I like silent_code's idea of a priority queue, but if this is the only thing that's causing trouble, you could just make a special transfer task for the gun, and always handle it first. That way you can just render it and assume the texture will make it down in the next VBlank.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">One final annoying thing about this deferred loading thing is sprite animations, eg explosions. By the time the required frame of animation has been loaded, the sprite has moved to the next frame! Don't really know what to do about this...</td> </tr></table><span class="postbody">
<br/>
How big are these? Any chance you could load all the frames at once? Using the hardware's compressed texture format could help reduce bandwidth/VRAM usage.
<br/>
Another option would be to make sure that a frame is displayed for at least one render cycle after it finishes loading, and not request a new frame to load until the previous one has finished. Animation might be a bit choppy, but might not look too bad.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">EDIT: oh and I didn't think the ARM7 could write to VRAM? I know you can write to C and D when they's assigned as work RAM - how about the others?</td> </tr></table><span class="postbody">
<br/>
Yeah, only C and D. Any method of splitting the load would probably be way over-complicated for how useful it would be. Just ran through my head before I sent that post :)<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
