<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>libfat, no file date? - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>DS development > libfat, no file date?</h2>
<div id="posts">
<div class="post">
    <h4>#122594 - ttabbal - Tue Mar 20, 2007 4:31 pm</h4>
    <div class="postbody"><span class="postbody">I have read working fine in libfat, but when I write a new file it doesn't have a date. It's valid, and I can copy it off the card just fine. I'm testing on an M3 Simply w/ devkitpro r20. The code is nothing special, just an fopen() with "wb", an fwrite() and an fclose(). 
<br/>
<br/>
Is there any way to tell libfat what the time is?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#122601 - Diddl - Tue Mar 20, 2007 5:18 pm</h4>
    <div class="postbody"><span class="postbody">does you set the system time? in libfat is code for reading RTC and setting into fileinfo.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#122602 - ttabbal - Tue Mar 20, 2007 5:23 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Diddl wrote:</b></span></td> </tr> <tr> <td class="quote">does you set the system time? in libfat is code for reading RTC and setting into fileinfo.</td> </tr></table><span class="postbody">
<br/>
<br/>
The DS system clock (the one they show in the boot menu) is set. It was set out of the box, it was wrong, but it did have a value. Where does libfat get the time from? I could print it to the screen to see what it sees.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#122606 - Diddl - Tue Mar 20, 2007 5:31 pm</h4>
    <div class="postbody"><span class="postbody">libfat does read this RTC data, I know this cause I had problems to compile libfat sources with old r19 kit. with devkitpro r19 you get error messages concerning RTC cause this struct has changed at r20.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#122610 - ttabbal - Tue Mar 20, 2007 6:02 pm</h4>
    <div class="postbody"><span class="postbody">Which struct? I'm not sure where this is stored.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#122633 - Diddl - Tue Mar 20, 2007 9:54 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>ttabbal wrote:</b></span></td> </tr> <tr> <td class="quote">Which struct? I'm not sure where this is stored.</td> </tr></table><span class="postbody">
<br/>
<br/>
file <span style="font-weight: bold">filetime.c</span>:</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
u16 _FAT_filetime_getTimeFromRTC (void) {
<br/>
#ifdef NDS
<br/>
   int hour, minute, second;
<br/>
<br/>
   hour = (IPC-&gt;time.rtc.hours &gt;= HOUR_PM_INDICATOR ? IPC-&gt;time.rtc.hours - HOUR_PM_INDICATOR : IPC-&gt;time.rtc.hours);
<br/>
   minute = IPC-&gt;time.rtc.minutes;
<br/>
   second = IPC-&gt;time.rtc.seconds;
<br/>
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#122665 - ttabbal - Wed Mar 21, 2007 3:49 am</h4>
    <div class="postbody"><span class="postbody">Okay, I get all zeros for those vars (I just copied the code into my project and did a printf to see what the values are). The firmware menu knows what time it is, why doesn't homebrew?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#122673 - HyperHacker - Wed Mar 21, 2007 4:58 am</h4>
    <div class="postbody"><span class="postbody">The ARM7 has to read them from the real-time clock and fill them in. You must be using a custom ARM7 binary that doesn't do that (or it's broken or not being loaded properly). A word of advice though, from what I've heard, reading the clock too often causes touch screen inaccuracy. Really you need only read it once per frame, or if you can spare a timer, once at startup and then keep track of time manually.<br/>_________________<br/>I'm a PSP hacker now, but I still &lt;3 DS.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#122685 - ttabbal - Wed Mar 21, 2007 5:52 am</h4>
    <div class="postbody"><span class="postbody">I am using the template ARM7 from the combined template project. Do I just use IPC-&gt;time = gp_getRTC(); in the vblank handler?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#124603 - tepples - Sat Apr 07, 2007 4:25 am</h4>
    <div class="postbody"><span class="postbody">I got accurate date from recent libfat by just doing this in ARM7 main() (based on code extracted from <a class="postlink" href="http://forum.gbadev.org/viewtopic.php?p=123124#123124" target="_blank">this post</a>):
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">   rtcReset();
<br/>
   rtcGetTimeAndDate((uint8 *)&amp;(IPC-&gt;time.rtc.year));
<br/>
</td> </tr></table><span class="postbody">
<br/>
If you also care about an accurate time of day, and you expect your program to run for more than a couple minutes, then I'd suggest having ARM7 vblank handler update the seconds and minutes values itself until the time reaches a new hour, at which point it should call rtcGetTimeAndDate() again to resync. Don't resync too often, as it appears to cause noise in the touch screen readout. Also, remember that the LCD timing is set for roughly 599 (not 600) vblanks in 10 seconds, so tune your Bresenham algorithm accordingly.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
