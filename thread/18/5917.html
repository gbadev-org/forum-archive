<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Pixel Blending Routine - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>DS development > Pixel Blending Routine</h2>
<div id="posts">
<div class="post">
    <h4>#44546 - telamon - Thu Jun 02, 2005 7:56 pm</h4>
    <div class="postbody"><span class="postbody">Hi! I've kindof become stuck. I wrote this color blending routine, but it's spitting out completely wrong values. I've spent much about the whole day figureing out why it won't work but have had no sucess. :(
<br/>
<br/>
If anyone of you could help me getting this to work, i'd be extremely grateful.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
u16 Blend_Normal(u16 c1,u16 c2,u8 a){
<br/>
   // input: Color 1 , Color 2 , Alpha value.
<br/>
   // 32 blending levels
<br/>
   #define MAXBIT 5 
<br/>
   #define MAX (1&lt;&lt;(MAXBIT))
<br/>
   /*
<br/>
         u16
<br/>
   0 00000 00000 00000
<br/>
      B     G      R
<br/>
   */
<br/>
   if(c1 == Transparent_Color)
<br/>
      c1 = Canvas_Color;
<br/>
   if(c2 == Transparent_Color)
<br/>
      return Transparent_Color;
<br/>
      
<br/>
   u8 rgb[3],i;
<br/>
   for(i=0;i&lt;3;i++){
<br/>
      rgb[i]=(
<br/>
      ((c1&lt;&lt;(i*5+1))&gt;&gt;11)*(MAX-a)
<br/>
      +
<br/>
      ((c2&lt;&lt;(i*5+1))&gt;&gt;11)*a
<br/>
      )&gt;&gt;MAXBIT;
<br/>
   }
<br/>
   return RGB15(rgb[2],rgb[1],rgb[0]);
<br/>
}
<br/>
</td> </tr></table><span class="postbody"><br/>_________________<br/><a href="http://manifested.ath.cx" target="_blank">http://manifested.ath.cx</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#44549 - TheMikaus - Thu Jun 02, 2005 8:14 pm</h4>
    <div class="postbody"><span class="postbody">Are you sure that shifting erases the extras?  I know that on some platforms it does but on other it doesn't.
<br/>
<br/>
maybe you should just mask the values instead
<br/>
<br/>
MaskA1 = cl &amp;&amp; 0x1F;
<br/>
MaskB1 = cl &amp;&amp; (0x1F &lt;&lt; 5);
<br/>
MaskC1 = cl &amp;&amp; (0x1F &lt;&lt; 10);
<br/>
<br/>
Similar with the second color.
<br/>
<br/>
And then perform you blending operations
<br/>
<br/>
Also you'll probably want to check for value overflows.
<br/>
If your code doesn't already.
<br/>
<br/>
---Edit---
<br/>
Actually.  Are you sure that in general it is correct?
<br/>
<br/>
Max * a is 'a' a fixed point value? if so I'm not sure that the multiplation would know the difference.  You'd get over flows all over the place I would think.  I mean .45 might be like 00111 or something which would be multiplication by 7.  Of course I could be full of it since I know very little of what your blend function is actually doing.  but that's what I got out of it.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#44552 - strager - Thu Jun 02, 2005 8:21 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>telamon wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
u16 Blend_Normal(u16 c1,u16 c2,u8 a){
<br/>
   // input: Color 1 , Color 2 , Alpha value.
<br/>
   // 32 blending levels
<br/>
   #define MAXBIT 5 
<br/>
   #define MAX (1&lt;&lt;(MAXBIT))
<br/>
   /*
<br/>
         u16
<br/>
   0 00000 00000 00000
<br/>
      B     G      R
<br/>
   */
<br/>
   if(c1 == Transparent_Color)
<br/>
      c1 = Canvas_Color;
<br/>
   if(c2 == Transparent_Color)
<br/>
      return Transparent_Color;
<br/>
      
<br/>
   u8 rgb[3],i;
<br/>
   for(i=0;i&lt;3;i++){
<br/>
      rgb[i]=(
<br/>
      ((c1&lt;&lt;(i*5+1))&gt;&gt;11)*(MAX-a)
<br/>
      +
<br/>
      ((c2&lt;&lt;(i*5+1))&gt;&gt;11)*a
<br/>
      )&gt;&gt;MAXBIT;
<br/>
   }
<br/>
   return RGB15(rgb[2],rgb[1],rgb[0]);
<br/>
}
<br/>
</td> </tr></table><span class="postbody"></span></td> </tr></table><span class="postbody">
<br/>
<br/>
Maybe this'll fix it:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
   u8 rgb[3]
<br/>
   int channel;
<br/>
<br/>
   for(channel = 0; channel &lt;= 3; channel++)
<br/>
   {
<br/>
      rgb[i] = ((((c1 &gt;&gt; (channel * 5)) &amp; 31) * (31 - a) +
<br/>
                (((c2 &gt;&gt; (channel * 5)) &amp; 31) * a) / 2; /* Edit: May be / 31 !! */
<br/>
   };
<br/>
<br/>
   return(RGB15(rgb[0], rgb[1], rgb[2]));
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
What I've fixed:
<br/>
Changed i to channel, and made it an int.
<br/>
Changed &lt; to &lt;= in the for loop.
<br/>
Rewrote the rgb[i] = ... and added a / 2 (could change to &gt;&gt; 1).
<br/>
Switched around the return.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#44555 - telamon - Thu Jun 02, 2005 8:35 pm</h4>
    <div class="postbody"><span class="postbody">Oh yeah this gives me something to follow thanks alot.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Are you sure that shifting erases the extras? I know that on some platforms it does but on other it doesn't. </td> </tr></table><span class="postbody">
<br/>
Hmm i did't know about that. But seems strager figured out my problem. Gonna see if it works now.[/code]<br/>_________________<br/><a href="http://manifested.ath.cx" target="_blank">http://manifested.ath.cx</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#44563 - telamon - Thu Jun 02, 2005 10:37 pm</h4>
    <div class="postbody"><span class="postbody">Ok i've got this stuff working, the masking seemed to have been the problem. Thanks to strager that's fixed =)
<br/>
Here's the working function if anyone of you have use for it.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
/** Input Color1 and Color 2 and Color2's <b style="color:#FFA34F">opacity</b>.
<br/>
Returns blended color */
<br/>
u16 Blend_Normal(u16 c1,u16 c2,u8 a){
<br/>
   /*
<br/>
         u16
<br/>
   0 00000 00000 00000
<br/>
      B     G      R
<br/>
   */
<br/>
   if(c1 == Transparent_Color)
<br/>
      c1 = Canvas_Color;
<br/>
   if(c2 == Transparent_Color)
<br/>
      return Transparent_Color;
<br/>
      
<br/>
   u8 rgb[3],channel;
<br/>
   for(channel=0;channel&lt;3;channel++){
<br/>
      rgb[channel] = (((c1 &gt;&gt; (channel * 5)) &amp; 31) * (31 - a) +
<br/>
        (((c2 &gt;&gt; (channel * 5)) &amp; 31) * a)) &gt;&gt; 5; 
<br/>
   }
<br/>
   return RGB15(rgb[0],rgb[1],rgb[2]);
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
Thanks for the help guys!<br/>_________________<br/><a href="http://manifested.ath.cx" target="_blank">http://manifested.ath.cx</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#44565 - strager - Thu Jun 02, 2005 10:42 pm</h4>
    <div class="postbody"><span class="postbody">You are very welcome, and good luck in your project!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#44586 - Darkain - Fri Jun 03, 2005 3:15 am</h4>
    <div class="postbody"><span class="postbody">this is what i'm using for alpha blending in DarkStar's gfx lib.  maybe itll help ya out?
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#define RGB(r,g,b)  ((r)+((g)&lt;&lt;5)+((b)&lt;&lt;10))
<br/>
#define BGR(b,g,r)  ((r)+((g)&lt;&lt;5)+((b)&lt;&lt;10))
<br/>
#define RGB16(r,g,b)  ((r)+((g)&lt;&lt;5)+((b)&lt;&lt;10)+0x8000)
<br/>
#define BGR16(b,g,r)  ((r)+((g)&lt;&lt;5)+((b)&lt;&lt;10)+0x8000)
<br/>
<br/>
#define REDMASK   (0x7C00)
<br/>
#define GREENMASK (0x03E0)
<br/>
#define BLUEMASK  (0x001F)
<br/>
#define ALPHAMASK (0x8000)
<br/>
#define EXTENDEDMASK (0xF8000)
<br/>
<br/>
#define RGBRED(c)   (((c)&gt;&gt; 0) &amp; 0x001F)
<br/>
#define RGBGREEN(c) (((c)&gt;&gt; 5) &amp; 0x001F)
<br/>
#define RGBBLUE(c)  (((c)&gt;&gt;10) &amp; 0x001F)
<br/>
<br/>
#define WHITE RGB(31,31,31)
<br/>
#define BLACK RGB(0,0,0)</td> </tr></table><span class="postbody">
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">    inline u16 mixColors(u16 c1, u16 c2) { return ((c1&gt;&gt;1)&amp;0x3DEF) + ((c2&gt;&gt;1)&amp;0x3DEF) | 0x8000; }
<br/>
<br/>
    inline u16 alphaBlend(u16 c1, u16 c2, u8 trans) {
<br/>
      if (c1 == c2) return c1;
<br/>
      trans &amp;= 0x1F;
<br/>
      switch(trans) {
<br/>
        case  0: return c1;
<br/>
        case  7: return mixColors(c1, mixColors(c1, c2));
<br/>
        case 15: return mixColors(c1, c2);
<br/>
        case 23: return mixColors(c2, mixColors(c2, c1));
<br/>
        case 31: return c2;
<br/>
      }
<br/>
      register u8 trans2 = 31-trans;
<br/>
      return (u16)0x8000 |
<br/>
        (u32)(((((c2&amp;BLUEMASK) *trans)+((c1&amp;BLUEMASK) *trans2))&amp;GREENMASK)
<br/>
            | ((((c2&amp;GREENMASK)*trans)+((c1&amp;GREENMASK)*trans2))&amp;REDMASK)
<br/>
            | ((((c2&amp;REDMASK)  *trans)+((c1&amp;REDMASK)  *trans2))&amp;EXTENDEDMASK)) &gt;&gt; 5;
<br/>
    }
<br/>
</td> </tr></table><span class="postbody"><br/>_________________<br/>-=- Darkain Dragoon -=-
<br/>
<a class="postlink" href="http://www.darkain.com" target="_blank">http://www.darkain.com</a>
<br/>
<a class="postlink" href="http://ds.darkain.com/hack" target="_blank">DarkStar</a> for <a class="postlink" href="http://ds.darkain.com" target="_blank">Nintendo DS</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#44601 - telamon - Fri Jun 03, 2005 10:10 am</h4>
    <div class="postbody"><span class="postbody">Oh darkain! i was trying to contact you earlier. I was wondering if you stored alpha data for each pixel and calculated colors during the screen draw, or if you simply hard-painted alpha values during the penstrokes. 
<br/>
<br/>
My app uses hardpainted alpha atm , but that ends up in ugly white edges when painting in a layer underneath. But having separate alpha values for each pixel will increase the bit size for my layer arrays. :/ 
<br/>
And ofcourse having to re-calculate the alpha values for each frame will drain the resources too. :/ I wonder if there's anything in between or some nice alpha-hack. 
<br/>
<br/>
Heh i used a few odd words to describe the problem. You can try this wip demo and see for yourselves what i mean :) 
<br/>
<a class="postlink" href="http://molested.ath.cx/code/nds/Artalot0.99-WIP.zip" target="_blank">http://molested.ath.cx/code/nds/Artalot0.99-WIP.zip</a>
<br/>
Yep, i broke the brush again... :(<br/>_________________<br/><a href="http://manifested.ath.cx" target="_blank">http://manifested.ath.cx</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#44616 - Darkain - Fri Jun 03, 2005 6:43 pm</h4>
    <div class="postbody"><span class="postbody">heh... i only work with a single buffer of memory right now, no layering at all.  everything you see on the screen is always the same single bitmap.  i dont do any fancy layering techniques at all.<br/>_________________<br/>-=- Darkain Dragoon -=-
<br/>
<a class="postlink" href="http://www.darkain.com" target="_blank">http://www.darkain.com</a>
<br/>
<a class="postlink" href="http://ds.darkain.com/hack" target="_blank">DarkStar</a> for <a class="postlink" href="http://ds.darkain.com" target="_blank">Nintendo DS</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#44621 - strager - Fri Jun 03, 2005 7:14 pm</h4>
    <div class="postbody"><span class="postbody">What would be nice in a DS drawing program is that the colors are stored in 32-bits, and they are dithered (or whatever technique you chose) on-the-fly to the video buffer.  This way, you could easily implement alpha to each pixel (using the unused 8 bits), and could access each channel with no hassle (assuming you are using memory where it is 8-bit RW).</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#44666 - Darkain - Sat Jun 04, 2005 12:30 am</h4>
    <div class="postbody"><span class="postbody">a) video ram is 16bit access *only*  (32bit read/writes i do beleive become broken down into a pair of 16bit read/writes)
<br/>
<br/>
b) heh, dithering + downsampling from 32bit to 16bit isnt the fastest of processes either...<br/>_________________<br/>-=- Darkain Dragoon -=-
<br/>
<a class="postlink" href="http://www.darkain.com" target="_blank">http://www.darkain.com</a>
<br/>
<a class="postlink" href="http://ds.darkain.com/hack" target="_blank">DarkStar</a> for <a class="postlink" href="http://ds.darkain.com" target="_blank">Nintendo DS</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#44676 - strager - Sat Jun 04, 2005 1:32 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Darkain wrote:</b></span></td> </tr> <tr> <td class="quote">b) heh, dithering + downsampling from 32bit to 16bit isnt the fastest of processes either...</td> </tr></table><span class="postbody">
<br/>
<br/>
Dithering could be removed, and the channels just need to be shifted right 3 bits:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#define RGB32toRGB16(c) \
<br/>
/* Red */ \
<br/>
( ( (((c) &amp; 0xFF) &gt;&gt; 3) | \
<br/>
/* Green */ \
<br/>
((((c) &amp; 0xFF00) &gt;&gt; 3) &lt;&lt; 5 | \
<br/>
/* Blue */ \
<br/>
((((c) &amp; 0xFF0000) &gt;&gt; 3) &lt;&lt; 10) ) | \
<br/>
/* Alpha Mask */ \
<br/>
(((c) &amp; 0xFF000000) ? (1 &lt;&lt; 15) : 0) )</td> </tr></table><span class="postbody">
<br/>
<br/>
I hope I have those parentheses correct...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#44680 - Darkain - Sat Jun 04, 2005 2:19 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>strager wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Darkain wrote:</b></span></td> </tr> <tr> <td class="quote">b) heh, dithering + downsampling from 32bit to 16bit isnt the fastest of processes either...</td> </tr></table><span class="postbody">
<br/>
<br/>
Dithering could be removed, and the channels just need to be shifted right 3 bits:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#define RGB32toRGB16(c) \
<br/>
/* Red */ \
<br/>
( ( (((c) &amp; 0xFF) &gt;&gt; 3) | \
<br/>
/* Green */ \
<br/>
((((c) &amp; 0xFF00) &gt;&gt; 3) &lt;&lt; 5 | \
<br/>
/* Blue */ \
<br/>
((((c) &amp; 0xFF0000) &gt;&gt; 3) &lt;&lt; 10) ) | \
<br/>
/* Alpha Mask */ \
<br/>
(((c) &amp; 0xFF000000) ? (1 &lt;&lt; 15) : 0) )</td> </tr></table><span class="postbody">
<br/>
<br/>
I hope I have those parentheses correct...</span></td> </tr></table><span class="postbody">
<br/>
<br/>
either your code, or your comments may not be correct, because the DS, like the GBA, uses BGR instead of RGB.  ;)<br/>_________________<br/>-=- Darkain Dragoon -=-
<br/>
<a class="postlink" href="http://www.darkain.com" target="_blank">http://www.darkain.com</a>
<br/>
<a class="postlink" href="http://ds.darkain.com/hack" target="_blank">DarkStar</a> for <a class="postlink" href="http://ds.darkain.com" target="_blank">Nintendo DS</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#44682 - strager - Sat Jun 04, 2005 2:38 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Darkain wrote:</b></span></td> </tr> <tr> <td class="quote">either your code, or your comments may not be correct, because the DS, like the GBA, uses BGR instead of RGB.  ;)</td> </tr></table><span class="postbody">
<br/>
<br/>
Ah, but if the 32 bit colors were stored AAAAAAAABBBBBBBBGGGGGGGGRRRRRRRR, that wouldn't be the case. ;-)</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
