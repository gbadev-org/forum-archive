<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>About MP3 Decoding... - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > About MP3 Decoding...</h2>
<div id="posts">
<div class="post">
    <h4>#142363 - Lazy1 - Mon Oct 08, 2007 7:55 pm</h4>
    <div class="postbody"><span class="postbody">I'm having a bit of trouble here, I have the helix MP3 decoder running on the arm7 streaming data from the arm9.
<br/>
<br/>
The problem is that the output while recognizable is still very clicky and I have tried a few things to get it to sound better with no luck.
<br/>
<br/>
Basically what I do is this:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
   // Keep the ARM7 idle
<br/>
   while ( 1 ) {
<br/>
      swiWaitForVBlank( );
<br/>
<br/>
      if ( LoadMP3 == 1 ) {
<br/>
         LoadMP3 = 0;
<br/>
<br/>
         if ( OpenMP3( MP3Path, &amp;MP3File ) == 1 ) {
<br/>
            tprint_string( "ARM7: Loaded [" );
<br/>
            tprint_string( MP3Path );
<br/>
            tprint_string( "].\n" );
<br/>
<br/>
            if ( DecodeMP3Frame( &amp;MP3File ) == 1 ) {
<br/>
               MP3FillSegment( &amp;MP3File );
<br/>
<br/>
               DecodeMP3Frame( &amp;MP3File ); 
<br/>
               MP3FillSegment( &amp;MP3File );
<br/>
<br/>
               SCHANNEL_REPEAT_POINT( 0 ) = 0;
<br/>
               SCHANNEL_SOURCE( 0 ) = ( u32 ) MP3File.PlayBuffer;
<br/>
               SCHANNEL_LENGTH( 0 ) = ( 1152 * 2 ) &gt;&gt; 2;
<br/>
               SCHANNEL_TIMER( 0 ) = SOUND_FREQ( MP3File.Frame.samprate );
<br/>
               SCHANNEL_CR( 0 ) = SCHANNEL_ENABLE | SOUND_REPEAT | SOUND_16BIT | SOUND_VOL( 0x7F ) | SOUND_PAN( 0 );
<br/>
<br/>
               TIMER0_DATA = SOUND_FREQ( MP3File.Frame.samprate ) * 2;
<br/>
               TIMER0_CR = TIMER_ENABLE | TIMER_DIV_1;
<br/>
<br/>
               TIMER1_DATA = 65535 - ( 1152 );
<br/>
               TIMER1_CR = TIMER_ENABLE | TIMER_DIV_1 | TIMER_CASCADE;
<br/>
<br/>
               TIMER2_DATA = 0;
<br/>
               TIMER2_CR = TIMER_ENABLE | TIMER_DIV_1 | TIMER_CASCADE;
<br/>
<br/>
               do {
<br/>
                  if ( TIMER2_DATA &gt; f ) {
<br/>
                     DecodeMP3Frame( &amp;MP3File );
<br/>
                     MP3FillSegment( &amp;MP3File );
<br/>
<br/>
                     f = TIMER2_DATA;
<br/>
                  }
<br/>
               } while ( MP3File.IsEOF == 0 &amp;&amp; MP3File.IsOutOfData == 0 );
<br/>
<br/>
               SCHANNEL_CR( 0 ) = 0;
<br/>
            }
<br/>
<br/>
            CloseMP3( &amp;MP3File );
<br/>
         }
<br/>
      }
<br/>
   }
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I would assume that it's entirely ass backwards which is why it doesn't work properly.
<br/>
Any suggestions?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#142364 - Noda - Mon Oct 08, 2007 7:57 pm</h4>
    <div class="postbody"><span class="postbody">try first removing the swiForVBlank() call, it's not needed there...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#142366 - Lazy1 - Mon Oct 08, 2007 8:00 pm</h4>
    <div class="postbody"><span class="postbody">While the MP3 is decoding it doesn't wait for vblank.
<br/>
I'll admit the code is in a cheap hack state, otherwise it would be much neater. ( and done properly )</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#142387 - DekuTree64 - Mon Oct 08, 2007 9:40 pm</h4>
    <div class="postbody"><span class="postbody">Two bad things I can see there. First, timer1 data should be set to 6553<span style="font-weight: bold">6</span> - x. Second, this bit of code:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">               do { 
<br/>
                  if ( TIMER2_DATA &gt; f ) { 
<br/>
                     DecodeMP3Frame( &amp;MP3File ); 
<br/>
                     MP3FillSegment( &amp;MP3File ); 
<br/>
<br/>
                     f = TIMER2_DATA; 
<br/>
                  } 
<br/>
               } while ( MP3File.IsEOF == 0 &amp;&amp; MP3File.IsOutOfData == 0 );</td> </tr></table><span class="postbody">
<br/>
is a bit dangerous, because it's reading timer2 data twice, and the value could change between the two reads. Better to read it once into a temporary, and use that for comparing/setting to f.<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#142388 - Lazy1 - Mon Oct 08, 2007 9:53 pm</h4>
    <div class="postbody"><span class="postbody">I made those changes and it's still crackly, except now it pauses every once and a while for a tiny amount of time.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#142413 - DekuTree64 - Tue Oct 09, 2007 12:16 am</h4>
    <div class="postbody"><span class="postbody">I just noticed that it seems to be waiting until the buffer is completely empty to start decoding the next frame. Much better to double buffer it (decode one frame while the previous plays).<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#142422 - Lazy1 - Tue Oct 09, 2007 1:42 am</h4>
    <div class="postbody"><span class="postbody">That's what it _should_ be doing.
<br/>
I made the buffer 2x the size of a mono mp3 frame, when TIMER2_DATA increments that _should_ be when one half of the buffer has been played.
<br/>
<br/>
Full, messy/hacky code:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#include &lt;nds.h&gt;
<br/>
#include &lt;stdio.h&gt;
<br/>
#include &lt;stdlib.h&gt;
<br/>
#include &lt;string.h&gt;
<br/>
<br/>
#include &lt;ipcshared.h&gt;
<br/>
#include &lt;mp3dec.h&gt;
<br/>
<br/>
#define READBUF_SIZE ( 16 * 1024 )
<br/>
#define PCMBUF_SIZE ( MAX_NCHAN * MAX_NGRAN * MAX_NSAMP * 2 )
<br/>
<br/>
typedef struct {
<br/>
   FILE* Stream;
<br/>
<br/>
   int BytesLeft;
<br/>
   int BytesRead;
<br/>
   int IsEOF;
<br/>
   int IsOutOfData;
<br/>
   int LastError;
<br/>
<br/>
   HMP3Decoder Helix;
<br/>
   MP3FrameInfo Frame;
<br/>
<br/>
   unsigned char* ReadBuffer;
<br/>
   unsigned char* ReadPtr;
<br/>
   short* PlayBuffer;
<br/>
   short* PlayCursor;
<br/>
   short* PCMBuffer;
<br/>
} MP3Stream;
<br/>
<br/>
char MP3Path[ 192 ];
<br/>
volatile int LoadMP3 = 0;
<br/>
<br/>
MP3Stream MP3File;
<br/>
<br/>
int OpenMP3( const char* Path, MP3Stream* MP3 ) {
<br/>
   memset( MP3, 0, sizeof( MP3Stream ) );
<br/>
<br/>
   if ( ( MP3-&gt;Helix = MP3InitDecoder( ) ) == 0 ) {
<br/>
      tprint_string( "ARM7: Failed to create helix.\n" );
<br/>
      return 0;
<br/>
   }
<br/>
<br/>
   if ( ( MP3-&gt;Stream = tfopen( Path, "rb" ) ) == NULL ) {
<br/>
      tprint_string( "Failed to open [" );
<br/>
      tprint_string( Path );
<br/>
      tprint_string( "].\n" );
<br/>
<br/>
      return 0;
<br/>
   }
<br/>
<br/>
   MP3-&gt;ReadBuffer = ( unsigned char* ) tmalloc( READBUF_SIZE );
<br/>
   MP3-&gt;PCMBuffer = ( short* ) tmalloc( PCMBUF_SIZE );
<br/>
   MP3-&gt;PlayBuffer = ( short* ) tmalloc( 1152 * 2 * 2 );
<br/>
   MP3-&gt;PlayCursor = MP3-&gt;PlayBuffer;
<br/>
   MP3-&gt;ReadPtr = MP3-&gt;ReadBuffer;
<br/>
<br/>
   return 1;
<br/>
}
<br/>
<br/>
int CloseMP3( MP3Stream* MP3 ) {
<br/>
   if ( MP3-&gt;Stream != NULL ) {
<br/>
      MP3FreeDecoder( MP3-&gt;Stream );
<br/>
<br/>
      tfclose( MP3-&gt;Stream );
<br/>
      tfree( MP3-&gt;ReadBuffer );
<br/>
      tfree( MP3-&gt;PCMBuffer );
<br/>
      tfree( MP3-&gt;PlayBuffer );
<br/>
<br/>
      memset( MP3, 0, sizeof( MP3Stream ) );
<br/>
      return 1;
<br/>
   }
<br/>
<br/>
   return 0;
<br/>
}
<br/>
<br/>
int FillReadBuffer( MP3Stream* MP3 ) {
<br/>
   int ReadCount = 0;
<br/>
<br/>
   memmove( MP3-&gt;ReadBuffer, MP3-&gt;ReadPtr, MP3-&gt;BytesLeft );
<br/>
   ReadCount = tfillbuffer( MP3-&gt;ReadBuffer + MP3-&gt;BytesLeft, READBUF_SIZE - MP3-&gt;BytesLeft, MP3-&gt;Stream );
<br/>
<br/>
   if ( ReadCount &lt; ( READBUF_SIZE - MP3-&gt;BytesLeft ) )
<br/>
      memset( MP3-&gt;ReadBuffer + MP3-&gt;BytesLeft + ReadCount, 0, READBUF_SIZE - MP3-&gt;BytesLeft - ReadCount );
<br/>
<br/>
   return ReadCount;
<br/>
}
<br/>
<br/>
int DecodeMP3Frame( MP3Stream* MP3 ) {
<br/>
   int ReadCount = 0;
<br/>
   int Offset = 0;
<br/>
   int Error = 0;
<br/>
<br/>
   if ( MP3-&gt;BytesLeft &lt; ( MAINBUF_SIZE &lt;&lt; 1 ) &amp;&amp; MP3-&gt;IsEOF == 0 ) {
<br/>
      ReadCount = FillReadBuffer( MP3 );
<br/>
      MP3-&gt;BytesLeft+= ReadCount;
<br/>
      MP3-&gt;ReadPtr = MP3-&gt;ReadBuffer;
<br/>
<br/>
      if ( ReadCount == 0 )
<br/>
         MP3-&gt;IsEOF = 1;
<br/>
   }
<br/>
<br/>
   if ( ( Offset = MP3FindSyncWord( MP3-&gt;ReadPtr, MP3-&gt;BytesLeft ) ) &lt; 0 ) {
<br/>
      tprint_string( "Helix: Could not find syncword\n" );
<br/>
      MP3-&gt;IsOutOfData = 1;
<br/>
      return 0;
<br/>
   }
<br/>
<br/>
   MP3-&gt;ReadPtr+= Offset;
<br/>
   MP3-&gt;BytesLeft-= Offset;
<br/>
<br/>
   if ( ( Error = MP3Decode( MP3-&gt;Helix, &amp;MP3-&gt;ReadPtr, &amp;MP3-&gt;BytesLeft, MP3-&gt;PCMBuffer, 0 ) ) &gt; 0 ) {
<br/>
      switch ( Error ) {
<br/>
         case ERR_MP3_INDATA_UNDERFLOW: {
<br/>
            MP3-&gt;LastError = Error;
<br/>
            MP3-&gt;IsOutOfData = 1;
<br/>
<br/>
            return 0;
<br/>
         }
<br/>
         case ERR_MP3_MAINDATA_UNDERFLOW: {
<br/>
            break;
<br/>
         }
<br/>
         default:
<br/>
         case ERR_MP3_FREE_BITRATE_SYNC: {
<br/>
            MP3-&gt;LastError = Error;
<br/>
            MP3-&gt;IsOutOfData = 1;
<br/>
<br/>
            return 0;
<br/>
         }
<br/>
      };
<br/>
   }
<br/>
<br/>
   MP3GetLastFrameInfo( MP3-&gt;Helix, &amp;MP3-&gt;Frame );
<br/>
   return 1;
<br/>
}
<br/>
<br/>
void MP3SwapCursor( MP3Stream* MP3 ) {
<br/>
   if ( MP3-&gt;PlayCursor == MP3-&gt;PlayBuffer ) MP3-&gt;PlayCursor+= 1152;
<br/>
   else MP3-&gt;PlayCursor = MP3-&gt;PlayBuffer;
<br/>
}
<br/>
<br/>
void MP3FillSegment( MP3Stream* MP3 ) {
<br/>
   memcpy( MP3-&gt;PlayCursor, MP3-&gt;PCMBuffer, 1152 * 2 );
<br/>
   MP3SwapCursor( MP3 );
<br/>
}
<br/>
<br/>
//---------------------------------------------------------------------------------
<br/>
void startSound(int sampleRate, const void* data, u32 bytes, u8 channel, u8 vol,  u8 pan, u8 format) {
<br/>
//---------------------------------------------------------------------------------
<br/>
   SCHANNEL_TIMER(channel)  = SOUND_FREQ(sampleRate);
<br/>
   SCHANNEL_SOURCE(channel) = (u32)data;
<br/>
   SCHANNEL_LENGTH(channel) = bytes &gt;&gt; 2 ;
<br/>
   SCHANNEL_CR(channel)     = SCHANNEL_ENABLE | SOUND_ONE_SHOT | SOUND_VOL(vol) | SOUND_PAN(pan) | (format==1?SOUND_8BIT:SOUND_16BIT);
<br/>
}
<br/>
<br/>
<br/>
//---------------------------------------------------------------------------------
<br/>
s32 getFreeSoundChannel() {
<br/>
//---------------------------------------------------------------------------------
<br/>
   int i;
<br/>
   for (i=0; i&lt;16; i++) {
<br/>
      if ( (SCHANNEL_CR(i) &amp; SCHANNEL_ENABLE) == 0 ) return i;
<br/>
   }
<br/>
   return -1;
<br/>
}
<br/>
<br/>
int vcount;
<br/>
touchPosition first,tempPos;
<br/>
<br/>
#define KEY_TOUCH ( 1 &lt;&lt; 6 )
<br/>
<br/>
//---------------------------------------------------------------------------------
<br/>
void VcountHandler() {
<br/>
//---------------------------------------------------------------------------------
<br/>
   static int lastbut = -1;
<br/>
   
<br/>
   uint16 but=0, x=0, y=0, xpx=0, ypx=0, z1=0, z2=0;
<br/>
<br/>
   but = REG_KEYXY;
<br/>
<br/>
   if (!( (but ^ lastbut) &amp; (1&lt;&lt;6))) {
<br/>
 
<br/>
      tempPos = touchReadXY();
<br/>
<br/>
      x = tempPos.x;
<br/>
      y = tempPos.y;
<br/>
      xpx = tempPos.px;
<br/>
      ypx = tempPos.py;
<br/>
      z1 = tempPos.z1;
<br/>
      z2 = tempPos.z2;
<br/>
      
<br/>
   } else {
<br/>
      lastbut = but;
<br/>
      but |= (1 &lt;&lt;6);
<br/>
   }
<br/>
<br/>
   if ( vcount == 80 ) {
<br/>
      first = tempPos;
<br/>
   } else {
<br/>
      if (   abs( xpx - first.px) &gt; 10 || abs( ypx - first.py) &gt; 10 ||
<br/>
            (but &amp; ( 1&lt;&lt;6)) ) {
<br/>
<br/>
         but |= (1 &lt;&lt;6);
<br/>
         lastbut = but;
<br/>
<br/>
      } else {    
<br/>
         IPC-&gt;mailBusy = 1;
<br/>
         IPC-&gt;touchX         = x;
<br/>
         IPC-&gt;touchY         = y;
<br/>
         IPC-&gt;touchXpx      = xpx;
<br/>
         IPC-&gt;touchYpx      = ypx;
<br/>
         IPC-&gt;touchZ1      = z1;
<br/>
         IPC-&gt;touchZ2      = z2;
<br/>
         IPC-&gt;mailBusy = 0;
<br/>
      }
<br/>
   }
<br/>
   IPC-&gt;buttons      = but;
<br/>
   vcount ^= (80 ^ 130);
<br/>
   SetYtrigger(vcount);
<br/>
}
<br/>
<br/>
volatile int ARM9Ready = 0;
<br/>
volatile int ARM7Waiting = 0;
<br/>
<br/>
void IRQFifoNotEmpty( void ) {
<br/>
   u32 Data = 0;
<br/>
<br/>
   do {
<br/>
      Data = REG_IPC_FIFO_RX;
<br/>
<br/>
      switch ( Data ) {
<br/>
         case FMessage_Ready: {
<br/>
            ARM9Ready = 1;
<br/>
            break;
<br/>
         }
<br/>
         case FMessage_FifoCompleted: {
<br/>
            ARM7Waiting = 0;
<br/>
            break;
<br/>
         }
<br/>
         case FMessage_LoadMP3: {
<br/>
            strncpy( MP3Path, ( const char* ) IPCBuffer, sizeof( MP3Path ) - 1 );         
<br/>
            LoadMP3 = 1;
<br/>
<br/>
            fifoIPC_SendCompleted( );
<br/>
            break;
<br/>
         }
<br/>
         default: break;
<br/>
      };
<br/>
   } while ( ! ( REG_IPC_FIFO_CR &amp; IPC_FIFO_RECV_EMPTY ) );
<br/>
}
<br/>
<br/>
void VblankHandler( void ) {
<br/>
}
<br/>
<br/>
//---------------------------------------------------------------------------------
<br/>
int main(int argc, char ** argv) {
<br/>
//---------------------------------------------------------------------------------
<br/>
   int ThisTimer2Data = 0;
<br/>
   int LastTimer2Data = 0;
<br/>
<br/>
   fifoIPC_Init( );
<br/>
<br/>
   // Reset the clock if needed
<br/>
   rtcReset();
<br/>
<br/>
   //enable sound
<br/>
   powerON(POWER_SOUND);
<br/>
   SOUND_CR = SOUND_ENABLE | SOUND_VOL(0x7F);
<br/>
   IPC-&gt;soundData = 0;
<br/>
<br/>
   irqInit();
<br/>
   irqSet( IRQ_FIFO_NOT_EMPTY, IRQFifoNotEmpty );
<br/>
   irqSet(IRQ_VBLANK, VblankHandler);
<br/>
<br/>
   SetYtrigger(80);
<br/>
   vcount = 80;
<br/>
<br/>
   irqSet(IRQ_VCOUNT, VcountHandler);
<br/>
   irqEnable(IRQ_VBLANK | IRQ_VCOUNT | IRQ_FIFO_NOT_EMPTY );
<br/>
<br/>
   // Tell the ARM9 we are ready to go
<br/>
   fifoIPC_SendReady( );
<br/>
<br/>
   // Wait for the ARM9 to be ready
<br/>
   while ( ARM9Ready == 0 )
<br/>
      swiWaitForVBlank( );
<br/>
<br/>
   // Keep the ARM7 idle
<br/>
   while ( 1 ) {
<br/>
      swiWaitForVBlank( );
<br/>
<br/>
      if ( LoadMP3 == 1 ) {
<br/>
         LoadMP3 = 0;
<br/>
<br/>
         if ( OpenMP3( MP3Path, &amp;MP3File ) == 1 ) {
<br/>
            tprint_string( "ARM7: Loaded [" );
<br/>
            tprint_string( MP3Path );
<br/>
            tprint_string( "].\n" );
<br/>
<br/>
            if ( DecodeMP3Frame( &amp;MP3File ) == 1 ) {
<br/>
               MP3FillSegment( &amp;MP3File );
<br/>
<br/>
               DecodeMP3Frame( &amp;MP3File ); 
<br/>
               MP3FillSegment( &amp;MP3File );
<br/>
<br/>
               SCHANNEL_REPEAT_POINT( 0 ) = 0;
<br/>
               SCHANNEL_SOURCE( 0 ) = ( u32 ) MP3File.PlayBuffer;
<br/>
               SCHANNEL_LENGTH( 0 ) = ( 1152 * 2 ) &gt;&gt; 2;
<br/>
               SCHANNEL_TIMER( 0 ) = SOUND_FREQ( MP3File.Frame.samprate );
<br/>
               SCHANNEL_CR( 0 ) = SCHANNEL_ENABLE | SOUND_REPEAT | SOUND_16BIT | SOUND_VOL( 0x7F ) | SOUND_PAN( 0 );
<br/>
<br/>
               TIMER0_DATA = SOUND_FREQ( MP3File.Frame.samprate ) * 2;
<br/>
               TIMER0_CR = TIMER_ENABLE | TIMER_DIV_1;
<br/>
<br/>
               TIMER1_DATA = 65536 - ( 1152 );
<br/>
               TIMER1_CR = TIMER_ENABLE | TIMER_DIV_1 | TIMER_CASCADE;
<br/>
<br/>
               TIMER2_DATA = 0;
<br/>
               TIMER2_CR = TIMER_ENABLE | TIMER_DIV_1 | TIMER_CASCADE;
<br/>
<br/>
               do {
<br/>
                  ThisTimer2Data = TIMER2_DATA;
<br/>
<br/>
                  if ( ThisTimer2Data &gt; LastTimer2Data ) {
<br/>
                     DecodeMP3Frame( &amp;MP3File );
<br/>
                     MP3FillSegment( &amp;MP3File );
<br/>
<br/>
                     LastTimer2Data = ThisTimer2Data;
<br/>
                  }
<br/>
               } while ( MP3File.IsEOF == 0 &amp;&amp; MP3File.IsOutOfData == 0 );
<br/>
<br/>
               swiWaitForVBlank( );
<br/>
               SCHANNEL_CR( 0 ) = 0;
<br/>
            }
<br/>
<br/>
            CloseMP3( &amp;MP3File );
<br/>
         }
<br/>
      }
<br/>
   }
<br/>
}
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#142425 - DekuTree64 - Tue Oct 09, 2007 2:12 am</h4>
    <div class="postbody"><span class="postbody">Ah, I think it's this line:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">SCHANNEL_LENGTH( 0 ) = ( 1152 * 2 ) &gt;&gt; 2;</td> </tr></table><span class="postbody">
<br/>
Since the stream is 16-bit, that will play 1152 samples before looping. So multiply by 2 again to play a double length buffer.<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#142426 - Lazy1 - Tue Oct 09, 2007 2:18 am</h4>
    <div class="postbody"><span class="postbody">You did it!
<br/>
A million thanks!
<br/>
<br/>
The only problem that remains is a small gap/glitch every few seconds.
<br/>
If you want I can upload a sample.
<br/>
<br/>
EDIT:
<br/>
Gap/glitches disappear if the timer is 65535 - blah.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#142427 - Noda - Tue Oct 09, 2007 2:26 am</h4>
    <div class="postbody"><span class="postbody">Once got a working version, can you post/upload the sources somewhere? I think some people could be interested with a proper mp3 decoding/streaming system on the arm7 ;)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#142429 - Lazy1 - Tue Oct 09, 2007 2:34 am</h4>
    <div class="postbody"><span class="postbody">I think I will, though a complete rewrite of the FIFO code would be in order.
<br/>
Even better would be if I made that into a library.
<br/>
<br/>
One thing is bothering me though, is there a problem reading files during an interrupt?
<br/>
Currently the arm7 requests a buffer fill by sending a fifo message to the arm9 which handles it in the receive irq handler.
<br/>
<br/>
EDIT AGAIN:
<br/>
It seems that what I said earlier may not be the case.
<br/>
On another MP3 the small glitch was there but almost unnoticeable.
<br/>
<br/>
I'll try to throw together some files so it can be heard first hand.
<br/>
<br/>
EDIT YET AGAIN:
<br/>
Files:
<br/>
<a class="postlink" href="http://lazyone.drunkencoders.com/wordpress/wp-content/uploads/2007/10/mp3tests.zip" target="_blank">http://lazyone.drunkencoders.com/wordpress/wp-content/uploads/2007/10/mp3tests.zip</a>
<br/>
<a class="postlink" href="http://lazyone.drunkencoders.com/wordpress/wp-content/uploads/2007/10/mp3stream-src.zip" target="_blank">http://lazyone.drunkencoders.com/wordpress/wp-content/uploads/2007/10/mp3stream-src.zip</a>
<br/>
<br/>
EDIT #99999:
<br/>
The FIFO system in there is a joke, if anyone has some suggestions please let me know.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#142434 - DragonMinded - Tue Oct 09, 2007 4:17 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Lazy1 wrote:</b></span></td> </tr> <tr> <td class="quote">One thing is bothering me though, is there a problem reading files during an interrupt?
<br/>
Currently the arm7 requests a buffer fill by sending a fifo message to the arm9 which handles it in the receive irq handler.</td> </tr></table><span class="postbody">
<br/>
<br/>
YES.  Do NOT do this!  The bug present for over a year in DSOrganize that caused random freezes in music was due to me reading files in interrupts.  Avoid this at all costs.<br/>_________________<br/>Enter the mind of the dragon.
<br/>
<br/>
<a href="http://dragonminded.blogspot.com" target="_blank">http://dragonminded.blogspot.com</a>
<br/>
<br/>
Seriously guys, how hard is it to simply TRY something yourself?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#142437 - Lazy1 - Tue Oct 09, 2007 4:56 am</h4>
    <div class="postbody"><span class="postbody">I see...
<br/>
The only other option would be to do this in the main loop however I see two problems:
<br/>
<br/>
1) The wolf3d source is FULL of while( ) loops
<br/>
2) If the renderer takes too much time it's possible that the mp3 player will not get the data fast enough</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#142455 - DragonMinded - Tue Oct 09, 2007 9:19 am</h4>
    <div class="postbody"><span class="postbody">Or just buffer the data, then in the interrupt when it requests a chunk, just copy it out of already buffered memory, and flag that it needs to be refilled in the main loop.<br/>_________________<br/>Enter the mind of the dragon.
<br/>
<br/>
<a href="http://dragonminded.blogspot.com" target="_blank">http://dragonminded.blogspot.com</a>
<br/>
<br/>
Seriously guys, how hard is it to simply TRY something yourself?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#142457 - simonjhall - Tue Oct 09, 2007 9:28 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Lazy1 wrote:</b></span></td> </tr> <tr> <td class="quote">EDIT:
<br/>
Gap/glitches disappear if the timer is 65535 - blah.</td> </tr></table><span class="postbody">Sounds familiar :-)
<br/>
Anyway, well done. Reason I again never got back to you was because mine started clicking again! I'm still finding that this stuff slows down the ARM9 a bit too much though. This is due to the endless file access and the extra latency introduced due to ARM9/ARM7 IPC since the decoder is running. Any ideas of how to handle this?<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#142478 - Lazy1 - Tue Oct 09, 2007 2:51 pm</h4>
    <div class="postbody"><span class="postbody">Since the MP3 decoder is very dependent on latency why not hack libfat to run on the arm7 and have the arm9 access files though IPC?
<br/>
This would solve the interrupt problem and hopefully the latency one as well.
<br/>
<br/>
As for the arm9 slowing down, maybe map some vram to the arm7 and decode/play the sounds from there?
<br/>
<br/>
[EDIT]
<br/>
The click/pop/crackle problem is definitely the result of ARM7&lt;-&gt;ARM9 I/O IPC.
<br/>
I just tried modifying my sources to load the entire MP3 into ram and then fill the buffer with memcpy as the arm7 requests it.
<br/>
The result is perfect MP3 playing.
<br/>
<br/>
This raises a few issues, the latency can possibly be solved by reading twice the read buffer's size then memcpy()ing it on request.
<br/>
The question is though, with the game taking up 100% of the ARM9's cpu time will that read buffer be filled in time?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#142519 - Lazy1 - Wed Oct 10, 2007 12:07 am</h4>
    <div class="postbody"><span class="postbody">simonjhall:
<br/>
Did you try reducing the read buffer size?
<br/>
<br/>
I just lowered the size by half to 8KB and xtower2.mp3 no longer snaps, crackles or pops.
<br/>
I'm not sure how much of a solution this is though, I haven't done any tests for 8KB but reading 16KB takes 100-135 hblanks to complete.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#142522 - tepples - Wed Oct 10, 2007 12:32 am</h4>
    <div class="postbody"><span class="postbody">If you're trying different read buffer sizes, you might want to play with <a class="postlink" href="http://www.pineight.com/gba/#cf_bench" target="_blank">speed tester</a>.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#142523 - Lazy1 - Wed Oct 10, 2007 12:58 am</h4>
    <div class="postbody"><span class="postbody">That just made me realize...
<br/>
The games 'n music cart is horribly slow isn't it?
<br/>
<br/>
I'm just worried that no matter how much I buffer in advance the MP3 decoder will catch up to the slow I/O.
<br/>
<br/>
In the meantime I'm re-writing my FIFO code to be much better.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#142526 - tepples - Wed Oct 10, 2007 1:42 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Lazy1 wrote:</b></span></td> </tr> <tr> <td class="quote">I'm just worried that no matter how much I buffer in advance the MP3 decoder will catch up to the slow I/O.</td> </tr></table><span class="postbody">
<br/>
Obviously the card's built-in MP3 player keeps up with the data stream, and I've read that so does MoonShell at least for music.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#142530 - DragonMinded - Wed Oct 10, 2007 2:24 am</h4>
    <div class="postbody"><span class="postbody">DSOrganize also plays all its formats flawlessly on GnM, so it's not the card.<br/>_________________<br/>Enter the mind of the dragon.
<br/>
<br/>
<a href="http://dragonminded.blogspot.com" target="_blank">http://dragonminded.blogspot.com</a>
<br/>
<br/>
Seriously guys, how hard is it to simply TRY something yourself?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#142538 - Lazy1 - Wed Oct 10, 2007 5:29 am</h4>
    <div class="postbody"><span class="postbody">*slaps forehead*
<br/>
Next time I should really look at the title of the cart a little more closely.
<br/>
<br/>
Still, it'll be interesting to try and update the sound system from the main loop when there are like 50 of them.
<br/>
Maybe threading would be a better idea?
<br/>
<br/>
EDIT:
<br/>
Chishm said in another thread...
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
Interrupts aren't disabled during an fread. This can cause problems, as in your case, if it interrupts the disc IO in the middle of a sector read/write. Effects vary depending on the card. On some devices it'll just mis-read the sector originally being read. On others it can cause the device to lock up.
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Maybe I could just disable interrupts before reading data from the main loop?
<br/>
All I/O operations in Wolfenstein are wrapped anyway so that might make it easier.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#142546 - simonjhall - Wed Oct 10, 2007 8:06 am</h4>
    <div class="postbody"><span class="postbody">Ah I'd forgotten about the GnM... Yeah, that may need some testing!
<br/>
The speed problems I get are the endless freads through the game. I've got a tiny data buffer, an this means it's reading all the time.
<br/>
<br/>
Also when the '9 wants to play a sound, it blocks until the '7 picks up the message - well if the processor is busy, it's gonna have to wait longer. This isn't a mega amount of time, but it does make some high-speed stuff slower (eg the nail gun). Also y'know that there will be some idiots who try and play 256kbps music and complain to me that it jumps and/or the game itself is slow ;-)<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#142569 - tepples - Wed Oct 10, 2007 12:53 pm</h4>
    <div class="postbody"><span class="postbody">Then maybe you need to preload the weapon firing sounds when the player pulls out a weapon. Not enough RAM? Recommend the RAM build to GnM users.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#142634 - Lazy1 - Thu Oct 11, 2007 12:51 am</h4>
    <div class="postbody"><span class="postbody">Are you using FIFO for your IPC or shared memory?
<br/>
<br/>
I know that FIFO is the proper route to go since it keeps the arm7 out of main ram but so far it's been a real pain in the ass.
<br/>
Should I just go the shared memory route and wait for something official and update my sources in the future?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#142639 - DekuTree64 - Thu Oct 11, 2007 1:48 am</h4>
    <div class="postbody"><span class="postbody">You could try <a class="postlink" href="http://forum.gbadev.org/viewtopic.php?p=132370&amp;highlight=#132370" target="_blank">this FIFO system</a> I wrote a while back (what ever became of incorporating it or something similar into libnds?)
<br/>
<br/>
Shared memory isn't necessarily evil though. The big advantage of FIFO is that it interrupts the other CPU, so the message is processed immediately. Shared memory is fine if the other CPU can just handle the message next time through its main loop or whatever.<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#142847 - Lazy1 - Sun Oct 14, 2007 4:00 pm</h4>
    <div class="postbody"><span class="postbody">I have a working IPC system and the MP3 plays perfectly up to 128kbps on the arm7.
<br/>
<br/>
The problem is that the test app reads during an interrupt, as expected this really screws up wolf3d.
<br/>
I could change the IPC to read during the main loop except there are an insane amount of loops to begin with.
<br/>
<br/>
I guess I could track down every single loop and add a call to SD_Update but that would really be hacky. 
<br/>
I may have to though unless someone has another suggestion.
<br/>
<br/>
Could threads be the answer here, or is that just another problem?</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
