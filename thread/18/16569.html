<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>dstexcomp: Texture compression tool - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > dstexcomp: Texture compression tool</h2>
<div id="posts">
<div class="post">
    <h4>#167838 - kvance - Mon Mar 30, 2009 6:21 pm</h4>
    <div class="postbody"><span class="postbody">There's a few forum posts here and elsewhere about texture compression, but I haven't found any working compression tool links.  So I took a crack at writing one: <a class="postlink" href="http://kvance.com/project/dstexcomp/" target="_blank">dstexcomp</a>.  It requires python 2.5, and you may have to install some extra python libraries if you don't have them already.
<br/>
<br/>
Hopefully the README should explain how to use the script.  I also have some example code to show how to load and display the textures in libnds on the project page.  And I have discussions of <a class="postlink" href="http://kvance.livejournal.com/1029559.html" target="_blank">the texture format</a> and <a class="postlink" href="http://kvance.livejournal.com/1029665.html" target="_blank">my compressor</a> on my LJ.  Let me know if you need any help.
<br/>
<br/>
Patches to improve image quality are welcome ;)<br/>_________________<br/>Corner Office: <a class="postlink" href="http://lj.kvance.com/tag/corneroffice" target="_blank">dev LJ</a>
<br/>
<a class="postlink" href="http://kvance.com/project/HexxagonDS" target="_blank">HexxagonDS</a>, <a class="postlink" href="http://kvance.com/project/dsmzx/" target="_blank">dsmzx</a>, <a class="postlink" href="http://lj.kvance.com/tag/nintendo+ds" target="_blank">more...</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167855 - DiscoStew - Tue Mar 31, 2009 7:28 pm</h4>
    <div class="postbody"><span class="postbody">Nice tool. I tried it out myself, and while I can't say much about the processing speed (I was kinda worried about actually using all 4 cores on my processor for such a long length of time....for the first time without thinking about possible heat problems), I liked the output I got. Placed the output into your NDS example, and I don't think I could be happier.
<br/>
<br/>
I have a question about the compressed textures being used on the NDS though. They're not limited to the beginning of the usable VRAM slots, right? I mean, if I understand the format correctly, as long as I place the data in the correct spots so they align with each other, everything should work fine?<br/>_________________<br/><span style="font-weight: bold">DS</span> - It's all about <span style="font-weight: bold">D</span>isco<span style="font-weight: bold">S</span>tew</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167857 - kvance - Tue Mar 31, 2009 8:00 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>DiscoStew wrote:</b></span></td> </tr> <tr> <td class="quote">I tried it out myself, and while I can't say much about the processing speed (I was kinda worried about actually using all 4 cores on my processor for such a long length of time....for the first time without thinking about possible heat problems), I liked the output I got.</td> </tr></table><span class="postbody">
<br/>
<br/>
Heh, I wrote about its slowness everywhere else but I forgot to mention it here.  Hopefully it won't cause anyone's CPU to overheat!
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>DiscoStew wrote:</b></span></td> </tr> <tr> <td class="quote">I have a question about the compressed textures being used on the NDS though. They're not limited to the beginning of the usable VRAM slots, right? I mean, if I understand the format correctly, as long as I place the data in the correct spots so they align with each other, everything should work fine?</td> </tr></table><span class="postbody">
<br/>
<br/>
Correct.  libnds isn't really set up to work with compressed textures, but it won't get in the way if you're careful.  You should be able to use glGetTexturePointer() to find a texture's offset, and calculate the index offset from that.  You'll also need to make sure to temporarily disable texture slot 1 before calling glTexImage2D() so it doesn't overwrite the index.  And of course, you have to choose an appropriate palette size for all your compressed textures so there's enough palette VRAM for all of them.
<br/>
<br/>
I don't think you'll be able to share texture slot 1 between index data and other textures without replacing libnds' texture management code though.
<br/>
<br/>
Edit to add: Maybe at the beginning of your program, you could enable only texture slot 1, use glTexImage2D() with a phony texture of the correct size, and overwrite it with real index data later.  Then libnds should leave the index alone<br/>_________________<br/>Corner Office: <a class="postlink" href="http://lj.kvance.com/tag/corneroffice" target="_blank">dev LJ</a>
<br/>
<a class="postlink" href="http://kvance.com/project/HexxagonDS" target="_blank">HexxagonDS</a>, <a class="postlink" href="http://kvance.com/project/dsmzx/" target="_blank">dsmzx</a>, <a class="postlink" href="http://lj.kvance.com/tag/nintendo+ds" target="_blank">more...</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167864 - DiscoStew - Wed Apr 01, 2009 8:05 am</h4>
    <div class="postbody"><span class="postbody">At first glance of not knowing any Python scripting, I really couldn't understand it, but I gave myself some more time to look over it, starting with the entry function and going line by line, function by function, to figure out what was going on. While I can't code Python, at least I now have an idea how it works.
<br/>
<br/>
I was thinking. Unless you were doing it yourself, I could try to port your script over to C++. Granted I don't have knowledge or access to some of the stuff imported into it (like using multiple cores), the "meat" of the whole process is in the script, and the rest can be dealt with later.
<br/>
<br/>
I can give it a try, but I wouldn't expect it to be done very quickly. The RL can be quite the time consumer at times.  :P<br/>_________________<br/><span style="font-weight: bold">DS</span> - It's all about <span style="font-weight: bold">D</span>isco<span style="font-weight: bold">S</span>tew</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167870 - kvance - Wed Apr 01, 2009 3:35 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>DiscoStew wrote:</b></span></td> </tr> <tr> <td class="quote">I was thinking. Unless you were doing it yourself, I could try to port your script over to C++. Granted I don't have knowledge or access to some of the stuff imported into it (like using multiple cores), the "meat" of the whole process is in the script, and the rest can be dealt with later.</td> </tr></table><span class="postbody">
<br/>
<br/>
You're welcome to it.  At this point, I'm more interested in better image quality than speed (though I did just realize that I should put a border around the image when dithering, so I don't have to do bounds checks) so I'm not planning on doing it.
<br/>
<br/>
Some of the meat is definitely in the libraries.  Specifically, I use PIL's color quantizer to pick the best colors for each block.  Also, the palette reducing stage just calls SciPy's k-means function.
<br/>
<br/>
The final "egregiously bad block" stage is hurt more by its algorithm than python's slowness.  It's running the color quantizer on each palette (~8000 of them!) until it finds an acceptable one for each bad block.  It would be a lot faster if it only searched similar palettes.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">I can give it a try, but I wouldn't expect it to be done very quickly. The RL can be quite the time consumer at times.  :P</td> </tr></table><span class="postbody">
<br/>
<br/>
This is why I wrote it in python :)<br/>_________________<br/>Corner Office: <a class="postlink" href="http://lj.kvance.com/tag/corneroffice" target="_blank">dev LJ</a>
<br/>
<a class="postlink" href="http://kvance.com/project/HexxagonDS" target="_blank">HexxagonDS</a>, <a class="postlink" href="http://kvance.com/project/dsmzx/" target="_blank">dsmzx</a>, <a class="postlink" href="http://lj.kvance.com/tag/nintendo+ds" target="_blank">more...</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167879 - kusma - Wed Apr 01, 2009 10:15 pm</h4>
    <div class="postbody"><span class="postbody">I've also made a compressor, you can find it <a class="postlink" href="http://github.com/kusma/nds/tree/067a6fc2c54a36830c8830b046260763cd407511/texcompress" target="_blank">here</a>. I'd like to clean it up and release it properly one day, but for now this is it.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167887 - kvance - Thu Apr 02, 2009 1:07 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>kusma wrote:</b></span></td> </tr> <tr> <td class="quote">I've also made a compressor, you can find it <a class="postlink" href="http://github.com/kusma/nds/tree/067a6fc2c54a36830c8830b046260763cd407511/texcompress" target="_blank">here</a>. I'd like to clean it up and release it properly one day, but for now this is it.</td> </tr></table><span class="postbody">
<br/>
<br/>
Wow, that's great!  I wish I knew about that 2 weeks ago!<br/>_________________<br/>Corner Office: <a class="postlink" href="http://lj.kvance.com/tag/corneroffice" target="_blank">dev LJ</a>
<br/>
<a class="postlink" href="http://kvance.com/project/HexxagonDS" target="_blank">HexxagonDS</a>, <a class="postlink" href="http://kvance.com/project/dsmzx/" target="_blank">dsmzx</a>, <a class="postlink" href="http://lj.kvance.com/tag/nintendo+ds" target="_blank">more...</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167893 - DiscoStew - Thu Apr 02, 2009 7:22 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>kusma wrote:</b></span></td> </tr> <tr> <td class="quote">I've also made a compressor, you can find it <a class="postlink" href="http://github.com/kusma/nds/tree/067a6fc2c54a36830c8830b046260763cd407511/texcompress" target="_blank">here</a>. I'd like to clean it up and release it properly one day, but for now this is it.</td> </tr></table><span class="postbody">
<br/>
<br/>
Just tried your app kusma. It's nice and fast with pretty good quality, but for some reason in some of my test images, I'm getting odd "blank spaces", in which the block's colors are not anywhere near what it should be, or even close to those of the surrounding blocks. I mostly get them as solid black blocks.
<br/>
<br/>
Other than that, I like it. Should the resulting images be flipped though?<br/>_________________<br/><span style="font-weight: bold">DS</span> - It's all about <span style="font-weight: bold">D</span>isco<span style="font-weight: bold">S</span>tew</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167932 - kusma - Fri Apr 03, 2009 6:11 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>DiscoStew wrote:</b></span></td> </tr> <tr> <td class="quote">Just tried your app kusma. It's nice and fast with pretty good quality, but for some reason in some of my test images, I'm getting odd "blank spaces", in which the block's colors are not anywhere near what it should be, or even close to those of the surrounding blocks.
<br/>
</td> </tr></table><span class="postbody">
<br/>
Thanks for the feedback. Would you care to sent me an example-image so I can debug it? :)
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>DiscoStew wrote:</b></span></td> </tr> <tr> <td class="quote">Other than that, I like it. Should the resulting images be flipped though?</td> </tr></table><span class="postbody">
<br/>
Thanks for pointing this out! Might be, the code is pretty much proof-of-concept so far. I'll look into it! By the way, is there any kind of definition of the origin of textures on the NDS?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167936 - DiscoStew - Fri Apr 03, 2009 8:50 pm</h4>
    <div class="postbody"><span class="postbody">Actually, I was kinda wrong in my explanation. Its not black, but more of a dominance of a specific color, that the blocks are filled with that color reference. Most of my tests involved a lot of dark, which is why I assumed it was filling in "black/blank" blocks, but I tried a nice bright image from the internet (which was used in color quantization testing coincidentally, lol), and I get even more odd-ball blocks. You'll notice them right off the bat in this test result.
<br/>
<br/>
<a href="http://www.mediafire.com/?te3jzl32kzq" target="_blank">http://www.mediafire.com/?te3jzl32kzq</a><br/>_________________<br/><span style="font-weight: bold">DS</span> - It's all about <span style="font-weight: bold">D</span>isco<span style="font-weight: bold">S</span>tew</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167985 - kvance - Sun Apr 05, 2009 7:57 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>DiscoStew wrote:</b></span></td> </tr> <tr> <td class="quote">Actually, I was kinda wrong in my explanation. Its not black, but more of a dominance of a specific color, that the blocks are filled with that color reference.</td> </tr></table><span class="postbody">
<br/>
<br/>
That sounds a lot like the reason I had to add the "egregiously bad block" pass in my compressor.  If you run it with -e 9999 you'll probably see some similar problems.<br/>_________________<br/>Corner Office: <a class="postlink" href="http://lj.kvance.com/tag/corneroffice" target="_blank">dev LJ</a>
<br/>
<a class="postlink" href="http://kvance.com/project/HexxagonDS" target="_blank">HexxagonDS</a>, <a class="postlink" href="http://kvance.com/project/dsmzx/" target="_blank">dsmzx</a>, <a class="postlink" href="http://lj.kvance.com/tag/nintendo+ds" target="_blank">more...</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167986 - DiscoStew - Sun Apr 05, 2009 10:30 pm</h4>
    <div class="postbody"><span class="postbody">Just a quick off-topic question kusma. With the function FreeImage_ColorQuantizeEx(), is there a specific order designed for the resulting palette? Just wondering because with your code, you check the blend possibilities using only the first and last colors, as if they stood on the ends of the palette, and the remaining were between them.<br/>_________________<br/><span style="font-weight: bold">DS</span> - It's all about <span style="font-weight: bold">D</span>isco<span style="font-weight: bold">S</span>tew</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167987 - kusma - Sun Apr 05, 2009 10:35 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>DiscoStew wrote:</b></span></td> </tr> <tr> <td class="quote">Just a quick off-topic question kusma. With the function FreeImage_ColorQuantizeEx(), is there a specific order designed for the resulting palette? Just wondering because with your code, you check the blend possibilities using only the first and last colors, as if they stood on the ends of the palette, and the remaining were between them.</td> </tr></table><span class="postbody">
<br/>
I didn't find a guarantee, but I seem to remember observing that the palette is somewhat sorted in reality. This might have been a wrong assumption, though.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167988 - kusma - Sun Apr 05, 2009 10:41 pm</h4>
    <div class="postbody"><span class="postbody">By the way, I've moved the code to a <a class="postlink" href="http://github.com/kusma/nds_texcompress/tree/master" target="_blank">separate git-repo</a> to make maintaining this a bit easier. The old repo wasn't "supposed" to be used by anyone else than me :P</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167994 - DiscoStew - Mon Apr 06, 2009 7:35 am</h4>
    <div class="postbody"><span class="postbody">Hey kusma, you'll be happy to know that I discovered the problem, but I'm quite surprised by what it was, and even more confused that the compiler felt it was acceptable syntax (to my knowledge).
<br/>
<br/>
Starting in the "colorCount" tests, when it equals 3...
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">if (colorEqual(pal[1], colorLerp(pal[0], pal[2], 0.5), 31), 2*colorErr)</td> </tr></table><span class="postbody">...should be...</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">if (colorEqual(pal[1], colorLerp(pal[0], pal[2], 0.5), 2*colorErr))</td> </tr></table><span class="postbody">
<br/>
Separated out, it would look something like...</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">if( statement1, statement2 )</td> </tr></table><span class="postbody">
<br/>
I don't think you meant the code to be like that, but it compiled nonetheless. Would this be similar to ANDing or ORing them?
<br/>
<br/>
<br/>
Anyways, making the change will fix the problem. The "palette" file will grow a little with that same test image I used, but those bad blocks won't exist anymore. The resulting images actually seem to be somewhat improved too from the fix.<br/>_________________<br/><span style="font-weight: bold">DS</span> - It's all about <span style="font-weight: bold">D</span>isco<span style="font-weight: bold">S</span>tew</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167995 - kusma - Mon Apr 06, 2009 9:47 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>DiscoStew wrote:</b></span></td> </tr> <tr> <td class="quote">Hey kusma, you'll be happy to know that I discovered the problem</td> </tr></table><span class="postbody">
<br/>
Ah, thanks a lot for debugging the issue! This is indeed the real issue, and it works nicely for me as well. I guess this shows how few tiles really fall into this code-path, which is a bit scary.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">I'm quite surprised by what it was, and even more confused that the compiler felt it was acceptable syntax (to my knowledge).</td> </tr></table><span class="postbody">
<br/>
The syntax is perfectly legal to my knowledge. I'm not sure how usefull it is, though. And I'm not sure how it behaves.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167996 - kusma - Mon Apr 06, 2009 9:59 am</h4>
    <div class="postbody"><span class="postbody">OK, I checked out how it behaves. It evaluates both expressions, and returns the result of the second one. <a class="postlink" href="http://docs.roxen.com/pike/7.0/tutorial/expressions/comma.xml" target="_blank">Comma operator</a>
<br/>
<br/>
Anyway, I'll push your change upstream when I get home from work.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#168016 - DiscoStew - Mon Apr 06, 2009 10:07 pm</h4>
    <div class="postbody"><span class="postbody">I had made some additions to your code. I won't say "improvements", because atm, it improves one aspect of the resulting quality, but then makes another aspect worse.
<br/>
<br/>
Instead of checking with the first and last colors of a palette for blending, I made a check through all possible color combinations for the block, and took the one with the least error if under the color error (for 4-color, the most of the two, but the least of all blocks) to determine possible blending. The resulting palette size shrunk a little at the current color error, so I reduced that from 8 to 6 so my tests would have the prior palette size. The end result of the image was that there was much less blockiness. That is the good news. The bad news is that now the resulting image is somewhat more grainy and edges don't appear as smooth. It could be the method for how I chose the palettes for that section, so I'll go over it again.<br/>_________________<br/><span style="font-weight: bold">DS</span> - It's all about <span style="font-weight: bold">D</span>isco<span style="font-weight: bold">S</span>tew</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#168022 - kusma - Tue Apr 07, 2009 12:42 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>DiscoStew wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
Instead of checking with the first and last colors of a palette for blending, I made a check through all possible color combinations for the block, and took the one with the least error if under the color error (for 4-color, the most of the two, but the least of all blocks) to determine possible blending. The resulting palette size shrunk a little at the current color error, so I reduced that from 8 to 6 so my tests would have the prior palette size. The end result of the image was that there was much less blockiness. That is the good news. The bad news is that now the resulting image is somewhat more grainy and edges don't appear as smooth. It could be the method for how I chose the palettes for that section, so I'll go over it again.</td> </tr></table><span class="postbody">
<br/>
I'd love to see the patch, just for the sake of it. It's good to see improvements to stuff you do :) I'm sorry I wasn't able to push stuff upstream etc today, work turned into some kind of drunktard-celebration.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#168039 - DiscoStew - Tue Apr 07, 2009 11:27 pm</h4>
    <div class="postbody"><span class="postbody">Ok, here's the change I made (I commented out the prior implementation)
<br/>
<br/>
At the top, I have...
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">int pal4Count = 12;
<br/>
int pal4A[] = { 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 2, 2 };
<br/>
int pal4B[] = { 1, 1, 2, 2, 3, 3, 2, 2, 3, 3, 3, 3 };
<br/>
int pal4C[] = { 2, 3, 1, 3, 1, 2, 0, 3, 0, 2, 1, 0 };
<br/>
int pal4D[] = { 3, 2, 3, 1, 2, 1, 3, 0, 2, 0, 0, 1 };
<br/>
<br/>
int pal3Count = 3;
<br/>
int pal3A[] = { 0, 0, 1 };
<br/>
int pal3B[] = { 1, 2, 2 };
<br/>
int pal3C[] = { 2, 1, 0 };</td> </tr></table><span class="postbody">
<br/>
<br/>
...and in the code itself, I have...
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">int blockMode = 2; // if all else fails
<br/>
         if (colorCount == 4)
<br/>
         {
<br/>
            int curErrVal = INT_MAX;
<br/>
            int curErrIndex = -1;
<br/>
            for( int i = 0; i &lt; pal4Count; i++ )
<br/>
            {
<br/>
               int pal1Err = colorDiff( pal[ pal4C[ i ]], colorLerp( pal[ pal4A[ i ]], pal[ pal4B[ i ]], 0.375 ));
<br/>
               int pal2Err = colorDiff( pal[ pal4D[ i ]], colorLerp( pal[ pal4A[ i ]], pal[ pal4B[ i ]], 0.625 ));
<br/>
               if( pal1Err &lt; pal2Err ) pal1Err = pal2Err;
<br/>
               if( pal1Err &lt; curErrVal )
<br/>
               {
<br/>
                  curErrVal = pal1Err;
<br/>
                  curErrIndex = i;
<br/>
               }               
<br/>
            }
<br/>
            if(( curErrIndex &gt;= 0 ) &amp;&amp; ( curErrVal &lt;= ( 2 * colorErr )))
<br/>
            {
<br/>
               lerpable++;
<br/>
<br/>
               lerpColors[0] = pal[ pal4A[ curErrIndex ]];
<br/>
               lerpColors[1] = pal[ pal4B[ curErrIndex ]];
<br/>
               if( pal4A[ curErrIndex ] != 0 )
<br/>
               {
<br/>
                  BYTE a = 0;
<br/>
                  BYTE b = pal4A[ curErrIndex ];
<br/>
                  FreeImage_SwapColors(tileQuant.getFIBitmap(), &amp;pal[a], &amp;pal[b], true);
<br/>
                  FreeImage_SwapPaletteIndices(tileQuant.getFIBitmap(), &amp;a, &amp;b);
<br/>
               }
<br/>
               if( pal4B[ curErrIndex ] != 1 )
<br/>
               {
<br/>
                  BYTE a = 1;
<br/>
                  BYTE b = pal4B[ curErrIndex ];
<br/>
                  FreeImage_SwapColors(tileQuant.getFIBitmap(), &amp;pal[a], &amp;pal[b], true);
<br/>
                  FreeImage_SwapPaletteIndices(tileQuant.getFIBitmap(), &amp;a, &amp;b);
<br/>
               }
<br/>
               pal = lerpColors;
<br/>
               colorCount = 2;
<br/>
               blockMode = 3;
<br/>
            }
<br/>
            else
<br/>
               nonlerpable++;
<br/>
<br/>
            /*
<br/>
            if (colorEqual(pal[1], colorLerp(pal[0], pal[3], 0.375), 2*colorErr) &amp;&amp;
<br/>
               colorEqual(pal[2], colorLerp(pal[0], pal[3], 0.625), 2*colorErr))
<br/>
            {
<br/>
               lerpable++;
<br/>
               lerpColors[0] = pal[0];
<br/>
               lerpColors[1] = pal[3];
<br/>
               
<br/>
               BYTE a = 1;
<br/>
               BYTE b = 3;
<br/>
               FreeImage_SwapColors(tileQuant.getFIBitmap(), &amp;pal[a], &amp;pal[b], true);
<br/>
               FreeImage_SwapPaletteIndices(tileQuant.getFIBitmap(), &amp;a, &amp;b);
<br/>
               
<br/>
               pal = lerpColors;
<br/>
               colorCount = 2;
<br/>
               blockMode = 3;
<br/>
               
<br/>
            } else nonlerpable++;
<br/>
            */
<br/>
         }
<br/>
         else if (colorCount == 3)
<br/>
         {
<br/>
            int curErrVal = INT_MAX;
<br/>
            int curErrIndex = -1;
<br/>
            for( int i = 0; i &lt; pal3Count; i++ )
<br/>
            {
<br/>
               int palErr = colorDiff( pal[ pal3C[ i ]], colorLerp( pal[ pal3A[ i ]], pal[ pal3B[ i ]], 0.5 ));
<br/>
               if( palErr &lt; curErrVal )
<br/>
               {
<br/>
                  curErrVal = palErr;
<br/>
                  curErrIndex = i;
<br/>
               }               
<br/>
            }
<br/>
            if(( curErrIndex &gt;= 0 ) &amp;&amp; ( curErrVal &lt;= ( 2 * colorErr )))
<br/>
            {
<br/>
               lerpable++;
<br/>
               lerpColors[0] = pal[ pal3A[ curErrIndex ]];
<br/>
               lerpColors[1] = pal[ pal3B[ curErrIndex ]];
<br/>
               if( pal3A[ curErrIndex ] != 0 )
<br/>
               {
<br/>
                  BYTE a = 0;
<br/>
                  BYTE b = pal3A[ curErrIndex ];
<br/>
                  FreeImage_SwapColors(tileQuant.getFIBitmap(), &amp;pal[a], &amp;pal[b], true);
<br/>
                  FreeImage_SwapPaletteIndices(tileQuant.getFIBitmap(), &amp;a, &amp;b);
<br/>
               }
<br/>
               if( pal3B[ curErrIndex ] != 1 )
<br/>
               {
<br/>
                  BYTE a = 1;
<br/>
                  BYTE b = pal3B[ curErrIndex ];
<br/>
                  FreeImage_SwapColors(tileQuant.getFIBitmap(), &amp;pal[a], &amp;pal[b], true);
<br/>
                  FreeImage_SwapPaletteIndices(tileQuant.getFIBitmap(), &amp;a, &amp;b);
<br/>
               }
<br/>
               pal = lerpColors;
<br/>
               colorCount = colorPadCount = 2;
<br/>
               blockMode = 1;
<br/>
            }
<br/>
            else
<br/>
            {
<br/>
               colorPadCount = 4; // round up, colors are allocated two by two 
<br/>
               nonlerpable++;
<br/>
            }
<br/>
            /*
<br/>
            if (colorEqual(pal[1], colorLerp(pal[0], pal[2], 0.5), 2*colorErr))
<br/>
            {
<br/>
               lerpable++;
<br/>
               lerpColors[0] = pal[0];
<br/>
               lerpColors[1] = pal[2];
<br/>
               
<br/>
               BYTE a = 1;
<br/>
               BYTE b = 2;
<br/>
               FreeImage_SwapColors(tileQuant.getFIBitmap(), &amp;pal[a], &amp;pal[b], true);
<br/>
               FreeImage_SwapPaletteIndices(tileQuant.getFIBitmap(), &amp;a, &amp;b);
<br/>
               
<br/>
               pal = lerpColors;
<br/>
               colorCount = colorPadCount = 2;
<br/>
               blockMode = 1;
<br/>
            }
<br/>
            else
<br/>
            {
<br/>
               colorPadCount = 4; // round up, colors are allocated two by two 
<br/>
               nonlerpable++;
<br/>
            }
<br/>
            */
<br/>
         }
<br/>
         else if (colorCount == 1)
<br/>
         {
<br/>
            colorPadCount = 2; // round up, colors are allocated two by two 
<br/>
         }</td> </tr></table><span class="postbody">
<br/>
<br/>
Like I said before, it helps with block reduction, but the result appears grainy. Maybe someone can look at it, and see if any improvments can be made.<br/>_________________<br/><span style="font-weight: bold">DS</span> - It's all about <span style="font-weight: bold">D</span>isco<span style="font-weight: bold">S</span>tew</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#168252 - nanou - Fri Apr 17, 2009 1:43 am</h4>
    <div class="postbody"><span class="postbody">This kind of compression must be intended for sky textures. If you think about it, they mostly made up of gradients and most gradients are going to fit nicely within 4 colors for a 4x4 area (no matter which angle they're at) and many of the 4x4 blocks will work well with the blended modes.<br/>_________________<br/>- nanou</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#168262 - kusma - Fri Apr 17, 2009 1:02 pm</h4>
    <div class="postbody"><span class="postbody">Actually, they work pretty well for most kinds of textures.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#168275 - nanou - Sat Apr 18, 2009 2:23 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>kusma wrote:</b></span></td> </tr> <tr> <td class="quote">Actually, they work pretty well for most kinds of textures.</td> </tr></table><span class="postbody">
<br/>
Oh I'm sure you will get good results with other textures, but I'm thinking that most sky textures are going to turn out much closer to the original since they're likely to have few if any edges that aren't already smoothly graded.<br/>_________________<br/>- nanou</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
