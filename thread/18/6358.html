<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>GBFS Error - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > GBFS Error</h2>
<div id="posts">
<div class="post">
    <h4>#48424 - jandujar - Tue Jul 19, 2005 10:46 pm</h4>
    <div class="postbody"><span class="postbody">Hello, 
<br/>
I have a problem, i'm trying to incorporate a DAT file to my rom.
<br/>
<br/>
My makefile is this:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
# Makefile for gbfs_demo1.nds
<br/>
# <a href="mailto:chris.double@double.co.nz">chris.double@double.co.nz</a>
<br/>
NDSLIB_INCLUDE=c:/ndsdev/libnds/include
<br/>
NDSLIB_LIB=c:/ndsdev/libnds/lib
<br/>
<br/>
all: gbfs_demo1.nds.gba
<br/>
<br/>
<br/>
<br/>
libgbfs.o: libgbfs.c gbfs.h
<br/>
   arm-elf-g++ -g -Wall -O2 -mcpu=arm7tdmi -mtune=arm7tdmi -fomit-frame-pointer -ffast-math -mthumb-interwork -I$(NDSLIB_INCLUDE) -DARM7 -c libgbfs.c -olibgbfs.o
<br/>
<br/>
arm7_main.o: arm7_main.cpp
<br/>
   arm-elf-g++ -g -Wall -O2 -mcpu=arm7tdmi -mtune=arm7tdmi -fomit-frame-pointer -ffast-math -mthumb-interwork -I$(NDSLIB_INCLUDE) -DARM7 -c arm7_main.cpp -oarm7_main.o
<br/>
<br/>
arm7.elf: arm7_main.o 
<br/>
   arm-elf-g++ -g -mthumb-interwork -mno-fpu -specs=ds_arm7.specs arm7_main.o -L$(NDSLIB_LIB) -lnds7 -oarm7.elf
<br/>
<br/>
arm7.bin: arm7.elf 
<br/>
   arm-elf-objcopy -O binary arm7.elf arm7.bin
<br/>
<br/>
arm9_main.o: arm9_main.cpp
<br/>
   arm-elf-g++ -g -Wall -O2 -mcpu=arm9tdmi -mtune=arm9tdmi -fomit-frame-pointer -ffast-math -mthumb-interwork -I$(NDSLIB_INCLUDE) -DARM9 -c arm9_main.cpp -oarm9_main.o
<br/>
<br/>
arm9.elf: arm9_main.o libgbfs.o 
<br/>
   arm-elf-g++ -g -mthumb-interwork -mno-fpu -specs=ds_arm9.specs arm9_main.o libgbfs.o  -L$(NDSLIB_LIB) -lnds9 -o arm9.elf
<br/>
<br/>
arm9.bin: arm9.elf
<br/>
   arm-elf-objcopy -O binary arm9.elf arm9.bin
<br/>
<br/>
puzzles.gbfs: puzzles.dat
<br/>
   gbfs puzzles.gbfs puzzles.dat
<br/>
<br/>
gbfs_demo1.nds: arm7.bin arm9.bin puzzles.gbfs
<br/>
   ndstool -c gbfs_demo1.nds -9 arm9.bin -7 arm7.bin
<br/>
   cat gbfs_demo1.nds puzzles.gbfs &gt;gbfs_demo1_tmp.nds
<br/>
   mv gbfs_demo1_tmp.nds gbfs_demo1.nds
<br/>
<br/>
gbfs_demo1.nds.gba: gbfs_demo1.nds
<br/>
   dsbuild gbfs_demo1.nds -o gbfs_demo1.nds.gba
<br/>
<br/>
clean:
<br/>
   rm -f *.bin
<br/>
   rm -f *.elf
<br/>
   rm -f *.o
<br/>
   rm -f *~
<br/>
   rm -f *.raw
<br/>
   rm -f *.gbfs
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
And my source file is:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
<br/>
#include &lt;nds.h&gt;
<br/>
#include "nds/arm9/console.h"
<br/>
#include &lt;stdlib.h&gt;
<br/>
#include &lt;string.h&gt;
<br/>
#include &lt;stdio.h&gt;
<br/>
#include "gbfs.h"
<br/>
<br/>
<br/>
struct Fichero{
<br/>
  char const* filename;
<br/>
  uint8* data;
<br/>
  uint32 length;   
<br/>
};
<br/>
<br/>
/* 
<br/>
 * Aqu? tengo el fichero con los puzzles
<br/>
 * 
<br/>
 */
<br/>
static Fichero ficheros[]={
<br/>
   {"puzzles.dat",0,0},
<br/>
   {0,0,0}
<br/>
};
<br/>
<br/>
<br/>
static Fichero* current_file = 0;
<br/>
<br/>
<br/>
static void CargarDat(){
<br/>
  // Map Game Cartridge memory to ARM9
<br/>
  WAIT_CR &amp;= ~0x80;
<br/>
  
<br/>
  /* Start searching from the beginning of cartridge memory */
<br/>
  GBFS_FILE const* gbfs_file = 
<br/>
    find_first_gbfs_file((void*)0x08000000);
<br/>
<br/>
  unsigned int max_length = 0;
<br/>
  Fichero* file = ficheros;
<br/>
  while(file-&gt;filename) {
<br/>
    file-&gt;data = (uint8*)gbfs_get_obj(gbfs_file, 
<br/>
                  file-&gt;filename, 
<br/>
                  &amp;file-&gt;length);
<br/>
    if(file-&gt;length &gt; max_length)
<br/>
      max_length = file-&gt;length;
<br/>
    file++;
<br/>
  }
<br/>
  current_file=ficheros;
<br/>
  
<br/>
}
<br/>
static int key_prev = 0;
<br/>
static int key_curr = 0;
<br/>
int numpuzzles;
<br/>
static uint8* buffer = 0;
<br/>
<br/>
#define key_poll() { key_prev=key_curr; key_curr = KEYS; }
<br/>
#define key_transit(key) ((key_curr^key_prev) &amp; key)
<br/>
#define key_held(key) (~(key_curr|key_prev) &amp; key)
<br/>
#define key_hit(key) ((~key_curr&amp;key_prev) &amp; key)
<br/>
#define key_released(key) ((key_curr&amp;~key_prev) &amp; key)
<br/>
<br/>
void on_irq_vblank() 
<br/>
{   
<br/>
  
<br/>
  // Disable interrupts
<br/>
  IME = 0;
<br/>
<br/>
  consoleClear();
<br/>
  consolePrintf("GBFS Demo Program\n\n");
<br/>
<br/>
  consolePrintf("Press 'A' to play current file.\n");
<br/>
  consolePrintf("'left/right' changes file.\n");
<br/>
  consolePrintf("'up/down' changes channel.\n\n");
<br/>
<br/>
  consolePrintf("File:    %s (%d)\n", 
<br/>
      current_file-&gt;filename, 
<br/>
      current_file-&gt;length);
<br/>
  consolePrintf("Channel: %d\n", 0);  
<br/>
  //sscanf((const char*)current_file-&gt;data,"%d\n",&amp;numpuzzles);
<br/>
  consolePrintf("Numpuzzles: %d\n",numpuzzles);
<br/>
  
<br/>
  // Tell the DS we handled the VBLANK interrupt
<br/>
  IF = IF;
<br/>
  VBLANK_INTR_WAIT_FLAGS = IF | IE;
<br/>
<br/>
  // Enable interrupts
<br/>
  IME = 1;
<br/>
}
<br/>
<br/>
int main(void)
<br/>
{
<br/>
  powerON(POWER_ALL);  
<br/>
  videoSetMode(MODE_0_2D | DISPLAY_BG0_ACTIVE);
<br/>
  vramSetBankA(VRAM_A_MAIN_BG);
<br/>
  BG0_CR = BG_MAP_BASE(31);
<br/>
  BG_PALETTE[255] = RGB15(31,31,31);
<br/>
  lcdSwap();
<br/>
  irqInitHandler(irqDefaultHandler);
<br/>
  irqSet(IRQ_VBLANK, on_irq_vblank);
<br/>
  irqEnable(IRQ_VBLANK);
<br/>
  consoleInitDefault((u16*)SCREEN_BASE_BLOCK(31), (u16*)CHAR_BASE_BLOCK(0), 16);
<br/>
<br/>
<br/>
  CargarDat();
<br/>
  
<br/>
  while(1) {
<br/>
    swiWaitForVBlank();
<br/>
    key_poll();
<br/>
<br/>
    if(key_hit(KEY_UP)) {
<br/>
      
<br/>
    }
<br/>
    if(key_hit(KEY_DOWN)) {
<br/>
      
<br/>
    }
<br/>
    if(key_hit(KEY_LEFT)) {
<br/>
      if(--current_file &lt; ficheros)
<br/>
   current_file = ficheros;
<br/>
    }
<br/>
    if(key_hit(KEY_RIGHT)) {
<br/>
      if((++current_file)-&gt;filename == 0) 
<br/>
   --current_file;
<br/>
    }
<br/>
    if(key_hit(KEY_A)) {
<br/>
      dmaCopy(current_file-&gt;data, buffer, current_file-&gt;length);
<br/>
      sscanf((const char*)buffer,"%d\n",&amp;numpuzzles);
<br/>
    
<br/>
    }
<br/>
  }
<br/>
<br/>
  return 0;
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
my file puzzles.dat have this:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
1
<br/>
1 1 101010101010101010101010101010101010
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
But numpuzzles alwais sais "0"<br/>_________________<br/><a class="postlink" href="http://jandujar.homelinux.com" target="_blank">http://jandujar.homelinux.com</a>
<br/>
<a class="postlink" href="http://www.dsrobot.com" target="_blank">http://www.dsrobot.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#48435 - tepples - Tue Jul 19, 2005 11:22 pm</h4>
    <div class="postbody"><span class="postbody">On newer versions of devkitARM, the ".bss" section (unitialized global variables) will overwrite any appended data file. Until a workaround is found, try the bin2s method instead of the find_first_gbfs_file method.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#48441 - doublec - Wed Jul 20, 2005 12:14 am</h4>
    <div class="postbody"><span class="postbody">In this case though the gbfs file is appended to the nds file. The nds file lives in cartridge space ROM so can't be overwritten. I think the bss change will only affect those instances where the gbfs file is appended to the arm9 binary.
<br/>
<br/>
At a guess, you will need to padbin the nds file. I'll be changing the tutorial to mention this step. So change the following make line:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">gbfs_demo1.nds: arm7.bin arm9.bin puzzles.gbfs
<br/>
   ndstool -c gbfs_demo1.nds -9 arm9.bin -7 arm7.bin
<br/>
   padbin 256 gbfs_demo1.nds
<br/>
   cat gbfs_demo1.nds puzzles.gbfs &gt;gbfs_demo1_tmp.nds
<br/>
   mv gbfs_demo1_tmp.nds gbfs_demo1.nds
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Note that addition of the padbin line.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#48463 - jandujar - Wed Jul 20, 2005 6:49 am</h4>
    <div class="postbody"><span class="postbody">?what is the meaning of "bss" ?
<br/>
<br/>
I will try to padding the nds file, i don't know how to use bin2s<br/>_________________<br/><a class="postlink" href="http://jandujar.homelinux.com" target="_blank">http://jandujar.homelinux.com</a>
<br/>
<a class="postlink" href="http://www.dsrobot.com" target="_blank">http://www.dsrobot.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#48494 - Lord Graga - Wed Jul 20, 2005 12:53 pm</h4>
    <div class="postbody"><span class="postbody">That Makefile could be a lot more dynamic.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#48507 - tepples - Wed Jul 20, 2005 1:59 pm</h4>
    <div class="postbody"><span class="postbody">True, they could be more dynamic, but I see it as a "not yet" situation. A lot of people start with very simple shell scripts (*.bat), then write makefiles that are are essentially batch files with dependency information, then make them dynamic, making sure that they work after each stage. I know I've gone through these stages in some of my projects.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#48519 - GPFerror - Wed Jul 20, 2005 3:45 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>doublec wrote:</b></span></td> </tr> <tr> <td class="quote">In this case though the gbfs file is appended to the nds file. The nds file lives in cartridge space ROM so can't be overwritten. I think the bss change will only affect those instances where the gbfs file is appended to the arm9 binary.
<br/>
<br/>
At a guess, you will need to padbin the nds file. I'll be changing the tutorial to mention this step. So change the following make line:
<br/>
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">gbfs_demo1.nds: arm7.bin arm9.bin puzzles.gbfs
<br/>
   ndstool -c gbfs_demo1.nds -9 arm9.bin -7 arm7.bin
<br/>
   padbin 256 gbfs_demo1.nds
<br/>
   cat gbfs_demo1.nds puzzles.gbfs &gt;gbfs_demo1_tmp.nds
<br/>
   mv gbfs_demo1_tmp.nds gbfs_demo1.nds
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
<br/>
<br/>
Thanks
<br/>
Note that addition of the padbin line.</span></td> </tr></table><span class="postbody">
<br/>
<br/>
will this work with any of the current emulators?
<br/>
<br/>
I can't seem to get it to work.</span><span class="gensmall"><br/><br/>Last edited by GPFerror on Wed Jul 20, 2005 8:06 pm; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#48552 - tepples - Wed Jul 20, 2005 7:25 pm</h4>
    <div class="postbody"><span class="postbody">If you are concatenating the loader and the .nds files, then the loader has to be a multiple of 256 bytes as well.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#48577 - jandujar - Wed Jul 20, 2005 8:59 pm</h4>
    <div class="postbody"><span class="postbody">thanks a lot.
<br/>
It seems that padbin makes good things, but i have still having problems.
<br/>
<br/>
When I uncomment this line:
<br/>
<br/>
sscanf((const char*)current_file-&gt;data,"%d\n",&amp;numpuzzles);   (read the number 1 from puzzles.dat)
<br/>
<br/>
makes print screen bad things.
<br/>
<br/>
How can I read data from puzzles.dat?
<br/>
I know that current_file-&gt;data is uint8*<br/>_________________<br/><a class="postlink" href="http://jandujar.homelinux.com" target="_blank">http://jandujar.homelinux.com</a>
<br/>
<a class="postlink" href="http://www.dsrobot.com" target="_blank">http://www.dsrobot.com</a></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
