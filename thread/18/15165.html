<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Retrieve amount of stack memory free - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>DS development > Retrieve amount of stack memory free</h2>
<div id="posts">
<div class="post">
    <h4>#152198 - Rajveer - Tue Mar 11, 2008 7:17 pm</h4>
    <div class="postbody"><span class="postbody">Is there any way to retrieve the amount of stack memory available free? I have a recursive function which I believe to be overloading the stack and crashing my game, before rewriting the functions I thought I'd ask to make sure my assumptions are correct.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#152199 - Rajveer - Tue Mar 11, 2008 7:29 pm</h4>
    <div class="postbody"><span class="postbody">Erm, I had a while loop without incrementing the counter -_-
<br/>
<br/>
Still, would be helpful and interesting to see how much stack space I'm using with this function, is it possible?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#152200 - DekuTree64 - Tue Mar 11, 2008 7:33 pm</h4>
    <div class="postbody"><span class="postbody">Make a .s file with this:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
.global GetStackPointer
<br/>
.text
<br/>
.thumb
<br/>
.thumb_func
<br/>
GetStackPointer:
<br/>
mov r0, sp
<br/>
bx lr</td> </tr></table><span class="postbody">
<br/>
<br/>
and prototype as
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void* GetStackPointer();</td> </tr></table><span class="postbody">
<br/>
<br/>
Then you can print the current stack pointer from your recursive function and see if it goes too far.
<br/>
<br/>
Another classic method of stack debugging is to put a bunch of known values near the end of the stack (0xDEADBEEF or whatever) and then in your main loop, check if any of them have been overwritten. That will tell you how large the stack has ever grown. Of course, if it actually overflows, you probably won't make it back to the checking location.<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#152201 - simonjhall - Tue Mar 11, 2008 7:48 pm</h4>
    <div class="postbody"><span class="postbody">If you don't want to make a separate assembly file, try:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">register unsigned int sp asm ("sp");
<br/>
printf("my stack pointer is, %08x\n", sp);</td> </tr></table><span class="postbody">...for pure ownage.
<br/>
Not as robust as deku's, though as the compiler may want to move stuff around. For instance if you want to get the lr and change the asm("sp") bit to "lr" you won't get the lr of the current function, you'll get the line after the printf. In which case, take a copy with a volatile non-register variable, then do the printf.
<br/>
<br/>
Or use deku's code :-)
<br/>
<br/>
PS: the register name is more target dependent than I would have thought. With the PPC GCC that I use, you can't do "sp" - instead you have to do "1".<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#152248 - Rajveer - Wed Mar 12, 2008 8:02 pm</h4>
    <div class="postbody"><span class="postbody">Cheers guys :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#154891 - Rajveer - Tue Apr 22, 2008 2:09 pm</h4>
    <div class="postbody"><span class="postbody">Don't mean to bring up an old thread (actually I do, that's why I'm doing it lol) but how would you suggest I check how much free RAM I have too? Keep a count of how much I've allocated, or keep mallocing until it fails, or is there another easier way?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#154893 - eKid - Tue Apr 22, 2008 2:33 pm</h4>
    <div class="postbody"><span class="postbody">"mallinfo" ... <a class="postlink" href="http://www.gnu.org/software/libtool/manual/libc/Statistics-of-Malloc.html" target="_blank">http://www.gnu.org/software/libtool/manual/libc/Statistics-of-Malloc.html</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#154894 - Noda - Tue Apr 22, 2008 3:25 pm</h4>
    <div class="postbody"><span class="postbody">I didn't get mallinfo to work on DS, unfortunately.
<br/>
<br/>
Here's what I'm using, I simply allocate memory to know how much free memory is available:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">// get amount of free RAM
<br/>
int getFreeRAM()
<br/>
{
<br/>
    int q = 2*1024*1024;   // 2 Mb
<br/>
    int size = q;
<br/>
    void *ptr;
<br/>
 
<br/>
    do {    
<br/>
        ptr = malloc(size);
<br/>
 
<br/>
        if(ptr) {
<br/>
            free(ptr);
<br/>
        } else {
<br/>
            size -= q;
<br/>
        }
<br/>
        q /= 2;
<br/>
        size += q;        
<br/>
 
<br/>
    } while(q &gt; 0);
<br/>
 
<br/>
    return size;
<br/>
}</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#154896 - Rajveer - Tue Apr 22, 2008 3:28 pm</h4>
    <div class="postbody"><span class="postbody">Mallinfo worked for me, cheers guys. Now I know it's called mallinfo, searching for it brought up similar posts, sorry!
<br/>
<br/>
Noda what was the error, did you include &lt;unistd.h&gt; and
<br/>
&lt;malloc.h&gt;? For allocated memory I simply used:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">struct mallinfo mi = mallinfo();
<br/>
int usedMem = mi.uordblks;
<br/>
printf("\x1b[22;0HMem: Used %d  ", usedMem);</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#154897 - Noda - Tue Apr 22, 2008 3:39 pm</h4>
    <div class="postbody"><span class="postbody">I used that exact same piece of code, but wheras my function returned 2149Ko of free memory, the mallinfo you use told me something around 190Ko.
<br/>
<br/>
Maybe it's just a misinterpretation of the result returned.
<br/>
<br/>
EDIT: btw the way, I used fordblks to get the number of free memory. Maybe this had been adressed with r22, didn't checked.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#154899 - theli - Tue Apr 22, 2008 3:53 pm</h4>
    <div class="postbody"><span class="postbody">i use this for getting free memory
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#include &lt;malloc.h&gt;
<br/>
extern u8 __end__[];        // end of static code and data
<br/>
extern u8 __eheap_end[];    // farthest point to which the heap will grow
<br/>
<br/>
u8* getHeapStart() {
<br/>
        return __end__;
<br/>
}
<br/>
u8* getHeapEnd() {
<br/>
        return (u8*)sbrk(0);
<br/>
}
<br/>
u8* getHeapLimit() {
<br/>
        return __eheap_end;
<br/>
}
<br/>
int getMemUsed() {
<br/>
        struct mallinfo mi = mallinfo();
<br/>
        return mi.uordblks;
<br/>
}
<br/>
int getMemFree() {
<br/>
        struct mallinfo mi = mallinfo();
<br/>
        return mi.fordblks + (getHeapLimit() - getHeapEnd());
<br/>
}</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#154900 - Noda - Tue Apr 22, 2008 4:38 pm</h4>
    <div class="postbody"><span class="postbody">Thanks, that may be handy ;)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#154916 - Cydrak - Tue Apr 22, 2008 11:00 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Noda wrote:</b></span></td> </tr> <tr> <td class="quote">wheras my function returned 2149Ko of free memory, the mallinfo you use told me something around 190Ko. </td> </tr></table><span class="postbody">
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>theli wrote:</b></span></td> </tr> <tr> <td class="quote">i use this for getting free memory
<br/>
...</td> </tr></table><span class="postbody">
<br/>
Just to clarify (since I use the same thing):
<br/>
mi.fordblks is right, but it only seems to cover free space <span style="font-style: italic">inside the heap</span>. The heap itself can shrink and grow, IIRC, through calls to sbrk(). The discrepancy should vanish once you add the space between the heap and the RAM limit.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#154943 - Rajveer - Wed Apr 23, 2008 1:34 am</h4>
    <div class="postbody"><span class="postbody">Thanks for the explanation Cydrak, now I understand :)</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
