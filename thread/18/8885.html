<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Problems including the WIFI-LIB into my project... - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > Problems including the WIFI-LIB into my project...</h2>
<div id="posts">
<div class="post">
    <h4>#75305 - qw3rty - Sun Mar 12, 2006 1:21 am</h4>
    <div class="postbody"><span class="postbody">I tried the last few days to implement the WiFi Lib into my project.
<br/>
Everything seems to work all right in my small test app, but as soon as I include it into my main program, I get unexplainable crashs.
<br/>
<br/>
I got it almost working in my main program, but it's very unstable.
<br/>
The most confusing issue is, that a few absolutely unrelated changes in the code can result in instant crash on bootup.
<br/>
(even if the changed function wasn't called once :O )
<br/>
<br/>
Maybe someone has has similar problems and could give me a hint ?
<br/>
<br/>
P.S. I have tried every source I could get my hands on - I started with trexec, thought the unstability came from some extra stuff of trexec, started from scratch with the wifi-lib-test-source, and had a look at the recently released source of wifichat...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#75336 - knight0fdragon - Sun Mar 12, 2006 7:00 am</h4>
    <div class="postbody"><span class="postbody">what problems are u having??? I just used the stripped down version available on the forums and had no problems with it<br/>_________________<br/><a href="http://www.myspace.com/knight0fdragonds" target="_blank">http://www.myspace.com/knight0fdragonds</a>
<br/>
<br/>
MK DS FC: Dragon 330772 075464 
<br/>
AC WW FC: Anthony SamsClub 1933-3433-9458 
<br/>
MPFH: Dragon 0215 4231 1206</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#75346 - qw3rty - Sun Mar 12, 2006 9:52 am</h4>
    <div class="postbody"><span class="postbody">If I had found a stripped down version I would have used it ;)
<br/>
Could you give me a hint were to find it ?
<br/>
<br/>
EDIT :
<br/>
Never mind, I found it... I have a look on the source... I really hope, this time it'll work ;)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#75397 - qw3rty - Sun Mar 12, 2006 6:22 pm</h4>
    <div class="postbody"><span class="postbody">ARGH !
<br/>
I can't get it to work AGAIN !!!
<br/>
<br/>
I will give you an example, of the unexplainable errors :
<br/>
<br/>
changing following line in the  code :
<br/>
<br/>
sprintf(printbuf,"Status: %s", assocstatus_strings[Wifi_AssocStatus()]);
<br/>
<br/>
into
<br/>
<br/>
sprintf(printbuf,"Status: %14s", assocstatus_strings[Wifi_AssocStatus()]);
<br/>
<br/>
results in instant crash on the NDS, even BEFORE that line gets called.
<br/>
There are no compiler errors,  (besides the "useless storage class" error, I get in socket.h (I suppose that's normal, because wifichat compiled and worked fine)
<br/>
<br/>
Is there something to avoid when using the wifi-lib ?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#75453 - knight0fdragon - Mon Mar 13, 2006 1:27 am</h4>
    <div class="postbody"><span class="postbody">email me ur code so that i may check it out <a href="mailto:dragondolez@yahoo.com">dragondolez@yahoo.com</a><br/>_________________<br/><a href="http://www.myspace.com/knight0fdragonds" target="_blank">http://www.myspace.com/knight0fdragonds</a>
<br/>
<br/>
MK DS FC: Dragon 330772 075464 
<br/>
AC WW FC: Anthony SamsClub 1933-3433-9458 
<br/>
MPFH: Dragon 0215 4231 1206</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#75498 - qw3rty - Mon Mar 13, 2006 3:31 pm</h4>
    <div class="postbody"><span class="postbody">I quickly put together parts of my code, and it's working.
<br/>
But when I include the rest of my code, it still crashes.
<br/>
<br/>
You can download the source here :
<br/>
<a class="postlink" href="http://qwerty.servebeer.com/dspaint.rar" target="_blank">http://qwerty.servebeer.com/dspaint.rar</a>
<br/>
Maybe someone can identify a problem in my spaghetti-code ;)
<br/>
<br/>
It's a little paint program, with a PC-Server, that saves the pictures.
<br/>
<br/>
Usage :
<br/>
<br/>
L / R : switch between tools / draw - screen
<br/>
X/Y : UNDO / REDO
<br/>
START : Connect to AP
<br/>
SELECT : Transfer the current image to the PC. (you can abort the transfer with "B", if you forgot to connect FIRST)
<br/>
<br/>
The PC-Adresse can't be changed in the program, but in the source ("paint.h, search for "transfer(IP_ADRESS(192,168,0,2),......")
<br/>
<br/>
The touch recognition isn't too good right now, because I disabled my additional touchscreen-code - it could be a source of problems (it's adding entries into IPC.h, not sure if that's OK to do).
<br/>
<br/>
P.S. : I won't take responsibility, if your PC crashes, your router explodes, your NDS bricks or your house burns down - this is an early part of my game (the game won't include a paint program, but a communication a-la Pictochat)
<br/>
<br/>
P.P.S. : There's a bug in the Fill-routine, that makes it crash with too complex graphics (lots of edges etc.) - maybe it's a stack overflow (the routine is recursive)...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#75500 - knight0fdragon - Mon Mar 13, 2006 4:11 pm</h4>
    <div class="postbody"><span class="postbody">what problem are u getting?????? it works fine for me,  the only thing is be sure to declare lcdMainOnBottom(), because with my version of libnds, it reverses the screens for some reason<br/>_________________<br/><a href="http://www.myspace.com/knight0fdragonds" target="_blank">http://www.myspace.com/knight0fdragonds</a>
<br/>
<br/>
MK DS FC: Dragon 330772 075464 
<br/>
AC WW FC: Anthony SamsClub 1933-3433-9458 
<br/>
MPFH: Dragon 0215 4231 1206</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#75519 - qw3rty - Mon Mar 13, 2006 7:01 pm</h4>
    <div class="postbody"><span class="postbody">As I said, this is only a little part of my program - as soon I try to integrate the whole source, it  crashes.
<br/>
<br/>
I can send you the whole source, but it's huge aprox. -  600KB code.
<br/>
And it's not easily readable - I was "learning while doing" :)
<br/>
(I started this project with only a little basic and pascal practice ;)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#75525 - bafio - Mon Mar 13, 2006 8:28 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>qw3rty wrote:</b></span></td> </tr> <tr> <td class="quote">As I said, this is only a little part of my program - as soon I try to integrate the whole source, it  crashes.
<br/>
<br/>
I can send you the whole source, but it's huge aprox. -  600KB code.
<br/>
And it's not easily readable - I was "learning while doing" :)
<br/>
(I started this project with only a little basic and pascal practice ;)</td> </tr></table><span class="postbody">
<br/>
<br/>
Hi, for what I can tell you are using stonebone's modifications to the wifi lib, taken from my DSChat (the readme2.txt is the same I wrote) but you are not properly setting up IPC, that is done differently from Sgstair's version.
<br/>
If you look at the thread on the forum or at the source code of DSChat, you will see the ARM7 init is different, and ARM9 (wifiMain method) too. 
<br/>
<br/>
Also, I am running into the same problem when doing fill, it seems that you get a stack overflow. If you find a method that works, I'll be happy to know and implement it in dsChat. And, I'm happy if you find any of the code of dschat useful, but if so I'd appriciate being cited when you release :)
<br/>
<br/>
Cheers
<br/>
<br/>
Bafio</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#75533 - qw3rty - Mon Mar 13, 2006 11:02 pm</h4>
    <div class="postbody"><span class="postbody">Hi Bafio :)
<br/>
<br/>
Yes, I use the modified LIB, it was the only one I found on the net.
<br/>
When I release it (I hope, I get it done this time - this game was already started on the GBA ;) ) I try to mention everyone who helped me :)
<br/>
<br/>
Now to the fill-routine :
<br/>
<br/>
My routine initializes 10 variables, it is called with 5 parameters (if I don't include the text-bg struct my funtion uses) plus an array with 256 bytes.(one byte per pixel of a line)
<br/>
<br/>
thats 256+30 bytes.
<br/>
<br/>
If you don't use text-backgrounds the variables could be reduced even further.
<br/>
<br/>
Have a look at my fill-routine (found in /arm9/include/paint/fill.h) - the weird shifts and &amp;'s were my try to optimize the speed....afterwards I noticed, that the compiler does it anyways....resulting in absolutely unreadable code.
<br/>
<br/>
It seems, that I can't produce too complex situations anymore, BUT i have only running the paint procedure (plus the wifi code) - I don't know if that is much of a help in such a situation...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#75537 - bafio - Mon Mar 13, 2006 11:43 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>qw3rty wrote:</b></span></td> </tr> <tr> <td class="quote">Hi Bafio :)
<br/>
<br/>
Yes, I use the modified LIB, it was the only one I found on the net.
<br/>
When I release it (I hope, I get it done this time - this game was already started on the GBA ;) ) I try to mention everyone who helped me :)
<br/>
<br/>
Now to the fill-routine :
<br/>
<br/>
My routine initializes 10 variables, it is called with 5 parameters (if I don't include the text-bg struct my funtion uses) plus an array with 256 bytes.(one byte per pixel of a line)
<br/>
<br/>
thats 256+30 bytes.
<br/>
<br/>
If you don't use text-backgrounds the variables could be reduced even further.
<br/>
<br/>
Have a look at my fill-routine (found in /arm9/include/paint/fill.h) - the weird shifts and &amp;'s were my try to optimize the speed....afterwards I noticed, that the compiler does it anyways....resulting in absolutely unreadable code.
<br/>
<br/>
It seems, that I can't produce too complex situations anymore, BUT i have only running the paint procedure (plus the wifi code) - I don't know if that is much of a help in such a situation...</td> </tr></table><span class="postbody">
<br/>
<br/>
Hi, thanks, I'll take a look at you routine, actually I have a really simple one (10 lines of code) since I work in balck and white, it's included in the source code, but that works only for small areas (it's recursive).
<br/>
<br/>
Didi you try to replace the inti of wifi in both arm 7 and 9 code? I really think your proble may be there, since the inti phase is different, and anyway it's better to do the proper initialization for IPC...
<br/>
<br/>
Cheers
<br/>
bafio</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#75541 - qw3rty - Tue Mar 14, 2006 1:06 am</h4>
    <div class="postbody"><span class="postbody">I was too quick - my routine still crashes with areas too complicated (I doubt you could produce an CLOSED area, thats comlicated enough, but  if you draw mindless lines on the screen and fill try to fill it, it will crash eventually.
<br/>
<br/>
	irqSet(IRQ_IPC_SYNC, Wifi_Update);
<br/>
	irqEnable(IRQ_IPC_SYNC);
<br/>
	REG_IPC_SYNC = IPC_SYNC_IRQ_ENABLE;
<br/>
<br/>
And yes, I included the code above into arm7-wifi-init and arm9 init. Is this all I had to do ? It seems to work much better - now I can transfer many images (before the DS didn't receive any messages after a few images - ok, my transfer routine may be not the best (it's my first bit of network code....)
<br/>
but there is one strange thing - I have to connect two times, or the PC won't receive my packets...hmmm...
<br/>
<br/>
P.S. : 10 lines of code ?! I nearly grew gray hairs on my fill- routine (one complete day :)
<br/>
But it was rewarding anyways, I did it without taking someone else's code or ideas :)
<br/>
<br/>
P.P.S. : I just noticed : when the NDS stopped receiving messages(yes, it still stops working after a certain amount of time), after reconnecting to the AP it worked again...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#75549 - bafio - Tue Mar 14, 2006 2:19 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>qw3rty wrote:</b></span></td> </tr> <tr> <td class="quote">I was too quick - my routine still crashes with areas too complicated (I doubt you could produce an CLOSED area, thats comlicated enough, but  if you draw mindless lines on the screen and fill try to fill it, it will crash eventually.
<br/>
<br/>
	irqSet(IRQ_IPC_SYNC, Wifi_Update);
<br/>
	irqEnable(IRQ_IPC_SYNC);
<br/>
	REG_IPC_SYNC = IPC_SYNC_IRQ_ENABLE;
<br/>
<br/>
And yes, I included the code above into arm7-wifi-init and arm9 init. Is this all I had to do ? It seems to work much better - now I can transfer many images (before the DS didn't receive any messages after a few images - ok, my transfer routine may be not the best (it's my first bit of network code....)
<br/>
but there is one strange thing - I have to connect two times, or the PC won't receive my packets...hmmm...
<br/>
<br/>
P.S. : 10 lines of code ?! I nearly grew gray hairs on my fill- routine (one complete day :)
<br/>
But it was rewarding anyways, I did it without taking someone else's code or ideas :)
<br/>
<br/>
P.P.S. : I just noticed : when the NDS stopped receiving messages(yes, it still stops working after a certain amount of time), after reconnecting to the AP it worked again...</td> </tr></table><span class="postbody">
<br/>
<br/>
Hi again, the reply I was writing to you went lost :(
<br/>
<br/>
but well, what is your program exactly about, I'm curious :) ?
<br/>
As for you problem look carefully in the init of arm9 in wifi.c:
<br/>
there is also this part (the arp timer)
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
extern void sgIP_ARP_Timer100ms();
<br/>
extern void Wifi_Update();
<br/>
<br/>
...
<br/>
<br/>
TIMER3_CR = 0;
<br/>
irqSet(IRQ_TIMER3, sgIP_ARP_Timer100ms);
<br/>
irqEnable(IRQ_TIMER3);
<br/>
TIMER3_DATA = (u16)-13106; 
<br/>
TIMER3_CR = TIMER_IRQ_REQ | TIMER_DIV_256;
<br/>
</td> </tr></table><span class="postbody">
<br/>
maybe that's what is missing, 
<br/>
<br/>
Cheers 
<br/>
<br/>
Bafio</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#75570 - tepples - Tue Mar 14, 2006 3:49 am</h4>
    <div class="postbody"><span class="postbody">Does your fill routine use run-length filling (seek to the left, then seek to the right, then fill a horizontal line, then look above and below that line), or does it make a separate function call for every single pixel?<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#75583 - qw3rty - Tue Mar 14, 2006 10:47 am</h4>
    <div class="postbody"><span class="postbody">My funtions gets as parameter the "last filled-line's length" (last_left_x to last_right_x ; last_left_x = last_right_x = clicked x-pos for the first call), then it checks the line above (or below, depending on the direction) from left_x to right_x, filling every pixel with the original color (if the line below was completely filled from left_x to right_x without gap, it's ok to fill every pixel with the original clor above that line too.)
<br/>
Then it checks further left / right.
<br/>
<br/>
if the current_left_x or the current_right_x border differ for more than one pixel, I have to check the line below (or above - the opposite scanning direction) from current_left_x to last_left_x - hence I call the same funtion with these parameters current_left x, last_left_x and current_line (+-1).
<br/>
<br/>
If I find at least one gap in the current_line, I call my fill function again, for every gap.
<br/>
<br/>
To make it short - I suppose I use "run-length" filling. :)
<br/>
P.S. : As you see, it's not as worse as calling my funtion for every pixel, but it gets called for each and every "unsteadiness" / "discontinuity".
<br/>
<br/>
@Bafio : It's name is "Blubb", it's a clone of a relatively unknown game I loved on the dreamcast.
<br/>
It's basically battle-ships mixed with minesweeper...But it's not as boring as battleships ;)
<br/>
<br/>
As soon as I get the WiFi-Lib integrated and the first online-alpha, I'll put it on the net(I'll need testers then anyways).
<br/>
I hope this will be in about two weeks (I have to learn for exams this week - ARGH :)
<br/>
<br/>
EDIT : 
<br/>
<br/>
SUCCESS !! It seems, that I have succesfully integrated the WiFi-Lib into my project....At least the WiFi-Init stage and also the Connection phase are working now.
<br/>
It was a pretty dumb bug :
<br/>
I found a global variable "u8 end;", but I initialized "end" again as u16 in functions....it compiled fine, but with "u8 end" declared as global variable, the Arm7 never finished initializing, or eventually it resulted in an instant crash.
<br/>
I'm baffled, that the "u8 end", that never got called before the crash, seemed to have caused it :-/
<br/>
<br/>
P.S. : I updated the RAR on  my website.
<br/>
The litte Paint program should now be quite stable...The interface could be better...it could come handy for someone who needs 16color graphics for NDS....I'm going to use it to create graphics for my game - i hope it won't look too bad ;)
<br/>
<br/>
P.P.S. : There seems to be some instability in the connection - sometimes the NDS stops receiveing messages - but after a reconnect to the AP, it's working again...any hints ? (keep-alive packets every now and then ?!)</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
