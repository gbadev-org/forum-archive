<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>The 'correct way to handle the hinge'? - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > The 'correct way to handle the hinge'?</h2>
<div id="posts">
<div class="post">
    <h4>#113105 - MrD - Sat Dec 23, 2006 4:18 am</h4>
    <div class="postbody"><span class="postbody">I've read some folks here get a bit riled up that a lot of homebrew doesn't handle the DS' hinge properly by dropping into a low power pause mode.
<br/>
<br/>
So, what do folks want the hinge to do, and how would you do it? (Don't just describe it: give code, otherwise I can't do much about it.)<br/>_________________<br/>Not active on this forum. For Lemmings DS help see its website.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#113109 - Firon - Sat Dec 23, 2006 5:03 am</h4>
    <div class="postbody"><span class="postbody">There's some registers/bits that need to be set when going into the lid-closed suspend mode. I'm not exactly sure which ones, though.
<br/>
<br/>
<a href="http://nocash.emubase.de/gbatek.htm#dspowermanagement" target="_blank">http://nocash.emubase.de/gbatek.htm#dspowermanagement</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#113131 - Lick - Sat Dec 23, 2006 1:42 pm</h4>
    <div class="postbody"><span class="postbody">I'm going to describe it anyway:
<br/>
1) Detect hinge status.
<br/>
2) If closed and the following procedure hasn't been done already: 
<br/>
- a. Turn off the backlight of both screens.
<br/>
- b. Power off the graphics hardware.
<br/>
- c. Optional: Power off the LCDs (POWER_LCD = 0). This will turn off the speakers as well. 
<br/>
3) If open and the following procedure hasn't been done already:
<br/>
- Do 2abc but now turn them on, instead of, off.
<br/>
<br/>
You're going to need the following functions: readPowerManagement() and writePowerManagment() and powerON() and powerOFF().<br/>_________________<br/><a class="postlink" href="http://licklick.wordpress.com" target="_blank">http://licklick.wordpress.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#113154 - 0xtob - Sat Dec 23, 2006 7:52 pm</h4>
    <div class="postbody"><span class="postbody">To save CPU power you might also want to send the CPUs to sleep using swiSleep, but I haven't figured out how that works yet. Does anyone here have an example how that is used? :-)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#113156 - Mighty Max - Sat Dec 23, 2006 8:01 pm</h4>
    <div class="postbody"><span class="postbody">I think:
<br/>
<br/>
Turn off power to everything not used. Set up the interrupts that should awake the DS again. (i.e. keychange on the lid, a timer or card removal)
<br/>
<br/>
And then just call the swiSleep. 
<br/>
<br/>
After the irq occured it should just continue to execute. And you can power up everything again.<br/>_________________<br/><a class="postlink" href="http://mightymax.org/gbamp_multiboot.html" target="_blank">GBAMP Multiboot</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#113178 - HyperHacker - Sun Dec 24, 2006 2:39 am</h4>
    <div class="postbody"><span class="postbody">Depends on the program, obviously in some cases you'll want the speakers to stay on, program to keep running, etc while others should just go into sleep mode. Turning off screens and lights is a given though.<br/>_________________<br/>I'm a PSP hacker now, but I still &lt;3 DS.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#113229 - MrD - Sun Dec 24, 2006 8:21 pm</h4>
    <div class="postbody"><span class="postbody">Eeesh... I'll pass. Thanks anyway though.<br/>_________________<br/>Not active on this forum. For Lemmings DS help see its website.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#113232 - OOPMan - Sun Dec 24, 2006 10:05 pm</h4>
    <div class="postbody"><span class="postbody">We'd rather you didn't...
<br/>
<br/>
It's rather irritating when homebrew doesn't handle sleep mode properly...
<br/>
<br/>
If nothing else, learning how to do it hones your coding skills ;-)<br/>_________________<br/>"My boot, your face..." - Attributed to OOPMan, Emperor of Eroticon VI
<br/>
<br/>
You can find my NDS homebrew projects <a class="postlink" href="http://blog.dev-scene.com/oopman/" target="_blank">here...</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#113248 - HyperHacker - Mon Dec 25, 2006 9:07 am</h4>
    <div class="postbody"><span class="postbody">Were you looking specifically for code you could drop into your program? It sounded more like you just wanted to know what a program was expected to do.<br/>_________________<br/>I'm a PSP hacker now, but I still &lt;3 DS.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#113264 - MrD - Mon Dec 25, 2006 3:50 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Were you looking specifically for code you could drop into your program?</td> </tr></table><span class="postbody">
<br/>
<br/>
Sort of, yeah. :)
<br/>
<br/>
I probably should have said 'Don't just describe it: give working example code, otherwise I can't do much about it.'
<br/>
<br/>
The reason I'm not too enthusiastic about implementing sleep mode is that I assumed the code to do so would be entirely ARM9... Monkeying around with the ARM7 code probably isn't too good an idea until I'm certain I can get it to work together with what's already there.<br/>_________________<br/>Not active on this forum. For Lemmings DS help see its website.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#113267 - Mighty Max - Mon Dec 25, 2006 6:40 pm</h4>
    <div class="postbody"><span class="postbody">The code example (tested in virtual16)
<br/>
<br/>
Arm9 Code:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
   /* if lid 'key' */
<br/>
   if (keys &amp; BIT(7)) {
<br/>
      /* hinge is closed */
<br/>
      /* set only key irq for waking up */
<br/>
      unsigned long oldIE = REG_IE ;
<br/>
      REG_IE = IRQ_KEYS ;
<br/>
      *(volatile unsigned short *)0x04000132 = BIT(14) | 255 ; /* any of the inner keys might irq */
<br/>
      /* power off everything not needed */
<br/>
      powerOFF(POWER_LCD) ;
<br/>
      /* set system into sleep */
<br/>
      sleep() ;
<br/>
      /* wait a bit until returning power */
<br/>
      while (REG_VCOUNT!=0) ;
<br/>
      while (REG_VCOUNT==0) ;
<br/>
      while (REG_VCOUNT!=0) ;
<br/>
      /* power on again */
<br/>
      powerON(POWER_LCD) ;
<br/>
      /* set up old irqs again */
<br/>
      REG_IE = oldIE ;
<br/>
   } ;
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Arm9 assembler for sleep():
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
.global sleep
<br/>
sleep:
<br/>
   mcr p15,0,r0,c7,c0,4
<br/>
   mov r0,r0               // a nop instruction to prevent failures 
<br/>
   BX lr
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Arm7 code:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
                  if (keys &amp; BIT(7)) {
<br/>
                        /* set up keychange as powerup signal again */
<br/>
                        REG_IE = IRQ_KEYS ;
<br/>
                        *(volatile unsigned short *)0x04000132 = BIT(14) | 255 ; /* any of the inner keys might irq */
<br/>
                        REG_IME = 1 ;
<br/>
                        /* power off not needed things */
<br/>
                        powerOFF(POWER_SOUND) ;
<br/>
                        /* enter powersave */
<br/>
                        swiSleep() ;
<br/>
                        /* sleep is over, power up again */
<br/>
                        powerON(POWER_SOUND) ;
<br/>
                        /* ToDo: save old REG_IE and restore it here */
<br/>
                  } ;
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
<br/>
The code will turn off LCDs/Sound on closing the lid. And reenabling power when a 'inner' key is pressed.
<br/>
<br/>
Merry  X-Mas
<br/>
<br/>
:edit:
<br/>
The arm7 seems to be unreliable the way it is used, gotta read up there after tomorrow and correct it.<br/>_________________<br/><a class="postlink" href="http://mightymax.org/gbamp_multiboot.html" target="_blank">GBAMP Multiboot</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#134688 - ThousandKnives - Sun Jul 15, 2007 9:34 pm</h4>
    <div class="postbody"><span class="postbody">I know this is an old thread but I am having issues setting up "hinge sleeping".  Mighty Max's code snippit was very helpful and I have integrated his code suggestions into my program, but I am confused on a few points:
<br/>
<br/>
-With regard to the Arm9 section, what is the necessity of the assembly code, and how does one insert such a function into C/C++ code?  I tried using asm() but the compiler didn't like the ":" character.  I took an x86 assembly course about 10 years ago but we never went over how to combine ASM with C.
<br/>
<br/>
-I have modified Mighty Max's Arm7 code for handling the sleep as follows, with these global (Arm7) variables in use:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">unsigned long oldIE = REG_IE;
<br/>
bool lidClosed = false;
<br/>
</td> </tr></table><span class="postbody">And with this code inserted at the end of the vCount handler.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">   if(!lidClosed &amp;&amp; !(but &amp; BIT(0)))
<br/>
      {
<br/>
      oldIE      = REG_IE;
<br/>
      REG_IE   = IRQ_VCOUNT;
<br/>
      REG_IME   = 1;
<br/>
      powerOFF(POWER_SOUND);
<br/>
      REG_SPICNT    =  BIT(11) | SPI_ENABLE | SPI_BAUD_1MHZ | SPI_DEVICE_POWER;
<br/>
      REG_SPIDATA =   PM_CONTROL_REG;
<br/>
      REG_SPICNT    &amp;=  ~BIT(11);//un-hold
<br/>
      //swiSleep();
<br/>
      lidClosed = true;
<br/>
      }
<br/>
   else if(lidClosed &amp;&amp; (but &amp; BIT(0)))
<br/>
      {
<br/>
      REG_IE   = oldIE;
<br/>
      powerSET(POWER_SOUND);
<br/>
      REG_SPICNT    =  BIT(11) | SPI_ENABLE | SPI_BAUD_1MHZ | SPI_DEVICE_POWER;
<br/>
      REG_SPIDATA =   PM_CONTROL_REG | PM_BACKLIGHT_TOP;
<br/>
      REG_SPICNT    &amp;=  ~BIT(11);//un-hold
<br/>
      lidClosed = false;
<br/>
      }
<br/>
</td> </tr></table><span class="postbody">
<br/>
Here is the Arm9 code in my main game loop:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">      if(control-&gt;Check(KEY_X,CHECK_DOWN))
<br/>
         {
<br/>
         oldIE = REG_IE;
<br/>
         REG_IE = IRQ_KEYS;
<br/>
         powerOFF(POWER_LCD); 
<br/>
         oldMode = GetMode();
<br/>
         SwitchMode(MODE_SLEEP);
<br/>
         }
<br/>
      else if(control-&gt;Check(KEY_X,CHECK_UP))
<br/>
         {
<br/>
         powerON(POWER_ALL_2D);
<br/>
         REG_IE = oldIE;
<br/>
         SwitchMode(oldMode);
<br/>
         }
<br/>
</td> </tr></table><span class="postbody">
<br/>
This code works properly, shutting off the sound and screens when the X button is pressed (X button is for simplicity's sake while testing, rather than having to peep in while closing the lid).  However, I have three issues with what I've done:
<br/>
1. I have had to comment out "swiSleep()".  This is because using swiSleep makes the DS go comatose - it doesn't wake up when the lid is re-opened.  Why is this function necessary and how can it's effect be "undone" when the lid is opened?  Or, more importantly, could using it actually be preventing some of my other code from working?
<br/>
2. According to the Specifications I used to help me write the SPI code (http://nocash.emubase.de/gbatek.htm) I should use "WaitByLoop(3)" after accessing the SPI.  What is WaitByLoop() and why is it neccarity, and more importantly why does this code function properly without?
<br/>
3. When closing the lid there is a slight popping noise from the speakers, presumably from the sound being turned off.  This doesn't happen on commerical games so I'm assuming something can be done about it?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#134778 - bob_fossil - Mon Jul 16, 2007 5:51 pm</h4>
    <div class="postbody"><span class="postbody">To stop the sound popping try:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
// Turn the speaker down.
<br/>
swiChangeSoundBias(0,0x400);
<br/>
<br/>
// Turn the speaker up.
<br/>
swiChangeSoundBias(1,0x400);
<br/>
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I got swiSleep() to work by storing away REG_IE and then setting it to IRQ_LID. When you open the lid, the interrupt fires and swiSleep returns control. Then you just restore REG_IE to what it was before. This may not be the best way to do it but it works in my game.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#134786 - ThousandKnives - Mon Jul 16, 2007 7:58 pm</h4>
    <div class="postbody"><span class="postbody">Thanks bob fossil.  Your sound code stopped the popping noise right on!
<br/>
<br/>
As for the swiSleep problem, it actually seemed that it was a result of enabling REG_IME (somehow).
<br/>
<br/>
My code causes the LED light to go a bit dim but it doesn't blink.  Anyone know how to get the light to blink?
<br/>
<br/>
Edit: I have added this code, but it isn't having any effect.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">REG_SPICNT  = BIT(11) | SPI_ENABLE | SPI_BAUD_1MHZ | SPI_DEVICE_POWER;
<br/>
REG_SPIDATA = PM_LED_SLEEP;
<br/>
REG_SPICNT  &amp;= ~BIT(11);//un-hold
<br/>
</td> </tr></table><span class="postbody">
<br/>
I also tried accomplishing the same thing by adding  "| PM_LED_SLEEP" to the SPI statement that I use to turn off screen power, and that doesn't work either.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#134790 - Quirky - Mon Jul 16, 2007 9:10 pm</h4>
    <div class="postbody"><span class="postbody">I thought that this was a bug in libnds and wrote <a class="postlink" href="http://sourceforge.net/tracker/index.php?func=detail&amp;aid=1686383&amp;group_id=114505&amp;atid=668551" target="_blank">this  bug report</a>. </span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">writePowerManagement(PM_CONTROL_REG, PM_LED_CONTROL(1));</td> </tr></table><span class="postbody"> produces suitable blinking.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#134794 - bob_fossil - Mon Jul 16, 2007 9:47 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quirky wrote:</b></span></td> </tr> <tr> <td class="quote">I thought that this was a bug in libnds and wrote <a class="postlink" href="http://sourceforge.net/tracker/index.php?func=detail&amp;aid=1686383&amp;group_id=114505&amp;atid=668551" target="_blank">this  bug report</a>. <table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">writePowerManagement(PM_CONTROL_REG, PM_LED_CONTROL(1));</td> </tr></table><span class="postbody"> produces suitable blinking.</span></td> </tr></table><span class="postbody">
<br/>
<br/>
Cheers for that Quirky! I've got my LED blinking away now. Here's the code I've ended up with if anyone's interested. It lives in the arm7 inside the VcountHandler function.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
   but = REG_KEYXY;
<br/>
   // Check if the lid has been closed.
<br/>
   if(but &amp; BIT(7))
<br/>
      {
<br/>
      // Save the current interrupt sate.
<br/>
      u32 ie_save = REG_IE;
<br/>
      // Turn the speaker down.
<br/>
      swiChangeSoundBias(0,0x400);
<br/>
      // Save current power state.
<br/>
      int power = readPowerManagement(PM_CONTROL_REG);
<br/>
      // Set sleep LED.
<br/>
      writePowerManagement(PM_CONTROL_REG, PM_LED_CONTROL(1));
<br/>
      // Register for the lid interrupt. 
<br/>
      REG_IE = IRQ_LID;
<br/>
<br/>
      // Power down till we get our interrupt.
<br/>
      swiSleep(); //waits for PM (lid open) interrupt
<br/>
<br/>
      REG_IF = ~0;
<br/>
      // Restore the interrupt state.
<br/>
      REG_IE = ie_save;
<br/>
      // Restore power state.
<br/>
      writePowerManagement(PM_CONTROL_REG, power);
<br/>
         
<br/>
      // Turn the speaker up.
<br/>
      swiChangeSoundBias(1,0x400);
<br/>
      }         
<br/>
   //
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Seems to do the trick for me. :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#134795 - ThousandKnives - Mon Jul 16, 2007 10:04 pm</h4>
    <div class="postbody"><span class="postbody">Thanks for the heads up Quirky.  I hadn't noticed the writePowerManagement function before.  Your bug report is very helpful as well.  My blinking light now works- I used essentially the same method as bob_fossil.
<br/>
<br/>
I'm wondering if this code makes use of powerOFF/ON(POWER_SOUND) redundant?  There is a sound power bit in the Power Management SPI, is that the same thing?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#136773 - yellowstar - Sat Aug 04, 2007 9:03 pm</h4>
    <div class="postbody"><span class="postbody">I know this is an old topic,
<br/>
but anyway:
<br/>
<br/>
I can't get the assembler code for sleep
<br/>
to compile.
<br/>
<br/>
Here's the compile error:
<br/>
"C:/DOCUME~1/Owner/LOCALS~1/Temp/ccYTxbeM.s(76): Error: selected processor does not support `mcr p15,0,r0,c7,c0,4'"
<br/>
<br/>
I tried using an s file for this,
<br/>
but that won't work either.
<br/>
It says it can't find the sleep function,
<br/>
or something like that.
<br/>
<br/>
By the way,
<br/>
there is a function called sleep
<br/>
in the unistd header file.
<br/>
It dosen't do the same thing though.
<br/>
So you get an error when you include it.
<br/>
In my app I renamed it to Sleep.
<br/>
<br/>
Here's the code I am using for the sleep function:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
__asm("mcr p15,0,r0,c7,c0,4");
<br/>
__asm("mov r0, r0");
<br/>
__asm("BX lr");
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#138810 - melw - Wed Aug 29, 2007 9:18 am</h4>
    <div class="postbody"><span class="postbody">I also stubled upon this topic while looking for lid sleep functionality.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>yellowstar wrote:</b></span></td> </tr> <tr> <td class="quote">I can't get the assembler code for sleep
<br/>
to compile.
<br/>
<br/>
Here's the compile error:
<br/>
"C:/DOCUME~1/Owner/LOCALS~1/Temp/ccYTxbeM.s(76): Error: selected processor does not support `mcr p15,0,r0,c7,c0,4'"</td> </tr></table><span class="postbody">
<br/>
<br/>
The compiler doesn't know you're trying to compile for ARM processor - try using -march=armv5te and/or -marm in your makefile as a compiler parameter.
<br/>
<br/>
Here's slightly modified source code for lid sleep. It's working with the latest libnds (CVS 280807) and is based on what Mighty Max, Bob Fossil and Quirky already wrote:
<br/>
<br/>
ARM7 VcountHandler:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
// Check if the lid has been closed.
<br/>
if(keys &amp; BIT(7)) {
<br/>
   // Save the current interrupt sate.
<br/>
   u32 ie_save = REG_IE;
<br/>
   // Turn the speaker down.
<br/>
   swiChangeSoundBias(0,0x400);
<br/>
   // Save current power state.
<br/>
   int power = readPowerManagement(PM_CONTROL_REG);
<br/>
   // Set sleep LED.
<br/>
   writePowerManagement(PM_CONTROL_REG, PM_LED_CONTROL(1));
<br/>
   // Register for the lid interrupt.
<br/>
   REG_IE = IRQ_LID;
<br/>
   
<br/>
   // Power down till we get our interrupt.
<br/>
   swiSleep(); //waits for PM (lid open) interrupt
<br/>
   
<br/>
   REG_IF = ~0;
<br/>
   // Restore the interrupt state.
<br/>
   REG_IE = ie_save;
<br/>
   // Restore power state.
<br/>
   writePowerManagement(PM_CONTROL_REG, power);
<br/>
   
<br/>
   // Turn the speaker up.
<br/>
   swiChangeSoundBias(1,0x400);
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
ARM9:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void lidSleep()
<br/>
{
<br/>
   __asm("mcr p15,0,r0,c7,c0,4");
<br/>
   __asm("mov r0, r0");
<br/>
   __asm("BX lr"); 
<br/>
}
<br/>
<br/>
// when reading keys
<br/>
if (keys &amp; KEY_LID) {
<br/>
   /* <b style="color:#FFA34F">hinge</b> is closed */
<br/>
   /* set only key irq for waking up */
<br/>
   unsigned long oldIE = REG_IE;
<br/>
   REG_IE = IRQ_KEYS;
<br/>
   *(volatile unsigned short *)0x04000132 = BIT(14) | 255; /* any of the inner keys might irq */
<br/>
   /* power off everything not needed */
<br/>
   powerOFF(POWER_LCD);
<br/>
   /* set system into sleep */
<br/>
   lidSleep();
<br/>
   /* wait a bit until returning power */
<br/>
   while (REG_VCOUNT!=0);
<br/>
   while (REG_VCOUNT==0);
<br/>
   while (REG_VCOUNT!=0);
<br/>
   /* power on again */
<br/>
   powerON(POWER_LCD);
<br/>
   /* set up old irqs again */
<br/>
   REG_IE = oldIE;
<br/>
}; 
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#138843 - Quirky - Wed Aug 29, 2007 7:15 pm</h4>
    <div class="postbody"><span class="postbody">You really don't need asm in there. You can use the libnds call swiIntrWait(1, IRQ_VBLANK);
<br/>
<br/>
The idea is this: on the arm7, you turn off the all interrupts when the lid goes down. On the arm9 you set an interrupt for when the next vblank hits. Since the all IRQ are turned off by the arm7, this won't fire ever. But! the arm7 also set an interrupt handler for the lid opening again. Now everything is off. The arm9 waiting for a vblank, the arm7 waiting for the lid to open. Once the lid-open interrupt fires, you switch the vblank irq back on in the arm7, which causes the swiIntrWait for vblank to fire on the arm9 and you are back in business, both processors up and running.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#138852 - Cydrak - Wed Aug 29, 2007 9:04 pm</h4>
    <div class="postbody"><span class="postbody">Err, I'm pretty sure IME, IE, IF are unique to each core, so you couldn't go and halt the ARM9 that way. The reason it would seem to work is that swiSleep() stops _both_ ARMs, and indeed most of the IRQ sources. If you replace swiIntrWait() with a busy loop, you should find (at least I do) that the '9 won't finish counting til the '7 wakes up.
<br/>
<br/>
Therefore, I would really recommend having one core initiate the process, not blindly checking keys on both sides! Otherwise, you'd have a lovely race condition, and the '9 might not finish powering down on its end. Especially if it was busy elsewhere. You probably don't want to sleep during a FAT call, for example... ^_^; Other apps (like music players, alarms...) will also need control over when and when not to sleep.
<br/>
<br/>
Personally I use swiWaitForIRQ(). It does exactly the same as the ASM above. I send a sleep message over FIFO, and a reply supplies the needed interrupt. I would also make sure graphics, lcd, sound and mic amps, and wifi are all shut down, some of these definitely stay active. (Heh... red sleep LEDs are amusing. At home. :P)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#138871 - laos - Thu Aug 30, 2007 1:53 am</h4>
    <div class="postbody"><span class="postbody">a lot of my homebrew uses the sleep mode support, ironically, my alarm clock for DS sleeps when closed xD<br/>_________________<br/>laos,
<br/>
In charge of Storyline: Tales of Dagur 2</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#138918 - Quirky - Thu Aug 30, 2007 7:11 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Cydrak wrote:</b></span></td> </tr> <tr> <td class="quote">Err, I'm pretty sure IME, IE, IF are unique to each core, so you couldn't go and halt the ARM9 that way. The reason it would seem to work is that swiSleep() stops _both_ ARMs, and indeed most of the IRQ sources. If you replace swiIntrWait() with a busy loop, you should find (at least I do) that the '9 won't finish counting til the '7 wakes up.</td> </tr></table><span class="postbody">
<br/>
<br/>
That does make sense, but empirically I've seen that the powerOFF(POWER_LCD); on the arm9 definitely works if you use ideas similar to the code posted above. I'm not sure how you would go about checking that a busy loop was actually paused while the arm7 was stopped either.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Personally I use swiWaitForIRQ(). It does exactly the same as the ASM above. I send a sleep message over FIFO, and a reply supplies the needed interrupt. I would also make sure graphics, lcd, sound and mic amps, and wifi are all shut down, some of these definitely stay active. (Heh... red sleep LEDs are amusing. At home. :P)</td> </tr></table><span class="postbody">
<br/>
<br/>
That is certainly more sophisticated. What would be the psuedo code for that? swiWaitForIRQ reacts to any interrupt, so I imagine it would be:
<br/>
<br/>
Arm9 turns off all its interrupts. turns on FIFO_NOT_EMPTY.
<br/>
Arm9 -&gt; arm7 send a message "the lid is down, go to sleep"
<br/>
arm7 -&gt; arm9 shuts itself (arm7) down, sets up for awaking on ??? then sends a return message.
<br/>
Arm9 again: the fifo not empty is triggered, if it is the correct FIFO message, then power down and wait for the lid open interrupt.
<br/>
<br/>
That just leaves the reverse steps for waking up.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#138940 - Cydrak - Fri Aug 31, 2007 1:16 am</h4>
    <div class="postbody"><span class="postbody">I tried removing the powerOFF too, and the LCD goes dark on sleep, then flashes white on waking anyway. So either it's unnecessary in the first place, or swiSleep() kills something important besides REG_POWERCNT. I think it's the latter--if I go rapidly in and out of sleep I see pixel garbage (in place of white) when I didn't powerOFF myself.
<br/>
<br/>
The loop runs long enough to count and watch:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">DisableIrqs();
<br/>
SendArm7ToSleep();
<br/>
for(volatile int i = 0; i &lt; 20000000; i++)
<br/>
    /* spin for about 3 sec */;</td> </tr></table><span class="postbody">
<br/>
<br/>
So let's say you close the lid for 10, 15, 20 seconds... If the ARM9 continued running there would be no pause when you opened it back up--the loop would have finished. But that's not what happens. It pauses for roughly 3 sec *after* I open the lid.
<br/>
<br/>
I'm not sure what you mean about the ARM9 powering down or the lid interrupt, according to GBAtek only the ARM7 has that. It helps to have a good messaging system, then it's only a few lines:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void Sleep9(int irqWakeMask) {
<br/>
    IRQGuard gu(IRQ_FIFO_NOT_EMPTY);
<br/>
    
<br/>
    // Also DisableWifi() / EnableWifi() / AutoConnect() if desired..
<br/>
    powerOFF(POWER_ALL);
<br/>
    
<br/>
    // Call Sleep7 on the other core
<br/>
    FIFO::Send(PM_SLEEP, 0, irqWakeMask);
<br/>
    
<br/>
    // Soon the '7 will get the message and go to sleep;
<br/>
    // wait for the message it will send after it wakes up.
<br/>
    while(!WakeReceived())
<br/>
        swiWaitForIRQ();
<br/>
    
<br/>
    powerON(POWER_ALL);
<br/>
}
<br/>
<br/>
void Sleep7(int irqWakeMask) {
<br/>
    u32 prevLed = Power::Led(PM_LED_SLEEP);
<br/>
    swiChangeSoundBias(0, 0x200);
<br/>
    powerOFF(POWER_SOUND);
<br/>
    {
<br/>
        IRQGuard gu(irqWakeMask);
<br/>
        swiSleep();
<br/>
    }
<br/>
    powerON(POWER_SOUND);    
<br/>
    swiChangeSoundBias(1, 0x200);
<br/>
    Power::Led(prevLed);
<br/>
    
<br/>
    // Wake up the ARM9
<br/>
    FIFO::Send(PM_WAKE);
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
My setup allows for replies, so I could actually have made PM_SLEEP a blocking call and done away with the wait on PM_WAKE--then FIFO::Send() would swiIntrWait() on the FIFO instead.
<br/>
<br/>
(I didn't do that... Sleep7() was deferred to the main loop, for a couple reasons. One was that my FIFO calls were meant to be either async, or else short and sweet. Also, libnds had a nesting issue that has since been fixed.)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#139018 - Quirky - Fri Aug 31, 2007 7:42 pm</h4>
    <div class="postbody"><span class="postbody">Some excellent ideas there, thanks. 
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Cydrak wrote:</b></span></td> </tr> <tr> <td class="quote">I'm not sure what you mean about the ARM9 powering down or the lid interrupt, according to GBAtek only the ARM7 has that. </td> </tr></table><span class="postbody">
<br/>
<br/>
By power down, I meant what it can, i.e. the screen. Got in a muddle over the lid irq, not sure what I meant either!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#139076 - yellowstar - Sat Sep 01, 2007 5:20 pm</h4>
    <div class="postbody"><span class="postbody">I finally got it to compile!
<br/>
<br/>
Once I put the following code before the asm,
<br/>
it worked!(The compiling part)
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
__asm(".arm");
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I tried to use a s file,
<br/>
but it still won't work.
<br/>
<br/>
I tried putting in the following code in the ARM9 main code,
<br/>
But it still won't detect the Sleep function.
<br/>
I get a error similar to this: "Undefined reference to Sleep"
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
extern void Sleep();
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Here's the asm I am using for the s file:(its name is sleep.s, in the ARM9
<br/>
source directory)
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
.arm
<br/>
<br/>
.global Sleep
<br/>
Sleep:
<br/>
mcr p15,0,r0,c7,c0,4 
<br/>
mov r0, r0 
<br/>
BX lr
<br/>
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I am not using this s file.
<br/>
Right now, if I tried to use the s file,
<br/>
it wouldn't compile.
<br/>
<br/>
<br/>
<br/>
<br/>
But now it won't work.(When I try to run it, and use Sleep mode.)
<br/>
<br/>
When I close the lid to send it into sleep mode,
<br/>
it works correctly.
<br/>
<br/>
But, when I open the lid to make it leave sleep mode,
<br/>
it won't leave sleep mode.
<br/>
<br/>
The ARM7 enters and leaves sleep mode correctly.
<br/>
<br/>
But, the ARM9, once in sleep mode,
<br/>
won't leave sleep mode.
<br/>
So the ARM9 is stuck in sleep mode,
<br/>
once it enters sleep mode.
<br/>
<br/>
<br/>
<br/>
I also have this function call in the ARM7, before the while loop.
<br/>
See the comment for why I have it there.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
writePowerManagement(PM_CONTROL_REG, PM_LED_CONTROL(0));//My DSX has the LED blinking when it turns on.
<br/>
//This is so that it stops blinking.
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
It does what it is supposed to do.
<br/>
But, it also turns off both screens.
<br/>
In the ARM9, I tried this code,
<br/>
but that didn't fix it.
<br/>
I have this code before the while loop.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
swiWaitForVBlank();
<br/>
powerON(POWER_LCD);
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Unlike the original code,
<br/>
I am using IPC, via shared memory,
<br/>
instead of checking the keys on both processors.
<br/>
This works fine,
<br/>
so this isn't the problem.
<br/>
<br/>
Here's the code I am using:
<br/>
<br/>
IPC.h
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#define CommandControl ((commandControl*)((uint32)(IPC) + sizeof(TransferRegion)))
<br/>
struct commandControl
<br/>
{
<br/>
bool processed;
<br/>
bool do_sleep;
<br/>
};
<br/>
<br/>
#ifdef ARM9
<br/>
<br/>
void IPCInit()
<br/>
{
<br/>
CommandControl-&gt;processed = 1;//So the ARM7 dosen't think it's time to sleep.
<br/>
CommandControl-&gt;do_sleep = 0;
<br/>
}
<br/>
<br/>
void ARM7Sleep()
<br/>
{
<br/>
<br/>
CommandControl-&gt;processed = 0;
<br/>
CommandControl-&gt;do_sleep = 1;
<br/>
<br/>
}
<br/>
<br/>
#endif
<br/>
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
ARM9
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#include "../../IPC.h"
<br/>
<br/>
extern "C" void Sleep();
<br/>
/*
<br/>
void Sleep()
<br/>
{
<br/>
   __asm(".arm");
<br/>
   __asm("mcr p15,0,r0,c7,c0,4"); 
<br/>
   __asm("mov r0, r0"); 
<br/>
   __asm("BX lr"); 
<br/>
}*/
<br/>
<br/>
void CheckSleep()
<br/>
{
<br/>
   if (keysDown() &amp; KEY_LID)
<br/>
   { 
<br/>
      /* <b style="color:#FFA34F">hinge</b> is closed */ 
<br/>
      /* set only key irq for waking up */ 
<br/>
      unsigned long oldIE = REG_IE; 
<br/>
      REG_IE = IRQ_LID; 
<br/>
      *(volatile unsigned short *)0x04000132 = BIT(14) | 255; /* any of the inner keys might irq */ 
<br/>
      /* power off everything not needed */ 
<br/>
      powerOFF(POWER_LCD); 
<br/>
      //Tell ARM7 to sleep
<br/>
      ARM7Sleep();
<br/>
      /* set system into sleep */ 
<br/>
      Sleep(); 
<br/>
      /* wait a bit until returning power */ 
<br/>
      while (REG_VCOUNT!=0); 
<br/>
      while (REG_VCOUNT==0); 
<br/>
      while (REG_VCOUNT!=0); 
<br/>
      /* power on again */ 
<br/>
      powerON(POWER_LCD); 
<br/>
      /* set up old irqs again */ 
<br/>
      REG_IE = oldIE; 
<br/>
   }
<br/>
}
<br/>
<br/>
..
<br/>
while(1)
<br/>
{
<br/>
scanKeys();
<br/>
CheckSleep();
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
ARM7
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
<br/>
void CheckSleep()
<br/>
{
<br/>
<br/>
   // Check if the lid has been closed. 
<br/>
if(CommandControl-&gt;processed == 0 &amp;&amp; CommandControl-&gt;do_sleep==1) {
<br/>
<br/>
CommandControl-&gt;processed = 1;
<br/>
CommandControl-&gt;do_sleep = 0;
<br/>
<br/>
   // Save the current interrupt sate. 
<br/>
   u32 ie_save = REG_IE; 
<br/>
   // Turn the speaker down. 
<br/>
   swiChangeSoundBias(0,0x400); 
<br/>
   // Save current power state. 
<br/>
   int power = readPowerManagement(PM_CONTROL_REG); 
<br/>
   // Set sleep LED. 
<br/>
   writePowerManagement(PM_CONTROL_REG, PM_LED_CONTROL(1)); 
<br/>
   // Register for the lid interrupt. 
<br/>
   REG_IE = IRQ_LID; 
<br/>
    
<br/>
   // Power down till we get our interrupt. 
<br/>
   swiSleep(); //waits for PM (lid open) interrupt 
<br/>
    
<br/>
   REG_IF = ~0; 
<br/>
   // Restore the interrupt state. 
<br/>
   REG_IE = ie_save; 
<br/>
   // Restore power state. 
<br/>
   writePowerManagement(PM_CONTROL_REG, power); 
<br/>
    
<br/>
   // Turn the speaker up. 
<br/>
   swiChangeSoundBias(1,0x400); 
<br/>
} 
<br/>
<br/>
}
<br/>
<br/>
void VBlankHandler(){
<br/>
<br/>
..
<br/>
<br/>
CheckSleep();
<br/>
}
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"><br/><br/>Last edited by yellowstar on Sun Sep 02, 2007 8:54 pm; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#139091 - Cydrak - Sat Sep 01, 2007 9:52 pm</h4>
    <div class="postbody"><span class="postbody">I don't know enough about the toolchain to see why the *.s is failing... it looks alright to me. Perhaps specify the section, e.g. ".text"? Does it get picked up by the makefile?
<br/>
<br/>
Are you compiling C++? Might need to say extern "C" ... instead, C++ function naming uses a different scheme.
<br/>
<br/>
As for PM_CONTROL_REG, read &lt;nds/arm7/serial.h&gt; and <a class="postlink" href="http://nocash.emubase.de/gbatek.htm#dspowermanagement" target="_blank">GBAtek: DS Power Management</a> (specifically the SPI device); that register controls more than just the LED...
<br/>
<br/>
The ARM9 probably isn't waking up, as you have it waiting on IRQ_KEYS which has nothing to do with the lid. That only works for the 10 GBA buttons in REG_KEYINPUT. You need use another method from the ARM7 side, like the FIFO or <a class="postlink" href="http://nocash.emubase.de/gbatek.htm#dsinterprocesscommunicationipc" target="_blank">IPC interrupt</a>.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#139149 - yellowstar - Sun Sep 02, 2007 8:52 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Cydrak wrote:</b></span></td> </tr> <tr> <td class="quote">I don't know enough about the toolchain to see why the *.s is failing... it looks alright to me. Perhaps specify the section, e.g. ".text"? Does it get picked up by the makefile?
<br/>
</td> </tr></table><span class="postbody">
<br/>
That didn't do anything.(It still won't work.)
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Cydrak wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
Are you compiling C++? Might need to say extern "C" ... instead, C++ function naming uses a different scheme.
<br/>
</td> </tr></table><span class="postbody">
<br/>
Yes, I am using C++.
<br/>
I tried that, and it worked!
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Cydrak wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
The ARM9 probably isn't waking up, as you have it waiting on IRQ_KEYS which has nothing to do with the lid. That only works for the 10 GBA buttons in REG_KEYINPUT. You need use another method from the ARM7 side, like the FIFO or <a class="postlink" href="http://nocash.emubase.de/gbatek.htm#dsinterprocesscommunicationipc" target="_blank">IPC interrupt</a>.</td> </tr></table><span class="postbody">
<br/>
That's how the above posted code,(above my first post)
<br/>
was.
<br/>
I tried fixing it on the ARM9, by switching it to IRQ_LID,
<br/>
but it still won't work.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146349 - yellowstar - Mon Dec 03, 2007 1:28 am</h4>
    <div class="postbody"><span class="postbody">I solved it!
<br/>
<br/>
Once I changed the IRQ
<br/>
the arm9 waits on,
<br/>
to IRQ_VBLANK, it worked!
<br/>
<br/>
<br/>
But, I'm having problems with noise
<br/>
when the lid is opened/closed.
<br/>
<br/>
When the lid is closed,
<br/>
it makes a little noise.(I'd perfer no noise,
<br/>
as for opening)
<br/>
(But, opening on official games
<br/>
have some noise on opening,
<br/>
so I guess I'll go with that amount of noise.)
<br/>
<br/>
When opened it makes alot more noise.
<br/>
<br/>
I'm enabling/disabling sound
<br/>
when entering/leaving sleep mode.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146352 - ThousandKnives - Mon Dec 03, 2007 1:44 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>yellowstar wrote:</b></span></td> </tr> <tr> <td class="quote">But, I'm having problems with noise
<br/>
when the lid is opened/closed.
<br/>
<br/>
When the lid is closed,
<br/>
it makes a little noise.(I'd perfer no noise,
<br/>
as for opening)
<br/>
(But, opening on official games
<br/>
have some noise on opening,
<br/>
so I guess I'll go with that amount of noise.)
<br/>
<br/>
When opened it makes alot more noise.
<br/>
<br/>
I'm enabling/disabling sound
<br/>
when entering/leaving sleep mode.</td> </tr></table><span class="postbody">
<br/>
<br/>
This behavior was already discussed in this very thread.  Here is the relevant post:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>bob_fossil wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
To stop the sound popping try: 
<br/>
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
// Turn the speaker down. 
<br/>
swiChangeSoundBias(0,0x400); 
<br/>
<br/>
// Turn the speaker up. 
<br/>
swiChangeSoundBias(1,0x400);
<br/>
</td> </tr></table><span class="postbody">
<br/>
</span></td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146355 - yellowstar - Mon Dec 03, 2007 2:05 am</h4>
    <div class="postbody"><span class="postbody">My code has that sound bias code.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#150405 - nipil - Sun Feb 03, 2008 10:17 pm</h4>
    <div class="postbody"><span class="postbody">Once again, this thread is taken out of the graveyard.
<br/>
Sorry about this, i'm just doing something that actually
<br/>
works, but i don't get why...
<br/>
<br/>
Arm7 code from <a class="postlink" href="http://forum.gbadev.org/viewtopic.php?p=134794#134794" target="_blank">this post</a> which is ok as far as arm7 is concerned : basically 		IRQ_LID &amp; swiSleep.
<br/>
<span style="font-weight: bold">First question is : what is this "REG_IF = ~0;" used for, on return the sleep ?!</span>
<br/>
As i get it, it's forcing all the IRQ flags, to simulate everything happened (on the Arm7 only afaik), but why ?
<br/>
<br/>
Arm9 code i use :
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">if (keysDown() &amp; KEY_LID) {
<br/>
   unsigned long oldIE = REG_IE ;
<br/>
   REG_IE = IRQ_VBLANK ;
<br/>
   powerOFF(POWER_LCD) ;
<br/>
   swiIntrWait(1, IRQ_VBLANK);
<br/>
   powerON(POWER_LCD) ;
<br/>
   REG_IE = oldIE ;
<br/>
} ;</td> </tr></table><span class="postbody">
<br/>
This last piece was tested on my DS and it "Just works (TM)"
<br/>
(screens turn off when closes, and back on when open)
<br/>
<span style="font-weight: bold">But i don't understand why this Arm9 part works !</span>
<br/>
<br/>
<span style="text-decoration: underline">My first assumption:</span>
<br/>
- Arm9's interrupts are reduced to VBLANK.
<br/>
- The screens are turned off
<br/>
- As such, there should be no vblank happening
<br/>
- .... Should never wake up ?
<br/>
<span style="font-style: italic">=&gt; "Problem" is : it does wake up when i open !</span>
<br/>
<br/>
<span style="text-decoration: underline">My second assumption:</span>
<br/>
- Arm9's interrupts are reduced to VBLANK.
<br/>
- The screens are turned off
<br/>
- There still are VBLANK interrupts coming
<br/>
- Arm9 it's directly woken up
<br/>
- On the next loop, the keysDown() doesn't hold KEY_LID
<br/>
- As a consequence, it shouldn't be put to sleep again
<br/>
<span style="font-style: italic">=&gt; "Problem" is : it stays asleep !</span>
<br/>
<br/>
Please, could somebody explain me what makes it working ?
<br/>
I don't like when i don't understand something, don't let me down :-)<br/>_________________<br/>NDS Lite Gold/Silver, MK5/R4DS, MSI PC54G2, D-Link DI-624</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#150417 - Jim e - Mon Feb 04, 2008 12:51 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>nipil wrote:</b></span></td> </tr> <tr> <td class="quote"><span style="font-weight: bold">First question is : what is this "REG_IF = ~0;" used for, on return the sleep ?!</span></td> </tr></table><span class="postbody">If I remember correctly, it acknowledges all pending interrupts. Considering its only allowing 1 interrupt, its not necessary but it doesn't harm anything.
<br/>
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>nipil wrote:</b></span></td> </tr> <tr> <td class="quote">Arm9 code i use :
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">if (keysDown() &amp; KEY_LID) {
<br/>
   unsigned long oldIE = REG_IE ;
<br/>
   REG_IE = IRQ_VBLANK ;
<br/>
   powerOFF(POWER_LCD) ;
<br/>
   swiIntrWait(1, IRQ_VBLANK);
<br/>
   powerON(POWER_LCD) ;
<br/>
   REG_IE = oldIE ;
<br/>
} ;</td> </tr></table><span class="postbody">
<br/>
This last piece was tested on my DS and it "Just works (TM)"
<br/>
(screens turn off when closes, and back on when open)
<br/>
<span style="font-weight: bold">But i don't understand why this Arm9 part works !</span>
<br/>
<br/>
<span style="text-decoration: underline">My first assumption:</span>
<br/>
- Arm9's interrupts are reduced to VBLANK.
<br/>
- The screens are turned off
<br/>
- As such, there should be no vblank happening
<br/>
- .... Should never wake up ?
<br/>
<span style="font-style: italic">=&gt; "Problem" is : it does wake up when i open !</span>
<br/>
<br/>
<span style="text-decoration: underline">My second assumption:</span>
<br/>
- Arm9's interrupts are reduced to VBLANK.
<br/>
- The screens are turned off
<br/>
- There still are VBLANK interrupts coming
<br/>
- Arm9 it's directly woken up
<br/>
- On the next loop, the keysDown() doesn't hold KEY_LID
<br/>
- As a consequence, it shouldn't be put to sleep again
<br/>
<span style="font-style: italic">=&gt; "Problem" is : it stays asleep !</span>
<br/>
<br/>
Please, could somebody explain me what makes it working ?
<br/>
I don't like when i don't understand something, don't let me down :-)</span></td> </tr></table><span class="postbody">If your using the arm7 code, that should be enough.  So using the arm9 with it has little effect.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#150420 - yellowstar - Mon Feb 04, 2008 4:08 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>nipil wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
Arm9 code i use :
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">if (keysDown() &amp; KEY_LID) {
<br/>
   unsigned long oldIE = REG_IE ;
<br/>
   REG_IE = IRQ_VBLANK ;
<br/>
   powerOFF(POWER_LCD) ;
<br/>
   swiIntrWait(1, IRQ_VBLANK);
<br/>
   powerON(POWER_LCD) ;
<br/>
   REG_IE = oldIE ;
<br/>
} ;</td> </tr></table><span class="postbody">
<br/>
This last piece was tested on my DS and it "Just works (TM)"
<br/>
(screens turn off when closes, and back on when open)
<br/>
<span style="font-weight: bold">But i don't understand why this Arm9 part works !</span>
<br/>
<br/>
<span style="text-decoration: underline">My first assumption:</span>
<br/>
- Arm9's interrupts are reduced to VBLANK.
<br/>
- The screens are turned off
<br/>
- As such, there should be no vblank happening
<br/>
- .... Should never wake up ?
<br/>
<span style="font-style: italic">=&gt; "Problem" is : it does wake up when i open !</span>
<br/>
<br/>
<span style="text-decoration: underline">My second assumption:</span>
<br/>
- Arm9's interrupts are reduced to VBLANK.
<br/>
- The screens are turned off
<br/>
- There still are VBLANK interrupts coming
<br/>
- Arm9 it's directly woken up
<br/>
- On the next loop, the keysDown() doesn't hold KEY_LID
<br/>
- As a consequence, it shouldn't be put to sleep again
<br/>
<span style="font-style: italic">=&gt; "Problem" is : it stays asleep !</span>
<br/>
<br/>
Please, could somebody explain me what makes it working ?
<br/>
I don't like when i don't understand something, don't let me down :-)</span></td> </tr></table><span class="postbody">
<br/>
<br/>
Here's how it works:
<br/>
You put the DS to sleep. Arm9 tells Arm7, and the Arm9 puts itself to sleep, with vblank being the trigger to wake up. Arm7 gets the Arm9's message, sets itself to wake up when the lid
<br/>
is opened, and puts itself to sleep. When that happens, the Arm7 wakes up.
<br/>
<br/>
VBlanks always happen, as long as at least one of the processors are awake. So, in this case, as soon as a VBlank is fired on the Arm7, the same VBlank interrupt happens on the Arm9, waking it up.
<br/>
<br/>
I don't know about the second thing...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#150425 - nipil - Mon Feb 04, 2008 8:39 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>yellowstar wrote:</b></span></td> </tr> <tr> <td class="quote">VBlanks always happen, <span style="font-style: italic">as long as at least one of the processors are awake</span>... as soon as a VBlank is fired on the Arm7, the same VBlank interrupt happens on the Arm9, waking it up</td> </tr></table><span class="postbody">So that's the part i didn't understand, thank you for explaining it ;)<br/>_________________<br/>NDS Lite Gold/Silver, MK5/R4DS, MSI PC54G2, D-Link DI-624</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#150523 - Cydrak - Wed Feb 06, 2008 3:02 am</h4>
    <div class="postbody"><span class="postbody">I'd leave REG_IF alone--libnds handles it automatically. If I understand right, setting it here will cause IRQs active between the two REG_IE lines to get lost. So I'm not sure why that is there... as soon as the DS wakes up, libnds should see and acknowledge IRQ_LID, anyway. Even without a handler.
<br/>
<br/>
The ARM9 code is not, IMHO, doing anything to make it work!
<br/>
<br/>
As soon as you call swiSleep() on the '7 side, practically the entire system goes into suspended animation. Sound, video (including vcount/vblanks iirc), timers, and the ARM9--amongst other things--are paused. When a suitable IRQ (such as lid, keys, clock...) wakes the ARM7, the ARM9 comes with it.
<br/>
<br/>
swiSleep() also shuts off the backlights, no matter what you do. I don't know about the LCDs, since on my DSLite, I can't see them afterwards.
<br/>
<br/>
That's why it "just works", far as I can tell: The ARM9 seems to have no choice in the matter. You might want to watch out if you're doing things like file I/O.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
