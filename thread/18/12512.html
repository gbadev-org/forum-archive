<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Libfat / devkitpro 20 problem with fwrite(),fseek() - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > Libfat / devkitpro 20 problem with fwrite(),fseek()</h2>
<div id="posts">
<div class="post">
    <h4>#119315 - Diddl - Wed Feb 21, 2007 9:01 pm</h4>
    <div class="postbody"><span class="postbody">below there are binaries and sources to demonstrate the problem with current libfat. the problem appears on R4, M3 lite and SuperCard lite in the same manner.
<br/>
<br/>
please patch binaries with your DLDI driver and test it yourself.
<br/>
<br/>
<br/>
Not working sample:  <a class="postlink" href="http://web3.vs2066076.netfabrik.de/nds/test_libfat_src_1.rar" target="_blank">source</a>, <a class="postlink" href="http://web3.vs2066076.netfabrik.de/nds/test_libfat_1.rar" target="_blank">binary</a>
<br/>
<br/>
Working sample:  <a class="postlink" href="http://web3.vs2066076.netfabrik.de/nds/test_libfat_src_2.rar" target="_blank">source</a>, <a class="postlink" href="http://web3.vs2066076.netfabrik.de/nds/test_libfat_2.rar" target="_blank">binary</a>
<br/>
<br/>
<br/>
the only difference in source are this lines:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">for(i = 0; i &lt;= ANZ_BLOCKS; ++i)</td> </tr></table><span class="postbody">
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">for(i = ANZ_BLOCKS; i &gt;= 0; --i)</td> </tr></table><span class="postbody">
<br/>
<br/>
<br/>
My suspicion is, the error occurs if the last operations are
<br/>
<ul>
<br/>
<li>a fseek() behind the end of file
<br/>
</li><li>a write access - fwrite() or fputs()
<br/>
</li><li>a fclose()
<br/>
</li></ul>
<br/>
<br/>
The interesting part is, the file is damaged! neither the NDS nor my PC can read this file. Windows says
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">cannot copy the source file.</td> </tr></table><span class="postbody"></span><span class="gensmall"><br/><br/>Last edited by Diddl on Wed Feb 21, 2007 10:50 pm; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#119324 - 0xtob - Wed Feb 21, 2007 10:30 pm</h4>
    <div class="postbody"><span class="postbody">I can confirm the problem (tested on SC Lite).
<br/>
<br/>
Both of your source links point to the same file, the second link should point to <a class="postlink" href="http://web3.vs2066076.netfabrik.de/nds/test_libfat_src_2.rar" target="_blank">http://web3.vs2066076.netfabrik.de/nds/test_libfat_src_2.rar</a>.
<br/>
<br/>
I hope you are aware that both of your loops actually iterate ANZ_BLOCKS + 1 times.<br/>_________________<br/><a class="postlink" href="http://blog.dev-scene.com/0xtob" target="_blank">http://blog.dev-scene.com/0xtob</a> | <a class="postlink" href="http://nitrotracker.tobw.net" target="_blank">http://nitrotracker.tobw.net</a> | <a class="postlink" href="http://dsmi.tobw.net" target="_blank">http://dsmi.tobw.net</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#119329 - Diddl - Wed Feb 21, 2007 10:53 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>0xtob wrote:</b></span></td> </tr> <tr> <td class="quote">Both of your source links point to the same file, the second link should point to <a class="postlink" href="http://web3.vs2066076.netfabrik.de/nds/test_libfat_src_2.rar" target="_blank">http://web3.vs2066076.netfabrik.de/nds/test_libfat_src_2.rar</a>.</td> </tr></table><span class="postbody">
<br/>
<br/>
thanks! I've corrected this ...
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>0xtob wrote:</b></span></td> </tr> <tr> <td class="quote">I hope you are aware that both of your loops actually iterate ANZ_BLOCKS + 1 times.</td> </tr></table><span class="postbody">
<br/>
<br/>
this is ok. blocks below 259 are 256 bytes blocks. the last on is only a simple text. I want to to the fat test with a odd number of bytes ...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#119419 - Payk - Thu Feb 22, 2007 9:49 pm</h4>
    <div class="postbody"><span class="postbody">Ok have to report stuff too.
<br/>
<br/>
<span style="font-weight: bold">R4</span> does hang when my game start rendering part. I am pretty sure it has loaded all stuff and tries to render first frame. I guess that it failed to load models right.(could be another fseek issue, but device dependendly)
<br/>
<br/>
<span style="font-weight: bold">DS-Xtreme</span> loads first map fine but then a "out of memory" (malloc returns NULL) occures. 
<br/>
If i deactivate sound-stuff it works absolutly fine. The reason could be wrong filesizes returned by dldi (my texture/model loading functions dont need to know filesize but the music loader needs to know) or some arm7&lt;&gt;arm9 issue. For example that ds-xtreme maight load homebrew stuff a bit wrong. But would just be since r20.
<br/>
<br/>
Sorry for that short report. I will do some bugtracking at this weekend. 
<br/>
It would be cool if more ppl could bring some reports here or could help a bit.
<br/>
Thanx</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#119465 - chishm - Fri Feb 23, 2007 6:33 am</h4>
    <div class="postbody"><span class="postbody">I traced the bug down for the seek problem. It has to do with seeking to the exact end of a file. I'll fix it when I can.
<br/>
<br/>
Payk:
<br/>
If you can, load your game via WMB, but patched for the R4 or DS-X (whichever one you're testing). If it works fine then the problem is with the menu. Also make sure to use the DS-X DLDI file from my site. The one on the DS-X site has bugs.<br/>_________________<br/><a class="postlink" href="http://chishm.drunkencoders.com" target="_blank">http://chishm.drunkencoders.com</a>
<br/>
<a class="postlink" href="http://dldi.drunkencoders.com" target="_blank">http://dldi.drunkencoders.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#119700 - chishm - Sun Feb 25, 2007 11:35 am</h4>
    <div class="postbody"><span class="postbody">Seek then write bug is fixed in CVS now.<br/>_________________<br/><a class="postlink" href="http://chishm.drunkencoders.com" target="_blank">http://chishm.drunkencoders.com</a>
<br/>
<a class="postlink" href="http://dldi.drunkencoders.com" target="_blank">http://dldi.drunkencoders.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#119717 - Diddl - Sun Feb 25, 2007 3:29 pm</h4>
    <div class="postbody"><span class="postbody">thank you Chishm. you are great!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#119730 - Payk - Sun Feb 25, 2007 5:55 pm</h4>
    <div class="postbody"><span class="postbody">Hey, yeah wmb helped for the r4. Thanx.
<br/>
But the DS-Xtreme DLDI from you site was that one which i was using.
<br/>
Maybe its not a fatbug at all. Could be some other stuff similar to the r4 one.
<br/>
But thanx for infos ;)</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
