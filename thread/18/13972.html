<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>fseek not seeking to end of the file - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>DS development > fseek not seeking to end of the file</h2>
<div id="posts">
<div class="post">
    <h4>#138235 - masscat - Tue Aug 21, 2007 4:26 pm</h4>
    <div class="postbody"><span class="postbody">There appears to be a problem with fseeking to the end of a file using libfat/DKA r20.
<br/>
I have put together some test code to show the problem (see below). The test code writes out "test" followed by "aaaa". It then seeks backwards 5 bytes and writes "a". It then seeks using the supplied offset and whence (SEEK_END etc.) and writes "bbbb".
<br/>
<br/>
Calling:
<br/>
seek_test( "end_test", 0, SEEK_END)
<br/>
seek_test( "cur_test", 4, SEEK_CUR)
<br/>
seek_test( "set_test", 8, SEEK_SET)
<br/>
<br/>
Should all seek the end of the file and produce the file contents "tesaaaaabbbb" but none of them do. They produce "tesabbbb" followed by four zero or rubbish byte values.
<br/>
<br/>
Note, calling:
<br/>
seek_test( "end_test", -1, SEEK_END)
<br/>
seek_test( "cur_test", 3, SEEK_CUR)
<br/>
seek_test( "set_test", 7, SEEK_SET)
<br/>
<br/>
All produce "tesaaaabbbb" as they should, so it is only the end of file case that seem to be a problem.
<br/>
<br/>
Here is the test code:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">int
<br/>
seek_test( const char *filename, long offset, int whence) {
<br/>
  int test_good = 1;
<br/>
  u8 temp_write[4] = {"test"};
<br/>
  FILE *test_file = fopen( filename, "wb+");
<br/>
<br/>
  if ( test_file != NULL) {
<br/>
    if ( fwrite( &amp;temp_write, 1, 4, test_file) == 4) {
<br/>
<br/>
      int j;
<br/>
      for ( j = 0; j &lt; 4; j++)
<br/>
        temp_write[j] = 'a';
<br/>
<br/>
      if ( fwrite( &amp;temp_write, 1, 4, test_file) == 4) {
<br/>
        /*
<br/>
         * seek back a bit and write something then seek to the
<br/>
         * end again.
<br/>
         */
<br/>
        if ( fseek( test_file, -5, SEEK_CUR) == 0) {
<br/>
          if ( fwrite( &amp;temp_write, 1, 1, test_file) == 1) {
<br/>
<br/>
            /*
<br/>
             * THE SEEK TO END
<br/>
             */
<br/>
            if ( fseek( test_file, offset, whence) == 0) {
<br/>
              for ( j = 0; j &lt; 4; j++)
<br/>
                temp_write[j] = 'b';
<br/>
<br/>
              if ( fwrite( &amp;temp_write, 1, 4, test_file) != 4) {
<br/>
                test_good = 0;
<br/>
              }
<br/>
            }
<br/>
            else
<br/>
              test_good = 0;
<br/>
          }
<br/>
          else
<br/>
            test_good = 0;
<br/>
        }
<br/>
        else
<br/>
          test_good = 0;
<br/>
      }
<br/>
      else
<br/>
        test_good = 0;
<br/>
    }
<br/>
    else
<br/>
      test_good = 0;
<br/>
<br/>
    fclose( test_file);
<br/>
  }
<br/>
  else {
<br/>
    iprintf("Failed to open file\n");
<br/>
  }
<br/>
<br/>
  return test_good;
<br/>
}
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
