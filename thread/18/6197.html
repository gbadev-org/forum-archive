<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>malloc() not working - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>DS development > malloc() not working</h2>
<div id="posts">
<div class="post">
    <h4>#46917 - headspin - Sat Jul 02, 2005 1:36 am</h4>
    <div class="postbody"><span class="postbody">Hi, currently I have a variable I use to store large sample data.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#define MAXSMP   (44100*10)
<br/>
<br/>
short VAR_IN_EXRAM MemWav[MAXSMP];</td> </tr></table><span class="postbody">
<br/>
<br/>
To save taking such a long time to send via wifime, I'd like to malloc it at run-time.
<br/>
<br/>
I use this code:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">short *MemWav;</td> </tr></table><span class="postbody">
<br/>
<br/>
Then in main() I allocate memory (I've tried both these methods):
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">MemWav = new short[MAXSMP];
<br/>
// or
<br/>
MemWav = (short *) malloc(MAXSMP);</td> </tr></table><span class="postbody">
<br/>
<br/>
I assume they are essentially the same since new calls malloc, am I correct?
<br/>
<br/>
This is crashing my ROM using either of these methods. I should probably place it in external RAM, how can I do that using malloc/new?
<br/>
<br/>
I have tried replacing ds_arm9.ld from <a class="postlink" href="http://forum.gbadev.org/viewtopic.php?t=5418" target="_blank">this thread</a>, but still not working.<br/>_________________<br/><a class="postlink" href="http://headsoft.com.au/index.php?category=warhawk" target="_blank">Warhawk DS</a> | <a class="postlink" href="http://headsoft.com.au/index.php?category=mmll" target="_blank">Manic Miner: The Lost Levels</a> | <a class="postlink" href="http://headsoft.com.au/index.php?category=tdg" target="_blank">The Detective Game</a></span><span class="gensmall"><br/><br/>Last edited by headspin on Sat Jul 02, 2005 5:46 pm; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#46925 - notb4dinner - Sat Jul 02, 2005 4:51 am</h4>
    <div class="postbody"><span class="postbody">short = 2 bytes, so the correct form would be:
<br/>
MemWav = (short *) malloc(MAXSMP*sizeof(short)); 
<br/>
<br/>
However since the array method is crashing as well that's probably not the source of your problem.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#46933 - headspin - Sat Jul 02, 2005 6:10 am</h4>
    <div class="postbody"><span class="postbody">Thanks for the reply, of course cos malloc takes size as bytes.. but still CRASH!
<br/>
<br/>
Shouldn't malloc'ed stuff be placed in EXRAM? I think that's the problem perhaps. Any way to specify the allocation to be external RAM?<br/>_________________<br/><a class="postlink" href="http://headsoft.com.au/index.php?category=warhawk" target="_blank">Warhawk DS</a> | <a class="postlink" href="http://headsoft.com.au/index.php?category=mmll" target="_blank">Manic Miner: The Lost Levels</a> | <a class="postlink" href="http://headsoft.com.au/index.php?category=tdg" target="_blank">The Detective Game</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#46934 - LOst? - Sat Jul 02, 2005 6:28 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>headspin wrote:</b></span></td> </tr> <tr> <td class="quote">This is crashing my ROM using either of these methods.</td> </tr></table><span class="postbody">
<br/>
<br/>
Using your ROM with an specific emulator, or the real hardware?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#46935 - headspin - Sat Jul 02, 2005 6:31 am</h4>
    <div class="postbody"><span class="postbody">my ROM won't work in emulator, acutally I can't get anything working in any emulators at all (even ndslib examples), the emu's just crash for me :(
<br/>
<br/>
Anyways, I use both processors so emulator will not work anyways.
<br/>
<br/>
So this is a multiboot ROM which I test by sending wirelessly using wmb.<br/>_________________<br/><a class="postlink" href="http://headsoft.com.au/index.php?category=warhawk" target="_blank">Warhawk DS</a> | <a class="postlink" href="http://headsoft.com.au/index.php?category=mmll" target="_blank">Manic Miner: The Lost Levels</a> | <a class="postlink" href="http://headsoft.com.au/index.php?category=tdg" target="_blank">The Detective Game</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#46936 - LOst? - Sat Jul 02, 2005 6:39 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>headspin wrote:</b></span></td> </tr> <tr> <td class="quote">my ROM won't work in emulator, acutally I can't get anything working in any emulators at all (even ndslib examples), the emu's just crash for me :(</td> </tr></table><span class="postbody">
<br/>
<br/>
I wonder how long it will take before emulators will work. I get a lot of crashes and random results everytime I recompile my code.
<br/>
<br/>
Try run your ROM without multiboot support. Maybe you will have better luck with malloc. Myself has almost lost every hope of getting my DS 2D engine to work because things won't work as they are supposed to.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#46937 - headspin - Sat Jul 02, 2005 6:43 am</h4>
    <div class="postbody"><span class="postbody">My ROM works fine when I set the variable size and store it in EXRAM. But as you can imagine it adds about 500k to the ROM size.
<br/>
<br/>
If I use malloc() I can allocate at runtime and make my ROM size smaller.
<br/>
<br/>
I want my ROM to be multiboot so people can send it wirelessly.<br/>_________________<br/><a class="postlink" href="http://headsoft.com.au/index.php?category=warhawk" target="_blank">Warhawk DS</a> | <a class="postlink" href="http://headsoft.com.au/index.php?category=mmll" target="_blank">Manic Miner: The Lost Levels</a> | <a class="postlink" href="http://headsoft.com.au/index.php?category=tdg" target="_blank">The Detective Game</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#46942 - Mollusk - Sat Jul 02, 2005 8:48 am</h4>
    <div class="postbody"><span class="postbody">Headspin, first thing, even if it adds 500k to the rom, this shouldn't change the multiboot ability, right ? Multiboot means all will be put in RAM, so if you're rom is already around 4 megs, you won't be able to add the extra 500k to ram... so if the ROM size is ok with the variables in it, even with 500 extra k, it should work.
<br/>
<br/>
Second, can't you use the BSS ? (#define EWRAM_BSS	__attribute__((section(".sbss"))) in ndslib) It should, if I get it right, put the data in EWRAM but not in the rom, so you would get a smaller rom size... It just creates it at the startup...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#46962 - gladius - Sat Jul 02, 2005 6:05 pm</h4>
    <div class="postbody"><span class="postbody">Mollusk is 100% right.  VAR_IN_EXRAM is used for initialized variables that you want to place in EWRAM, for unitialized variables, use EWRAM_BSS, which will not increase the size of your rom.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#46983 - headspin - Sun Jul 03, 2005 1:34 am</h4>
    <div class="postbody"><span class="postbody">Thanks, it worked :)<br/>_________________<br/><a class="postlink" href="http://headsoft.com.au/index.php?category=warhawk" target="_blank">Warhawk DS</a> | <a class="postlink" href="http://headsoft.com.au/index.php?category=mmll" target="_blank">Manic Miner: The Lost Levels</a> | <a class="postlink" href="http://headsoft.com.au/index.php?category=tdg" target="_blank">The Detective Game</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#46986 - LOst? - Sun Jul 03, 2005 3:21 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>headspin wrote:</b></span></td> </tr> <tr> <td class="quote">Thanks, it worked :)</td> </tr></table><span class="postbody">
<br/>
Lucky you. I wish my stuff would work to.
<br/>
<br/>
<br/>
How big size is the EWRAM_BSS area?</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
