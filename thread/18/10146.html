<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Display capture: am I doing it wrong? - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>DS development > Display capture: am I doing it wrong?</h2>
<div id="posts">
<div class="post">
    <h4>#90343 - kvance - Thu Jun 29, 2006 8:10 pm</h4>
    <div class="postbody"><span class="postbody">I'm having trouble using the hardware display capture.  I'm trying to render 3D objects into VRAM to use as sprites.  My code works, but I have to run it in a loop 3 times and I don't understand why.  There are some printfs sprinkled in to watch the DCAP_ENABLE bit.  It appears to finish after two iterations, but if I stop there then nothing gets copied to VRAM_A.
<br/>
<br/>
I'd appreciate any ideas or suggestions.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">vramSetBankA(VRAM_A_LCD);
<br/>
<br/>
for(int i = 0; i &lt; 3; i++) {
<br/>
<br/>
        DISP_CAPTURE = DCAP_ENABLE |
<br/>
                DCAP_MODE(0) |          /* Capture source A */
<br/>
                DCAP_DST(0) |           /* VRAM write offset 0 */
<br/>
                DCAP_SRC(1) |           /* 3D screen */
<br/>
                DCAP_SIZE(3) |          /* 256x192 */
<br/>
                DCAP_OFFSET(0) |        /* VRAM read offset 0 */
<br/>
                DCAP_BANK(0) |          /* Write to VRAM A */
<br/>
                DCAP_A(16) |            /* Blend amount */
<br/>
                DCAP_B(0);              /* Ignore source B */
<br/>
<br/>
        printf("%d0: cap=%d\n", i, (DISP_CAPTURE &amp; DCAP_ENABLE) == DCAP_ENABLE);
<br/>
<br/>
        glReset();
<br/>
        glOrtho(0, 2.56f, 1.92f, 0, -1, 1);
<br/>
<br/>
   ... draw draw draw ...
<br/>
<br/>
        printf("%d1: cap=%d\n", i, (DISP_CAPTURE &amp; DCAP_ENABLE) == DCAP_ENABLE);
<br/>
<br/>
        glFlush();
<br/>
        printf("%d2: cap=%d\n", i, (DISP_CAPTURE &amp; DCAP_ENABLE) == DCAP_ENABLE);
<br/>
        swiWaitForVBlank();
<br/>
        printf("%d3: cap=%d\n", i, (DISP_CAPTURE &amp; DCAP_ENABLE) == DCAP_ENABLE);
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
The console output is:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">00: cap=1
<br/>
01: cap=1
<br/>
02: cap=1
<br/>
03: cap=1
<br/>
10: cap=1
<br/>
11: cap=1
<br/>
12: cap=1
<br/>
13: cap=0
<br/>
20: cap=1
<br/>
21: cap=1
<br/>
22: cap=1
<br/>
23: cap=0</td> </tr></table><span class="postbody"><br/>_________________<br/>Corner Office: <a class="postlink" href="http://lj.kvance.com/tag/corneroffice" target="_blank">dev LJ</a>
<br/>
<a class="postlink" href="http://kvance.com/project/HexxagonDS" target="_blank">HexxagonDS</a>, <a class="postlink" href="http://kvance.com/project/dsmzx/" target="_blank">dsmzx</a>, <a class="postlink" href="http://lj.kvance.com/tag/nintendo+ds" target="_blank">more...</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#90360 - DekuTree64 - Thu Jun 29, 2006 10:21 pm</h4>
    <div class="postbody"><span class="postbody">Try drawing all your 3D stuff first (including sending the page flip command), then set up the capture and wait for 2 VBlanks. One VBlank because the capture won't start running until the next frame starts drawing, and one to wait for that frame to draw.<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#91815 - kvance - Sun Jul 09, 2006 10:53 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>DekuTree64 wrote:</b></span></td> </tr> <tr> <td class="quote">Try drawing all your 3D stuff first (including sending the page flip command), then set up the capture and wait for 2 VBlanks. One VBlank because the capture won't start running until the next frame starts drawing, and one to wait for that frame to draw.</td> </tr></table><span class="postbody">
<br/>
<br/>
(Sorry for my long response time.  I haven't had much time for my DS project lately.)
<br/>
<br/>
I followed your advice, but still no joy.  I've boiled it down to the simplest possible function, just capturing a 32x32 white triangle.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void create_sprites()
<br/>
{
<br/>
        /* Render 3D onto VRAM A. */
<br/>
        videoSetMode(MODE_5_3D);
<br/>
        vramSetBankA(VRAM_A_LCD);
<br/>
<br/>
        glViewPort(0, 0, 255, 191);
<br/>
        glClearDepth(0x7FFF);
<br/>
        glReset();
<br/>
<br/>
        glOrtho(0, 2.56f, 1.92f, 0, -1, 1);
<br/>
        glMatrixMode(GL_MODELVIEW);
<br/>
        glLoadIdentity();
<br/>
        glPolyFmt(POLY_ALPHA(31) | POLY_CULL_NONE);
<br/>
        glColor3f(1.0f, 1.0f, 1.0f);
<br/>
        glBegin(GL_TRIANGLE);
<br/>
                glVertex3f( 0.0f,  0.0f, 0.0f);
<br/>
                glVertex3f( 0.0f, 0.32f, 0.0f);
<br/>
                glVertex3f(0.32f, 0.32f, 0.0f);
<br/>
        glEnd();
<br/>
        glFlush();
<br/>
<br/>
        DISP_CAPTURE = DCAP_ENABLE |
<br/>
                DCAP_MODE(0) |          /* Capture source A */
<br/>
                DCAP_DST(0) |           /* VRAM write offset 0 */
<br/>
                DCAP_SRC(1) |           /* 3D screen */
<br/>
                DCAP_SIZE(3) |          /* 256x192 */
<br/>
                DCAP_OFFSET(0) |        /* VRAM read offset 0 */
<br/>
                DCAP_BANK(0) |          /* Write to VRAM A */
<br/>
                DCAP_A(16) |            /* Blend amount */
<br/>
                DCAP_B(0);              /* Ignore source B */
<br/>
<br/>
        swiWaitForVBlank();
<br/>
        swiWaitForVBlank();
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
An interesting thing I noticed about my method from the first post is that it only works for a specific number of triangles.  60 tris was fine, but the same routine with 120 tris did nothing.  Seems like it was only some race condition that was allowing the capture to take place, and there's something about timing this that I still don't understand.<br/>_________________<br/>Corner Office: <a class="postlink" href="http://lj.kvance.com/tag/corneroffice" target="_blank">dev LJ</a>
<br/>
<a class="postlink" href="http://kvance.com/project/HexxagonDS" target="_blank">HexxagonDS</a>, <a class="postlink" href="http://kvance.com/project/dsmzx/" target="_blank">dsmzx</a>, <a class="postlink" href="http://lj.kvance.com/tag/nintendo+ds" target="_blank">more...</a></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
