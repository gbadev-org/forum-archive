<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Lighting problems - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>DS development > Lighting problems</h2>
<div id="posts">
<div class="post">
    <h4>#112329 - pettersson - Fri Dec 15, 2006 8:07 am</h4>
    <div class="postbody"><span class="postbody">hi guys,
<br/>
<br/>
working on a small 3d test application, i've encountered a problem. all my objects do not get lit properly. all i can see is ambient color, and i just can't find the error in my code. I've broken down the code to a single lightsource and a single triangle with one normal for every vertex. Here is the triangle code
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
u32 triangle[] = 
<br/>
{
<br/>
   12,
<br/>
   FIFO_COMMAND_PACK(FIFO_BEGIN, FIFO_NORMAL, FIFO_VERTEX16, FIFO_NORMAL),
<br/>
   GL_TRIANGLE,
<br/>
   NORMAL_PACK( 0, 0, floattov10(1.0) ),
<br/>
   VERTEX_PACK(inttov16(-1),inttov16(-1)), VERTEX_PACK(0,0),
<br/>
   NORMAL_PACK( 0, 0, floattov10(1.0) ),
<br/>
   FIFO_COMMAND_PACK(FIFO_VERTEX16, FIFO_NORMAL, FIFO_VERTEX16, FIFO_END),
<br/>
   VERTEX_PACK(inttov16(1),inttov16(-1)), VERTEX_PACK(0,0),
<br/>
   NORMAL_PACK( 0, 0, floattov10(1.0) ),
<br/>
   VERTEX_PACK(inttov16(0),inttov16(1)), VERTEX_PACK(0,0),
<br/>
};
<br/>
</td> </tr></table><span class="postbody">
<br/>
And here goes the rendering code
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
glReset();
<br/>
gluPerspective(35, 256.0 / 192.0, 0.1, 40);
<br/>
   
<br/>
glLight( 0, RGB15(31,31,31) , 0, 0, floattov10(-1.f) );
<br/>
         
<br/>
gluLookAt( 0.0, 0.0, 3.0,      //camera position 
<br/>
           0.0, 0.0, 0.0,      //look at
<br/>
           0.0, 1.0, 0.0 );   //up
<br/>
   
<br/>
            
<br/>
glMaterialf(GL_AMBIENT, RGB15(8,8,8));
<br/>
glMaterialf(GL_DIFFUSE, BIT(15)|RGB15(31,0,0) );
<br/>
glMaterialf(GL_SPECULAR, BIT(15) | RGB15(31,31,31));
<br/>
glMaterialf(GL_EMISSION, RGB15(0,0,0));
<br/>
glMaterialShinyness();
<br/>
   
<br/>
glMatrixMode( GL_MODELVIEW );
<br/>
glPushMatrix();
<br/>
  glPolyFmt( POLY_ALPHA(31) | POLY_CULL_BACK | POLY_FORMAT_LIGHT0 );
<br/>
  glCallList( triangle );
<br/>
glPopMatrix( 0 );
<br/>
glFlush();
<br/>
</td> </tr></table><span class="postbody">
<br/>
and all i get is just a triangle showing its ambient color. So obviously i must be doing something wrong, i just can't see what.
<br/>
Maybe one of you guys can help me
<br/>
<br/>
thanks in advance,
<br/>
pettersson</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#112408 - memoni - Sat Dec 16, 2006 12:29 am</h4>
    <div class="postbody"><span class="postbody">If I dont remember horribly wrong, the DS supports only directional lights, so the z component of the normal dot light direction is:
<br/>
<br/>
1 * -1 = -1, which clamps to 0 in light calculations.
<br/>
<br/>
Try to make the light direction (0,0,1)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#112425 - pettersson - Sat Dec 16, 2006 7:19 am</h4>
    <div class="postbody"><span class="postbody">Yes, the DS only supports parallel light sources. But 1*-1 = -1 is not the way you calculate lighting. (0,0,-1) is the light's directional vector. So it should be ok this way. (it doesn't help to change to 0,0,1). Still  only ambient color.
<br/>
Heck, what am i doing wrong here.
<br/>
<br/>
.pettersson</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#112427 - DiscoStew - Sat Dec 16, 2006 8:01 am</h4>
    <div class="postbody"><span class="postbody">I'm not sure, but doesn't the DS have problems when using the float value of 1 (or -1) with normals? Try 0.9999 (or -0.9999).<br/>_________________<br/><span style="font-weight: bold">DS</span> - It's all about <span style="font-weight: bold">D</span>isco<span style="font-weight: bold">S</span>tew</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#112430 - pettersson - Sat Dec 16, 2006 8:59 am</h4>
    <div class="postbody"><span class="postbody">Ooouu.. Thx a lot. That's it. Changing values from 1.0 to 0.999 fixes my problem :)
<br/>
<br/>
Danke
<br/>
.pettersson</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#112454 - silent_code - Sat Dec 16, 2006 4:19 pm</h4>
    <div class="postbody"><span class="postbody">sorry for this afterthrow. you can simply subtract 1 from the 10 bit fixed point number and it works (like "floattov10(1.0) - 1")... i remember there was some note that was supposed to remind people they can't use 1.0 for the number part, as the tenth bit is the sign... ;)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#112471 - ikaris - Sat Dec 16, 2006 5:56 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>pettersson wrote:</b></span></td> </tr> <tr> <td class="quote">Ooouu.. Thx a lot. That's it. Changing values from 1.0 to 0.999 fixes my problem :)</td> </tr></table><span class="postbody">
<br/>
<br/>
I had the same problem with my Maya exporter, and now I detect if the normal is 1 and swap it for 0.99999 instead...
<br/>
<br/>
fixes the problem.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
