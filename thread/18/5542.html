<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>from DS --> Gba mode Questions - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > from DS --> Gba mode Questions</h2>
<div id="posts">
<div class="post">
    <h4>#41232 - josath - Tue Apr 26, 2005 6:23 pm</h4>
    <div class="postbody"><span class="postbody">Ok, if you have a flash cart that does bank switching, and you know how, you can easily boot from ds into <b style="color:#FFA34F">gba</b> <b style="color:#FFA34F">mode</b>.
<br/>
for example, on the flash cart, put a small loader at the front that boots in DS <b style="color:#FFA34F">mode</b>, than switches the bank so 0x08000000 points at the beginning of the <b style="color:#FFA34F">GBA</b> rom, then call the trick to reset to <b style="color:#FFA34F">gba</b> <b style="color:#FFA34F">mode</b>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">                mov    r2, #0x40
<br/>
                ldr    r12, =0x11B8      @ call some routine in the bios
<br/>
                bx     r12</td> </tr></table><span class="postbody">
<br/>
And you will seen the <b style="color:#FFA34F">gba</b> boot logo, then the bin starts, because it's mapped to the right place.
<br/>
<br/>
The thing is, the other screen stays on. I'm thinking the ARM9 might continue to run while the arm7 runs in <b style="color:#FFA34F">gba</b> <b style="color:#FFA34F">mode</b>. 
<br/>
If this is true, it opens up possibilities. Imagine a gameshark that runs on the touchscreen, and you control with the stylus, that runs at the same time as the <b style="color:#FFA34F">gba</b> game runs on the top screen.
<br/>
I'm sure others can come up with ideas for this.
<br/>
<br/>
So the questions are:
<br/>
1. Does the ARM9 continue to run independantly when the ARM7 is switched to <b style="color:#FFA34F">gba</b> <b style="color:#FFA34F">mode</b>? Or does it shut down?
<br/>
2. What part of ram is used by the ARM7 in <b style="color:#FFA34F">gba</b> <b style="color:#FFA34F">mode</b>? I need to know, that way the ARM9 code in ram doesn't get overwritten by the <b style="color:#FFA34F">gba</b> bin running on the ARM7. I'd think it would either be the beginning or the end of ram. <b style="color:#FFA34F">GBA</b> has 256kbytes of ram right?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#41281 - darkfader - Wed Apr 27, 2005 2:34 am</h4>
    <div class="postbody"><span class="postbody">Heard that idea before. The display backlight is controlled by the power management chip. And there's little that you can do with that :P
<br/>
Just turn off one display and swap accordingly to the setting.
<br/>
0x27FFCE4, bit 3, <b style="color:#FFA34F">GBA</b> <b style="color:#FFA34F">mode</b> screen selection. 0=upper, 1=lower</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#41360 - josath - Wed Apr 27, 2005 10:17 pm</h4>
    <div class="postbody"><span class="postbody">after some testing, it looks like one of two things is happening when switching to <b style="color:#FFA34F">gba</b> <b style="color:#FFA34F">mode</b>:
<br/>
1. ARM9 being shut off
<br/>
2. All of main ram being cleared, so ARM9 has nothing to execute
<br/>
either way, both of the displays are cleared, EXCEPT for about 10 pixels on the left &amp; right of the <b style="color:#FFA34F">gba</b> screen, inside the black border.
<br/>
<br/>
<a href="http://rorexrobots.com/ds/test.png" target="_blank">http://rorexrobots.com/ds/test.png</a> some test patterns in ds <b style="color:#FFA34F">mode</b>, turns into this after switching to <b style="color:#FFA34F">gba</b> <b style="color:#FFA34F">mode</b>:
<br/>
<a href="http://www.pocket-dev.org/bug.PNG" target="_blank">http://www.pocket-dev.org/bug.PNG</a> ( a mockup, but accurate )
<br/>
<br/>
So fancy tricks like i was thinking about above, doesn't look to be possible.
<br/>
However, making a menu/loader that can load both .nds and .<b style="color:#FFA34F">gba</b> files, is a definite possibility, if you know the bankswitching code for your flashcart.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#41462 - dagamer34 - Thu Apr 28, 2005 7:41 pm</h4>
    <div class="postbody"><span class="postbody">So does this work properly?<br/>_________________<br/>Little kids and Playstation 2's don't mix. :(</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#41470 - josath - Thu Apr 28, 2005 9:59 pm</h4>
    <div class="postbody"><span class="postbody">It's possible to <b style="color:#FFA34F">switch</b> from DS <b style="color:#FFA34F">mode</b> into <b style="color:#FFA34F">GBA</b> <b style="color:#FFA34F">mode</b> and have it run a <b style="color:#FFA34F">gba</b> rom, but only if you know how to bankswitch on your flashcart.
<br/>
<br/>
I couldn't find any way of keeping the ARM9 running once you <b style="color:#FFA34F">switch</b> into <b style="color:#FFA34F">gba</b> <b style="color:#FFA34F">mode</b>.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#45438 - TheChuckster - Fri Jun 10, 2005 6:13 pm</h4>
    <div class="postbody"><span class="postbody">You think Darkain could have this in his loader?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#45443 - josath - Fri Jun 10, 2005 6:38 pm</h4>
    <div class="postbody"><span class="postbody">I already said it twice, want me to say it again:
<br/>
It's possible to <b style="color:#FFA34F">switch</b> from DS <b style="color:#FFA34F">mode</b> into <b style="color:#FFA34F">GBA</b> <b style="color:#FFA34F">mode</b> and have it run a <b style="color:#FFA34F">gba</b> rom, but only if you know how to bankswitch on your flashcart. 
<br/>
<br/>
Maybe you want me to clarify:
<br/>
Bankswitching code is known for some of the flashcarts, but not all. So you'd have to add support for flashcarts one at a time, and would never be able to support them all.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#45450 - dovoto - Fri Jun 10, 2005 7:30 pm</h4>
    <div class="postbody"><span class="postbody">perhaps a flash cart library should be started and maintained and a standard for accessing carts could be created.
<br/>
<br/>
FlashCartInit("xgFlash");
<br/>
<br/>
FlashCartSwitchBank(blah..);
<br/>
<br/>
Would not support all the cards but at least the info for the cards we do know could be localized.<br/>_________________<br/><a href="http://www.drunkencoders.com" target="_blank">www.drunkencoders.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#45451 - josath - Fri Jun 10, 2005 7:34 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>dovoto wrote:</b></span></td> </tr> <tr> <td class="quote">perhaps a flash cart library should be started and maintained and a standard for accessing carts could be created.
<br/>
<br/>
FlashCartInit("xgFlash");
<br/>
<br/>
FlashCartSwitchBank(blah..);
<br/>
<br/>
Would not support all the cards but at least the info for the cards we do know could be localized.</td> </tr></table><span class="postbody">
<br/>
<br/>
That's kinda how pogoshell for <b style="color:#FFA34F">gba</b> works actually. if you want pogoshell to support a new flash cart, you just have to write the functions for switching the banks and jumping to an address i think, and then drop it in.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#45489 - tepples - Sat Jun 11, 2005 5:22 am</h4>
    <div class="postbody"><span class="postbody">Problem is that a lot of the flash equipment manufacturers are more into wanton copyright infringement of commercial games than into homebrew, and they publicly choose not to release hardware specs to homebrewers, not even enough to bankswitch the card's ROM and SRAM. I'm looking at you, Borden of EZFA.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#45512 - cory1492 - Sat Jun 11, 2005 12:06 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tepples wrote:</b></span></td> </tr> <tr> <td class="quote">they publicly choose not to release hardware specs to homebrewers, not even enough to bankswitch the card's ROM and SRAM. I'm looking at you, Borden of EZFA.</td> </tr></table><span class="postbody">Too true, they don't want to release the info and have POGO work on all carts properly, now do they... I think they like the extra hits to their sites while users are waiting for new bootloaders...
<br/>
<br/>
from:
<br/>
<a href="http://forum.gbadev.org/viewtopic.php?t=6003" target="_blank">http://forum.gbadev.org/viewtopic.php?t=6003</a>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tepples wrote:</b></span></td> </tr> <tr> <td class="quote">And by that time, you're trying to do exactly what they're talking about in this topic. Please take discussion there.</td> </tr></table><span class="postbody">
<br/>
Actually I was attempting to do something similar to what is done with a <b style="color:#FFA34F">GBA</b> .mb file, wrather than ask a question about keeping the ARM9 going after the reset. Had I known that the RAM (apparently) gets cleared by calling</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">mov r2, #0x40
<br/>
ldr r12, =0x11B8 @ call some routine in the bios
<br/>
bx r12 </td> </tr></table><span class="postbody"> and that some extra code is actually required to shut off one of the screens beyond that snippet, I may have not even bothered to ask. So thanks for the aim at this info.
<br/>
<br/>
Does anyone know what that assembly is doing and can explain a little better than "call some routine in the bios", is it calling any old routine in the <b style="color:#FFA34F">gba</b> bios? do registers survive the soft reset to <b style="color:#FFA34F">GBA</b> <b style="color:#FFA34F">mode</b>? is that just the assembly for what is done when you press <b style="color:#FFA34F">GBA</b> on the DS user menu screen/app? is there some little piece of info that I missed somewhere else that would enlighten me so I can intuit these answers on my own?
<br/>
<br/>
I'd wrather do it the easy way with bankswitching, but I dont have the F2A Ultra's bankswitching beyond what is in POGO (up to 512MBit f2au IIRC, somewhere. I have a 1024MBit one so...) if I did have the bankswitching code and understood how to setup the bankswitching from already running DS code, and also had darkains source to his bootloader I just may attempt that, but thats alot of ifs, which lead me to start looking into other ways of doing the same thing. 
<br/>
<br/>
I have no way of making the bootloaders position static on the cart other than putting it at the beginning of the cart, or within a DS app/load stub of fixed length so the location would have to be patched when the cart is burned if it was to be that way... which as I also said in the other thread will destroy ingame resets that are meant to go back to the bootloader.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>josath wrote:</b></span></td> </tr> <tr> <td class="quote">Ideally, what you'd do is use your carts bank/offset switching registers to make the beginning of <b style="color:#FFA34F">gba</b> rom (0x080..) point to a <b style="color:#FFA34F">gba</b> rom. this probably WONT work with <b style="color:#FFA34F">gba</b> menus/bootloaders, as they most likely expect themselves to be at the beginning of the rom and might get confused if they are not.</td> </tr></table><span class="postbody"> actually, as I stated in the other thread, the F2A Ultra loader does not need to be or care if its the first rom on the cart, it uses a content descriptor in the "virtual" SRAM (IIRC) to describe the locations of data on the cart.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#45523 - NEiM0D - Sat Jun 11, 2005 3:46 pm</h4>
    <div class="postbody"><span class="postbody">The bios only does this:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#define REG_HALT *(vu8*)0x04000301 
<br/>
<br/>
void ToGBAMode(void)
<br/>
{
<br/>
   REG_HALT = 0x40;
<br/>
   (nop)
<br/>
   (nop)
<br/>
   return;
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
REG_HALT is a CPU controlling register.
<br/>
<br/>
You can't set REG_HALT yourself either, it must be set using the BIOS.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#45584 - cory1492 - Sun Jun 12, 2005 8:40 am</h4>
    <div class="postbody"><span class="postbody">it occurs to me <span style="font-style: italic">now</span> that the code in pogoshell for bankswitching should be sufficient, since the DStoGBAf2au+origional loader <span style="font-style: italic">could</span>be contained inside of the gbfs of darkains loader, all that would really be needed is a little bit of DS code that sets the bankswitching like pogo does, and takes the beginning of the loader appended to the chunk of code using cat or copy /b (which the loader will "know" its own size and set the bankswitch to the first place after the beginning of itself by using the offset of the location in gbfs+the DS code size), and all without a modded darkain loader... gonna give it a shot now.
<br/>
<br/>
Thanks for that bit of c code NEiM0D, nice to see a straigt forward explanation of it, now all I gotta do is figure out how to include that and Darkfaders bit to turn off the screen...</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
