<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>M3's RAM: LDMDB, STMDB memcopy loop fails - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > M3's RAM: LDMDB, STMDB memcopy loop fails</h2>
<div id="posts">
<div class="post">
    <h4>#110940 - Dwedit - Sun Dec 03, 2006 1:52 am</h4>
    <div class="postbody"><span class="postbody">The 32MB of RAM does not always behave how you'd expect it to.  For example, a fast, backwards memcopy loop using LDMDB and STMDB fails on the M3.<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#110970 - OOPMan - Sun Dec 03, 2006 8:31 am</h4>
    <div class="postbody"><span class="postbody">Hmmmmm, interesting...
<br/>
<br/>
Would this be an 8-bit write related issue?<br/>_________________<br/>"My boot, your face..." - Attributed to OOPMan, Emperor of Eroticon VI
<br/>
<br/>
You can find my NDS homebrew projects <a class="postlink" href="http://blog.dev-scene.com/oopman/" target="_blank">here...</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#110974 - Dwedit - Sun Dec 03, 2006 8:43 am</h4>
    <div class="postbody"><span class="postbody">I'm using the block read/write instructions, which write in 32 bits.<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#111030 - OOPMan - Sun Dec 03, 2006 7:44 pm</h4>
    <div class="postbody"><span class="postbody">Erm, I think the GBA port only supports 16-bit reads/writes max...
<br/>
<br/>
Anyone else know whether this is true?<br/>_________________<br/>"My boot, your face..." - Attributed to OOPMan, Emperor of Eroticon VI
<br/>
<br/>
You can find my NDS homebrew projects <a class="postlink" href="http://blog.dev-scene.com/oopman/" target="_blank">here...</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#111050 - tepples - Sun Dec 03, 2006 8:37 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>OOPMan wrote:</b></span></td> </tr> <tr> <td class="quote">Erm, I think the GBA port only supports 16-bit reads/writes max...
<br/>
<br/>
Anyone else know whether this is true?</td> </tr></table><span class="postbody">
<br/>
Every part of the GBA and Nintendo DS that supports 16-bit access supports 32-bit access, and vice versa. The problematic areas are GBA SRAM (no 16-bit or 32-bit reads or writes), video-related RAM (no 8-bit writes), and GBA ROM (no 8-bit writes).<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#111072 - Mighty Max - Sun Dec 03, 2006 10:52 pm</h4>
    <div class="postbody"><span class="postbody">When using stm/ldm, make sure that you are using them proper aligned.
<br/>
<br/>
Also check if the problems are solved if you change the wait states for accessing gba memory (WAIT_CR (0x04000204:16)) to the slowest. If that fixes it, try figuring out the best working timings.<br/>_________________<br/><a class="postlink" href="http://mightymax.org/gbamp_multiboot.html" target="_blank">GBAMP Multiboot</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#111074 - tepples - Sun Dec 03, 2006 11:11 pm</h4>
    <div class="postbody"><span class="postbody">It's fastest to access ROM in sequential order. Are you trying a ROM-to-ROM copy?<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#111130 - OOPMan - Mon Dec 04, 2006 8:39 am</h4>
    <div class="postbody"><span class="postbody">Thanks for correcting me on the above tepples :-)<br/>_________________<br/>"My boot, your face..." - Attributed to OOPMan, Emperor of Eroticon VI
<br/>
<br/>
You can find my NDS homebrew projects <a class="postlink" href="http://blog.dev-scene.com/oopman/" target="_blank">here...</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#113530 - simonjhall - Thu Dec 28, 2006 4:31 pm</h4>
    <div class="postbody"><span class="postbody">Sorry for digging up an old topic, but how did this work out in the end? Did you get the card working properly in the end?
<br/>
And the thing that I *really* would like to know, how fast can do you do a memcpy from M3 RAM&lt;--&gt;regular RAM? Tens of megabytes per second would be really nice.<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#113547 - Dwedit - Thu Dec 28, 2006 9:28 pm</h4>
    <div class="postbody"><span class="postbody">ldmia and stmia work fine on the M3, but the backwards versions (ldmdb, stmdb) do not work.  My tests were doing copies from M3 ram to M3 ram.
<br/>
<br/>
Going backwards one word at a time does work.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
fastcopyloop
<br/>
   ldmia r1!,{r4,r5,r6,r7,r8,r9,r10,r11}
<br/>
   stmia r0!,{r4,r5,r6,r7,r8,r9,r10,r11}
<br/>
   
<br/>
   subs r2,r2,#0x20
<br/>
   bpl fastcopyloop
<br/>
</td> </tr></table><span class="postbody">
<br/>
An equivalent version of this code using ldmdb and stmdb did not produce identical results on hardware as it did on a modified verison of VBA, but I did not bother to examine the memory, I just checked the adler32.<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#113554 - simonjhall - Thu Dec 28, 2006 10:00 pm</h4>
    <div class="postbody"><span class="postbody">Okey-doke, I only really want a memcpy in and memcpy out function, and if I've gotta do something particular then that's not too much of a problem.
<br/>
So, regarding the speed - any info? I'm thinking about Quake2 here so the higher the better :-D<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#113581 - tepples - Fri Dec 29, 2006 1:39 am</h4>
    <div class="postbody"><span class="postbody">I don't know the number of wait states the DS uses for its 4 MB RAM in DS mode, but on the GBA, a DMA copy from ROM to EWRAM should run at 6.6 10^6 B/s at 3/1 ROM wait state (M3) or 5.5 10^6 B/s at 4/2 ROM wait state (SuperCard). Using an LDM/STM loop with the ARM9's write caching might speed this up, or it might not.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#113600 - simonjhall - Fri Dec 29, 2006 2:51 am</h4>
    <div class="postbody"><span class="postbody">So the Supercard isn't that much slower than the M3? That's interesting... I assumed that it was much slower as GBA games need to be patched due to the speed of the memory... (or something)
<br/>
Either way, I think the speed is just fast enough to be do-able. Just :-)<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#113750 - HyperHacker - Sat Dec 30, 2006 9:01 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Dwedit wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
fastcopyloop
<br/>
   ldmia r1!,{r4,r5,r6,r7,r8,r9,r10,r11}
<br/>
   stmia r0!,{r4,r5,r6,r7,r8,r9,r10,r11}
<br/>
   
<br/>
   subs r2,r2,#0x20
<br/>
   bpl fastcopyloop
<br/>
</td> </tr></table><span class="postbody"></span></td> </tr></table><span class="postbody">
<br/>
You realize this code doesn't check alignment nor ensure the number of bytes is a multiple of 0x20? I believe LDMxx/STMxx require 32-bit alignment, and not checking for multiples means if you try to copy, say, 0x21 bytes, you end up copying 0x40 and causing memory corruption.<br/>_________________<br/>I'm a PSP hacker now, but I still &lt;3 DS.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
