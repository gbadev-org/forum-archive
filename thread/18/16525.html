<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>libmem (alpha memory handler) - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > libmem (alpha memory handler)</h2>
<div id="posts">
<div class="post">
    <h4>#167299 - hacker013 - Sun Mar 08, 2009 3:31 pm</h4>
    <div class="postbody"><span class="postbody">hey everybody,
<br/>
<br/>
I have written this library more for debug purpose the for real use. But I thought maybe you guys/girls can use it. It handles memory allocating. It shows you much your using. How much you can totaly use (defined by yourself). And how much memory is free totaly on the nds. If you find bugs pm me or post it here in this forum. If you have requests ask me :)
<br/>
<br/>
<a class="postlink" href="http://urazelda.webs.com/downloads.htm" target="_blank">Download Url + Documentation</a>.
<br/>
<br/>
gr,
<br/>
<br/>
newbie013<br/>_________________<br/><a class="postlink" href="http://imetal.nl/" target="_blank">Website / Blog</a>
<br/>
<br/>
Let the nds be with you.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167304 - kusma - Sun Mar 08, 2009 4:41 pm</h4>
    <div class="postbody"><span class="postbody">What's the purpose of this library, apart from making false assumptions on how much memory is used and slowing down memory allocations / deallocations? A call to malloc might use more memory than you requested, due to internal memory fragmentation. Also, why does it try to handle arrays differently?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167310 - hacker013 - Sun Mar 08, 2009 7:01 pm</h4>
    <div class="postbody"><span class="postbody">I handle arrays this way so when you free everything also the arrays can be freed. The purpose of this library was for debugging so you can track down some things in your memory handling.<br/>_________________<br/><a class="postlink" href="http://imetal.nl/" target="_blank">Website / Blog</a>
<br/>
<br/>
Let the nds be with you.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167311 - kusma - Sun Mar 08, 2009 7:31 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>hacker013 wrote:</b></span></td> </tr> <tr> <td class="quote">I handle arrays this way so when you free everything also the arrays can be freed.</td> </tr></table><span class="postbody">
<br/>
Uhm, what? Care to explain that a bit more?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167312 - hacker013 - Sun Mar 08, 2009 8:19 pm</h4>
    <div class="postbody"><span class="postbody">If I define array like this
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
void mem[MAX_MEM_POINTERS];
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Now this memory can't be freed anymore.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
void ** mem;
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
This memory can be freed :)
<br/>
Like this:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
int i=0;
<br/>
for(i=0;i&lt;MAX_MEM_POINTERS;i++)
<br/>
{
<br/>
      free(mem[0]);
<br/>
      mem[0]=NULL;
<br/>
}
<br/>
free(mem);
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I hope this explains it. :)<br/>_________________<br/><a class="postlink" href="http://imetal.nl/" target="_blank">Website / Blog</a>
<br/>
<br/>
Let the nds be with you.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167315 - Griffin - Sun Mar 08, 2009 9:06 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>hacker013 wrote:</b></span></td> </tr> <tr> <td class="quote">If I define array like this
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
int i=0;
<br/>
for(i=0;i&lt;MAX_MEM_POINTERS;i++)
<br/>
{
<br/>
      free(mem[0]);
<br/>
      mem[0]=NULL;
<br/>
}
<br/>
free(mem);
<br/>
</td> </tr></table><span class="postbody">
<br/>
</span></td> </tr></table><span class="postbody">
<br/>
I suppose the loop should read
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
        free(mem[i]);
<br/>
        mem[i] = NULL;
<br/>
</td> </tr></table><span class="postbody">
<br/>
Even so, wouldn't it be better to create some sort of array pseudo-class that frees its contents automatically?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167317 - albinofrenchy - Sun Mar 08, 2009 11:29 pm</h4>
    <div class="postbody"><span class="postbody">You are better off having functions that handle deallocating structs for you. 
<br/>
<br/>
Also, the built in memory management tool has mallinfo if you haven't checked that out.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167326 - hacker013 - Mon Mar 09, 2009 8:16 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Griffin wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>hacker013 wrote:</b></span></td> </tr> <tr> <td class="quote">If I define array like this
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
int i=0;
<br/>
for(i=0;i&lt;MAX_MEM_POINTERS;i++)
<br/>
{
<br/>
      free(mem[0]);
<br/>
      mem[0]=NULL;
<br/>
}
<br/>
free(mem);
<br/>
</td> </tr></table><span class="postbody">
<br/>
</span></td> </tr></table><span class="postbody">
<br/>
I suppose the loop should read
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
        free(mem[i]);
<br/>
        mem[i] = NULL;
<br/>
</td> </tr></table><span class="postbody">
<br/>
Even so, wouldn't it be better to create some sort of array pseudo-class that frees its contents automatically?</span></td> </tr></table><span class="postbody">
<br/>
<br/>
Yes, srry, It was typo.
<br/>
Classes in c??????????
<br/>
<br/>
@albinofrenchy
<br/>
Yes i've checked it out but it was a little confusing and I don't need it because it doesn't what I want<br/>_________________<br/><a class="postlink" href="http://imetal.nl/" target="_blank">Website / Blog</a>
<br/>
<br/>
Let the nds be with you.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167327 - kusma - Mon Mar 09, 2009 8:36 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>hacker013 wrote:</b></span></td> </tr> <tr> <td class="quote">I hope this explains it. :)</td> </tr></table><span class="postbody">
<br/>
It doesn't even begin to explain it, because your library (at least the version I downloaded) doesn't work with double pointers, as your explanation is using.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167329 - albinofrenchy - Mon Mar 09, 2009 9:24 am</h4>
    <div class="postbody"><span class="postbody">The memory management stuff is a bit confusing, but its good to know.
<br/>
<br/>
(BTW, if I fuck any of this up people please correct me.)
<br/>
<br/>
Basically the C memory manager sits on top of a low level memory allocator and requests heap space to fit the demand of the memory you request. The function that gives malloc this space is called sbrk ( I don't now why). 
<br/>
<br/>
So if you look at <a class="postlink" href="http://www.gnu.org/software/libtool/manual/libc/Statistics-of-Malloc.html" target="_blank">mallinfo</a> you can see how much memory the C memory manager is taking up in the 'arena' field. 
<br/>
<br/>
You can view total allocated bytes via 'uordblks'. This is literally the total of all malloc-ish calls minus whatever you've freed (or realloced back, etc etc). 
<br/>
<br/>
The principle problem with this I think is that you completely do not account for fragmentations in your code. Lets say we have 100 kb of free space. Now I allocate a 20 kb struct, and then a 30 kb struct. Then I free the 20 kb struct. In theory, we have 70 kb of memory left, but if you try to allocate more than 50, you will get a out of memory exception because of fragmentation: that 30 kb structure is fragmenting the memory so that the largest continuous part is only 50 kb. 
<br/>
<br/>
Kusma is also correct to point out that you are adding a level of complexity on top of memory management that can drastically slow down your app. The only time you want to handle memory management on your own is a) To find memory leaks, which you could probably retool this library to do and b) in cases when you can optimize memory management because of something you know about the data structure. I don't think I've ever seen a case where b was really justified though. 
<br/>
<br/>
Bluntly, If you tell us exactly what you wanted to track with this tool, we can tell you how to track it in mallinfo more accurately and without slowing down your app.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167348 - hacker013 - Mon Mar 09, 2009 5:01 pm</h4>
    <div class="postbody"><span class="postbody">I'm using Nitro Engine for my 3d game and it doesn't show some graphics. First I thought I was doing some thing wrong in the code. But that wasn't so I thought maybe because NE allocates all its arrays with the way this library does but without checking if it has enough memory, so with this library I thought to trackdown if the library was using to much memory.<br/>_________________<br/><a class="postlink" href="http://imetal.nl/" target="_blank">Website / Blog</a>
<br/>
<br/>
Let the nds be with you.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167350 - albinofrenchy - Mon Mar 09, 2009 6:02 pm</h4>
    <div class="postbody"><span class="postbody">With this library you'd have to go through and replace all malloc's with your code anyway, so you might as well just start putting error handling code in for malloc failures. 
<br/>
<br/>
Malloc returns 0 when it is out of memory. If I were you, I'd track down where most of the mallocs occur and make sure they are checking that the value they are getting back is not zero. 
<br/>
<br/>
In general though, if they were abusing memory that bad and not checking for out of memory exceptions the rom would either crash or lock up. 
<br/>
<br/>
You can check this another way though too. Call mallinfo() and print out the uordblks field every so often. You can be sure that if they have an active memory leak, that number will start to skyrocket until the thing crashes. 
<br/>
<br/>
Check your premise about your graphics. Graphics on the DS are a pain in the ass in that the most innocuous of programmer error can f up all video output.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167352 - elhobbs - Mon Mar 09, 2009 6:08 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>hacker013 wrote:</b></span></td> </tr> <tr> <td class="quote">I'm using Nitro Engine for my 3d game and it doesn't show some graphics. First I thought I was doing some thing wrong in the code. But that wasn't so I thought maybe because NE allocates all its arrays with the way this library does but without checking if it has enough memory, so with this library I thought to trackdown if the library was using to much memory.</td> </tr></table><span class="postbody">are you exceeding the polylimit?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167354 - Griffin - Mon Mar 09, 2009 6:16 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>albinofrenchy wrote:</b></span></td> </tr> <tr> <td class="quote">With this library you'd have to go through and replace all malloc's with your code anyway, so you might as well just start putting error handling code in for malloc failures.</td> </tr></table><span class="postbody">
<br/>
That could be fixed with <a class="postlink" href="http://www.gnu.org/software/libtool/manual/libc/Hooks-for-Malloc.html" target="_blank">malloc hooks</a> assuming that you can do those on the gba/ds. (I'm just guessing that we're using glibc)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167356 - kusma - Mon Mar 09, 2009 7:02 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Griffin wrote:</b></span></td> </tr> <tr> <td class="quote">That could be fixed with <a class="postlink" href="http://www.gnu.org/software/libtool/manual/libc/Hooks-for-Malloc.html" target="_blank">malloc hooks</a> assuming that you can do those on the gba/ds. (I'm just guessing that we're using glibc)</td> </tr></table><span class="postbody">
<br/>
Nope, we're using uclibc.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167357 - albinofrenchy - Mon Mar 09, 2009 7:53 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Nope, we're using uclibc.</td> </tr></table><span class="postbody">
<br/>
<br/>
I'm pretty sure we actually use newlib, unless I missed something. 
<br/>
<br/>
I looked into it, this is from deep within the newlib malloc source:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">    
<br/>
* No user-definable hooks for callbacks and the like.
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Depending on your affinity for black magic though, you could always do the  -finstrument-functions thing and scan for free's and malloc's pointers.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167358 - kusma - Mon Mar 09, 2009 8:19 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>albinofrenchy wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Nope, we're using uclibc.</td> </tr></table><span class="postbody">
<br/>
<br/>
I'm pretty sure we actually use newlib, unless I missed something. 
<br/>
</span></td> </tr></table><span class="postbody">
<br/>
Indeed, my bad :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167377 - hacker013 - Tue Mar 10, 2009 3:24 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>elhobbs wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>hacker013 wrote:</b></span></td> </tr> <tr> <td class="quote">I'm using Nitro Engine for my 3d game and it doesn't show some graphics. First I thought I was doing some thing wrong in the code. But that wasn't so I thought maybe because NE allocates all its arrays with the way this library does but without checking if it has enough memory, so with this library I thought to trackdown if the library was using to much memory.</td> </tr></table><span class="postbody">are you exceeding the polylimit?</span></td> </tr></table><span class="postbody">
<br/>
<br/>
I was using the 2d mode :)<br/>_________________<br/><a class="postlink" href="http://imetal.nl/" target="_blank">Website / Blog</a>
<br/>
<br/>
Let the nds be with you.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167379 - elhobbs - Tue Mar 10, 2009 3:47 pm</h4>
    <div class="postbody"><span class="postbody">2d mode? that is your problem right there ;) </span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">I'm using Nitro Engine for my 3d game </td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167382 - hacker013 - Tue Mar 10, 2009 5:17 pm</h4>
    <div class="postbody"><span class="postbody">No, NE has a option to draw in 2d &gt;.&gt;<br/>_________________<br/><a class="postlink" href="http://imetal.nl/" target="_blank">Website / Blog</a>
<br/>
<br/>
Let the nds be with you.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167384 - elhobbs - Tue Mar 10, 2009 5:51 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>hacker013 wrote:</b></span></td> </tr> <tr> <td class="quote">No, NE has a option to draw in 2d &gt;.&gt;</td> </tr></table><span class="postbody">I was being sarcastic. though, depending on the implementation, it is possible for a 2d mode to use the 3d hardware. in which case it would still be a valid issue. I have no idea how 3d is implemented in this library though.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167385 - DiscoStew - Tue Mar 10, 2009 5:55 pm</h4>
    <div class="postbody"><span class="postbody">Are you drawing via triangles/quads, or by sprites/backgrounds? If the former, then you are drawing with 3D, even if it is to look 2D.<br/>_________________<br/><span style="font-weight: bold">DS</span> - It's all about <span style="font-weight: bold">D</span>isco<span style="font-weight: bold">S</span>tew</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167386 - hacker013 - Tue Mar 10, 2009 6:20 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>DiscoStew wrote:</b></span></td> </tr> <tr> <td class="quote">Are you drawing via triangles/quads, or by sprites/backgrounds? If the former, then you are drawing with 3D, even if it is to look 2D.</td> </tr></table><span class="postbody">
<br/>
<br/>
Yes, it is 3d, it looks like 2d. And my debugging screen is saying that i'm using 0 polygons oO. I use a NE function to get how many there are used.<br/>_________________<br/><a class="postlink" href="http://imetal.nl/" target="_blank">Website / Blog</a>
<br/>
<br/>
Let the nds be with you.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167387 - DiscoStew - Tue Mar 10, 2009 6:50 pm</h4>
    <div class="postbody"><span class="postbody">At what point are you checking the polygon count in your code? If it is after the scene gets flushed, but before you draw anything for the next scene, then expect the result to be zero (unless I'm wrong, and it checks the RAM that holds the polygons/vertices that just got flushed).
<br/>
<br/>
Also, are you checking this in an emulator? I could be wrong, but last time I tried retrieving the polygon/vertex count of my program while using an emulator (No$GBA specifically), it returned zero because that feature was unsupported. It may be now, I'm not sure.<br/>_________________<br/><span style="font-weight: bold">DS</span> - It's all about <span style="font-weight: bold">D</span>isco<span style="font-weight: bold">S</span>tew</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167392 - hacker013 - Tue Mar 10, 2009 7:30 pm</h4>
    <div class="postbody"><span class="postbody">I'm just running it on hardware and I don't know if it before or after it get flushed because NE handles mine drawing to the screen. I have just to use:
<br/>
NE_ProcessDual(DrawUpperScreen,DrawDownScreen);
<br/>
<br/>
DrawUpperScreen and DrawDownScreen are functions.<br/>_________________<br/><a class="postlink" href="http://imetal.nl/" target="_blank">Website / Blog</a>
<br/>
<br/>
Let the nds be with you.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167395 - Kath - Tue Mar 10, 2009 7:59 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>hacker013 wrote:</b></span></td> </tr> <tr> <td class="quote">I'm just running it on hardware and I don't know if it before or after it get flushed because NE handles mine drawing to the screen. I have just to use:
<br/>
NE_ProcessDual(DrawUpperScreen,DrawDownScreen);
<br/>
<br/>
DrawUpperScreen and DrawDownScreen are functions.</td> </tr></table><span class="postbody">
<br/>
<br/>
NE_ProcessDual() calls the functions you pass then right afterwards calls a flush:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">if(NE_Screen == 1) { topscreen(); }
<br/>
else { downscreen(); }
<br/>
<br/>
GFX_FLUSH = (1&lt;&lt;0); //GL_TRANS_MANUALSORT</td> </tr></table><span class="postbody">
<br/>
<br/>
I would try reading the poly/vert count near the end of the function you pass in.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167448 - hacker013 - Thu Mar 12, 2009 2:19 pm</h4>
    <div class="postbody"><span class="postbody">That is what i'm doing but it is always showing 0. :(<br/>_________________<br/><a class="postlink" href="http://imetal.nl/" target="_blank">Website / Blog</a>
<br/>
<br/>
Let the nds be with you.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
