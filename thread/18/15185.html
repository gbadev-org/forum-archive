<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>text mode doesnt work, why? - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > text mode doesnt work, why?</h2>
<div id="posts">
<div class="post">
    <h4>#152421 - ben0bi - Sat Mar 15, 2008 6:11 pm</h4>
    <div class="postbody"><span class="postbody">i try to make normal text mode over a background. text mode alone works, background alone works too. but both together put out a mess on the screen.
<br/>
<br/>
can anyone tell me why that does not work and what to do to fix it?
<br/>
<br/>
here is my code:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
videoSetMode(MODE_5_2D | DISPLAY_BG3_ACTIVE);
<br/>
videoSetModeSub(MODE_5_2D | DISPLAY_BG2_ACTIVE DISPLAY_BG0_ACTIVE);
<br/>
vramSetBankA(VRAM_A_MAIN_BG_0x06000000);
<br/>
vramSetBankB(VRAM_B_LCD);
<br/>
vramSetBankC(VRAM_C_SUB_BG);
<br/>
vramSetBankD(VRAM_D_LCD);
<br/>
<br/>
// text mode init
<br/>
SUB_BG0_CR = BG_MAP_BASE(31);
<br/>
BG_PALETTE_SUB[255] = RGB15(31,31,31);
<br/>
consoleInitDefault((u16*)SCREEN_BASE_BLOCK_SUB(31), (u16*)CHAR_BASE_BLOCK_SUB(0), 16);
<br/>
<br/>
// graphics mode
<br/>
SUB_BG2_XDY = 0;
<br/>
SUB_BG2_XDX = 1 &lt;&lt; 8;
<br/>
SUB_BG2_YDX = 0;
<br/>
SUB_BG2_YDY = 1 &lt;&lt; 8;
<br/>
SUB_BG2_CX = 0;
<br/>
SUB_BG2_CY = 0;
<br/>
<br/>
u8* sub_buffer[2];
<br/>
sub_buffer[0]=(u8*)BG_BMP_RAM_SUB(0);
<br/>
sub_buffer[1]=(u8*)BG_BMP_RAM_SUB(3);
<br/>
bool actualBuffer=false;
<br/>
...
<br/>
while(1)
<br/>
{
<br/>
      if(bActualBuffer)
<br/>
      {
<br/>
         bActualBuffer=0;
<br/>
         gfxSetDrawBuffer(sub_buffer[bActualBuffer]);
<br/>
         SUB_BG2_CR = BG_BMP8_256x256 | BG_BMP_BASE(3);
<br/>
      }else{
<br/>
         bActualBuffer=1;
<br/>
         gfxSetDrawBuffer(sub_buffer[bActualBuffer]);
<br/>
      
<br/>
         SUB_BG2_CR = BG_BMP8_256x256 | BG_BMP_BASE(0);
<br/>
      }
<br/>
<br/>
<br/>
...
<br/>
print, draw, whatever
<br/>
...
<br/>
<br/>
swiWaitForVBlank
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
i did not include the clearscreen function and the main screen buffer things here..
<br/>
<br/>
why does this not work?
<br/>
on my machine, the pixels on bg2 are drawed. but the bg0 interfereres everywhere on screen, not only on the position where it should print.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#152429 - Cearn - Sat Mar 15, 2008 8:13 pm</h4>
    <div class="postbody"><span class="postbody">From video.h:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#define BG_MAP_RAM(base)      (((base)*0x800) + 0x06000000)
<br/>
#define BG_MAP_RAM_SUB(base)   (((base)*0x800) + 0x06200000)
<br/>
<br/>
#define BG_TILE_RAM(base)      (((base)*0x4000) + 0x06000000)
<br/>
#define BG_TILE_RAM_SUB(base)   (((base)*0x4000) + 0x06200000)
<br/>
<br/>
#define BG_BMP_RAM(base)      (((base)*0x4000) + 0x06000000)
<br/>
#define BG_BMP_RAM_SUB(base)   (((base)*0x4000) + 0x06200000)</td> </tr></table><span class="postbody">
<br/>
In other words, the memory that BG_x_RAM and BG_x_RAM_SUB point to overlap. Choose your tile/map/bmp blocks so that writing one set of data doesn't clobber another.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#152438 - ben0bi - Sun Mar 16, 2008 1:38 am</h4>
    <div class="postbody"><span class="postbody">i don't get it.
<br/>
how should i do that?
<br/>
<br/>
i map SUB_BG0 to MAP_BASE(31) and SUB_BG2 to BMP_BASE(0) to BMP_BASE(5) --- so there should be enough blank memory between...
<br/>
<br/>
could you please give some code where it works, i am stuck here since 2 weeks trying to set up this f***in screens...:(
<br/>
<br/>
thanks.
<br/>
<br/>
[edit]
<br/>
ok i checked it and i do not know what to do:
<br/>
it gives grafic artefacts when i use
<br/>
videoSetModeSub(ANY_MODE | BG0_ACTIVE | BG2_ACTIVE);
<br/>
so, if i use BG0 or BG1 with BG2 or BG3 it gives artefacts, no matter what.
<br/>
<br/>
i wrote this line and used the initialisation of bg2 but NOTHING with bg0.
<br/>
<br/>
same with bg1...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#152441 - Cearn - Sun Mar 16, 2008 2:32 am</h4>
    <div class="postbody"><span class="postbody">You're forgetting about SUB_BG0's tile/char-base. This line:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
SUB_BG0_CR = BG_MAP_BASE(31);
<br/>
</td> </tr></table><span class="postbody">implicitly sets the char-base to 0, which overlaps with bmp-base 0. Furthermore, screen-base 31 is actually inside bmp-base 3; since a 256x256@8 bitmap actually spans 4 bmp-bases, you may be overwriting that one as well.
<br/>
<br/>
This arrangement should work better (note: untested) :
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
// sub-bg0 : char-base 0, screen-base 7 
<br/>
//   (yes, screen-base 7 is the last 64 tiles of char-base 0, 
<br/>
//   but you're not using that many tiles so it's still safe)
<br/>
SUB_BG0_CR = BG_MAP_BASE(7) | BG_TILE_BASE(0);
<br/>
consoleInitDefault((u16*)SCREEN_BASE_BLOCK_SUB(7),
<br/>
    (u16*)CHAR_BASE_BLOCK_SUB(0), 16);
<br/>
<br/>
// sub-bg3 : bmp-base 4 and 8
<br/>
...
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Calculate how much memory you're actually using, translate that to the number of bmp/char/screen bases, and then assign the numbers accordingly.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#152581 - silent_code - Mon Mar 17, 2008 11:39 pm</h4>
    <div class="postbody"><span class="postbody">okay, a hint to (old but) working code: the infamous volume shadow demo on my site. ;^)
<br/>
<br/>
hope it helps!
<br/>
<br/>
ps: the others are right. a bit of tinkering with the memory banks and offsets will give you the result you need. just take a look at how i have done it.
<br/>
<br/>
pps: yes, i've used a custom font, but that shouldn't get you off course, really. you can still use the default font.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
