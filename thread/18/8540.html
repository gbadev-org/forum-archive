<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>mallinfo() returns wrong values - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > mallinfo() returns wrong values</h2>
<div id="posts">
<div class="post">
    <h4>#71384 - HyperHacker - Sun Feb 12, 2006 8:35 am</h4>
    <div class="postbody"><span class="postbody">I just came across mallinfo(), which is nice, but it seems to be a bit confused as to how much memory is actually free. While uordblks correctly specifies how much I've allocated, fordblks specifies a very small number (~1000, when I've allocated 96K) that actually goes up as more memory gets used (~5000 when allocating an additional 4K). O_o
<br/>
<br/>
I imagine this is related to another problem; malloc() is failing trying to allocate another 96K, even though there's nearly 4MB available and it used to work before. (Just kinda died all of a sudden...)
<br/>
<br/>
[edit] Odd... malloc() fails the first time trying to allocate 96K, but then succeeds doing the same a few milliseconds later.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#71901 - HyperHacker - Wed Feb 15, 2006 6:20 am</h4>
    <div class="postbody"><span class="postbody">Hmm, weird. I fixed a stupid allocation bug, and now mallinfo() at least reports a bigger number (~300,000). I guess it's number of blocks, not number of bytes; how big are these blocks? malloc() still fails (as does memalign(), which is like malloc() but aligns blocks to a specified boundary) but just calling it in a loop works around this and it eventually succeeds. O_o (Of course if it fails 10 times in a row the loop quits and I assume it really is out of memory.)
<br/>
<br/>
So it works, but I can't shake the feeling that something must be going wrong for it to need that...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#78811 - wintermute - Sun Apr 09, 2006 11:39 pm</h4>
    <div class="postbody"><span class="postbody">That behaviour sounds a bit odd. Could you send me some test code that I can reproduce the problem with.
<br/>
<br/>
In regard to mallinfo you'll find some further information here
<br/>
<br/>
<a href="http://www.gnu.org/software/libc/manual/html_node/Statistics-of-Malloc.html" target="_blank">http://www.gnu.org/software/libc/manual/html_node/Statistics-of-Malloc.html</a>
<br/>
<br/>
<span style="font-weight: bold">arena</span> contains the total size of memory allocated with sbrk by malloc, in bytes. This is the total amount of memory that the malloc functions have requested from the underlying heap allocator via sbrk. Malloc simply requests a block of memory which is then divided up by it's own internal routines.
<br/>
<br/>
<span style="font-weight: bold">ordblks</span> are chunks in mallocs internal tables which are currently free and can be allocated. This is unrelated to the actual amount of free RAM in the system unless all available memory has been allocated at some point.
<br/>
<br/>
<span style="font-weight: bold">keepcost</span> may possibly be useful in determining the memory yet to be allocated. If you can determine the base address of this chunk and add keepcost then you should obtain the base address of memory still not obtained from sbrk. In devkitARM there is a variable called fake_head_end which contains the end address of memory which will be allocated by sbrk. You can access this by using this declaration
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
extern char *fake_heap_end;
<br/>
</td> </tr></table><span class="postbody"><br/>_________________<br/><a class="postlink" href="http://www.devkitpro.org/" target="_blank">devkitPro - professional toolchains at amateur prices</a>
<br/>
<a class="postlink" href="http://wiki.devkitpro.org/index.php/IRC" target="_blank">devkitPro IRC support</a>
<br/>
<a class="postlink" href="http://davejmurphy.com/" target="_blank">Personal Blog</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#80761 - HyperHacker - Tue Apr 25, 2006 8:31 am</h4>
    <div class="postbody"><span class="postbody">Alright, just wanted to confirm that I saw your post. I'll do it next time I do DS dev, I'm just too busy at the moment. (Reinstalling Windows is fun! -_-)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#80769 - tepples - Tue Apr 25, 2006 12:49 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>wintermute wrote:</b></span></td> </tr> <tr> <td class="quote">In regard to mallinfo you'll find some further information here
<br/>
<br/>
<a href="http://www.gnu.org/software/libc/manual/html_node/Statistics-of-Malloc.html" target="_blank">http://www.gnu.org/software/libc/manual/html_node/Statistics-of-Malloc.html</a></td> </tr></table><span class="postbody">
<br/>
That manual covers GNU libc. Does devkitARM's newlib provide the same extensions?<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#80805 - wintermute - Tue Apr 25, 2006 6:50 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tepples wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>wintermute wrote:</b></span></td> </tr> <tr> <td class="quote">In regard to mallinfo you'll find some further information here
<br/>
<br/>
<a href="http://www.gnu.org/software/libc/manual/html_node/Statistics-of-Malloc.html" target="_blank">http://www.gnu.org/software/libc/manual/html_node/Statistics-of-Malloc.html</a></td> </tr></table><span class="postbody">
<br/>
That manual covers GNU libc. Does devkitARM's newlib provide the same extensions?</span></td> </tr></table><span class="postbody">
<br/>
<br/>
That page says nothing about extensions, it merely describes the mallinfo struct. The struct defined in malloc.h contains those elements but the newlib documentation doesn't have as much detail as that page.
<br/>
<br/>
<a href="http://sourceware.org/newlib/libc.html#SEC22" target="_blank">http://sourceware.org/newlib/libc.html#SEC22</a><br/>_________________<br/><a class="postlink" href="http://www.devkitpro.org/" target="_blank">devkitPro - professional toolchains at amateur prices</a>
<br/>
<a class="postlink" href="http://wiki.devkitpro.org/index.php/IRC" target="_blank">devkitPro IRC support</a>
<br/>
<a class="postlink" href="http://davejmurphy.com/" target="_blank">Personal Blog</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#80918 - tepples - Wed Apr 26, 2006 3:09 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>wintermute wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tepples wrote:</b></span></td> </tr> <tr> <td class="quote">devkitARM's newlib provide the same extensions?</td> </tr></table><span class="postbody">
<br/>
That page says nothing about extensions, it merely describes the mallinfo struct.</span></td> </tr></table><span class="postbody">
<br/>
mallinfo itself is an extension to the C standard library.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">The struct defined in malloc.h contains those elements</td> </tr></table><span class="postbody">
<br/>
Thanks. It's a pet peeve of mine when people talk about functions in one implementation of a C library and treat them as if they're in the ANSI standard.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#81574 - HyperHacker - Sun Apr 30, 2006 4:25 am</h4>
    <div class="postbody"><span class="postbody">Alright, well the program that was having this problem doesn't even really exist anymore, but I wrote a quick test app. malloc() doesn't fail, but fordblks jumps around a lot.
<br/>
<br/>
<a class="postlink" href="http://hypernova.amarok-shadow.com/MyStuff/memtest.zip" target="_blank">Test app here</a></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
