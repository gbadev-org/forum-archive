<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>A list of all the "WTF"s I'm having trouble with - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>DS development > A list of all the "WTF"s I'm having trouble with</h2>
<div id="posts">
<div class="post">
    <h4>#66901 - FireSlash - Sat Jan 14, 2006 6:27 am</h4>
    <div class="postbody"><span class="postbody">Here we go.
<br/>
<br/>
#1. Fading a GL texture in and out.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">bool dsIntro::update()
<br/>
{
<br/>
    nextScene ns;
<br/>
    if((alpha &lt; 62) &amp;&amp; (state == state_LOADED) )
<br/>
        alpha++;
<br/>
    if((alpha &gt; 0) &amp;&amp; (state == state_UNLOADING) )
<br/>
        alpha--;
<br/>
    if(alpha &gt;= 62)
<br/>
        state = state_UNLOADING;
<br/>
    if( (alpha &lt;= 0) &amp;&amp; (state = state_UNLOADING) )
<br/>
    {
<br/>
         ns = scene_menu;
<br/>
        sceneController.changeScene(ns);  
<br/>
    }    
<br/>
    
<br/>
    return true;
<br/>
}
<br/>
<br/>
bool dsIntro::draw_bottom(uint32 frame)   
<br/>
{
<br/>
    byte a;
<br/>
    if(alpha == 0)
<br/>
        a=0;
<br/>
    else
<br/>
        a=alpha/2;
<br/>
    update();
<br/>
<br/>
    glPolyFmt(POLY_ALPHA(a) | POLY_CULL_BACK  | POLY_FORMAT_LIGHT0);
<br/>
<br/>
   glLoadIdentity();
<br/>
    glTranslatef(0,0,0);
<br/>
    
<br/>
    
<br/>
   glBindTexture(GL_TEXTURE_2D, textures[1]);
<br/>
   
<br/>
   glBegin(GL_QUADS);
<br/>
      glTexCoord2f(1.5f, 0.0f); 
<br/>
        glVertex3f(  0.0f,  0.0f, 0);
<br/>
      glTexCoord2f(1.5f, 2.0f);
<br/>
        glVertex3f(  1.0f,  0.0f, 0);
<br/>
      glTexCoord2f(0.0f, 2.0f);
<br/>
        glVertex3f(  1.0f,  1.0f, 0 );
<br/>
      glTexCoord2f(0.0f, 0.0f);
<br/>
        glVertex3f(  0.0f,  1.0f, 0);
<br/>
   glEnd();
<br/>
   
<br/>
   return TRUE;
<br/>
}</td> </tr></table><span class="postbody">
<br/>
The scene properly waits for a few seconds before unloading, but the alpha NEVER changes from full. Even if I manually set it to, say, 5, it never changes. I made sure that glEnable(GL_BLEND); was set up in the init routine.
<br/>
<br/>
#2. Pallete entry 0 not transparent.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">    pFile = FAT_fopen ("/data/lumiDS/base/sweep.pcx","r");
<br/>
    if (!pFile) return false;
<br/>
    FAT_fseek (pFile , 0 , SEEK_END);
<br/>
    lSize = FAT_ftell (pFile);
<br/>
    FAT_fseek(pFile, 0, SEEK_SET);
<br/>
    
<br/>
    buffer = (char*) malloc (lSize);
<br/>
    if (!buffer) return false;
<br/>
    
<br/>
    FAT_fread (buffer,1,lSize,pFile);
<br/>
<br/>
   loadPCX((u8*)buffer, &amp;pcx);
<br/>
   
<br/>
   image8to16(&amp;pcx);
<br/>
<br/>
   glGenTextures(1, &amp;textures[2]);
<br/>
   glBindTexture(0, textures[2]);
<br/>
   glTexImage2D(0, 0, GL_RGB, TEXTURE_SIZE_32 , TEXTURE_SIZE_32, 0, GL_TEXTURE_COLOR0_TRANSPARENT | TEXGEN_TEXCOORD, pcx.data8);
<br/>
<br/>
   imageDestroy(&amp;pcx);
<br/>
    FAT_fclose (pFile);
<br/>
    free (buffer);</td> </tr></table><span class="postbody">
<br/>
I've verified (twice) that pallete entry 0 is indeed the background in these images, but they still show black.
<br/>
<br/>
#3 Using...
<br/>
            glOrtho(0,1,0,1,-6,6);
<br/>
The Depth is based on the Y value, NOT the Z axis. Perhaps I missed something somewhere, but thats how its working for me. I can provide example binaries if needed :p
<br/>
<br/>
#4 If anyone has found a way to set up reg_capture without burning two VRAM banks, I'd love to see source for it. Another option would be a way to use banks past D for textures, or for a way to use banks E and F for reg_capture. (For source, see ecurtz's sample: <a href="ftp://ftp.nuprometheus.com/pub/Display_Capture.zip" target="_blank">ftp://ftp.nuprometheus.com/pub/Display_Capture.zip</a> )
<br/>
Important bits:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">// ....
<br/>
      if (frameCount &amp; 0x1)
<br/>
      {
<br/>
         vramSetBankC(VRAM_C_SUB_BG);
<br/>
         vramSetBankD(VRAM_D_LCD);
<br/>
         SetRegCapture(true, 0, 15, 3, 0, 3, 0, 0);
<br/>
         scene-&gt;draw_top(frameCount);
<br/>
      } else {
<br/>
            vramSetBankC(VRAM_C_LCD);
<br/>
         vramSetBankD(VRAM_D_SUB_SPRITE);
<br/>
         SetRegCapture(true, 0, 15, 2, 0, 3, 0, 0);
<br/>
         scene-&gt;draw_bottom(frameCount);
<br/>
      }
<br/>
// .....
<br/>
<br/>
void SetRegCapture(bool enable, uint8 srcBlend, uint8 destBlend, uint8 bank, uint8 offset, uint8 size, uint8 source, uint8 srcOffset)
<br/>
{
<br/>
   uint32 value = 0;
<br/>
   if (enable)
<br/>
      value |= 1 &lt;&lt; 31; // 31 is enable
<br/>
   value |= 3 &lt;&lt; 29; // 29-30 seems to have something to do with the blending
<br/>
   value |= (srcOffset &amp; 0x3) &lt;&lt; 26; // capture source offset is 26-27
<br/>
   value |= (source &amp; 0x3) &lt;&lt; 24; // capture source is 24-25
<br/>
   value |= (size &amp; 0x3) &lt;&lt; 20; // capture data write size is 20-21
<br/>
   value |= (offset &amp; 0x3) &lt;&lt; 18; // write offset is 18-19 
<br/>
   value |= (bank &amp; 0x3) &lt;&lt; 16; // vram bank select is 16-17 
<br/>
   value |= (srcBlend &amp; 0xF) &lt;&lt; 8; // graphics blend evb is 8..12
<br/>
   value |= (destBlend &amp; 0xF) &lt;&lt; 0; // ram blend EVA is bits 0..4 
<br/>
   
<br/>
   REG_CAPTURE = value;
<br/>
}</td> </tr></table><span class="postbody">
<br/>
#5 bitmap fonts in 3d without being able to generate display lists is blowing my mind. I can't seem to find a <span style="font-weight: bold">good</span> way to do it. If anyone can at least point me in the right direction, that'd be awesome.
<br/>
<br/>
#6 CF cards are slow. If I load data from them, the DS goes kind of fruity while its being loaded, I assume due to vblank being called with incomplete data drawn. Is there a way to have the DS skip a vblank, or simply use the previous data? It may be simple since REG_CAPTURE is already using two VRAM banks to store the screen data, but I'm having trouble with it.
<br/>
<br/>
Thanks for the noob-help :)<br/>_________________<br/><a class="postlink" href="http://www.fireslash.net" target="_blank">FireSlash.net</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#67134 - duencil - Sun Jan 15, 2006 8:22 pm</h4>
    <div class="postbody"><span class="postbody">As for the first issue, are you calling the function glReset() every frame? Right now that resets GL_BLEND to off (its probably a bug), so you might want to call glEnable() every frame instead of only during initialisation. Better yet call GFX_CONTROL directly as the glEnable/glDisable functions are screwy right now ( <a href="http://forum.gbadev.org/viewtopic.php?t=8109" target="_blank">http://forum.gbadev.org/viewtopic.php?t=8109</a> )  
<br/>
<br/>
Enabling GL_BLEND and/or GL_ALPHA_TEST might be all that is necessary for your palette transparency issue too.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#67301 - duencil - Mon Jan 16, 2006 9:33 pm</h4>
    <div class="postbody"><span class="postbody">#3. Whathappens if you use... 
<br/>
glOrtho(0,1,0,1,0,12);
<br/>
instead?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#67374 - FireSlash - Tue Jan 17, 2006 5:24 pm</h4>
    <div class="postbody"><span class="postbody">I made the changes to my code for alpha blending, didn't seem to help. I'll make another attempt later today without glEnable();
<br/>
<br/>
I'll also give the glOrtho adjustments a shot.<br/>_________________<br/><a class="postlink" href="http://www.fireslash.net" target="_blank">FireSlash.net</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#69410 - FireSlash - Mon Jan 30, 2006 5:24 pm</h4>
    <div class="postbody"><span class="postbody">Duencil, changing the Z coords like that give me two fully black screens. At first I thought maybe my Z values were just out of bounds, or behind the camera, but I double checked both cases. o.O
<br/>
<br/>
EDIT:
<br/>
Fixed the black screen problem, silly mistake. Still get the same results though with the polygon ordering :/<br/>_________________<br/><a class="postlink" href="http://www.fireslash.net" target="_blank">FireSlash.net</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#69453 - Extreme Coder - Mon Jan 30, 2006 9:13 pm</h4>
    <div class="postbody"><span class="postbody">Try using 0xFFFF (pink) color and set poly_alpha(31), and that would make those parts transparent. Atleast it worked for me...
<br/>
<br/>
If you ever get an update on the ortho problem, tell me;)</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
