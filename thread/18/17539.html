<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Saving bmp screenshot using fat from hardware - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > Saving bmp screenshot using fat from hardware</h2>
<div id="posts">
<div class="post">
    <h4>#176308 - SchmendrickSchmuck - Mon Jun 20, 2011 8:09 pm</h4>
    <div class="postbody"><span class="postbody">I'm trying to save a screenshot to fat on hardware. The output however is completely garbled. Any example code I've found is mostly identical. 
<br/>
<br/>
This is the result: <a href="http://temp.dennisvanzwieten.com/DSLieroScreenshot0005.bmp" target="_blank">http://temp.dennisvanzwieten.com/DSLieroScreenshot0005.bmp</a>
<br/>
There is also 0006 and 0007. It doesn't appear to be complete garbage, as it seems to be the visible portion of the 8bit bg, heavily mangled. Text and (3D) sprites can't be seen.
<br/>
<br/>
I don't really know how to adjust the code below in order to make it work, since I'm not sure how it accesses the display data in the first place. I assume that using VRAM_A - VRAM_D as LCD / unmapped, you have direct access to the screen's framebuffer, but if that's the case, the result wouldn't be the way it is.
<br/>
<br/>
Here is my code:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
void write16(u16* address, u16 value) 
<br/>
{
<br/>
   u8* first=(u8*)address;
<br/>
   u8* second=first+1;
<br/>
<br/>
   *first=value&amp;0xff;
<br/>
   *second=value&gt;&gt;8;
<br/>
}
<br/>
<br/>
void write32(u32* address, u32 value) 
<br/>
{
<br/>
<br/>
   u8* first=(u8*)address;
<br/>
   u8* second=first+1;
<br/>
   u8* third=first+2;
<br/>
   u8* fourth=first+3;
<br/>
<br/>
   *first=value&amp;0xff;
<br/>
   *second=(value&gt;&gt;8)&amp;0xff;
<br/>
   *third=(value&gt;&gt;16)&amp;0xff;
<br/>
   *fourth=(value&gt;&gt;24)&amp;0xff;
<br/>
}
<br/>
<br/>
void CreateScreenshot(const char* filename) 
<br/>
{
<br/>
   FILE* file=fopen(filename, "wb");
<br/>
<br/>
   REG_DISPCAPCNT=DCAP_BANK(3)|DCAP_ENABLE|DCAP_SIZE(3);
<br/>
   while(REG_DISPCAPCNT &amp; DCAP_ENABLE);
<br/>
<br/>
   int ysize = 384;
<br/>
   int headerSize = sizeof(INFOHEADER) + sizeof(HEADER);
<br/>
   u8* temp = (u8*)malloc(256 * ysize * 3 + headerSize);
<br/>
<br/>
   HEADER* header=(HEADER*)temp;
<br/>
   INFOHEADER* infoheader=(INFOHEADER*)(temp + sizeof(HEADER));
<br/>
<br/>
   write16(&amp;header-&gt;type, 0x4D42);
<br/>
   write32(&amp;header-&gt;size, 256 * ysize * 3 + headerSize);
<br/>
   write32(&amp;header-&gt;offset, headerSize);
<br/>
   write16(&amp;header-&gt;reserved1, 0);
<br/>
   write16(&amp;header-&gt;reserved2, 0);
<br/>
<br/>
   write16(&amp;infoheader-&gt;bits, 24);
<br/>
   write32(&amp;infoheader-&gt;size, sizeof(INFOHEADER));
<br/>
   write32(&amp;infoheader-&gt;compression, 0);
<br/>
   write32(&amp;infoheader-&gt;width, 256);
<br/>
   write32(&amp;infoheader-&gt;height, ysize);
<br/>
   write16(&amp;infoheader-&gt;planes, 1);
<br/>
   write32(&amp;infoheader-&gt;imagesize, 256 * ysize * 3);
<br/>
   write32(&amp;infoheader-&gt;xresolution, 0);
<br/>
   write32(&amp;infoheader-&gt;yresolution, 0);
<br/>
   write32(&amp;infoheader-&gt;importantcolours, 0);
<br/>
   write32(&amp;infoheader-&gt;ncolours, 0);
<br/>
<br/>
   u32 vram_temp = vramSetPrimaryBanks(VRAM_A_LCD, VRAM_B_LCD, VRAM_C_LCD, VRAM_D_LCD);
<br/>
<br/>
   for(int y = 0; y &lt; ysize; y++)
<br/>
   {
<br/>
      for(int x = 0; x &lt; 256;x++)
<br/>
      {
<br/>
         u16 color = 0;
<br/>
         if(y &gt; 192)
<br/>
            color =  VRAM_C[256 * 192 - (y - 191) * 256 + x];
<br/>
         else color = VRAM_D[256 * 192 - (y + 1) * 256 + x];
<br/>
<br/>
         u8 b =(color &amp; 31) &lt;&lt; 3;
<br/>
         u8 g =((color &gt;&gt; 5) &amp; 31) &lt;&lt; 3;
<br/>
         u8 r =((color &gt;&gt; 10) &amp; 31) &lt;&lt; 3;
<br/>
<br/>
         temp[((y * 256) + x) * 3 + 0 + headerSize] = r;
<br/>
         temp[((y * 256) + x) * 3 + 1 + headerSize] = g;
<br/>
         temp[((y * 256) + x) * 3 + 2 + headerSize] = b;
<br/>
      }
<br/>
   }
<br/>
<br/>
   vramRestorePrimaryBanks(vram_temp);
<br/>
<br/>
   DC_FlushAll();
<br/>
   fwrite(temp, 1, 256 * ysize * 3 + headerSize, file);
<br/>
   fclose(file);
<br/>
   free(temp);
<br/>
}
<br/>
</td> </tr></table><span class="postbody">[/code]<br/>_________________<br/><a href="http://DSLiero.DennisvanZwieten.com" target="_blank">http://DSLiero.DennisvanZwieten.com</a> - Liero for NDS!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#176310 - DiscoStew - Tue Jun 21, 2011 2:02 am</h4>
    <div class="postbody"><span class="postbody">A few things...
<br/>
<br/>
I see you are wanting to capture both screens. Sorry to be the bearer of bad news, but that isn't possible. This <a class="postlink" href="http://nocash.emubase.de/gbatek.htm#dsvideodisplaysystemblockdiagram" target="_blank">chart</a> will show you what can be done with the capture unit, but for what you are doing, only the main screen can be captured. With this, your 15bit to 24bit conversion can only read the first 192 lines, so that is what 'ysize' will need to be.
<br/>
<br/>
When capturing, the bank that is to be used to hold the capture needs to be allocated to LCDC first.
<br/>
<br/>
<br/>
<br/>
See if that helps.<br/>_________________<br/><span style="font-weight: bold">DS</span> - It's all about <span style="font-weight: bold">D</span>isco<span style="font-weight: bold">S</span>tew</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#176314 - SchmendrickSchmuck - Tue Jun 21, 2011 3:23 pm</h4>
    <div class="postbody"><span class="postbody">Thanks DiscoStew, I've successfully made a screenshot of the main screen. I got some artifacts on the sub screen (I use VRAM_C for sub bg, which gets messed up), but those should be easily worked out.
<br/>
<br/>
So the sub screen can't be captured at all? Since it seems to be completely unrelated to all the main screen operations in that diagram.. I had hoped it was at least possible in some way.
<br/>
<br/>
Where can I find more libnds documentation for these display capture functions and defines? The <a class="postlink" href="http://libnds.devkitpro.org" target="_blank">http://libnds.devkitpro.org</a> default docs site doesn't have any info on them, and google didn't help much either.
<br/>
<br/>
Thanks again!<br/>_________________<br/><a href="http://DSLiero.DennisvanZwieten.com" target="_blank">http://DSLiero.DennisvanZwieten.com</a> - Liero for NDS!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#176315 - elhobbs - Tue Jun 21, 2011 4:23 pm</h4>
    <div class="postbody"><span class="postbody">the display capture hardware only works on the main screen. you could do something like the dual 3d sample. render the subcreen to the main screen and capture it with the hardware then display it as the subscreen.
<br/>
<br/>
gbatek is the best the source that I know of for ds/gba hardware specs.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
