<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Texture Compression Algorithm, see results. - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > Texture Compression Algorithm, see results.</h2>
<div id="posts">
<div class="post">
    <h4>#88322 - yackom - Sun Jun 18, 2006 7:44 pm</h4>
    <div class="postbody"><span class="postbody">Someone brought up texture compression for the DS when I talked about the problems in my DSQuake project. 
<br/>
<br/>
I found out that the texture compression format is for in an image each 4x4 blocks of pixels, which you can choose up to 4 colors for. So at 4 colors for a 4x4 block it works out to be 4bits per pixel, or 1/2 that of 256 color palette, or 1/4 that of 16bit color.
<br/>
<br/>
Simple enough concept, so what 4 colors do you pick? So that is an ?Image Quantization? problem which is basically the same problem that gif compressors solve by picking 256 colors max from a whole image to represent it. The thing is we only have to compress 16 pixels at a time which is a lot less than an entire image for like a gif. So the algorithms that are popular for the full image case aren?t as high quality as we can get with our little 4x4 images because we can process them in a much more exact way via brute force. The algorithm I made isn?t as sophisticated like other methods that work on full images, but mine is much truer to the real problem and produces what I would assume for the 4 color or less case much better results. I figure why not use the best possible method if we can within a reasonable amount of time, these textures only have to be compressed once, and shouldn?t have to be compressed in real-time. If a real-time solution is needed the median cut algorithm, would probably be the best solution for the speed and quality [1]. 
<br/>
<br/>
I must admit it is really quite brutal on my desktop cpu, for a 128x256 size image its about 1 min to calculate, and for a 512x512 or so image is about 5 mins to calculate. I haven?t bothered to do any algorithmic optimizations yet, such as branch and bound, sorting the colors by distances to each other, or parallelize it for multicore processors. Once the optimizations are implemented should be able to do a 512x512 in 1 min or so.
<br/>
<br/>
So here is the pseudocode for compressing a block
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
*Put all of the input colors into one group, in an array of groups.
<br/>
<br/>
For 1 to 3 // each iteration adds one color to the palette
<br/>
{
<br/>
*Select the group with largest Euclidean distance between all pixels and those pixels mean average.
<br/>
<br/>
*Subdivide the selected group into two groups by generating all possible   combinations of two sets the same Euclidean distance between all pixels and their groups mean average pixel, and save the group set which has the minimal total distance.
<br/>
<br/>
}
<br/>
<br/>
*For each input color output it?s group?s mean average for its color.
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
<br/>
Results,
<br/>
<br/>
In all of the images the original is on the left, the compressed one is on the right. 2c means 2 colors, 3c- 3 colors, 4c - 4 colors. The Shambler and rose image are small enough to put all 3 comparisons in the same file. Note the mandrill image is from a 256 color gif source, so for 256 color images a person can?t really tell.
<br/>
<a class="postlink" href="http://yackom.com/texturecompress/" target="_blank">http://yackom.com/texturecompress/</a>
<br/>
<br/>
If people would like I could post my source code in a day or so after I clean it up a bit,
<br/>
<br/>
-yackom
<br/>
<br/>
Links:
<br/>
[1]  <a class="postlink" href="http://www.gamasutra.com/features/visual_arts/061997/a_few_good_colors.htm" target="_blank">http://www.gamasutra.com/features/visual_arts/061997/a_few_good_colors.htm</a>
<br/>
this is a good and easy to read explanation for Paul Heckbert?s ?median cut algorithm?
<br/>
<br/>
<a class="postlink" href="http://www.efg2.com/Lab/Library/Color/AndComputers.htm#Quantization" target="_blank">http://www.efg2.com/Lab/Library/Color/AndComputers.htm#Quantization</a>
<br/>
Another good source for other newer color quantization algorithms.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#88324 - Payk - Sun Jun 18, 2006 7:56 pm</h4>
    <div class="postbody"><span class="postbody">Hmhmh would be fun to code that i think...
<br/>
Nice from u to post that. I will test that when it arrives.
<br/>
Hopefully dualis will support that but assume it doesnt since it doesnt support 8bit textures as well...hmhmh</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#88350 - M3d10n - Sun Jun 18, 2006 11:24 pm</h4>
    <div class="postbody"><span class="postbody">The artifacts do look like the S3TC compression artifacts (you can see them once in a while in Resident Evil 4 on the GC). 
<br/>
<br/>
But it amazes me that they aren't really obvious at 1:1 zoom. This means a 2D game could take advantage of compressed textures as well. I'm not sure if it's possible to use them in the 2D modes, but an engine using 3D for 2D could do it.
<br/>
<br/>
Now that I think about it... I think Castlevania uses them already. There is a bit of color banding here in a few tiles, but it doesn't feel like 256-color banding. It does use the 3D hardware for the tiles, so it should be a no-brainer.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#88351 - Extreme Coder - Sun Jun 18, 2006 11:29 pm</h4>
    <div class="postbody"><span class="postbody">M3d10n: coughGL2Dcough :D
<br/>
<br/>
Anyway, that's a great find you've got there, but what are the differences between this and S3TC? And I'm interested in the code of compression and decompression, if possible:)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#88358 - silent_code - Mon Jun 19, 2006 12:21 am</h4>
    <div class="postbody"><span class="postbody">really nice work!
<br/>
<br/>
i'm getting even more excited seeing this!
<br/>
<br/>
would be a nice coding exercise, though having some code to compare to isn't that bad :)
<br/>
<br/>
i imagine that with a bit of optimisation this could become a standard nds compression tool. ;)
<br/>
<br/>
the results are so good, you don't even need dithering and stuff! that's a really good thing that the nds is capable of doing it. i know there's even been compression on the gba, but it didn't know that it could look that great! what's the memory gained for let's say the shambler?
<br/>
<br/>
good luck with your project!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#88408 - masscat - Mon Jun 19, 2006 9:57 am</h4>
    <div class="postbody"><span class="postbody">Do you know how to get the DS to use compressed textures? When I last played with them I could not get it to work (see <a class="postlink" href="http://forum.gbadev.org/viewtopic.php?t=8940" target="_blank">here</a>).</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#88409 - EyeballKid - Mon Jun 19, 2006 10:00 am</h4>
    <div class="postbody"><span class="postbody">This library might be useful - <a class="postlink" href="http://www.sjbrown.co.uk/?code=squish" target="_blank">http://www.sjbrown.co.uk/?code=squish</a>. It looks pretty well thought through, and the guy who wrote it really knows his stuff.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#88498 - Sausage Boy - Mon Jun 19, 2006 8:20 pm</h4>
    <div class="postbody"><span class="postbody">One problem I had using squish was compiling it with optimizations. It breaks the good compression method. Compiling with -O0 is a temporary solution, but if someone i good at debugging these things...
<br/>
<br/>
The difference between the DS's compression and S3TC DXT1 is that the DS uses a palette with color pairs as well.<br/>_________________<br/>"no offense, but this is the gayest game ever"</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
