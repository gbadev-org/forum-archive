<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Problems with RealTimeClock (IPC->...) - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > Problems with RealTimeClock (IPC->...)</h2>
<div id="posts">
<div class="post">
    <h4>#117802 - king corn - Wed Feb 07, 2007 4:59 pm</h4>
    <div class="postbody"><span class="postbody">hi!
<br/>
first off, yes i did a search ;).
<br/>
<br/>
yesterday i switched from devkitARM_r19a to devkitARM_r20 and from libnds-20060719 to libnds-20070127, made some changes to my sourcecode and compiled.
<br/>
well the problem now is, that IPC-&gt;time.rtc.xyz returns zero.
<br/>
i've tried on both hardware and no$gba, but no luck with the clock.
<br/>
it did work fine with the old version, but with the new improved stylushandling i really don't want to switch back again.
<br/>
<br/>
any hint or help would be very much appreciated.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#123110 - ikaris - Sun Mar 25, 2007 4:39 am</h4>
    <div class="postbody"><span class="postbody">I have the same issue.
<br/>
<br/>
Not sure what can be done to fix it.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#123116 - ttabbal - Sun Mar 25, 2007 6:52 am</h4>
    <div class="postbody"><span class="postbody">I added this to the VBlank handler for the arm7...
<br/>
<br/>
	rtcGetTime(IPC-&gt;time.curtime);
<br/>
<br/>
The RTC data is now not zero. It doesn't fix my problem with libfat not setting a file date though. Odd. I can print out the time, but libfat still doesn't want to set the file timestamps. 
<br/>
<br/>
I'm not sure this is the best way to handle the time data, but it has to be read from the arm7, and the VBlank seemed like a good way to keep it reasonably updated.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#123124 - melw - Sun Mar 25, 2007 10:42 am</h4>
    <div class="postbody"><span class="postbody">According to Wintermute, there's going to be a changes in a way how IPC struct is handled, as well as realtime clock. However, this is how the realtime clock works with the current libnds CVS version. Just call initClock() in the beginning of arm7 main and use syncRTC() in vblank interrupt.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void initClock()
<br/>
{
<br/>
   REG_RCNT = 0x8100;
<br/>
<br/>
   irqSet(IRQ_NETWORK, testSync);
<br/>
<br/>
   // Reset the clock if needed
<br/>
   rtcReset();
<br/>
<br/>
   rtcGetTimeAndDate((uint8 *)&amp;(IPC-&gt;time.rtc.year));
<br/>
<br/>
   uint8 command[4];
<br/>
   
<br/>
   command[0] = READ_STATUS_REG2;
<br/>
   rtcTransaction(command, 1, &amp;command[1], 1);
<br/>
<br/>
   command[0] = WRITE_STATUS_REG2;
<br/>
   command[1] = 0x41;
<br/>
<br/>
   rtcTransaction(command, 2, 0, 0);   
<br/>
<br/>
   command[0] = WRITE_INT_REG1;
<br/>
   command[1] = 0x01;
<br/>
   rtcTransaction(command, 2, 0, 0);
<br/>
   
<br/>
   command[0] = WRITE_INT_REG2;
<br/>
   command[1] = 0x00;
<br/>
   command[2] = 0x21;
<br/>
   command[3] = 0x35;
<br/>
   
<br/>
   rtcTransaction(command, 4, 0, 0);
<br/>
}
<br/>
<br/>
void syncRTC()
<br/>
{
<br/>
   int oldhours = IPC-&gt;time.rtc.hours;
<br/>
   
<br/>
   uint8 command[2];
<br/>
   
<br/>
   command[0] = READ_STATUS_REG1;
<br/>
   rtcTransaction(command, 1, &amp;command[1], 1);
<br/>
<br/>
   IPC-&gt;mailSize = REG_RCNT;
<br/>
<br/>
   if ( command[1] &amp; 0x30 ) {
<br/>
      IPC-&gt;mailRead = command[1];
<br/>
      REG_IF = IRQ_NETWORK;
<br/>
   } else {
<br/>
      IPC-&gt;mailAddr = command[1];
<br/>
   }
<br/>
<br/>
   rtcGetTime((uint8 *)&amp;(IPC-&gt;time.rtc.hours));
<br/>
<br/>
   if(oldhours&gt;IPC-&gt;time.rtc.hours) // going from 23 to 0 hours, update whole time struct
<br/>
      rtcGetTimeAndDate((uint8 *)&amp;(IPC-&gt;time.rtc.year));
<br/>
}
<br/>
<br/>
// in vblank:
<br/>
<br/>
   if ( ++frame == 60 ) { // update time struct once per second
<br/>
      frame = 0;
<br/>
      syncRTC();
<br/>
   }
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
