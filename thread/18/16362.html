<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Quaternion to matrix problem [SOLVED] - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > Quaternion to matrix problem [SOLVED]</h2>
<div id="posts">
<div class="post">
    <h4>#166033 - Marcel24 - Sat Jan 17, 2009 5:21 pm</h4>
    <div class="postbody"><span class="postbody">Hi,currently i try to convert a Quaternion to 4x4 videoGL matrix
<br/>
and multiply it my the current hardware matrix.
<br/>
<br/>
I need this for interpolation key frames (rotations and positions)
<br/>
<br/>
But it doesnt work :(
<br/>
<br/>
Maybe somebody can help me ?
<br/>
<br/>
If i convert the result of QuatSlerpFixed to axis angle then
<br/>
it works right.
<br/>
but its damm slow:(
<br/>
<br/>
tnx for help..
<br/>
<br/>
<br/>
:( i forgot to swap the z,y parameter from the quat
<br/>
i wrote a exporter for 3dstudio max 
<br/>
and forgot it.
<br/>
now it works :)
<br/>
tnx
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
<br/>
<br/>
#define DELTA 0.001
<br/>
<br/>
inline void C3DNode::QuatSlerpFixed(QUATNDS * from, QUATNDS * to, int32 t,QUATNDS * res)
<br/>
      {
<br/>
      int32           to1Fixed[4];
<br/>
      int32      cosomFixed;
<br/>
      int32      omegaFixed;
<br/>
      int32      scale0Fixed;
<br/>
      int32      scale1Fixed;
<br/>
   
<br/>
      cosomFixed =  mulf32(from-&gt;x, to-&gt;x) + 
<br/>
                 mulf32(from-&gt;y, to-&gt;y) + 
<br/>
                 mulf32(from-&gt;z, to-&gt;z) +
<br/>
                 mulf32(from-&gt;w, to-&gt;w);
<br/>
<br/>
      
<br/>
<br/>
      // adjust signs (if necessary)
<br/>
        if ( cosomFixed &lt; floattof32(0.0) )
<br/>
      { 
<br/>
        cosomFixed = -cosomFixed;
<br/>
        to1Fixed[0] = - to-&gt;x;
<br/>
        to1Fixed[1] = - to-&gt;y;
<br/>
        to1Fixed[2] = - to-&gt;z;
<br/>
        to1Fixed[3] = - to-&gt;w;
<br/>
        } 
<br/>
      else  
<br/>
      {
<br/>
         to1Fixed[0] = to-&gt;x;
<br/>
        to1Fixed[1] = to-&gt;y;
<br/>
        to1Fixed[2] = to-&gt;z;
<br/>
        to1Fixed[3] = to-&gt;w;
<br/>
        }
<br/>
<br/>
        // calculate coefficients
<br/>
       scale0Fixed = floattof32(1.0) - t;
<br/>
        scale1Fixed = t;
<br/>
<br/>
   // calculate final values
<br/>
<br/>
   res-&gt;x = mulf32(scale0Fixed,from-&gt;x) + mulf32(scale1Fixed,to1Fixed[0]);
<br/>
   res-&gt;y = mulf32(scale0Fixed,from-&gt;y) + mulf32(scale1Fixed,to1Fixed[1]);
<br/>
   res-&gt;z = mulf32(scale0Fixed,from-&gt;z) + mulf32(scale1Fixed,to1Fixed[2]);
<br/>
   res-&gt;w = mulf32(scale0Fixed,from-&gt;w) + mulf32(scale1Fixed,to1Fixed[3]);
<br/>
}
<br/>
<br/>
inline void C3DNode::LinearInterpolate(FASTPOS *from , FASTPOS *to , FASTPOS *res, int32 t)
<br/>
{
<br/>
   int32 tmp1 = inttof32(1) - t;
<br/>
   
<br/>
   res-&gt;x = (mulf32(from-&gt;x,tmp1) + mulf32(to-&gt;x,t));
<br/>
   res-&gt;y = (mulf32(from-&gt;y,tmp1) + mulf32(to-&gt;y,t));
<br/>
   res-&gt;z = (mulf32(from-&gt;z,tmp1) + mulf32(to-&gt;z,t));
<br/>
}
<br/>
<br/>
<br/>
// In render function
<br/>
FASTPOS posRes;
<br/>
      QUATNDS resQuat;
<br/>
      AXIS_ROT_NDS axisRot;
<br/>
<br/>
      LinearInterpolate(&amp;pNode-&gt;pPosAnimation-&gt;pPosValues[m_iCurKeyFrame],
<br/>
                    &amp;pNode-&gt;pPosAnimation-&gt;pPosValues[m_iCurKeyFrame+1],
<br/>
                    &amp;posRes,m_fixedSplineTime);
<br/>
      
<br/>
      glTranslate3f32(posRes.x,posRes.y,posRes.z);
<br/>
<br/>
      
<br/>
      QuatSlerpFixed(&amp;pNode-&gt;pPosAnimation-&gt;pRotValues[m_iCurKeyFrame],
<br/>
              &amp;pNode-&gt;pPosAnimation-&gt;pRotValues[m_iCurKeyFrame + 1], m_fixedSplineTime,&amp;resQuat);
<br/>
   
<br/>
      m4x4 matrix;
<br/>
      
<br/>
      QuatToMatrixFixed(&amp;resQuat,&amp;matrix,&amp;posRes);
<br/>
      
<br/>
      glMultMatrix4x4(&amp;matrix);</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
