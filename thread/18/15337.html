<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Executing code from the ROM - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>DS development > Executing code from the ROM</h2>
<div id="posts">
<div class="post">
    <h4>#153890 - naleksiev - Mon Apr 07, 2008 11:09 pm</h4>
    <div class="postbody"><span class="postbody">Is it possible to execute code from the ROM on DS without moving it to the RAM? 
<br/>
<br/>
Q: Why I need this? 
<br/>
A: Imagine a library that is not much time consuming and working a little slower won't be a problem, but in the RAM it will take too much space.
<br/>
<br/>
I did some research and these are my thoughts. 
<br/>
<br/>
- I also know how the overlays are working but this is not my case
<br/>
- I know it's possible on GBA - From what I understand if I don't specify IWRAM or EWRAM it will be running from the ROM (I could be wrong here)
<br/>
- I can imagine that if the ROM can't be addressed than this is impossible. But I couldn't really understand how it works on DS. 
<br/>
- Knowing that it's not a good idea to link resources on DS the way it used to be on GBA I assume the ROM can't be addressed directly.
<br/>
<br/>
I hope you guys prove me wrong, so I can find a solution :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#153892 - simonjhall - Mon Apr 07, 2008 11:37 pm</h4>
    <div class="postbody"><span class="postbody">Are you talking about running part of the program from ROM or the *entire* thing? I've played around with running code from slot-2 memory and can confirm that it works, but it was pretty hairy. I don't think you'll be able to run code directly from slot-1, as that's not memory-mapped.<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#153893 - naleksiev - Mon Apr 07, 2008 11:55 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>simonjhall wrote:</b></span></td> </tr> <tr> <td class="quote">Are you talking about running part of the program from ROM or the *entire* thing?</td> </tr></table><span class="postbody">
<br/>
Just part
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>simonjhall wrote:</b></span></td> </tr> <tr> <td class="quote">I don't think you'll be able to run code directly from slot-1, as that's not memory-mapped.</td> </tr></table><span class="postbody">
<br/>
Unfortunately that's what I thought, but I was hopping that there is something I'm missing :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#153898 - Dwedit - Tue Apr 08, 2008 12:53 am</h4>
    <div class="postbody"><span class="postbody">Sounds more like a task for overlays than anything else.  Overlays are where you swap in one block of code for another, possibly by reading it from the disk (ds card).<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#153933 - naleksiev - Tue Apr 08, 2008 4:27 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Dwedit wrote:</b></span></td> </tr> <tr> <td class="quote">Sounds more like a task for overlays than anything else.  Overlays are where you swap in one block of code for another, possibly by reading it from the disk (ds card).</td> </tr></table><span class="postbody">
<br/>
<br/>
I understand the overlays. But this is not the case. Imagine you have 5MB library. Does anyone can come with idea how it can be used?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#153935 - eKid - Tue Apr 08, 2008 4:39 pm</h4>
    <div class="postbody"><span class="postbody">The library will have to be modified to have a smaller memory footprint.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#153938 - kusma - Tue Apr 08, 2008 4:50 pm</h4>
    <div class="postbody"><span class="postbody">I guess the MPU could even be used to automatically swap the overlays, but I must admit that my attempts at messing with the MPU so far has failed horribly.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#153939 - simonjhall - Tue Apr 08, 2008 4:53 pm</h4>
    <div class="postbody"><span class="postbody">Slot-2 RAM, baby. I tried loading in a phat bit of code into this memory, figured out my entry point, returned some function pointers - it's all hunky dorey.
<br/>
You've got to be careful about
<br/>
a) linking your code so that it knows it's going into a variable address - slot-2 memory isn't fixed at 0x80... etc
<br/>
b) making sure your code can call things from libc and other code that's in main memory
<br/>
c) making sure that if you've got any globals there are no 8-bit writes OR you have to adjust the link scripts to ensure your data goes into main memory
<br/>
<br/>
World of pain, but it's all in the linking ;-)<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#153941 - naleksiev - Tue Apr 08, 2008 5:09 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>eKid wrote:</b></span></td> </tr> <tr> <td class="quote">The library will have to be modified to have a smaller memory footprint.</td> </tr></table><span class="postbody">
<br/>
Of course this is a solution:)
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>kusma wrote:</b></span></td> </tr> <tr> <td class="quote">I guess the MPU could even be used to automatically swap the overlays, but I must admit that my attempts at messing with the MPU so far has failed horribly.</td> </tr></table><span class="postbody">
<br/>
I'll look at the MPU it sounds interesting
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>simonjhall wrote:</b></span></td> </tr> <tr> <td class="quote">Slot-2 RAM, baby.</td> </tr></table><span class="postbody">
<br/>
Thanks simonjhall but I'll pass on this one. I love game consoles because I "can't" upgrade them and if something works on my NDS it should works on your. I better use PC instead of trying to make my DS a PC</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#153942 - M3d10n - Tue Apr 08, 2008 5:12 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>naleksiev wrote:</b></span></td> </tr> <tr> <td class="quote">Is it possible to execute code from the ROM on DS without moving it to the RAM?</td> </tr></table><span class="postbody">
<br/>
No. Slot-1 ROM is not memory mapped. It's no different than optical media when it comes to executing code from it.
<br/>
<br/>
(Posting this just because it hasn't been said yet.)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#153944 - kusma - Tue Apr 08, 2008 5:21 pm</h4>
    <div class="postbody"><span class="postbody">I believe MightyMax had some virtual memory with loading from disk on request code working in the tiny kernel-thingie he wrote. Damn skilled guy.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#153946 - naleksiev - Tue Apr 08, 2008 5:33 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>M3d10n wrote:</b></span></td> </tr> <tr> <td class="quote">Slot-1 ROM is not memory mapped.</td> </tr></table><span class="postbody">
<br/>
<br/>
Just from curiosity, why did Nintendo design the hardware this way? Especially if it was memory mapped in GBA. 
<br/>
My only guess will be to break the 4GB limit for 32bit pointer.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#153955 - M3d10n - Tue Apr 08, 2008 5:56 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>naleksiev wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>M3d10n wrote:</b></span></td> </tr> <tr> <td class="quote">Slot-1 ROM is not memory mapped.</td> </tr></table><span class="postbody">
<br/>
<br/>
Just from curiosity, why did Nintendo design the hardware this way? Especially if it was memory mapped in GBA. 
<br/>
My only guess will be to break the 4GB limit for 32bit pointer.</span></td> </tr></table><span class="postbody">
<br/>
<br/>
GBA carts (and probably all past consoles' carts) are memory mapped because they are memory mapped devices with a parallel interface, not much different than RAM sticks in your computer. 
<br/>
<br/>
NDS carts are block-devices with serial interface, similar to SD-cards, hard-disks and CD-ROMs. They are slower to access than memory-mapped carts, but the serial interface is much cheaper to produce and allows cartridges to be smaller and use a wider range of storage methods.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#153964 - Miked0801 - Tue Apr 08, 2008 6:50 pm</h4>
    <div class="postbody"><span class="postbody">And man is that interface slow :(</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#153966 - simonjhall - Tue Apr 08, 2008 6:55 pm</h4>
    <div class="postbody"><span class="postbody">How fast is it anyway? I've done FA with slot-1 besides point my fat that way (heh) and haven't really paid attention to the interface speed. Slot-2 is &lt; 10 megs / second, how does slot-1 compare?<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#153978 - tepples - Tue Apr 08, 2008 9:51 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>naleksiev wrote:</b></span></td> </tr> <tr> <td class="quote">I better use PC instead of trying to make my DS a PC</td> </tr></table><span class="postbody">
<br/>
Which handheld PC do you plan to code for?
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>naleksiev wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>M3d10n wrote:</b></span></td> </tr> <tr> <td class="quote">Slot-1 ROM is not memory mapped.</td> </tr></table><span class="postbody">
<br/>
Just from curiosity, why did Nintendo design the hardware this way? Especially if it was memory mapped in GBA.</span></td> </tr></table><span class="postbody">
<br/>
Cost. Word-addressed memory, such as that used in the N64 and GBA, is more expensive than <a class="postlink" href="http://www.pineight.com/ds/block/" target="_blank">block-addressed memory</a>, such as that used in the GameCube, DS, and digital cameras. Compare the prices of a 512 Mbit GBA card and a 64 MB CompactFlash card during the GBA's commercial life.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">My only guess will be to break the 4GB limit for 32bit pointer.</td> </tr></table><span class="postbody">
<br/>
Address space wasn't the issue. There was a 40 KiB limit for NES Game Paks, yet they approached 1 MiB by the end of the system's commercial life. See <a class="postlink" href="http://en.wikipedia.org/wiki/Bank_switching" target="_blank">Bank switching on Wikipedia</a> and <a class="postlink" href="http://nesdevwiki.org/index.php/Category:Mappers" target="_blank">Mappers on NESdevWiki</a>.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>simonjhall wrote:</b></span></td> </tr> <tr> <td class="quote">Slot-2 is &lt; 10 megs / second, how does slot-1 compare?</td> </tr></table><span class="postbody">
<br/>
DS SLOT-1 is an 8-bit channel. To see how fast it can transfer, take your favorite SLOT-1 microSD adapter, such as R4 or CycloDS Evolution, and run my <a class="postlink" href="http://www.pineight.com/gba/#cf_bench" target="_blank">speed tester</a>. The value you get isn't exact, as the flash cards aren't exactly the same as an authentic Game Card, but it's in the ballpark.
<br/>
<br/>
Datel Games n Music, on the other hand, uses the 1-bit side channel that authentic Game Cards use for save data, so it'll be about 8 times slower. Results from my speed tester bear this out.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#153983 - simonjhall - Tue Apr 08, 2008 11:19 pm</h4>
    <div class="postbody"><span class="postbody">I realise I'm pretty off-topic here, so feel free to fork if you care.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tepples wrote:</b></span></td> </tr> <tr> <td class="quote">DS SLOT-1 is an 8-bit channel. To see how fast it can transfer, take your favorite SLOT-1 microSD adapter, such as R4 or CycloDS Evolution, and run my <a class="postlink" href="http://www.pineight.com/gba/#cf_bench" target="_blank">speed tester</a>. The value you get isn't exact, as the flash cards aren't exactly the same as an authentic Game Card, but it's in the ballpark.
<br/>
<br/>
Datel Games n Music, on the other hand, uses the 1-bit side channel that authentic Game Cards use for save data, so it'll be about 8 times slower. Results from my speed tester bear this out.</td> </tr></table><span class="postbody">Right, thanks for clarifying. I knew there was some beef with the interface to the GnM (hence the slow speed) but was unsure what. They must have done the 1-bit do-dah because of cost, but it does seem a bit of an odd way to do it! So what's the peak speed that you can get out of the interface sans latency issues?
<br/>
<br/>
With the gba slot I'd imagine it's something like 16MHz @ 16 bit, so something like 32 meg / second. I'm probably wrong though, cos I've not coded in quite a few months now ;-)<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#153984 - Dwedit - Tue Apr 08, 2008 11:46 pm</h4>
    <div class="postbody"><span class="postbody">Waitstates waitstates waitstates.
<br/>
There are 8 cycles in a 4 byte cartridge memory access, not 1.
<br/>
2^24Hz clockspeed and 8 cycles per 32-bit memory read.
<br/>
Works out to 8MB/sec.
<br/>
There are more waitstates in NDS mode.<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#153986 - tepples - Wed Apr 09, 2008 12:00 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>simonjhall wrote:</b></span></td> </tr> <tr> <td class="quote">I realise I'm pretty off-topic here, so feel free to fork if you care.</td> </tr></table><span class="postbody">
<br/>
As far as I can tell, we're still within the topic of the motivation to execute code directly from ROM or not to do so.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>simonjhall wrote:</b></span></td> </tr> <tr> <td class="quote">I knew there was some beef with the interface to the GnM (hence the slow speed) but was unsure what. They must have done the 1-bit do-dah because of cost, but it does seem a bit of an odd way to do it! So what's the peak speed that you can get out of the interface sans latency issues?</td> </tr></table><span class="postbody">
<br/>
With quality microSD cards, people in the <a class="postlink" href="http://forum.gbadev.org/viewtopic.php?t=13862&amp;postdays=0&amp;postorder=asc&amp;start=15" target="_blank">speed tester topic</a> have reported getting roughly 6000 microseconds for 16 KiB, or about 2.8 MB per second. I haven't tried testing with actual DS Game Cards, for reasons that I also <a class="postlink" href="http://forum.gbadev.org/viewtopic.php?p=153976#153976" target="_blank">explained in the speed tester topic</a>.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">With the gba slot I'd imagine it's something like 16MHz @ 16 bit, so something like 32 meg / second. I'm probably wrong though, cos I've not coded in quite a few months now ;-)</td> </tr></table><span class="postbody">
<br/>
Dwedit is right. At 2,1 wait state, which is the fastest that SLOT-2 supports, the interface runs at is 5.6 MHz for random access or 8.4 MHz for sequential access.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
