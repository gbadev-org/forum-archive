<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Console and Bitmap Backgrounds - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > Console and Bitmap Backgrounds</h2>
<div id="posts">
<div class="post">
    <h4>#128686 - evilsanta - Mon May 14, 2007 1:46 am</h4>
    <div class="postbody"><span class="postbody">EDIT: See 2nd Post... this post was very ignorant. :)
<br/>
I am having some problems using the console, and also writing pixels to the same screen as the console, I realize I have to set it to the proper VRam... but currently I can only get the console to work using ConsoleInitDemo... which I obviously cant use if I want to alter the BG and stuff of the screen.
<br/>
<br/>
<br/>
Right now this is my code... currently some blue lines appear, so it seems the text is being scewed, sadly I do not know exactly what is going on so I cant possible fix it.
<br/>
<br/>
Any help would be appreciated...
<br/>
(CODE REMOVED TO MAKE THREAD SHORTER)</span><span class="gensmall"><br/><br/>Last edited by evilsanta on Wed May 16, 2007 1:01 am; edited 3 times in total</span></div>    
</div>
<div class="post">
    <h4>#128850 - evilsanta - Tue May 15, 2007 10:45 pm</h4>
    <div class="postbody"><span class="postbody">Ok, now after a couple days of doing much research... I have discovered that I shouldnt be using FB mode...
<br/>
<br/>
I altered my code, I can draw things to both screens fairly easily... but I am having trouble adding the text to a new background... whenever I add it the text looks garbled, if I do a full screen draw (say solid red) I get black vertical lines. What exactly could be happening here?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#128853 - dovoto - Tue May 15, 2007 10:58 pm</h4>
    <div class="postbody"><span class="postbody">Black horizontal lines normally are the result of attempting to render to VRAM using 8 bit writes.  VRAM must be written to in 16 bit increments.
<br/>
<br/>
As for fuxoring up the console you should be fine if you avoid VRAM C and palette entry 255 of the subdisplay (assuming you have used consoleDemoInit()).
<br/>
<br/>
If you need to use VRAM C take a look at the more verbose version of the console init function (LIBNDS_DIR/nds/arm9/console.h).  It will allow you to specify the location of console memory explicitly.<br/>_________________<br/><a href="http://www.drunkencoders.com" target="_blank">www.drunkencoders.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#128856 - evilsanta - Tue May 15, 2007 11:03 pm</h4>
    <div class="postbody"><span class="postbody">Thanks for the reply, yeah I am currently using consoleinitDefault... and I am also using vram_c.
<br/>
<br/>
<br/>
Here, ill post my code... for a while I was trying to set it to VRAM_H but I had the same problem. Any help would be appreciated...
<br/>
<br/>
EDIT: Ok, after adding BG_PALETTE_SUB[255] = RGB15(3,15,11); I can see the text, however when I add Background 3 I get garbled pixels as seen here...
<br/>
<a href="http://img180.imageshack.us/img180/5048/untitledjn0.jpg" target="_blank">http://img180.imageshack.us/img180/5048/untitledjn0.jpg</a>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code"> 
<br/>
   powerON(POWER_ALL); 
<br/>
<br/>
   irqInit();
<br/>
   irqSet(IRQ_VBLANK, 0);
<br/>
   
<br/>
   //vramSetMainBanks(VRAM_A_MAIN_BG, VRAM_B_LCD, VRAM_C_SUB_BG , VRAM_D_LCD); //REMOVE
<br/>
   
<br/>
   u16* vidBuffA = (u16*)BG_BMP_RAM(0); //Point a video buffer to the start of the BG
<br/>
   videoSetMode(MODE_5_2D | DISPLAY_BG2_ACTIVE); //Set mode to 5, with BG2 active
<br/>
   vramSetBankA(VRAM_A_MAIN_BG); //Store it in vram_a
<br/>
   
<br/>
   //Initialize BG
<br/>
   BG2_CR = BG_BMP16_256x256;
<br/>
   BG2_XDX = 1&lt;&lt;8;
<br/>
   BG2_XDY = 0;
<br/>
   BG2_YDX = 0;
<br/>
   BG2_YDY = 1&lt;&lt;8;
<br/>
   BG2_CY = 0;
<br/>
   BG2_CX = 0;
<br/>
   
<br/>
<br/>
   u16* vidBuffC = (u16*)BG_BMP_RAM_SUB(0); 
<br/>
   videoSetModeSub(MODE_5_2D | DISPLAY_BG0_ACTIVE | DISPLAY_BG3_ACTIVE);
<br/>
   
<br/>
   
<br/>
   vramSetBankC(VRAM_C_SUB_BG);
<br/>
<br/>
    SUB_BG3_CR = BG_BMP16_256x256 | BG_BMP_BASE(0) | BG_PRIORITY(3); 
<br/>
    //attributes of the affine translation matrix
<br/>
    SUB_BG3_XDX = 1 &lt;&lt; 8; //scale x
<br/>
    SUB_BG3_XDY = 0; //rotation x
<br/>
    SUB_BG3_YDX = 0; //scale y
<br/>
    SUB_BG3_YDY = 1 &lt;&lt; 8; //scale y
<br/>
    SUB_BG3_CX = 0; //translation x
<br/>
    SUB_BG3_CY = 0; //translation y
<br/>
    
<br/>
   SUB_BG0_CR = BG_MAP_BASE(31) | BG_PRIORITY(0);//use bg0 for the text 
<br/>
   consoleInitDefault((u16*)SCREEN_BASE_BLOCK_SUB(31), (u16*)CHAR_BASE_BLOCK_SUB(0), 16);
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#128880 - Dark Knight ez - Wed May 16, 2007 10:24 am</h4>
    <div class="postbody"><span class="postbody">Easy one. Your BG3's graphics are using the same place as the console's graphics.
<br/>
You use BG_BMP_BASE(0) for the former and CHAR_BASE_BLOCK_SUB(0) for the latter, effectively being the same place.
<br/>
I'd suggest moving the console's map further to the front of the VRAM (I think there was a limit to where you can place maps, can't place it further down the VRAM) and just put BG3's graphics somewhat back in VRAM.
<br/>
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">SUB_BG0_CR = BG_MAP_BASE(<span style="font-weight: bold">3</span>) | BG_PRIORITY(0); // graphics at start, and map at 6kb into VRAM
<br/>
consoleInitDefault((u16*)SCREEN_BASE_BLOCK_SUB(<span style="font-weight: bold">3</span>), (u16*)CHAR_BASE_BLOCK_SUB(0), 16);
<br/>
<br/>
SUB_BG3_CR = BG_BMP16_256x256 | BG_BMP_BASE(<span style="font-weight: bold">2</span>) | BG_PRIORITY(3); // graphics at 32kb into VRAM, should still be enough for your insanely VRAM-consuming background.</td> </tr></table><span class="postbody"><br/>_________________<br/><span style="font-size: 9px; line-height: normal"><a class="postlink" href="http://amplituds.drunkencoders.com" target="_blank">AmplituDS website</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#128937 - evilsanta - Wed May 16, 2007 9:15 pm</h4>
    <div class="postbody"><span class="postbody">Thank you for your reply, it is working much better now...
<br/>
<br/>
However, when I do a full BG fill of the sub screen
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
      for(int i = 0; i &lt; 256*256; i++)
<br/>
         vidBuffC[i] = RGB15(0,0,31) | BIT(15);
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Then the text does not display...
<br/>
<br/>
<br/>
<br/>
Also I was wondering about something, when I set my BG3s location in VRAM to anything above the console, it doesnt work... is this because the mapping for the console takes up a lot?
<br/>
<br/>
EDIT: found that if I remove this consoleClear(); from my main loop it works... I have not yet tested it on actual hardware, but I have a guess as to how I can fix it, double buffering correct?
<br/>
<br/>
EDIT AGAIN: I have also just tested it on hardware, the text appears very faded and transparent... any ideas?
<br/>
<br/>
EDIT: Nvrmind, heh just shouldnt have consoleClear(). Thanks everyone for all the help! :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#129024 - evilsanta - Fri May 18, 2007 12:51 am</h4>
    <div class="postbody"><span class="postbody">Hello, So far all had been going well... I had a bitmap bg on the mainscreen and subscreen, and the subscreen had a console setup... but now then wanted to add a console to the mainscreen, and then I started getting random black shapes on the bottom screen...
<br/>
<br/>
<br/>
Currently my memory map looks like this
<br/>
<br/>
Main BG 2 - BG_BMP_BASE(3)
<br/>
Main BG 0 - BG_MAP_BASE(5) (console)
<br/>
<br/>
Sub BG 3 - BG_BMP_BASE(2)
<br/>
Sub BG 0 - BG_MAP_BASE(4) (console)
<br/>
<br/>
Does my memory layout look ok? Im thinking it might just be the emulator I am using...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#129040 - Dark Knight ez - Fri May 18, 2007 9:54 am</h4>
    <div class="postbody"><span class="postbody">o.O'
<br/>
<br/>
You use printf or iprintf to write to the console... how were you possibly going to make those calls know if you meant printing to your main- or subscreen?<br/>_________________<br/><span style="font-size: 9px; line-height: normal"><a class="postlink" href="http://amplituds.drunkencoders.com" target="_blank">AmplituDS website</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#129121 - evilsanta - Sat May 19, 2007 3:11 am</h4>
    <div class="postbody"><span class="postbody">I am sorry, but I do not know what you mean, do I not just change the consoleinit to the proper memory each time I want to write to that screen? Because so far it appears to be working just fine on hardware...
<br/>
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
      consoleInitDefault((u16*)SCREEN_BASE_BLOCK(5), (u16*)CHAR_BASE_BLOCK(0), 16);
<br/>
      printf("Hello Top Screen");
<br/>
      consoleInitDefault((u16*)SCREEN_BASE_BLOCK_SUB(4), (u16*)CHAR_BASE_BLOCK_SUB(0), 16);
<br/>
      printf("Hello Bottom Screen");
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#129130 - Dark Knight ez - Sat May 19, 2007 11:00 am</h4>
    <div class="postbody"><span class="postbody">I see... quite the hassle.
<br/>
Anyway, show the code you added for the mainscreen's console.<br/>_________________<br/><span style="font-size: 9px; line-height: normal"><a class="postlink" href="http://amplituds.drunkencoders.com" target="_blank">AmplituDS website</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#129139 - evilsanta - Sat May 19, 2007 4:17 pm</h4>
    <div class="postbody"><span class="postbody">Well, it seems to work on hardware, I was just wondering if my memory setup would cause anyproblems...
<br/>
<br/>
But is there a better way to enable the console on both the bottom and top screen? Anyways if you wanted to see my code...
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
///////////////
<br/>
   //MAIN       //
<br/>
   ///////////////
<br/>
   u16* vidBuffA = (u16*)BG_BMP_RAM(3); //Point a video buffer to the start of BG 2
<br/>
   videoSetMode(MODE_5_2D | DISPLAY_BG2_ACTIVE | DISPLAY_BG0_ACTIVE); //Set mode to 5, with BG2 active
<br/>
   //Initialize BG
<br/>
   BG2_CR = BG_BMP16_256x256 | BG_BMP_BASE(3) | BG_PRIORITY(2);
<br/>
   BG2_XDX = 1&lt;&lt;8;
<br/>
   BG2_XDY = 0;
<br/>
   BG2_YDX = 0;
<br/>
   BG2_YDY = 1&lt;&lt;8;
<br/>
   BG2_CY = 0;
<br/>
   BG2_CX = 0;
<br/>
   //dmaCopy(Splash_bin, (u16*)BG_BMP_RAM(3), Splash_bin_size);
<br/>
   
<br/>
   //CONSOLE
<br/>
   BG0_CR = BG_MAP_BASE(5) | BG_PRIORITY(0);//use bg0 for the text 
<br/>
   //consoleInitDefault((u16*)SCREEN_BASE_BLOCK(5), (u16*)CHAR_BASE_BLOCK(0), 16);
<br/>
   BG_PALETTE[255] = RGB15(31,31,31); //change color of text
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#129158 - Dark Knight ez - Sat May 19, 2007 10:01 pm</h4>
    <div class="postbody"><span class="postbody">Apart from writing your own code, I don't think there is.
<br/>
<br/>
And if it works on hardware, then there's no need for me to look through your code... emulators aren't perfect, you realised that yourself. :)<br/>_________________<br/><span style="font-size: 9px; line-height: normal"><a class="postlink" href="http://amplituds.drunkencoders.com" target="_blank">AmplituDS website</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#129172 - tepples - Sun May 20, 2007 1:21 am</h4>
    <div class="postbody"><span class="postbody">If it works on hardware but not on an emulator, then please simplify the code to the minimal program that produces this behavior, and send the source code and binary to the emulator's maintainer as a test case.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#129175 - odelot - Sun May 20, 2007 1:46 am</h4>
    <div class="postbody"><span class="postbody">hey... i am trying to do almost the same thing that you want... but i couldnt put text to work yet..
<br/>
<br/>
i am using bank A and bank B for framebuffer on main screen (to make double buffering) and C for the framebuffer of subscreen
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
      //initializing the bank A, B and C. Note that C bank is set to be used in sub screen
<br/>
      vramSetBankA (VRAM_A_MAIN_BG_0x06000000); 
<br/>
      vramSetBankB (VRAM_B_MAIN_BG_0x06020000);
<br/>
      vramSetBankC (VRAM_C_SUB_BG_0x06200000);</td> </tr></table><span class="postbody">
<br/>
<br/>
what banks can I use to for text backgrounds on each screen?? how are you doing this???</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
