<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Banks assignement on main- and sub-screens - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > Banks assignement on main- and sub-screens</h2>
<div id="posts">
<div class="post">
    <h4>#148663 - nipil - Tue Jan 08, 2008 2:26 pm</h4>
    <div class="postbody"><span class="postbody"><span style="text-decoration: underline">"Disclaimer" :</span>
<br/>
<span style="font-style: italic">i do apologize for the length of this post. I write lots of stuff, as it helps
<br/>
me be sure i'm not confusing while writing it, and provides all the info i
<br/>
managed to gather, which (i hope) helps to find the answers to the
<br/>
questions i ask ;)</span>
<br/>
<br/>
Right now, i've been doing my stuff on main screen, using console output on sub to debug (both mode5). I was setting VRAM A&amp;B to main background. 
<br/>
<br/>
I'm currently using :
<br/>
- BG_MAP_BASE(0) (16k of maps available)
<br/>
- BG_TILE_BASE(1) (16k of sprites available)
<br/>
- an extended 256x256@16 BG3 (128k of memory available)
<br/>
<br/>
I just realize i was "wasting" memory by assigning B, which i might use for something else later.
<br/>
So i decided to change the setting from A+B to A(128k)+F(16k)+G(16k) :
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">vramSetBankA(VRAM_A_MAIN_BG_0x06000000);
<br/>
vramSetBankF(VRAM_F_MAIN_BG);
<br/>
vramSetBankG(VRAM_G_MAIN_BG);</td> </tr></table><span class="postbody">
<br/>
Then i realized banks F &amp; G didn't specify adresses to map to. So i took a look at <a class="postlink" href="http://nocash.emubase.de/gbatek.htm#dsmemorycontrolvram" target="_blank">gbatek's  VRAM memory control</a>. There i found:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">VRAM    SIZE  MST  OFS   ARM9, 2D Graphics Engine A, BG-VRAM (max 512K)
<br/>
A,B,C,D 128K  1    0..3  6000000h+(20000h*OFS)
<br/>
E       64K   1    -     6000000h
<br/>
F,G     16K   1    0..3  6000000h+(4000h*OFS.0)+(10000h*OFS.1)</td> </tr></table><span class="postbody">
<br/>
What i understand from this is that contrary to A, for F&amp;G, OFS is not a counter :
<br/>
- A can be mapped to 600:0000, and "ends" at 601:FFFFh.
<br/>
- F can be mapped to 4 different adresses using the 2 lower bits of the 4-bits OFS
<br/>
- G is the same as F
<br/>
<br/>
Possible base F addresses are then :
<br/>
- 600:0000h (OFS=0) ending at 600:3FFFh
<br/>
- 600:4000h (OFS=1) ending at 600:7FFFh
<br/>
- 601:0000h (OFS=2) ending at 601:3FFFh
<br/>
- 601:4000h (OFS=3) ending at 601:7FFFh
<br/>
<br/>
I thought i would have mapped it as shown below (each letter being a 16k block) :
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">|&lt;- VRAM base 600:0000h
<br/>
<br/>
Target placement
<br/>
|AAAAAAAA........
<br/>
|........F.......
<br/>
|.........G......
<br/>
<br/>
Possible F &amp; G placements using OFS
<br/>
|AAAAAAAA........
<br/>
|FF..FF..........
<br/>
|GG..GG..........</td> </tr></table><span class="postbody">
<br/>
As you can see, A overlaps F or G no matter OFS. So i guess i cannot achieve target placement.
<br/>
In turn, i *could* invert the positions of the banks, as shown below :
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">Potential solution by moving A to 602:0000h
<br/>
|........AAAAAAAA
<br/>
|FF..FF..........
<br/>
|GG..GG..........
<br/>
<br/>
Let's say i retain this one :
<br/>
|..uuuuuu........ unused adresses
<br/>
|........AAAAAAAA
<br/>
|F............... (OFS=0)
<br/>
|.G.............. (OFS=1)</td> </tr></table><span class="postbody">
<br/>
<span style="font-style: italic"><span style="font-weight: bold">Now we reached this point, i have, as you can guess, some questions</span></span> :
<br/>
- Can we really order the mapping as we want ?
<br/>
- Is there a problem with the 6 unused (u) 16k adresse blocks ?
<br/>
- There's a define for A on 602:0000h, but i don't seeany define to place F or G (ie using OFS lower bits), how do i do it ?
<br/>
- I'm currently using the first code-block (F &amp; G without adresses). I fell there's a problem with it, but it works (in no$gba). Is it normal ?
<br/>
<br/>
<br/>
<br/>
<span style="font-weight: bold"><span style="font-style: italic">The next thing i plan to do is to display exactly the same thing on both screens</span></span>.
<br/>
As such, i have to configure banks for the sub engine. The same page from <a class="postlink" href="http://nocash.emubase.de/gbatek.htm#dsmemorycontrolvram" target="_blank">gbatek</a> gives me and the associate placement :
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">GbaTek:
<br/>
VRAM    SIZE  MST  OFS   ARM9, 2D Graphics Engine B, BG-VRAM (max 128K)
<br/>
C       128K  4    -     6200000h
<br/>
H       32K   1    -     6200000h
<br/>
I       16K   1    -     6208000h
<br/>
<br/>
Associated placement :
<br/>
|........CCCCCCCC
<br/>
|........H.......
<br/>
|..........G.....</td> </tr></table><span class="postbody">
<br/>
As stated, max usable memory is 128k (ie, no using C plus another bank). Anyway, H and G overlap with C.
<br/>
<br/>
Final question is :
<br/>
- What are my options for sub-engine configuration ?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#148710 - knight0fdragon - Wed Jan 09, 2008 4:00 am</h4>
    <div class="postbody"><span class="postbody">looks to me like the best solution for you is to map it like so
<br/>
<br/>
FGXXXXXXAAAAAAAA
<br/>
but, unfortunately you can only use a max of 128k for the sub screen, so this is not possible.
<br/>
<br/>
now in the method you have mentioned above, you would set the BG3 BMP_BASE to 8, so that it goes to memory A
<br/>
<br/>
then you want to set TILE_BASE to 0, and set MAP_BASE to 15
<br/>
<br/>
this will give you 30720Bytes of tile memory to deal with, with the last 2048 bytes for map memory.
<br/>
<br/>
now, another trick you can pull determines on how large the BMP image is.
<br/>
<br/>
if you are only going to use an image of 256x192 at 16bpp, that leaves you 32K at the end of VRAM A to do the exact same thing you would be doing in VRAM F and G, but instead you would set your TILE_BASE to 0, your MAP_BASE to 15, and set the BMP_BASE to 2<br/>_________________<br/><a href="http://www.myspace.com/knight0fdragonds" target="_blank">http://www.myspace.com/knight0fdragonds</a>
<br/>
<br/>
MK DS FC: Dragon 330772 075464 
<br/>
AC WW FC: Anthony SamsClub 1933-3433-9458 
<br/>
MPFH: Dragon 0215 4231 1206</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#148725 - nipil - Wed Jan 09, 2008 11:59 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>knight0fdragon wrote:</b></span></td> </tr> <tr> <td class="quote">now in the method you have mentioned above, you would set the BG3 BMP_BASE to 8, so that it goes to memory A
<br/>
then you want to set TILE_BASE to 0, and set MAP_BASE to 15</td> </tr></table><span class="postbody">
<br/>
So i should have for main screen :
<br/>
- VRAM_A_MAIN_BG_0x06020000, as BMP_BASE(8) maps to 602:0000h
<br/>
- BG3_CR = ... | BMP_BASE(8)
<br/>
- VRAM_F_MAIN_BG ... <span style="font-style: italic">mapped where?</span> Presumably 600:0000h. <span style="font-weight: bold">Confirmation ?</span>
<br/>
- VRAM_G_MAIN_BG ... <span style="font-style: italic">mapped where ?</span> <span style="font-weight: bold">How to specifiy to map it at 600:4000h ?</span>
<br/>
- BG0_CR = ... | BG_MAP_BASE(15) | BG_TILE_BASE(0)
<br/>
<br/>
=&gt; And i have a block space :
<br/>
- used from 600:0000h to 600:7FFFh
<br/>
- empty from 600:8000h to 601:FFFFh
<br/>
- usd from 602:0000h to 603:FFFFh
<br/>
<br/>
Then :
<br/>
BMP_BASE_RAM(8) is then ok (602:0000h to 603:FFFFh) in A
<br/>
BG_TILE_BASE(0) is then ok (600:0000h to 600:77FFh) in F
<br/>
BG_MAP_BASE(15) is then ok (600:7800h to 600:7FFFh) <span style="font-weight: bold">if G is mapped at 600:4000h !</span>
<br/>
<br/>
Is it ok ? What about G placement (bold above) ?
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>knight0fdragon wrote:</b></span></td> </tr> <tr> <td class="quote">if you are only going to use an image of 256x192 at 16bpp, that leaves you 32K at the end of VRAM A to do the exact same thing you would be doing in VRAM F and G right now</td> </tr></table><span class="postbody">
<br/>
i'm using all the 256x256 pixels (rot/scrolling BG3) so this is not quite posible right now.
<br/>
To solve the problem on sub engine, i'll try and use 8bpp instead of 16 (so only half the C-bank is used)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#148748 - knight0fdragon - Wed Jan 09, 2008 7:16 pm</h4>
    <div class="postbody"><span class="postbody">it looks like there are no macros for F and G right now to do what you want, so you will have to add the following lines
<br/>
<br/>
VRAM_F_MAIN_BG_0x06000000     = 1;
<br/>
VRAM_F_MAIN_BG_0x06004000     = 1 | VRAM_OFFSET(1);
<br/>
VRAM_F_MAIN_BG_0x06010000     = 1 | VRAM_OFFSET(2);
<br/>
VRAM_F_MAIN_BG_0x06014000     = 1 | VRAM_OFFSET(3);
<br/>
<br/>
VRAM_G_MAIN_BG_0x06000000     = 1;
<br/>
VRAM_G_MAIN_BG_0x06004000     = 1 | VRAM_OFFSET(1);
<br/>
VRAM_G_MAIN_BG_0x06010000     = 1 | VRAM_OFFSET(2);
<br/>
VRAM_G_MAIN_BG_0x06014000     = 1 | VRAM_OFFSET(3);<br/>_________________<br/><a href="http://www.myspace.com/knight0fdragonds" target="_blank">http://www.myspace.com/knight0fdragonds</a>
<br/>
<br/>
MK DS FC: Dragon 330772 075464 
<br/>
AC WW FC: Anthony SamsClub 1933-3433-9458 
<br/>
MPFH: Dragon 0215 4231 1206</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#148749 - nipil - Wed Jan 09, 2008 8:50 pm</h4>
    <div class="postbody"><span class="postbody">Aw, it's that simple ? ;)
<br/>
<br/>
I thought that if it did not appear in the libnds defines,
<br/>
it was for some reasons not possible. Thanks a lot mate !</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#150440 - krozen - Mon Feb 04, 2008 4:39 pm</h4>
    <div class="postbody"><span class="postbody">Thanks for the interesting posts guys. Helping me get my head around these things!
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
PostPosted: Wed Jan 09, 2008 6:16 pm    Post subject:
<br/>
it looks like there are no macros for F and G right now to do what you want, so you will have to add the following lines
<br/>
<br/>
VRAM_F_MAIN_BG_0x06000000 = 1;
<br/>
VRAM_F_MAIN_BG_0x06004000 = 1 | VRAM_OFFSET(1);
<br/>
VRAM_F_MAIN_BG_0x06010000 = 1 | VRAM_OFFSET(2);
<br/>
VRAM_F_MAIN_BG_0x06014000 = 1 | VRAM_OFFSET(3); </td> </tr></table><span class="postbody">
<br/>
<br/>
This is indeed helpful. One question though. There's a gap of 16k between VRAM_F_MAIN_BG_0x06000000  and  VRAM_F_MAIN_BG_0x06004000, and another 16k gap between VRAM_F_MAIN_BG_0x06010000 and VRAM_F_MAIN_BG_0x06014000. Why is there a 48k gap between  VRAM_F_MAIN_BG_0x06004000 and VRAM_F_MAIN_BG_0x06010000? Is this due to the VRAM_OFFSET call? 
<br/>
I've used this code to assign F and G to contigious parts of memory. It works fine if they are offset beteen 0 and 1, and again between 2 and 3. But there is a big gap between 1 and 2! Is there any way of addressing the data from VRAM_F_MAIN_BG_0x06004000 in 16k gaps using VRAM_OFFSET?
<br/>
<br/>
One more thing: If I use VRAM_OFFSET(4) in bank G, it seems to map to memory bank to the start of video memory again back to the start of video memory again (i.e VRAM_F_MAIN_BG_0x06000000). 
<br/>
<br/>
Cheers!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#150525 - Cydrak - Wed Feb 06, 2008 3:34 am</h4>
    <div class="postbody"><span class="postbody">Yeah, offsets 4,8,12... are indeed the same as 0. I guess it's only 2 bits.
<br/>
<br/>
The best way to understand banks, IMHO:
<br/>
1) Fill them all with different colors, so you can recognize each one.
<br/>
2) Throw BG2 or 3 into a huge bitmap mode (512x512 8bit for 256K, 16bit for 512K).
<br/>
3) Scroll around, or scale so you can see the whole thing.
<br/>
4) Similar tricks can be done with sprites, palettes and textures.
<br/>
<br/>
Now you have a little VRAM viewer, and can play around with the bank values. If you do that, you should find the reason for the "gap"--there isn't any, exactly. I was surprised to see F and G show up in _two_ places, 32 KB apart!
<br/>
<br/>
Here's what I get for different banks. Behavior is largely the same, regardless of what the banks are mapped to:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">A-D, VRAM_OFFSET(n): maps at 128KB*n
<br/>
E                    [EEEE....] (fixed)
<br/>
F/G, VRAM_OFFSET(0): [X.X.....] ( 0KB,  32KB)
<br/>
F/G, VRAM_OFFSET(1): [.X.X....] (16KB,  48KB)
<br/>
F/G, VRAM_OFFSET(2): [....X.X.] (64KB,  96KB)
<br/>
F/G, VRAM_OFFSET(3): [.....X.X] (80KB, 112KB)
<br/>
C/D, subscreen       [XXXXXXXX] (mirrors every 128KB)
<br/>
H, sub BG            [HH..HH..] (every other 32KB)
<br/>
I, sub BG            [..II..II] (twice every other 32KB)
<br/>
I, sub OBJ           [IIIIIIII] (every 16KB)
<br/>
</td> </tr></table><span class="postbody">
<br/>
So, F and G can map anywhere in the first 128 KB. Maybe something like:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">// n = 0..7 (* 16 KB)
<br/>
#define VRAM_F_G_OFFSET(n)  ( ((n)&gt;&gt;1 &amp; 2) | ((n) &amp; 1) )
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I know nobody asked about bank E, but the fixed location bugs me, leaving a gap if you add bank A and such. I thought of a possible solution to that. Fussing around a bit more, I noticed main BG addressing wraps around at 512 KB, and main OBJs wrap at 256 KB. The ARM9 0x06xxxxxx ranges do it, too.
<br/>
<br/>
By shifting the BG base or OBJ index, this should allow A..D to be contiguous with E:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">0x6000000 + 0 KB     128      256      384      0
<br/>
BG:        [EEEE.... ........ CCCCCCCC DDDDDDDD EEEE....]
<br/>
                              ^ add 256 KB to all BG base
<br/>
</td> </tr></table><span class="postbody">
<br/>
DISPLAY_CR has global map/tile offsets that might be useful here. I don't think there's a bitmap offset, probably as unlike the others, BG_BMP_BASE covers the whole range.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
