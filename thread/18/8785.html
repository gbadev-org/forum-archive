<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Behavioral changes in int casting - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > Behavioral changes in int casting</h2>
<div id="posts">
<div class="post">
    <h4>#74184 - MrAdults - Fri Mar 03, 2006 8:26 am</h4>
    <div class="postbody"><span class="postbody">I was using devkitPro r14, and I'm modifying my project to work with r17. I have one particular function that is showing very different results. It may not be completely clear out of context, but here is the function:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">int W_CheckNumForName(char *name)
<br/>
{
<br/>
   char name8[9];
<br/>
   int v1, v2;
<br/>
   lumpinfo_t *lump_p;
<br/>
<br/>
   // Make the name into two integers for easy compares
<br/>
   strncpy(name8, name, 8);
<br/>
   name8[8] = 0; // in case the name was a full 8 chars
<br/>
   strupr(name8); // case insensitive
<br/>
   v1 = *(int *)name8;
<br/>
   v2 = *(int *)&amp;name8[4];
<br/>
<br/>
   // Scan backwards so patch lump files take precedence
<br/>
   lump_p = lumpinfo+numlumps;
<br/>
   while(lump_p-- != lumpinfo)
<br/>
   {
<br/>
      if(*(int *)lump_p-&gt;name == v1 &amp;&amp; *(int *)&amp;lump_p-&gt;name[4] == v2)
<br/>
      {
<br/>
         return lump_p-lumpinfo;
<br/>
      }
<br/>
   }
<br/>
   return -1;
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
So, there are a few things you could see possibly going wrong here, such as the incoming string being 6 characters and the stack array not being zero'd out, or whatever. That is not happening - byte for byte, all 8 bytes from the name8 memory address and from the lump_p-&gt;name memory address match up. Additionally, both addresses are 4-byte-aligned.
<br/>
<br/>
The problem is that whatever code is generated by those *(int *)lump_p-&gt;name statements is not doing what it was doing in r14, so the ints are actually different values despite being cast from 2 identical and aligned 8-byte memory chunks. I could write some inline assembly to ldr and compare manually, but I would really prefer not to. Does anyone know why this would be different all of a sudden?
<br/>
<br/>
-Rich</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#74261 - sajiimori - Fri Mar 03, 2006 9:57 pm</h4>
    <div class="postbody"><span class="postbody">Working on a Doom port?  :)
<br/>
<br/>
If you've already put in asserts on the alignment of name8 and every lump_p-&gt;name address, the next step is to compile the code with -S on each version of the compiler and see what's different.
<br/>
<br/>
Nothing about the code stands out to me other than alignment.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#74295 - MrAdults - Sat Mar 04, 2006 4:59 am</h4>
    <div class="postbody"><span class="postbody">Yeah, I guess copying addresses by hand into calc.exe at 2am isn't a good idea. The stack address was not 4-byte-aligned after all. Thanks for the reply anyway. :)
<br/>
<br/>
Although I am curious, was something related to stack alignment changed between r14 and r17, or did the change in crt/lib/whoknowswhatelse code just happen to push the location of my stack variable off by a couple bytes?
<br/>
<br/>
-Rich</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#74296 - DekuTree64 - Sat Mar 04, 2006 5:01 am</h4>
    <div class="postbody"><span class="postbody">Huh, I thought it was ARM standard that the stack pointer always be word aligned. Maybe should be reported as a bug in the latest GCC.
<br/>
<br/>
Probably what's causing it is that array of 9 chars. Try rounding it up to 12, just as a workaround, and see if it works.<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#74297 - MrAdults - Sat Mar 04, 2006 5:16 am</h4>
    <div class="postbody"><span class="postbody">Yeah, padding that from 9 to 12 corrects the issue. Looking at the generated assembly for the unpadded version I can see the problem pretty quickly:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">   sub   sp, sp, #12
<br/>
.LCFI7:
<br/>
.LVL43:
<br/>
   .loc 1 474 0
<br/>
   add   r4, sp, #3</td> </tr></table><span class="postbody">
<br/>
<br/>
Apparently it decided to pad that array, but instead of giving me a pointer to its base, it gave me a pointer to padded size minus the size of the array. Silly compiler.
<br/>
<br/>
-Rich</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#74305 - GPFerror - Sat Mar 04, 2006 6:25 am</h4>
    <div class="postbody"><span class="postbody">how do you pad a struct for that?
<br/>
<br/>
iv had a similiar issue, where i was trying to load data into a structure member and it was using sizeof(structmem) and i had to change it to a hardcoded value that i got from the pc version of the port.
<br/>
<br/>
thanks,
<br/>
Troy(GPF)
<br/>
<a href="http://gpf.dcemu.co.uk" target="_blank">http://gpf.dcemu.co.uk</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#74307 - MrAdults - Sat Mar 04, 2006 6:46 am</h4>
    <div class="postbody"><span class="postbody">That's a somewhat different matter than what's discussed above (seems that stack alignment should be handled automatically and properly by the compiler, even though it isn't with the latest GCC). By default all of your structs will be 4-byte/word-aligned, and sizeof will be the padded size. If you want to avoid having unknown pad added to your structs you can just add pad members yourself to make sure everything is 4-byte-aligned. You can also disable struct alignment with a compiler option, but on the DS that would be a generally bad idea.
<br/>
<br/>
-Rich</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#74312 - sajiimori - Sat Mar 04, 2006 7:37 am</h4>
    <div class="postbody"><span class="postbody">Maybe I wouldn't blame GCC for not aligning a char array (since it might expect you to only use byte operations), but it does seem odd that it chose to start the array on an unaligned address even though it made enough space to use an aligned address.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#74315 - MrAdults - Sat Mar 04, 2006 8:02 am</h4>
    <div class="postbody"><span class="postbody">I would be less inclined to blame the compiler, except for the GCC included with devkitPro r14 also pads that array to 12 bytes (took a look at the assembly for that version as well), but doesn't add the extra 3 bytes back, and rather just gives me the base. It's definitely odd behavior, and it wasn't there before.
<br/>
<br/>
-Rich</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#74316 - DekuTree64 - Sat Mar 04, 2006 8:18 am</h4>
    <div class="postbody"><span class="postbody">I think the 4 byte alignment is to conform to the standard, but it wants to squeeze the 9 byte array up as high as possible so if you do happen to make another byte variable, it can go in those 3 bytes below instead of allocating another 4 bytes.
<br/>
While there is some logic to that, I'd rather it sacrifice that bit of extra space to have correct alignment for faster mem copies and such. At least there should be an option for it, rather than just changing the behavior entirely.<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
