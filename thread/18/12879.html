<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>3D Lighting is broken - multiple libnds bugs. - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > 3D Lighting is broken - multiple libnds bugs.</h2>
<div id="posts">
<div class="post">
    <h4>#123868 - 3D_geek - Sun Apr 01, 2007 12:51 am</h4>
    <div class="postbody"><span class="postbody">I've just started to play with lighting for 3D graphics - and I can't get ANYTHING to work.  So I looked at the trusty 'nds-examples-20070127.tar' bundle to see what the example programs do.  Several of the NeHe demos and one or two of the Misc demos seem to turn on 3D light sources, they set the light attribute on the glPolyFmt call and provide normals for simple things like cubes and such - so I presume we have (at least at some stage) gotten lighting working.
<br/>
<br/>
However, when I run those demos - none of them seem to show any kind of 3D lighting effect at all!   Well - this perhaps explains why I'm having no luck!
<br/>
<br/>
So - starting at the beginning - do I have good vertex normals?
<br/>
<br/>
Well all of the examples have things like:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
        NORMAL_PACK(0,inttov10(-1),0),
<br/>
        NORMAL_PACK(0,inttov10(1),0),
<br/>
        NORMAL_PACK(inttov10(1),0,0),
<br/>
        NORMAL_PACK(0,0,inttov10(-1)),
<br/>
        NORMAL_PACK(inttov10(-1),0,0),
<br/>
        NORMAL_PACK(0,inttov10(1),0)
<br/>
</td> </tr></table><span class="postbody">
<br/>
...as the normals for the six faces of a simple cube.  NORMAL_PACK says:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#define NORMAL_PACK(x,y,z)   (((x) &amp; 0x3FF) | (((y) &amp; 0x3FF) &lt;&lt; 10) | ((z) &lt;&lt; 20))
<br/>
</td> </tr></table><span class="postbody">
<br/>
And inttov10 (and floattov10) say:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#define inttov10(n)          ((n) &lt;&lt; 9)
<br/>
#define floattov10(n)       ((v10)((n) * (1 &lt;&lt; 9)))
<br/>
</td> </tr></table><span class="postbody">
<br/>
So I deduce that there are 10 bits for each component of the normal - packed into a 30 bit word...but hold on - normals are signed quantities?!  According to the hardware bible: <a href="http://nocash.emubase.de/gbatek.htm#ds3dpolygondefinitionsbyvertices" target="_blank">http://nocash.emubase.de/gbatek.htm#ds3dpolygondefinitionsbyvertices</a> ...we are required to provide:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
4000484h - Cmd 21h - NORMAL - Set Normal Vector (W)
<br/>
    0-  9 X-Component of Normal Vector (1bit sign + 9bit fractional part)
<br/>
  10-19 Y-Component of Normal Vector (1bit sign + 9bit fractional part)
<br/>
  20-29 Z-Component of Normal Vector (1bit sign + 9bit fractional part)
<br/>
  30-31 Not used
<br/>
</td> </tr></table><span class="postbody">
<br/>
Oh - oh.  That's not what libnds does!
<br/>
<br/>
If we take a number like 1 or 1.0f (as used in ALL of the cube examples) and hand it to inttov10 or floattov10, we'll get 0x200.  But that's '-0' in the DS's sign-and-magnitude setup!   On the other hand, if I hand a -1 to inttov10, it'll hand me back 0xfffffe00 - which NORMAL_PACK will chop down to 10 bits by ANDing it with 0x3FF - which leaves me with 0x200 again!!!  No wonder none of these programs can light up a simple cube - all of the surface normals are (0,-0,0), (-0,0,0) or (0,0,-0)...basically...Zero!!!  Since (0,0,0) is not of length 1, it's not a valid normal...who knows what the hardware does with that junk?!
<br/>
<br/>
So none of the example programs have good normals!   They can't ever have had proper lighting working?!?
<br/>
<br/>
There seems to be a similar problem in the packing of texture coordinates - same deal. with sign-and-magnitude representations.  The difference here is that the error is less noticable because relatively few models use negative or maximum-possible-value texture coordinates.
<br/>
<br/>
Has any of this stuff ever been used for real?   Didn't anyone ever think to worry about why none of the lighting works in any of the stock examples?
<br/>
<br/>
When I fix this problem in my own code - I still don't get any 3D lighting - but since it appears that nobod tested this stuff properly - that's not really a surprise!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#123870 - tepples - Sun Apr 01, 2007 1:19 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>3D_geek wrote:</b></span></td> </tr> <tr> <td class="quote">If we take a number like 1 or 1.0f (as used in ALL of the cube examples) and hand it to inttov10 or floattov10, we'll get 0x200.  But that's '-0' in the DS's sign-and-magnitude setup!</td> </tr></table><span class="postbody">
<br/>
Since when is anything on the DS in sign-and-magnitude form?<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#123872 - 3D_geek - Sun Apr 01, 2007 1:28 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tepples wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>3D_geek wrote:</b></span></td> </tr> <tr> <td class="quote">If we take a number like 1 or 1.0f (as used in ALL of the cube examples) and hand it to inttov10 or floattov10, we'll get 0x200.  But that's '-0' in the DS's sign-and-magnitude setup!</td> </tr></table><span class="postbody">
<br/>
Since when is anything on the DS in sign-and-magnitude form?</span></td> </tr></table><span class="postbody">
<br/>
<br/>
Are you saying that this document is wrong?
<br/>
<br/>
<a href="http://nocash.emubase.de/gbatek.htm#ds3dpolygondefinitionsbyvertices" target="_blank">http://nocash.emubase.de/gbatek.htm#ds3dpolygondefinitionsbyvertices</a>
<br/>
<br/>
But no matter whether it's sign/magnitude or two's complement, the fact that:
<br/>
<br/>
a) The example programs use  inttov10(1)  and inttov10(-1) as normal values.
<br/>
b) These two numbers produce IDENTICAL bit patterns after smooshing them through NORMAL_PACK.
<br/>
<br/>
....means that there is a problem.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#123885 - M3d10n - Sun Apr 01, 2007 4:48 am</h4>
    <div class="postbody"><span class="postbody">The teapot display list example I have on my drive seems to be properly lit. I'm using an old libnds version, so maybe it got broken on recent releases?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#123894 - DekuTree64 - Sun Apr 01, 2007 6:44 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>3D_geek wrote:</b></span></td> </tr> <tr> <td class="quote">a) The example programs use  inttov10(1)  and inttov10(-1) as normal values.</td> </tr></table><span class="postbody">
<br/>
Yes, that is bad. The 1.9 bit normal format can't reach a full positive 1. Probably would be best to make a named constant for the maximum value (just use inttov10(1) - 1).<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#123925 - 3D_geek - Sun Apr 01, 2007 5:41 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>M3d10n wrote:</b></span></td> </tr> <tr> <td class="quote">The teapot display list example I have on my drive seems to be properly lit. I'm using an old libnds version, so maybe it got broken on recent releases?</td> </tr></table><span class="postbody">
<br/>
<br/>
Yes - you're right - that one is correctly lit with the latest stuff too.   It's a nice curvey objecf - not a cube or anything - so it probably doesn't have any 1.0 or -1.0 normal components.
<br/>
<br/>
Thanks!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#123927 - 3D_geek - Sun Apr 01, 2007 6:01 pm</h4>
    <div class="postbody"><span class="postbody">Another reason many of the lighting examples aren't working is because that same inttov10/floattov10 problem occurs in the glLight call.  Hence all of our light sources are someplace where they shouldn't be....I havn't yet quite figured what this does - but I suspect it's killing lighting somehow.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#123928 - silent_code - Sun Apr 01, 2007 6:39 pm</h4>
    <div class="postbody"><span class="postbody">lighting works fine in my demo (<a class="postlink" href="http://forum.gbadev.org/viewtopic.php?t=12873" target="_blank">http://forum.gbadev.org/viewtopic.php?t=12873</a>). i had all four lights enabled and working well, though i thought one light may be enough for that simple scene. ;^D
<br/>
<br/>
happy coding.
<br/>
<br/>
ps: one doesn't question tepples. ;^p</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#123951 - 3D_geek - Mon Apr 02, 2007 12:34 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>silent_code wrote:</b></span></td> </tr> <tr> <td class="quote">lighting works fine in my demo (<a class="postlink" href="http://forum.gbadev.org/viewtopic.php?t=12873" target="_blank">http://forum.gbadev.org/viewtopic.php?t=12873</a>). i had all four lights enabled and working well, though i thought one light may be enough for that simple scene. ;^D</td> </tr></table><span class="postbody">
<br/>
<br/>
When I fix my normals so inttov10 and floattov10 are replaced with code that clamps the (1,0,0) type of cases - and do the same thing with glLight positions - my lighting works OK too.  This is likely to be a common problem in application programs though - especially if the example programs don't get it right.
<br/>
<br/>
It's well enough to say "Well, use floattov10(0.97,0,0) in those cases - but very often the normal comes about through some kind of calculation from the polygon vertices - so it'll be wise to scale down the vector by a factor of 0.97 everywhere just to be sure.  Personally I'm going to put a clamp in my version of the inttov10/floattov10 code because roundoff errors could still result in overflow - and the consequences of that are rather serious.  Fortunately, I don't use those calls inside any inner loops so the extra cost is negligable in my application.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
