<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>[noob] dumping the register values / loader functions - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>DS development > [noob] dumping the register values / loader functions</h2>
<div id="posts">
<div class="post">
    <h4>#67262 - linus - Mon Jan 16, 2006 4:44 pm</h4>
    <div class="postbody"><span class="postbody">How would i go about accessing the internal cpu registers (r0 etc) in C? Sorry if this has been covered i couldnt find it anywhere.
<br/>
<br/>
Cheers</span><span class="gensmall"><br/><br/>Last edited by linus on Tue Jan 17, 2006 5:45 pm; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#67281 - juhees - Mon Jan 16, 2006 6:37 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>linus wrote:</b></span></td> </tr> <tr> <td class="quote">How would i go about accessing the internal cpu registers (r0 etc) in C? Sorry if this has been covered i couldnt find it anywhere.
<br/>
<br/>
Cheers</td> </tr></table><span class="postbody">
<br/>
<br/>
You can't. If you want to have access to the registers, you have to use Assembler. Why would you want to read the registers?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#67283 - linus - Mon Jan 16, 2006 6:43 pm</h4>
    <div class="postbody"><span class="postbody">ok didnt know that. im trying to see what values are in the registers when i start a homebrew app from the supercard, so i can possibly see how the restart mechanism works. this may not be possible, i dont know - the main reason im doing it is for experience.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#67286 - tepples - Mon Jan 16, 2006 6:53 pm</h4>
    <div class="postbody"><span class="postbody">Then you'll probably have to customize the startup code on each CPU to dump all registers to an array before it does anything else.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#67328 - linus - Tue Jan 17, 2006 1:35 am</h4>
    <div class="postbody"><span class="postbody">Ah ok so i would need to change the default arm7 and arm9 bins generated when compiling stuff using libnds? - thats probably above my skill level but just for experiences sake how would i copy the stuff to an array?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#67335 - Joat - Tue Jan 17, 2006 2:21 am</h4>
    <div class="postbody"><span class="postbody">You'd replace the crt0 for the arm7 and arm9 with code that copies the registers somewhere safe, before doing the rest of the crt0 setup, and then in your C code, you'd write or display them somewhere.  You'll need the source of libnds (anon CVS should do you), which will provide you with the crtls and the build scripts for them.  You need to copy the arm7, arm9 .s (crt0 code you'll need to mod) and .spec files for them, then modify the .spec to point to the new .s'es, and in your project makefile, change the line that references a .spec file to refer to your new ones.
<br/>
<br/>
It'd probably be a lot easier to disassemble the supercard menu and see what it does with respect to initialization.
<br/>
<br/>
Either way, if you don't know any assembly, now is as good a time to learn as any :)<br/>_________________<br/>Joat
<br/>
<a href="http://www.bottledlight.com" target="_blank">http://www.bottledlight.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#67359 - linus - Tue Jan 17, 2006 12:06 pm</h4>
    <div class="postbody"><span class="postbody">heh well ive done a bit of 68k assembly which helps quite a lot cos i can read other peoples stuff. It doesnt sound to bad. I would dissassemble but i dont really know how and i think the firmware is XOR enrypted, some people over at scdev.org deccrypted it - but i dont know how to do that yet. I think there was 3 different keys or something silly - i may just ask them.
<br/>
<br/>
urm just recap if i get my assembly to dump the values to a memory location is all i have to do just read that location in my C program that prints them.
<br/>
<br/>
oh and how do i dissassemble a bin is there a good tool?
<br/>
<br/>
cheers for this guys it all helps</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#67363 - pepsiman - Tue Jan 17, 2006 1:41 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Joat wrote:</b></span></td> </tr> <tr> <td class="quote">You'd replace the crt0 for the arm7 and arm9 with code that copies the registers somewhere safe.</td> </tr></table><span class="postbody">
<br/>
That's too late for arm7, the nds loader has already overwritten the registers.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#67377 - linus - Tue Jan 17, 2006 5:44 pm</h4>
    <div class="postbody"><span class="postbody">ok well, if im really gonna try this i think i need some more info. in my wonderful land of ignorance i would think all you have to do to start a new program is reset the program counter for the arm7 and arm9 to the start address of the new program. the reset function for for the mp is 
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">   
<br/>
   *((vu32*)0x027FFFFC) = FileCluster;  // Start cluster of NDS to load
<br/>
   *((vu32*)0x027FFE04) = (u32)0xE59FF018;  // ldr pc, 0x027FFE24
<br/>
   *((vu32*)0x027FFE24) = (u32)0x027FFE04;  // Set ARM9 Loop address
<br/>
   swiSoftReset();  // Reset
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
here it looks like the start cluster is going somewhere i dont know, the pc counter is getting a random address i dont know. then theres an arm9 loop - errr what does that do? and then the reset is being called, which i assume resets all the interrupts :S?
<br/>
<br/>
as you can see there is much i dont understand. if anyone can explain to me why just reseting the pc doesnt do it that would be great :) - i know i ask a lot, but one day hopefully i can help out somehow :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#67430 - chishm - Tue Jan 17, 2006 11:46 pm</h4>
    <div class="postbody"><span class="postbody">That's actually used to call the GBAMP's built in loader. The file cluster tells the loader what file to load. The "ldr pc,0x027FFE24 " instruction gets the CPU to keep reading the value at that address and jump to it. The ARM9 loop address tells it to keep jumping back to the ldr instruction, effectively placing it in an infinite loop waiting for the address to change. Finally, the swiSoftReset calls a BIOS function that returns the CPU to it's boot state.
<br/>
<br/>
There is code on the ARM7 as well. It basically resets the ARM7 and jumps to 0x080000c0 when the ARM9 sets up the infinite loop.<br/>_________________<br/><a class="postlink" href="http://chishm.drunkencoders.com" target="_blank">http://chishm.drunkencoders.com</a>
<br/>
<a class="postlink" href="http://dldi.drunkencoders.com" target="_blank">http://dldi.drunkencoders.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#67432 - linus - Wed Jan 18, 2006 12:09 am</h4>
    <div class="postbody"><span class="postbody">sorry if this is obvious but what changes 0x027FFE24 to the cluster address, i assume its some part of the gbamp - does that mean its always polling 0x027FFFFC to check for changes? - that seems a bit crazy to me.
<br/>
<br/>
this is getting a bit complicated for me but ill stick with it, in the mean time im having great fun with your fat driver chishm!
<br/>
<br/>
urm what does a CPU state entail :S</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#67435 - chishm - Wed Jan 18, 2006 12:41 am</h4>
    <div class="postbody"><span class="postbody">0x027FFE24 actually gets changed to the start address of the ARM9 binary, after the ARM7 has finished loading it. This makes the game start. The ARM7 loads the file according to the value at 0x027FFFFC. This is done by the GBAMP firmware when it is first booted <span style="font-style: italic">and when it is called as stated above</span>.
<br/>
<br/>
So the GBAMP doesn't keep polling the value at 0x027FFFC for changes, although the ARM7 binary in the menu (like moonshell) will poll 0x027FFE24 for changes, and act accordingly.
<br/>
<br/>
A CPU state is just what mode it is in, what flags are set, and what values are in its registers.<br/>_________________<br/><a class="postlink" href="http://chishm.drunkencoders.com" target="_blank">http://chishm.drunkencoders.com</a>
<br/>
<a class="postlink" href="http://dldi.drunkencoders.com" target="_blank">http://dldi.drunkencoders.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#67452 - HyperHacker - Wed Jan 18, 2006 6:20 am</h4>
    <div class="postbody"><span class="postbody">Heh, I was just about to ask about this... <a class="postlink" href="http://www.bottledlight.com/ds/index.php/Memory/Layout" target="_blank">this memory map</a> shows nothing mapped to 0x02400000-0x03000000... is this just a mistake? I noticed in ndslib in ipc.h, the IPC struct is located in that range (at 0x027FF000), is this some special area designed for IPC or just general memory? I mainly ask because I want to replace it with my own IPC struct with more info, but I'm not sure if it's safe.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#67454 - chishm - Wed Jan 18, 2006 6:30 am</h4>
    <div class="postbody"><span class="postbody">0x02400000-0x02800000 is an uncached mirror of 0x02000000-0x02400000.
<br/>
What this means is it will contain the exact same data (it is the same memory), but the CPU will <span style="font-weight: bold">always</span> read and write it, instead of using its own internal copy.<br/>_________________<br/><a class="postlink" href="http://chishm.drunkencoders.com" target="_blank">http://chishm.drunkencoders.com</a>
<br/>
<a class="postlink" href="http://dldi.drunkencoders.com" target="_blank">http://dldi.drunkencoders.com</a></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
