<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Alpha blending a single sprite - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > Alpha blending a single sprite</h2>
<div id="posts">
<div class="post">
    <h4>#170119 - headspin - Tue Sep 01, 2009 12:58 am</h4>
    <div class="postbody"><span class="postbody">How do I get per-sprite alpha blending working? I have setup a sprite in 16-bit bitmap mode and have the alpha value set to 0x7. Sprites appear completely opaque. What else do I need to do?
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">oamSet(&amp;oamSub,                  // sub graphics engine context
<br/>
   m_oamIndex,                  // oam index (0 to 127)
<br/>
   m_x, m_y,                  // x and y pixel location of the sprite
<br/>
   1,                        // priority, lower renders last (on top)
<br/>
   0x7,                     // this is the palette index if multiple palettes or the alpha value if bmp sprite   
<br/>
   SpriteSize_32x32,
<br/>
   SpriteColorFormat_Bmp,
<br/>
   m_gfxSub,                  // pointer to the loaded graphics
<br/>
   -1,                        // sprite rotation data  
<br/>
   false,                     // double the size when rotating?
<br/>
   false,                     // hide the sprite?
<br/>
   false,                     // horizontal flip?
<br/>
   false,                     // vertical flip?
<br/>
   false);                     // mosaic?</td> </tr></table><span class="postbody"><br/>_________________<br/><a class="postlink" href="http://headsoft.com.au/index.php?category=warhawk" target="_blank">Warhawk DS</a> | <a class="postlink" href="http://headsoft.com.au/index.php?category=mmll" target="_blank">Manic Miner: The Lost Levels</a> | <a class="postlink" href="http://headsoft.com.au/index.php?category=tdg" target="_blank">The Detective Game</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170121 - sverx - Tue Sep 01, 2009 8:49 am</h4>
    <div class="postbody"><span class="postbody">if you're using a bitmap object (a 32k colors sprite) then check this:
<br/>
<br/>
<a href="http://nocash.emubase.de/gbatek.htm#dsvideoobjs" target="_blank">http://nocash.emubase.de/gbatek.htm#dsvideoobjs</a>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">OBJ Attribute 0 and 2
<br/>
Setting the OBJ Mode bits (Attr 0, Bit10-11) to a value of 3 has been prohibited in GBA, however, in NDS it selects the the new Bitmap OBJ mode; in that mode, the Color depth bit (Attr 0, Bit13) should be set to zero; also in that mode, the color bits (Attr 2, Bit 12-15) are used as Alpha-OAM value (instead of as palette setting).</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170123 - headspin - Tue Sep 01, 2009 12:51 pm</h4>
    <div class="postbody"><span class="postbody">I did read that on GBATek but nothing seems to be working. I am using libnds so I want to do things the "libnds" way and that is use their helper functions as much as possible rather than hitting the registers directly.
<br/>
<br/>
I've looked at the bitmap_sprite example from libnds and although it seems to be setting an alpha value the sprites do not appear alpha blended. When I can't even get the example working (both in No$GBA and hardware although No$GBA fails to rotate the sprite as well) I don't have much hope for it working in my own game.
<br/>
<br/>
Please can someone show me a working example of alpha blending a single sprite using the latest libnds.<br/>_________________<br/><a class="postlink" href="http://headsoft.com.au/index.php?category=warhawk" target="_blank">Warhawk DS</a> | <a class="postlink" href="http://headsoft.com.au/index.php?category=mmll" target="_blank">Manic Miner: The Lost Levels</a> | <a class="postlink" href="http://headsoft.com.au/index.php?category=tdg" target="_blank">The Detective Game</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170126 - sverx - Tue Sep 01, 2009 2:14 pm</h4>
    <div class="postbody"><span class="postbody">I never used bitmap objects before, I'm coding an example that uses them with alpha blending, no luck on no$gba at the moment... :|
<br/>
<br/>
btw blending a regular sprite (256 colors) works...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170127 - headspin - Tue Sep 01, 2009 2:41 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>sverx wrote:</b></span></td> </tr> <tr> <td class="quote">btw blending a regular sprite (256 colors) works...</td> </tr></table><span class="postbody">
<br/>
<br/>
Really? I can get all the sprites to alpha blend using the blend registers (REG_BLDCNT / REG_BLDALPHA) but not a single sprite. I'm happy to use 256 color sprites if I can have one blended out. If you can show me an example of how to do it that would be great.
<br/>
<br/>
Appreciate your help :)<br/>_________________<br/><a class="postlink" href="http://headsoft.com.au/index.php?category=warhawk" target="_blank">Warhawk DS</a> | <a class="postlink" href="http://headsoft.com.au/index.php?category=mmll" target="_blank">Manic Miner: The Lost Levels</a> | <a class="postlink" href="http://headsoft.com.au/index.php?category=tdg" target="_blank">The Detective Game</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170128 - headspin - Tue Sep 01, 2009 3:52 pm</h4>
    <div class="postbody"><span class="postbody">Turns out there is a bug in the No$GBA emulator. When I ran this on hardware it works fine. Just a few tips for others who want to achive per sprite alpha blending.
<br/>
<br/>
1. You have to turn on alpha blending for REG_BLDCNT (BLEND_ALPHA)
<br/>
2. You must use bitmap sprites for per sprite alpha blending
<br/>
3. BLEND_SRC_SPRITE is not required and REG_BLDALPHA is ignored when using bitmap sprites. Use the alpha value for each oam entry instead
<br/>
4. Overlapping two alpha blended sprites only shows the background
<br/>
5. You won't see the result in No$ so run it on hardware<br/>_________________<br/><a class="postlink" href="http://headsoft.com.au/index.php?category=warhawk" target="_blank">Warhawk DS</a> | <a class="postlink" href="http://headsoft.com.au/index.php?category=mmll" target="_blank">Manic Miner: The Lost Levels</a> | <a class="postlink" href="http://headsoft.com.au/index.php?category=tdg" target="_blank">The Detective Game</a></span><span class="gensmall"><br/><br/>Last edited by headspin on Tue Sep 01, 2009 4:14 pm; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#170129 - gauauu - Tue Sep 01, 2009 4:01 pm</h4>
    <div class="postbody"><span class="postbody">Heh, I wish I had remembered that I had had that same trouble also about a year ago, I could've saved you some time.  But I didn't remember till you had said so...(I mention it at the bottom of this post <a class="postlink" href="http://anguna-dev.blogspot.com/2008/09/update-on-bugs.html" target="_blank">http://anguna-dev.blogspot.com/2008/09/update-on-bugs.html</a>)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170130 - headspin - Tue Sep 01, 2009 4:24 pm</h4>
    <div class="postbody"><span class="postbody">I rely on No$ quite alot and this demonstrates you should always test on hardware every so often. No$ does a damn good job though.
<br/>
<br/>
My only problem now is that my fading in and out of black between screens the sprites are not effected by the fading.
<br/>
<br/>
I am using 
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">REG_BLDCNT_SUB = BLEND_FADE_BLACK | BLEND_ALPHA | BLEND_SRC_BG2 | BLEND_SRC_BG3 | BLEND_SRC_SPRITE | BLEND_DST_BG2 | BLEND_DST_BG3;</td> </tr></table><span class="postbody">
<br/>
<br/>
But it seems like the alpha value for each oam entry overrides the REG_BLDY_SUB value so sprites won't fade in and out of black.
<br/>
<br/>
The only solution to this I can see is to loop through oam and set each alpha value to be the fade value and they will fade in and out of black like everything else.<br/>_________________<br/><a class="postlink" href="http://headsoft.com.au/index.php?category=warhawk" target="_blank">Warhawk DS</a> | <a class="postlink" href="http://headsoft.com.au/index.php?category=mmll" target="_blank">Manic Miner: The Lost Levels</a> | <a class="postlink" href="http://headsoft.com.au/index.php?category=tdg" target="_blank">The Detective Game</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170137 - sverx - Wed Sep 02, 2009 8:35 am</h4>
    <div class="postbody"><span class="postbody">I did some more tests yesterday evening, and I'm quite confident now I've found how it works. I'm posting it here for completeness :)
<br/>
<br/>
- You have to set the ATTR0_TYPE_BLENDED in the OAM for the sprite(s) you want to alpha blend
<br/>
- You have to set in the REG_BLDCNT[_SUB] the flags of the <span style="font-weight: bold">DST</span> backgrounds and/or backdrop you want your sprite(s) to blend with (ex: REG_BLDCNT = BLEND_DST_BG1 | BLEND_DST_BG2 | BLEND_DST_BG0 | BLEND_DST_BACKDROP; )
<br/>
- You have to set REG_BLDALPHA[_SUB] according to 'how' you would like to 'add' the components.
<br/>
- You <span style="font-weight: bold">don't need</span> to activate a special effect (ex: BLEND_ALPHA). But you can do it, of course. But you also should be able to use another special effect and still have semi-transparent sprites. (There are some limitations, btw...)
<br/>
- You <span style="font-weight: bold">don't need</span> to activate BLEND_SRC_SPRITE flag in the REG_BLDCNT[_SUB]. If you do this and if you activate also the BLEND_ALPHA mode then you'll have ALL your sprites blending, not only those marked with ATTR0_TYPE_BLENDED.
<br/>
<br/>
no$gba fails in showing this behaviour, but it works perfectly on hardware. This morning I tried with some other emulators and I found that <a class="postlink" href="http://www.ideasemu.org/" target="_blank">iDeaS</a> (I'm using ver. 1.0.3.0) does render that feature correctly. My tests were done with 256 colors sprites, but I believe the effect is the same with 16 color sprites and also with bitmap objects (but in this case I think the value in REG_BLDALPHA will be -at least partially- ignored)
<br/>
<br/>
Hope it helps.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170138 - sverx - Wed Sep 02, 2009 8:39 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>headspin wrote:</b></span></td> </tr> <tr> <td class="quote">My only problem now is that my fading in and out of black between screens the sprites are not effected by the fading.</td> </tr></table><span class="postbody">
<br/>
<br/>
Maybe you could remove the ATTR0_TYPE_BLENDED attribute from the sprites when fading in/out. This way those sprites won't be blending and then they would fade just like everything else. Don't know if it fits your needs, just an idea...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#171181 - grapeape - Wed Nov 04, 2009 6:42 pm</h4>
    <div class="postbody"><span class="postbody">Hey guys.  I'm trying to blend some 256 color paletted (not bmp) sprites with bg3.  I set up the blend with:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
REG_BLDCNT_SUB = BLEND_ALPHA | BLEND_DST_BG3 | BLEND_SRC_SPRITE;
<br/>
REG_BLDALPHA = 0x1010;
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
oamSet() doesn't seem to allow me to set the attribute field, so just before oamSet, I call:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
oamMain.oamMemory[id].attribute[0] = ATTR0_TYPE_BLENDED;
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Where id is the sprite index.  Still no joy.  I'm using ideas v1.0.3.0 to test.  Sverx, do you have an example that defintely works with this emu that you could post?  
<br/>
<br/>
Cheers,
<br/>
J</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#171182 - Exophase - Wed Nov 04, 2009 8:56 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>headspin wrote:</b></span></td> </tr> <tr> <td class="quote">My only problem now is that my fading in and out of black between screens the sprites are not effected by the fading.
<br/>
<br/>
I am using 
<br/>
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">REG_BLDCNT_SUB = BLEND_FADE_BLACK | BLEND_ALPHA | BLEND_SRC_BG2 | BLEND_SRC_BG3 | BLEND_SRC_SPRITE | BLEND_DST_BG2 | BLEND_DST_BG3;</td> </tr></table><span class="postbody">
<br/>
<br/>
But it seems like the alpha value for each oam entry overrides the REG_BLDY_SUB value so sprites won't fade in and out of black.
<br/>
<br/>
The only solution to this I can see is to loop through oam and set each alpha value to be the fade value and they will fade in and out of black like everything else.</span></td> </tr></table><span class="postbody">
<br/>
<br/>
Indeed bitmap sprites with alpha &lt; 0xF and &gt; 0x0 or translucent mode will always blend regardless of blend mode. I think that also applies to 3D with final alpha &lt; 0x1F and &gt; 0x0.
<br/>
<br/>
Try using the master brightness control to fade to/from black instead, that's what it's there for.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#171188 - sverx - Thu Nov 05, 2009 9:09 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>grapeape wrote:</b></span></td> </tr> <tr> <td class="quote">Sverx, do you have an example that defintely works with this emu that you could post?</td> </tr></table><span class="postbody">
<br/>
<br/>
I'm doing this (I'm using Sub engine and ext palettes)
<br/>
<br/>
The video mode:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">videoSetModeSub(MODE_0_2D | DISPLAY_BG0_ACTIVE | DISPLAY_BG2_ACTIVE | DISPLAY_BG1_ACTIVE | DISPLAY_BG_EXT_PALETTE | DISPLAY_SPR_ACTIVE | DISPLAY_SPR_2D | DISPLAY_SPR_EXT_PALETTE);</td> </tr></table><span class="postbody">
<br/>
<br/>
The blending:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">   // blending
<br/>
   REG_BLDCNT_SUB = BLEND_DST_BG1 | BLEND_DST_BG2 | BLEND_DST_BG0 | BLEND_DST_BACKDROP;
<br/>
    REG_BLDALPHA_SUB = 0x04 | ( 0x04 &lt;&lt;  8 );   // valori in sedicesimi...</td> </tr></table><span class="postbody">
<br/>
<br/>
The blended sprite:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">   SubSpriteCTRL-&gt;Sprite[6].y_attrib_0= ATTR0_TYPE_BLENDED | ATTR0_SQUARE | ATTR0_COLOR_256 | OBJ_Y(60);   // 256 colori
<br/>
   SubSpriteCTRL-&gt;Sprite[6].x_attrib_1= ATTR1_SIZE_64 | OBJ_X(10);                     // normale 8*8
<br/>
   SubSpriteCTRL-&gt;Sprite[6].attrib_2 = TILE256(48) | ATTR2_PALETTE(2) | ATTR2_PRIORITY(2); // tile, priority, palette</td> </tr></table><span class="postbody">
<br/>
<br/>
sorry the code is quite messy, it's taken directly from my code. Sorry I can't post the whole code or a demo at the moment :|
<br/>
<br/>
Hope it helps :)</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
