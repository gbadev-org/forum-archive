<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>FAT library / SaTa's version - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > FAT library / SaTa's version</h2>
<div id="posts">
<div class="post">
    <h4>#80178 - melw - Wed Apr 19, 2006 3:38 pm</h4>
    <div class="postbody"><span class="postbody">Ok, I feel a bit stupid asking this but after playing around with an hour or so and not finding a solution I decided to ask here. The problem: Official Chishm FAT library doesn't support SCSD/M3SD but RAIN v14 has a modified version of the library with asm implementation for these cards. However, when I try to use the SaTa's version I can't get the functions residing in the .s files to link. Compiling goes all ok, but in the linking phase I get the following error (example of what happens compiling only with M3SD support):
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
arm-elf-g++ -g -mthumb-interwork -mno-fpu -specs=ds_arm9.specs main.o io_m3sd_asm.o -Lc:/devkitpro/libnds/lib -lnds9 -o rm9.elf
<br/>
main.o: In function `M3SD_write1sector(unsigned int, unsigned int)':
<br/>
c:/devkitpro/libnds/include/gba_nds_fat/io_m3sd.c:189: undefined reference to `SD_crc16(unsigned short*, unsigned short, unsigned short*)'
<br/>
c:/devkitpro/libnds/include/gba_nds_fat/io_m3sd.c:190: undefined reference to `SD_data_write(unsigned short*, unsigned short*)'
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I can get Rain v14 to compile and link without the same problem so I assume there's just something I've forgotten to do in my own project - however having nearly zero experience what comes to using asm files I don't know what would solve the broken references in this case...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#80191 - linus - Wed Apr 19, 2006 8:45 pm</h4>
    <div class="postbody"><span class="postbody">Is it a problem with your make file? Try using one of the make files from the ndslib or palib examples, theyre pretty versatile and include .s files for me (and ive even compiled that version of fat using them).
<br/>
<br/>
Good luck.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#80232 - melw - Thu Apr 20, 2006 10:11 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>linus wrote:</b></span></td> </tr> <tr> <td class="quote">Is it a problem with your make file?</td> </tr></table><span class="postbody">
<br/>
<br/>
Well, I'm not using makefile's at all with this. :) As an answer why is that - the same codebase/engine is used for multiple platforms, not just DS and it was easier to go without one. Otherwise the way I've implemented the FAT support is the same as HyperHacker's solution in <a class="postlink" href="http://forum.gbadev.org/viewtopic.php?t=8316" target="_blank">this post</a>, i.e. put the FAT lib under libnds/include and then include separately all needed files in the code.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#80233 - Mighty Max - Thu Apr 20, 2006 10:24 am</h4>
    <div class="postbody"><span class="postbody">In this case: Did the build from the .s return any errors then? &amp; does the io_m3sd_asm.o even exist?
<br/>
<br/>
(It's compiling-lines are missing in your [code] block)<br/>_________________<br/><a class="postlink" href="http://mightymax.org/gbamp_multiboot.html" target="_blank">GBAMP Multiboot</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#80235 - melw - Thu Apr 20, 2006 11:09 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Mighty Max wrote:</b></span></td> </tr> <tr> <td class="quote">In this case: Did the build from the .s return any errors then? &amp; does the io_m3sd_asm.o even exist?</td> </tr></table><span class="postbody">
<br/>
<br/>
Yes, the compiling of the .s should be fine, no errors there. Also the io_m3sd_asm.o exists in the build directory after compiling... Here's a bit more what's happening on the command line:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#asm 
<br/>
arm-elf-gcc -MM -g -Wall -O2 -mcpu=arm9tdmi -mtune=arm9tdmi -fomit-frame-pointer -ffast-math -mthumb-interwork -Ic:/devkitpro/libnds/include -DARM9 -DFPM_ARM -DOPT_ACCURACY -DROMVER=\"\" -o tmp\build\io_m3sd_asm.d c:\devkitpro\libnds\include\gba_nds_fat\io_m3sd_asm.s
<br/>
arm-elf-gcc  -g -mthumb-interwork -c c:\devkitpro\libnds\include\gba_nds_fat\io_m3sd_asm.s -otmp\build\io_m3sd_asm.o
<br/>
<br/>
#arm9 main
<br/>
arm-elf-g++ -g --no-warnings -Wall -Os -mcpu=arm9tdmi -mtune=arm9tdmi -fomit-frame-pointer -ffast-math -mthumb-interwork -Ic:/devkitpro/libnds/include -DARM9 -c tmp\tmpsrc\main.c -otmp\build\main.o
<br/>
arm-elf-g++ -g -mthumb-interwork -mno-fpu -specs=ds_arm9.specs tmp\build\main.o tmp\build\io_m3sd_asm.o -Lc:/devkitpro/libnds/lib -lnds9 -otmp\arm9.elf
<br/>
tmp\build\main.o: In function `M3SD_write1sector(unsigned int, unsigned int)':
<br/>
c:/devkitpro/libnds/include/gba_nds_fat/io_m3sd.c:189: undefined reference to `SD_crc16(unsigned short*, unsigned short, unsigned short*)'
<br/>
c:/devkitpro/libnds/include/gba_nds_fat/io_m3sd.c:190: undefined reference to `SD_data_write(unsigned short*, unsigned short*)'
<br/>
collect2: ld returned 1 exit status
<br/>
arm-elf-objcopy -O binary tmp\arm9.elf tmp\arm9.bin
<br/>
arm-elf-objcopy: 'tmp\arm9.elf': No such file
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
One thing I noticed also is that in the build directory there's no io_m3sd_asm.d - although this seems to be the case also when compiling RAIN.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#80255 - josath - Thu Apr 20, 2006 6:15 pm</h4>
    <div class="postbody"><span class="postbody">The fat lib has many .c files...how come none of them are listed in the link command? I only see main.o and io_m3sd_asm.o for some reason. 
<br/>
<br/>
For example, my link command looks like:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">arm-elf-g++  -specs=ds_arm9.specs -g -mthumb-interwork -mno-fpu -Wl,-Map,.map  main.o msg.o disc_io.o gba_nds_fat.o io_efa2.o io_fcsr.o io_m3cf.o io_m3sd.o io_mpcf.o io_nmmc.o io_sccf.o io_scsd.o io_m3sd_asm.o io_scsd_asm.o -L/home/davidr/ds/devkitarm//libnds/lib -lnds9 -lpng -lz -o /lvm/shared/ds/ds/Draw3/arm9/Draw3.arm9.elf</td> </tr></table><span class="postbody">
<br/>
Everything from disc_io.o to io_m3sd_asm.o is part of the fat lib.
<br/>
Are you using one of the makefiles that came with devkitarm/libnds?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#80261 - Mighty Max - Thu Apr 20, 2006 6:34 pm</h4>
    <div class="postbody"><span class="postbody">Erm, now that i see this, you compile them using g++? did you &gt;&gt;extern "C"&lt;&lt; them then? they are normally included from an as c treated and not cpp treated file. .s exports globals via their real and not as cpp expects encoded name.<br/>_________________<br/><a class="postlink" href="http://mightymax.org/gbamp_multiboot.html" target="_blank">GBAMP Multiboot</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#80264 - melw - Thu Apr 20, 2006 8:18 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Mighty Max wrote:</b></span></td> </tr> <tr> <td class="quote">Erm, now that i see this, you compile them using g++? did you &gt;&gt;extern "C"&lt;&lt; them then? they are normally included from an as c treated and not cpp treated file. .s exports globals via their real and not as cpp expects encoded name.</td> </tr></table><span class="postbody">
<br/>
<br/>
Ok, that was it! I feel truly stupid now, should've realized that myself as well. :) Don't have a M3SD to test with over here, but at least after declaring the assembler functions as extern "C"'s everything compiles without errors - will check tomorrow if it really works or not. 
<br/>
<br/>
Thanks, everyone for the help!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#80265 - melw - Thu Apr 20, 2006 8:26 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>josath wrote:</b></span></td> </tr> <tr> <td class="quote">The fat lib has many .c files...how come none of them are listed in the link command? I only see main.o and io_m3sd_asm.o for some reason.</td> </tr></table><span class="postbody">
<br/>
<br/>
That's because the library files are included in the code (see link to HyperHacker's post). Only the asm implementation for M3SD and SCSD can't be included the same way.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
