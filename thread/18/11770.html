<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>problem using kosf - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > problem using kosf</h2>
<div id="posts">
<div class="post">
    <h4>#109829 - Xgame - Tue Nov 21, 2006 4:23 pm</h4>
    <div class="postbody"><span class="postbody">I am trining to use kosfs, but, after putting the libs in the example, i can't compile it. I have also created the .img file, but i don't know how to include it. 
<br/>
please help me
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
C:\devkitPro\kosf\fstest&gt;make
<br/>
fstest.c
<br/>
arm-eabi-gcc -MMD -MP -MF /c/devkitPro/kosf/fstest/build/fstest.d -g -Wall -O2 -
<br/>
mcpu=arm9tdmi -mtune=arm9tdmi -fomit-frame-pointer -ffast-math -mthumb-interwork
<br/>
  -I/c/devkitPro/kosf/fstest/kos -I/c/devkitPro/libnds/include -I/c/devkitPro/li
<br/>
bnds/include -I/c/devkitPro/kosf/fstest/build -DARM9  -c /c/devkitPro/kosf/fstes
<br/>
t/source/fstest.c -o fstest.o
<br/>
c:/devkitPro/kosf/fstest/source/fstest.c:12:26: error: romdisk_img.h: No such fi
<br/>
le or directory
<br/>
c:/devkitPro/kosf/fstest/source/fstest.c: In function 'fs_test':
<br/>
c:/devkitPro/kosf/fstest/source/fstest.c:38: warning: implicit declaration of fu
<br/>
nction 'malloc'
<br/>
c:/devkitPro/kosf/fstest/source/fstest.c:38: warning: incompatible implicit decl
<br/>
aration of built-in function 'malloc'
<br/>
c:/devkitPro/kosf/fstest/source/fstest.c:39: warning: implicit declaration of fu
<br/>
nction 'exit'
<br/>
c:/devkitPro/kosf/fstest/source/fstest.c:39: warning: incompatible implicit decl
<br/>
aration of built-in function 'exit'
<br/>
c:/devkitPro/kosf/fstest/source/fstest.c:49: warning: format '%s' expects type '
<br/>
char *', but argument 2 has type 'int'
<br/>
c:/devkitPro/kosf/fstest/source/fstest.c:54: warning: format '%s' expects type '
<br/>
char *', but argument 2 has type 'int'
<br/>
c:/devkitPro/kosf/fstest/source/fstest.c:25: warning: unused variable 'i'
<br/>
c:/devkitPro/kosf/fstest/source/fstest.c:25: warning: unused variable 'n'
<br/>
c:/devkitPro/kosf/fstest/source/fstest.c:24: warning: unused variable 'c'
<br/>
c:/devkitPro/kosf/fstest/source/fstest.c:23: warning: unused variable 'wFile'
<br/>
c:/devkitPro/kosf/fstest/source/fstest.c: In function 'InitInterrupts':
<br/>
c:/devkitPro/kosf/fstest/source/fstest.c:159: error: 'DISP_SR' undeclared (first
<br/>
 use in this function)
<br/>
c:/devkitPro/kosf/fstest/source/fstest.c:159: error: (Each undeclared identifier
<br/>
 is reported only once
<br/>
c:/devkitPro/kosf/fstest/source/fstest.c:159: error: for each function it appear
<br/>
s in.)
<br/>
c:/devkitPro/kosf/fstest/source/fstest.c: In function 'main':
<br/>
c:/devkitPro/kosf/fstest/source/fstest.c:186: warning: implicit declaration of f
<br/>
unction 'find_first_romfs_file'
<br/>
make[1]: *** [fstest.o] Error 1
<br/>
make: *** [build] Error 2
<br/>
<br/>
C:\devkitPro\kosf\fstest&gt;
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
the image is called "romdisk.img" and i put it in "Source", "romdisk" and "data". i think something in makefile is wrong, but i don't know what.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#109832 - GPFerror - Tue Nov 21, 2006 4:47 pm</h4>
    <div class="postbody"><span class="postbody">the latest version of that on my site was built for a older version of the devkitpro setup.
<br/>
<br/>
in the fstest.c include section at top
<br/>
add
<br/>
#include &lt;nds/registers_alt.h&gt;
<br/>
<br/>
that will fix the 'DISP_SR' undeclared or you can change it to whatever the newer libnds calls it.
<br/>
<br/>
in the version on my site I have 
<br/>
//#include "romdisk_img.h" 
<br/>
commented out, since the example looks for the romdisk.img appended to the end of the nds file.
<br/>
<br/>
Maybe you have an old version from somewhere?
<br/>
<a class="postlink" href="http://gpf.dcemu.co.uk/ndsromdisk.shtml" target="_blank">http://gpf.dcemu.co.uk/ndsromdisk.shtml</a> is where I released it.
<br/>
<br/>
TheLazy1 has been working on an updated version which uses the latest devkitpro which has a hook for newlib - using devoptab_t .  This allow for using stdio function directly. 
<br/>
<br/>
Troy(GPF)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#109836 - Xgame - Tue Nov 21, 2006 5:28 pm</h4>
    <div class="postbody"><span class="postbody">yes, I have that version. but if I comment #include "romdisk_img.h" how can I load it?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#109844 - GPFerror - Tue Nov 21, 2006 6:17 pm</h4>
    <div class="postbody"><span class="postbody">the end of the Makefile
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">romdisk.img:
<br/>
   genromfs -f ../romdisk.img -d ../romdisk -v
<br/>
   padbin 0x100 $(OUTPUT).nds
<br/>
   cat $(OUTPUT).nds ../romdisk.img  &gt; $(OUTPUT)_tmp.nds</td> </tr></table><span class="postbody">
<br/>
<br/>
generates the romdisk.img, pads the nds file and then concats it to the end of the nds file.
<br/>
<br/>
If you want to embedded the romdisk.img you would use the include line, but you need to have the Makefile generate an embeddable object with bin2s, which would create the romdisk_img.h file automatically.
<br/>
<br/>
Troy(GPF)
<br/>
<a href="http://gpf.dcemu.co.uk" target="_blank">http://gpf.dcemu.co.uk</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#109846 - Cthulhu - Tue Nov 21, 2006 6:22 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>GPFerror wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
TheLazy1 has been working on an updated version which uses the latest devkitpro which has a hook for newlib - using devoptab_t .  This allow for using stdio function directly. 
<br/>
<br/>
Troy(GPF)</td> </tr></table><span class="postbody">
<br/>
<br/>
Where can i get that version?
<br/>
<br/>
And another question, i've been trying this FS and works great, but i have a problem (maybe because i used an emulator to run the program), when i try to read an unsigned char after an unsigned short, the char info is wrong, don't know if it is because the byte alignment (its not aligned to 4) or its an emulator thing... this happens always, i can fseek whatever position in the file and the unsigned char always have wrong info :S</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#109848 - Lazy1 - Tue Nov 21, 2006 6:37 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Cthulhu wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>GPFerror wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
TheLazy1 has been working on an updated version which uses the latest devkitpro which has a hook for newlib - using devoptab_t .  This allow for using stdio function directly. 
<br/>
<br/>
Troy(GPF)</td> </tr></table><span class="postbody">
<br/>
<br/>
Where can i get that version?
<br/>
</span></td> </tr></table><span class="postbody">
<br/>
<br/>
There is no official release, I just made some modifications to the library and sent those off to GPF.
<br/>
If you want I can give you the changes needed to allow using standard I/O functions.
<br/>
<br/>
[Slightly off topic]
<br/>
Is there any way to get the arm9 start address and size?
<br/>
If I can get those numbers it will be possible for gbamp/wmb users to append a romdisk to the arm9 binary.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#109852 - tepples - Tue Nov 21, 2006 7:26 pm</h4>
    <div class="postbody"><span class="postbody">Sure, you can append the datafile to the ARM9. This worked until devkitPro R12 or thereabouts, when the DS linker script was changed to start the BSS and heap immediately after the ARM9 binary and will overwrite any appended file when zeroing BSS. (We're on R19b now.) I'd guess that the most reliable method is to make an empty 1 MB file with a known content, use bin2s to link that into the ARM9 binary, and at the artist's side, replace that file with your romdisk.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#109854 - Cthulhu - Tue Nov 21, 2006 8:08 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Lazy1 wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
If you want I can give you the changes needed to allow using standard I/O functions.
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Yes, please :D
<br/>
<br/>
By the way, is there some type of size limit in the romdisk?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#109855 - Lazy1 - Tue Nov 21, 2006 8:21 pm</h4>
    <div class="postbody"><span class="postbody">Add this to the bottom of fs_romdisk.c:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
/* RomdiskFS newlib integration code
<br/>
 * 2006 - TheLazy1 (lazyone.drunkencoders.com)
<br/>
 *
<br/>
 * Thanks to: Chishm for libfat which I referenced to get this working.
<br/>
*/
<br/>
<br/>
<br/>
static int romfs_open( struct _reent* r, void* fileStruct, const char* path, int flags, int mode ) {
<br/>
   int fileHandle = -1;
<br/>
   int openFlags = 0;
<br/>
<br/>
   /* ( flags &amp; O_WRONLY ) return -1;
<br/>
   if ( flags &amp; O_RDWR ) return -1;
<br/>
   if ( flags &amp; O_APPEND ) return -1;
<br/>
   if ( flags &amp; O_CREAT ) return -1;
<br/>
   if ( flags &amp; O_EXCL ) return -1;
<br/>
   if ( flags &amp; O_TRUNC ) return -1;
<br/>
   */
<br/>
<br/>
   if (    ( flags &amp; O_WRONLY )    ||
<br/>
      ( flags &amp; O_RDWR )   ||
<br/>
      ( flags &amp; O_APPEND )   ||
<br/>
      ( flags &amp; O_CREAT )   ||
<br/>
      ( flags &amp; O_EXCL )      ||
<br/>
      ( flags &amp; O_TRUNC ) ) 
<br/>
   {
<br/>
      r-&gt;_errno = EROFS;
<br/>
      return -1;
<br/>
   }
<br/>
<br/>
   if ( flags &amp; O_RDONLY ) openFlags |= O_RDONLY;
<br/>
<br/>
   fileHandle = fs_open( path, openFlags );
<br/>
   *( ( int* ) fileStruct ) = fileHandle;
<br/>
<br/>
   if ( fileHandle == -1 ) {
<br/>
      r-&gt;_errno = ENOENT;
<br/>
   }
<br/>
<br/>
   return fileHandle;
<br/>
}
<br/>
<br/>
static int romfs_close( struct _reent* r, int fd ) {
<br/>
   fs_close( *( ( int* ) fd ) );
<br/>
   return 1;
<br/>
}
<br/>
<br/>
static int romfs_write( struct _reent* r, int fd, const char* ptr, int len ) {
<br/>
   r-&gt;_errno = EROFS;
<br/>
   return -1;
<br/>
}
<br/>
<br/>
static int romfs_read( struct _reent* r, int fd, char* ptr, int len ) {
<br/>
   return fs_read( *( ( int* ) fd ), ptr, len );
<br/>
}
<br/>
<br/>
static int romfs_seek( struct _reent* r, int fd, int pos, int dir ) {
<br/>
   return fs_seek( *( ( int* ) fd ), pos, dir );
<br/>
}
<br/>
<br/>
static int romfs_fstat( struct _reent* r, int fd, struct stat* st ) {
<br/>
   r-&gt;_errno = ENOSYS;
<br/>
   return -1;
<br/>
}
<br/>
<br/>
static int romfs_stat( struct _reent* r, const char* file, struct stat* st ) {
<br/>
   r-&gt;_errno = ENOSYS;
<br/>
   return -1;
<br/>
}
<br/>
<br/>
static int romfs_link( struct _reent* r, const char* existing, const char* new ) {
<br/>
   r-&gt;_errno = EROFS;
<br/>
   return -1;
<br/>
}
<br/>
<br/>
static int romfs_unlink( struct _reent* r, const char* name ) {
<br/>
   r-&gt;_errno = EROFS;
<br/>
   return -1;
<br/>
}
<br/>
<br/>
static int romfs_chdir( struct _reent* r, const char* name ) {
<br/>
   r-&gt;_errno = ENOSYS;
<br/>
   return -1;
<br/>
}
<br/>
<br/>
static const devoptab_t romfsIO = {
<br/>
   "romfs",
<br/>
   4,
<br/>
   &amp;romfs_open,
<br/>
   &amp;romfs_close,
<br/>
   &amp;romfs_write,
<br/>
   &amp;romfs_read,
<br/>
   &amp;romfs_seek,
<br/>
   &amp;romfs_fstat,
<br/>
   &amp;romfs_stat,
<br/>
   &amp;romfs_link,
<br/>
   &amp;romfs_unlink,
<br/>
   &amp;romfs_chdir
<br/>
};
<br/>
<br/>
int romfsInit( int searchAddress, const char* mountPoint ) {
<br/>
   const u8* romfsBase = NULL;
<br/>
<br/>
   sysSetCartOwner( true );
<br/>
<br/>
   if ( ( romfsBase = ( const u8* ) find_first_romfs_file( ( const void* ) searchAddress ) ) != NULL ) {
<br/>
      fs_romdisk_init( );
<br/>
      fs_romdisk_mount( mountPoint, romfsBase, 0 );
<br/>
<br/>
      AddDevice( &amp;romfsIO );
<br/>
      setDefaultDevice( FindDevice( "romfs:" ) );
<br/>
<br/>
      return 1;
<br/>
   }
<br/>
<br/>
   return 0;
<br/>
}
<br/>
<br/>
int romfsInitDefault( void ) {
<br/>
   return romfsInit( 0x08000000, "/" );
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Add this to the bottom of fs_romdisk.h:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
/* Initialize romfs, start looking for the romdisk at "searchAddress" */
<br/>
int romfsInit( int searchAddress, const char* mountPoint );
<br/>
<br/>
/* Initializes romfs, looks for the romdisk starting at 0x08000000 */
<br/>
int romfsInitDefault( void );
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
As you can see a few functions are not implemented, but last I checked this code works fine.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#114249 - GPFerror - Fri Jan 05, 2007 8:55 pm</h4>
    <div class="postbody"><span class="postbody">I have added TheLazyOne's newlib changes to the code and lib on my site
<br/>
<br/>
<a href="http://gpf.dcemu.co.uk/ndsromdisk.shtml" target="_blank">http://gpf.dcemu.co.uk/ndsromdisk.shtml</a>
<br/>
<br/>
Troy(GPF)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#114323 - Payk - Sat Jan 06, 2007 5:50 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">By the way, is there some type of size limit in the romdisk?</td> </tr></table><span class="postbody">
<br/>
Yes sure. It uese the GBA-ROMSPACE. The gba games had max. 32MB so same for KOSFS as long as you attach file at the end of the rom. Otherwhise you will just have the 4MB main ram for datas and code. But 32MB is quite enough for homebrew...</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
