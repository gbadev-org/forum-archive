<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Slot-2 RAM Library - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>DS development > Slot-2 RAM Library</h2>
<div id="posts">
<div class="post">
    <h4>#125614 - Lazy1 - Sun Apr 15, 2007 2:54 am</h4>
    <div class="postbody"><span class="postbody">I am currently writing a library for using the ram found on some slot-2 cards.
<br/>
My idea was to make one library to support all current and future cards, thats where a script file like this comes in.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
(libextmem)
<br/>
<br/>
device=Supercard CF
<br/>
size=0x02000000
<br/>
base=0x08000000
<br/>
<br/>
fn set_ram
<br/>
   write16( 0x09FFFFFE, 0xA55A )
<br/>
   write16( 0x09FFFFFE, 0xA55A )
<br/>
   write16( 0x09FFFFFE, 0x0005 )
<br/>
   write16( 0x09FFFFFE, 0x0005 )
<br/>
efn
<br/>
<br/>
fn set_disk
<br/>
   write16( 0x09FFFFFE, 0xA55A )
<br/>
   write16( 0x09FFFFFE, 0xA55A )
<br/>
   write16( 0x09FFFFFE, 0x0003 )
<br/>
   write16( 0x09FFFFFE, 0x0003 )
<br/>
efn
<br/>
<br/>
fn set_disable
<br/>
   brk
<br/>
efn
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
That script would be placed in the root of your media device as "memdrv.txt' and would be read and compiled once you initialize libextmem.
<br/>
<br/>
The script's program sections are compiled into read/write 8/16/32 instructions for a tiny virtual machine which will execute them whenever you want to set the cart to ram mode, disk mode or disabled.
<br/>
<br/>
The basic API will probably be just an init function and some functions to get the cart name, size and base address.
<br/>
New carts can be supported by writing a driver script and dropping it into memdrv.txt in the root of your media device.
<br/>
<br/>
Any thoughts/ideas/suggestions?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#125615 - stampede_dude - Sun Apr 15, 2007 2:56 am</h4>
    <div class="postbody"><span class="postbody">That would be awesome if someone ever gets a web browser working for the DS that is homebrew.<br/>_________________<br/>867-530<span style="font-weight: bold">9</span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#125617 - chishm - Sun Apr 15, 2007 3:52 am</h4>
    <div class="postbody"><span class="postbody">You could just use compiled ARM code, with offset pointers in the header of the file. If you assume that the code is completely self contained, with each function (like set_ram, set_disk, etc.) having its own block of code, you can simply load it into memory, then use a bit of ASM magic to BLX to it.<br/>_________________<br/><a class="postlink" href="http://chishm.drunkencoders.com" target="_blank">http://chishm.drunkencoders.com</a>
<br/>
<a class="postlink" href="http://dldi.drunkencoders.com" target="_blank">http://dldi.drunkencoders.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#125621 - Lazy1 - Sun Apr 15, 2007 4:42 am</h4>
    <div class="postbody"><span class="postbody">I wanted to keep things simple (except the script compiler which is huge and continues to grow in size) so that making and debugging ram drivers would be easier.
<br/>
<br/>
Besides, I doubt any applications would swap modes fast enough to notice any performance hit vs native code especially since the vm is extremely simple.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#125623 - HyperHacker - Sun Apr 15, 2007 5:20 am</h4>
    <div class="postbody"><span class="postbody">A script parser is going to inflate the executable though, which could be an issue for games that already take up a fair bit of the available 4MB.
<br/>
<br/>
It's nice to see this being done though. Will it support other things, such as rumble and motion sensors?<br/>_________________<br/>I'm a PSP hacker now, but I still &lt;3 DS.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#125624 - chishm - Sun Apr 15, 2007 5:22 am</h4>
    <div class="postbody"><span class="postbody">Fair enough. I was just thinking that native ARM code is easier to execute, doesn't require a VM, and supports mathematical operations and looping.<br/>_________________<br/><a class="postlink" href="http://chishm.drunkencoders.com" target="_blank">http://chishm.drunkencoders.com</a>
<br/>
<a class="postlink" href="http://dldi.drunkencoders.com" target="_blank">http://dldi.drunkencoders.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#125642 - simonjhall - Sun Apr 15, 2007 11:41 am</h4>
    <div class="postbody"><span class="postbody">Nice idea, but the script-parsing stuff would def increase the size (although it can't be that much...). How about just dropping a precompiled flat binary into the same directory as the program and that file just gets slotted straight into memory on startup?
<br/>
You'd have to reserve a little bit of space though in your binary (I guess it'd be a little bit like the DLDI system).
<br/>
<br/>
Btw: some of these unlock codes write to locations that may be in the extended memory space. What happens to the data in those addresses when you write the code? Does it detect that it's unlock code and revert the changes, or does the data in those addresses get trashed?<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#125647 - Lazy1 - Sun Apr 15, 2007 2:37 pm</h4>
    <div class="postbody"><span class="postbody">It actually would be easier to keep the compiler in a separate standalone application and to compile the script into a single binary file.
<br/>
<br/>
About writing unlock codes:
<br/>
I have no idea and wondered this myself, maybe someone who is more experienced in that area could give some info?
<br/>
<br/>
I haven't noticed a problem with Mini vMac though, but maybe that's why the M3 code never worked.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#125657 - Lick - Sun Apr 15, 2007 5:34 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>simonjhall wrote:</b></span></td> </tr> <tr> <td class="quote">Btw: some of these unlock codes write to locations that may be in the extended memory space. What happens to the data in those addresses when you write the code? Does it detect that it's unlock code and revert the changes, or does the data in those addresses get trashed?</td> </tr></table><span class="postbody">
<br/>
Wasn't it so that the extended memory can only be written to 8 bits a time? When you write 16 bit to that address it might recognize as a state change, and with 8 bit it stores the data?
<br/>
Just a wild guess.<br/>_________________<br/><a class="postlink" href="http://licklick.wordpress.com" target="_blank">http://licklick.wordpress.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#125731 - FAST6191 - Mon Apr 16, 2007 12:12 pm</h4>
    <div class="postbody"><span class="postbody">Personally I try to keep the root as clear as possible or for quick launching.
<br/>
<br/>
Anyhow I am sure I say this to the chagrin of a few end users but the idea of a dynamically linked ram interface (sorry chism) is an idea I had kicking around in my head for a while now.
<br/>
Implementation may be fun though, maybe it could be piggybacked onto DLDI and placed in the "unused" DLDI section.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#125738 - simonjhall - Mon Apr 16, 2007 1:37 pm</h4>
    <div class="postbody"><span class="postbody">Has anyone got proper unlock codes for the M3? It seems that people have problems getting them to work... I'd really like them so I can drop them into Quake! Plus someone to test them for me :-)
<br/>
<br/>
Oh and Lick, it's a 16-bit bus. If you write 32- and 16-bit quantities the data gets stored correctly (that's a str instruction). If you do 8-bit writes to the bus (with a strb or its derivatives) then the data that gets written is completely whack. Some people have said that what you get written is (number &lt;&lt; 8) | number, but on my SC all I get is crap. Stores seem to be the only thing that's affected - loads work fine, regardless of the size.
<br/>
<br/>
If you're interested, I get about 15 megs/second writing with 32- and 16-bits to main memory and ~7 megs/second 16-bit writes, ~3 meg/second 32-bit writes to the GBA bus. It doesn't seem to make a difference which card is plugged in.<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#125740 - MelGibson - Mon Apr 16, 2007 2:59 pm</h4>
    <div class="postbody"><span class="postbody">I think the people over at dslinux.org (esp. Amadeus who implemented the RAM Access in DSLinux) should have the proper unlock codes for M3 (and other cards as well) 
<br/>
<br/>
If you need an M3 tester, I'd be glad to help.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#125742 - Genoil - Mon Apr 16, 2007 3:20 pm</h4>
    <div class="postbody"><span class="postbody"><a class="postlink" href="http://www.google.com/codesearch?hl=en&amp;q=+m3_set_ram+show:xcJsYuwClr8:CSDqjwlcvYE:ebCR8vpjyoY&amp;sa=N&amp;cd=1&amp;ct=rc&amp;cs_p=:pserver:anoncvs%40dslinux.spline.de:/cvsroot/dslinux+dslinux&amp;cs_f=linux-2.6.x/include/asm-arm/arch-nds/gbarom-macro.S#a0" target="_blank">here</a>
<br/>
are the m3 unlock codes from the dslinux SVN trunk.
<br/>
<br/>
i think the best way to automagically support extended RAM is to modify the compiler <a class="postlink" href="http://dslinux.org/amadeus/?p=15" target="_blank">like Amadeus did</a> to the dslinux building toolchain.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#125746 - OOPMan - Mon Apr 16, 2007 4:27 pm</h4>
    <div class="postbody"><span class="postbody">Isn't this a teensy little bit overkill, considering that there are basically 4 RAM devices, 5 if you include the rather difficult to use EZFlash one...
<br/>
<br/>
It just seems like setting up a library they way this is set up is a little OTT for the current scenario and potential future scenario...<br/>_________________<br/>"My boot, your face..." - Attributed to OOPMan, Emperor of Eroticon VI
<br/>
<br/>
You can find my NDS homebrew projects <a class="postlink" href="http://blog.dev-scene.com/oopman/" target="_blank">here...</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#125748 - Lazy1 - Mon Apr 16, 2007 5:04 pm</h4>
    <div class="postbody"><span class="postbody">I don't think it's overkill, it would making and debugging drivers easier as new devices come out without applications needing applications to be rebuilt.
<br/>
<br/>
Having an extra file in the root directory won't make a difference anyways since most apps can't save in their working directory.
<br/>
<br/>
Another reason for this library would be that even though there are only 5 ram devices the developer may only own 1.
<br/>
Trying to support a device in your application without having it is a real pain in the ass, I don't know how many builds of Mini vMac I sent over IRC to get M3 support working. ( Which I never figured out )
<br/>
<br/>
With this library, I could send a small script file or compiled driver or the user could write one themselves.
<br/>
This frees up time for the developer since he's guaranteed that through the API all devices look and act the same.
<br/>
<br/>
I would be planning to add an application to test and debug drivers to make it easier for people who actually have the devices to write them.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#125783 - simonjhall - Tue Apr 17, 2007 12:18 am</h4>
    <div class="postbody"><span class="postbody">@Genoil
<br/>
We've talked about adjusting the compiler before, and I think people preferred to do the work themselves, rather than let the compiler 'just fix it'. What'd be nice would be a tool which went through object files and gave you line info as to where strb (and its derivatives) live, so you could fix the code yourself. That way you'd be aware of what's fixed and what the performance implications would be...<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#125814 - OOPMan - Tue Apr 17, 2007 7:54 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Lazy1 wrote:</b></span></td> </tr> <tr> <td class="quote">I don't think it's overkill, it would making and debugging drivers easier as new devices come out without applications needing applications to be rebuilt.
<br/>
<br/>
Having an extra file in the root directory won't make a difference anyways since most apps can't save in their working directory.
<br/>
<br/>
Another reason for this library would be that even though there are only 5 ram devices the developer may only own 1.
<br/>
Trying to support a device in your application without having it is a real pain in the ass, I don't know how many builds of Mini vMac I sent over IRC to get M3 support working. ( Which I never figured out )
<br/>
<br/>
With this library, I could send a small script file or compiled driver or the user could write one themselves.
<br/>
This frees up time for the developer since he's guaranteed that through the API all devices look and act the same.
<br/>
<br/>
I would be planning to add an application to test and debug drivers to make it easier for people who actually have the devices to write them.</td> </tr></table><span class="postbody">
<br/>
<br/>
It's not the dynamic side that sounds OTT. It's the scripting engine + VM thing. You've said yourself that it continues to grow at an alarming rate.
<br/>
<br/>
You may well have the same problem I encountered with the threading library I ported. It works well, but at 60k, it's a rather large chunk of code.
<br/>
<br/>
The dynamic interface idea is cool, but if it comes at a cost of bloat, is it really worth it?<br/>_________________<br/>"My boot, your face..." - Attributed to OOPMan, Emperor of Eroticon VI
<br/>
<br/>
You can find my NDS homebrew projects <a class="postlink" href="http://blog.dev-scene.com/oopman/" target="_blank">here...</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#125815 - viruseb - Tue Apr 17, 2007 7:55 am</h4>
    <div class="postbody"><span class="postbody">BTW Amadeus modifies the compiler because it more 'easy' to fix the compiler to forbide 8byte write than fixing all possible linux apps.
<br/>
What can be useful is a malloc function capable of allocating data in the GBA 'ROM' space. It can even hold the unlock functions for that matters (and calling them on the first call).</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#125839 - Lazy1 - Tue Apr 17, 2007 1:53 pm</h4>
    <div class="postbody"><span class="postbody">Well, it has been decided that the VM compiler will be a standalone application to keep the size down.
<br/>
<br/>
The VM itself is tiny, not even 10 instructions so that won't be a problem.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#125841 - Lick - Tue Apr 17, 2007 2:26 pm</h4>
    <div class="postbody"><span class="postbody">Is it possible to check how much RAM is available, in software?<br/>_________________<br/><a class="postlink" href="http://licklick.wordpress.com" target="_blank">http://licklick.wordpress.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#125842 - Lazy1 - Tue Apr 17, 2007 2:41 pm</h4>
    <div class="postbody"><span class="postbody">If you mean with the library, getting the size of the device will be part of the API.
<br/>
It's up to the driver developer to put the "size=" line in the script, without one it will not be compiled.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#125843 - Lick - Tue Apr 17, 2007 2:59 pm</h4>
    <div class="postbody"><span class="postbody">Well I actually meant in software. But I guess it would require some dirty and raw measurement routines.<br/>_________________<br/><a class="postlink" href="http://licklick.wordpress.com" target="_blank">http://licklick.wordpress.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#125854 - simonjhall - Tue Apr 17, 2007 4:19 pm</h4>
    <div class="postbody"><span class="postbody">In Q2 to find the amount of RAM, after unlocking the memory (or at least attempting, anyway) I take a pointer to the head of extended memory and write a (16-bit) magic number and then read it back, just to check it's there. Once that fails, we're out of memory. Repeat, counting the amount of words written.
<br/>
<br/>
Don't forget to slap some 'volatile's in there!<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#125957 - chishm - Wed Apr 18, 2007 2:48 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>simonjhall wrote:</b></span></td> </tr> <tr> <td class="quote">If you're interested, I get about 15 megs/second writing with 32- and 16-bits to main memory and ~7 megs/second 16-bit writes, ~3 meg/second 32-bit writes to the GBA bus. It doesn't seem to make a difference which card is plugged in.</td> </tr></table><span class="postbody">
<br/>
Are you sure about the GBA bus figures? I would have thought that 32-bit accesses would be faster when transfering the same amount of data due to sequential accesses.<br/>_________________<br/><a class="postlink" href="http://chishm.drunkencoders.com" target="_blank">http://chishm.drunkencoders.com</a>
<br/>
<a class="postlink" href="http://dldi.drunkencoders.com" target="_blank">http://dldi.drunkencoders.com</a></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
