<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Problems using jpeglib from the portlibs - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>DS development > Problems using jpeglib from the portlibs</h2>
<div id="posts">
<div class="post">
    <h4>#174150 - SatNav - Thu May 20, 2010 3:34 pm</h4>
    <div class="postbody"><span class="postbody">Hi, I'm using the jpeglib provided for devkitpro to load jpeg files at runtime, for use as background images in my Rubik's Cube sim game. After a few days hacking/blundering around, I've got some code that I think should work, but unfortunately doesn't. I was hoping that perhaps someone with some experience with jpeglib might be able to shed some light on my problem. Here is my code:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">bool loadJPG(char* filename)
<br/>
{
<br/>
   FILE* fp;
<br/>
   
<br/>
   /* Open the prospective JPG file. */
<br/>
   if ((fp = fopen(filename, "rb")) == NULL)
<br/>
   {
<br/>
      return false;
<br/>
   }
<br/>
   else
<br/>
   {
<br/>
      struct jpeg_decompress_struct cinfo;
<br/>
      struct jpeg_error_mgr jerr;
<br/>
      uint row_stride;
<br/>
      u8* jpgData;
<br/>
<br/>
      /* Initialize the JPEG decompression object with default error handling. */
<br/>
      cinfo.err = jpeg_std_error(&amp;jerr);
<br/>
      jpeg_create_decompress(&amp;cinfo);
<br/>
<br/>
      /* Specify data source for decompression */
<br/>
      jpeg_stdio_src(&amp;cinfo, fp);
<br/>
<br/>
      /* Read file header, set default decompression parameters */
<br/>
      (void) jpeg_read_header(&amp;cinfo, TRUE);
<br/>
      uint width = cinfo.output_width;
<br/>
      uint height = cinfo.output_height;
<br/>
      uint channels = cinfo.output_components;
<br/>
      row_stride = width * channels;
<br/>
<br/>
      jpeg_start_decompress(&amp;cinfo);
<br/>
      printf("jpeg_start_decompress\n");
<br/>
<br/>
      /* Allocate the image_data buffer. */
<br/>
      if ((jpgData = (u8*) malloc(row_stride * height))==NULL) {
<br/>
         //png_destroy_read_struct(&amp;png_ptr, &amp;info_ptr, NULL);
<br/>
         return false;
<br/>
      }
<br/>
<br/>
      u8** row_ptr = new u8 * [height];
<br/>
      for(uint i=0; i&lt;height; i++)
<br/>
         row_ptr[i] = &amp;jpgData[i*row_stride];
<br/>
      if(row_ptr[height-1]==NULL)
<br/>
         return false;
<br/>
      printf("allocated memory\n");
<br/>
      
<br/>
<br/>
      /* loop through file, creating image array */
<br/>
      uint lines_read=0;
<br/>
      while (cinfo.output_scanline &lt; cinfo.output_height) {
<br/>
          lines_read += jpeg_read_scanlines(&amp;cinfo, (JSAMPARRAY)&amp;row_ptr[lines_read], 1);
<br/>
          printf("%i\n", lines_read);
<br/>
      }
<br/>
<br/>
      delete [] row_ptr;
<br/>
<br/>
      jpeg_finish_decompress(&amp;cinfo);
<br/>
      jpeg_destroy_decompress(&amp;cinfo);
<br/>
      printf("jpeg_finish_decompress\n");
<br/>
<br/>
      backgroundTexData = new rgb[65536];
<br/>
<br/>
      for(uint i=0; i&lt; 65536; i++)
<br/>
      {
<br/>
         uint dx = i / 256;
<br/>
         uint dy = i % 256;
<br/>
         uint sx = dx * width / 256;
<br/>
         uint sy = dy * height / 256;
<br/>
         uint source = sy * width + sx;
<br/>
<br/>
         backgroundTexData[i]=RGB8(jpgData[source*channels], jpgData[source*channels+1], jpgData[source*channels+2]);
<br/>
         printf("%i\n", backgroundTexData[i]);
<br/>
      }
<br/>
<br/>
      free(jpgData);
<br/>
<br/>
      return true;
<br/>
   }
<br/>
   return false;
<br/>
}</td> </tr></table><span class="postbody">
<br/>
Basically, the program hangs after reading 8 lines of a 400x300 jpg image. It seems like it might be that I'm running out of memory, and crashing through some program code or something stupid. I'm not sure whether I'm allocating memory safely (or exactly how to, with that row_ptr array), so any tips in that regard are very welcome.
<br/>
<br/>
And I know someone is going to suggest headspins gba-jpeg thing. I'm considering it, but I'd rather apply a simple fix for my code (if one exists), than completely rewrite for a different library.
<br/>
<br/>
Cheers,
<br/>
Mark<br/>_________________<br/>Cube-DS: A Kick-Ass Rubik's Cube Game for DS
<br/>
<a class="postlink" href="http://cube-ds.googlecode.com" target="_blank">http://cube-ds.googlecode.com</a></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
