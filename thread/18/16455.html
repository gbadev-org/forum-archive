<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Bug in my menu layering - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>DS development > Bug in my menu layering</h2>
<div id="posts">
<div class="post">
    <h4>#166775 - hacker013 - Tue Feb 17, 2009 4:54 pm</h4>
    <div class="postbody"><span class="postbody">hey everybody,
<br/>
<br/>
I've written my own menu layering system. Zo the menu can have different layers. But the only thing I got is a black screen. I using the nitro engine. I hope you can help me with this, i'm already a week long trying to get this work.
<br/>
<br/>
UZMenuLayer.h
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#ifndef __UZ_MENULAYER_H__
<br/>
#define __UZ_MENULAYER_H__
<br/>
<br/>
#include &lt;nds.h&gt;
<br/>
#include "NE2D.h"
<br/>
<br/>
#define UZ_MAX_WINDOWS 128
<br/>
#define UZ_MAX_LAYERS 128
<br/>
<br/>
typedef struct{
<br/>
   bool visible;
<br/>
   NE_Window ** window;
<br/>
   int priority;
<br/>
   bool screen;
<br/>
   /* 0 = down / 1 = top*/
<br/>
}UZ_MenuLayer;
<br/>
<br/>
/* Functions */
<br/>
// -- Initing / Freeing
<br/>
void UZ_MenuLayerInit(int mlayers, int mwindows);
<br/>
void UZ_MenuLayerFree();
<br/>
// -- Adding / Deleting
<br/>
UZ_MenuLayer* UZ_MenuLayerCreate();
<br/>
void UZ_MenuLayerDelete(UZ_MenuLayer* menulayer);
<br/>
// -- Drawing down / top
<br/>
void UZ_MenuLayerDrawDown();
<br/>
void UZ_MenuLayerDrawTop();
<br/>
// -- Edit Settings
<br/>
void UZ_MenuLayerSetPriority(UZ_MenuLayer* menulayer, int priority);
<br/>
void UZ_MenuLayerSetVisible(UZ_MenuLayer* menulayer, bool visible);
<br/>
void UZ_MenuLayerSetScreen(UZ_MenuLayer* menulayer, bool screen);
<br/>
// -- Window Settings / Adding / Removing
<br/>
int UZ_MenuLayerWindowAdd(UZ_MenuLayer* menulayer, NE_Window* window);
<br/>
void UZ_MenuLayerWindowRemove(UZ_MenuLayer* menulayer, NE_Window* window);
<br/>
<br/>
#endif
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
UZMenuLayer.c
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#include "UZMenuLayer.h"
<br/>
<br/>
bool uz_menulayerinited = false;
<br/>
UZ_MenuLayer ** MenuLayers;
<br/>
int uz_max_layers;
<br/>
int uz_max_windows;
<br/>
<br/>
void UZ_MenuLayerInit(int mlayers, int mwindows)
<br/>
{
<br/>
   if(uz_menulayerinited==true)UZ_MenuLayerFree();
<br/>
   /* Set Max Layers */
<br/>
   if(mlayers&gt;0){
<br/>
      uz_max_layers=mlayers;
<br/>
   } else {
<br/>
      uz_max_layers=UZ_MAX_LAYERS;
<br/>
   }
<br/>
   /* Set Max Windows */
<br/>
   if(mwindows&gt;0){
<br/>
      uz_max_windows=mwindows;
<br/>
   } else {
<br/>
      uz_max_windows=UZ_MAX_WINDOWS;
<br/>
   }
<br/>
   /* Allocated Enough Memory */
<br/>
   MenuLayers = malloc(sizeof(UZ_MenuLayer)*uz_max_layers);
<br/>
   int i=0;
<br/>
   for(i=0;i&lt;uz_max_layers;i++)
<br/>
   {
<br/>
      MenuLayers[i]=NULL;
<br/>
   }
<br/>
}
<br/>
<br/>
void UZ_MenuLayerFree()
<br/>
{
<br/>
   if(uz_menulayerinited==false)return;
<br/>
   int i=0;
<br/>
   /* Free All Menu Layers */
<br/>
   for(i=0;i&lt;uz_max_layers;i++)
<br/>
   {
<br/>
      if(MenuLayers[i]!=NULL)
<br/>
      {
<br/>
         UZ_MenuLayerDelete(MenuLayers[i]);
<br/>
      }
<br/>
   }
<br/>
   free(MenuLayers);
<br/>
}
<br/>
<br/>
UZ_MenuLayer* UZ_MenuLayerCreate()
<br/>
{
<br/>
   if(uz_menulayerinited==false)return NULL;
<br/>
   int i=0;
<br/>
   /* Check if id is free */
<br/>
   for(i=0;i&lt;uz_max_layers;i++)
<br/>
   {
<br/>
      /* If id is free */
<br/>
      if(MenuLayers[i]==NULL)
<br/>
      {
<br/>
         UZ_MenuLayer* menulayer;
<br/>
         menulayer = malloc(sizeof(UZ_MenuLayer));    //Set memory
<br/>
         menulayer-&gt;visible=true;               //Set visible
<br/>
         menulayer-&gt;priority=0;                  //Set priority
<br/>
         menulayer-&gt;screen=0;                  //Set screen
<br/>
         menulayer-&gt;window = malloc(sizeof(NE_Window)*uz_max_windows);
<br/>
         for(i=0;i&lt;uz_max_windows;i++)
<br/>
         {
<br/>
            menulayer-&gt;window[i]=NULL;            //Init Windows
<br/>
         }
<br/>
         MenuLayers[i]=menulayer;               //Keep pointer
<br/>
         return menulayer;
<br/>
      }
<br/>
   }
<br/>
   return NULL;
<br/>
}
<br/>
<br/>
void UZ_MenuLayerDelete(UZ_MenuLayer* menulayer)
<br/>
{
<br/>
   if(uz_menulayerinited==false)return;
<br/>
   if(menulayer==NULL)return;
<br/>
   int i;
<br/>
   for(i=0;i&lt;uz_max_layers;i++)
<br/>
   {
<br/>
      if(MenuLayers[i]==menulayer)
<br/>
      {
<br/>
         MenuLayers[i]=NULL;
<br/>
         for(i=0;i&lt;uz_max_windows;i++)
<br/>
         {
<br/>
            UZ_MenuLayerWindowRemove(menulayer,menulayer-&gt;window[i]);
<br/>
         }
<br/>
         free(menulayer);
<br/>
         return; //Don't loop unnessary loops.
<br/>
      }
<br/>
   }
<br/>
   
<br/>
}
<br/>
<br/>
void UZ_MenuLayerDrawDown()
<br/>
{
<br/>
   if(uz_menulayerinited==false)return;
<br/>
   int i=0;
<br/>
   for(i=0;i&lt;uz_max_layers;i++)
<br/>
   {
<br/>
      if(MenuLayers[i]!=NULL)
<br/>
      {
<br/>
         if(MenuLayers[i]-&gt;screen==0  &amp;&amp; MenuLayers[i]-&gt;visible==true)
<br/>
         {
<br/>
            int j=0;
<br/>
            for(j=0;j&lt;uz_max_windows;j++)
<br/>
            {
<br/>
               /* Get Original Priority */
<br/>
               int tmp_priority=MenuLayers[i]-&gt;window[j]-&gt;priority;
<br/>
               /* Set to the correct depth for MenuLayers */
<br/>
               NE_WindowSetPriority(MenuLayers[i]-&gt;window[j],MenuLayers[i]-&gt;priority+tmp_priority);
<br/>
               /* Draw Window */
<br/>
               NE_WindowDraw(MenuLayers[i]-&gt;window[j]);
<br/>
               /* Reset Priority */
<br/>
               NE_WindowSetPriority(MenuLayers[i]-&gt;window[j],tmp_priority);
<br/>
            }
<br/>
         }
<br/>
      }
<br/>
   }
<br/>
}
<br/>
<br/>
void UZ_MenuLayerDrawTop()
<br/>
{
<br/>
   if(uz_menulayerinited==false)return;
<br/>
   int i=0;
<br/>
   for(i=0;i&lt;uz_max_layers;i++)
<br/>
   {
<br/>
      if(MenuLayers[i]!=NULL)
<br/>
      {
<br/>
         if(MenuLayers[i]-&gt;screen==1 &amp;&amp; MenuLayers[i]-&gt;visible==true)
<br/>
         {
<br/>
            int j=0;
<br/>
            for(j=0;j&lt;uz_max_windows;j++)
<br/>
            {
<br/>
               /* Get Original Priority */
<br/>
               int tmp_priority=MenuLayers[i]-&gt;window[j]-&gt;priority;
<br/>
               /* Set to the correct depth for MenuLayers */
<br/>
               NE_WindowSetPriority(MenuLayers[i]-&gt;window[j],MenuLayers[i]-&gt;priority+tmp_priority);
<br/>
               /* Draw Window */
<br/>
               NE_WindowDraw(MenuLayers[i]-&gt;window[j]);
<br/>
               /* Reset Priority */
<br/>
               NE_WindowSetPriority(MenuLayers[i]-&gt;window[j],tmp_priority);
<br/>
            }
<br/>
         }
<br/>
      }
<br/>
   }
<br/>
}
<br/>
<br/>
void UZ_MenuLayerSetPriority(UZ_MenuLayer* menulayer, int priority)
<br/>
{
<br/>
   if(uz_menulayerinited==false)return;
<br/>
   if(menulayer==NULL)return;
<br/>
   menulayer-&gt;priority = priority;
<br/>
}
<br/>
<br/>
void UZ_MenuLayerSetVisible(UZ_MenuLayer* menulayer, bool visible)
<br/>
{
<br/>
   if(uz_menulayerinited==false)return;
<br/>
   if(menulayer==NULL)return;
<br/>
   menulayer-&gt;visible = visible;
<br/>
}
<br/>
<br/>
void UZ_MenuLayerSetScreen(UZ_MenuLayer* menulayer, bool screen)
<br/>
{
<br/>
   if(uz_menulayerinited==false)return;
<br/>
   if(menulayer==NULL)return;
<br/>
   menulayer-&gt;screen = screen;
<br/>
}
<br/>
<br/>
int UZ_MenuLayerWindowAdd(UZ_MenuLayer* menulayer, NE_Window* window)
<br/>
{
<br/>
   if(uz_menulayerinited==false)return 0;
<br/>
   if(menulayer==NULL)return 0;
<br/>
   int i=0;
<br/>
   for(i=0;i&lt;uz_max_windows;i++)
<br/>
   {
<br/>
      if(menulayer-&gt;window[i]==NULL)
<br/>
      {
<br/>
         menulayer-&gt;window[i]=malloc(sizeof(NE_Window));
<br/>
         menulayer-&gt;window[i]=window;
<br/>
         return 1;
<br/>
      }
<br/>
   }
<br/>
   return 0;
<br/>
}
<br/>
<br/>
void UZ_MenuLayerWindowRemove(UZ_MenuLayer* menulayer, NE_Window* window)
<br/>
{
<br/>
   if(uz_menulayerinited==false)return;
<br/>
   if(menulayer==NULL)return;
<br/>
   int i=0;
<br/>
   for(i=0;i&lt;uz_max_windows;i++)
<br/>
   {
<br/>
      if(menulayer-&gt;window[i]==window)
<br/>
      {
<br/>
         free(menulayer-&gt;window[i]);
<br/>
         menulayer-&gt;window[i]=NULL;
<br/>
      }
<br/>
   }
<br/>
}
<br/>
</td> </tr></table><span class="postbody"><br/>_________________<br/><a class="postlink" href="http://imetal.nl/" target="_blank">Website / Blog</a>
<br/>
<br/>
Let the nds be with you.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
