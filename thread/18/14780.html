<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Flashlight effect in a 3d scene - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > Flashlight effect in a 3d scene</h2>
<div id="posts">
<div class="post">
    <h4>#148293 - Peter - Fri Jan 04, 2008 1:28 pm</h4>
    <div class="postbody"><span class="postbody">I wonder how the <a class="postlink" href="http://www.renegadekid.com" target="_blank">developers</a> of <a class="postlink" href="http://en.wikipedia.org/wiki/Dementium:_The_Ward" target="_blank">dementium: the ward</a> have achieved the flashlight effect shown in th followig screenshots:<ul>
<br/>
<li> <a class="postlink" href="http://www.nintendothailand.com/picture/nds/screenshot/d/dementiumtheward_2.jpg" target="_blank">shot 1</a>
<br/>
</li><li> <a class="postlink" href="http://www.fantasy.fr/news/upload/actu/16082007-Dementium-the-ward-1.jpg" target="_blank">shot 2</a>
<br/>
</li><li> <a class="postlink" href="http://i29.photobucket.com/albums/c288/greatgaara/dem.jpg" target="_blank">shot 3</a>
<br/>
</li><li> <a class="postlink" href="http://www.shacknews.com/images/generated/470549a733fff_featured_without_text_Dementium5104.jpg" target="_blank">shot 4</a>
<br/>
</li></ul>First I thought it would be just some kind of overlay and gets blended with the 3d scene, but on several screenshots the light looks rather perspective, for example when it's projected at a corner of a wall or into another room.
<br/>
<br/>
Then I thought maybe it's done with a shadow-volume. But instead of darkening the affacted area, it brightened. But no idea if you can change the shadow-color/blending mode. 
<br/>
<br/>
Another theory is again a shadow-volume, but with an "invered cone" as volume. So everything except in the cone gets shadowed.
<br/>
<br/>
What do you think how the effect is achieved?<br/>_________________<br/>Kind Regards,
<br/>
Peter</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#148308 - M3d10n - Fri Jan 04, 2008 3:28 pm</h4>
    <div class="postbody"><span class="postbody">Yes, that's a shadow volume, but it's not inverted.
<br/>
<br/>
With the correct settings, you can make it so the fog will not affect the pixels inside the shadow volume. So the areas outside the flashlight cone are darkened by a cleverly adjusted black fog, while the cone volume does nothing but show the unfogged scene.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#148313 - Bloodypriest - Fri Jan 04, 2008 4:00 pm</h4>
    <div class="postbody"><span class="postbody">If I remember correctly what I heard at GDC, this effect is actually based on a bug in the DS fog engine. I think it has to do with an unfogged 3d model while the scene is fogged which will make the scene show through or something like that ; I don't remember correctly. And they could not explain every detail because of Nintendo's NDA.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#148318 - silent_code - Fri Jan 04, 2008 4:12 pm</h4>
    <div class="postbody"><span class="postbody">right, right!
<br/>
<br/>
if you used an inverted cone, all you'd get is a real bad depression. it's much pain to get it working with the z-pass shadow volume algorithm used by the nds, if you *can* do it at all (i tried...).
<br/>
you can, however, define any color for the shadow. :^)
<br/>
<br/>
EDIT: afaik, you can't change the nds' blending mode besides modulate and decal. that also applies to shadow blending.
<br/>
i havent tried texturing the shadow, but using it for "fog cutouts" like in that game (looks interesting!) is not hard - and you can tell from the images that it's doing that (what also limits the visuals you can get with that technique, eg. distant objects, no matter how lit they are, will allways dissolve in darkness that way). is, like posted before, a matter of setting things up right.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#148361 - M3d10n - Fri Jan 04, 2008 11:34 pm</h4>
    <div class="postbody"><span class="postbody">Actually, it's on GBATek:
<br/>
<br/>
<a class="postlink" href="http://nocash.emubase.de/gbatek.htm#ds3dshadowpolygons" target="_blank">http://nocash.emubase.de/gbatek.htm#ds3dshadowpolygons</a>
<br/>
<br/>
From the link:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">The old Fog Enable flag in the Attribute Buffer is ANDed with the Fog Enable flag of the Shadow Polygons, this allows to exclude Fog in shaded regions.</td> </tr></table><span class="postbody">
<br/>
<br/>
So, if you enable fog for the scene, render geometry with fog enabled (bit 15 in the poly attribute), and render the shadow volume with fog disabled afterwards, the pixels inside the volume will be unfogged.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#148364 - Peter - Sat Jan 05, 2008 12:06 am</h4>
    <div class="postbody"><span class="postbody">Awesome, thanks for the info! Not that I want to program this effect, I was just curious how they might have done it.
<br/>
<br/>
And again learned something today, yay! :)<br/>_________________<br/>Kind Regards,
<br/>
Peter</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#148366 - simonjhall - Sat Jan 05, 2008 12:38 am</h4>
    <div class="postbody"><span class="postbody">Just reading that info on gbatek about this shadowing lark and it does sound pretty easy! I'm gonna have to have a go :-)
<br/>
However you just KNOW that as soon as you add that DS 'funk factor' a ten minute job is actually going to take you hours until you realise you need to set some obscure bit in a register somewhere... Grr...
<br/>
<br/>
Now the only thing holding me back from using shadow properly is that it eats into your valuable polygon count...
<br/>
<br/>
/more off-topic:
<br/>
Reckon you could use the display capture to do shadow mapping?<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#148371 - elhobbs - Sat Jan 05, 2008 1:54 am</h4>
    <div class="postbody"><span class="postbody">I had a go at writing a shadow map quake level viewer using the display capture. I rendered the scene once with the level textures and captured the frame then copied to main memory. Then I rendered the frame again using the lightmaps with display capture then copied the frame to main memory. I then blended the two frames in software using a lookup into the quake colormap. As you may imagine it runs at about 10 frames a second and uses the lowest resolution mipmaps since one of the vram banks is lost to capture. since the lightmaps are so tiny I packed them into larger texture blocks like glquake - this makes it almost impossible to do any type of texture loading and unloading for the lightmaps so they needed to stay resident in vram. this did not even render any of the monsters and they typically take longer to render then the bsp file. I would say that it is a no go for quake, but cetainly possible for something that is designed from the start with this in mind.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#148437 - Bloodypriest - Sat Jan 05, 2008 6:44 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>M3d10n wrote:</b></span></td> </tr> <tr> <td class="quote">Actually, it's on GBATek:
<br/>
<br/>
<a class="postlink" href="http://nocash.emubase.de/gbatek.htm#ds3dshadowpolygons" target="_blank">http://nocash.emubase.de/gbatek.htm#ds3dshadowpolygons</a>
<br/>
<br/>
From the link:
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">The old Fog Enable flag in the Attribute Buffer is ANDed with the Fog Enable flag of the Shadow Polygons, this allows to exclude Fog in shaded regions.</td> </tr></table><span class="postbody">
<br/>
<br/>
So, if you enable fog for the scene, render geometry with fog enabled (bit 15 in the poly attribute), and render the shadow volume with fog disabled afterwards, the pixels inside the volume will be unfogged.</span></td> </tr></table><span class="postbody">
<br/>
Yes! That was it! That's the "feature" the speaker at GDC was saying was a bug due to weird way fog was rendered on the DS.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
