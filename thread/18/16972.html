<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>need help getting wifi to send more than ~20K of data - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>DS development > need help getting wifi to send more than ~20K of data</h2>
<div id="posts">
<div class="post">
    <h4>#171395 - Ant6n - Wed Nov 18, 2009 8:40 am</h4>
    <div class="postbody"><span class="postbody">Hio,
<br/>
<br/>
In some project I need to send possibly up to like 500KB at the time, which I thought would not be a problem using today's ultra speeds of wifi's and dsl's. I use the http example from devkitpro with POST to get the data onto my server.
<br/>
In other threads there is mention that 'send' only sends ~8K data at a time, so I do the resend trick, with a swiWaitForVBlank thrown in for good measure. The final code looks like this
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
char * url = 
<br/>
        "&lt;host&gt;";
<br/>
char* request = 
<br/>
        "POST /&lt;user&gt;/cgi-bin/DSWifiSubmit.py HTTP/1.1\r\n"
<br/>
        "&lt;host&gt;\r\n"
<br/>
        "Content-Length: %d\n"
<br/>
        "\n"
<br/>
        "recording=%s";
<br/>
<br/>
<br/>
int getHttp(char* url,char *request_text) {
<br/>
  int success = 0;
<br/>
<br/>
  pause_terminal();//pause terminal -- sending might get disrupted by interrupts
<br/>
<br/>
  // Find the IP address of the server, with gethostbyname
<br/>
  struct hostent * myhost = gethostbyname( url );
<br/>
  iprintf("Found IP Address, ");
<br/>
 
<br/>
  // Create a TCP socket
<br/>
  int my_socket;
<br/>
  my_socket = socket( AF_INET, SOCK_STREAM, 0 );
<br/>
  iprintf("Created Socket");
<br/>
<br/>
  // Tell the socket to connect to the IP address we found, on port 80 (HTTP)
<br/>
  struct sockaddr_in sain;
<br/>
  sain.sin_family = AF_INET;
<br/>
  sain.sin_port = htons(80);
<br/>
  sain.sin_addr.s_addr= *( (unsigned long *)(myhost-&gt;h_addr_list[0]) );
<br/>
  connect( my_socket,(struct sockaddr *)&amp;sain, sizeof(sain) );
<br/>
  iprintf("Connected to server,sending data");
<br/>
<br/>
  // send our request - it only sends ~8k(?) bytes at a time
<br/>
  int sent = 0, size = strlen(request_text);
<br/>
  while(sent &lt; size){ 
<br/>
    printf("sent %d of %d bytes\n",sent,size);
<br/>
    sent += send(my_socket, &amp;(request_text[sent]), size - sent, 0);
<br/>
    swiWaitForVBlank();
<br/>
  } 
<br/>
  printf("sent %d of %d bytes\n",sent,size);
<br/>
  iprintf("Sent data, printing result:\n");
<br/>
<br/>
  int recvd_len;
<br/>
  char incoming_buffer[256];
<br/>
<br/>
<br/>
  while( ( recvd_len = recv( my_socket, incoming_buffer, 255, 0 ) ) != 0 ) { // if recv returns 0, the socket has been closed.
<br/>
    if(recvd_len&gt;0) { // data was received!
<br/>
      incoming_buffer[recvd_len] = 0; // null-terminate
<br/>
      iprintf(incoming_buffer);
<br/>
      resume_terminal();//reactivate terminal
<br/>
      nextDownEvent();
<br/>
      pause_terminal();//pause terminal -- sending might get disrupted by interrupts
<br/>
    }
<br/>
  }
<br/>
  resume_terminal();//reactivate terminal
<br/>
<br/>
  iprintf("\nclosed connection\n");
<br/>
<br/>
  shutdown(my_socket,0); // good practice to shutdown the socket.
<br/>
  
<br/>
  iprintf("shutdown socket, ");
<br/>
<br/>
  closesocket(my_socket); // remove the socket.
<br/>
<br/>
  iprintf("closed socket\n");
<br/>
   
<br/>
  success = 1;
<br/>
  return success;
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
<br/>
The first time it sends 8K, then a bit less than 2K, apparently going down to about 1K, then it stops submitting. It doesn't always behave the same way. When I try with smaller data (~14K), it finishes succesfully and prints the result from the server. Ideas?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#171430 - Ant6n - Thu Nov 19, 2009 7:10 am</h4>
    <div class="postbody"><span class="postbody">Some further research mentioned there might be something going on with some changes in the FIFO this year, but that all sounds like very low level to deal with.
<br/>
<br/>
So to deal with it, I am using a portable compression library, at <a class="postlink" href="http://oldhome.schmorp.de/marc/liblzf.htm" target="_blank">http://oldhome.schmorp.de/marc/liblzf.htm</a>l. It's nice because it has only two h and c files, and is portable. It's a bit crappy at compression, so with this it actually makes sense to compress twice; my data of mostly zeros compressed down to ~50% the first time, and down to 10% of that the second time.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#171433 - sverx - Thu Nov 19, 2009 10:34 am</h4>
    <div class="postbody"><span class="postbody">why not zlib?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#171435 - Ant6n - Thu Nov 19, 2009 11:56 am</h4>
    <div class="postbody"><span class="postbody">because it's hard to find libraries like that online (and in some previous thread a question for some lightweight portable library wasn't answered).
<br/>
<br/>
I don't like this zlib, it has way to many files, and within 5 minutes I didn't find functions for compressing and decompressing given pointers to memory. For people that already know it seems fine, or for people that might use it again later (which is not me).
<br/>
<br/>
That said, the library I mentioned works in the emulator for me, but it doesn't seem to work in hardware well, although there might be some other things going on here. I'll try another tiny, portable compressor library without dependency called minilzo <a class="postlink" href="http://www.oberhumer.com/opensource/lzo/" target="_blank">http://www.oberhumer.com/opensource/lzo/</a>.</span><span class="gensmall"><br/><br/>Last edited by Ant6n on Thu Nov 19, 2009 8:22 pm; edited 2 times in total</span></div>    
</div>
<div class="post">
    <h4>#171439 - sverx - Thu Nov 19, 2009 12:40 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Ant6n wrote:</b></span></td> </tr> <tr> <td class="quote">I don't like this zlib, it has way to many files, and within 5 minutes I didn't find functions for compressing and decompressing given pointers to memory.</td> </tr></table><span class="postbody">
<br/>
<br/>
There are compress() and uncompress()
<br/>
<a href="http://zlib.ipinfo.de/manual.html#Utility" target="_blank">http://zlib.ipinfo.de/manual.html#Utility</a> functions
<br/>
It's fast and has a good compression ratio. Has been used, for instance, in Manic Miner in the Lost Levels homebrew, to compress XM tunes stored in the .NDS and decompress them at run time.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#171442 - headspin - Thu Nov 19, 2009 2:15 pm</h4>
    <div class="postbody"><span class="postbody">zlib is very easy to implement and work with as sverx said. If you need any help with it let me know.<br/>_________________<br/><a class="postlink" href="http://headsoft.com.au/index.php?category=warhawk" target="_blank">Warhawk DS</a> | <a class="postlink" href="http://headsoft.com.au/index.php?category=mmll" target="_blank">Manic Miner: The Lost Levels</a> | <a class="postlink" href="http://headsoft.com.au/index.php?category=tdg" target="_blank">The Detective Game</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#171447 - Ant6n - Thu Nov 19, 2009 8:29 pm</h4>
    <div class="postbody"><span class="postbody">huh, I guess I didn't find that in 5 minutes late yesterday night ;-). 
<br/>
This miniLZO works on the hardware btw, and it's pretty light weight to use.
<br/>
I think I'll try Zlib as well; I have a feeling it should give me better compression ratios. 
<br/>
<br/>
I presume it works if I just throw all the files of the top level directory of the library into my source code (except example.c, minizgip.c).
<br/>
<br/>
Thanks for the input :-)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#171526 - Izhido - Tue Nov 24, 2009 3:13 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
I don't like this ***, it has way to many files, and within 5 minutes I didn't find functions for *** and *** given ****.
<br/>
</td> </tr></table><span class="postbody">
<br/>
Then why the hell are you here, acting as a <span style="font-weight: bold">software developer</span> ???
<br/>
<br/>
&lt;/grumpy&gt;
<br/>
<br/>
I think I need my morning coffee... urgently... :P</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
