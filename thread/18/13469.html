<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>How to use trigonometric functions? - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>DS development > How to use trigonometric functions?</h2>
<div id="posts">
<div class="post">
    <h4>#131730 - gyokimae - Tue Jun 19, 2007 3:03 pm</h4>
    <div class="postbody"><span class="postbody">Hi,
<br/>
<br/>
<br/>
.. The subject says it all,
<br/>
In the BG_Rotation demo, etc, I see macros like,
<br/>
<br/>
s16 s = SIN[angle &amp; 0x1FF] &gt;&gt; 4;
<br/>
<br/>
<br/>
The best I could understand from information gathered is that this macro is refering to a look up table of 512 steps which is perhaps part of the libnds (opposed to standard C functions).
<br/>
<br/>
Where can I find resources on
<br/>
* Type of value returned from this macro (s16 for sure... any obscure rules like fixed point?)
<br/>
* Usage of 0x1FF (which I am assuming is some sort of mask).
<br/>
* Significance of the 4 bit bit-shifting.
<br/>
<br/>
I grepped through header files in libnds but found no answer.
<br/>
Straight answers or even pointers to documents are highly appreciated.
<br/>
Thanks.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#131738 - Lick - Tue Jun 19, 2007 4:42 pm</h4>
    <div class="postbody"><span class="postbody">I think it's <span style="font-weight: bold">12.4 fixed point</span>. As you said the total number of bits equals 16 and the example shifts 4 to the right. The only logical reason for this shift would be to get the whole values (discarding the 4 bits).
<br/>
<br/>
Logical-AND-ing with a power-of-two-minus-one, is the same as modulus the power-of-two. It should be faster though. 
<br/>
(11 % 4 == 11 &amp; 3)
<br/>
<br/>
Like I said, the 4-bit shifting is to get the "whole" value from the fixed point.
<br/>
Let's say the fixed point stored "2,5" then you shift away the 4 bits you'd get "2".<br/>_________________<br/><a class="postlink" href="http://licklick.wordpress.com" target="_blank">http://licklick.wordpress.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#131739 - knight0fdragon - Tue Jun 19, 2007 4:44 pm</h4>
    <div class="postbody"><span class="postbody">the look up table is in 4.12 fixed point
<br/>
<br/>
the BG registers are in 8.8 fixed point
<br/>
<br/>
so what you need to do is shift the returned value of 4 over so that it becomes an 8.8 fixed point number
<br/>
<br/>
0x1FF is a mask, because we never want the angle to go above 511 degrees
<br/>
<br/>
in libnds trig LUT, one rotation is from 0 to 511
<br/>
which means 512 will get us back to 0
<br/>
<br/>
same concept as 0-359 degrees<br/>_________________<br/><a href="http://www.myspace.com/knight0fdragonds" target="_blank">http://www.myspace.com/knight0fdragonds</a>
<br/>
<br/>
MK DS FC: Dragon 330772 075464 
<br/>
AC WW FC: Anthony SamsClub 1933-3433-9458 
<br/>
MPFH: Dragon 0215 4231 1206</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#131740 - knight0fdragon - Tue Jun 19, 2007 4:45 pm</h4>
    <div class="postbody"><span class="postbody">haha you beat me to a response lick, that was funny<br/>_________________<br/><a href="http://www.myspace.com/knight0fdragonds" target="_blank">http://www.myspace.com/knight0fdragonds</a>
<br/>
<br/>
MK DS FC: Dragon 330772 075464 
<br/>
AC WW FC: Anthony SamsClub 1933-3433-9458 
<br/>
MPFH: Dragon 0215 4231 1206</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#131741 - gyokimae - Tue Jun 19, 2007 5:23 pm</h4>
    <div class="postbody"><span class="postbody">Thanks for the valuable information.
<br/>
I really find you mates incurreging for a newbie like me.
<br/>
<br/>
You mind if I ask how you discover all this?
<br/>
Is the function documented somewhere or is the only option currently available to dive in to source code of the library?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#131742 - gyokimae - Tue Jun 19, 2007 5:33 pm</h4>
    <div class="postbody"><span class="postbody">oh, wait a minute,
<br/>
<br/>
that is two different theories.
<br/>
<br/>
12.4 &gt;&gt; 4 -&gt; get real number
<br/>
4.12 &gt;&gt; 4 -&gt; convert to 8.8
<br/>
<br/>
oh well, I guess I can find out for myself.
<br/>
Helpful info though. Especially the concept with the modulus.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#131748 - Lick - Tue Jun 19, 2007 6:20 pm</h4>
    <div class="postbody"><span class="postbody">knight0fdragon was right, it's 4.12.  I confused the goal to be 'getting the whole values' instead of 'getting a 8.8 value'.
<br/>
<br/>
It makes much more sense though, 4.12 allows much smaller steps than 12.4. Hehe.<br/>_________________<br/><a class="postlink" href="http://licklick.wordpress.com" target="_blank">http://licklick.wordpress.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#131759 - kusma - Tue Jun 19, 2007 8:48 pm</h4>
    <div class="postbody"><span class="postbody">is it just me, or is it plain stupid to have 4 bits of integer range for a sine-table?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#131760 - wintermute - Tue Jun 19, 2007 9:03 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>kusma wrote:</b></span></td> </tr> <tr> <td class="quote">is it just me, or is it plain stupid to have 4 bits of integer range for a sine-table?</td> </tr></table><span class="postbody">
<br/>
<br/>
The purpose is to match up with the 4.12 format for vectors. Whether that was a good idea or not I can't say, you're the first person to mention it and it was inherited from the former ndslib.<br/>_________________<br/><a class="postlink" href="http://www.devkitpro.org/" target="_blank">devkitPro - professional toolchains at amateur prices</a>
<br/>
<a class="postlink" href="http://wiki.devkitpro.org/index.php/IRC" target="_blank">devkitPro IRC support</a>
<br/>
<a class="postlink" href="http://davejmurphy.com/" target="_blank">Personal Blog</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#131780 - tepples - Wed Jun 20, 2007 1:45 am</h4>
    <div class="postbody"><span class="postbody">I'd suggest using 2.14 for a 257-entry table, then doing linear interpolation.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#131785 - DekuTree64 - Wed Jun 20, 2007 2:27 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tepples wrote:</b></span></td> </tr> <tr> <td class="quote">I'd suggest using 2.14 for a 257-entry table, then doing linear interpolation.</td> </tr></table><span class="postbody">
<br/>
Maybe store the table as 2.14, and interpolate to 2.30? I like to keep as few fixed-point formats in circulation as possible, so .12 for general use and .30 for things that are always between -1 and 1 seems like a pretty good setup.<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#131806 - wintermute - Wed Jun 20, 2007 8:40 am</h4>
    <div class="postbody"><span class="postbody">I'd suggest submitting a patch for consideration.
<br/>
<br/>
Such a patch should also update examples where necessary.<br/>_________________<br/><a class="postlink" href="http://www.devkitpro.org/" target="_blank">devkitPro - professional toolchains at amateur prices</a>
<br/>
<a class="postlink" href="http://wiki.devkitpro.org/index.php/IRC" target="_blank">devkitPro IRC support</a>
<br/>
<a class="postlink" href="http://davejmurphy.com/" target="_blank">Personal Blog</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#131809 - kusma - Wed Jun 20, 2007 10:57 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>DekuTree64 wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tepples wrote:</b></span></td> </tr> <tr> <td class="quote">I'd suggest using 2.14 for a 257-entry table, then doing linear interpolation.</td> </tr></table><span class="postbody">
<br/>
Maybe store the table as 2.14, and interpolate to 2.30? I like to keep as few fixed-point formats in circulation as possible, so .12 for general use and .30 for things that are always between -1 and 1 seems like a pretty good setup.</span></td> </tr></table><span class="postbody">
<br/>
<br/>
since the sign-bit is implicit in the lut index (top bit: sin(x) = -sin(x - pi), and the range for our lut is 0..2pi), we can get away without storing it. Also, there's a symmetry around the top and bottom of the sine-wave that can be exploited simply, just by picking some bits.
<br/>
<br/>
Here's some code to do just that. Note that the macro SIN_TABLE_LOG2_SIZE and SIN_TABLE_SIZE are the sizes of the "virtual" sine-table, that is, before the symmetry exploitations i mentioned above.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#define SIN_TABLE_LOG2_SIZE 9
<br/>
#define SIN_TABLE_SIZE (1 &lt;&lt; SIN_TABLE_LOG2_SIZE)
<br/>
extern const unsigned short sin_lut[(SIN_TABLE_SIZE / 4) + 1];
<br/>
<br/>
inline int sin_lookup(int i)
<br/>
{
<br/>
   int idx = i &amp; ((SIN_TABLE_SIZE &gt;&gt; 2) - 1);
<br/>
   switch ((i &gt;&gt; (SIN_TABLE_LOG2_SIZE - 2)) &amp; 0x3)
<br/>
   {
<br/>
      case 0: return +int(sin_lut[idx]);
<br/>
      case 1: return +int(sin_lut[(SIN_TABLE_SIZE / 4) - idx]);
<br/>
      case 2: return -int(sin_lut[idx]);
<br/>
      case 3: return -int(sin_lut[(SIN_TABLE_SIZE / 4) - idx]);
<br/>
   }
<br/>
}
<br/>
<br/>
inline int cos_lookup(int i)
<br/>
{
<br/>
   return sin_lookup(i + (SIN_TABLE_SIZE / 4));
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Interpolation could be done on top of this. I'm using 0:16 fixed point myself. Yes, I know, the biggest value in the LUT (1.0) must then be clamped to some almost zero value. What can be done to defeat coordinate systems to implode, is to map 0..1 to 0..65535 (instead of 65536), and do </span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">v = v + (v &gt;&gt; 15)</td> </tr></table><span class="postbody"> to "renormalize" it to 0..65536 after interpolation.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#132580 - NeX - Wed Jun 27, 2007 10:46 pm</h4>
    <div class="postbody"><span class="postbody">I would like to know how the extended rotation bg registers work.... I am trying to place a 128x128 bg in the middle of the subscreen and rotate it.  But, due to a lack of documentation, I really don't know what I'm doing, and although sometimes I get close, the bg is pretty much always off centre.  And if it's rotating around the centre properly, it's in the wrong place.  I could use a 256x256 image, but that would be a waste of memory.<br/>_________________<br/><a class="postlink" href="http://www.mediafire.com/?cuyb10fzdz2" target="_blank">Strummer</a> or <a class="postlink" href="http://www.mediafire.com/?71zxcztscix" target="_blank">Drummer?</a>.  
<br/>
Or maybe you would rather play with sand? <a class="postlink" href="http://www.mediafire.com/?a05z5wmdvxm" target="_blank">Sandscape is for you in that case.</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#132583 - NeX - Wed Jun 27, 2007 11:00 pm</h4>
    <div class="postbody"><span class="postbody">Looking at it, the BG ROTATION example isn't quite on centre either.<br/>_________________<br/><a class="postlink" href="http://www.mediafire.com/?cuyb10fzdz2" target="_blank">Strummer</a> or <a class="postlink" href="http://www.mediafire.com/?71zxcztscix" target="_blank">Drummer?</a>.  
<br/>
Or maybe you would rather play with sand? <a class="postlink" href="http://www.mediafire.com/?a05z5wmdvxm" target="_blank">Sandscape is for you in that case.</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#132585 - Lick - Wed Jun 27, 2007 11:13 pm</h4>
    <div class="postbody"><span class="postbody">Cearn wrote a nice article on <a class="postlink" href="http://user.chem.tue.nl/jakvijn/tonc/affine.htm" target="_blank">affine transformations</a>.<br/>_________________<br/><a class="postlink" href="http://licklick.wordpress.com" target="_blank">http://licklick.wordpress.com</a></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
