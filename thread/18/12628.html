<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>scaling jittering help - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>DS development > scaling jittering help</h2>
<div id="posts">
<div class="post">
    <h4>#120720 - GPFerror - Mon Mar 05, 2007 8:02 pm</h4>
    <div class="postbody"><span class="postbody">I am trying to make my Frodo c64 emulator port look a little better and was hoping for some suggestions or sample code.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">   BG3_CR = BG_BMP8_512x512;
<br/>
   BG3_XDX = DISPLAY_X-54; 
<br/>
   BG3_XDY = 0;
<br/>
   BG3_YDX = 0;
<br/>
   BG3_YDY = DISPLAY_X-108;
<br/>
   BG3_CX = 28&lt;&lt;8;
<br/>
   BG3_CY = 32&lt;&lt;8 ; 
<br/>
   frontBuffer = (uint8*)(0x06000000);
<br/>
   bufmem = (uint8*)malloc(512*512);
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
and using DMA to copy it into VRAM
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">   DC_FlushRange(bufmem, 512*512);
<br/>
   dmaCopy(bufmem,frontBuffer, (512*512)/2);</td> </tr></table><span class="postbody">
<br/>
<br/>
<br/>
where DISPLAY_X=384, and DISPLAY_Y=272, since the Frodo C64 port has borders on the left and right of 32-37 pixels and top and bottom borders of 51-55 pixels, I am shifting the screen and chopping off most of the borders so that more of the screen is displayed.
<br/>
<br/>
Someone was telling me about using jitter to make the display look a little better, I was told something about using the scroll registers to either move the screen up and left a couple pixels(or down and right) and reset it every other vblank, for the above code how would I do that?
<br/>
<br/>
Thanks,
<br/>
Troy(GPF)
<br/>
<a href="http://gpf.dcemu.co.uk" target="_blank">http://gpf.dcemu.co.uk</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#120729 - Lick - Mon Mar 05, 2007 8:43 pm</h4>
    <div class="postbody"><span class="postbody">If you shift the background position 60 times a second, by a little offset, your eyes won't notice the movement. Instead, it will blur out this 'flickering' and in result you will see a smoother image.
<br/>
<br/>
Just shift the background by 1 pixel horizontally and vertically. You should beware of the background wrapping though, otherwise you might get unwanted colors at the edges of the screen.<br/>_________________<br/><a class="postlink" href="http://licklick.wordpress.com" target="_blank">http://licklick.wordpress.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#120732 - tepples - Mon Mar 05, 2007 9:09 pm</h4>
    <div class="postbody"><span class="postbody">And you do this by changing BG3_CX and BG3_CY.
<br/>
<br/>
Another tip: Use both BG2 and BG3, displaying the same thing at different scrolls, and use the blending registers to combine them.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#120734 - GPFerror - Mon Mar 05, 2007 9:25 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tepples wrote:</b></span></td> </tr> <tr> <td class="quote">And you do this by changing BG3_CX and BG3_CY.
<br/>
<br/>
Another tip: Use both BG2 and BG3, displaying the same thing at different scrolls, and use the blending registers to combine them.</td> </tr></table><span class="postbody">
<br/>
<br/>
so in my vblank I need to do something like this move it 2 pixels down and left and then reset it ?
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">int swap=0;
<br/>
void vblankhandler()
<br/>
{
<br/>
  if(swap ==1)
<br/>
  { 
<br/>
     swap=0;
<br/>
     BG3_CX = 30&lt;&lt;8;
<br/>
     BG3_CY = 34&lt;&lt;8 ;
<br/>
  }
<br/>
  else
<br/>
  { 
<br/>
     swap=1;
<br/>
     BG3_CX = 28&lt;&lt;8;
<br/>
     BG3_CY = 32&lt;&lt;8 ;
<br/>
  }
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
<br/>
and this BG2 and BG3 blending sounds intriguing is there any sample code anywhere that might help me understand what that means :)
<br/>
<br/>
Thanks,
<br/>
Troy(GPF)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#120735 - tepples - Mon Mar 05, 2007 9:30 pm</h4>
    <div class="postbody"><span class="postbody">Don't change them by 2 whole pixels. Try changing them by half a pixel: BG3_CX = 28&lt;&lt;8 vs. BG3_CX (28&lt;&lt;8) + 128.
<br/>
<br/>
Blending between two identical BGs has been done. I developed a proof of concept on the GBA called <a class="postlink" href="http://pinocchio.jk0.org/gbaforum/alpha-lerp.zip" target="_blank">α-Lerp</a> (al fuh lurp), and nesDS uses exactly this technique for its vertical scaling. There's a wealth of discussion on some other source that the admins prohibit us from citing on this forum.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#120758 - spinal_cord - Mon Mar 05, 2007 11:24 pm</h4>
    <div class="postbody"><span class="postbody">half a pixel? GPF is attempting to scale 320 to 256 (or rather 384 to ~307)wouldnt he lose loads of pixels that way?
<br/>
<br/>
I did <a class="postlink" href="http://www.freewebs.com/sensitiveds/RotBackgrounds.nds" target="_blank">this</a> with a two pixel jump, and it seems fine, and the text if perfectly legible.<br/>_________________<br/>I'm not a boring person, it's just that boring things keep happening to me.
<br/>
<a class="postlink" href="http://spinal.dizidesigns.co.uk/" target="_blank">Homepage</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#120774 - gabebear - Tue Mar 06, 2007 1:05 am</h4>
    <div class="postbody"><span class="postbody">Jittering by more than one pixel is going to blur the scene; which may look better in some cases, but might make the screen unusable in other cases.
<br/>
<br/>
Page on anti-aliasing with jitter:
<br/>
<a href="http://www.bluevoid.com/opengl/sig00/advanced00/notes/node125.html" target="_blank">http://www.bluevoid.com/opengl/sig00/advanced00/notes/node125.html</a>
<br/>
<br/>
I have some example code that does 3D jitter with accumulation using the video capture stuff on the DS. The video capture stuff lets you combine the current output with another image in VRAM; so you can jitter the camera and keep combining frames to get full screen anti-aliasing. It requires two of the 128kb banks and 4x anti-aliasing drops the frame rate to 15fps, but it can be useful. I was using this to clean up a 3D scene when nothing was moving. Jittering the 2D background may be a better option in this case.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#120821 - spinal_cord - Tue Mar 06, 2007 8:48 am</h4>
    <div class="postbody"><span class="postbody">I think something like this. It should set a 1 pixel jitter.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
int swap=0;
<br/>
void vblankhandler()
<br/>
{
<br/>
  if(swap ==1)
<br/>
  {
<br/>
     swap=0;
<br/>
     BG3_CX = 32;
<br/>
     BG3_CY = 18;
<br/>
     BG3_YDX = 0;
<br/>
     BG3_YDY = 0;
<br/>
  }
<br/>
  else
<br/>
  {
<br/>
     swap=1;
<br/>
     BG3_CX = 33;
<br/>
     BG3_CY = 19;
<br/>
     BG3_YDX = 1;
<br/>
     BG3_YDY = 1;
<br/>
  }
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
[edit] changed from earlyer.<br/>_________________<br/>I'm not a boring person, it's just that boring things keep happening to me.
<br/>
<a class="postlink" href="http://spinal.dizidesigns.co.uk/" target="_blank">Homepage</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#120921 - kvance - Wed Mar 07, 2007 8:28 am</h4>
    <div class="postbody"><span class="postbody">This post helped me a great deal with scaling methods.  I made a quick <a class="postlink" href="http://kvance.com/fora/DSscaler.zip" target="_blank">downscaling demo</a> to compare the various methods.  This is for scaling mode 13 (320x200) down to the DS screen, which isn't all that bad for photograph-like images.
<br/>
<br/>
The X, Y, A, and B buttons switch between hardware, flicker, alerp, and flicker alerp.  L shows a prescaled image (GIMP cubic scaler).  R switches between a worst-case test pattern and a raytraced image (guess the game it's from!).
<br/>
<br/>
I'd be interested to know if there are other downscaling methods, or if I misunderstood alpha lerping, or if anyone knows some better values for the jitter tables.<br/>_________________<br/>Corner Office: <a class="postlink" href="http://lj.kvance.com/tag/corneroffice" target="_blank">dev LJ</a>
<br/>
<a class="postlink" href="http://kvance.com/project/HexxagonDS" target="_blank">HexxagonDS</a>, <a class="postlink" href="http://kvance.com/project/dsmzx/" target="_blank">dsmzx</a>, <a class="postlink" href="http://lj.kvance.com/tag/nintendo+ds" target="_blank">more...</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#120946 - tepples - Wed Mar 07, 2007 2:45 pm</h4>
    <div class="postbody"><span class="postbody">It looks OK. What you have (flicker α-Lerp) should be good for the first version. Try jittering the flicker scaling only horizontally (X) and jittering the two layers vertically (Y) and see if that looks any worse. Or try using rand() to generate jitter values.
<br/>
<br/>
Other downscaling methods include the following:
<br/>
<ul><li>Overscan: Scale only horizontally, and just drop the top and bottom 4 lines. </li><li>HDMA to the alpha register, changing the blend value per scanline. In theory, this should look much nicer when scaling by a value close to 100% (such as the 96% needed to squeeze all of mode 13h onto the DS screen), but you'll need to learn raster effects first. Want a demo? </li><li>Full software interpolation. Does ScummVM use this? </li></ul><br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#121126 - kvance - Fri Mar 09, 2007 6:27 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tepples wrote:</b></span></td> </tr> <tr> <td class="quote"><ul><li>HDMA to the alpha register, changing the blend value per scanline. In theory, this should look much nicer when scaling by a value close to 100% (such as the 96% needed to squeeze all of mode 13h onto the DS screen), but you'll need to learn raster effects first. Want a demo?</li></ul></td> </tr></table><span class="postbody">
<br/>
I've updated the <a class="postlink" href="http://kvance.com/fora/DSscaler.zip" target="_blank">scaling test</a> with my first crack at this.  I set up the blending tables to blur the 7 artifacts that occur when the BG's have a Y difference of 1.0.  Flicker is on the X-axis only.  This handles alternating 1-pixel black and white lines very well, but actually seems to look worse on the raytraced image.  I'm not sure why yet.
<br/>
<br/>
DMA on HBlank is very cool!  I've never used anything like it.<br/>_________________<br/>Corner Office: <a class="postlink" href="http://lj.kvance.com/tag/corneroffice" target="_blank">dev LJ</a>
<br/>
<a class="postlink" href="http://kvance.com/project/HexxagonDS" target="_blank">HexxagonDS</a>, <a class="postlink" href="http://kvance.com/project/dsmzx/" target="_blank">dsmzx</a>, <a class="postlink" href="http://lj.kvance.com/tag/nintendo+ds" target="_blank">more...</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#121146 - tepples - Fri Mar 09, 2007 2:51 pm</h4>
    <div class="postbody"><span class="postbody">It appears there may be a bug. Try making it so that the diagonal lines in the test pattern don't jiggle up and down so much between cubic scaling (R) and the new system (Start).<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
