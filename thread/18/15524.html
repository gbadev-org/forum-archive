<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>alloca() - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>DS development > alloca()</h2>
<div id="posts">
<div class="post">
    <h4>#156682 - simonjhall - Mon May 12, 2008 7:12 pm</h4>
    <div class="postbody"><span class="postbody">I discovered the amazingness that is alloca() recently - it's great! I can't believe I'd never used (nor heard of) this function before.
<br/>
For those who don't know, it's used for creating variable-sized arrays on the stack, not the heap. When the function returns, the compiler automatically frees the memory. Useful on targets where you don't have a new or malloc.<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#156690 - tepples - Mon May 12, 2008 8:35 pm</h4>
    <div class="postbody"><span class="postbody"><ul><li><a class="postlink" href="http://www.mkssoftware.com/docs/man3/alloca.3.asp" target="_blank">man 3 alloca</a> </li><li><a class="postlink" href="http://www.gnu.org/software/libtool/manual/libc/Advantages-of-Alloca.html" target="_blank">Advantages</a> and <a class="postlink" href="http://www.gnu.org/software/libtool/manual/libc/Disadvantages-of-Alloca.html#Disadvantages-of-Alloca" target="_blank">disadvantages</a> </li></ul>
<br/>
As I understand it, malloc() is ISO C, while alloca() is a BSD innovation. So wouldn't malloc() work on more systems than alloca()?<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#156695 - simonjhall - Mon May 12, 2008 9:16 pm</h4>
    <div class="postbody"><span class="postbody">Ah good stuff. From the disadvantages page I don't really follow: you don't get a clean error message? Does that mean that it doesn't return a NULL pointer if there's insufficient memory? I guess you just get a pointer into some place which looks stack-y but it may be further into the stack than you're allowed to go...
<br/>
<br/>
Also I don't get it how you can have a library emulation of the function - when a function finishes, how does the memory get freed? Does the compiler automatically call the appropriate memory free function?
<br/>
<br/>
And you're right, alloca seems to live in non-standard places. For instance on Visual C++ (.NET 2003 at least) it's in malloc.h but on the GCC I tried earlier it's in alloca.h (which then goes to __builtin_alloca()).
<br/>
<br/>
/ot: just watched Dispatches on Channel 4 all about anti-aging creams. One of the women inteviewed was named "Newby Hands" - wow. Just wow. Seriously.<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#156698 - Quirky - Mon May 12, 2008 9:26 pm</h4>
    <div class="postbody"><span class="postbody">As in "Get your Newby Hands off my code"?
<br/>
<br/>
Also alloca: nice! I hadn't heard of it before. The DS has a pretty small stack, so care must be taken there, right? Statically allocating big things on the stack tends to crap out in a very ugly way, I guess this would do the same.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#156701 - kusma - Mon May 12, 2008 10:19 pm</h4>
    <div class="postbody"><span class="postbody">simon, first you must understand what alloca IS - it's a subtraction on the stack-pointer. Since you usually have no knowledge of where the stack ends (in theory it often doesn't), there's no way of checking that the memory isn't there.
<br/>
<br/>
On the other side, malloc() doesn't really return NULL when out of memory on modern computers (note: this does not include the NDS or the GBA) - it only does so when it runs out of address-room. Thank god for visualization.
<br/>
<br/>
The stack-pointer is usually pushed when entering a function, and popped when leaving. This means that there's no need to free any memory, since it's returned automatically.
<br/>
<br/>
And yes, alloca is a neat function, but I don't really find too many real usecases for it reality.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#156703 - DekuTree64 - Mon May 12, 2008 10:36 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>kusma wrote:</b></span></td> </tr> <tr> <td class="quote">The stack-pointer is usually pushed when entering a function, and popped when leaving. This means that there's no need to free any memory, since it's returned automatically. </td> </tr></table><span class="postbody">
<br/>
Pushed onto what, itself? The allocation sizes or previous stack pointer would have to be kept track of somewhere. It would also affect how normal stack variables are accessed, since they normally use constant offsets from the stack pointer. Especially tricky in thumb code, where there are special instructions for stack-relative access, so you can't just copy the original stack to another register and use that.
<br/>
<br/>
Maybe I'll do some disassembly testing on it later to see what actually happens.<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#156704 - simonjhall - Mon May 12, 2008 10:45 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>kusma wrote:</b></span></td> </tr> <tr> <td class="quote">simon, first you must understand what alloca IS - it's a subtraction on the stack-pointer. Since you usually have no knowledge of where the stack ends (in theory it often doesn't), there's no way of checking that the memory isn't there.</td> </tr></table><span class="postbody">Yeah that's what I had thought!
<br/>
Thing is though, compilers can add in run-time checking of the stack pointer (gcc has an -fstack-check option as well as -fstack-limit-* stuff) so I had imagined that somehow it'd pull a null pointer out if it ran out of room :-)
<br/>
<br/>
As you say though, it may not be too useful. However I'll see if I can find some use for it on my baby at work though...
<br/>
<br/>
@DekuTree64
<br/>
I found this gem of a function in the awesome book "See MIPS run" and it implemented the function through a combination of two pointers/registers, sp and fp. Normal usage of the stack would just use sp but when you drop a variable-sized stack frame into the mix (via alloca) it'd use the two registers to do work within the function.
<br/>
<br/>
I don't have the book with me so can't divulge further.
<br/>
(God knows what happens on x86)
<br/>
<br/>
EDIT: so what DOES happen with compilers that don't support alloca() and it's done through a library that (presumably) uses malloc()?<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#156705 - kusma - Mon May 12, 2008 10:48 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>DekuTree64 wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
Pushed onto what, itself? The allocation sizes or previous stack pointer would have to be kept track of somewhere.</td> </tr></table><span class="postbody">
<br/>
Uhm, good point (I'm quite tired - packing to a company trip (UK) tomorrow morning). What happens with the stack is that a value is subtracted (not pushed, silly me) from the stack to make room for any variables allocated there, and added back again once the function returns. Now, exactly what happens with dynamically allocated stack-space, I'm not entirely sure of (and I suspect it varies among implementations), but I suspect a hidden variable is constructed (most likely on the stack itself), initialized to zero, and added to inside alloca(). Dead code elimination and/or constant folding will make sure that it doesn't cost anything in functions that does not use alloca.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#156722 - Dwedit - Tue May 13, 2008 9:18 am</h4>
    <div class="postbody"><span class="postbody">I bet some abuse of setjump and longjump could simulate destruction of alloca'ed memory in C.
<br/>
edit: no it can't... Gotta stop posting at 3:21 AM...<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#156801 - tepples - Wed May 14, 2008 12:32 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>simonjhall wrote:</b></span></td> </tr> <tr> <td class="quote">Also I don't get it how you can have a library emulation of the function - when a function finishes, how does the memory get freed? Does the compiler automatically call the appropriate memory free function?</td> </tr></table><span class="postbody">
<br/>
<a class="postlink" href="http://search.cpan.org/src/SFINK/perl-bison-1.25.1.1/alloca.c" target="_blank">Bison approximates it</a> something like this: <ol type="1"><li>Detect where on the stack the alloca() was called. </li><li>Collect garbage: free() all alloca()tions that were done with a stack taller than this one. </li><li>malloc() the memory. </li><li>Keep track of the allocated block along with where on the stack this alloca() was performed. </li></ol>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>kusma wrote:</b></span></td> </tr> <tr> <td class="quote">Since you usually have no knowledge of where the stack ends (in theory it often doesn't), there's no way of checking that the memory isn't there. </td> </tr></table><span class="postbody">
<br/>
In many cases, the linker emits a symbol indicating the start of the section intended as the stack. Couldn't alloca() have been designed to compare the stack pointer to this address? I would bet that some implementations do, as simonjhall hinted with the comment about -fstack-check.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>kusma wrote:</b></span></td> </tr> <tr> <td class="quote">On the other side, malloc() doesn't really return NULL when out of memory on modern computers (note: this does not include the NDS or the GBA) - it only does so when it runs out of address-room.</td> </tr></table><span class="postbody">
<br/>
Even worse, sometimes it succeeds and then your program crashes when it tries to <span style="font-style: italic">write</span> to the memory (see "Moral #2" on <a class="postlink" href="http://www.gotw.ca/publications/mill16.htm" target="_blank">this page</a>).
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>DekuTree64 wrote:</b></span></td> </tr> <tr> <td class="quote">It would also affect how normal stack variables are accessed, since they normally use constant offsets from the stack pointer.</td> </tr></table><span class="postbody">
<br/>
Apparently, functions that call alloca() need to use a separate register to hold the old stack pointer, called the "frame pointer".
<br/>
<br/>
It appears that alloca() is designed to fit into the C mindset, which has no built-in concept of destructors. It gets <span style="font-style: italic">much</span> tricker with non-POD types in C++ because you have to make sure that a class's constructor and destructor (or struct's conclassor and declassor[1]) get called somehow.
<br/>
<br/>
<br/>
[1] Pun.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#156822 - simonjhall - Wed May 14, 2008 7:47 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tepples wrote:</b></span></td> </tr> <tr> <td class="quote">[1] Pun.</td> </tr></table><span class="postbody">LOL - I got it at least.<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#156828 - keldon - Wed May 14, 2008 12:17 pm</h4>
    <div class="postbody"><span class="postbody">Close ...
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#define kalloca(varname,type) \
<br/>
    char varname ## _alloca [sizeof(type)]; \
<br/>
   type &amp;varname = *(type*) varname ## _alloca
<br/>
<br/>
int main (void)
<br/>
{
<br/>
   typedef int myarray[10];
<br/>
   
<br/>
   kalloca (myvar, myarray);
<br/>
   
<br/>
   return 0;
<br/>
}</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
