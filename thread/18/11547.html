<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Fat Library optimization by adding a task scheduler? - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > Fat Library optimization by adding a task scheduler?</h2>
<div id="posts">
<div class="post">
    <h4>#107148 - Dwedit - Fri Oct 27, 2006 5:33 am</h4>
    <div class="postbody"><span class="postbody">This probably requires that the DS or GBA have some kind of operating system to handle task switching, but it looks like a huge possible speed improvement to the FAT library.
<br/>
There are time where the FAT library spinlocks on when the disk is ready, and on when the data becomes available.  Since afterwards, the transfer is quick, I think that the spinlock should be converted into timed polling, and while it's busy, yield the processor to another task.
<br/>
This could allow an API including functions like fread_background, which would update a size counter indicating how much has been read, so a file could call this, test if enough has been transferred into a buffer, then work on what data is available.  Data could be processed during the time formerly used for spinlock.  I think it could speed up media-playback programs quite a bit.<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#107151 - josath - Fri Oct 27, 2006 6:58 am</h4>
    <div class="postbody"><span class="postbody">A possible issue might be that from what I understand, some of the FS drivers require EXACT timing. Having stuff running in a separate thread might impact that timing.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#107239 - tepples - Fri Oct 27, 2006 10:39 pm</h4>
    <div class="postbody"><span class="postbody">Then would it be possible to have some function that tells whether the inserted card supports non-blocking sector reads? Or the exact timing issue could be solved by running the block device driver on ARM7 while game code runs on ARM9.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#107253 - josath - Sat Oct 28, 2006 12:48 am</h4>
    <div class="postbody"><span class="postbody">I think libfat can already be run on arm7, in which case this would be pretty easy to implement. Simply have a function on arm9 which requests the arm7 to read data in the background, and then arm7 will alert the arm9 when the read is done.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#107284 - tepples - Sat Oct 28, 2006 5:55 am</h4>
    <div class="postbody"><span class="postbody">And here's an idea to make this work, which resembles the way it's done in Real Operating Systems(tm) and on Real Game Consoles(tm): Run the file system on the ARM9 and the block device driver on the ARM7. Have the ARM7 prefetch up to 64 kilobytes of sectors when it gets free time. This way, sector requests from the ARM9 appear to complete almost immediately.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#107296 - Dark Knight ez - Sat Oct 28, 2006 9:34 am</h4>
    <div class="postbody"><span class="postbody">With extensive music playing libraries on the ARM7 (libmikmod in some projects), wouldn't they (the lib executing and FAT code executing) hinder each other?
<br/>
I'm hoping most projects will put their music playing libraries on ARM7, which is the cleaner way to do things, so I am hoping this is given some thought.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#107302 - OOPMan - Sat Oct 28, 2006 10:19 am</h4>
    <div class="postbody"><span class="postbody">Hmmmm, if you multi-threaded them (The sound and background reading functionality) on the ARM7 then you might do okay. Might.<br/>_________________<br/>"My boot, your face..." - Attributed to OOPMan, Emperor of Eroticon VI
<br/>
<br/>
You can find my NDS homebrew projects <a class="postlink" href="http://blog.dev-scene.com/oopman/" target="_blank">here...</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#107343 - tepples - Sat Oct 28, 2006 8:34 pm</h4>
    <div class="postbody"><span class="postbody">OOPMan is right. It probably wouldn't be too hard to prefetch sectors from the block device as requested by the ARM9 during any period that the ARM7 isn't doing touch screen I/O or mixing sound.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
