<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>filesystem problem : using dirnext with long filenames - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > filesystem problem : using dirnext with long filenames</h2>
<div id="posts">
<div class="post">
    <h4>#120996 - Paco_777 - Thu Mar 08, 2007 12:45 am</h4>
    <div class="postbody"><span class="postbody">Hi,
<br/>
I'm scanning all the filesystem in order to find some specific files.
<br/>
To achieve this, i'm using the dirnext method of the last devkitARM
<br/>
I do it this usual way : 
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">DIR_ITER* dir = diropen (nameTempBufferDir);
<br/>
if (dir!=NULL) {
<br/>
   while (dirnext(dir, nameTempBufferFile, &amp;st) == 0) {
<br/>
         // do stuffs
<br/>
   }
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
I performed my tests on a Supercard SD.
<br/>
I'm facing a problem : my loop stops with files which have a very big filename.
<br/>
At least with the following filename in the root directory :
<br/>
"this is a very big file ndkslepslamdoeldmsoemdoeld this is a very big file ndkslepslamdoeldmsoemdoeld this is a very big file ndkslepslamdoeldmsoemdoeld this is a very big file ndkslepslamdoeldmsothis is a very big file ndkslepslamdoeldmsoemdoeld .txt"
<br/>
<br/>
<br/>
I made another version, trying to use errno in order to bypass incorrect files :
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">bool dirok;
<br/>
DIR_ITER* dir = diropen (nameTempBufferDir);
<br/>
if (dir!=NULL) {
<br/>
   dirok = ((dirnext(dir, nameTempBufferFile, &amp;st) == 0) || (errno!=ENOENT));
<br/>
   while (dirok) {
<br/>
      if (errno!=ENOENT){
<br/>
         // do stuffs
<br/>
      }
<br/>
      dirok = ((dirnext(dir, nameTempBufferFile, &amp;st) == 0) || (errno!=ENOENT));
<br/>
   }
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
Unfortunately, the loop is endless and the 'bad' filename cannot be bypassed.
<br/>
<br/>
Is there a solution for that problem ?
<br/>
<br/>
By the way, dirnext should have a maxlength parameter (the size of the filename buffer) in order to avoid memory corruption when
<br/>
the filename is written to the char *.<br/>_________________<br/><a href="http://Gnese.free.fr/NDS/" target="_blank">http://Gnese.free.fr/NDS/</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#121022 - HyperHacker - Thu Mar 08, 2007 7:07 am</h4>
    <div class="postbody"><span class="postbody">That's probably what's happening. Your huge file names are exceeding the buffer.<br/>_________________<br/>I'm a PSP hacker now, but I still &lt;3 DS.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#121024 - chishm - Thu Mar 08, 2007 7:49 am</h4>
    <div class="postbody"><span class="postbody">Max filename length is 256 chars. It should be defined somewhere, but I can't seem to find it.<br/>_________________<br/><a class="postlink" href="http://chishm.drunkencoders.com" target="_blank">http://chishm.drunkencoders.com</a>
<br/>
<a class="postlink" href="http://dldi.drunkencoders.com" target="_blank">http://dldi.drunkencoders.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#121542 - Paco_777 - Tue Mar 13, 2007 12:56 am</h4>
    <div class="postbody"><span class="postbody">ok, thanks (luckyly, my buffer size was 256:) ).
<br/>
<br/>
Would it be possible to have dirnext skip files with filenames bigger that 256 characters ?
<br/>
There is perhaps another way to list all the files in my filesystem (without stopping on some of them) , but i cannot figure how :/
<br/>
<br/>
well, of course removing the big filenames will do the job, but i cannot ensure that every user will have a clean card :)
<br/>
<br/>
(At least, i think that i can use chdir in order to reduce the total length of my filename+dirname).<br/>_________________<br/><a href="http://Gnese.free.fr/NDS/" target="_blank">http://Gnese.free.fr/NDS/</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#121556 - chishm - Tue Mar 13, 2007 3:20 am</h4>
    <div class="postbody"><span class="postbody">The FAT long file name specifications specify that a filename must be no more than 255 characters long. If you have a filename longer than this, it is outside of specs.<br/>_________________<br/><a class="postlink" href="http://chishm.drunkencoders.com" target="_blank">http://chishm.drunkencoders.com</a>
<br/>
<a class="postlink" href="http://dldi.drunkencoders.com" target="_blank">http://dldi.drunkencoders.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#121565 - HyperHacker - Tue Mar 13, 2007 5:06 am</h4>
    <div class="postbody"><span class="postbody">So what does happen if we have a file with an excessively long name on our card?<br/>_________________<br/>I'm a PSP hacker now, but I still &lt;3 DS.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#121573 - chishm - Tue Mar 13, 2007 6:54 am</h4>
    <div class="postbody"><span class="postbody">It shouldn't pass a chkdsk/scandisk test. If you try to use it with libfat, it'll likely cause buffer overflows.<br/>_________________<br/><a class="postlink" href="http://chishm.drunkencoders.com" target="_blank">http://chishm.drunkencoders.com</a>
<br/>
<a class="postlink" href="http://dldi.drunkencoders.com" target="_blank">http://dldi.drunkencoders.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#121626 - tepples - Tue Mar 13, 2007 4:09 pm</h4>
    <div class="postbody"><span class="postbody">What about a filename with "Pok?mon" repeated 36 times? That's 252 characters but it comes out to 288 bytes due to UTF-8 encoding.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#121631 - Diddl - Tue Mar 13, 2007 4:17 pm</h4>
    <div class="postbody"><span class="postbody">nobody needs such long filenames. but buffer overflow should not happen, - it should be repaired by a new version of libfat.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#121725 - chishm - Wed Mar 14, 2007 9:51 am</h4>
    <div class="postbody"><span class="postbody">tepples:
<br/>
LFNs are encoded using UCS-2 in the FAT filename structures on disc. Libfat only uses the low byte, which can cause problems, but will be fixed in future. When that happens, the buffers passed to libfat likely need to be 768 bytes, with the names stored internally as UCS-2.
<br/>
<br/>
Diddl:
<br/>
It's not that nobody needs the filenames. They shouldn't actually exist, since they are not allowed by the FAT specs. That begin said, I have added code to prevent buffer overflows due to excessively long LFNs.<br/>_________________<br/><a class="postlink" href="http://chishm.drunkencoders.com" target="_blank">http://chishm.drunkencoders.com</a>
<br/>
<a class="postlink" href="http://dldi.drunkencoders.com" target="_blank">http://dldi.drunkencoders.com</a></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
