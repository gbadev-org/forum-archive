<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Working in emulators (kinda) but not on real hardware - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>DS development > Working in emulators (kinda) but not on real hardware</h2>
<div id="posts">
<div class="post">
    <h4>#46773 - LOst? - Thu Jun 30, 2005 1:08 pm</h4>
    <div class="postbody"><span class="postbody">I have a problem with my first DS demo. I have set up the main display to show one BG, and it uses map, palette, and tiles from my GBA demo. In dsemu the actual tiles the map is showing are corrupted, and in dualis it shows up like it's supposed to. On the real hardware everything is just black.
<br/>
<br/>
Have you had this problem? Is there something I need to think about?
<br/>
<br/>
Here are the settings I use:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
      // Power on both displays using 2-D core
<br/>
      POWER_CR = POWER_LCD_TOP | POWER_2D | POWER_LCD_BOTTOM | POWER_2D_SUB;
<br/>
   
<br/>
      // Assign main BG to VRAM_A
<br/>
      VRAM_A_CR = VRAM_ENABLE | VRAM_A_MAIN_BG;
<br/>
 
<br/>
      // Enable BG 0 on the main display
<br/>
      DISPLAY_CR = MODE_0_2D | DISPLAY_BG_EXT_PALETTE | DISPLAY_BG0_ACTIVE;
<br/>
   
<br/>
      // Disable sub display
<br/>
      SUB_DISPLAY_CR = 0;
<br/>
<br/>
      // Configure BG 0
<br/>
      BG0_CR = BG_16_COLOR | BG_TILE_BASE (1) | BG_MAP_BASE (0) | BG_32x32;
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
      // Copy ROM palette
<br/>
      dmaCopyWords (3, bgPalette, bg_palette, 128 * 4);
<br/>
<br/>
      // Copy tiles
<br/>
      u16* bg0_tiles = (u16*) BG_TILE_RAM (1);
<br/>
      dmaCopyWords (3, bgTiles, bg0_tiles, (sizeof (bgTiles)) * 4);
<br/>
   
<br/>
      // Copy map
<br/>
      u16* bg0_map = (u16*) BG_MAP_RAM (0);
<br/>
      dmaCopyWords (3, bgMap, bg0_map, (sizeof (bgMap)) * 4);
<br/>
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Something's wrong here? Something I forgot?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#46818 - LOst? - Fri Jul 01, 2005 3:14 am</h4>
    <div class="postbody"><span class="postbody">Impossible to develop for the DS. I just need to change one little thing in the code to make emulators crash. And it still is black all over the real hardware display.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#46821 - rize - Fri Jul 01, 2005 3:42 am</h4>
    <div class="postbody"><span class="postbody">Well, you shouldn't have extended palettes enabled if you're only using 16 color mode.
<br/>
<br/>
Also, if you're using 16 color mode, then the palette for your graphics should be designed for that and your tiles better index the palettes appropriately.
<br/>
<br/>
I'm not familiar with dma yet so I'm not sure if you're doing that right.  Are you putting the palette in the right place?
<br/>
<br/>
Aside from the dma which I don't fully understand yet, the only other thing that strikes me as off is bg_palette
<br/>
<br/>
The macro BG_PALETTE points to the normal location for the ordinary main screen palette (16x16 or 256)
<br/>
<br/>
If all of that is straight and you're loading memory properly, it should work.  Dualis suggests that you're loading memory properly, except maybe the palette.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#46824 - LOst? - Fri Jul 01, 2005 4:04 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>rize wrote:</b></span></td> </tr> <tr> <td class="quote">Well, you shouldn't have extended palettes enabled if you're only using 16 color mode.
<br/>
<br/>
Also, if you're using 16 color mode, then the palette for your graphics should be designed for that and your tiles better index the palettes appropriately.
<br/>
<br/>
I'm not familiar with dma yet so I'm not sure if you're doing that right.  Are you putting the palette in the right place?
<br/>
<br/>
Aside from the dma which I don't fully understand yet, the only other thing that strikes me as off is bg_palette
<br/>
<br/>
The macro BG_PALETTE points to the normal location for the ordinary main screen palette (16x16 or 256)
<br/>
<br/>
If all of that is straight and you're loading memory properly, it should work.  Dualis suggests that you're loading memory properly, except maybe the palette.</td> </tr></table><span class="postbody">
<br/>
<br/>
The problem is the dma. I'm copying the array bg_palette to BG_PALETTE using DMA during the Vblank interrupt. The DMA doesn't work on the real hardware. And channel 3 only works in the emulator. I want to use channel 0 (immediate copy).
<br/>
<br/>
DMA is there for usage. I don't like it when I can't use it.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#46825 - rize - Fri Jul 01, 2005 4:09 am</h4>
    <div class="postbody"><span class="postbody">yeah.  the extended palette flag should be ignored if you set the color for a bg to 16 color mode
<br/>
<br/>
so I'm not surprised it's the dma.  I don't know much about dma yet, but you can probably sort it out if you've used it on the gba</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#46827 - LOst? - Fri Jul 01, 2005 4:15 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>rize wrote:</b></span></td> </tr> <tr> <td class="quote">yeah.  the extended palette flag should be ignored if you set the color for a bg to 16 color mode
<br/>
<br/>
so I'm not surprised it's the dma.  I don't know much about dma yet, but you can probably sort it out if you've used it on the gba</td> </tr></table><span class="postbody">
<br/>
<br/>
In GBA I have to use DMA0 because nothing else can set the background offsets during VBlank interrupt. That means I will not be able to scroll the first scanline.
<br/>
<br/>
The extended palette flag is from your example. I have removed it now. It doesn't really make any difference right now.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#46833 - LOst? - Fri Jul 01, 2005 5:07 am</h4>
    <div class="postbody"><span class="postbody">&gt;.&lt;; DMA doesn't work. Why is DS unable to use DMA (in ARM9)?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#46834 - DekuTree64 - Fri Jul 01, 2005 5:14 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>LOst? wrote:</b></span></td> </tr> <tr> <td class="quote">&gt;.&lt;; DMA doesn't work. Why is DS unable to use DMA (in ARM9)?</td> </tr></table><span class="postbody">
<br/>
<br/>
Cache. You're probably trying to DMA from memory that hasn't been flushed out of the cache yet, so it's not what you're expecting it to be.
<br/>
<br/>
Or DMAing TO a place that hasn't been flushed, and then when it is flushed it overwrites your DMA'd data.
<br/>
<br/>
Solution: Flush the memory ranges involved before doing a DMA.<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#46835 - LOst? - Fri Jul 01, 2005 5:18 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>DekuTree64 wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>LOst? wrote:</b></span></td> </tr> <tr> <td class="quote">&gt;.&lt;; DMA doesn't work. Why is DS unable to use DMA (in ARM9)?</td> </tr></table><span class="postbody">
<br/>
<br/>
Cache. You're probably trying to DMA from memory that hasn't been flushed out of the cache yet, so it's not what you're expecting it to be.
<br/>
<br/>
Or DMAing TO a place that hasn't been flushed, and then when it is flushed it overwrites your DMA'd data.
<br/>
<br/>
Solution: Flush the memory ranges involved before doing a DMA.</span></td> </tr></table><span class="postbody">
<br/>
<br/>
How do I flush the memory? Also how to I place the arrays in the bigger memory (not the 32k)?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#46837 - DekuTree64 - Fri Jul 01, 2005 5:26 am</h4>
    <div class="postbody"><span class="postbody">Try DC_FlushAll(). Not sure, but there might be a DC_FlushRange or something to only flush the areas you want. Flush all should be fine though.
<br/>
<br/>
To put an array in main RAM, you'll need to use an attribute to tell it to go into the .ewram section. I don't remember the exact syntax, but I think there's a #define called VAR_IN_EXRAM for it. To use that, do like
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">u8 bigArray[32769] VAR_IN_EXRAM;</td> </tr></table><span class="postbody">
<br/>
and it should go into main RAM (4MB).<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#46838 - LOst? - Fri Jul 01, 2005 5:29 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>DekuTree64 wrote:</b></span></td> </tr> <tr> <td class="quote">DC_FlushAll()</td> </tr></table><span class="postbody">
<br/>
Do I need to flush every time I use DMA?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#46840 - DekuTree64 - Fri Jul 01, 2005 5:36 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>LOst? wrote:</b></span></td> </tr> <tr> <td class="quote">Do I need to flush every time I use DMA?</td> </tr></table><span class="postbody">
<br/>
<br/>
Pretty much. If you're sure your data isn't in the cache, then you don't need to, but most of the time there's no guarantee. Kind of sucks when you're used to using it for everything on GBA, but it is still useful for blasting things to VRAM, or copying other large chunks of data around.
<br/>
<br/>
For small chunks of data, you'll probably be better off with a normal CPU copy.<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#46841 - LOst? - Fri Jul 01, 2005 5:36 am</h4>
    <div class="postbody"><span class="postbody">VAR_IN_EXRAM was a success! The DMA now works because the memory array is in the right place</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#46842 - LOst? - Fri Jul 01, 2005 5:38 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>DekuTree64 wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>LOst? wrote:</b></span></td> </tr> <tr> <td class="quote">Do I need to flush every time I use DMA?</td> </tr></table><span class="postbody">
<br/>
<br/>
Pretty much. If you're sure your data isn't in the cache, then you don't need to, but most of the time there's no guarantee. Kind of sucks when you're used to using it for everything on GBA, but it is still useful for blasting things to VRAM, or copying other large chunks of data around.
<br/>
<br/>
For small chunks of data, you'll probably be better off with a normal CPU copy.</span></td> </tr></table><span class="postbody">
<br/>
<br/>
What I plan to do is using HDMA. It will do a DMA every hblank, so that I can do raster effects. I hope one flush will be enough &lt;.&lt;;</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#46844 - DekuTree64 - Fri Jul 01, 2005 5:50 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>LOst? wrote:</b></span></td> </tr> <tr> <td class="quote">What I plan to do is using HDMA. It will do a DMA every hblank, so that I can do raster effects. I hope one flush will be enough &lt;.&lt;;</td> </tr></table><span class="postbody">
<br/>
<br/>
Yeah, once you finish filling out your table, flush it and you should be good to go. 
<br/>
<br/>
It doesn't matter if it ends up back in the cache at some point (by reading data near it or something), because the correct data is in RAM, and unless you change it, the same data would be in the cache too.
<br/>
<br/>
It's confusing, but the speed is worth it when your memory is as slow as the DS's main RAM :)<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#46845 - LOst? - Fri Jul 01, 2005 6:06 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>DekuTree64 wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>LOst? wrote:</b></span></td> </tr> <tr> <td class="quote">What I plan to do is using HDMA. It will do a DMA every hblank, so that I can do raster effects. I hope one flush will be enough &lt;.&lt;;</td> </tr></table><span class="postbody">
<br/>
<br/>
Yeah, once you finish filling out your table, flush it and you should be good to go. 
<br/>
<br/>
It doesn't matter if it ends up back in the cache at some point (by reading data near it or something), because the correct data is in RAM, and unless you change it, the same data would be in the cache too.
<br/>
<br/>
It's confusing, but the speed is worth it when your memory is as slow as the DS's main RAM :)</span></td> </tr></table><span class="postbody">
<br/>
<br/>
How do I set up the HDMA? This didn't work:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
s16 scanline [192*2] VAR_IN_EXRAM;
<br/>
<br/>
...
<br/>
   DC_FlushAll ();
<br/>
<br/>
   DMA_SRC(0) = (uint32) scanline;
<br/>
   DMA_DEST(0) = (uint32) BG0_X0;
<br/>
   DMA_CR(0) = DMA_16_BIT | DMA_START_HBL | DMA_REPEAT | DMA_DST_RESET | DMA_ENABLE | 2;
<br/>
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#46849 - DekuTree64 - Fri Jul 01, 2005 6:36 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>LOst? wrote:</b></span></td> </tr> <tr> <td class="quote">How do I set up the HDMA? This didn't work:
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">...
<br/>
   DMA_DEST(0) = (uint32) BG0_X0;
<br/>
...</td> </tr></table><span class="postbody"></span></td> </tr></table><span class="postbody">
<br/>
<br/>
Make that 
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">   DMA_DEST(0) = (uint32) &amp;BG0_X0;</td> </tr></table><span class="postbody">
<br/>
the rest looks fine to me<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#46851 - LOst? - Fri Jul 01, 2005 7:17 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>DekuTree64 wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>LOst? wrote:</b></span></td> </tr> <tr> <td class="quote">How do I set up the HDMA? This didn't work:
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">...
<br/>
   DMA_DEST(0) = (uint32) BG0_X0;
<br/>
...</td> </tr></table><span class="postbody"></span></td> </tr></table><span class="postbody">
<br/>
<br/>
Make that 
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">   DMA_DEST(0) = (uint32) &amp;BG0_X0;</td> </tr></table><span class="postbody">
<br/>
the rest looks fine to me</span></td> </tr></table><span class="postbody">
<br/>
<br/>
Only one problem. DMA0 doesn't work. And you can't use DMA3</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#46852 - DekuTree64 - Fri Jul 01, 2005 7:33 am</h4>
    <div class="postbody"><span class="postbody">Huh? Why doesn't DMA0 work? And why can't you use 3?<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#46862 - LOst? - Fri Jul 01, 2005 12:18 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>DekuTree64 wrote:</b></span></td> </tr> <tr> <td class="quote">Huh? Why doesn't DMA0 work? And why can't you use 3?</td> </tr></table><span class="postbody">
<br/>
DMA3 isn't as high priority to finish the copy at the Hblank (why DMA0 is needed when doing HDMA).
<br/>
<br/>
DMA0 won't work in emulators, and it is hard to see if something even happened on the real hardware.
<br/>
<br/>
EDIT: All of a sudden DMA0 works, and so do HDMA. Wierd. I have worked for so many hours, and all it needed was a little bit sleep (me sleeping of course, not the code)
<br/>
<br/>
EDIT: But not on the real hardware &gt;.&lt;;</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
