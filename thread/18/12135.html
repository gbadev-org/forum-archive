<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Sprites show in Dualis, but not Hardware [SOLVED] - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>DS development > Sprites show in Dualis, but not Hardware [SOLVED]</h2>
<div id="posts">
<div class="post">
    <h4>#114873 - JessTicular - Thu Jan 11, 2007 6:01 am</h4>
    <div class="postbody"><span class="postbody">Howdy :)
<br/>
<br/>
I'm not exactly new to DS development, but this one has me stumped!
<br/>
<br/>
I've set up and am using sprites (tall rotated, square rotated and just square), all of which display perfectly in Dualis, and function without any worries.
<br/>
<br/>
However, when I upload it to my DS (WiFiMe), the sprites simply wont show. All the game logic works, I can still press the buttons, and the touch-screen interface works fine, yet no Sprites...
<br/>
<br/>
some code:
<br/>
<a class="postlink" href="http://jt0.org/dl/ds/xmas/main_arm9.cpp" target="_blank">main_arm9.cpp</a> (main code)
<br/>
<a class="postlink" href="http://jt0.org/dl/ds/xmas/sprites.cpp" target="_blank">sprites.cpp</a> (sprite handling)
<br/>
<br/>
and a binary so you can check for yourself (to make sure it's not my DS :P)
<br/>
<a class="postlink" href="http://jt0.org/dl/ds/xmas/xmas.nds" target="_blank">xmas.nds</a> (~723KB)
<br/>
( The game-logic for the code and binary supplied have been removed to make sure none of that was interfering )
<br/>
<br/>
<br/>
Thanks for any and all help that you can provide!
<br/>
<br/>
Jess.
<br/>
<br/>
<span style="font-weight: bold">[SOLUTION]</span>
<br/>
<br/>
The problem was with the Alpha.
<br/>
I had: <span style="font-style: italic">sprites[0].attribute[2] = ATTR2_ALPHA(0)</span>
<br/>
When I should have had: <span style="font-style: italic">sprites[0].attribute[2] = ATTR2_ALPHA(1)</span>
<br/>
<br/>
I don't know why its different between hardware and emulator, but it is, and lesson learnt!
<br/>
<br/>
<span style="font-weight: bold">[/SOLUTION]</span><br/>_________________<br/><span style="font-size: 9px; line-height: normal"><span style="font-weight: bold">Nintendo DS &amp; Dominos :: <a class="postlink" href="http://dsdominos.sourceforge.net" target="_blank">DS Dominos</a></span>
<br/>
<a class="postlink" href="http://jt0.org" target="_blank">http://jt0.org</a></span></span><span class="gensmall"><br/><br/>Last edited by JessTicular on Sat Jan 13, 2007 8:35 am; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#114890 - JessTicular - Thu Jan 11, 2007 9:32 am</h4>
    <div class="postbody"><span class="postbody">Ok, I extended my searching outside of just the NDS boards and found <a class="postlink" href="http://forum.gbadev.org/viewtopic.php?t=8548&amp;highlight=sprites+hardware" target="_blank">this</a> thread that has a similar problem.
<br/>
<br/>
I'm pretty sure that that is the problem, as I have read (quite a few times actually) about it. I'll go and try it now :)
<br/>
<br/>
[EDIT]
<br/>
Nope, no-go... I'm writting u16's which should be perfectly safe.
<br/>
[/EDIT]
<br/>
<br/>
[EDIT2]
<br/>
I'm not even doing that, I'm copying entire blocks (admittedly, non-aligned blocks) of the entire image across at a time!
<br/>
[/EDIT2]<br/>_________________<br/><span style="font-size: 9px; line-height: normal"><span style="font-weight: bold">Nintendo DS &amp; Dominos :: <a class="postlink" href="http://dsdominos.sourceforge.net" target="_blank">DS Dominos</a></span>
<br/>
<a class="postlink" href="http://jt0.org" target="_blank">http://jt0.org</a></span></span><span class="gensmall"><br/><br/>Last edited by JessTicular on Thu Jan 11, 2007 4:04 pm; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#114910 - Lick - Thu Jan 11, 2007 3:15 pm</h4>
    <div class="postbody"><span class="postbody">Don't use DMACopy. Use memcpy (string.h) instead.
<br/>
<br/>
Also, try adding DISPLAY_SPR_1D_LAYOUT.<br/>_________________<br/><a class="postlink" href="http://licklick.wordpress.com" target="_blank">http://licklick.wordpress.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#114915 - JessTicular - Thu Jan 11, 2007 4:03 pm</h4>
    <div class="postbody"><span class="postbody">I never thought of trying memcpy instead of dmaCopy, but unfortunately it didn't work, and neither did the DISPLAY_SPR_1D_LAYOUT flag.
<br/>
<br/>
Thanks all the same, though.<br/>_________________<br/><span style="font-size: 9px; line-height: normal"><span style="font-weight: bold">Nintendo DS &amp; Dominos :: <a class="postlink" href="http://dsdominos.sourceforge.net" target="_blank">DS Dominos</a></span>
<br/>
<a class="postlink" href="http://jt0.org" target="_blank">http://jt0.org</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#115002 - koryspansel - Fri Jan 12, 2007 3:26 am</h4>
    <div class="postbody"><span class="postbody">This is just a (long) shot in the dark...but, maybe, you need to update the OAM in your main loop?  It would seem pretty ridiculous for the DS to clear the OAM each frame, but that could explain why it works on the emulator.
<br/>
<br/>
--
<br/>
Kory</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#115134 - JessTicular - Sat Jan 13, 2007 4:50 am</h4>
    <div class="postbody"><span class="postbody">koryspansel,
<br/>
<br/>
Unforunatly that doesn't work either :( Good idea, though.<br/>_________________<br/><span style="font-size: 9px; line-height: normal"><span style="font-weight: bold">Nintendo DS &amp; Dominos :: <a class="postlink" href="http://dsdominos.sourceforge.net" target="_blank">DS Dominos</a></span>
<br/>
<a class="postlink" href="http://jt0.org" target="_blank">http://jt0.org</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#115141 - JessTicular - Sat Jan 13, 2007 5:54 am</h4>
    <div class="postbody"><span class="postbody">Alright, this is getting to be rediculous...
<br/>
<br/>
I've pretty much mutilated my code to bring it to down to the very, very basics of what should be done to get a sprite to work.
<br/>
And yet, it <span style="font-style: italic">still doesn't work</span> :(
<br/>
<br/>
Looky;
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#include &lt;nds.h&gt;
<br/>
#include &lt;stdio.h&gt;
<br/>
#include &lt;cstdlib&gt;
<br/>
#include &lt;string.h&gt;
<br/>
<br/>
<br/>
// Sprites
<br/>
SpriteEntry sprites[128];
<br/>
<br/>
//turn off all the sprites
<br/>
void initSprites(SpriteEntry* sprites)
<br/>
{
<br/>
   for(int i = 0; i &lt; 128; i++){
<br/>
      sprites[i].attribute[0] = ATTR0_DISABLED; // 'Hidden' Bit Setter
<br/>
      sprites[i].attribute[1] = 0;
<br/>
      sprites[i].attribute[2] = 0;
<br/>
      sprites[i].attribute[3] = 0;
<br/>
   }
<br/>
}
<br/>
<br/>
//copy our sprite to object attribute memory
<br/>
void updateOAM(SpriteEntry* sprPtr, int size)
<br/>
{
<br/>
   DC_FlushAll();
<br/>
   dmaCopy(sprPtr, OAM, size * sizeof(SpriteEntry));
<br/>
}
<br/>
<br/>
<br/>
//---------------------------------------------------------------------------------
<br/>
void VblankHandler(void) {
<br/>
//---------------------------------------------------------------------------------
<br/>
   if(REG_IF &amp; IRQ_VBLANK) {
<br/>
      // Handle vertical blank interrupt
<br/>
      VBLANK_INTR_WAIT_FLAGS |= IRQ_VBLANK;
<br/>
      REG_IF |= IRQ_VBLANK;
<br/>
   }else{
<br/>
      // Ignore all other interrupts
<br/>
      REG_IF = REG_IF;
<br/>
   }
<br/>
<br/>
}
<br/>
<br/>
//---------------------------------------------------------------------------------
<br/>
int main(void) {
<br/>
//---------------------------------------------------------------------------------
<br/>
<br/>
   powerON(POWER_ALL_2D);
<br/>
   irqInit();
<br/>
   irqSet(IRQ_VBLANK, VblankHandler);
<br/>
   irqEnable(IRQ_VBLANK);
<br/>
   lcdSwap();
<br/>
<br/>
   // Set the mode to 0 and activate 1D Sprites
<br/>
   videoSetMode(MODE_0_2D | DISPLAY_SPR_ACTIVE | DISPLAY_SPR_1D_BMP);
<br/>
<br/>
   // Map VRAM A to sprite memory
<br/>
   vramSetBankA(VRAM_A_MAIN_SPRITE);
<br/>
<br/>
   // hide all sprites
<br/>
   initSprites(sprites);
<br/>
<br/>
   // copy sprite data to hardware
<br/>
   updateOAM(sprites, 128);
<br/>
<br/>
   // fill in a red blob
<br/>
   for(uint16 i = 0; i &lt; 1024; i++){
<br/>
      SPRITE_GFX[i] = RGB15(31,0,0) | (1 &lt;&lt; 15);
<br/>
   }
<br/>
<br/>
<br/>
   // Sprite
<br/>
   // Set the attributes
<br/>
   sprites[0].attribute[0] = ATTR0_BMP | ATTR0_TALL;
<br/>
   sprites[0].attribute[1] = ATTR1_SIZE_64 | 0;
<br/>
<br/>
   // set the positions and what-not now
<br/>
   sprites[0].attribute[2] = ATTR2_ALPHA(0) | ATTR2_PRIORITY(1) | 0;   // Tile-number (tiles are 8x8)
<br/>
   
<br/>
<br/>
   sprites[0].attribute[0] &amp;= 0xFF00;      // Remove the position data
<br/>
   sprites[0].attribute[0] |= (97 &amp; 0x00FF);   // put in the Y position data
<br/>
<br/>
   sprites[0].attribute[1] &amp;= 0xFE00;      // Remove the position data
<br/>
   sprites[0].attribute[1] |= (24 &amp; 0x01FF);   // put in the X position data
<br/>
<br/>
<br/>
   // reflect the changes in hardware
<br/>
   updateOAM(sprites, 128);
<br/>
<br/>
<br/>
   while(1) {
<br/>
<br/>
      swiWaitForVBlank();
<br/>
<br/>
   }   // END While
<br/>
<br/>
   return 0;
<br/>
}</td> </tr></table><span class="postbody"><br/>_________________<br/><span style="font-size: 9px; line-height: normal"><span style="font-weight: bold">Nintendo DS &amp; Dominos :: <a class="postlink" href="http://dsdominos.sourceforge.net" target="_blank">DS Dominos</a></span>
<br/>
<a class="postlink" href="http://jt0.org" target="_blank">http://jt0.org</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#115151 - JessTicular - Sat Jan 13, 2007 8:35 am</h4>
    <div class="postbody"><span class="postbody">The problem was with the Alpha.
<br/>
I had: <span style="font-style: italic">sprites[0].attribute[2] = ATTR2_ALPHA(0)</span>
<br/>
When I should have had: <span style="font-style: italic">sprites[0].attribute[2] = ATTR2_ALPHA(1)</span>
<br/>
<br/>
I don't know why its different between hardware and emulator, but it is, and lesson learnt!<br/>_________________<br/><span style="font-size: 9px; line-height: normal"><span style="font-weight: bold">Nintendo DS &amp; Dominos :: <a class="postlink" href="http://dsdominos.sourceforge.net" target="_blank">DS Dominos</a></span>
<br/>
<a class="postlink" href="http://jt0.org" target="_blank">http://jt0.org</a></span></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
