<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Options for a DS Filesystem?  (for use with my game) - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > Options for a DS Filesystem?  (for use with my game)</h2>
<div id="posts">
<div class="post">
    <h4>#79104 - sofakng - Tue Apr 11, 2006 6:54 pm</h4>
    <div class="postbody"><span class="postbody">I'm making a game that I would like to be compatible with as many flash cards as possible and it seems like the FAT system is only compatible with the compact flash cards...
<br/>
<br/>
The other filesystem I've seen is PALib's Filesystem but it seems to have a ton of problems...
<br/>
<br/>
What other options do I have?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#79107 - GPFerror - Tue Apr 11, 2006 7:04 pm</h4>
    <div class="postbody"><span class="postbody">romfs ,gbfs or bin2s the file and using it directly.
<br/>
<br/>
you can get the romfs from my page <a href="http://gpf.dcemu.co.uk/ndsromdisk.shtml" target="_blank">http://gpf.dcemu.co.uk/ndsromdisk.shtml</a> it uses a variation of the stdio library api, ie KOS_fopen, KOS_fread etc. you can also #undef the ones defined by stdio and redefine the ones used in my lib.
<br/>
ie
<br/>
#undef fopen
<br/>
#define fopen KOS_fopen
<br/>
<br/>
Troy(GPF)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#79191 - josath - Wed Apr 12, 2006 1:52 am</h4>
    <div class="postbody"><span class="postbody">fat lib is actually compatible with flash cards as well, it even uses SRAM as an overlay, so you have limited writing abilities as well. It's Just there is no tool to build the filesystem yet. (bug chishm :P )</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#79263 - sofakng - Wed Apr 12, 2006 3:40 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>GPFerror wrote:</b></span></td> </tr> <tr> <td class="quote">romfs ,gbfs or bin2s the file and using it directly.
<br/>
<br/>
you can get the romfs from my page <a href="http://gpf.dcemu.co.uk/ndsromdisk.shtml" target="_blank">http://gpf.dcemu.co.uk/ndsromdisk.shtml</a> it uses a variation of the stdio library api, ie KOS_fopen, KOS_fread etc. you can also #undef the ones defined by stdio and redefine the ones used in my lib.
<br/>
ie
<br/>
#undef fopen
<br/>
#define fopen KOS_fopen
<br/>
<br/>
Troy(GPF)</td> </tr></table><span class="postbody">
<br/>
<br/>
So far KosFS is working great!
<br/>
<br/>
However, there seems to be a bug in kos_fgets().
<br/>
<br/>
Take a look at this code:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
  char buf[1024]
<br/>
  while ( fgets(buf, 1024, fp) ) {
<br/>
    // whatever
<br/>
  }
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
That will give me an infinite loop...  it looks like fgets is never returning false (eg. 0).
<br/>
<br/>
By any chance can you take a look at this?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#79291 - GPFerror - Wed Apr 12, 2006 6:51 pm</h4>
    <div class="postbody"><span class="postbody">well fgets calls fgetc which calls fread, so im not sure yet.
<br/>
<br/>
I hadnt actually tested that command before, so Ill try to look into it this week.
<br/>
<br/>
I think that the functions return EOF which equals -1 , so that might be the problem if the while loop is looking for a return of 0; I forget what the standard fgets function returns.
<br/>
<br/>
Troy</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#79298 - sofakng - Wed Apr 12, 2006 7:10 pm</h4>
    <div class="postbody"><span class="postbody">After doing a bunch of testing, I finally figured out the problem...
<br/>
<br/>
Here was the problem:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">ch = s[i] = KOS_fgetc (file);</td> </tr></table><span class="postbody">
<br/>
<br/>
It was simply changed to:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">ch = KOS_fgetc (file);
<br/>
s[i] = ch;
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I'm not extremely familar with C so I'm not sure why my fix works but it does... (and I guess thats all that matters :))</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#79303 - tepples - Wed Apr 12, 2006 7:23 pm</h4>
    <div class="postbody"><span class="postbody">fgetc() returns an int and uses the more significant bits (MSBs) of the return value to signal whether end of file has occurred. Assigning to a char variable and then reading back from that char variable discards the MSBs.
<br/>
<br/>
Codes A and B are equivalent[1], and codes C and D are equivalent:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">// A
<br/>
ch = s[i] = KOS_fgetc (file);
<br/>
<br/>
// B
<br/>
s[i] = KOS_fgetc (file);
<br/>
ch = s[i];
<br/>
<br/>
// C
<br/>
s[i] = ch = KOS_fgetc (file);
<br/>
<br/>
// D
<br/>
ch = KOS_fgetc (file);
<br/>
s[i] = ch;
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
<span style="font-size: 9px; line-height: normal">[1] Modulo volatility.</span><br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#79310 - sofakng - Wed Apr 12, 2006 8:40 pm</h4>
    <div class="postbody"><span class="postbody">Thanks for the explanation!
<br/>
<br/>
I have one more question for GPFerror about KOS_FS...
<br/>
<br/>
Do you have a FileExists function?  (simple function that returns if a file exists... I'm not sure if I need it to return the file_type as well [like in chism's FAT driver])
<br/>
<br/>
Also, do you have a remove() function?  It's prototyped in your code but the actual function doesn't exist.
<br/>
<br/>
Thanks again for all of your help!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#79319 - GPFerror - Wed Apr 12, 2006 10:26 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>sofakng wrote:</b></span></td> </tr> <tr> <td class="quote">Thanks for the explanation!
<br/>
<br/>
I have one more question for GPFerror about KOS_FS...
<br/>
<br/>
Do you have a FileExists function?  (simple function that returns if a file exists... I'm not sure if I need it to return the file_type as well [like in chism's FAT driver])
<br/>
<br/>
Also, do you have a remove() function?  It's prototyped in your code but the actual function doesn't exist.
<br/>
<br/>
Thanks again for all of your help!</td> </tr></table><span class="postbody">
<br/>
<br/>
no i dont have one, you can use the opendir, readdir functions maybe for that, or just try fopen the file and if it returns a handle it exists :)
<br/>
<br/>
there isnt a remove function, since its a permanent romdisk, the code that i originally ported is setup so you can add filesystems to it, its what we use for the dreamcast.
<br/>
<br/>
included in the filesystem is a ramdisk also though, that you can read and write to, just specify /ram
<br/>
<br/>
copy a file from romdisk to ramdisk
<br/>
fs_copy("/rd/test.bin","/ram/test.bin);
<br/>
<br/>
to remove the file from the ramdisk you can do fs_unlink("/ram/test.bin");
<br/>
<br/>
within the code i use KOS_tmpfile(), which can show you better probably.
<br/>
<br/>
Troy(GPF)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#79333 - sofakng - Wed Apr 12, 2006 11:27 pm</h4>
    <div class="postbody"><span class="postbody">Oh... so you can't save files except to the ROM disk?  It looked like you had KOS_fwrite and other functions that would allow writing...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#79341 - GPFerror - Thu Apr 13, 2006 1:00 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>sofakng wrote:</b></span></td> </tr> <tr> <td class="quote">Oh... so you can't save files except to the ROM disk?  It looked like you had KOS_fwrite and other functions that would allow writing...</td> </tr></table><span class="postbody">
<br/>
<br/>
only can save to the RAMDISK, which disappears after you shutdown the ds. and our limited by the ram left in the ds.
<br/>
<br/>
Troy(GPF)</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
