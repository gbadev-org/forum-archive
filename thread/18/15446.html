<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>best way to do decals / z-fighting problem - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > best way to do decals / z-fighting problem</h2>
<div id="posts">
<div class="post">
    <h4>#155168 - Noda - Fri Apr 25, 2008 10:52 pm</h4>
    <div class="postbody"><span class="postbody">Hi,
<br/>
<br/>
have a floor texture (a big quad) on which I want to apply decals on it (smaller quads). Which is the best way to do it?
<br/>
<br/>
Currently I simply offset the decals by 0.15 which works fine when the camera is near but when it gets farther, I've go flickering problems.
<br/>
<br/>
0.3 seems to be the limit from which the offset become visible, and since I have 2 layers of decals (the second one being the shadows of the walls casted on the floor) I can't enlarge the offsets. And even at 0.3 the z-fighting problem is present.
<br/>
<br/>
Is there a better way to do what I want?
<br/>
<br/>
Thanks for your help and suggestions.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#155170 - silent_code - Fri Apr 25, 2008 11:23 pm</h4>
    <div class="postbody"><span class="postbody">that's pretty "normal" or common. you can try to use distance based offsets, so that further away decals get offset more. that's won't be noticable.
<br/>
<br/>
are you using w or z buffering? z buffering is getting more issues the farther away stuff is, as w buffering affects near stuff more that z buffering, but equally throughout the whole depth range. sort of... try to read up on it. :^)
<br/>
<br/>
hope that helps. :^D</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#155176 - M3d10n - Sat Apr 26, 2008 12:46 am</h4>
    <div class="postbody"><span class="postbody">There's a setting in the polyfmt which allows you to draw decals without z-fighting, but I believe you need to use the same exact vertex positions and matrix transformations. 
<br/>
<br/>
So you'd need to draw your entire floor again (or only the triangles under the decal) for each decal, turn off texture wrapping and use a texture matrix to offset and scale the texture so the decal is where you want it to be. That's how things works on actual videocards as well, more or less.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#155177 - TwentySeven - Sat Apr 26, 2008 1:16 am</h4>
    <div class="postbody"><span class="postbody">On real videocards everyone just uses polygonoffset. :P
<br/>
<br/>
To me it seems like you're going to have to simulate polygonoffset with worldspace transforms (distance based bias), as mentioned above.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#155183 - silent_code - Sat Apr 26, 2008 3:20 am</h4>
    <div class="postbody"><span class="postbody">actually polyoffset isn't recommended. you would use the stencil buffer...
<br/>
using decal blending is a good idea!
<br/>
well, i'd sure try to decalblend with regular per decal geometry first. :^)
<br/>
<br/>
@ TS: ps: the nds doen't have imaginary graphics hw. ;^D</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#155187 - tepples - Sat Apr 26, 2008 3:57 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>silent_code wrote:</b></span></td> </tr> <tr> <td class="quote">@ TS: ps: the nds doen't have imaginary graphics hw. ;^D</td> </tr></table><span class="postbody">
<br/>
It does render to an imaginary frame buffer when you're not in capture mode. Does that count?<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#155191 - Noda - Sat Apr 26, 2008 5:24 am</h4>
    <div class="postbody"><span class="postbody">Thanks for the ideas :)
<br/>
<br/>
I'll think I'll first try to simulate polygon offset by adjusting the offset based on the camera distance. Still I think there would be some problem, as with very low camera angle (very close and in the direction of the floor) the zfighting would still occurs.
<br/>
<br/>
The idea of using decal mode and the same vertices as the floor with texture matrix transform would fix that problem, but still the issue with the shadows would be here (as shadows are not texture but polygons drawn using the stencil).
<br/>
<br/>
Seems there's no perfect solution for my problem, but a mix of those 2 ideas (distance adjusted offset for shadow + decal mode for decals objects) should do the job I hope. Now I just need to rewrite some parts of my rendering engine...
<br/>
<br/>
Oh, and for the solution of using W-buffer instead of Z-buffer, I tried but it seems it did not changed anything, I found it strange as I would expect at least some changes...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#155193 - a128 - Sat Apr 26, 2008 8:25 am</h4>
    <div class="postbody"><span class="postbody">Great discussion...if someone could share the results with  source code this would be great.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#155197 - simonjhall - Sat Apr 26, 2008 11:10 am</h4>
    <div class="postbody"><span class="postbody">There's the "Z equal" test in polyfmt (which M3d10n was hinting at) which would be very useful for a problem like this.
<br/>
<br/>
If you want to see an example of this, check out Quake's two-layer sky. The lower layer of clouds is effectively a decal and I do this by drawing the skybox twice (with the exact same geometry) but use the Z equal test, a different texture and an alpha channel to make it work.<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#155203 - TwentySeven - Sat Apr 26, 2008 3:29 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">I'll think I'll first try to simulate polygon offset by adjusting the offset based on the camera distance. Still I think there would be some problem, as with very low camera angle (very close and in the direction of the floor) the zfighting would still occurs. </td> </tr></table><span class="postbody">
<br/>
<br/>
Yeah, that sounds like you're thinking of just moving the decal vertically off the floor..  
<br/>
eg:  position += floornormal * distance bias 
<br/>
<br/>
More robustly, you should be moving the decal back towards the camera just a touch.
<br/>
eg: position -= cameraforwardvector * distance bias
<br/>
<br/>
This is closer to what goes on with (the sadly unavailable on the ds!)polygonoffset, except obviously your decal is going to be scaled a touch larger by this whereas polygonoffset only messes with the zbuffer values.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#155205 - silent_code - Sat Apr 26, 2008 4:01 pm</h4>
    <div class="postbody"><span class="postbody">ok (or not), "equal" depth compare will most likely give you artifacts if not rendered with the same vertex setup (e.g. triangle). :^C</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
