<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Texture Coordinate Tip - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > Texture Coordinate Tip</h2>
<div id="posts">
<div class="post">
    <h4>#144861 - TwentySeven - Thu Nov 08, 2007 12:24 pm</h4>
    <div class="postbody"><span class="postbody">Hi,
<br/>
<br/>
I've been messing around wondering why my meshes were coming out on the DS Hardware with texture seams visible when my OpenGL renderer was fine..   
<br/>
<br/>
I managed to fix it, so I thought I'd share what might be common knowledge, but it wasnt immediately obvious to me and nor could I find a mention of it on the web anywhere( but I might be just dumb ).
<br/>
<br/>
"<span style="font-weight: bold">S/T texture coordinates need the S to be offset in the positive direction by half a texel.</span>"
<br/>
<br/>
So if you were using a 64x64 texture on a quad and wanted it fitted perfectly between: (bad ascii art of UV's on a quad)
<br/>
<br/>
0,0  --  1,0
<br/>
|
<br/>
0,1  --  1,1
<br/>
<br/>
and then converted to 4/10 fixed point format for a 64x64 texture:
<br/>
<br/>
0,0  ---- 1024,0
<br/>
|              
<br/>
0,1024--1024,1024
<br/>
<br/>
you'd have to actually pass in:
<br/>
<br/>
16,0  ---- 1040, 0
<br/>
|              
<br/>
16,1024 -- 1040,1024  
<br/>
<br/>
to get it to render equivilantly to openGL
<br/>
<br/>
The "16" figure is what half a texel at 64x64 works out to be.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#144866 - simonjhall - Thu Nov 08, 2007 2:10 pm</h4>
    <div class="postbody"><span class="postbody">You got any pictures/photos of what it looks like with/without this offset?
<br/>
Just curious, since my textures are like, (off the top of my head!)
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">0,0 ---- 1008,0 
<br/>
| 
<br/>
0,1008--1008,1008
<br/>
(note: 1008 not 1024)</td> </tr></table><span class="postbody">
<br/>
...and I see no seams...<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#144883 - TwentySeven - Thu Nov 08, 2007 11:02 pm</h4>
    <div class="postbody"><span class="postbody">I'll take some today.
<br/>
<span style="font-style: italic">*edit*</span>  Heres what I did.
<br/>
<br/>
<a href="http://27.blackrayne.net/dsquirk/texture.png" target="_blank">http://27.blackrayne.net/dsquirk/texture.png</a>
<br/>
<br/>
This is the texture I'm using to test. You might have to blow it up to tell but it has a row of coloured texels along each edge, and different 1 texel colours in each corner.
<br/>
<br/>
I'm rendering that on a pair of triangles arranged as a triangle strip.
<br/>
<br/>
Texture is loaded via:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
glTexImage2D(0, 0, GL_RGB, TEXTURE_SIZE_64 , TEXTURE_SIZE_64, 0, TEXGEN_OFF|GL_TEXTURE_WRAP_S|GL_TEXTURE_WRAP_T, (byte*)point);
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
<br/>
<a href="http://27.blackrayne.net/dsquirk/standard.png" target="_blank">http://27.blackrayne.net/dsquirk/standard.png</a>
<br/>
And here's what it looks like, with the UV's of each vertex printed out.
<br/>
<br/>
<a href="http://27.blackrayne.net/dsquirk/halfpixel.png" target="_blank">http://27.blackrayne.net/dsquirk/halfpixel.png</a>
<br/>
And here it is with the half texel nudge on the "S" axis.</span><span class="gensmall"><br/><br/>Last edited by TwentySeven on Thu Nov 08, 2007 11:45 pm; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#144891 - TwentySeven - Thu Nov 08, 2007 11:44 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">0,0 ---- 1008,0 
<br/>
| 
<br/>
0,1008--1008,1008 
<br/>
(note: 1008 not 1024)</td> </tr></table><span class="postbody"></span></td> </tr></table><span class="postbody">
<br/>
<br/>
Yeah thats exactly what we started off with from our exporter too
<br/>
<br/>
* TextureWidth-1
<br/>
* TextureHeight-1 
<br/>
<br/>
to get something 0-63
<br/>
<br/>
Here's a screenshot of how that looks on my end, for completeness.
<br/>
<br/>
<a href="http://27.blackrayne.net/dsquirk/0to1008.png" target="_blank">http://27.blackrayne.net/dsquirk/0to1008.png</a>
<br/>
<br/>
Now I'm really starting to wonder if theres something really wrong with my 3d initialization code after all this.. maybe its just that I'm using triangle strips?
<br/>
<br/>
The behavior is the same under both no$gba and the real hardware.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#144899 - nce - Fri Nov 09, 2007 12:46 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>TwentySeven wrote:</b></span></td> </tr> <tr> <td class="quote"> Yeah thats exactly what we started off with from our exporter too
<br/>
<br/>
* TextureWidth-1
<br/>
* TextureHeight-1 
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I usually always use the same uv coordinate system ( meaning I consider all texture to be 128 * 128 ) and use the texture matrix to scale it correctly depending of the real texture size.
<br/>
<br/>
I do this because when I'm doing a scene I prefer to export my mesh once, and if I change my texture ( often shrink it because I realise that I use a too big texture for the distance ) I just have to rebuild my texture pack. and not reexport everything :)<br/>_________________<br/>-jerome-</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#144905 - TwentySeven - Fri Nov 09, 2007 1:02 am</h4>
    <div class="postbody"><span class="postbody">You bring up an interesting point about texture matrixes.  I don't initialize or use one at all.. I just pass in the UV's directly to the hardware in their proper 32bit  10|4  10|4 packing. 
<br/>
<br/>
Its funny, i didn't even consider using a texture matrix to use "normalized" UV's..  Maybe using a matrix fixes the issue?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#151325 - TwentySeven - Sat Feb 23, 2008 12:07 pm</h4>
    <div class="postbody"><span class="postbody">The DS just has unusual texel sampling rules.
<br/>
<br/>
It seems to be the hardware rasterizer is sampling from the center top of pixels, which is unlike d3d or opengl. 
<br/>
<br/>
It's not because I wasn't using a texture matrix.  However a texture matrix does offer a convenient way to correct for this so you can just store your UV's without fudging around with them.
<br/>
<br/>
So to start with, I base everything around uv's for a 64x64 texture.  It was suggested on these forums to use a larger range like 256x256 for more precision.
<br/>
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
<br/>
u32 uv64[] =
<br/>
{
<br/>
   TEXTURE_PACK(inttot16(0),inttot16(0)),
<br/>
   TEXTURE_PACK(inttot16(64),inttot16(0)),
<br/>
   TEXTURE_PACK(inttot16(64),inttot16(64)),
<br/>
   TEXTURE_PACK(inttot16(0),inttot16(64)),
<br/>
};
<br/>
</td> </tr></table><span class="postbody">
<br/>
uv setup for a 64x64 textured quad - note its 0-64 not 0-63 
<br/>
because normalized Uvs go from 0.0f-1.0f, not 0 to 0.984375  ;)
<br/>
<br/>
<br/>
<br/>
Texture initialization looks like:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
glTexImage2D(0, 0, GL_RGBA, TEXTURE_SIZE_64 , TEXTURE_SIZE_64, 0, TEXGEN_TEXCOORD|GL_TEXTURE_WRAP_S, (byte*)data);
<br/>
</td> </tr></table><span class="postbody">
<br/>
GL_TEXTURE_WRAP_S is required or you will be unable to sample from column 63 at all &gt;_&lt;
<br/>
GL_TEXTURE_WRAP_T can introduce 1 pixel sparklies in row 0 sampled from row 63, on the real hardware.  
<br/>
<br/>
<br/>
The setup code for the texture matrixes with the sampling correction factored in looks like:
<br/>
Setup to render a  64x64 texture 
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
glMatrixMode(GL_TEXTURE); 
<br/>
glLoadIdentity(); 
<br/>
<br/>
MATRIX_TRANSLATE = (32&lt;&lt;12);//half a texel on S at 0-64 uv range
<br/>
MATRIX_TRANSLATE = 0;
<br/>
MATRIX_TRANSLATE = 0;
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
<br/>
Set up to render a 128x128 texture, same UV's
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
glMatrixMode(GL_TEXTURE); 
<br/>
glLoadIdentity(); 
<br/>
<br/>
//Translate goes first, woops
<br/>
MATRIX_TRANSLATE = (32&lt;&lt;12); //nudge for 0-64 range 
<br/>
MATRIX_TRANSLATE = 0;
<br/>
MATRIX_TRANSLATE = 0;
<br/>
<br/>
MATRIX_SCALE = (int)(2*(1&lt;&lt;12)); 
<br/>
MATRIX_SCALE = (int)(2*(1&lt;&lt;12));
<br/>
MATRIX_SCALE = (int)(2*(1&lt;&lt;12));
<br/>
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"><br/><br/>Last edited by TwentySeven on Wed Feb 27, 2008 9:13 am; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#151328 - silent_code - Sat Feb 23, 2008 3:01 pm</h4>
    <div class="postbody"><span class="postbody">sorry, but isn't it: texel 0 = 0.0 = (fxpt)0, texel 63 = width - 1 = 1.0 = (fxpt) 1008 (just like simon's [btw: greetings and thanks for ? a.k.a. Q2 ;^p !] setup)... because normally in a 64 texel wide texture map, the 64th texel would be texel 0 with texture wrapping enabled. that shouldn't change with normalized uvs at all. at least i don't get the logic behind such a thing.
<br/>
<br/>
or is it really like that on the nds (i can't remeber, i got such results in my tests, at all)? i mean, your results *sure* look odd...
<br/>
<br/>
ps: i guess, you all are familiar with openGL's texture mapping offset, right? like, you have to use a small offset for perspective projected geometry to make things really right, as well as another offset, which differs from the former, for othogonal projected geometry. otherwise it's especially hard to get correct results in text drawing etc.
<br/>
that might just be the nds' flavor of the same thing. i really have to get back to nds dev soon to check that out! ;^D</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#151346 - simonjhall - Sat Feb 23, 2008 10:49 pm</h4>
    <div class="postbody"><span class="postbody">I think a lot of things with DS 3D are hit and miss. I really really wish I had the proper hardware docs so I could just read them and "oh, right THAT's what's going on!" but there's no way I'd wanna be a pro DS developer.
<br/>
<br/>
Back on topic :-)
<br/>
I guess if you get seams or whatever with whatever you're doing, just wiggle the inputs until you get exactly what you want. Once you've done that, invent some understanding of how you think the internals actually work!
<br/>
Thinking about it, maybe it does make sense to define your co-ords as going from 0-64, not to 0-63 cos as you say 0.0-1.0 is what you'd do with other hardware- and software-render solutions.
<br/>
Kusma, what say you?
<br/>
<br/>
Btw anyone know what's the deal with those texturing artifacts you get where the sides of texels seem to wiggle on the triangles they're drawn onto? (not so much when on quads)
<br/>
Kinda looks like the hardware doesn't step correctly in s/z and t/z...
<br/>
<br/>
edit: @ silent_code, ta mate! I was like "I gave you €? I donated you money? Ahhh!" :-D<br/>_________________<br/><span style="font-weight: bold"><a class="postlink" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=simonjhall%40gmail%2ecom&amp;no_shipping=2&amp;no_note=1&amp;tax=0&amp;currency_code=GBP&amp;lc=GB&amp;bn=PP%2dDonationsBF&amp;charset=UTF%2d8" target="_blank">Big thanks to everyone who donated for Quake2</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#151363 - silent_code - Sun Feb 24, 2008 4:17 pm</h4>
    <div class="postbody"><span class="postbody">@simon... ha, ha, ha... :^D i didn't even THINK about that! i just saw (i think it was tepples) someone making that refernece to the euro-sign and thought it was funny... ;^D
<br/>
<br/>
well, i'll have a look at that topic today.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
