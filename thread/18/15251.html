<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Problem with PAlib and libfat... - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>DS development > Problem with PAlib and libfat...</h2>
<div id="posts">
<div class="post">
    <h4>#152985 - SnakerDLK - Sun Mar 23, 2008 7:07 pm</h4>
    <div class="postbody"><span class="postbody">Hi,
<br/>
Im using PAlib Community Release 080203 and...
<br/>
the following code has and error... 
<br/>
the line with the error is </span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">/*THIS IS THE LINE !*/while(!dirnext(dir, item, &amp;fileStat))</td> </tr></table><span class="postbody">
<br/>
(line 129...)
<br/>
<br/>
when the line is commented, the program keeps prefectly in loop, in the main function...
<br/>
<br/>
but when uncommented, the program freezes on the line
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">   debug("exiting");
<br/>
   return OK;
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
where OK is defined as 0.
<br/>
<br/>
here is the 'full' code:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">//INCLUDES
<br/>
<br/>
// Include for PA_Lib
<br/>
#include &lt;PA9.h&gt;
<br/>
<br/>
//Includes for fat lib
<br/>
#include &lt;fat.h&gt;
<br/>
#include &lt;sys/dir.h&gt;
<br/>
<br/>
//DEFINES
<br/>
#define MENU_END 0
<br/>
#define MENU_SELECTABLE 1
<br/>
#define MENU_NOT_SELECTABLE 2
<br/>
#define MENU_MAX_LINES 18
<br/>
#define MENU_SYMBOL "*"
<br/>
#define MENU_MAX_NAME 31
<br/>
<br/>
#define BROWSETYPE_FOLDER 0
<br/>
#define BROWSETYPE_FILE 1
<br/>
#define BROWSE_NAME_SIZE 100
<br/>
#define BROWSE_CURRENT_DIR "."
<br/>
#define BROWSE_SOURCE_DIR ".."
<br/>
<br/>
#define OK 0
<br/>
#define ERROR_OPEN_DIR 1
<br/>
#define INPUT_ERROR 2
<br/>
#define ERROR_ALLOCATING_VAR 3
<br/>
#define LIMIT_ERROR 4
<br/>
#define CANCEL 5
<br/>
#define BUG 666;
<br/>
<br/>
//TYPEDEFS
<br/>
//file list struct...prev could be removed...
<br/>
typedef struct browseTypeStruct{
<br/>
   char name[MENU_MAX_NAME+1];
<br/>
   unsigned char type;
<br/>
   struct browseTypeStruct *next;
<br/>
   struct browseTypeStruct *prev;
<br/>
}browseType;
<br/>
<br/>
//PROTOS
<br/>
void debug(char *input);
<br/>
browseType *getBrowseItem(browseType *first, unsigned num);
<br/>
int browseFile(char *home, char *path, unsigned char browseType);
<br/>
<br/>
//FUNCTIONS
<br/>
void debug(char *input)
<br/>
{
<br/>
   unsigned char counter;
<br/>
   
<br/>
   //check if 'input' fits on the screen...
<br/>
   if(strlen(input) &gt; 31)
<br/>
   {
<br/>
      debug("DEBUG SIZE EXCEEDED");
<br/>
   }else{
<br/>
      counter = 31 - strlen(input);
<br/>
      PA_Print(1, "%s", input);
<br/>
      
<br/>
      //this is for another bug... the text was being garbled if I dont specifically set it
<br/>
      while(counter)
<br/>
      {
<br/>
         PA_Print(1, " ");
<br/>
         counter--;
<br/>
      }
<br/>
      PA_Print(1, "\n");
<br/>
   }
<br/>
   
<br/>
   //there was a time where the upper screen just went black..so this is a timer to stop the program for a few seconds
<br/>
   //for the user to be able to read the log... just for debugging purpouses...
<br/>
   counter = 20;
<br/>
   while(counter)
<br/>
   {
<br/>
      PA_WaitForVBL();
<br/>
      counter--;
<br/>
   }
<br/>
}
<br/>
<br/>
browseType *getBrowseItem(browseType *first, unsigned num)
<br/>
{
<br/>
   browseType *current;
<br/>
   unsigned counter;
<br/>
   
<br/>
   current = first;
<br/>
   for(counter = 0; ((counter &lt; num)&amp;&amp;(current != NULL)); counter ++)
<br/>
   {
<br/>
      current = current-&gt;next;
<br/>
   }
<br/>
   return current;
<br/>
}
<br/>
<br/>
int browseFile(char *home, char *pathOut, unsigned char browseForType)
<br/>
{
<br/>
   struct stat fileStat;                //to check wether the item is a file or folder.
<br/>
   browseType *first = NULL, *current = NULL, *new;   //create the file list.
<br/>
   char item[BROWSE_NAME_SIZE+1];            //not really needed..but without this I would
<br/>
                        //have to allocate the first list item before checking the
<br/>
                        //first item...whatever...
<br/>
   
<br/>
   unsigned offset, choice, counter;    //offset and choice are explained later... counter is a loop counter...
<br/>
   unsigned lastItem = 0;         //used to limit the offset+choice...see later.
<br/>
   unsigned char waiting;         //status... if the menu needs to be reput or the file list updated...
<br/>
   char path[256];            //I was using the 'pathOut' var but the program was resetting it...see later.
<br/>
   
<br/>
   //check for possible programming errors...who knows...
<br/>
   if((home == NULL)||(path == NULL))
<br/>
      return INPUT_ERROR;
<br/>
      
<br/>
   //to open the home dir
<br/>
   //well...this does not limit the user to home dir and subdirs... just to put a place to start browsing.
<br/>
   strcpy(path, home);
<br/>
   
<br/>
   
<br/>
   waiting = 1;
<br/>
   while(waiting)
<br/>
   {   
<br/>
      
<br/>
      //get file list for path directory
<br/>
      DIR_ITER* dir = diropen(path);
<br/>
      if(dir == NULL)
<br/>
      {
<br/>
         debug("Error opening dir...");
<br/>
         return ERROR_OPEN_DIR;
<br/>
      }
<br/>
      
<br/>
      debug("Directory opened:");
<br/>
      debug(path);
<br/>
      
<br/>
      //create dir list
<br/>
<br/>
/*THIS IS THE LINE !*/while(!dirnext(dir, item, &amp;fileStat))
<br/>
<br/>
      {
<br/>
      }
<br/>
      
<br/>
      debug("Created list of directories");
<br/>
      
<br/>
      //close dir
<br/>
      dirclose (dir);
<br/>
      debug("Directory closed");
<br/>
      
<br/>
      {
<br/>
      }
<br/>
      
<br/>
      debug("Going to free list");
<br/>
      
<br/>
      //free dir list
<br/>
      current = first;
<br/>
      while(current != NULL)
<br/>
      {
<br/>
         first = current-&gt;next;
<br/>
         free(current);
<br/>
         current = first;
<br/>
      }
<br/>
      
<br/>
      first = current = new = NULL;
<br/>
      
<br/>
      debug("File list freed");
<br/>
      
<br/>
      waiting = 0;
<br/>
   }
<br/>
   
<br/>
   debug(path);
<br/>
   strcpy(pathOut, path);
<br/>
   debug(pathOut);
<br/>
   debug("exiting");
<br/>
   return OK;
<br/>
}
<br/>
<br/>
// Function: main()
<br/>
int main(void)
<br/>
{
<br/>
   int option;
<br/>
   char path[256], home[256];
<br/>
   PA_Init();    // Initializes PA_Lib
<br/>
   PA_InitVBL(); // Initializes a standard VBL
<br/>
   
<br/>
   PA_InitText(0, 0);
<br/>
   PA_InitText(1, 1);
<br/>
   
<br/>
   debug("Palib init");
<br/>
   
<br/>
   //from the example...did not try to remove the following lines yet...
<br/>
   PA_WaitForVBL();  
<br/>
   PA_WaitForVBL();  
<br/>
   PA_WaitForVBL();
<br/>
   
<br/>
   if(fatInitDefault())
<br/>
      debug("Libfat init");
<br/>
   else{
<br/>
      debug("Libfat ERROR...");
<br/>
      debug("reboot !");
<br/>
      PA_WaitForVBL();
<br/>
   }
<br/>
   
<br/>
   // Infinite loop to keep the program running
<br/>
   while (1)
<br/>
   {
<br/>
      strcpy(home, "/");
<br/>
      //did no want to use browseFile("/", path, BROWSETYPE_FILE);
<br/>
      //but would not make a diference...probably
<br/>
      option = browseFile(home, path, BROWSETYPE_FILE);
<br/>
      
<br/>
      //just to know if you escaped the function... I never did U_U
<br/>
      debug("out..");
<br/>
      if(!option)
<br/>
         PA_Print(1, "path \"%s\"\n", path);
<br/>
      else
<br/>
         PA_Print(1, "ERROR %d\n", option);
<br/>
      PA_WaitForVBL();
<br/>
   }
<br/>
   
<br/>
   return 0;
<br/>
} // End of main()
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
since the palib forum is down... and their 'new' forum is quite deserted...
<br/>
well, if anyone can help, I appreciate it ^^
<br/>
<br/>
(well...perhaps if someone could compile this with the stable release of palib... or tell me where I can find a function that allows browsing for files/folders...)</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
