<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Personal data not updating - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>DS development > Personal data not updating</h2>
<div id="posts">
<div class="post">
    <h4>#162007 - Jeremysr - Sat Aug 23, 2008 2:11 am</h4>
    <div class="postbody"><span class="postbody">I want to get the DS username, but when I set the username to something else (from the DS firmware) and then run my program, it still displays the username that I had before I changed it. The DS firmware displays my new one but my program still displays the old one. If I go to the options again and set it again, then it will work. Why does this happen and how can I fix it?
<br/>
<br/>
Here is the code:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void get_username(char *username) {
<br/>
   struct tPERSONAL_DATA *user_info = PersonalData;
<br/>
<br/>
   for (u8 i = 0; i &lt; user_info-&gt;nameLen; i++) {
<br/>
      username[i] = (char)(user_info-&gt;name[i] &amp; 0x00FF);
<br/>
   }
<br/>
<br/>
   username[user_info-&gt;nameLen] = '\0';
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
My program isn't storing the username anywhere other than in memory so it can't be a problem with my program.<br/>_________________<br/><a class="postlink" href="http://viewsourcecode.org/" target="_blank">viewsourcecode</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#162009 - chuckstudios - Sat Aug 23, 2008 3:44 am</h4>
    <div class="postbody"><span class="postbody"><a class="postlink" href="http://nocash.emubase.de/gbatek.htm#dsfirmwareusersettings" target="_blank">GBATEK</a> says:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Note: There are two User Settings areas in the firmware chip, at offset 3FE00h and 3FF00h, if both areas have valid CRCs, then the current/newest area is that whose Update Counter is one bigger than in the other/older area.
<br/>
<br/>
 IF count1=((count0+1) AND 7Fh) THEN area1=newer ELSE area0=newer
<br/>
<br/>
When changing settings, the older area is overwritten with new data (and incremented Update Counter). The two areas allow to recover previous settings in case of a write-error (eg. on a battery failure during write).</td> </tr></table><span class="postbody">
<br/>
<br/>
<br/>
Off-topic:
<br/>
This is immediately below that paragraph:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
Battery Removal
<br/>
Even though the battery is required only for the RTC (not for the firmware flash memory), most of the firmware user settings are reset when removing the battery. This appears to be a strange bug-or-feature of the DS bios, at least, fortunately, it still keeps the rest of the firmware intact.
<br/>
</td> </tr></table><span class="postbody">
<br/>
This is not true, as a flashcart with the autoboot bit set will prove. IIRC, Martin Korth is nowhere to be found. As cases like this are found, who will maintain the technical documents?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#162010 - Jeremysr - Sat Aug 23, 2008 4:46 am</h4>
    <div class="postbody"><span class="postbody">Ok, so I have to check which one is the new one, or does the DS do that? I'm guessing when the DS starts up, it checks which one is new and loads it to 0x27FFC80... Except the DS firmware menu shows the new name but my program shows the old one.<br/>_________________<br/><a class="postlink" href="http://viewsourcecode.org/" target="_blank">viewsourcecode</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#162030 - chuckstudios - Sat Aug 23, 2008 5:46 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Jeremysr wrote:</b></span></td> </tr> <tr> <td class="quote">Ok, so I have to check which one is the new one, or does the DS do that? I'm guessing when the DS starts up, it checks which one is new and loads it to 0x27FFC80... Except the DS firmware menu shows the new name but my program shows the old one.</td> </tr></table><span class="postbody">
<br/>
<br/>
It's likely that libnds's getUserSettings() (or named similarly) that runs on the default ARM7 core does not evaluate for which is newer. I'll check the libnds source a bit later to see if that is the case...
<br/>
<br/>
Edit: I've checked <a class="postlink" href="http://devkitpro.cvs.sourceforge.net/devkitpro/libnds/source/arm7/userSettings.c?view=markup" target="_blank">userSettings.c</a>, and it does check both CRC and modification time. :-/</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#162231 - thoduv - Thu Aug 28, 2008 10:49 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>chuckstudios wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
Edit: I've checked <a class="postlink" href="http://devkitpro.cvs.sourceforge.net/devkitpro/libnds/source/arm7/userSettings.c?view=markup" target="_blank">userSettings.c</a>, and it does check both CRC and modification time. :-/</td> </tr></table><span class="postbody">
<br/>
Yeah, but there is obviously a bug in this check:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">currentSettings = (slot2count == (( slot2count + 1 ) &amp; 0x7f) ? &amp;slot2 : &amp;slot1);
<br/>
</td> </tr></table><span class="postbody">
<br/>
should be
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">currentSettings = (slot2count == (( slot1count + 1 ) &amp; 0x7f) ? &amp;slot2 : &amp;slot1);
<br/>
</td> </tr></table><span class="postbody">
<br/>
(I currently don't have the tools needed to make a .diff patch and submit it, so if someone could report this to devkitPro...)</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
