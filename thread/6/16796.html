<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Yet Another GBA Lua - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>Announcements And Comments > Yet Another GBA Lua</h2>
<div id="posts">
<div class="post">
    <h4>#169703 - Karatorian - Thu Jul 30, 2009 7:43 pm</h4>
    <div class="postbody"><span class="postbody">I'm working on an RPG project (please don't bring up any dead equines please, start an new thread if you must) and I figure any RPG engine worth it's salt needs scripting. I could probably write my own (I've done some small language projects before), but that'd be a lot of work. So I decided to look into using <a class="postlink" href="http://www.lua.org" target="_blank">Lua</a>. Figuring that someone had most likely already made a port, I started <a class="postlink" href="http://www.google.com/search?q=lua+gba" target="_blank">Googling</a> around for what I could find.
<br/>
<br/>
There are a couple of interesting projects out there. There's what looks to be a mature DS port <a class="postlink" href="http://microlua.risike.com/" target="_blank">here</a>, and, once apon a time, it seems there was a GBA port <a class="postlink" href="http://web.archive.org/web/20050301074421/www.gatesboy.com/Lua/Documentation/" target="_blank">there</a>. However, I decided to go with Torlus's <a class="postlink" href="http://torlus.com/index.php?2005/09/09/117-lua4gba" target="_blank">project</a>. (Well, at first anyway.)
<br/>
<br/>
So I downloaded and played around with it. The supplied ROM images worked fine, but I couldn't recompile it due to some issue with bitrot (my toolchain is a lot newer than the one he used). This only required a few adjustments and then everything was good. So I started to dig a little deeper into the code.
<br/>
<br/>
Besides having been (apparently) abandoned once the proof of concept was working, the code wasn't really to my liking. Firstly, he modified the Lua code in a way that wasn't required. I wanted to avoid that if at all possible, so I downloaded the latest Lua sources. I made a few changes to the Makefiles to add a "gba" target (but didn't change any sources, woot) and everything seemed to work great, but there was no way to be sure as it was just a library (the command line tools where of no use, clearly).
<br/>
<br/>
So the next task was to get Lua4gba to work by linking to the library rather than it's own custom version. This was a little trickier than I'd hoped it would be. He used his own console implementation (which is fine), but for Lua to work with it required the modified version (not so good). So, being lazy, I simply gutted his console code and used the one from libgba, which worked with the standard Lua right out of the box.
<br/>
<br/>
Once all that was working, I started looking at the rest of the code. I didn't really like what I saw. The code was kinda a mess. It was composed of a cut down version of "lua.c" interspersed with bits of GBA specific stuff. Basically, it was a port of the Lua intepreter, which wasn't really what I was after. What I wanted instead was to embed Lua using the normal C API (which seems much cleaner to me). So I pretty much started over.
<br/>
<br/>
The only part of the code I ended up keeping was the part that loaded a script from a GBFS. I split it out into a seperate function and wrote a new version of main to call it. I based my code on a couple of Lua embedding tutorials I found. It's probably not as robust as the original (error handling? what's that? =_=), but it's cleaner and much smaller.
<br/>
<br/>
My code works basically the same way as Lua4gba does. It loads a script from GBFS (the first file found) and attempts to run it. It's not very useful at the moment, but it could be used as the basis for something bigger.
<br/>
<br/>
My plans for this in the long term are a little vauge right now. The next thing I plan to do is make an option to embed just the VM and not the compiler. As tight as resources are on the GBA, the slight inconvience of having to precompile the scripts is definitely worth it. Second up will be looking at the options for number types. Lua defaults to using double precision floating point for all numerical calculations. As the GBA has no FPU, that'll have to change. Luckily, there are some compile options for alternatives, so I can hopefully avoid rolling my own. (Although I might if I decide to optimize division and modulo (likely) or do something crazy like fixed point (possible)).
<br/>
<br/>
From that point, I'm not really sure. If someone knows of (or is willing to write) a decent virtual keyboard, it'd be cool to do a full fledged port of the interactive interpreter. (But that's not really my aim.) Mainly, I'm going to focus on what I need for my engine, and as a lot of the design is still up in the air, I can't really say for sure what I'll end up doing.
<br/>
<br/>
I suppose that one could couple this with some sort of generic game engine and build a game construction kit thingy out of it. If anyone is interested in such a thing, I'd be willing to help out, but I'm not gonna do anything of the sort solo. Furthermore, it looks the the DS port I mentioned above would be a better starting point for that sort of thing.
<br/>
<br/>
Anyhoo, you can grab a source tarball from <a class="postlink" href="http://static.karatorian.org/code/gba/yagl-20090730-src.tar.bz2" target="_blank">my website</a> and try it out. Sorry, there's no prebuilt ROM images at the moment, but I'll get some up soon.
<br/>
<br/>
Comments, critques, and suggestions welcome. Thanks in advance.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#169727 - sgeos - Fri Jul 31, 2009 7:47 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Karatorian wrote:</b></span></td> </tr> <tr> <td class="quote">and I figure any RPG engine worth it's salt needs scripting.</td> </tr></table><span class="postbody">
<br/>
Correct.  Lua is usually the correct choice for a canned scripting language.
<br/>
<br/>
Why not get in touch with Ruben and add lua to his engine if he is OK with that?  It seems like two people cooperating on an RPG project would increase the chances of success by at least an order of magnitude.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Karatorian wrote:</b></span></td> </tr> <tr> <td class="quote">The next thing I plan to do is make an option to embed just the VM and not the compiler.</td> </tr></table><span class="postbody">
<br/>
This is a good idea.  FWIW, you might need a lua script compiler that runs on the GBA or DS.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Karatorian wrote:</b></span></td> </tr> <tr> <td class="quote">Lua defaults to using double precision floating point for all numerical calculations. As the GBA has no FPU, that'll have to change.</td> </tr></table><span class="postbody">
<br/>
Actually, I'm not sure it will.  How heavy are your scripts going to be?  For now I'd stick with lua out of the can, using float or double for the type of lua_Number and fuss about something more efficient later when and if the scripting engine becomes a problem.  Admittedly, switching to some sort of integer should be relatively painless, but that wouldn't be my top priority.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Karatorian wrote:</b></span></td> </tr> <tr> <td class="quote">(Although I might if I decide to optimize division and modulo (likely) or do something crazy like fixed point (possible)).</td> </tr></table><span class="postbody">
<br/>
Fixed is possible, evidently in hours if you know what you are doing.  My first attempt failed.  I have a list of places the source needs to be changed, if you want it.  I'd love to see a fixed point version of lua for embedded systems.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Karatorian wrote:</b></span></td> </tr> <tr> <td class="quote">If someone knows of (or is willing to write) a decent virtual keyboard,</td> </tr></table><span class="postbody">
<br/>
Port the project to the DS and this problem is solved.
<br/>
<br/>
FWIW, I wrote a couple of lua modules to tag (RPG) messages.  You can extend them with your own tags.  If you want them PM me.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">'I see... #PROPER(#X_NOUNS(a,potion,potions,$1)) and you want #X_NOUNS(a,gold coin,gold coins,$2) for #NOUNS(it,them,$1)?'
<br/>
(0,21) -&gt; I see... No Potions and you want 21 gold coins for them?
<br/>
(1, 0) -&gt; I see... A Potion and you want no gold coins for it?
<br/>
(4, 1) -&gt; I see... 4 Potions and you want a gold coin for them?</td> </tr></table><span class="postbody">
<br/>
(Yes, the message has a bug.)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#169737 - Karatorian - Sat Aug 01, 2009 5:55 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>sgeos wrote:</b></span></td> </tr> <tr> <td class="quote">Why not get in touch with Ruben and add lua to his engine if he is OK with that?  It seems like two people cooperating on an RPG project would increase the chances of success by at least an order of magnitude.</td> </tr></table><span class="postbody">
<br/>
Well I don't know what Ruben's working on, but I'm not making a traditional RPG, I'm making a tactical RPG (didn't seem relevant enough to mention above). So I don't know how much use cooperating would be.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">This is a good idea.  FWIW, you might need a lua script compiler that runs on the GBA or DS.</td> </tr></table><span class="postbody">
<br/>
Well, the compiler in the interpreter works on the GBA and the standalone compiler builds for GBA just fine. (Though, of course, without a command line, etc, I don't know if it actually works.) So the option is there. It'll probablly end up being a compile time option.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Actually, I'm not sure it will.  How heavy are your scripts going to be?  For now I'd stick with lua out of the can, using float or double for the type of lua_Number and fuss about something more efficient later when and if the scripting engine becomes a problem.  Admittedly, switching to some sort of integer should be relatively painless, but that wouldn't be my top priority.</td> </tr></table><span class="postbody">
<br/>
I'm not entirely sure how much scripting I'll need, so I can't say if it'll be a problem or not. That said, it looks like Lua has some built in (compile time) options for other types, so I might play around with those. At the moment, I'm not very interested in changing the Lua sources more than I need to.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Karatorian wrote:</b></span></td> </tr> <tr> <td class="quote">Fixed is possible, evidently in hours if you know what you are doing.  My first attempt failed.  I have a list of places the source needs to be changed, if you want it.  I'd love to see a fixed point version of lua for embedded systems.</td> </tr></table><span class="postbody">
<br/>
Well, at the moment, I'll stick with the stock version, but if I ever do decide to experiment with it, I'll be sure to ask you about it.
<br/>
<br/>
If a robust fixed implementation was done, I wonder how hard it would be to get it officially accepted upstream. Maintaing a fork is always a pain.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Port the project to the DS and this problem is solved.</td> </tr></table><span class="postbody">
<br/>
Well, I don't own a DS and am not planning on buying one anytime soon. (I know, I must be crazy, but hey.) Besides which, it looks like MicroLua for the DS is much farther along than me, so in that case, I'd probably be better off using their stuff.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">FWIW, I wrote a couple of lua modules to tag (RPG) messages.  You can extend them with your own tags.  If you want them PM me.</td> </tr></table><span class="postbody">
<br/>
I'd be interested if for no other reason than that I don't know Lua very well. Personally, I'm a Pythonista, but the thought of porting <span style="font-style: italic">that</span> to anything scares me. (Have you seen the Python internals? It's solid code, but not exactly easily hackable.)
<br/>
<br/>
Of course, it would be interesting just to do it (after all, Torlus ported the Java VM to the GBA), but I can't see there being any resources left over to use for anything else.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#169738 - wallacoloo - Sat Aug 01, 2009 6:23 am</h4>
    <div class="postbody"><span class="postbody">What a coincidence, I'm developing an interpreter right now too. I've finished the virtual keyboard, though it's got a few minor glitches that need fixing. Nothing major, just the way newline characters are handled.
<br/>
It's for the GBA, meaning no touch screen.
<br/>
<br/>
You can see some screenshots and download the ROM from here:
<br/>
<a class="postlink" href="http://smileyunlimited.com/source.php?p=GBA/vKeyboard" target="_blank">http://smileyunlimited.com/source.php?p=GBA/vKeyboard</a>
<br/>
Make sure to read "notes.txt", and sorry for the bad UI :-(
<br/>
<br/>
I'm not sure if this is what you're looking for or not, but maybe it'll help.
<br/>
It's written in C++, I can share the source code if you're interested.
<br/>
<br/>
Java VM on the GBA? Could you send me a link?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#169739 - dantheman - Sat Aug 01, 2009 6:51 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>wallacoloo wrote:</b></span></td> </tr> <tr> <td class="quote">Java VM on the GBA? Could you send me a link?</td> </tr></table><span class="postbody">
<br/>
<a href="http://torlus.com/index.php?2004/01/05/25-java4gba---a-java-virtual-machine-for-gba" target="_blank">http://torlus.com/index.php?2004/01/05/25-java4gba---a-java-virtual-machine-for-gba</a>
<br/>
<br/>
This code was later ported to the DS (java4nds) and then modified to add MIDP support, turning it into a mobile phone java game emulator (PSTROS DS)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#169741 - Karatorian - Sat Aug 01, 2009 7:37 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>wallacoloo wrote:</b></span></td> </tr> <tr> <td class="quote">What a coincidence, I'm developing an interpreter right now too. I've finished the virtual keyboard, though it's got a few minor glitches that need fixing.</td> </tr></table><span class="postbody">
<br/>
Interpreter for what language? Something standard or your own? I'm kinda a programming language geek (even though there's only a few I really use), so I'd love to hear more about it either way.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">I'm not sure if this is what you're looking for or not, but maybe it'll help.</td> </tr></table><span class="postbody">
<br/>
Well, mostly I intend to edit and compile the scripts on my build system and only execute them on the GBA. However, I mentioned the virtual keyboard thing as I figured some people would be more interested in using it interactively, so a port of the standard interpreter would be a nice addition.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">It's written in C++, I can share the source code if you're interested.</td> </tr></table><span class="postbody">
<br/>
Well, I'm more of a C guy myself, but code's code, so I may be interesed. However, you should know that I intend to release this project under the MIT License (same as Lua itself), so don't offer to contribute if you're not comfortable with that. (It's a new style BSD license, which basically means: Do what you want, give us credit, and don't blame us if it breaks your toys. It's also been referred to (as a spoof on "copyright" and "copyleft") as a "copycenter" license, meaning "Take it down to the copy center and make some copies.")</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#169742 - wallacoloo - Sat Aug 01, 2009 8:24 am</h4>
    <div class="postbody"><span class="postbody">Yeah, it's a language of my own. The syntax is a cross between javascript and python. I haven't gotten very far on it yet. It can handle function calls with passing parameters. It can also parse math expressions. Very little support for math at this point. Integers only. 
<br/>
<br/>
Anyways, I've uploaded the source code to that url I posted earlier (as source.zip). It's documented very poorly, sorry for that.
<br/>
<br/>
The function compileAndRun under the file "vKeyboard.c" is where you'll want to add whatever code will be interpreting the text.
<br/>
<br/>
I'm not familiar with many licenses. All I care is that I can still use this code in my own projects. By the sounds of it I can, so I'm fine with that license.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
