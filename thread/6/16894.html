<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Sonic AS, GBA/DS Midi player - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>Announcements And Comments > Sonic AS, GBA/DS Midi player</h2>
<div id="posts">
<div class="post">
    <h4>#170549 - Ruben - Thu Oct 01, 2009 6:46 pm</h4>
    <div class="postbody"><span class="postbody">Well, that was quick xD
<br/>
<br/>
Long story short, I got bored a few days ago, so I wrote out the whole music engine in assembler, got bored again, and ported it to the DS just cos I can =D
<br/>
<br/>
Sonic AS has 16 channels polyphony for the DS, and variable polyphony on the GBA. It has support for variable music players, and the DS version can handle PCM8/16 and ADPCM data, as it uses the hardware channels. The GBA version can also have either nearest neighbour interpolation (that is, no interpolation; this is fast), or linear interpolation, with .23 fixed point accuracy, which can be toggled by changing the variables in sasInternal.inc.
<br/>
Since it's written in all assembler, the memory footprint is rather low.
<br/>
<br/>
All processing is done on the ARM7 side, with the ARM9 simply signaling to play/stop, etc.
<br/>
<br/>
As per usual, it comes with all sources, assets, etc., and yeah.
<br/>
You can get it <a class="postlink" href="http://www.filefactory.com/file/a0d3gc0/n/Sonic_AS_rar" target="_blank">here</a>.
<br/>
<br/>
I think that's the final music player I will code, as I am finally happy with it, so yeah, no more spam from Aik-kun. ^_^'<br/>_________________<br/>I'm 18 and have Asperger's, so if I don't get something at first, just bear with me. *nod*</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170571 - UglyMike - Fri Oct 02, 2009 10:15 pm</h4>
    <div class="postbody"><span class="postbody">Hmmmmmmmmmmmmm,
<br/>
<br/>
I didn't see an obvious way to load music files other than the "FFII Fight 1". Anything I'm missing?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170574 - Ruben - Sat Oct 03, 2009 4:23 am</h4>
    <div class="postbody"><span class="postbody">Left/Right changes the song ^_^'<br/>_________________<br/>I'm 18 and have Asperger's, so if I don't get something at first, just bear with me. *nod*</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170575 - hacker013 - Sat Oct 03, 2009 11:29 am</h4>
    <div class="postbody"><span class="postbody">on the first view it is great *played the demo ;)* but can I also play sound effects with it ?<br/>_________________<br/>Let the nds be with you.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170576 - Ruben - Sat Oct 03, 2009 11:53 am</h4>
    <div class="postbody"><span class="postbody">Yes, sound effects can be played back as song data (remember, it has a variable amount of music players ;)), which allows for more 'flexible' effects. Alternatively, you can add your own function that sets up a channel to play a single sound.
<br/>
<br/>
Personally, I prefer the 'song' method because it allows more 'tricks' and stuff, but yeah.
<br/>
<br/>
EDIT:
<br/>
<br/>
I got bored so I wrote the code for a single sound effect ^_^'
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">@ DS Version
<br/>
    push    {r4}
<br/>
    ldr     r1, =sasChan        @ &amp;chan[0]
<br/>
    mov     r2, #0x10
<br/>
#if ALLCHAN_UNLOCK
<br/>
    mov     r3, r1              @ aux_chan
<br/>
#else
<br/>
    mov     r3, #0x00           @ aux_chan
<br/>
#endif
<br/>
1:  ldrb    r4, [r1]
<br/>
    lsr     r4, r4, #0x01       @ if(chan-&gt;stat == off)
<br/>
    bcc     .LChanReady         @   goto chan_ok
<br/>
    lsr     r4, #0x04
<br/>
    cmp     r4, #sasRelease
<br/>
    bne     2f
<br/>
    mov     r3, r1
<br/>
2:  add     r1, #SAS_CHANSIZE
<br/>
    sub     r2, #0x01
<br/>
    bhi     1b
<br/>
    mov     r1, r3
<br/>
#if !ALLCHAN_UNLOCK
<br/>
    beq     .LNoChan4FX
<br/>
#endif
<br/>
<br/>
    mov     r2, #sasOn + sasNoteOn
<br/>
    strb    r2, [r1]
<br/>
    ldr     r2, [r0, #0x04]
<br/>
    lsr     r2, #0x0A
<br/>
    str     r2, [r1, #0x04]
<br/>
    mov     r2, #0x00
<br/>
    mov     r3, #0x00
<br/>
    mov     r4, #0x00
<br/>
    add     r1, #0x10
<br/>
    stmia   r1!, {r0,r2-r4}
<br/>
<br/>
.LNoChan4FX:
<br/>
    pop     {r4}
<br/>
    bx      lr
<br/>
<br/>
@ GBA Version
<br/>
    push    {r4}
<br/>
    ldr     r1, =sasChan        @ &amp;chan[0]
<br/>
    ldr     r2, =sasVar
<br/>
    ldrb    r2, [r2, #0x02]
<br/>
#if ALLCHAN_UNLOCK
<br/>
    mov     r3, r1              @ aux_chan
<br/>
#else
<br/>
    mov     r3, #0x00           @ aux_chan
<br/>
#endif
<br/>
1:  ldrb    r4, [r1]
<br/>
    lsr     r4, r4, #0x01       @ if(chan-&gt;stat == off)
<br/>
    bcc     .LChanReady         @   goto chan_ok
<br/>
    lsr     r4, #0x04
<br/>
    cmp     r4, #sasRelease
<br/>
    bne     2f
<br/>
    mov     r3, r1
<br/>
2:  add     r1, #SAS_CHANSIZE
<br/>
    sub     r2, #0x01
<br/>
    bhi     1b
<br/>
    mov     r1, r3
<br/>
#if !ALLCHAN_UNLOCK
<br/>
    beq     .LNoChan4FX
<br/>
#endif
<br/>
<br/>
    mov     r2, #sasOn + sasNoteOn
<br/>
    strb    r2, [r1]
<br/>
    ldr     r2, [r0, #0x04]
<br/>
    lsr     r2, #0x0A
<br/>
    str     r2, [r1, #0x0C]
<br/>
    mov     r2, #0x00
<br/>
    mov     r3, #0x00
<br/>
    mov     r4, #0x00
<br/>
    add     r1, #0x20
<br/>
    stmia   r1!, {r0,r2-r4}
<br/>
<br/>
.LNoChan4FX:
<br/>
    pop     {r4}
<br/>
    bx      lr</td> </tr></table><span class="postbody">
<br/>
<br/>
However, this code is untested so.. =P<br/>_________________<br/>I'm 18 and have Asperger's, so if I don't get something at first, just bear with me. *nod*</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170577 - hacker013 - Sat Oct 03, 2009 12:08 pm</h4>
    <div class="postbody"><span class="postbody">can you give an example because i don't understand the asm :(<br/>_________________<br/>Let the nds be with you.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170578 - Ruben - Sat Oct 03, 2009 12:15 pm</h4>
    <div class="postbody"><span class="postbody">Well.. create a file called "sasSFX.s" (in the case of the DS, stick it into the ARM7 source). In this file, paste this...
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">/**********************************************\
<br/>
 *            _______       _______           *
<br/>
 *           / _____/ _____/ _____/           *
<br/>
 *           \_____ \/ __  \_____ \           *
<br/>
 *           /______/__||__/______/           *
<br/>
 *                                            *
<br/>
 *                  Sonic AS                  *
<br/>
 *       Copyright (C) 2009 Ruben Nunez       *
<br/>
 *                                            *
<br/>
\**********************************************/
<br/>
<br/>
#include &lt;sasInternal.inc&gt;
<br/>
<br/>
/**********************************************/
<br/>
<br/>
.global sasSFX
<br/>
<br/>
/**********************************************/
<br/>
<br/>
.text
<br/>
.align
<br/>
.thumb
<br/>
.thumb_func
<br/>
<br/>
sasSFX:
<br/>
    @ Paste the code above in here (get
<br/>
    @ rid of these lines, too
<br/>
<br/>
.align
<br/>
.size sasSFX, .-sasSFX
<br/>
<br/>
/**********************************************\
<br/>
 * EOF                                        * 
<br/>
\**********************************************/</td> </tr></table><span class="postbody">
<br/>
<br/>
If this is for the DS, you will also need an ARM9 function to signal it to play, so make another file named "sasSFX.s" and put it in the ARM9 source. Paste this in it...
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">/**********************************************\
<br/>
 *            _______       _______           *
<br/>
 *           / _____/ _____/ _____/           *
<br/>
 *           \_____ \/ __  \_____ \           *
<br/>
 *           /______/__||__/______/           *
<br/>
 *                                            *
<br/>
 *                  Sonic AS                  *
<br/>
 *       Copyright (C) 2009 Ruben Nunez       *
<br/>
 *                                            *
<br/>
\**********************************************/
<br/>
<br/>
#include &lt;sasInternal.inc&gt;
<br/>
<br/>
/**********************************************/
<br/>
<br/>
.global sasSFX
<br/>
<br/>
/**********************************************/
<br/>
<br/>
.text
<br/>
.align
<br/>
.thumb
<br/>
.thumb_func
<br/>
<br/>
sasSFX:
<br/>
   mov      r1, #SAS_FIFOSFX
<br/>
   lsl      r1, #0x1C
<br/>
   orr      r1, r0
<br/>
   mov      r0, #SAS_FIFOCHAN
<br/>
   ldr      r2, =fifoSendValue32
<br/>
   bx      r2
<br/>
<br/>
.align
<br/>
.size sasSFX, .-sasSFX
<br/>
<br/>
/**********************************************\
<br/>
 * EOF                                        * 
<br/>
\**********************************************/</td> </tr></table><span class="postbody">
<br/>
<br/>
To make this work, you have to add this line to the sasInternal.inc file
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#define SAS_FIFOCHAN    ( 8)
<br/>
#define SAS_FIFOPLAY    ( 1)
<br/>
#define SAS_FIFOSTOP    ( 2)
<br/>
#define SAS_FIFOSTOPALL ( 3)
<br/>
#define SAS_FIFOSFX     ( 4) //! Add this line!</td> </tr></table><span class="postbody">
<br/>
<br/>
Then you can call this function by adding this line to the sasLib.h file...
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">//! sasStopAll(void)
<br/>
//! Stops all players.
<br/>
void sasStopAll(void);
<br/>
<br/>
//! Add this!
<br/>
//! sasSFX(const sasWave_t *Wave)
<br/>
//! Plays \var Wave as an SFX.
<br/>
void sasSFX(const sasWave_t *Wave);</td> </tr></table><span class="postbody">
<br/>
<br/>
EDIT:
<br/>
<br/>
Shoot, if it's for the DS, you also have to modify the jump table in the ARM7 "sasComm7.s" file
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">   .word   0
<br/>
   .word   sasPlay
<br/>
   .word   sasStop
<br/>
   .word   sasStopAll
<br/>
   .word   sasSFX @ Add this!</td> </tr></table><span class="postbody"><br/>_________________<br/>I'm 18 and have Asperger's, so if I don't get something at first, just bear with me. *nod*</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170776 - brando132 - Mon Oct 19, 2009 11:48 pm</h4>
    <div class="postbody"><span class="postbody">Is there any way to load your own songs?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170779 - Ruben - Tue Oct 20, 2009 9:21 am</h4>
    <div class="postbody"><span class="postbody">Sure. You simply use the mid2sas program included in the bin/sfx/mid folder. Once you have your song in a .s file, you place it some place in the ARM[9] source, add it to the song table, and away you go =)<br/>_________________<br/>I'm 18 and have Asperger's, so if I don't get something at first, just bear with me. *nod*</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170782 - hacker013 - Tue Oct 20, 2009 5:47 pm</h4>
    <div class="postbody"><span class="postbody">can I also load it from fat or not O_o ?<br/>_________________<br/>Let the nds be with you.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170787 - Ruben - Tue Oct 20, 2009 7:18 pm</h4>
    <div class="postbody"><span class="postbody">Er, well, I suppose I could modify the sources a fair bit for the DS (this is for the DS, right?) to allow file-access, which should be fun, IMO.
<br/>
<br/>
As a matter of interest, did you get the SFX code working? Drop me a line if not and still need to get it working.
<br/>
<br/>
EDIT:
<br/>
<br/>
Oh, and the sources have been modified a bit, and the GBA mixing code has been re-written, which gives a faster mixing and mixdown speed (at the small cost of no clipping, but it's hardly needed anyway *shrug*).<br/>_________________<br/>I'm 18 and have Asperger's, so if I don't get something at first, just bear with me. *nod*</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170790 - hacker013 - Tue Oct 20, 2009 10:10 pm</h4>
    <div class="postbody"><span class="postbody">i'm still trying to get it compiled with my project, because of a wierd reason i don't know, th .s files for de arm7 can't include .h files so this engine doesn't compile O_o<br/>_________________<br/>Let the nds be with you.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170791 - Ruben - Tue Oct 20, 2009 10:12 pm</h4>
    <div class="postbody"><span class="postbody">Well, I'll have a quick look over my latest sources, add the SFX function and update the DS sources to include support for reading files.<br/>_________________<br/>I'm 18 and have Asperger's, so if I don't get something at first, just bear with me. *nod*</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170860 - Ruben - Sat Oct 24, 2009 1:18 am</h4>
    <div class="postbody"><span class="postbody">Well, I've been trying to upload but filefactory is failing on me &gt;_&gt;'
<br/>
<br/>
But just so you know:
<br/>
<br/>
-DS runs with variable channel count (to allow stuff like libnds sound)
<br/>
-GBA mixer code has been heavily optimized
<br/>
-Music code has been revised
<br/>
-Fixed pitch bend stuff
<br/>
-Added SFX code
<br/>
<br/>
I think I'm going to make new 'demonstration' files, but in the meantime you can download the sources for Sonic AS v1.1 <a class="postlink" href="http://www.filefactory.com/file/a06fabc/n/Sonic_AS_v1_1_rar" target="_blank">here</a>.
<br/>
<br/>
EDIT:
<br/>
<br/>
I made a new GBA demonstration file (as I'm far more 'fluent' with GBA than DS), you can get it <a class="postlink" href="http://www.filefactory.com/file/a06f431/n/sasagb_rar" target="_blank">here</a>.
<br/>
<br/>
It includes all sources for it, plus somewhat revised sound code and a song not written by me to show that it works with other Midi files, too. I'll start work on the DS demonstration+upgrade soon. ^_^'<br/>_________________<br/>I'm 18 and have Asperger's, so if I don't get something at first, just bear with me. *nod*</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170866 - keldon - Sat Oct 24, 2009 11:56 am</h4>
    <div class="postbody"><span class="postbody">Have you considered <a class="postlink" href="http://www.mediafire.com/" target="_blank">mediafire</a>?
<br/>
<br/>
p.s. I also have unlimited space on my server and can set up ftp access for your own site. It could be something like ruben_super_genius.konelabs.org (or whatever you decide on) ;)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170868 - Ruben - Sat Oct 24, 2009 12:07 pm</h4>
    <div class="postbody"><span class="postbody">Ah yes, Mediafire. I would've used that, but for some reason the upload stalls when it reaches 100%, which is why I started using filefactory ;)
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">It could be something like ruben_super_genius.konelabs.org</td> </tr></table><span class="postbody">
<br/>
Lol! I'm not sure if I should be amused.. or scared. =P
<br/>
Either way, that would be good, thanks. Can I add you to MSN and we can talk there?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170871 - Ruben - Sat Oct 24, 2009 1:21 pm</h4>
    <div class="postbody"><span class="postbody">Okie doke, DS version done. I didn't bother at *all* with the samples because I'm REALLY tired (it's 11:20pm here and I only got 6 hours sleep, been awake since 7am). You can get it <a class="postlink" href="http://www.filefactory.com/file/a06g910/n/sasds_rar" target="_blank">here</a>.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#171046 - mukunda - Thu Oct 29, 2009 7:42 am</h4>
    <div class="postbody"><span class="postbody">Cool sounding! and written in tasty asm too :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#171047 - Ruben - Thu Oct 29, 2009 8:05 am</h4>
    <div class="postbody"><span class="postbody">Hehe, yes it is. ^_^'
<br/>
<br/>
I've been thinking of re-writing the Midi converter, but keep forgetting (damn short term memory -_-) and right now it's too hot to do that (I can't concentrate in the heat). After that I may add some minor tweaks to the code and make v1.2. The next thing after that would be to add pattern compression which the music player already supports, but not the converter. =P</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#171050 - keldon - Thu Oct 29, 2009 10:05 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Ruben wrote:</b></span></td> </tr> <tr> <td class="quote">Hehe, yes it is. ^_^'
<br/>
<br/>
I've been thinking of re-writing the Midi converter, but keep forgetting (damn short term memory -_-) and right now it's too hot to do that (I can't concentrate in the heat). After that I may add some minor tweaks to the code and make v1.2. The next thing after that would be to add pattern compression which the music player already supports, but not the converter. =P</td> </tr></table><span class="postbody">
<br/>
<br/>
<a class="postlink" href="http://news.bbc.co.uk/weather/forecast/8" target="_blank">Do you mind?</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#171071 - Ruben - Fri Oct 30, 2009 12:00 am</h4>
    <div class="postbody"><span class="postbody">13*C.... *drools* Wanna trade?</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
