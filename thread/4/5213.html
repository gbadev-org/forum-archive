<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>JPEG_DecompressImage problem - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>Coding > JPEG_DecompressImage problem</h2>
<div id="posts">
<div class="post">
    <h4>#37857 - emgie - Thu Mar 17, 2005 11:18 pm</h4>
    <div class="postbody"><span class="postbody">Hi,
<br/>
<br/>
I'm trying to decompress a JPEG image from source located in ROM (I think...), but I get no results.
<br/>
<br/>
<span style="font-weight: bold">mandrill.h</span>:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
unsigned char MANDRILL_DAT[6194]  ={
<br/>
0xFF,0xD8,0xFF,0xE0,0x00,0x10,0x4A,0x46,0x49, ... and so on...
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
<span style="font-weight: bold">main.c</span>:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#include "gfx/mandrill.h"
<br/>
<br/>
JPEG_DecompressImage(MANDRILL_DAT, MEM_BG_PTR, 240, 160);
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
When I first copy MANDRILL_DAT to a buffer in EWRAM (unsigned char buf[240*160*2] MEM_IN_EWRAM) and then unpack it from there, all goes well. The same if I use gbfs filesystem.
<br/>
<br/>
Anyone to tell me what's wrong in #include and right in other methods?
<br/>
<br/>
Regards,
<br/>
Maciek</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#37877 - tepples - Fri Mar 18, 2005 3:05 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>emgie wrote:</b></span></td> </tr> <tr> <td class="quote">I'm trying to decompress a JPEG image from source located in ROM (I think...), but I get no results.
<br/>
<br/>
<span style="font-weight: bold">mandrill.h</span>:
<br/>
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
unsigned char MANDRILL_DAT[6194]  ={
<br/>
0xFF,0xD8,0xFF,0xE0,0x00,0x10,0x4A,0x46,0x49, ... and so on...
<br/>
</td> </tr></table><span class="postbody"></span></td> </tr></table><span class="postbody">
<br/>
Change the first line to
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
unsigned char MANDRILL_DAT[6194] __attribute__((aligned(4))) =
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
And this is JPEG_DecompressImage from <a class="postlink" href="http://members.iinet.net.au/~freeaxs/gbacomp/#Displaying%20a%20JPEG%20Image%20on%20the%20GBA" target="_blank">Burton Radons library</a>, right?<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#38105 - emgie - Tue Mar 22, 2005 12:08 am</h4>
    <div class="postbody"><span class="postbody">Unfortunately, it doesn't work for me.
<br/>
I've tried also 8 and 256 aligning, but it doesn't help either.
<br/>
It does work when I set this data to be MEM_IN_EWRAM, so I'm suspecting that the JPEG library (by Burton Radons, yes) needs to have a write access to the memory where the source is.
<br/>
But then, why does it work when I use the gbfs filesystem?
<br/>
<br/>
Is there any documentation for the library? What are the third and fourth parameters? When I displayed 144x144 image, and invoked the function like this:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">JPEG_DecompressImage(IMG_DATA, MEM_BG_PTR, 144, 144);</td> </tr></table><span class="postbody">
<br/>
the image got messed.
<br/>
Again, I had to decompress it to a buffer in EWRAM, using (240, 160) as parameters and then blit a 144x144 part of it to the screen.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#38125 - gb_feedback - Tue Mar 22, 2005 3:18 pm</h4>
    <div class="postbody"><span class="postbody">It should work fine from ROM - it certainly worked for me. I don't even think I dword aligned it. Couple of thoughts though. It's been a while since I wrote any GBA code, but don't you need to say 'const' to get it left in ROM?
<br/>
<br/>
The business about the 3rd and 4th params. I seem to remember having the same experience and using the same fix. I think the reason has to do with the duel purpose nature of the code. With a very small change it can be made to run on a PC, and I think it is the specific mapping of GBA video memory which means you have to use 240 pixels width. You have to live with it if you don't want to re-write it.<br/>_________________<br/><a class="postlink" href="http://www.bookreader.co.uk/" target="_blank">http://www.bookreader.co.uk/</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#38147 - emgie - Wed Mar 23, 2005 12:27 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>gb_feedback wrote:</b></span></td> </tr> <tr> <td class="quote">It should work fine from ROM - it certainly worked for me. I don't even think I dword aligned it. Couple of thoughts though. It's been a while since I wrote any GBA code, but don't you need to say 'const' to get it left in ROM?
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Exactly. Using
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">const unsigned char MANDRILL_DAT[6194]  = {</td> </tr></table><span class="postbody">
<br/>
solved the problem. Thanks!
<br/>
<br/>
BTW. I still don't quite understand why it goes like that... Does the data get lost if I don't use "const"... ;-)
<br/>
I've forgot many things since my C days (now using perl &amp; php).</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#38161 - gb_feedback - Wed Mar 23, 2005 9:30 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote"> I still don't quite understand why it goes like that... Does the data get lost if I don't use "const"... ;-) 
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
The data will be copied by the startup code into RAM and referred to at that location during your program. It may well be that space constraints have caused a data loss. You prpbably only have to lose the end of the jpeg to crash the display code. Examine the .map file to see where it went.<br/>_________________<br/><a class="postlink" href="http://www.bookreader.co.uk/" target="_blank">http://www.bookreader.co.uk/</a></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
