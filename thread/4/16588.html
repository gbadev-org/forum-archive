<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Unexpected Makefile behavior - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>Coding > Unexpected Makefile behavior</h2>
<div id="posts">
<div class="post">
    <h4>#168051 - sgeos - Wed Apr 08, 2009 10:57 am</h4>
    <div class="postbody"><span class="postbody">Given the following Makefile:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">LIBS = librng.a
<br/>
<br/>
.PHONY : all
<br/>
all : $(LIBS) Makefile
<br/>
<br/>
%/lib.a : force_look
<br/>
        ls $*/*.a
<br/>
        cd $*; $(MAKE) $(MFLAGS) lib.a
<br/>
<br/>
lib%.a : %/lib.a
<br/>
        cp $&lt; $@
<br/>
        ls $*/*.a
<br/>
<br/>
.PHONY : force_look
<br/>
force_look :
<br/>
        true</td> </tr></table><span class="postbody">
<br/>
<br/>
I get the following output:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">$ make
<br/>
true
<br/>
ls rng/*.a
<br/>
rng/librng.a
<br/>
cd rng; make  lib.a
<br/>
make[1]: Entering directory `/home/USER/cpp/maze/lib/rng'
<br/>
rm -f lib.a
<br/>
ar cq lib.a RNG.o
<br/>
make[1]: Leaving directory `/home/USER/cpp/maze/lib/rng'
<br/>
cp rng/lib.a librng.a
<br/>
ls rng/*.a
<br/>
rng/lib.a  rng/librng.a</td> </tr></table><span class="postbody">
<br/>
<br/>
The problem is that when everything is said and done, lib.a does not exist in rng/
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">$ ls rng/*.a
<br/>
rng/librng.a</td> </tr></table><span class="postbody">
<br/>
<br/>
This is not the case if I explicitly make rng/lib.a.  Why is make doing this?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#168053 - gauauu - Wed Apr 08, 2009 2:53 pm</h4>
    <div class="postbody"><span class="postbody">I've had this happen before -- as far as I can tell, make thinks your lib.a is an intermediate file, and thus deletes it when finished with it.  
<br/>
<br/>
I've ran into various workarounds, searching on google about make deleting intermediate files.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#168060 - sgeos - Wed Apr 08, 2009 5:40 pm</h4>
    <div class="postbody"><span class="postbody">I found information about this <a class="postlink" href="http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=4073" target="_blank">here</a>.  It appears that the solution is to explicitly mention the file anywhere, like this:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">.PHONY : do-not-delete
<br/>
do-not-delete : me.file or-me.file</td> </tr></table><span class="postbody">
<br/>
Is there a way to have libmyfile.a depend on myfile/libmyfile.a using a pattern rule?  The following does not work:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">lib%.a : %/lib%.a</td> </tr></table><span class="postbody">
<br/>
Right now I'm always running the rule and using <span style="font-weight: bold">cp -u</span> as a work around, but this approach does not feel right.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#168070 - kusma - Thu Apr 09, 2009 12:18 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>sgeos wrote:</b></span></td> </tr> <tr> <td class="quote">I found information about this <a class="postlink" href="http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=4073" target="_blank">here</a>.  It appears that the solution is to explicitly mention the file anywhere, like this:
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">.PHONY : do-not-delete
<br/>
do-not-delete : me.file or-me.file</td> </tr></table><span class="postbody">
<br/>
Is there a way to have libmyfile.a depend on myfile/libmyfile.a using a pattern rule?  The following does not work:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">lib%.a : %/lib%.a</td> </tr></table><span class="postbody">
<br/>
Right now I'm always running the rule and using <span style="font-weight: bold">cp -u</span> as a work around, but this approach does not feel right.</span></td> </tr></table><span class="postbody">
<br/>
I think what you're searching for might be the ".SECONDARY" pseudo-target.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#168074 - sgeos - Thu Apr 09, 2009 12:43 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>kusma wrote:</b></span></td> </tr> <tr> <td class="quote">I think what you're searching for might be the ".SECONDARY" pseudo-target.</td> </tr></table><span class="postbody">
<br/>
That was mentioned in link above, but it appears that .SECONDARY does not support pattern rules.  Also, .SECONDARY is buggy according to the maintainer at the time the information in the above link was written.  Explict mention using a dummy target was recommended by the maintainer.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#168085 - gauauu - Thu Apr 09, 2009 3:19 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>sgeos wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
Is there a way to have libmyfile.a depend on myfile/libmyfile.a using a pattern rule?  The following does not work:
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
This is where my lack of knowledge of makefiles starts showing itself, but maybe something along the general idea of:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
lib%.a : $(patsubst lib%.a,%/lib%.a, $@)
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
With the idea that $@ would be libmyfile.a, and the patsubst would change it to myfile/libmyfile.a?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#168089 - sgeos - Thu Apr 09, 2009 6:24 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>gauauu wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">lib%.a : $(patsubst lib%.a,%/lib%.a, $@)</td> </tr></table><span class="postbody">
<br/>
With the idea that $@ would be libmyfile.a, and the patsubst would change it to myfile/libmyfile.a?</span></td> </tr></table><span class="postbody">
<br/>
<span style="font-weight: bold">EDIT:</span> patsubst changes it to myfile/lib%.a
<br/>
<br/>
This seemed to work, but upon testing it didn't seem to update files after I made changes.  It also appears that I need to try to recursively remake every library anyway, so this is what I am currently using:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">SRCDIR = rng programargument
<br/>
INCDIR = ../include
<br/>
DSTLIB = $(patsubst %,lib%.a,$(SRCDIR))
<br/>
<br/>
.PHONY : all
<br/>
all : $(DSTLIB) Makefile
<br/>
<br/>
lib%.a : force_look
<br/>
        cd $*; $(MAKE) $(MFLAGS) lib$*.a
<br/>
        cp -u $*/$@ $@
<br/>
        -cp -u $*/*.h $(INCDIR)
<br/>
        -cp -u $*/*.hpp $(INCDIR)
<br/>
<br/>
.PHONY : force_look
<br/>
force_look :
<br/>
        true</td> </tr></table><span class="postbody">
<br/>
I was hoping to have lib%.a depend on %/lib%.a, and have %/lib%.a depend on force_look, but that seemed to involve voodoo beyond my abilities and this seems to do the trick.
<br/>
<br/>
Thanks for your help though.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#169635 - Karatorian - Mon Jul 27, 2009 5:24 pm</h4>
    <div class="postbody"><span class="postbody">Too keep (GNU) make from deleting intermediate files, you can use the .PRECIOUS directive, like so:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
.PRECIOUS: %.img %.pal
<br/>
</td> </tr></table><span class="postbody">
<br/>
Depending on what you're looking for, this could be the proper solution, or just a work around. Basically, when you run make without an argument, you're telling it that you want "librng.a". It's sort of implied that you don't care about "rng/lib.a". If "rng/lib.a" is supposed to be a target, it should be specified as such. If it's not supposed to be a target, but you want to avoid rebuilding it every time (basically, you want to cache it), precious is the way to go.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#169667 - sgeos - Tue Jul 28, 2009 4:37 pm</h4>
    <div class="postbody"><span class="postbody">I saw .PRECIOUS, but I'd need to go back and look into this again.  Thanks for the information.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
