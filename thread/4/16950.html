<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Makefile to compile EFS/FAT version - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>Coding > Makefile to compile EFS/FAT version</h2>
<div id="posts">
<div class="post">
    <h4>#171146 - headspin - Tue Nov 03, 2009 2:48 am</h4>
    <div class="postbody"><span class="postbody">I'm trying to modify a makefile to compile an EFS or FAT version based on the following:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">EFS := 1</td> </tr></table><span class="postbody">
<br/>
<br/>
I can get this to work in the Makefile itself like so:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">$(TARGET).nds   :   $(TARGET).arm7 $(TARGET).arm9
<br/>
ifeq ($(EFS), 1)
<br/>
   ndstool -c $(TARGET).nds -7 $(TARGET).arm7 -9 $(TARGET).arm9 $(NITRODIR) $(LOGO) $(ICON) "$(NAME);$(AUTHOR);$(VERSION)"
<br/>
   efs $(TARGET).nds
<br/>
else
<br/>
   ndstool -c $(TARGET).nds -7 $(TARGET).arm7 -9 $(TARGET).arm9 $(LOGO) $(ICON) "$(NAME);$(AUTHOR);$(VERSION)"
<br/>
endif</td> </tr></table><span class="postbody">
<br/>
<br/>
But for some reason in the arm9 main.s the EFS value does not seem to be set..
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#if (EFS == 1)
<br/>
   mov r0, #(EFS_AND_FAT | EFS_DEFAULT_DEVICE)   @ Init EFS
<br/>
   mov r1, #0
<br/>
   bl EFS_Init
<br/>
#else
<br/>
   bl fatInitDefault                     @ Init FAT
<br/>
#endif</td> </tr></table><span class="postbody">
<br/>
<br/>
So that is always failing to see if EFS is set to "1" in the makefile. On the other hand if I do a "#define EFS 1" at the start of main.s then it will be set and do what it's supposed to do.
<br/>
<br/>
Why isn't the environment variable set in the Makefile registered in the pre-processor commands in main.s? The Makefile in question is the main one, not the one for the arm7 or arm9 so it should be set before compiling main.s in arm9 right?<br/>_________________<br/><a class="postlink" href="http://headsoft.com.au/index.php?category=warhawk" target="_blank">Warhawk DS</a> | <a class="postlink" href="http://headsoft.com.au/index.php?category=mmll" target="_blank">Manic Miner: The Lost Levels</a> | <a class="postlink" href="http://headsoft.com.au/index.php?category=tdg" target="_blank">The Detective Game</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#171147 - kusma - Tue Nov 03, 2009 2:52 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>headspin wrote:</b></span></td> </tr> <tr> <td class="quote">Why isn't the environment variable set in the Makefile registered in the pre-processor commands in main.s?</td> </tr></table><span class="postbody">
<br/>
Because environment variables and preprocessor definitions aren't the same thing? You need to do something along the lines of
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">ifeq ($(EFS), 1) 
<br/>
CPPFLAGS += -DEFS
<br/>
endif</td> </tr></table><span class="postbody">
<br/>
...to get the desired effect.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#171148 - headspin - Tue Nov 03, 2009 3:05 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>kusma wrote:</b></span></td> </tr> <tr> <td class="quote">Because environment variables and preprocessor definitions aren't the same thing?</td> </tr></table><span class="postbody">
<br/>
<br/>
That would explain it
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>kusma wrote:</b></span></td> </tr> <tr> <td class="quote">You need to do something along the lines of
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">ifeq ($(EFS), 1) 
<br/>
CPPFLAGS += -DEFS
<br/>
endif</td> </tr></table><span class="postbody">
<br/>
...to get the desired effect.</span></td> </tr></table><span class="postbody">
<br/>
<br/>
Hmm that didn't seem to work<br/>_________________<br/><a class="postlink" href="http://headsoft.com.au/index.php?category=warhawk" target="_blank">Warhawk DS</a> | <a class="postlink" href="http://headsoft.com.au/index.php?category=mmll" target="_blank">Manic Miner: The Lost Levels</a> | <a class="postlink" href="http://headsoft.com.au/index.php?category=tdg" target="_blank">The Detective Game</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#171149 - Drovor - Tue Nov 03, 2009 3:06 am</h4>
    <div class="postbody"><span class="postbody">In the Makefile try adding "-DEFS=1" to the CFLAGS option.
<br/>
<br/>
The "#if (EFS == 1)" checks for preprocessor flags, not environment variables.
<br/>
<br/>
For example compile this with "gcc main.c -DEFS=1" then try "gcc main.c -DEFS=2"
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#include &lt;stdio.h&gt;
<br/>
int main()
<br/>
{
<br/>
  #if (EFS == 1)
<br/>
    printf("EFS = 1\n");
<br/>
  #elif (EFS == 2)
<br/>
    printf("EFS = 2\n");
<br/>
  #endif
<br/>
  return 0;
<br/>
}
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#171151 - headspin - Tue Nov 03, 2009 3:18 am</h4>
    <div class="postbody"><span class="postbody">Still doesn't seem to be working. I have EFS := 1 in the main Makefile, and in the arm9 makefile I have
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">ifeq ($(EFS), 1) 
<br/>
   CFLAGS += -DEFS=1
<br/>
   ASFLAGS += -DEFS=1
<br/>
endif</td> </tr></table><span class="postbody">
<br/>
<br/>
After the CFLAGS and ASFLAGS values are set. This is an asm file (main.s) so I tried adding it to the ASFLAGS value aswell. No joy :(<br/>_________________<br/><a class="postlink" href="http://headsoft.com.au/index.php?category=warhawk" target="_blank">Warhawk DS</a> | <a class="postlink" href="http://headsoft.com.au/index.php?category=mmll" target="_blank">Manic Miner: The Lost Levels</a> | <a class="postlink" href="http://headsoft.com.au/index.php?category=tdg" target="_blank">The Detective Game</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#171154 - kusma - Tue Nov 03, 2009 11:13 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>headspin wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">ifeq ($(EFS), 1) 
<br/>
   CFLAGS += -DEFS=1
<br/>
   ASFLAGS += -DEFS=1
<br/>
endif</td> </tr></table><span class="postbody">
<br/>
<br/>
After the CFLAGS and ASFLAGS values are set. This is an asm file (main.s) so I tried adding it to the ASFLAGS value aswell. No joy :(</span></td> </tr></table><span class="postbody">
<br/>
<br/>
First of all, -D directives are C pre-processor defines, not C compiler directives (there's a difference, even though it might be small). So in general -D (and -I) directives should go in CPPFLAGS, not CFLAGS (some people seem to think CPPFLAGS is for C++ flags, but that's what CXXFLAGS is for). Secondly, you should use the $(COMPILE.S) rule (as opposed to the $(COMPILE.s) rule)... if you use make's implicit build-rules, that is.  If not, you should make sure you call "gcc -x assembler-with-cpp", and make sure you include $(CPPFLAGS) in your "%.o : %.S"-rule.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
