<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Multiple interrupts - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>Coding > Multiple interrupts</h2>
<div id="posts">
<div class="post">
    <h4>#13422 - poslundc - Sat Dec 13, 2003 2:14 am</h4>
    <div class="postbody"><span class="postbody">I'm looking at combining my graphics engine with my music engine, and it has me a little bit nervous. Basically because both rely heavily on interrupts, and I'm concerned about collisions occuring between the two. Here's the skinny on it:
<br/>
<br/>
- Graphics engine has a HBlank ISR that pretty much <span style="font-style: italic">has</span> to run and cannot afford to be pre-empted with the short length of time that HBlank lasts.
<br/>
<br/>
- Music engine relies on a timer that interrupts at a frequency of 4096 Hz.
<br/>
<br/>
My ideal situation would be to have both interrupts enabled, and if the music interrupt is activated during the HBlank ISR then it would be blocked until the HBlank ISR completed (and if the HBlank ISR was activated during the music ISR, then it would interrupt it).
<br/>
<br/>
I suppose I can at least change my HBlank ISR so that the first thing it does is set REG_IME to zero, and then just before returning sets REG_IME to 1. The problem with this, though, is that if I understand correctly then it won't simply <span style="font-style: italic">block</span> my music interrupt, it'll ignore it entirely, and some samples will go missing as a result. I'm guessing that over the VDraw period this could accumulate to become quite a nuisance.
<br/>
<br/>
Are there any suggestions as to how I should be dealing with this?
<br/>
<br/>
Thanks,
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#13427 - torne - Sat Dec 13, 2003 5:05 am</h4>
    <div class="postbody"><span class="postbody">DKA 5 has a prioritised multiple interrupt handler.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#13429 - poslundc - Sat Dec 13, 2003 6:21 am</h4>
    <div class="postbody"><span class="postbody">Forgive me for being naive, but I've just been using a pre-compiled Mac OS X version of DKA, and don't know an awful lot about upgrading it.
<br/>
<br/>
I know in the version that I have, interrupts are handled by crt0.S. In order to get this improved functionality, do I just need to get the more recent version of crt0.S? If so, which of the packages on the website contains it? Or is the only way to get this improved functionality by recompiling the whole darned thing?
<br/>
<br/>
Does the new DKA ISR handle the priorities in the way I was describing? I'm not shy about coding an interrupt handler (I was planning on going in and messing with the one in crt0.S eventually anyway), it's just that I don't really know how to block (ie. <span style="font-style: italic">detain</span>) lower-priority interrupts without skipping them entirely.
<br/>
<br/>
Thanks,
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#13434 - gb_feedback - Sat Dec 13, 2003 12:31 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Music engine relies on a timer that interrupts at a frequency of 4096 Hz. </td> </tr></table><span class="postbody">I suppose this means that your dma is using the interrupt to request 4 bytes at a time? I know it won't be a welcome suggestion, but wouldn't it be better to do the dma from a couple of buffers long enough for one frame, and not use interrupts at all. I tried it once using interrupts, but it was all too time critical and kept locking up on me. Doing all the work during vblank fixed everything.
<br/>
<br/>
If I've misunderstood what you're doing - ignore this.<br/>_________________<br/><a class="postlink" href="http://www.bookreader.co.uk/" target="_blank">http://www.bookreader.co.uk/</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#13436 - torne - Sat Dec 13, 2003 12:39 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>poslundc wrote:</b></span></td> </tr> <tr> <td class="quote">I know in the version that I have, interrupts are handled by crt0.S. In order to get this improved functionality, do I just need to get the more recent version of crt0.S? If so, which of the packages on the website contains it? Or is the only way to get this improved functionality by recompiling the whole darned thing?</td> </tr></table><span class="postbody">
<br/>
<br/>
You should just be able to replace the crt* files and the link script.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Does the new DKA ISR handle the priorities in the way I was describing? I'm not shy about coding an interrupt handler (I was planning on going in and messing with the one in crt0.S eventually anyway), it's just that I don't really know how to block (ie. <span style="font-style: italic">detain</span>) lower-priority interrupts without skipping them entirely.</td> </tr></table><span class="postbody">
<br/>
<br/>
Just read the DKA code, then, and write your own.  Basically, all you need to do is to write to the IE register to disable all interrupts of lower priority than the one you are currently processing (they will still be generated, and will thus be handled when you turn them back on), then reenable interrupts by flipping the I bit of the CPSR. It's slightly fiddly to get it all done in the correct order so as not to cause any races; the No$ documentation has some details.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#13441 - poslundc - Sat Dec 13, 2003 3:51 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>gb_feedback wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Music engine relies on a timer that interrupts at a frequency of 4096 Hz. </td> </tr></table><span class="postbody">I suppose this means that your dma is using the interrupt to request 4 bytes at a time? I know it won't be a welcome suggestion, but wouldn't it be better to do the dma from a couple of buffers long enough for one frame, and not use interrupts at all. I tried it once using interrupts, but it was all too time critical and kept locking up on me. Doing all the work during vblank fixed everything.</span></td> </tr></table><span class="postbody">
<br/>
<br/>
I've experimented with buffered systems and they work okay... the thing is that the latest mixer I wrote processes exactly four samples in its loop. So I figured at the cost of having two DMAs running (which means halting the CPU, running DMA1, running DMA2, and then restarting the CPU) every frame I might as well just have an interrupt do it and not have to worry about keeping track of and switching up the DMAs (in a double-buffered system).
<br/>
<br/>
It's actually worked pretty well... but now I'm thinking of scaling it down to a simpler half-panning system that uses scaling instead of clipping, so I may go back to using a buffer, who knows. :P
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#13442 - poslundc - Sat Dec 13, 2003 4:03 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>torne wrote:</b></span></td> </tr> <tr> <td class="quote">Just read the DKA code, then, and write your own.  Basically, all you need to do is to write to the IE register to disable all interrupts of lower priority than the one you are currently processing <span style="font-style: italic">(they will still be generated, and will thus be handled when you turn them back on)</span></td> </tr></table><span class="postbody">
<br/>
<br/>
Is that so? It'll be easy to code, then. I was under the impression, though, that if you didn't have the bits flipped on in REG_IE that the interrupts wouldn't be generated. This is the lynchpin to the operation, since if the interrupts are <span style="font-style: italic">skipped</span> instead of just held up then my system won't work.
<br/>
<br/>
So if, for example, I were to enable VBlank interrupts in REG_DISPSTAT but not in REG_IE, then suddenly at some point in my program turn VBlank interrupts on in REG_IE, would I immediately have a VBlank interrupt regardless of whether I was in VBlank or not because of an initial interrupt trigger many VBlank cycles ago that was <span style="font-style: italic">detained</span> instead of <span style="font-style: italic">skipped</span>?
<br/>
<br/>
Thanks,
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#13454 - torne - Sat Dec 13, 2003 7:37 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>poslundc wrote:</b></span></td> </tr> <tr> <td class="quote">So if, for example, I were to enable VBlank interrupts in REG_DISPSTAT but not in REG_IE, then suddenly at some point in my program turn VBlank interrupts on in REG_IE, would I immediately have a VBlank interrupt regardless of whether I was in VBlank or not because of an initial interrupt trigger many VBlank cycles ago that was <span style="font-style: italic">detained</span> instead of <span style="font-style: italic">skipped</span>?</td> </tr></table><span class="postbody">
<br/>
<br/>
Yes, you would. That's exactly how it works. The actual enabling/disabling of the *event* is handled in some event-specific way (for h/vblank it's in DISPCNT, for timers it's whether the timer is running..etc). REG_IE only affects whether the events actually interrupt the CPU; they happen regardless.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#13457 - gb_feedback - Sat Dec 13, 2003 8:01 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">I've experimented with buffered systems and they work okay... the thing is that the latest mixer I wrote processes exactly four samples in its loop. So I figured at the cost of having two DMAs running (which means halting the CPU, running DMA1, running DMA2, and then restarting the CPU) every frame I might as well just have an interrupt do it and not have to worry about keeping track of and switching up the DMAs (in a double-buffered system). 
<br/>
</td> </tr></table><span class="postbody">When I tried something similar the killer was that the amount of processing varied quite a lot depending on the state of each channel. So sometimes the interrupt timing was critical. Spread over a whole frame the average processing load was never critical.
<br/>
Also the actual interrupt overhead (times many interrupts per frame) added significantly to the actual mixer processing.
<br/>
<br/>
Hell - just knocked over my drink all over the mouse!<br/>_________________<br/><a class="postlink" href="http://www.bookreader.co.uk/" target="_blank">http://www.bookreader.co.uk/</a></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
