<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>How to put C code in iwram? - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>Coding > How to put C code in iwram?</h2>
<div id="posts">
<div class="post">
    <h4>#21253 - isildur - Wed May 26, 2004 2:26 pm</h4>
    <div class="postbody"><span class="postbody">I know how to do it in assembly by using the .section .iwram directive but how do I put a C function in iwram?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#21254 - isildur - Wed May 26, 2004 2:50 pm</h4>
    <div class="postbody"><span class="postbody">never mind, I figured it out :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#21256 - isildur - Wed May 26, 2004 3:08 pm</h4>
    <div class="postbody"><span class="postbody">I have another similar question... How can I specify that a certain C function be compiled in thumb?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#21259 - Lord Graga - Wed May 26, 2004 3:16 pm</h4>
    <div class="postbody"><span class="postbody">Use the edit button, you looney! ;)
<br/>
<br/>
I would tell you how to do it if I knew :P</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#21260 - isildur - Wed May 26, 2004 3:18 pm</h4>
    <div class="postbody"><span class="postbody">Your reply is as silly as my not using the edit button :) Thanks anyways ;)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#21262 - NoMis - Wed May 26, 2004 3:31 pm</h4>
    <div class="postbody"><span class="postbody">As far as i know its only possible to use different compile options at file basis. So if you want a specific function compiled in thumb and other functions in arm than put the function definitions in different files.
<br/>
<br/>
NoMis</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#21263 - isildur - Wed May 26, 2004 3:39 pm</h4>
    <div class="postbody"><span class="postbody">Ok, I will do it for a whole file. But when it is a C file, is there a directive I can put in it to make it compile as thumb?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#21264 - Lord Graga - Wed May 26, 2004 3:42 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>isildur wrote:</b></span></td> </tr> <tr> <td class="quote">Ok, I will do it for a whole file. But when it is a C file, is there a directive I can put in it to make it compile as thumb?</td> </tr></table><span class="postbody">I think there's a function like --compile-thumb, or something. Look it up!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#21266 - poslundc - Wed May 26, 2004 3:59 pm</h4>
    <div class="postbody"><span class="postbody">gcc -mthumb
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#21268 - isildur - Wed May 26, 2004 4:06 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>poslundc wrote:</b></span></td> </tr> <tr> <td class="quote">gcc -mthumb
<br/>
<br/>
Dan.</td> </tr></table><span class="postbody">
<br/>
<br/>
Yes, I know this one but is there a directive I can put in my C file to have it compiled automatically in thumb?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#21281 - wintermute - Wed May 26, 2004 5:31 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>isildur wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>poslundc wrote:</b></span></td> </tr> <tr> <td class="quote">gcc -mthumb
<br/>
<br/>
Dan.</td> </tr></table><span class="postbody">
<br/>
<br/>
Yes, I know this one but is there a directive I can put in my C file to have it compiled automatically in thumb?</span></td> </tr></table><span class="postbody">
<br/>
<br/>
<br/>
Not that I'm aware of. and I have been looking around for something similar.
<br/>
<br/>
The most straigtforward way I've found is to use makefile rules
<br/>
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
THUMB   :=   -mthumb -mthumb-interwork
<br/>
ARM   :=   -mthumb-interwork
<br/>
<br/>
#---------------------------------------------------------------------------------
<br/>
%_arm.o : %_arm.c
<br/>
   @echo $(notdir $&lt;)
<br/>
   $(CC) -MMD $(ARM) $(CFLAGS) -o $@ -c $&lt;
<br/>
<br/>
#---------------------------------------------------------------------------------
<br/>
%.o : %.c
<br/>
   @echo $(notdir $&lt;)
<br/>
   $(CC) -MMD $(THUMB) $(CFLAGS) -o $@ -c $&lt;
<br/>
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#21283 - isildur - Wed May 26, 2004 5:43 pm</h4>
    <div class="postbody"><span class="postbody">wintermute, thanks, I will go that way then...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#22940 - R0d Longfella - Thu Jul 01, 2004 5:03 pm</h4>
    <div class="postbody"><span class="postbody">Perhaps you could make use of grep in your make file, and have it look for a useless define or comment. (such as #define THUMB or // use Thumb!) If either of the two are present you can switch your compiler statement.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#22967 - col - Thu Jul 01, 2004 10:36 pm</h4>
    <div class="postbody"><span class="postbody">I use a similar approach to Wintermute. All the files to be compiled as arm have .arm.c or .arm.cpp
<br/>
<br/>
My makefile sorts the rest out.
<br/>
<br/>
FWIW, I posted my makefile in full a while ago:
<br/>
<a href="http://forum.gbadev.org/viewtopic.php?t=2004&amp;start=12" target="_blank">http://forum.gbadev.org/viewtopic.php?t=2004&amp;start=12</a>
<br/>
<br/>
This version there is a bit out of date, but contains most of the goodness. The nice thing is that you can seperate all your source files into different folders.
<br/>
You just tell the makefile where the folders are and it does the rest.
<br/>
The only time you need to edit the makefile is if you add a new directory, or want to tweak the compiler switches. You don't need to edit it when you add new source files - the makefile scans the directories and sorts out all the source files and headers.
<br/>
It handles all the dependency issues as well - only recompiles what is needed.
<br/>
It compiles to arm and thumb using .thumb.c, .thumb.cpp, .arm.c, .arm.cpp - thumb is default, so you only need to to the .arm. bits
<br/>
 anyhow, give it a whirl :)
<br/>
<br/>
cheers
<br/>
<br/>
Col
<br/>
<br/>
Edit - i forgot to add, this makefile depends on gnu make specific features, so you will need to use gnu make.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#22993 - batblaster - Fri Jul 02, 2004 9:04 am</h4>
    <div class="postbody"><span class="postbody">Hi ,
<br/>
<br/>
I'm coding some different thiongs and sometimes i'm putting my function in IWRAM , to do i've taked some help from HAM doing this:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
<br/>
void function(void) MEM_FUNC_IN_IWRAM;
<br/>
<br/>
<br/>
<br/>
MEM_FUNC_IN_IWRAM void function(void)
<br/>
{
<br/>
...
<br/>
}
<br/>
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
This work perfectly, tested many many times on my small 3d routines and tested with No$GBA too...
<br/>
<br/>
To know how the macro work you need to watch the HAM dev kit...<br/>_________________<br/>Batblaster / 7 Raven Studios Co. Ltd
<br/>
------------------------------------------</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#24000 - Yodajr - Mon Jul 26, 2004 8:09 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>batblaster wrote:</b></span></td> </tr> <tr> <td class="quote">This work perfectly</td> </tr></table><span class="postbody">
<br/>
<br/>
batblaster, your projet is under the 256ko ?
<br/>
Because if my rom overtake the multiboot limit, when I use this macro, I have this error : 
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">relocation truncated to fit: R_ARM_PC24</td> </tr></table><span class="postbody">
<br/>
<br/>
Are you do something else ?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#24034 - batblaster - Mon Jul 26, 2004 9:19 pm</h4>
    <div class="postbody"><span class="postbody">Nope , my code in 17.5 megabits and works perfect , i dont know what is the difference if you use the macro on HAM or on devkitadv...
<br/>
<br/>
My demo is out and many of my routine are in IWRAM, if you wan to see the demo take from here...
<br/>
<br/>
<br/>
<a class="postlink" href="http://www.ngine.de/roms/RasterMania.rar" target="_blank">http://www.ngine.de/roms/RasterMania.rar</a>
<br/>
<br/>
I hope you like and i hope GBADEV put online very very soon...
<br/>
<br/>
On my demo all raster and 3d routines are in IWRAM using the macro...
<br/>
<br/>
CU...<br/>_________________<br/>Batblaster / 7 Raven Studios Co. Ltd
<br/>
------------------------------------------</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#24057 - Yodajr - Tue Jul 27, 2004 4:03 am</h4>
    <div class="postbody"><span class="postbody">If I like it ? I love it ! :D
<br/>
Congratulations, man, your demo is impressive !
<br/>
<br/>
I don't understand why I have this error... I use HAM and VHAM :-/
<br/>
<br/>
How are you initialise the variables wich used in the routines in IWRAM ?
<br/>
<br/>
u8 pos_x MEM_IN_IWRAM; ? 
<br/>
<br/>
Are you using any "include" ?
<br/>
<br/>
Thanks ;)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#24062 - DekuTree64 - Tue Jul 27, 2004 8:11 am</h4>
    <div class="postbody"><span class="postbody">Hey there Batblaster, great demo! Glad to see that you're still at it. Demo coders are rare these days, seems like most people here are just working on games now. Not that that's a bad thing, the experience gained from making a game is surely more valuable than that from making a demo, but heck, demos are more fun, and are much more feasable to finish. 
<br/>
My new spare-time project is a standard tunnel effect, casting one ray per 8x8 pixels, and interpolating the texture coordinates between them. Not too interesting, but since thats the classic method, and GBA uses tiles just the right size, I couldn't resist. 
<br/>
<br/>
Anyway, so as not to be entirely off the original topic, Yodajr, your problem is that you're not using long calls. EWRAM and IWRAM are close enough together that you can do regular branches between them, but when you move the EWRAM code into ROM, then it's too far away so you have to tell the compiler to deal with it properly. I always used my own long-call function to do it, because I wasn't using the standard libraries, which the compiler expects to have when using automatic long calls. 
<br/>
Usually there are two defines, MEM_IN_IWRAM and CODE_IN_IWRAM, or something like that. The mem version just specifies to put it in IWRAM, the code version also specifies to use a long call as well, so if you have both versions, just switch it to the code one, if not, I'll go dig up a reference on exactly how to set the attributes for it.<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#24089 - dagamer34 - Tue Jul 27, 2004 8:12 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#define CODE_IN_IWRAM    __attribute__ ((section (".iwram"), long_call))
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
No need to look it up Deku, i did it for you. ;)<br/>_________________<br/>Little kids and Playstation 2's don't mix. :(</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#24254 - batblaster - Fri Jul 30, 2004 6:00 pm</h4>
    <div class="postbody"><span class="postbody">Deku, you are my asm Teacher heheheh Many many thanks you got a time to watch my demo... My 3D routine for the endpart are not so well like yours but Krawall take so much time...
<br/>
<br/>
I'm working now on some new things , i don't know if i will relase but i like hehehe...
<br/>
<br/>
Thanks to all people who found time to watch my demo... thanks a lot...<br/>_________________<br/>Batblaster / 7 Raven Studios Co. Ltd
<br/>
------------------------------------------</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
