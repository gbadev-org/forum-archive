<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>ASM Performance Question - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>Coding > ASM Performance Question</h2>
<div id="posts">
<div class="post">
    <h4>#170077 - Seahawk - Fri Aug 28, 2009 4:16 am</h4>
    <div class="postbody"><span class="postbody">I am learning how to write ASM code for GBA. Leaving it to the compiler to make code for me is probably better, but I still want to try.
<br/>
<br/>
I've noticed a difference in the "style" of how the compiler generates code for loading data into an I/O port location.
<br/>
<br/>
For instance, if I use the C-way of loading a register
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
WAIT_CONTROL = 0x4003;
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
devkitPro generates the following code, viewed through VBA disassembler window.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
080005ee ldr r2, [$080005f8] (=$00004003)
<br/>
080005f0 ldr r3, [$080005fc] (=$04000204)
<br/>
080005f2 strh r2, [r3, #0x0]
<br/>
080005f4 b $080005f
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
The way I wrote it was:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
080005ee mov r0, #0x80
<br/>
080005f0 lsl r0, r0, #0x7
<br/>
080005f2 add r0, #0x3
<br/>
080005f4 mov r1, #0x80
<br/>
080005f6 lsl r1, r1, #0x0a
<br/>
080005f8 add r1, #0x1
<br/>
080005fa lsl r1, r1, #0x7
<br/>
080005fc add r1, #0x1
<br/>
080005fe lsl r1, r1, #0x02
<br/>
08000600 strh r0, [r1, #0x0]
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
My code uses 1 non sequential accesses on ROM and 9 sequential accesses. Devkitpro's code uses 6 nonsequential accesses and 1 sequential.
<br/>
<br/>
Which version would be faster generally? I know sequential access on ROM is faster, but would the greater amount of statements to process in my code negate this advantage?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170080 - Dwedit - Fri Aug 28, 2009 5:24 am</h4>
    <div class="postbody"><span class="postbody">You optimize the code that runs 18,000,00 times, and forget about optimizing the code that runs 7 times.
<br/>
<br/>
But anyway, somehow go track down a copy of NO$GBA, and it tells you how many cycles it took to execute.
<br/>
<br/>
I almost never use Thumb ASM anyway.<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170081 - eKid - Fri Aug 28, 2009 5:45 am</h4>
    <div class="postbody"><span class="postbody">They should both take around the same time to execute, although the first one has that branch at the end which pushes the cycle count a bit above the second one. (but the first one is smaller...)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170085 - kusma - Fri Aug 28, 2009 6:11 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>eKid wrote:</b></span></td> </tr> <tr> <td class="quote">They should both take around the same time to execute, although the first one has that branch at the end which pushes the cycle count a bit above the second one. (but the first one is smaller...)</td> </tr></table><span class="postbody">
<br/>
AFAICT, the branch is just the following code, so it shouldn't be counted.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170087 - Cearn - Fri Aug 28, 2009 8:03 pm</h4>
    <div class="postbody"><span class="postbody">Cycle counting becomes a little complicated when it comes to memory accesses because you have to split them up into code and data parts, and then deal with waitstates and bus-sizes. You can find all these at <a class="postlink" href="http://nocash.emubase.de/gbatek.htm#gbamemorymap" target="_blank">gbatek:gbamemmap</a>. In these cases, I think it comes down to the following:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">@ Assuming ROM code, default waitstates.
<br/>
@ Affixes 'c and 'd' mean code and data.
<br/>
@ The number indicates the section (like 8 for ROM)
<br/>
@ 'w' and 'h' mean word and halfword access.
<br/>
@ The strh doesn't matter, as it's part of both algorithms.
<br/>
@ NOTE: just a theoretical estimate.
<br/>
<br/>
ldr     r0,=0x4003          @ Nc(8h) + Nd(8w) + I
<br/>
ldr     r1,=0x04000204      @ Nc(8h) + Nd(8w) + I
<br/>
<br/>
Total : 2*N(8h) + 2*N(8w) + 2*I = 2*5 + 2*8 + 2*1 = 28
<br/>
<br/>
<br/>
mov     r0, #0x80       
<br/>
lsl     r0, r0, #0x7
<br/>
add     r0, #0x3
<br/>
mov     r1, #0x80
<br/>
lsl     r1, r1, #0x0a
<br/>
add     r1, #0x1
<br/>
lsl     r1, r1, #0x7
<br/>
add     r1, #0x1
<br/>
lsl     r1, r1, #0x02
<br/>
<br/>
All 1S(8h) : 9*3 = 27
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
So the longer version is actually a teensy bit faster. You can even reduce that down to 6 instructions in this case:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
mov     r0, #0x40           @ r0 = 0x0040
<br/>
lsl     r1, r0, #17         @ r1 = 0x00800000
<br/>
add     r1, r0              @ r1 = 0x00800040
<br/>
lsl     r1, r1, #3          @ r1 = 0x04000200
<br/>
lsl     r0, r0, #8          @ r0 = 0x4000
<br/>
add     r0, #3              @ r0 = 0x4003
<br/>
<br/>
strh    r0, [r1, #4]</td> </tr></table><span class="postbody">
<br/>
However, <span style="font-weight: bold">none of that matters</span> because of what Dwedit said:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Dwedit wrote:</b></span></td> </tr> <tr> <td class="quote">You optimize the code that runs 18,000,00 times, and forget about optimizing the code that runs 7 times.
<br/>
</td> </tr></table><span class="postbody">This is not the kind of code you'd put in an inner loop, so it would have little influence of the overall speed. When choosing what to optimize, <span style="font-size: 7px; line-height: normal">*jedi handwave*</span> this is not the code you're looking for . 
<br/>
<br/>
Start with the LDR versions for constants; they're easier to write and debug. Transfer to the other version when you find it really matters. Or, of course, if you really, really want to.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170091 - Ruben - Sat Aug 29, 2009 7:39 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Cearn wrote:</b></span></td> </tr> <tr> <td class="quote">Start with the LDR versions for constants; they're easier to write and debug. Transfer to the other version when you find it really matters. Or, of course, if you really, really want to.</td> </tr></table><span class="postbody">
<br/>
Or if you're doing an optimization exercise and/or trying to learn how to code fast assembler as an exercise. ^^'</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170103 - Pate - Mon Aug 31, 2009 6:57 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Cearn wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
lsl     r1, r0, #17         @ r1 = 0x00800000
<br/>
add     r1, r0              @ r1 = 0x00800040
<br/>
</td> </tr></table><span class="postbody">
<br/>
</span></td> </tr></table><span class="postbody">
<br/>
<br/>
Just wondering, is it not allowed to use the same source register twice, like this:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
add r1, r0, r0, lsl #17
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I'm just learning ASM at the moment, so please excuse me if that is just not possible.
<br/>
<br/>
Pate<br/>_________________<br/><ul><li>Now working on DSx86 <a href="http://dsx86.patrickaalto.com" target="_blank">http://dsx86.patrickaalto.com</a>
<br/>
</li><li>Get LineWarsDS from <a href="http://linewars.patrickaalto.com" target="_blank">http://linewars.patrickaalto.com</a></li></ul></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170105 - Ruben - Mon Aug 31, 2009 7:44 am</h4>
    <div class="postbody"><span class="postbody">Yes, that is possible, which allows one to do stuff like this...
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">@ Aim: Build 0x11111111
<br/>
mov r0,             #0x11 @ 0x00000011
<br/>
orr r0, r0, r0, lsl #0x08 @ 0x00001111
<br/>
orr r0, r0, r0, lsl #0x10 @ 0x11111111</td> </tr></table><span class="postbody">
<br/>
<br/>
However, this only works for ARM: for THUMB code, you must do all the shifting manually like this
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">mov r0,     #0x11 @ 0x00000011
<br/>
lsl r1, r0, #0x08 @ 0x00001100
<br/>
orr r0, r1        @ 0x00001111
<br/>
lsl r1, r0, #0x10 @ 0x11110000
<br/>
orr r0, r1        @ 0x11111111</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170106 - Pate - Mon Aug 31, 2009 8:08 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Ruben wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
However, this only works for ARM: for THUMB code, you must do all the shifting manually like this
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Ah, okay, I missed the fact that it was thumb code. Sorry about that, and thanks for the info!
<br/>
<br/>
Pate<br/>_________________<br/><ul><li>Now working on DSx86 <a href="http://dsx86.patrickaalto.com" target="_blank">http://dsx86.patrickaalto.com</a>
<br/>
</li><li>Get LineWarsDS from <a href="http://linewars.patrickaalto.com" target="_blank">http://linewars.patrickaalto.com</a></li></ul></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#170639 - Ant6n - Fri Oct 09, 2009 5:06 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Cearn wrote:</b></span></td> </tr> <tr> <td class="quote">When choosing what to optimize, <span style="font-size: 7px; line-height: normal">*jedi handwave*</span> this is not the code you're looking for . 
<br/>
</td> </tr></table><span class="postbody">
<br/>
awesomness. :)</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
