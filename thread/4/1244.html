<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>VSync - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>Coding > VSync</h2>
<div id="posts">
<div class="post">
    <h4>#6139 - niltsair - Sun May 18, 2003 4:59 am</h4>
    <div class="postbody"><span class="postbody">Have been wondering about this one for some time.
<br/>
<br/>
with this line :
<br/>
<br/>
<span style="font-weight: bold">while((volatile u16)REG_VCOUNT != 160){} </span>
<br/>
<br/>
Does each evaluation of the predicate takes less than 1 scanline. I think so, but i wasn't sure and so was wondering if it could occurs that we miss line 160 and have to wait an entire screen refresh.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#6140 - wiz - Sun May 18, 2003 5:04 am</h4>
    <div class="postbody"><span class="postbody">Hi there,
<br/>
<br/>
perhaps this is a solution if the scanline is missed:
<br/>
<br/>
while((volatile u16)REG_VCOUNT <span style="font-weight: bold">&lt;</span> 160){}
<br/>
<br/>
Good luck</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#6142 - niltsair - Sun May 18, 2003 5:24 am</h4>
    <div class="postbody"><span class="postbody">I don't have this problem, it's just something i was wondering about.
<br/>
<br/>
There's a problem with the solution you submited. The condition would return False if it was on the last scanlines and we would thus restart on scanline 1 soon afterward, not giving us enough time to do all of our screen's operations. So it would have to be more like :
<br/>
<br/>
<span style="font-weight: bold">while((volatile u16)REG_VCOUNT &lt; 160 &amp;&amp; (volatile u16)REG_VCOUNT &gt; 165){} </span>
<br/>
<br/>
But i doubt it is needed, i think the condition can be evaluated under 1 scanline without problem, i just wanted confirmation.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#6143 - sgeos - Sun May 18, 2003 5:40 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">while((volatile u16)REG_VCOUNT != 160){} 
<br/>
while((volatile u16)REG_VCOUNT [b]&lt;[/b] 160){}</td> </tr></table><span class="postbody">
<br/>
<br/>
These do different things.  The first one stalls unless the scanline is 160.  The second stalls if the scanline is less than 160.
<br/>
<br/>
vblanks begins on scanline 160.  There are problems with each of these if you assume that they do something without understanding what they actually do.
<br/>
<br/>
If you do something that takes less than once scanline, it will be done multiple times with the first bit of code above.  It will be done many, many times with the second.
<br/>
<br/>
If you do something that takes less than the vblank, it will be done once with the first bit of code above.  It will be done multiple times with the second.
<br/>
<br/>
If you want something do be done only once a frame, interrupts are the way to go.  If you don't understand interrupts, then use the following:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">while((volatile u16)REG_VCOUNT == 160){} 
<br/>
while((volatile u16)REG_VCOUNT != 160){}</td> </tr></table><span class="postbody">
<br/>
<br/>
That stalls if the scanline is 160.  When the scanline is no longer 160, or if it was not 160 to begin with, then it will stall until the scanline is 160 again.  You can remove the first loop if you are sure everything will take more than one scanline to complete.
<br/>
<br/>
If the first loop is left in, and your routine happens to take up the whole vblank and vdraw and finishes when the scanline is 160 again, then it will stall for a whole frame because it thinks that your routine took a very short time to complete.
<br/>
<br/>
I hope that wasn't worded in a really confusing manner.
<br/>
<br/>
-Brendan</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#6152 - Link - Sun May 18, 2003 1:32 pm</h4>
    <div class="postbody"><span class="postbody">But, what is VSync? And vblanks?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#6156 - SmileyDude - Sun May 18, 2003 3:22 pm</h4>
    <div class="postbody"><span class="postbody">If all you are doing is waiting for the vblank, and the inside of the loop is empty, I think you're worrying too much about missing the vblank.  REG_VCOUNT changes at the start of the line, and unless your compiler is spitting out crap code, there is no way that you're going to miss a particular line (in this case, 160) when doing nothing else.
<br/>
<br/>
Most likely, you are probally reading REG_VCOUNT many times in a single line -- in fact, this method wastes CPU time, and more importantly on the GBA, the battery.  So, the possibility of missing when line 160 comes around is the least of your worries :)<br/>_________________<br/>dennis</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#6160 - Quirky - Sun May 18, 2003 5:28 pm</h4>
    <div class="postbody"><span class="postbody">And the best way is to use the bios interrupt for vblank - doing that fixed a lot of timing bugs I had due to "was it on the vbalnk/wasn't it?" problems.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#6163 - Link - Sun May 18, 2003 6:14 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Link wrote:</b></span></td> </tr> <tr> <td class="quote">But, what is VSync? And vblanks?</td> </tr></table><span class="postbody">
<br/>
<br/>
up</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#6170 - tepples - Sun May 18, 2003 8:54 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Link wrote:</b></span></td> </tr> <tr> <td class="quote">But, what is VSync? And vblanks?</td> </tr></table><span class="postbody">
<br/>
Those are explained in the various tutorials that the FAQ in the Beginners section links to, or even in a DirectDraw tutorial.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#6174 - Link - Sun May 18, 2003 10:33 pm</h4>
    <div class="postbody"><span class="postbody">never i see it!
<br/>
Anyway i use DirectX 8.1 and never seen it in SDK.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#6178 - tepples - Mon May 19, 2003 2:49 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Link wrote:</b></span></td> </tr> <tr> <td class="quote">never i see it!
<br/>
Anyway i use DirectX 8.1 and never seen it in SDK.</td> </tr></table><span class="postbody">
<br/>
Vblank, short for vertical blank, refers to the time between when the video hardware draws one frame and when it draws the next frame. The term "vsync" refers to waiting for the vertical blank before drawing something so that everything moves more smoothly.
<br/>
<br/>
I don't know about Direct3D 8, but DirectDraw 7 had <a class="postlink" href="http://msdn.microsoft.com/archive/default.asp?url=/archive/en-us/ddraw7/directdraw7/vbddref_9k6a.asp" target="_blank">DirectDraw7::WaitForVerticalBlank</a>.
<br/>
<br/>
To wait for vblank on GBA, you can spin on VCOUNT:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#define VCOUNT (*(volatile u16 *)0x04000006)  /* 0-159: draw; 160-227 vblank */
<br/>
void wait4vbl(void)
<br/>
{
<br/>
  while(VCOUNT != 160) ;
<br/>
  while(VCOUNT != 161) ;
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
Or you can save battery power by installing an ISR, or interrupt service routine, and then doing this:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void wait4vbl(void)
<br/>
{
<br/>
  asm volatile("mov r2, #0; swi 0x05" ::: "r0", "r1", "r2", "r3");
<br/>
}</td> </tr></table><span class="postbody">
<br/>
(There are tons of examples in gbadev.org's sources section that demonstrate how to write and use an ISR.)<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#6193 - Link - Mon May 19, 2003 11:43 am</h4>
    <div class="postbody"><span class="postbody">tnx tepples ;)</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
