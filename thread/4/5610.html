<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>signed long long integers? - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>Coding > signed long long integers?</h2>
<div id="posts">
<div class="post">
    <h4>#41595 - nicouiuc - Sat Apr 30, 2005 1:48 am</h4>
    <div class="postbody"><span class="postbody">Hi together,
<br/>
<br/>
I am still fighting with a control algorithm I set up on the GBA. I used fixed point math to set up an equation; however, that did not really work. So i put my filter into matlab, and the reason why its not working is HUGE integer numbers. I need a precision of about 30 bits, else the filter screws up. 
<br/>
<br/>
Now I was wondering if I can use signed long long integers on the GBA. TONC says I could use them; however, I did not really find much more about it on the internet. 
<br/>
<br/>
I tried it, and some problems occured:
<br/>
1) I have to declare them as "volatile", else my display crahes, or it sometimes shows up in funny colours. I dont really know what volatile means to variables. Are they else moved into an area that the display uses maybe?
<br/>
2) When I display the variables, it shows an "normal" integer which is overflowing. However, when I display the final result of the computation (which is right shifted again), it might make sense, im not sure though.
<br/>
<br/>
So my question is if I can use signed long long int at all, and if so, if theres anything i have to be beware of.
<br/>
<br/>
Thanks, 
<br/>
~Nico</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#41599 - sgeos - Sat Apr 30, 2005 3:49 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>nicouiuc wrote:</b></span></td> </tr> <tr> <td class="quote">I need a precision of about 30 bits, else the filter screws up.</td> </tr></table><span class="postbody">
<br/>
A regular signed long int has 32 bits precision.  1 bit sign, 31 bits integer.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>nicouiuc wrote:</b></span></td> </tr> <tr> <td class="quote">1) I have to declare them as "volatile", else my display crahes, or it sometimes shows up in funny colours. I dont really know what volatile means to variables. Are they else moved into an area that the display uses maybe?</td> </tr></table><span class="postbody">
<br/>
What are you trying to do?  Volatile is a way of telling the compiler "don't optimize this variable, something outside outside this code needs all values exactly as provided."
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>nicouiuc wrote:</b></span></td> </tr> <tr> <td class="quote">2) When I display the variables, it shows an "normal" integer which is overflowing. However, when I display the final result of the computation (which is right shifted again), it might make sense, im not sure though.</td> </tr></table><span class="postbody">
<br/>
Have you tried a signed long int?
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>nicouiuc wrote:</b></span></td> </tr> <tr> <td class="quote">So my question is if I can use signed long long int at all, and if so, if theres anything i have to be beware of.</td> </tr></table><span class="postbody">
<br/>
It was an extension of gcc last time I checked.  As such it may not be portable in theory.  The GBA does not have native support for 64-bit ints, so operations on a long long will be done in software (slow).  If you need 64-bit ints and you don't care about speed, long long is fine.  If you need speed (probably not), use assembler.
<br/>
<br/>
-Brendan</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#41601 - nicouiuc - Sat Apr 30, 2005 4:47 am</h4>
    <div class="postbody"><span class="postbody">Ok,
<br/>
<br/>
I do care about speed, as long as it doesnt take more than maybe 400microseconds.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
What are you trying to do? Volatile is a way of telling the compiler "don't optimize this variable, something outside outside this code needs all values exactly as provided." 
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I want to use them as regular changing variables, I just set them up as volatile because else my programm crashed several times or the text display was screwed up or coloured.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
Have you tried a signed long int? 
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
yeah I set up a signed long long int, and it is displaying an overflow shortly after it reaches 2 billion, e.g. it seems to be an overflowing signed int, not signed long long int.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
It was an extension of gcc last time I checked. As such it may not be portable in theory.
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Ok, Im not very familiar with this, sorry :-)  That means that I'd "just" have to update the gcc Im using in the DevKit?
<br/>
<br/>
And, btw, I was thinking this afternoon of "taking the calculations apart", e.g. use integers for the fractional part and different ones for the non-fractional.... but I first have to sit down and think about if and how that works.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#41612 - poslundc - Sat Apr 30, 2005 8:04 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>nicouiuc wrote:</b></span></td> </tr> <tr> <td class="quote">So my question is if I can use signed long long int at all, and if so, if theres anything i have to be beware of.</td> </tr></table><span class="postbody">
<br/>
<br/>
Long longs (they are signed by default) are somewhat wonky and are intended primarily for maintaining precision when multiplying two regular 32-bit integers, which is required frequently enough that the ARM processor has native support for it (and not other 64-bit operations).
<br/>
<br/>
The biggest caveat to be aware of is that while in other expressions, simpler data types will get promoted to more complicated ones (eg. if you add an integer and a float, it treats them both as floats), long longs will constantly get demoted to regular ints unless you thoroughly make sure all terms of an expression are either long long or cast to that type. It can become quite a hassle.
<br/>
<br/>
If your math application really requires numbers with greater precision than 32 bits, consider other numeric representations as well. Long longs are serviceable, but they really aren't cut out for mathematical manipulation.
<br/>
<br/>
And if you need 30 bits of precision... well, regular ints get you 31 bits of precision, so that's a whole extra bit of wiggle room you have before you should even have to consider 64-bit numbers.
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#41822 - nicouiuc - Mon May 02, 2005 5:05 am</h4>
    <div class="postbody"><span class="postbody">Dan,
<br/>
<br/>
thanks for your help. I need about 30 bits of precision, yes, else its not working. The problem is, i need the 30 bits for representing only the fractional part; I have to do some multiplications and that makes my registers blow up/overflow.
<br/>
<br/>
What do you mean by 
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
If your math application really requires numbers with greater precision than 32 bits, consider other numeric representations as well. Long longs are serviceable, but they really aren't cut out for mathematical manipulation. 
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
floats take too long, i tried it. What did you think of?
<br/>
<br/>
Thanks,
<br/>
~Nico</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#41868 - Miked0801 - Mon May 02, 2005 5:31 pm</h4>
    <div class="postbody"><span class="postbody">I've never had much luck with long longs.  If I needed more precision than 32-bits, I'd break the number up into 2 longs and do the math myself.  That said, 30 bits of precision?  And program crashing if not made volatile?  The second sounds like an array/memory over-write error.  The first makes me think your algorithm may need some tweaking.  30 bits of precision is a ton!  If the last few bits cause issue, part of your equation is way overly sensitive and probably could be improved.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#41869 - poslundc - Mon May 02, 2005 5:36 pm</h4>
    <div class="postbody"><span class="postbody">I would recommend analyzing your problem and determining at what points you really need more than 32 bits of precision. Without knowing more about the nature of the problem you are solving, I find it <span style="font-style: italic">really</span> surprising that you need to retain 32 bits just for the fractional part over the entire course of the problem - that's a level of precision of 1/(2^32) = 1 over more than <span style="font-style: italic">4 billion</span>.
<br/>
<br/>
That's the idea behind long longs - you switch to them when you need them for temporary calculations, before switching back to more conventional data types. If you want to use them for persistent calculations involving more than the basic four operators, it's buyer beware.
<br/>
<br/>
That said, you have a couple of options. You could create a struct/class for storing both an integral and fractional portion, and write functions/methods to temporarily represent them as a long long when needed for the mathematical calculations that require it. (You could use a union to have a single 64-bit variable contain both the long long representation and the integer/fraction representation.)
<br/>
<br/>
You could also have a look at <a class="postlink" href="http://www.php.net/manual/en/ref.bc.php" target="_blank">BCMath</a>, a library used by the PHP scripting language for arbitrary-precision calculations that represents numbers as strings. I'm certain that there are other similar arbitrary-precision libraries out there as well that you could look at porting over to the GBA.
<br/>
<br/>
But again, I really have to stress the preferability of examining your problem and seeing if you can squeeze it into 32 bits.
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#41875 - DekuTree64 - Mon May 02, 2005 6:06 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>nicouiuc wrote:</b></span></td> </tr> <tr> <td class="quote">I need about 30 bits of precision, yes, else its not working. The problem is, i need the 30 bits for representing only the fractional part; I have to do some multiplications and that makes my registers blow up/overflow.</td> </tr></table><span class="postbody">
<br/>
<br/>
If multiplication is the only thing that ever overflows, you can fix it with a small assembly function to use the ARM's 32x32=64 bit multiply. Try putting this in a .s file:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">.text
<br/>
.global mul30
<br/>
.align 2
<br/>
.arm
<br/>
mul30:
<br/>
smull r2, r3, r0, r1       @ r2:r3 = r0 * r1
<br/>
mov   r0, r2, lsr #30      @ Shift the 64 bit result...
<br/>
orr   r0, r0, r3, lsl #1   @ ...30 bits to the right
<br/>
bx    lr</td> </tr></table><span class="postbody">
<br/>
<br/>
And this in a .h/.c/.cpp file:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#ifdef __cplusplus
<br/>
extern "C" {
<br/>
#endif
<br/>
<br/>
extern s32 mul30(s32 m1, s32 m2);
<br/>
<br/>
#ifdef __cplusplus
<br/>
}
<br/>
#endif</td> </tr></table><span class="postbody">
<br/>
<br/>
Hope that helps.<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#41969 - nicouiuc - Tue May 03, 2005 9:20 pm</h4>
    <div class="postbody"><span class="postbody">Hi,
<br/>
<br/>
it was indeed only the multiplication that blew up the registers; with the help of DekuTree, I split up my vector multiplication into single 32bitx32bit multiplications, shifted those results and then added them all together. I also changed my sampling timer to a lower rate to be able to get rid off some precision. That did the job finally, and my robot started working with the filter   :-)
<br/>
<br/>
Thanks to all for the help; However, I occured a new problem/question, but this one should be much easier :-) I posted a new topic...</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
