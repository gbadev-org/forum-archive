<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>AAS, VBlank/HBlank/VCount interrupt, BIOS, etc. - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>Coding > AAS, VBlank/HBlank/VCount interrupt, BIOS, etc.</h2>
<div id="posts">
<div class="post">
    <h4>#24631 - DiscoStew - Sun Aug 08, 2004 5:53 am</h4>
    <div class="postbody"><span class="postbody">I've been working on interrupts and BIOS calls using the 2nd example of AAS, and I've got a few questions (pertaining to the emu no$gba).  The VBlank interrupt is set, in which when it hits, it will disable the HBlank interrupt. The VCount interrupt is set for scanline 227, in which that will enable the HBlank interrupt (so that the HBlank interrupt doesn't run through VBlank). At the beginning of my main loop, I have the BIOS call swi 0x05, and at the end the BIOS call swi 0x02, which is deactivated when the VCount interrupts. All code from the 2nd AAS example is still there for testing with. It all seems to work except when I uncomment the swi 0x05 call. With that uncommented, it seems nothing in the main loop is executed. When commented, it does work, but it seems to be looping through the main loop more than once per frame (about 163 times, there really isn't much there). What should I do about it? Plus, is it bad to enable the VCount interrupt at scanline 227? The HBlank interrupt sets off once before the time I'd like it to. At 228, the HBlank interrupt doesn't even go, because it is enabled in the VCount interrupt, which is probably not going through. Here is both the interrupt.c and AAS_Example.c code.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">interrupt.c
<br/>
#ifndef _gba_INTERRUPT_C
<br/>
#define _gba_INTERRUPT_C
<br/>
<br/>
#include "gba.h"
<br/>
#include "AAS.h"
<br/>
<br/>
extern u16 Somevalue;
<br/>
u16 value = 0;
<br/>
<br/>
<br/>
void VBlankInterruptHandler()
<br/>
{
<br/>
   REG_IME = 0;
<br/>
   //Disable the HBlank Interrupt
<br/>
   REG_IE &amp;= ~(1 &lt;&lt; 1);
<br/>
<br/>
   //AAS Processing of audio
<br/>
   AAS_DoWork();
<br/>
   *((u32*)0x03005000) = Somevalue;
<br/>
   Somevalue = 0;
<br/>
   REG_IME = 1;
<br/>
}
<br/>
<br/>
IN_IWRAM void HBlankInterruptHandler()
<br/>
{
<br/>
   //Just a simple shift of the background every scanline just to see if it works
<br/>
   REG_BG0HOFS = ((REG_VCOUNT &amp; 0x1) ? value : 0);
<br/>
   
<br/>
}
<br/>
<br/>
void VCountInterruptHandler()
<br/>
{
<br/>
   
<br/>
   REG_IME = 0;
<br/>
   ++value;
<br/>
   if(value == 16) value = 0;
<br/>
   //Enable the HBlank interrupt
<br/>
   REG_IE |= (1 &lt;&lt; 1);
<br/>
   REG_IME = 1;
<br/>
   
<br/>
}
<br/>
<br/>
void UnusedInterruptHandler()
<br/>
{
<br/>
}
<br/>
<br/>
void (*AAS_IntrTable[13])(void) =
<br/>
{
<br/>
   VBlankInterruptHandler,      // VBlank Interrupt
<br/>
   HBlankInterruptHandler,      // HBlank Interrupt
<br/>
   VCountInterruptHandler,      // V Counter Interrupt
<br/>
   UnusedInterruptHandler,      // Timer 0 Interrupt
<br/>
   UnusedInterruptHandler,      // Timer 2 Interrupt
<br/>
   UnusedInterruptHandler,      // Timer 3 Interrupt
<br/>
   UnusedInterruptHandler,      // Serial Communication Interrupt
<br/>
   UnusedInterruptHandler,      // DMA0 Interrupt
<br/>
   UnusedInterruptHandler,      // DMA1 Interrupt
<br/>
   UnusedInterruptHandler,      // DMA2 Interrupt
<br/>
   UnusedInterruptHandler,      // DMA3 Interrupt
<br/>
   UnusedInterruptHandler,      // Key Interrupt
<br/>
   UnusedInterruptHandler       // Cart Interrupt
<br/>
};
<br/>
<br/>
#endif
<br/>
</td> </tr></table><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">AAS_Example.c
<br/>
// AAS Example for projects with other CPU intensive interrupts
<br/>
// Notes:
<br/>
//  + Specially modified crt0.s file included with the example must be set to use __AAS_MultipleInterrupts
<br/>
//  + AAS_DoWork() must be called at least 50 times/sec. In this example, it's being called during VBlank.
<br/>
<br/>
#include "gba.h"
<br/>
#include "AAS.h"
<br/>
#include "AAS_Data.h"
<br/>
<br/>
u16 Somevalue = 0;
<br/>
<br/>
<br/>
const u16 BG_Palette[] = {
<br/>
   0x0000, 0x0000, 0x7FFF, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
<br/>
};
<br/>
<br/>
const u16 BG_Tiles[] = {
<br/>
   0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
<br/>
   0x1111, 0x1111, 0x1111, 0x1111, 0x1111, 0x1111, 0x1111, 0x1111, 0x1111, 0x1111, 0x1111, 0x1111, 0x1111, 0x1111, 0x1111, 0x1111,
<br/>
   0x2222, 0x2222, 0x2222, 0x2222, 0x2222, 0x2222, 0x2222, 0x2222, 0x2222, 0x2222, 0x2222, 0x2222, 0x2222, 0x2222, 0x2222, 0x2222,
<br/>
};
<br/>
<br/>
const u16 BG_Maps[] = {
<br/>
   0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002,
<br/>
   0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001,
<br/>
   0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002,
<br/>
   0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001,
<br/>
   0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002,
<br/>
   0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001,
<br/>
   0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002,
<br/>
   0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001,
<br/>
   0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002,
<br/>
   0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001,
<br/>
   0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002,
<br/>
   0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001,
<br/>
   0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002,
<br/>
   0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001,
<br/>
   0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002,
<br/>
   0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001,
<br/>
   0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002,
<br/>
   0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001,
<br/>
   0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002,
<br/>
   0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001,
<br/>
   0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002,
<br/>
   0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001,
<br/>
   0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002,
<br/>
   0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001,
<br/>
   0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002,
<br/>
   0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001,
<br/>
   0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002,
<br/>
   0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001,
<br/>
   0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002,
<br/>
   0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001,
<br/>
   0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002,
<br/>
   0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001, 0x0002, 0x0001,
<br/>
};
<br/>
<br/>
<br/>
<br/>
// Registers for GBA keys
<br/>
#define   REG_KEY (*(volatile AAS_u16 *)0x04000130)
<br/>
#define REG_KEY_A 0x0001
<br/>
#define REG_KEY_B 0x0002
<br/>
<br/>
void AgbMain() 
<br/>
{
<br/>
   int keys, keys_changed;
<br/>
   int prev_keys = 0;
<br/>
   
<br/>
   // Initialise AAS
<br/>
   AAS_SetConfig( AAS_CONFIG_MIX_32KHZ, AAS_CONFIG_CHANS_8, AAS_CONFIG_SPATIAL_STEREO, AAS_CONFIG_DYNAMIC_OFF );
<br/>
   
<br/>
   // Show AAS Logo (required for non-commercial projects)
<br/>
   AAS_ShowLogo();
<br/>
<br/>
   
<br/>
   // Start playing MOD
<br/>
   AAS_MOD_Play( AAS_DATA_MOD_CreamOfTheEarth );
<br/>
   
<br/>
   REG_DMA3SAD = (u32)(BG_Palette);
<br/>
   REG_DMA3DAD = (u32)(BGPaletteMem);
<br/>
   REG_DMA3CNT = (16) | DMA_16NOW;
<br/>
<br/>
   REG_DMA3SAD = (u32)(BG_Tiles);
<br/>
   REG_DMA3DAD = (u32)(CharBaseBlock(0));
<br/>
   REG_DMA3CNT = (48) | DMA_16NOW;
<br/>
<br/>
   REG_DMA3SAD = (u32)(BG_Maps);
<br/>
   REG_DMA3DAD = (u32)(ScreenBaseBlock(7));
<br/>
   REG_DMA3CNT = (32*32) | DMA_16NOW;
<br/>
<br/>
   REG_BG0CNT = (0 + (0 &lt;&lt; 1) + (0 &lt;&lt; 6) + (0 &lt;&lt; 7) + (7 &lt;&lt; 8) + (0 &lt;&lt; 13) + (0 &lt;&lt; 14));
<br/>
<br/>
   REG_BG0HOFS = 0;
<br/>
   REG_BG0VOFS = 0;
<br/>
<br/>
   REG_DISPCNT = (MODE_0 |BG0_ENABLE);
<br/>
<br/>
   // Enable vblank, hblank, and vcount interrupts
<br/>
   REG_DISPSTAT |= ((1 &lt;&lt; 3) | (1 &lt;&lt; 4) | (1 &lt;&lt; 5) | (227 &lt;&lt; 8));
<br/>
   
<br/>
   REG_IE |= (1 | (1 &lt;&lt; 2));
<br/>
   
<br/>
<br/>
   // Main loop
<br/>
   while(1)
<br/>
   {
<br/>
<br/>
      //Wait for VBlank. Other interrupts still occur, but no code beyond this point continues until the VBlank
<br/>
      BIOS_VSync();
<br/>
      ++Somevalue;
<br/>
      // Work out which keys have just been pressed
<br/>
      keys = ~REG_KEY;
<br/>
      keys_changed = keys ^ prev_keys;
<br/>
      prev_keys = keys;
<br/>
      
<br/>
      // Play looping ambulance sound effect out of left speaker if A button is pressed, stop when released
<br/>
      if ( keys_changed &amp; REG_KEY_A )
<br/>
      {
<br/>
         if ( keys &amp; REG_KEY_A )
<br/>
            AAS_SFX_Play( 0, 64, 16000, AAS_DATA_SFX_START_Ambulance, AAS_DATA_SFX_END_Ambulance, AAS_DATA_SFX_START_Ambulance );
<br/>
         else
<br/>
            AAS_SFX_Stop( 0 );
<br/>
      }
<br/>
      
<br/>
      // Play explosion sound effect out of right speaker if B button is pressed
<br/>
      if ( keys_changed &amp; keys &amp; REG_KEY_B )
<br/>
         AAS_SFX_Play( 1, 64, 8000, AAS_DATA_SFX_START_Boom, AAS_DATA_SFX_END_Boom, AAS_NULL );
<br/>
<br/>
      //CPU is halted until an interrupt occurs, should disable with the VCount interrupt. Some power saving
<br/>
      
<br/>
      BIOS_Halt();
<br/>
      
<br/>
   }
<br/>
   return;
<br/>
}
<br/>
</td> </tr></table><span class="postbody">Plus some swi ASM code taken from Cearn's examples</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">swi.s
<br/>
<br/>
<br/>
   .file "swi.s"
<br/>
   .text
<br/>
   .align 2
<br/>
   .code 16
<br/>
   
<br/>
   .global BIOS_Halt
<br/>
   .thumb_func
<br/>
BIOS_Halt:
<br/>
   swi 0x02
<br/>
   bx lr
<br/>
   
<br/>
   .global BIOS_VSync
<br/>
   .thumb_func
<br/>
BIOS_VSync:
<br/>
   swi   0x05
<br/>
   bx   lr
<br/>
   
<br/>
</td> </tr></table><span class="postbody">
<br/>
I checked Cearn's own examples of the swi VSync, and I think this code is very identical to that, but mine doesn't work. Can anyone see the problem? thx for any help given<br/>_________________<br/><span style="font-weight: bold">DS</span> - It's all about <span style="font-weight: bold">D</span>isco<span style="font-weight: bold">S</span>tew</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#24643 - dagamer34 - Sun Aug 08, 2004 3:19 pm</h4>
    <div class="postbody"><span class="postbody">I don't think the HBlank interrupt triggers during the VBlank period. All the pictures about the timing of that that I have seen show that HBlank only triggers the first 160 scanlines, the visible ones.<br/>_________________<br/>Little kids and Playstation 2's don't mix. :(</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#24645 - DiscoStew - Sun Aug 08, 2004 4:55 pm</h4>
    <div class="postbody"><span class="postbody">Actually, the HBlank interrupt does trigger during the VBlank. It is HDMA that doesn't. I checked through the forums about that, plus I made a test for checking which scanlines run the HBlank.
<br/>
<br/>
EDIT:
<br/>
I think I may have found the problem. After searching for VBlankIntrWait in the forums, I came across <a class="postlink" href="http://forum.gbadev.org/viewtopic.php?t=1544" target="_blank">this</a>, which as Quirky pointed out that the BIOS must be told that the VBlank had occurred, which can be done as such in the VBlank interrupt function...
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">(*(volatile u32*)0x03fffff8) = INT_VBLANK;</td> </tr></table><span class="postbody">
<br/>
Now my code works, with everything in the main loop only being called once per frame. I don't even need the BIOS_Halt function for this, since interrupts run if set and are not halted by my BIOS_VSync function.
<br/>
<br/>
I was wondering about whether I should set the VCount interrupt to 227, but after doing this and that, I found out something about the HBlank. At first I understood that for each scanline there is an HBlank period, and an HDraw period, in that order, but it seems to me that it is reversed, where the HBlank is after the HDraw for the same scanline. So I guess it is good for me to enable the VCount interrupt at scanline 227 because it sets me up for the next HDraw, which would be at scanline 0.<br/>_________________<br/><span style="font-weight: bold">DS</span> - It's all about <span style="font-weight: bold">D</span>isco<span style="font-weight: bold">S</span>tew</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
