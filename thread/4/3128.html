<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>messed up sprite coord - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>Coding > messed up sprite coord</h2>
<div id="posts">
<div class="post">
    <h4>#18485 - Darmstadium - Sat Mar 27, 2004 5:01 pm</h4>
    <div class="postbody"><span class="postbody">I am working on this collision detection thing. I have two sprites to test it. I'm storing the coords of my sprites in unsigned shorts and those variables are in a struct along with some other stuff for my collision detection. The x coord of my first sprite is completely wrong, though the y coord was correct. My other sprite always apears where I tell it to. As a despereate attempt to fix this, I changed the types of the variables that store the coords to unsigned chars. The second sprite was where I told it to be, but the first sprite appeared somewhere completely different from where I told it to be. I have absolutely no clue what the heck is going on. Here is my code:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#include "gba.h"
<br/>
#include "dispcnt.h"
<br/>
#include "keypad.h"
<br/>
#include "sprite.h"
<br/>
#include "dma.h"
<br/>
<br/>
#include "box.raw.c"
<br/>
#include "box.pal.c"
<br/>
<br/>
struct object
<br/>
{
<br/>
   u8 n;
<br/>
   u16 x, y;
<br/>
   u16 h, w;
<br/>
};
<br/>
<br/>
inline void WaitForVsync();
<br/>
inline void CopyOAM();
<br/>
void MoveBox();
<br/>
bool MoveOK(object *,s16,s16);
<br/>
<br/>
#define OBJSLEN   1
<br/>
object * objs[OBJSLEN];
<br/>
<br/>
object box;
<br/>
object evilBox;
<br/>
<br/>
inline void WaitForVsync()
<br/>
{
<br/>
   while((volatile u16)REG_VCOUNT != 160){}
<br/>
}
<br/>
<br/>
inline void CopyOAM()
<br/>
{
<br/>
   REG_DM3SAD = (u32)sprites;
<br/>
   REG_DM3DAD = (u32)OAM;
<br/>
   REG_DM3CNT = 256 | DMA_ENABLE | DMA_TIMEING_IMMEDIATE | DMA_32;
<br/>
}
<br/>
<br/>
bool MoveOK(object * client, s16 xmove, s16 ymove)
<br/>
{
<br/>
   u16 loop = 1;
<br/>
   for (loop = 0; loop &lt;= OBJSLEN; loop++)
<br/>
   {
<br/>
      if (objs[loop]-&gt;n != client-&gt;n)
<br/>
      {
<br/>
         if (client-&gt;x + xmove + client-&gt;w &lt; objs[loop]-&gt;x)
<br/>
            continue;
<br/>
         if (client-&gt;x + xmove &gt; objs[loop]-&gt;x + objs[loop]-&gt;w)
<br/>
            continue;
<br/>
         if (client-&gt;y + ymove + client-&gt;h &lt; objs[loop]-&gt;y)
<br/>
            continue;
<br/>
         if (client-&gt;y + ymove &gt; objs[loop]-&gt;y + objs[loop]-&gt;h)
<br/>
            continue;
<br/>
         
<br/>
         return false;
<br/>
      }
<br/>
   }
<br/>
   
<br/>
   return true;
<br/>
}
<br/>
<br/>
void MoveBox()
<br/>
{
<br/>
   if (!(*KEYS &amp; KEY_UP))
<br/>
   {
<br/>
      if (MoveOK(&amp;box, 0, -1))
<br/>
         box.y -= 1;
<br/>
   }
<br/>
   if (!(*KEYS &amp; KEY_DOWN))
<br/>
   {
<br/>
      if (MoveOK(&amp;box, 0, 1))
<br/>
         box.y += 1;
<br/>
   }
<br/>
   if (!(*KEYS &amp; KEY_LEFT))
<br/>
   {
<br/>
      if (MoveOK(&amp;box, -1, 0))
<br/>
         box.x -= 1;
<br/>
   }
<br/>
   if (!(*KEYS &amp; KEY_RIGHT))
<br/>
   {
<br/>
      if (MoveOK(&amp;box, 1, 0))
<br/>
         box.x += 1;
<br/>
   }
<br/>
}
<br/>
<br/>
int main()
<br/>
{
<br/>
   u16 loop;
<br/>
   
<br/>
   for(loop = 0; loop &lt; 128; loop++)
<br/>
   {
<br/>
      sprites[loop].attribute0 = 160;
<br/>
      sprites[loop].attribute1 = 240;
<br/>
   }
<br/>
   
<br/>
   REG_DISPCNT = MODE_1 | OBJ_ENABLE | OBJ_MAP_1D;
<br/>
   
<br/>
   REG_DM3SAD = (u32)box_Palette;
<br/>
   REG_DM3DAD = (u32)OBJPaletteMem;
<br/>
   REG_DM3CNT = 64 | DMA_ENABLE | DMA_TIMEING_IMMEDIATE | DMA_32;
<br/>
   
<br/>
   REG_DM3SAD = (u32)box_Bitmap;
<br/>
   REG_DM3DAD = (u32)&amp;OAMData[0];
<br/>
   REG_DM3CNT = 64 | DMA_ENABLE | DMA_TIMEING_IMMEDIATE | DMA_32;
<br/>
   
<br/>
   objs[0] = &amp;box;
<br/>
   box.n = 0;
<br/>
   box.x = 20;
<br/>
   box.y = 20;
<br/>
   box.h = 16;
<br/>
   box.w = 16;
<br/>
   sprites[0].attribute0 = COLOR_256 | SQUARE | box.y;
<br/>
   sprites[0].attribute1 = SIZE_16 | box.x;
<br/>
   sprites[0].attribute2 = 0;
<br/>
   
<br/>
   objs[1] = &amp;evilBox;
<br/>
   evilBox.n = 1;
<br/>
   evilBox.x = 120;
<br/>
   evilBox.y = 60;
<br/>
   evilBox.h = 16;
<br/>
   evilBox.w = 16;
<br/>
   sprites[1].attribute0 = COLOR_256 | SQUARE | evilBox.y;
<br/>
   sprites[1].attribute1 = SIZE_16 | evilBox.x;
<br/>
   sprites[1].attribute2 = 0;
<br/>
   
<br/>
   while (1)
<br/>
   {
<br/>
      MoveBox();
<br/>
<br/>
      sprites[0].attribute0 = COLOR_256 | SQUARE | box.y;
<br/>
      sprites[0].attribute1 = SIZE_16 | box.x;
<br/>
      
<br/>
      sprites[1].attribute0 = COLOR_256 | SQUARE | evilBox.y;
<br/>
      sprites[1].attribute1 = SIZE_16 | evilBox.x;
<br/>
      
<br/>
      WaitForVsync();
<br/>
      CopyOAM();
<br/>
   }
<br/>
   return 0;
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Thanks in advance</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#18486 - Miked0801 - Sat Mar 27, 2004 5:22 pm</h4>
    <div class="postbody"><span class="postbody">objs[1] = &amp;evilBox; 
<br/>
<br/>
reads off the end of your pointer list - it is only 1 in length - same bug as in the previous post.  Chaos thus ensues</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#18488 - Darmstadium - Sat Mar 27, 2004 5:42 pm</h4>
    <div class="postbody"><span class="postbody">You could not possibly comprehend how grateful I am. Seriously!!!!!!!!!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#18494 - sajiimori - Sat Mar 27, 2004 7:40 pm</h4>
    <div class="postbody"><span class="postbody">The previous bug is still there, too.  Your loop in MoveOK tests for loop &lt;= OBJSLEN, so what is the last index that's accessed?
<br/>
<br/>
Also, about your scheme of having seperate variables for each object, then having an array of pointers to all of them:  it's clever, but not very memory efficient, and it's somewhat slower during collision detection due to the extra pointer indirection.  How about this?
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#define OBJSLEN   2
<br/>
object objs[OBJSLEN];
<br/>
<br/>
#define box     objs[0]
<br/>
#define evilBox objs[1]
<br/>
</td> </tr></table><span class="postbody">
<br/>
Now you can access box and evilBox just like normal, you don't have an extra initialization step, and accessing the objects using the array is faster.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#18495 - Lupin - Sat Mar 27, 2004 9:43 pm</h4>
    <div class="postbody"><span class="postbody">do you check if the x/y value is out of bounds? I think it is 9 bits for X and 8 bits for Y but i am not sure, you should check for the value anyway...<br/>_________________<br/><a class="postlink" href="http://pokeme.shizzle.it/" target="_blank">Team Pokeme</a>
<br/>
<a class="postlink" href="http://lupin.shizzle.it/" target="_blank">My blog and PM ASM tutorials</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#18499 - Darmstadium - Sun Mar 28, 2004 1:18 am</h4>
    <div class="postbody"><span class="postbody">Thanks a lot for you help guys!</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
