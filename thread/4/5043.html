<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>External data alignment issues - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>Coding > External data alignment issues</h2>
<div id="posts">
<div class="post">
    <h4>#36069 - KonVex - Mon Feb 14, 2005 8:49 pm</h4>
    <div class="postbody"><span class="postbody">I know that this was brought up before, but haven't found a working solution yet.
<br/>
<br/>
I want to link external data into my rom (using the objcopy method).
<br/>
The problem is that the data isn't 32 Bit aligned, and thus causing all reading operations to return incorrect data.
<br/>
Is there any way to stop that behaviour?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#36078 - tepples - Mon Feb 14, 2005 9:57 pm</h4>
    <div class="postbody"><span class="postbody">Ever tried the GBFS method or the bin2s method? Both of those, mentioned in the FAQ in the Beginners section, work for me.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#36082 - KonVex - Mon Feb 14, 2005 10:59 pm</h4>
    <div class="postbody"><span class="postbody">Well, I can't use GBFS because I need this info to implement my own FS. :)
<br/>
I want to include the filesystem image, but the gba refuses to load unaligned data. Appending the imagefile to the rom isn't enough, because that way I wouldn't have a symbol to access my data.
<br/>
<br/>
I haven't found bin2s in the faq, but b2x is mentioned in the devrs gba faq (that should be pretty similar). I guess I will try that next.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#36100 - sajiimori - Tue Feb 15, 2005 1:37 am</h4>
    <div class="postbody"><span class="postbody">objcopy always worked for me. :/  Is it possible that your alignment being thrown off by something inside the objects, rather than by the alignment of the objects in the .elf?  (nm can tell you that)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#36102 - KonVex - Tue Feb 15, 2005 1:58 am</h4>
    <div class="postbody"><span class="postbody">Here are the symbols generated for my external data:
<br/>
<br/>
0200eaad R _binary_ROM_DATA_bin_end
<br/>
0000c580 A _binary_ROM_DATA_bin_size
<br/>
<span style="font-weight: bold">0200252d R _binary_ROM_DATA_bin_start</span>
<br/>
<br/>
This was compiled using devkitARM R11 as a multiboot rom (but it wasn't working with R8 either).</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#36103 - Miked0801 - Tue Feb 15, 2005 2:06 am</h4>
    <div class="postbody"><span class="postbody">Pad your data with 0s to 16/32 bit alignment.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#36115 - sajiimori - Tue Feb 15, 2005 3:58 am</h4>
    <div class="postbody"><span class="postbody">Isn't there some way to tell the linker to align the start of each .o file?
<br/>
<br/>
Maybe DevKitAdvance's lnkscript did that for me, because I'm sure my data wasn't coincidentally aligned all the time, and I don't recall having to do it myself.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#36116 - tepples - Tue Feb 15, 2005 4:01 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Miked0801 wrote:</b></span></td> </tr> <tr> <td class="quote">Pad your data with 0s to 16/32 bit alignment.</td> </tr></table><span class="postbody">
<br/>
"Your data" itself is padded to a multiple of 32 bits in length (size: 0xc580), but <span style="font-style: italic">the program before it</span> isn't padded to anything bigger than 8-bit. The linker is supposed to pad the program before the data block with 0's to proper alignment, based on an attribute of the data block (called __attribute((aligned(4))) in C or .balign 4 in assembly), but <a class="postlink" href="http://www.gnu.org/software/binutils/manual/html_chapter/binutils_3.html" target="_blank">GNU objcopy's man page</a> lists no way to specify such an attribute.
<br/>
<br/>
I just use GBFS or bin2s, which handles alignment cleanly. Both are available in the <a class="postlink" href="http://www.pineight.com/gba/#gbfs" target="_blank">GBFS distribution at my site</a>.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#36164 - KonVex - Tue Feb 15, 2005 3:33 pm</h4>
    <div class="postbody"><span class="postbody">I finally tried bin2s and it works pretty well, the only drawback is that it takes longer to compile now.
<br/>
Anyway your quick help is really appreciated :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#36166 - wintermute - Tue Feb 15, 2005 4:08 pm</h4>
    <div class="postbody"><span class="postbody">generate a mapfile and see what's causing the misalignment.  The problem is with something before R _binary_ROM_DATA_bin_start.
<br/>
<br/>
I've been looking for a method to automatically align objcopied data with little success other than the alignbin shellscript found in the devkitARM bin directory.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#36168 - KonVex - Tue Feb 15, 2005 5:12 pm</h4>
    <div class="postbody"><span class="postbody">I just found something that might be of interest.
<br/>
If the linked file is called *.all.rodata.o (as suggested in the devrs faq) it is put in rom-space and the start-address is unaligned.
<br/>
When the all.rodata is left away the data is put into IWRAM, but it is aligned.
<br/>
<br/>
Here is a small snippet of the mapfile (with all.rodata and without multiboot):
<br/>
.rodata         0x0800238c     0xc73c
<br/>
 *(.rodata)
<br/>
 .rodata        0x0800238c       0x6c C:\DOKUME~1\KonVex\LOKALE~1\Temp/ccuAaaaa.o
<br/>
 .rodata        0x080023f8        0xc C:\DOKUME~1\KonVex\LOKALE~1\Temp/ccENaaaa.o
<br/>
 .rodata        0x08002404       0x40 C:\DOKUME~1\KonVex\LOKALE~1\Temp/ccO0aaaa.o
<br/>
 .rodata        0x08002444      0x101 C:/devkitARM/bin/../lib/gcc/arm-elf/3.4.3/../../../../arm-elf/lib/interwork\libc.a(ctype_.o)
<br/>
                0x08002444                _ctype_
<br/>
 *all.rodata*(*)
<br/>
 .data          0x08002545     0xc580 ROM_DATA.all.rodata.o
<br/>
                0x0800eac5                _binary_ROM_DATA_bin_end
<br/>
                0x08002545                _binary_ROM_DATA_bin_start
<br/>
 *(.roda)
<br/>
 *(.rodata.*)
<br/>
 *(.gnu.linkonce.r*)
<br/>
                0x0800eac8                . = ALIGN (0x4)
<br/>
 *fill*         0x0800eac5        0x3 ff</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#36200 - wintermute - Wed Feb 16, 2005 12:17 am</h4>
    <div class="postbody"><span class="postbody">have a look at the PCXView example in sourceforge
<br/>
<br/>
<a href="http://cvs.sourceforge.net/viewcvs.py/devkitpro/examples/gba/PCXView/" target="_blank">http://cvs.sourceforge.net/viewcvs.py/devkitpro/examples/gba/PCXView/</a>
<br/>
<br/>
You're putting the data into a section *after* the const data from the libraries and unfortunately including a constant from libc  which is 8 bits. Objcopy puts binaries into the .data section by default. The bin2o macro from my makefiles places it in .rodata</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
