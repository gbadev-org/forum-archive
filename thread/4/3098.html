<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>HBlank Interrupt - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>Coding > HBlank Interrupt</h2>
<div id="posts">
<div class="post">
    <h4>#18180 - bomberman - Mon Mar 22, 2004 10:22 am</h4>
    <div class="postbody"><span class="postbody">Hello,
<br/>
<br/>
after solving my problems with graphic modes switch during a HBlank (see end of topic <a class="postlink" href="http://forum.gbadev.org/viewtopic.php?t=1303&amp;start=0" target="_blank">http://forum.gbadev.org/viewtopic.php?t=1303&amp;start=0</a>), I noticed a strange thing happening.
<br/>
<br/>
During splash screen and options menu screen, I do not need the interrupt to be triggered, so I disable this specific interruption, and only when I enter in my game loop, I enable it. And once out of ten approximately, just when I do this, my game resets on VBA and freezes on hardware. It seems I have "fixed" it by first waiting the beginning of the VBlank to enable/disable the HBlank interrupt. At least, I can not reproduce it any more... Is it "forbidden" to do it at any time ? Is there a reason to wait the VBlank interval ? I do not like bugs supposedly fixed because they don't happen any more :O)
<br/>
<br/>
Thanks !</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#18200 - DekuTree64 - Mon Mar 22, 2004 4:37 pm</h4>
    <div class="postbody"><span class="postbody">Are you only disabling it in IE, and not DISPSTAT? I haven't confirmed this personally, but I've heard that will sort of queue interrupts and trigger them as soon as you enable them again in IE. I don't know how that could cause a reset though, unless you haven't set the HBL function pointer yet, and just branch into nowhere when it's triggered.
<br/>
But actually that doesn't make sense of why it would work properly during VBL, so I'm nt sure what the problem is. 
<br/>
If you're not disabling it in DISPSTAT already, do so and see what happens.<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#18204 - bomberman - Mon Mar 22, 2004 4:58 pm</h4>
    <div class="postbody"><span class="postbody">I always enable/disable the pair IE/DISPSTAT.
<br/>
<br/>
Having spoken with a pro, he told me that when modifying IE, IME should first be disabled. Then you should modify your IE (and other registers like DISPSTAT) and then reactivate your IME. Waiting to come back home tonight to test this without my VBlank wait.
<br/>
In these conditions, it does not explain why it worked during VBL, you're right. On the other hand, I only could not reproduce it during VBL, it does not guarantee it worked fully. Tried it 50 consecutives times and did not crash, whereas before it would have crashed a few times.
<br/>
Last thing, the reset was observed only in the emulator. The hardware just froze and I had to switch off and on.
<br/>
<br/>
Well, will let you know tomorrow the results of my tries tonight !
<br/>
<br/>
Thanks !</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#18207 - poslundc - Mon Mar 22, 2004 5:05 pm</h4>
    <div class="postbody"><span class="postbody">I don't think it matters if you enable DISPSTAT before IE or not, but you should disable DISPSTAT before IE in order to avoid queueing up an old interrupt that will launch immediately when next you enable IE.
<br/>
<br/>
Other than that, there could be plenty of potential mishaps occurring in code... interrupts are easy to get working, but tricky things to manage, unfortunately.
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#18217 - Miked0801 - Mon Mar 22, 2004 6:46 pm</h4>
    <div class="postbody"><span class="postbody">Also a good idea to clear specific IF fields when playing with IE.  Nothing like running 5 interrupts right on top of each other to cause unusual behavior.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#18242 - bomberman - Tue Mar 23, 2004 12:47 am</h4>
    <div class="postbody"><span class="postbody">Well, here are the results of my experiments !
<br/>
<br/>
First of all, previously, the REG_IME was always on, and when activating HBlank interrupts, I was doing in this order:
<br/>
1 - Modify IE
<br/>
2 - Install the appropriate handler
<br/>
3 - Modify DISPSTAT
<br/>
<br/>
So it would never jump in a non correctly setup function pointer. On the other hand, it's not only something which only happens on software (contrary to my previous problems), so we could suspect a software problem... Weird...
<br/>
<br/>
Anyway, after having listen to the advice I was given (disable REG_IME before any modifications of interrupts), it works fine, at any time. Not necessary to wait for the next VBlank. Or at least, I was not able to reproduce it...
<br/>
<br/>
So if you play with interrupts, try to remember this: DISABLE THE REG_IME :O)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#18245 - tepples - Tue Mar 23, 2004 1:06 am</h4>
    <div class="postbody"><span class="postbody">If you get a problem on the emulator that doesn't show up on hardware (other than cycle inaccuracy or lack of serial support), then get a SourceForge.net account, make a minimal test case, and post it to the VisualBoyAdvance bug report site. Making the minimal test case will help you understand and explain the difference of behavior so that Forgotten, the maintainer of VBA, can better understand the behavior of the GBA hardware.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
