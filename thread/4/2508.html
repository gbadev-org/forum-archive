<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>problem with day-2 code from www.thepernproject.com - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>Coding > problem with day-2 code from www.thepernproject.com</h2>
<div id="posts">
<div class="post">
    <h4>#13618 - GermanGBA - Thu Dec 18, 2003 3:57 pm</h4>
    <div class="postbody"><span class="postbody">this is my code:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#include &lt;gba.h&gt;
<br/>
#include &lt;screenmode.h&gt;
<br/>
#include &lt;sprite.h&gt;
<br/>
#include "spritedemo.h"
<br/>
#define CharMem (u16*)0x6010000
<br/>
<br/>
u16* Screen = (u16*)VideoBuffer;
<br/>
u16* paletteMem=(u16*)BGPaletteMem;
<br/>
<br/>
void PlotPixel(int x,int y, unsigned short int c){Screen[(y)*120+(x)]=(c);}
<br/>
<br/>
int main(void)
<br/>
{
<br/>
    SetMode(OBJ_MAP_2D | MODE_3 | OBJ_ENABLE);
<br/>
    
<br/>
    u8 spritedemoAttributes=0;
<br/>
    s16 x=10, y=10;
<br/>
    u16 char_number=0;
<br/>
    
<br/>
    sprites[spritedemoAttributes].attribute0=COLOR_256 + SQUARE + y;
<br/>
    sprites[spritedemoAttributes].attribute1=SIZE_64 + x;
<br/>
    sprites[spritedemoAttributes].attribute2=char_number;
<br/>
    
<br/>
    int xloop=0;
<br/>
    int yloop=0;
<br/>
    int index=0;
<br/>
    
<br/>
    for(yloop=0;yloop&lt;8;yloop++)
<br/>
    {
<br/>
        for(xloop=0;xloop&lt;256;xloop++)
<br/>
        {
<br/>
            CharMem[xloop+yloop*512]=spritedemoData[index];
<br/>
            index++;
<br/>
        }
<br/>
    }
<br/>
    return(0);
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
and this is the problem:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">c:/programs/dev-cpp/projects/gba-stuff/sprites/main.cpp:32: invalid types 'int[int]' for array subscript</td> </tr></table><span class="postbody">
<br/>
<br/>
what does it mean?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#13619 - poslundc - Thu Dec 18, 2003 4:07 pm</h4>
    <div class="postbody"><span class="postbody">You are attempting to index into an array that you haven't declared yet.
<br/>
<br/>
Are you new to C? You should probably get more experience with basic C programming before you dive right into GBA programming.
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#13620 - GermanGBA - Thu Dec 18, 2003 4:10 pm</h4>
    <div class="postbody"><span class="postbody">i'm not really new to c...
<br/>
i only took the code out of the tutorial and tryed to compile it.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#13622 - GermanGBA - Thu Dec 18, 2003 4:23 pm</h4>
    <div class="postbody"><span class="postbody">soory i recognized my mistake...
<br/>
<br/>
but why the hell doesn't it draw my sprite???</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#13632 - poslundc - Thu Dec 18, 2003 9:27 pm</h4>
    <div class="postbody"><span class="postbody">It draws your sprite (probably draws it, anyway), but then resets because you reach the end of the main() function. A GBA program should (generally speaking) never reach the end of the main function.
<br/>
<br/>
You need to start over from the beginning of the tutorials and work your way through them. They explain all of this; if you are just going to cut and paste code out of them and complain that they don't work then you will not get very far.
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#13634 - AcidGame - Thu Dec 18, 2003 10:04 pm</h4>
    <div class="postbody"><span class="postbody">that is completely true. The main function is the first command called when a C program is run, and when it reaches the end, it will usually cut off. Try rooting off to a refresh ( the GBA runs on a screen refresh ( so i've heard ) and needs to be updated before anything changes on the screen ) Like i said, i've heard this, but i dont know. :X</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#13639 - NoMis - Thu Dec 18, 2003 11:27 pm</h4>
    <div class="postbody"><span class="postbody">there are other things missing. 
<br/>
<br/>
1. you schould have an endless loop in the mainfunction.
<br/>
2. i guess sprites is a shadow copy of the oam, so you need to update it during the vblank. 
<br/>
<br/>
the pern project describes these things prety good so if you completly read it you shouldn't have problems to get this stuff running.
<br/>
<br/>
NoMis</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#13644 - sgeos - Fri Dec 19, 2003 4:17 am</h4>
    <div class="postbody"><span class="postbody">Add these three lines right before return 0.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">while (1) {
<br/>
   /* Endless Loop */
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
You could add this line instead, but it is harder to understand at a glance:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">while (1);  /* Endless Loop */</td> </tr></table><span class="postbody">
<br/>
<br/>
Edit:  This may not be enough to get the display to do anything.  Please follow the advice of the other friendly posters.
<br/>
<br/>
-Brendan</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#13681 - dagamer34 - Sat Dec 20, 2003 4:58 pm</h4>
    <div class="postbody"><span class="postbody">OAMMem can only be changed during a VBlank and HBlank(its locked at any other time.)
<br/>
<br/>
1) Like other people have said, make a while loop at the end.
<br/>
<br/>
2) Big problem I see here. Your sprite array may point to OAMMem, BUT it does not change it. Look at the Pern Project code again. It is always best to download it off their site, the on-line tutorials only give snippets of code.
<br/>
<br/>
It would better help if you showed all your code, i don't see where sprites is declared.
<br/>
<br/>
add this to your code:
<br/>
<br/>
[code]
<br/>
// Before main
<br/>
void CopyOAM ();
<br/>
void WaitSync ();
<br/>
<br/>
// your main function
<br/>
int main ()
<br/>
{
<br/>
<br/>
    // Initialize your data, just like you have it,
<br/>
<br/>
<br/>
   // Now after all the copying but before return 0, put this
<br/>
   while (1)
<br/>
{
<br/>
     WaitVSync ();
<br/>
     CopyOAM ();
<br/>
}
<br/>
<br/>
return 0;
<br/>
}
<br/>
<br/>
// Copys the data that controls the sprite to OAM memory
<br/>
void CopyOAM ()
<br/>
{
<br/>
      u16 loop; 
<br/>
      u16* temp;
<br/>
      temp = (u16*)sprites;
<br/>
      for (loop = 0; loop &lt; 128 * 4; loop++)
<br/>
      {
<br/>
           OAMMem [loop] = sprites [loop];
<br/>
      }
<br/>
}
<br/>
<br/>
// We can only alter OAM memory during a VSync(scanline = 160) so wait for it.
<br/>
void WaitVSync ()
<br/>
{
<br/>
      while ((volatile u16)REG_VCOUNT != 160) {}
<br/>
}<br/>_________________<br/>Little kids and Playstation 2's don't mix. :(</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#13688 - GermanGBA - Sat Dec 20, 2003 6:28 pm</h4>
    <div class="postbody"><span class="postbody">thx for the advices, but now it displays a black line in the middle of the picture..
<br/>
<br/>
my current code looks like this:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#include &lt;gba.h&gt;
<br/>
#include &lt;screenmode.h&gt;
<br/>
#include &lt;sprite.h&gt;
<br/>
<br/>
#include "sprite1.h"
<br/>
#include "start.h"
<br/>
<br/>
u16* videoBuffer=(u16*)VideoBuffer;
<br/>
u16* paletteMem=(u16*)BGPaletteMem;
<br/>
u16* CharMem=(u16*)OAMdata;
<br/>
u16* ObjPaletteMem=(u16*)OBJPaletteMem;
<br/>
<br/>
void PlotPixel(int x,int y, unsigned short int c) {videoBuffer[(y) *120 + (x)] = (c);}
<br/>
void CopyOAM(void);
<br/>
void WaitForVsync(void);
<br/>
void InitializeSprites(void);
<br/>
<br/>
int main(void)
<br/>
{
<br/>
    
<br/>
    u16 x=10;
<br/>
    u16 y=10;
<br/>
    u16 char_number=0;
<br/>
    
<br/>
    int index=0;
<br/>
    int loop;
<br/>
    SetMode(MODE_4 + OBJ_MAP_2D + OBJ_ENABLE + BG2_ENABLE);
<br/>
    
<br/>
    for(loop=0;loop&lt;256;loop++)
<br/>
        paletteMem[loop]=startPalette[loop];
<br/>
<br/>
    for(loop=0;loop&lt;256;loop++)
<br/>
        ObjPaletteMem[loop]=sprite1Palette[loop];
<br/>
<br/>
    for(x=0;x&lt;120;x++)
<br/>
        for(y=0;y&lt;160;y++)
<br/>
            PlotPixel(x, y, startData[y*120+x]);
<br/>
    
<br/>
    InitializeSprites();
<br/>
    
<br/>
    sprites[0].attribute0=COLOR_256 + SQUARE + y;
<br/>
    sprites[0].attribute1=SIZE_64 + x;
<br/>
    sprites[0].attribute2=char_number+512;
<br/>
<br/>
    for(index=0;index&lt;256*8;index++)
<br/>
        CharMem[index+(512*16)] = sprite1Data[index];
<br/>
        
<br/>
    while(1)
<br/>
    {
<br/>
        WaitForVsync();
<br/>
        CopyOAM();
<br/>
    }
<br/>
}
<br/>
<br/>
void WaitForVsync(void)
<br/>
{
<br/>
   while((volatile u16)REG_VCOUNT != 160){}   
<br/>
}
<br/>
<br/>
void CopyOAM(void)
<br/>
{
<br/>
   u16 loop;
<br/>
   u16* temp;
<br/>
   temp = (u16*)sprites;
<br/>
   for(loop = 0; loop &lt; 128*4; loop++)
<br/>
   {
<br/>
      OAM[loop] = temp[loop];
<br/>
   }
<br/>
}
<br/>
<br/>
void InitializeSprites(void)
<br/>
{
<br/>
   int loop;
<br/>
   for(loop = 0; loop &lt; 128; loop++)
<br/>
   {
<br/>
      sprites[loop].attribute0 = 160;
<br/>
      sprites[loop].attribute1 = 240;
<br/>
   }
<br/>
}
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#13691 - sajiimori - Sat Dec 20, 2003 7:29 pm</h4>
    <div class="postbody"><span class="postbody">For the most part, there's no way to tell what's happening here because many of your symbols (OAMdata, sprites, sprite1Data, etc) are not defined in the code you posted.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
    u16 x=10; 
<br/>
    u16 y=10; 
<br/>
<br/>
    ...
<br/>
<br/>
    for(x=0;x&lt;120;x++) 
<br/>
        for(y=0;y&lt;160;y++) 
<br/>
            PlotPixel(x, y, startData[y*120+x]); 
<br/>
<br/>
    ...
<br/>
<br/>
    sprites[0].attribute0=COLOR_256 + SQUARE + y; 
<br/>
    sprites[0].attribute1=SIZE_64 + x; 
<br/>
</td> </tr></table><span class="postbody">
<br/>
I don't suppose that will do what you were expecting.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
   while((volatile u16)REG_VCOUNT != 160){}    
<br/>
</td> </tr></table><span class="postbody">
<br/>
What is your definition of REG_VCOUNT?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#13696 - mtg101 - Sat Dec 20, 2003 9:38 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
    for(x=0;x&lt;120;x++) 
<br/>
        for(y=0;y&lt;160;y++) 
<br/>
            PlotPixel(x, y, startData[y*120+x]); 
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
So what's going on here?  Are you trying to draw a background image to the screen before displaying your sprite? It would help if startData had a better name (like gBackgroundImage), and was documented in its first use to explain where it's come from.
<br/>
<br/>
Anyway let's concentrate on getting the sprite to display before we go drawing funky background images.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
    InitializeSprites(); 
<br/>
<br/>
    sprites[0].attribute0=COLOR_256 + SQUARE + y; 
<br/>
    sprites[0].attribute1=SIZE_64 + x; 
<br/>
    sprites[0].attribute2=char_number+512; 
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
When you do "sprites[0].attribute0=COLOR_256 + SQUARE + y;", what is the value of the 'y' variable? It'll be 160, because 'y' was used as a loop variable during the PlotPixel() loops above. Thus your sprite will be drawn off the bottom of the screen.
<br/>
<br/>
<br/>
Cheers
<br/>
Russell<br/>_________________<br/>---
<br/>
Speaker for the Dead</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#13698 - dagamer34 - Sat Dec 20, 2003 9:54 pm</h4>
    <div class="postbody"><span class="postbody">Use VBA and see if the data is correctly being loaded.
<br/>
<br/>
One other thing is that most people (well, at least me) don't load sprites in 2D mode because it is too much of a hassle. 1D is simpler for loading and when you decide to creat animations.
<br/>
<br/>
And if you are using the Pern Project headers, VideoBuffer, BGPaletteMem, OBJPaletteMem, and OAMData are already defined as pointers to registers. It isn't very usefil to make a pointer to a pointer in this case.
<br/>
<br/>
Thats all i can say for now.<br/>_________________<br/>Little kids and Playstation 2's don't mix. :(</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#13763 - GermanGBA - Mon Dec 22, 2003 3:38 pm</h4>
    <div class="postbody"><span class="postbody">but if i do not define a pointer to the defines of the headers, i will get the error described above</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
