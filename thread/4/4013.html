<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>I'm really failing with the GBA ;.; - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>Coding > I'm really failing with the GBA ;.;</h2>
<div id="posts">
<div class="post">
    <h4>#25975 - LOst? - Thu Sep 02, 2004 5:07 am</h4>
    <div class="postbody"><span class="postbody">Everything has to do with the way you set up the game loop, and the way you use interrupts. I have no control over what's being executed first.
<br/>
<br/>
An example would be my biggest dream: To have a scanline based scrolling engine.
<br/>
<br/>
At first I used multiple Interrupts with that CRT.S, and it didn't really give that much CPU time at all for the effects i wanted. I got flickering scanlines and stuff. I'm still very unhappy with the way you set up interrupts. But I have no other choices than to go along with that CRT.S because I don't want to learn that assembler, just to get a result worse than the current one.
<br/>
<br/>
With over 48 hours of fixing the HBlank, I got the effect I really wanted, except it did only work in Visualboy Advance. Any other emulator would crash or show the scanlines the wrong way.
<br/>
On the real hardware, the result was.... okay. That stupid scanline number 0 wouldn't scroll correct &gt;.&lt;;;; And that was my main goal with those 48 hours &gt;.&lt;;;;;;;
<br/>
<br/>
I also spent 9 hours debugging a commercial game to find out how they did the scanline scrolling.
<br/>
They do it with something called HDMA. I tried to use HDMA myself with these flags just like they did:
<br/>
<span style="font-weight: bold">DMA0(&amp;(REG_BG0HOFS), &amp;VTable [0], 0x1, DMA_TIMEING_HBLANK | DMA_ENABLE | DMA_REPEATE | DMA_DEST_FIXED | DMA_SOURCE_INCREMENT);</span>
<br/>
<br/>
And the result: BAD! It didn't even sync the frame, and then I had tried using the VBlank and the Vcounter in all ways I could find to make it sync, but still...... BAD.
<br/>
<br/>
PLUS! The scanline 0 was not scrolling in the same way as the rest of the scanlines. So.......?
<br/>
<br/>
WTF is wrong with the GBA? Why is is so unsychronized?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#25976 - DekuTree64 - Thu Sep 02, 2004 6:37 am</h4>
    <div class="postbody"><span class="postbody">That top scanline is caused by the fact that HBlank occurrs at the END of the scanline, and the last scanline before the top of the screen is the one at the bottom of the screen, so you have to sort of shift your table back one space to get the right values on each scanline. 
<br/>
I think either HBL interrupt or HDMA occurrs even during VBlank, but I can't remember which. Seems like it was DMA, and you have to restart that manually on VBlank anyway, so it doesn't cause any table problems.
<br/>
If you want to do much anytyhing but set a couple of registers or something, you'll most likely have to write your interrupt routine in ASM. ARM ASM is really fun and understandable compared to x86 though, ldr is the only confusing instruction, because you have to load symbols, and then the values stored at those symbols and such. Not too bad though.
<br/>
<br/>
Anyway, HDMA is better if you only want to change one register each scanline, but won't do you much good if you want to do a lot of different things.<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#25978 - poslundc - Thu Sep 02, 2004 1:49 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>DekuTree64 wrote:</b></span></td> </tr> <tr> <td class="quote">That top scanline is caused by the fact that HBlank occurrs at the END of the scanline, and the last scanline before the top of the screen is the one at the bottom of the screen, so you have to sort of shift your table back one space to get the right values on each scanline.</td> </tr></table><span class="postbody">
<br/>
<br/>
Also: you should set up the display of your first line during VBlank so that it is displayed before the first HBlank occurs.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">I think either HBL interrupt or HDMA occurrs even during VBlank, but I can't remember which. Seems like it was DMA, and you have to restart that manually on VBlank anyway, so it doesn't cause any table problems.</td> </tr></table><span class="postbody">
<br/>
<br/>
HBlank interrupts occur throughout all 225 scanlines. HDMA occurs only in the 160 VDraw scanlines.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">If you want to do much anytyhing but set a couple of registers or something, you'll most likely have to write your interrupt routine in ASM. ARM ASM is really fun and understandable compared to x86 though, ldr is the only confusing instruction, because you have to load symbols, and then the values stored at those symbols and such. Not too bad though.</td> </tr></table><span class="postbody">
<br/>
<br/>
When I first started working with HBlank interrupts and they worked on software but not so well on hardware, it turned out to be because of speed. HBlank is incredibly short, and interrupts have to be incredibly fast. ASM is definitely the way to go.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Anyway, HDMA is better if you only want to change one register each scanline, but won't do you much good if you want to do a lot of different things.</td> </tr></table><span class="postbody">
<br/>
<br/>
Word.
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#25985 - MumblyJoe - Thu Sep 02, 2004 4:57 pm</h4>
    <div class="postbody"><span class="postbody">Out of interest could you describe the effect you are aiming for? Maybe someone can come up with a more abstract idea for doing it.<br/>_________________<br/><a class="postlink" href="http://www.hungrydeveloper.com" target="_blank">www.hungrydeveloper.com</a>
<br/>
Version 2.0 now up - guaranteed at least 100% more pleasing!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#26001 - LOst? - Thu Sep 02, 2004 10:56 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>MumblyJoe wrote:</b></span></td> </tr> <tr> <td class="quote">Out of interest could you describe the effect you are aiming for? Maybe someone can come up with a more abstract idea for doing it.</td> </tr></table><span class="postbody">
<br/>
<br/>
<a href="http://www.logotypes.se/tmp/gbahdma.avi" target="_blank">http://www.logotypes.se/tmp/gbahdma.avi</a>
<br/>
<br/>
Here is a video I recorded. The commercial game here uses one background (BG3 as shown) to scroll the clouds in different speeds, but also makes a cool water ripple effect. All of this is done by HDMA.
<br/>
<br/>
I can't seem to get HDMA to be synchronized with the Vblank, so it isn't easy to fix the top scanline problem when HDMA starts the frame after the last Vblank, or before... Not really at the same visible frame.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
