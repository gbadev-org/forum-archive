<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Binary Amnesia (Witty title for a confusing memory bug) - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>Coding > Binary Amnesia (Witty title for a confusing memory bug)</h2>
<div id="posts">
<div class="post">
    <h4>#476 - staringmonkey - Wed Jan 08, 2003 1:30 am</h4>
    <div class="postbody"><span class="postbody">Hey all,
<br/>
<br/>
  For anybody who wants to hit me with the "where the hell have you been, we never talk to you anymore" style questions, you can go ahead, but thats not the reason for this post. :)
<br/>
  Normally I'd post my problems on the Yahoo group, but I thought I'd give these handy dandy new message boards a spin.
<br/>
<br/>
  Heres the situation:
<br/>
<br/>
   Basically, I've run out of IWRAM and I don't know why.  But let me start at the beginning.  The last few coding sessions I've had I've been having variables return incorrectly, AKA the values in the variables are fine within the function, but when returned and stored in a variable the value is corrupted.  I thought that I was just doing something stupid so I took some time off from that and did some optimization stuff, but yesterday when I went back to work on it I started having the same problem.  I didn't know what could be causing it other than some sort of memory bug so I just checked the address of one of my most recently initialized variables to see where it was in memory and it was at 0x3007d73, right on the trailing edge of IWRAM!  I can more or less put together the pieces on whats going on here, but I don't understand where my RAM could have gone.  All my game data is in ROM and my game variables are in EXRAM (granted the pointers to them are in IWRAM, but thats not much).  According to my .map file my last global is being placed at 0x030007a8, not even 2K into RAM.  So the only things in memory are code, 2K of globals, and local variables... that can't account for 32K worth of RAM.  I don't understand what the rest of my memory is being used for.
<br/>
  For the sake of experimentation (the way I usually find solutions to bugs) I tried declaring a variable right at the beginning of my first function to see where it was getting put.  Address check: 0x3007ef4.  So basically I'm missing the vast majority of IWRAM...  I won't claim to having ever been an expert on low-level memory management, but never-the-less I've never seen anything like this.
<br/>
<br/>
  Any ideas what the hell is going on?  BTW, this is for a professional project with an upcoming deadline, so time is severely NOT on my side.
<br/>
<br/>
Thanks in advance,
<br/>
staringmonkey</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#483 - ampz - Wed Jan 08, 2003 1:53 am</h4>
    <div class="postbody"><span class="postbody">That's your stack.
<br/>
The stack is usually placed at the end of the memory area.
<br/>
Local variables goes onto the stack you know.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#485 - staringmonkey - Wed Jan 08, 2003 2:14 am</h4>
    <div class="postbody"><span class="postbody">Ampz:
<br/>
<br/>
  Ahhhhhhhh (sigh of understanding).  I didn't know the stack was placed at the end of memory.  Well that makes sense.  Tid-bit of knowledge that I did not know.  So then my problem may not be a memory issue after all.  Then why are my functions returning incorrect values...?
<br/>
<br/>
  I guess I'll go tinker with this code some more... maybe it <span style="font-style: italic">was</span> something stupid I was doing after all... :)
<br/>
<br/>
Thanks,
<br/>
staringmonkey</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#487 - Touchstone - Wed Jan 08, 2003 2:21 am</h4>
    <div class="postbody"><span class="postbody">If you have the official devkit hardware you can use the debugger to single-step each assembly instruction and that way follow your data from one function to the next more closely than by single-stepping each C line. If you don't have the debug hardware on the other hand you're .. how should I put this .. on your own.<br/>_________________<br/>You can't beat our meat</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#488 - theSparko - Wed Jan 08, 2003 2:34 am</h4>
    <div class="postbody"><span class="postbody">I am a total Noob to GBA development, but I know some programming and I thought this sounded like a bug that might deal with passing by value or reference. 
<br/>
<br/>
Y'know:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
void swap(int x, int y) {
<br/>
     int temp = x;
<br/>
     x = y;
<br/>
     y = temp;
<br/>
     return;
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Now if you check the value of x and y they're still their original values because C is pass by value. So the function gets the values of x and y not a reference to their addresses. 
<br/>
<br/>
Anyway, I'm sure you probably already thought of this, but I thought I'd throw it out there anyway just cause I like to help people.
<br/>
<br/>
Helpfully,
<br/>
theSparko</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#506 - tom - Wed Jan 08, 2003 7:47 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>staringmonkey wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
So then my problem may not be a memory issue after all.  Then why are my functions returning incorrect values...?
<br/>
staringmonkey</td> </tr></table><span class="postbody">
<br/>
<br/>
post one of these functions. perhaps you're returning addresses of local variables on the stack ?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#507 - staringmonkey - Wed Jan 08, 2003 7:50 am</h4>
    <div class="postbody"><span class="postbody">Hey guys,
<br/>
<br/>
 TouchStone:  No I don't have official dev-hardware, not yet anyway.
<br/>
<br/>
 theSparko: Not quite what I was asking for, but thanks for trying to be helpful. :)
<br/>
<br/>
  Normally I wouldn't post code, but this is an extenuating (sp?) circumstance:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
///////////////////////////////Output////////////////////////////////////////
<br/>
u8 Output(u8 screenMem, u16 font, u8 palette, u8 startX, u8 startY, u8 maxX, u8 maxY, char *originalString, ...)
<br/>
{
<br/>
   //Local variables
<br/>
   u16 i = 0;                                 //Looping variable
<br/>
   u8 x = 0;                                 //X Column
<br/>
   u8 y = 0;                                 //Y Row
<br/>
   char outputString[(strlen(originalString) + 32)];   //String with variables
<br/>
   u16 length = 0;                              //Array length
<br/>
   u16 currentLetter = 0;                        //Current letter
<br/>
   u16 *destination = 0;                        //Target memory
<br/>
   u16 findSpace = 0;                           //Used to find last space before line-end
<br/>
<br/>
   //Cocanate variables into this string
<br/>
   va_list arguments;                              //Get arguments list
<br/>
   va_start(arguments, originalString);               //Start
<br/>
   vsprintf(outputString, originalString, arguments);      //Copy arguments
<br/>
   va_end(arguments);                              //End
<br/>
<br/>
   //Get the target memory
<br/>
   destination = GET_SCREEN_MEM(screenMem);
<br/>
<br/>
   //Get the length of the string
<br/>
   length = strlen(outputString);
<br/>
<br/>
   //Starting cursor position
<br/>
   x = startX;
<br/>
   y = startY;
<br/>
<br/>
   //Output the text
<br/>
   for(currentLetter = 0; currentLetter &lt; length; currentLetter++)
<br/>
   {
<br/>
      //This letter is a carriage return
<br/>
      if(outputString[currentLetter] == TEXT_CR)
<br/>
      {
<br/>
         //Next line
<br/>
         x = startX;
<br/>
         y++;
<br/>
<br/>
         //Next letter
<br/>
         continue;
<br/>
      }
<br/>
<br/>
      //If past the end of this line
<br/>
      if(x &gt;= maxX)
<br/>
      {
<br/>
         //Start at currentLetter
<br/>
         findSpace = currentLetter;
<br/>
<br/>
         //Search string
<br/>
         while(outputString[findSpace] != TEXT_SPACE)
<br/>
         {
<br/>
            //Backwords from current point
<br/>
            findSpace--;
<br/>
<br/>
            //No spaces found in the sentence
<br/>
            if(findSpace &lt;= 0)
<br/>
            {
<br/>
               //Just start writing on the next line with this letter
<br/>
               findSpace = currentLetter - 1;
<br/>
<br/>
               break;
<br/>
            }
<br/>
         }
<br/>
<br/>
         //Move forward from the found space
<br/>
         for(i = findSpace + 1; i &lt; currentLetter; i++)
<br/>
         {
<br/>
            //Erase this letter
<br/>
            destination[(y * 32) + (x - (currentLetter - i))] = 0;
<br/>
         }
<br/>
            
<br/>
         //Beginning of next line
<br/>
         x = startX;
<br/>
         y++;
<br/>
<br/>
         //Move back in the string (just past the space) and start writing again
<br/>
         currentLetter = findSpace + 1;
<br/>
<br/>
         //Past maximum length
<br/>
         if(y &gt;= maxY)
<br/>
         {
<br/>
            //Quit writing
<br/>
            return (y + 1);
<br/>
         }
<br/>
      }
<br/>
   
<br/>
      //Output the current letter
<br/>
      destination[(y * 32) + (x)] = ((font + (outputString[currentLetter] - 32)) | (palette&lt;&lt;12));
<br/>
<br/>
      //Next space
<br/>
      x++;
<br/>
   }
<br/>
<br/>
   //Return next open line
<br/>
   return (y + 1);
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
  When I pass call this function as:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
currentLine = Output(8, bg_font_graphics, bg_font_palette, DIALOGUE_WINDOW_LEFT + 3, currentLine, DIALOGUE_WINDOW_RIGHT, 32, "%s", message-&gt;responses[3]);
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
  Where <span style="font-weight: bold">message-&gt;responses[3]</span> = "1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0"
<br/>
<br/>
  The thing returns 53... incorrect.
<br/>
<br/>
  Strangeness #1:  If I change <span style="font-weight: bold">message-&gt;responses[3]</span> to "1234...etc" (no spaces) it works fine.
<br/>
  Strangeness #2:  If I check the value of <span style="font-weight: bold">y</span> immediately prior to returning, it is 11.
<br/>
<br/>
<span style="font-size: 18px; line-height: normal"><span style="color: darkred"><span style="font-weight: bold">!I AM SO CONFUSED!</span></span></span>
<br/>
<br/>
Thanks again,
<br/>
staringmonkey</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#513 - Quirky - Wed Jan 08, 2003 9:26 am</h4>
    <div class="postbody"><span class="postbody">Does this work then?
<br/>
<br/>
char outputString[(strlen(originalString) + 32)];  //String with variables 
<br/>
<br/>
because I can't imagine it'd compile - the copiler doesn't know the size of outputString at compile time... Anyway that's by the by, when you do this:
<br/>
<br/>
vsprintf(outputString, originalString, arguments)
<br/>
<br/>
"arguments" is longer than 32, which is the extra space you've alloted in your char buffer, isn't it? That could explain why it works with "1234567890" but not "1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0". Any behaviour after this step is undefined. Have you tried setting 
<br/>
<br/>
char outputString[200]; 
<br/>
<br/>
or something really big that will definitely hold all the chars? I'm probably way off though...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#515 - tom - Wed Jan 08, 2003 9:48 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quirky wrote:</b></span></td> </tr> <tr> <td class="quote">Does this work then?
<br/>
<br/>
char outputString[(strlen(originalString) + 32)];  //String with variables 
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
this is certainly one of the problems. the size of a variable on the stack must be a constant value, determinable at compile time. i wonder why this even compiles. vc++ refuses to compile that (which is correct behaviour)
<br/>
<br/>
i'd try something like that:
<br/>
<br/>
char *outputString = (char*)malloc(strlen(originalString)+32);
<br/>
<br/>
don't forget to free up the allocated memory at the end of the function.
<br/>
<br/>
or use a large enough string, as Quirky suggested, although that is of course not very safe =)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#516 - staringmonkey - Wed Jan 08, 2003 10:01 am</h4>
    <div class="postbody"><span class="postbody">Hey,
<br/>
<br/>
  Yep, you guys are right.  I just made this discovery myself, albeit in a far more roundabout way then you guys did.  (Lets just say it involved lots of futzing with how the string was passed.)
<br/>
<br/>
  Stupid, stupid mistake... oh well... I guess sometimes you have to learn the hard way.  Not that I'll look at it that way in two weeks when my first milestone is due. :)
<br/>
<br/>
Thanks again,
<br/>
The ever-so-humbled staringmonkey</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#518 - ampz - Wed Jan 08, 2003 10:23 am</h4>
    <div class="postbody"><span class="postbody">Actually, an local array CAN be of variable size. This is a C99(I think) feature that GCC supports. (however, not all compilers do support it)</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
