<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Continuous DMA copying - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>Coding > Continuous DMA copying</h2>
<div id="posts">
<div class="post">
    <h4>#22466 - DiscoStew - Tue Jun 22, 2004 6:35 am</h4>
    <div class="postbody"><span class="postbody">Would DMA copying be faster if I am continually using it in a group of operations than between long pieces of code?
<br/>
<br/>
I've been thinking of making an array that consists of a bunch of addresses and operations for use with DMA so that I am continually using DMA. My thought would be to increment pointers to the array for each source, destination, etc. each time a DMA operation was done until it reaches the end of the list. Would that be a good idea? Or does it not matter?<br/>_________________<br/><span style="font-weight: bold">DS</span> - It's all about <span style="font-weight: bold">D</span>isco<span style="font-weight: bold">S</span>tew</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#22467 - tepples - Tue Jun 22, 2004 6:57 am</h4>
    <div class="postbody"><span class="postbody">Remember that DMA halts the CPU. If you're trying to fit a bunch of DMAs into vblank time, such as if you're loading sprite cel data, then your transfer queue idea might work.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#22470 - DiscoStew - Tue Jun 22, 2004 9:39 am</h4>
    <div class="postbody"><span class="postbody">You really do seem to know what I'm working with, huh tepples? I've been working on my sprite handler for so long, that people immediately know what my current topics are related to.
<br/>
Then again, it could have been a lucky guess, since DMA questions are usually related to image data transfering...
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tepples wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
Remember that DMA halts the CPU
<br/>
</td> </tr></table><span class="postbody">
<br/>
I'm getting the feeling that since this is the case, my idea of a continual stream of data being copied through DMA to different places in memory may not work out for the better (in terms of speed I thought I could gain). Now I don't know what happens when the GBA switches between the CPU and DMA, but since I would have use the CPU to increment the pointer that points to the array in between DMAs (since there is no other way that I know of), it seems kinda pointless to do this compared to what I currently have, which is immediate DMAing instead of making a list and doing all DMAs in a row. The DMA registers are capable of incrementing to the next address in memory, but not incrementing a pointer to an address.
<br/>
<br/>
If anyone has any thoughts/ideas on the subject that may help, please post. thx.<br/>_________________<br/><span style="font-weight: bold">DS</span> - It's all about <span style="font-weight: bold">D</span>isco<span style="font-weight: bold">S</span>tew</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#22474 - sgeos - Tue Jun 22, 2004 11:43 am</h4>
    <div class="postbody"><span class="postbody">You might be able to have a more productive vblank if you do things like this:</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">setup_for_first_frame();
<br/>
fade_in();
<br/>
while (not_done) {
<br/>
   wait_for_vblank();
<br/>
   execute_dma_queue();
<br/>
   setup_for_next_frame();
<br/>
   do_non_time_critical_stuff();
<br/>
}</td> </tr></table><span class="postbody">
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>gbatek wrote:</b></span></td> </tr> <tr> <td class="quote">After changing the Enable bit [in DMAxCNT_H] from 0 to 1, wait 2 clock cycles before accessing any DMA related registers.</td> </tr></table><span class="postbody">Would this have any bearing on a DMA queue?
<br/>
<br/>
-Brendan</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#22481 - tepples - Tue Jun 22, 2004 8:30 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>sgeos wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>gbatek wrote:</b></span></td> </tr> <tr> <td class="quote">After changing the Enable bit [in DMAxCNT_H] from 0 to 1, wait 2 clock cycles before accessing any DMA related registers.</td> </tr></table><span class="postbody">Would this have any bearing on a DMA queue?</span></td> </tr></table><span class="postbody">
<br/>
Probably not. If you put your actual DMA copy in a separate function that's not inlined, the 'bx lr' at the end of the function should cover those 2 cycles nicely.
<br/>
<br/>
And of course, if you're using serial communication, use BIOS CpuFastSet() instead of big monolithic uninterruptible DMA transfers.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#22482 - dagamer34 - Tue Jun 22, 2004 8:31 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>sgeos wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>gbatek wrote:</b></span></td> </tr> <tr> <td class="quote">After changing the Enable bit [in DMAxCNT_H] from 0 to 1, wait 2 clock cycles before accessing any DMA related registers.</td> </tr></table><span class="postbody">Would this have any bearing on a DMA queue?
<br/>
<br/>
-Brendan</span></td> </tr></table><span class="postbody">
<br/>
<br/>
The waiting 1-2 cycles bit is for assembly programmers.<br/>_________________<br/>Little kids and Playstation 2's don't mix. :(</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#22491 - sgeos - Tue Jun 22, 2004 11:48 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tepples wrote:</b></span></td> </tr> <tr> <td class="quote">And of course, if you're using serial communication, use BIOS CpuFastSet() instead of big monolithic uninterruptible DMA transfers.</td> </tr></table><span class="postbody">If using serial communication, could CpuFastSet() be used to fill the sound FIFOs in a reliable manner?
<br/>
<br/>
-Brendan</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#22497 - poslundc - Wed Jun 23, 2004 3:09 am</h4>
    <div class="postbody"><span class="postbody">You would have better luck using an interrupt and just loading and storing the data out of memory yourself. One of my earlier mixers used such a technique, but it is rather wasteful.
<br/>
<br/>
Better to use the DMA, since it's designed for that purpose. As for difficulty with serial communication, has anyone ever really run into a problem there? I've not done any link programming so I can't say, but I would think the 8 cycles or so the DMAs would halt the CPU for stereo sound wouldn't create too much of a problem.
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#22499 - tepples - Wed Jun 23, 2004 3:20 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>sgeos wrote:</b></span></td> </tr> <tr> <td class="quote">If using serial communication, could CpuFastSet() be used to fill the sound FIFOs in a reliable manner?</td> </tr></table><span class="postbody">
<br/>
I don't think anybody has tried CpuFastSet in any mode other than DMA_COPYNOW. And I agree with poslundc that FIFO filling wouldn't reasonably delay FIFO filling, as the gap between FIFO fetches (once every 4 samples) is at least on the order of 2500 to 5000 cycles for typical GBA PCM playback rates.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
