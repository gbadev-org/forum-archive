<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>object file linking problems - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>Coding > object file linking problems</h2>
<div id="posts">
<div class="post">
    <h4>#21915 - johnny_north - Wed Jun 09, 2004 3:40 pm</h4>
    <div class="postbody"><span class="postbody">I?m having the darndest problem and I?m not sure of how many of the circumstances are pertinent, but here goes:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#include ?gba.h?
<br/>
#include ?console.h?
<br/>
<br/>
Console console;
<br/>
<br/>
int main(){
<br/>
   console.start();
<br/>
   return 0;
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
The whole game runs fine like this. However, if I comment out both the declaration of console and comment out console.start(), but link console.o to the project ? the binary hangs. I seem to find that one of console.cpp dependency files - background.o appears to be the offending object file. Nearly all of the code and data object files can be linked to produce a working rom, but the addition of background.o to the list of .o files to link causes the rom to hang immediately after starting.
<br/>
<br/>
If I strip out all of the code except for externs, declarations and includes from background.cpp and link background.o the rom works fine ? so It?s got to be a quirk with the code in this file ? right?
<br/>
<br/>
I?m hoping that someone?s conquered a similar problem and can help me cut down what?s looking like a lengthy bug hunt (the code in this file spans nearly 2000 lines and roughly half of it is interdependent). Any ideas?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#21916 - poslundc - Wed Jun 09, 2004 3:59 pm</h4>
    <div class="postbody"><span class="postbody">I'm not sure I understand why your console object would automatically launch in the first place.
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#21917 - johnny_north - Wed Jun 09, 2004 4:15 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">I'm not sure I understand why your console object would automatically launch in the first place. </td> </tr></table><span class="postbody">
<br/>
<br/>
If I understand you correctly, my answer is that it shouldn't do anything until I call one of console's member functions. However, normally that's the first thing I would do inside main().[/quote]</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#21919 - Abscissa - Wed Jun 09, 2004 5:00 pm</h4>
    <div class="postbody"><span class="postbody">That does seem odd.  I do know that crt0.o (If you're using that one) needs to be the first object file passed to the linker otherwise the ROM won't work.  Is it possible that that your inclusion/exclusion of those things is causing your makefile to pass the object files to the linker in a different order?
<br/>
<br/>
Some shots in the dark: Maybe there's something weird with a constructor or global either expecting an instance of Console to exist?  Maybe Console's constructor does something that another constructor or global expects to have been done?  Or maybe some sort of memory error in something's constructor/destructor.
<br/>
<br/>
If it's a problem in the code, I'd think it would have to be a constructor or a destructor, otherwise it'd probably be a problem in the build process.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#21924 - johnny_north - Wed Jun 09, 2004 5:27 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Is it possible that that your inclusion/exclusion of those things is causing your makefile to pass the object files to the linker in a different order?</td> </tr></table><span class="postbody">
<br/>
<br/>
The linker output is correct. The .map file shows that the member functions of background.cpp all reside in rom after ctr0 and main's functions (there are no directives to place any of background.cpp's functions anywhere else).
<br/>
<br/>
The strangest behavior is that if all the .o files (including background.o) are linked and console is declared - the game runs fine.
<br/>
<br/>
However, if all the .o files are linked and console is not declared the rom hangs immediately.
<br/>
<br/>
Edit - either I didn't all of your post or you added to it.
<br/>
<br/>
The real problem appears to be linking with background.o. If I remove console.o and any refs to it in main, the the rom works as expected so long as background.o has not been linked.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#21925 - johnny_north - Wed Jun 09, 2004 5:55 pm</h4>
    <div class="postbody"><span class="postbody">Ok, all functions from background.cpp that are not needed by other functions in this file are now gone including the costructor and any inline assembly. background.o still causes the rom to hang. I'm going to start removing the code from all of the other function bodies - one at a time until I pinpoint the problem code. 
<br/>
<br/>
I pray that the problem is in the first few functions. ;(</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#21926 - sajiimori - Wed Jun 09, 2004 6:07 pm</h4>
    <div class="postbody"><span class="postbody">You aren't creating a big static array that's filling up IWRAM, right?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#21929 - johnny_north - Wed Jun 09, 2004 6:21 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">You aren't creating a big static array that's filling up IWRAM, right?</td> </tr></table><span class="postbody">
<br/>
<br/>
Right - no static variables are used in any of background.cpp's functions.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#21931 - sajiimori - Wed Jun 09, 2004 7:19 pm</h4>
    <div class="postbody"><span class="postbody">I mean "static" in the more general sense of memory that's allocated before main() executes.  That includes these:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
int a;
<br/>
static int b;
<br/>
void f() { static int c; }
<br/>
class X { static int d; }; int X::d;
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#21933 - johnny_north - Wed Jun 09, 2004 8:02 pm</h4>
    <div class="postbody"><span class="postbody">Gotcha-
<br/>
<br/>
No, I'm not using static like this in background.cpp. I did choose to use static const declarations in lieu of some #defines where it seemed to be appropriate to do so (within the class definition). 
<br/>
<br/>
I haven't had need to use static in the manner you suggest. In your example:
<br/>
<br/>
a is an integer with global scope
<br/>
b is an integer with file scope
<br/>
c is an integer whose data persists and has f() scope
<br/>
d is an integer that will be shared amongst all instances of X
<br/>
<br/>
int X::d - I think this is the correct way to intialize d
<br/>
<br/>
Just quizzing my self to see if I understand the concept, although I'm not sure how any of these could cause a problem (rhetorical question).
<br/>
<br/>
Edit-
<br/>
<br/>
If you don't mind, how would using static in particular cause me a problem?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#21942 - sajiimori - Wed Jun 09, 2004 10:59 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">a is an integer with global scope 
<br/>
b is an integer with file scope 
<br/>
c is an integer whose data persists and has f() scope 
<br/>
d is an integer that will be shared amongst all instances of X
<br/>
</td> </tr></table><span class="postbody">What they all have in common is that they are allocated in RAM before main() even starts.
<br/>
<br/>
Again, I don't mean "static" the keyword -- I mean persistent data.  The reason I asked is because I've seen people do things like this and wonder what the problem is:</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">u8 map[256][256];</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#21961 - tepples - Thu Jun 10, 2004 2:32 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>sajiimori wrote:</b></span></td> </tr> <tr> <td class="quote">I don't mean "static" the keyword -- I mean persistent data.</td> </tr></table><span class="postbody">
<br/>
"Persistent" can mean one of two different things: data that never changes within one build of the program to the next (called 'const' data around here) and variables whose changes are preserved from one run of the program to the next (called a 'savegame').
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">The reason I asked is because I've seen people do things like this and wonder what the problem is:<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">u8 map[256][256];</td> </tr></table><span class="postbody"></span></td> </tr></table><span class="postbody">
<br/>
That's lacking only an EWRAM section attribute on the definition.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#21962 - wintermute - Thu Jun 10, 2004 2:44 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>johnny_north wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
I?m hoping that someone?s conquered a similar problem and can help me cut down what?s looking like a lengthy bug hunt (the code in this file spans nearly 2000 lines and roughly half of it is interdependent). Any ideas?</td> </tr></table><span class="postbody">
<br/>
<br/>
almost impossible to say without further information. The first thing I'd do is generate a mapfile and look for memory overruns.
<br/>
<br/>
Another possibility is an alignment problem if you're linking binary data using objcopy or some sort of bin2o tool.
<br/>
<br/>
There's a win32 port of Insight on <a href="http://www.devkit.tk" target="_blank">http://www.devkit.tk</a> which might help you narrow it down.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
