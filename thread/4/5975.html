<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Weird sprites and BG behaviors -- HELP ! - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>Coding > Weird sprites and BG behaviors -- HELP !</h2>
<div id="posts">
<div class="post">
    <h4>#45155 - Lideln - Wed Jun 08, 2005 3:22 am</h4>
    <div class="postbody"><span class="postbody">Hi all !
<br/>
<br/>
I'm new to GBA programming, and I don't understand some very weird behaviors related to sprites and backgrounds happening on my Double Dragon - like game.
<br/>
<br/>
<span style="font-weight: bold">First, the background</span>
<br/>
<br/>
I'm using tile-based mode 0. I display :
<br/>
- a background on BG0 (street and buildings) with priority 3 (like the sprites) size : 256*256
<br/>
- a status background (lives, ennemies' lives, etc) with priority 2
<br/>
<br/>
In that case, everything works FINE.
<br/>
But I would like to change the BG0 size to 512*256 in order to allow me to create a level bigger than 256 pixels :p
<br/>
And... tadaaaaa ! Beurk ! I do not understand what's happening : everyhting (only in BG0) is messed up, tiles are not at their "normal" position, its awful. And its even worst when I try to change the screen and char BaseBlock of the BG0.
<br/>
I tried almost everything, it just doesn't work.
<br/>
<br/>
Does someone have an idea about what's happening ? If you need my code to answer, I'll post it.
<br/>
<br/>
<br/>
<span style="font-weight: bold">Second, the sprites</span>
<br/>
<br/>
Another thing very weird is something like if the sprite palette had been corrupted (when looking in the palette viewer of VBA, some colors have been replaced by other).
<br/>
<br/>
When do this happen : In fact, till today I had been #include-ing the "sprite.c" files directly in my main.h, because I saw it somewhere, and .c are what pcx2sprite spits out. All my code was in a single file (almost) and so I decided to split it into many files (without modifying the code itself).
<br/>
I then had a problem : "spriteData multiple defined in game.o, first defined in main.o", but in main.h I only #include the game.h.
<br/>
So I decided to create a sprite.h file, to #include it, and to add the sprite.c to the project.
<br/>
<br/>
At this moment, this weird palette corruption happened. The solution I found is to delete sprite.c from the project (not compiled directly in the makefile) and to #include it directly in the game.c
<br/>
It worked, but I wanted to do the same way for other sprite files, and then it became more awful than the first time (with bad animation index, missing tiles, etc)
<br/>
<br/>
Does anyone have ever heard about that ?
<br/>
<br/>
<br/>
I'm sorry to bother you with my newbie's questions, and I would be very grateful for help (especially for the background problem, since I would like to create a REAL level ^^ (and I have never found a real, simple, not asm-based tutorial about that))
<br/>
<br/>
Thanks again,
<br/>
<br/>
Regards,
<br/>
<br/>
Lideln[/b]</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#45159 - tepples - Wed Jun 08, 2005 4:01 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Lideln wrote:</b></span></td> </tr> <tr> <td class="quote">I'm new to GBA programming, and I don't understand some very weird behaviors related to sprites and backgrounds happening on my Double Dragon - like game.</td> </tr></table><span class="postbody">
<br/>
Double Dragon Warrior, or Final Fight VII? ;-)
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote"><span style="font-weight: bold">First, the background</span>
<br/>
<br/>
I'm using tile-based mode 0. I display :
<br/>
- a background on BG0 (street and buildings) with priority 3 (like the sprites) size : 256*256
<br/>
- a status background (lives, ennemies' lives, etc) with priority 2
<br/>
<br/>
In that case, everything works FINE.
<br/>
But I would like to change the BG0 size to 512*256 in order to allow me to create a level bigger than 256 pixels :p
<br/>
And... tadaaaaa ! Beurk ! I do not understand what's happening : everyhting (only in BG0) is messed up, tiles are not at their "normal" position, its awful. And its even worst when I try to change the screen and char BaseBlock of the BG0.
<br/>
I tried almost everything, it just doesn't work.</td> </tr></table><span class="postbody">
<br/>
A 512x256 pixel map is organized in memory as two 256x256 maps side by side. But actually, you can make a level bigger than 256 pixels with a 256x256 map by redrawing only those tiles that are about to become visible. At any given scroll position, there's a 16-pixel-wide strip of the map that is not displayed; if you continue to draw new map data into that strip, you can keep drawing map data until the batteries run out.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">I then had a problem : "spriteData multiple defined in game.o, first defined in main.o", but in main.h I only #include the game.h.
<br/>
So I decided to create a sprite.h file, to #include it, and to add the sprite.c to the project.
<br/>
<br/>
At this moment, this weird palette corruption happened. The solution I found is to delete sprite.c from the project (not compiled directly in the makefile) and to #include it directly in the game.c
<br/>
It worked, but I wanted to do the same way for other sprite files, and then it became more awful than the first time (with bad animation index, missing tiles, etc)</td> </tr></table><span class="postbody">
<br/>
Are you making sure to give each file a unique name? Don't use "sprite" as a file name unless it depicts a <span style="font-style: italic">Secret of Mana</span> fairy or a can of lemon-lime flavored carbonated soda.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">I'm sorry to bother you with my newbie's questions, and I would be very grateful for help (especially for the background problem, since I would like to create a REAL level ^^ (and I have never found a real, simple, not asm-based tutorial about that))</td> </tr></table><span class="postbody">
<br/>
Open the tile viewer in VisualBoyAdvance for Windows, set it on auto-refresh, and look at the background on any GB, GBC, or GBA scrolling game.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#45198 - Lideln - Wed Jun 08, 2005 3:19 pm</h4>
    <div class="postbody"><span class="postbody">Hi Tepples,
<br/>
<br/>
<br/>
First of all thanks for your answer. I'll try to figure out how to make the "fill the strip" work since I did not find any good tutorial about this (for example, do I have to fill the tiles memory as well, or just the data memory ?) I won't deny that if you know about a good tutorial on what you said (using a 256*256 BG) it would be of great help for me.
<br/>
(maybe you could write some lines of code about that, since I think that, for you, it must not be very hard to write ? of course, I do not want to bother you, and if you have better things to do, or else, I'll try by myself)
<br/>
<br/>
For the sprites being corrupted, I still don't know what's happening... The sprites are called a different name each, and before splitting my code into different files everything was ok... weird...
<br/>
<br/>
Not knowing what to do, I decided to put my code in a single (almost) file again... It's very ugly, but its the only way it works atm.
<br/>
<br/>
Thanks again, and if you know about a good scrolling tutorial speaking about what you told me, I would be greatly interested.
<br/>
<br/>
Have a nice day,
<br/>
<br/>
Lideln</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#45273 - Lideln - Thu Jun 09, 2005 3:44 am</h4>
    <div class="postbody"><span class="postbody">Hi !
<br/>
<br/>
It's me, again...
<br/>
<br/>
I juste can't figure out what the hell is happening in my code. Could someone help me please ?
<br/>
<br/>
Here is what the problem is (about the sprites) :
<br/>
<br/>
Let's say I have a main.c and main.h.
<br/>
In the main.h, I write :
<br/>
<br/>
[code]
<br/>
    #include "ptiga.h"
<br/>
    #include "ptiga.c"
<br/>
//    #include "jelly.h"
<br/>
//    #include "jelly.c"
<br/>
[/quote]
<br/>
<br/>
Note that I had to comment the second sprite include.
<br/>
In that case, everything is ok, my hero is displayed correctly.
<br/>
<br/>
However, if I write :
<br/>
<br/>
[code]
<br/>
    #include "ptiga.h"
<br/>
    #include "ptiga.c"
<br/>
    #include "jelly.h"
<br/>
    #include "jelly.c"
<br/>
[/quote]
<br/>
<br/>
For example if I need to display other sprites than my hero.......
<br/>
In that case everything goes wront, even not using the second sprite, juste including it !!!
<br/>
What's happening ? My hero sprite is then displayed randomly, wrong tiles are displayed, sometimes nothing is displayed, sometimes just some weird pixels, sometimes a good face of my hero...
<br/>
<br/>
Please, does someone know what is happening with my code ?
<br/>
I just don't have the courage to write my code again from the beginning to see where it crashes, it would take too much time.
<br/>
<br/>
Thanks by advance for your help.
<br/>
<br/>
<br/>
Regards.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#45288 - ScottLininger - Thu Jun 09, 2005 6:32 am</h4>
    <div class="postbody"><span class="postbody">Lideln,
<br/>
<br/>
Could you post an opening snippet from your C and H files? My guess is that you're missing something very simple. 
<br/>
<br/>
One thing that's possible is that you're not putting the sprite data into the right memory area, and you're running out of RAM.
<br/>
<br/>
For example, are you using the "const" keyword in your graphic data declaration? This is needed to tell the compiler to store your graphics in cartridge ROM. If you don't declare them as const, they're getting stuffed into RAM at runtime.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">const u16 jellyData[] = {
<br/>
   0x0000, 0x0000, 0x058B, 0x0000, 0x0000, 0xAC8B, 0x7979, 0x0079, 0x7979, 0x7979, 
<br/>
   ...
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
We don't need to see everything... but a bit of code would be a good start.
<br/>
<br/>
:)
<br/>
<br/>
-Scott</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#45361 - Lideln - Thu Jun 09, 2005 11:29 pm</h4>
    <div class="postbody"><span class="postbody">Hi Scott
<br/>
<br/>
Thank you for your answer.
<br/>
Yes, there is the "const" since it is created by pcx2sprite, but the fact is that finally I decided to check every line of my code (since my last post yesterday).
<br/>
<br/>
I found at last where the error was, but I found it thanks to luck. (after about 6-8hours reading my code and making tests)
<br/>
When I create a sprite handler, a structure that knows the x, y, and z coord of my sprites for example, I created a [128] array, and that is what was wrong. I don't know why, because when I put [NUMBALLS] (from a Harbour Tutorial), it works !
<br/>
<br/>
This is quite annoying because Harbour created a 128 array, not a NUMBALLS one.
<br/>
<br/>
I thinks it's because I do not initialize every sprite, do you think so ?
<br/>
I just initialize the sprites I am using, so if I copy the data from sprites I am not using (thus they are not initialized, are they ?), I copy some weird values, isn't it ?
<br/>
<br/>
Here are some lines of code using sprites and sprites handlers (I am unfortunately not a guru coder, so my code is not secret ^^) :
<br/>
<br/>
Here is the sprites.h
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
<br/>
// ------------------------
<br/>
// sprites.h
<br/>
// ------------------------
<br/>
<br/>
    typedef struct tagSprite
<br/>
    {
<br/>
        unsigned short attribute0;
<br/>
        unsigned short attribute1;
<br/>
        unsigned short attribute2;
<br/>
        unsigned short attribute3;
<br/>
    }Sprite,*pSprite;
<br/>
<br/>
    typedef struct tagSpriteHandler
<br/>
    {
<br/>
        int alive;
<br/>
        int x, y, z;
<br/>
        int dirx, diry;
<br/>
        int width, height;
<br/>
        int hflip, vflip;
<br/>
        int size;
<br/>
        int shape;
<br/>
        int colormode;
<br/>
        int trans;
<br/>
    }SpriteHandler;
<br/>
<br/>
    extern Sprite sprites[128];
<br/>
    extern SpriteHandler mysprites[NUMBALLS];
<br/>
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
<br/>
Here is the sprites.c :
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
<br/>
#include "sprites.h"
<br/>
<br/>
SpriteHandler mysprites[NUMBALLS];
<br/>
Sprite sprites[128];
<br/>
<br/>
void HideSprites()
<br/>
{
<br/>
    int n;
<br/>
<br/>
    for (n = 0; n &lt; NUMBALLS; ++n)
<br/>
    {
<br/>
        sprites[n].attribute0 = 160;
<br/>
        sprites[n].attribute1 = 240;
<br/>
    }
<br/>
}
<br/>
<br/>
void MoveSprite(int num)
<br/>
{
<br/>
    sprites[num].attribute1 &amp;= 0xFE00;
<br/>
    sprites[num].attribute1 |= mysprites[num].x | mysprites[num].hflip | mysprites[num].vflip;// &amp; 0x01FF);
<br/>
<br/>
    sprites[num].attribute0 &amp;= 0xFF00;
<br/>
    sprites[num].attribute0 |= mysprites[num].y;// &amp; 0x00FF);
<br/>
}
<br/>
<br/>
void UpdateSpriteMemory(void)
<br/>
{
<br/>
    unsigned short* temp;
<br/>
    
<br/>
    temp = (unsigned short*)sprites;
<br/>
    DMACopy((void*)temp, (void*)SpriteMem, NUMBALLS * sizeof(Sprite) / 4, DMA_32NOW);
<br/>
}
<br/>
<br/>
void InitSprite(int num, int x, int y, int z, int sizeX, int sizeY, int color, int tileIndex)
<br/>
{
<br/>
    unsigned int sprite_size = 0;
<br/>
    unsigned int sprite_shape = 0;
<br/>
<br/>
//  some uninteresting code......
<br/>
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Here is where I initialize the sprites (at the moment only 2 different sprites, heheee it's the beginning :D). Here the code is exclusively (almost) from me, so there may be erros :D
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
<br/>
void UpdateJelly(int index)
<br/>
{
<br/>
    u16 *data;
<br/>
    u16 *dest;
<br/>
<br/>
    int max = jelly_WIDTH * jelly_HEIGHT / 2;
<br/>
    int begin = ptiga_WIDTH * ptiga_HEIGHT / 2;
<br/>
<br/>
    data = &amp;jellyData[(max * index)];
<br/>
    dest = &amp;SpriteData[begin];
<br/>
<br/>
    DMACopy((void*)data, (void*)dest, max, DMA_16NOW);
<br/>
}
<br/>
<br/>
void UpdatePtiga(int index)
<br/>
{
<br/>
    u16 *data;
<br/>
<br/>
    int max = ptiga_WIDTH * ptiga_HEIGHT / 2;
<br/>
<br/>
    data = &amp;ptigaData[(max * index)];
<br/>
<br/>
    DMACopy((void*)data, (void*)SpriteData, max, DMA_16NOW);
<br/>
<br/>
    sprites[0].attribute0 = mysprites[0].shape | mysprites[0].colormode | mysprites[0].y;
<br/>
    sprites[0].attribute1 = mysprites[0].size;
<br/>
    sprites[0].attribute1 |= mysprites[0].x | mysprites[0].hflip | mysprites[0].vflip;
<br/>
}
<br/>
<br/>
// ----------------------------------
<br/>
// In the main(void) function :
<br/>
// ----------------------------------
<br/>
InitSprite(0, (240 - ptiga_WIDTH) / 2, 160 - 16 - ptiga_HEIGHT, 16, ptiga_WIDTH, ptiga_HEIGHT, COLOR_256, 0);
<br/>
for (n = 1; n &lt; NUMBALLS; ++n)
<br/>
{
<br/>
    InitSprite(n, rand() % 230, rand() % 150, 0, jelly_WIDTH, jelly_HEIGHT, COLOR_256, 32);
<br/>
}
<br/>
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Now, if I change the :
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
// sprites.h
<br/>
extern SpriteHandler mysprites[NUMBALLS];
<br/>
// sprites.c
<br/>
SpriteHandler mysprites[NUMBALLS];
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
into :
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
// sprites.h
<br/>
extern SpriteHandler mysprites[128]; // the max amount of sprites
<br/>
// sprites.c
<br/>
SpriteHandler mysprites[128]; // the max amount of sprites
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
<br/>
Then my game <span style="font-weight: bold">freezes</span>.... Nice, isn't it ? :D
<br/>
(I also got some weird results like sprites displaying only one frame each two frames, and each its turn : ptiga first, then jelly, then ptiga... and with some of the frames distorted, I mean weird things... erf)
<br/>
<br/>
I should try with different values of NUMBALLS (atm it's 10), but if you see where the problem comes from, I'm listening :D
<br/>
<br/>
Thanks for your help, this is very nice of you !
<br/>
<br/>
Another thing : I still experience problems when trying to display a 512*256 background, the result is very awful. If you know where I can find a tutorial about how to display such a background (and especially how to perform a scrolling -- not only with the MapWrap bit, but a real level like mario) I would be very interested ! I am in mode 0.
<br/>
<br/>
Thanks again a lot, :)
<br/>
<br/>
Lideln</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#45388 - Shade - Fri Jun 10, 2005 3:40 am</h4>
    <div class="postbody"><span class="postbody">Hi, I've stopped following the Harbour book and started using TONC as a guide; I strongly recommend you do so as well. It's been quite useful so far (specially the background chapter).
<br/>
<br/>
<a href="http://user.chem.tue.nl/jakvijn/tonc/" target="_blank">http://user.chem.tue.nl/jakvijn/tonc/</a>
<br/>
<br/>
Cheers and good luck<br/>_________________<br/>"Whenever you find you're on the side of the majority, it's time to pause and reflect." -- Mark Twain</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#45390 - Lideln - Fri Jun 10, 2005 3:56 am</h4>
    <div class="postbody"><span class="postbody">Hi Shade !
<br/>
<br/>
It seems to be very interesting, I think its just what I was in need for.
<br/>
<br/>
Thank you for your tip, have a nice day !
<br/>
<br/>
Lideln
<br/>
(France)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#45398 - Lideln - Fri Jun 10, 2005 8:17 am</h4>
    <div class="postbody"><span class="postbody">Nice, thanks again for the site, now I understood why I was wrong (i thought the way to fill the BG was th same as a picture, but its not)
<br/>
<br/>
Thanks !
<br/>
<br/>
Lideln</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#45441 - Shade - Fri Jun 10, 2005 6:35 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Lideln wrote:</b></span></td> </tr> <tr> <td class="quote">Nice, thanks again for the site, now I understood why I was wrong (i thought the way to fill the BG was th same as a picture, but its not)</td> </tr></table><span class="postbody">
<br/>
You're welcome. TONC already helped me a lot. Enjoy!
<br/>
<br/>
Cheers<br/>_________________<br/>"Whenever you find you're on the side of the majority, it's time to pause and reflect." -- Mark Twain</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
