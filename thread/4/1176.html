<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>DMA trouble - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>Coding > DMA trouble</h2>
<div id="posts">
<div class="post">
    <h4>#5756 - Daikath - Thu May 08, 2003 4:42 am</h4>
    <div class="postbody"><span class="postbody">For some mysterious reason I can't seem to use DMA's, the data is as fine as it gets as it works fine with a for loop but I just want to know how to use DMA.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
REG_DMA3SAD = (u32)tilesPalette;
<br/>
REG_DMA3DAD = (u32)BGPaletteMem;
<br/>
REG_DMA3CNT_L = 256;
<br/>
REG_DMA3CNT_H = DMA_16NOW;
<br/>
<br/>
REG_DMA3SAD = (u32)tilesData;
<br/>
REG_DMA3DAD = (u32)BGMem;
<br/>
REG_DMA3CNT_L = 128*128/2; 
<br/>
REG_DMA3CNT_H = DMA_16NOW;
<br/>
   
<br/>
REG_DMA3SAD = (u32)New;
<br/>
REG_DMA3DAD = (u32)FrontBuffer;
<br/>
REG_DMA3CNT_L = 32*32; 
<br/>
REG_DMA3CNT_H = DMA_16NOW;
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
With these defines
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#define DMA_ENABLE 0x80000000
<br/>
#define DMA_TIMEING_IMMEDIATE 0x00000000
<br/>
#define DMA_16NOW DMA_ENABLE | DMA_TIMEING_IMMEDIATE| DMA_16
<br/>
</td> </tr></table><span class="postbody"><br/>_________________<br/>?There are no stupid questions but there are a LOT of inquisitive idiots.?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#5757 - niltsair - Thu May 08, 2003 4:49 am</h4>
    <div class="postbody"><span class="postbody">Those 2 :
<br/>
REG_DMA3CNT_L 
<br/>
REG_DMA3CNT_H
<br/>
<br/>
Are 16 bits pointers. And you try to give them 32bits values :
<br/>
#define DMA_ENABLE 0x80000000
<br/>
#define DMA_TIMEING_IMMEDIATE 0x00000000
<br/>
#define DMA_16NOW DMA_ENABLE | DMA_TIMEING_IMMEDIATE| DMA_16 
<br/>
<br/>
So, either transform those defines to 16bits, or use them as they should, by adressing the register in 1 shot, in 32bits :
<br/>
REG_DMA3SAD = (u32)tilesPalette;
<br/>
REG_DMA3DAD = (u32)BGPaletteMem;
<br/>
REG_DMA3CNT = DMA_16NOW | 256;
<br/>
<br/>
I did the exact same thing at first ;-)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#5758 - Daikath - Thu May 08, 2003 4:57 am</h4>
    <div class="postbody"><span class="postbody">Sorry for some weird reason I only see a all black palette when I check it in Visual Boy Advance.<br/>_________________<br/>?There are no stupid questions but there are a LOT of inquisitive idiots.?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#5760 - niltsair - Thu May 08, 2003 5:42 am</h4>
    <div class="postbody"><span class="postbody">You changed yours <span style="font-weight: bold">REG_DMA3CNT_L, REG_DMA3CNT_H</span> for 1 <span style="font-weight: bold">REG_DMA3CNT</span> ?
<br/>
<br/>
Here's what i use and that work perfectly fine :
<br/>
<br/>
#define DMA_ENABLE			0x80000000
<br/>
#define DMA_TIMEING_IMMEDIATE	0x00000000
<br/>
#define DMA_16				0x00000000
<br/>
#define DMA_16NOW	   (DMA_ENABLE | DMA_TIMEING_IMMEDIATE |DMA_16) 
<br/>
<br/>
REG_DMA3SAD = (u32)pic;	
<br/>
REG_DMA3DAD = (u32)VideoBuffer;	
<br/>
REG_DMA3CNT = 160*240 | DMA_16NOW;
<br/>
<br/>
Which is also what you basicly do.  So the problem must be elsewhere. Are <span style="font-weight: bold">tilesPalette;</span> and the other variable,  pointers on 16bits data? Because that's the only thing that could be wrong, non 16bits aligned data. Else, beside wrong pointers, i really don't see what might be wrong.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#5762 - Daikath - Thu May 08, 2003 6:11 am</h4>
    <div class="postbody"><span class="postbody">Lol, just my luck. I was also stuck 3 months getting a sprite to animate or move at all because REG_VCOUNT wasnt defined as a volatile. Am I just cursed to take the hardest way or what? ;)
<br/>
<br/>
Anyways I uploaded my entire source file, hopefully this'll help because I just can't seem to fix it.
<br/>
<br/>
<a href="http://212.187.35.37/jordi/tegelachtergronden.zip" target="_blank">http://212.187.35.37/jordi/tegelachtergronden.zip</a><br/>_________________<br/>?There are no stupid questions but there are a LOT of inquisitive idiots.?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#5776 - niltsair - Thu May 08, 2003 2:22 pm</h4>
    <div class="postbody"><span class="postbody">I'll have a quick look at it tonight (in ~9 hours :-) )</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#5796 - jenswa - Thu May 08, 2003 6:57 pm</h4>
    <div class="postbody"><span class="postbody">What you're trying to do is loading background stuff,
<br/>
like tiles and maps.
<br/>
<br/>
I also tried that, but couldn't get it to work,
<br/>
although you're palettes must work, since i load my palettes
<br/>
the same way and they work fine, also loading sprite graphics
<br/>
is going fine, just the background stuff isn't.
<br/>
<br/>
I'd love to hear a solution.<br/>_________________<br/>It seems this wasn't lost after all.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#5797 - niltsair - Thu May 08, 2003 7:03 pm</h4>
    <div class="postbody"><span class="postbody">Just a thought, are you waiting for VSync before sending your datas? I know they can get sheared, but i think(am i'm really not positive on this) that you can't update certain area unless your scanline is below 160.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#5801 - Daikath - Thu May 08, 2003 9:19 pm</h4>
    <div class="postbody"><span class="postbody">I use WaitforVsync after copying the data.<br/>_________________<br/>?There are no stupid questions but there are a LOT of inquisitive idiots.?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#5805 - niltsair - Thu May 08, 2003 9:42 pm</h4>
    <div class="postbody"><span class="postbody">should be done before copying the data. The point is to wait for VSync to have completed refreshing the screen, then you can change things to the display, before it start displaying again.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#5814 - niltsair - Fri May 09, 2003 12:04 am</h4>
    <div class="postbody"><span class="postbody">Ehehehehehehe, you'l love this one.
<br/>
<br/>
I checked your code, stripped everything without getting it to work. Was really swamped as to why it wouldn't work....
<br/>
<br/>
Remember that older thing you got stuck on? ;-)</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#define REG_DMA3SAD    *(volatile u32*)0x40000D4      /* DMA3 Source Address */
<br/>
#define REG_DMA3SAD_L  *(volatile u16*)0x40000D4      /* DMA3 Source Address Low Value */
<br/>
#define REG_DMA3SAD_H  *(volatile u16*)0x40000D6      /* DMA3 Source Address High Value */
<br/>
#define REG_DMA3DAD    *(volatile u32*)0x40000D8      /* DMA3 Destination Address */
<br/>
#define REG_DMA3DAD_L  *(volatile u16*)0x40000D8      /* DMA3 Destination Address Low Value */
<br/>
#define REG_DMA3DAD_H  *(volatile u16*)0x40000DA      /* DMA3 Destination Address High Value */
<br/>
#define REG_DMA3CNT    *(volatile u32*)0x40000DC      /* DMA3 Control (Amount) */
<br/>
#define REG_DMA3CNT_L  *(volatile u16*)0x40000DC      /* DMA3 Control Low Value */
<br/>
#define REG_DMA3CNT_H  *(volatile u16*)0x40000DE      /* DMA3 Control High Value */</td> </tr></table><span class="postbody">
<br/>
<br/>
:-) Just declare all your register's variable as volatile. And Voil?.
<br/>
The most esthetic way to do this is :
<br/>
#define vu8 volatile unsigned char
<br/>
#define vu16 volatile unsigned short...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#5815 - Daikath - Fri May 09, 2003 12:16 am</h4>
    <div class="postbody"><span class="postbody">Could you send me the entire source document you made? Because even with those registers registered as a volatile it doesnt do anything different here.<br/>_________________<br/>?There are no stupid questions but there are a LOT of inquisitive idiots.?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#5816 - niltsair - Fri May 09, 2003 12:50 am</h4>
    <div class="postbody"><span class="postbody">Put every register to volatile, especially : 
<br/>
<br/>
#define REG_VCOUNT     *(volatile u16*)0x4000006      /* Vertical Control (Sync) */</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#5820 - niltsair - Fri May 09, 2003 2:04 am</h4>
    <div class="postbody"><span class="postbody">Here's the solution:
<br/>
---Removed---
<br/>
<br/>
Just do a seach on //SF to find where i changed things.
<br/>
<br/>
But really, the only problems were :
<br/>
1. Needed to declare every register pointer, as volatile
<br/>
2. When you were passing your array address, you didn't need to do '&amp;Array', only 'Array' since an array is a pointer, you were passing the pointer address and not the data address.</span><span class="gensmall"><br/><br/>Last edited by niltsair on Sat May 10, 2003 12:34 am; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#5822 - Daikath - Fri May 09, 2003 3:20 am</h4>
    <div class="postbody"><span class="postbody">*kisses niltsair on the lips*
<br/>
<br/>
thank you! heil niltsair!<br/>_________________<br/>?There are no stupid questions but there are a LOT of inquisitive idiots.?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#5823 - niltsair - Fri May 09, 2003 4:46 am</h4>
    <div class="postbody"><span class="postbody">Errrr, if you're a guy, no needs for that really. And if you're a girl, well i'm not sure my girlfriend would approve :-) A small 20$ would be enough ;-)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#6982 - hzx - Thu Jun 05, 2003 7:20 pm</h4>
    <div class="postbody"><span class="postbody">hello
<br/>
<br/>
I totally stucked with a code, and it seems to be a DMA problem, maybe similar with the aforementioned one. It wants to be a mode3 double buffer, in which you always draw into the background buffer and then copy it to VideoBuffer on VBlank. Here it is:
<br/>
<br/>
u16 *DrawBuffer = (u16 *)0x02000000;
<br/>
<br/>
// Backbuffer in EWRAM, because it is bigger than 32K
<br/>
<br/>
void Wkey() {
<br/>
while ((*KEYS) &amp; 1) {
<br/>
};
<br/>
}
<br/>
<br/>
// just for debugging purposes
<br/>
<br/>
void CopyDrawBuffer() {
<br/>
<br/>
REG_DMA3SAD = (u32)DrawBuffer;
<br/>
REG_DMA3DAD = 0x06000000;
<br/>
REG_DMA3CNT = 38400 | DMA_ENABLE;
<br/>
<br/>
}
<br/>
<br/>
// use DMA to copy the backbuffer to VideoBuffer
<br/>
<br/>
void DMAClearDrawBuffer() {
<br/>
<br/>
REG_DMA3SAD = 0x05000000;
<br/>
REG_DMA3DAD = (u32)DrawBuffer;
<br/>
REG_DMA3CNT = 38400 | DMA_ENABLE | DMA_SOURCE_FIXED;
<br/>
}
<br/>
<br/>
// this one clears the backbuffer. Takes the zero value from the Palette[0]
<br/>
<br/>
void StupidClear() {
<br/>
<br/>
int i;
<br/>
for (i = 0; i &lt; 38400; i++) {
<br/>
DrawBuffer[i] = 0;
<br/>
}
<br/>
}
<br/>
<br/>
// a debug clearscreen, filling background buffer with zeros
<br/>
<br/>
int main() {
<br/>
<br/>
int i;
<br/>
<br/>
SetMode(MODE_3 | BG2_ENABLE);
<br/>
<br/>
i = 1000; // for a little demonstration
<br/>
<br/>
while(1) {
<br/>
DrawBuffer[i] = RGB16(31,31,31);
<br/>
WaitForVSync();
<br/>
CopyDrawBuffer();
<br/>
Wkey();
<br/>
i++;
<br/>
DMAClearDrawBuffer();
<br/>
// StupidClear();
<br/>
}
<br/>
<br/>
So, when i run the code, the screen remains blank until the first keypress, which is strange, because the CopyDrawBuffer should display the white pixel in the 1000th position of VideoBuffer. After the first keypress, the code works as it is expected, BUT! only with the stupid clear routine - the DMA version clears the screen though, the program doesnt work at all. Maybe i am missing some oblivious, but i cannot see it. Somebody can help me? As the last thing, i suspected the compiler, but i am not smart enough to write an asm code to setup DMA regs yet.<br/>_________________<br/>.hzx</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#6983 - jenswa - Thu Jun 05, 2003 7:33 pm</h4>
    <div class="postbody"><span class="postbody">The gba draws two pixels at a time,
<br/>
so not one like your trying.
<br/>
<br/>
If you want one white pixel and you need to draw two pixels,
<br/>
what will you do? There is more than one way.
<br/>
<br/>
Just write a white pixel where you want it, followed by tranparent.
<br/>
That should work.<br/>_________________<br/>It seems this wasn't lost after all.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#6989 - niltsair - Thu Jun 05, 2003 8:11 pm</h4>
    <div class="postbody"><span class="postbody">Jenswa: No, this part is ok. The 2 pixels writing only apply in 256colors mode, (and 4pixels for 16colors mode). In mode 3, a pixel takes 16bits, so you write one at a time.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#6999 - hzx - Thu Jun 05, 2003 9:56 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>jenswa wrote:</b></span></td> </tr> <tr> <td class="quote">The gba draws two pixels at a time,
<br/>
so not one like your trying.
<br/>
<br/>
If you want one white pixel and you need to draw two pixels,
<br/>
what will you do? There is more than one way.
<br/>
<br/>
Just write a white pixel where you want it, followed by tranparent.
<br/>
That should work.</td> </tr></table><span class="postbody">
<br/>
<br/>
Jenswa, I'm afraid you missed the point in my case. In mode3 you write one pixel with a 16 bit transfer, and there are no  "transparent" pixels IMHO. The strange thing is that this code works if you use the SillyClear function, and does not, if you use the DMA for clearing the backbuffer. If you set Palette[0] to an other color (RGB16(31,0,0) for example), you can see that it actually clears the backbuffer, and thus the VideoBuffer, just halts the running of the program somehow.<br/>_________________<br/>.hzx</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#7034 - hzx - Fri Jun 06, 2003 3:18 pm</h4>
    <div class="postbody"><span class="postbody">Damn, I figured it out! This code won't work if you compile it with the -O2 optimizing option. But goes perfectly, if compile without.<br/>_________________<br/>.hzx</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#7040 - niltsair - Fri Jun 06, 2003 5:12 pm</h4>
    <div class="postbody"><span class="postbody">Ah, the typical error ;-)
<br/>
<br/>
Declare all your register's pointers as 'volatile'. Should work fine with -O2 afterward.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#7043 - tepples - Fri Jun 06, 2003 5:31 pm</h4>
    <div class="postbody"><span class="postbody">Also, make sure to set DMA3CNT to 0 before setting up the copy.  If DMA3CNT is not 0, then the DMA3 registers may be write-protected.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#7059 - Lupin - Sat Jun 07, 2003 2:42 pm</h4>
    <div class="postbody"><span class="postbody">I played around with loading up tile maps, and I used this code to load an 512p(32t) x 512p(32t) map
<br/>
<br/>
Could I do it with less DMA copies?
<br/>
<br/>
  u16 y;
<br/>
  for(y = 0; y &lt; 64; y++) {
<br/>
    if(y&lt;32) {
<br/>
	  DMACopyCH3((void*)planets_MapData+y*128, (void*)pMapData+y*64, 16, DMA_32NOW);
<br/>
	  DMACopyCH3((void*)planets_MapData+64+y*128, (void*)pMapData+y*64+2048, 16, DMA_32NOW);
<br/>
	}else{
<br/>
	  DMACopyCH3((void*)planets_MapData+y*128, (void*)pMapData+(y-32)*64+4096, 16, DMA_32NOW);
<br/>
	  DMACopyCH3((void*)planets_MapData+64+y*128, (void*)pMapData+(y-32)*64+6144, 16, DMA_32NOW);
<br/>
	}
<br/>
  }</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
