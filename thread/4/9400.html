<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Help understanding some UART code - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>Coding > Help understanding some UART code</h2>
<div id="posts">
<div class="post">
    <h4>#81436 - a4_jet - Sat Apr 29, 2006 4:19 am</h4>
    <div class="postbody"><span class="postbody">Hi,
<br/>
I'm fairly new to GB programming and have started my first program, which is a program to recieve serial information from a car's ECU and then display it to the driver.
<br/>
<br/>
Im trying to setup the UART on the GBA to recieve 8 bit RS232 data set at 9600 bps.
<br/>
<br/>
I had a look at this post to intialize the UART 
<br/>
<a href="http://forum.gbadev.org/viewtopic.php?t=1307&amp;highlight=uart" target="_blank">http://forum.gbadev.org/viewtopic.php?t=1307&amp;highlight=uart</a>
<br/>
<br/>
I have used most of this code but i'm trying to debug it now using visual ham.
<br/>
This is it so far
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
//UART intilization
<br/>
// Register base address
<br/>
#define REG_BASE          0x4000000
<br/>
<br/>
// Serial IO Registers
<br/>
#define REG_SIOCNT        *(volatile unsigned short int *)(REG_BASE + 0x128)  // Serial control
<br/>
#define REG_SIODATA8      *(volatile unsigned short int *)(REG_BASE + 0x12a)  // Serial data
<br/>
#define REG_RCNT          *(volatile unsigned short int *)(REG_BASE + 0x134)  // General IO
<br/>
<br/>
<br/>
// UART settings
<br/>
#define SIO_USE_UART      0x3000 \\must be set for 1 for uart mode
<br/>
<br/>
// Baud Rate
<br/>
#define SIO_BAUD_9600     0x0000 \\sets the input to 9600
<br/>
#define SIO_BAUD_38400    0x0001
<br/>
#define SIO_BAUD_57600    0x0002
<br/>
#define SIO_BAUD_115200   0x0003
<br/>
<br/>
#define SIO_CTS           0x0004
<br/>
#define SIO_PARITY_ODD    0x0008
<br/>
#define SIO_SEND_DATA     0x0010
<br/>
#define SIO_RECV_DATA     0x0020
<br/>
#define SIO_ERROR         0x0040
<br/>
#define SIO_LENGTH_8      0x0080 \\recieves 8 bit data
<br/>
#define SIO_USE_FIFO      0x0100
<br/>
#define SIO_USE_PARITY    0x0200
<br/>
#define SIO_SEND_ENABLE   0x0400 \\sets the uart to send
<br/>
#define SIO_RECV_ENABLE   0x0800 \\sets the uart to recieve
<br/>
#define SIO_REQUEST_IRQ   0x4000 \\sets an interrupt when send, recieve and error flag are set.
<br/>
//-----------------------------------------------------------------------------------
<br/>
<br/>
   // Init UART
<br/>
   REG_RCNT = 0; //turns the uart on in the gba
<br/>
   REG_SIOCNT = 0; //intializes all the uart control values to zero.
<br/>
   REG_SIOCNT = SIO_BAUD_9600 | SIO_LENGTH_8 | SIO_RECV_ENABLE | SIO_USE_UART | SIO_REQUEST_IRQ ;
<br/>
   REG_SIOCNT |= SIO_RECV_DATA | SIO_SEND_DATA; 
<br/>
//-----------------------------------------------------------------------------------
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I am having trouble understanding this part of the code and it is the part im having difficulty debugging
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
REG_SIOCNT = SIO_BAUD_9600 | SIO_LENGTH_8 | SIO_RECV_ENABLE | SIO_USE_UART | SIO_REQUEST_IRQ ;
<br/>
   REG_SIOCNT |= SIO_RECV_DATA | SIO_SEND_DATA; 
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I understand that it is setting up the UART port, but i'm not understanding the code. What does a | do in regards to the code? 
<br/>
Is it simplier way to enable all the registers for UART control at once? instead of writing individual code for each register you want to enable.
<br/>
<br/>
Im totally stuck i've been trying to read up on c programming but cant find anything about this "|".
<br/>
<br/>
Thanks
<br/>
a4_jet
<br/>
<br/>
<br/>
OOPS i should have put this in the C code help section, sorry...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#81462 - headspin - Sat Apr 29, 2006 7:55 am</h4>
    <div class="postbody"><span class="postbody">The '|' is called a bitwise OR in C. So you are setting the appropriate bits in the REG_SIOCNT register all at once. The |= is just or'ing more bits to the same register. If you convert all the hex values to their binary equivalents and or them together you will see they are setting individual bits of the register.
<br/>
<br/>
Check out <a class="postlink" href="http://www.cs.rit.edu/~tjh8300/CowBite/CowBiteSpec.htm#Serial%20Communication%20Registers" target="_blank">CowBite Virtual Harware Spec</a> to find out what each bit of the register means.<br/>_________________<br/><a class="postlink" href="http://headsoft.com.au/index.php?category=warhawk" target="_blank">Warhawk DS</a> | <a class="postlink" href="http://headsoft.com.au/index.php?category=mmll" target="_blank">Manic Miner: The Lost Levels</a> | <a class="postlink" href="http://headsoft.com.au/index.php?category=tdg" target="_blank">The Detective Game</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#81476 - a4_jet - Sat Apr 29, 2006 12:12 pm</h4>
    <div class="postbody"><span class="postbody">Thanks HeadSpin!
<br/>
<br/>
Im getting errors when i go to compile it in visual ham.
<br/>
This is what pops up
<br/>
main.c:57: error: parse error before "volatile"
<br/>
main.c:58: error: parse error before "volatile"
<br/>
main.c:59: error: parse error before "volatile"
<br/>
main.c:59: error: stray '\' in program
<br/>
main.c:59: error: stray '\' in program
<br/>
main.c:59: error: stray '\' in program
<br/>
main.c:59: error: stray '\' in program
<br/>
main.c:59: error: stray '\' in program
<br/>
main.c:59: error: stray '\' in program
<br/>
main.c:59: error: stray '\' in program
<br/>
main.c:59: error: stray '\' in program
<br/>
main.c:59: error: stray '\' in program
<br/>
main.c:59: error: stray '\' in program
<br/>
main.c:60: error: parse error before "volatile"
<br/>
<br/>
Lines 57-60 refer to this code
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
   REG_RCNT = 0x0000000; //turns the uart on in the gba
<br/>
   REG_SIOCNT = 0; //intializes all the uart control values to zero.
<br/>
   REG_SIOCNT = SIO_BAUD_9600 | SIO_LENGTH_8 | SIO_RECV_ENABLE | SIO_USE_UART | SIO_REQUEST_IRQ ;
<br/>
   REG_SIOCNT |= SIO_RECV_DATA | SIO_SEND_DATA; 
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Now i'm sure the error is not occuring here but further up at these lines
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#define REG_SIOCNT        *(volatile unsigned short int *)(REG_BASE + 0x128);  // Serial control
<br/>
#define REG_SIODATA8      *(volatile unsigned short int *)(REG_BASE + 0x12a);  // Serial data
<br/>
#define REG_RCNT          *(volatile unsigned short int *)(REG_BASE + 0x134);  // General IO</td> </tr></table><span class="postbody">
<br/>
<br/>
I understand that this code is defining what address to write the bits into the memory to setup the UART port.
<br/>
Im not understanding the code and the errors. I know that the volatile unsigned short is referring to a 16bit value that can be changed by anypart of the code(i think that is what volatile means)
<br/>
<br/>
i'm not sure what the pointers and the (REG_BASE + "hexadecimal number") are doing in the code. 
<br/>
<br/>
It also seems to get less errors when i remove the pointers before "volatile". 
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#define REG_SIOCNT        (volatile unsigned short int *)(REG_BASE + 0x128);  // Serial control 
<br/>
#define REG_SIODATA8      (volatile unsigned short int *)(REG_BASE + 0x12a);  // Serial data 
<br/>
#define REG_RCNT          (volatile unsigned short int *)(REG_BASE + 0x134);  // General IO
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Normally im pretty good at c code, i do some at uni programming microprocessors. But this is my first time having a go at a GBA system.
<br/>
<br/>
Any help would be greatly appreciated!
<br/>
<br/>
PS.
<br/>
again this should be in the c code section sorry...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#81477 - Mighty Max - Sat Apr 29, 2006 12:19 pm</h4>
    <div class="postbody"><span class="postbody">Remove the ";" at the end of the defines.
<br/>
<br/>
With the current defines, REG_RCNT = 0x0000000; will get substituted to 
<br/>
(volatile unsigned short int *)(REG_BASE + 0x134); = 0x0000000;
<br/>
<br/>
the \ Error comes from the SIO_ defines. Use // instead of \\ for comments<br/>_________________<br/><a class="postlink" href="http://mightymax.org/gbamp_multiboot.html" target="_blank">GBAMP Multiboot</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#81480 - a4_jet - Sat Apr 29, 2006 1:32 pm</h4>
    <div class="postbody"><span class="postbody">Thanks mightymax
<br/>
<br/>
Yes that was silly using \\ instead of // for comments. bit of newb mistake i guess
<br/>
<br/>
I think i know what was wrong now... I think you can only assign the bits inside a function. So i have now changed the code too.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#define REG_BASE          0x4000000
<br/>
<br/>
<br/>
// Serial IO Registers
<br/>
#define REG_SIOCNT        *(volatile unsigned short int *)(REG_BASE + 0x128)  // Serial control
<br/>
#define REG_SIODATA8      *(volatile unsigned short int *)(REG_BASE + 0x12a)  // Serial data
<br/>
#define REG_RCNT          *(volatile unsigned short int *)(REG_BASE + 0x134)  // General IO
<br/>
<br/>
<br/>
// UART settings
<br/>
#define SIO_USE_UART      0x3000 //must be set for 1 for uart mode
<br/>
<br/>
// Baud Rate
<br/>
#define SIO_BAUD_9600     0x0000 //sets the input to 9600
<br/>
#define SIO_BAUD_38400    0x0001
<br/>
#define SIO_BAUD_57600    0x0002
<br/>
#define SIO_BAUD_115200   0x0003
<br/>
<br/>
#define SIO_CTS           0x0004
<br/>
#define SIO_PARITY_ODD    0x0008
<br/>
#define SIO_SEND_DATA     0x0010
<br/>
#define SIO_RECV_DATA     0x0020
<br/>
#define SIO_ERROR         0x0040
<br/>
#define SIO_LENGTH_8      0x0080 //recieves 8 bit data
<br/>
#define SIO_USE_FIFO      0x0100
<br/>
#define SIO_USE_PARITY    0x0200
<br/>
#define SIO_SEND_ENABLE   0x0400 //sets the uart to send
<br/>
#define SIO_RECV_ENABLE   0x0800 //sets the uart to recieve
<br/>
#define SIO_REQUEST_IRQ   0x4000 //sets an interrupt when send, recieve and error flag are set.
<br/>
//-----------------------------------------------------------------------------------
<br/>
<br/>
void InitUART()
<br/>
{
<br/>
   // Init UART
<br/>
   REG_RCNT = 0x0000000; //turns the uart on in the gba
<br/>
   REG_SIOCNT = 0; //intializes all the uart control values to zero.
<br/>
   REG_SIOCNT = SIO_BAUD_9600 | SIO_LENGTH_8 | SIO_RECV_ENABLE | SIO_USE_UART | SIO_REQUEST_IRQ;
<br/>
   REG_SIOCNT |= SIO_RECV_DATA | SIO_SEND_DATA;
<br/>
//-----------------------------------------------------------------------------------
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
and bingo no parse errors!!!
<br/>
Yippee
<br/>
<br/>
Thanks for all your help guys and dealing with my newb mistakes</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
