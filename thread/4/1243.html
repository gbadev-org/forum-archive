<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Sprite animation - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>Coding > Sprite animation</h2>
<div id="posts">
<div class="post">
    <h4>#6138 - e_mpika - Sun May 18, 2003 4:34 am</h4>
    <div class="postbody"><span class="postbody">Hallo everyone, im quite new to gba porgramming so bear with me!
<br/>
im trying to animat a sprite, i just want to loop it, the are 3 frame of a man walking.
<br/>
ive learnt alot and think i understand most of it so far, basically this code is a copy and paste of tutorial stuff ive come accross, please could you help me animate my man, i have set up the man and loaded the sprite data and stuff, i just need to be able to loop between attribute2's, i have made a struce to hold the frame numbers in.
<br/>
<br/>
//my code for a man, by eddy parris.
<br/>
<br/>
#include "gba.h"
<br/>
#include "screenmode.h"
<br/>
#include "sprite.h"
<br/>
#include "spred_sprite.h"
<br/>
<br/>
//#include "palette.h"
<br/>
#include "keypad.h"
<br/>
<br/>
s16 x = 50;
<br/>
s16 y = 60;
<br/>
u16 char_number = 0;
<br/>
u16 frame =0;
<br/>
<br/>
void GetInput(void);
<br/>
<br/>
void MoveSprite(OAMEntry* sp, int x, int y);
<br/>
<br/>
OAMEntry sprites[128];
<br/>
<br/>
typedef struct
<br/>
{
<br/>
	u16 x;			//x and y position on screen
<br/>
	u16 y;
<br/>
	u16 spriteFrame[3];     //animation frame
<br/>
	int activeFrame;        //which frame is active
<br/>
}Sprite;
<br/>
<br/>
Sprite man;
<br/>
<br/>
<br/>
void CopyOAM()
<br/>
{
<br/>
u16 loop;
<br/>
u16* temp;
<br/>
temp = (u16*)sprites;
<br/>
<br/>
<br/>
	for(loop = 0; loop &lt; 128*4; loop++)
<br/>
	{
<br/>
	OAMmem[loop] = temp[loop];
<br/>
	}
<br/>
}
<br/>
<br/>
void GetInput(void)
<br/>
{
<br/>
	if(!(*KEYS &amp; KEY_UP))
<br/>
	{
<br/>
 		y--;
<br/>
	}
<br/>
	if(!(*KEYS &amp; KEY_DOWN))
<br/>
	{
<br/>
 		y++;
<br/>
	}
<br/>
	if(!(*KEYS &amp; KEY_LEFT))
<br/>
	{
<br/>
 		x--;
<br/>
	}
<br/>
	if(!(*KEYS &amp; KEY_RIGHT))
<br/>
	{
<br/>
 		x++;
<br/>
	}
<br/>
	if(!(*KEYS &amp; KEY_A))
<br/>
	{
<br/>
 		x++;
<br/>
		y++;
<br/>
	}
<br/>
}
<br/>
<br/>
<br/>
void MoveSprite(OAMEntry* sp, int x, int y)
<br/>
{
<br/>
	if(x &lt; 0)			
<br/>
		x = 512 + x;
<br/>
	if(y &lt; 0)		
<br/>
		y = 256 + y;
<br/>
<br/>
	sp-&gt;attribute1 = sp-&gt;attribute1 &amp; 0xFE00; 
<br/>
	sp-&gt;attribute1 = sp-&gt;attribute1 | x;
<br/>
<br/>
	sp-&gt;attribute0 = sp-&gt;attribute0 &amp; 0xFF00; 
<br/>
	sp-&gt;attribute0 = sp-&gt;attribute0 | y;
<br/>
}
<br/>
<br/>
void InitializeSprites()
<br/>
{
<br/>
u16 loop;
<br/>
for(loop = 0; loop &lt; 128; loop++)
<br/>
{
<br/>
sprites[loop].attribute0 = 160;
<br/>
sprites[loop].attribute1 = 240;
<br/>
}
<br/>
}
<br/>
<br/>
<br/>
void WaitForVsync()
<br/>
{
<br/>
while((volatile u16)REG_VCOUNT != 160){}
<br/>
}
<br/>
<br/>
<br/>
<br/>
int main()
<br/>
{
<br/>
u16 loop;
<br/>
<br/>
<br/>
	SetMode(MODE_1 | OBJ_ENABLE | OBJ_MAP_1D);
<br/>
<br/>
	for(loop = 0; loop &lt; 256; loop++)
<br/>
	OBJPaletteMem[loop] = spred_sprite_pal[loop];
<br/>
<br/>
InitializeSprites();
<br/>
<br/>
sprites[0].attribute0 = COLOR_256 | WIDE | y;
<br/>
sprites[0].attribute1 = SIZE_32 | x;
<br/>
sprites[0].attribute2 = 0;
<br/>
<br/>
<br/>
for(loop = 0; loop &lt; 768; loop++)
<br/>
{
<br/>
OAMdata[loop] = spred_sprite_pak[loop];
<br/>
}
<br/>
<br/>
    man.activeFrame = 0;                    //set the initial active frame markers
<br/>
	man.spriteFrame[0] = 0;                 //set the frame markers
<br/>
	man.spriteFrame[1] = 16;
<br/>
	man.spriteFrame[2] = 32;
<br/>
<br/>
while(1)
<br/>
{
<br/>
<br/>
GetInput();
<br/>
MoveSprite(&amp;sprites[0],x,y);
<br/>
<br/>
WaitForVsync();
<br/>
<br/>
CopyOAM();
<br/>
<br/>
}
<br/>
}</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#6448 - Daedro - Mon May 26, 2003 2:44 am</h4>
    <div class="postbody"><span class="postbody">I woudly really like this answered too.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#6452 - Quirky - Mon May 26, 2003 8:09 am</h4>
    <div class="postbody"><span class="postbody">One way to do it would be to add an interrupt on vblank, count the number of game frames and then animate in the main loop every X frames. I assume that you have loaded just 1 frame into OAM? Well, what you need to do is load the next animation frame in on the next loop.
<br/>
<br/>
Read one of the interrupt tutorials, but basically something like this to set the interrupts up:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
int game_frames;
<br/>
void init_interrupts(void) {
<br/>
  REG_IME = 0x00;                       // Disable interrupts 
<br/>
  REG_INTERUPT = (u32)IRQHandler;    // interrupt function address 
<br/>
  REG_IE = INT_VBLANK;   // enable vblank interrupt only
<br/>
  REG_IF = 0x00;
<br/>
  REG_DISPSTAT = 0x8;      // bit 3, display vblank intrpt
<br/>
  REG_IME = 0x01;
<br/>
  game_frames = 0;
<br/>
}
<br/>
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Then you need to add the code to handle interrupts :
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
void IRQHandler(void) {
<br/>
 
<br/>
  REG_IME = 0x00;     // Disable interrupts 
<br/>
  u16 Int_Flag; 
<br/>
  Int_Flag = REG_IF; // Read the interrupt flags
<br/>
  
<br/>
  if (Int_Flag == INT_VBLANK) {
<br/>
    game_frames++;
<br/>
    
<br/>
  }
<br/>
  
<br/>
    
<br/>
  REG_IME = 0x1;                  // Enable interrupts
<br/>
  REG_IF = Int_Flag;              // Write back the interrupt flags  
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Finally, in your main game loop, do something like this:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
int spriteFrame = 0;
<br/>
while(1)
<br/>
{ 
<br/>
  GetInput();
<br/>
  MoveSprite(&amp;sprites[0],x,y); 
<br/>
  // choose a number here, 20 might look rubbish 
<br/>
  if (game_frame == 20) {
<br/>
    SetSpriteFrame(&amp;sprites[0], spriteFrame);
<br/>
  }
<br/>
  WaitForVsync(); 
<br/>
  CopyOAM();
<br/>
}
<br/>
<br/>
<br/>
void SetSpriteFrame(OAMEntry* sp, int frame) {
<br/>
  
<br/>
  // load the next animation frame... 
<br/>
  // 768 is the size of 1 frame, probably :)
<br/>
  int loop;
<br/>
  int offset = 768*frame;
<br/>
  for(loop = 0; loop &lt; 768; loop++)  {
<br/>
    OAMdata[loop] = spred_sprite_pak[offset+loop];
<br/>
  }
<br/>
  
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
That assumes you have your sprite data set up so that you have 1 frame in the first 768 bytes (?)
<br/>
<br/>
Play around with it though, it should at least give you some ideas...</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
