<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Background Problems? - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>Coding > Background Problems?</h2>
<div id="posts">
<div class="post">
    <h4>#51650 - lewisrevill - Mon Aug 22, 2005 6:19 pm</h4>
    <div class="postbody"><span class="postbody">Hey guys
<br/>
<br/>
Im programming in Mode 4 and having trouble displaying my background.  Its dispays ok but you can see it being drawn and i want it to be instant.  I just using "Frontbuffer" and a loop to display a backround.h file.  Please can you help - Thank you</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#51657 - tepples - Mon Aug 22, 2005 7:54 pm</h4>
    <div class="postbody"><span class="postbody">There are two frame buffers in mode 4. If you want something to appear instantly, you'll have to 1. draw your image to the buffer that you're not displaying and then 2. use the page bit in DISPCNT to switch to the image you just drew.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#51726 - headspin - Tue Aug 23, 2005 5:17 am</h4>
    <div class="postbody"><span class="postbody">Use DMACopy() instead of a loop to get an instant display of the image.<br/>_________________<br/><a class="postlink" href="http://headsoft.com.au/index.php?category=warhawk" target="_blank">Warhawk DS</a> | <a class="postlink" href="http://headsoft.com.au/index.php?category=mmll" target="_blank">Manic Miner: The Lost Levels</a> | <a class="postlink" href="http://headsoft.com.au/index.php?category=tdg" target="_blank">The Detective Game</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#51744 - poslundc - Tue Aug 23, 2005 6:38 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>headspin wrote:</b></span></td> </tr> <tr> <td class="quote">Use DMACopy() instead of a loop to get an instant display of the image.</td> </tr></table><span class="postbody">
<br/>
<br/>
How d'you figure?
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#51745 - yamaneko - Tue Aug 23, 2005 7:26 am</h4>
    <div class="postbody"><span class="postbody">Macro for the bits seting:
<br/>
#define DMA_ENABLE 0x80000000
<br/>
#define DMA_INTERUPT_ENABLE 0x40000000
<br/>
#define DMA_TIMEING_IMMEDIATE 0x00000000
<br/>
#define DMA_TIMEING_VBLANK 0x10000000
<br/>
#define DMA_TIMEING_HBLANK 0x20000000
<br/>
#define DMA_TIMEING_SYNC_TO_DISPLAY 0x30000000
<br/>
#define DMA_16 0x00000000
<br/>
#define DMA_32 0x04000000
<br/>
#define GAME_PACK 0x08000000
<br/>
#define DMA_REPEATE 0x02000000
<br/>
#define DMA_SOURCE_INCREMENT 0x00000000
<br/>
#define DMA_SOURCE_DECREMENT 0x00800000
<br/>
#define DMA_SOURCE_FIXED 0x01000000
<br/>
#define DMA_DEST_INCREMENT 0x00000000
<br/>
#define DMA_DEST_DECREMENT 0x00200000
<br/>
#define DMA_DEST_FIXED 0x00400000
<br/>
#define DMA_DEST_RELOAD 0x00600000
<br/>
<br/>
Some DMA register:
<br/>
#define REG_DM3SAD     *(volatile u32*)0x40000D4
<br/>
#define REG_DM3SAD_L   *(volatile u16*)0x40000D4
<br/>
#define REG_DM3SAD_H   *(volatile u16*)0x40000D6
<br/>
#define REG_DM3DAD     *(volatile u32*)0x40000D8
<br/>
#define REG_DM3DAD_L   *(volatile u16*)0x40000D8
<br/>
#define REG_DM3DAD_H   *(volatile u16*)0x40000DA
<br/>
#define REG_DM3CNT     *(volatile u32*)0x40000DC
<br/>
#define REG_DM3CNT_L   *(volatile u16*)0x40000DC
<br/>
#define REG_DM3CNT_H   *(volatile u16*)0x40000DE
<br/>
<br/>
The function:
<br/>
#define DMACopy(src,dest,count)\
<br/>
REG_DM3SAD = (u32)src;\ 
<br/>
REG_DM3DAD = (u32)dest;\
<br/>
REG_DM3CNT = count | DMA_ENABLE | DMA_TIMEING_IMMEDIATE | DMA_32;\
<br/>
while(REG_DM3CNT_H &amp; 0x8000);\</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#51779 - strager - Tue Aug 23, 2005 1:07 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>yamaneko wrote:</b></span></td> </tr> <tr> <td class="quote">The function:
<br/>
#define DMACopy(src,dest,count)\
<br/>
REG_DM3SAD = (u32)src;\ 
<br/>
REG_DM3DAD = (u32)dest;\
<br/>
REG_DM3CNT = count | DMA_ENABLE | DMA_TIMEING_IMMEDIATE | DMA_32;\
<br/>
while(REG_DM3CNT_H &amp; 0x8000);\</td> </tr></table><span class="postbody">
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#define DMACopy(src,dst,siz) { \
<br/>
REG_DM3SAD = (u32)(src); \
<br/>
REG_DM3DAD = (u32)(dst); \
<br/>
REG_DM3CNT = ((siz) &gt;&gt; 1) | DMA_ENABLE | \
<br/>
DMA_TIMING_IMMEDIATE | DMA_32; \
<br/>
}
<br/>
<br/>
#define DMACopyWait(src,dst,siz) {
<br/>
DMACopy(src, dst, siz); \
<br/>
while(REG_DM3CNT &amp; DMA_ENABLE) \
<br/>
    /* Wait */ \
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
This copies an array of [siz] size from [src] to [dst].  [siz] is the actual array size in bytes (but only bits 1-15 are used).
<br/>
<br/>
Copy from your buffer to the display, with buffer swapping:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">// VBlank code, should work (pseudo)
<br/>
static u16 *back_buffer = (u16 *)(0x06000000);
<br/>
<br/>
// ...
<br/>
<br/>
DISP_CNT ^= BUFFER_FLIP; // Flip render buffer
<br/>
<br/>
DMACopy(my_display_buffer, back_buffer, 240 * 160); // Copy to the back buffer
<br/>
<br/>
back_buffer = (u16 *)((u32)back_buffer ^ 0x0000A000); // Set the new back buffer for the next VBlank
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#51844 - lewisrevill - Tue Aug 23, 2005 10:51 pm</h4>
    <div class="postbody"><span class="postbody">Hey guys ive tried that double buffer but when the backbuffer is displayed it has a section of the image messed up!  Also it wasnt an instant transition!  Could someone please display some code including registers for double buffering? Thanks</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#51870 - yamaneko - Wed Aug 24, 2005 6:33 am</h4>
    <div class="postbody"><span class="postbody">//Some register for the flip function
<br/>
#define DISP_CR	*(u16*)0x4000000
<br/>
#define BACKBUFFER	0x10
<br/>
<br/>
//There are the diferent register of video memory
<br/>
//All the time write in VideoBuffer!
<br/>
u16		*VideoBuffer = (u16*)0x6000000;
<br/>
u16		*VideoFrontBuffer = (u16*)0x6000000;
<br/>
u16		*VideoBackBuffer = (u16*)0x600a000;
<br/>
<br/>
<br/>
//Function for swap buffer
<br/>
void Flip(){
<br/>
	if (DISP_CR &amp; BACKBUFFER){
<br/>
		DISP_CR &amp;= ~BACKBUFFER;
<br/>
		VideoBuffer = VideoBackBuffer;
<br/>
	}
<br/>
	else {
<br/>
		DISP_CR |= BACKBUFFER;
<br/>
		VideoBuffer = VideoFrontBuffer;
<br/>
	}
<br/>
}
<br/>
<br/>
<br/>
#define SCREEN_MOD4_SIZE32  9600//size(in long 240*160/4) of screen in mod4
<br/>
<br/>
//Main function
<br/>
int main(void)
<br/>
{
<br/>
     Flip();
<br/>
     DMACopy(your_src,VideoBuffer,SCREEN_MOD4_SIZE32);
<br/>
}</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#51971 - LOst? - Thu Aug 25, 2005 4:39 am</h4>
    <div class="postbody"><span class="postbody">Wow, if I got this much help when I first came here, I would have made a game already, lol.<br/>_________________<br/><span style="font-style: italic">Exceptions are fun</span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#51976 - yamaneko - Thu Aug 25, 2005 6:16 am</h4>
    <div class="postbody"><span class="postbody">Sorry Lost I was not here. :)<br/>_________________<br/>山猫</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
