<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Funny Behavior with -mthumb - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>Coding > Funny Behavior with -mthumb</h2>
<div id="posts">
<div class="post">
    <h4>#44842 - jormundgard - Sun Jun 05, 2005 11:08 pm</h4>
    <div class="postbody"><span class="postbody">Hi, I'm new to the forum.
<br/>
<br/>
I'm trying to do some simple GBA work on the Mac and, I guess for the heck of it, tried to build my own gcc compiler. I did manage to set something up that works (on the Boycott emulator at least). I used Jeff Frohwein's crt0.S bootstrap(?) and just tried a simple program that draws a pixel in the center of the screen.
<br/>
<br/>
Anyway, the program works fine if I compile and assemble everything without the -mthumb tag (and with -mthumb-interwork, if it's relevant). But when I also use the -mthumb tag, which I figured was a good idea, the emulator accepts the rom but the pixel isn't drawn. Does anyone have an idea what I could be doing wrong? Did I build a bad gcc, or is there maybe another mistake somewhere?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#44843 - strager - Sun Jun 05, 2005 11:13 pm</h4>
    <div class="postbody"><span class="postbody">Are you compiling the crt0 script with the -mthumb command?  That may be the problem, but I'm not too sure.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#44844 - jormundgard - Sun Jun 05, 2005 11:21 pm</h4>
    <div class="postbody"><span class="postbody">That was my first guess too. But it seems to happen even if I only use -mthumb on the C code. I'm just using -mthumb-interwork with the assember and crt0.
<br/>
<br/>
Oh, BTW, in case it's relevant, the C code is just a simple main() function, with some helper functions listed in Jeff F's crt0.S text readme. I admit that I don't really know exactly what's going on, and am mostly feeling my way through right now :).</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#44846 - strager - Sun Jun 05, 2005 11:38 pm</h4>
    <div class="postbody"><span class="postbody">Try to do a -save-temps and see if the output is ligit.  Usually the instructions leek, and that's why I prefer ARM code.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#44847 - SmileyDude - Sun Jun 05, 2005 11:44 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>strager wrote:</b></span></td> </tr> <tr> <td class="quote">Are you compiling the crt0 script with the -mthumb command?  That may be the problem, but I'm not too sure.</td> </tr></table><span class="postbody">
<br/>
<br/>
The crt0.s file is written in assembly -- compiling it in thumb mode or not doesn't make any difference, since the code in the file specifies what mode it is.
<br/>
<br/>
Can you post the code that you're trying to compile along with the commands you use to compile, link, and build the .gba file?<br/>_________________<br/>dennis</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#44848 - strager - Sun Jun 05, 2005 11:50 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>SmileyDude wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>strager wrote:</b></span></td> </tr> <tr> <td class="quote">Are you compiling the crt0 script with the -mthumb command?  That may be the problem, but I'm not too sure.</td> </tr></table><span class="postbody">
<br/>
<br/>
The crt0.s file is written in assembly -- compiling it in thumb mode or not doesn't make any difference, since the code in the file specifies what mode it is.</span></td> </tr></table><span class="postbody">
<br/>
<br/>
I know that, but just to make sure... :-)
<br/>
<br/>
And yes, the source and Makefile would help.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#44850 - jormundgard - Mon Jun 06, 2005 12:09 am</h4>
    <div class="postbody"><span class="postbody">Here's the Makefile (hopefully it's OK to just post it directly):
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
ARMCC = arm-thumb-elf-gcc
<br/>
ARMAS = arm-thumb-elf-as
<br/>
ARMLD = arm-thumb-elf-ld
<br/>
CFLAGS = -c -mthumb-interwork
<br/>
ASFLAGS = -mthumb-interwork
<br/>
LDFLAGS = --script lnkscript
<br/>
<br/>
all: HelloWorld.gba
<br/>
<br/>
HelloWorld.gba: HelloWorld.elf
<br/>
        arm-thumb-elf-objcopy -O binary HelloWorld.elf HelloWorld.gba
<br/>
<br/>
HelloWorld.elf: HelloWorld.o crt0.o
<br/>
        $(ARMLD) $(LDFLAGS) -o HelloWorld.elf HelloWorld.o crt0.o
<br/>
<br/>
HelloWorld.o: HelloWorld.c
<br/>
        $(ARMCC) $(CFLAGS) -o HelloWorld.o HelloWorld.c
<br/>
<br/>
crt0.o: crt0.S
<br/>
        $(ARMAS) $(ASFLAGS) -o crt0.o crt0.S
<br/>
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
And here's the main.c
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
typedef   unsigned int   u32;
<br/>
#define IN_IWRAM __attribute__ ((section (".iwram")))
<br/>
extern u32 __FarFunction (u32 (*ptr)(), ...);  // Reference to routine in crt0.S
<br/>
extern void __FarProcedure (void (*ptr)(), ...);  // Reference to routine in crt
<br/>
0.S
<br/>
// u32 IWRAMCode (u32 *FuncAddr, int param1, int param2) IN_IWRAM;
<br/>
<br/>
<br/>
int main(void)
<br/>
{
<br/>
  // Create pointer to VRAM
<br/>
  unsigned short* videoBuffer = (unsigned short*) 0x6000000;
<br/>
<br/>
  // Setup Video Mode 3
<br/>
  *(unsigned long*) 0x4000000 = (0x3 | 0x800);
<br/>
<br/>
  // Draw a white pixel centered on the screen
<br/>
  videoBuffer[240 * 80 + 120] = 0xFFFF;
<br/>
<br/>
  // Loop until power-down
<br/>
  while(1);
<br/>
  return 0;
<br/>
}
<br/>
<br/>
<br/>
u32 IWRAMCode (u32 *FuncAddr, u32 param1, u32 param2)
<br/>
{
<br/>
  u32 SomeValue;
<br/>
      // Note: The first parameter for this function MUST be
<br/>
      //  the *FuncAddr. Do NOT remove this parameter even
<br/>
      //  though you probably may not need it.
<br/>
<br/>
   return (SomeValue);
<br/>
 }
<br/>
<br/>
<br/>
 void AgbMain (void)
<br/>
 {
<br/>
   u32 ReturnValue = __FarFunction (IWRAMCode, 1, 2);
<br/>
 }
<br/>
</td> </tr></table><span class="postbody">
<br/>
(Basically cribbed from Jonathan Harbor's tutorial)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#44853 - jormundgard - Mon Jun 06, 2005 12:19 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>strager wrote:</b></span></td> </tr> <tr> <td class="quote">Try to do a -save-temps and see if the output is ligit.  Usually the instructions leek, and that's why I prefer ARM code.</td> </tr></table><span class="postbody">
<br/>
<br/>
I'm nowhere near literate in ARM assembly, so I can't say much, but at the least I can see that my builds are definitely producing 32 bit ARM code without the -mthumb flag (or at least, there are no .code 16 statements), and 16 bit Thumb code with the flag. I figure that the emulator is fine, so I will try to take a closer look at the assembly output.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#44893 - jormundgard - Mon Jun 06, 2005 4:52 pm</h4>
    <div class="postbody"><span class="postbody">I noticed that some of my C libraries don't seem to support -mthumb-interwork and, for all I know, may have been compiled as ARM code (meaning that I may have bungled the build). Would this simple program use any of the C libraries? Does every C program use the libraries in some way? Or does my confusion run even deeper than all this?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#45049 - Cearn - Tue Jun 07, 2005 9:32 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>jormundgard wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">  // Setup Video Mode 3 
<br/>
  *(unsigned long*) 0x4000000 = (0x3 | 0x800); </td> </tr></table><span class="postbody"></span></td> </tr></table><span class="postbody">
<br/>
Background 2 is 0x0400, not 0x0800, so you might want to try that. Or even better, create a list of defines as raw numbers can be confusing. For interworking libraries, I think it's necessary to include -mthumb-interwork to the linker flags as well.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#45074 - jormundgard - Tue Jun 07, 2005 2:30 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Cearn wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
Background 2 is 0x0400, not 0x0800, so you might want to try that. Or even better, create a list of defines as raw numbers can be confusing. For interworking libraries, I think it's necessary to include -mthumb-interwork to the linker flags as well.</td> </tr></table><span class="postbody">
<br/>
<br/>
My linker doesn't even seem to accept the -mthumb-interwork tag. Maybe that's just because it isn't producing any new assembly code, so doesn't need it. But could there also be a problem with my linker?
<br/>
<br/>
(PS thanks for mentioning the DISPCNT error)</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
