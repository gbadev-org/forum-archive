<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Loading a linear framebuffer into Vram - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>Coding > Loading a linear framebuffer into Vram</h2>
<div id="posts">
<div class="post">
    <h4>#7715 - wizardgsz - Mon Jun 23, 2003 2:18 pm</h4>
    <div class="postbody"><span class="postbody">Has someone got a fast routine to load a linear framebuffer into OBJ/BG Vram?
<br/>
This silly C implementation takes so many cycles:(
<br/>
<br/>
Hear you soon!
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
void CopyFromLinearBuffer( u16* a_Dest, u16* a_Source, u32 a_WidthInBlocks, u32 a_HeightInBlocks )
<br/>
{
<br/>
   // Dummy counters;
<br/>
   u32 x, y;
<br/>
<br/>
   // Source data pointers to the 8x8 block
<br/>
   u16 *s0, *s1, *s2, *s3, *s4, *s5, *s6, *s7;
<br/>
<br/>
   // Calculate the number of 16 bit halfwords for each image row
<br/>
   u32 widthInHalfwords = a_WidthInBlocks &lt;&lt; 3 &gt;&gt; 1;
<br/>
<br/>
   // Let's start from the first upper-left block
<br/>
   for ( y = 0; y &lt; a_HeightInBlocks; y++ )
<br/>
   {
<br/>
      s0 = &amp;a_Source[ widthInHalfwords * y * 8 ];
<br/>
      s1 = s0 + widthInHalfwords;
<br/>
      s2 = s1 + widthInHalfwords;
<br/>
      s3 = s2 + widthInHalfwords;
<br/>
      s4 = s3 + widthInHalfwords;
<br/>
      s5 = s4 + widthInHalfwords;
<br/>
      s6 = s5 + widthInHalfwords;
<br/>
      s7 = s6 + widthInHalfwords;
<br/>
<br/>
      // Process the entire 8x8 block
<br/>
      for ( x = 0; x &lt; a_WidthInBlocks; x++ )
<br/>
      {
<br/>
         *a_Dest++ = *s0++;
<br/>
         *a_Dest++ = *s0++;
<br/>
         *a_Dest++ = *s0++;
<br/>
         *a_Dest++ = *s0++;
<br/>
<br/>
         *a_Dest++ = *s1++;
<br/>
         *a_Dest++ = *s1++;
<br/>
         *a_Dest++ = *s1++;
<br/>
         *a_Dest++ = *s1++;
<br/>
<br/>
         *a_Dest++ = *s2++;
<br/>
         *a_Dest++ = *s2++;
<br/>
         *a_Dest++ = *s2++;
<br/>
         *a_Dest++ = *s2++;
<br/>
<br/>
         *a_Dest++ = *s3++;
<br/>
         *a_Dest++ = *s3++;
<br/>
         *a_Dest++ = *s3++;
<br/>
         *a_Dest++ = *s3++;
<br/>
<br/>
         *a_Dest++ = *s4++;
<br/>
         *a_Dest++ = *s4++;
<br/>
         *a_Dest++ = *s4++;
<br/>
         *a_Dest++ = *s4++;
<br/>
<br/>
         *a_Dest++ = *s5++;
<br/>
         *a_Dest++ = *s5++;
<br/>
         *a_Dest++ = *s5++;
<br/>
         *a_Dest++ = *s5++;
<br/>
<br/>
         *a_Dest++ = *s6++;
<br/>
         *a_Dest++ = *s6++;
<br/>
         *a_Dest++ = *s6++;
<br/>
         *a_Dest++ = *s6++;
<br/>
<br/>
         *a_Dest++ = *s7++;
<br/>
         *a_Dest++ = *s7++;
<br/>
         *a_Dest++ = *s7++;
<br/>
         *a_Dest++ = *s7++;
<br/>
      }
<br/>
   }
<br/>
}
<br/>
</td> </tr></table><span class="postbody"><br/>_________________<br/><a href="http://www.geocities.com/gabriele_scibilia/" target="_blank">http://www.geocities.com/gabriele_scibilia/</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#7716 - niltsair - Mon Jun 23, 2003 2:23 pm</h4>
    <div class="postbody"><span class="postbody">Use Dma. There's plenty of example about it on this site, just make a search on it.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#7717 - wizardgsz - Mon Jun 23, 2003 2:27 pm</h4>
    <div class="postbody"><span class="postbody">Dma or cpuCopy swi call for 8 byte?
<br/>
I thought it was expensive to set up a Dma copy for it.
<br/>
<br/>
Many thanks
<br/>
Ga<br/>_________________<br/><a href="http://www.geocities.com/gabriele_scibilia/" target="_blank">http://www.geocities.com/gabriele_scibilia/</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#7718 - niltsair - Mon Jun 23, 2003 2:32 pm</h4>
    <div class="postbody"><span class="postbody">There's at least 8x8Bytes to copy for a Tile.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#7721 - wizardgsz - Mon Jun 23, 2003 3:45 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>niltsair wrote:</b></span></td> </tr> <tr> <td class="quote">There's at least 8x8Bytes to copy for a Tile.</td> </tr></table><span class="postbody">
<br/>
<br/>
Yeah! but since I'm copying from a linear framebuffer there are 8 non-consecutive rows (8bytes a row) to be considered. Am I wrong:-?
<br/>
Set up 8 Dma-copies can be slower than a simple 4halfwords copy repeated for 8 times (one per row). Can't it?<br/>_________________<br/><a href="http://www.geocities.com/gabriele_scibilia/" target="_blank">http://www.geocities.com/gabriele_scibilia/</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#7722 - niltsair - Mon Jun 23, 2003 3:53 pm</h4>
    <div class="postbody"><span class="postbody">They all seem to be consecutive.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#7723 - wizardgsz - Mon Jun 23, 2003 3:58 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>niltsair wrote:</b></span></td> </tr> <tr> <td class="quote">They all seem to be consecutive.</td> </tr></table><span class="postbody">
<br/>
<br/>
Ehm, since the routine above works...
<br/>
it copies 4 halfwords from different rows (8) within a linear framebuffer into a consecutive 64byte tile/block (in Vram).
<br/>
The source isn't consecutive memory.
<br/>
<br/>
I'm certainly missing something, excuse me;)
<br/>
<br/>
Ga<br/>_________________<br/><a href="http://www.geocities.com/gabriele_scibilia/" target="_blank">http://www.geocities.com/gabriele_scibilia/</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#7731 - tepples - Mon Jun 23, 2003 6:15 pm</h4>
    <div class="postbody"><span class="postbody">OP is trying to copy from a linear framebuffer to a tile-based framebuffer. Such a copy does not take place in "consecutive memory".<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#7752 - Paul Shirley - Tue Jun 24, 2003 12:06 am</h4>
    <div class="postbody"><span class="postbody">removed</span><span class="gensmall"><br/><br/>Last edited by Paul Shirley on Sun Mar 28, 2004 10:04 pm; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#7759 - wizardgsz - Tue Jun 24, 2003 7:20 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
1: use u32's instead of u16's in the copy, less instructions -&gt; faster code
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Can I use 32 bit access to Vram?
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
This is a classic piece of code that will be dramatically easier to write well in assembler.</td> </tr></table><span class="postbody">
<br/>
<br/>
Well, my asm skill is about zero:)
<br/>
Many thanks for your precious suggestions.<br/>_________________<br/><a href="http://www.geocities.com/gabriele_scibilia/" target="_blank">http://www.geocities.com/gabriele_scibilia/</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#7761 - Paul Shirley - Tue Jun 24, 2003 8:59 am</h4>
    <div class="postbody"><span class="postbody">removed</span><span class="gensmall"><br/><br/>Last edited by Paul Shirley on Sun Mar 28, 2004 10:04 pm; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#7957 - wizardgsz - Sun Jun 29, 2003 1:17 pm</h4>
    <div class="postbody"><span class="postbody">I'm glad to read your tips.
<br/>
I received a fast ldmia/stmia implementation working 8byte by 8byte (8 ldmia/stdmia), I edited a little to work 16byte a time (four 32-bit registers, 4 load&amp;stores). I'll try to figure out how use 8 registers and do it with 2 sets of load&amp;stores as suggested, thank you again!<br/>_________________<br/><a href="http://www.geocities.com/gabriele_scibilia/" target="_blank">http://www.geocities.com/gabriele_scibilia/</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#7972 - wizardgsz - Sun Jun 29, 2003 6:32 pm</h4>
    <div class="postbody"><span class="postbody">Excuse me again, I hope I'm working on the right direction.
<br/>
<br/>
I properly setted up a 64bytes block-copy (rows 0-3 first, 4-7 then), is it the way you suggested?
<br/>
I got about 14% of cpu time for a full screen 240x160 image.
<br/>
This code is necessarily explanatory, repeat this 2 times for a full 8*8 block:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
@ source:   r14 = the start of the linear buffer
<br/>
@ dest:     r1  = the start of the tileset in vram
<br/>
@ width:    r2  = the width of the buffer in pixels
<br/>
<br/>
ldmia   r14,{r5, r6}        @ load 8 bytes from iwram
<br/>
add     r14,r14, r2         @ increase the source pointer with "width" bytes
<br/>
ldmia   r14,{r7, r8}        @ load 8 bytes from iwram
<br/>
add     r14,r14, r2         @ increase the source pointer with "width" bytes
<br/>
ldmia   r14,{r9, r10}       @ load 8 bytes from iwram
<br/>
add     r14,r14, r2         @ increase the source pointer with "width" bytes
<br/>
ldmia   r14,{r11,r12}       @ load 8 bytes from iwram
<br/>
stmia   r1!,{r5 -r12}       @ store 32 bytes in vram, and writeback the pointer
<br/>
add     r14,r14, r2         @ increase the source pointer with "width" bytes
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I have to thanks all the readers!<br/>_________________<br/><a href="http://www.geocities.com/gabriele_scibilia/" target="_blank">http://www.geocities.com/gabriele_scibilia/</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#7975 - Paul Shirley - Sun Jun 29, 2003 7:15 pm</h4>
    <div class="postbody"><span class="postbody">removed</span><span class="gensmall"><br/><br/>Last edited by Paul Shirley on Sun Mar 28, 2004 10:04 pm; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#8247 - wizardgsz - Sat Jul 05, 2003 10:40 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
Getting there, you can improve it substantially by allocating 4 source pointers and using writeback mode in the ldmia. Remember: you've got a lot of registers to play with so use them. 
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Yeahh!! That's could be really a speed up, I cannot imagine how asm could speed your work up.
<br/>
<br/>
Today I'm trying to modify my routine using your new hint... withous success anyway:(
<br/>
<br/>
First, I haven't got 3 registers left and I'm running out of registers for the loop counters (across width and height).
<br/>
Well, I don't know asm very well (I know it absolutely nothing), excuse me.
<br/>
Anyhow I'm trying to write just a "row" of tiles but I got weird stuffs; the source pointers point something else they should.
<br/>
The loop itself works (I verified it with imaginary 32bit values assigned myself without the ldmia instructionS, just some ldr xx, =((150)+(150&lt;&lt;8)+(150&lt;&lt;16)+(150&lt;&lt;24))) but using ldmia it loads (and stores then) trash.
<br/>
<br/>
Assuming such a prototype
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
void Copy( u32* source, u32* dest, u32 width, u32 height );
<br/>
@ source:   r0 = the start of the linear buffer in iwram
<br/>
@ dest:     r1 = the start of the sprite in vram
<br/>
@ width:    r2 = the width of the iwram buffer in pixels
<br/>
@ height:   r3 = the height of the iwram buffer in pixels
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I'm trying with
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
        @ r11 source pointer
<br/>
        @ r12 destination pointer
<br/>
<br/>
            mov     r11,r0
<br/>
            mov     r12,r1
<br/>
<br/>
        @ r14 indicates how many pixels to copy per line
<br/>
        @ r3 indicates how many lines of pixels to copy
<br/>
<br/>
            mov     r14,r2
<br/>
<br/>
<br/>
        CopyNextRow:
<br/>
<br/>
        @ r8,r9,r10,r11 source row pointers for row,row+1,row+2,row+3
<br/>
<br/>
            mov     r8, r11
<br/>
            add     r9, r8, r14
<br/>
            add     r10,r9, r14
<br/>
            add     r11,r10,r14
<br/>
<br/>
        Copy8x8Block:
<br/>
<br/>
        @ Copy a 8*8 block from the linear buffer to vram
<br/>
        @ r0-r7 working store for half a char
<br/>
<br/>
            ldmia   r8!, {r0-r1}        @ load 8 bytes from iwram, and writeback the pointer
<br/>
            ldmia   r9!, {r2-r3}        @ load 8 bytes from iwram, and writeback the pointer
<br/>
            ldmia   r10!,{r4-r5}        @ load 8 bytes from iwram, and writeback the pointer
<br/>
            ldmia   r11!,{r6-r7}        @ load 8 bytes from iwram, and writeback the pointer
<br/>
            stmia   r12!,{r0-r7}        @ store 32 bytes in  vram, and writeback the pointer
<br/>
<br/>
            ldmia   r8!, {r0-r1}        @ repeat this 2 times for a full 8*8 block
<br/>
            ldmia   r9!, {r2-r3}
<br/>
            ldmia   r10!,{r4-r5}
<br/>
            ldmia   r11!,{r6-r7}
<br/>
            stmia   r12!,{r0-r7}
<br/>
<br/>
        @ I need r14 from "row" to "row" so don't trash it!
<br/>
        @ I run out of registers
<br/>
<br/>
            subs    r14, r14, #8        @ Substract 8 from the total number of pixels to copy
<br/>
            bne     Copy8x8Block        @ Zero left?? then go to next row, else copy the next block
<br/>
<br/>
<br/>
@            subs    ??, ??, #8          @ Decrease the number of rows with 8
<br/>
@            beq     CopyEnd             @ Zero left?? then branch to end
<br/>
<br/>
@            b       CopyNextRow         @ Start the next row
<br/>
<br/>
        @ we're finished
<br/>
<br/>
        CopyEnd:
<br/>
</td> </tr></table><span class="postbody"><br/>_________________<br/><a href="http://www.geocities.com/gabriele_scibilia/" target="_blank">http://www.geocities.com/gabriele_scibilia/</a></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
