<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>The infamous scripting question - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>Coding > The infamous scripting question</h2>
<div id="posts">
<div class="post">
    <h4>#36460 - Kyoufu Kawa - Mon Feb 21, 2005 3:03 pm</h4>
    <div class="postbody"><span class="postbody">This post is no longer relevant. The problem described in it has been solved below.</span><span class="gensmall"><br/><br/>Last edited by Kyoufu Kawa on Sat Feb 26, 2005 4:21 pm; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#36462 - Kyoufu Kawa - Mon Feb 21, 2005 5:00 pm</h4>
    <div class="postbody"><span class="postbody">This post has been deprecated as well.</span><span class="gensmall"><br/><br/>Last edited by Kyoufu Kawa on Sat Feb 26, 2005 4:22 pm; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#36529 - Kyoufu Kawa - Wed Feb 23, 2005 6:34 pm</h4>
    <div class="postbody"><span class="postbody">It's done! All it needs now is simple math and subroutine support. I decided to post the thing in it's entirity to help others, being such a nice guy (ehem cough cough). Many thanks to Cearn for helping me out with this.
<br/>
<br/>
Most of the functions and variables referred to herein won't be available for you but the logic and math stuff's clear.
<br/>
<br/>
This goes in a .c file, ofcourse...
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#define   SC_NOP 0x00   // No parms
<br/>
#define   SC_VBLANK 0x01   // No parms
<br/>
#define   SC_IF 0x02   // u8 val u32 target
<br/>
#define   SC_IFTRUE 0x03   // u32 target
<br/>
#define   SC_GOTO 0x04   // u32 target
<br/>
#define   SC_SETPLOTFLAG 0x05   // u8 flag
<br/>
#define   SC_CLEARPLOTFLAG 0x06   // u8 flag
<br/>
#define   SC_CHECKPLOTFLAG 0x07   // u8 flag
<br/>
#define   SC_TEXT 0x10   // u32 text
<br/>
#define   SC_ERROR 0x11   // u32 text
<br/>
#define   SC_ASK 0x18   // u32 text u8 ccnt
<br/>
#define SC_WAITFORKEY 0x19 // No parms
<br/>
#define   SC_PLAYSONG 0x20   // u16 song
<br/>
#define   SC_STOPSONG 0x21   // No parms
<br/>
#define   SC_PLAYSOUND 0x22   // u16 song
<br/>
#define   SC_REVEALCGPIC 0x23   // u8 pic
<br/>
#define   SC_SHOWPICTURE 0x24   // u8 pic
<br/>
#define   SC_HALTANIMATION 0x25   // No parms
<br/>
#define   SC_FADE   0x26   // u8 inout
<br/>
#define   SC_FLASH 0x27   // No parms
<br/>
#define GetScriptByte      MyByte   =  ScriptData[ScriptCursor++];
<br/>
#define GetScriptHWord   MyHWord   =  ScriptData[ScriptCursor++];            \
<br/>
                                    MyHWord   |= ScriptData[ScriptCursor++] &lt;&lt; 8;
<br/>
#define GetScriptWord      MyWord   =  ScriptData[ScriptCursor++];            \
<br/>
                                    MyWord   |= ScriptData[ScriptCursor++] &lt;&lt; 8;      \
<br/>
                                    MyWord   |= ScriptData[ScriptCursor++] &lt;&lt; 16;   \
<br/>
                                    MyWord   |= ScriptData[ScriptCursor++] &lt;&lt; 24;
<br/>
<br/>
extern const u8 ScriptData[];
<br/>
u16 ScriptCursor;
<br/>
u8 SC_LastResult;
<br/>
void ScriptTick(void)
<br/>
{
<br/>
   u16* pal = (u16*)0x5000000;
<br/>
   u8 MyByte;
<br/>
   u16 MyHWord;
<br/>
   u32   MyWord;
<br/>
<br/>
   GetScriptByte;
<br/>
   WriteText(1,31,2,31,"Cmd:\nPC: \nLst:",0);
<br/>
   DrawNum(MyByte,5,2);
<br/>
   DrawNum(ScriptCursor,5,3);
<br/>
   DrawNum(SC_LastResult,5,4);
<br/>
   switch(MyByte)
<br/>
   {
<br/>
      case SC_NOP: break;
<br/>
      case SC_VBLANK:
<br/>
         DoVBlank();
<br/>
         break;
<br/>
      case SC_IF:
<br/>
         GetScriptByte;
<br/>
         GetScriptWord;
<br/>
         if(SC_LastResult == MyByte) ScriptCursor = MyWord - ((u32)ScriptData);
<br/>
         break;
<br/>
      case SC_IFTRUE:
<br/>
         GetScriptWord;
<br/>
         if(SC_LastResult) ScriptCursor = MyWord - ((u32)ScriptData);
<br/>
         break;
<br/>
      case SC_GOTO:
<br/>
         GetScriptWord;
<br/>
         ScriptCursor = MyWord - ((u32)ScriptData);
<br/>
         break;
<br/>
      case SC_SETPLOTFLAG:
<br/>
         GetScriptByte;
<br/>
         data.PlotFlags |= MyByte;
<br/>
         break;
<br/>
      case SC_CLEARPLOTFLAG:
<br/>
         GetScriptByte;
<br/>
         //TODO: Find proper bit operand to clear a bit.
<br/>
         break;
<br/>
      case SC_CHECKPLOTFLAG:
<br/>
         GetScriptByte;
<br/>
         SC_LastResult = (data.PlotFlags &amp; MyByte) ? 1 : 0;
<br/>
         //if(data.PlotFlags &amp; MyByte)
<br/>
         //   SC_LastResult = 1;
<br/>
         //else
<br/>
         //   SC_LastResult = 0;
<br/>
         break;
<br/>
      case SC_TEXT:
<br/>
         //DEBUG ONLY: Shouldn't be used in final script builds!
<br/>
         GetScriptWord;
<br/>
         WriteText(1,31,1,31,"                            ",0);
<br/>
         WriteText(1,31,1,31,(u8*)MyWord,0);
<br/>
         break;
<br/>
      case SC_ASK:
<br/>
         GetScriptWord;
<br/>
         GetScriptByte;
<br/>
         SC_LastResult = GetChoice((u8*)MyWord,MyByte);
<br/>
         break;
<br/>
      case SC_WAITFORKEY:
<br/>
         Trg = 0;
<br/>
         while(!(Trg &amp; A_BUTTON))
<br/>
         {
<br/>
            DoVBlank();
<br/>
            KeyRead();
<br/>
         }
<br/>
         break;
<br/>
      case SC_PLAYSONG:
<br/>
         GetScriptHWord;
<br/>
         PlaySong(MyHWord);
<br/>
         break;
<br/>
      case SC_STOPSONG:
<br/>
         PlaySong(0);
<br/>
         break;
<br/>
      case SC_PLAYSOUND:
<br/>
         GetScriptHWord;
<br/>
         m4aSongNumStart(MyHWord);
<br/>
         break;
<br/>
      case SC_REVEALCGPIC:
<br/>
         GetScriptByte;
<br/>
         data.ImageFlags |= MyByte;
<br/>
         break;
<br/>
      case SC_SHOWPICTURE:
<br/>
         GetScriptByte;
<br/>
         ShowPic(MyByte);
<br/>
         break;
<br/>
      case SC_HALTANIMATION:
<br/>
         nextPicTimer=0;
<br/>
         break;
<br/>
      case SC_FADE:
<br/>
         GetScriptByte;
<br/>
         switch(MyByte)
<br/>
         {
<br/>
            case 0: FadeOut(); break;
<br/>
            case 1: FadeIn(); break;
<br/>
            default: RaiseError("Invalid para-\nmeter for\nFADE.\n \n0 - out\n1 - in");
<br/>
         }
<br/>
         break;
<br/>
      case SC_FLASH:
<br/>
         Flash();
<br/>
         break;
<br/>
      default:
<br/>
         break;
<br/>
   }
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
Put this in a .s file...
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">   .section .rodata
<br/>
   .align   2
<br/>
<br/>
   .equ   NOP,      0x00   @ No parms
<br/>
   .equ   VBLANK,      0x01   @ No parms
<br/>
   .equ   IF,      0x02   @ u8 val u32 target
<br/>
   .equ   IFTRUE,      0x03   @ u32 target
<br/>
   .equ   GOTO,      0x04   @ u32 target
<br/>
   .equ   SETPLOTFLAG,   0x05   @ u8 flag
<br/>
   .equ   CLEARPLOTFLAG,   0x06   @ u8 flag
<br/>
   .equ   CHECKPLOTFLAG,   0x07   @ u8 flag
<br/>
   .equ   TEXT,      0x10   @ u32 text
<br/>
   .equ   ERROR,      0x11   @ u32 text
<br/>
   .equ   ASK,      0x18   @ u32 text u8 ccnt
<br/>
   .equ   WAITFORKEY,   0x19   @ No parms
<br/>
   .equ   PLAYSONG,   0x20   @ u16 song
<br/>
   .equ   STOPSONG,   0x21   @ No parms
<br/>
   .equ   PLAYSOUND,   0x22   @ u16 song
<br/>
   .equ   REVEALCGPIC,   0x23   @ u8 pic
<br/>
   .equ   SHOWPICTURE,   0x24   @ u8 pic
<br/>
   .equ   HALTANIMATION,   0x25   @ No parms
<br/>
   .equ   FADE,      0x26   @ u8 inout
<br/>
   .equ   FLASH,      0x27   @ No parms
<br/>
   @ TODO: release this on GBADev.
<br/>
   @ TODO: think of a nice name for this little scripting language.
<br/>
   @ TODO: add simple math functions.
<br/>
   
<br/>
   .global ScriptData
<br/>
ScriptData:
<br/>
<br/>
SillyQuestionTest:
<br/>
   .byte   PLAYSONG
<br/>
    .short   0x0002
<br/>
   .byte   SHOWPICTURE
<br/>
    .byte   6
<br/>
   .byte   FADE
<br/>
    .byte   1
<br/>
AskIt:
<br/>
   .byte   ASK
<br/>
    .word   Questions
<br/>
    .byte   4
<br/>
   .byte   IF
<br/>
    .byte   1
<br/>
    .word   AnswerAChosen
<br/>
   .byte   IF
<br/>
    .byte   2
<br/>
    .word   AnswerBChosen
<br/>
   .byte   IF
<br/>
    .byte   3
<br/>
    .word   AnswerCChosen   
<br/>
   .byte   IF
<br/>
    .byte   4
<br/>
    .word   AnswerDChosen   
<br/>
   .byte   GOTO
<br/>
    .word   EndLoop
<br/>
AnswerAChosen:
<br/>
   .byte   TEXT
<br/>
    .word   AnswerAText
<br/>
   .byte   WAITFORKEY
<br/>
   .byte   GOTO
<br/>
    .word   EndLoop
<br/>
AnswerBChosen:
<br/>
   .byte   TEXT
<br/>
    .word   AnswerBText
<br/>
   .byte   WAITFORKEY
<br/>
   .byte   GOTO
<br/>
    .word   EndLoop
<br/>
AnswerCChosen:
<br/>
   .byte   TEXT
<br/>
    .word   AnswerCText
<br/>
   .byte   WAITFORKEY
<br/>
   .byte   GOTO
<br/>
    .word   EndLoop
<br/>
AnswerDChosen:
<br/>
   .byte   FADE
<br/>
    .byte   17   @ Fade can only go in (1) or out (0).
<br/>
EndLoop:
<br/>
   .byte   VBLANK
<br/>
   .byte   GOTO
<br/>
    .word   AskIt
<br/>
   
<br/>
Questions:   .asciz   "Answer A\nAnswer B\nFuck you!\nCause an error"
<br/>
AnswerAText:   .asciz   "You chose Answer A."
<br/>
AnswerBText:   .asciz   "You chose Answer B."
<br/>
AnswerCText:   .asciz   "Yo momma!"</td> </tr></table><span class="postbody">
<br/>
<br/>
Cearn, your turn to comment on this stuff ;)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#36569 - pollier - Thu Feb 24, 2005 7:56 pm</h4>
    <div class="postbody"><span class="postbody">I'm not Cearn, but I'd like to make comments anyways~
<br/>
<br/>
This is pretty cool and has some elegant compact code. However, the ask-a-question, do-an-if-test-4-times bit in the example seem like a waste of space; you might as well just build the gotos straight into the syntax of the SC_IF. 
<br/>
<br/>
You might like to have a SC_DELAY opcode too. And if you don't need too much math, you could have an opcode that takes a pointer to a regular C function and a few arguments, and calls it.
<br/>
<br/>
(Of course, if this was me writing the code, I'd be obsessed with compressing this as much as possible, packing my bits, but then I wouldn't be able to write it in assembly.)
<br/>
<br/>
Oh, and I think you can clear a bit by writing data.PlotFlags &amp;= !(u32)MyByte; .
<br/>
<br/>
In any case, this is a great little engine! Add some object animation support in there and your game'll look spectacular.
<br/>
<br/>
-Paul<br/>_________________<br/>(Works for me!)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#36570 - Kyoufu Kawa - Thu Feb 24, 2005 8:48 pm</h4>
    <div class="postbody"><span class="postbody">Thanks. I already figured out the bit clearing part by myself, added Script Memory (256 bytes worth of temporary variables) and some commands to use it.
<br/>
<br/>
Thanks for the suggestion on the multiple IFs, but I'm not you and like it this way. Add it yourself if you want to, see below. If by object animation you mean sprite manipulation support, that's not needed in my game - it uses full-screen FMV.
<br/>
<br/>
Anybody who needs a scripting engine and is too mushed in the head to write one may use this one under very non-limiting conditions.
<br/>
<br/>
1) Somewhere in the finished product must be a line that reads "<span style="font-style: italic">JESUS scripting engine by Kyoufu Kawa and Cearn</span>" or something to that effect.
<br/>
2) I want to know when, where and by who it's used.
<br/>
3) Any really cool additions would be nice to know of.
<br/>
<br/>
That's all really. Yes, the engine's called JESUS. It's an acronym you don't want to know the meaning of.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#36571 - sajiimori - Thu Feb 24, 2005 8:54 pm</h4>
    <div class="postbody"><span class="postbody">It's good that you started with hand-typed bytecode like that.  It really makes you focus on data requirements.
<br/>
<br/>
If you end up having lots of scripting to do, consider writing a compiler that will let you write scripts in a more structured and readable manner.  It's a very fun and challenging task if you haven't done it before.</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">function answerAChosen()
<br/>
   text("You chose Answer A.")
<br/>
   waitForKey()
<br/>
end
<br/>
<br/>
while 1 do
<br/>
   playSong(2)
<br/>
   showPicture(6)
<br/>
   fade(1)
<br/>
<br/>
   ask(
<br/>
     ["Answer A", answerAChosen],
<br/>
     ["Answer B", answerBChosen],
<br/>
     ["Darn you!", answerCChosen],
<br/>
     ["Cause an error", answerDChosen])
<br/>
     
<br/>
   vBlank()
<br/>
end</td> </tr></table><span class="postbody">Or choose your favorite syntax. ^_^</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#36572 - Kyoufu Kawa - Thu Feb 24, 2005 9:25 pm</h4>
    <div class="postbody"><span class="postbody">I would, but all I ever managed to write compiler-wise was Rubikon, for Pokemon Advance. Compilers fall under Rule Three ;)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#36573 - sajiimori - Thu Feb 24, 2005 9:42 pm</h4>
    <div class="postbody"><span class="postbody">I don't know what Rule Three is, but if you need any help I'd be happy to give you some tips (or even some source code).  With the right approach, compiler writing can be a very satisfying experience.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#36575 - Kyoufu Kawa - Thu Feb 24, 2005 9:50 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">3) Any really cool additions would be nice to know of. </td> </tr></table><span class="postbody">
<br/>
<br/>
That's rule three, and maybe I should rephrase that.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">3) Any really cool additions would be nice to <span style="font-style: italic">see</span>. </td> </tr></table><span class="postbody">
<br/>
<br/>
In other words, I can't write a compiler, but if you can provide at least a framework, that'd be very swell.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#36578 - sajiimori - Fri Feb 25, 2005 12:24 am</h4>
    <div class="postbody"><span class="postbody">Heheh... I wasn't looking for a project for myself.  It was just a suggestion for you.  ^_^  I can offer guidance, but if the motivation isn't there for you then I won't be of much use.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#36594 - Kyoufu Kawa - Fri Feb 25, 2005 2:29 pm</h4>
    <div class="postbody"><span class="postbody">Don't worry. That's what Google and stuff are for ;)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#36622 - AnthC - Sat Feb 26, 2005 4:59 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Kyoufu Kawa wrote:</b></span></td> </tr> <tr> <td class="quote">Being about halfway through writing a quite solid codebase for my game, I've been contemplating to write a reasonably simple scripting engine. It need not be too complex, but by now it's common knowledge that pointers don't like me and vice versa.
<br/>
<br/>
I thought I could just use an .s file full of .byte and .word statements with predefined (more like equ) commands and stuff...
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">.byte PLAYSOUND
<br/>
.byte 6
<br/>
.byte FADE
<br/>
.byte 0 @ fade in/out param
<br/>
.byte SHOWTEXT
<br/>
.word (some pointer thingy here)</td> </tr></table><span class="postbody">
<br/>
<br/>
&lt;ANTH : SNIP&gt;
<br/>
</span></td> </tr></table><span class="postbody">
<br/>
<br/>
Rather than going to ASM why not code these in C?
<br/>
I did a similar thing in Cauldron using some macros I wrote.
<br/>
<br/>
e.g.
<br/>
<br/>
#define SPEED(A) (U8)A_CMD_SPEED,(U8)(A),
<br/>
#define LOOPS(A) (U8)A_CMD_LOOPS,(U8)(A),
<br/>
#define SETFR(A) (U8)A_CMD_SETFR,(U8)(A),(U8)((A)&gt;&gt;8),
<br/>
<br/>
etc etc.
<br/>
<br/>
const U8 AnmWitchStirR[]=
<br/>
{
<br/>
	SPEED(8)
<br/>
	LOOPS(INFINATE)
<br/>
		SETFR(WITCHSTIR)
<br/>
		NEXTFR
<br/>
		NEXTFR
<br/>
	LOOPE
<br/>
};
<br/>
<br/>
&lt;EDIT : Just looked you have goto's which is a problem since you need labels to access them, ASM Macro's would do the equivalent and give you more flexibility - the main point of the macros is to avoid simple bugs creeping in&gt;
<br/>
<br/>
Anth</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#36787 - Kyoufu Kawa - Tue Mar 01, 2005 8:19 pm</h4>
    <div class="postbody"><span class="postbody">And now, allow me to present you the final 1.0 release of the JESUS scripting engine kit!
<br/>
<br/>
Zip contents:
<br/>
 * HEROD compiler (more like translator but hey)
<br/>
 * Sample script
<br/>
 * How to do loops, for the n00bs
<br/>
 * A bare-bones JESUS interpreter. Just the system commands, nearly nothing from my game left.
<br/>
<br/>
JESUS has:
<br/>
 * Subroutines, thanks to a crude stack of user-definable size
<br/>
 * No word-alignment issues.
<br/>
 * Reasonable speed.
<br/>
<br/>
Get it <a class="postlink" href="http://helmetedrodent.kickassgamers.com/Jesus%20SDK.zip" target="_blank">here</a>.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
