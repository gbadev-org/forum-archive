<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>[bonk] Gamepak mem, pointers and my fried brain..[/bonk] - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>Coding > [bonk] Gamepak mem, pointers and my fried brain..[/bonk]</h2>
<div id="posts">
<div class="post">
    <h4>#35000 - wbochar - Sat Jan 29, 2005 5:27 am</h4>
    <div class="postbody"><span class="postbody">Ok. Before the pointers guide's, the rtfm's and reading xyz. I looked and I have a headache and I have done soo many spins that I am not sure what is right or wrong.. Here is the deal..
<br/>
<br/>
Saving to gamepak memory.. I can save, but when I try to verfiy the data programattically it never works.. though after looking at the emu sav file its does save the header.. I know this is a pointer problem.. but I am not sure how to go about fixing it..
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
   u8 *pSaveMemory = GAMEPAK_RAM;
<br/>
   char *SaveHeader="KHSAVE";
<br/>
   int SaveHeaderGood;
<br/>
<br/>
   SaveHeaderGood=1;
<br/>
<br/>
   int i;
<br/>
<br/>
   // If there is no Save Game header Data create a high score table
<br/>
<br/>
   for (i=0;i&lt;strlen(SaveHeader);i++)
<br/>
   {
<br/>
   if ((u8)*pSaveMemory+i != *SaveHeader+i)
<br/>
   {
<br/>
      SaveHeaderGood=0;
<br/>
   }
<br/>
   }
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
this always returns false. I have tried what feels like everything, including the 1000's of monkeys tapping keys in case I get either the right combonation or the next great novel. 
<br/>
<br/>
Head hurts.. please help..</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#35001 - DekuTree64 - Sat Jan 29, 2005 5:51 am</h4>
    <div class="postbody"><span class="postbody">Hmm, I'm not positive, but that string may not actually be claiming stack space, and is overlapping with the SaveHeaderGood variable and getting overwritten. Try this:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">char SaveHeader[7]="KHSAVE";</td> </tr></table><span class="postbody">
<br/>
And if that doesn't help, try printing the data yoyu're checking on the screen so you can look at it, or just store them out in memory at some specific address so you can look at the values in VBA's memory viewer. Like, 
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">   for (i=0;i&lt;strlen(SaveHeader);i++) 
<br/>
   { 
<br/>
      // Save the values we're about to compare out in the middle of EWRAM
<br/>
   ((u8*)0x2010000)[i] = (u8)*pSaveMemory+i;
<br/>
   ((u8*)0x2010010)[i] = *SaveHeader+i;
<br/>
<br/>
   if ((u8)*pSaveMemory+i != *SaveHeader+i) 
<br/>
   { 
<br/>
      SaveHeaderGood=0; 
<br/>
   } 
<br/>
   } </td> </tr></table><span class="postbody"><br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#35004 - sajiimori - Sat Jan 29, 2005 7:19 am</h4>
    <div class="postbody"><span class="postbody">The pointer occupies the appropriate amount of stack space.
<br/>
<br/>
Unary * binds more tightly than +, so you are repeatedly reading the first char of each string.  If you mean array access, just use [].</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#35025 - wbochar - Sat Jan 29, 2005 3:27 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
u8 *pSaveMemory = GAMEPAK_RAM;
<br/>
   char SaveHeader[]="KHSAVE";
<br/>
   int SaveHeaderGood;
<br/>
   SaveHeaderGood=1;
<br/>
   int i;
<br/>
<br/>
   // If there is no Save Game Data create a high score table
<br/>
   for (i=0;i&lt;strlen(SaveHeader);i++)
<br/>
   {
<br/>
   if (pSaveMemory[i] != SaveHeader[i])
<br/>
   {
<br/>
      SaveHeaderGood=0;
<br/>
   }
<br/>
   }
<br/>
   
<br/>
   if(SaveHeaderGood==0)
<br/>
   {
<br/>
      //create a header (KHSAVE)
<br/>
      for (i=0;i&lt;strlen(SaveHeader);i++)
<br/>
      {
<br/>
         pSaveMemory[i]=SaveHeader[i];
<br/>
      }
<br/>
      //Load in bogus top 5 default highscores
<br/>
<br/>
   }
<br/>
   else
<br/>
   {
<br/>
   
<br/>
   pSaveMemory[0]=0x00;
<br/>
      
<br/>
   }
<br/>
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
this is the code from the suggestions.. it compiles but doesnt work. to see if the 'KHSAVE' is successfully found, I write a 0x00 to the start of mem (where the K is). So If I run  the program without a save or proper header it will create a new header -- if it is there, it will make it invalid with a 0x00 at the begining. I run the game, check to see that the sav file has the right text, then run it again to see if the code alters the header to show that it found the header.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#35047 - denopqrihg - Sat Jan 29, 2005 9:03 pm</h4>
    <div class="postbody"><span class="postbody">I don't know if this is the case, but gbatek says that code in ROM can't read from SRAM. So if your code is in ROM (which probably isn't), move it to IWRAM or somewhere.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#35107 - gb_feedback - Sun Jan 30, 2005 3:03 pm</h4>
    <div class="postbody"><span class="postbody">Strange, the code looks ok to me. Whenever this kind of thing happens I resort to desperate casting methods, like:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">   if ( (u8)pSaveMemory[i] != (u8)SaveHeader[i] ) 
<br/>
   { 
<br/>
      SaveHeaderGood=0; 
<br/>
   } 
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Always worth a try.<br/>_________________<br/><a class="postlink" href="http://www.bookreader.co.uk/" target="_blank">http://www.bookreader.co.uk/</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#35651 - Morloth - Tue Feb 08, 2005 11:57 pm</h4>
    <div class="postbody"><span class="postbody">Hi there,
<br/>
<br/>
I wrote a simple program to demonstrate what is going wrong, the problem is basically that you are dereferincing the pointer and than add i to the value it is refering to rather than the move the pointer and than dereference. Let me explain:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
*SaveHeader+i
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
What this does is this <span style="font-style: italic">(*SaveHeader) + i</span>; So it takes the first character the pointer points to "K", and add i to this character. Obviously this is not prefered. So you should use parantes like this:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
*(SaveHeader + i)
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
To let he pointer point to the next character and dereference this character. Take a look at the following application and try it for yourself :).
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#include &lt;iostream.h&gt;
<br/>
#include &lt;string.h&gt;
<br/>
#include &lt;stddef.h&gt;
<br/>
<br/>
int main(void) {
<br/>
<br/>
   typedef unsigned char u8;
<br/>
<br/>
   char *niceChar = "testing";
<br/>
<br/>
   size_t i;
<br/>
<br/>
   // Display the values
<br/>
   for (i = 0; i &lt; strlen(niceChar); i++)
<br/>
   {
<br/>
      cout &lt;&lt; *niceChar + i &lt;&lt;                  // Not good :x
<br/>
            ' ' &lt;&lt; *(niceChar + i) &lt;&lt; endl;         // Good :)
<br/>
   }
<br/>
<br/>
   return 0;
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
So basically I think your code should look something like this:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
...
<br/>
<br/>
for (i=0; i&lt;strlen(SaveHeader); i++)
<br/>
{
<br/>
   if (*(pSaveMemory+i) != *(SaveHeader+i))
<br/>
   {
<br/>
      SaveHeaderGood=0;
<br/>
   }
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
You may even want to use arrays, if you find it prettier:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
for (i=0; i&lt;strlen(SaveHeader); i++)
<br/>
{
<br/>
   if (*(u8*)pSaveMemory[i] != *(u8*)SaveHeader[i])
<br/>
   {
<br/>
      SaveHeaderGood=0;
<br/>
   }
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
In the last block of code I casted both points to a u8*, just to make sure C doesn't get confused with 2 different data types. I'm not sure if it's  necessary, but you can't be to sure =).
<br/>
<br/>
Hope it helps!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#35653 - sajiimori - Wed Feb 09, 2005 12:24 am</h4>
    <div class="postbody"><span class="postbody">Morloth, his revised code already used proper array indexing.
<br/>
<br/>
wbochar, your code looks fine to me too.  You're comparing u8s with chars, but that shouldn't cause a problem here.
<br/>
<br/>
Misc stuff: indent things that are inside braces, and use strcmp and strcpy instead of writing them inline.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">if(strcmp(pSaveMemory, SaveHeader))
<br/>
{
<br/>
  strcpy(pSaveMemory, SaveHeader);
<br/>
}
<br/>
else
<br/>
{
<br/>
  pSaveMemory[0] = 0;
<br/>
}
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#35675 - Morloth - Wed Feb 09, 2005 10:57 am</h4>
    <div class="postbody"><span class="postbody">sajiimori, you are right. I'm sorry, I obviously misread your post...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#36809 - wbochar - Wed Mar 02, 2005 1:28 am</h4>
    <div class="postbody"><span class="postbody">This is really getting on my nerves.. 
<br/>
<br/>
I can write data to the gamepak memory, but when I try to read back to verify I get completely different information. Its really annoying.
<br/>
<br/>
Sajiimori -- the strcopy is not 8bit compatible (i think) it will screwup copying to gamepak mem.
<br/>
<br/>
I am stuck -- maybe this is an issue with emulation -- but how many other people have done gamepak read/write? Someone has to have gotten this work.. what am I doing wrong?
<br/>
<br/>
wbochar</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#36812 - tepples - Wed Mar 02, 2005 1:39 am</h4>
    <div class="postbody"><span class="postbody">For one thing, code that directly accesses SRAM should be in EWRAM, not in ROM. There's probably something to do with the address decoding that's unreliable on real carts.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#36817 - wbochar - Wed Mar 02, 2005 2:41 am</h4>
    <div class="postbody"><span class="postbody">The code i've written can write to the sram, just cant seem to reliably read from it. This is all of course done in emulation -- I havent tried to run this on my ez-cart II..yet..
<br/>
<br/>
I am going to look into the ewram method but I am not sure how to begin :).. Time for some more reading..
<br/>
<br/>
wbochar</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#36839 - sasq - Wed Mar 02, 2005 9:04 am</h4>
    <div class="postbody"><span class="postbody">I've read/written to SRAM without problems - you just have to remember to not use libc-functions for anything - strlen, strcpy, memcpy etc may all be optimized to read or write more than 8-bits at a time.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#36852 - tepples - Wed Mar 02, 2005 2:34 pm</h4>
    <div class="postbody"><span class="postbody">Search this forum for bytecpy(), a memcpy() replacement , and stick the code in EWRAM using a section attribute.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
