<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Using hardware sin and cos tables - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>Coding > Using hardware sin and cos tables</h2>
<div id="posts">
<div class="post">
    <h4>#7158 - Lupin - Tue Jun 10, 2003 8:17 pm</h4>
    <div class="postbody"><span class="postbody">How could I access the hardware sin and cos tables? I read that they are stored in bios</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#7159 - DekuTree64 - Tue Jun 10, 2003 8:43 pm</h4>
    <div class="postbody"><span class="postbody">Use swi 0xe (BG affine set, data is described in the CowBite spec (http://www.cs.rit.edu/~tjh8300/CowBite/CowBiteSpec.htm)
<br/>
Just set x, y, tx and ty to 0, sx and sy to 256 (that's 1 in fixed point), and theta to the angle you want, which is also 8.8 fixed point. And there's 256 degrees in a circle, not 360. So like, for 90 degrees, set theta to 64 &lt;&lt; 8.
<br/>
<br/>
Then, as you may or may not know, the way to set up your rotation regs is 
<br/>
pa = cos * x scale
<br/>
pb = sin * y scale
<br/>
pc = -sin * x scale
<br/>
pd = cos * y scale
<br/>
<br/>
so if your x/y scale is set to 1, you can take pb for sin, or pa/pd for cos. 
<br/>
But sin(angle) = cos(angle + 1/2 pi) (1/2 pi is 1/4 a revolution in radians, or 90 degrees), so you can just make one table for cos and for sin use table[angle + 64 &amp; 255], because 64 is 1/4 a revolution, assuming your table is 0-255 (you could make your step size for BgAffineSet's theta 128 (which is 1/2 fp) and have a table of 0-511, to double the accuracy if needed, so then you'd use table[angle + 128 &amp; 511] for sin). 
<br/>
Thanks to MrMr[iCE] for using this technique in his Tweakmode demo, and releasing the source to it, because that's where I learned it</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#7180 - Lupin - Wed Jun 11, 2003 5:33 pm</h4>
    <div class="postbody"><span class="postbody">erm.... yes.... ?!?!
<br/>
<br/>
I will give it up I think :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#7182 - DekuTree64 - Wed Jun 11, 2003 5:59 pm</h4>
    <div class="postbody"><span class="postbody">Really, it's not that hard. Here's how to do it in code:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
<br/>
#define cos(x) (trigTable[(x) &amp; 255])
<br/>
#define sin(x) (trigTable[((x) + 64) &amp; 255])
<br/>
<br/>
typedef struct tBGAffineSource {
<br/>
     s32 x;     //Original data's center X coordinate (8bit fractional portion)
<br/>
     s32 y;     //Original data's center Y coordinate (8bit fractional portion)
<br/>
     s16 tX;    //Display's center X coordinate
<br/>
     s16 tY;    //Display's center Y coordinate
<br/>
     s16 sX;    //Scaling ratio in X direction (8bit fractional portion)
<br/>
     s16 sY;    //Scaling ratio in Y direction (8bit fractional portion)
<br/>
     u16 theta; //Angle of rotation (8bit fractional portion) Effective Range 0-FFFF
<br/>
} BGAffineSource;
<br/>
<br/>
typdef struct tBGAffineDest {
<br/>
     s16 pa;  //Difference in X coordinate along same line
<br/>
     s16 pb;  //Difference in X coordinate along next line
<br/>
     s16 pc;  //Difference in Y coordinate along same line
<br/>
     s16 pd;  //Difference in Y coordinate along next line
<br/>
     s32 x;   //Start X coordinate
<br/>
     s32 y;   //Start Y coordinate
<br/>
} BGAffineDest;
<br/>
<br/>
extern void BgAffineSet(void*, void*, u32); //src, dest, count (more on this later)
<br/>
<br/>
BGAffineSource bgSrc[256];
<br/>
BGAffineDest bgDest[256];
<br/>
u32 i;
<br/>
s16 trigTable[256];
<br/>
<br/>
for(i = 0; i &lt; 256; i++)
<br/>
{
<br/>
   bgSrc.x = 0;
<br/>
   bgSrc.y = 0;
<br/>
   bgSrc.tX = 0;
<br/>
   bgSrc.tY = 0;
<br/>
   bgSrc.sX = 256;
<br/>
   bgSrc.sY = 256;
<br/>
   bgSrc.theta = i &lt;&lt; 8;
<br/>
}
<br/>
<br/>
BgAffineSet(bgSrc, bgDest, 256);
<br/>
<br/>
for(i = 0; i &lt; 256; i++)
<br/>
{
<br/>
   trigTable[i] = bgDest[i].pa;
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Then in a .s file, put 
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
.global BgAffineSet
<br/>
.thumb
<br/>
.align 2
<br/>
.thumb_func
<br/>
BgAffineSet:
<br/>
swi 0xe
<br/>
bx lr
<br/>
</td> </tr></table><span class="postbody">
<br/>
And compile it exactly like you would a C file. GCC figures out it's in ASM by the extension.
<br/>
<br/>
And you're done.
<br/>
The args of the C prototype, extern void BgAffineSet(void*, void*, u32); are set up just right for this SWI. r0 is a pointer to the source data structs(s), r1 is the dest data, and r2 is the number of structs you want to calculate. I haven't done any speed tests, but I assume it's faster to have it calculate a whole array of 256 at once than to loop through adding 256 (1 fixed-point) to theta and calling BgAffineSet with the count set to 1.
<br/>
But anyway, function arguments are pased in the registers r0-r3 (and then pushed onto the stack if you have more than 4, but we only have 3), so you can just put them in the order the SWI needs, and then when you call the function they're already set up. Much easier than doing it with inline ASM.
<br/>
Sorry if my previous post was too confusing^^</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#7183 - Lupin - Wed Jun 11, 2003 6:39 pm</h4>
    <div class="postbody"><span class="postbody">thx, now even I understand it ^^
<br/>
<br/>
but Why are there only 256 entries for the trig-table, I thought there should be 360 (each for every degree)?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#7185 - DekuTree64 - Wed Jun 11, 2003 7:01 pm</h4>
    <div class="postbody"><span class="postbody">It just makes it work better with a base-2 number system. You could change your theta step size to (256 &lt;&lt; 8) / 360 instead of just (1 &lt;&lt; 8) to get 360 degrees, but then you'd have to use % 360 instead of &amp; 255 when looking up values in your table. So basically 90 degrees becomes 64, 45 is 32, 180 is 128, and so on. Just a different proportion.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#7187 - Lupin - Wed Jun 11, 2003 7:37 pm</h4>
    <div class="postbody"><span class="postbody">You help an n00b like me very much - thanks!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#7188 - Lupin - Wed Jun 11, 2003 8:07 pm</h4>
    <div class="postbody"><span class="postbody">I implemented the code, but as soon as BgAffineSet(); gets called the rom hangs up :(
<br/>
<br/>
I'm pretty sure that I'm linking the .s file into my code, but somehow it doesn't work.
<br/>
<br/>
Here is what I did:
<br/>
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
/*
<br/>
 MATHLUTS.H
<br/>
*/
<br/>
<br/>
#ifndef MATHLUTS_H
<br/>
#define MATHLUTS_H
<br/>
<br/>
typedef struct tBGAffineSource { 
<br/>
     s32 x;     //Original data's center X coordinate (8bit fractional portion) 
<br/>
     s32 y;     //Original data's center Y coordinate (8bit fractional portion) 
<br/>
     s16 tX;    //Display's center X coordinate
<br/>
     s16 tY;    //Display's center Y coordinate 
<br/>
     s16 sX;    //Scaling ratio in X direction (8bit fractional portion) 
<br/>
     s16 sY;    //Scaling ratio in Y direction (8bit fractional portion) 
<br/>
     u16 theta; //Angle of rotation (8bit fractional portion) Effective Range 0-FFFF 
<br/>
} BGAffineSource; 
<br/>
<br/>
typedef struct tBGAffineDest { 
<br/>
     s16 pa;  //Difference in X coordinate along same line 
<br/>
     s16 pb;  //Difference in X coordinate along next line 
<br/>
     s16 pc;  //Difference in Y coordinate along same line 
<br/>
     s16 pd;  //Difference in Y coordinate along next line 
<br/>
     s32 x;   //Start X coordinate 
<br/>
     s32 y;   //Start Y coordinate 
<br/>
} BGAffineDest; 
<br/>
<br/>
extern void BgAffineSet(void*, void*, u32);
<br/>
<br/>
#define cos(x) (trigTable[(x) &amp; 255]) 
<br/>
#define sin(x) (trigTable[((x) + 64) &amp; 255]) 
<br/>
<br/>
s16 trigTable[256]; 
<br/>
<br/>
void InitTrigTable(void) {
<br/>
  BGAffineSource bgSrc[256]; 
<br/>
  BGAffineDest bgDest[256]; 
<br/>
  u32 i; 
<br/>
<br/>
  for(i = 0; i &lt; 256; i++) { 
<br/>
   bgSrc[i].x = 0; 
<br/>
   bgSrc[i].y = 0; 
<br/>
   bgSrc[i].tX = 0; 
<br/>
   bgSrc[i].tY = 0; 
<br/>
   bgSrc[i].sX = 256; 
<br/>
   bgSrc[i].sY = 256; 
<br/>
   bgSrc[i].theta = i &lt;&lt; 8; 
<br/>
  }
<br/>
<br/>
  BgAffineSet(bgSrc, bgDest, 256); 
<br/>
<br/>
  for(i = 0; i &lt; 256; i++) { 
<br/>
   trigTable[i] = bgDest[i].pa; 
<br/>
  } 
<br/>
}
<br/>
<br/>
<br/>
#endif
<br/>
//EOF
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
this header file gets included into my main c++ file, I call the InitTrigTable();-Function right after my Main();-function gets called. These are my compiler options (I'm using an makefile, created by an wizard):
<br/>
<br/>
CFLAGS  = -I $(INCDIR2) -I $(INCDIR) -I $(SRCDIR) -mthumb-interwork -c -Wall -fverbose-asm
<br/>
SFLAGS  = -I $(INCDIR2) -I $(INCDIR) -mthumb-interwork 
<br/>
LDFLAGS = -L $(LIBDIR) -L $(LIBDIR2) -T LinkScript
<br/>
<br/>
<br/>
I'm so sorry that I need your help once again, just because of my stupidity :(</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#7190 - DekuTree64 - Wed Jun 11, 2003 9:25 pm</h4>
    <div class="postbody"><span class="postbody">Hmm, well I typed that code out pretty fast, so there could be something wrong with it, but I went and looked at the code on my programming computer, and it does look just about the same, so it seems like it would work. Those structs are pretty big though, so with 256 of each, it could be running out of IWRAM. In mine, I used EWRAM for the arrays, so maybe try that. If you don't have anything else in EWRAM, just use 
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
BGAffineSource *bgSrc = (BGAffineSource *)0x2000000;
<br/>
BGAffineDest *bgDest = (BGAffineDest *)(0x2000000 + (sizeof(BgAffineSource) &lt;&lt; 8));
<br/>
</td> </tr></table><span class="postbody">
<br/>
And leave the rest the same.
<br/>
Then if that doesn't work, try changing the ASM function to 
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
.global BgAffineSet
<br/>
.arm
<br/>
.align 4
<br/>
BgAffineSet:
<br/>
swi 0xe0000
<br/>
bx lr
<br/>
</td> </tr></table><span class="postbody">
<br/>
Which does the same thing, but in ARM, which I think is what your main function is compiled with, since it doesn't specify, and I'm pretty sure it's the default, and it may not be interworking correctly (it should though).
<br/>
<br/>
Then if all else fails, do them one at a time, which would be someting like
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
void InitTrigTable(void) { 
<br/>
  BGAffineSource bgSrc; 
<br/>
  BGAffineDest bgDest; 
<br/>
  u32 i; 
<br/>
<br/>
  for(i = 0; i &lt; 256; i++) { 
<br/>
   bgSrc.x = 0; 
<br/>
   bgSrc.y = 0; 
<br/>
   bgSrc.tX = 0; 
<br/>
   bgSrc.tY = 0; 
<br/>
   bgSrc.sX = 256; 
<br/>
   bgSrc.sY = 256; 
<br/>
   bgSrc.theta = i &lt;&lt; 8; 
<br/>
   BgAffineSet(&amp;bgSrc, &amp;bgDest, 1); //use &amp; because they're no longer arrays, so you need to get the address
<br/>
   trigTable[i] = bgDest.pa; 
<br/>
  } 
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
And if that STILL doesn't work, post again and I'll bang my head on the wall a few times and see if I realize anything wrong with it^_^</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#7337 - Lupin - Sun Jun 15, 2003 1:32 pm</h4>
    <div class="postbody"><span class="postbody">thx! :)</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
