<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>gba software interrupts - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>Coding > gba software interrupts</h2>
<div id="posts">
<div class="post">
    <h4>#166329 - moonlightcheese - Wed Feb 04, 2009 8:47 pm</h4>
    <div class="postbody"><span class="postbody">i'm attempting to build an elf loader and i think i've got the file read and placed in memory properly and i need to send an interrupt to begin execution at the pointer to the memory segments i populated with the loader.  are there any particular examples or tutorials regarding software interrupts on the gba?  i'm not even sure where to start and any advice or reference would be helpful.  interrupts are supposed to be the most difficult part of OS coding and i can definitely see the truth in that... :D</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#166331 - Dwedit - Wed Feb 04, 2009 9:12 pm</h4>
    <div class="postbody"><span class="postbody">I don't think you need any form of software interrupt to load an ELF file, rather you would just jump to the entry point with the proper lr value in case it decides to return.
<br/>
But you may also need to ensure that the ctr0 file used by the program you wish to run indeed supports returning.<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#166334 - moonlightcheese - Wed Feb 04, 2009 9:41 pm</h4>
    <div class="postbody"><span class="postbody">i'm not worried about returning really.  i just want to make the process image run.  everything is coded in C and i have no clue how to just branch to an address in C.  i'm told that using inline assembly is a no-no for switching context due to some irregularities the compiler causes in cpu registers.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#166335 - Maxxie - Wed Feb 04, 2009 9:50 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>moonlightcheese wrote:</b></span></td> </tr> <tr> <td class="quote">i just want to make the process image run.  everything is coded in C and i have no clue how to just branch to an address in C.</td> </tr></table><span class="postbody">
<br/>
<br/>
Declare a procedure pointer type, and create an instance like you would do with any other pointer. You can then just call it as you are used to with functions available at compiletime.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
typedef int (* mainfunction_type)(int argc, char **argv) ;
<br/>
<br/>
mainfunction_type *mainfn = (mainfunction_type *)address ;
<br/>
int retval = mainfn(argc,argv) ;
<br/>
</td> </tr></table><span class="postbody"><br/>_________________<br/><a class="postlink" href="http://nintendods.desperate-programmers.com/doku.php?id=wireless_io_map" target="_blank">Trying  to bring more detail into understanding the wireless hardware</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#166336 - Dwedit - Wed Feb 04, 2009 9:56 pm</h4>
    <div class="postbody"><span class="postbody">The easiest way to call an arbitrary address in pure C is to make a function pointer, then call it.
<br/>
<br/>
declare a function pointer:
<br/>
void (*mypointer)();
<br/>
assign a function pointer:
<br/>
*(u32*)mypointer=0x02000000;
<br/>
call a function pointer:
<br/>
mypointer();
<br/>
<br/>
To do a context switch on a GBA, just save and restore the complete set of registers, r0-r12, sp, lr, maybe pc, as well as the processor status register, and also which CPU mode you were in before.  You need a separate stack for each 'thread'.
<br/>
You can also use the standard C library functions setjmp and longjmp.
<br/>
<br/>
If you are writing a GBA operating system which loads ELF files, and plan on ever having the OS interrupt the program, you may want to ensure that the client program does not clear all memory and reset the stack address.  Usually those tasks are done in the crt0 code which executes before main().  But if it's just an elf loader that boots once then lets the program have free reign, that's not necessary.<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#166337 - samel - Wed Feb 04, 2009 10:35 pm</h4>
    <div class="postbody"><span class="postbody">May be these link can help you
<br/>
<br/>
//gba thread by DarkPhantom
<br/>
<br/>
<a href="http://www.gbadev.org/index.php?showinfo=986" target="_blank">http://www.gbadev.org/index.php?showinfo=986</a>
<br/>
<br/>
//ds thread modified from DarkPhantom by me
<br/>
<br/>
<a href="http://donotjava.netsons.org/?page_id=67" target="_blank">http://donotjava.netsons.org/?page_id=67</a>
<br/>
<br/>
ThreaDS work fine with DevkitPro r21 [if i remember right 8p] but should have no [BIG] problem with newer version.
<br/>
<br/>
If you have any question just ask.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#166339 - moonlightcheese - Thu Feb 05, 2009 12:24 am</h4>
    <div class="postbody"><span class="postbody">ok i got it to jump properly but the executable won't load.  time for some debugging.  thanks for the help :D</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#166340 - kusma - Thu Feb 05, 2009 2:03 am</h4>
    <div class="postbody"><span class="postbody">Perhaps the image needs a bit of relocating? I'd reccomend looking at it all in a debugger.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#166345 - moonlightcheese - Thu Feb 05, 2009 3:28 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>kusma wrote:</b></span></td> </tr> <tr> <td class="quote">Perhaps the image needs a bit of relocating? I'd reccomend looking at it all in a debugger.</td> </tr></table><span class="postbody">
<br/>
i read in a post on osdev.org that you have to use section headers rather than program headers on systems that do not have an MMU.  i'm trying to work through an example but it's got virtual memory implemented and i'm just building a loader for purposes of example with physical addresses.  i'm gonna try to figure out how to use the section headers.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
