<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>arm-eabi-as.exe SLOW - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>Coding > arm-eabi-as.exe SLOW</h2>
<div id="posts">
<div class="post">
    <h4>#164522 - Chano Marrano - Wed Nov 05, 2008 2:43 am</h4>
    <div class="postbody"><span class="postbody">Using devKitArm r23b, when I include about 70 .mod songs in my project (I'm using AAS for sound), as.exe takes about 5 minutes to finish its execution. The project only contains a pair of .c files and the .mod files. The makefile i'm using is a mix between TONC makefile and the makefile included in devKitPro's AAS example:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code"># ---------------------------------------------------------------------
<br/>
# SETUP
<br/>
# ---------------------------------------------------------------------
<br/>
<br/>
# --- No implicit rules ---
<br/>
.SUFFIXES:
<br/>
<br/>
# --- Tonc paths ---
<br/>
# If not defined as environment var, assumed to be 2 dirs up
<br/>
export TONCCODE   ?= C:/TONC
<br/>
<br/>
include $(TONCCODE)/tonc_rules
<br/>
<br/>
# --- Main path ---
<br/>
export PATH   :=   $(DEVKITARM)/bin:$(PATH)
<br/>
<br/>
<br/>
# ---------------------------------------------------------------------
<br/>
# PROJECT DETAILS
<br/>
# ---------------------------------------------------------------------
<br/>
<br/>
# PROJ      : Base project name
<br/>
# TITLE      : Title for ROM header (12 characters)
<br/>
# LIBS      : Libraries to use, formatted as list for linker flags
<br/>
# BUILD      : Directory for build process temporaries. Should NOT be empty!
<br/>
# SRCDIRS   : List of source file directories
<br/>
# DATADIRS   : List of data file directories
<br/>
# INCDIRS   : List of header file directories
<br/>
# LIBDIRS   : List of library directories
<br/>
# General note: use . for the current dir, don't leave them empty.
<br/>
<br/>
export PROJ   ?= $(notdir $(CURDIR))
<br/>
TITLE      := $(PROJ)
<br/>
GFXLIBS      := libgfx.a
<br/>
LIBAAS      := $(TONCCODE)/libAAS
<br/>
<br/>
LIBS      := -ltonc -lgfx -lAAS
<br/>
<br/>
BUILD      := build
<br/>
SRCDIRS      := source
<br/>
DATADIRS   := data
<br/>
INCDIRS      := source
<br/>
LIBDIRS      := $(TONCCODE)/tonclib $(LIBAAS)
<br/>
AASDATA      := audio
<br/>
<br/>
EMU := $(TONCCODE)/emu/emu.exe
<br/>
<br/>
<br/>
# --- switches ---
<br/>
<br/>
bMB      := 0   # Multiboot build
<br/>
bTEMPS   := 0   # Save gcc temporaries (.i and .s files)
<br/>
bDEBUG2   := 0   # Generate debug info (bDEBUG2? Not a full DEBUG flag. Yet)
<br/>
<br/>
<br/>
# ---------------------------------------------------------------------
<br/>
# BUILD FLAGS
<br/>
# ---------------------------------------------------------------------
<br/>
<br/>
# This is probably where you can stop editing
<br/>
<br/>
# --- Architecture ---
<br/>
<br/>
ARCH    := -mthumb-interwork -mthumb
<br/>
RARCH   := -mthumb-interwork -mthumb
<br/>
IARCH   := -mthumb-interwork -marm -mlong-calls
<br/>
<br/>
# --- Main flags ---
<br/>
<br/>
CFLAGS   := -mcpu=arm7tdmi -mtune=arm7tdmi $(ARCH) -O2
<br/>
CFLAGS   += -Wall
<br/>
CFLAGS   += $(INCLUDE)
<br/>
CFLAGS   += -ffast-math -fno-strict-aliasing
<br/>
<br/>
CXXFLAGS   := $(CFLAGS) -fno-rtti -fno-exceptions
<br/>
<br/>
ASFLAGS   := $(ARCH)
<br/>
LDFLAGS := $(ARCH) -Wl,-Map,$(PROJ).map
<br/>
<br/>
# --- switched additions ----------------------------------------------
<br/>
<br/>
# --- Multiboot ? ---
<br/>
ifeq ($(strip $(bMB)), 1)
<br/>
   TARGET   := $(PROJ).mb
<br/>
else
<br/>
   TARGET   := $(PROJ)
<br/>
endif
<br/>
   
<br/>
# --- Save temporary files ? ---
<br/>
ifeq ($(strip $(bTEMPS)), 1)
<br/>
   CFLAGS   += -save-temps
<br/>
endif
<br/>
<br/>
# --- Debug info ? ---
<br/>
<br/>
ifeq ($(strip $(bDEBUG2)), 1)
<br/>
   CFLAGS   += -g
<br/>
   LDFLAGS   += -g
<br/>
endif
<br/>
<br/>
<br/>
# ---------------------------------------------------------------------
<br/>
# BUILD PROCEDURE
<br/>
# ---------------------------------------------------------------------
<br/>
<br/>
ifneq ($(BUILD),$(notdir $(CURDIR)))
<br/>
<br/>
# Still in main dir: 
<br/>
# * Define/export some extra variables
<br/>
# * Invoke this file again from the build dir
<br/>
# PONDER: what happens if BUILD == "" ?
<br/>
<br/>
export OUTPUT   :=   $(CURDIR)/$(TARGET)
<br/>
export VPATH   :=                           \
<br/>
   $(foreach dir, $(SRCDIRS) , $(CURDIR)/$(dir))   \
<br/>
   $(foreach dir, $(DATADIRS), $(CURDIR)/$(dir))   \
<br/>
   $(CURDIR)/$(AASDATA)
<br/>
<br/>
export DEPSDIR   :=   $(CURDIR)/$(BUILD)
<br/>
<br/>
# --- List source and data files ---
<br/>
<br/>
CFILES      :=   $(foreach dir, $(SRCDIRS) , $(notdir $(wildcard $(dir)/*.c)))
<br/>
CPPFILES   :=   $(foreach dir, $(SRCDIRS) , $(notdir $(wildcard $(dir)/*.cpp)))
<br/>
SFILES      :=   $(foreach dir, $(SRCDIRS) , $(notdir $(wildcard $(dir)/*.s)))
<br/>
BINFILES   :=   $(foreach dir, $(DATADIRS), $(notdir $(wildcard $(dir)/*.*)))
<br/>
AAS_FILES   :=   $(notdir $(wildcard $(AASDATA)/*.*))
<br/>
<br/>
export AAS_DEPS   :=   $(foreach file,$(AAS_FILES),$(CURDIR)/$(AASDATA)/$(file))
<br/>
export AAS_DIR   :=   $(CURDIR)/$(AASDATA)
<br/>
<br/>
# --- Set linker depending on C++ file existence ---
<br/>
ifeq ($(strip $(CPPFILES)),)
<br/>
   export LD   := $(CC)
<br/>
else
<br/>
   export LD   := $(CXX)
<br/>
endif
<br/>
<br/>
# --- Define object file list ---
<br/>
export OFILES   :=                           \
<br/>
   AAS_Data.o                              \
<br/>
   $(addsuffix .o, $(BINFILES))               \
<br/>
   $(CFILES:.c=.o) $(CPPFILES:.cpp=.o)            \
<br/>
   $(SFILES:.s=.o)
<br/>
<br/>
# --- Create include and library search paths ---
<br/>
export INCLUDE   :=                           \
<br/>
   $(foreach dir,$(INCDIRS),-I$(CURDIR)/$(dir))   \
<br/>
   $(foreach dir,$(LIBDIRS),-I$(dir)/include)      \
<br/>
   -I$(CURDIR)/$(BUILD)
<br/>
<br/>
export LIBPATHS   :=   -L$(CURDIR) $(foreach dir,$(LIBDIRS),-L$(dir)/lib)
<br/>
<br/>
<br/>
# --- More targets ----------------------------------------------------
<br/>
<br/>
.PHONY: $(BUILD) clean
<br/>
<br/>
# --- Create $(BUILD) if necessary, and run this makefile from there ---
<br/>
<br/>
$(BUILD):
<br/>
   @[ -d $@ ] || mkdir -p $@
<br/>
   @make --no-print-directory -f $(CURDIR)/gfxmake
<br/>
   @make --no-print-directory -C $(BUILD) -f $(CURDIR)/Makefile
<br/>
   @$(EMU) $(TARGET).gba
<br/>
<br/>
all   : $(BUILD)
<br/>
<br/>
clean:
<br/>
   @echo clean ...
<br/>
   @rm -fr $(BUILD) $(TARGET).elf $(TARGET).gba
<br/>
<br/>
<br/>
else      # If we're here, we should be in the BUILD dir
<br/>
<br/>
DEPENDS   :=   $(OFILES:.o=.d)
<br/>
<br/>
# --- Main targets ----
<br/>
<br/>
$(OUTPUT).gba   :   $(OUTPUT).elf
<br/>
<br/>
$(OUTPUT).elf   :   $(OFILES) libgfx.a
<br/>
<br/>
AAS_Data.s: $(AAS_DEPS)
<br/>
   $(LIBAAS)/bin/conv2aas.exe $(AAS_DIR)
<br/>
<br/>
-include $(DEPENDS)
<br/>
<br/>
<br/>
endif      # End BUILD switch
<br/>
<br/>
# EOF</td> </tr></table><span class="postbody">
<br/>
<br/>
So... any solution?
<br/>
<br/>
<span style="font-weight: bold">EDIT:</span>
<br/>
as.exe almost hangs at this line of execution:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">AAS_Data.s
<br/>
arm-eabi-gcc -MMD -MP -MF /c/ProyectoTSC/build/AAS_Data.d -x assembler-with-cpp -mthumb-interwork -mthumb -c AAS_Data.s -o AAS_Data.o</td> </tr></table><span class="postbody"><br/>_________________<br/><a class="postlink" href="http://www.playeradvance.org/forum/showthread.php?t=19881" target="_blank">Sh*tty RPG</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#164544 - Miked0801 - Thu Nov 06, 2008 6:54 pm</h4>
    <div class="postbody"><span class="postbody">Does turing off the dependency check help out?  Also, how big is said assembler file?  Finally, if you just run the file without make overhead, how fast does it go?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#164545 - Chano Marrano - Thu Nov 06, 2008 9:38 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Does turing off the dependency check help out?</td> </tr></table><span class="postbody"> I suppose you mean to do this:</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">AAS_Data.s:
<br/>
   $(LIBAAS)/bin/conv2aas.exe $(AAS_DIR)</td> </tr></table><span class="postbody"> And nope, it doesn't help.
<br/>
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">how big is said assembler file?</td> </tr></table><span class="postbody"> About 30 MB.
<br/>
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">if you just run the file without make overhead, how fast does it go?</td> </tr></table><span class="postbody"> What file? I didn't understand that.
<br/>
<br/>
I don't understand why an assembler can be so slow. AAS converter (a more complex program, I suppose) takes less than a minute to convert all songs.
<br/>
<br/>
<br/>
<span style="font-weight: bold">EDIT</span>:
<br/>
I tried to run this line on cmd.exe and the results were more or less the same:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">arm-eabi-gcc -MMD -MP -MF /c/ProyectoTSC/build/AAS_Data.d -x assembler-with-cpp -mthumb-interwork -mthumb -c AAS_Data.s -o AAS_Data.o</td> </tr></table><span class="postbody">
<br/>
Also I turned off the antivirus and assigned 1GB to the virtual machine (I'm running devkitPro on VirtualBox with Windows XP) and the results weren't better.<br/>_________________<br/><a class="postlink" href="http://www.playeradvance.org/forum/showthread.php?t=19881" target="_blank">Sh*tty RPG</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#164551 - Cydrak - Fri Nov 07, 2008 1:18 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">&gt; how big is said assembler file?
<br/>
About 30 MB.</td> </tr></table><span class="postbody">o_o;
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">I don't understand why an assembler can be so slow. ...</td> </tr></table><span class="postbody">30MB / 80 chars per line / 5 min, roughly speaking, would be ~1,300 lines/second. Take that as you will.
<br/>
<br/>
Frankly I'd be surprised (or impressed) if it <span style="font-style: italic">wasn't</span> a little slow. Traditionally these tools work on human-written code, after all. They are a bit fancier for it. You could even say, there are practically infinite ways to write a given program but roughly one way to write a MOD; by comparison, MODs have a very fixed, simple format. (Well... that's giving the latter too much credit, IMHO, but I digress. ;p)
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">arm-eabi-gcc -MMD -MP -MF /c/ProyectoTSC/build/AAS_Data.d <span style="font-weight: bold">-x assembler-with-cpp</span> -mthumb-interwork -mthumb -c AAS_Data.s -o AAS_Data.o</td> </tr></table><span class="postbody">This doesn't just invoke the assembler; it also runs the C preprocessor ("cpp") beforehand! So you really have two programs involved. You can further try it without "-MMD -MP -MF AAS_Data.d", which is superfluous for simple data. I assume that's the dependency search mentioned above, and I doubt it works without the preprocessor anyway.
<br/>
<br/>
If AAS allows you to convert to binary (and separate files), perhaps look into something like <a class="postlink" href="http://www.pineight.com/gba/#gbfs" target="_blank">GBFS</a>, which is designed for embedding this stuff. It sidesteps the extra compilation entirely.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#164552 - Chano Marrano - Fri Nov 07, 2008 2:31 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">You can further try it without "-MMD -MP -MF AAS_Data.d", which is superfluous for simple data. I assume that's the dependency search mentioned above, and I doubt it works without the preprocessor anyway.</td> </tr></table><span class="postbody"> I tried to execute this with the same result:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">arm-eabi-as.exe C:\...\AAS_Data.s -o C:\...\AAS_Data.o</td> </tr></table><span class="postbody">
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">If AAS allows you to convert to binary (and separate files), perhaps look into something like GBFS, which is designed for embedding this stuff. It sidesteps the extra compilation entirely.</td> </tr></table><span class="postbody"> That's the problem, AAS converter only gives as output a single assembler file for all the mods converted, because it tries to share the samples used in all songs. AAS converter takes as input a directory instead of a file.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Frankly I'd be surprised (or impressed) if it wasn't a little slow.</td> </tr></table><span class="postbody"> <span style="font-weight: bold">Five</span> minutes for a 30MB file?<br/>_________________<br/><a class="postlink" href="http://www.playeradvance.org/forum/showthread.php?t=19881" target="_blank">Sh*tty RPG</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#164574 - Miked0801 - Fri Nov 07, 2008 7:11 pm</h4>
    <div class="postbody"><span class="postbody">What CPU/Memory is your computer?  Perhaps the thing is running full speed.  30Megs of dense assembler is a bunch of work.  If you have a multi-cpu system, would it be possible to divide and conquer the assmebr file?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#164576 - Chano Marrano - Fri Nov 07, 2008 9:34 pm</h4>
    <div class="postbody"><span class="postbody">I have a AMD X2 3800+ with 2GB, but as I said I'm running Windows XP through VirtualBox. AAS converter takes less than a minute to get its job done, so I don't think a better PC would fix my problem.
<br/>
<br/>
VirtualBox doesn't allow dual core guest systems.<br/>_________________<br/><a class="postlink" href="http://www.playeradvance.org/forum/showthread.php?t=19881" target="_blank">Sh*tty RPG</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#164579 - Cydrak - Sat Nov 08, 2008 1:09 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote"><span style="font-weight: bold">Five</span> minutes for a 30MB file?</td> </tr></table><span class="postbody">Even with GCC out of the picture? I still feel sorry for the assembler, but fair enough!
<br/>
<br/>
I tried and couldn't reproduce this, in or out of VirtualBox. I'm running XP on an X2 5200+, 3GB RAM; VBox had 1GB. Data was a 16MB image exported from Usenti, and AS takes ~3 seconds on the 60MB file. I have to admit, this isn't so bad as I thought. Of course my data and host are different, and it was almost a bare VM image, so this isn't saying too much. :|
<br/>
<br/>
One oddity for me is that files under //vboxsvr/* take a little longer (sometimes), and 'gcc -x assembler-with-cpp' even segfaults on them, whereas the assembler alone works fine.
<br/>
<br/>
The worst I could manage: GCC on the equivalent C array spends about a minute. (Assuming RAM is available, because it tops out at a monstrous 1GB. Yikes!)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#164583 - Chano Marrano - Sat Nov 08, 2008 8:28 am</h4>
    <div class="postbody"><span class="postbody">Hmmm... OK, <a class="postlink" href="http://www.fileden.com/files/2008/2/17/1764711/PruebaMods.zip" target="_blank">project link</a>.
<br/>
All mods have been downloaded from modarchive.org and <a href="http://www.exotica.org.uk" target="_blank">www.exotica.org.uk</a> . If you want to compile the project, you'll need to set TONCCODE and LIBAAS variables in Makefile.<br/>_________________<br/><a class="postlink" href="http://www.playeradvance.org/forum/showthread.php?t=19881" target="_blank">Sh*tty RPG</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#164605 - Cydrak - Sun Nov 09, 2008 7:40 pm</h4>
    <div class="postbody"><span class="postbody">...several minutes. Yep. @_@;
<br/>
<br/>
AS kinda doesn't like long lines. Most of AAS's assembler is just one statement, a 30MB .byte array. I've seen mammoth text files, but never lines this long! Pretty egregious abuse if you ask me...
<br/>
<br/>
I think I would be looking for another library. ;p But if you must have AAS, a slightly easier solution--than rewriting the converter--is to break up the lines. I say "slightly" because the first shell commands I tried fare even worse than the assembler. &gt;_&gt;
<br/>
<br/>
So as a starting point I made a very quick-and-dirty C hack, to split all those huge arrays: <a class="postlink" href="http://draci.chaosnet.org/code/AAS_Linefix/" target="_blank">AAS_Linefix</a>
<br/>
Add it to the conversion rule:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">AAS_Data.s: $(AAS_DEPS)
<br/>
    $(LIBAAS)/bin/conv2aas.exe $(AAS_DIR)
<br/>
    $(SOME_PATH_TO)/AAS_Linefix.exe AAS_Data.s</td> </tr></table><span class="postbody">
<br/>
If it works for you, things should be considerably faster now. Good luck!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#164607 - Chano Marrano - Sun Nov 09, 2008 9:11 pm</h4>
    <div class="postbody"><span class="postbody">o_O'
<br/>
<br/>
<span style="font-weight: bold">WOW</span>
<br/>
<br/>
Uh... thanks!
<br/>
A explanation for the problem would have been more than sufficient for me, so the fact that you have spent your time writing a program to fix it has left me speechless.
<br/>
<br/>
By the way, as.exe now gets its job done in less than 20 seconds, so again, thanks a lot!<br/>_________________<br/><a class="postlink" href="http://www.playeradvance.org/forum/showthread.php?t=19881" target="_blank">Sh*tty RPG</a></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
