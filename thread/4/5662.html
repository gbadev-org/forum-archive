<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>How to write to EReader SRAM - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>Coding > How to write to EReader SRAM</h2>
<div id="posts">
<div class="post">
    <h4>#42190 - Maverick - Sat May 07, 2005 12:13 pm</h4>
    <div class="postbody"><span class="postbody">I am looking to write a simple UART comms program that writes to the ereader sram. Allowing me to write some ereader code without wasting lots and lots of paper.
<br/>
<br/>
Does anyone have any information on this or can point me in the right direction?
<br/>
<br/>
I need locations and any bit commands if needed.
<br/>
<br/>
Many thanks</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#42196 - caitsith2 - Sat May 07, 2005 4:07 pm</h4>
    <div class="postbody"><span class="postbody">e-reader uses 1Mbit flash, bankswitched in 2 512Kbit banks.
<br/>
<br/>
What you need to know, is that the program storage starts in the upper bank.
<br/>
<br/>
This is the code I have to write to the flash, and switch banks.  (asm code).
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
.GLOBL  check_flashrom
<br/>
.GLOBL  switchbank0
<br/>
.GLOBL  switchbank1
<br/>
.GLOBL  writeflash
<br/>
.GLOBL  eraseflash
<br/>
<br/>
.ARM
<br/>
@.SECTION .iwram
<br/>
.ALIGN
<br/>
.TEXT
<br/>
<br/>
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
<br/>
@
<br/>
@   Flash related functions.
<br/>
@
<br/>
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
<br/>
<br/>
        
<br/>
@extern void check_flashrom(u16 *v1, u16 *v2);
<br/>
check_flashrom:
<br/>
<br/>
<br/>
   STMFD   sp!, {r2-r5}
<br/>
   ldr     r5,=0xE005555
<br/>
   mov     r2,#0xAA
<br/>
   strb    r2,[r5]         @ AA =&gt; 0800AAAA
<br/>
   mov     r4,#0xE000000
<br/>
   ldr     r3,=0xE002AAA
<br/>
   mov     r2,#0x55
<br/>
   strb    r2,[r3]         @ 55 =&gt; 08005554
<br/>
   mov     r2,#0x90
<br/>
   strb    r2,[r5]         @ 90 =&gt; 0800AAAA
<br/>
   ldrh    r2,[r4]         @ 08000000 =&gt; v1
<br/>
   strh    r2,[r0]         
<br/>
   ldrh    r0,[r4,#0x1]      @ 08000002 =&gt; v2
<br/>
   strh    r0,[r1]
<br/>
   mov     r0,#0xF0
<br/>
   strh    r0,[r4]         @ F0 =&gt; 08000000
<br/>
   LDMFD   sp!, {r2-r5}
<br/>
   bx      lr
<br/>
<br/>
@extern void switchbank0(void);
<br/>
switchbank0:
<br/>
   STMFD   sp!, {r2-r5}
<br/>
   ldr     r5,=0xE005555
<br/>
   mov     r2,#0xAA
<br/>
   strb    r2,[r5]         @ AA =&gt; 0800AAAA
<br/>
   mov     r4,#0xE000000
<br/>
   ldr     r3,=0xE002AAA
<br/>
   mov     r2,#0x55
<br/>
   strb    r2,[r3]         @ 55 =&gt; 08005554
<br/>
   mov     r2,#0xB0
<br/>
   strb    r2,[r5]         @ 90 =&gt; 0800AAAA
<br/>
   mov     r2,#0x00
<br/>
   strb    r2,[r4]
<br/>
   LDMFD   sp!, {r2-r5}
<br/>
   bx      lr
<br/>
   
<br/>
@extern void switchbank1(void);
<br/>
switchbank1:
<br/>
   STMFD   sp!, {r2-r5}
<br/>
   ldr     r5,=0xE005555
<br/>
   mov     r2,#0xAA
<br/>
   strb    r2,[r5]         @ AA =&gt; 0800AAAA
<br/>
   mov     r4,#0xE000000
<br/>
   ldr     r3,=0xE002AAA
<br/>
   mov     r2,#0x55
<br/>
   strb    r2,[r3]         @ 55 =&gt; 08005554
<br/>
   mov     r2,#0xB0
<br/>
   strb    r2,[r5]         @ 90 =&gt; 0800AAAA
<br/>
   mov     r2,#0x01
<br/>
   strb    r2,[r4]
<br/>
   LDMFD   sp!, {r2-r5}
<br/>
   bx      lr
<br/>
   
<br/>
<br/>
@extern void writeflash(u16 address, u8 data);
<br/>
writeflash:
<br/>
   STMFD   sp!, {r2-r5}
<br/>
   ldr     r5,=0xE005555
<br/>
   mov     r2,#0xAA
<br/>
   strb    r2,[r5]         @ AA =&gt; 0800AAAA
<br/>
   mov     r4,#0xE000000
<br/>
   add     r0, r0, r4
<br/>
   ldr     r3,=0xE002AAA
<br/>
   mov     r2,#0x55
<br/>
   strb    r2,[r3]         @ 55 =&gt; 08005554
<br/>
   mov     r2,#0xA0
<br/>
   strb    r2,[r5]         @ 90 =&gt; 0800AAAA
<br/>
   strb    r1,[r0]
<br/>
writeloop:
<br/>
    ldrb    r1,[r0]
<br/>
    ldrb    r2,[r0]
<br/>
    cmp     r1,r2
<br/>
    bne     writeloop
<br/>
    ldrb    r1,[r0]
<br/>
    ldrb    r2,[r0]
<br/>
    cmp     r1,r2
<br/>
    bne     writeloop
<br/>
   LDMFD   sp!, {r2-r5}
<br/>
   bx      lr
<br/>
   
<br/>
@extern void eraseflash(void);
<br/>
eraseflash:
<br/>
    STMFD   sp!, {r0-r5}
<br/>
    ldr     r3,=0xE005555
<br/>
    ldr     r4,=0xE002AAA
<br/>
    ldr     r5,=0xE000000
<br/>
    mov     r2,#0xAA        @ -&gt; E005555
<br/>
    strb    r2,[r3]
<br/>
    mov     r2,#0x55        @ -&gt; E002AAA
<br/>
    strb    r2,[r4]
<br/>
    mov     r2,#0x80        @ -&gt; E005555
<br/>
    strb    r2,[r3]
<br/>
    mov     r2,#0xAA        @ -&gt; E005555
<br/>
    strb    r2,[r3]
<br/>
    mov     r2,#0x55        @ -&gt; E002AAA
<br/>
    strb    r2,[r4]
<br/>
    mov     r2,#0x10        @ -&gt; E005555
<br/>
    strb    r2,[r3]
<br/>
eraseloop:
<br/>
    ldrb    r0,[r5]
<br/>
    ldrb    r1,[r5]
<br/>
    cmp     r0,r1
<br/>
    bne     eraseloop
<br/>
    ldrb    r0,[r5]
<br/>
    ldrb    r1,[r5]
<br/>
    cmp     r0,r1
<br/>
    bne     eraseloop
<br/>
   LDMFD   sp!, {r0-r5}
<br/>
   bx      lr
<br/>
   
<br/>
</td> </tr></table><span class="postbody">[/code]</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#42208 - Maverick - Sat May 07, 2005 9:06 pm</h4>
    <div class="postbody"><span class="postbody">Thanks
<br/>
<br/>
So the EReader save starts at address 0x0E000000
<br/>
<br/>
First, erase then write to bank one, then erase and write to bank two
<br/>
<br/>
How, when and why do i need to use check flash rom?
<br/>
<br/>
To check it is ok, do i just need to print from 0x0E000000 straight after?
<br/>
<br/>
Many thanks for all the help</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#42226 - caitsith2 - Sun May 08, 2005 3:14 am</h4>
    <div class="postbody"><span class="postbody">You don't really need to use check flash rom at all, unless you wish to know the manufacture/device type bytes.
<br/>
<br/>
But yeah,  if there is any info in the current sector you wish to save, read it out to a block of memory,  make the changes to that block of memory you read the sector out to,  erase the sector, write the sector back in.
<br/>
<br/>
However, if your not saving any bytes within the sector, then just erase the sector, write what you want to it.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#42251 - wintermute - Sun May 08, 2005 1:31 pm</h4>
    <div class="postbody"><span class="postbody">any reason the bankswitching wasn't done like this?
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
@extern void switchbank(int bank);
<br/>
switchbank:
<br/>
   STMFD   sp!, {r2-r5}
<br/>
   ldr     r5,=0xE005555
<br/>
   mov     r2,#0xAA
<br/>
   strb    r2,[r5]         @ AA =&gt; 0800AAAA
<br/>
   mov     r4,#0xE000000
<br/>
   ldr     r3,=0xE002AAA
<br/>
   mov     r2,#0x55
<br/>
   strb    r2,[r3]         @ 55 =&gt; 08005554
<br/>
   mov     r2,#0xB0
<br/>
   strb    r2,[r5]         @ 90 =&gt; 0800AAAA
<br/>
   strb    r0,[r4]
<br/>
   LDMFD   sp!, {r2-r5}
<br/>
   bx      lr 
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Is this code timing sensitive? i.e. does it need to be in arm assembly or would C code suffice?
<br/>
<br/>
This would probably make a useful addition to the Ereader support in devkitARM/libgba.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
