<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Fading. Again. - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>Coding > Fading. Again.</h2>
<div id="posts">
<div class="post">
    <h4>#47631 - Fatnickc - Mon Jul 11, 2005 4:23 pm</h4>
    <div class="postbody"><span class="postbody">I know that there have been heaps of posts asking how to do fading, but I realy can't do it at all. I've tried so many things, and, after looking at CowBite, thought I had it. However, changing the value of REG_BLDMOD or REG_COLEY, turned one pixel black each. I'm using Mode 4, and, I know this is being incredibly lazy, but, can anyone just show me some source which works, so I can understand how and why, and then make my own function for it?
<br/>
Thanks, Fatnickc.
<br/>
<br/>
EDIT : Please, I'm really at a lost end here.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#47690 - Crs - Tue Jul 12, 2005 12:25 pm</h4>
    <div class="postbody"><span class="postbody">Hi,
<br/>
<br/>
Perhaps you could just step down/up all your palettes rather than using BLDMOD.. I would think this would help with fading any sprites too.
<br/>
<br/>
All I can suggest is check your target and source backgrounds are the right way around, and that you are using the correct blend mode.. I dont have any code to share but if you can post some I may beable to spot why its not functioning correctly.
<br/>
<br/>
Also ensure your backgrounds have mosaic enabled.. (never used mode 4 so maybe thats a reason?)
<br/>
<br/>
Cheers
<br/>
<br/>
Chris</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#47696 - Cearn - Tue Jul 12, 2005 1:00 pm</h4>
    <div class="postbody"><span class="postbody">A very simply fade to white for mode 4. You'll have to change the names to whatever you're used to, but I hope it's pretty clear. A fade works on the <span style="font-style: italic">top</span> layers (REG_BLDCNT{0-5}), not on the bottom layers (REG_BLDCNT{8-D}), maybe that was the problem. Also, you probably need to include the backdrop too, otherwise 0-pixels will shine through, which is probably undesireable.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
// blend build macro: top layer, source layer, blend mode
<br/>
#define BLD_BUILD(_top, _bot, _mode) \
<br/>
    ( (_top) | (((_mode)&amp;3)&lt;&lt;6) | ((_bot)&lt;&lt;8) )
<br/>
<br/>
int main()
<br/>
{
<br/>
    REG_DISPCNT= DCNT_MODE4 | DCNT_BG2_ON;
<br/>
<br/>
    // fill the screen with random pixels (replace with image, of course)
<br/>
    int ii;
<br/>
    for(ii=0; ii&lt;256; ii++)
<br/>
        pal_bg_mem[ii]= rand();
<br/>
<br/>
    for(ii=0; ii&lt;120*160; ii++)
<br/>
        vid_mem[ii]= rand();
<br/>
<br/>
    // set blend mode: 
<br/>
    //   top=bg2 and backdrop
<br/>
    //   bottom= none
<br/>
    //   fade to white (mode=2) 
<br/>
    // (REG_BLDCNT == REG_BLDMOD)
<br/>
    REG_BLDCNT = BLD_BUILD((1&lt;&lt;2)|(1&lt;&lt;5), 0, 2);
<br/>
<br/>
    // ey denotes fade level. (Well, ey denotes 8*fade level, 
<br/>
    // because I don't want the fade to be too fast)
<br/>
    u32 ey=0;
<br/>
    while(1)
<br/>
    {
<br/>
        vid_vsync();
<br/>
        REG_BLDY= ey&gt;&gt;3; // REG_BLDY == REG_COLEY (yeah overflow, so what?)
<br/>
        ey++;            
<br/>
    }
<br/>
    return 0;
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
And like Chris said, modifing the palette itself will work too (mosaic isn't required, though).</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#47707 - Fatnickc - Tue Jul 12, 2005 4:10 pm</h4>
    <div class="postbody"><span class="postbody">I don't even have some of those definations, so that'sprobably where I'm going wrong. Perhaps you could provide me with the definations of all the REGs, so I can at least run it?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#47726 - tepples - Tue Jul 12, 2005 8:18 pm</h4>
    <div class="postbody"><span class="postbody">There are all sorts of 'gba.h' files floating around.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#47728 - Fatnickc - Tue Jul 12, 2005 8:30 pm</h4>
    <div class="postbody"><span class="postbody">Yes, and they are all different.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#47729 - tepples - Tue Jul 12, 2005 8:45 pm</h4>
    <div class="postbody"><span class="postbody">They're all different, but they are similar. You can usually resolve naming differences by checking against GBATEK or the CowBite spec. Recent code may be written against the header files that come with libgba, which is available from the same place where you got devkitARM.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#47779 - Fatnickc - Wed Jul 13, 2005 10:38 am</h4>
    <div class="postbody"><span class="postbody">Thank you tepples, and thank you Cearn. When I'm back on the fast computer sometime soon(search around..). I'll add to me header files, as appropriate, and then attempt the above code. 
<br/>
Cearn, is the vid_mem just the bg_mem? So, if you use pcx2gba, it's the first part, right?
<br/>
<br/>
Following what CowBite and GBATEK say, the REGs I was stuck on are just the same as some of the other ones. However, this results in 'warning : assignment of read only memory'. I can understand this, but it must be the way I make REG_BLDCNT and REG_BLDY the same as REG_BLDMOD and REG_COLEY respectively. At the moment I just define them as each other, and think this is wrong. However, saying 
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">REG_BLDY == REG_COLEY</td> </tr></table><span class="postbody">
<br/>
doesn't work either, with an error from the compiler. What am I to do?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#47803 - Quirky - Wed Jul 13, 2005 7:48 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#define REG_COLEY      *(volatile u16*)0x4000054
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
That's what my gba.h has, taken many moons ago from the pern project.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#47815 - Fatnickc - Wed Jul 13, 2005 9:17 pm</h4>
    <div class="postbody"><span class="postbody">Urrm.. I wasn't looking for that one though..</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#47889 - Fatnickc - Thu Jul 14, 2005 9:17 am</h4>
    <div class="postbody"><span class="postbody">I've just tried another method, which doesn't work either. 
<br/>
I'm going to post my code here, and can you test it to see if it works with you?
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#include "gba.h"
<br/>
#include "bg.h"
<br/>
<br/>
<br/>
void SleepQ(int i) 
<br/>
{ 
<br/>
   int x, y; 
<br/>
   int c; 
<br/>
   for (y = 0; y &lt; i; y++) 
<br/>
   { 
<br/>
      for (x = 0; x &lt; 4000; x++) 
<br/>
         c = c + 2; // do something to slow things down 
<br/>
   } 
<br/>
} 
<br/>
<br/>
<br/>
//****************************************************************************** 
<br/>
void fadeout( u32 aWait ) 
<br/>
{ 
<br/>
   s8 Phase; 
<br/>
   REG_BLDMOD = 0 | 1 | 2 | 4 | 8 | 128 | 64 | 32; 
<br/>
   for( Phase = 0; Phase &lt; 17; Phase++ ) 
<br/>
   { 
<br/>
      REG_COLEY = Phase; 
<br/>
      SleepQ( aWait ); 
<br/>
   } 
<br/>
} 
<br/>
<br/>
//****************************************************************************** 
<br/>
void fadein( u32 aWait ) 
<br/>
{ 
<br/>
   s8 Phase; 
<br/>
   REG_BLDMOD = 0 | 1 | 2 | 4 | 8 | 128 | 64 | 32; 
<br/>
   for( Phase = 0; Phase &lt; 16; Phase++ ) 
<br/>
   { 
<br/>
      REG_COLEY = 16-Phase; 
<br/>
      SleepQ ( aWait ); 
<br/>
   } 
<br/>
} 
<br/>
u16 loop;
<br/>
int main() 
<br/>
{ 
<br/>
<br/>
   SetMode(MODE_4 | BG2_ENABLE | OBJ_ENABLE | OBJ_MAP_1D);
<br/>
<br/>
   for (loop = 0; loop &lt; 256; loop++) {
<br/>
      BG_PaletteMem[loop]=bgPalette[loop];
<br/>
   }
<br/>
<br/>
   for (loop = 0; loop &lt; (120*160); loop++) {
<br/>
      FrontBuffer[loop] = bgData[loop] ;
<br/>
   }
<br/>
fadeout(10);
<br/>
return 0;
<br/>
<br/>
} 
<br/>
<br/>
<br/>
<br/>
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Is it the way in which I assign my background which is wrong?
<br/>
What this currently does is turn 2 pixels at the top, to the left of the center black, and then a while later flash back to white, then go black again straight away.
<br/>
This is similar to what other methods have resulted in, except for now the pixels flash.
<br/>
I'm fairly sure that I am at fault, and not the methods, as so many have not seemed to work, producing the same results.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#47890 - headspin - Thu Jul 14, 2005 10:10 am</h4>
    <div class="postbody"><span class="postbody">Check out the site in my sig, there is some basic fade-in/out code there. It worked for me! :)<br/>_________________<br/><a class="postlink" href="http://headsoft.com.au/index.php?category=warhawk" target="_blank">Warhawk DS</a> | <a class="postlink" href="http://headsoft.com.au/index.php?category=mmll" target="_blank">Manic Miner: The Lost Levels</a> | <a class="postlink" href="http://headsoft.com.au/index.php?category=tdg" target="_blank">The Detective Game</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#47891 - Fatnickc - Thu Jul 14, 2005 10:23 am</h4>
    <div class="postbody"><span class="postbody">Thank you, that works! However, it doesn't fade all the way down to black. I think this may be to do with what I set fade to. What did you set it to?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#47958 - Cearn - Fri Jul 15, 2005 10:51 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Fatnickc wrote:</b></span></td> </tr> <tr> <td class="quote">Thank you tepples, and thank you Cearn. When I'm back on the fast computer sometime soon(search around..). I'll add to me header files, as appropriate, and then attempt the above code. 
<br/>
Cearn, is the vid_mem just the bg_mem? So, if you use pcx2gba, it's the first part, right?
<br/>
</td> </tr></table><span class="postbody">vid_mem is VRAM pointer is (u16*)0x06000000. I usually use my own <a class="postlink" href="http://user.chem.tue.nl/jakvijn/tonc/" target="_blank">headers/library</a>. This includes a page on blending which I've pointed to in other threads as well, so I thought you'd seen it already.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Following what CowBite and GBATEK say, the REGs I was stuck on are just the same as some of the other ones. However, this results in 'warning : assignment of read only memory'. I can understand this, but it must be the way I make REG_BLDCNT and REG_BLDY the same as REG_BLDMOD and REG_COLEY respectively. </td> </tr></table><span class="postbody">
<br/>
This usually works:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#define REG_BLDCNT REG_BLDMOD
<br/>
#define REG_BLDY REG_COLEY
<br/>
</td> </tr></table><span class="postbody">Or the other way around, depending on which ones you have in your own header files. 
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void SleepQ(int i) 
<br/>
{ 
<br/>
   int x, y; 
<br/>
   int c; 
<br/>
   for (y = 0; y &lt; i; y++) 
<br/>
   { 
<br/>
      for (x = 0; x &lt; 4000; x++) 
<br/>
         c = c + 2; // do something to slow things down 
<br/>
   } 
<br/>
}</td> </tr></table><span class="postbody"></span></td> </tr></table><span class="postbody">
<br/>
If you have any level of optimisation on, this probably won't work at all. Since variable c isn't used anywhere else, c= c+2 (commonly referred to as c+=2), will be optimised out. Since the x loop doesn't do anything then either, it is optimised out as well. Since the y loop will be empty at that point as well, it too will go and the function will be a complete no-op. If you want to wait a while, use a vsync or a timer or something like that.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void fadein( u32 aWait ) 
<br/>
{ 
<br/>
   s8 Phase; 
<br/>
   REG_BLDMOD = 0 | 1 | 2 | 4 | 8 | 128 | 64 | 32; 
<br/>
   for( Phase = 0; Phase &lt; 16; Phase++ ) 
<br/>
   { 
<br/>
      REG_COLEY = 16-Phase; 
<br/>
      SleepQ ( aWait ); 
<br/>
   } 
<br/>
}</td> </tr></table><span class="postbody"></span></td> </tr></table><span class="postbody">The fade out seems ok, but at the end of fade in REG_COLEY will be set to 1. The loop ends at 15 after all. Oh, and <a class="postlink" href="http://forum.gbadev.org/viewtopic.php?p=43025&amp;highlight=#43025" target="_blank">don't use non-word types as local variables</a>.
<br/>
<br/>
If you're now using headspin's fade out:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void fade_out()
<br/>
{
<br/>
    while (fade != (16&lt;&lt;1))
<br/>
   {
<br/>
        fade++;
<br/>
        FadeIn((fade&gt;&gt;2)); 
<br/>
        WaitVBlank();
<br/>
    }
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
Note that the maximum value of fade is 31. The maximum value passed to FadeIn is fade/4 = 7, which is about half a fade. Also, note that in neither fade_in nor fade_out the fade variable ever gets a value, is this supposed to be a global variable? (Hmm, since it's not even declared there, probably)
<br/>
<br/>
And @headspin, why use </span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">u16 *reg_BLDMOD = (u16 *)0x4000050;
<br/>
<br/>
reg_BLDMOD[0]= ...;
<br/>
</td> </tr></table><span class="postbody"> when </span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#define REG_BLDMOD (*(volatile u16*)0x04000050)
<br/>
<br/>
REG_BLDMOD= ...;
<br/>
</td> </tr></table><span class="postbody">
<br/>
is easier for users, doesn't create an extra variable for the register and is possibly safer due to the volatile?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#47962 - Fatnickc - Fri Jul 15, 2005 11:58 am</h4>
    <div class="postbody"><span class="postbody">Yes, I already had it as a global variable, I was just wondering what to set it as..
<br/>
Anyway, with a few tweaks I got headspin's method down to going all the way down to black. Also, at the same time, I worked out how to do a fairly simple wipe from the top, which works nicely. Thanks headspin for the method, and thanks cearn for the insight ;).
<br/>
Now, I'd like to know about lightening the image. I assumed that if you changed the fade_in function to continue for longer than until it was back to normal, you would have a fade to white, but this doesn't work, instead changing to black as soon as it has reached normal and tries to proceed. 
<br/>
What changes could one make to the fade_in (or indeed fade_out) to make it go to white?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#48132 - Quirky - Sun Jul 17, 2005 12:34 pm</h4>
    <div class="postbody"><span class="postbody">For fading and "whiting" I use the following:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
void screen_fade(int level)
<br/>
{
<br/>
  if (level &gt; 16)
<br/>
    level = 16;
<br/>
  if (level &lt; 0)
<br/>
    level = 0;
<br/>
  REG_BLDMOD = BLDMOD_FIRST_BG1 | BLDMOD_FIRST_BG0 | BLDMOD_FIRST_BG2|
<br/>
    BLDMOD_FIRST_OBJ | BLDMOD_SECOND_BD | BLDMOD_MODE(3);
<br/>
  REG_COLEY = level;
<br/>
}
<br/>
<br/>
void screen_fade_out()
<br/>
{
<br/>
  int loop;
<br/>
  for (loop = 0; loop &lt; 17; loop++) {
<br/>
    wait_vsync_int();
<br/>
    screen_fade(loop);
<br/>
  }
<br/>
}
<br/>
void screen_fade_in()
<br/>
{
<br/>
  int loop;
<br/>
  for (loop = 0; loop &lt; 17; loop++) {
<br/>
    wait_vsync_int();
<br/>
    screen_fade(16-loop);
<br/>
  }
<br/>
}
<br/>
<br/>
void screen_white(int level)
<br/>
{
<br/>
  if (level &gt; 16)
<br/>
    level = 16;
<br/>
  if (level &lt; 0)
<br/>
    level = 0;
<br/>
  REG_BLDMOD = BLDMOD_FIRST_BD
<br/>
     | BLDMOD_MODE(2);
<br/>
  REG_COLEY = level;
<br/>
}
<br/>
<br/>
void screen_white_out()
<br/>
{
<br/>
  int loop;
<br/>
  for (loop = 0; loop &lt; 17; loop++) {
<br/>
    wait_vsync_int();
<br/>
    screen_white(loop);
<br/>
  }
<br/>
}
<br/>
void screen_white_in()
<br/>
{
<br/>
  int loop;
<br/>
  for (loop = 0; loop &lt; 17; loop++) {
<br/>
    wait_vsync_int();
<br/>
    screen_white(16-loop);
<br/>
  }
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
All the details of which bits you should set, in case you don't have the defines, are here:
<br/>
<a class="postlink" href="http://www.cs.rit.edu/~tjh8300/CowBite/CowBiteSpec.htm#Effects%20Registers" target="_blank"> Cowbite effects registers descriptions</a></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
