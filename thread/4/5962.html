<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>n00b Sprite Corruption - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>Coding > n00b Sprite Corruption</h2>
<div id="posts">
<div class="post">
    <h4>#44967 - AkumaATR - Mon Jun 06, 2005 11:51 pm</h4>
    <div class="postbody"><span class="postbody">My problematic code is below -- it's a variation of the one of the tutorials from Jonathan Harbour's free materials.
<br/>
<br/>
My problems is as follows: I've been having an issue getting sprites to work in 4bpp (16 color) mode all afternoon. i was able to get it to work in 256 color mode, so i'm completely confused now (since i thought i had figured it out). i know this code is ugly but i just wanted to get it working first.
<br/>
<br/>
i have tried using pcx2sprite (pcx2sprite h:16 ?w:16 -16) and gfx2gba (gfx2gba -t8 -c16 -fsrc star_64x64.bmp). the source image was def. 16 color, correct palette entries.
<br/>
<br/>
original image: <a href="http://home.insightbb.com/~cecil.jason/files/star_64x64.bmp" target="_blank">http://home.insightbb.com/~cecil.jason/files/star_64x64.bmp</a>
<br/>
<br/>
corrupt image displayed by this code: <a href="http://home.insightbb.com/~cecil.jason/files/corrupt_star.bmp" target="_blank">http://home.insightbb.com/~cecil.jason/files/corrupt_star.bmp</a>
<br/>
<br/>
Thanks for any help everyone.
<br/>
<br/>
Code Follows:
<br/>
<br/>
//typedefs
<br/>
typedef unsigned short u16;
<br/>
<br/>
#include "star_64x64.h"
<br/>
#include "star_64x64.c"
<br/>
<br/>
//macros
<br/>
#define SetMode(mode) REG_DISPCNT = (mode)
<br/>
#define REG_DISPCNT *(volatile unsigned short *)0x4000000
<br/>
#define BGPaletteMem ((unsigned short *)0x5000000)
<br/>
#define REG_VCOUNT *(volatile unsigned short *)0x4000006
<br/>
#define REG_DISPSTAT *(volatile unsigned short *)0x4000004
<br/>
<br/>
//OAM mem state addy
<br/>
#define SpriteMem ((unsigned short *)0x7000000)
<br/>
<br/>
//OAM image addy
<br/>
#define SpriteData ((unsigned short *)0x6010000)
<br/>
<br/>
//OAM palette addy
<br/>
#define SpritePal ((unsigned short *)0x5000200)
<br/>
<br/>
//misc constants
<br/>
#define OBJ_MAP_2D 0x0
<br/>
#define OBJ_MAP_1D 0x40
<br/>
#define OBJ_ENABLE 0x1000
<br/>
<br/>
//attr0 stuff
<br/>
#define ROTATION_FLAG 0x100
<br/>
#define SIZE_DOUBLE 0x200
<br/>
#define MODE_NORMAL 0x0
<br/>
#define MODE_TRANSPARENT 0x400
<br/>
#define MODE_WINDOWED 0x800
<br/>
#define MOSAIC 0x1000
<br/>
#define COLOR_16 0x0000
<br/>
#define COLOR_256 0x2000
<br/>
#define SQUARE 0x0
<br/>
#define TALL 0x4000
<br/>
#define WIDE 0x8000
<br/>
<br/>
//attr1 stuff
<br/>
#define ROTDATA(n)  ((n) &lt;&lt; 9)
<br/>
#define HORIZONTAL_FLIP 0x1000
<br/>
#define VERTICAL_FLIP 0x2000
<br/>
#define SIZE_8 0x0
<br/>
#define SIZE_16 0x4000
<br/>
#define SIZE_32 0x8000
<br/>
#define SIZE_64 0xC000
<br/>
<br/>
//attr2 stuff
<br/>
#define PRIORITY(n) ((n &lt;&lt; 10)
<br/>
#define PALETTE(n)  ((n &lt;&lt; 12)
<br/>
<br/>
//sprite structs
<br/>
typedef struct tagSprite
<br/>
{
<br/>
    unsigned short attribute0;
<br/>
    unsigned short attribute1;
<br/>
    unsigned short attribute2;
<br/>
    unsigned short attribute3;
<br/>
} Sprite, *pSprite;
<br/>
<br/>
//array of 128 sprites
<br/>
Sprite sprites[128];
<br/>
<br/>
void WaitForVSync(void);
<br/>
void UpdateSpriteMemory(void);
<br/>
<br/>
int main(void)
<br/>
{
<br/>
    signed short x = 20, y = 20;
<br/>
    int char_number = 0;
<br/>
    int n;
<br/>
    SetMode(2 | OBJ_ENABLE | OBJ_MAP_1D);
<br/>
<br/>
    //set sprite palette
<br/>
    for (n = 0; n &lt; 8; n++)
<br/>
    {
<br/>
        SpritePal[n] = star_64x64Palette[n];
<br/>
    }
<br/>
<br/>
    //load sprite image data
<br/>
    for (n = 0; n &lt; 1024; n++)
<br/>
    {
<br/>
       SpriteData[n] = star_64x64Data[n];
<br/>
    }
<br/>
<br/>
    sprites[0].attribute0 = COLOR_16 | y;
<br/>
    sprites[0].attribute1 = SIZE_64 | x;
<br/>
    sprites[0].attribute2 = char_number;
<br/>
<br/>
    while (1)
<br/>
    {
<br/>
        WaitForVSync();
<br/>
        UpdateSpriteMemory();
<br/>
    }
<br/>
}
<br/>
<br/>
void WaitForVSync(void)
<br/>
{
<br/>
    while ((REG_DISPSTAT &amp; 1));
<br/>
}
<br/>
<br/>
void UpdateSpriteMemory(void)
<br/>
{
<br/>
    int n;
<br/>
    unsigned short* temp;
<br/>
    temp = (unsigned short *)sprites;
<br/>
    for (n = 0; n &lt; 128 * 4; n++)
<br/>
        SpriteMem[n] = temp[n];
<br/>
}</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#45035 - AkumaATR - Tue Jun 07, 2005 5:24 am</h4>
    <div class="postbody"><span class="postbody">damn zero replies!!! and i was all excited to have come home to some assistance... hehe</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#45036 - tepples - Tue Jun 07, 2005 5:31 am</h4>
    <div class="postbody"><span class="postbody">It looks like you're getting 256-color tile data. No, I don't know the specific arguments to pass to those programs to make them output 16-color tile data.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#45088 - AkumaATR - Tue Jun 07, 2005 4:49 pm</h4>
    <div class="postbody"><span class="postbody">The problem ended up being that gfx2gba spits out unpacked values, rather than packed ones, even though I told I specified 16 color mode as a parameter.
<br/>
<br/>
For example, four red pixels in a row (where red is palette index 1) should look like this from the tool.
<br/>
<br/>
0x1111, ...
<br/>
<br/>
gfx2gba spits out
<br/>
<br/>
0x0101, 0x0101 in an array that is twice as big as it should be. I was using the -fsrc to get source code instead of raw output, so their may just be a big with that flag. Of course it's possible I'm still doing something wrong but I did notice many posts about strangeness with 16 color mode w/ gfx2gba that makes me think the tool may have a bug. I tried using gif2sprite and it worked, spitting out a proper data array representing a 16 color sprite.
<br/>
<br/>
- Jason</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#45092 - poslundc - Tue Jun 07, 2005 5:26 pm</h4>
    <div class="postbody"><span class="postbody">In the long run, if you are serious about GBA programming, you will probably wind up having to write your own tools anyway.
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
