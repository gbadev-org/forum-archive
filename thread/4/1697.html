<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Crazy DMA problem! - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>Coding > Crazy DMA problem!</h2>
<div id="posts">
<div class="post">
    <h4>#8597 - regularkid - Wed Jul 16, 2003 4:07 am</h4>
    <div class="postbody"><span class="postbody">Ok. I'm trying to simply clear the video buffer (back buffered) each frame (mode 4) before drawing to it. However, I am using DMA to fill the video buffer to a specific color. When I use DMA by setting the registers up at the beginning of the game loop, everything works fine and the rest of the drawing gets done on top of it. But when I call a function to setup the DMA registers, the rest of the drawing gets drawn below the screen clear. Very strange. My only guess is that for some reason when you return from a function that does DMA stuff, it waits to do the transfer? Here is my game loop code:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
while(1)
<br/>
{
<br/>
    u16 color = (0 | (0 &lt;&lt; 8));
<br/>
<br/>
#if 0
<br/>
    DMA_Fill(19200, (u32*)&amp;color, (u32*)g_VideoBuffer);
<br/>
#else
<br/>
    REG_DMA3SAD = (u32)&amp;
<br/>
    REG_DMA3DAD = (u32)g_VideoBuffer;
<br/>
    REG_DMA3CNT = 19200 | WORD_SIZE_16 | TIMING_IMMEDIATE | SOURCE_FIXED | DESTINATION_INCREMENT | ENABLE;
<br/>
#endif
<br/>
<br/>
    LEVEL_Draw();
<br/>
<br/>
    VIDEO_WaitVSync();
<br/>
    VIDEO_Flip();
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
The DMA_Fill call has the exact same code as the #else part of that block. When I use the function call (#if 1), I only see the screen fill. But when I use the DMA code without the function call (#if 0), then everything works fine and everything in LEVEL_Draw() gets drawn perfectly. Very strange! Any help at all would be greatly appreciated!
<br/>
<br/>
NOTE: When I change the number of words to copy to 9600 (half of the screen), I can see my LEVEL_Draw() stuff behind the half-cleared screen when I use the DMA_Fill call.<br/>_________________<br/>- RegularKid</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#8599 - night_ - Wed Jul 16, 2003 6:41 am</h4>
    <div class="postbody"><span class="postbody">On the first, quick look it appears a bit strange to me that you cast the address of color, which is a 16 bit number, 
<br/>
to a pointer to a 32 bit number in order to pass it to your function. It should be enough to just pass the address of color
<br/>
(u32) &amp;color and write this to the src register: REG_DMA3SAD = passedValue; Also check this for g_Videobuffer.
<br/>
Maybe I can have a closer look at this after having some sleep..</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#8600 - regularkid - Wed Jul 16, 2003 7:27 am</h4>
    <div class="postbody"><span class="postbody">The reason that I cast it to a 32bit pointer is because that is what the dma source and destination register's types are. However, the g_VideoBuffer is a 16bit pointer and the color is also 16bit. That is the reason for the cast.<br/>_________________<br/>- RegularKid</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#8606 - Lupin - Wed Jul 16, 2003 12:41 pm</h4>
    <div class="postbody"><span class="postbody">Sorry, but I couldn't really come up with an real solution, but if you want to solve your problem, why don't you use an simple #define for your DMA copy routine? It's faster (branching costs a bit of time) and it would solve your problem. You could also use an inline function, but I prefer #defines, since the compiler doesn't generate code for the define (it generates an function label for inlined functions....)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#8612 - night_ - Wed Jul 16, 2003 3:45 pm</h4>
    <div class="postbody"><span class="postbody">I think you got me wrong. What you need is a address which is 32 bits and not an address that points to
<br/>
a 32 bit value. What you do is casting the pointer. (u32) &amp;color is just casting the address value to a 32 bit value.
<br/>
<br/>
Do the following: make color and videobuffer global. Use the exact same code in your function as you do in your endless loop.
<br/>
That also means: Do not access the passed values but the globals. If that works, consider reading my first post again.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#8628 - Archeious - Wed Jul 16, 2003 9:37 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Lupin wrote:</b></span></td> </tr> <tr> <td class="quote">Sorry, but I couldn't really come up with an real solution, but if you want to solve your problem, why don't you use an simple #define for your DMA copy routine? It's faster (branching costs a bit of time) and it would solve your problem. You could also use an inline function, but I prefer #defines, since the compiler doesn't generate code for the define (it generates an function label for inlined functions....)</td> </tr></table><span class="postbody">
<br/>
<br/>
Should read the article in Game Programmings Gems 2 by Peter Dalton.  He explains why inline functions are 90% of the time better then macros.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#8630 - jd - Wed Jul 16, 2003 11:28 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
    REG_DMA3SAD = (u32)&amp;
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Maybe the above is just a typo in your post, but that code should read:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
    REG_DMA3SAD = (u32)&amp; color;
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
(Actually, I'm pretty sure that's a bug in the forum because it just removed the "color;" from my version as well. I had to add a space between &amp; and "color;" to get it to work.)
<br/>
<br/>
Also, if DMA_Fill() has exactly the same code as the #else part of the block then it might be setting DMA3SAD to point to the address of <span style="font-weight: bold">the address of</span> color. Posting the code to DMA_Fill() would help to clarify things.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#8663 - Lupin - Thu Jul 17, 2003 2:37 pm</h4>
    <div class="postbody"><span class="postbody">Archeious, why are inline functions faster then macros? Sorry, but I don't want to buy an whole book just to be enlightened about this small topic :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#8666 - night_ - Thu Jul 17, 2003 3:48 pm</h4>
    <div class="postbody"><span class="postbody">offtopic:
<br/>
<br/>
- inline functions are c++
<br/>
- with inline functions you have type checking (compile time errors!). To a macro you can pass any data type. 
<br/>
- inline functions evaluate every argument only once, whereas macros just put the arguments into the macro code. 
<br/>
<br/>
A classic example for a common error is:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code"> #define abs_macro(i) ( (i) &gt;= 0 ? (i) : -(i) ) //absolute value macro</td> </tr></table><span class="postbody">
<br/>
user code:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">abs_macro(i++); </td> </tr></table><span class="postbody">
<br/>
<br/>
produces the following code:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code"> (i++) &gt;= 0 ? (i++) : -(i++) </td> </tr></table><span class="postbody">
<br/>
so if you want the absolute value of 3 you get 5. Which is obviously wrong.
<br/>
<br/>
 It is also imprtant to put paranthesis around the arguments.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code"> #define multiply_macro(i,j) (i*j) //absolute value macro</td> </tr></table><span class="postbody">
<br/>
<br/>
user code:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">multiply_macro(a+b,c+d);</td> </tr></table><span class="postbody">
<br/>
<br/>
results in
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">a+b*c+d</td> </tr></table><span class="postbody">
<br/>
<br/>
b and c are multiplied,which is obviously not what the user intended.
<br/>
<br/>
this solves the problem:
<br/>
 #define multiply_macro(i,j) ((i)*(j)) //absolute value macro
<br/>
<br/>
If I code in C on projects that need high performance, I use functions in the debug and corresponding macros in the release version, because macro code can be a nightmare to debug.
<br/>
<br/>
Please also note that macros and inline functions can blow up your code. There are other issues, but as this is off-topic and I have already written more than I wanted...
<br/>
<br/>
Oh.. your question. If you still want to know: inline functions may be a little bit slower than macros, but if you use c++, use inline functions because they are,for the above reasons, BETTER not FASTER.</span><span class="gensmall"><br/><br/>Last edited by night_ on Thu Jul 17, 2003 9:46 pm; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#8674 - Cyberman - Thu Jul 17, 2003 8:17 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>night_ wrote:</b></span></td> </tr> <tr> <td class="quote">offtopic:
<br/>
<br/>
- inline functions are c++
<br/>
- with inline functions you have type checking (compile time errors!). To a macro you can pass any data type. 
<br/>
- inline functions evaluate every argument only once, whereas macros just put the arguments into the macro code. 
<br/>
</td> </tr></table><span class="postbody">
<br/>
1 : Yes this seems sad.. but that really isn't a problem unless you are not using the GCC compilor :)
<br/>
<br/>
2: This is GOOD type checking makes for fewer mistakess. Macros can create problems because of type checking in any case, debugging the output of the pre processor can be a nightmare, trust me I've spent several hours trying to find a single macro mistake.  Bottom line is be sure you are doing what you think you are doing, Macros don't magically make this happen.
<br/>
<br/>
3: Inline functions are quite similiar to macros however there are subtle if not important differences.  Inline means the compilor generates the code inline with the code the 'function' call appears in. Thus no function call ocurs. However you do not expose anything of your class, or what the function is doing you might also protect passed variables from being modified etc. The advantage here is inline only generates code for what is necessary.  Another important difference is you can't have temporary variables in macros (you can in inline functions). Inlines are perfectly good to use and can lead to simplification (it mostly depends on how well organized the programer is). Macros are good to use as well. So what does one do? Use the right feature for the right thing. Macros are excelent for handling complex function calls and creating complicated structures without making the code a nightmare, at the same time, one has to know what they are doing.
<br/>
<br/>
A good example of a useful macro definition:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#define AREA_TAG(NAME)\
<br/>
{\
<br/>
TAG_AREA_ID,\
<br/>
#NAME,\
<br/>
NAME##_Data\
<br/>
};
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
An example of using this kind of macro
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
TAG_AREA Sandusky_Region_List[] =
<br/>
{
<br/>
 MK_AREA_TAG(Sandusky_Desert),
<br/>
 MK_AREA_TAG(Sandusky_OceanSide),
<br/>
 MK_AREA_TAG(Sandusky_Mountain),
<br/>
 MK_AREA_TAG(Sandusky_City),
<br/>
 MK_AREA_TAG(Sandusky)
<br/>
};
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
One would use other macros to create the structures used by the region list (in the above array) this code saves one a LOT of typing :) This is a good use for a macro.
<br/>
<br/>
Inlines uses are more obvious.. so I don't see the need for examples.
<br/>
<br/>
Cyb</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#8680 - Archeious - Thu Jul 17, 2003 10:25 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Lupin wrote:</b></span></td> </tr> <tr> <td class="quote">Archeious, why are inline functions faster then macros? Sorry, but I don't want to buy an whole book just to be enlightened about this small topic :)</td> </tr></table><span class="postbody">
<br/>
<br/>
Sorry if I led you to think inline function are faster.  I won't go over the reason to use inline vs #defines, it looks like that has been taken care of.
<br/>
<br/>
I use inline function when they are well just that functions (well psuedo functions) like DMA copies because of the compile time typecasting and arguments are only evaluated once. 
<br/>
<br/>
Once again sorry if I led you to any confusion.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#8696 - peebrain - Fri Jul 18, 2003 4:27 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Cyberman wrote:</b></span></td> </tr> <tr> <td class="quote">Another important difference is you can't have temporary variables in macros (you can in inline functions).</td> </tr></table><span class="postbody">
<br/>
<br/>
Yeah you can.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#define LOOP_MACRO(v)  \
<br/>
{\
<br/>
for (int i = 0; i &lt; 10; i++)\
<br/>
v = v + i * v;\
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Voila!  Just put braces around the entire thing to generate a new scope.
<br/>
<br/>
~Sean<br/>_________________<br/><a href="http://www.pbwhere.com" target="_blank">http://www.pbwhere.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#8707 - niltsair - Fri Jul 18, 2003 2:38 pm</h4>
    <div class="postbody"><span class="postbody">in </span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">#define AREA_TAG(NAME)\
<br/>
{\
<br/>
TAG_AREA_ID,\
<br/>
#NAME,\
<br/>
NAME##_Data\
<br/>
}; </td> </tr></table><span class="postbody"> What are the # in #NAME and NAME##_Data for?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#8710 - Nessie - Fri Jul 18, 2003 3:03 pm</h4>
    <div class="postbody"><span class="postbody">I think # is the macro stringize feature if I remember correctly?
<br/>
<br/>
Basically you could do something like this:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">//Helper macro
<br/>
#define ENUM2STR(_enum)  _enum,#_enum
<br/>
<br/>
enum ECityEnum
<br/>
{
<br/>
    Madison = 0,
<br/>
    Chicago,
<br/>
    London,
<br/>
    Paris,
<br/>
};
<br/>
<br/>
// Simple hypothetical structure
<br/>
typedef struct SCityElement
<br/>
{
<br/>
    ECityEnum mCity;
<br/>
    const char *mCityString;
<br/>
} TCityElement;
<br/>
<br/>
TCityElement CityList[]=
<br/>
{
<br/>
    ENUM2STR(Madison),
<br/>
    ENUM2STR(Chicago),
<br/>
    ENUM2STR(London),
<br/>
    ENUM2STR(Paris),
<br/>
};
<br/>
<br/>
/* Is the same as:
<br/>
TCityElement CityList[]=
<br/>
{
<br/>
    Madison,"Madison",
<br/>
    Chicago,"Chicago",
<br/>
    London,"London",
<br/>
    Paris,"Paris"
<br/>
};
<br/>
*/
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Of course, I should probably test this, but hey if I'm wrong, I'm sure someone will kindly correct me.
<br/>
<br/>
Cheers</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#8734 - tepples - Fri Jul 18, 2003 6:36 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>peebrain wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#define LOOP_MACRO(v)  \
<br/>
{\
<br/>
for (int i = 0; i &lt; 10; i++)\
<br/>
v = v + i * v;\
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Voila!  Just put braces around the entire thing to generate a new scope.</span></td> </tr></table><span class="postbody">
<br/>
Actually, this will cause problems in an if-then construction because you want the caller to supply the final semicolon; otherwise, there will be problems in 'if' and 'do' constructions. The <a class="postlink" href="http://www.eskimo.com/~scs/C-faq/q10.4.html" target="_blank">comp.lang.c FAQ</a> suggests something like this:</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#define LOOP_MACRO(v)  \
<br/>
do {\
<br/>
for (int i = 0; i &lt; 10; i++)\
<br/>
v = v + i * v;\
<br/>
} while(0)</td> </tr></table><span class="postbody">
<br/>
Notice the lack of semicolon at the end.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
