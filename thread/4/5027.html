<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Hblank, multiplexed sprites and emulators - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>Coding > Hblank, multiplexed sprites and emulators</h2>
<div id="posts">
<div class="post">
    <h4>#35927 - gadget - Sun Feb 13, 2005 2:07 am</h4>
    <div class="postbody"><span class="postbody">I've been trying to get a small bit of code working for the past six hours. I'm trying to use hblank to up 6 sprites in OAM.  Each of these six sprites represent a row of blocks for a puzzle game. I'm trying to draw the entire board as sprites since otherwise it would require greater than the 128 available. 
<br/>
<br/>
Since the task requires two steps, determining which sprites are needed and updating shadow OAM and then secondly, dma'ing that information to OAM, i'm splitting these tasks on different hblanks. The problem i'm running into is consistency with emulators. VBA and NO$GBA will show the sprites displayed properly, but on hardware I get a blank line between rows of sprites. I've adjusted the lines on which the hblanks occur but I can't seem to get a timing that will work across both emulators and hardware. 
<br/>
<br/>
Does anyone have any information how to properly multiplex sprites?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#35928 - AnthC - Sun Feb 13, 2005 2:26 am</h4>
    <div class="postbody"><span class="postbody">Just my 2c you could DMA half the OAM in each line so that the next line is DMA'ed in on the current line, and ensure you only use half of your sprites on each line.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#35929 - poslundc - Sun Feb 13, 2005 2:59 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>gadget wrote:</b></span></td> </tr> <tr> <td class="quote">Since the task requires two steps, determining which sprites are needed and updating shadow OAM and then secondly, dma'ing that information to OAM, i'm splitting these tasks on different hblanks. The problem i'm running into is consistency with emulators. VBA and NO$GBA will show the sprites displayed properly, but on hardware I get a blank line between rows of sprites. I've adjusted the lines on which the hblanks occur but I can't seem to get a timing that will work across both emulators and hardware. </td> </tr></table><span class="postbody">
<br/>
<br/>
1. VBA (not sure about NO$GBA) does not accurately emulate memory access cycle timings. So you could be running out of cycles before HBlank ends.
<br/>
<br/>
2. You need to set the HBlank Interval Free bit in REG_DISPCNT in order to be able to access OAM during the HBlank period on hardware. It is quite possible that emulators may let you get away with it where hardware won't.
<br/>
<br/>
I get the impression from your wording that you are doing calculations and setting up your shadow-OAM during the HBlank period... if so, that is wrong, wrong, wrong. HBlank is <span style="font-style: italic">extremely</span> short; just enough time to copy some quick data (either with an interrupt or DMA) and bail out of there. Prepare all of your shadow-data during the previous frame or VBlank and have it all ready to load in when HBlank arrives.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Does anyone have any information how to properly multiplex sprites?</td> </tr></table><span class="postbody">
<br/>
<br/>
There are a number of strategies that depend on the nature of what your game is doing. For a text-based system where you'll be switching sprites at a consistent interval, a workable strategy would be to use an HBlank interrupt alongside a VCOUNT interrupt. The line before you want to switch, have the VCOUNT interrupt update a flag that tells the HBlank interrupt that it has work to do, then have the HBlank interrupt copy the necessary data and clear the flag.
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#35937 - gadget - Sun Feb 13, 2005 8:56 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>poslundc wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
I get the impression from your wording that you are doing calculations and setting up your shadow-OAM during the HBlank period... if so, that is wrong, wrong, wrong. HBlank is <span style="font-style: italic">extremely</span> short; just enough time to copy some quick data (either with an interrupt or DMA) and bail out of there. Prepare all of your shadow-data during the previous frame or VBlank and have it all ready to load in when HBlank arrives.</td> </tr></table><span class="postbody">
<br/>
<br/>
There are two steps to what i'm doing. Firstly, i'm building six OMA entries into shadow during one hblank step. Second, i'm copying the bit of shadow into OAM during a second hblank. The array that the data resides in is updated during the main loop before vblank. When I build the six oam entries  I do so by changing only the character the oam points to and the palette it uses. The rest of the sprite characteristics remain the same from frame to frame.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#35956 - tepples - Sun Feb 13, 2005 4:57 pm</h4>
    <div class="postbody"><span class="postbody">On real GBA hardware, there is a delay between when you write to sprite memory and when it actually takes effect, as the PPU does some pipelined processing during one or more previous scanlines. This has been true of every Nintendo sprite engine since the NES.
<br/>
<br/>
Super Puzzle Fighter II uses a technique like what you mention, and I'm pretty sure it uses two rows of sprites to represent the playfield so that it can copy one while the other is displaying.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#36010 - gadget - Mon Feb 14, 2005 4:46 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tepples wrote:</b></span></td> </tr> <tr> <td class="quote">On real GBA hardware, there is a delay between when you write to sprite memory and when it actually takes effect, as the PPU does some pipelined processing during one or more previous scanlines. This has been true of every Nintendo sprite engine since the NES.
<br/>
<br/>
Super Puzzle Fighter II uses a technique like what you mention, and I'm pretty sure it uses two rows of sprites to represent the playfield so that it can copy one while the other is displaying.</td> </tr></table><span class="postbody">
<br/>
<br/>
That's the key I was looking for. I didn't realize the OAM was updated immediately which caused the blank lines I was seeing. I double the amount of OAM entries I was using to allow odd/even updating and that worked beautifully. It now works across both emulators and the hardware (SP and GBA player).
<br/>
<br/>
By the way, i'm writing a semi-clone of puzzle fighter, as I absolutely love that game.
<br/>
<br/>
Thanks so much for the help!</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
