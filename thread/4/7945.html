<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Multiboot  trouble - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>Coding > Multiboot  trouble</h2>
<div id="posts">
<div class="post">
    <h4>#65152 - Voelker - Fri Dec 30, 2005 6:18 pm</h4>
    <div class="postbody"><span class="postbody">I have recently bought a EZFA usb cable to load my programm into my gba with no need of an expensive cartridge. But when i load one of my programm sprites doesn't work but background display and i can use the keypad. This problem also occur with progs downloaded on the internet. The only programm i found working well with this cable is thingpong which use sprites. I d'ont know what to do to get my own programm working, so please help me ...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#65164 - Dwedit - Fri Dec 30, 2005 8:59 pm</h4>
    <div class="postbody"><span class="postbody">Sounds like the linker software boots the game into a dirty state.  Try manually resetting every register to what they should be before initally booting up.<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#65171 - tepples - Fri Dec 30, 2005 9:57 pm</h4>
    <div class="postbody"><span class="postbody">RegisterRamReset(0xFC) should do most of what you want.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#65187 - wintermute - Sat Dec 31, 2005 4:01 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tepples wrote:</b></span></td> </tr> <tr> <td class="quote">RegisterRamReset(0xFC) should do most of what you want.</td> </tr></table><span class="postbody">
<br/>
<br/>
Unlikely, the problem is with the multiboot loader in EZFA and, afaict, every USB based link port cable I've been able to lay my hands on.
<br/>
<br/>
Xboo Communicator will run code fine since the uploaded application is booted directly. See <a href="http://www.devkitpro.org/downloads.shtml" target="_blank">http://www.devkitpro.org/downloads.shtml</a>
<br/>
<br/>
I'm currently looking into supporting some USB cables with this app, I have an XG2 cable but donations of other cables would be appreciated :P</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#65188 - Dwedit - Sat Dec 31, 2005 4:19 am</h4>
    <div class="postbody"><span class="postbody">I've verified that the data sitting in EWRAM is identical to the original file when multibooting with a F2A cable.  But why would it fail to run in a dirty environment?<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#65189 - wintermute - Sat Dec 31, 2005 4:36 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Dwedit wrote:</b></span></td> </tr> <tr> <td class="quote">I've verified that the data sitting in EWRAM is identical to the original file when multibooting with a F2A cable.  But why would it fail to run in a dirty environment?</td> </tr></table><span class="postbody">
<br/>
<br/>
It's not a dirty environment as such. The loader tries to run apps in user mode so it can't set up it's IRQ stack.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#65190 - Dwedit - Sat Dec 31, 2005 5:13 am</h4>
    <div class="postbody"><span class="postbody">Any good way to get out of user mode?  Does the bug that lets you dump the bios also allow you to get out of user mode?
<br/>
<br/>
edit: nope, it was a dumb suggestion anyway...<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#65194 - chishm - Sat Dec 31, 2005 7:12 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>wintermute wrote:</b></span></td> </tr> <tr> <td class="quote">It's not a dirty environment as such. The loader tries to run apps in user mode so it can't set up it's IRQ stack.</td> </tr></table><span class="postbody">
<br/>
I had this problem with the GBAMP FW hack. To fix it, you need to be able to modify the multiboot loader. Run it through a disassmbler, or even VBA. Find the last mode change instruction (tends to be a mov r0, #x; msr cpsr, r0; where x is the mode value) and change it to a switch to supervisor mode, by changing the mov r0, #0x50 to mov r0, #0x5f. This should fix that particular problem.<br/>_________________<br/><a class="postlink" href="http://chishm.drunkencoders.com" target="_blank">http://chishm.drunkencoders.com</a>
<br/>
<a class="postlink" href="http://dldi.drunkencoders.com" target="_blank">http://dldi.drunkencoders.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#65197 - wintermute - Sat Dec 31, 2005 7:54 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>chishm wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>wintermute wrote:</b></span></td> </tr> <tr> <td class="quote">It's not a dirty environment as such. The loader tries to run apps in user mode so it can't set up it's IRQ stack.</td> </tr></table><span class="postbody">
<br/>
I had this problem with the GBAMP FW hack. To fix it, you need to be able to modify the multiboot loader. Run it through a disassmbler, or even VBA. Find the last mode change instruction (tends to be a mov r0, #x; msr cpsr, r0; where x is the mode value) and change it to a switch to supervisor mode, by changing the mov r0, #0x50 to mov r0, #0x5f. This should fix that particular problem.</span></td> </tr></table><span class="postbody">
<br/>
<br/>
Unfortunately in some of the devices I've looked at so far the loader is embedded in the driver :/</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#65198 - Dwedit - Sat Dec 31, 2005 8:15 am</h4>
    <div class="postbody"><span class="postbody">As long as it's not compressed or encoded in any strange way, if you can find the multiboot program, you can modify it with a hex editor.  Just gotta find it.  Usually lots of 4 byte words with the MSB beginning with E indicates ARM code, look for a bunch of E3's, E5's or E1's making columns.  Maybe some 1A's in there too.<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#65204 - Voelker - Sat Dec 31, 2005 2:42 pm</h4>
    <div class="postbody"><span class="postbody">How do you explain that the game thing pong which is using sprites and is setting is own IRQ, is running with this cable ?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#65205 - wintermute - Sat Dec 31, 2005 3:00 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Voelker wrote:</b></span></td> </tr> <tr> <td class="quote">How do you explain that the game thing pong which is using sprites and is setting is own IRQ, is running with this cable ?</td> </tr></table><span class="postbody">
<br/>
<br/>
Probably because it happens to use the same crt0 as the loader in the cable &amp; the stacks happen to be in the same place so nothing breaks.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#65211 - wintermute - Sat Dec 31, 2005 7:13 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Dwedit wrote:</b></span></td> </tr> <tr> <td class="quote">Any good way to get out of user mode?  Does the bug that lets you dump the bios also allow you to get out of user mode?
<br/>
<br/>
edit: nope, it was a dumb suggestion anyway...</td> </tr></table><span class="postbody">
<br/>
<br/>
That bug doesn't but there's an undocumented SWI (0xd4) which jumps to  0x02002040 which could be used to jump back to the crt0 in supervisor mode. I'll have a look at adding some suitable code to the default crt0.
<br/>
<br/>
If you want to test something in the meantime, the crt0 source and makefile is provided in the arm-elf/lib directory of devkitARM. Just open an msys shell, set the PATH if needed &amp; execute make CRT=gba
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
davem@NEUROMANCER /e/devkitPro_test/devkitARM/arm-elf/lib
<br/>
$ PATH=$PATH:$DEVKITARM/bin make CRT=gba
<br/>
arm-elf-gcc  -x assembler-with-cpp -marm -c gba_crt0.s -ogba_crt0.o
<br/>
arm-elf-gcc  -x assembler-with-cpp -marm -mthumb-interwork -c gba_crt0.s -o interwork/gba_crt0.o
<br/>
arm-elf-gcc  -x assembler-with-cpp -mthumb -c gba_crt0.s -o thumb/gba_crt0.o
<br/>
arm-elf-gcc  -x assembler-with-cpp -mthumb -mthumb-interwork -c gba_crt0.s -o thumb/interwork/gba_crt0.o
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#65224 - tepples - Sun Jan 01, 2006 2:29 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>wintermute wrote:</b></span></td> </tr> <tr> <td class="quote">there's an undocumented SWI (0xd4) which jumps to  0x02002040 which could be used to jump back to the crt0 in supervisor mode. I'll have a look at adding some suitable code to the default crt0.</td> </tr></table><span class="postbody">
<br/>
Wouldn't that seem to require reserving the first 8 KB of the program? And has the Game Boy micro's BIOS changed in any way that would keep this from working? And what effect would it have on emulators that high-level-emulate the BIOS (in order not to require the user to dump a BIOS file) and don't know what to do with SWI 0xD4?<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#65292 - wintermute - Sun Jan 01, 2006 10:37 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tepples wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>wintermute wrote:</b></span></td> </tr> <tr> <td class="quote">there's an undocumented SWI (0xd4) which jumps to  0x02002040 which could be used to jump back to the crt0 in supervisor mode. I'll have a look at adding some suitable code to the default crt0.</td> </tr></table><span class="postbody">
<br/>
Wouldn't that seem to require reserving the first 8 KB of the program? And has the Game Boy micro's BIOS changed in any way that would keep this from working? And what effect would it have on emulators that high-level-emulate the BIOS (in order not to require the user to dump a BIOS file) and don't know what to do with SWI 0xD4?</span></td> </tr></table><span class="postbody">
<br/>
<br/>
GB Micro BIOS is identical.
<br/>
<br/>
Code to use this method would obviously save and restore the contents of the memory when using the SWI so there would be no need to reserve memory.
<br/>
<br/>
I suppose code could be used to detect emulation and execute the code as appropriate.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#65316 - Dwedit - Mon Jan 02, 2006 12:41 am</h4>
    <div class="postbody"><span class="postbody">What registers are destroyed by the SWI to enter supervisor mode?<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
