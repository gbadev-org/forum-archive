<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Demo not working!! - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>Coding > Demo not working!!</h2>
<div id="posts">
<div class="post">
    <h4>#140315 - Ruben - Sat Sep 15, 2007 6:53 am</h4>
    <div class="postbody"><span class="postbody">I was recently adding the 'big map' thing a magig which I got working successfully but after I changed ALL the maps... MY DEMO STOPPED WORKING!! When I check the disassembly, I notice 2 weird things:
<br/>
1) It's mainly ARM code, even though my compiler flags include '-mthumb -mthumb-interwork'
<br/>
2) It's practically doing nothing ('mov r0, #0x800000' amongst others)
<br/>
I don't know what could be going on there as all I did was change my map sizes from 1024 to 4096. Thanks in advance.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#140345 - Cearn - Sat Sep 15, 2007 2:22 pm</h4>
    <div class="postbody"><span class="postbody">If you're using function pointer somewhere, it's possible you called a NULL function which make the code jump into neverneverland. If you see lots of repeated instructions, it's actually possible you're executing data rather than code. Look at the addresses and check the mapfile and find what those addresses are a part of. IWRAM overflow might be another problem: if you're creating a large local array, you might swamp the rest of IWRAM including the stack, causing everything after it go horribly wrong. If there's something more 'interesting' going on, we may need either the code or the binary to figure it out.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#140352 - Ruben - Sat Sep 15, 2007 3:39 pm</h4>
    <div class="postbody"><span class="postbody">Hi Cearn. I really don't know what's going on but I thought I'd disassemble it in VBA and these are the results:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">000000b8 ea000006 b $00000020
<br/>
00000020 e3a00302 mov r0, #0x8000000
<br/>
00000024 e1a0f000 mov pc, r0
<br/>
08000024 ea00002e b $080000c0
<br/>
080000c0 ea000000 b $000000c8
<br/>
080000c8 e3a00012 mov r0, #0x12
<br/>
080000cc e129f000 msr cpsr_fc, r0
<br/>
080000d0 e59fd09c ldr sp, [$08000174] (=$03007fa0)
<br/>
00000018 ea000088 b $00000240
<br/>
00000240 e92d500f stmfd sp!, {r0-r3,r12,lr}
<br/>
00000244 e3a00301 mov r0, #0x4000000
<br/>
00000248 e1a0e00f mov lr, pc
<br/>
0000024c e510f004 ldr pc, [r0, -#0x4]</td> </tr></table><span class="postbody">
<br/>
And it just repeats that over and over again... I don't know what might be causing it though... hm... I've uploaded the binary <a class="postlink" href="http://www.mediafire.com/?bjbggldb2vb" target="_blank">here</a> (it's in ELF format so you can debug it) and the disassembly <a class="postlink" href="http://www.mediafire.com/?7go92jtn2n1" target="_blank">here</a>.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#140355 - Cearn - Sat Sep 15, 2007 4:28 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">00000020 e3a00302 mov r0, #0x8000000
<br/>
00000024 e1a0f000 mov pc, r0
<br/>
<br/>
08000024 ea00002e b $080000c0
<br/>
080000c0 ea000000 b $000000c8
<br/>
080000c8 e3a00012 mov r0, #0x12
<br/>
080000cc e129f000 msr cpsr_fc, r0
<br/>
080000d0 e59fd09c ldr sp, [$08000174] (=$03007fa0)
<br/>
</td> </tr></table><span class="postbody">
<br/>
That's part of the boot-code. (note: early ROM addresses)
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
00000018 ea000088 b $00000240
<br/>
<br/>
00000240 e92d500f stmfd sp!, {r0-r3,r12,lr}
<br/>
00000244 e3a00301 mov r0, #0x4000000
<br/>
00000248 e1a0e00f mov lr, pc
<br/>
0000024c e510f004 ldr pc, [r0, -#0x4]</td> </tr></table><span class="postbody">
<br/>
This is part of the interrupt process. (note: 0000:xxxx means BIOS). 0400:0000-4 is a pointer to the master interrupt service routine. This address appears to be empty in your binary, so it just jumps back to 0000:0000 again (like I said, beware of calling NULL functions :P ). You need to set up an interrupt routine before enabling any interrupts.
<br/>
<br/>
<span style="font-weight: bold">ETA:</span>
<br/>
On further inspection, the master ISR <span style="font-style: italic">is</span> actually set (in the boot code, around 0800:00E8). However, it's cleared again when you hit this part later:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">    08000102 (T)  ldr     r1,=__data_lma            ; (0809:D274)
<br/>
    08000104 (T)  ldr     r2,=__bss_end             ; (0300:541C)
<br/>
    08000106 (T)  ldr     r4,=__iwram_overlay_end   ; (0300:EC28)
<br/>
    08000108 (T)  bl      CopyMemChk
<br/>
</td> </tr></table><span class="postbody">
<br/>
I can't find the name '__iwram_overlay_end' in any custom ctr0.S files I have here, but it looks like this is supposed to be copying the data section (initialized global variables) into place. The range it's copying into is from 0300:541C to 0300:EC28 ; if you ever see IWRAM addresses over 0300:8000, that's bad. If you must have the large arrays in RAM (rather than ROM), put them into EWRAM using __attribute((section(".ewram")))</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#140395 - Ruben - Sun Sep 16, 2007 2:25 am</h4>
    <div class="postbody"><span class="postbody">OK. That's just WEIRD. This is my 'Main.cpp' file:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">/*
<br/>
 +-----------------------------------------+
<br/>
 | FINAL FANTASY IV - THE RETURN OF GOLBEZ |
<br/>
 +-----------------------------------------+
<br/>
 |     ORIGINAL MADE BY SQUARE IN 1991     |
<br/>
 +-----------------------------------------+
<br/>
 | ALL WORK IS COPYRIGHTED BY THEIR OWNERS |
<br/>
 +-----------------------------------------+
<br/>
*/
<br/>
<br/>
//Includes
<br/>
#include "Includes.H"
<br/>
<br/>
//The Interrupt Table
<br/>
void (*IntrTable[])() = {
<br/>
 &amp;vblFunc, //V-Blank Interrupt
<br/>
 0, //H-Blank Interrupt
<br/>
 0, //VCOUNT Interrupt
<br/>
 0, //TM0 Interrupt
<br/>
 &amp;kradInterrupt, //TM1 Interrupt
<br/>
 0, //TM2 Interrupt
<br/>
 0, //TM3 Interrupt
<br/>
 0, //Serial Interrupt
<br/>
 0, //DMA0 Interrupt
<br/>
 0, //DMA1 Interrupt
<br/>
 0, //DMA2 Interrupt
<br/>
 0, //DMA3 Interrupt
<br/>
 0, //DMA4 Interrupt
<br/>
 0, //Cart-Remove Interrupt
<br/>
};
<br/>
<br/>
//Entry Point
<br/>
char __EH_FRAME_BEGIN__[] = {};
<br/>
int main(void) {
<br/>
 int i;
<br/>
 
<br/>
 //Enable Interrupts
<br/>
 REG_IME = 1;
<br/>
 
<br/>
 //Cart-Remove-Interrupt and V-Blank Interrupt
<br/>
 REG_IE |= (1 &lt;&lt; 13) | 1;
<br/>
 
<br/>
 //Setup the V-Blank Interrupt
<br/>
 REG_DISPSTAT |= (1 &lt;&lt; 3);
<br/>
 
<br/>
 //Setup ROM-Timing
<br/>
 REG_WSCNT = (5 &lt;&lt; 2) | (1 &lt;&lt; 14);
<br/>
 
<br/>
 //Set the Window Parameters
<br/>
 REG_WININ = 0x003F;
<br/>
 REG_WIN0H = 0x00F0;
<br/>
 
<br/>
 //Reset OAM Data
<br/>
 ClearOAM();
<br/>
 
<br/>
 //Show the Introduction
<br/>
 ShowIntro();
<br/>
 
<br/>
 //Set to Mode 0, Enable Sprites, 1D Mapping and Enable Window 0
<br/>
 REG_DISPCNT = MODE_0;
<br/>
 REG_DISPCNT |= OBJ_ENABLE;
<br/>
 REG_DISPCNT |= OBJ_MAP_1D;
<br/>
 REG_DISPCNT |= WIN0_ENABLE;
<br/>
 
<br/>
 //Enable Camera Updating on BG2 and BG 3
<br/>
 CameraBG2Update = true;
<br/>
 CameraBG3Update = true;
<br/>
 
<br/>
 //Define BG0
<br/>
 Background0.number = 0;
<br/>
 Background0.charBaseBlock = 1;
<br/>
 Background0.screenBaseBlock = 2;
<br/>
 Background0.colorMode = BG_COLOR_16;
<br/>
 Background0.size = BG_SIZE_256x256;
<br/>
 Background0.mosaic = 0;
<br/>
 Background0.x_scroll = 0;
<br/>
 Background0.y_scroll = 0;
<br/>
 Background0.priority = 0;
<br/>
 
<br/>
 //Define BG1
<br/>
 Background1.number = 1;
<br/>
 Background1.charBaseBlock = 2;
<br/>
 Background1.screenBaseBlock = 3;
<br/>
 Background1.colorMode = BG_COLOR_16;
<br/>
 Background1.size = BG_SIZE_256x256;
<br/>
 Background1.mosaic = 0;
<br/>
 Background1.x_scroll = 0;
<br/>
 Background1.y_scroll = 0;
<br/>
 Background1.priority = 0;
<br/>
 
<br/>
 //Define BG2
<br/>
 Background2.number = 2;
<br/>
 Background2.charBaseBlock = 0;
<br/>
 Background2.screenBaseBlock = 4;
<br/>
 Background2.colorMode = BG_COLOR_256;
<br/>
 Background2.size = BG_SIZE_256x256;
<br/>
 Background2.mosaic = 0;
<br/>
 Background2.priority = 1;
<br/>
 
<br/>
 //Define BG3
<br/>
 Background3.number = 3;
<br/>
 Background3.charBaseBlock = 0;
<br/>
 Background3.screenBaseBlock = 5;
<br/>
 Background3.colorMode = BG_COLOR_256;
<br/>
 Background3.size = BG_SIZE_256x256;
<br/>
 Background3.mosaic = 0;
<br/>
 Background3.priority = 0;
<br/>
 
<br/>
 //Enable Backgrounds 2 and 3
<br/>
 EnableBackground(&amp;Background2); //Background
<br/>
 EnableBackground(&amp;Background3); //Foreground
<br/>
 
<br/>
 //Load OAM Palette into Memory
<br/>
 for(i=0;i&lt;16;i++) OBJPaletteMem[i] = OAMPalettes[PlayerCurrent][i];
<br/>
 
<br/>
 //Clear the VRAM
<br/>
 ClearVRAM();
<br/>
 
<br/>
 //Initialize the Text System
<br/>
 TextInit();
<br/>
 
<br/>
 //Write Map into Memory
<br/>
 PlayerCurrentX = 6;
<br/>
 PlayerCurrentY = 5;
<br/>
 
<br/>
 //Write the New Map Information
<br/>
 CurrentEvents = BaronCastleEastTower1FEvents;
<br/>
 CurrentObstruction = BaronCastleEastTower1FObstructions;
<br/>
 CurrentTileData = BaronCastleEastTower1FTileData;
<br/>
 UpdateMapDataViaCamera(
<br/>
 BaronCastleEastTower1FBackgroundData,
<br/>
 BaronCastleEastTower1FForegroundData,
<br/>
 BaronCastleEastTower1FTileImage,
<br/>
 BaronCastleEastTower1FTilePalette,
<br/>
 64);
<br/>
 
<br/>
 //Setup the Player's OAMs
<br/>
 Sprites[0].attribute0 = WIDE | PlayerScreenLocationY;
<br/>
 Sprites[0].attribute1 = PlayerScreenLocationX;
<br/>
 Sprites[0].attribute2 = PRIORITY(1);
<br/>
 Sprites[1].attribute0 = WIDE | PlayerScreenLocationY+8;
<br/>
 Sprites[1].attribute1 = PlayerScreenLocationX;
<br/>
 Sprites[1].attribute2 = PRIORITY(1) | 2;
<br/>
 
<br/>
 //Play a Module
<br/>
 krapPlay(&amp;mod_KingdomBaron, KRAP_MODE_LOOP, 0);
<br/>
 
<br/>
 //Write the OAM Image and Transition In
<br/>
 u16* NewImage = (u16*)SpriteData;
<br/>
 for(i=0;i&lt;64;i++) OAMData[i] = NewImage[i];
<br/>
 OpenTransition();
<br/>
 
<br/>
 //Enable Input
<br/>
 PlayerInputAllowed = true;
<br/>
 
<br/>
 //Loop
<br/>
 while(1) {
<br/>
  UpdateInputPlayer();
<br/>
  UpdateKeys();
<br/>
  WaitForVSync();
<br/>
 }
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
And this is my V-Blank interrupt function:</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">//This is Called Every V-Blank
<br/>
void vblFunc() {
<br/>
 GlobalFrameCount++;
<br/>
 kramWorker();
<br/>
 UpdateCamera();
<br/>
 CopyAllOAM();
<br/>
 if(!(GlobalFrameCount % 8)) UpdateMapEngine();
<br/>
}</td> </tr></table><span class="postbody">
<br/>
None of these functions are NULL and all my map data is 'const u8' so I don't know what could be happening there...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#141200 - Ruben - Sun Sep 23, 2007 4:25 am</h4>
    <div class="postbody"><span class="postbody">OK... this is just going to freak EVERYONE out... when I tested the game again... I thought I'd see all the registers, palettes, etc... and when I saw the OAM palette... I realized that the OAM palette IS written! And when I tested with the introduction on, it wrote BOTH palettes!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#141298 - Cearn - Sun Sep 23, 2007 9:49 pm</h4>
    <div class="postbody"><span class="postbody">DevkitArm comes with a utility called arm-eabi-nm.exe, which allows you to see the memory allocation for elf-files. (use `arm-eabi-nm -n -S <span style="font-style: italic">filename</span> &gt; foo.txt' to dump it to 'foo.txt'. Note that the original filename doesn't work for some reason, probably because it's too long.) This is part of what I get for yours
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
030021e4 0000018c B PlayerCommandQueue
<br/>
03002370 00000800 B CurrentObstruction
<br/>
03002b70 00000800 B CurrentTileData
<br/>
03003370 00000004 B CurrentBGMapData
<br/>
03003374 00000004 B CurrentFGMapData
<br/>
03003378 00000001 B CurrentMapSize
<br/>
<span style="font-weight: bold">0300337c 00002000</span> B CurrentEvents
<br/>
0300537c 0000001c B Background0
<br/>
<br/>
... 
<br/>
<br/>
03005488 00000800 D BaronCastleEastTower1FObstructions
<br/>
03005c88 00002000 D BaronCastleEastTower1FEvents
<br/>
03007c00 A __iheap_end
<br/>
<span style="font-weight: bold">03007c88 00000800</span> D BaronCastleEastTower1FTileData  <span style="font-style: italic">HAHA stack I keel you!!!</span>
<br/>
03007f00 A __sp_usr
<br/>
03007fa0 A __sp_irq
<br/>
03007ffc A __intr_vector_buf
<br/>
<span style="font-weight: bold">03008488 00000800</span> D BaronCastleEastTower2FObstructions
<br/>
<span style="font-weight: bold">03008c88 00002000</span> D BaronCastleEastTower2FEvents
<br/>
0300ac88 00000800 D BaronCastleEastTower2FTileData
<br/>
0300b488 00000800 D BaronCastleEastTower3FObstructions
<br/>
0300bc88 00002000 D BaronCastleEastTower3FEvents
<br/>
0300dc88 00000800 D BaronCastleEastTower3FTileData
<br/>
0300e488 00000004 D LastFrame
<br/>
0300e48c 00000004 D MapFrameCount
<br/>
</td> </tr></table><span class="postbody">
<br/>
Basically, you have too much stuff in IWRAM. You should try to move the bigger stuff to EWRAM (or ROM if it's actually constant data). The 'Current' and 'Baron' stuff you see here would be good places to start. Why are the Current<span style="font-style: italic">foo</span> items so large anyway? wouldn't it be easier to just point to the stuff in ROM ?
<br/>
<br/>
I would also strongly suggest using <a class="postlink" href="http://www.devkitpro.org" target="_blank">devkitpro</a> instead of devkitAdvance. Compilers have advances a little in the last 4 years; for one it would have warned you about overrunning RAM limits. It also comes with basic library code that is likely to be superior to what you find in most tutorials.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#141327 - Ruben - Mon Sep 24, 2007 3:28 am</h4>
    <div class="postbody"><span class="postbody">Cool. I'll do that right away. I thought I should've used devKitPro but I wasn't sure I'd be able to do it properly as I program on another PC but it seems I can actually keep the files... lol... and I forgot to post my updated version of the code... everything is a pointer now...anyways... thanks!</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
