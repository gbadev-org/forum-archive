<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>SpriteOAM_RAM and rot/scaling - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>Coding > SpriteOAM_RAM and rot/scaling</h2>
<div id="posts">
<div class="post">
    <h4>#18689 - Mephisto - Thu Apr 01, 2004 1:46 am</h4>
    <div class="postbody"><span class="postbody">I want to sort sprites according to its y coord, without using the priority flag (only 4 levels).
<br/>
So i tried to put my temporary OAM in the right order in the spriteOAM_RAM : here is the point, sprites appears in the right order as wanted, but their rot/scaling data are somehow fucked up ! 
<br/>
I do not understand at all what i must update when i put OAM in another order in the spriteOAM_RAM.
<br/>
<br/>
<br/>
help plz !!!!
<br/>
<br/>
<br/>
Another problem, when i use rot/scaling, i must refresh all sprites, if not sprites are not drawn correctly ...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#18690 - dagamer34 - Thu Apr 01, 2004 1:54 am</h4>
    <div class="postbody"><span class="postbody">Please post the code you are using. I can only guess that you are using DMA to copy all 4 attributes in a OAM entry instead of the first three that are used by sprites.<br/>_________________<br/>Little kids and Playstation 2's don't mix. :(</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#18691 - Mephisto - Thu Apr 01, 2004 2:24 am</h4>
    <div class="postbody"><span class="postbody">WaitVBLANK();
<br/>
for (i = 0, j = 0; i &lt; nbobjets;  i++)
<br/>
{
<br/>
   SpritesOAM_RAM[j++] = FinalResult[i]-&gt;SpriteOAM-&gt;Attribute0;
<br/>
   SpritesOAM_RAM[j++] = FinalResult[i]-&gt;SpriteOAM-&gt;Attribute1;
<br/>
   SpritesOAM_RAM[j++] = FinalResult[i]-&gt;SpriteOAM-&gt;Attribute2;
<br/>
   SpritesOAM_RAM[j++] = FinalResult[i]-&gt;SpriteOAM-&gt;Unused;
<br/>
}
<br/>
<br/>
//FinalResult is pointers array of sprite_struct, sorted by y-coord</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#18693 - tepples - Thu Apr 01, 2004 2:32 am</h4>
    <div class="postbody"><span class="postbody">Try this:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">WaitVBLANK();
<br/>
for (i = 0, j = 0; i &lt; nbobjets;  i++)
<br/>
{
<br/>
   SpritesOAM_RAM[j++] = FinalResult[i]-&gt;SpriteOAM-&gt;Attribute0;
<br/>
   SpritesOAM_RAM[j++] = FinalResult[i]-&gt;SpriteOAM-&gt;Attribute1;
<br/>
   SpritesOAM_RAM[j++] = FinalResult[i]-&gt;SpriteOAM-&gt;Attribute2;
<br/>
   j++;  /* skip writing to Unused, which actually contains rot/scale data */
<br/>
}
<br/>
</td> </tr></table><span class="postbody"><br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#18694 - Mephisto - Thu Apr 01, 2004 2:43 am</h4>
    <div class="postbody"><span class="postbody">ok i must not update the fourth attribute ... ok thx</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#18695 - Mephisto - Thu Apr 01, 2004 3:21 am</h4>
    <div class="postbody"><span class="postbody">baaah !! sprites  are not drawn, only black squares.
<br/>
<br/>
Must i refresh all spriteOAM_RAM ?
<br/>
<br/>
And i do not understand why mustnt i refresh fourth attribute since those sprite are rotated and scaled ...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#18696 - LOst? - Thu Apr 01, 2004 5:36 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Mephisto wrote:</b></span></td> </tr> <tr> <td class="quote">baaah !! sprites  are not drawn, only black squares.
<br/>
<br/>
Must i refresh all spriteOAM_RAM ?
<br/>
<br/>
And i do not understand why mustnt i refresh fourth attribute since those sprite are rotated and scaled ...</td> </tr></table><span class="postbody">
<br/>
<br/>
At least there are black squares....
<br/>
<br/>
Have you set up the sprite data in VRAM and made OAM point to it? (or maybe it's messed up afterwards?)</span><span class="gensmall"><br/><br/>Last edited by LOst? on Thu Apr 01, 2004 2:28 pm; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#18704 - Lupin - Thu Apr 01, 2004 11:56 am</h4>
    <div class="postbody"><span class="postbody">You should also check if you set up the correct value to rot/scale data. You can use these defines to make setting up sprites a bit easier:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
typedef struct tagOAMEntry
<br/>
{
<br/>
        u16 attribute0;
<br/>
        u16 attribute1;
<br/>
        u16 attribute2;
<br/>
        u16 attribute3;
<br/>
}OAMEntry,*pOAMEntry;
<br/>
<br/>
typedef struct tagRotData
<br/>
{
<br/>
        u16 filler1[3];
<br/>
        u16 hdx;
<br/>
        u16 filler2[3];
<br/>
        u16 hdy; 
<br/>
        u16 filler3[3];
<br/>
        u16 vdx; 
<br/>
        u16 filler4[3];
<br/>
        u16 vdy;
<br/>
}RotData,*pRotData;
<br/>
<br/>
vu16* OAM = (vu16*)0x7000000; //the address of OAM 
<br/>
OAMEntry sprites[128]; //My sprite array
<br/>
pRotData rotData = (pRotData)sprites; //My rotation and scaling array
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
1 Rotdata entry takes 4 attribute 3 elements (so you can not have independent rotation for all sprites). I think that code comes from one of the thepernproject.com tutorials (i suggest you looking there for more info). Sprites are sometimes a bit tricky, i also had the black-box problem, but i somehow solved it :)<br/>_________________<br/><a class="postlink" href="http://pokeme.shizzle.it/" target="_blank">Team Pokeme</a>
<br/>
<a class="postlink" href="http://lupin.shizzle.it/" target="_blank">My blog and PM ASM tutorials</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#18705 - Cearn - Thu Apr 01, 2004 12:39 pm</h4>
    <div class="postbody"><span class="postbody">Like the others have said, the OAM attributes and the Rot/Scale elements are interlaced, if you look at the code that Lupin gave you'll see that each RotData is 4 OAMEntries long, and the filler of OAMEntry (attribute3) is placed exactly where the actual RotData dat would be, and vice versa. I have a diagram of it <a class="postlink" href="http://user.chem.tue.nl/jakvijn/tonc/regobj.htm#OAM" target="_blank">here</a> (scroll down to table 1). If you were to switch, say OAMEntry[0] and and OAMEntry[1], you would also switch pa and pb of RotData[0] if you updated the attribute3 of the OAMEntries. That's a bad idea (see Tepples' post). But you still need to update the RotData, of course, justdon't do it at the same time as the sorting. If you don't update it at all, the real RotData elements will be 0 and the first pixel of each sprite will be used for the whole sprite, which is probably why it's all black.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#18718 - Mephisto - Thu Apr 01, 2004 3:02 pm</h4>
    <div class="postbody"><span class="postbody">Cearn thanks a lot, i understand all now, i ll try it soon ^^ thank u!!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#18727 - Mephisto - Thu Apr 01, 2004 11:33 pm</h4>
    <div class="postbody"><span class="postbody">Yes it works pretty well thank you.
<br/>
<br/>
But i have another question, i read there was 32 rotations available at a time, but it seems to be limited by 8.
<br/>
when i try to use the 9th it uses the first.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#18730 - tepples - Fri Apr 02, 2004 3:43 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Mephisto wrote:</b></span></td> </tr> <tr> <td class="quote">Yes it works pretty well thank you.
<br/>
<br/>
But i have another question, i read there was 32 rotations available at a time, but it seems to be limited by 8.
<br/>
when i try to use the 9th it uses the first.</td> </tr></table><span class="postbody">
<br/>
Perhaps you're mistakenly ANDing out the two high order bits somewhere, probably in a header file. I've rotated 32 sprites independently.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
