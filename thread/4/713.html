<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>sb plz help me to optimize this code further more... - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>Coding > sb plz help me to optimize this code further more...</h2>
<div id="posts">
<div class="post">
    <h4>#3658 - jammin.won - Tue Mar 04, 2003 9:18 am</h4>
    <div class="postbody"><span class="postbody"><span style="color: green">/* i was trying to filling all(maybe part) the color as fast as possible under MODE_3... but yet it is the best algorithm i can figure out in my knowledge ,and i guess that must not be the best ,so plz help me ,bros =)*/</span>
<br/>
<br/>
<br/>
void PlotPixel(u16 x,u16 y,u16 color){
<br/>
	u16* vram=REG_VRAM;
<br/>
	vram[(y)*240+(x)]=(color);
<br/>
}
<br/>
<br/>
int main(void){
<br/>
<br/>
	SET_DISP_MODE(DISP_MODE_3 | DISP_BG2_ON);
<br/>
<br/>
	u16 x,y,r,g,b,count;
<br/>
<br/>
	for(y=0;y&lt;160;y++){
<br/>
		r=(int)(y*0.199);
<br/>
		b=31-r;
<br/>
		count=4;
<br/>
		g=0;
<br/>
<br/>
	                for(x=0;x&lt;240;x++,count++){
<br/>
			if(count&gt;7){					g++;
<br/>
			count=0;		
<br/>
			}
<br/>
			PlotPixel(x,y,SET_RGB(r,g,b));
<br/>
		}
<br/>
	}
<br/>
}
<br/>
<br/>
<br/>
<span style="color: green">//thx thx thx =)</span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#3660 - pelrun - Tue Mar 04, 2003 12:19 pm</h4>
    <div class="postbody"><span class="postbody">Here's my quick stab at it. And it is definitely sub-optimal - further improvements are an exercise for the reader :) You should be able to rework this to only require one loop...
<br/>
<br/>
The r variable does not need a multiplication each iteration, since all that happens is it gets incremented by 0.199. The r2 variable is there so I don't have to perform an int cast every pixel when it's only needed once each line.
<br/>
<br/>
The count and g variables (and the if statement using them) are unnecessary as g can be directly calculated from x using just an add and a shift.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
void PlotPixel(u16 x,u16 y,u16 color){
<br/>
    u16* vram=REG_VRAM;
<br/>
    vram[(y)*240+(x)]=(color);
<br/>
}
<br/>
<br/>
int main(void){
<br/>
    SET_DISP_MODE(DISP_MODE_3 | DISP_BG2_ON);
<br/>
<br/>
    // CHANGE: Remove g and count vars, add r2
<br/>
    u16 x,y,b,r2=0;
<br/>
    // CHANGE: Define r as float, initialise to zero.
<br/>
    float r=0;
<br/>
<br/>
    for(y=0;y&lt;160;y++){
<br/>
        // CHANGE: r=(int)y*0.199; removed
<br/>
        b=31-r;
<br/>
        // CHANGE: count=4; g=0; dropped
<br/>
<br/>
        // CHANGE: count++ removed
<br/>
        for(x=0;x&lt;240;x++){
<br/>
            // CHANGE: calculate g from x directly
<br/>
            PlotPixel(x,y,SET_RGB(r2, (x+4)&gt;&gt;3, b));
<br/>
        }
<br/>
<br/>
        // CHANGE: r+=0.199; r2=(int)r; added
<br/>
        r+=0.199;
<br/>
        r2=(int)r;
<br/>
    }
<br/>
}
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#3662 - gb_feedback - Tue Mar 04, 2003 2:19 pm</h4>
    <div class="postbody"><span class="postbody">Or...
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void ClearScreen()
<br/>
{
<br/>
   
<br/>
   u16 paperColour = RGB(255,0,0);
<br/>
<br/>
   u16* ScreenBuffer = (u16*)0x6000000; 
<br/>
   //this is the start of video memory
<br/>
<br/>
   REG_DM3SAD = (u32) &amp;paperColour; 
<br/>
   REG_DM3DAD = (u32) ScreenBuffer;
<br/>
<br/>
   REG_DM3CNT = ((240 * 160) | VAL_DMACNT_SRC_INC_NC | 
<br/>
                     VAL_DMACNT_ENABLE |
<br/>
                     VAL_DMACNT_SIZE_16 |
<br/>
                     VAL_DMACNT_START_VBL);
<br/>
<br/>
   while (REG_DM3CNT_H &amp; 0x8000)   // wait for completion
<br/>
      ;
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
...(untested)<br/>_________________<br/><a class="postlink" href="http://www.bookreader.co.uk/" target="_blank">http://www.bookreader.co.uk/</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#3665 - jammin.won - Tue Mar 04, 2003 2:31 pm</h4>
    <div class="postbody"><span class="postbody">truely thankful to pelrun and gb =) that really helps a lot 
<br/>
<br/>
ill try it out tomorrow (china's tomorrow) ...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#3666 - jammin.won - Tue Mar 04, 2003 4:51 pm</h4>
    <div class="postbody"><span class="postbody">well....i thought it again and used something in Perlrun's reply then formed this solution ... maybe not the best but its far better than the last one ....thanks again to Pelrun
<br/>
<br/>
btw...i really realized now the difference between simple addition/subtraction and multiplication/division ,even the difference between multi and div is substantial...which i never gave them a thought in pc-programming =)
<br/>
<br/>
and...sb told me that i can actually create a rectangle of 30*32,and enlarge it to fit the screen.....so far ,i didnt know how to do that .... and dunno weather it's even faster than the code below
<br/>
<br/>
the complete simple code:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">//brief header defination
<br/>
typedef   unsigned short int   u16;
<br/>
#define REG_DISPCNT      *(u16*)0x04000000   //DISPLAY CONTROL REGISTER
<br/>
#define REG_VRAM_16B   (u16*)0x06000000   //address of Video RAM,MODE_3,5
<br/>
#define DISP_MODE_3   0x0003      //BG 2 with 240*160. 16-bits TRUE color. ONLY 1 frame buffer
<br/>
#define DISP_BG2_ON         0x0400      //BG2 enabled
<br/>
#define SET_DISP_MODE(_MODE_)   REG_DISPCNT=(_MODE_)   //macro to setup screen mode
<br/>
#define SET_RGB(r,g,b)   ((r)+((g)&lt;&lt;5)+((b)&lt;&lt;10))   //use bitwise shift to mount to proper position
<br/>
<br/>
<br/>
int main(void){
<br/>
<br/>
   SET_DISP_MODE(DISP_MODE_3 | DISP_BG2_ON);
<br/>
   u16* vram=REG_VRAM_16B;   
<br/>
   u16 x,y,b,addr;
<br/>
<br/>
   addr=0;
<br/>
   for(y=0;y&lt;32;y++){
<br/>
      b=31-y;
<br/>
      for(;addr&lt;y*1200+1200;){
<br/>
         for(x=0;x&lt;30;x++){
<br/>
            vram[addr]=SET_RGB(y,x,b);
<br/>
            vram[addr+1]=vram[addr];
<br/>
            vram[addr+2]=vram[addr];
<br/>
            vram[addr+3]=vram[addr];
<br/>
            vram[addr+4]=vram[addr];
<br/>
            vram[addr+5]=vram[addr];
<br/>
            vram[addr+6]=vram[addr];
<br/>
            vram[addr+7]=vram[addr];
<br/>
            addr+=8;
<br/>
         }
<br/>
      }
<br/>
   }
<br/>
<br/>
   while(1);//does nothing
<br/>
}</td> </tr></table><span class="postbody">[/code]</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#3676 - peebrain - Tue Mar 04, 2003 10:33 pm</h4>
    <div class="postbody"><span class="postbody">Why exactly aren't you using DMA's?
<br/>
<br/>
Edit: oh nevermind
<br/>
<br/>
~Sean<br/>_________________<br/><a href="http://www.pbwhere.com" target="_blank">http://www.pbwhere.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#3705 - chrisrothery - Wed Mar 05, 2003 6:45 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">for(;addr&lt;y*1200+1200;){ </td> </tr></table><span class="postbody">
<br/>
<br/>
You should definitely do something with the limits for addr.
<br/>
<br/>
Firstly, I think that each time round this loop, it's going to do y*1200+1200 to evaluate the condition, it's fixed for that for loop so do maxaddr = y * 1200+1200 and change the loop to limit on y &lt; maxaddr.
<br/>
<br/>
Second, maxaddr is a fixed set of values (1200, 2400, 3600 etc.), so why calculate it as a function of y anyway.  initialise it to 1200 and increment by 1200 during the loop.
<br/>
<br/>
Not tested any of this but it's the most obvious thing left after the changes you've made to the original.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#3706 - jammin.won - Wed Mar 05, 2003 7:25 pm</h4>
    <div class="postbody"><span class="postbody">thats right...i also noticed it when i used the changed code in another program,actually no multipulation is needed =)
<br/>
<br/>
and...lots of ppl reminded me of using DMA....hmmm,i haven't learned it yet....the current stage of my learning is SPRITE.... but i must try DMA out coz it sounds so sweet 
<br/>
<br/>
thanks for all the reply ,that helps really much</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
