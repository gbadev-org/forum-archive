<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Problems with DMA... - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>Coding > Problems with DMA...</h2>
<div id="posts">
<div class="post">
    <h4>#25605 - /*Articuno*/ - Wed Aug 25, 2004 10:28 pm</h4>
    <div class="postbody"><span class="postbody">Hello World,
<br/>
<br/>
I'm having a strange problem when using DMA for copying...
<br/>
This code:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
void DMAFastCopy(void* source,void* dest,unsigned int count,unsigned int mode) {
<br/>
    if (mode == DMA_16NOW || mode == DMA_32NOW) {
<br/>
        REG_DMA3SAD = (unsigned int)source;
<br/>
        REG_DMA3DAD = (unsigned int)dest;
<br/>
        REG_DMA3CNT = count | mode;
<br/>
    }
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
wasn't working (on our first versions it was working... before we started using DevKitArm, Krawall, etc...)
<br/>
<br/>
Then we made this "slower" version:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
void DMAFastCopy(void* source,void* dest,unsigned int count,unsigned int mode) {   
<br/>
    // DMASlowCopy ^_^;
<br/>
<br/>
    if (mode == DMA_16NOW)
<br/>
        while(count--)
<br/>
        *((u16*)dest + count) = *((u16*)source + count);
<br/>
    else
<br/>
        while(count--)
<br/>
            *((u32*)dest + count) = *((u32*)source + count);
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
But, when i was told that Krawall and DMA should be working together, i made this test:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
void DMAFastCopy(void* source,void* dest,unsigned int count,unsigned int mode) {
<br/>
    if (mode == DMA_16NOW || mode == DMA_32NOW) {
<br/>
        REG_DMA3SAD = (unsigned int)source;
<br/>
        REG_DMA3DAD = (unsigned int)dest;
<br/>
        REG_DMA3CNT = count | mode;
<br/>
    }
<br/>
<br/>
    dprintf("Trying to copy %d blocks...\n", count);
<br/>
    if (mode == DMA_16NOW) {
<br/>
        while(count--)
<br/>
            if (*((u16*)dest + count) != *((u16*)source + count)) break;
<br/>
    }
<br/>
    else {
<br/>
        while(count--)
<br/>
            if (*((u32*)dest + count) != *((u32*)source + count)) break;
<br/>
    }
<br/>
    dprintf("%d\n", count);
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
to check how many blocks were being correctly copied...
<br/>
And then the DMA Copy started working again! Note that the loops are only comparing values!
<br/>
(and dprintf is just my debug function, that prints to VisualBoyAdvance's stdout...)
<br/>
<br/>
When i remove this "test code", the function doesn't work at all, as if things were messed during copy (the game shows arbitrary colors, a dark and broken version of our game... some pictures missing... etc...)
<br/>
<br/>
Someone can tell me what is wrong ? Could Krawall be affecting DMA ? Should I use interrupts for DMA ?<br/>_________________<br/>Close the world, tx<span style="color: red">E</span>n eht nepO.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#25606 - poslundc - Wed Aug 25, 2004 10:38 pm</h4>
    <div class="postbody"><span class="postbody">- Make sure all three DMA registers are defined as volatile.
<br/>
<br/>
- Try inserting REG_DMA3CNT = 0; just before the line where you assign REG_DMA3CNT.
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#25610 - FireOut - Wed Aug 25, 2004 11:14 pm</h4>
    <div class="postbody"><span class="postbody">If you are using any optimization flags on your compiler (such as -O2), try setting those off. 
<br/>
<br/>
If the code works after that change you probably didn't set the registers as volatile, like poslundc said, and the compiler is optimizing something it shouldn't ;-)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#25677 - /*Articuno*/ - Thu Aug 26, 2004 10:24 pm</h4>
    <div class="postbody"><span class="postbody">Thanks poslundc !<br/>_________________<br/>Close the world, tx<span style="color: red">E</span>n eht nepO.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
