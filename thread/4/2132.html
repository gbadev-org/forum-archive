<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Writing a Multiboot loader - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>Coding > Writing a Multiboot loader</h2>
<div id="posts">
<div class="post">
    <h4>#11069 - Lord Graga - Thu Sep 25, 2003 12:51 pm</h4>
    <div class="postbody"><span class="postbody">Hey all, I am curently trying to write a multiboot loader (for fun ;)
<br/>
It is a simple menu, but the current version just says the named of the image, and tries to load it.
<br/>
<br/>
The theory is based on this quote from the Cowbite specs:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote"><span style="font-weight: bold">0x00: SoftReset</span>
<br/>
<span style="font-weight: bold">Resets</span> the GBA and runs the code at address 0x2000000 or 0x8000000 depending on the contents of 0x3007ffa (0 means 0x8000000 and anything else means 0x2000000).</td> </tr></table><span class="postbody">
<br/>
<br/>
So my procedure is:
<br/>
<br/>
- <span style="font-weight: bold">L</span>oad the MB image into 0x2000000
<br/>
- <span style="font-weight: bold">S</span>et 0x3007FFA to 1
<br/>
- <span style="font-weight: bold">D</span>o a softreset
<br/>
<br/>
But somehow, it does not seem to to work (tried both on real GBA and EMU). My explanaition could be:
<br/>
<br/>
The branch opcode has 3 bytes to tell CPU where to branch. As neither 0x2000000 or 0x8000000 could be written with 3 bytes, then the CPU adds 0x08 or 0x02 to the start of the instruction, based on the content of 0x3007FFA (Cowbite). However, this does NOT seem to work as it should, is that a bug in the GBA firmware?
<br/>
<br/>
<br/>
Anyway, here is my code:
<br/>
<br/>
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void Run(void)
<br/>
{
<br/>
   u32 i;
<br/>
   Write("starting image transfer!",100);
<br/>
   for(i=0;i&lt;0xFFFF;i++) *(u16*)(0x2000000+i) = *(u16*)(0x8008000+i);
<br/>
   Write("done, starting sleep...",110);
<br/>
   for(i=0;i&lt;120;i++)
<br/>
   {
<br/>
      while(*((volatile unsigned short*)0x04000004) &amp; (1&lt;&lt;0));
<br/>
      while(!((*((volatile unsigned short*)0x04000004) &amp; (1&lt;&lt;0))));
<br/>
   }
<br/>
   Write("resetting",120);
<br/>
   *(u8*)(0x3007FFA) = 0x1;
<br/>
   __asm {
<br/>
      swi 0x00
<br/>
   }
<br/>
}</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#11073 - tepples - Thu Sep 25, 2003 2:42 pm</h4>
    <div class="postbody"><span class="postbody">downtou.cjb.net had multiboot code before it died. I wrote my own working multiboot code based on its concepts. It's not polished enough to be put on my main web site, but <a class="postlink" href="http://pinocchio.jk0.org/mbsrc.zip" target="_blank">here's the code anyway</a>.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#11074 - Lord Graga - Thu Sep 25, 2003 2:48 pm</h4>
    <div class="postbody"><span class="postbody">I am not making a program that sends data to another GBA, but a program that  works like a menu! (Like Pogoshell, but more simple)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#11075 - tepples - Thu Sep 25, 2003 3:50 pm</h4>
    <div class="postbody"><span class="postbody">in that case, you want a .mb menu. I've made <a class="postlink" href="http://www.pineight.com/gba/#mbmenu" target="_blank">one of those too</a>.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
