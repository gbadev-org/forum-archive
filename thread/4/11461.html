<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Crash Recovery Systems - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>Coding > Crash Recovery Systems</h2>
<div id="posts">
<div class="post">
    <h4>#106272 - sgeos - Tue Oct 17, 2006 12:36 pm</h4>
    <div class="postbody"><span class="postbody">Many programs (open office, nethack, etc) have crash recovery systems.  Even if the power cuts out, you don't lose your work.  What is the best way to implement a crash recovery system on the PC?  (tools)  What would be the best way to implement a crash recovery system on something like the GBA?  (power cuts out or pak is removed)
<br/>
<br/>
-Brendan</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#106279 - tepples - Tue Oct 17, 2006 2:31 pm</h4>
    <div class="postbody"><span class="postbody">Crash recovery can be accomplished either through journaling (write a list of transactions that can be used to reconstruct the current state, where each transaction represents a small change and can be stored small) or through periodically writing the whole document to another file. How to best implement crash recovery depends on the nature of your document's state, on the nature of the transactions, and on the nature of your storage medium. It will differ for a text editor, for an audio editor, for a simple game, or for a complex game. It will also differ for the PC, for the Game Boy Advance, and for the Nintendo DS.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#106309 - poslundc - Tue Oct 17, 2006 7:55 pm</h4>
    <div class="postbody"><span class="postbody">I've implemented a virtual save system in the past. The basic principle is that if you have three save slots you instead use four (or more) physical save slots, and cycle through the slots when saving your game. You record both the virtual slot it is being saved into (so I could be saving into the 2nd slot virtually when I'm saving into the 5th physical slot), and a version number so you can keep track of which version is most recent.
<br/>
<br/>
When presenting the virtual slots to the user, you reference the physical slots with the highest version number.
<br/>
<br/>
The algorithm automatically recovers to the most recent version if it discovers corrupt data, since the maximum version number it can find for the virtual save slot it's looking for will simply be in a different physical slot.
<br/>
<br/>
There are some finer details with metadata you need to store in the physical slots... ie. is a file deleted, marked as corrupted, etc.
<br/>
<br/>
On a project that had much more data to save, I even created separate virtual filesystems for different resources that were being used by a single save game. So you could lose a custom drawing or a microphone sample from corruption without it affecting your main save-game at all.
<br/>
<br/>
Another good thing about a system like this is that it greatly extends the life of your backup media, since you are performing fewer writes to the same location.
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#106678 - sgeos - Sun Oct 22, 2006 2:09 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>poslundc wrote:</b></span></td> </tr> <tr> <td class="quote">I've implemented a virtual save system in the past. The basic principle is that if you have three save slots you instead use four (or more) physical save slots, and cycle through the slots when saving your game.
<br/>
...
<br/>
When presenting the virtual slots to the user, you reference the physical slots with the highest version number.</td> </tr></table><span class="postbody">
<br/>
Interesting.  I could see the player being confused when an archived save is corrupted and turns into a save for the current game- unless I misunderstood.  (I beat the game with a party of level 7 characters and never want to delete that data.)
<br/>
<br/>
Mirroring can also be used to prevent corruption.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Another good thing about a system like this is that it greatly extends the life of your backup media, since you are performing fewer writes to the same location.</td> </tr></table><span class="postbody">
<br/>
I had not thought of that.  It honestly sounds like an amazing system.
<br/>
<br/>
But... it's not really what I wanted to know...  If I make it to the final room and the batteries run out, this usually means I need to fight my way all the way back to final room.  I think it would be neat if I didn't have to do that.  Worse yet, the power goes out when I'm making the last room. =)
<br/>
<br/>
Journaling or a periodic state dump (every 15 minutes) seems like the way to go.  I guess I want a cyclinic/mirrored 5/15 minute autosave.
<br/>
<br/>
-Brendan</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#106686 - tepples - Sun Oct 22, 2006 6:55 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>sgeos wrote:</b></span></td> </tr> <tr> <td class="quote">If I make it to the final room and the batteries run out, this usually means I need to fight my way all the way back to final room.</td> </tr></table><span class="postbody">
<br/>
<span style="font-style: italic">Animal Crossing: Wild World</span> for Nintendo DS has a partial solution: warn the player when the system's battery light has turned red.
<br/>
<br/>
You could say make 8 save slots, and use 4 for the three virtual slots of the "save" function and 4 for real-time saves.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#106704 - poslundc - Sun Oct 22, 2006 9:04 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>sgeos wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>poslundc wrote:</b></span></td> </tr> <tr> <td class="quote">I've implemented a virtual save system in the past. The basic principle is that if you have three save slots you instead use four (or more) physical save slots, and cycle through the slots when saving your game.
<br/>
...
<br/>
When presenting the virtual slots to the user, you reference the physical slots with the highest version number.</td> </tr></table><span class="postbody">
<br/>
Interesting.  I could see the player being confused when an archived save is corrupted and turns into a save for the current game- unless I misunderstood.  (I beat the game with a party of level 7 characters and never want to delete that data.)</span></td> </tr></table><span class="postbody">
<br/>
<br/>
That's not how it works. If I have a 5 physical slots on my media and 3 virtual slots (save locations) in my game, then my physical slots might have the following configuration:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">========================
<br/>
= Physical slot 1
<br/>
=   - Virtual slot:   2      * ACTIVE
<br/>
=   - Version number: 0
<br/>
=========================
<br/>
= Physical slot 2
<br/>
=   - Virtual slot:   1      * INACTIVE
<br/>
=   - Version number: 1
<br/>
=========================
<br/>
= Physical slot 3
<br/>
=   - Virtual slot:   3      * INACTIVE
<br/>
=   - Version number: 2
<br/>
=========================
<br/>
= Physical slot 4
<br/>
=   - Virtual slot:   1      * ACTIVE
<br/>
=   - Version number: 4
<br/>
=========================
<br/>
= Physical slot 5
<br/>
=   - Virtual slot:   3      * ACTIVE
<br/>
=   - Version number: 5
<br/>
=========================</td> </tr></table><span class="postbody">
<br/>
<br/>
In this example:
<br/>
<ul><li>Physical slot 1 is active because it has the highest version number of any slot that points to virtual slot 2
<br/>
</li><li> Physical slot 2 is inactive because there is another physical slot that has the same virtual slot number as it, but has a higher version number</li></ul>
<br/>
<br/>
So if I were to display a list of save-game-slots to the player, I would take the data from physical slots 1, 4, and 5 and ignore the data in slots 2 and 3.
<br/>
<br/>
When <span style="font-style: italic">any</span> game is next saved, it will be recorded into physical slot 2, because that is the <span style="font-weight: bold">inactive</span> slot with the <span style="font-weight: bold">lowest</span> version number. (The version number of that next save record will be 6.)
<br/>
<br/>
Say we are trying to make a list of all of our valid save-slots (virtual slots) the player can save into. If one of the active slots - say physical slot 5 - is found to be corrupted, then the game reverts to making physical slot 3 an active slot, since that is the slot that has the next-most-recent version number that points to the virtual slot number we were trying to populate. The other virtual slots remain unaffected by this procedure, so you can't get the situation you describe where data for one slot becomes data for another slot.
<br/>
<br/>
As a side note, it would probably be a Nintendo lot-check violation to "silently" revert to older data; if corrupt data is found then it would have to be reported to the user, with a message that might say "your data has been restored to an earlier version". That corrupt data would then be marked as a normal empty slot so you don't get that message again. (As I said, there are a number of nuances to implementing the actual system.)
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">But... it's not really what I wanted to know... If I make it to the final room and the batteries run out, this usually means I need to fight my way all the way back to final room. I think it would be neat if I didn't have to do that. Worse yet, the power goes out when I'm making the last room. =)
<br/>
<br/>
Journaling or a periodic state dump (every 15 minutes) seems like the way to go. I guess I want a cyclinic/mirrored 5/15 minute autosave.</td> </tr></table><span class="postbody">
<br/>
<br/>
You can base autosave on a number of things... you could save every time you enter a new room, for example. Give the user a "quick start" option as well as a "return to some central game location" option when selecting their file.
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#106706 - tepples - Sun Oct 22, 2006 9:09 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>poslundc wrote:</b></span></td> </tr> <tr> <td class="quote">As a side note, it would probably be a Nintendo lot-check violation to "silently" revert to older data; if corrupt data is found then it would have to be reported to the user, with a message that might say "your data has been restored to an earlier version". That corrupt data would then be marked as a normal empty slot so you don't get that message again. (As I said, there are a number of nuances to implementing the actual system.)</td> </tr></table><span class="postbody">
<br/>
If this is true, then Nintendo violated its own lot check guidelines in <span style="font-style: italic">Super Mario World</span> and <span style="font-style: italic">Mario Paint</span> for Super NES. Those games would silently lose saves all the time.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#106708 - poslundc - Sun Oct 22, 2006 9:12 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tepples wrote:</b></span></td> </tr> <tr> <td class="quote">If this is true, then Nintendo violated its own lot check guidelines in <span style="font-style: italic">Super Mario World</span> and <span style="font-style: italic">Mario Paint</span> for Super NES. Those games would silently lose saves all the time.</td> </tr></table><span class="postbody">
<br/>
<br/>
Nintendo has always followed its own unique set of inscrutable rules when it comes to their own first-party titles. :-P
<br/>
<br/>
That said, I imagine the lot check requirements have evolved considerably since the days of those two games.
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#106737 - sgeos - Mon Oct 23, 2006 3:52 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>poslundc wrote:</b></span></td> </tr> <tr> <td class="quote">If one of the active slots - say physical slot 5 - is found to be corrupted, then the game reverts to making physical slot 3 an active slot, since that is the slot that has the next-most-recent version number that points to the virtual slot number we were trying to populate.</td> </tr></table><span class="postbody">
<br/>
Got it.  If physical slot 1 is corrupted, you end up with an empty slot.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tepples wrote:</b></span></td> </tr> <tr> <td class="quote">warn the player when the system's battery light has turned red.</td> </tr></table><span class="postbody">
<br/>
That is certainly a reasonable solution.  The goal is to cater to the people that play their GBA/DS until the batteries actually run out.  (This may not actually be a worth while goal.)
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>poslundc wrote:</b></span></td> </tr> <tr> <td class="quote">You can base autosave on a number of things... you could save every time you enter a new room, for example.</td> </tr></table><span class="postbody">
<br/>
Memory efficient- seed, room/entrance, player status.  On the otherhand, it doesn't help if me if I spend an hour in the same room.  At any rate, specific solutions seem readily available for specific problems.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>poslundc wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tepples wrote:</b></span></td> </tr> <tr> <td class="quote">If this is true, then Nintendo violated its own lot check guidelines in <span style="font-style: italic">Super Mario World</span> and <span style="font-style: italic">Mario Paint</span> for Super NES. Those games would silently lose saves all the time.</td> </tr></table><span class="postbody">
<br/>
Nintendo has always followed its own unique set of inscrutable rules when it comes to their own first-party titles. :-P</span></td> </tr></table><span class="postbody">
<br/>
That's the difference between we want this out the door and you want this out the door.  If the standards are yours, you can fudge them a little without having to answer to anyone.
<br/>
<br/>
For what it's worth, if you <span style="font-weight: bold">really</span> didn't want to fix this lot check violation, you might be able to return it to Mario Club as "Could not reproduce.  Please provide specific instructions to reproduce this bug."  Then hope that the psychic playtester(*) doesn't get around to doing just that. =P
<br/>
<br/>
For this particular "bug", that is probably the wrong course of action as it does result in an inferior product.
<br/>
<br/>
-Brendan
<br/>
<br/>
(*) The person who submits the bug reports that are humanly impossible to pull off.  "Starting with the upper lefthand button, if you move to the right and press a different button every frame the game will lock up when you hit the exit button."  =P</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#108271 - sgeos - Tue Nov 07, 2006 9:32 am</h4>
    <div class="postbody"><span class="postbody">I assume that a basic crash recovery system looks something like this.  It is written in java and works superficially, although I have not gone crazy with a debugger.  If you are using something like C you'd obviously replace serialization with a custom save scheme.  On the GBA the file name would be replaced with an appropriate write location.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">import java.io.*;
<br/>
<br/>
public class CrashRecovery
<br/>
    implements ITicking, Serializable
<br/>
{
<br/>
    // User Constant
<br/>
    private static final String DEFAULT_FILE_NAME   = "recovery.ser";
<br/>
    private static final String DEFAULT_MIRROR_NAME = "recovery_mirror.ser";
<br/>
    private static final int    DEFAULT_TIMEOUT     = 60 * 60 * 5;  // 60fps * 60s/m * 5m
<br/>
<br/>
    // System Constant
<br/>
    private static final int    DEFAULT_TICK    = 1;
<br/>
    private static final int    ONE_SECOND      = 1000; // milliseconds
<br/>
<br/>
    // State
<br/>
    private Serializable    mHost;
<br/>
    private String          mFileName;
<br/>
    private String          mMirrorName;
<br/>
    private int             mTimer;
<br/>
    private int             mTimeout;
<br/>
    private int             mVersion;
<br/>
<br/>
    public CrashRecovery()
<br/>
    {
<br/>
        init(null, DEFAULT_FILE_NAME, DEFAULT_MIRROR_NAME);
<br/>
    }
<br/>
<br/>
    public CrashRecovery(Serializable pHost, String pFileName, String pMirrorName)
<br/>
    {
<br/>
        init(pHost, pFileName, pMirrorName);
<br/>
    }
<br/>
<br/>
    public CrashRecovery init(Serializable pHost, String pFileName, String pMirrorName)
<br/>
    {
<br/>
        setHost(pHost);
<br/>
        setFile(pFileName, pMirrorName);
<br/>
        resetTimer();
<br/>
        resetVersion();
<br/>
        return this;
<br/>
    }
<br/>
<br/>
    public CrashRecovery setHost(Serializable pHost)
<br/>
    {
<br/>
        mHost = pHost;
<br/>
        return this;
<br/>
    }
<br/>
<br/>
    public CrashRecovery setFile(String pFileName, String pMirrorName)
<br/>
    {
<br/>
        mFileName   = pFileName;
<br/>
        mMirrorName = pMirrorName;
<br/>
        return this;
<br/>
    }
<br/>
<br/>
    // tick every frame
<br/>
    public void tick()
<br/>
    {
<br/>
        tick(DEFAULT_TICK);
<br/>
    }
<br/>
<br/>
    // ITicking supports multiticking
<br/>
    public void tick(int pTick)
<br/>
    {
<br/>
        mTimer += pTick;
<br/>
        if (mTimeout &lt; mTimer)
<br/>
        {
<br/>
            resetTimer();
<br/>
            save();
<br/>
        }
<br/>
    }
<br/>
<br/>
    public void setTimeout(int pTimeout)
<br/>
    {
<br/>
        mTimeout = pTimeout;
<br/>
    }
<br/>
<br/>
    // because splitting timeout time and FPS is probably a good thing
<br/>
    public void setTimeout(int pSeconds, int pFps)
<br/>
    {
<br/>
        mTimeout = pSeconds * pFps;
<br/>
    }
<br/>
<br/>
    public void resetTimer()
<br/>
    {
<br/>
        mTimer = 0;
<br/>
    }
<br/>
<br/>
    private void resetVersion()
<br/>
    {
<br/>
        mVersion = 0;
<br/>
    }
<br/>
<br/>
    public boolean save()
<br/>
    {
<br/>
        mVersion++;
<br/>
        resetTimer();
<br/>
        boolean success =  saveState(mFileName);
<br/>
        success         &amp;= saveState(mMirrorName);
<br/>
        return success;
<br/>
    }
<br/>
<br/>
    public Serializable load()
<br/>
    {
<br/>
        Serializable        result;
<br/>
        SerializableShell   data    = loadShell(mFileName);
<br/>
        SerializableShell   mirror  = loadShell(mMirrorName);
<br/>
<br/>
        // null is bad
<br/>
        if ((null == data) &amp;&amp; (null == mirror))
<br/>
        {
<br/>
            result = null;
<br/>
        }
<br/>
        else if (null == data)
<br/>
        {
<br/>
            result = mirror.host;
<br/>
        }
<br/>
        else if (null == mirror)
<br/>
        {
<br/>
            result = data.host;
<br/>
        }
<br/>
<br/>
        // lower version is more reliable
<br/>
        else if (mirror.version &lt; data.version)
<br/>
        {
<br/>
            result = mirror.host;
<br/>
        }
<br/>
        else
<br/>
        {
<br/>
            result = data.host;
<br/>
        }
<br/>
        if (null != result)
<br/>
        {
<br/>
            setHost(result);
<br/>
            resetVersion();
<br/>
            save();
<br/>
        }
<br/>
        return mHost;
<br/>
    }
<br/>
<br/>
    public boolean saveState(String pFilename)
<br/>
    {
<br/>
        boolean success;
<br/>
        try
<br/>
        {
<br/>
            SerializableShell   data    = new SerializableShell(mHost, mVersion);
<br/>
            FileOutputStream    fos     = new FileOutputStream(pFilename);
<br/>
            ObjectOutputStream  out     = new ObjectOutputStream(fos);
<br/>
            out.writeObject(data);
<br/>
            out.close();
<br/>
            success = true;
<br/>
        }
<br/>
        catch (IOException e)
<br/>
        {
<br/>
            success = false;
<br/>
        }
<br/>
        return success;
<br/>
    }
<br/>
<br/>
    public Serializable loadState(String pFilename)
<br/>
    {
<br/>
        SerializableShell data = loadShell(pFilename);
<br/>
        if (null == data)
<br/>
        {
<br/>
            return null;
<br/>
        }
<br/>
        return data.host;
<br/>
    }
<br/>
<br/>
    private SerializableShell loadShell(String pFilename)
<br/>
    {
<br/>
        SerializableShell data = null;
<br/>
        try
<br/>
        {
<br/>
            FileInputStream     fis     = new FileInputStream(pFilename);
<br/>
            ObjectInputStream   in      = new ObjectInputStream(fis);
<br/>
            data = (SerializableShell)in.readObject();
<br/>
            in.close();
<br/>
        }
<br/>
        catch (Throwable e)
<br/>
        {
<br/>
            data = null;
<br/>
        }
<br/>
        return data;
<br/>
    }
<br/>
<br/>
    public boolean deleteFiles()
<br/>
    {
<br/>
        boolean success =   (new File(mFileName)).delete();
<br/>
        success         &amp;=  (new File(mMirrorName)).delete();
<br/>
        return success;
<br/>
    }
<br/>
<br/>
    class SerializableShell
<br/>
        implements Serializable
<br/>
    {
<br/>
        public Serializable host;
<br/>
        public int          version;
<br/>
<br/>
        public SerializableShell(Serializable pHost, int pVersion)
<br/>
        {
<br/>
            host = pHost;
<br/>
            version = pVersion;
<br/>
        }
<br/>
    }
<br/>
}</td> </tr></table><span class="postbody">
<br/>
Minus stylistic issues, is there anything obviously stupid about this scheme, or is it more or less usable?
<br/>
<br/>
-Brendan</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
