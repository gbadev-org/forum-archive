<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Code organization + sprites. - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>Coding > Code organization + sprites.</h2>
<div id="posts">
<div class="post">
    <h4>#169360 - mog123 - Mon Jul 06, 2009 12:21 pm</h4>
    <div class="postbody"><span class="postbody">Hey, I've got a question how to do you organize your code in GBA games. Say you have an rpg game and you: divide the certain blocks into .c files like (intro.c menu.c game_engine.c etc) and in your main.c just do something like:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">while(1){
<br/>
intro();
<br/>
if(KEY_PRESS(START)) menu();
<br/>
...etc?</td> </tr></table><span class="postbody">
<br/>
<br/>
Another thing, how do you organize sprites in VRAM/add them to the screen.
<br/>
Let's say I have a 16x32p sprite that is 2x4t. That's a sprite of a guy standing. Let's say I want to just change his legs moving, not the whole guy, So do I have to copy a whole new 16x32 sprite (another head + body with only legs moving) and change his tid OR should I add the sprites in 16x16p chunks and manage the legs spearately from the rest of the body? How do you guys do it?
<br/>
Also, If you have the spare time, can anyone give me a short algorythm how to animate sprites ? Do I need to use counters or can I update the tid every other frame and flip it with if(frame%4) or sth like that?
<br/>
<br/>
Thanks a bunch!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#169362 - DekuTree64 - Mon Jul 06, 2009 2:34 pm</h4>
    <div class="postbody"><span class="postbody">About organization: I usually have a GameMode.c or something to that effect, which manages switching between intro, world map, main game, menus, etc., so my Main.c looks like this:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">[init lots of stuff]
<br/>
GameModeInit();
<br/>
while(1) {
<br/>
    UpdateGameMode();
<br/>
    WaitForVBlank();
<br/>
}</td> </tr></table><span class="postbody">
<br/>
It's pretty simple. Either a function pointer table or a switch statement on an enum of game modes. Each mode has an init, update, and exit function. Then GameMode has a variable for the current mode, and a variable for a new mode to switch to. You can set the new mode variable at any point, and then at the start of the next frame it checks if it's not set to some "no new mode" value and then calls the current mode's exit, new mode's init, and sets the current mode to the new mode.
<br/>
<br/>
About sprites: I wouldn't bother updating the head and legs separately unless I had good reason. Some games use separate sprites for body and legs so you can mix and match upper body animations with standing, walking, crouching, etc. on the legs. But if the only reason the head doesn't change is that I was too lazy to add a little movement in the animation, then it's not worth the trouble.
<br/>
<br/>
About animations: I usually use a delay counter so I can have different delay for each frame of the animation. It also takes less CPU cycles to update than a mod. But unless you have 50 sprites on screen, I wouldn't worry about it. So if you don't need per-frame delay, either way is fine.<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#169363 - mog123 - Mon Jul 06, 2009 2:50 pm</h4>
    <div class="postbody"><span class="postbody">Thanks for the detailed post. It really sorted some stuff up in my head.
<br/>
<br/>
About sprite animation: If I'll try to add so much sprites and animate them, I'll run out of OAM in a second. I've got a 16x32 main character that's going to walk in 8 directions with about 5 frames for each direction + he's gonna attack, cast spells etc. SO just the main character will eat up all my OAM. How do all the games handle it then?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#169364 - DekuTree64 - Mon Jul 06, 2009 3:26 pm</h4>
    <div class="postbody"><span class="postbody">Well, first of all, OAM is the sprite position/priority/tile index/palette index/etc. definitions. I think what you mean is VRAM (the actual pixel data).
<br/>
<br/>
The trick to it is that you only need VRAM for what's displayed on the screen for the current frame. So your player character really only needs enough VRAM for a single 16x32 frame, and then you can copy new pixel data into it from ROM whenever his animation frame changes.
<br/>
<br/>
Copying pixel data around all the time of course takes more CPU cycles than just changing what VRAM location the sprite points to, but usually there's just not enough VRAM otherwise. You can combine techniques though, if you have plenty of VRAM but run into speed problems. Maybe keep idle and walking frames in VRAM all the time, but dynamically load the more rarely used ones. Probably not necessary for an RPG though.<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#169365 - mog123 - Mon Jul 06, 2009 4:13 pm</h4>
    <div class="postbody"><span class="postbody">Yes, I finally understand now :)
<br/>
Thank you so much. I'm gonna try to write my own copying/animation function on days, so please keep track of this topic to see and grade it when I'm finally done.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#169379 - mog123 - Tue Jul 07, 2009 1:37 pm</h4>
    <div class="postbody"><span class="postbody">Hey, I did the loading function :
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void oam_framecpy(u32 sprite_number,u32 frame, u32 sprite_size)
<br/>
{
<br/>
   memcpy(&amp;tile_mem[4][sprite_number*16], &amp;spritesTiles[frame*256], sprite_size);
<br/>
}</td> </tr></table><span class="postbody">
<br/>
The only downside is That it'll work only if by the road there won't be any sprites different in size than 256 (16*32 or 32*16 or 8*64 etc.)
<br/>
Is there a "cure" for this? The only one I can think of is keeping all spritesheets in separate files.
<br/>
<br/>
Oh, I almost forgot, how to set a color to be transparent? I know I have to change it's value to 0x0000, but how to do it with code?
<br/>
Thanks!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#169388 - zazery - Wed Jul 08, 2009 6:10 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>mog123 wrote:</b></span></td> </tr> <tr> <td class="quote">The only downside is That it'll work only if by the road there won't be any sprites different in size than 256 (16*32 or 32*16 or 8*64 etc.)
<br/>
Is there a "cure" for this? The only one I can think of is keeping all spritesheets in separate files.</td> </tr></table><span class="postbody">
<br/>
<br/>
There are many possible solutions to the problem. One of them is to write a dynamic memory allocator for VRAM. Keep track of where contiguous blocks of VRAM are free and pick one that will fit the sprite memory you're trying to allocate. I don't think external fragmentation will be a problem since as you pointed out many sprite shapes have the same tile count.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>mog123 wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
Oh, I almost forgot, how to set a color to be transparent? I know I have to change it's value to 0x0000, but how to do it with code?
<br/>
Thanks!</td> </tr></table><span class="postbody">
<br/>
<br/>
The first index of a palette is the transparent colour regardless of the colour. Commonly the colour is magenta or cyan because those colours are rarely used. See <a class="postlink" href="http://nocash.emubase.de/gbatek.htm#lcdcolorpalettes" target="_blank">LCD Colour Palettes</a> on GBATek for more information.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#169419 - mog123 - Thu Jul 09, 2009 4:57 pm</h4>
    <div class="postbody"><span class="postbody">Ok, here's my walker demo:
<br/>
<br/>
<a href="http://rapidshare.com/files/253846360/walkerguy.zip.html" target="_blank">http://rapidshare.com/files/253846360/walkerguy.zip.html</a>
<br/>
<br/>
I tried changing the first color in the palette to 0x7C1F(the magenda I'm using) but it didn't work, I Still saw the magendish border around the sprite, it wasn't transparent (black)
<br/>
<br/>
I did a simple end animation detection so it loads a still image after the animation finishes. The walker walks in place, so I could see if I placed the frames in correct position, but you can change that by changing the speed variable. Any thoughts on my code? Please give me some advice m(_ _)m</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#169422 - zazery - Thu Jul 09, 2009 7:03 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>mog123 wrote:</b></span></td> </tr> <tr> <td class="quote"> I tried changing the first color in the palette to 0x7C1F(the magenda I'm using) but it didn't work, I Still saw the magendish border around the sprite, it wasn't transparent (black)</td> </tr></table><span class="postbody">
<br/>
<br/>
The reason for the magenta background being displayed is it is not the first colour of the palette. Open up the Palette Viewer in VisualBoyAdvance and you will see that magenta is the 253rd colour of the palette. You can use <a class="postlink" href="http://www.coranac.com/projects/#usenti" target="_blank">Usenti</a> to reorder the palette. The first colour of the palette is currently set to black which means black is your transparent colour right now. Black is not a default transparent colour but certainly looks like it if your background solid black as well.
<br/>
<br/>
If you want to use black as part of your sprite then you'll need to have two black palette entries which makes editing a challenge because you cannot distinguish between the two. This is why people use magenta as a transparent colour since it is almost never used in an actual sprite.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#169423 - mog123 - Thu Jul 09, 2009 7:54 pm</h4>
    <div class="postbody"><span class="postbody">Ok then, I'll try to do it, how does the code look to you?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#169634 - Karatorian - Mon Jul 27, 2009 4:58 pm</h4>
    <div class="postbody"><span class="postbody">Generally, I organize my game code as a state machine. Each part of the game is a state. For instance, the intro is a state, the various menus are each a state, the main gameplay part is a state (or several states, depending on the game), pause is a state, game over is a state, etc.
<br/>
<br/>
Each state has it's own input handling, game logic, and rending code. Which one the main loop calls depends on what state the game is currently in. Of course, by it's own input handling and other code, I don't mean that there's pointless code duplication all over the place. Only the part that has to be different is changed.
<br/>
<br/>
For instance, in a menu state, pressing the A button could select a menu item, while in the game proper it could shoot or something. The part that reads the keypad is the same (in fact, it's in the main loop). However, once the keypad has been read, the state specific input handler decides what to do about it.
<br/>
<br/>
Rendering works similarly. My main graphics routine runs every loop, but the data it's rendering has been selected by the game logic code specific to the current game state.
<br/>
<br/>
Using a state machine is a great convience. It allows you to cleanly modularize your codebase while reusing the bits that ought to remain fairly consistant. It also keeps your code relatively free of complex and error prone if chains or switches.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
