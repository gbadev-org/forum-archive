<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>LUA problems in my engine - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>Coding > LUA problems in my engine</h2>
<div id="posts">
<div class="post">
    <h4>#70881 - TwinD - Thu Feb 09, 2006 7:00 am</h4>
    <div class="postbody"><span class="postbody">Ok
<br/>
<br/>
I have a fairly flexible engine that has been built on for awhile. Originally I was just doing the scripting using C but recently decided to change over to LUA. I use GBFS and seeing as they aren't 'real' files in GBFS I figured I have to use lua_dobuffer instead of lua_dofile so i have a compiled lua file in my GBFS named mithla.lub
<br/>
<br/>
my loading code:
<br/>
	u32 size;
<br/>
	const char* scriptFile = (const char*)gbfs_get_obj(dat, filename, &amp;size);
<br/>
	lua_dobuffer(luaScript, scriptFile, size, filename);
<br/>
<br/>
then to call the autoexec (the one thing im testing)
<br/>
runFunction("autoexec");
<br/>
<br/>
<br/>
// runs a function in the current script 
<br/>
void CScriptHandler::runFunction(char *funcname)
<br/>
{
<br/>
	int top = lua_gettop(luaScript);
<br/>
<br/>
	lua_getglobal(luaScript, funcname);
<br/>
	lua_call(luaScript, 0, 0);
<br/>
	lua_settop(luaScript, top);
<br/>
}
<br/>
<br/>
the lua file has: 
<br/>
-- Test Script File for GBA Engine
<br/>
function autoexec ()
<br/>
	loadMap("Mithla Village");
<br/>
end
<br/>
<br/>
loadMap right now is a hacked function that loads the same map everytime, sets everything up and puts it on screen for testing purposes
<br/>
<br/>
ive made sure im initializing the luaVM, registering all my functions, loading the right file, checked that its in the gbfs, etc but im not seeing the problem and it just isnt doing anything when it calls the autoexec
<br/>
<br/>
any ideas?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#70886 - sajiimori - Thu Feb 09, 2006 8:36 am</h4>
    <div class="postbody"><span class="postbody">There are too many possibilities to troubleshoot.  Find a minimal sample and get it running on your PC, then get the same thing running on GBA.  After that it's easy.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#71023 - tepples - Fri Feb 10, 2006 1:02 am</h4>
    <div class="postbody"><span class="postbody">In fact, you can even test the GBFS handling code on the PC by malloc()ing a buffer and loading your .gbfs file into that. Provided you're running on a 32-bit little-endian platform (e.g. x86), it should work out of the box.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#71592 - TwinD - Mon Feb 13, 2006 5:40 pm</h4>
    <div class="postbody"><span class="postbody">well i've researched this issue further and come to the following conclusion:
<br/>
<br/>
if i use a .lua file containing no functions such as:
<br/>
<br/>
loadMap("blahba");
<br/>
setCameraFocus(0);
<br/>
<br/>
it will work fine,
<br/>
<br/>
however if i do
<br/>
function autoexec()
<br/>
   loadMap("blahba");
<br/>
   setCameraFocus(0);
<br/>
end
<br/>
<br/>
it will load up fine, but when i do lua_getglobal(l, "autoexec); and then do a lua_call it never calls the function... it's a bit bizarre, i'm confused as to why it must be reading it right but won't be calling it... maybe someone with some lua experience could help</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#71704 - Joat - Tue Feb 14, 2006 1:42 am</h4>
    <div class="postbody"><span class="postbody">Not knowing anything at all about lua, have you tried looking for a get last error function or similar (seems to be using a stack mentality, since you don't get any return values from the global lookup), and instrumenting the runFunction call to make sure it's working as expected?
<br/>
<br/>
Also, heya, it's been forever :D<br/>_________________<br/>Joat
<br/>
<a href="http://www.bottledlight.com" target="_blank">http://www.bottledlight.com</a></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
