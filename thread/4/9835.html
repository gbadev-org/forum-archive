<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>hblank interrupts during vblank? - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>Coding > hblank interrupts during vblank?</h2>
<div id="posts">
<div class="post">
    <h4>#86770 - Exophase - Fri Jun 09, 2006 3:28 am</h4>
    <div class="postbody"><span class="postbody">GBATEK clearly says they don't occur, but both No$GBA and VBA seem to be generating them, which one is it on actual hardware? If I'm wrong about the emulators please correct me as well, but it definitely seems to be the case (and a glance at VBA's source backs this up).. it's be weird for No$GBA to behave that way when the doc by the very same author contradicts it though.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#86778 - tepples - Fri Jun 09, 2006 5:49 am</h4>
    <div class="postbody"><span class="postbody">Hblank interrupts do occur during vblank. Hblank DMA does not occur during vblank.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#86784 - Ant6n - Fri Jun 09, 2006 7:17 am</h4>
    <div class="postbody"><span class="postbody">so when the screen is done drawing you can actually have an hblank and vblank interrupt happening at the same time (i.e. two bits set in IF) ?
<br/>
I always thought that this is very unlikely to happen.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#86799 - Exophase - Fri Jun 09, 2006 1:11 pm</h4>
    <div class="postbody"><span class="postbody">Thanks, that's very good to know (writing an emulator), GBATEK really should be corrected then, this is what it says:
<br/>
<br/>
"Note that no H-Blank interrups are generated within V-Blank period."
<br/>
<br/>
Ant6n; I don't think that'll happen, as far as I'm aware the vblank will start (and thus the interrupt will occur) at the beginning of the "virtual" vertical refresh period of line 160, while the hblank won't start until the last 68 "virtual" pixels of that line. Besides that I don't think interrupts can really occur at the same time anyway, not with the way the hardware works, even if they're to happen at the same time one will get to the CPU first and the other will have to wait for interrupts to be enabled again.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#86858 - edwdig - Fri Jun 09, 2006 11:21 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Ant6n wrote:</b></span></td> </tr> <tr> <td class="quote">so when the screen is done drawing you can actually have an hblank and vblank interrupt happening at the same time (i.e. two bits set in IF) ?
<br/>
I always thought that this is very unlikely to happen.</td> </tr></table><span class="postbody">
<br/>
<br/>
Mutliple interrupts can definitely occur at the same time. I had a bug that took me forever to track down where once every several thousand frames one of my interrupts wouldn't trigger. Turns out a lot of the interrupt handlers you find floating on the net don't cope with multiple simultaneous interrupts.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#87362 - Ultima2876 - Tue Jun 13, 2006 3:52 pm</h4>
    <div class="postbody"><span class="postbody">I have this bug too... how did you fix it?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#87366 - tepples - Tue Jun 13, 2006 4:02 pm</h4>
    <div class="postbody"><span class="postbody">A GBA multiple interrupt service routine will look like this:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void isr(void) {
<br/>
  unsigned int interrupts = REG_IF;
<br/>
<br/>
  if (interrupts &amp; INT_TIMER1) {
<br/>
    // switch the audio buffer
<br/>
  }
<br/>
  if (interrupts &amp; INT_HBLANK) {
<br/>
    // hblank code goes here, although it may be faster to use hdma
<br/>
  }
<br/>
  if (interrupts &amp; INT_SERIAL) {
<br/>
    // add the received data to a ring buffer
<br/>
    // send the next byte of the packet
<br/>
  }
<br/>
  if (interrupts &amp; INT_VBLANK) {
<br/>
    // vblank code goes here
<br/>
  }
<br/>
<br/>
  // Acknowledge those interrupts that we handled to the BIOS...
<br/>
  VBLANK_INTR_WAIT_FLAGS |= interrupts;  // notice: |= not =
<br/>
<br/>
  // ...and to the hardware.
<br/>
  REG_IF = interrupts;  // notice: = not |=
<br/>
}</td> </tr></table><span class="postbody"><br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#87459 - Ant6n - Wed Jun 14, 2006 12:45 am</h4>
    <div class="postbody"><span class="postbody">PERN has a working one, at leas that's what they told me in the asm thread.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
