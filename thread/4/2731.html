<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>sprites in mode 4 - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>Coding > sprites in mode 4</h2>
<div id="posts">
<div class="post">
    <h4>#15449 - slboytoy - Thu Jan 22, 2004 9:23 pm</h4>
    <div class="postbody"><span class="postbody">hi there
<br/>
<br/>
i'm working on a program that draws a background in mode 4.  i'm trying to modify this so that a sprite is displayed over top of the background.  the code compiles ok but when i run it on Visual Boy Advance the sprite does not show up.  i checked the map view and the OAM viewer and everything seems to be working.  i can push a key and control the sprite animation on the OAM viewer but, like i said, i does not show up on the game screen.
<br/>
<br/>
anybody have any ideas/suggestions about how to fix this?
<br/>
<br/>
thanks</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#15452 - sajiimori - Thu Jan 22, 2004 9:39 pm</h4>
    <div class="postbody"><span class="postbody">Did you enable sprites in REG_DISPCNT?
<br/>
<br/>
Can you see the sprite if you don't turn on the background?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#15453 - slboytoy - Thu Jan 22, 2004 9:42 pm</h4>
    <div class="postbody"><span class="postbody">yeah.  here's the code for that in case i buggered it up some how
<br/>
<br/>
SetMode(MODE_4 |BG2_ENABLE | OBJ_ENABLE | OBJ_MAP_1D);
<br/>
<br/>
i can't see the sprite in mode 4 with the backgound off...only mode 2</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#15454 - johnny_north - Thu Jan 22, 2004 9:51 pm</h4>
    <div class="postbody"><span class="postbody">Half the memory for sprites is available in mode 4 than for mode 2. Check one of the available tech refs to be sure you're selecting them correctly (GBATEK or PERN).</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#15455 - slboytoy - Thu Jan 22, 2004 9:57 pm</h4>
    <div class="postbody"><span class="postbody">i've read a couple of places about the OAM memory being halved in mode 4 but i haven't seen anything on how to actually fix the problem.  do i just change the starting address of the OAM in my program?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#15456 - johnny_north - Thu Jan 22, 2004 10:05 pm</h4>
    <div class="postbody"><span class="postbody">Seriously, read one of those two docs. The pern project will tell you exactly what to do. The key is that you will have fewer sprite tiles to work with not fewer sprite objects.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#15458 - slboytoy - Thu Jan 22, 2004 10:17 pm</h4>
    <div class="postbody"><span class="postbody">i don't see where it makes mention to using sprites in mode 4 on the pern project site.  can you possibly point me in the right direction?  it's not in the sprite tutorial (day 3).  is it somewhere else or am i just an idiot?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#15459 - johnny_north - Thu Jan 22, 2004 10:25 pm</h4>
    <div class="postbody"><span class="postbody">From pern day 3:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Character data starts at 0x6010000 and extends for 32KB. It consists of 1024 8x8 16 color tiles (256 color tiles actually take two 8x8 slots). The character name bits in attribute 2 refer to one of these tiles. The problem with this set up is that bit map modes (mode 3,4, and 5) actually extend into the character data area of memory cutting it in half. This means that only character names greater than 511 are allowed in the bitmap modes.</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#15463 - slboytoy - Thu Jan 22, 2004 10:38 pm</h4>
    <div class="postbody"><span class="postbody">so......what does that mean?????????
<br/>
<br/>
what do i actually need to change?   the loop for copying the array into the OAM?  or is it the one for copying the sprite to the screen?  or is it the frame markers that need to be reset??  
<br/>
<br/>
i tried changing each of these separtely to no avail.  the closest i came was changing the loop for copying the sprite array into the OAM.  this allowed me to see the first frame of the sprite (on the OAM viewer only) but i can't cycle it up and down like i was previously</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#15467 - sajiimori - Thu Jan 22, 2004 10:56 pm</h4>
    <div class="postbody"><span class="postbody">Don't confuse OAM with character (tile) memory.
<br/>
<br/>
There are normally 1024 sprite characters available (when using 16 color sprites).  In modes 3-5, only the second 512 of them are available.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#define CHAR_MEMORY (u8*)0x6010000
<br/>
#define CHAR_LOCATION(n) (CHAR_MEMORY+32*(n))
<br/>
</td> </tr></table><span class="postbody">
<br/>
You should load your sprites starting at CHAR_LOCATION(512).
<br/>
<br/>
Understand now?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#15476 - slboytoy - Thu Jan 22, 2004 11:18 pm</h4>
    <div class="postbody"><span class="postbody">i didn't work.  the "CHAR_MEMORY" definition in the previous example is handled by a value called "OAMData" however this is defined as an u16 instead of just an u8.  do i not have to shift  sprite frames for my active frame up?  i did this and it didn't work.
<br/>
<br/>
any extra help would be appreciated</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#15481 - sajiimori - Fri Jan 23, 2004 12:14 am</h4>
    <div class="postbody"><span class="postbody">I can't tell what you're doing unless you post some code.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#15488 - tepples - Fri Jan 23, 2004 3:23 am</h4>
    <div class="postbody"><span class="postbody">In modes 3 through 5, you need to copy your sprite cel data into some location between 0x06014000 and 0x06017FFF. These correspond to attribute 2 tile numbers 512 through 1024. Quickest way to test for this is to run your program in VisualBoyAdvance, open the Map Viewer, switch to frame 1, and look for some corruption in the bottom half.
<br/>
<br/>
Posting all source code that writes to OAM or to VRAM (or writes to structures that are copied directly to OAM) would help the most. If you can't do that, even uploading your program's binary might help, as some readers of this forum have mad ski11z with VBA's viewers and, after having analyzed the program, will tell you exactly what you're doing wrong and what he or she did to find it.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#15634 - slboytoy - Mon Jan 26, 2004 7:48 pm</h4>
    <div class="postbody"><span class="postbody">thanks everyone for your help.  i'm pretty close to getting it to work but it's still not quite there.  here's my code.  if anybody sees anything that i did wrong let me know.  
<br/>
<br/>
thanks again
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code"> 
<br/>
#include "gba.h"       //GBA register definitions
<br/>
#include "keypad.h"     //button registers
<br/>
#include "dispcnt.h"    //REG_DISPCNT register #defines
<br/>
#include "sprit.h"      //my generic sprite header file
<br/>
#include "numbers.h"   //sprite info
<br/>
#include "palette.h"   //palette info
<br/>
#include "backgroundpic.h"   //holds the image information in an array
<br/>
<br/>
//*****OAMData = 0x6014000 &lt;==this was done in gba.h***** 
<br/>
<br/>
<br/>
#define MULTIBOOT const int __gba_multiboot
<br/>
MULTIBOOT = 1;
<br/>
<br/>
//create an OAM variable and make it point to the address of OAM
<br/>
u16* OAM = (u16*)0x7000000;
<br/>
<br/>
//create the array of sprites (128 is the maximum)
<br/>
OAMEntry sprites[128];
<br/>
<br/>
//create the rotation and scaling array (overlaps the OAMEntry array memory)
<br/>
pRotData rotData = (pRotData)sprites;
<br/>
<br/>
//animated sprite structure required
<br/>
typedef struct
<br/>
{
<br/>
   u16 x;         //x and y position on screen
<br/>
   u16 y;
<br/>
   u16 spriteFrame[10];     //animation frame
<br/>
   int activeFrame;        //which frame is active
<br/>
}Sprite;
<br/>
<br/>
Sprite numSprite;      //create instance
<br/>
<br/>
//Copy our sprite array to OAM
<br/>
void CopyOAM()
<br/>
{
<br/>
   u16 loop;
<br/>
   u16* temp;
<br/>
   temp = (u16*)sprites;
<br/>
   for(loop = 0; loop &lt; 128*4; loop++)
<br/>
   {
<br/>
      OAM[loop] = temp[loop];
<br/>
   }
<br/>
}
<br/>
<br/>
//Set sprites to off screen
<br/>
void InitializeSprites()
<br/>
{
<br/>
   u16 loop;
<br/>
   for(loop = 0; loop &lt; 128; loop++)
<br/>
   {
<br/>
      sprites[loop].attribute0 = 160;  //y to &gt; 159
<br/>
      sprites[loop].attribute1 = 240;  //x to &gt; 239
<br/>
   }
<br/>
}
<br/>
<br/>
//move the background image into memory
<br/>
void PlotPixel(int x,int y, unsigned short int c)
<br/>
{
<br/>
   VideoBuffer[(y) * 120 + (x)] = (c);
<br/>
}
<br/>
<br/>
//wait for the screen to stop drawing
<br/>
void WaitForVsync()
<br/>
{
<br/>
   while((volatile u16)REG_VCOUNT != 160){}
<br/>
}
<br/>
<br/>
void GetInput()
<br/>
{
<br/>
   if(!(*KEYS &amp; KEY_UP))      //if the up key is pressed
<br/>
   {
<br/>
      if (numSprite.activeFrame &gt; 0)
<br/>
      {
<br/>
         numSprite.activeFrame = numSprite.activeFrame - 1;
<br/>
         sprites[0].attribute2 = numSprite.spriteFrame[numSprite.activeFrame];
<br/>
      }
<br/>
   }
<br/>
   if(!(*KEYS &amp; KEY_DOWN))         //if the up down is pressed
<br/>
   {
<br/>
       if (numSprite.activeFrame &lt; 9)
<br/>
       {
<br/>
          numSprite.activeFrame = numSprite.activeFrame + 1;
<br/>
         sprites[0].attribute2 = numSprite.spriteFrame[numSprite.activeFrame];
<br/>
      }
<br/>
   }
<br/>
}
<br/>
<br/>
<br/>
int main()
<br/>
{
<br/>
   u16 loop;       //generic loop variable
<br/>
        numSprite.x = 25;   //variables to hold position of number sprite on screen
<br/>
   numSprite.y = 25;
<br/>
   int x, y;
<br/>
<br/>
          SetMode(MODE_4 |BG2_ENABLE | OBJ_ENABLE | OBJ_MAP_1D); //set mode 4, enable sprites, 1d mapping and enable background 2
<br/>
<br/>
   for(loop = 0; loop &lt; 256; loop++)          //load the palette into memory
<br/>
      OBJPaletteMem[loop] = numberPalette[loop];
<br/>
<br/>
   for(loop = 0; loop &lt; 256; loop++)                 //256 entries allowed
<br/>
      BGPaletteMem[loop] = backgroundpicPalette[loop]; //load the palette into palette memory
<br/>
   
<br/>
   InitializeSprites();
<br/>
<br/>
   sprites[0].attribute0 = COLOR_256 | SQUARE | numSprite.y;   //setup sprite info, 256 colour, shape and y-coord
<br/>
   sprites[0].attribute1 = SIZE_16 | numSprite.x;             //size 16x16 and x-coord
<br/>
   sprites[0].attribute2 = 512;                              //pointer to tile where sprite starts
<br/>
<br/>
       for(loop = 0; loop &lt; 1280; loop++)                      //load sprite image data
<br/>
   {
<br/>
      OAMData[loop] = numData[loop];
<br/>
   }
<br/>
<br/>
   numSprite.activeFrame = 512;                    //set the initial active frame markers
<br/>
   numSprite.spriteFrame[0] = 512;                 //set the frame markers
<br/>
   numSprite.spriteFrame[1] = 520;
<br/>
   numSprite.spriteFrame[2] = 528;
<br/>
   numSprite.spriteFrame[3] = 536;
<br/>
   numSprite.spriteFrame[4] = 544;
<br/>
   numSprite.spriteFrame[5] = 552;
<br/>
   numSprite.spriteFrame[6] = 560;
<br/>
   numSprite.spriteFrame[7] = 568;
<br/>
   numSprite.spriteFrame[8] = 576;
<br/>
   numSprite.spriteFrame[9] = 584;
<br/>
<br/>
<br/>
   while(1)                                //main loop
<br/>
        {
<br/>
      //plot the background
<br/>
      for(y = 0; y &lt; 160; y++)                  //screen height
<br/>
      {
<br/>
         for(x = 0; x &lt; 120; x++)          //screen width
<br/>
         {
<br/>
            PlotPixel(x,y, backgroundpicData[y*120+x]);   //load image data into
<br/>
         }                  //memory pixel by pixel
<br/>
      }
<br/>
   
<br/>
      //control the sprite
<br/>
      GetInput();
<br/>
      WaitForVsync();         //waits for the screen to stop drawing
<br/>
      CopyOAM();         //Copies sprite array into OAM.
<br/>
   }
<br/>
}
<br/>
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#15641 - sajiimori - Mon Jan 26, 2004 11:33 pm</h4>
    <div class="postbody"><span class="postbody">What does it do wrong?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#15644 - dagamer34 - Tue Jan 27, 2004 12:25 am</h4>
    <div class="postbody"><span class="postbody">Try plotting your pixels AFTER VSync. That might help. Other than that, all I can say is to look at the demos on this site, one of them deals with sprites in <b style="color:#FFA34F">mode</b> <b style="color:#FFA34F">4</b>.
<br/>
<br/>
Try doing the simple stuff and build up from that. Remove code as needed. Its easier to fix a car engine after you have opened the hood, right?<br/>_________________<br/>Little kids and Playstation 2's don't mix. :(</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#15648 - sajiimori - Tue Jan 27, 2004 12:33 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
Try plotting your pixels AFTER VSync. That might help.
<br/>
</td> </tr></table><span class="postbody">
<br/>
It doesn't really matter.  In fact, the plotting really only needs to be done once, before the main loop.  All the redundant copying will slow things down quite a bit.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#15734 - slboytoy - Wed Jan 28, 2004 6:43 pm</h4>
    <div class="postbody"><span class="postbody">well i got the initial loading figured out.  thanks everyone for helping with that.  now i was just wondering how many frames i can load into memory for each sprite.
<br/>
<br/>
the idea is i have one sprite containing the data for 16 seperate frames.  i want to be able to scroll through the frames using the keypad.  
<br/>
<br/>
do i need to split these frames into different sprites?  if so, how many frames will each be able to hold?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#15741 - tepples - Wed Jan 28, 2004 9:09 pm</h4>
    <div class="postbody"><span class="postbody">Either you can keep all your sprite cels in sprite cel VRAM (0x06014000-0x06017fff) and switch among them in <b style="color:#FFA34F">OAM</b>, or you can keep your sprite cels in EWRAM or ROM and copy one into VRAM at a time.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#15743 - sajiimori - Wed Jan 28, 2004 9:42 pm</h4>
    <div class="postbody"><span class="postbody">I'll elaborate on what tepples said a bit.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
do i need to split these frames into different sprites? if so, how many frames will each be able to hold?
<br/>
</td> </tr></table><span class="postbody">
<br/>
It sounds like you have the wrong idea about how the sprite hardware works.  Sprites don't "hold" frames, and frames aren't made of sprites.
<br/>
<br/>
The GBA has 2 blocks of memory that are relevant to sprite management.
<br/>
<br/>
There's what I call character RAM (sometimes called tile memory or character base blocks), which is where you store sprite pixel information in 8x8 tiles.  It has room for 1024 16-color tiles, or 512 256-color tiles.
<br/>
<br/>
Some gba headers #define character RAM as OAMData, but that's a really misleading name because there's a totally seperate area of memory called Object Attribute Memory (<b style="color:#FFA34F">OAM</b>) that is used for a completely different purpose.  <b style="color:#FFA34F">OAM</b> stores information for up to 128 sprites that are currently on-screen.  Each entry stores things like size, x and y position, and also a number referring to a tile in character RAM.  That tile will be the top-left tile of the on-screen sprite.
<br/>
<br/>
So you could say that you use <b style="color:#FFA34F">OAM</b> to tell the GBA what sprites you want on-screen, and you use character RAM to tell the GBA what pixel data to use for them.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#15769 - slboytoy - Thu Jan 29, 2004 7:41 pm</h4>
    <div class="postbody"><span class="postbody">got everything working.  thanks for all the help</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
