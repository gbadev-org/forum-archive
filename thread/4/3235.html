<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>DMA Loading + Clearing... - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>Coding > DMA Loading + Clearing...</h2>
<div id="posts">
<div class="post">
    <h4>#19283 - darknet - Fri Apr 16, 2004 3:47 am</h4>
    <div class="postbody"><span class="postbody">I am writing a game that is a bunch of mini-games all independent of each other and work through a main driver program.
<br/>
<br/>
I successfully wrote a breakout clone and a gradius clone in that order. Both use Harbours (the GBA book) DMAFastCopy function to load in the tiled backgrounds. 
<br/>
<br/>
When I finished the Breakout clone (before I began writing the gradius clone), the background loaded up just fine. Then I wrote the gradius clone and THAT background loads up fine as well. However, now the tiles in the breakout clone are corrupt (and I didnt change that code whatsoever from when it was working!)
<br/>
<br/>
So since I use the same DMA copy function in both, I am assuming that I may have to reset the DMA registers or somehow clear it for BOTH minigames to work? Here's some of the code I've mentioned...
<br/>
<br/>
The DMAFastCopy function:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
void DMAFastCopy(void* source, void* destination, unsigned int count,
<br/>
                 unsigned int mode) {
<br/>
<br/>
    if(mode == DMA_16NOW || mode == DMA_32NOW) {
<br/>
            REG_DMA3DAD = (unsigned int)destination;
<br/>
            REG_DMA3SAD = (unsigned int)source;
<br/>
            REG_DMA3CNT = count | mode;
<br/>
    }
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
and the code that Breakout uses to load its background:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
 //copy the palette into the background palette memory
<br/>
 DMAFastCopy((void*)boback_Palette, (void*)BGPaletteMem, 256, DMA_16NOW);
<br/>
<br/>
 //now copy the tile images into tile memory
<br/>
 DMAFastCopy((void*)background_Tiles, (void*)charBaseBlock(0), 65088/4, DMA_32NOW);
<br/>
<br/>
//Finally, draw the background's map.
<br/>
 DMAFastCopy((void*)background_Map, (void*)bgOneMap, 1024, DMA_32NOW);
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
and the code that Gradius uses to load its background:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
 //copy the palette into the background palette memory
<br/>
 DMAFastCopy((void*)defenderMap_Palette, (void*)BGPaletteMem, 256, DMA_16NOW);
<br/>
<br/>
 //now copy the tile images into tile memory
<br/>
 DMAFastCopy((void*)defenderMap_Tiles, (void*)charBaseBlock(0), 6848/4, DMA_32NOW);
<br/>
<br/>
 //Finally, draw the background's map.
<br/>
 DMAFastCopy((void*)defenderMap_Map, (void*)bgOneDefendMap, 1024, DMA_32NOW);
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Once again, the Breakout worked just fine before I wrote the gradius game. The gradius one works fine now but the breakout one has corrupt tiles.
<br/>
<br/>
I actually run the entire project through a main.cpp that simply switches appropiately between the two games' start functions. Selecting the two also involves switching to mode 3 and displaying a menu, if that may have anything to do with it. I wrote both games as if the other did not exist.
<br/>
<br/>
I hope I asked my question clearly, thanks very very much for reading and any reply is greatly appreciated.
<br/>
<br/>
-Mike</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#19284 - poslundc - Fri Apr 16, 2004 4:07 am</h4>
    <div class="postbody"><span class="postbody">A few notes:
<br/>
<br/>
1. Make sure that your GBA header file declares the various REG_DMA3XXX registers as being volatile (or vu32 as opposed to just u32).
<br/>
<br/>
2. Try inserting the line REG_DMA3DCNT = 0; at the beginning of the if-block in the DMAFastCopy function. The DMA needs to be disabled in order for the source and destination to be written to.
<br/>
<br/>
3. If neither of those make a difference, try replacing your DMA function with a simple loop that copies the data from one location to the other. This will tell you if it's the DMA or if it's some other problem with your code.
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#19287 - darknet - Fri Apr 16, 2004 6:22 am</h4>
    <div class="postbody"><span class="postbody">I did set that register equal to 0 as you suggested, that sounded like a good idea regardless of my problem.
<br/>
<br/>
I followed your other instructions and nothing was working yet. I then loaded the data the traditional way with the Background struct. It was there that I found my problem.
<br/>
<br/>
The conversion program I use converts tiles as chars, not shorts. My background struct (and loop) was loading them as shorts, thus the problem.
<br/>
<br/>
I changed the tileData pointer to a char and everything is all good.
<br/>
<br/>
Thanks alot,
<br/>
-Mike</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
