<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Fixed point multiplication accuracy [sorted] - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>Coding > Fixed point multiplication accuracy [sorted]</h2>
<div id="posts">
<div class="post">
    <h4>#130526 - keldon - Mon Jun 04, 2007 5:25 pm</h4>
    <div class="postbody"><span class="postbody">I'm just working on some code in fixed point and encountered terrible blockiness, so I rearranged the multiplies and the shifting of the code like the <a class="postlink" href="http://www.coranac.com/tonc/text/mode7.htm" target="_blank">mode 7 example</a>. But why is it more accurate??? (I later found out from writing this post)
<br/>
<br/>
Note: PA,PB,PC and PD are 16.16 and the rest are integers at the moment (xRef and yRef will be 16.16 later).
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">// example 1
<br/>
         long a,b;
<br/>
         a = (long)PA * (long)x;
<br/>
         a -= (long)PA * (long)xRef;
<br/>
         b = (long)PB * (long)y;
<br/>
         b -= (long)PB * (long)yRef;
<br/>
         return (int)((a + b)&gt;&gt;16) + xRef;
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">// example 2
<br/>
         return (fmul(PA , (x - xRef)) + fmul(PB , (y - yRef)) + xRef)&gt;&gt;16;</td> </tr></table><span class="postbody">
<br/>
<br/>
Despite every other variable being an integer, every multiplication still may produce detail past the point; each multiplication truncates this detail.  What a massive difference in quality!!!
<br/>
<br/>
Well since I figured it out it's not really a question but I still decided to post it as it <span style="font-style: italic">may</span> help someone in some random way, despite it being said in the Mode 7 tutorial.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#130588 - Miked0801 - Tue Jun 05, 2007 4:45 pm</h4>
    <div class="postbody"><span class="postbody">Can you post the original order?  That will help me (us) show you where the over/underflow was occuring.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#130599 - tepples - Tue Jun 05, 2007 7:41 pm</h4>
    <div class="postbody"><span class="postbody">Fixed-point multiplications consist of a multiplication followed by a division by a denominator. If you can rearrange things so that you can multiply before dividing without overflowing 32 bits, you preserve more precision into the final coordinates. A lot of the fine-tuning of the effects engine in <a class="postlink" href="http://www.pineight.com/tod/" target="_blank">TOD</a> went toward this.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#130608 - keldon - Tue Jun 05, 2007 8:18 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tepples wrote:</b></span></td> </tr> <tr> <td class="quote">Fixed-point multiplications consist of a multiplication followed by a division by a denominator. If you can rearrange things so that you can multiply before dividing without overflowing 32 bits, you preserve more precision into the final coordinates. A lot of the fine-tuning of the effects engine in <a class="postlink" href="http://www.pineight.com/tod/" target="_blank">TOD</a> went toward this.</td> </tr></table><span class="postbody">
<br/>
Funnily enough that's kind of what I was working on (well the hardware implementation side of it). It's basically a Java emulation of [some of] the GBA hardware but you could easily recode it into C to work with the PC TOD to make for an easy port of the GBA version's features as it emulates the hardware really good. In fact I've created a Mode 7 demo for it already! EDIT: ooh completely forgot about the winTOD that has it
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Miked0801 wrote:</b></span></td> </tr> <tr> <td class="quote">PostPosted: Tue Jun 05, 2007 3:45 pm    Post subject:
<br/>
Can you post the original order? That will help me (us) show you where the over/underflow was occuring.</td> </tr></table><span class="postbody">
<br/>
Thanks, but the problem is pretty much solved and understood. Plus now that BGnX and BGnY are 16:16 (in the GBA Hardware emulator type thing I'm working on) the old code doesn't quite give the same looking error as the naive method will now display the pixels fine but move funny when moving around the reference points.
<br/>
<br/>
It was something like this:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">return (PA * (x - xRef)) + (PB * (y - yRef))&gt;&gt;16 + (xRef&gt;&gt;16)</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
