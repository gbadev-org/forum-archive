<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>mini-game structure (fsm?!?) - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>Coding > mini-game structure (fsm?!?)</h2>
<div id="posts">
<div class="post">
    <h4>#18574 - darknet - Mon Mar 29, 2004 2:57 am</h4>
    <div class="postbody"><span class="postbody">Here Goes:
<br/>
<br/>
I (for those who haven't helped me before) am making a game full of TIMED mini-games, in the vein of warioware microgames (but not that frantic!)
<br/>
<br/>
I have 2 games complete (of 4 or 5), but the main driver (main.cpp) is not functioning properly. 
<br/>
<br/>
Basically, when a player beats a mini-game or time runs out on a mini-game, I want to the user to be transported back to the main menu. With my structure however, I cannot find a clean or good or working way to do this.
<br/>
<br/>
Each mini-game is completely self-contained and the all of the game code goes in a startGame() function (i.e. Breakout has void startBreakout() ). I have the user play the games until time either runs out or they complete the game. The main.cpp driver has a loadMiniGame function that does the following:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
void loadMiniGame() {
<br/>
<br/>
      drawMode3Background(videoBuffer, menu_Bitmap);
<br/>
      current_state = IN_MENU;
<br/>
<br/>
      int previousButton, button, down, up;
<br/>
<br/>
      while(current_state!=QUIT) {
<br/>
<br/>
         button = *BUTTONS ^ 0x03ff;
<br/>
         down = button &amp; ~previousButton;   //pressed since last loop
<br/>
         up = previousButton &amp; ~button;    //released since last loop
<br/>
<br/>
         if( (down &amp; A_BUTTON) !=0) {
<br/>
<br/>
            switch(current_state) {
<br/>
               case IN_MENU:
<br/>
                  startTxtAdventure();
<br/>
                  break;
<br/>
            }
<br/>
         }
<br/>
         
<br/>
         if( (down &amp; B_BUTTON) !=0) {
<br/>
<br/>
           switch(current_state) {
<br/>
               case IN_MENU:
<br/>
                  startBreakout();
<br/>
                  break;
<br/>
            }
<br/>
         }
<br/>
<br/>
         previousButton = button;
<br/>
         waitForVSync();
<br/>
<br/>
      }
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
As of right now, once the mini-game ends the entire program halts and goes nowhere. I tried throwing in other cases within each to no avail. I even have a getState function within each game that gets the final state. No dice when I tried getting the state within the above code and checking if it was a certain value.
<br/>
<br/>
I hope this question makes sense. I suppose in an abstract manner the question is how the main driver can regain control of the program once the mini-game halts. Seems easy enough, but been having the worst time getting something going.
<br/>
<br/>
Any help is appreaciated + thanks alot for reading.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#18575 - Darmstadium - Mon Mar 29, 2004 3:40 am</h4>
    <div class="postbody"><span class="postbody">If I understand your meaning, I would do something like this: have a variable that keeps track of what phase your game is in. Then in your main loop have if statements that make the game act how you want based on what phase it's in. I'll show you what I mean:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
u8 phase = 0;
<br/>
<br/>
while (1)
<br/>
{
<br/>
     if (phase == 0)
<br/>
          doMainMenu();
<br/>
     if (phase == 1)
<br/>
          doMinigameOne();
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
Then all's you have to do is change the phase variable to make your game go around between your different things. I hope I was able to help.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#18576 - darknet - Mon Mar 29, 2004 4:01 am</h4>
    <div class="postbody"><span class="postbody">That seems to make sense....except where would I change the phase variable? Right after the function call? i.e.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
 if (phase == 0)
<br/>
          doMainMenu();
<br/>
          phase = 1;
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
? You did understand my question correctly. I think I forgot to mention part of the dilemma was where that overall state variable is being changed (or phase variable). I have been doing something somewhat similar and changing the state in each game and then testing for equality...but that does not seem to work.
<br/>
<br/>
Thanks,
<br/>
-Mike</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#18579 - tepples - Mon Mar 29, 2004 4:18 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>darknet wrote:</b></span></td> </tr> <tr> <td class="quote">That seems to make sense....except where would I change the phase variable? Right after the function call? i.e.
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
 if (phase == 0)
<br/>
          doMainMenu();
<br/>
          phase = 1;
<br/>
</td> </tr></table><span class="postbody"></span></td> </tr></table><span class="postbody">
<br/>
Been coding too much Python lately? If you have more than one statement, you need to bracket your code like this:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
if (phase == 0)
<br/>
{
<br/>
  doMainMenu();
<br/>
  phase = 1;
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
If I were coding it, I'd use a switch statement:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">switch(phase)
<br/>
{
<br/>
  case MAIN_MENU:
<br/>
    phase = doMainMenu();
<br/>
    break;
<br/>
}</td> </tr></table><span class="postbody">
<br/>
And then each function would return a constant representing what state to go to next.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#18584 - MumblyJoe - Mon Mar 29, 2004 6:11 am</h4>
    <div class="postbody"><span class="postbody">Actually you have shown another great reason to use c++, classes with constructors and destructors that inherit from a base class with the functions needed would suit your need perfectly as i see it.<br/>_________________<br/><a class="postlink" href="http://www.hungrydeveloper.com" target="_blank">www.hungrydeveloper.com</a>
<br/>
Version 2.0 now up - guaranteed at least 100% more pleasing!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#18615 - dagamer34 - Mon Mar 29, 2004 11:05 pm</h4>
    <div class="postbody"><span class="postbody">You would change the phase variable inside one of the functions (or in this case, mini-games) to change the game state.
<br/>
<br/>
Like have 1 represent the menu, 2 the first mini-game, 3 the second mini-game, etc.. and have a number for loosing and stuff like that.<br/>_________________<br/>Little kids and Playstation 2's don't mix. :(</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#18629 - SmileyDude - Tue Mar 30, 2004 5:52 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>MumblyJoe wrote:</b></span></td> </tr> <tr> <td class="quote">Actually you have shown another great reason to use c++, classes with constructors and destructors that inherit from a base class with the functions needed would suit your need perfectly as i see it.</td> </tr></table><span class="postbody">
<br/>
<br/>
That, and virtual functions -- instead of using a switch statement for a FSM, it's easier to do something like this in your while loop:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">currentState.update();</td> </tr></table><span class="postbody">
<br/>
<br/>
Of course, I'm sure that there are plenty of people here that will scream bloody murder about using virtual functions, but for something like this, it's a perfect application.... and probably faster too.<br/>_________________<br/>dennis</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#18653 - torne - Tue Mar 30, 2004 11:28 pm</h4>
    <div class="postbody"><span class="postbody">A switch that gets compiled to a jump table is going to be in the same ballpark as a virtual function dispatch. A switch that's compiled to sequential if-else's will probably be slower than virtual dispatch.
<br/>
<br/>
The only way you'll get it faster than a virtual function is to use a function pointer, and that's not going to gain much. If you're comfortable with OO programming, use it.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#18980 - SmileyDude - Fri Apr 09, 2004 3:28 am</h4>
    <div class="postbody"><span class="postbody">At a talk during the GDC (C++ performance), the performance guy from Microsoft said that they haven't seen any cases where virtual functions are a bottleneck in the games they have tested.  The overhead just isn't that much.<br/>_________________<br/>dennis</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#18986 - NoMis - Fri Apr 09, 2004 7:08 am</h4>
    <div class="postbody"><span class="postbody">yeah if you have a 3 ghz machine. But what about the gba, wich is significantly slower than this. I use C++ too and i use some virtual functions but you need to know where to use them. e.g. if you call a virtual function within an inner loop wich may run, say 500 times every frame it will slow everything down because you have to lookup 500 times. but if it happens once a frame its not that big problem. But you can still use compile time polimorphismus in such cases (see <a href="http://www.gamedev.net/reference/articles/article2015.asp" target="_blank">http://www.gamedev.net/reference/articles/article2015.asp</a> ).
<br/>
<br/>
NoMis</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#19008 - torne - Fri Apr 09, 2004 10:18 pm</h4>
    <div class="postbody"><span class="postbody">NoMis: the 500-times-per-frame case is the only time when you really need to avoid virtual dispatch. The rest of the time, the extra memory access is not likely to be significant. Optimising prematurely introduces more bugs and design problems; dont't worry about these things until the code works and has proven to be too slow (profiling is your friend).</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#19146 - SmileyDude - Mon Apr 12, 2004 12:05 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>NoMis wrote:</b></span></td> </tr> <tr> <td class="quote">yeah if you have a 3 ghz machine. But what about the gba, wich is significantly slower than this.</td> </tr></table><span class="postbody">
<br/>
<br/>
heh -- last I checked, the XBox is 700mhz, but that's not the point anyway.
<br/>
<br/>
If you are already using function pointers in a struct, you are most of the way to using polymorphism anyway.  Doesn't make too much sense to trade away readability/maintability too early in the process because you might need that extra couple of cyles.
<br/>
<br/>
The best thing to do in any case, though, is to benchmark your code.  Find out if virtual functions really are slowing your code down.  Maybe you might find that there is another area of your code that you could optimise that will get you much better results.<br/>_________________<br/>dennis</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
