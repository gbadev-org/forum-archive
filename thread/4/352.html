<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Exiting to Pogoshell - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>Coding > Exiting to Pogoshell</h2>
<div id="posts">
<div class="post">
    <h4>#2158 - headspin - Thu Jan 30, 2003 9:20 am</h4>
    <div class="postbody"><span class="postbody">At the moment I've set up a key to do a soft reset bios call, then I can simply apply the exithack and that key will return to Pogoshell instead.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
void softReset()
<br/>
{
<br/>
    asm volatile("swi 0x00000"); // 0x00 Soft Reset 
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
When you apply the exithack the rom won't work in Emulators anymore unless you use the "skip intro" feature.
<br/>
<br/>
Using the exithack works well for all goods and purposes, but I'd like to know a way I can put some actual code in my game to exit to Pogoshell. I've noticed some people have managed to do this without needing to skip intro in an emulator. Any ideas?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#2179 - zeuhl - Thu Jan 30, 2003 3:17 pm</h4>
    <div class="postbody"><span class="postbody">I think I'd understand better if you explained what your exithack exactly consists in. 
<br/>
personnaly, I use code for visoly carts (available in the PogoShell sourcecode), to reset the cart's ROM relocation feature (ie, force the cart to boot the shell, not the program), and finally perform a swi 0. this works perfectly on both emulator (VBA) and real hardware.
<br/>
<br/>
I must admit I haven't tested the "return to PogoShell" feature on the emulator, using a real PogoShell formatted rom filesystem. I've only run my program in the emulator, and the special reset key combination only resets the emulator, that starts the program again.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#2184 - Herg - Thu Jan 30, 2003 6:15 pm</h4>
    <div class="postbody"><span class="postbody">Here's the reset from my games:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
void doReset(void)
<br/>
{
<br/>
#define ROM_START (u16 *)(0x096B592E)
<br/>
#define WRITE_LOC_1 (volatile u16 *)(0x987654*2+0x8000000)
<br/>
#define WRITE_LOC_2 (volatile u16 *)(0x012345*2+0x8000000)
<br/>
#define WRITE_LOC_3 (volatile u16 *)(0x007654*2+0x8000000)
<br/>
#define WRITE_LOC_4 (volatile u16 *)(0x765400*2+0x8000000)
<br/>
#define WRITE_LOC_5 (volatile u16 *)(0x013450*2+0x8000000)
<br/>
  u16 i;
<br/>
<br/>
  // only try to reset like this if we booted from a ROM...
<br/>
  if(__boot_method == 0)
<br/>
  {
<br/>
     for(i=0;i&lt;1;i++) *WRITE_LOC_1=0x5354;
<br/>
     for(i=0;i&lt;500;i++) *WRITE_LOC_2=0x1234;
<br/>
     for(i=0;i&lt;1;i++) *WRITE_LOC_2=0x5354;
<br/>
     for(i=0;i&lt;500;i++) *WRITE_LOC_2=0x5678;
<br/>
     for(i=0;i&lt;1;i++) *WRITE_LOC_1=0x5354;
<br/>
     for(i=0;i&lt;1;i++) *WRITE_LOC_2=0x5354;
<br/>
     for(i=0;i&lt;1;i++) *WRITE_LOC_4=0x5678;
<br/>
     for(i=0;i&lt;1;i++) *WRITE_LOC_5=0x1234;
<br/>
     for(i=0;i&lt;500;i++) *WRITE_LOC_2=0xabcd;
<br/>
     for(i=0;i&lt;1;i++) *WRITE_LOC_1=0x5354;   
<br/>
<br/>
     *ROM_START=0;
<br/>
<br/>
     __asm
<br/>
     {
<br/>
      swi      1
<br/>
      swi      0
<br/>
     }
<br/>
<br/>
  }
<br/>
}
<br/>
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Note: this is written for the ARM compiler rather than GCC.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#2186 - NEiM0D - Thu Jan 30, 2003 6:22 pm</h4>
    <div class="postbody"><span class="postbody">eh, what is that?
<br/>
I'm assuming that's flashcart specific code?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#2208 - tepples - Fri Jan 31, 2003 4:11 am</h4>
    <div class="postbody"><span class="postbody">Yes, it's flash cart specific code, designed to work on any flash cart with the same hardware interface as Visoly flash carts.
<br/>
<br/>
After seeing Herg's reset and comparing it to visoly.s from PogoShell, I went and added reset support to TOD pre-Milestone 3.  Here's the function that works in GCC:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#define ROM_BANKSWITCH (volatile u16 *)(0x096B592E)
<br/>
#define WRITE_LOC_1 (volatile u16 *)(0x987654*2+0x8000000)
<br/>
#define WRITE_LOC_2 (volatile u16 *)(0x012345*2+0x8000000)
<br/>
#define WRITE_LOC_3 (volatile u16 *)(0x007654*2+0x8000000)
<br/>
#define WRITE_LOC_4 (volatile u16 *)(0x765400*2+0x8000000)
<br/>
#define WRITE_LOC_5 (volatile u16 *)(0x013450*2+0x8000000)
<br/>
<br/>
void reset_gba(void)
<br/>
{
<br/>
  unsigned int i;
<br/>
<br/>
  INTENABLE = 0;
<br/>
<br/>
  /* reset cart bankswitching */
<br/>
  for(i=0;i&lt;1;i++) *WRITE_LOC_1=0x5354;
<br/>
  for(i=0;i&lt;500;i++) *WRITE_LOC_2=0x1234;
<br/>
  for(i=0;i&lt;1;i++) *WRITE_LOC_2=0x5354;
<br/>
  for(i=0;i&lt;500;i++) *WRITE_LOC_2=0x5678;
<br/>
  for(i=0;i&lt;1;i++) *WRITE_LOC_1=0x5354;
<br/>
  for(i=0;i&lt;1;i++) *WRITE_LOC_2=0x5354;
<br/>
  for(i=0;i&lt;1;i++) *WRITE_LOC_4=0x5678;
<br/>
  for(i=0;i&lt;1;i++) *WRITE_LOC_5=0x1234;
<br/>
  for(i=0;i&lt;500;i++) *WRITE_LOC_2=0xabcd;
<br/>
  for(i=0;i&lt;1;i++) *WRITE_LOC_1=0x5354;   
<br/>
  *ROM_BANKSWITCH=0;
<br/>
<br/>
  /* reset GBA */
<br/>
  *(u16 *)0x03007ffa = 0;  /* reset to ROM (= 0) rather than RAM (= 1) */
<br/>
  asm volatile(
<br/>
    "mov r0, #0xfc  \n"  /* clear everything other than RAM */
<br/>
    "swi 0x01       \n"
<br/>
    "swi 0x00       \n"
<br/>
    ::: "r0", "r1", "r2", "r3");
<br/>
}
<br/>
</td> </tr></table><span class="postbody"><br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#2222 - zeuhl - Fri Jan 31, 2003 10:34 am</h4>
    <div class="postbody"><span class="postbody">Hi, I have an assembler-version of this resetcode, which was included in PogoShell.
<br/>
<br/>
It works perfectly in IWRAM, as is.
<br/>
<br/>
I have tried to convert it to THUMB code, in order to be able to run it from ROM, in the aim to reduce the IWRAM usage. but it doesn't work anymore ! even the same ARM code doesn't work when run from ROM.
<br/>
<br/>
I guess the "for" loops are here for timing purposes, and as the execution time (from ROM) should not be the same as when run from IWRAM, this may be the reason of my problem.
<br/>
<br/>
Another possible reason (to me) is that it's not possible to change the ROM page relocation configuration, using code that is in ROM itself. But I thought the ROM relocation was only effective after a software reset.
<br/>
<br/>
Has somebody got a good explanation for this problem ?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#2228 - gb_feedback - Fri Jan 31, 2003 12:47 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">I guess the "for" loops are here for timing purposes, and as the execution time (from ROM) should not be the same as when run from IWRAM, this may be the reason of my problem. </td> </tr></table><span class="postbody">
<br/>
<br/>
I would have thought that the writes were a complex validation sequence to prevent accidentally writing to the cart unless this exact sequence is followed. In that case reading FROM the  cart in between would no doubt interrupt the sequence of writes and invalidate it.
<br/>
<br/>
Just my theory...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#2229 - zeuhl - Fri Jan 31, 2003 12:52 pm</h4>
    <div class="postbody"><span class="postbody">I haven't thought about that !
<br/>
<br/>
Obviously, running code from ROM causes ROM reads.
<br/>
<br/>
Anyway, a simple solution to this problem would be to copy the code from ROM to RAM when needed, then execute it.
<br/>
<br/>
Thanks for this explanation !</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#2230 - FluBBa - Fri Jan 31, 2003 1:27 pm</h4>
    <div class="postbody"><span class="postbody">If you try to switch the rom area that your code is running from it wont very good will it? Just like on the NES, most bankswitching code should run from RAM and not the ROM space that your switching in/out.
<br/>
<br/>
/FluBBa</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#2242 - tepples - Fri Jan 31, 2003 3:17 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>FluBBa wrote:</b></span></td> </tr> <tr> <td class="quote">If you try to switch the rom area that your code is running from it wont very good will it?</td> </tr></table><span class="postbody">
<br/>
I write mostly multiboot programs, and those run from EWRAM rather than ROM.  Yes, if you're bankswitching on the GBA, you have to run your bankswitch code from EWRAM or IWRAM.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Just like on the NES, most bankswitching code should run from RAM and not the ROM space that your switching in/out.</td> </tr></table><span class="postbody">
<br/>
Only a few mappers on the NES (such as Rare's AOROM) actually bankswitched the whole cartridge at once.  Most would bankswitch parts of the program area and leave the rest hardwired to the last bank of the cartridge.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#2353 - headspin - Sun Feb 02, 2003 11:28 am</h4>
    <div class="postbody"><span class="postbody">Thanks for the help guys!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#2477 - Malefactor - Tue Feb 04, 2003 4:58 pm</h4>
    <div class="postbody"><span class="postbody">hrm...
<br/>
<br/>
I tried both of those methods in my own program and both work great in visual boy, but both freeze my program on hardware with pogoshell 1.0
<br/>
<br/>
Update:
<br/>
I just tried it with pogoshell 1.2 and same results
<br/>
ExitHack just makes it go back to pogoshell immediatley upon loading.
<br/>
<br/>
Looks like my rom won't be having an 'Exit to boot menu' option...
<br/>
Maybe I should leave it in though and call it 'Freeze'<br/>_________________<br/><a class="postlink" href="http://lorrd.fearware.net" target="_blank"></a><a href="http://mysite.verizon.net/vzep3wth/sitebuildercontent/sitebuilderpictures/lorrdbanner.gif">[Images not permitted - Click here to view it]</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#2486 - Herg - Tue Feb 04, 2003 9:01 pm</h4>
    <div class="postbody"><span class="postbody">As mentioned above, whichever method you use, the code has to run from RAM rather than ROM.  My games are small enough to fit entirely in EWRAM, so I copy the entire ROM there upon startup.  For exithack, it works the same way, except only the exithack code is copied to RAM, and only at the point that the reset code needs to be executed.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#2502 - Malefactor - Wed Feb 05, 2003 1:44 am</h4>
    <div class="postbody"><span class="postbody">I thought that that was what the problem was, but I was really hoping it wasn't...
<br/>
<br/>
Putting code in RAM is over my head because I don't understand crt0.s, linkerscipts or makefiles.
<br/>
<br/>
...I have one of those .s files, but I don't even know what its for, and I don't use a linkerscript or a makefile because I've never had the need of learning this stuff before...
<br/>
<br/>
Could you suggest some learning recourses?<br/>_________________<br/><a class="postlink" href="http://lorrd.fearware.net" target="_blank"></a><a href="http://mysite.verizon.net/vzep3wth/sitebuildercontent/sitebuilderpictures/lorrdbanner.gif">[Images not permitted - Click here to view it]</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#4131 - wtuck - Thu Mar 20, 2003 3:28 am</h4>
    <div class="postbody"><span class="postbody">I was looking over the email trail and I thought I would try to copy the softReset from my ROM over to EWRAM I tried the following, but got compiler errors. Any one have a better Idea or code snipet? 
<br/>
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">  
<br/>
{
<br/>
  unsigned int* EWRAM = (unsigned int*)0x02000000;
<br/>
  typedef void (*entrypoint_t(void));
<br/>
  entrypoint_t entrypoint;
<br/>
<br/>
  memcpy(EWRAM, &amp;SoftReset, 100); // don't know how big it really is
<br/>
  entrypoint =  (entrypoint_t) (0x2000000); //** THIS IS THE ERROR **
<br/>
  entrypoint();
<br/>
}
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#4138 - tepples - Thu Mar 20, 2003 5:03 pm</h4>
    <div class="postbody"><span class="postbody">The following workaround will work for this specific case but won't work for cases where you have to go to EWRAM and return to ROM.
<br/>
<br/>
1. Make a multiboot program that just runs the exit code. (To make a multiboot program, make a global variable <span style="font-weight: bold">int __gba_multiboot;</span>)
<br/>
2. Copy it to EWRAM and run it (see my <a class="postlink" href="http://www.pineight.com/gba/#mbmenu" target="_blank">Multiboot Menu</a> code for details).<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#5440 - Quirky - Sun Apr 27, 2003 9:08 pm</h4>
    <div class="postbody"><span class="postbody">Sorry for resurrecting this old thread, but I've just incorporated tepples code into my project and thought this might be handy as it hasn't been mentioned yet. I used the old trick of:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
// this goes in the header file
<br/>
#define CODE_IN_EWRAM __attribute__ ((section (".ewram"), long_call))
<br/>
#define RESET_GBA __FarProcedure(reset_gba)
<br/>
<br/>
void reset_gba(void) CODE_IN_EWRAM;
<br/>
<br/>
<br/>
<br/>
// this goes in the .c file
<br/>
CODE_IN_EWRAM void reset_gba(void)
<br/>
{
<br/>
  /* rest of the code tepples gave..... */
<br/>
}
<br/>
<br/>
// then in my game, when "Quit to PogoShell" is chosen...
<br/>
void foo(void) {
<br/>
  REG_IME = 0x00; // disable interrupts
<br/>
  RESET_GBA;
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Hope that helps someone! PogoShell is great, isn't it?[/code]</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
