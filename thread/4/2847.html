<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>debug <-> release - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>Coding > debug <-> release</h2>
<div id="posts">
<div class="post">
    <h4>#16258 - rapso - Wed Feb 11, 2004 8:47 am</h4>
    <div class="postbody"><span class="postbody">I've some strange problems with the release-mode *.gba.
<br/>
I'm using (visual)HAM and with the debugmode all code seems to work just fine, but on release mode it works for some frames and freez.
<br/>
<br/>
I've read on this forum that the EWRAM is untouched, but when I call some functions, I've seen on the VisualBoyA and BoyCottA that some byte at the beginning of the EWRAM are changed.
<br/>
<br/>
the really strange thing is, all I have to do is to call a function looking like this
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
void foo(u8* pDst,const u8* pStr1,const u8* pStr2)
<br/>
{
<br/>
return;
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
to get the freez.
<br/>
<br/>
the main function:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
u8 Test[32];
<br/>
void main()
<br/>
{
<br/>
.
<br/>
.
<br/>
.
<br/>
<br/>
while(1)
<br/>
{
<br/>
//working version
<br/>
foo(NULL,NULL,"foo");
<br/>
//not working version
<br/>
// foo(Test,Test,"foo");
<br/>
<br/>
Render();
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
<br/>
I can get it work if I use the outcommandet function just by disabling the "Render();" call, but it does not work together.
<br/>
<br/>
at first I deleted the CODE_IN_IWRAM on all functions, 'cause I thought it might be a stackoverflow, but it still does not work.
<br/>
<br/>
<br/>
so, please tell me the difference between the debug and the release mode, is it just the -o3 switch?
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
an other small question,
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
u32 xm,x1,x2;
<br/>
.
<br/>
.
<br/>
.
<br/>
xm = (x1+x2)&gt;&gt;1;
<br/>
.
<br/>
.
<br/>
.
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
is compiled to something like that
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
add r1,r2,r3
<br/>
mov r0, r1 asr #1
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
is there a reason not to write "add r0,r2,r3 asr #1" ?
<br/>
<br/>
greets
<br/>
rapso</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#16260 - FluBBa - Wed Feb 11, 2004 11:24 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>rapso wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
u32 xm,x1,x2;
<br/>
.
<br/>
xm = (x1+x2)&gt;&gt;1;
<br/>
.
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
is compiled to something like that
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
add r1,r2,r3
<br/>
mov r0, r1 asr #1
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
is there a reason not to write "add r0,r2,r3 asr #1" ?</span></td> </tr></table><span class="postbody">
<br/>
<br/>
Yes that would mean something like
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
xm =x1+(x2&gt;&gt;1);
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
But its still strange that it uses ASR instead of LSR as it an u32 and not s32.<br/>_________________<br/>I probably suck, my not is a programmer.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#16261 - rapso - Wed Feb 11, 2004 11:35 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>FluBBa wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>rapso wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
u32 xm,x1,x2;
<br/>
.
<br/>
xm = (x1+x2)&gt;&gt;1;
<br/>
.
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
is compiled to something like that
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
add r1,r2,r3
<br/>
mov r0, r1 asr #1
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
is there a reason not to write "add r0,r2,r3 asr #1" ?</span></td> </tr></table><span class="postbody">
<br/>
<br/>
Yes that would mean something like
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
xm =x1+(x2&gt;&gt;1);
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
But its still strange that it uses ASR instead of LSR as it an u32 and not s32.</span></td> </tr></table><span class="postbody">
<br/>
<br/>
sorry, yes it's s32....
<br/>
<br/>
rapso</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#16264 - batblaster - Wed Feb 11, 2004 12:44 pm</h4>
    <div class="postbody"><span class="postbody">try to ask in the HAM Forum on <a href="http://www.ngine.de" target="_blank">www.ngine.de</a> i think you can found all the solutions you need...<br/>_________________<br/>Batblaster / 7 Raven Studios Co. Ltd
<br/>
------------------------------------------</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#16270 - torne - Wed Feb 11, 2004 1:20 pm</h4>
    <div class="postbody"><span class="postbody">Try using different compiler optimisation flags until you find exactly which is the culprit; then maybe you can narrow it down.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#16380 - rapso - Sat Feb 14, 2004 2:20 am</h4>
    <div class="postbody"><span class="postbody">ok,
<br/>
while i was trying to make a minimum version for download, I trow a lot of functions and variables out of the code, then I found one global
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
register u16   *g_P asm("r9");
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
and this was the bug. I though that the compiler would 'save' the register across all sources, but it does it just for the one I defined it, and that's why it was overwritten in the release version ('cause of parameter passing over the register, not the stack) and did work with the debug version.
<br/>
<br/>
I hope my bug can help someone else to avoid it.
<br/>
<br/>
thanks for the help torne,batblaster &amp;&amp; FluBBa
<br/>
<br/>
greets
<br/>
rapso</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#16382 - torne - Sat Feb 14, 2004 2:49 am</h4>
    <div class="postbody"><span class="postbody">You should rarely if ever force things into registers; the compiler usually knows much better than you (and definately does if you use profiling and feedback). If the compiler's not being smart enough about register allocation, btw, try using -fnew-ra to turn on the graph colouring register allocator on recent GCC versions (but beware that it's not fully tested and *might* make broken code).</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#16390 - Paul Shirley - Sat Feb 14, 2004 3:13 pm</h4>
    <div class="postbody"><span class="postbody">removed</span><span class="gensmall"><br/><br/>Last edited by Paul Shirley on Sun Mar 28, 2004 9:13 pm; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#16400 - poslundc - Sat Feb 14, 2004 10:28 pm</h4>
    <div class="postbody"><span class="postbody">By the time you get to that level of optimization, you might want to start thinking about recoding your routine in assembly...
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#16401 - torne - Sat Feb 14, 2004 10:39 pm</h4>
    <div class="postbody"><span class="postbody">Not neccecarily, poslundc; you can get some good performance boosts by doing careful register allocation for select globals as Paul says; but, well, it's one of those things where if you don't already know how to do it, you shouldn't be doing it. =)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#16435 - rapso - Mon Feb 16, 2004 12:51 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>torne wrote:</b></span></td> </tr> <tr> <td class="quote">Not neccecarily, poslundc; you can get some good performance boosts by doing careful register allocation for select globals as Paul says; but, well, it's one of those things where if you don't already know how to do it, you shouldn't be doing it. =)</td> </tr></table><span class="postbody">
<br/>
yes, but someday everybody has to start doing this things, you know, this crazy things, you're on unknown terrain and just the stupid try&amp;error game gives you that kick you need 'cause you've tried everything else :o)...
<br/>
<br/>
I'm not that familar with the gcc, I never used the manual register allocation, but my pointer to the actuall screen is used very often, I got the last bit of performance out of the code (I took a look at the assembler, not more to do than just inline the code to save the call and the return). so I tried to optimise it with some compiler "specials"
<br/>
<br/>
<br/>
maybe someone knows some max polygone throughput values of other 3d engines for the gba? (just to be able to compare)
<br/>
<br/>
greets
<br/>
rapso</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#16444 - torne - Mon Feb 16, 2004 6:23 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>rapso wrote:</b></span></td> </tr> <tr> <td class="quote">yes, but someday everybody has to start doing this things, you know, this crazy things, you're on unknown terrain and just the stupid try&amp;error game gives you that kick you need 'cause you've tried everything else :o)...</td> </tr></table><span class="postbody">
<br/>
<br/>
I know; it was sort of a joke. =) Paul's post told you what changes you need to make to get it to work.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
