<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Converting Goomba Color to compile on GCC - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>Coding > Converting Goomba Color to compile on GCC</h2>
<div id="posts">
<div class="post">
    <h4>#124616 - Dwedit - Sat Apr 07, 2007 8:23 am</h4>
    <div class="postbody"><span class="postbody">Right now I'm in the process of converting Goomba Color to compile on GCC.  I've killed off all the register-relative labels, converted almost all of the ASM syntax, but there's still a long way to go.  Gnu Assembler is <span style="font-weight: bold">crashing</span> on me whenever I use a macro, and the code uses macros very heavily.  I'm also getting some lovely errors like "Error: symbol definition loop encountered at `_address'"
<br/>
<br/>
I'm posting code and asking someone else to help me fix the build errors.
<br/>
<br/>
EDIT: Now links to thread: <a href="http://www.dwedit.org/dwedit_board/viewtopic.php?pid=1846#p1846" target="_blank">http://www.dwedit.org/dwedit_board/viewtopic.php?pid=1846#p1846</a><br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"><br/><br/>Last edited by Dwedit on Sun Apr 08, 2007 7:04 am; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#124618 - keldon - Sat Apr 07, 2007 9:04 am</h4>
    <div class="postbody"><span class="postbody">No end of line in mbclient.c, gbamp_cf.h, gba_nds_fat.c, cache.h, asmcalls.h, ui.h and sram.h (although it has comment).</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#124619 - Dwedit - Sat Apr 07, 2007 9:10 am</h4>
    <div class="postbody"><span class="postbody">Right now I'm not concerned with any of the C files, just the asm files.<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#124652 - gmiller - Sat Apr 07, 2007 4:46 pm</h4>
    <div class="postbody"><span class="postbody">The _address issue is related to "equates.h" where the symbol is used and redefined but no initial definition.  These may be memory offset definitions but I am not sure yet.  I am looking at boot.s as a start.  The GAS manual at <a href="http://sourceware.org/binutils/docs-2.17/as/index.html" target="_blank">http://sourceware.org/binutils/docs-2.17/as/index.html</a> has always been less that helpful in general.  Was this code originally from the "golden rod" ARM assembler?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#124660 - tepples - Sat Apr 07, 2007 5:18 pm</h4>
    <div class="postbody"><span class="postbody">"Golden rod"? Have you been playing Animal Crossing?
<br/>
<br/>
The code wasn't written for Goldroad. It was written for ARM SDT.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#124681 - Dwedit - Sat Apr 07, 2007 7:01 pm</h4>
    <div class="postbody"><span class="postbody">Thanks for catching that I forgot to give an initial value to _address.  My previous code used a GBLA (global arithmetic) declaration, which is not needed by as, but I never assigned the initial value anyway.
<br/>
I think that solved the crash problems too.<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#124686 - gmiller - Sat Apr 07, 2007 7:32 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tepples wrote:</b></span></td> </tr> <tr> <td class="quote">"Golden rod"? Have you been playing Animal Crossing?
<br/>
<br/>
The code wasn't written for Goldroad. It was written for ARM SDT.</td> </tr></table><span class="postbody">
<br/>
<br/>
I forgot it was "Goldroad" , Oh well ... some brain cells do fail some times.  Never played animal crossing ...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#124757 - Dwedit - Sun Apr 08, 2007 6:24 am</h4>
    <div class="postbody"><span class="postbody">Status update: I've solved all assembler errors with the ASM code.  In order to resolve deficiencies in Gnu assembler (ADR instruction can't cross files), I had to make one ASM file .includes all the other source code.
<br/>
<br/>
Still need to figure out the black magic that is makefiles and getting the damn thing to link.
<br/>
<br/>
Still need help: I need to modify the CRT files and possibly the linkscript for these features:
<br/>
* In multiboot mode (booted from cartridge) or cartridge mode, get the address of the last byte in the binary (in rom), and store it to a variable.  Also get the address of the last byte of EWRAM.
<br/>
* In multiboot mode, remove the sections that do not stay in EWRAM.  Also make sure there are no holes (all non-ewram content strictly comes after ewram content in the binary)
<br/>
* In multiboot mode, move the appended content (initially stored after the end of the MB binary) over to what becomes the last byte of EWRAM.  This removes the IWRAM content from EWRAM.  Also store a pointer to the location the appended data was copied to.
<br/>
<br/>
Latest work posted at <a href="http://www.dwedit.org/dwedit_board/viewtopic.php?pid=1846#p1846" target="_blank">http://www.dwedit.org/dwedit_board/viewtopic.php?pid=1846#p1846</a> if anyone cares.<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#124877 - gmiller - Mon Apr 09, 2007 2:06 pm</h4>
    <div class="postbody"><span class="postbody">All of your inline assembly is not in GNU form so that will need to change.  The symbols with $$ in them will need to change (or course these are ones you need changes for)  and a pretty standard Makefile will work with some minor folder layout changes and a few changes to the .s assembly include directives.  I have it linking with errors at this point using my standard Makefile layout (based on the standard ones wintermute included in devkitPro) I could give the current way I have it layed out if you want.  Of course I commented out the inline assembly rather than convert it to save me time.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#128331 - tepples - Thu May 10, 2007 6:42 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Dwedit wrote:</b></span></td> </tr> <tr> <td class="quote">Still need to figure out the black magic that is makefiles</td> </tr></table><span class="postbody">
<br/>
Makefiles in general are not black magic. Wintermute's makefile is black magic intended to make use by beginners easier, but for complex projects, sometimes I find it it easier to scrap the makefile and start from scratch than to work around its limitations (For example, one of my projects uses an archive that depends on multiple LZ-compressed files, which in turn depends on a converted sprite sheet, which in turn depends on the original sprite sheet in .bmp format).
<br/>
<br/>
Fortunately, simple makefiles are still simple. They specify what file depends on what file, followed by what command to run to generate the file.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">stuff.o: stuff.c
<br/>
(tab)arm-eabi-gcc -O -mthumb -mthumb-interwork stuff.c -o stuff.o</td> </tr></table><span class="postbody">
<br/>
Here, (tab) represents an actual tab character, not four or eight spaces.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">and getting the damn thing to link.</td> </tr></table><span class="postbody">
<br/>
My technique is to start with hello world and make sure everything works after each stage.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">* In multiboot mode (booted from cartridge) or cartridge mode, get the address of the last byte in the binary (in rom), and store it to a variable.  Also get the address of the last byte of EWRAM.</td> </tr></table><span class="postbody">
<br/>
I made GBFS before I learned of this technique:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">extern const u8 _end[];
<br/>
<br/>
size_t binarySize = &amp;_end - (const u8 *)0x02000000;</td> </tr></table><span class="postbody">
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">* In multiboot mode, remove the sections that do not stay in EWRAM.  Also make sure there are no holes (all non-ewram content strictly comes after ewram content in the binary)</td> </tr></table><span class="postbody">
<br/>
The map file generated from TOD shows that in the default crt0/linkscript, everything starting after __iwram_lma gets copied to IWRAM.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">extern const u8 __iwram_lma[];</td> </tr></table><span class="postbody">
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">* In multiboot mode, move the appended content (initially stored after the end of the MB binary) over to what becomes the last byte of EWRAM.  This removes the IWRAM content from EWRAM.  Also store a pointer to the location the appended data was copied to.</td> </tr></table><span class="postbody">
<br/>
Make a version without this feature, and set a debugger to trap on accesses between __iwram_lma and _end to make sure that you aren't overwriting anything.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
