<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Help with timers - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>Coding > Help with timers</h2>
<div id="posts">
<div class="post">
    <h4>#1368 - Epo - Fri Jan 17, 2003 6:02 am</h4>
    <div class="postbody"><span class="postbody">Hi,
<br/>
<br/>
Does anyone have some kinf of routine that pauses for so long using timers; a Wait() function, where you pass the number of miliseconds.
<br/>
<br/>
I keep trying to use REG_TM3D and REG_TM3CNT.. but i am getting no results  =(
<br/>
<br/>
Thanks,
<br/>
 - Epo</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#1369 - mo - Fri Jan 17, 2003 6:26 am</h4>
    <div class="postbody"><span class="postbody"><a href="http://216.167.73.47/~dovoto/English/tutorial_5.html#timers" target="_blank">http://216.167.73.47/~dovoto/English/tutorial_5.html#timers</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#1394 - Gordon - Sat Jan 18, 2003 4:27 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Epo wrote:</b></span></td> </tr> <tr> <td class="quote">Hi,
<br/>
<br/>
Does anyone have some kinf of routine that pauses for so long using timers; a Wait() function, where you pass the number of miliseconds.
<br/>
<br/>
I keep trying to use REG_TM3D and REG_TM3CNT.. but i am getting no results  =(
<br/>
<br/>
Thanks,
<br/>
 - Epo</td> </tr></table><span class="postbody">
<br/>
only thing you need is the gba.h file
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">/////////////////Bits////////////////
<br/>
#define BIT00 1
<br/>
#define BIT01 2
<br/>
#define BIT02 4
<br/>
#define BIT03 8
<br/>
#define BIT04 16
<br/>
#define BIT05 32
<br/>
#define BIT06 64
<br/>
#define BIT07 128
<br/>
#define BIT08 256
<br/>
#define BIT09 512
<br/>
#define BIT10 1024
<br/>
#define BIT11 2048
<br/>
#define BIT12 4096
<br/>
#define BIT13 8192
<br/>
#define BIT14 16384
<br/>
#define BIT15 32768
<br/>
<br/>
///////////////////Definitions////////////////////
<br/>
#define REG_TM0D       *(volatile u16*)0x4000100      //Timer 1 Data
<br/>
#define REG_TM0CNT     *(volatile u16*)0x4000102      //Timer 1 Control
<br/>
#define REG_TM1D       *(volatile u16*)0x4000104      //Timer 2 Data
<br/>
#define REG_TM1CNT     *(volatile u16*)0x4000106      //Timer 2 Control
<br/>
#define REG_TM2D       *(volatile u16*)0x4000108      //Timer 3 Data
<br/>
#define REG_TM2CNT     *(volatile u16*)0x400010A      //Timer 3 Control
<br/>
#define REG_TM3D       *(volatile u16*)0x400010C      //Timer 4 Data
<br/>
#define REG_TM3CNT     *(volatile u16*)0x400010E      //Timer 4 Control
<br/>
#define FREQUENCY_0      0x00
<br/>
#define FREQUENCY_64   BIT00
<br/>
#define FREQUENCY_256   BIT01
<br/>
#define FREQUENCY_1024   BIT00 | BIT01
<br/>
<br/>
#define TIMER_CASCADE   BIT02
<br/>
#define TIMER_IRQ      BIT06
<br/>
#define TIMER_ENABLE   BIT07
<br/>
<br/>
/********************************************  How to use 
<br/>
   
<br/>
  1) when to enable it
<br/>
     call S_FeTimerEnable()
<br/>
  2) timer = S_FeTimerNew(); 
<br/>
  3) set time stemp
<br/>
     call S_FeTimerSetTimeStemp(..)
<br/>
  4) check to see is over or not
<br/>
     call FeTimerIsOver(a_timerPtr);
<br/>
  
<br/>
 ***********************************************************/
<br/>
 
<br/>
typedef struct _FeTimer
<br/>
{
<br/>
 //Time variables
<br/>
 u32 m_secondStemp;
<br/>
 u32 m_milliSecondStemp;
<br/>
 u32 m_seconds;
<br/>
 u32 m_milliSeconds;
<br/>
 u16 m_formId;            
<br/>
 bool m_switch;   // true : enable, false: disable
<br/>
 u16 m_status;    // conditional flag using depends on the user
<br/>
 // 
<br/>
} FeTimer, *FeTimerPtr;
<br/>
<br/>
/**
<br/>
 * Create a new timer
<br/>
 */
<br/>
FeTimerPtr S_FeTimerNew();
<br/>
<br/>
/**
<br/>
 * Enable the clock for all timers
<br/>
 */
<br/>
void S_FeTimerEnable();
<br/>
<br/>
/**
<br/>
 * disable the clock for all timers
<br/>
 */
<br/>
void S_FeTimerDisable();
<br/>
<br/>
/**
<br/>
 * Set the time stemp 
<br/>
 * @param a_timerPtr pointer to the timer
<br/>
 * @param a_second number of seconds
<br/>
 * @param a_milliSeconds number of milliSeconds
<br/>
 */
<br/>
void FeTimerSetTimeStemp(FeTimerPtr a_timerPtr, int a_second, int a_milliSeconds);
<br/>
<br/>
/**
<br/>
 * Check to see the timer is over or not
<br/>
 * @param a_timerPtr pointer to the timer
<br/>
 * @return true: is over, otherwise is false
<br/>
 */
<br/>
bool FeTimerIsOver(FeTimerPtr a_timerPtr);
<br/>
</td> </tr></table><span class="postbody">
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
FeTimerPtr S_FeTimerNew()
<br/>
{
<br/>
   FeTimerPtr timerPtr;
<br/>
   
<br/>
   timerPtr = (FeTimerPtr) malloc( sizeof(FeTimer) );
<br/>
   FE_ASSERT( timerPtr != NULL, "NULL");
<br/>
   timerPtr-&gt;m_secondStemp = 0;
<br/>
   timerPtr-&gt;m_milliSecondStemp = 0;
<br/>
   timerPtr-&gt;m_seconds = 0;
<br/>
   timerPtr-&gt;m_milliSeconds = 0;
<br/>
   timerPtr-&gt;m_eventPtr = NULL;
<br/>
   timerPtr-&gt;m_formId = 0xffff;
<br/>
   timerPtr-&gt;m_switch = false;
<br/>
   
<br/>
   return timerPtr;
<br/>
}
<br/>
<br/>
void S_FeTimerEnable()
<br/>
{
<br/>
   //Enable timers
<br/>
   REG_TM3D   = 0; // reset time to 0
<br/>
   REG_TM2D   = 0; // reset time to 0
<br/>
   REG_TM2CNT = FREQUENCY_256 | TIMER_ENABLE;
<br/>
   REG_TM3CNT = TIMER_CASCADE | TIMER_ENABLE;
<br/>
}
<br/>
<br/>
void S_FeTimerDisable()
<br/>
{
<br/>
     REG_TM2CNT = 0;
<br/>
   REG_TM3CNT = 0;
<br/>
   REG_TM3D   = 0; // reset time to 0
<br/>
   REG_TM2D   = 0; // reset time to 0
<br/>
}
<br/>
<br/>
void FeTimerSetTimeStemp(FeTimerPtr a_timerPtr, int a_seconds, int a_milliSeconds)
<br/>
{
<br/>
     a_timerPtr-&gt;m_secondStemp      = REG_TM3D;
<br/>
     a_timerPtr-&gt;m_milliSecondStemp = REG_TM2D / (65536/1000);
<br/>
     a_timerPtr-&gt;m_switch = true;
<br/>
     a_timerPtr-&gt;m_seconds = a_seconds;
<br/>
     a_timerPtr-&gt;m_milliSeconds = a_milliSeconds;
<br/>
}
<br/>
<br/>
bool FeTimerIsOver(FeTimerPtr a_timerPtr)
<br/>
{
<br/>
    u32 seconds;
<br/>
    u32 milliSeconds;
<br/>
    u32 reg_seconds;
<br/>
    u32 reg_milliSeconds;
<br/>
    
<br/>
    if ( a_timerPtr-&gt;m_switch == true)
<br/>
    {
<br/>
       seconds       = a_timerPtr-&gt;m_seconds;
<br/>
       // Total milliseconds
<br/>
       milliSeconds  = a_timerPtr-&gt;m_milliSeconds + seconds*1000;
<br/>
       // diff in second
<br/>
      reg_seconds      = REG_TM3D - a_timerPtr-&gt;m_secondStemp;
<br/>
      reg_milliSeconds = REG_TM2D / (65536/1000);
<br/>
      reg_milliSeconds += reg_seconds*1000;
<br/>
      // diff in millisecond
<br/>
      reg_milliSeconds -= a_timerPtr-&gt;m_milliSecondStemp;
<br/>
    
<br/>
      if ( milliSeconds &lt;= reg_milliSeconds )
<br/>
      {  
<br/>
         a_timerPtr-&gt;m_seconds = 0;
<br/>
         a_timerPtr-&gt;m_milliSeconds = 0;
<br/>
         a_timerPtr-&gt;m_switch = false;
<br/>
         return true;
<br/>
      }
<br/>
    }
<br/>
    
<br/>
    return false;
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
bye now!
<br/>
Gordon wong</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
