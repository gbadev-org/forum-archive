<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>dead code elimination? - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>Coding > dead code elimination?</h2>
<div id="posts">
<div class="post">
    <h4>#144655 - bpoint - Mon Nov 05, 2007 12:34 pm</h4>
    <div class="postbody"><span class="postbody">Hello all,
<br/>
<br/>
I've been working on a rather large project under Win32, and have finally ported the code over to GBA.  However, I am having a bit of a problem getting my application to link properly.  ld is giving me these errors (the log is not exact -- I have trimmed some things to make it more readable):
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">1&gt;------ Build started: Project: sandbox, Configuration: Debug GBA ------
<br/>
1&gt;Performing Makefile project actions
<br/>
1&gt;arm-eabi-g++ -mthumb -mthumb-interwork -Wl,-Map,sandbox.elf.map -dead_strip -specs=gba_mb.specs    sandbox.o  -L../../lib/gba -lDebug-lib1 -lDebug-lib2 -lDebug-lib3 -lDebug-lib4  -o sandbox.elf
<br/>
1&gt;arm-eabi/bin/ld.exe: address 0x20ab760 of sandbox.elf section .text is not within region ewram
<br/>
1&gt;arm-eabi/bin/ld.exe: section .init [02000000 -&gt; 02000217] overlaps section .fini [02000000 -&gt; 0200000b]
<br/>
1&gt;arm-eabi/bin/ld.exe: section .rodata [02000010 -&gt; 0200ddf3] overlaps section .init [02000000 -&gt; 02000217]
<br/>
1&gt;arm-eabi/bin/ld.exe: section .text [02000218 -&gt; 020ab75f] overlaps section .rodata [02000010 -&gt; 0200ddf3]
<br/>
1&gt;arm-eabi/bin/ld.exe: section .ARM.extab [0200ddf4 -&gt; 02017c77] overlaps section .text [02000218 -&gt; 020ab75f]
<br/>
1&gt;arm-eabi/bin/ld.exe: sandbox.elf: section .init lma 0x2000000 overlaps previous sections
<br/>
1&gt;arm-eabi/bin/ld.exe: sandbox.elf: section .rodata lma 0x2000010 overlaps previous sections
<br/>
1&gt;arm-eabi/bin/ld.exe: sandbox.elf: section .text lma 0x2000218 overlaps previous sections
<br/>
1&gt;arm-eabi/bin/ld.exe: sandbox.elf: section .ARM.extab lma 0x200ddf4 overlaps previous sections
<br/>
1&gt;arm-eabi/bin/ld.exe: sandbox.elf: section .ARM.exidx lma 0x2017c78 overlaps previous sections
<br/>
1&gt;arm-eabi/bin/ld.exe: sandbox.elf: section .init_array lma 0x201dfe0 overlaps previous sections
<br/>
1&gt;arm-eabi/bin/ld.exe: sandbox.elf: section .fini_array lma 0x201e01c overlaps previous sections
<br/>
1&gt;arm-eabi/bin/ld.exe: sandbox.elf: section .jcr lma 0x201e020 overlaps previous sections
<br/>
1&gt;arm-eabi/bin/ld.exe: sandbox.elf: section .eh_frame lma 0x201e024 overlaps previous sections</td> </tr></table><span class="postbody">
<br/>
<br/>
It's obvious from the messages that the compiled code size in the .text section is larger than the ewram size (256k) of the GBA.  However, this is my main() function:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">int main(int argc, char *argv[], char *envp[])
<br/>
{
<br/>
   return 0;
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
Indeed, after looking at the .map file produced by the linker, every single function and class in every library being linked in is trying to be put inside the output .elf file.  I realize I can get around the linker errors by using the gba.specs file instead of the multiboot one, but this is not a solution.  I do not want any unused functions to be placed in the output .elf file.  Does devkitARM not support the "-dead_strip" parameter, or am I doing something wrong here?
<br/>
<br/>
Any ideas would be greatly appreciated.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#144660 - wintermute - Mon Nov 05, 2007 1:32 pm</h4>
    <div class="postbody"><span class="postbody">You're doing something very, very wrong somewhere. 
<br/>
<br/>
-dead-strip is an Apple extenson as far as I'm aware - I can't find it in the FSF documentation anyway.
<br/>
<br/>
<a href="http://sourceware.org/binutils/docs-2.18/ld/Options.html#Options" target="_blank">http://sourceware.org/binutils/docs-2.18/ld/Options.html#Options</a>
<br/>
<br/>
If you don't want "unused" functions in your output file the best way is to not reference them or put them in files containing functions that *are* used.
<br/>
<br/>
gcc does provide a means to attempt to eliminate dead code but I'm not particularly sure how well it works. Add -ffunction-sections -fdata-sections to CFLAGS and --gc-sections to LDFLAGS. I'm not sure how well these work, I've never used them.<br/>_________________<br/><a class="postlink" href="http://www.devkitpro.org/" target="_blank">devkitPro - professional toolchains at amateur prices</a>
<br/>
<a class="postlink" href="http://wiki.devkitpro.org/index.php/IRC" target="_blank">devkitPro IRC support</a>
<br/>
<a class="postlink" href="http://davejmurphy.com/" target="_blank">Personal Blog</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#144665 - tepples - Mon Nov 05, 2007 1:58 pm</h4>
    <div class="postbody"><span class="postbody">Wintermute is right. In my mini-rant "<a class="postlink" href="http://www.pineight.com/rant/#cbloatbloat" target="_blank">The plus stands for bloat</a>" about my experience with space inefficiency of static GNU libstdc++, I tell how <span style="font-weight: bold">-Wl,-gc-sections</span> helped a little bit for me.
<br/>
<br/>
But you might run into classes where one member from one part of the standard library brings in another big chunk of the standard library. In cases like std::ostream of &lt;iostream&gt; bringing in some date, time, and money formatting objects from the locale library, it might take some surgery on the libraries themselves to slim them down. As I understand it, the linker can sometimes eliminate uncalled functions but not unused data members.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#144668 - bpoint - Mon Nov 05, 2007 3:54 pm</h4>
    <div class="postbody"><span class="postbody">Sorry, I probably should have made it clear that all of the code that I'm linking in through libraries is all engine code that our team has written.  We don't use RTTI or exceptions, and we don't use anything in the C++ standard library.  We can even practically avoid linking to libc entirely (although there are a few functions left we still need to bind to).
<br/>
<br/>
I did some more searching on Google about "-dead_strip" -- apparently it is a Darwin-only option.  My apologies.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>wintermute wrote:</b></span></td> </tr> <tr> <td class="quote">If you don't want "unused" functions in your output file the best way is to not reference them or put them in files containing functions that *are* used.</td> </tr></table><span class="postbody">
<br/>
<br/>
I'm not exactly sure what you mean by not referencing them.  If I have an empty main(), how am I referencing any functions at all?
<br/>
<br/>
I will give the -Wl,-gc-sections option a try though.  Thank you!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#144683 - bpoint - Mon Nov 05, 2007 7:05 pm</h4>
    <div class="postbody"><span class="postbody">Adding <span style="font-weight: bold">-ffunction-sections -fdata-sections</span> to CFLAGS, and <span style="font-weight: bold">-Wl,--gc-sections</span> to LDFLAGS seemed to do the trick, for the most part.  The compiled size now fits well within ewram, although I'm still seeing certain classes and their functions being put into the .text section even with my empty main().
<br/>
<br/>
After browsing the .map file in more detail, it's possible these remaining classes are statically allocated local to a given source file, and referenced through functions in that source file.  Microsoft's compiler is smart enough to recognize that if those unused functions are not called, then the data (and code) being referenced by them is not necessary either.  I guess gcc hasn't made it that far yet, but I will admit this is something that could be done better on our end anyway.
<br/>
<br/>
I am now trying to deal with a last few "undefined reference" errors.  In order to avoid going off-topic, I'll make a new post.
<br/>
<br/>
Thanks again for the help!</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
