<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Tile-mode Graphics Corruption Problem - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>Coding > Tile-mode Graphics Corruption Problem</h2>
<div id="posts">
<div class="post">
    <h4>#177962 - aidan_aidan - Wed Jun 12, 2013 2:55 pm</h4>
    <div class="postbody"><span class="postbody"><a href="http://i.imgur.com/c9suZzC.png">[Images not permitted - Click here to view it]</a>
<br/>
<br/>
The corruption as you can see is in the lower area of the screen, starting at tile number 512 (block 1). The corruption extends all the way back to the tiles library itself in the Character block, I now this from viewing it in Visual boy. I have spent many hours to no avail trying to figure out the problem and am tired of trying. So I have turned to the forums. I will now post the relevant code.
<br/>
<br/>
C FILE WITH MAIN FUNCTION
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#include &lt;..\include\toolbox.h&gt;
<br/>
#include &lt;..\include\palettes.h&gt;
<br/>
#include &lt;..\include\tileset.h&gt;
<br/>
#include &lt;..\include\sprites.h&gt;
<br/>
#include &lt;..\include\samples.h&gt;
<br/>
#include &lt;..\include\text.h&gt;
<br/>
#include &lt;..\include\bitmaps.h&gt;
<br/>
<br/>
u32 starXoff = 0, starYoff = 0, shipX = 10, shipY = 72;
<br/>
<br/>
void tm1Interrupt(void);
<br/>
void interruptHandler(void);
<br/>
void meleeMode(void);
<br/>
void introScreen(void);
<br/>
void playSound(u32 frequency, const u32* soundLoc, u32 length);
<br/>
void displayText(u32 length, const char string[], u32 colorIndex);
<br/>
<br/>
int main(void){
<br/>
   introScreen();
<br/>
   
<br/>
   while(1){}
<br/>
   
<br/>
   return(0);
<br/>
}
<br/>
<br/>
/*
<br/>
void initRegisters(){
<br/>
   REG_ISR_MAIN = interruptHandler;
<br/>
   SOUNDCNT_H = (SOUND_HVOLUME100 | SOUND_HAVOLUME100 | SOUND_HBVOLUME0 | SOUND_HAENABLERIGHT | SOUND_HAENABLELEFT | SOUND_HATIMER0 | SOUND_HBDISABLERIGHT | SOUND_HBDISABLELEFT | SOUND_HBTIMER0);
<br/>
   SOUNDCNT_X = (SOUND_XFIFOME);
<br/>
   INTERRUPTME = (IME_ENABLE);
<br/>
   INTERRUPTE = (INTERRUPT_TM1);
<br/>
}
<br/>
*/
<br/>
<br/>
void introScreen(){
<br/>
   u32 x, y;
<br/>
   u16 vBlankBool_A = 0, vBlankBool_B = 0;
<br/>
   
<br/>
   DISPCNT = (MODE0 | BG0_ENABLE | BG1_ENABLE);
<br/>
   BG0CNT  = (CBB0 | BGCOLOR256 | SBB16 | BG_REG_32x32);
<br/>
   BG1CNT  = (CBB3 | BGCOLOR16 | SBB1 | BG_REG_32x32);
<br/>
   
<br/>
   for(x = 0; x &lt; INTROSETLENGTH; x++){
<br/>
      CBB0_U32_LOC[x] = introSet[x];
<br/>
   }
<br/>
   for(x = 0; x &lt; 30; x++){
<br/>
      for(y = 0; y &lt; 20; y++){
<br/>
         SBB16_U16_LOC[(y * 30) + x + (y * 2)] = (x + (y * 30));
<br/>
      }
<br/>
   }
<br/>
   for(x = 0; x &lt; BGINTROPALETTELENGTH; x++){
<br/>
      BGPAL[x] = bgIntroPalette[x];
<br/>
   }
<br/>
   
<br/>
   while(1){
<br/>
      vBlankBool_A = (DISPSTAT &amp; VBLANKFLAG);
<br/>
      
<br/>
      if(vBlankBool_A &amp; ~vBlankBool_B){
<br/>
         
<br/>
      }
<br/>
      
<br/>
      vBlankBool_B = vBlankBool_A;
<br/>
   }
<br/>
}
<br/>
<br/>
void meleeMode(){
<br/>
   u32 i, tile0, tile1, flip0, flip1, index0, index1;
<br/>
   u16 vBlankBool_A = 0, vBlankBool_B = 0;
<br/>
   
<br/>
   DISPCNT = (MODE0 | BG0_ENABLE | BG1_ENABLE | BG2_ENABLE | BG3_ENABLE | OBJ_ENABLE | OBJ1D);
<br/>
   BG1CNT  = (BG_REG_64x32 | SBB16 | CBB0 | BGCOLOR16);
<br/>
   BG2CNT  = (BG_REG_64x32 | SBB18 | CBB0 | BGCOLOR16);
<br/>
   BG3CNT  = (BG_REG_64x32 | SBB20 | CBB0 | BGCOLOR16);
<br/>
   
<br/>
   for(i = 0; i &lt; BGMELEEMODEPALETTELENGTH; i++){
<br/>
      BGPAL[i] = bgMeleeModePalette[i];
<br/>
   }
<br/>
   for(i = 0; i &lt; STARSETLENGTH; i++){
<br/>
      CBB0_U32_LOC[i] = starSet[i];
<br/>
   }
<br/>
   for(i = 0; i &lt; (BGSTARSLENGTH * 3); i++){
<br/>
      index0 = r() &gt;&gt; 25;
<br/>
      index1 = r() &gt;&gt; 25;
<br/>
      if(index0 &gt; 16){
<br/>
         tile0 = 0;
<br/>
      }
<br/>
      else{
<br/>
         tile0 = index0;
<br/>
      }
<br/>
      if(index1 &gt; 16){
<br/>
         tile1 = 0;
<br/>
      }
<br/>
      else{
<br/>
         tile1 = index1;
<br/>
      }
<br/>
      tile1 = (tile1 &lt;&lt; 16);
<br/>
      flip0 = r() &gt;&gt; 30;
<br/>
      flip1 = r() &gt;&gt; 30;
<br/>
      flip0 = (flip0 &lt;&lt; 10);
<br/>
      flip1 = (flip1 &lt;&lt; 26);
<br/>
      SBB16_U32_LOC[i] = (tile0 | tile1 | flip0 | flip1);
<br/>
   }
<br/>
   
<br/>
   while(1){
<br/>
      vBlankBool_A = (DISPSTAT &amp; VBLANKFLAG);
<br/>
      
<br/>
      if(vBlankBool_A &amp; ~vBlankBool_B){
<br/>
         keyPoll();
<br/>
   
<br/>
         if(keyDown(BUTTON_DOWN)){
<br/>
            starYoff++;
<br/>
         }
<br/>
         if(keyDown(BUTTON_UP)){
<br/>
            starYoff--;
<br/>
         }
<br/>
         if(keyDown(BUTTON_LEFT)){
<br/>
            starXoff -= 2;
<br/>
         }
<br/>
         if(keyDown(BUTTON_RIGHT)){
<br/>
            starXoff += 2;
<br/>
         }
<br/>
         
<br/>
         starXoff += 3;
<br/>
         
<br/>
         BG1HOFS = starXoff &gt;&gt; 1;
<br/>
         BG2HOFS = starXoff &gt;&gt; 2;
<br/>
         BG3HOFS = starXoff &gt;&gt; 3;
<br/>
         
<br/>
         BG1VOFS = starYoff;
<br/>
         BG2VOFS = starYoff &gt;&gt; 1;
<br/>
         BG3VOFS = starYoff &gt;&gt; 2;
<br/>
      }
<br/>
      
<br/>
      vBlankBool_B = vBlankBool_A;
<br/>
   }
<br/>
}
<br/>
<br/>
void interruptHandler(void){
<br/>
   if(INTERRUPTF &amp; INTERRUPT_TM1){
<br/>
      tm1Interrupt();
<br/>
   }
<br/>
}
<br/>
void tm1Interrupt(void){
<br/>
   TM0CNT = 0;
<br/>
   DMA1CNT = 0;
<br/>
   INTERRUPTF = INTERRUPT_TM1;
<br/>
}
<br/>
<br/>
void displayText(u32 length, const char string[], u32 colorIndex){
<br/>
   u32 i;
<br/>
   for(i = 0; i &lt; length; i++){
<br/>
      SBB31LOC[i] = (string[i] - 32);
<br/>
   }
<br/>
}
<br/>
<br/>
void playSound(u32 frequency, const u32* loc, u32 length){
<br/>
   TM0CNTCOUNT = 65536 - (16777216 / frequency);
<br/>
   TM1CNTCOUNT = 65536 - length;
<br/>
   TM1CNT = (TIMER_COUNTUPTIMING | TIMER_IRQENABLE);
<br/>
   
<br/>
   DMA1SAD = (u32)loc;
<br/>
   DMA1DAD = (u32)FIFOA;
<br/>
   SOUNDCNT_H = SOUNDCNT_H | SOUND_HARESETFIFO;
<br/>
   DMA1CNT = (DMASTARTTIMING_SPEC | DMAENABLE | DMAREPEAT | DMATRANSFER_32);
<br/>
   
<br/>
   TM0CNT = TIMER_START;
<br/>
   TM1CNT = TM1CNT | TIMER_START;
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I am not really sure what to include so if anything isn't clear please ask.[/code]<br/>_________________<br/>French re f draft free e w shredder for c rt</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#177963 - Dwedit - Wed Jun 12, 2013 3:37 pm</h4>
    <div class="postbody"><span class="postbody">Stuff that looks like that is usually the map memory being interpreted as tile graphics.
<br/>
Use VisualBoyAdvance's tile viewer to see if it's really corrupt tiles, or if your tiles are intact, and the map is getting invalid data.
<br/>
If you see evidence of the tile data getting corrupted, you can use data breakpoints to see exactly where the writes are taking place.
<br/>
Also check for extra background layers with incorrect settings.<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#177964 - aidan_aidan - Wed Jun 12, 2013 8:03 pm</h4>
    <div class="postbody"><span class="postbody">Looking at the tile viewer, the tiles are corrupt in the tile viewer. So that means it is somehow getting corrupt when being written to VRAM?
<br/>
<br/>
EDIT: Looking at the tile viewer again, i notice the corrupt tiles start right at CBB2
<br/>
<br/>
EDIT: There is something specific about CBB2 that is causing the problems because if I change the CBB from 0 to 1 for that layer, the errors move up on the screen as would be expected.<br/>_________________<br/>French re f draft free e w shredder for c rt</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#177965 - aidan_aidan - Wed Jun 12, 2013 11:14 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Dwedit wrote:</b></span></td> </tr> <tr> <td class="quote">Stuff that looks like that is usually the map memory being interpreted as tile graphics.
<br/>
Use VisualBoyAdvance's tile viewer to see if it's really corrupt tiles, or if your tiles are intact, and the map is getting invalid data.
<br/>
If you see evidence of the tile data getting corrupted, you can use data breakpoints to see exactly where the writes are taking place.
<br/>
Also check for extra background layers with incorrect settings.</td> </tr></table><span class="postbody">
<br/>
<br/>
<br/>
Yes it was being interpreted as a map, i was using SBB16 which would put it in the middle of the VRAM - right where my tiles were stored. and the map was written after the tiles which makes sense
<br/>
<br/>
<br/>
In other words, thanks!<br/>_________________<br/>French re f draft free e w shredder for c rt</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
