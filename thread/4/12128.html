<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>GBA Timers - Tutorial - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>Coding > GBA Timers - Tutorial</h2>
<div id="posts">
<div class="post">
    <h4>#114732 - Minco - Wed Jan 10, 2007 2:58 pm</h4>
    <div class="postbody"><span class="postbody">I tried using the code from KrakKeN's GBA Timers tutorial, which can be found here: <a class="postlink" href="http://www.gbadev.org/docs.php?showinfo=43" target="_blank">http://www.gbadev.org/docs.php?showinfo=43</a>
<br/>
<br/>
<span style="text-decoration: underline">When I try to compile a simple program using this delay function, I immediately get the following errors:</span>
<br/>
<br/>
<span style="font-style: italic">compiler_test.c: In function `DelayExecution':
<br/>
compiler_test.c:29: warning: assignment makes pointer from integer without a cast
<br/>
compiler_test.c:30: warning: assignment makes pointer from integer without a cast
<br/>
compiler_test.c:32: warning: comparison between pointer and integer
<br/>
compiler_test.c:33: warning: comparison between pointer and integer</span>
<br/>
<br/>
<span style="text-decoration: underline">In the code this will be the following lines:</span>
<br/>
<br/>
<br/>
<span style="font-style: italic">line 29:    REG_TMCNT[2] = (TIMEENABLE | TIME256);
<br/>
line 30:    REG_TMCNT[3] = (TIMEOVERFLOW | TIMEENABLE);
<br/>
line 31:    REG_TMD[2] = REG_TMD[3] = 0;
<br/>
line 32:    while (REG_TMD[3] &lt; iSecs) { /*/ Do Nothing /*/ }
<br/>
line 33:    while (REG_TMD[2] &lt; (65535 / 1000) * iMilliSecs) { /*/ Do Nothing /*/ } </span>
<br/>
<br/>
I've just copy pasted the code from KrakKeN's GBA Timers Tutorial, but I immediately get this errors. When I try to set a delay, let's say 1000 milliseconds, like DelayExecution(1000);, the program immediately 'crashes' at that point.
<br/>
<br/>
How can I fix this errors and fix this timer problem? (By the way, does anyone know a good other timing tutorial?)
<br/>
<br/>
Thanks!
<br/>
<br/>
<span style="font-style: italic"><span style="font-weight: bold">(p.s. if someone else also got some working functions for setting delays or setting a counter which will return a value after a given time interval or something like that, please let me know --&gt; <a href="mailto:arjan.van.bremen@gmail.com">arjan.van.bremen@gmail.com</a>)</span></span></span><span class="gensmall"><br/><br/>Last edited by Minco on Wed Jan 10, 2007 7:21 pm; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#114736 - Ant6n - Wed Jan 10, 2007 3:27 pm</h4>
    <div class="postbody"><span class="postbody">the 'errors' are actually 'warnings'. what do you mean the program 'crashes'?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#114740 - Minco - Wed Jan 10, 2007 4:05 pm</h4>
    <div class="postbody"><span class="postbody">I mean that the program 'stalls', it doesn't go any further. Here you can find the sourcecode, I used a simple example which first sets the background colour to blue, then it should wait 1000ms, and change the background colour to white/yellow, the sourcecode is pretty straightforward (I also included a make batch file, just change the path to your devkitadvance bin).
<br/>
<br/>
SOURCECODE:
<br/>
<a class="postlink" href="http://www.webjuice.eu/source.zip" target="_blank">http://www.webjuice.eu/source.zip</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#114765 - Miked0801 - Wed Jan 10, 2007 6:37 pm</h4>
    <div class="postbody"><span class="postbody">REG_TMCNT[] appears to be mis-cast somehow if you are getting that warning.  It means that it thinks the register is an array pointer and that you are feeding it integers which is bad.
<br/>
<br/>
Can you post how REG_TMCMT is declared in the headers?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#114768 - Minco - Wed Jan 10, 2007 7:19 pm</h4>
    <div class="postbody"><span class="postbody">I'll just simply post the sourcecode which is given in the tutorial:
<br/>
<br/>
<span style="text-decoration: underline"><span style="font-weight: bold">SOURCECODE timer.c</span></span>
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#include "timer.h"
<br/>
<br/>
void DelayExecution(int iTime) {
<br/>
     // Initialise Two Integers To Hold Seconds And Milliseconds //
<br/>
     int iMilliSecs, iSecs;  
<br/>
  
<br/>
    // Get Millisecond Delay //
<br/>
    // "%" Gets The Remainder Of The Answer After Division //
<br/>
    iMilliSecs = iTime % 1000;  
<br/>
<br/>
    // Get Second Delay //
<br/>
    // Remove Any Remainder From "iTime" And Divide By "1000" To Get Value In Seconds //
<br/>
    iSecs = (iTime - iMilliSecs) / 1000;
<br/>
    
<br/>
    // Enable Timer #2 And Set The Increment Frequency To 256 Cycles //
<br/>
    REG_TMCNT[2] = (TIMEENABLE | TIME256);
<br/>
    
<br/>
    // Enable Timer #3 And Set It To Increment When Timer #2 Overflows //
<br/>
    REG_TMCNT[3] = (TIMEOVERFLOW | TIMEENABLE);
<br/>
    
<br/>
    // Reset The Timers To 0 So Any Previous Use Of The Timers Are Cleared //
<br/>
    REG_TMD[2] = REG_TMD[3] = 0;
<br/>
    
<br/>
    // Loop While Timer #3 Is Under "iSecs" //
<br/>
    while (REG_TMD[3] &lt; iSecs) { /*/ Do Nothing /*/ }
<br/>
    
<br/>
    // Divide 2^16 By 1000 Then Multiply By "iMilliSecs" //
<br/>
    // To Get The Equivalent Amount Of Cycles In Milliseconds //
<br/>
    // Do Nothing While Counter Is Under This Value //
<br/>
    while (REG_TMD[2] &lt; (65535 / 1000) * iMilliSecs) { /*/ Do Nothing /*/ } 
<br/>
    
<br/>
    // Clear The Control Register For Timer #2 And Timer #3 - Disable It //
<br/>
    REG_TMCNT[2] = REG_TMCNT[3] = 0;
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
<br/>
<br/>
<span style="text-decoration: underline"><span style="font-weight: bold">SOURCECODE HEADER timer.h</span></span>
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">// DEFINE "uShort" AS AN "unsigned short int" //
<br/>
typedef unsigned short int uShort;
<br/>
<br/>
// DECLARE AN ARRAY POINTER TO THE FOUR TIMER CONTROL REGISTERS //
<br/>
volatile uShort* REG_TMCNT[4] = {
<br/>
  (uShort*)0x4000102, 
<br/>
  (uShort*)0x4000106, 
<br/>
  (uShort*)0x400010A,
<br/>
  (uShort*)0x400010E
<br/>
};
<br/>
<br/>
// DECLARE AN ARRAY POINTER TO THE FOUR TIMER COUNTER REGISTERS //
<br/>
volatile uShort* REG_TMD[4] = {
<br/>
  (uShort*)0x4000100, 
<br/>
  (uShort*)0x4000104, 
<br/>
  (uShort*)0x4000108,
<br/>
  (uShort*)0x400010C
<br/>
};
<br/>
<br/>
#define TIMESYSTEM      0x0
<br/>
#define TIME64          0x1
<br/>
#define TIME256         0x2
<br/>
#define TIME1024        0x3
<br/>
<br/>
#define TIMEOVERFLOW    0x4
<br/>
#define TIMEIRQ         0x40
<br/>
#define TIMEENABLE      0x80</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#114773 - Ant6n - Wed Jan 10, 2007 7:55 pm</h4>
    <div class="postbody"><span class="postbody">you have a volatile array of pointers, when you write to the array, you change these pointers. when you write to them you have to dereference them, also, you have to declare the pointers themselves volatile.
<br/>
<br/>
uShort* REG_TMD[4] = {
<br/>
  (volatile uShort*)0x4000100, 
<br/>
  (volatile uShort*)0x4000104, 
<br/>
  (volatile uShort*)0x4000108,
<br/>
  (volatile uShort*)0x400010C
<br/>
};
<br/>
<br/>
access with 
<br/>
REG_TMD[n]*</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#114778 - tepples - Wed Jan 10, 2007 8:12 pm</h4>
    <div class="postbody"><span class="postbody">Those definitions for the timer look confusing. Here are the ones from my own header:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">typedef struct TIMER_REC
<br/>
{
<br/>
  unsigned short count;
<br/>
  unsigned short control;
<br/>
} TIMER_REC;
<br/>
<br/>
#define TIMER ((volatile TIMER_REC *)0x04000100)
<br/>
</td> </tr></table><span class="postbody">
<br/>
Then you do TIMER[0].count, TIMER[3].control, etc. But if you're dealing with intervals longer than 50 milliseconds, it might be better to count vblanks.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#114785 - Minco - Wed Jan 10, 2007 8:28 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Ant6n wrote:</b></span></td> </tr> <tr> <td class="quote">you have a volatile array of pointers, when you write to the array, you change these pointers. when you write to them you have to dereference them, also, you have to declare the pointers themselves volatile.
<br/>
<br/>
uShort* REG_TMD[4] = {
<br/>
  (volatile uShort*)0x4000100, 
<br/>
  (volatile uShort*)0x4000104, 
<br/>
  (volatile uShort*)0x4000108,
<br/>
  (volatile uShort*)0x400010C
<br/>
};
<br/>
<br/>
access with 
<br/>
REG_TMD[n]*</td> </tr></table><span class="postbody">
<br/>
<br/>
Thanks, that does the trick! Only need to access them with *REG_TMD[n] ofcourse ;-). I'll use this code for some short delays. Someone got a tutorial or tips for using vblanks, frame rate checkings etc.? Thanks again!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#114790 - Cearn - Wed Jan 10, 2007 8:37 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Ant6n wrote:</b></span></td> </tr> <tr> <td class="quote">REG_TMD[n]*</td> </tr></table><span class="postbody">
<br/>
That would be *REG_TMD[n] :P. Tepples' way is nicer though.
<br/>
<br/>
For more on timers, <a class="postlink" href="http://www.coranac.com/tonc/text/timers.htm" target="_blank">tonc: timers</a>. But as tepples said, counting vblanks is the usual way for delays. Note that this
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">while(ScanlineCounter&lt;160) {} </td> </tr></table><span class="postbody">
<br/>
won't work as a frame-counter because in the <span style="font-style: italic">next</span> iteration of the main loop you'll probably still be in the VBlank period. For more, see <a class="postlink" href="http://www.coranac.com/tonc/text/video.htm#sec-vsync1" target="_blank">here</a>.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
