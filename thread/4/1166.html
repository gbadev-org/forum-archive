<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Code overlays - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>Coding > Code overlays</h2>
<div id="posts">
<div class="post">
    <h4>#5725 - jd - Wed May 07, 2003 1:16 am</h4>
    <div class="postbody"><span class="postbody">I'm trying to learn how to use code overlays, but I'm struggling to find any 
<br/>
example code. Can someone point me in the direction of some GBA-specific examples or documentation?
<br/>
<br/>
Thanks for your help,
<br/>
James.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#5735 - Touchstone - Wed May 07, 2003 10:54 am</h4>
    <div class="postbody"><span class="postbody">Why would you want to do this? Code is normally executed from ROM so no overlay is needed unless your code is compressed and need to be decompressed in RAM.
<br/>
<br/>
If you want to load code to RAM for faster execution then it's simply a matter of copying the code from ROM to RAM, given that your code and required symbols is PC relative and not using absolute adresses. You would ofcourse have to define new function-pointers to point to your function in RAM instead of ROM.
<br/>
<br/>
If you want to overlay variables in RAM then you should write a linkerscript with multiple sections in the same memory-space and just assign your variables to the correct section. Be aware that you have to initialize your variables for the variable-attribute "section" to work.<br/>_________________<br/>You can't beat our meat</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#5737 - torne - Wed May 07, 2003 1:37 pm</h4>
    <div class="postbody"><span class="postbody">If you mean the iwram0-9 sections supported by the crtls linker script, then all you need to do is declare functions as being in a particular one of those sections. iwram0 will be copied into iwram for you at boot time (along with the normal iwram section); when you want to copy a different overlay into memory, then use a DMA copy. The linker's section variables (things like __iwram1_start) will give you the addresses you need to copy from/to.
<br/>
<br/>
ewram0-9 work exactly the same way.
<br/>
<br/>
I realise this isn't in a lot of detail; I've never actually USED the overlay support in crtls, but I do understand linker scripts. =)
<br/>
<br/>
If you have any specific questions about this ask again and I'll see what I can find out.
<br/>
<br/>
T.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#5745 - jd - Wed May 07, 2003 11:03 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>torne wrote:</b></span></td> </tr> <tr> <td class="quote">If you mean the iwram0-9 sections supported by the crtls linker script, then all you need to do is declare functions as being in a particular one of those sections. iwram0 will be copied into iwram for you at boot time (along with the normal iwram section); when you want to copy a different overlay into memory, then use a DMA copy. The linker's section variables (things like __iwram1_start) will give you the addresses you need to copy from/to.</td> </tr></table><span class="postbody">
<br/>
<br/>
Ah, I see. Thanks for the help! However, there is a slight complication in my case that I hope you can help me out with. I'd like to keep the sound mixer and interrupt handling in the same place in IWRAM in all cases, even when other routines are being swapped in and out. What's the best way to do that?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#5747 - torne - Thu May 08, 2003 12:03 am</h4>
    <div class="postbody"><span class="postbody">Just define anything you want to *always* be in iwram in the 'iwram' section. The iwram section is never replaced. iwram0-9 are allocated 'after' iwram, so while they all overlay each other, none of them overlay the iwram section.
<br/>
<br/>
T</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#5750 - jd - Thu May 08, 2003 1:31 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>torne wrote:</b></span></td> </tr> <tr> <td class="quote">Just define anything you want to *always* be in iwram in the 'iwram' section. The iwram section is never replaced. iwram0-9 are allocated 'after' iwram, so while they all overlay each other, none of them overlay the iwram section.
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I see. Thanks for the help!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#5785 - jd - Thu May 08, 2003 4:53 pm</h4>
    <div class="postbody"><span class="postbody">I've run into another problem - when I try to compile the following code:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#define UBYTE unsigned char
<br/>
#define IN_IWRAM1 __attribute__ ((section (".iwram1")))
<br/>
<br/>
UBYTE local_luminance_quant_table_idct[8][8] IN_IWRAM1;
<br/>
UBYTE local_chrominance_quant_table_idct[8][8] IN_IWRAM1;
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I get these errors:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
AMV.arm.c:42: local_luminance_quant_table_idct causes a section type conflict
<br/>
AMV.arm.c:43: local_chrominance_quant_table_idct causes a section type conflict
<br/>
make: *** [AMV.o] Error 1
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Help!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#5787 - torne - Thu May 08, 2003 5:27 pm</h4>
    <div class="postbody"><span class="postbody">Two problems:
<br/>
<br/>
1) You are trying to put uninitialised data into a section other than bss. This is not possible with a C compiler, that I know of. Uninitialised globals always go into the bss section, where they will be filled with zeros at load time. The C compiler won't let you have 'undefined' data; either it is initialised, and goes by default into the .data section, or it's uninitialised and goes into .bss to be zero-filled.
<br/>
<br/>
2) You are trying to use data overlays, which is normally neither neccecary nor possible for non-constant data. The iwram0-9 and ewram0-9 sections are intended for code overlays. If the data is supposed to be uninitialised, i.e. you don't want to store initial values in ROM, then it would be easier to just malloc the memory when you needed it and free it when you're done, rather than using overlays. If you need the data to be initialised, i.e. you want to store an array of non-constant data in ROM until it's needed, then copy it into RAM to use it, then remember that you won't be able to write the values back when you load a different overlay (obviously). If that's really, genuinely what you want, then tell me and I'll see if I can work out how to make data overlays work on the GBA (because I like pain). It will probably involve modifying the linker script as Touchstone said.
<br/>
<br/>
Hope that's enough for now,
<br/>
Torne</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#5790 - Jason Wilkins - Thu May 08, 2003 6:08 pm</h4>
    <div class="postbody"><span class="postbody">The problem is that DevKit Advance R4 does not support putting both code and data into a special section at the same time.
<br/>
<br/>
using DevKit Advance R5 Beta 2, you can specify .iwram.text and .iwram.data (or even .iwram.foobar) to prevent the conflict.
<br/>
<br/>
The C compiler determines the type of section based on the first declaration it sees with a section attribute.  So, all the definitions that go into a section need to have the same combination of executability and writability or you get a conflict.
<br/>
<br/>
The ability to add 'sub-sections', that is the ability to put things in .iwram.data and .iwram.text seperates all these different properties out and prevents the conflict.<br/>_________________<br/><a href="http://devkitadv.sourceforge.net" target="_blank">http://devkitadv.sourceforge.net</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#5793 - torne - Thu May 08, 2003 6:34 pm</h4>
    <div class="postbody"><span class="postbody">Convenient, thanks Jason. Though since I just program in asm mostly, I can do whatever I like with my sections. =)
<br/>
<br/>
T.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#5800 - Jason Wilkins - Thu May 08, 2003 9:03 pm</h4>
    <div class="postbody"><span class="postbody">Yeah, with assembly you can make sure that the section attributes are always the same.  If you program in C, the compiler sets these attributes based on what you are putting into that section.
<br/>
<br/>
Functions get an 'ax' for allocatable and executable, initialized data gets 'aw' for allocatable and writable, constant data gets 'a' for just allocatable (not writable).
<br/>
<br/>
If you specify a section attribute for uninitialized data, it gets treated as data initialized to zero ('ar').  Unfortunately, this means you cannot split the .bss section into an iwram part and a ewram part.  True uninitialized data has no attributes set, not even allocatable.
<br/>
<br/>
Here is an example of how to do something like what the original poster wants to do with DKA5.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
__attribute__ ((section(".iwram.data"))) int iwram_var;
<br/>
<br/>
__attribute__ ((section(".iwram.text"))) void my_interrupt_handler(void)
<br/>
{
<br/>
}
<br/>
<br/>
__attribute__ ((section(".iwram0.text"))) void my_movie_renderer(void)
<br/>
{
<br/>
}
<br/>
<br/>
__attribute__ ((section(".iwram1.text"))) void my_3d_renderer(void)
<br/>
{
<br/>
}
<br/>
<br/>
extern int __iwram_overlay_start[];
<br/>
extern int __iwram_overlay_end[];
<br/>
extern int __load_start_iwram0;
<br/>
extern int __laod_stop_iwram0;
<br/>
extern int __load_start_iwram1;
<br/>
extern int __load_stop_iwram1;
<br/>
<br/>
void AgbMain(void)
<br/>
{
<br/>
   // go ahead and use iwram0 because it is already loaded
<br/>
   my_movie_renderer();
<br/>
<br/>
   // switch to iwram overlay 1
<br/>
   memcpy(__iwram_overlay_start, __load_start_iwram, __load_stop_iwram1 - __load_start_iwram1)
<br/>
<br/>
   my_3d_renderer();
<br/>
<br/>
   // switch back to iwram overlay 0
<br/>
   memcpy(__iwram_overlay_start, __load_start_iwram, __load_stop_iwram0 - __load_start_iwram0)
<br/>
<br/>
   my_movie_renderer();
<br/>
}
<br/>
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
One caveat.  I found a bug with overlays when getting ready for beta 3, so you may want to wait until I release beta 3 (very soon I hope) before you try this.
<br/>
<br/>
Another Caveat, it would be better to come up with macros for declaring attributes and switching overlays.  The code above is hardly readable as it is.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#define IWRAM_FUN(decl) __attribute__ ((section(".iwram.text"))) decl
<br/>
#define IWRAM_VAR(decl) __attribute__ ((section(".iwram.data"))) decl
<br/>
#define CONST_IWRAM_VAR(decl) __attribute__ ((section(".iwram.rodata"))) decl
<br/>
<br/>
IWRAM_VAR(foobar) = 42;
<br/>
<br/>
CONST_IWRAM_VAR(awesome) = 69;
<br/>
<br/>
// a function declaration
<br/>
IWRAM_FUN(my_external_function(void));
<br/>
<br/>
// a function definition
<br/>
IWRAM_FUN(int my_awesome_function(int a, int b))
<br/>
{
<br/>
   return a + b + awesome;
<br/>
}
<br/>
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
You will need to compile using the -mlong-calls option in order to call the function from ROM.  Or, you can add the long_call attribute to the IWRAM_FUN macro and make it like this.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#define IWRAM_FUN(decl) __attribute__ ((section(".iwram.text"), long_call))
<br/>
</td> </tr></table><span class="postbody"><br/>_________________<br/><a href="http://devkitadv.sourceforge.net" target="_blank">http://devkitadv.sourceforge.net</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#5809 - jd - Thu May 08, 2003 11:20 pm</h4>
    <div class="postbody"><span class="postbody">Thanks for all the help. I've worked around the problem by just putting the arrays mentioned above in IWRAM all the time - after all, it's only 128 bytes.
<br/>
<br/>
However, I have spotted that the following declaration uses ~220K of ROM when really it should use virtually none:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#define ULONG unsigned int
<br/>
#define IN_EWRAM1 __attribute__ ((section (".ewram1")))
<br/>
<br/>
ULONG amv_data[55360] IN_EWRAM1;
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I guess this is related to what Jason was saying but I'd prefer not to switch to a new version of the devkit at such a late stage in development, but I really need that 220K back somehow. Is there any way to fix this problem without upgrading? Perhaps using a bit of assembler?</span><span class="gensmall"><br/><br/>Last edited by jd on Fri May 09, 2003 12:00 am; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#5810 - tepples - Thu May 08, 2003 11:24 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>jd wrote:</b></span></td> </tr> <tr> <td class="quote">I have spotted that the following declaration uses ~220K of ROM when really it should use virtually nothing:
<br/>
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#define ULONG unsigned int
<br/>
#define IN_EWRAM1 __attribute__ ((section (".ewram1")))
<br/>
<br/>
ULONG amv_data[55360] IN_EWRAM1;
<br/>
</td> </tr></table><span class="postbody"></span></td> </tr></table><span class="postbody">
<br/>
To fix this, try malloc().<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#5813 - jd - Fri May 09, 2003 12:03 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tepples wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
To fix this, try malloc().
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I've rewritten my routines so they don't use malloc because I need all the IWRAM I can get.
<br/>
<br/>
There must be a way to declare the variable with it wasting all that ROM.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#5830 - Jason Wilkins - Fri May 09, 2003 3:34 pm</h4>
    <div class="postbody"><span class="postbody">I have realized the problem of having large uninitialized ewram/iwram variables waste ROM space because they are 'allocated'
<br/>
<br/>
DevKit Advance R5 somewhat works around this problem by allowing you to easily choose to put normal read/write C variables into ewram or iwram.  That will allow you to use bss to allocate large variables in ewram.
<br/>
<br/>
It is not fine grain, unfortunately.
<br/>
<br/>
A work around is to use dynamic memory.  I do not mean you have to use malloc.  I do not remember if these symbols exist in R4, but R5 provides __ewram_break and __iwram_break which point to the beginning of unallocated space.  It is not hard to write a simple memory manager for these spaces.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
<br/>
extern char __ewram_break[];
<br/>
char *ebreak;
<br/>
<br/>
void reset_ewram_break(void)
<br/>
{
<br/>
      end = __ewram_break;
<br/>
}
<br/>
<br/>
char *set_ewram_break(size_t s)
<br/>
{
<br/>
   char *prev_ebreak;
<br/>
<br/>
   if (!end) {
<br/>
      reset_ewram_break();
<br/>
   }
<br/>
<br/>
   prev_ebreak = ebreak;
<br/>
   ebreak += s;
<br/>
<br/>
   return prev_ebreak;
<br/>
}
<br/>
<br/>
my_foo *foo;
<br/>
my_bar *bar;
<br/>
<br/>
void AgbMain(void)
<br/>
{
<br/>
   foo = set_ewram_break(sizeof(*foo));
<br/>
   bar = set_ewram_break(sizeof(*bar));
<br/>
<br/>
   // now, use foo and bar ...
<br/>
<br/>
   // unallocate everything
<br/>
   reset_ewram_break();
<br/>
<br/>
   // can now reallocate
<br/>
}
<br/>
</td> </tr></table><span class="postbody"><br/>_________________<br/><a href="http://devkitadv.sourceforge.net" target="_blank">http://devkitadv.sourceforge.net</a></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
