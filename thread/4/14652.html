<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Solved: Struct memory problems - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>Coding > Solved: Struct memory problems</h2>
<div id="posts">
<div class="post">
    <h4>#146818 - Rajveer - Sun Dec 09, 2007 6:21 pm</h4>
    <div class="postbody"><span class="postbody">I have a few structs which work fine, and a few which dont. The following works:
<br/>
<br/>
Structs:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">struct ObjVertex
<br/>
{
<br/>
   v16 x, y, z;
<br/>
};
<br/>
<br/>
struct ObjNormal
<br/>
{
<br/>
   v10 x, y, z;
<br/>
};   
<br/>
<br/>
struct ObjTexCoord
<br/>
{
<br/>
   t16 u, v;
<br/>
};
<br/>
<br/>
struct ObjTriangle
<br/>
{
<br/>
   int Vertex[3];
<br/>
   int Normal[3];
<br/>
   int TexCoord[3];
<br/>
};
<br/>
<br/>
struct ObjTexture
<br/>
{
<br/>
   int texture;
<br/>
   e.t.c.
<br/>
};
<br/>
<br/>
struct ObjModel
<br/>
{
<br/>
   int nVertex, nNormal, nTexCoord, nTriangle;
<br/>
   int transform[3];
<br/>
   int scale;
<br/>
   
<br/>
   struct ObjVertex* VertexArray;
<br/>
   struct ObjNormal* NormalArray;
<br/>
   struct ObjTexCoord* TexCoordArray;
<br/>
   
<br/>
   struct ObjTriangle* TriangleArray;
<br/>
   
<br/>
   struct ObjTexture* Texture;
<br/>
};
<br/>
<br/>
struct Ship
<br/>
{
<br/>
   Stats...
<br/>
   struct ObjModel* Model; //Ship's loaded 3D model
<br/>
};
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Allocate:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">struct Ship* ret;   
<br/>
   
<br/>
   // the returned model struct, allocate and clear
<br/>
   ret = calloc(1,sizeof(struct Ship));
<br/>
   memset(ret, 0, sizeof(struct Ship));</td> </tr></table><span class="postbody">
<br/>
<br/>
The following doesn't work:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
struct SplineNode
<br/>
{
<br/>
   some variables, pointers
<br/>
};
<br/>
<br/>
struct ProgressQuad
<br/>
{
<br/>
   some variables
<br/>
};
<br/>
<br/>
struct PositionalLight
<br/>
{
<br/>
   light stuff
<br/>
};
<br/>
<br/>
struct TrackModel
<br/>
{
<br/>
   struct ObjModel* Model;
<br/>
   s8 type; // 0 = No Collision, 1 = Collision, 2 = Healing Zone
<br/>
};
<br/>
<br/>
struct Track
<br/>
{
<br/>
   int nTrackModel, nSplineNode, nProgressQuad, nLight;
<br/>
   
<br/>
   struct ObjModel* LowPolyModel;
<br/>
   struct TrackModel* TrackModelArray;
<br/>
   struct SplineNode* SplineArray;
<br/>
   struct ProgressQuad* ProgressQuadArray;
<br/>
   struct PositionalLight* LightArray;
<br/>
};</td> </tr></table><span class="postbody">
<br/>
<br/>
Allocate:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">struct Track* ret;   
<br/>
   
<br/>
   // the returned model struct, allocate and clear
<br/>
   ret = calloc(1,sizeof(struct Track));
<br/>
   memset(ret, 0, sizeof(struct Track));
<br/>
<br/>
   .
<br/>
   .
<br/>
   .
<br/>
<br/>
   ret-&gt;TrackModelArray = malloc(sizeof(struct TrackModel)*ret-&gt;nTrackModel);
<br/>
   ret-&gt;TrackModelArray[nM]-&gt;Model = ObjLoadModel(file_Location,(int)temp_Variable[0],(int)temp_Variable[1]); //ObjLoadModel works fine, so thats not the problem
<br/>
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
With the latter, after trying to allocate Track arrays or modify variables such as ret-&gt;nTrackModel, nothing happens. If I use malloc instead of calloc, the variables have some (incorrect) values. Also, the last line as well as any call to ret-&gt;TrackModelArray or any other array pointers, produces an "error: invalid type argument of '-&gt;'" error. Any ideas?</span><span class="gensmall"><br/><br/>Last edited by Rajveer on Mon Dec 10, 2007 1:17 am; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#146819 - Dark Knight ez - Sun Dec 09, 2007 6:46 pm</h4>
    <div class="postbody"><span class="postbody">When you use an array index like that... you should use . instead of -&gt;, as you're not dealing with a pointer anymore but with a value (at that specific location).
<br/>
<br/>
So ret-&gt;TrackModelArray[nM].Model would make more sense.
<br/>
<br/>
Small example to clarify...
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">int someArray[2];
<br/>
someArray[0] = 6;
<br/>
someArray[1] = 8;
<br/>
printf("%i", someArray[0]); // will output 6</td> </tr></table><span class="postbody">
<br/>
<br/>
In the above example, you can clearly see an index-use gives you a value, not a (integer) pointer to the value.<br/>_________________<br/><span style="font-size: 9px; line-height: normal"><a class="postlink" href="http://amplituds.drunkencoders.com" target="_blank">AmplituDS website</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146826 - gmiller - Sun Dec 09, 2007 8:54 pm</h4>
    <div class="postbody"><span class="postbody">I assume that by the time you execute:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
ret-&gt;TrackModelArray = malloc(sizeof(struct TrackModel)*ret-&gt;nTrackModel);
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
That ret-&gt;nTrackModel is non zero?  If it is zero then there are issues that the malloc will allocate zero bytes.
<br/>
<br/>
BTW:  If you use calloc then:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
memset(ret, 0, sizeof(struct Track));
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
is not needed ... calloc does clear the heap data to all zero(s).</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146840 - Rajveer - Sun Dec 09, 2007 11:24 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Dark Knight ez wrote:</b></span></td> </tr> <tr> <td class="quote">When you use an array index like that... you should use . instead of -&gt;, as you're not dealing with a pointer anymore but with a value (at that specific location).
<br/>
<br/>
So ret-&gt;TrackModelArray[nM].Model would make more sense.</td> </tr></table><span class="postbody">
<br/>
<br/>
Even though TrackModelArray is still a pointer to a struct, just like ret is a pointer to a struct? I thought . should be used only if the variable or whatever is defined within the struct. So because I'm allocating an array of TrackModel instead of just one, then the pointer TrackModelArray wouldn't use -&gt;?
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>gmiller wrote:</b></span></td> </tr> <tr> <td class="quote">I assume that by the time you execute:
<br/>
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
ret-&gt;TrackModelArray = malloc(sizeof(struct TrackModel)*ret-&gt;nTrackModel);
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
That ret-&gt;nTrackModel is non zero?  If it is zero then there are issues that the malloc will allocate zero bytes.</span></td> </tr></table><span class="postbody">
<br/>
<br/>
Yup, the idea is that the number of obj models in a level is counted from a text file and stored in nTrackModel, and then nTrackModel TrackModels are allocated. So I have some code in between creating ret and the malloc of size TrackModel*nTrackModel, where the nTrackModel is incremented. Although at the moment it's not working for some reason :S</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146841 - Dark Knight ez - Sun Dec 09, 2007 11:39 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Even though TrackModelArray is still a pointer to a struct, just like ret is a pointer to a struct? I thought . should be used only if the variable or whatever is defined within the struct. So because I'm allocating an array of TrackModel instead of just one, then the pointer TrackModelArray wouldn't use -&gt;? </td> </tr></table><span class="postbody">
<br/>
Look up the use of . and -&gt; if you don't understand them completely. Quite important to use them in a correct manner. It doesn't matter if you're talking about regular variables or structs... pointers are what matter.
<br/>
<br/>
Let me give a struct example, so you hopefully understand.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">struct Coordinate {
<br/>
    int x;
<br/>
    int y;
<br/>
}
<br/>
<br/>
struct Coordinate  exampleOne[3]; // exampleOne is actually a pointer to an array.
<br/>
struct Coordinate *exampleTwo;    // exampleTwo is a generic pointer right now.
<br/>
<br/>
exampleOne[1].x = 6;         // . notation here because we use [] to get an index of a pointer/array.
<br/>
exampleTwo = exampleOne + 1; // exampleTwo now POINTS to exampleOne[1], thus being equal to &amp;exampleOne[1].
<br/>
exampleTwo-&gt;y = 4;           // -&gt; notation here because we use a pointer and want to dereference it.
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Hope it makes sense now.<br/>_________________<br/><span style="font-size: 9px; line-height: normal"><a class="postlink" href="http://amplituds.drunkencoders.com" target="_blank">AmplituDS website</a></span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146843 - Rajveer - Sun Dec 09, 2007 11:57 pm</h4>
    <div class="postbody"><span class="postbody">Ahh, great I understood that! Thanks for that, learn something new everyday, or rather escape having to buy C for dummies for an extra day ;) As such both problems are solved, one because of the . and -&gt; mixup and the other because I didn't see an obvious error.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146845 - sajiimori - Mon Dec 10, 2007 12:35 am</h4>
    <div class="postbody"><span class="postbody">exampleOne is <span style="font-style: italic">not</span> a pointer to an array -- it is an array.  C just happens to use the rule that if you write the name of an array, it will implicitly convert to a pointer to the first element.
<br/>
<br/>
The type of exampleOne is Coordinate[3], not Coordinate*.  Declaring an array doesn't allocate any pointers.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#146849 - tepples - Mon Dec 10, 2007 3:15 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>sajiimori wrote:</b></span></td> </tr> <tr> <td class="quote">exampleOne is <span style="font-style: italic">not</span> a pointer to an array -- it is an array.</td> </tr></table><span class="postbody">
<br/>
To emphasize the difference: On ARM7 and ARM9, sizeof(some pointer) will equal 4, just like on i386, but sizeof(some array) will usually be much larger.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
