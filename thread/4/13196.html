<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>SMSAdvance port to GCC: .iwram section replaced with zeroes! - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>Coding > SMSAdvance port to GCC: .iwram section replaced with zeroes!</h2>
<div id="posts">
<div class="post">
    <h4>#128674 - Dwedit - Mon May 14, 2007 12:31 am</h4>
    <div class="postbody"><span class="postbody">Source code available at: <a href="http://www.dwedit.org/dwedit_board/attachment.php?item=67" target="_blank">http://www.dwedit.org/dwedit_board/attachment.php?item=67</a>
<br/>
<br/>
I need help here.  I've got SMSAdvance building on GCC with no compiler errors, except the generated .GBA file has a zero-filled IWRAM section instead of the code it's supposed to have.
<br/>
<br/>
Here are the sequence of commands used to generate the binary (batch file):
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
arm-eabi-gcc -mthumb -mthumb-interwork -Os -fomit-frame-pointer -Wall -c main.c -o main.o
<br/>
arm-eabi-gcc -mthumb -mthumb-interwork -Os -fomit-frame-pointer -Wall -c ui.c -o ui.o
<br/>
arm-eabi-gcc -mthumb -mthumb-interwork -Os -fomit-frame-pointer -Wall -c sram.c -o sram.o
<br/>
arm-eabi-gcc -mthumb -mthumb-interwork -Os -fomit-frame-pointer -Wall -c minilzo.107/minilzo.c -o minilzo.o
<br/>
cd asm
<br/>
arm-eabi-as all.s -o all.o
<br/>
cd ..
<br/>
<br/>
arm-eabi-gcc -mthumb-interwork -Wall main.o sram.o ui.o minilzo.o asm/all.o -o smsadvance.elf -specs=gba_mb.specs
<br/>
arm-eabi-objcopy -v -O binary smsadvance.elf smsadvance.gba
<br/>
gbafix smsadvance.gba -tSMSAdvance
<br/>
</td> </tr></table><span class="postbody"><br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#128721 - Dwedit - Mon May 14, 2007 3:08 pm</h4>
    <div class="postbody"><span class="postbody">What's weird is that the ELF file contains all the iwram code, but after using OBJCOPY on it, the iwram code disappears!  Also when loading the elf file in VBA or NO$GBA, the iwram code disappears as well.  So far, the only thing that works is manually copying the iwram section into the GBA file with a hex editor.
<br/>
<br/>
Output of ReadElf:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
ELF Header:
<br/>
  Magic:   7f 45 4c 46 01 01 01 00 00 00 00 00 00 00 00 00
<br/>
  Class:                             ELF32
<br/>
  Data:                              2's complement, little endian
<br/>
  Version:                           1 (current)
<br/>
  OS/ABI:                            UNIX - System V
<br/>
  ABI Version:                       0
<br/>
  Type:                              EXEC (Executable file)
<br/>
  Machine:                           ARM
<br/>
  Version:                           0x1
<br/>
  Entry point address:               0x2000000
<br/>
  Start of program headers:          52 (bytes into file)
<br/>
  Start of section headers:          97572 (bytes into file)
<br/>
  Flags:                             0x4000002, has entry point, &lt;unrecognized EABI&gt;
<br/>
<br/>
  Size of this header:               52 (bytes)
<br/>
  Size of program headers:           32 (bytes)
<br/>
  Number of program headers:         3
<br/>
  Size of section headers:           40 (bytes)
<br/>
  Number of section headers:         21
<br/>
  Section header string table index: 18
<br/>
<br/>
Section Headers:
<br/>
  [Nr] Name              Type            Addr     Off    Size   ES Flg Lk Inf Al
<br/>
  [ 0]                   NULL            00000000 000000 000000 00      0   0  0
<br/>
  [ 1] .init             PROGBITS        02000000 008000 000224 00  AX  0   0  4
<br/>
  [ 2] .text             PROGBITS        02000224 008224 005960 00  AX  0   0  4
<br/>
  [ 3] .fini             PROGBITS        02005b84 00db84 000018 00  AX  0   0  4
<br/>
  [ 4] .rodata           PROGBITS        02005b9c 00db9c 000870 00   A  0   0  4
<br/>
  [ 5] .init_array       INIT_ARRAY      0200640c 00e40c 000004 00  WA  0   0  4
<br/>
  [ 6] .fini_array       FINI_ARRAY      02006410 00e410 000004 00  WA  0   0  4
<br/>
  [ 7] .jcr              PROGBITS        02006414 00e414 000004 00  WA  0   0  4
<br/>
  [ 8] .eh_frame         PROGBITS        02006418 00e418 000004 00   A  0   0  4
<br/>
  [ 9] .iwram            PROGBITS        03000000 00fc48 007b9c 00      0   0  4
<br/>
  [10] .bss              NOBITS          03007b9c 00fc48 0000a8 00  WA  0   0  4
<br/>
  [11] .data             PROGBITS        03007c44 00fc44 000004 00  WA  0   0  4
<br/>
  [12] .comment          PROGBITS        00000000 0177e4 0002b9 00      0   0  1
<br/>
  [13] .debug_aranges    PROGBITS        00000000 017aa0 000050 00      0   0  8
<br/>
  [14] .debug_info       PROGBITS        00000000 017af0 0000b6 00      0   0  1
<br/>
  [15] .debug_abbrev     PROGBITS        00000000 017ba6 000020 00      0   0  1
<br/>
  [16] .debug_line       PROGBITS        00000000 017bc6 000092 00      0   0  1
<br/>
  [17] .ARM.attributes   LOPROC+3        00000000 017c58 000010 00      0   0  1
<br/>
  [18] .shstrtab         STRTAB          00000000 017c68 0000bc 00      0   0  1
<br/>
  [19] .symtab           SYMTAB          00000000 01806c 007760 10     20 1466  4
<br/>
  [20] .strtab           STRTAB          00000000 01f7cc 003c42 00      0   0  1
<br/>
Key to Flags:
<br/>
  W (write), A (alloc), X (execute), M (merge), S (strings)
<br/>
  I (info), L (link order), G (group), x (unknown)
<br/>
  O (extra OS processing required) o (OS specific), p (processor specific)
<br/>
<br/>
Program Headers:
<br/>
  Type           Offset   VirtAddr   PhysAddr   FileSiz MemSiz  Flg Align
<br/>
  LOAD           0x008000 0x02000000 0x02000000 0x0641c 0x0641c RWE 0x8000
<br/>
  LOAD           0x00fc44 0x03007c44 0x0200dfb8 0x00004 0x00004 RW  0x8000
<br/>
  LOAD           0x00fb9c 0x03007b9c 0x03007b9c 0x00000 0x000a8 RW  0x8000
<br/>
<br/>
 Section to Segment mapping:
<br/>
  Segment Sections...
<br/>
   00     .init .text .fini .rodata .init_array .fini_array .jcr .eh_frame
<br/>
   01     .data
<br/>
   02     .bss
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Any idea why the .iwram section gets dropped by objcopy?<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#128740 - tepples - Mon May 14, 2007 6:51 pm</h4>
    <div class="postbody"><span class="postbody">I noticed that .iwram's "Flg" column doesn't have "A".<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#128749 - Cearn - Mon May 14, 2007 7:21 pm</h4>
    <div class="postbody"><span class="postbody">The proper section declaration for iwram is 
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">.section .iwram, "ax", %progbits</td> </tr></table><span class="postbody">
<br/>
When you use that instead of `.section ".iwram" ', the IWRAM stuff still end up in the binary. I don't trust all that non-aligned code though: it's possible that all the data and code happen to be word-aligned, but it'd better to add .align explicitly. Also, IWRAM is <span style="font-style: italic">very</span> ful. The counter goes up to 0300:7C00, leaving less than 1kb for the stack.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#128757 - Dwedit - Mon May 14, 2007 9:54 pm</h4>
    <div class="postbody"><span class="postbody">Thanks!
<br/>
<br/>
I had tried the '.section .iwram, "ax", %progbits' thing before, and got a compiler warning that the change in attributes was being ignored, so I made sure to replace all instances, then it finally worked.  Yay!<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#128926 - Dwedit - Wed May 16, 2007 7:49 pm</h4>
    <div class="postbody"><span class="postbody">I see that __end__ is a valid symbol for the last byte in multiboot mode, but it is not valid for cartridge mode.  What is a valid symbol for the last byte in cartridge mode?  All the symbols I've seen on the table are 8 bytes short of the last byte, for some reason there's this "dkARM\0\0\0" found 8 bytes from the end, and all of the last symbols point there.
<br/>
<br/>
Edit: Ah, I see: Version 1.5 deliberately corrupted the linkscript by adding the "dkarm\0\0\0" string.  That really needs to go.  I wonder if more people got burned by not having a real end symbol, or by the auto-trimmers which prompted the creation of junk in the linkscript?<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#128931 - tepples - Wed May 16, 2007 8:06 pm</h4>
    <div class="postbody"><span class="postbody">I think the addition had something to do with adding more robust support for appended data in general, rather than ad-hoc solutions such as GBFS.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#128943 - Dwedit - Wed May 16, 2007 11:14 pm</h4>
    <div class="postbody"><span class="postbody">I think I've hit a bug in GCC.
<br/>
<br/>
I'm building for cartridge, so that .text is at 08000000.  The program makes a few calls (from THUMB to ARM) to functions in .iwram.  Whenever it calls an ARM function from thumb, there is an 8-byte veneer, consisting of two thumb instructions (bx pc \ nop) and an arm instruction (b xxxxxxxx).  In the case where it calls from 08xxxxxx to 03xxxxxx, the jump is too long for a branch instruction, and it instead jumps to 07xxxxxx.  In my case, it was trying to jump to 03005ccc, but instead jumped to 07005CCC.  Of course, executing 07xxxxxx proceeds to execute a ton of NOPS, then it "reboots" when it hits 08000000.
<br/>
<br/>
I'd call this a GCC bug because it didn't try to make the jump long, or raise a linker error.
<br/>
<br/>
For comparison, ARM SDT raised a link error, and then proceeded to not give any information about that error, making it a long annoying guessing game.  I don't know which is worse, ignoring an error so it crashes/reboots, or giving an error and not telling where it is.<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#128953 - wintermute - Thu May 17, 2007 1:50 am</h4>
    <div class="postbody"><span class="postbody">I'm really not sure how you managed to get it to do that, I was having a play with this code a couple of days ago and got a whole bunch of relocation errors. I was going to fix it &amp; post a zip but that project is too much of a mess for me to spare the time on unfortunately.
<br/>
<br/>
I've massaged things a bit to fit into a standard devkitPro build if you want to have a look at it.
<br/>
<br/>
<a href="http://www.devkitpro.org/files/smsadvance.zip" target="_blank">http://www.devkitpro.org/files/smsadvance.zip</a>
<br/>
<br/>
In order to get rid of the relocation errors you'll need to separate the assembly files into separate objects rather than including them in all.s. Once you've done that the .iwram code will need to be separated from the .text code and assembled separately - gcc assumes that functions in the same compilation unit will be within short branch range.
<br/>
<br/>
This was tested with devkitARM release 20, I highly recommend using that. It sounds like you may have an old buggy set of binutils in whatever you're using now. I also recommend using the devkitPro updater/installer rather than trying to install manually on windows.
<br/>
<br/>
You'll also need to edit gba_cart.ld found in /path/to/devkitARM/arm-eabi/lib
<br/>
<br/>
replace
<br/>
<br/>
	end = __sbss_end;
<br/>
<br/>
with 
<br/>
<br/>
	_end = __sbss_end;
<br/>
<br/>
This tweak will be present in release 21<br/>_________________<br/><a class="postlink" href="http://www.devkitpro.org/" target="_blank">devkitPro - professional toolchains at amateur prices</a>
<br/>
<a class="postlink" href="http://wiki.devkitpro.org/index.php/IRC" target="_blank">devkitPro IRC support</a>
<br/>
<a class="postlink" href="http://davejmurphy.com/" target="_blank">Personal Blog</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#128954 - wintermute - Thu May 17, 2007 1:57 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Dwedit wrote:</b></span></td> </tr> <tr> <td class="quote">I see that __end__ is a valid symbol for the last byte in multiboot mode, but it is not valid for cartridge mode.  What is a valid symbol for the last byte in cartridge mode?  All the symbols I've seen on the table are 8 bytes short of the last byte, for some reason there's this "dkARM\0\0\0" found 8 bytes from the end, and all of the last symbols point there.
<br/>
<br/>
Edit: Ah, I see: Version 1.5 deliberately corrupted the linkscript by adding the "dkarm\0\0\0" string.  That really needs to go.  I wonder if more people got burned by not having a real end symbol, or by the auto-trimmers which prompted the creation of junk in the linkscript?</td> </tr></table><span class="postbody">
<br/>
<br/>
1. It's not corruption, it has zero effect other than to combat buggy auto trimmers.
<br/>
2. __end__ is a pefectly valid symbol in my gba_cart.ld but _end is not, thus the tweak above. end was removed because far too many people suffered memory corruption due to using a variable called end - a bug in the original devkit advance scripts these were based on.
<br/>
3. What version of devkitARM are you using? You seem to have broken it somehow. Are you sure you have no other toolchains in your path and/or odd environment variables defined?<br/>_________________<br/><a class="postlink" href="http://www.devkitpro.org/" target="_blank">devkitPro - professional toolchains at amateur prices</a>
<br/>
<a class="postlink" href="http://wiki.devkitpro.org/index.php/IRC" target="_blank">devkitPro IRC support</a>
<br/>
<a class="postlink" href="http://davejmurphy.com/" target="_blank">Personal Blog</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#128960 - Dwedit - Thu May 17, 2007 3:16 am</h4>
    <div class="postbody"><span class="postbody">First, this is the corrected and (mostly) working code I am using.  (use of mbclient.c is disabled since it's not working, otherwise everything works fine, don't know what's up, but it says "Sending..." and never stops)
<br/>
<a href="http://www.dwedit.org/dwedit_board/attachment.php?item=75" target="_blank">http://www.dwedit.org/dwedit_board/attachment.php?item=75</a>
<br/>
<br/>
In order to reproduce the broken jump, change: asmcalls.h (replace run_c with run), change main.c (replace all run_c calls with run).
<br/>
"make rom" at a command line to build it.
<br/>
You don't even need to append any roms to see the glitch in action.  If you run the generated smsadvance_rom.gba, you will first see the 'rainbow splash screen' (copying open bus to vram), then you see it reboot and hear a staticy noise.  That's it calling run, and getting to 07xxxxxx.
<br/>
<br/>
<br/>
Edit: spoke too soon, forgot to modify code to trigger the problem.  Clean devkitpro DOES have the problem.<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"><br/><br/>Last edited by Dwedit on Thu May 17, 2007 3:41 am; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#128961 - wintermute - Thu May 17, 2007 3:41 am</h4>
    <div class="postbody"><span class="postbody">Is there any particular reason why you've copied the specs &amp; crtls into your project?
<br/>
<br/>
That "makefile" is worse than the original bat file :/
<br/>
<br/>
You're mixing arm and thumb code and not telling the compiler, use -mthumb-interwork.
<br/>
<br/>
You're still going to have to separate the iwram code into separate objects to get it to work in rom.<br/>_________________<br/><a class="postlink" href="http://www.devkitpro.org/" target="_blank">devkitPro - professional toolchains at amateur prices</a>
<br/>
<a class="postlink" href="http://wiki.devkitpro.org/index.php/IRC" target="_blank">devkitPro IRC support</a>
<br/>
<a class="postlink" href="http://davejmurphy.com/" target="_blank">Personal Blog</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#128962 - Dwedit - Thu May 17, 2007 3:47 am</h4>
    <div class="postbody"><span class="postbody">For the "multiboot" build, I needed a modified crt0.s file.  I needed to know whether it was initially executed from a cartridge or from multiboot mode based on the initial PC, and the default crt0.s has no way of reporting that.
<br/>
For the "rom" build, I needed to kill the 8 byte trailer with a modified linkscript, it was either that, or adding 8 to a C variable manually.  I thought adding 8 for the padding section was too 'hacky'.  Then again, maybe I should instead use objcopy or something to just exclude that section?
<br/>
It would be nice if I could just get the modified crt0.s file without needing to provide the specs and linkscript as well.
<br/>
<br/>
edit: "-R.pad" added to the objcopy line removes the need for the included linkscript in cart mode, yay<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#128964 - wintermute - Thu May 17, 2007 4:03 am</h4>
    <div class="postbody"><span class="postbody">How is the trailing 8 bytes a problem? It would be good if you could explain this one in detail.
<br/>
<br/>
EDIT: bah, stop editing your posts while I'm replying :P
<br/>
<br/>
I <span style="font-weight: bold">still</span> don't understand why the 8 bytes are causing you problems.
<br/>
<br/>
<br/>
A flag for multiboot code run from cart sounds like it might be useful. I'm going to consider that a feature request for r21<br/>_________________<br/><a class="postlink" href="http://www.devkitpro.org/" target="_blank">devkitPro - professional toolchains at amateur prices</a>
<br/>
<a class="postlink" href="http://wiki.devkitpro.org/index.php/IRC" target="_blank">devkitPro IRC support</a>
<br/>
<a class="postlink" href="http://davejmurphy.com/" target="_blank">Personal Blog</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#128965 - Dwedit - Thu May 17, 2007 4:18 am</h4>
    <div class="postbody"><span class="postbody">The program depends on having a filesystem-like thingy appended to the rom.  The program is dumb and doesn't do any searching, it assumes it will appear at a specific address given by a symbol address.  If it gets the wrong address, it fails to find the filesystem.  8 bytes of appended data screws it up enough.
<br/>
Right now, I'm using the symbol '__load_stop_iwram9' since that symbol is the end address of the binary in both multiboot and cart linkscripts.  I'd perfer to use __end__, but __end__ has a value of 02000000 in my builds using the cart linkscript, so it's useless for that purpose.
<br/>
Removing the .pad section works fine for removing the default appended data for now, it's just that it was unexpected that anything would even be there.  Maybe __end__ needs to be redefined so that it points to the address after the padding.<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#128967 - Dwedit - Thu May 17, 2007 4:46 am</h4>
    <div class="postbody"><span class="postbody">How do I have multiple iwram sections that I can select the order in which they go into the binary?  It looks like the linkscript provides a way to do it, but I can't tell how.
<br/>
For now I'm using .subsections and putting everything in to the same file, there has to be a better way.
<br/>
<br/>
edit: Also, does gnu assembler support instructions like: ldr r0,[r10,#my_label - my_base] if 'my_label' and 'my_base' are external symbols?<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#129383 - Dwedit - Tue May 22, 2007 7:18 am</h4>
    <div class="postbody"><span class="postbody">Ran out of stack space, finally had to modify both linkscripts.  I changed the IRQ stack to start at 7FA0 (system default) instead of 7F00, and the User stack to start at 7F00 instead of 7E00.
<br/>
<br/>
Why was the IRQ stack placed at 7F00 anyway, when it is usually at 7FA0?
<br/>
What else would the memory at 7F00-7FA0 be used for?<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
