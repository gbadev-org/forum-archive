<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>DMA Timings and Wait States - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>Coding > DMA Timings and Wait States</h2>
<div id="posts">
<div class="post">
    <h4>#169629 - Karatorian - Mon Jul 27, 2009 3:32 pm</h4>
    <div class="postbody"><span class="postbody">I'm working on the core graphics engine for my latest project and I've got some questions about DMA timing. Basically, I want to know how much data I can realistically DMA transfer to VRAM before I run out of v-blank time.
<br/>
<br/>
According to the GBAtek, the v-blank is 83776 cycles. So, if I understand how the DMA timing works (the only docs I could find on this was the dev'rs FAQ), the theoretical maximums are as follows:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
Source      Dest   Total      Speed
<br/>
<br/>
IWRAM       VRAM   ~55850      4 bytes every 6 cycles
<br/>
EWRAM       VRAM   ~33510      2 bytes every 5 cycles
<br/>
ROM (4/2)   VRAM    23936      2 bytes every 7 cycles
<br/>
ROM (3/1)   VRAM   ~27925      2 bytes every 6 cycles
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
However, I think I've calculated the most of these values wrong. After the first access, DMA should be using sequential addressing, so it should be faster. More like:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
Source      Dest   Total      Speed
<br/>
<br/>
ROM (4/2)   VRAM   ~33510      2 bytes every 5 cycles
<br/>
ROM (3/1)   VRAM    41888      2 bytes every 4 cycles
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I don't know what exactly the timing on the EWRAM is. Is it's wait always 2 cycles or is it faster on sequential access? So anyway, are these numbers correct, or am I misunderstanding something? I'm a little confused because none of the docs I found explain wait states in a comprehensive way, especially with regards to DMA.
<br/>
<br/>
The other thing I was wondering about was 32 vs 16 bit DMA. From what I understand you can use 32 bit DMA even when one of the buses is 16 bit. What I'm not sure about is if both of the buses are 16 bit. Can you do it and is there any drawback to doing so?
<br/>
<br/>
If I grok the timing correctly, 16 to 16 with 32 bit DMA should be the same speed as with 16 bit DMA. The reason I'm asking is that 16 to 32 (or vice versa) or 32 to 32 transfers should be faster with 32 bit DMA and it'd simplify things if I could just use 32 bit transfers for everything.
<br/>
<br/>
Obviously, these are theoretical maximums and it's probably impossible to actually reach quite these speeds. However, I want to know if I'm doing the math right, so I can figure the timing on what I do need to transfer.
<br/>
<br/>
As for what that is, well most of it's pretty basic stuff, but my engine is a little bit complicated in some areas. First up is 4k of tile map buffers (for mode 0 layers). As I'm using a varible width font I have to transfer a bunch of text tiles and then I need to transfer about 3k of spirite tiles for characters, plus some more for attacks. (Due to the large number of characters and the many possible poses, I can't simply stuff it all in VRAM at once). Finally, there's the OAM data. I'm also thinking of tranfering all or most of the palette data to make pallet effects quick and easy.
<br/>
<br/>
All told, it'll probably be 20 to 24k of DMA every v-blank. Is that reasonable, or do I have to rethink my design?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#169631 - eKid - Mon Jul 27, 2009 3:57 pm</h4>
    <div class="postbody"><span class="postbody">20-24k seems like a bit much, but it might be reasonable.
<br/>
<br/>
EWRAM speed is 3 cycles per 16bit read/write, 1 cycle for the 16bit access plus 2 waitstates. The sequential timing is the same so it's really pretty slow...
<br/>
3,1 waitstates on ROM give 2 cycles per each 16bit transferred. Transferring this data to VRAM will be 3 + 1 cycles per 16bit hword from EWRAM and 2+1 cycles when transferring from ROM (3,1).
<br/>
<br/>
When transferring a 32bit word from a 16bit bus it will take two accesses. The first access will be nonsequential and the second one will be sequential. When doing 32bit dma transfers from a 16bit memory region then only the first 16bit will be nonsequential. You will save with 32bit DMA if either the source or the destination area (or both) have a 32bit bus.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#169633 - Karatorian - Mon Jul 27, 2009 4:42 pm</h4>
    <div class="postbody"><span class="postbody">Could you clarify a little more about using 32 bit dma on a 16 bit bus? I get that the first 16 bits will be non-sequential and that the next 16 bits will be sequential. I assumed that the third, forth, etc. 16 bits would be sequential also, but what you wrote seems to imply that it alternates every other word? Which interpretation is correct?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#169636 - eKid - Mon Jul 27, 2009 5:37 pm</h4>
    <div class="postbody"><span class="postbody">Er yeah only the very first 16bit hword of the first 32bit word will be nonsequential in the transfer. With a reasonable amount transferred with DMA you don't really need to take the nonsequential timing into account.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#169641 - Karatorian - Mon Jul 27, 2009 7:03 pm</h4>
    <div class="postbody"><span class="postbody">Thank you.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
