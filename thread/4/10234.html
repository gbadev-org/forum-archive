<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Awkward OAM problem - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>Coding > Awkward OAM problem</h2>
<div id="posts">
<div class="post">
    <h4>#91233 - Edelnutte - Wed Jul 05, 2006 1:38 pm</h4>
    <div class="postbody"><span class="postbody">hi^^
<br/>
<br/>
I want to display and move a sprite using own written funtions, but when I want to Update the OAM it Overwrites every Attribute different and messes up my sprite.
<br/>
Here are the Funtions for Moving and Updating:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void keyinput(){
<br/>
     u8 x;
<br/>
     u8 y;
<br/>
     if(!(REG_KEYINPUT &amp; KEY_LEFT)) {x=x-1;}
<br/>
     if(!(REG_KEYINPUT &amp; KEY_RIGHT)) {x=x+1;} 
<br/>
     if(!(REG_KEYINPUT &amp; KEY_A)) {y=y+5;}
<br/>
     OAMcopy[0].attr1=OBJ_X(x);
<br/>
     OAMcopy[0].attr0=OBJ_Y(y);
<br/>
      }</td> </tr></table><span class="postbody">
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
//UPDATE OAM
<br/>
void updateOAM(){
<br/>
     for(i=0;i&lt;128;i++){
<br/>
                        OAM[i]=OAMcopy[i];}}</td> </tr></table><span class="postbody">
<br/>
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
//THE ORIGINAL SPRITE ATTRIBUTES
<br/>
for(i=0;i&lt;128;i++){
<br/>
OBJ_BASE_ADR[i]=tiles0_Data[i];}
<br/>
<br/>
     
<br/>
     OAMcopy[0].attr1=(OBJ_256_COLOR);           
<br/>
     OAMcopy[0].attr0=(OBJ_SIZE(Sprite_16x16));
<br/>
     OAMcopy[0].attr2=(OBJ_CHAR(0)|OBJ_SQUARE);</td> </tr></table><span class="postbody">
<br/>
<br/>
<br/>
<br/>
I appreciate any help. I'm pretty new and desperate with it.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#91241 - Cearn - Wed Jul 05, 2006 4:18 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Edelnutte wrote:</b></span></td> </tr> <tr> <td class="quote">I want to display and move a sprite using own written funtions, but when I want to Update the OAM it Overwrites every Attribute different and messes up my sprite.
<br/>
Here are the Functions for Moving and Updating:
<br/>
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void keyinput()
<br/>
{
<br/>
     u8 x;
<br/>
     u8 y;
<br/>
     if(!(REG_KEYINPUT &amp; KEY_LEFT)) {x=x-1;}
<br/>
     if(!(REG_KEYINPUT &amp; KEY_RIGHT)) {x=x+1;} 
<br/>
     if(!(REG_KEYINPUT &amp; KEY_A)) {y=y+5;}
<br/>
     OAMcopy[0].attr1=OBJ_X(x);
<br/>
     OAMcopy[0].attr0=OBJ_Y(y);
<br/>
}</td> </tr></table><span class="postbody">
<br/>
</span></td> </tr></table><span class="postbody">
<br/>
<br/>
The coordinates are only a part of attr0 and attr1, so simply assigning them to the attributes will remove all the other settings. Mask out the bits you want to set and then add (masked!) x/y in there. See <a class="postlink" href="http://user.chem.tue.nl/jakvijn/tonc/regobj.htm#ssec-demo-pos" target="_blank">here</a> for an example.
<br/>
Also, don't use bytes as a variable for x as that will only cover half the range of the valid x-coordinate. And you shouldn't use bytes (or halfwords) as variables anyway, because they produce more and slower code than word variables. Use ints, please.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Edelnutte wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
//UPDATE OAM
<br/>
void updateOAM()
<br/>
{
<br/>
    for(i=0;i&lt;128;i++)
<br/>
        OAM[i]=OAMcopy[i];
<br/>
}</td> </tr></table><span class="postbody"></span></td> </tr></table><span class="postbody">
<br/>
Unfortunately, struct copies don't work as well under devkitPro r19 as before, some of the alignment rules have changed. If the struct has no 32bit members and you want to do struct-copies, you have to add alignment attributes. See <a class="postlink" href="http://user.chem.tue.nl/jakvijn/tonc/bitmaps.htm#ssec-data-align" target="_blank">here</a> for details. 
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Edelnutte wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">//THE ORIGINAL SPRITE ATTRIBUTES
<br/>
for(i=0;i&lt;128;i++)
<br/>
    OBJ_BASE_ADR[i]=tiles0_Data[i];</td> </tr></table><span class="postbody">
<br/>
</span></td> </tr></table><span class="postbody">
<br/>
OBJ_BASE_ADR is a void pointer, I'm confident that tiles0_Data isn't. Cast or use memcpy/dma/CpuFastSet for copies.</span><span class="gensmall"><br/><br/>Last edited by Cearn on Wed Jul 05, 2006 5:42 pm; edited 2 times in total</span></div>    
</div>
<div class="post">
    <h4>#91248 - Edelnutte - Wed Jul 05, 2006 5:34 pm</h4>
    <div class="postbody"><span class="postbody">Thank you very much, couldn't try it yet but especially the part under the Keyinput Qoute sounds logic to me
<br/>
<br/>
EDIT: 
<br/>
I appended the ALIGN(4) to the struct OBJATTR and it compiles fine But i Still dont get the OAMcopy properly copied to OAM!
<br/>
<br/>
BITMAP_OBJ_BASE_ADR has a u16 pointer and In VBA the Tiles are stored correctly.
<br/>
<br/>
<br/>
heres the whole Source, for the first, Keyinput() isnt used I only tried updateOAM but even that gets me the problem
<br/>
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#include "include/gba.h"
<br/>
#include "data/frame0.h"
<br/>
<br/>
OBJATTR OAMcopy[127] ;
<br/>
int i;
<br/>
<br/>
<br/>
<br/>
//CLEAR OAM
<br/>
void clearOAM(){
<br/>
for(i=1;i&lt;128;i++){ OAMcopy[i].attr0=OBJ_DISABLE; } }
<br/>
<br/>
//UPDATE OAM
<br/>
void updateOAM(){
<br/>
     for(i=0;i&lt;128;i++){
<br/>
                        OAM[i]=OAMcopy[i];}}
<br/>
<br/>
//VSYNC FUNC
<br/>
void WaitForVSync() {
<br/>
   while (*(vu16*)0x4000006 != 160);}
<br/>
   
<br/>
<br/>
<br/>
//KEYINPUT FUNC
<br/>
void keyinput(){
<br/>
     u8 x;
<br/>
     u8 y;
<br/>
     if(!(REG_KEYINPUT &amp; KEY_LEFT)) {x=x-1;}
<br/>
     if(!(REG_KEYINPUT &amp; KEY_RIGHT)) {x=x+1;} 
<br/>
     if(!(REG_KEYINPUT &amp; KEY_A)) {y=y+5;}
<br/>
     OAMcopy[0].attr1=OBJ_X(x);
<br/>
     OAMcopy[0].attr0=OBJ_Y(y);
<br/>
      }
<br/>
<br/>
<br/>
int main(void){
<br/>
    //SCREENMODE
<br/>
SetMode(MODE_1|OBJ_ON|OBJ_1D_MAP);
<br/>
<br/>
//SPRITE DATA
<br/>
for(i=0;i&lt;128;i++){
<br/>
OBJ_BASE_ADR[i]=tiles0_Data[i];}
<br/>
for(i=0;i&lt;256;i++){
<br/>
OBJ_COLORS[i]=tiles0_Palette[i];}
<br/>
<br/>
<br/>
     
<br/>
     OAMcopy[0].attr1=(OBJ_256_COLOR);           
<br/>
     OAMcopy[0].attr0=(OBJ_SIZE(Sprite_16x16));
<br/>
     OAMcopy[0].attr2=(OBJ_CHAR(0)|OBJ_SQUARE);  
<br/>
     
<br/>
     clearOAM();
<br/>
     
<br/>
     while(1) {
<br/>
               WaitForVSync();;
<br/>
               updateOAM(); }
<br/>
               
<br/>
               
<br/>
              return 0; } </td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#92304 - Cearn - Wed Jul 12, 2006 6:28 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Edelnutte wrote:</b></span></td> </tr> <tr> <td class="quote">I appended the ALIGN(4) to the struct OBJATTR and it compiles fine But i Still dont get the OAMcopy properly copied to OAM!
<br/>
</td> </tr></table><span class="postbody">
<br/>
I see what you mean :(
<br/>
<br/>
For some reason, devkitPro has become insanely stupid when it comes to struct copies with r19. I thought the alignment would fix it but I guess I was wrong. In the past it would use ldm/stm for small-struct copies (if you don't know what they, just know that they are good), but nowadays it always uses memcpy, which is not only very slow for small structs, but doesn't even work for PAL/VRAM/OAM because of the no-byte-write rule. The only workaround that seems to work is by working with pointers manually:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void updateOAM()
<br/>
{
<br/>
   int ii;
<br/>
   OBJATTR *dst= OAM, *src= OAMcopy;
<br/>
   ii=128;
<br/>
   while(ii--)
<br/>
      *dst++= *src++;
<br/>
}
<br/>
</td> </tr></table><span class="postbody">Even this isn't compiled optimally anymore, but at least it still works.
<br/>
<br/>
On a side note, please use one of the <a class="postlink" href="http://en.wikipedia.org/wiki/Indent_style" target="_blank">standard indent styles</a>. Hiding the initial brace behind other code makes code difficult to read, hiding both braces makes it next to impossible.
<br/>
<br/>
<br/>
ETA:
<br/>
OK, I think I may have found the problem. Or part of it anyway.
<br/>
<br/>
It's not just alignment, it's the combination of alignment and the amount of stuff you want to copy. For small enough loops it'll try to unroll the loops (at least for -O2 optimization). Example for a 2 iteration loop:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
   for(ii=0; ii&lt;2; ii++)
<br/>
      OAM[ii]= OAMcopy[ii];
<br/>
// compiles to:
<br/>
   ldr   r3, .L12
<br/>
   mov   r2, #224
<br/>
   lsl   r2, r2, #19
<br/>
   ldmia   r3!, {r0, r1}
<br/>
   stmia   r2!, {r0, r1}
<br/>
   ldmia   r3!, {r0, r1}
<br/>
   stmia   r2!, {r0, r1}</td> </tr></table><span class="postbody">
<br/>
But the full 128 version becomes:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">   mov   r5, #224
<br/>
   ldr   r6, .L8
<br/>
   ldr   r4, .L8+4
<br/>
   lsl   r5, r5, #19
<br/>
.L2:
<br/>
   mov   r0, r5
<br/>
   mov   r1, r4
<br/>
   mov   r2, #8
<br/>
   add   r5, r5, #8
<br/>
   bl   memcpy
<br/>
   add   r4, r4, #8
<br/>
   cmp   r5, r6
<br/>
   bne   .L2</td> </tr></table><span class="postbody">
<br/>
128 iterations would be a little long to unroll, so that's not an option. but even then it should use ldm/stm like it does in the unrolled version (well, partially at least), and not memcpy. In the past I've seen memcpy being called for struct copies if the size was large enough (around 13 words). It could be that GCC looks at the loop-size and says "Nevermind, unrolling that", but also looks at the total copy size (128*8 bytes) and decides to use memcpy, even though that would be highly inappropriate here.
<br/>
<br/>
But I could be wrong.
<br/>
<br/>
Interestingly, my TILE struct copies still work properly, it's only with OBJATTR that I have problems with. Even defining it as two words doesn't help. I'm very close to calling this an optimization bug.
<br/>
<br/>
ETA2: Just for a lark I made OAMcopy const and got this:</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
const OBJATTR OAMcopy[128]= {{0}};
<br/>
for(ii=0; ii&lt;2; ii++)
<br/>
   OAM[ii]= OAMcopy[ii];
<br/>
// asm:
<br/>
   mov   r3, #224
<br/>
   lsl   r3, r3, #19
<br/>
   mov   r2, #0
<br/>
   str   r2, [r3]
<br/>
   str   r2, [r3, #4]
<br/>
   ldr   r3, .L12
<br/>
   ldr   r2, .L12+4
<br/>
   add   r3, r3, #8
<br/>
   ldmia   r3!, {r0, r1}
<br/>
   stmia   r2!, {r0, r1}</td> </tr></table><span class="postbody">Whut? o_O</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#93320 - Edelnutte - Tue Jul 18, 2006 4:33 pm</h4>
    <div class="postbody"><span class="postbody">Thanks for the help. It tourned out that actually without Bitmasking some attributes of the OAM were overwritten</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#93333 - tepples - Tue Jul 18, 2006 6:13 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Cearn wrote:</b></span></td> </tr> <tr> <td class="quote">On a side note, please use one of the <a class="postlink" href="http://en.wikipedia.org/wiki/Indent_style" target="_blank">standard indent styles</a>. Hiding the initial brace behind other code makes code difficult to read, hiding both braces makes it next to impossible.</td> </tr></table><span class="postbody">
<br/>
Looks like Pico mixed with K&amp;R.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#93345 - Edelnutte - Tue Jul 18, 2006 7:10 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tepples wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Cearn wrote:</b></span></td> </tr> <tr> <td class="quote">On a side note, please use one of the <a class="postlink" href="http://en.wikipedia.org/wiki/Indent_style" target="_blank">standard indent styles</a>. Hiding the initial brace behind other code makes code difficult to read, hiding both braces makes it next to impossible.</td> </tr></table><span class="postbody">
<br/>
Looks like Pico mixed with K&amp;R.</span></td> </tr></table><span class="postbody">
<br/>
<br/>
Well I was kind of unpatient when I wrote that stuff simply because I had no problems with the Compiling before I formatted my PC. Usually I do that Pico stuff (without even knowing the name :P )</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
