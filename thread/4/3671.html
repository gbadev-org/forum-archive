<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Water effect - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>Coding > Water effect</h2>
<div id="posts">
<div class="post">
    <h4>#23170 - ProblemBaby - Tue Jul 06, 2004 1:37 pm</h4>
    <div class="postbody"><span class="postbody">Hi I want to do a water/wave effect.
<br/>
For now I use a HBLANK-interrupt (that actually doesnt work ive no idea why but the code in the interrupt should work)
<br/>
Its freezing after all setup code here is how I enable the interrupt
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
IntrTable[1] = WaterEffect;
<br/>
REG_DISPSTAT |= 0x10;
<br/>
REG_IE |= 0x2;
<br/>
REG_IME = 1;
<br/>
<br/>
void WaterEffect()
<br/>
{
<br/>
REG_BG0HOFS = 20;Â  // this just to check if the code comes to this place
<br/>
REG_IF |= 0x2;
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Whats wrong, ive worked with interuppts before and it have worked but now it something really strange going on.
<br/>
<br/>
I also wonder if HDMA is that faster than an interrupt and is it possible to use in this case?</span><span class="gensmall"><br/><br/>Last edited by ProblemBaby on Tue Jul 06, 2004 2:10 pm; edited 2 times in total</span></div>    
</div>
<div class="post">
    <h4>#23171 - poslundc - Tue Jul 06, 2004 1:44 pm</h4>
    <div class="postbody"><span class="postbody">HDMA has less overhead than an interrupt, so it will go somewhat faster, but is recommended if you are only doing a single raster effect, since you can't perform multiple tasks with it.
<br/>
<br/>
To use it, set up an array during VBlank with 160 entries that have the register values you want to set for each scanline. Set DMA0 with the source as your array, the destination as the control register, and tell it to increment the source, leave the destination the same, and set its mode to fire automatically on HBlank. Turn it on, and voila. Make sure you turn the DMA off again during VBlank (REG_DMA0CNT = 0) before trying to fiddle with the registers.
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#23173 - tepples - Tue Jul 06, 2004 3:20 pm</h4>
    <div class="postbody"><span class="postbody">Another tip for hblank DMA: You'll want to set up the first scanline's data during vblank and then point the DMA source address to the <span style="font-style: italic">second</span> scanline's data.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#23206 - ProblemBaby - Wed Jul 07, 2004 1:53 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>poslundc wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
To use it, set up an array during VBlank with 160 entries that have the register values you want to set for each scanline. Set DMA0 with the source as your array, the destination as the control register, and tell it to increment the source, leave the destination the same, and set its mode to fire automatically on HBlank. Turn it on, and voila. Make sure you turn the DMA off again during VBlank (REG_DMA0CNT = 0) before trying to fiddle with the registers.
<br/>
Dan.</td> </tr></table><span class="postbody">
<br/>
<br/>
So Ive to set 2x160 entries (I change both the XOFS and YOFS) each VBlank it feels a bit slow. Maybe I can stick to the interrupt.
<br/>
<br/>
My interrupt look like this:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
REG_BG3HOFS = 8 + (SIN[((REG_VCOUNT + counter) &amp; 0x7) &lt;&lt; 5] &gt;&gt; 8);
<br/>
REG_BG3VOFS = 8 + (COS[((REG_VCOUNT + counter) &amp; 0xF) &lt;&lt; 4] &gt;&gt; 8);
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
counter is incremented each twelve VBlank this give me a good effect.
<br/>
It isnt somehow possible to make a DMACOPY of it without arrays?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#23208 - poslundc - Wed Jul 07, 2004 2:56 pm</h4>
    <div class="postbody"><span class="postbody">Are you testing it on hardware? Speed on emulation in no way reflects actual speed on hardware.
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#23209 - col - Wed Jul 07, 2004 3:47 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>ProblemBaby wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>poslundc wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
To use it, set up an array during VBlank with 160 entries that have the register values you want to set for each scanline. Set DMA0 with the source as your array, the destination as the control register, and tell it to increment the source, leave the destination the same, and set its mode to fire automatically on HBlank. Turn it on, and voila. Make sure you turn the DMA off again during VBlank (REG_DMA0CNT = 0) before trying to fiddle with the registers.
<br/>
Dan.</td> </tr></table><span class="postbody">
<br/>
<br/>
So Ive to set 2x160 entries (I change both the XOFS and YOFS) each VBlank it feels a bit slow. Maybe I can stick to the interrupt.
<br/>
<br/>
My interrupt look like this:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
REG_BG3HOFS = 8 + (SIN[((REG_VCOUNT + counter) &amp; 0x7) &lt;&lt; 5] &gt;&gt; 8);
<br/>
REG_BG3VOFS = 8 + (COS[((REG_VCOUNT + counter) &amp; 0xF) &lt;&lt; 4] &gt;&gt; 8);
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
counter is incremented each twelve VBlank this give me a good effect.
<br/>
It isnt somehow possible to make a DMACOPY of it without arrays?</span></td> </tr></table><span class="postbody">
<br/>
<br/>
If you are worried about efficiency, and are only updating the counter every 12 lines, you can use the vCount interrupt to manage the hBlank interrupt. It goes somthing like this: Each vcount interrupt sets up the data for the next line down, switches on the hblank interrupt and sets the vCount interrupt to fire again in 12 lines time. The hblank handler switches hBlank interrupts off at the end of its process.
<br/>
If you set it up this way, there is some extra overhead because you are using 2 interrupts. There is also some extra book-keeping to do. However you are only doing it 13 times per frame instead of 160.
<br/>
Its possible to set this up in a dynamic way so it's not hardwired to 12 line steps, but there comes a point where its not worth the extra overhead and its best to switch to pure hBlank interrupts or hBlankDMA.
<br/>
<br/>
Something you might want to try (i've not tested this idea myself) is using hblank DMA, but with a fixed data source. You could then use the vcount interrupt to update the source every 12(or whatever) lines..
<br/>
(maybe even try switching the hBlank DMA on/off using the vcount? although that brings in extra management code and more hassle)
<br/>
<br/>
cheers
<br/>
<br/>
Col</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
