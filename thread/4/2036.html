<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Fixed Point Rounding... - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>Coding > Fixed Point Rounding...</h2>
<div id="posts">
<div class="post">
    <h4>#10536 - regularkid - Mon Sep 08, 2003 5:03 am</h4>
    <div class="postbody"><span class="postbody">I'm trying to round up some fixed point numbers (12.20). Since I can have positive or negative values, here is what I want to happen:
<br/>
<br/>
If the decimal part of the number is greater than 0.5 (2048), then:
<br/>
    If the number is positive, then add 2048
<br/>
    If the number is negative, then subtract 2048
<br/>
<br/>
Here is the direct translation of the above that I am currently using in my code:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
if(num &amp; 0x00000800)
<br/>
{
<br/>
    if(num &gt; 0)
<br/>
    {
<br/>
        num += 2048;
<br/>
    }
<br/>
    else
<br/>
    {
<br/>
        num -= 2048;
<br/>
    }
<br/>
}
<br/>
               
<br/>
num &gt;&gt;= 12;
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
So, the above works and gives me what I want, but I would like to do it without the 'if's. I'm stumped...anyone have any good simple ways of rounding up fixed point numbers both negative and positive? Thanks!<br/>_________________<br/>- RegularKid</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#10539 - DekuTree64 - Mon Sep 08, 2003 6:26 am</h4>
    <div class="postbody"><span class="postbody">Are you sure it really matters? It will only make a difference when you're at exactly 2048. If you have say, 0x2750, add 0x800, and you get 0x2f50. Shift by 12 and you end up with 2. Then 0x2850 + 0x800 = 0x3050, &gt;&gt;12 = 3. Which is proper rounding. Then for negatives, if you have 0xd8b0 (-0x2750, 16-bit so it's easier to write, just imagine 4 f's before it), + 0x800 = 0xe0b0, &gt;&gt;12 = 0xfffe = -2, which is also properly rounded. And just for completeness, 0xd7b0 (-0x2850) + 0x800 = 0xdfb0, &gt;&gt;12 = fffd = -3. But 0x2800 + 0x800 = 0x3000, &gt;&gt;12 = 3, and 0xd800 (-0x2800) + 0x800 = 0xe000 &gt;&gt; 12 = -2. But right at an even half is the only place where negatives will round toward zero and positives will round away from zero, but actually since being at exactly 1/2 is like the old question about wether the glass is half empty or half full, where logically it could go either way, then I think it evens it out a little more.<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#10545 - FluBBa - Mon Sep 08, 2003 11:26 am</h4>
    <div class="postbody"><span class="postbody">hmmm, where to start...
<br/>
say you want to round of -0.1 to a normal integer, that would be 0, right?
<br/>
to represent this with a fixed point number with 12 bits for the fraction it would be something like -4096/10=-410=0xFFFFFE66.
<br/>
If you don't do anything with the number before you shift it, it would become -1/0xFFFFFFFF, but if you <span style="font-weight: bold">add</span> 2048 it will end up 0 which is right. I'm not so good with C but I think it will use an arithmetic shift if the type is signed.
<br/>
<br/>
C code:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
if(num &amp; 0x00000800)
<br/>
{
<br/>
        num += 2048;
<br/>
}
<br/>
num &gt;&gt;= 12;
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Or if you're into assembler:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
movs r0,r0,asr#12
<br/>
addcs r0,r0,#1
<br/>
</td> </tr></table><span class="postbody"><br/>_________________<br/>I probably suck, my not is a programmer.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#10554 - regularkid - Mon Sep 08, 2003 5:58 pm</h4>
    <div class="postbody"><span class="postbody">Thanks, guys!<br/>_________________<br/>- RegularKid</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
