<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>a problem with memset() - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>Coding > a problem with memset()</h2>
<div id="posts">
<div class="post">
    <h4>#6314 - Foz - Thu May 22, 2003 11:08 pm</h4>
    <div class="postbody"><span class="postbody">Hi all,
<br/>
<br/>
I'm having a problem with memset.  I'm using gcc and the program is in mode 4.
<br/>
I have a few files:<ul>Header
<br/>
Implementation
<br/>
Main</ul>The following are fragments but contain all the pertinent info.
<br/>
In the header I have:</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">extern u16* videoBuffer;</td> </tr></table><span class="postbody">
<br/>
In the implementation I have:</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">u16* videoBuffer;
<br/>
memset((u16*)videoBuffer[y*(HALF_SCREEN_WIDTH)+x1&gt;&gt;1],color, x2-x1);</td> </tr></table><span class="postbody">
<br/>
<br/>
I know assembly, or DMA is faster, but I am not there yet. I'm trying to get it all to work first.  I will then go back and optimize.
<br/>
<br/>
Anyway I get a warning that says:"cast to pointer of different size" and besides the warning it flat out doesn't work.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#6322 - tepples - Fri May 23, 2003 3:44 am</h4>
    <div class="postbody"><span class="postbody">[quote="Foz"]</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">u16* videoBuffer;
<br/>
memset((u16*)videoBuffer[y*(HALF_SCREEN_WIDTH)+x1&gt;&gt;1],color, x2-x1);</td> </tr></table><span class="postbody">
<br/>
You're probably missing an ampersand.  The value of 'videoBuffer' is a pointer to an array. The value of 'videoBuffer[x]' is the value of element x. The value of '&amp;videoBuffer[x]' is a pointer to element x.
<br/>
<br/>
Try this:</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">u16* videoBuffer;
<br/>
memset((u16*)&amp;videoBuffer[y*(HALF_SCREEN_WIDTH)+x1&gt;&gt;1],color, x2-x1);</td> </tr></table><span class="postbody"><br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#6335 - funkeejeffou - Fri May 23, 2003 12:51 pm</h4>
    <div class="postbody"><span class="postbody">This should also do it :
<br/>
memset(videoBuffer + y*(HALF_SCREEN_WIDTH)+ x1&gt;&gt;1,color, x2-x1);
<br/>
<br/>
videoBuffer + y*(HALF_SCREEN_WIDTH)+ x1&gt;&gt;1 is the adress of the element you want to reach in your videobuffer array.
<br/>
and
<br/>
*(videoBuffer + y*(HALF_SCREEN_WIDTH)+ x1&gt;&gt;1) = videoBuffer[y*(HALF_SCREEN_WIDTH)+ x1&gt;&gt;1], wich is the u16 value stored at this adress.
<br/>
<br/>
I know this does it when coding on PC, but it should work on devkit as it's the fundemantal notion and definition of an array, wich is in fact a pointer.
<br/>
Also, your cast should not be needed, even if the compiler generates a warning, don't care about it, as long as you know what you're doing:)
<br/>
<br/>
Hope this helps</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#6362 - Maddox - Fri May 23, 2003 8:12 pm</h4>
    <div class="postbody"><span class="postbody">funkeejeffou:
<br/>
Uhhh, yeah.  You pretty much ALWAYS want to pay attention to warnings, swifty, that's kinda why they're there.
<br/>
<br/>
Foz:
<br/>
Try putting parentheses in like this like you're supposed to:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">memset(((u16*)videoBuffer)[y*(HALF_SCREEN_WIDTH)+x1&gt;&gt;1],color, x2-x1);</td> </tr></table><span class="postbody">
<br/>
<br/>
See how I put those parentheses around </span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">(u16*)videoBuffer</td> </tr></table><span class="postbody">?
<br/>
<br/>
Now good grab a good C book that describes operator precedence.
<br/>
<br/>
MADDOX!!<br/>_________________<br/>You probably suck.  I hope you're is not a game programmer.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#6402 - funkeejeffou - Sat May 24, 2003 11:37 am</h4>
    <div class="postbody"><span class="postbody">maddox :
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">memset(((u16*)videoBuffer)[y*(HALF_SCREEN_WIDTH)+x1&gt;&gt;1],color, x2-x1);</td> </tr></table><span class="postbody">
<br/>
won't work. 
<br/>
you're casting a u16 variable to a u16*
<br/>
so if videoBuffer)[y*(HALF_SCREEN_WIDTH)+x1&gt;&gt;1] = 158;
<br/>
then memset will copy the data at the adress 158=0x9E
<br/>
hummm...guess it's not the VRAM starting adress...
<br/>
<br/>
Foz :
<br/>
The general form of the memset functiun is:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void *memset(void *s, int c, size_t n);</td> </tr></table><span class="postbody">
<br/>
where s is the adress pointing at your destination variable.
<br/>
c is the value you want to write. 
<br/>
n is the number of bytes you want to write starting from the pointer s.
<br/>
<br/>
if you have
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">extern u16 *videobuffer;</td> </tr></table><span class="postbody">
<br/>
then 
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">videobuffer[x]</td> </tr></table><span class="postbody"> is the value stored at the adress (videobuffer + x)
<br/>
videobuffer[x] is equivalent to *(videobuffer + x)
<br/>
<br/>
You can put as an argument in the memset functiun for s :
<br/>
&amp;videobuffer[x] as Tepples said
<br/>
or (videobuffer + x)
<br/>
wich is the adress of the x element of the videobuffer array in both cases.
<br/>
<br/>
Besides, as you may may have guessed, memset copies blocs of bytes(unsigned char = 8bits), and the bus accessing the VRAM on the GBA is 16bit wide.
<br/>
You really should use DMA in 16 or 32 bit for speed improvement, or even  better, a little asm routine(DMA rereads the source for each 16/32bits transfer, making it inaccurate when copying a constant value on a large destination).
<br/>
But memset works fine on devkit, so we can use it.
<br/>
<br/>
Hope this helps Foz</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#6403 - funkeejeffou - Sat May 24, 2003 11:45 am</h4>
    <div class="postbody"><span class="postbody">Just written something wrong up there, I've read too quickly,
<br/>
Maddox, your code cast a u16* to a u16*...
<br/>
useless...
<br/>
but you still give the value of the array as an adress to the memset functiun, so memset will cast by itself a u16 (videobuffer[x...]) to a u16*.
<br/>
So for the example above, you still write at the adress 0x9E...
<br/>
And it is still not the VRAM starting adress...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#6417 - Maddox - Sun May 25, 2003 2:35 am</h4>
    <div class="postbody"><span class="postbody">Oh, yeah.  Put an ampersand in front of mine, too.<br/>_________________<br/>You probably suck.  I hope you're is not a game programmer.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#6440 - Foz - Sun May 25, 2003 6:19 pm</h4>
    <div class="postbody"><span class="postbody">Sorry, I was away for awhile.  Thank you for all the posts.
<br/>
<br/>
funkeejeffou:
<br/>
I was thinking of using DMA but I'm worried about losing input from the player as the CPU will ignore him during the copy (perhaps, I'm wrong on this, but I do know that DMA will take up the CPU cycles).
<br/>
<br/>
I'm going to give the ampersand a try.(I should have tried that)  Maybe I'll get a book on C as Maddox suggested. ;)
<br/>
<br/>
As for assembly, once I get this routine working I can start to see the fruits of my labor as all of my drawing functions are based on it.  Clearly assembly is the way to go here, so when it works I'll only need to plug in an inline assembly routine in order to see a significant speed increase.  What was said about accuracy concerns me though. I'll fiddle around and get back to you.  Thanks again.
<br/>
<br/>
-Foz</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
