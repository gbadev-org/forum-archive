<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>ReDraw every pixel in vblank? - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>Coding > ReDraw every pixel in vblank?</h2>
<div id="posts">
<div class="post">
    <h4>#32427 - QuantumDoja - Wed Dec 22, 2004 7:56 pm</h4>
    <div class="postbody"><span class="postbody">Hi, I was just wondering, if i wanted to change the color of every pixel every vblank, what the fastest way to do it, because when i try, i get crazy black lines moving over my screen, sort of like a refresh.
<br/>
<br/>
Heres a link to my compiled *.gba.......
<br/>
<br/>
<br/>
<a href="http://www.demonasp.co.uk/gba/Main.zip" target="_blank">www.demonasp.co.uk/gba/Main.zip</a>
<br/>
<br/>
<br/>
.....how do people get over this problem so it looks smooth?<br/>_________________<br/>Chris Davis</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#32431 - ScottLininger - Wed Dec 22, 2004 8:31 pm</h4>
    <div class="postbody"><span class="postbody">A few questions before I think we'll be able to answer your question:
<br/>
<br/>
1. What screen mode are you using?
<br/>
<br/>
2. What's your code like? If you can post the key "loop" that's drawing the screen, people might suggest some optimizations
<br/>
<br/>
3. What compiler are you using and what optimization parameters (if any) are you using? You can probably copy and paste your "gcc" line from your make.bat or your makefile options.
<br/>
<br/>
-Scott</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#32432 - DekuTree64 - Wed Dec 22, 2004 8:39 pm</h4>
    <div class="postbody"><span class="postbody">There's not enough time in a VBlank to redraw the entire screen. That's what the backbuffer in mode4 is for, so you can draw to it outside of VBlank, and for as many frames as you need to to get it done before showing anything. 
<br/>
<br/>
It is possible to copy a full solid screen if you draw it line by line from the top down starting at VBlank. You won't actually finish before the screen starts drawing again, but you can get enough of a head start to outrun the displaying scanline so it's all done before it's visible. 
<br/>
The fastest way to get data to the screen is DMA, but that pretty much means having a backbuffer in EWRAM, since it's a straight copy. You'll probably need to do that for mode3, although it's so slow I'd suggest trying to find another way (tile modes preferably, mode4 if it has to be bitmap)
<br/>
<br/>
EDIT: I just checked your demo and it looks like you are using mode4 already. To fix it, just flip flop between the two buffers each frame, waiting for VBlank each time you're finished drawing and ready to swap.<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#32439 - QuantumDoja - Wed Dec 22, 2004 10:02 pm</h4>
    <div class="postbody"><span class="postbody">Hi, Im a bit of a newbie, so I may just be bodging it to make it work, but have a look:
<br/>
<br/>
vars n stuff
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
int MatrixLine[119]; //for x axis: color of first pixel (mode4 240/2)
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
color palette
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
const u16 MatrixPalette[] = {
<br/>
                    0x0000, 0x0101, 0x0202, 0x0303, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
<br/>
                    ....... 0xFFFF,};
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
plot pixel
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
void PlotPixel(int x,int y, unsigned short int c)   
<br/>
{
<br/>
FrontBuffer[(y) *120 + (x)] = (c);
<br/>
}
<br/>
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
draw screen
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
void DrawScreen()
<br/>
{
<br/>
   //drawing entire screen.
<br/>
   int i;
<br/>
   int j;
<br/>
   int tmp;
<br/>
   for (i=0;i&lt;160;i++)
<br/>
   {
<br/>
      for (j=0;j&lt;120;j++)
<br/>
      {
<br/>
         //holds the number location of the color.
<br/>
         tmp = MatrixLine[j];
<br/>
         if (i&gt;0)
<br/>
         {
<br/>
            tmp = tmp + 1;
<br/>
            MatrixLine[j] = tmp;
<br/>
         }
<br/>
         if (tmp &gt; 3)
<br/>
         {
<br/>
            MatrixLine[j] = 0;
<br/>
            tmp = 0;
<br/>
         }
<br/>
         PlotPixel(j,i,BG_PaletteMem[tmp]);
<br/>
      }
<br/>
   }
<br/>
}
<br/>
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
main
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
int main() {
<br/>
<br/>
   SetMode(MODE_4 | BG2_ENABLE);
<br/>
<br/>
   //LOAD PALETTE
<br/>
   int i;
<br/>
   int r;
<br/>
      for (i = 0; i &lt; 256; i++) {
<br/>
         BG_PaletteMem[i]=MatrixPalette[i];
<br/>
      }
<br/>
<br/>
while(1)
<br/>
   {
<br/>
<br/>
      DrawScreen();
<br/>
<br/>
      WaitForVsync();
<br/>
<br/>
   }
<br/>
<br/>
return 0;
<br/>
}
<br/>
</td> </tr></table><span class="postbody"><br/>_________________<br/>Chris Davis</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#32441 - DekuTree64 - Wed Dec 22, 2004 10:21 pm</h4>
    <div class="postbody"><span class="postbody">Yeah, you need to switch which buffer you're drawing to each frame. The first buffer is at address 0x6000000, and the second is 0x600a000. 
<br/>
All you need to do is make your FrontBuffer variable into a pointer and switch which of those addresses it points to each frame, and switch which is visible by flipping bit 4 in DISPCNT. 
<br/>
If the bit is clear, 0x6000000 is displayed, if it's set, you see 0x600a000. Just make sure you're drawing to the one that's NOT visible, and you shouldn't get any breaking at all.<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#32453 - Datch - Thu Dec 23, 2004 1:08 am</h4>
    <div class="postbody"><span class="postbody">Like mentionned previously, you're drawing in the same buffer which render your choice of mode 4 useless.   If you want to keep things this way I would recommend two easy things.  First invert DrawScreen() and WaitForVSync().  Also, I would do a macro with your PlotPixel function or I'd make it "inline".</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#32547 - QuantumDoja - Thu Dec 23, 2004 8:16 pm</h4>
    <div class="postbody"><span class="postbody">Hi, thanks I added the extra buffer and wrote to it alternately and it kinda works well, there is a slight slight flicker, but itll do.
<br/>
<br/>
THanks :-p<br/>_________________<br/>Chris Davis</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#32739 - QuantumDoja - Sat Dec 25, 2004 4:05 pm</h4>
    <div class="postbody"><span class="postbody">Hi, I have added the extra bufer, and now my sprites wont even appear, i am using an emulator to test my game, but no OAM data gets loaded....any ideas???<br/>_________________<br/>Chris Davis</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#32741 - tepples - Sat Dec 25, 2004 5:06 pm</h4>
    <div class="postbody"><span class="postbody">For one thing, when you use a bitmap mode such as mode 4, you need to use only tiles 512-1023 of sprite cel VRAM.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
