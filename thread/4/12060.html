<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>First member of array is messed up - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>Coding > First member of array is messed up</h2>
<div id="posts">
<div class="post">
    <h4>#113901 - sgeos - Mon Jan 01, 2007 12:52 am</h4>
    <div class="postbody"><span class="postbody">I'm working on a PC side test scaffold for some code, and the first member of one of my arrays is messed up.  I have never seen anything like this before.  Could it be a compiler error?
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">CommandAction mList[] =
<br/>
{
<br/>
        {"printme", &amp;print},
<br/>
        DISPATCH_ALIAS(pr, print),
<br/>
        DISPATCH_COMMAND(print),
<br/>
        DISPATCH_ALIAS(q, quit),
<br/>
        DISPATCH_COMMAND(quit),
<br/>
        DISPATCH_ALIAS(set, set),
<br/>
        DISPATCH_COMMAND(var),
<br/>
        LAST_DISPATCH_COMMAND
<br/>
};</td> </tr></table><span class="postbody">
<br/>
The macros just spit out a string and function pointer, like the first line.  The assembler looks fine:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">LC0:
<br/>
        .ascii "printme\0"
<br/>
LC1:
<br/>
        .ascii "pr\0"
<br/>
LC2:
<br/>
        .ascii "print\0"
<br/>
LC3:
<br/>
        .ascii "q\0"
<br/>
LC4:
<br/>
        .ascii "quit\0"
<br/>
LC5:
<br/>
        .ascii "set\0"
<br/>
LC6:
<br/>
        .ascii "var\0"
<br/>
.globl _mList
<br/>
        .data
<br/>
        .align 32
<br/>
_mList:
<br/>
        .long   LC0
<br/>
        .long   _print
<br/>
        .long   LC1
<br/>
        .long   _print
<br/>
        .long   LC2
<br/>
        .long   _print
<br/>
        .long   LC3
<br/>
        .long   _quit
<br/>
        .long   LC4
<br/>
        .long   _quit
<br/>
        .long   LC5
<br/>
        .long   _set
<br/>
        .long   LC6
<br/>
        .long   _var
<br/>
        .long   0
<br/>
        .long   0</td> </tr></table><span class="postbody">
<br/>
A list of string constants followed by the array.  The array members are lined up in memory in a regular fashion, but the location of the first string is odd:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">    Array       Function    String      String
<br/>
0:  0x00403000  0x004015C1  0x0040FC60    &lt;----- Why is it here?!
<br/>
1:  0x00403008  0x004015C1  0x00404038  pr
<br/>
2:  0x00403010  0x004015C1  0x0040403B  print
<br/>
3:  0x00403018  0x0040175A  0x00404041  q
<br/>
4:  0x00403020  0x0040175A  0x00404043  quit
<br/>
5:  0x00403028  0x004016BD  0x00404048  set
<br/>
6:  0x00403030  0x00401620  0x0040404C  var</td> </tr></table><span class="postbody">
<br/>
The function pointers appear to be correct.  The "printme" string is in the binary.  It lives right in front of "pr", where it should be, but address appears to have been botched.
<br/>
<br/>
-Brendan</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#113907 - tepples - Mon Jan 01, 2007 2:14 am</h4>
    <div class="postbody"><span class="postbody">Unless the asm file is putting the strings in the .text segment. In addition, string constants should go in .rodata, not .data, unless you want them copied to RAM.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#113912 - poslundc - Mon Jan 01, 2007 2:40 am</h4>
    <div class="postbody"><span class="postbody">Since mList is in the .data section, it's going to be in RAM next to other non-constant variables.
<br/>
<br/>
At first glance - especially seeing as it's the very first element of your array that's botched - it looks like bad data for some other pointer being written off the end of some adjacent buffer, thereby corrupting your array.
<br/>
<br/>
If you have the ability to place read/write breakpoints on your target, this would be an excellent time to do it.
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#113913 - sgeos - Mon Jan 01, 2007 2:40 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">        .file   "dispatch.c"
<br/>
        .section .rdata,"dr"
<br/>
LC0:
<br/>
        .ascii "printme\0"
<br/>
...</td> </tr></table><span class="postbody">
<br/>
Evidently, the strings live in rdata and the array in data.  This is a PC side tool, but thanks for the advice.  The array should be const.
<br/>
<br/>
-Brendan</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#113922 - sgeos - Mon Jan 01, 2007 4:52 am</h4>
    <div class="postbody"><span class="postbody">I had two variables named mList in different modules.  As soon I made the above list const, the program segfaulted like crazy.  (Something is seriosly wrong when changing something to const segfaults your program.)  This bug was especially confusing because it segfaulted on (what appeared to be) a proper assignment segfault:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">mList = pBuffer;</td> </tr></table><span class="postbody">
<br/>
Really confusing.  (Yes, the types are the same.  Yes, it looks right.  Yes, the types are the same.  Yes, there is memory available.  Yes, the types are the same.  Yes, it is being called correctly.  ...)
<br/>
<br/>
In the future I'll be wary of global variables with the same name.  I could swear that you can have two global variables/functions with the same name as long as they are constrained to module scope.  Then again, something might be exposed somewhere.  And I might just be wrong about items with the same name.
<br/>
<br/>
I'll give my thanks to tepples.  Sub-thanks to Dan (I must have just missed your comment).
<br/>
<br/>
I should probably figure out why things broke as they did, but things (appear) to work now and I want a break.  =P
<br/>
<br/>
Is there any way get gcc to spit out a human readable symbol table?  That would be really nice to have.
<br/>
<br/>
-Brendan</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#113926 - tepples - Mon Jan 01, 2007 6:13 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>sgeos wrote:</b></span></td> </tr> <tr> <td class="quote">Is there any way get gcc to spit out a human readable symbol table?  That would be really nice to have.</td> </tr></table><span class="postbody">
<br/>
arm-eabi-nm -n something.elf<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#113936 - Peter - Mon Jan 01, 2007 1:54 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>sgeos wrote:</b></span></td> </tr> <tr> <td class="quote">In the future I'll be wary of global variables with the same name.  I could swear that you can have two global variables/functions with the same name as long as they are constrained to module scope. </td> </tr></table><span class="postbody">
<br/>
You can use the same names in each compilation unit when the variables/functions are declared as static.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#113962 - sajiimori - Mon Jan 01, 2007 11:03 pm</h4>
    <div class="postbody"><span class="postbody">Is this what happened?
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
// Module1.c
<br/>
const char* const thing[5];
<br/>
</td> </tr></table><span class="postbody">
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
// Module2.c
<br/>
extern int thing;
<br/>
<br/>
void corruptFirstPointer()
<br/>
{
<br/>
  thing = 10;
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
There should be a link error without putting the 'extern'.
<br/>
<br/>
About changing things to const: An x86 application could write-protect const data.  If the 'thing' array was protected in this manner, it could cause a segfault on write.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#113963 - poslundc - Mon Jan 01, 2007 11:12 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>sgeos wrote:</b></span></td> </tr> <tr> <td class="quote">In the future I'll be wary of global variables with the same name.  I could swear that you can have two global variables/functions with the same name as long as they are constrained to module scope.  Then again, something might be exposed somewhere.  And I might just be wrong about items with the same name.</td> </tr></table><span class="postbody">
<br/>
<br/>
In GCC (which I realize you almost definitely aren't using, so the particulars may differ), module-level global variable declarations are by default global to the entire project unless you explicitly declare them as static (which your code snippet did not do).
<br/>
<br/>
But they will also create a linker error if you reuse the same name, so I don't know why you didn't get that happening there.
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#113965 - sgeos - Mon Jan 01, 2007 11:40 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>sajiimori wrote:</b></span></td> </tr> <tr> <td class="quote">Is this what happened?
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">* SNIP *</td> </tr></table><span class="postbody"></span></td> </tr></table><span class="postbody">
<br/>
Close.  This is what happened:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">// variablelist.c
<br/>
Variable *mList;  // pointer to user provided buffer
<br/>
<br/>
// dispatch.c
<br/>
// list of word/action pairs; this became const
<br/>
CommandAction mList[] =
<br/>
{ 
<br/>
        DISPATCH_COMMAND(print), 
<br/>
        DISPATCH_ALIAS(q, quit), 
<br/>
        // ...
<br/>
        LAST_DISPATCH_COMMAND 
<br/>
};</td> </tr></table><span class="postbody">
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>sajiimori wrote:</b></span></td> </tr> <tr> <td class="quote">There should be a link error without putting the 'extern'.</td> </tr></table><span class="postbody">
<br/>
No link error.  Maybe the compiler treated both variables as (const void *) to the array?  I'm not sure.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>sajiimori wrote:</b></span></td> </tr> <tr> <td class="quote">About changing things to const: An x86 application could write-protect const data.  If the 'thing' array was protected in this manner, it could cause a segfault on write.</td> </tr></table><span class="postbody">
<br/>
Yes, but I didn't write to it.  I <span style="font-style: italic">would have</span>, but I didn't get that far.  I tried to change the pointer variable, and it segfaulted on that assignment.  If the compiler thought that was a const variable, I could see that causing problems.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>poslundc wrote:</b></span></td> </tr> <tr> <td class="quote">In GCC (which I realize you almost definitely aren't using, so the particulars may differ),</td> </tr></table><span class="postbody">
<br/>
Actually, I'm using gcc.  =P
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>poslundc wrote:</b></span></td> </tr> <tr> <td class="quote">module-level global variable declarations are by default global to the entire project unless you explicitly declare them as static (which your code snippet did not do).</td> </tr></table><span class="postbody">
<br/>
I'll keep this in mind.  Will this have any adverse effects when porting to other compilers?
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>poslundc wrote:</b></span></td> </tr> <tr> <td class="quote">But they will also create a linker error if you reuse the same name, so I don't know why you didn't get that happening there.</td> </tr></table><span class="postbody">
<br/>
No link error.  gdb reported the buffer pointer as a generic pointer.  I didn't look the table because I didn't segfault that way, and by the time I realized it was the problem I fixed it.  The table may be a generic pointer as well.  This is why I'd like to dump the symbol table- so I can inspect it.
<br/>
<br/>
-Brendan</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#113974 - sajiimori - Tue Jan 02, 2007 1:17 am</h4>
    <div class="postbody"><span class="postbody">I was just reading that GCC, by default, shares memory if you declare a global variable (without extern) twice.  Use -fno-common to disable this (dangerous and obsolete) behavior.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">I tried to change the pointer variable, and it segfaulted on that assignment.</td> </tr></table><span class="postbody">Right -- you didn't declare the mList pointer const, but if it's sharing space with a const array of the same name, then it might be in a read-only section anyway.  x_x
<br/>
<br/>
Edit: Better yet, compile as C++.  This kind of error could only happen in C.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
