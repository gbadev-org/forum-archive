<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>MODE 7 using MODE_2, BG3 with ROTBG_SIZE_256x256 - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>Coding > MODE 7 using MODE_2, BG3 with ROTBG_SIZE_256x256</h2>
<div id="posts">
<div class="post">
    <h4>#22058 - Mr. GBA - Sat Jun 12, 2004 6:08 pm</h4>
    <div class="postbody"><span class="postbody">Hi,
<br/>
<br/>
I'm trying mode 7 using MODE2 with BG 3, ROTBG_SIZE_256x256 &amp; BG_COLOR_256.
<br/>
<br/>
I think I have the correct code placed in the HBLANK interrupt, but I'm not getting the right result. The following code is from the HBLANK interrupt.
<br/>
<br/>
   /* do something */ 
<br/>
	int center_y;   //these are the points around which the the screen rotates
<br/>
	int center_x; 
<br/>
	int tempS = SIN[angle];//some temps to hold the sine cos values so we eliminate all those table acceses
<br/>
	int tempC = COS[angle];//actualy only need to do this once per frame so we could store then in a global
<br/>
							//and calc durring the vblank if we wanted
<br/>
<br/>
	int zoom;
<br/>
<br/>
	zoom = (height*div[REG_VCOUNT])&gt;&gt;16; //div is fixed 16.16 height is fixed 24.8 so I end up with 8.24..
<br/>
											//so I shift away 16 bits to give me a zoom that is fixed 24.8
<br/>
											//you may notice that I still have some distortion at the bottom of the screen
<br/>
											//this can probably be fixed by keeping some of the presision in the 
<br/>
											//value and shifting later
<br/>
<br/>
	center_y = (180 * zoom)&gt;&gt;2;  //set for the center of the screen in the x direction and slightlu
<br/>
	center_x = (120 * zoom)&gt;&gt;2;	//bellow the screen for the Y (about were the observer would be standing)
<br/>
<br/>
	REG_BG3X = (((ScaleX)-center_y*tempS-center_x*tempC))&gt;&gt;14; //x and y are the background scroll factors
<br/>
	REG_BG3Y = (((ScaleY)-center_y*tempC+center_x*tempS))&gt;&gt;14;
<br/>
<br/>
	REG_BG3PA  = (tempC*zoom)&gt;&gt;16;  //cos&amp;sin are LUTs that are .8 fixed numbers
<br/>
	REG_BG3PB  = (tempS*zoom)&gt;&gt;16;  //zoom is also fixed
<br/>
	REG_BG3PC  = (-tempS*zoom)&gt;&gt;16;
<br/>
	REG_BG3PD  = (tempC*zoom)&gt;&gt;16;
<br/>
<br/>
<br/>
The angle variable is incremented and decremented in the keypad functions.
<br/>
<br/>
I would be much obliged if someone could help me figure out how to get mode seven working.
<br/>
<br/>
Thanks.<br/>_________________<br/>my dev/business site:
<br/>
<br/>
<a href="http://codebytesdev.afraid.org" target="_blank">http://codebytesdev.afraid.org</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#22067 - dagamer34 - Sat Jun 12, 2004 10:38 pm</h4>
    <div class="postbody"><span class="postbody">Could you tell us what kind of result you are getting and where you got the code from (it looks familiar)? 
<br/>
<br/>
Try changing this line:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
zoom = (height*div[REG_VCOUNT])&gt;&gt;16; //div is fixed 16.16 height is fixed 24.8 so I end up with 8.24.. 
<br/>
</td> </tr></table><span class="postbody">
<br/>
If my set-up is just like yours, then my Mode7 rotation function works by shifting the final zoom 8 bits instead of 16. Or maybe I'm completely wrong, who knows. If you'd like, I can send you a copy of my Mode 7 example, although it has my library stuff in there which might be a little hard to read.
<br/>
<br/>
Check out Cearn's tutorials over the subject if you need some help. They're on the main site.<br/>_________________<br/>Little kids and Playstation 2's don't mix. :(</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#22079 - Mr. GBA - Sun Jun 13, 2004 12:46 am</h4>
    <div class="postbody"><span class="postbody">The result I get shows the background tiles only in the left hand portion of the screen only. Also the tiled background looks very small, like tiny little dots.
<br/>
<br/>
I've tried right shifting the zoom by 8 instead of 16 and a similar result transpired.
<br/>
<br/>
I would really appreciate it if you (dagamer34) could post your mode 7 code.
<br/>
<br/>
BTW, I got the code from Devoto's mode 7 tut.
<br/>
<br/>
Thanks.<br/>_________________<br/>my dev/business site:
<br/>
<br/>
<a href="http://codebytesdev.afraid.org" target="_blank">http://codebytesdev.afraid.org</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#22082 - Mr. GBA - Sun Jun 13, 2004 2:10 am</h4>
    <div class="postbody"><span class="postbody">OK guys, I'm really stuck and it's 2 AM in the morning.
<br/>
<br/>
I've put my project up on my home server at <a href="http://82.44.76.14/bgcounter.zip" target="_blank">http://82.44.76.14/bgcounter.zip</a>
<br/>
<br/>
Hopefully someone will be able to correct my mode 7 project.
<br/>
<br/>
The project uses gcc (devkitadv).
<br/>
<br/>
Thanks. :)Zzzzzzzzzz<br/>_________________<br/>my dev/business site:
<br/>
<br/>
<a href="http://codebytesdev.afraid.org" target="_blank">http://codebytesdev.afraid.org</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#22088 - dagamer34 - Sun Jun 13, 2004 3:33 am</h4>
    <div class="postbody"><span class="postbody">I have found 1 thing so far and that is none of your registers are declared volatile. There seems to be something else causing the problem though, so I'll keep looking into it.<br/>_________________<br/>Little kids and Playstation 2's don't mix. :(</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#22106 - Cearn - Sun Jun 13, 2004 2:57 pm</h4>
    <div class="postbody"><span class="postbody">With this much bitshifting going on you need to be really careful with where the fixed point is; write down a list of variables and their fixed points and trace where the point goes after each statement. The mode 7 sections on <a class="postlink" href="http://user.chem.tue.nl/jakvijn/tonc/toc.htm" target="_blank">my site</a> should show how to do this as well as other mode 7 niceties (and not so niceties).</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#22109 - Mr. GBA - Sun Jun 13, 2004 3:37 pm</h4>
    <div class="postbody"><span class="postbody">I've got a mode 7 effect, but without using the registers REG_BG3X REG_BG3Y. The background appears to curve to the left. The REG_BG3X &amp; REG_BG3Y registers are used to define the location of the pixel at 0,0 (so Cowbite Spec claims). 
<br/>
Could anyone of you masters tell me a bit more about these registers.
<br/>
<br/>
Thanks.
<br/>
(BTW, I really appreciate the help I've received so far. If I can be of service to anybody, don't hesitate to ask).<br/>_________________<br/>my dev/business site:
<br/>
<br/>
<a href="http://codebytesdev.afraid.org" target="_blank">http://codebytesdev.afraid.org</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#22179 - Cearn - Mon Jun 14, 2004 9:48 am</h4>
    <div class="postbody"><span class="postbody">in bgcounter.cpp
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
    //sine cos LUT
<br/>
    for(int loop = 0; loop &lt; 360; loop++)
<br/>
    {
<br/>
        SIN[loop] = (FIXED)((RADIAN(loop)) * (float)(1&lt;&lt;16));  //sin and cos are computed and cast to fixed
<br/>
        COS[loop] = (FIXED)((RADIAN(loop)) * (float)(1&lt;&lt;16));
<br/>
    }
<br/>
</td> </tr></table><span class="postbody">
<br/>
Dude ... please tell me this was an accident. Lie if you have to. Something like the cat jumped on your keyboard, messed up and quit the editor before you could assess the damage.
<br/>
(if you don't get it take a good hard look at the code)
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
    div[loop] = (FIXED)( (float)( (1&lt;&lt;16)/loop) ); //our fixed point divide table is 8.24 (24 bits of fraction)
<br/>
</td> </tr></table><span class="postbody">
<br/>
This is of course .16 bits fraction (and I wonder what happens when loop=0). With the current set of parentheses the casts to FIXED and float are completely superfluous (not a bug per se, but still wasteful).
<br/>
<br/>
Also, the keyboard and VBlank interrupts won't work with what you have now. I'll explain later.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
REG_IE |= INT_HBLANK |INT_KEYBOARD;   // Enable V-Blank IRQ. 
<br/>
REG_DISPSTAT |= 0x10 |BIT12;    // Enable Display V-Blank IRQ also. 
<br/>
</td> </tr></table><span class="postbody">
<br/>
This does not set the V-blank IRQ. In fact, it doesn't even set the 
<br/>
keyboard IRQ. For the VBlank IRQ, you need to set REG_IE, bit 0 and 
<br/>
REG_DISPSTAT, bit 3. For the keyboard IRQ, you need REG_IE, bit 12 
<br/>
(which is INT_KEYBOARD) and unless I'm mistaken you also need to set REG_P1CNT, bit 14. Try
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
REG_IE |= INT_HBLANK | INT_VBLANK | INT_KEYBOARD;
<br/>
REG_DISPSTAT |= 0x18; // Hblank and Vblank
<br/>
REG_P1CNT |= 1&lt;&lt;14;
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
And to get a nicer looking mode 7, try this:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
    // make sure cc and ss are .8 fixed numbers; 
<br/>
    // do an extra shift if you have to (and preferably outside the isr)
<br/>
    FIXED cc = COS[angle];
<br/>
    FIXED ss = SIN[angle];
<br/>
<br/>
    FIXED lam = (height*DIV[REG_VCOUNT]) &gt;&gt; 8;  // .12
<br/>
    FIXED lcc= lam*cc&gt;&gt;5;             // .15
<br/>
    FIXED lss= lam*ss&gt;&gt;5;             // .15
<br/>
<br/>
    // horizontal scale and offset (convert to .8 in the process)
<br/>
    REG_BG2PA= lcc&gt;&gt;7;
<br/>
    REG_BG2X= pos_x - 120*(lcc&gt;&gt;7) + ((D*lss)&gt;&gt;7);
<br/>
<br/>
    // vertical scale and offset
<br/>
    REG_BG2PC= lss&gt;&gt;7; 
<br/>
    REG_BG2Y= pos_z - 120*(lss&gt;&gt;7) - ((D*lcc)&gt;&gt;7);
<br/>
</td> </tr></table><span class="postbody">
<br/>
Note that you multiply with 120 <span style="font-style: italic">after</span> the down-shift to .8 fixed. This is important. I've also renamed ScaleX and ScaleY to pos_x and pos_z, since they have nothing to do with scaling (left over from earlier code?). D is the focus length; D=128 is standard I believe.
<br/>
Now, if you use this you'll still probably see nothing because you're at the top left corner of the map, looking away from the map try setting pos_x= 128&lt;&lt;8 and pos_z= 256&lt;&lt;8. Or set the WRAP_AROUND flag in REG_BGxCNT, that still won't give you a clue as to where you are on the map if it's symmetrical, but at least you'll see something.</span><span class="gensmall"><br/><br/>Last edited by Cearn on Wed Jun 16, 2004 12:01 pm; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#22191 - Mr. GBA - Mon Jun 14, 2004 2:33 pm</h4>
    <div class="postbody"><span class="postbody">VERY VERY VERY NICE!!! CEARN!!!
<br/>
<br/>
I very much like the look of your suggested mode 7. It's way more realisitc than Dovoto's, which is where I got that dreadful SIN &amp; COS LUT (that somehow works!).
<br/>
<br/>
I'm a semi-perfectionist so, I need to parse every line of code to avoid feeling like a hopeless loser. Please correct me where I am wrong.
<br/>
<br/>
*Variables <span style="font-weight: bold">cc &amp; ss </span>are obviously references to SIN &amp; COS values (which both have the same value in accordance to my screwed up LUT).
<br/>
FIXED cc = COS[angle]; 
<br/>
FIXED ss = SIN[angle]; 
<br/>
<br/>
*Variable <span style="font-weight: bold">lam </span> is the projected Y value that intersects through the projection plane. This will later act as the centre for rotation, I think.
<br/>
FIXED lcc= lam*cc&gt;&gt;5;             // .15 
<br/>
<br/>
*Variable <span style="font-weight: bold">lcc </span> is the value that the background will be sheared towards relative to the top left corner in the x direction.
<br/>
FIXED lcc= lam*cc&gt;&gt;5;             // .15 
<br/>
<br/>
*Variable <span style="font-weight: bold">lss </span> ] is the value that the background will be sheared towards relative to the top left corner in the x direction. Why REG_BG2PA is used twice I'll never know :(.
<br/>
FIXED lss= lam*ss&gt;&gt;5;             // .15 
<br/>
<br/>
*This is where we do the actual rotation.
<br/>
 REG_BG2PA= lcc&gt;&gt;7; 
<br/>
<br/>
* Ok, this is where I get lost because I'm not entirely sure of the purpose of REG_BG2X. Anyway, I think this is where we set the orientation of the X scrolling action. I think we minus the centre of the screen (120)*lcc from pos_x (current position) because this will give us ? and why the hell does D come into it. :(. Please help me understand what is going on here.
<br/>
REG_BG2X= pos_x - 120*(lcc&gt;&gt;7) + ((D*lss)&gt;&gt;7); 
<br/>
REG_BG2Y= pos_z - 120*(lss&gt;&gt;7) - ((D*lcc)&gt;&gt;7); 
<br/>
<br/>
OK then. Ceran, that is all that I can rendition from your mode 7, which must be pretty way off :( I would be much obliged if you could explain to me where I'm going wrong, particularly REG_BG2X &amp; REG_BG2Y.
<br/>
<br/>
BTW, thanks for the keyboard interrupt code (which is the now the least of my worries).
<br/>
<br/>
Thanks in advance.<br/>_________________<br/>my dev/business site:
<br/>
<br/>
<a href="http://codebytesdev.afraid.org" target="_blank">http://codebytesdev.afraid.org</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#22194 - Cearn - Mon Jun 14, 2004 3:03 pm</h4>
    <div class="postbody"><span class="postbody">For code and documentation, 
<br/>
<a class="postlink" href="http://user.chem.tue.nl/jakvijn/tonc/" target="_blank">http://user.chem.tue.nl/jakvijn/tonc/</a>
<br/>
<br/>
lambda is a scaling factor; in principle it's lam=z/D, but in the special case of a pitch-less environment, it's also lam=height/scanline
<br/>
<br/>
variables lcc and lss are simply lam*cosine and lam*sine, respectively. I used temporaries because they're used more than once, that's all.
<br/>
<br/>
REG_BG2PA is used twice because I screwed up in copy-pasting. The second one should be REG_BG2PC. Hey, everyone makes stupid C&amp;P errors occasionally. (EDIT: is fixed now in previously given code). REG_BG2PB and REG_BG2PD are unnecessary because effectively ignored when you're changing REG_BG2DY every scanline. (look it up in <a class="postlink" href="http://www.work.de/nocash/gbatek.htm#lcdiobgrotationscaling" target="_blank">GBATek</a>, internal registers)
<br/>
<br/>
I'm working on a full description of the mode 7 process (with variable pitch, horizon lines, variable pitch), but it'll take some time to get it in a user-friendly form. Well, I suppose that what I have now is user-friendly, it's just particular about who its friends are ;)</span><span class="gensmall"><br/><br/>Last edited by Cearn on Wed Jun 16, 2004 12:02 pm; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#22199 - Mr. GBA - Mon Jun 14, 2004 4:22 pm</h4>
    <div class="postbody"><span class="postbody">Thanks for the explanation.
<br/>
However, there is one matter that needs clearing up. How are REG_BG3X &amp; REG_BG3Y calculated. Could you please tell me if these registers refer to pixel pos 0,0 on the actual screen or if it alternates for each individual scanline.<br/>_________________<br/>my dev/business site:
<br/>
<br/>
<a href="http://codebytesdev.afraid.org" target="_blank">http://codebytesdev.afraid.org</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#22201 - Cearn - Mon Jun 14, 2004 5:06 pm</h4>
    <div class="postbody"><span class="postbody">Without any scaling or rotation, <span style="font-weight: bold">dx</span>= (REG_BGxDX, REG_BGxDY) contain the coordinates (in .8 fixed format) of the map that are put at the origin of the screen. However, when you write to REG_BGxDY in an HBlank, the left of the current line will count as the origin, instead of the top-left of the screen. For example, if you do
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
REG_BG2DY = 0
<br/>
</td> </tr></table><span class="postbody">
<br/>
each scanline, the first line of the map will appear on <span style="font-style: italic">all</span> scanlines.
<br/>
<br/>
As for how you calculate the values of <span style="font-weight: bold">dx</span>, the GBA uses the following equation
<br/>
<span style="font-weight: bold">P ? q</span> = <span style="font-weight: bold">p - dx</span>.
<br/>
where:
<br/>
<span style="font-weight: bold">P</span> the affine matrix (goes into REG_BGxPA-REG_BGxPD)
<br/>
<span style="font-weight: bold">q</span>= (qx, qy) an arbitrary screen point
<br/>
<span style="font-weight: bold">p</span>= (px, py) an arbitrary map point
<br/>
<span style="font-weight: bold">dx</span>= (REG_BGxDX, REG_BGxDY)
<br/>
<br/>
For any given subject, you should try to write down the necessary transformation and then try to cram it into the form of the equation given above. For rotation <span style="font-style: italic">phi</span> around a given point <span style="font-weight: bold">r</span>, that'd simply mean <span style="font-weight: bold">P</span>= <span style="font-weight: bold">R</span>(<span style="font-style: italic">phi</span>) and <span style="font-weight: bold">dx</span>= <span style="font-weight: bold">r - P?r</span>. For mode 7, it's something trickier depending on how your camera is orientated. I've just uploaded a file called <a class="postlink" href="http://user.chem.tue.nl/jakvijn/files/m7theory.zip" target="_blank">m7theory.zip</a>, you could take a look at it, but I warn you that there's a lot of math involved.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#22219 - Mr. GBA - Tue Jun 15, 2004 12:11 am</h4>
    <div class="postbody"><span class="postbody">Thanks alot Cearn. Everything thus far has been understood and now I'm working on a full 360 degree rotation of the backgorund in mode 7. I'm still reading your tutorials, especially .<span style="font-style: italic">mode7 theory</span>.<br/>_________________<br/>my dev/business site:
<br/>
<br/>
<a href="http://codebytesdev.afraid.org" target="_blank">http://codebytesdev.afraid.org</a></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
