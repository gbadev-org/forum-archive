<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Multitasking on GBA - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>Coding > Multitasking on GBA</h2>
<div id="posts">
<div class="post">
    <h4>#37822 - DecayCell - Thu Mar 17, 2005 11:11 am</h4>
    <div class="postbody"><span class="postbody">I'm trying to build a multitasking system on the GBA, but I can't find resources on the net about it -- especially about the assembly context switching part.
<br/>
I've written a test program, but it fails to work and I have absolutely no way to debug it, since GDB drives me through hell on my GNU/Linux box. I'm attaching the relevant assembly code:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">   .section   ".text"
<br/>
   .align
<br/>
   .arm
<br/>
<br/>
   .global _preempt
<br/>
@-------------------------------------------------------------------------------
<br/>
_preempt:
<br/>
@-------------------------------------------------------------------------------
<br/>
   @ Disable interrupts
<br/>
   mov      r0,   #0x4000000
<br/>
   add      r0,r0,#208
<br/>
   mov      r1, #0
<br/>
   strb   r1, [r0]
<br/>
<br/>
   @ Copy BIOS-backuped registers from stack to memory
<br/>
   ldr      r0, =_current_regs
<br/>
   sub      r1, sp, #24
<br/>
   ldr      r2, [r1]
<br/>
   str      r2, [r0]      @ r0
<br/>
   add      r0, r0, #4
<br/>
   add      r1, r1, #4
<br/>
   ldr      r2, [r1]
<br/>
   str      r2, [r0]      @ r1
<br/>
   add      r0, r0, #4
<br/>
   add      r1, r1, #4
<br/>
   ldr      r2, [r1]
<br/>
   str      r2, [r0]      @ r2
<br/>
   add      r0, r0, #4
<br/>
   add      r1, r1, #4
<br/>
   ldr      r2, [r1]
<br/>
   str      r2, [r0]      @ r3
<br/>
   add      r0, r0, #36
<br/>
   add      r1, r1, #4
<br/>
   ldr      r2, [r1]
<br/>
   str      r2, [r0]      @ r12
<br/>
   add      r0, r0, #8
<br/>
   add      r1, r1, #4
<br/>
   ldr      r2, [r1]
<br/>
   str      r2, [r0]      @ lr_irq
<br/>
<br/>
   @ Copy all other general-purpose registers to memory
<br/>
   sub      r0, r0, #40
<br/>
   str      r4, [r0]      @ r4
<br/>
   add      r0, r0, #4
<br/>
   str      r5, [r0]      @ r5
<br/>
   add      r0, r0, #4
<br/>
   str      r6, [r0]      @ r6
<br/>
   add      r0, r0, #4
<br/>
   str      r7, [r0]      @ r7
<br/>
   add      r0, r0, #4
<br/>
   str      r8, [r0]      @ r8
<br/>
   add      r0, r0, #4
<br/>
   str      r9, [r0]      @ r9
<br/>
   add      r0, r0, #4
<br/>
   str      r10, [r0]      @ r10
<br/>
   add      r0, r0, #4
<br/>
   str      r11, [r0]      @ r11
<br/>
<br/>
   @ Switch to System Mode and save sp in memory
<br/>
   add      r0, r0, #8
<br/>
   mov      r1, #0x1f
<br/>
   mrs      r2, cpsr
<br/>
   msr      cpsr, r1
<br/>
   str      sp, [r0]
<br/>
   msr      cpsr, r2
<br/>
<br/>
   @ Copy the saved CPSR to memory
<br/>
   ldr      r0, =_current_cpsr
<br/>
   mrs      r1, spsr
<br/>
   str      r1, [r0]
<br/>
<br/>
   @ Branch to kernel interrupt handler routine
<br/>
   ldr      r0, =handle_intr
<br/>
   bx      r0
<br/>
<br/>
   .global __schedule
<br/>
@-------------------------------------------------------------------------------
<br/>
__schedule:
<br/>
@-------------------------------------------------------------------------------
<br/>
   @ Copy BIOS-backuped registers to stack
<br/>
   ldr      r0, =_current_regs
<br/>
   sub      r1, sp, #24
<br/>
   ldr      r2, [r0]
<br/>
   str      r2, [r1]      @ r0
<br/>
   add      r0, r0, #4
<br/>
   add      r1, r1, #4
<br/>
   ldr      r2, [r0]
<br/>
   str      r2, [r1]      @ r1
<br/>
   add      r0, r0, #4
<br/>
   add      r1, r1, #4
<br/>
   ldr      r2, [r0]
<br/>
   str      r2, [r1]      @ r2
<br/>
   add      r0, r0, #4
<br/>
   add      r1, r1, #4
<br/>
   ldr      r2, [r0]
<br/>
   str      r2, [r1]      @ r3
<br/>
   add      r0, r0, #36
<br/>
   add      r1, r1, #4
<br/>
   ldr      r2, [r0]
<br/>
   str      r2, [r1]      @ r12
<br/>
   add      r0, r0, #8
<br/>
   add      r1, r1, #4
<br/>
   ldr      r2, [r0]
<br/>
   str      r2, [r1]      @ lr_irq
<br/>
<br/>
   @ Copy all other general-purpose registers from memory
<br/>
   sub      r0, r0, #40
<br/>
   ldr      r4, [r0]      @ r4
<br/>
   add      r0, r0, #4
<br/>
   ldr      r5, [r0]      @ r5
<br/>
   add      r0, r0, #4
<br/>
   ldr      r6, [r0]      @ r6
<br/>
   add      r0, r0, #4
<br/>
   ldr      r7, [r0]      @ r7
<br/>
   add      r0, r0, #4
<br/>
   ldr      r8, [r0]      @ r8
<br/>
   add      r0, r0, #4
<br/>
   ldr      r9, [r0]      @ r9
<br/>
   add      r0, r0, #4
<br/>
   ldr      r10, [r0]      @ r10
<br/>
   add      r0, r0, #4
<br/>
   ldr      r11, [r0]      @ r11
<br/>
<br/>
   @ Switch to System Mode and load sp from memory
<br/>
   add      r0, r0, #8
<br/>
   mov      r1, #0x1f
<br/>
   mrs      r2, cpsr
<br/>
   msr      cpsr, r1
<br/>
   ldr      sp, [r0]
<br/>
   msr      cpsr, r2
<br/>
<br/>
   @ Copy saved CPSR back from memory
<br/>
   ldr      r0, =_current_cpsr
<br/>
   ldr      r1, [r0]
<br/>
   msr      spsr, r1
<br/>
<br/>
   @ Enable interrupts
<br/>
   mov      r0,   #0x4000000
<br/>
   add      r0,r0,#208
<br/>
   mov      r1, #1
<br/>
   strb   r1, [r0]
<br/>
<br/>
   @ Return to BIOS routine
<br/>
   bx      lr
<br/>
<br/>
   .align
<br/>
   .pool
<br/>
   .end</td> </tr></table><span class="postbody">
<br/>
Any help would be GREATLY appreciated.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#37825 - Vince - Thu Mar 17, 2005 2:04 pm</h4>
    <div class="postbody"><span class="postbody">Hello,
<br/>
<br/>
As for multitasking/RTOS, I would advise you check eCos sources, the FSF RTOS.  A search on the lists will give you pointers to the GBA port.
<br/>
<br/>
HTH,
<br/>
<br/>
Vince<br/>_________________<br/>Reclaim control of your F2A/F2AU with <a class="postlink" href="http://forum.gbadev.org/viewtopic.php?p=32532" target="_blank">if2a</a> !!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#37833 - Lord Graga - Thu Mar 17, 2005 5:41 pm</h4>
    <div class="postbody"><span class="postbody">This has nothing to do with your problem, but I guess that you would like to know that:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">   str      r2, [r0]
<br/>
   add      r0, r0, #4</td> </tr></table><span class="postbody">
<br/>
Can be shortened down to:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">   str      r2, [r0], #4</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#38018 - sasq - Sun Mar 20, 2005 2:11 pm</h4>
    <div class="postbody"><span class="postbody">I guess we should also tell you about LDMIA and STMDB that lets you save any group of registers with one opcode. Neat eh?</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
