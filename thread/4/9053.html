<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Interrupt Handler Variables - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>Coding > Interrupt Handler Variables</h2>
<div id="posts">
<div class="post">
    <h4>#77223 - CyberSlag5k - Wed Mar 29, 2006 4:40 pm</h4>
    <div class="postbody"><span class="postbody">Quick question, can I pass my Interrupt Handling function a variable? I'd like to pass it the address of my OAM data for use during the actual interrupt. Is it just a simple matter of doing something like this:
<br/>
<br/>
REG_IRQ_HANDLER = myInterruptFunction(&amp;stuff);
<br/>
<br/>
Or must I do something tricky?<br/>_________________<br/><span style="font-style: italic">When you find yourself in the company of a halfling and an ill-tempered Dragon, remember, you do not have to outrun the Dragon... </span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#77228 - Cearn - Wed Mar 29, 2006 5:33 pm</h4>
    <div class="postbody"><span class="postbody">Function arguments rely on passing data of the calling function to the called function (in ARM's case via registers r0-r3 + stack). Hardware interrupts can happen at any point in the code, you never really know what the states of the registers are, so basically no, you can't pass arguments in isr's like you would in normal functions. Well, maybe there is, but that would indeed rely on trickery.
<br/>
<br/>
You could just use a global variable to store that pointer, though.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#77229 - CyberSlag5k - Wed Mar 29, 2006 5:42 pm</h4>
    <div class="postbody"><span class="postbody">You mean like an extern stored in some commonly shared file? I had that thought but was unsure of when exactly it would be defined. before I use it in the one file or not. Or does that not matter, as everything will come together simultaneously at link time?
<br/>
<br/>
What I mean is this:
<br/>
<br/>
//gba.h
<br/>
extern u16* myVar;
<br/>
<br/>
//fileOne.cpp
<br/>
u16* myVar = spritePtr;
<br/>
<br/>
//fileTwo.cpp
<br/>
myVar[0].attribute2 = 0;
<br/>
<br/>
The order I compile everything in has no bearing on when myVar is defined as a pointer to my sprite data, right? So I should be able to do something similar to the above?
<br/>
<br/>
I've never really used extern much, so I'm not 100% sure of the exact mechanics of sharing things between separately compiled objects, but it's fun and interesting to be learning about it now.
<br/>
<br/>
Anyway, thank you for your reply, Cearn. Am I on the right track?<br/>_________________<br/><span style="font-style: italic">When you find yourself in the company of a halfling and an ill-tempered Dragon, remember, you do not have to outrun the Dragon... </span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#77232 - Cearn - Wed Mar 29, 2006 6:09 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>CyberSlag5k wrote:</b></span></td> </tr> <tr> <td class="quote">Am I on the right track?</td> </tr></table><span class="postbody">
<br/>
mmmm ... yes and no. Mostly no. :P Take a step back and think of what you're trying to do. 
<br/>
<br/>
You have a function that should operate on a set of OAM entries. Usually, you use function parameters for this because they're nice and encapsulated, no (or little) side effects, all that jazz. However, because you can't use function parameters in ISRs because you can never be sure when they are actually called, like I said. So you have to use something else.
<br/>
<br/>
In the end, interrupt service routines (ISR) are still functions like any other, and will work like any other even if you weren't using it as an ISR. It'd just be a parameter-less function like many others. Nothing special.
<br/>
<br/>
As you probably know (but overlooked I guess) is what global variables are: they're just variables outside the scope of functions. That's it. You must have used them before as they're everywhere in the tutorials.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>CyberSlag5k wrote:</b></span></td> </tr> <tr> <td class="quote">You mean like an extern stored in some commonly shared file? I had that thought but was unsure of when exactly it would be defined. Before I use it in the one file or not. Or does that not matter, as everything will come together simultaneously at link time?
<br/>
<br/>
What I mean is this:
<br/>
<br/>
//gba.h
<br/>
extern u16* myVar;
<br/>
<br/>
//fileOne.cpp
<br/>
u16* myVar = spritePtr;
<br/>
<br/>
//fileTwo.cpp
<br/>
myVar[0].attribute2 = 0;
<br/>
<br/>
The order I compile everything in has no bearing on when myVar is defined as a pointer to my sprite data, right? So I should be able to do something similar to the above?</td> </tr></table><span class="postbody">
<br/>
Something like that, yes. However, the code above won't work. Because myVar here is a halfword pointer, and halfwords don't have members variables. 
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">//gba.h
<br/>
extern u16* myVar;
<br/>
<br/>
//fileOne.cpp
<br/>
OAMENTRY *myVar = spritePtr; (or whatever you've called the struct for spritePtr).
<br/>
<br/>
//fileTwo.cpp
<br/>
myVar[0].attribute2 = 0;
<br/>
</td> </tr></table><span class="postbody">Actually, scratch that. In all probability, spritePtr already <span style="font-style: italic">is</span> the global variable you need. So there's no need to go further. 
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>CyberSlag5k wrote:</b></span></td> </tr> <tr> <td class="quote">I've never really used extern much, so I'm not 100% sure of the exact mechanics of sharing things between separately compiled objects, but it's fun and interesting to be learning about it now.
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
<a class="postlink" href="http://user.chem.tue.nl/jakvijn/tonc/bitmaps.htm#sec-data" target="_blank">tonc:on data</a> ^_^. Particularly the section on 'Symbols, declarations and definitions'.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#77235 - CyberSlag5k - Wed Mar 29, 2006 6:19 pm</h4>
    <div class="postbody"><span class="postbody">Er..right, myVar should have been declared as one of my OAMInstance data types.
<br/>
<br/>
I have no problem with using a global variable in this instance (you are indeed correct that spritePtr is global in scope), except my ISR is in an entirely different file that is compiled separately. The global variables in my main file have long since gone out of scope by the time I compile the second file. Unless I'm overlooking something?
<br/>
<br/>
So making the appropriate change to myVar's data type, I should be good to go? My big concern there was that for some reason the compiler would look at the myVar[0].attribute2 line <span style="font-style: italic">before</span> the myVar = spritePtr line, but as I think on it that should be moot at link time. That's the part I was confused on, and hope I have straight.
<br/>
<br/>
Thanks again, Cearn!<br/>_________________<br/><span style="font-style: italic">When you find yourself in the company of a halfling and an ill-tempered Dragon, remember, you do not have to outrun the Dragon... </span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#77237 - Cearn - Wed Mar 29, 2006 6:27 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>CyberSlag5k wrote:</b></span></td> </tr> <tr> <td class="quote">Er..right, myVar should have been declared as one of my OAMInstance data types.
<br/>
<br/>
I have no problem with using a global variable in this instance (you are indeed correct that spritePtr is global in scope), except my ISR is in an entirely different file that is compiled separately. The global variables in my main file have long since gone out of scope by the time I compile the second file. Unless I'm overlooking something?
<br/>
<br/>
So making the appropriate change to myVar's data type, I should be good to go?
<br/>
</td> </tr></table><span class="postbody">
<br/>
Think that's pretty much it. Add the right declaration to the ISR file with 'extern' and you should be set. That's exactly what 'extern' is for: make something from one file visible to another file. It basically says to the compiler "something of this name (and type!) exists somewhere else." so that the compiler doesn't have to moan about undeclared identifiers. Of course it should actually <span style="font-style: italic">exist</span> in the project's files -and exist only once!- otherwise the linker will complain.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#77240 - CyberSlag5k - Wed Mar 29, 2006 6:45 pm</h4>
    <div class="postbody"><span class="postbody">Ah, so I can even cut the declaration in gba.h out of the loop and just keep it in main. <span style="font-style: italic">And</span> I can use extern to grab a couple functions from main, too. I've used extern in the past, but never quite as extensively. Very cool stuff.
<br/>
<br/>
Thank you very much, Cearn.<br/>_________________<br/><span style="font-style: italic">When you find yourself in the company of a halfling and an ill-tempered Dragon, remember, you do not have to outrun the Dragon... </span></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#77248 - Miked0801 - Wed Mar 29, 2006 7:32 pm</h4>
    <div class="postbody"><span class="postbody">One more gotcha - anytime you have a variable that is being accessed at both normal and interrupt time, it needs to be declared 'volatile'.  Otherwise, the compiler will "Optimize" your code for you and things will break.
<br/>
<br/>
Example:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
u32 bufferIsFull;
<br/>
<br/>
void interruptVblankFoo()
<br/>
{
<br/>
    // Do Normal Vblank stuff here
<br/>
<br/>
    if(bufferIsFull)
<br/>
    {
<br/>
        bufferIsFull = FALSE;
<br/>
        // Copy buffer info here
<br/>
    }
<br/>
}
<br/>
<br/>
void foo()
<br/>
{
<br/>
    while(bufferIsFull);
<br/>
<br/>
    // Buffer has now been copied via our vblank handler, go ahead and fill it with next tic's info
<br/>
<br/>
    // Buffer fill code
<br/>
    bufferIsFull = TRUE;
<br/>
}
<br/>
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
In the above, if bufferIsFull is not declared volatile, the compiler will optimize the while loop by reading the var once and storing it in a register.  Thus, when the interrupt occurs and the var is cleared, the code won't know.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#77252 - CyberSlag5k - Wed Mar 29, 2006 7:36 pm</h4>
    <div class="postbody"><span class="postbody">Ah yes, I remember reading that somewhere.
<br/>
<br/>
Thanks Mike!<br/>_________________<br/><span style="font-style: italic">When you find yourself in the company of a halfling and an ill-tempered Dragon, remember, you do not have to outrun the Dragon... </span></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
