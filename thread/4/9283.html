<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>fast inv square - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>Coding > fast inv square</h2>
<div id="posts">
<div class="post">
    <h4>#80035 - Ant6n - Tue Apr 18, 2006 4:55 am</h4>
    <div class="postbody"><span class="postbody">stumbled across this thing,
<br/>
pretty cool
<br/>
- it uses newton-rhapson with 1 iteration (!!), and a black magic number with evil bithacking to get first approx to get 3 sigfigs
<br/>
<a href="http://www.codemaestro.com/reviews/review00000105.html" target="_blank">http://www.codemaestro.com/reviews/review00000105.html</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#80092 - tepples - Tue Apr 18, 2006 7:42 pm</h4>
    <div class="postbody"><span class="postbody">The "evil bit hacking" involves floating-point numbers, but the Newton's method that follows may still apply to GBA and Nintendo DS programming.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#80094 - sajiimori - Tue Apr 18, 2006 7:50 pm</h4>
    <div class="postbody"><span class="postbody">Seems like the magic number should apply, too, though encoded in fixed-point format instead of floating point.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">int magicInt = 0x5f3759df;
<br/>
float magicFloat = *(float*)&amp;magicInt;
<br/>
<br/>
// Overflow?Â  Use long long maybe.
<br/>
int magicFx32 = magicFloat * 4096;
<br/>
<br/>
print("The magic fixed-point value is %x\n", magicFx32);
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#80098 - keldon - Tue Apr 18, 2006 7:55 pm</h4>
    <div class="postbody"><span class="postbody">Interesting.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#80128 - kusma - Wed Apr 19, 2006 1:19 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>sajiimori wrote:</b></span></td> </tr> <tr> <td class="quote">Seems like the magic number should apply, too, though encoded in fixed-point format instead of floating point.
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
not at all. the trick depends on a exponent/mantissa solution.
<br/>
<br/>
...and seriously, if you're serious about graphics optimizations and haven't heard about this trick before, well... you're way behind. ;)
<br/>
<br/>
it's a neat hack that has never been really demystified (although some guy wrote a paper attempting to do so, but failed miserably), but as pointed out, not really relevant on gba. besides, you can do quite nice lut-based rsq-routines in fixed point anyway. and again, your square roots are rarely your main bottleneck.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#80130 - gladius - Wed Apr 19, 2006 1:45 am</h4>
    <div class="postbody"><span class="postbody">kusma: Are you talking about <a class="postlink" href="http://www.lomont.org/Math/Papers/2003/InvSqrt.pdf" target="_blank">http://www.lomont.org/Math/Papers/2003/InvSqrt.pdf</a>?  I read that one a while back and it seemed pretty solid to me.  It was written by someone who knows his numerical methods pretty well.
<br/>
<br/>
Dave Eberly also took a crack at explaining the "magic number", and he's a pretty trustworthy source as well :).  His paper is here <a class="postlink" href="http://www.geometrictools.com/Documentation/FastInverseSqrt.pdf" target="_blank">http://www.geometrictools.com/Documentation/FastInverseSqrt.pdf</a>.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#80153 - kusma - Wed Apr 19, 2006 10:03 am</h4>
    <div class="postbody"><span class="postbody">heh, it seems my memory didn't serve me well. both papers seems to do a good job explaining it, tho i still feel some details are left out (like the dangers of carry propagating from the mantissa to the exponent). but then again this might just be me being too stupid to see what is supposed to be obvious.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#80168 - tepples - Wed Apr 19, 2006 1:57 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>kusma wrote:</b></span></td> </tr> <tr> <td class="quote">(like the dangers of carry propagating from the mantissa to the exponent)</td> </tr></table><span class="postbody">
<br/>
This was the "more difficult case" from the first paper.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#80262 - Ant6n - Thu Apr 20, 2006 6:36 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>kusma wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>sajiimori wrote:</b></span></td> </tr> <tr> <td class="quote">Seems like the magic number should apply, too, though encoded in fixed-point format instead of floating point.
<br/>
</td> </tr></table><span class="postbody">
<br/>
...and seriously, if you're serious about graphics optimizations and haven't heard about this trick before, well... you're way behind. ;)
<br/>
...
<br/>
</span></td> </tr></table><span class="postbody">
<br/>
<br/>
gee, I guess if I was serious about that I wouldnt post here, now would I?
<br/>
<br/>
And if I came across that and didnt know about it and thought it was interesting, then chances are somebody else might find it interesting, too. It is interesting to see if people find ways to implenent certain problems that seem completely odd. Maybe it could be an inspiration to find something like that yourself.
<br/>
<br/>
And yes, square roots, especially inverse square roots, can be a bottle neck -  they are not if everything you do is plain 2d ... but I guess you know that.
<br/>
<br/>
anyhoo</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#80394 - kusma - Fri Apr 21, 2006 11:06 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Ant6n wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
gee, I guess if I was serious about that I wouldnt post here, now would I?
<br/>
<br/>
And if I came across that and didnt know about it and thought it was interesting, then chances are somebody else might find it interesting, too. It is interesting to see if people find ways to implenent certain problems that seem completely odd. Maybe it could be an inspiration to find something like that yourself.
<br/>
</td> </tr></table><span class="postbody">
<br/>
Sure, whatever.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Ant6n wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
And yes, square roots, especially inverse square roots, can be a bottle neck -  they are not if everything you do is plain 2d ... but I guess you know that.
<br/>
</td> </tr></table><span class="postbody">
<br/>
If your 3d engine is frame-limited due to square roots, you are doing something very very wrong. first of all, fixed point (as well as floating point, but that is another story on this forum) RSQs can be implemented quite bloody fast using a clz and a look-up table (quite similar to the division trick I've discussed on this forum before). But hey, a good gba-level 3d engine should probably not contain any square nor inverse square roots anyway.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
