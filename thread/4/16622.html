<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>how can i call assembler subroutines from C? - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>Coding > how can i call assembler subroutines from C?</h2>
<div id="posts">
<div class="post">
    <h4>#168357 - moonlightcheese - Fri Apr 24, 2009 6:57 pm</h4>
    <div class="postbody"><span class="postbody">i've tried asking at OSdev.org and there appears to be a problem with the assembler in devKitPro...  here's the code.
<br/>
<br/>
load.s</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">.global load
<br/>
<br/>
load:
<br/>
   mov      r0, #5
<br/>
   ret</td> </tr></table><span class="postbody">
<br/>
load.h</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">extern short load(short address);</td> </tr></table><span class="postbody">
<br/>
<br/>
ret is a pretty common instruction, but dkp apparently doesn't like it:
<br/>
c:/public/projects/CS3243_os_proj/elf_load/elf_v.02/source/load.s:8: Error: bad instruction `ret'
<br/>
make[1]: *** [load.o] Error 1
<br/>
make: *** [build] Error 2
<br/>
<br/>
so i tried this instruction to return
<br/>
<br/>
mov  pc, lr
<br/>
<br/>
and this doesn't work either.  execution simply halts.  it doesn't seem like it should be this difficult just to call an assembly subroutine and return a value to C... what am i doing wrong?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#168358 - Mighty Max - Fri Apr 24, 2009 7:23 pm</h4>
    <div class="postbody"><span class="postbody">try BX lr<br/>_________________<br/><a class="postlink" href="http://mightymax.org/gbamp_multiboot.html" target="_blank">GBAMP Multiboot</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#168359 - moonlightcheese - Fri Apr 24, 2009 7:31 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Mighty Max wrote:</b></span></td> </tr> <tr> <td class="quote">try BX lr</td> </tr></table><span class="postbody">
<br/>
i should have posted here first... you guys always have the answers lol.
<br/>
<br/>
thanks!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#168363 - Ruben - Sat Apr 25, 2009 2:14 am</h4>
    <div class="postbody"><span class="postbody">And just to give you a minor explanation as to why mov pc, lr won't work..
<br/>
<br/>
My guess is that you called ARM from THUMB or vice-versa. Simply doing mov pc, lr means that it will try to load its next opcode from foo+1, which is not aligned which stuffs it up. Using BX LR will take care of that.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#168364 - Dwedit - Sat Apr 25, 2009 2:32 am</h4>
    <div class="postbody"><span class="postbody">Well, that and RET is not on the ARM or THUMB instruction set.<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
