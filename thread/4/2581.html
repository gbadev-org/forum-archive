<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Interrupt Problem: Nonfunctional on Hardware. - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>Coding > Interrupt Problem: Nonfunctional on Hardware.</h2>
<div id="posts">
<div class="post">
    <h4>#14201 - Lord Graga - Thu Jan 01, 2004 11:30 pm</h4>
    <div class="postbody"><span class="postbody">Hey all!
<br/>
<br/>
It's a long time since I posted a problem, since I have been working with things that I was pretty routinated with (mode 0, sprites, etc).
<br/>
<br/>
Anyways, today I decided to duel a bit with interrupts, and finaly: It worked!
<br/>
<br/>
But not on real hardware :(
<br/>
<br/>
I'm trying to do HBlank.
<br/>
<br/>
<br/>
<span style="font-weight: bold">CODE CHANGED, SEE LATEST CODE FURTHER DOWN!</span>
<br/>
<br/>
<br/>
If anyone could  point out what's wrong I would be very happy.</span><span class="gensmall"><br/><br/>Last edited by Lord Graga on Fri Jan 02, 2004 6:00 pm; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#14202 - poslundc - Fri Jan 02, 2004 12:34 am</h4>
    <div class="postbody"><span class="postbody">Hm...
<br/>
<br/>
Well, right off the bat I notice that you are using hofs_counter in your enabled ISR without having initialized its value (which doesn't happen until you get into the main loop). Emulators automatically zero variables on declaration, but you may get garbage data on hardware before your variables have been initialized.
<br/>
<br/>
It might help if you told us what happened when you try to run it on hardware, versus what you get in emulation.
<br/>
<br/>
(Also, I notice from a logical standpoint you are using a u8 to store your hofs_counter but then comparing it to 360 in your ISR, which is outside the range of a u8 (0-255). So something is not kosher there. And this doesn't necessarily invalidate what I said above: your program might still be trying to access illegal values of your sin/cos table because the compiler is going to pad your global u8's to u32's anyway.)
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#14203 - poslundc - Fri Jan 02, 2004 12:43 am</h4>
    <div class="postbody"><span class="postbody">Also... it's unlikely to be a problem since your ISR is so short, but you really should be compiling it as ARM code and putting it in IWRAM (versus Thumb/ROM which is the default).
<br/>
<br/>
Depending on what exactly happens when you try to run it on hardware, it could be symptomatic of your ISR taking too long. It might still work on emulation because the emulator doesn't correctly handle waitstates for ROM access, so it takes fewer cycles than it does on hardware. I ran into this problem when my HBlank ISR was taking too long on hardware (I was actually compiling it as ARM but putting it in ROM - which is about as silly as it gets - but it still worked just fine in emulation).
<br/>
<br/>
Again, more details about what goes wrong when you try it on hardware might help.
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#14204 - sajiimori - Fri Jan 02, 2004 12:57 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
Well, right off the bat I notice that you are using hofs_counter in your enabled ISR without having initialized its value (which doesn't happen until you get into the main loop). Emulators automatically zero variables on declaration, but you may get garbage data on hardware before your variables have been initialized.
<br/>
</td> </tr></table><span class="postbody">
<br/>
Globals will automatically be initialized to 0 during startup, as per the ANSI C spec.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
REG_IF &amp;= ~1;
<br/>
</td> </tr></table><span class="postbody">
<br/>
Quoth GBATEK:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
Interrupts must be manually acknowledged by writing a "1" to one of the IRQ bits, the IRQ bit will then be cleared.
<br/>
</td> </tr></table><span class="postbody">
<br/>
So, REG_IF = 1.
<br/>
<br/>
Dan is right about u8's.  In fact, using anything other than int might be considered premature optimization.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#14208 - Lord Graga - Fri Jan 02, 2004 2:13 am</h4>
    <div class="postbody"><span class="postbody">Thanks all, for pointing it out for me.
<br/>
I did some small changes in the code according to your ideas/etc.
<br/>
<br/>
CODE CHANGED, SEE LATEST CODE FURTHER DOWN!
<br/>
<br/>
The most major change is the flags. Setting it to anything but it's old value makes the code kinda jaggy.
<br/>
<br/>
I did somethings to test it on GBA (currently only multiboot), and I found out that the GBA wasn't freezing, it simply didn't proceed the interupts (is it one of two r's?).</span><span class="gensmall"><br/><br/>Last edited by Lord Graga on Fri Jan 02, 2004 5:59 pm; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#14216 - pbmtp - Fri Jan 02, 2004 12:41 pm</h4>
    <div class="postbody"><span class="postbody">you should also declare u32 hofs_counter; and u32 vofs_counter; as volatile otherwise the C compiler will try to optimise and not force a reload of this var when reusing them (as this var are modified under Interrupt they should be declraed volatile).
<br/>
<br/>
I am using the code decribed by tepples in this post and it is working on real hardware 
<br/>
<a class="postlink" href="http://forum.gbadev.org/viewtopic.php?t=2019&amp;highlight=interrupt" target="_blank">http://forum.gbadev.org/viewtopic.php?t=2019&amp;highlight=interrupt</a>
<br/>
<br/>
hope this help</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#14220 - Lord Graga - Fri Jan 02, 2004 5:58 pm</h4>
    <div class="postbody"><span class="postbody">I tried to change it according to Tepples  instructions, but still no luck:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#include "lib/lglib.h"
<br/>
#include "sincos.h"
<br/>
#define BIOS_IF (*(u32*)0x03FFFFF8)
<br/>
#define SPEED 2
<br/>
int i;
<br/>
volatile u32 hofs_counter;
<br/>
volatile u32 vofs_counter;
<br/>
void Intr_Hblank(void)
<br/>
{
<br/>
   unsigned int flags = REG_IF;
<br/>
   hofs_counter+=SPEED;
<br/>
   if(hofs_counter==360) hofs_counter = 0;
<br/>
   REG_BG0HOFS = Sin[hofs_counter]&gt;&gt;5;
<br/>
   REG_BG0VOFS = Cos[hofs_counter]&gt;&gt;5;
<br/>
   REG_IF = flags;
<br/>
   BIOS_IF |= flags;
<br/>
   REG_IME = 1;
<br/>
}
<br/>
<br/>
void AGBMain()
<br/>
{
<br/>
   int n;
<br/>
   SET_MODE(MODE_0|BG0_ENABLE);
<br/>
   REG_BG0CNT = BG_COLOR_256|SCREEN_MEM(24);
<br/>
   for(i=0;i&lt;32;i++) CharMem0[i+32] = 0x0101;
<br/>
   BGPaletteMem[1] = 0xFFFF;
<br/>
   BGPaletteMem[2] = 10|10&lt;&lt;5|10&lt;&lt;10;
<br/>
   for(n=0;n&lt;32;n++)   for(i=0;i&lt;32;i+=2) ScreenMem24[i+n*32+n%2] = 1;
<br/>
<br/>
   REG_IME = 0;
<br/>
   *(u32 *)0x03FFFFFC = (u32)Intr_Hblank;
<br/>
   REG_DISPSTAT = 1&lt;&lt;4;
<br/>
   REG_IE = 1&lt;&lt;1;
<br/>
   REG_IME = 1;
<br/>
<br/>
   while(1)
<br/>
   {
<br/>
      WaitForVSync();
<br/>
      vofs_counter+=SPEED;
<br/>
      if(vofs_counter==360) vofs_counter = 0;
<br/>
      hofs_counter = vofs_counter;
<br/>
   }
<br/>
}</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#14884 - sasq - Wed Jan 14, 2004 10:09 am</h4>
    <div class="postbody"><span class="postbody">Why do you write to IME in the irq, and why to 0300FFF8?
<br/>
<br/>
If you dont need to handle nesting irqs, you can simply do this in your irq-routine:
<br/>
SETW(REG_IF, 0xFFFF);
<br/>
<br/>
and nothing else, it should work fine.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#14927 - tepples - Wed Jan 14, 2004 8:35 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>sasq wrote:</b></span></td> </tr> <tr> <td class="quote">Why do you write to IME in the irq</td> </tr></table><span class="postbody">
<br/>
What, if anything, does the BIOS do with IME when an interrupt occurs?
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">and why to 0300FFF8?</td> </tr></table><span class="postbody">
<br/>
Write to 0x0300FFF8 (or 0x03007FF8 or 0x03FFFFF8) so that BIOS IntrWait() can keep up. Many programs use IntrWait() to use less batteries, and IntrWait() requires that the ISR 'or' the contents of IF into its global variable.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">SETW(REG_IF, 0xFFFF);</td> </tr></table><span class="postbody">
<br/>
But then you'll miss a second IRQ that occurs between reading IF and writing IF. Best is to write what you initially read from IF back to IF.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#14928 - Lord Graga - Wed Jan 14, 2004 8:37 pm</h4>
    <div class="postbody"><span class="postbody">Thanks, all, you have been very helpfull.
<br/>
<br/>
I finaly managed to get it to work :D</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
