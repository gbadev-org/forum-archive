<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Metroid Fusion - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>Coding > Metroid Fusion</h2>
<div id="posts">
<div class="post">
    <h4>#7889 - NovusAmor - Fri Jun 27, 2003 1:26 pm</h4>
    <div class="postbody"><span class="postbody">Does anyone know how they did the wavy water effect in Sector 4. If you go under water and look at the bottom layer the image sways back and forth. Are they using HBlank to achieve it? If so, do they scroll the layer back and forth each HBlank?<br/>_________________<br/>Robert
<br/>
Senior Programmer
<br/>
NeoPong Software, Inc
<br/>
<a href="http://www.neopong.com" target="_blank">www.neopong.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#7894 - tepples - Fri Jun 27, 2003 6:07 pm</h4>
    <div class="postbody"><span class="postbody">Effects like this in <span style="font-style: italic">Donkey Kong Country</span> are done with hblank DMA to the scroll registers, possibly with a vcount interrupt to switch palettes.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#7942 - NitroSR - Sun Jun 29, 2003 3:00 am</h4>
    <div class="postbody"><span class="postbody">I've been toying with this effect myself.  I quickly put together a simple scroller that will allow me to scroll across arbitrarily sized maps at any speed on a 256x256 map, and I figured I could have some fun with HBLANK effects.
<br/>
<br/>
Using the interrupt table method, I wrote an HBLANK handler that does as follows.  Using a sine table, counter variable, and the current X/Y coordinates, I write the following to my chosen layer's horizontal offset register.
<br/>
<br/>
<br/>
void HBLANK(void) {
<br/>
<br/>
REG_BG0HOFS = cur_x + (SIN(g_tempangle) &gt;&gt; g_damplitude);    
<br/>
g_tempangle += g_frequency;
<br/>
<br/>
REG_IF = INT_HBLANK;
<br/>
<br/>
} // ends HBLANK interrupt handler
<br/>
<br/>
Now, there's a reason why I have a variable called g_tempangle.  If you keep the code as-is, the first frame will skew each line according to the sine wave.   But in the next frame, g_tempangle will have been incremented by (g_frequency * 160), causing the wave to move too rapidly, so you need another variable that stores the angle where the wave should start at the top of the screen.  So, every V_BLANK you should update a variable called g_angle by a constant amount, and then copy this new value into g_tempangle.  I use a sine table with an range of -256 to 256 and 256 angles, so by shifting right by some constant I can reduce the amplitude of the sign wave to some desired power of 2.  Essentially, the higher g_frequency the tighter the wave, the higher g_damplitude the less the wave will cause distortion.
<br/>
<br/>
Experiment with the variables, and also try applying the same trick to the V_OFFSET registers... Trust me, you won't be disapointed.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
