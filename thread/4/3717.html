<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Multiplayer - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>Coding > Multiplayer</h2>
<div id="posts">
<div class="post">
    <h4>#23515 - ProblemBaby - Wed Jul 14, 2004 3:43 pm</h4>
    <div class="postbody"><span class="postbody">Ive made working Multiplayer code.
<br/>
But ive still some problems with the delay to send the data
<br/>
It is very Important that the data is recieved in same Frame in borh GBAs
<br/>
if I use a timer as ive seen many does the data often is recieved in Frame x+1
<br/>
<br/>
Now Ive put a little Delay in the MultiPlayerUpdate code
<br/>
But maybe it exist a better way to do this or maybe not
<br/>
well if not does it exist a formula to know how many cycles to wait
<br/>
that depends on the baudrate, number of gbas connected and number of packets</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#23522 - tepples - Wed Jul 14, 2004 5:13 pm</h4>
    <div class="postbody"><span class="postbody">Multiple GBAs will often drift out of sync because every GBA's clock crystal vibrates at a slightly different rate. You have to send a sequential frame number (of about 4 bits) with the input reflection or world reflection packets so that the GBAs that fall behind can wait a frame to catch up.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#23526 - ProblemBaby - Wed Jul 14, 2004 5:34 pm</h4>
    <div class="postbody"><span class="postbody">In my case it is input.
<br/>
as I said its very important that it is recieved in same Frame or else the whole game will flip out..
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
u8 n;
<br/>
<br/>
   REG_SIOMLT_SEND = OutData;
<br/>
<br/>
   if (g_MultiPlayerData.Identifier == 0)
<br/>
      REG_SIOCNT |= SIOCNT_ACTIVE;
<br/>
<br/>
   DelayCycles(921000); // I dont like this
<br/>
<br/>
   if (!(REG_SIOCNT &amp; SIOCNT_ERROR))
<br/>
   {
<br/>
      for (n = 0; n &lt; g_MultiPlayerData.PlayerCount; n++)
<br/>
      g_MultiPlayerData.Data[n] = REG_SIOMULTI[n];
<br/>
   }
<br/>
   else
<br/>
   {
<br/>
      for (n = 0; n &lt; g_MultiPlayerData.PlayerCount; n++)
<br/>
         g_MultiPlayerData.Data[n] = 0;
<br/>
      return 0;
<br/>
   }
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
This is my function for updating data it works very good but I think
<br/>
that the procedure to recieve doesnt take that much cycles.
<br/>
Now this works fine because it isnt much else in the program, but later....
<br/>
<br/>
It will take a lot of time to find a good value. Because I ve to flash it to my FlashCart every time to see if it works.
<br/>
<br/>
I dont want to use interrupts because the data will be recieved to late
<br/>
<br/>
So maybe it exist a formula to find it out and then I can add some extra cycles because of the sunc problems you told me about</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#23534 - col - Wed Jul 14, 2004 7:59 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tepples wrote:</b></span></td> </tr> <tr> <td class="quote">Multiple GBAs will often drift out of sync because every GBA's clock crystal vibrates at a slightly different rate. You have to send a sequential frame number (of about 4 bits) with the input reflection or world reflection packets so that the GBAs that fall behind can wait a frame to catch up.</td> </tr></table><span class="postbody">
<br/>
<br/>
<br/>
I am interested to know if you have implemented a successful version of this  approach, and what the behaviour was at the 'boundary' point where the lag occurs.
<br/>
<br/>
ProblemBaby (and tepples), 
<br/>
Are you talking about a system where each unit sends its keypad info to the others.?
<br/>
Or one where the slaves all sent their keypads and the master broadcasts game state information?
<br/>
<br/>
cheers
<br/>
<br/>
Col</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#23552 - ProblemBaby - Thu Jul 15, 2004 1:59 am</h4>
    <div class="postbody"><span class="postbody">Well iam talking about a system that sends the keystate
<br/>
and then every thing is processed in each gameboy</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#23553 - ProblemBaby - Thu Jul 15, 2004 2:30 am</h4>
    <div class="postbody"><span class="postbody">And oh Ive downloaded no$gba and in the options it is possible to set MultiPlayer settings but nothing doesnt work isnt it implemented or am I doing something wrong do I need something extra or what is the problem..
<br/>
<br/>
my settings is:
<br/>
Multiboot port: none/disabled
<br/>
Multiboot Normal/burst delays: Medium/medium (stable)
<br/>
Number of GBAs emulated: 2
<br/>
Link Gamepaks: Master only (single gamepak)
<br/>
Link cable type: Multiplayer (four players) // becuase it is what i got</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#23599 - ProblemBaby - Fri Jul 16, 2004 12:42 am</h4>
    <div class="postbody"><span class="postbody">It seems like that no$gba doesnt support MultiBoot
<br/>
but if I skip the MultiBoot-code and choose 2gbas it works
<br/>
but not like in hardware, no delays =/
<br/>
<br/>
Well about my question ive tried do a while to wait for the SIOCNT to be unactive and then run the Recieve code i got good frame rate
<br/>
but I doesnt work perfect...
<br/>
Maybe I cant do the same for both the Master and Slave
<br/>
do anyone now something abot this what happens in the Master and Slaves when the transfer is done and ready to be recieved..
<br/>
<br/>
Thanks</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#23618 - caitsith2 - Fri Jul 16, 2004 8:10 am</h4>
    <div class="postbody"><span class="postbody">Actually, no$gba does handle multiboot without the bios, just the routine for that is not perfect,  and seems to only work with games written with the official library at the moment.  I have tried however, using multiboot, with the bios, and it seems to work fine, providing that you tell no$gba to use the nintendo logo as the entry point, and not the direct rom access.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#23626 - ProblemBaby - Fri Jul 16, 2004 12:27 pm</h4>
    <div class="postbody"><span class="postbody">My screen is just white if I choose to start from the nintedo logo</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#23634 - Miked0801 - Fri Jul 16, 2004 5:45 pm</h4>
    <div class="postbody"><span class="postbody">All the more reason to try to setup an error reporting system on this forum :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#23648 - ProblemBaby - Sat Jul 17, 2004 1:13 am</h4>
    <div class="postbody"><span class="postbody">Iam also wondering what the swi 0x25 really does
<br/>
do someone know a site where I can find information how do my own.
<br/>
Because I dont want to have my game twice in the cartridge and I want to be able to send different data.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#23649 - mymateo - Sat Jul 17, 2004 1:50 am</h4>
    <div class="postbody"><span class="postbody">I'm way in over my head when it comes to multiplayer or ASM programming and the like, but sometimes I can be creative so I might be able to help.
<br/>
<br/>
What if each frame, you generated a checksum, or counted each frame sequentially.  Each GBA listens for comms from the other GBA(s).  When a GBA is done everything it needs to for a frame, it sends a "finished" code (defined by you) accompanied with the frame's checksum/serial number.  Then it waits until it has received a "finished" code with a matching number from all other GBA's.  Then, each GBA shares it's key data, and proceeds to process the next frame.  Since each GBA runs at almost the exact same speed, there should be extremely little delay, you could even save some overhead by reading the key data from other GBA's every 2 (or possibly 3) frames ('cause most people can't selectively push 20 to 30 buttons every second... by selectively I mean that pretty much everyone can wildly mash all the buttons and manage it, but they couldn't puch buttons that fast in a controlled manner to acheive a goal... heh).
<br/>
<br/>
So like I said, I'm in over my head in the technicl aspect, so I don't know if this is a theoretically sound solution, but maybe it'll help.  I hope it will.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#23655 - tepples - Sat Jul 17, 2004 6:26 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>mymateo wrote:</b></span></td> </tr> <tr> <td class="quote">Since each GBA runs at almost the exact same speed, there should be extremely little delay, you could even save some overhead by reading the key data from other GBA's every 2 (or possibly 3) frames ('cause most people can't selectively push 20 to 30 buttons every second... by selectively I mean that pretty much everyone can wildly mash all the buttons and manage it, but they couldn't puch buttons that fast in a controlled manner to acheive a goal... heh).</td> </tr></table><span class="postbody">
<br/>
You'd be surprised at how fast a fighting game veteran can pull off a <span style="font-style: italic">Street Fighter II</span> fireball or dragon-punch move.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#23729 - ScottLininger - Mon Jul 19, 2004 7:51 pm</h4>
    <div class="postbody"><span class="postbody">ProblemBaby,
<br/>
<br/>
You may be way past me already, but if you're interested I have some stable multiboot/multiplayer code on my site: <a href="http://www.thingker.com" target="_blank">http://www.thingker.com</a>
<br/>
<br/>
The code works by exchanging arbitrary STRUCTs every frame between all of the connected GBAs, so you could exchange your keypress state pretty easily... Each of your slave STRUCTS would contain a single INT that you dump the keystate into before transfer, while the master's STRUCT would contain all of the other game state variables that the slaves would need to display the game correctly.
<br/>
<br/>
The only problem with the code is that it's slower than the SGADE implementation because it checks that every single byte was transferred successfully, rather than using a CHECKSUM to confirm whole blocks of data. However, it's been speedy enough to run a multiplayer pong game and to exchange long strings for a text-based murder mystery game I was working on. 
<br/>
<br/>
I'd be happy to send you the Pong sourcecode if that would help.
<br/>
<br/>
Scott</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#23824 - ProblemBaby - Thu Jul 22, 2004 11:25 am</h4>
    <div class="postbody"><span class="postbody">Thanks for all replies!
<br/>
Ive solved almost everything. Instead of the Delay I wait until the bus isnt active anymore and then also send a little counter and check that they are equal at both GBAs.
<br/>
<br/>
thanks everyone!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#23838 - col - Thu Jul 22, 2004 7:27 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>ProblemBaby wrote:</b></span></td> </tr> <tr> <td class="quote">Thanks for all replies!
<br/>
Ive solved almost everything. Instead of the Delay I wait until the bus isnt active anymore and then also send a little counter and check that they are equal at both GBAs.
<br/>
<br/>
thanks everyone!</td> </tr></table><span class="postbody">
<br/>
<br/>
Checking if the units have the same frame tick value isn't the difficult part.
<br/>
The real trick is what you do when they are out of sync - that's the part that causes the trouble.
<br/>
<br/>
What is your plan for that situation?
<br/>
<br/>
cheers
<br/>
<br/>
Col</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#23842 - ProblemBaby - Thu Jul 22, 2004 10:04 pm</h4>
    <div class="postbody"><span class="postbody">Well it doesnt happend... my GBAs seems to be very synchronized.
<br/>
But if it happens The GBA that is out if vsync will keep send the counter
<br/>
and then wait until the counter is equal again without handle the other stuff.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
