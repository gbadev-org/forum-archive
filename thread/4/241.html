<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Division - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>Coding > Division</h2>
<div id="posts">
<div class="post">
    <h4>#1451 - draigan - Sun Jan 19, 2003 12:35 am</h4>
    <div class="postbody"><span class="postbody">I'm trying to do a division in some of my code (I'm simply using the division operator).  If I put the division in my 'normal' code, it compiles and links fine.  But if I put the division inside code that's inside IWRam, then I get this error:
<br/>
<br/>
<span style="font-weight: bold">test.o(.iwram+0x80): undefined reference to '__divsi3'</span>
<br/>
<br/>
So a couple of questions:
<br/>
1) How to make it so that it recognizes the divide in iwram
<br/>
2) How to do a bios divide and call it from iwram
<br/>
<br/>
Thanks.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#1592 - draigan - Mon Jan 20, 2003 4:37 pm</h4>
    <div class="postbody"><span class="postbody">anyone?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#1595 - Splam - Mon Jan 20, 2003 5:10 pm</h4>
    <div class="postbody"><span class="postbody">Not sure about this one, I've never used / in C whilst coding GBA stuff, it's just toooo slow.
<br/>
<br/>
Try this..
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
void FastIntDivide (s32 Numer, s32 Denom, s32 *Result, s32 *Remainder)
<br/>
   {
<br/>
   asm volatile
<br/>
      (
<br/>
      " mov   r0,%2   \n"
<br/>
      " mov   r1,%3   \n"
<br/>
      " swi   6       \n"   //NOTE!!!!! Put 6 here for Thumb C Compiler mode.
<br/>
      " ldr   r2,%0   \n"   //          Put 0x60000 there for ARM C Compiler mode.
<br/>
      " str   r0,[r2] \n"
<br/>
      " ldr   r2,%1   \n"
<br/>
      " str   r1,[r2] \n"
<br/>
      : "=m" (Result), "=m" (Remainder) // Outputs
<br/>
      : "r" (Numer), "r" (Denom)        // Inputs
<br/>
      : "r0","r1","r2","r3"             // Regs crushed &amp; smushed
<br/>
      );
<br/>
   }
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Found it on a site somewhere (google is a good thing btw hehe), not sure if it works because I've never used it, all my "fast" code is in asm anyway.  Note though the swi call and the difference between arm and thumb mode calling.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#1599 - Vortex - Mon Jan 20, 2003 5:21 pm</h4>
    <div class="postbody"><span class="postbody">According to <a href="http://www.devrs.com/gba/files/gbadevfaqs.php#IncLibgcc" target="_blank">http://www.devrs.com/gba/files/gbadevfaqs.php#IncLibgcc</a>
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
I get an "undefined reference" to one of these: __divsi3,__modsi3,__udivsi3,__umodsi3. Why?
<br/>
<br/>
<br/>
The library libgcc.a is either not getting properly linked with your project or it is an incorrect version.
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#1605 - tepples - Mon Jan 20, 2003 6:21 pm</h4>
    <div class="postbody"><span class="postbody">Here's the fastest divide code on the GBA.  It's potentially faster than the inline assembly fragment above because it doesn't have to put values in memory to get around GCC's lack of support for declaring inline asm registers.  Put it in a file with extension .s
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
@ int dv(int num, int den)
<br/>
@ Divide two signed integers.
<br/>
<br/>
.THUMB
<br/>
.THUMB_FUNC
<br/>
.ALIGN
<br/>
.GLOBL  dv
<br/>
<br/>
dv:
<br/>
  cmp r1, #0
<br/>
  beq 0f
<br/>
  swi 6
<br/>
  bx lr
<br/>
0:
<br/>
  ldr r0, =0x7fffffff
<br/>
  bx lr
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Then put the following in your C program's header file:
<br/>
int dv(int num, int den);<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#1627 - Splam - Mon Jan 20, 2003 8:47 pm</h4>
    <div class="postbody"><span class="postbody">Personally I'd take out the div by zero check, if you're stupid enough to send the wrong values to it then you deserve a crash ;)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#1632 - ampz - Mon Jan 20, 2003 9:08 pm</h4>
    <div class="postbody"><span class="postbody">Many divisions can be substituted by a multiplication and a bitshift.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#1634 - tepples - Mon Jan 20, 2003 9:24 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Splam wrote:</b></span></td> </tr> <tr> <td class="quote">Personally I'd take out the div by zero check, if you're stupid enough to send the wrong values to it then you deserve a crash ;)</td> </tr></table><span class="postbody">
<br/>
I put in the 1/0=Inf rule from projective geometry because when I used this function in the projection for my game's floor, it divided by zero whenever the camera tilted high enough to put the horizon on screen.  Of course, it'd be easy to take it out.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#1747 - krozen - Wed Jan 22, 2003 2:53 pm</h4>
    <div class="postbody"><span class="postbody">Hello,
<br/>
I was just wondering how you would use that fast division within your C code. I've tried following an example I seen, and I cant seem to do it. I also tried putting it in a .s fil, but cannot include it properly. Somebody help me!!!!
<br/>
Thank you</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#1749 - col - Wed Jan 22, 2003 3:53 pm</h4>
    <div class="postbody"><span class="postbody">Does anyone actually know how fast the bios divide really is - its all very well finding the quickest method to call it, but if it's not a fast algorithm whats the point?
<br/>
<br/>
So roughly how many cycles for the worst case? (excluding calling overhead)
<br/>
<br/>
cheers
<br/>
<br/>
col.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#1761 - ampz - Wed Jan 22, 2003 5:34 pm</h4>
    <div class="postbody"><span class="postbody">To start with, it's stored in zero waitstate ROM...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#1765 - col - Wed Jan 22, 2003 6:55 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>ampz wrote:</b></span></td> </tr> <tr> <td class="quote">To start with, it's stored in zero waitstate ROM...</td> </tr></table><span class="postbody">
<br/>
<br/>
So You would put your custom divide code into iwram along with any other cpu intensive math functions...
<br/>
<br/>
Surely someone knows what the bios algorithm is?
<br/>
<br/>
cheers,
<br/>
<br/>
col</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#1767 - Rich - Wed Jan 22, 2003 7:57 pm</h4>
    <div class="postbody"><span class="postbody">Not sure what the copyright situation would be with simply posting the Bios divide code verbatim, but it's very easy to use the BatGBA emulator and trace through it :)
<br/>
<br/>
From my tests, the Bios routine, although substantially quicker than the C library routines, isn't that fast.  Even when I took the code and relocated it in IWRAM, it's still slower than the code here <a href="http://www.peter-teichmann.de/ahinte.html," target="_blank">http://www.peter-teichmann.de/ahinte.html,</a> which is linked to on GameBoy Advance Dev'rs.
<br/>
<br/>
The code on Peters site also has some room for speedup :)
<br/>
<br/>
Rich.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#1786 - slapout - Thu Jan 23, 2003 3:35 am</h4>
    <div class="postbody"><span class="postbody">The problem with division (in general) is that it generates remainders. Taking them into account is very cpu intensive. One of the things you can do is use shifting to divide by powers of 2. Also remember that division is just subtracting a number several times. Subtracting several time my be quicker than dividing. 
<br/>
<br/>
I'm not an expert, that's just what I've read. And I'm not sure how well it translates to the GBA as I'm just a newbie to GBA programming.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#2093 - Maddox - Wed Jan 29, 2003 6:11 am</h4>
    <div class="postbody"><span class="postbody">In the general case division by repeated subtraction is not a good idea.  Consider:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
a = 16768 / 3;
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Do you know how many subtractions that equals?  Lots!
<br/>
<br/>
Next, remainders themselves are usually a by-product of the division algorithm itself.  They are not intrinsically expensive to "take them into account"  You absolutely can write a signed 32-bit/32-bit divide routing in IWRAM ARM code for ~100 cycles.  (Don't know if that stacks up very well...)<br/>_________________<br/>You probably suck.  I hope you're is not a game programmer.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
