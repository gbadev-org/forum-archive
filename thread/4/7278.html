<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Sharing vars between the game loop and the interrup. handler - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>Coding > Sharing vars between the game loop and the interrup. handler</h2>
<div id="posts">
<div class="post">
    <h4>#58539 - Nacho - Mon Oct 24, 2005 2:13 pm</h4>
    <div class="postbody"><span class="postbody">Hi! I?m trying to set my game?s frequency to 20 FPS. Until now, I?ve been using the scanline counter register but I?ve been suggested to use interruptions instead so I looked into that. My plan of attack is the following one: keep a static variable inside the InterruptHandler and increment it everytime a VBlank interruption occurs. Whenever that variable reaches 3, set a global variable to 1 so that the main loop can flip pages. Here?s the code:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
<br/>
// Interruptions.c
<br/>
<br/>
int g_iOK = 0;
<br/>
<br/>
CODE_IN_IWRAM void
<br/>
InterruptHandler(void)
<br/>
{
<br/>
    static int iNumPasses = 0;
<br/>
    unsigned short usFlags;
<br/>
<br/>
    REG_IME = 0x00;
<br/>
    usFlags = REG_IF;
<br/>
<br/>
    if((REG_IF &amp; INT_VBLANK)==INT_VBLANK) {
<br/>
        if(++iNumPasses==3) {
<br/>
            iNumPasses = 0;
<br/>
            g_iOK = 1;
<br/>
        } /* End if */
<br/>
        else {
<br/>
            g_iOK = 0;
<br/>
        } /* End else */
<br/>
    } /* End if */
<br/>
<br/>
    REG_IF = usFlags;
<br/>
    REG_IME = 0x01;
<br/>
    return;
<br/>
} /* End InterruptHandler() */
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
<br/>
// Main.c
<br/>
<br/>
int
<br/>
main(void)
<br/>
{
<br/>
    // Code
<br/>
<br/>
    while(iFlag) {
<br/>
        GameMain(&amp;RendCont);      
<br/>
        while(!g_iOK);
<br/>
        FlipPages();
<br/>
        FillScreen();
<br/>
    }
<br/>
    // More code.
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Unfortunately, the program crashes, although it works ok whenever I comment the </span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">while(!g_iOK);</td> </tr></table><span class="postbody"> statement. I believe this has something to do with the fact that InterruptHandler() is located in IWRAM whereas main() is not but I don?t know how to solve it. Can you help with this? Thanks in advance!
<br/>
<br/>
--Nacho</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#58543 - strager - Mon Oct 24, 2005 2:19 pm</h4>
    <div class="postbody"><span class="postbody">Try defining your variable as volatile.
<br/>
<br/>
As such:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">volatile int g_iOK = 0; </td> </tr></table><span class="postbody">
<br/>
The compiler might assume, since g_iOK is zero on startup (and the interrupt handler isn't called directly from your code), it optimizes the while loop to while(!(0));.  This, obviously, is a problem, and the volatile should fix it.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#58551 - Nacho - Mon Oct 24, 2005 4:09 pm</h4>
    <div class="postbody"><span class="postbody">Thanks, that fixed it! I thought that the volatile keyword was meant to be used only for register variables. Another thing to add to my troubleshooting repertoire =P Thanks again strager!
<br/>
<br/>
One more question: why does Visual Boy Advance keeps displaying that my game is running at 60 fps? What does it take as a parameter to determine that value? I though it was the amount of page flips performed in one second but, apparently, I?m wrong.
<br/>
<br/>
--Nacho</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#58553 - NoMis - Mon Oct 24, 2005 4:26 pm</h4>
    <div class="postbody"><span class="postbody">The GBA Hardware runs the display at a constant 60fps. That is a constant that can't be changed. You are only updating the screen every 3 frames and therefor get a theoretical framerate of 20fps.
<br/>
<br/>
NoMis<br/>_________________<br/><span style="font-style: italic"><a class="postlink" href="http://www.gamedev.at/" target="_blank">www.gamedev.at</a></span> - The austrian gamedev site
<br/>
<span style="font-style: italic"><a class="postlink" href="http://hde.gamedev.at/" target="_blank">hde.gamedev.at</a></span> - The Handheld Dev Env plugins for Eclipse</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#58554 - strager - Mon Oct 24, 2005 4:27 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Nacho wrote:</b></span></td> </tr> <tr> <td class="quote">Thanks, that fixed it! I thought that the volatile keyword was meant to be used only for register variables. Another thing to add to my troubleshooting repertoire =P Thanks again strager!
<br/>
<br/>
One more question: why does Visual Boy Advance keeps displaying that my game is running at 60 fps? What does it take as a parameter to determine that value? I though it was the amount of page flips performed in one second but, apparently, I?m wrong.
<br/>
<br/>
--Nacho</td> </tr></table><span class="postbody">
<br/>
<br/>
You're welcome.  The 'register' keyword was an extention by the Borland compilers, I think...
<br/>
<br/>
VisualBoy Advance says your game is running at 60FPS because that is the number of frames the emulator is rendering per second, not the number of frames the game is rendering per second.  The closer the emulator is to 60FPS, the more like the real hardware it is (somewhat).
<br/>
<br/>
Edit:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>NoMis wrote:</b></span></td> </tr> <tr> <td class="quote">The GBA Hardware runs the display at a constant 60fps. That is a constant that can't be changed. You are only updating the screen every 3 frames and therefor get a theoretical framerate of 20fps.
<br/>
<br/>
NoMis</td> </tr></table><span class="postbody">
<br/>
What he said. :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#58601 - tepples - Mon Oct 24, 2005 9:16 pm</h4>
    <div class="postbody"><span class="postbody">But if you set frameskip to 2 (display one, skip two), VBA will run the game at 20fps and it'll still look correct if your engine is synchronized to 20fps.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#58997 - Nacho - Thu Oct 27, 2005 11:04 pm</h4>
    <div class="postbody"><span class="postbody">Thanks for all your explanations, I learned a lot in this thread.
<br/>
<br/>
--Nacho</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
