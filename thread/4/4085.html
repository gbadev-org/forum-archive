<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>C++ and inline ASM - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>Coding > C++ and inline ASM</h2>
<div id="posts">
<div class="post">
    <h4>#26457 - RiZeUp - Thu Sep 16, 2004 1:23 am</h4>
    <div class="postbody"><span class="postbody">I'm trying to learn how to get multiplayer working on gba. The come i'm looking at is in c while my application is in c++. When I compile my code i get an undefined reference in my ASM code. From what I could gather(correct me if im wrong) g++ mangles the names and functiones when compiling.
<br/>
<br/>
What do I need to do to fix this?
<br/>
<br/>
here is my makefile(i tried both ways). I'm really running out of ideas.
<br/>
<br/>
rem g++ -c -O3 -mthumb -mthumb-interwork main.cpp
<br/>
rem g++ -c -O3 -mthumb -mthumb-interwork multiplayer.cpp
<br/>
<br/>
g++ -Wall -O -mthumb -mthumb-interwork -o mp.elf main.cpp multiplayer.cpp
<br/>
<br/>
g++ -mthumb -mthumb-interwork -o mp.elf main.o multiplayer.o
<br/>
<br/>
<br/>
objcopy -O binary mp.elf multiplayer.gba<br/>_________________<br/>~RiZeUp</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#26460 - sajiimori - Thu Sep 16, 2004 1:57 am</h4>
    <div class="postbody"><span class="postbody">C++ does mangle names, and it's not just a GCC thing.  To specify that a name is not or should not be mangled, wrap it in this:</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">extern "C" { ... }</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#26461 - RiZeUp - Thu Sep 16, 2004 2:08 am</h4>
    <div class="postbody"><span class="postbody">yeah I tried that.
<br/>
i think I need a break cause my error is probably really simple but i just don t see it.
<br/>
<br/>
with extern "C" i get syntax error before string constant.
<br/>
<br/>
and this is my code extern "C" code
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">   #ifdef  __cplusplus
<br/>
   extern "C" {
<br/>
   #endif
<br/>
<br/>
   // Execute BIOS routine to transfer client binary to slave unit
<br/>
   asm volatile (
<br/>
     " ldr r0,=mp\n"
<br/>
     " mov r1,#1\n"
<br/>
     " swi 0x25\n"  /* for ARM change to 0x00250000 */
<br/>
     ::: "r0","r1","r2","r8","r9","r10","r11","r12"
<br/>
   );
<br/>
   #ifdef  __cplusplus
<br/>
   }
<br/>
   #endif
<br/>
</td> </tr></table><span class="postbody">
<br/>
Thanks for taking the time to help me<br/>_________________<br/>~RiZeUp</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#26462 - sajiimori - Thu Sep 16, 2004 3:07 am</h4>
    <div class="postbody"><span class="postbody">I don't know the source of the syntax error, but you want to put extern "C" around the declaration of the object you want to access, not around the code that does the access.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#26472 - RiZeUp - Thu Sep 16, 2004 3:14 pm</h4>
    <div class="postbody"><span class="postbody">ok i'm starting to understand how it works a little bit better. I did a little research on newsgroups but i'm still having a little bit of a hard time.
<br/>
I still get syntax errors with this and undefined references. I read that you don't need to put extern "C" for typedefs.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
typedef struct {
<br/>
  u32 reserve1[5];      //
<br/>
  u8 hs_data;           // 20 ($14) Needed by BIOS
<br/>
  u8 reserve2;          // 21 ($15)
<br/>
  u16 reserve3;         // 22 ($16)
<br/>
  u8 pc;                // 24 ($18) Needed by BIOS
<br/>
  u8 cd[3];             // 25 ($19)
<br/>
  u8 palette;           // 28 ($1c) Needed by BIOS - Palette flash while load
<br/>
  u8 reserve4;          // 29 ($1d) rb
<br/>
  u8 cb;                // 30 ($1e) Needed by BIOS
<br/>
  u8 reserve5;          // 31 ($1f)
<br/>
  u8 *startp;           // 32 ($20) Needed by BIOS
<br/>
  u8 *endp;             // 36 ($24) Needed by BIOS
<br/>
  u8 *reserve6;         // 40 ($28)
<br/>
  u8 *reserve7[3];      // 44 ($2c)
<br/>
  u32 reserve8[4];      // 56 ($38)
<br/>
  u8 reserve9;          // 72 ($48)
<br/>
  u8 reserve10;         // 73 ($49)
<br/>
  u8 reserve11;         // 74 ($4a)
<br/>
  u8 reserve12;         // 75 ($4b)
<br/>
} MBStruct;
<br/>
<br/>
class Multiplayer
<br/>
{
<br/>
public:
<br/>
   extern "C" MBStruct mp;
<br/>
   void DelayCycles(u32 cycles);
<br/>
   u16 send(u16 send);
<br/>
   void sendMB();
<br/>
};</td> </tr></table><span class="postbody"><br/>_________________<br/>~RiZeUp</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#26474 - sajiimori - Thu Sep 16, 2004 6:34 pm</h4>
    <div class="postbody"><span class="postbody">Does that compile??  I've never seen that use of extern before.  Besides, if you're accessing a struct from assembly, you don't access elements by name -- you access them by offset.  Try this for computing the offset of an element:</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#define STRUCT_OFFSET(type, element) (&amp;((type*)0)-&gt;element)</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
