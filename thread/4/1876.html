<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>BoycottAdvance & Vis. Boy Adv.: Different results (+src& - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>Coding > BoycottAdvance & Vis. Boy Adv.: Different results (+src&</h2>
<div id="posts">
<div class="post">
    <h4>#9619 - Domovoi - Mon Aug 11, 2003 12:32 am</h4>
    <div class="postbody"><span class="postbody">Hi there. I'm testing some interrupt code I've been writing, and I noticed an oddity while doing so. I normally run my compiled code in BoycottAdvance (because it starts faster), but when I want to check tile data and such, I use VisualBoy Advance. 
<br/>
<br/>
However, when I run the same .bin in both emulators, they don't yield the exact same result. BCA displays things fine, while VBA messes up the background map.
<br/>
<br/>
Here's what I'm doing: I wrote an interrupt handler in C, which scrolls background 0 (using he BG0VOFS register) to various positions when reaching certain scanlines. So at line 0 it's scrolled to a certain point, then at line 8 it's scrolled to somewhere else, then on 16, it is scrolled on the position 'it should be'.  (in other words, the top two rows of tiles display something, and the rest of the screen is something else). 
<br/>
<br/>
However, I need to store the position 'it should be' before I start moving the map around at lines 0 and 8, or I won't know where it should go on 16. So what I'm doing is I created a static variable in the interrupt handler, and at line 0, it stores the contents of BG0VOFS in that variable, and then sets BG0VOFS to its desired value. Later it sets BG0VOFS to another value, and when it reaches line 16, I need to put the map back where it was before; the value stored in the static variable. 
<br/>
<br/>
It works like a charm on BCA. No problem whatsover. But on VBA, for some reason, I have to add 45 to the static variable, or the map won't be at the right position (the top two tiles are.) Of course, when I do that (which isn't a solution of course), it naturally looks messed up in BCA.
<br/>
<br/>
Does anyone have an idea what's going on here? I'm baffled by the fact that the two emulators yield different results. Now I can't tell wether my code is correct, because I don't know which emulator is the 'good' one. (I can't test on hardware, by the way.) Besides, if it turned out VBA -does- display it wrong... then that would render VBA useless.
<br/>
<br/>
Anyone know what's going on? Does BCA take certain liberties it shouldn't, or does VBA not support things it should? Or is there something else?
<br/>
<br/>
Edit: Could be handy to show you exactly what's happening... Here's the interrupt handler:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
void InterruptHandler()
<br/>
{
<br/>
   if (REG_IF &amp; INT_VCOUNT)
<br/>
   {
<br/>
      static unsigned short pos = 240;
<br/>
<br/>
      if (REG_VCOUNT == 0)  
<br/>
      {
<br/>
         pos = REG_BG0VOFS; 
<br/>
<br/>
         REG_BG0VOFS = 248; 
<br/>
         REG_DISPSTAT = 32 | (8 &lt;&lt; 8);
<br/>
      }
<br/>
      else if (REG_VCOUNT == 8)
<br/>
      {
<br/>
         REG_BG0VOFS = 240;
<br/>
         REG_DISPSTAT = 32 | (16 &lt;&lt; 8);
<br/>
      }
<br/>
      else if (REG_VCOUNT == 16)
<br/>
      {
<br/>
         REG_BG0VOFS = pos;
<br/>
         REG_DISPSTAT = 32 | (144 &lt;&lt; 8);
<br/>
      }
<br/>
      else if (REG_VCOUNT == 144)
<br/>
      {
<br/>
         REG_BG0VOFS = 104;
<br/>
         REG_DISPSTAT = 32 | (152 &lt;&lt; 8);
<br/>
      }
<br/>
      else if (REG_VCOUNT == 152)
<br/>
      {
<br/>
         REG_BG0VOFS = 96;
<br/>
         REG_DISPSTAT = 32;
<br/>
      }
<br/>
<br/>
      REG_IF = INT_VCOUNT;
<br/>
   } 
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
So, on lines 0, 8, 16, 144, and 152, it scrolls the map to a certain position, and sets REG_DISPSTAT to cause an interrupt on the next desired line. On line 0, the vertical offset might've been changed by user input, so it is saved to pos, and on line 16, it is read from pos again to scroll to that point.
<br/>
<br/>
Here's the .bin: <a class="postlink" href="http://baspaap.hypermart.net/GBAScroll2.bin" target="_blank">http://baspaap.hypermart.net/GBAScroll2.bin</a>
<br/>
<br/>
Try it out in BoycottAdvane and VisualBoyAdvance. (use left and right to scroll.) On BCA, it runs as I expected, but in VBA, the offset from line 16 to 144 is wrong.  Anyone got an idea?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#9633 - jenswa - Mon Aug 11, 2003 7:21 pm</h4>
    <div class="postbody"><span class="postbody">I don't know how it should look.
<br/>
<br/>
with ba .28 and it was really screwed up.
<br/>
and with vboy there are some black lines and
<br/>
a good picture and a part with tiles.
<br/>
<br/>
I don't know what the problem, but it doesn't work
<br/>
on both emus for me.
<br/>
<br/>
If you can compile a multiboot version, i might be able
<br/>
to test it on hardware and see how it looks<br/>_________________<br/>It seems this wasn't lost after all.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#9636 - abilyk - Mon Aug 11, 2003 8:13 pm</h4>
    <div class="postbody"><span class="postbody">I just tested the .bin on hardware for you.  It looks and runs exactly the same as it does with VBA, with the addition of a couple artifacts towards the top and bottom of the screen.  I've heard something about VBA being able to use an image of the GBA bios to better emulate the hardware.  Perhaps if you did that, VBA would produce those additional artifacts as well so you can better troubleshoot.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#9826 - Daniel Andersen - Tue Aug 19, 2003 7:09 am</h4>
    <div class="postbody"><span class="postbody">Boycott Advance has some problems with the stack while switching from interrupt mode to super-visor (if I remembers right). It doesn't use the user-mode's stack and that messes things quite a lot up!
<br/>
<br/>
I realised this while in an interrupt and trying to call an ordinary method. I had to switch to super-visor-mode (to be able to switch back again) but it didn't work.
<br/>
<br/>
It works fine on VisualBoy Advance and all I have made works just as on the real thing!</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
