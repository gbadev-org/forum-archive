<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Otimising multiplys and arrays - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>Coding > Otimising multiplys and arrays</h2>
<div id="posts">
<div class="post">
    <h4>#71648 - pure_ev1l - Mon Feb 13, 2006 9:37 pm</h4>
    <div class="postbody"><span class="postbody">ok, basicly this is kinda a question about how the compiler compiles so I can optimize it. as I REALLY need VERY optimised code as I am making a kinda particle simulator with 1000's of particles. I am using the newest devkitadv incase it makes any odds
<br/>
<br/>
basicly I have a 2 dimentional array, but as all the reading will be relative (eg 1 block up, down, left or right) should I make it a 1D array and just use + and -? (so insted of map[x+1][y]... do map[location+1])
<br/>
<br/>
also, I have an array that has 2 elements(is that the right word?) so does it do a muliply to access it? so should I split into 2? (eg, pixel[3].r and pixel[3].g etc... into pixelr[3]) to stop it multiplying to find entries?
<br/>
<br/>
also, if its a unsigned integer for example (16 bit) does it use multiply to access it? (eg test[13]=4 does it do 13*2 to get the location to modify) so should I only use u8?
<br/>
<br/>
any other tips about getting rid of multiply?
<br/>
<br/>
thanks alot in advance, this forum is so damn helpful!<br/>_________________<br/>-Rory
<br/>
<br/>
 "Planning makes for a boring life, but a good game"</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#71651 - sajiimori - Mon Feb 13, 2006 9:50 pm</h4>
    <div class="postbody"><span class="postbody">There's only one way to know the answers to these questions:  Look at the compiler's output using the -S command line option.  It's too hard to predict what the optimizer will do.
<br/>
<br/>
In general, multiplies and divides are converted to shifts if they are known at compile time to be by a power of two.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#71653 - tepples - Mon Feb 13, 2006 9:53 pm</h4>
    <div class="postbody"><span class="postbody">Multiplies are fast on ARM7. Divides aren't, unless you use some hack such as multiplying by a reciprocal from a lookup table.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#71654 - DekuTree64 - Mon Feb 13, 2006 9:55 pm</h4>
    <div class="postbody"><span class="postbody">Yeah, the compiler will do a multiply for 2-dimensional arrays. One way you can optimize there is if you're looping over one row, use a pointer to the start of that row, and then increment the pointer each time instead of doing array offsets:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">int array[MAX_Y][MAX_X];
<br/>
<br/>
for (y = 0; y &lt; MAX_Y; y++)
<br/>
{
<br/>
    int *arrayPtr = array[y];
<br/>
    for (x = MAX_X - 1; x &gt;= 0; x--)
<br/>
    {
<br/>
        *arrayPtr = 1;
<br/>
        arrayPtr++;
<br/>
    }
<br/>
}</td> </tr></table><span class="postbody">
<br/>
Note the backward loop for x, because it's never actually used as an offset so it doesn't matter which way it goes, and going to 0 is a tiny bit faster than incrementing and then comparing with an end value (pretty insignificant when comparing with a constant like this though).
<br/>
<br/>
<br/>
And yes to your other question too, the compiler will multiply the array index by the size of the data type. This is just a shift for built-in types, so it's free in ARM, or one extra cycle in THUMB. Structures will usually have to do a real multiply though.<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#71661 - sajiimori - Mon Feb 13, 2006 10:43 pm</h4>
    <div class="postbody"><span class="postbody">Hey Deku, will GCC not optimize a 2D array lookup if it knows the width of it (in bytes) is a power of 2?  I would expect the same to go for structs that are powers of 2 in size.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#71685 - DekuTree64 - Tue Feb 14, 2006 12:26 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>sajiimori wrote:</b></span></td> </tr> <tr> <td class="quote">Hey Deku, will GCC not optimize a 2D array lookup if it knows the width of it (in bytes) is a power of 2?</td> </tr></table><span class="postbody">
<br/>
I'd assume it would, but I've never actually checked it.<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#71708 - Joat - Tue Feb 14, 2006 1:59 am</h4>
    <div class="postbody"><span class="postbody">1) After algorithmic optimizations, the biggest win by far on the GBA is the move to ARM code in IWRAM (check the FAQ, I think there is a topic on how to do this, if not, google for it, and failing that ask and I'll explain)
<br/>
<br/>
2) In a similar vein to (1), memory speed is a big issue.  If your particle tables also fit into iwram, do it, but if they have to be in exwram, make sure the elements are halfwords (16 bits wide), don't use words if you can help it (16 bit external bus, word reads/writes cost basically twice as much).  Bytes versus halfwords: The ldrb / strb share the nice addressing modes of ldr/str, while ldrh/strh have restricted addressing.  However, it's *never* a win to read two bytes and reassemble, read a halfword if your data needs a bigger range.
<br/>
<br/>
2) devkitadv isn't much (probably not any) slower than devkitarm, but it is well worth the hour or two it will take to switch over to devkit ARM.  It's using a much newer version of GCC, is still being maintained, etc...
<br/>
<br/>
3) Profile!  Setup a pair of timers in cascade mode to make cycle-accurate measurements of how fast your code is.  Don't second-guess what a code change does to time, measure it.  Once you have a baseline for your current code, you can try different things and see what is a winner.  As sajimori suggested, it's also a good idea to look at the compiler output to see what is going on.
<br/>
<br/>
4) Keep a working, unoptimized (or only sanely optimized) copy of your code before you start trying weird stuff.  It will help you find bugs introduced during optimization, provides a path back to working code if you botch it, etc...<br/>_________________<br/>Joat
<br/>
<a href="http://www.bottledlight.com" target="_blank">http://www.bottledlight.com</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#71711 - tepples - Tue Feb 14, 2006 2:10 am</h4>
    <div class="postbody"><span class="postbody">Generalization of 4) is to learn to set up a CVS repository on your computer and check files in and out of it (e.g. with <a class="postlink" href="http://www.tortoisecvs.org/" target="_blank">TortoiseCVS</a> client and <a class="postlink" href="http://www.cvsnt.org/" target="_blank">CVSNT Open Source</a> server). This will let you set up a "reference" branch and an "optimization" branch.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#71738 - gauauu - Tue Feb 14, 2006 4:36 am</h4>
    <div class="postbody"><span class="postbody">Well said.  Using cvs for all my projects made a huge impact in my productivity.
<br/>
<br/>
And I've found that if I'm ever working on multiple computers, <a class="postlink" href="https://freepository.com/" target="_blank">Freepository</a> is a great free way to host my cvs repository, so I can access it from anywhere.
<br/>
<br/>
It's a little slower than putting your repository on your own computer but also provides the benefit of always having a backup of your code on a different machine. (not to mention all the other basic benefits of cvs)</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
