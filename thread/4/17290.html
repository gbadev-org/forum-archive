<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>compiling to thumb and arm - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>Coding > compiling to thumb and arm</h2>
<div id="posts">
<div class="post">
    <h4>#174436 - brave_orakio - Fri Jun 11, 2010 4:09 am</h4>
    <div class="postbody"><span class="postbody">Hi guys . I recently decided to use the standard makefile for my current GBA project since my makefile doesn't work with version r30. Or at least I think it doesn't thats why I'm going to try and use the default makefile and see if it works that way.
<br/>
<br/>
now here is my makefile:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#---------------------------------------------------------------------------------
<br/>
# Clear the implicit built in rules
<br/>
#---------------------------------------------------------------------------------
<br/>
.SUFFIXES:
<br/>
#---------------------------------------------------------------------------------
<br/>
ifeq ($(strip $(DEVKITARM)),)
<br/>
$(error "Please set DEVKITARM in your environment. export DEVKITARM=&lt;path to&gt;devkitARM)
<br/>
endif
<br/>
<br/>
include $(DEVKITARM)/gba_rules
<br/>
<br/>
#---------------------------------------------------------------------------------
<br/>
# TARGET is the name of the output, if this ends with _mb a multiboot image is generated
<br/>
# BUILD is the directory where object files &amp; intermediate files will be placed
<br/>
# SOURCES is a list of directories containing source code
<br/>
# DATA is a list of directories containing data files
<br/>
# INCLUDES is a list of directories containing header files
<br/>
#---------------------------------------------------------------------------------
<br/>
TARGET      :=   $(shell basename $(CURDIR))
<br/>
BUILD      :=   build
<br/>
SOURCEA      :=   sourceArm
<br/>
SOURCET      :=   sourceThumb
<br/>
DATA      :=
<br/>
INCLUDES   :=   includes
<br/>
<br/>
#---------------------------------------------------------------------------------
<br/>
# options for code generation
<br/>
#---------------------------------------------------------------------------------
<br/>
ARCH   :=   -mthumb -mthumb-interwork
<br/>
<br/>
CFLAGS   :=   -g -Wall -O3\
<br/>
      -mcpu=arm7tdmi -mtune=arm7tdmi\
<br/>
       -fomit-frame-pointer\
<br/>
      -ffast-math \
<br/>
      $(ARCH)
<br/>
<br/>
CFLAGS   +=   $(INCLUDE)
<br/>
<br/>
CXXFLAGS   :=   $(CFLAGS) -fno-rtti -fno-exceptions
<br/>
<br/>
ASFLAGS   :=   $(ARCH)
<br/>
LDFLAGS   =   -g $(ARCH) -Wl,-Map,$(notdir $@).map
<br/>
<br/>
ARCHA   :=   -marm -mlong-calls -mthumb-interwork
<br/>
<br/>
CFLAGSA   :=   -g -Wall -O3\
<br/>
      -mcpu=arm7tdmi -mtune=arm7tdmi\
<br/>
       -fomit-frame-pointer\
<br/>
      -ffast-math \
<br/>
      $(ARCHA)
<br/>
<br/>
CFLAGSA   +=   $(INCLUDE)
<br/>
<br/>
CXXFLAGSA   :=   $(CFLAGSA) -fno-rtti -fno-exceptions
<br/>
<br/>
ASFLAGSA   :=   $(ARCHA)
<br/>
LDFLAGSA   =   -g $(ARCHA) -Wl,-Map,$(notdir $@).map
<br/>
<br/>
#---------------------------------------------------------------------------------
<br/>
# any extra libraries we wish to link with the project
<br/>
#---------------------------------------------------------------------------------
<br/>
LIBS   :=   -lgba
<br/>
<br/>
#---------------------------------------------------------------------------------
<br/>
# list of directories containing libraries, this must be the top level containing
<br/>
# include and lib
<br/>
#---------------------------------------------------------------------------------
<br/>
LIBDIRS   :=   $(LIBGBA)
<br/>
<br/>
#---------------------------------------------------------------------------------
<br/>
# no real need to edit anything past this point unless you need to add additional
<br/>
# rules for different file extensions
<br/>
#---------------------------------------------------------------------------------
<br/>
ifneq ($(BUILD),$(notdir $(CURDIR)))
<br/>
#---------------------------------------------------------------------------------
<br/>
<br/>
export OUTPUT   :=   $(CURDIR)/$(TARGET)
<br/>
export VPATH   :=   $(foreach dir,$(SOURCEA),$(CURDIR)/$(dir)) \
<br/>
               $(foreach dir,$(SOURCET),$(CURDIR)/$(dir)) \
<br/>
         $(foreach dir,$(DATA),$(CURDIR)/$(dir))
<br/>
<br/>
export DEPSDIR   :=   $(CURDIR)/$(BUILD)
<br/>
<br/>
#---------------------------------------------------------------------------------
<br/>
# automatically build a list of object files for our project
<br/>
#---------------------------------------------------------------------------------
<br/>
CFILES      :=   $(foreach dir,$(SOURCEA),$(notdir $(wildcard $(dir)/*.c)))
<br/>
CFILES      :=   $(foreach dir,$(SOURCET),$(notdir $(wildcard $(dir)/*.c)))
<br/>
#CPPFILES   :=   $(foreach dir,$(SOURCES),$(notdir $(wildcard $(dir)/*.cpp)))
<br/>
#SFILES      :=   $(foreach dir,$(SOURCES),$(notdir $(wildcard $(dir)/*.s)))
<br/>
#BINFILES   :=   $(foreach dir,$(DATA),$(notdir $(wildcard $(dir)/*.*)))
<br/>
#BMPFILES   :=   $(foreach dir,$(GRAPHICS),$(notdir $(wildcard $(dir)/*.bmp)))
<br/>
<br/>
#---------------------------------------------------------------------------------
<br/>
# use CXX for linking C++ projects, CC for standard C
<br/>
#---------------------------------------------------------------------------------
<br/>
ifeq ($(strip $(CPPFILES)),)
<br/>
#---------------------------------------------------------------------------------
<br/>
   export LD   :=   $(CC)
<br/>
#---------------------------------------------------------------------------------
<br/>
else
<br/>
#---------------------------------------------------------------------------------
<br/>
   export LD   :=   $(CXX)
<br/>
#---------------------------------------------------------------------------------
<br/>
endif
<br/>
#---------------------------------------------------------------------------------
<br/>
<br/>
export OFILES   :=   $(addsuffix .o,$(BINFILES)) \
<br/>
               $(BMPFILES:.bmp=.o) \
<br/>
               $(CPPFILES:.cpp=.o) $(CFILES:.c=.o) $(SFILES:.s=.o)
<br/>
<br/>
#---------------------------------------------------------------------------------
<br/>
# build a list of include paths
<br/>
#---------------------------------------------------------------------------------
<br/>
export INCLUDE   :=   $(foreach dir,$(INCLUDES),-I$(CURDIR)/$(dir)) \
<br/>
         $(foreach dir,$(LIBDIRS),-I$(dir)/include) \
<br/>
         -I$(CURDIR)/$(BUILD)
<br/>
<br/>
#---------------------------------------------------------------------------------
<br/>
# build a list of library paths
<br/>
#---------------------------------------------------------------------------------
<br/>
export LIBPATHS   :=   $(foreach dir,$(LIBDIRS),-L$(dir)/lib)
<br/>
<br/>
.PHONY: $(BUILD) clean
<br/>
<br/>
#---------------------------------------------------------------------------------
<br/>
$(BUILD):
<br/>
   @[ -d $@ ] || mkdir -p $@
<br/>
   @make --no-print-directory -C $(BUILD) -f $(CURDIR)/Makefile
<br/>
<br/>
all   : $(BUILD)
<br/>
#---------------------------------------------------------------------------------
<br/>
clean:
<br/>
   @echo clean ...
<br/>
   @rm -fr $(BUILD) $(TARGET).elf $(TARGET).gba
<br/>
<br/>
#---------------------------------------------------------------------------------
<br/>
else
<br/>
<br/>
DEPENDS   :=   $(OFILES:.o=.d)
<br/>
<br/>
#---------------------------------------------------------------------------------
<br/>
# main targets
<br/>
#---------------------------------------------------------------------------------
<br/>
$(OUTPUT).gba   :   $(OUTPUT).elf
<br/>
<br/>
$(OUTPUT).elf   :   $(OFILES)
<br/>
<br/>
<br/>
#---------------------------------------------------------------------------------
<br/>
# The bin2o rule should be copied and modified
<br/>
# for each extension used in the data directories
<br/>
#---------------------------------------------------------------------------------
<br/>
<br/>
#---------------------------------------------------------------------------------
<br/>
# This rule links in binary data with the .bin extension
<br/>
#---------------------------------------------------------------------------------
<br/>
%.bin.o   :   %.bin
<br/>
#---------------------------------------------------------------------------------
<br/>
   @echo $(notdir $&lt;)
<br/>
   @$(bin2o)
<br/>
<br/>
#---------------------------------------------------------------------------------
<br/>
# This rule links in binary data with the .raw extension
<br/>
#---------------------------------------------------------------------------------
<br/>
%.raw.o   :   %.raw
<br/>
#---------------------------------------------------------------------------------
<br/>
   @echo $(notdir $&lt;)
<br/>
   @$(bin2o)
<br/>
<br/>
#---------------------------------------------------------------------------------
<br/>
# This rule creates assembly source files using grit
<br/>
# grit takes an image file and a .grit describing how the file is to be processed
<br/>
# add additional rules like this for each image extension
<br/>
# you use in the graphics folders 
<br/>
#---------------------------------------------------------------------------------
<br/>
%.s %.h   : %.bmp %.grit
<br/>
#---------------------------------------------------------------------------------
<br/>
   grit $&lt; -fts -o$*
<br/>
<br/>
-include $(DEPENDS)
<br/>
<br/>
#---------------------------------------------------------------------------------
<br/>
endif
<br/>
#---------------------------------------------------------------------------------
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
The ones with A at the end (ARCHA, CFLAGSA, etc.) indicate that the it is in ARM code and the rest THUMB. At the top SOURCA is the directory that contains the c files required to be compiled in ARM and SOURCET is the directory that contains the files for THUMB. INCLUDES contains all *.h files from both SOURCET and SOURCA.
<br/>
<br/>
Question is, what am I doing wrong here? I have no idea how to connect the ARCH and ARCHA to SOURCET and SOURCEA respectively so I  doubt that SOURCEA is being compiled to ARM code.
<br/>
<br/>
Also what do I need to change so it doesn't compile as multiboot? My old one had a -specs=gba.specs but I don't know what to use in this case.
<br/>
<br/>
many thanks!<br/>_________________<br/>help me</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#174439 - elhobbs - Fri Jun 11, 2010 1:40 pm</h4>
    <div class="postbody"><span class="postbody">The rules for compiling source files are being pulled in through this line</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">include $(DEVKITARM)/gba_rules </td> </tr></table><span class="postbody">which in turn brings in the base_rules file. the base_rules file has rules already for forcing thumb or arm output. it uses file extensions (technically filenames) to determine if it should compile for arm or thumb. If the file is named somename.arm.c it will be complied for arm. If it is named somename.thumb.c it will be compiled for thumb. you could modify the rules yourself or you could just use the default makefile and use the naming convention to force thumb/arm.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#174472 - brave_orakio - Tue Jun 15, 2010 1:58 am</h4>
    <div class="postbody"><span class="postbody">Thanks, I'll try that out. How about compiling so the code will execute from ROM(non-multiboot)? gba_rules has it as well?
<br/>
<br/>
Also what does this part do?
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
ARCH	:=	-mthumb -mthumb-interwork
<br/>
<br/>
CFLAGS	:=	-g -Wall -O3\
<br/>
		-mcpu=arm7tdmi -mtune=arm7tdmi\
<br/>
 		-fomit-frame-pointer\
<br/>
		-ffast-math \
<br/>
		$(ARCH)
<br/>
<br/>
CFLAGS	+=	$(INCLUDE)
<br/>
<br/>
CXXFLAGS	:=	$(CFLAGS) -fno-rtti -fno-exceptions
<br/>
<br/>
ASFLAGS	:=	$(ARCH)
<br/>
LDFLAGS	=	-g $(ARCH) -Wl,-Map,$(notdir $@).map
<br/>
</td> </tr></table><span class="postbody">
<br/>
In my other makefile, I have a similar part, or rather two similar parts. One for ARM and one for THUMB and also -mspecs=gba.specs for the part where all *.o files get converted to a *.elf file.
<br/>
<br/>
edit: never mind about the multiboot  thing. I read gba_rules and I have it. However, whats the above line for? Is it used basically if the source files have no .arm and .thumb in the filename?<br/>_________________<br/>help me</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
