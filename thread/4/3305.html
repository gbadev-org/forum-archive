<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Code working compiled in ARM but not in thumb - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>Coding > Code working compiled in ARM but not in thumb</h2>
<div id="posts">
<div class="post">
    <h4>#19884 - shadow_gg - Tue Apr 27, 2004 1:55 pm</h4>
    <div class="postbody"><span class="postbody">Hi everybody, does anyone can told me why my rom work in arm but not in thumb?
<br/>
when I compile in THUMB my game freeze , and I saw some illegal writes.
<br/>
My program is in C++,and it seems it happens when he tried to call methods in some classes.
<br/>
the instructions in ASM who use to make the illegal write always look like this:
<br/>
<br/>
 800285e:	6002      	str	r2, [r0, #0] //ILLEGAL WRITE!
<br/>
 8002860:	6808      	ldr	r0, [r1, #0]
<br/>
 8002862:	2103      	mov	r1, #3
<br/>
 8002864:	fa9af008 	bl	800ad9c &lt;_ZN7Sprite211SetPriorityEt&gt;
<br/>
<br/>
normally there shouldn't be any differences in my C code ?
<br/>
The same C code should either work in ARM or THUMB ,no ?
<br/>
<br/>
I hope somebody will be able to help me,bcs I'm damn blocked
<br/>
THX ALL!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#19893 - f(DarkAngel) - Tue Apr 27, 2004 8:00 pm</h4>
    <div class="postbody"><span class="postbody">It seems to be a pointer routine. It might be that you're writing to an illegal address (like null pointer), or maybe the pointer value wraps because it overflowed 2^16 in thumb mode and pointing to an illegal address... I'm not sure.<br/>_________________<br/>death scream...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#19898 - sajiimori - Tue Apr 27, 2004 9:05 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
maybe the pointer value wraps because it overflowed 2^16 in thumb mode and pointing to an illegal address
<br/>
</td> </tr></table><span class="postbody">
<br/>
Thumb instructions are just abbreviations of ARM instructions.  They have the same addressable space.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#19905 - col - Tue Apr 27, 2004 9:45 pm</h4>
    <div class="postbody"><span class="postbody">shadow_gg,
<br/>
<br/>
show us some compilable source code that exhibits the problem.
<br/>
also, what compiler/version are you using?
<br/>
And which command line switches are set?
<br/>
<br/>
Col</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#19994 - poslundc - Thu Apr 29, 2004 3:20 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>shadow_gg wrote:</b></span></td> </tr> <tr> <td class="quote">bcs I'm damn blocked</td> </tr></table><span class="postbody">
<br/>
<br/>
You know you've been writing too much ASM code when you read that as brach-carry-set...
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#20000 - shadow_gg - Thu Apr 29, 2004 5:16 pm</h4>
    <div class="postbody"><span class="postbody">lol dan ^^
<br/>
<br/>
I used devkitadv g++ 3.0.2
<br/>
it seems I had fixed the illegal writes issues by removing one function.
<br/>
<br/>
All my files where compiled in ARM mode and all was working well.
<br/>
Actually for my game working I must compile my main.cpp and sprite.cpp in arm.
<br/>
All others sources files are compiled in thumb.
<br/>
Now I want to compile main.cpp and sprite.cpp in thumb mode,
<br/>
but I got some stranges visuals effects occurings.
<br/>
<br/>
What can I do in my code who works in ARM and not in THUMB?
<br/>
sizeof( types ) are the same between ARM and THUMB ,no?
<br/>
<br/>
how the same C++ code can differ when compiled ?
<br/>
<br/>
my rules for getting .o files
<br/>
<br/>
%.o:%.cpp
<br/>
	$(GCC_PATH)  -I. -I$(DEVKIT_PATH)/lib/gcc-lib/arm-agb-elf/3.0.2/include -I$(DEVKIT_PATH)/arm-agb-elf/include -I$(Nintendo_include) -I./lucidcore/ -I./gbacoreapi/ -g -O2 -frename-registers -Wall -fverbose-asm -mthumb -mthumb-interwork -c  -o $@  $&lt;
<br/>
<br/>
<br/>
oh I just discovered something strange in the makefile:
<br/>
@ $(LD_PATH) --no-warn-mismatch -o GBA.elf ./gbacoreapi/crt0.o ./gbacoreapi/crtbegin.o ./gbacoreapi/crtend.o $(OBJS) $(SOUND_FILES) -L$(DEVKIT_PATH)/lib/gcc-lib/arm-agb-elf/3.0.2/interwork -L$(DEVKIT_PATH)/arm-agb-elf/lib/interwork  -L$(Nintendo_lib) -T Linkscript -lagbsyscall -lstdc++ -lgcc -lc -Map GBA.map
<br/>
<br/>
<br/>
when I removed --no-warn-mismatch it doesn't compile anymore,
<br/>
bcs my object files generated by objcopy don't support interworking.
<br/>
Maybe my errors come from this point,huh?
<br/>
<br/>
<br/>
<br/>
How can I add interworking support in this line :
<br/>
<br/>
%.o:%.bin
<br/>
	$(OBJCOPY_PATH) -B arm -I binary -O elf32-little --rename-section .data=.rodata $&lt; $@
<br/>
<br/>
?
<br/>
<br/>
<br/>
THX ALL FOR UR REPLIES ,AND EXCUSE ME FOR MY POOR ENGLISH ;)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#20043 - col - Fri Apr 30, 2004 1:05 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>shadow_gg wrote:</b></span></td> </tr> <tr> <td class="quote">lol dan ^^
<br/>
<br/>
I used devkitadv g++ 3.0.2
<br/>
it seems I had fixed the illegal writes issues by removing one function.
<br/>
<br/>
All my files where compiled in ARM mode and all was working well.
<br/>
Actually for my game working I must compile my main.cpp and sprite.cpp in arm.
<br/>
All others sources files are compiled in thumb.
<br/>
Now I want to compile main.cpp and sprite.cpp in thumb mode,
<br/>
but I got some stranges visuals effects occurings.
<br/>
<br/>
What can I do in my code who works in ARM and not in THUMB?
<br/>
sizeof( types ) are the same between ARM and THUMB ,no?
<br/>
<br/>
how the same C++ code can differ when compiled ?
<br/>
<br/>
</td> </tr></table><span class="postbody">
<br/>
without some source code its difficult to help much.
<br/>
I do remember that the version of gcc you are using was unable to dereference pointers to member functions correctly from thumb code.
<br/>
I am using 3.2.2 (devkitadv 5), and that issue has beed resolved.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
oh I just discovered something strange in the makefile:
<br/>
@ $(LD_PATH) --no-warn-mismatch -o GBA.elf ./gbacoreapi/crt0.o ./gbacoreapi/crtbegin.o ./gbacoreapi/crtend.o $(OBJS) $(SOUND_FILES) -L$(DEVKIT_PATH)/lib/gcc-lib/arm-agb-elf/3.0.2/interwork -L$(DEVKIT_PATH)/arm-agb-elf/lib/interwork  -L$(Nintendo_lib) -T Linkscript -lagbsyscall -lstdc++ -lgcc -lc -Map GBA.map
<br/>
<br/>
when I removed --no-warn-mismatch it doesn't compile anymore,
<br/>
bcs my object files generated by objcopy don't support interworking.
<br/>
Maybe my errors come from this point,huh?
<br/>
<br/>
How can I add interworking support in this line :
<br/>
<br/>
%.o:%.bin
<br/>
	$(OBJCOPY_PATH) -B arm -I binary -O elf32-little --rename-section .data=.rodata $&lt; $@
<br/>
<br/>
?
<br/>
</td> </tr></table><span class="postbody">
<br/>
If your code and the libs you use are all compiled with interworking enabled, then its just raw data thats the problem - sound, graphics... in that case you can use a tool called interflip (?) to fix the data object files.
<br/>
<br/>
If on the other hand the problem is in code object files, then they must be recompiled with interworking on. Any libs you link to should also support interworking.
<br/>
<br/>
cheers,
<br/>
<br/>
Col</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
