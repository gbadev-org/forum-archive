<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Need Some Windowing Code, or help with... - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>Coding > Need Some Windowing Code, or help with...</h2>
<div id="posts">
<div class="post">
    <h4>#50578 - justinGBA - Wed Aug 10, 2005 8:59 pm</h4>
    <div class="postbody"><span class="postbody">So i was over on TONC's web site, and was reading up on the windowing...  Well i'm not the best when it comes to understanding how to set bits.  So this is more or less a request for some working fragments of windowing code.  I even fired up his source code, and that is just a big unorganized mess.
<br/>
<br/>
Or... Can someone help me get it working with my current code...
<br/>
<br/>
For my video i do this...
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#define InitVideo(mode) *(unsigned long*)0x4000000 = (mode)
<br/>
//Tile based Modes
<br/>
#define Mode0 0x0
<br/>
#define Mode1 0x1  
<br/>
#define Mode2 0x2
<br/>
//Bitmap based Modes
<br/>
#define Mode3 0x3
<br/>
#define Mode4 0x4
<br/>
#define Mode5 0x5
<br/>
<br/>
<br/>
/* --Backgrounds To Enable-- */
<br/>
<br/>
#define Bg0   0x100
<br/>
#define Bg1 0x200
<br/>
//Bg2: default for Mode3
<br/>
#define Bg2 0x400
<br/>
#define Bg3 0x800
<br/>
<br/>
//USE OF FUNCTION
<br/>
InitVideo( Mode0 | OBJ_ENABLE | OBJ_MAP_1D | Bg0 | Bg1 );
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
So what value do i or into this to make windowing turned on...?
<br/>
his site says set   REG_DISPCNT{d,e,f} respectively.
<br/>
<br/>
then to set window bounds i do this?
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
// win0: l= 36, r=  76, t= 20, b=  60 (40x40 window)
<br/>
// win1: l= 12, r= 228, t= 12, b= 148 (12 pixel margin)
<br/>
// Obj at win0, bg0 at win1, bg1 at winOut
<br/>
<br/>
    REG_WIN0H=  (36&lt;&lt;8) | 76;
<br/>
    REG_WIN1H=  (12&lt;&lt;8) | 228;
<br/>
    REG_WIN0V=  (20&lt;&lt;8) | 60;
<br/>
    REG_WIN1V=  (12&lt;&lt;8) | 148;
<br/>
    REG_WININ = (WIN_BG0&lt;&lt;8) | (WIN_OBJ);
<br/>
    REG_WINOUT= WIN_BG1;
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
<br/>
So i guess i just need to know how to or the DEF of my REG_DISPCNT.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#50590 - headspin - Wed Aug 10, 2005 11:31 pm</h4>
    <div class="postbody"><span class="postbody">Here is some of my windowing code...
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#define WIN1_ENABLE 0x2000 
<br/>
#define WIN2_ENABLE 0x4000
<br/>
<br/>
void set_window()
<br/>
{
<br/>
   REG_WIN0H = (8 &lt;&lt; 8) | 230;
<br/>
   REG_WIN0V = (120 &lt;&lt; 8) | 152;
<br/>
   REG_WININ = 4095;
<br/>
   REG_WINOUT = 4094;
<br/>
   REG_DISPCNT |= WIN1_ENABLE;
<br/>
}
<br/>
<br/>
void off_window()
<br/>
{
<br/>
   REG_DISPCNT ^= WIN1_ENABLE;
<br/>
}</td> </tr></table><span class="postbody"><br/>_________________<br/><a class="postlink" href="http://headsoft.com.au/index.php?category=warhawk" target="_blank">Warhawk DS</a> | <a class="postlink" href="http://headsoft.com.au/index.php?category=mmll" target="_blank">Manic Miner: The Lost Levels</a> | <a class="postlink" href="http://headsoft.com.au/index.php?category=tdg" target="_blank">The Detective Game</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#50636 - Cearn - Thu Aug 11, 2005 8:23 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>justinGBA wrote:</b></span></td> </tr> <tr> <td class="quote">... REG_DISPCNT{d,e,f} ...</td> </tr></table><span class="postbody">Means bits 0xD, 0xE and 0xF of REG_DISPCNT (i.o.w., bits 13, 14, 15). I could swear I mentioned it somewhere ...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#51587 - jarobi - Mon Aug 22, 2005 4:25 am</h4>
    <div class="postbody"><span class="postbody">I just got started on windowing and interrupts.  I was wondering if there was a way to make neat window shapes using hblank interrupts.  If I run the following code during hblank, I would think that it gives me a diagonal line across the screen, but the window shifts and twists in every imaginable way instead:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#define setWin0Bounds(x1, x2, y1, y2) REG_WIN0H=((int)(x1)&lt;&lt;8)|(int)(x2);REG_WIN0V=((int)(y1)&lt;&lt;8)|(int)(y2);
<br/>
<br/>
int x = 0;
<br/>
<br/>
void hblank_isr()
<br/>
{
<br/>
    setWin0Bounds(x, x+16, REG_VCOUNT, REG_VCOUNT+1);
<br/>
}
<br/>
<br/>
void vblank_isr()
<br/>
{
<br/>
    x = 0;
<br/>
}
<br/>
</td> </tr></table><span class="postbody"><br/>_________________<br/>Nihongo o hanasemasen!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#51608 - Cearn - Mon Aug 22, 2005 8:47 am</h4>
    <div class="postbody"><span class="postbody">HBlank interrupts happen <span style="font-style: italic">after</span> a given REG_VCOUNT, not before. You shouldn't be getting anythgin at all then. If you're updating every hblank, just use the whole vertical range (0, 160). For a diagonal line, x should be updated in the hblank too.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void hblank_isr() 
<br/>
{ 
<br/>
    setWin0Bounds(x, x+16, 0, 160)
<br/>
    x++;
<br/>
} 
<br/>
</td> </tr></table><span class="postbody">This one seems to work ... with the exception that the top line starts with x=68 because there are hbl interrupts inside the VBlank too, but I'm sure you'll find a way around those.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#51688 - jarobi - Mon Aug 22, 2005 11:59 pm</h4>
    <div class="postbody"><span class="postbody">Your example actually worked!  Thank you very much Cearn.  I see what you mean about x starting at 68 though, but that shouldn't be too much of an issue for me.  It's a lot better than that television static effect I was getting before.<br/>_________________<br/>Nihongo o hanasemasen!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#51879 - jarobi - Wed Aug 24, 2005 7:38 am</h4>
    <div class="postbody"><span class="postbody">I managed to solve the issue of my window starting 68 px more to the right than expected by initializing my x values to 67 minus their original value.  I then proceeded to create a spotlight effect with my window by calling the following function every hblank:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
void adjustWindow()
<br/>
{
<br/>
   setWin0Bounds(x0/3, x1, 0, 160);
<br/>
   x0++;
<br/>
   x1++;
<br/>
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
I would get the predictable result using an emulator but when I tried it on hardware, all hell broke loose; by that I mean that the window was doing that same thing I mentioned earlier.  Almost by coincidence, I was simultaneously researching division on the GBA.  I found out that using the / operator or even using the bios division function takes hundreds of cycles.  I'm guessing that is a little bit too much to be in a hblank routine.  However, when I divide by 2 in the above function, everything works out OK for the obvious reason that the operation is optimized by the compiler.  So, to create neat window effects that involve "complex" math, do I have to store my x values in a table instead or is there another way?<br/>_________________<br/>Nihongo o hanasemasen!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#51906 - tepples - Wed Aug 24, 2005 1:58 pm</h4>
    <div class="postbody"><span class="postbody">Sixty-eight? That number sounds familiar. That's how many scanlines tall the vblank is.
<br/>
<br/>
The window isn't 68 pixels to the right; it's 68 pixels <span style="font-style: italic">up.</span> You're incrementing x even on hblank interrupts that occur during vblank. (Hblank interrupts occur during vblank; hblank DMA doesn't.) You're <span style="font-style: italic">supposed</span> to set the X position based on the current value of the VCOUNT register.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#51978 - jarobi - Thu Aug 25, 2005 6:47 am</h4>
    <div class="postbody"><span class="postbody">I was actually aware of incrementing x in the vblank.  The reason why I did not set the x position with respect to the value in the vcount reg is because the hardware messes up my window if I do; this works in an emulator though.  It seems to me that the hardware doesn't like it when I read from the vcount register during hblank.  I have even tried incrementing some value every hblank and I get the same crappy results.  Any clues as to what my problem is?
<br/>
<br/>
<span style="font-weight: bold">Edit:</span> I wonder if my accessing of the vcount register is somehow taking more than the ~250 cycles allowed in hblank?<br/>_________________<br/>Nihongo o hanasemasen!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#52000 - tepples - Thu Aug 25, 2005 11:53 am</h4>
    <div class="postbody"><span class="postbody">The most reliable way to set a window is with hblank DMA, not hblank interrupts. Or are you already using all four DMA channels for other purposes?<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#52042 - jarobi - Thu Aug 25, 2005 9:19 pm</h4>
    <div class="postbody"><span class="postbody">So, what you're saying is that I should competely scrap hblank interrupts in favour of hblank DMA?  If I were to do that, then would it be valid for me to do the following in code:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
//main game loop (pseudo-code)
<br/>
while (1)
<br/>
{
<br/>
    waitForVBlank();
<br/>
    int windowValV, windowValH;
<br/>
    windowValV = windowSettings;
<br/>
    windowValH = otherSettings;
<br/>
    dmaCopy(&amp;windowValV, REG_WIN0V, 32BITCPY, START_HBLANK);
<br/>
    dmaCopy(&amp;windowValH, REG_WIN0H, 32BITCPY, START_HBLANK);
<br/>
<br/>
    otherStuffToDo();
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
Is there something that I am missing here?  Oh yeah, I am not using DMA for anything inside of my main game loop.<br/>_________________<br/>Nihongo o hanasemasen!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#52067 - tepples - Fri Aug 26, 2005 2:29 am</h4>
    <div class="postbody"><span class="postbody">Yes, scrap interrupts for now.
<br/>
<br/>
<span style="font-weight: bold">Source:</span> The DMA happens <span style="font-style: italic">after</span> scanline rendering, not before. You'll need to set up an array, manually copy element 0 of the array into the register during vblank, and then start the source address at element 1.
<br/>
<br/>
<span style="font-weight: bold">Destination:</span> You only need to DMA to the WIN0H register, which is 16 bits wide.
<br/>
<br/>
<span style="font-weight: bold">Size:</span> You need to use start on hblank, repeating, 16-bit transfers, and a transfer size of 1 word.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#52077 - jarobi - Fri Aug 26, 2005 5:48 am</h4>
    <div class="postbody"><span class="postbody">I got "the white screen of death"!  I <span style="font-style: italic">think</span> I did exactly what you told me to do, but it just won't work... either that or my brain won't work;  more likely the latter than the former :).  Anyhow, this is what I have in my main loop.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
int main()
<br/>
{
<br/>
   Background demon_bk;
<br/>
   u16 win_values[160];
<br/>
   int x, i, my0, mx0, my1, mx1;
<br/>
   
<br/>
   /*REG_DISPSTAT |= IRQ_VB|IRQ_HB;
<br/>
   irqEnable(INT_VBLANK, doSomething);
<br/>
   irqEnable(INT_HBLANK, adjustWindow);
<br/>
   interruptEnable();*/
<br/>
   my0 = 2;
<br/>
   mx0 = 1;
<br/>
   my1 = 1;
<br/>
   mx1 = 1;
<br/>
   for (i = 0, x = 0; i &lt; 160; i++, x++)
<br/>
   {
<br/>
      win_values[i] = ((u16)Div(x*my0, mx0))&lt;&lt;8|((u16)Div((x+1)*my1, mx1));
<br/>
   }
<br/>
   
<br/>
   demon_bk.bgNumber = 2;
<br/>
   demon_bk.attributes = BG_COLOR_256
<br/>
                  |ROTBG_SIZE_1
<br/>
                  |BG_PRIORITY(3)
<br/>
                  |CHAR_BASE_BLOCK(0)
<br/>
                  |SCREEN_BASE_BLOCK(24)
<br/>
                  |WRAP_AROUND;
<br/>
   
<br/>
   loadBGPalette((u16*)demonPal);
<br/>
   loadBGTiles((u16*)demonData, 0, 256, 0);
<br/>
   loadBGMap((u16*)demon_map, 24, 16, 16);
<br/>
   
<br/>
   REG_BG2CNT = demon_bk.attributes;
<br/>
   
<br/>
   setWin0Content(W0_BG2);
<br/>
   
<br/>
   setMode(MODE_2|BG2_ENABLE|WIN0_ENABLE);
<br/>
   while (1)
<br/>
   {
<br/>
      waitForVBlank();
<br/>
      REG_WIN0H = win_values[0];
<br/>
      while (REG_DISPSTAT &amp; DISPSTAT_VB); //make sure DMA happens after vblank
<br/>
      REG_DMA2SAD = (u32)(&amp;win_values[1]); //28-bit address
<br/>
      REG_DMA2DAD = (u32)(&amp;REG_WIN0H); //27-bit addresses only
<br/>
      REG_DMA2CNT_L = 1;
<br/>
      REG_DMA2CNT_H = SRC_CONTROL(0)|DES_CONTROL(NO_INC_DEC)|START_MODE(XFER_HBLK)|BLOCK_SIZE_16|REPEAT|DMA_ENABLE;
<br/>
   }
<br/>
   
<br/>
   return 0;
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
<span style="font-weight: bold">Unrelated Thought:</span> I think I totally hijacked this thread :)<br/>_________________<br/>Nihongo o hanasemasen!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#52078 - DekuTree64 - Fri Aug 26, 2005 5:59 am</h4>
    <div class="postbody"><span class="postbody">Hmm, what does your waitForVBlank look like? If it's using the BIOS wait, you do need to have your VBlank interrupt enabled or it'll never break out.
<br/>
<br/>
Also, be sure to set the DMA control to 0 before you set it back up again. Otherwise it won't pay any attention, and will keep blasting whatever memory happened to be after your win_values table into the register. 
<br/>
I don't think that would cause a white screen, but might look a little crazy :)<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#52081 - jarobi - Fri Aug 26, 2005 6:21 am</h4>
    <div class="postbody"><span class="postbody">No dice.  Still not working.  Here is what my crappy waitForVBlank function looks like:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
void waitForVBlank()
<br/>
{
<br/>
   while (!(REG_DISPSTAT &amp; DISPSTAT_VB) &amp;&amp; REG_VCOUNT != 160);
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
Can you suggest anything better than the above?<br/>_________________<br/>Nihongo o hanasemasen!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#52141 - jarobi - Sat Aug 27, 2005 6:02 am</h4>
    <div class="postbody"><span class="postbody">I almost have my whole windowing issue figured out.  I figured out that my call to Div was causing the white screen of death for some reason.  In fact, my whole program halted at that point because my background wasn't even in memory.  I guess I should stay away from bios functions for a while.
<br/>
I researched hblank dma a bit and learned that it starts automatically after vblank but never during.  I know that was probably mentioned in a previous post, but I guess I needed to hear it in different words.  Now that I think about it, that line where I'm waiting on the condition REG_DISPSTAT &amp; DISPSTAT_VB seems really stupid to me now because it was never needed at all.  My main issue now is trying to get something other than a square window displaying properly (or at all), but I think I have bothered everyone here enough :).
<br/>
Thanks everyone for your help!  I really learned a lot in the past few days!  Maybe I will submit a windowing demo when I master them...<br/>_________________<br/>Nihongo o hanasemasen!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#52194 - jarobi - Sun Aug 28, 2005 7:07 am</h4>
    <div class="postbody"><span class="postbody">I know I said I'd shut up now, but I finally got my stuff working and thought I should share this info for anyone wanting to do neat windowing effects.  Remember the code I had in my main loop:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">//
<br/>
// EVIL NON_WORKING CODE &gt;:D~
<br/>
//
<br/>
waitForVBlank();
<br/>
REG_WIN0H = win_values[0];
<br/>
while (REG_DISPSTAT &amp; DISPSTAT_VB); //make sure DMA happens after vblank
<br/>
REG_DMA2SAD = (u32)(&amp;win_values[1]); //28-bit address
<br/>
REG_DMA2DAD = (u32)(&amp;REG_WIN0H); //27-bit addresses only
<br/>
REG_DMA2CNT_L = 1;
<br/>
REG_DMA2CNT_H = SRC_CONTROL(0)|DES_CONTROL(NO_INC_DEC)|START_MODE(XFER_HBLK)|BLOCK_SIZE_16|REPEAT|DMA_ENABLE;
<br/>
</td> </tr></table><span class="postbody">
<br/>
It seems that things are in the wrong order here!  Here's how it should go down.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">//
<br/>
// GOOD WORKING CODE O:)
<br/>
//
<br/>
REG_DMA3SAD = (u32)(&amp;win_values[1]); //28-bit address
<br/>
REG_DMA3DAD = (u32)(&amp;REG_WIN0H); //27-bit addresses only
<br/>
REG_DMA3CNT_L = 1;
<br/>
REG_DMA3CNT_H = SRC_CONTROL(0)|DES_CONTROL(NO_INC_DEC)|START_MODE(XFER_HBLK)|BLOCK_SIZE_16|REPEAT|DMA_ENABLE;
<br/>
waitForVBlank();
<br/>
REG_DMA3CNT_H = 0;
<br/>
REG_WIN0H = win_values[0];
<br/>
</td> </tr></table><span class="postbody">
<br/>
Since DMA takes two cycles to actually begin (which I recently learned off TONC), I was effectively turning it off before it even had a chance to begin.  I hardly think setting something to zero will take more than one or two cycles.  So, the hblank DMA needs time to complete, which makes it convenient to put a waitForVBlank function right after it.  And to make sure nothing gets screwed up, turn that s--t off upon entering vblank, set the first window value, and then proceed to do whatever.
<br/>
Thanks again everybody!  I'll shut up for good now... at least in this thread... :)<br/>_________________<br/>Nihongo o hanasemasen!</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
