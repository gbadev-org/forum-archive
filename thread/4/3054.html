<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Problems reinitialising tile memory - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>Coding > Problems reinitialising tile memory</h2>
<div id="posts">
<div class="post">
    <h4>#17823 - GunterPete - Mon Mar 15, 2004 2:50 pm</h4>
    <div class="postbody"><span class="postbody">Hi there,
<br/>
<br/>
I've written a CLevel class, allowing me to gather all the information for each level of a Mode7 game. The game looks like this:
<br/>
<a href="http://tbhl.theonering.net/petegunter/pics/project/jetpack.bmp">[Images not permitted - Click here to view it]</a>
<br/>
<br/>
This CLevel class includes a pointer to the tile data, to the map data (sky and floor), the levels palette and a pallete used for a copper bar effect to be loaded into the transparent colour every HBlank.
<br/>
<br/>
Here are the member variables:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
private:
<br/>
   const u16* m_ppalBackground;   //Pointer to levels pallette
<br/>
   const u16* m_pbmpMapTiles;      //Pointer to levels map tiles
<br/>
   const u8* m_pmapFloor;         //Pointer to levels floor map
<br/>
   const u8* m_pmapSky;         //Pointer to levels sky map
<br/>
   const u16* m_ppalCopper;      //Pointer to pallete used for copper bar effect
<br/>
<br/>
   FIXED m_gravity;            //FIXED :16 value of acceleration due to gravity
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
A method of the class is loadLvlIntoMemory, which loads all this information into the relevant areas of GBA memory:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
//Loads the map information into memory which includes:
<br/>
//  Load level palletes (map and copper bar)
<br/>
//   Level Tile Data (Char base block(0))
<br/>
//   Bg 1 (Text) map data,  Sky (Screen Base Block(30))
<br/>
//   Bg 2 (Rotation) map data, Floor (Screen Base Block(31))
<br/>
//   Gravity, fixed :16 into gGrav;
<br/>
// 
<br/>
void CLevel::loadLvlIntoMemory(void)
<br/>
{
<br/>
   /* Load in the palette data */
<br/>
   //Load in background pallete
<br/>
   DMA_Copy(3,(void*)m_ppalBackground,(void*)BGPaletteMem,256,DMA_16NOW);
<br/>
   //Load in the copper barpallete
<br/>
   DMA_Copy(3,(void*)m_ppalCopper,(void*)gpalCopper,160,DMA_16NOW);
<br/>
<br/>
<br/>
   /* Load in the tile data */
<br/>
   //Level tiles
<br/>
   DMA_Copy(3,(void*)m_pbmpMapTiles,(void*)CharBaseBlock(0),8190,DMA_16NOW);
<br/>
<br/>
   /* Load in the text background data */
<br/>
   //Temporary pointers to map data
<br/>
   u16* bg1map =(u16*)ScreenBaseBlock(30);
<br/>
<br/>
   int x=0,y=0; //iterating vars
<br/>
   for(y = 0; y &lt; 32; y++) //loop through all 32x32 tiles
<br/>
   {
<br/>
      for(x = 0; x &lt; 32; x++)
<br/>
      {
<br/>
         //*** BG 1 Sky
<br/>
         //First tile (Hiword)
<br/>
         bg1map[x + y*32] = m_pmapSky[x + y*32];
<br/>
      }
<br/>
   }
<br/>
<br/>
   /* Load in the rotation background data */
<br/>
   //Temporary pointer to map data
<br/>
   u16* bg2map =(u16*)ScreenBaseBlock(31);
<br/>
   for(y = 0; y &lt; 32; y++) //loop through all 32x32 tiles
<br/>
   {
<br/>
      for(x = 0; x &lt; 16; x++)
<br/>
      {
<br/>
         //*** BG 2 Floor
<br/>
         //First tile (Hiword)
<br/>
         bg2map[x + (y*16)] = (u16) (
<br/>
            ((u8)m_pmapFloor[(x*2) + y*32])
<br/>
         //Next tile (Loword)
<br/>
            +((u8)m_pmapFloor[(x*2)+1 + y*32]&lt;&lt;8)
<br/>
         );
<br/>
      }
<br/>
   }   
<br/>
<br/>
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
This seems to work fine the first time it is called. However whenever I try and switch levels, the map information is loaded in, but the tile and palette information isn't. Do I somehow need to clear the memory before reinitialising it? Am I just doing something genuinely very stupid? (this isn't at all unlikely).
<br/>
<br/>
The full project can be found at <a class="postlink" href="http://tbhl.theonering.net/petegunter/downloads/Jetpack.zip" target="_blank">http://tbhl.theonering.net/petegunter/downloads/Jetpack.zip</a> if anyones willing to take a look for me. In this code, level 1 is loaded when you hit L, and level 2 is (not :P) loaded when you hit R.
<br/>
<br/>
Kind regards,
<br/>
-Pete Gunter</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#17825 - poslundc - Mon Mar 15, 2004 3:14 pm</h4>
    <div class="postbody"><span class="postbody">That's a neat little game you got there.
<br/>
<br/>
Anyway, I'm not certain what your problem is, but I notice that you're using the DMA to copy in the stuff that won't copy, and iterating over loops to copy the stuff that will. Try copying the stuff manually, without using the DMA, and see if it will work. If it does, you know you need to fix your DMA function.
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#17827 - GunterPete - Mon Mar 15, 2004 4:37 pm</h4>
    <div class="postbody"><span class="postbody">Thanks for taking the time for looking at my code, and for the kind words.
<br/>
<br/>
Great suggestion. I tried as you said, and it's a vast improvement. The palette information and the map information is now being copied correctly. However now the tile information is corrupted (seems like random garbage). I'm probably just iterating it incorrectly, but I can't see where I'm going wrong.
<br/>
<br/>
Here's the new loadLvlIntoMemory() method:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">//Loads the map information into memory which includes:
<br/>
//  Load level palletes (map and copper bar)
<br/>
//   Level Tile Data (Char base block(0))
<br/>
//   Bg 1 (Text) map data,  Sky (Screen Base Block(30))
<br/>
//   Bg 2 (Rotation) map data, Floor (Screen Base Block(31))
<br/>
//   Gravity, fixed :16 into gGrav;
<br/>
// 
<br/>
void CLevel::loadLvlIntoMemory(void)
<br/>
{
<br/>
   /* Load in the palette data */
<br/>
   u8 p;
<br/>
   //Load in background pallete
<br/>
//   DMA_Copy(3,(u16*)m_ppalBackground,(u16*)BGPaletteMem,128,DMA_32NOW);
<br/>
   for(p=0; p&lt;128; p++)
<br/>
      ((u32*)BGPaletteMem)[p] = ((u32*)m_ppalBackground)[p];
<br/>
<br/>
   //Load in the copper bar pallete
<br/>
//   DMA_Copy(3,(u16*)m_ppalCopper,(u16*)gpalCopper,80,DMA_32NOW);
<br/>
   for(p=0; p&lt;80; p++)
<br/>
      ((u32*)gpalCopper)[p]=((u32*)m_ppalCopper)[p];
<br/>
<br/>
   /* Load in the tile data */
<br/>
   //Level tiles
<br/>
   //There are 256 tiles, each represented by 64 bytes.
<br/>
   //DMA_Copy(3,(void*)m_pbmpMapTiles,(void*)CharBaseBlock(0),4096,DMA_32NOW);
<br/>
   u16 t;
<br/>
   for(t=0; t&lt;4096; t++)
<br/>
      ((u32*)m_pbmpMapTiles)[t] = ((u32*)CharBaseBlock(0))[t];
<br/>
<br/>
<br/>
   /* Load in the text background data */
<br/>
   //Temporary pointers to map data
<br/>
   u16* bg1map =(u16*)ScreenBaseBlock(30);
<br/>
<br/>
   u8 x=0,y=0; //iterating vars
<br/>
   for(y = 0; y &lt; 32; y++) //loop through all 32x32 tiles
<br/>
   {
<br/>
      for(x = 0; x &lt; 32; x++)
<br/>
      {
<br/>
         //*** BG 1 Sky
<br/>
         //First tile (Hiword)
<br/>
         bg1map[x + y*32] = m_pmapSky[x + y*32];
<br/>
      }
<br/>
   }
<br/>
<br/>
   /* Load in the rotation background data */
<br/>
   //Temporary pointer to map data
<br/>
   u16* bg2map =(u16*)ScreenBaseBlock(31);
<br/>
   for(y = 0; y &lt; 32; y++) //loop through all 32x32 tiles
<br/>
   {
<br/>
      for(x = 0; x &lt; 16; x++)
<br/>
      {
<br/>
         //*** BG 2 Floor
<br/>
         //First tile (Hiword)
<br/>
         bg2map[x + (y*16)] = (u16) (
<br/>
            ((u8)m_pmapFloor[(x*2) + y*32])
<br/>
         //Next tile (Loword)
<br/>
            +((u8)m_pmapFloor[(x*2)+1 + y*32]&lt;&lt;8)
<br/>
         );
<br/>
      }
<br/>
   }   
<br/>
<br/>
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
I really appreciate your help. This is my final year project, and the deadline's in 3 days. :S
<br/>
<br/>
Regards,
<br/>
-Pete</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#17830 - johnny_north - Mon Mar 15, 2004 5:08 pm</h4>
    <div class="postbody"><span class="postbody">Pete-
<br/>
<br/>
I've had problems at times with the casting of raw or .o data myself say if I externed some raw tile data as u8 and then cast it as u16 for loading (it's been a while though, so I don't remember the details.)
<br/>
<br/>
At least, try casting the m_pbmpMapTiles and CharBaseBlock as u16* rather than u32* and use the for loop to load 16 bits at a time.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#17831 - XeroxBoy - Mon Mar 15, 2004 5:10 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">for(t=0; t&lt;4096; t++) 
<br/>
      ((u32*)m_pbmpMapTiles)[t] = ((u32*)CharBaseBlock(0))[t]; </td> </tr></table><span class="postbody">
<br/>
<br/>
Shouldn't this be the other way around?
<br/>
<br/>
As in:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">for(t=0; t&lt;4096; t++) 
<br/>
      ((u32*)CharBaseBlock(0))[t] = ((u32*)m_pbmpMapTiles)[t]; </td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#17832 - GunterPete - Mon Mar 15, 2004 5:17 pm</h4>
    <div class="postbody"><span class="postbody">XeroxBoy I could kiss you. I did say it was highly likely I was doing something stupid, and I was right! Sorry for posting, I really should have noticed that myself. :P
<br/>
<br/>
Relevant changes are made and it works fine now. I reckon I'm going to leave it loading in the data manually, at least for the hand-in. It seems to run fast enough for demoing purposes.
<br/>
<br/>
Horay! The practical projects now finished. Now I'd better get the report done. Why can't the markers just read the comments. ;)
<br/>
<br/>
Thanks everyone,
<br/>
-Pete</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
