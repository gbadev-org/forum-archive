<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>DevKitARM -> Code and Data in RAM - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>Coding > DevKitARM -> Code and Data in RAM</h2>
<div id="posts">
<div class="post">
    <h4>#26353 - funkeejeffou - Mon Sep 13, 2004 5:51 pm</h4>
    <div class="postbody"><span class="postbody">Hi,
<br/>
<br/>
I haven't found any docs on how putting code and data in specific RAM, and even after suscribing to the DevKitARM group, the info were still not clear.
<br/>
<br/>
1)Do I have to create specific .C files for each group of functiuns defined in the same RAM or ROM?
<br/>
2)Is the main functiun always in ROM?
<br/>
3)How can I malloc dynamically in specifics RAM(IWRAM or EWRAM)?
<br/>
4)www.devrs.com (although the FAQ is for DevkitAdv...) talks about #pragma long_calls, do I need this?
<br/>
5)Do I only need putting the "-mlong-calls" in the CFLAGS for it to work, is there an LDFLAG to set too?
<br/>
6)Is libgba absolutely necessary("gba_base.h")?
<br/>
7)What is the correct syntax for declaring variables and arrays(declared globally) in RAM, I always get error using the attribute stuff?
<br/>
<br/>
I know this is a lot of questions :)
<br/>
Thanks in advance !
<br/>
<br/>
Cheers, Jeff.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#26362 - tepples - Mon Sep 13, 2004 6:53 pm</h4>
    <div class="postbody"><span class="postbody"><ol type="1"><li>Assuming you've upgraded to devkitARM R8, the easiest way to get a function into IWRAM is by putting it in a separate file and calling the object file foo.iwram.o. Using a separate object file also gives you the chance to use ARM instructions. You can put all your ROM and EWRAM code into the same file; for that, you'd probably need to use the attribute. </li><li>main() is in ROM unless you've declared it otherwise. </li><li>malloc() goes to EWRAM. If you want to allocate IWRAM dynamically, you probably want to allocate from the stack. </li><li>Pragmas are evil. When a function in ROM needs to call a function in IWRAM or EWRAM, just use the long_call attribute on the function's prototype: </li></ol></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">__attribute__((long_call)) int gsm_decode(gsm, gsm_byte *, gsm_signal *);</td> </tr></table><span class="postbody"> <li>I don't remember needing anything in the linker. </li><li>My GSM Player uses devkitARM R8 without libgba. </li><li>Global arrays will end up in IWRAM unless you either declare them const (putting them into ROM or EWRAM depending on the multiboot specs) or specify in an attribute that they end up in EWRAM. <br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</li></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#26366 - funkeejeffou - Mon Sep 13, 2004 8:01 pm</h4>
    <div class="postbody"><span class="postbody">1) Yes I am using the R8 version. Is calling my file "file.iwram.c" enough?
<br/>
For the ARM instructiuns, you mean I can compile only this file with "-marm" so that I take advantage of the memory BUS related to IWRAM?
<br/>
3) What does allocate from the stack means?
<br/>
4)This is a sample from the group discussion :
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void __attribute__((section(".iwram"), long_call)) Fn(parameters)
<br/>
<br/>
if you want to call code in ROM or EWRAM from IWRAM you need to
<br/>
use-mlong-calls when compiling.</td> </tr></table><span class="postbody">
<br/>
The attribute stuff is placed before the return type of the  functiun, and it also specifies where the functiun is placed in memory. It is clearly different from what you have said. Also, I tried it out(the one from the discussion group), but it doesn't work unless I place all functiuns in the same RAM or ROM... Weird...
<br/>
7)So if I have understood well :
<br/>
a) For ROM, declare global const variables
<br/>
b)For EWRAM, declare a global pointer and malloc it so it goes in EWRAM
<br/>
c)For IWRAM, declare a global array
<br/>
What about a global pointer allocated dynamically in IWRAM?
<br/>
And a global array in EWRAM(without using malloc)?
<br/>
<br/>
From the discussion group :
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#define IWRAM_DATA __attribute__(section(".iwram"))
<br/>
#define EWRAM_DATA __attribute__(section(".ewram"))
<br/>
#define EWRAM_BSS __attribute__(section(".sbss"))</td> </tr></table><span class="postbody">
<br/>
<br/>
I couldn't manage to make this stuff compiled though...
<br/>
<br/>
<br/>
Thanks in advance, Jeff.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#26369 - tepples - Mon Sep 13, 2004 8:54 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>funkeejeffou wrote:</b></span></td> </tr> <tr> <td class="quote">1) Yes I am using the R8 version. Is calling my file "file.iwram.c" enough?</td> </tr></table><span class="postbody">
<br/>
Yes, provided the link script supports it. The default GBA link scripts for DevKit Advance R5b3 and devkitARM R8 do.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">For the ARM instructiuns, you mean I can compile only this file with "-marm" so that I take advantage of the memory BUS related to IWRAM?</td> </tr></table><span class="postbody">
<br/>
Yes. In my makefiles, I have set %.iwram.o to use -marm and others to use -mthumb.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">What does allocate from the stack means?</td> </tr></table><span class="postbody">
<br/>
It means make a local variable using the default 'auto' allocation method:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void foo()
<br/>
{
<br/>
  int x[1024];
<br/>
<br/>
  /*... */
<br/>
}</td> </tr></table><span class="postbody">
<br/>
Some versions of GCC may allow making the array size a variable. I haven't worked with this much.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void __attribute__((section(".iwram"), long_call)) Fn(parameters)
<br/>
<br/>
if you want to call code in ROM or EWRAM from IWRAM you need to
<br/>
use-mlong-calls when compiling.</td> </tr></table><span class="postbody">
<br/>
The attribute stuff is placed before the return type of the  functiun, and it also specifies where the functiun is placed in memory. It is clearly different from what you have said.</span></td> </tr></table><span class="postbody">
<br/>
GCC seems rather lenient about where you put the attribute. There's more than one way to do it; I just recommend what I've found comfortable.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">a) For ROM, declare global const variables
<br/>
b)For EWRAM, declare a global pointer and malloc it so it goes in EWRAM
<br/>
c)For IWRAM, declare a global array
<br/>
What about a global pointer allocated dynamically in IWRAM?</td> </tr></table><span class="postbody">
<br/>
IWRAM is too small for dynamic allocation except for local variables on the stack.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">And a global array in EWRAM(without using malloc)?</td> </tr></table><span class="postbody">
<br/>
I haven't used it because anything put in section .ewram takes ROM space, even if it's all zeroed, and I haven't had time to try section .sbss.
<br/>
<br/>
If you want help with getting a specific example to compile, then please post your best effort along with the specific error messages it returns.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
