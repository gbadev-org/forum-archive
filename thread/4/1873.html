<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Compiling into THUMB / ARM - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>Coding > Compiling into THUMB / ARM</h2>
<div id="posts">
<div class="post">
    <h4>#9601 - regularkid - Sun Aug 10, 2003 3:39 am</h4>
    <div class="postbody"><span class="postbody">Hi. I've got a problem with compiling code into THUMB / ARM. I'm not very familiar with how the compiler really works and I've read the docs and FAQ at devrs but still can't seem to figure some things out. Any help would be great!
<br/>
<br/>
So, I'm mixing C code and ASM code and want to make sure that everything gets compiled to the right format / place in memory. I have been looking at my memory map that gets outputted from the compiler and it seems that code and constants are being placed into ROM (0x08000000 and up). This is cool, becuase it is where I want it to go. However, I want to make sure that it is compiling into THUMB code since it wouldn't be very smart to put ARM code into ROM seeing how it is 16bit memory and ARM opcodes are 32bit. Here is my makefile:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
CC      =   gcc -mthumb-interwork
<br/>
AS      =   as -mthumb-interwork
<br/>
<br/>
GCCARM  =   C:\DevKitAdv\bin
<br/>
INCDIR  =   C:\DevKitAdv\include
<br/>
LIBDIR  =   C:\DevKitAdv\lib
<br/>
<br/>
GAME   =   Game
<br/>
<br/>
CFILES   =   Debug.c               \
<br/>
      Dma.c               \
<br/>
      Input.c               \
<br/>
      Irq.c               \
<br/>
      Level.c               \
<br/>
      Main.c               \
<br/>
      Math.c               \
<br/>
      Render.c            \
<br/>
      Sprite.c            \
<br/>
      Timer.c               \
<br/>
      Video.c               \
<br/>
<br/>
SFILES   =   Video.S               \
<br/>
      Render.S            \
<br/>
<br/>
OBJS   =   $(CFILES:.c=.o)            \
<br/>
      $(SFILES:.S=_ASM.o)         \
<br/>
<br/>
ASFLAGS =   
<br/>
CFLAGS   =   -c -Wall
<br/>
LFLAGS   =   -TLinkscript -Wl,-Map,Memory_map
<br/>
<br/>
##############################################################
<br/>
## RULES
<br/>
##############################################################
<br/>
Code : $(GAME).bin
<br/>
   @ECHO
<br/>
   @ECHO CODE BUILD COMPLETE!
<br/>
<br/>
$(GAME).bin : $(GAME).elf
<br/>
   @ECHO
<br/>
   @ECHO ----------------------------
<br/>
   @ECHO Making Game binary...
<br/>
   @objcopy -O binary $(GAME).elf $(GAME).bin
<br/>
<br/>
$(GAME).elf : $(OBJS)
<br/>
   @ECHO Linking...
<br/>
   @$(CC) $(LFLAGS) -o $(GAME).elf $(OBJS) -lc -lgcc -lm
<br/>
<br/>
%.o : %.c
<br/>
   @ECHO Compiling $&lt;...
<br/>
   @$(CC) $(CFLAGS) $&lt; -o $@
<br/>
<br/>
clean :
<br/>
   @ECHO Cleaning files...
<br/>
   @rm -f *.o
<br/>
<br/>
##############################################################
<br/>
## DEPENDENCIES
<br/>
##############################################################
<br/>
include C:\Game\Dependencies\Debug.dpn
<br/>
include C:\Game\Dependencies\Input.dpn
<br/>
include C:\Game\Dependencies\Main.dpn
<br/>
include C:\Game\Dependencies\Video.dpn
<br/>
include C:\Game\Dependencies\Timer.dpn
<br/>
include C:\Game\Dependencies\Dma.dpn
<br/>
include C:\Game\Dependencies\Level.dpn
<br/>
include C:\Game\Dependencies\Math.dpn
<br/>
include C:\Game\Dependencies\Sprite.dpn
<br/>
include C:\Game\Dependencies\Irq.dpn
<br/>
include C:\Game\Dependencies\Render.dpn
<br/>
<br/>
Video_ASM.o : Video.S
<br/>
   @ECHO Assembling Video.S...
<br/>
   @$(AS) $(ASFLAGS) Video.S -o Video_ASM.o
<br/>
<br/>
Render_ASM.o : Render.S
<br/>
   @ECHO Assembling Render.S...
<br/>
   @$(AS) $(ASFLAGS) Render.S -o Render_ASM.o
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Now, how would I make sure that the .c files get compiled into THUMB code instead of ARM. By the way, the linkscript file is just a generic one that I downloaded from the FAQ on devrs.
<br/>
<br/>
Next, here is the basic setup for all my ASM files:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
.THUMB
<br/>
.ALIGN 2
<br/>
.THUMB_FUNC
<br/>
<br/>
.GLOBAL myFunc
<br/>
<br/>
myFunc:
<br/>
      [... code]
<br/>
      bx      lr
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Then I have the function prototypes in the .h files so that these asm functions can be called from .c code. However, the problem I have here is that when I look at the code in my emulator's disassembler I can see the opcodes are duplicated twice in each 32bits instead of just having the one 16 bit opcode, so it comes up as "&lt;Undefined Opcode&gt;" in the disassembler. However, when I use .ARM code, it works fine (but I obviously want to use THUMB code because it will be faster in ROM).
<br/>
<br/>
Basically, I am just really confused as to how most of this stuff works, so if anyone could help me out in any way I would really appreciate it. Thanks!<br/>_________________<br/>- RegularKid</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#9602 - regularkid - Sun Aug 10, 2003 5:46 am</h4>
    <div class="postbody"><span class="postbody">Well, i was debugging some more and (by looking at the CPSR) it seems that as soon as the program gets into main() and from then on, it is in ARM mode. So this must mean that I am compiling all my code into ARM code. How would I make it so that all my code is THUMB and only certain code modules (mainly small ASM funcs that are in RAM) are compiled into ARM? Thanks!<br/>_________________<br/>- RegularKid</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#9603 - regularkid - Sun Aug 10, 2003 6:31 am</h4>
    <div class="postbody"><span class="postbody">Ok, after searching the forum posts here, I found what I was looking for, but I still am getting some weird errors. So, this is how I beleive I choose whether to compile to ARM or THUMB:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
gcc -marm -mthumb-interwork
<br/>
gcc -mthumb -mthumb-interwork
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I would use one of these depending on which type of code I wanted to compile into. Cool! So, I changed my makefile and made most of my files compile into THUMB, but a few needed to be compiled into ARM. Everything compiles fine, but when it trys to link I get tons of errors saying:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
/cygdrive/c/DEVKIT~1/BIN/../lib/gcc-lib/arm-agb-elf/3.0.2/../../../../arm-agb-elf/bin/ld: Warning: strcmp.o does not support interworking, whereas Game.elf does
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I thought that adding the "-mthumb-interwork" would fix the calls between arm/thumb code. Am I missing something here? I will keep searching around for answers, but any help would be very nice. Thanks!<br/>_________________<br/>- RegularKid</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#9607 - DekuTree64 - Sun Aug 10, 2003 4:54 pm</h4>
    <div class="postbody"><span class="postbody">Yeah, I was reading this post yesterday and I thought it sounded like it wasn't interworking properly, but then I saw that you had specified -mthumb-interwork so I was stumped and didn't reply. Maybe try moving it from the CC definition to CFLAGS. I don't think it would make any difference, but you never know. 
<br/>
Also, you should compile ASM files with GCC, cause I'm not sure if as runs the preprocessor on it even if it is .S instead of .s. GCC stands for GNU Cross Compiler, not GNU C Compiler (as I once thought^_^), so you just call it for everything and let it decide what to do by the file extension.<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#9608 - regularkid - Sun Aug 10, 2003 5:34 pm</h4>
    <div class="postbody"><span class="postbody">hooray! I finally got it working. I'm actually not sure what happened, but I re-downloaded devkitadvance and then after a rebuild all, the linking errors went away! I'm going to keep checking/testing to make sure that everything did infact get compiled correctly, but it seems that everything is good now!<br/>_________________<br/>- RegularKid</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#9623 - torne - Mon Aug 11, 2003 11:22 am</h4>
    <div class="postbody"><span class="postbody">The error given previously indicates that it was linking against the non-interworking version of libc. Doing a fresh build should probably fix that (as it did).
<br/>
<br/>
DekuTree is right; .S files should be assembled with GCC. If it's working for you using as, then you are presumably not actually using any preprocessor instructions. BTW, GCC stands for GNU Compiler Collection, not cross-compiler. It did *used* to stand for GNU C Compiler.
<br/>
<br/>
Torne</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
