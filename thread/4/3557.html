<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Objects in mode7 - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>Coding > Objects in mode7</h2>
<div id="posts">
<div class="post">
    <h4>#22108 - ProblemBaby - Sun Jun 13, 2004 3:06 pm</h4>
    <div class="postbody"><span class="postbody">Hi
<br/>
<br/>
Iam trying to place some objects in my mode7 environment but it won't work! and I cant understand why.
<br/>
<br/>
I've started to just get the right position (no scaling) and my code goes something like this.
<br/>
<br/>
d = viewdistance;
<br/>
obj_x, obj_y, obj_z = object position in world space
<br/>
cam_x, cam_y, cam_z = camera position in world space
<br/>
spr_x, spr_y, spr_width, spr_height = sprite pos and size
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
x = obj_x - cam_x;
<br/>
y = obj_y - cam_y;
<br/>
z = obj_z - cam_z;
<br/>
<br/>
spr_x = (120+((x * d) / z)) - (spr_width/2);
<br/>
spr_y = (80-((y * d) / z)) - (spr_height/2);
<br/>
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
yes it is many divisions but i'll get rid of it when it works...
<br/>
then I wonder how to achieve the correct scale.
<br/>
<br/>
plz help!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#22120 - keldon - Sun Jun 13, 2004 6:00 pm</h4>
    <div class="postbody"><span class="postbody">what's your input data, if you mind me asking?
<br/>
<br/>
hold on .. I'm about to edit this post to just give you a correct formula</span><span class="gensmall"><br/><br/>Last edited by keldon on Sun Jun 13, 2004 6:04 pm; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#22121 - ProblemBaby - Sun Jun 13, 2004 6:02 pm</h4>
    <div class="postbody"><span class="postbody">um input that should work.. if its done in a correct way but
<br/>
I think it is one thing that is missed.. but I dont know what=((</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#22122 - keldon - Sun Jun 13, 2004 6:11 pm</h4>
    <div class="postbody"><span class="postbody">spr_x = 120 + ( x / ( z + d )) * d
<br/>
spr_y = 80 + ( y / ( z + d )) * d
<br/>
<br/>
spr_width = ( spr_width / ( z + d )) * d
<br/>
spr_height = ( spr_height / ( z + d )) * d
<br/>
<br/>
---
<br/>
it's basically trigonometry, the same used in 3d perspective conversion. And by changing d, you get the effect of zooming in and not just getting closer - there is a big difference. Just watch out for divide by 0. And to test that it works, set z to 0 and it should come out in roughly the correct places - but if you want them exact the rewrite the formula so that it multiplies x then divides.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#22124 - ProblemBaby - Sun Jun 13, 2004 6:30 pm</h4>
    <div class="postbody"><span class="postbody">when I try this the sprite appears in the middle of the screen all the time
<br/>
even if I change the pos of the object or the camera
<br/>
<br/>
x, y, z  is the relative coordinates between cam and obj right?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#22143 - keldon - Sun Jun 13, 2004 9:15 pm</h4>
    <div class="postbody"><span class="postbody">spr_x = 120 + (x * d) / (z + d)
<br/>
spr_y = 80 + (y * d) / (z + d)
<br/>
<br/>
it's a precision thing, if you divide and make 0 all the time, then it will all be in the middle.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#22187 - Cearn - Mon Jun 14, 2004 12:28 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>keldon wrote:</b></span></td> </tr> <tr> <td class="quote">spr_x = 120 + (x * d) / (z + d)
<br/>
spr_y = 80 + (y * d) / (z + d)
<br/>
<br/>
it's a precision thing, if you divide and make 0 all the time, then it will all be in the middle.</td> </tr></table><span class="postbody">
<br/>
You mean a fixed point thing, right? But that shouldn't matter much in this case since the endresult is supposed to be a pure integer anyway. (or was that the point of your post?)
<br/>
You may want to lose the extra addition by <span style="font-style: italic">d</span>, though, since the top of the viewing pyramid is at z=0, not z=-d. Also, remember that the screen y-axis points down, while your world y-zxis probably points up, which would mean that the you need to subtract the projected y coord, not add.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
spr_x = 120 + (x * d) / (z)
<br/>
spr_y = 80 - (y * d) / (z)
<br/>
</td> </tr></table><span class="postbody">
<br/>
You can cut down on one of the divisions if you out something like (d&lt;&lt;16)/z in a temporary first; though you might have to play with the exact shift a bit.
<br/>
<br/>
For proper scaling, you'd have to use something like pa=pc=z/d, though there are reasons for doubling this number. Of course, you still to alter a few things when you rotate (either yaw or pitch), and there's still clipping 
<br/>
to take care of.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#22188 - keldon - Mon Jun 14, 2004 1:16 pm</h4>
    <div class="postbody"><span class="postbody">It's a trigonometry thing, so we need ( z + d ) for the scaling, which is weighted by the value of <span style="font-weight: bold">d</span>.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
^  |-----/ obj_x - cam_x
<br/>
|$ |    /
<br/>
v  |   /
<br/>
^  |--/     spr_x
<br/>
|? | /
<br/>
v  |/
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
<span style="font-weight: bold">?</span> represents d, <span style="font-weight: bold">$</span> represents obj_z - cam_z (z)
<br/>
<br/>
So what this does is scale obj_x - cam_x to calculate spr_x. I rewrote the order because (z + d) is likely to be greater than x, so <span style="font-weight: bold">x / (z + d)</span> would most likely result in 0. I just forgot that problem completely when writing the formula, because I'd usually work in floats.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#22192 - Cearn - Mon Jun 14, 2004 2:47 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>keldon wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
It's a trigonometry thing, so we need ( z + d ) for the scaling, which is weighted by the value of d. 
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
^  |-----/ obj_x - cam_x 
<br/>
|$ |    / 
<br/>
v  |   / 
<br/>
^  |--/     spr_x 
<br/>
|? | / 
<br/>
v  |/ 
<br/>
</td> </tr></table><span class="postbody">
<br/>
? represents d, $ represents obj_z - cam_z (z)
<br/>
</span></td> </tr></table><span class="postbody">
<br/>
This really depends on the relationship between the camera and the projection plane. In your case you have the projection plane at z=0 and the camera at z=-d; usually you'll take the camera at the origin and z=d (or z=-d in a righthanded system). 
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
       spr_x
<br/>
      |    obj_x
<br/>
      |  |
<br/>
^  |-----/ - obj_z
<br/>
|$ |    / 
<br/>
v  |   / 
<br/>
^  |--/    - spr_z 
<br/>
|? | / 
<br/>
v  |/      - cam_z
<br/>
</td> </tr></table><span class="postbody">
<br/>
In camera space (which has the camera position as its origin), then 
<br/>
<span style="font-weight: bold">x</span> = <span style="font-weight: bold">x_obj-x_cam</span> (vector!) and the projection plane is d in front of the camera, so spr_z=d. In that case, x_spr = x_obj *d / z. For example, if an object is located d units in front of the camera (that is, z=d), it's scale should be 1, which indeed would happen with d/z, but not with d/(d+z).
<br/>
<br/>
EDIT: now I remember what the deal was here. What is casually called " the camera position" can be either the back of the camera,in which case you'd use d/z; or the front of the camera, which uses d/(d+z). Which of these you use is a matter of taste, though I think most of the time it means the back of the camera, though.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#22200 - keldon - Mon Jun 14, 2004 5:04 pm</h4>
    <div class="postbody"><span class="postbody">oh, I get your formula now; camera at 0,0,0. I usually have the screen at 0,0,0; but I think your way is much better as it means you don't have the additional add</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#22216 - ProblemBaby - Mon Jun 14, 2004 11:11 pm</h4>
    <div class="postbody"><span class="postbody">Today i changed my mind I dont want a mode7 environment
<br/>
just a background that doesn't move something like this
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
     ___
<br/>
    /    \
<br/>
   /      \
<br/>
  /________\
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
its just a picture
<br/>
well i found out that I could do this to find out the x-coordinate
<br/>
for an object in this picture
<br/>
<br/>
slope of the outer line (in y) = x/y
<br/>
and then build a table
<br/>
like
<br/>
zTable[z] = FAR_X2 + (z * slope)
<br/>
<br/>
and then if I had a x-world coordinate between -1 and 1 just multiply it
<br/>
with tzTable[obj_scr_y] i found out the correct x coordinate.
<br/>
and i can use it to scale it so it looks good
<br/>
<br/>
but the question is how do I found the correct y??
<br/>
<br/>
if I just have a picture to look at is itsome lines that tells how much the object should move in y-direction (screen) according to the world_z???
<br/>
or is it impossible to find out?[/code]</span><span class="gensmall"><br/><br/>Last edited by ProblemBaby on Mon Jun 14, 2004 11:49 pm; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#22217 - keldon - Mon Jun 14, 2004 11:49 pm</h4>
    <div class="postbody"><span class="postbody">I gather that the <span style="font-weight: bold">z</span> values are finite, right? And this is the picture you meant to draw??
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">    _____
<br/>
   /     \
<br/>
  /       \
<br/>
 /         \
<br/>
/___________\</td> </tr></table><span class="postbody">
<br/>
<br/>
Movement in the X and Y direction is straight forward, just make sure that your camera position is in line with your background picture. I would do this with a sheet of paper, and a calculator to plot coordinates of the background so that it perfectly matches the camera position.
<br/>
<br/>
The correct <span style="font-weight: bold">Y</span> will be found by using the <span style="font-weight: bold">z</span> value, as moving away from the camera will now also raise the sprites on screen position. And the <span style="font-weight: bold">Y</span> value is scaled however you see fit - - although you may wish for it to be precise, so get your calculator out.
<br/>
<br/>
I assume you know and understand the trigonometry involved ?!?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#22221 - ProblemBaby - Tue Jun 15, 2004 12:33 am</h4>
    <div class="postbody"><span class="postbody">Yes it was:D
<br/>
<br/>
but I have try and i cant find out the connection between z-world and
<br/>
y-screen.
<br/>
<br/>
I know how I should scale and the x position if I get the correct y-screen coordinate, Iam quite sure about it had exact as the x value something
<br/>
with the slope of the outer lines to do but I cant find out the actual formula.=(</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#22235 - keldon - Tue Jun 15, 2004 11:05 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">    a1_____ a2
<br/>
     /     \ 
<br/>
    /       \ 
<br/>
   /         \ 
<br/>
a3/___________\a4
<br/>
</td> </tr></table><span class="postbody">
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">   &lt;|  (camera)
<br/>
<br/>
      a3,4__________a1,2  (ground)
<br/>
</td> </tr></table><span class="postbody">
<br/>
now the camera has a position; which should be at about (120,80,-400) for its (X,Y,Z), [b]d[/d] should be about 200. Now set a1-a2 at (Z=400,Y=0) and a3-a4 at (Z=0, Y=0) and a1-a3 at (Y=0, X=0) and a2-a4 at (Y=0, x=240) for now. And just calculate the screen x position using our formulas we gave you; and experiment until you are satisfied with its arrangement on the screen. Also jig about with the camera etc.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#22241 - ProblemBaby - Tue Jun 15, 2004 4:12 pm</h4>
    <div class="postbody"><span class="postbody">Thanks alot!
<br/>
now I know how to do (almost) everything!
<br/>
<br/>
my very last problem is:
<br/>
Ive started do draw dots at the edges of my square (board)-picture
<br/>
to find out which values I should use for everything.
<br/>
<br/>
but when I look at it the camera isnt just like this:
<br/>
<br/>
|_|&lt;
<br/>
            ________________
<br/>
<br/>
more like this:
<br/>
<br/>
\
<br/>
  \
<br/>
   /_
<br/>
 / |
<br/>
<br/>
<br/>
   _____________________
<br/>
<br/>
I do my transformation like this:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
<br/>
// COS, SIN is a table 0-255 with fixed values for sin and cos
<br/>
<br/>
theta = 256 - 64;
<br/>
x = IntToFixed((BOARD_LEFT - CAMERAX));
<br/>
y = IntToFixed((0 - CAMERAY));
<br/>
z = IntToFixed((BOARD_FAR - CAMERAZ));
<br/>
<br/>
//I thought that the 'rotate around pitch' transformation looked like this
<br/>
y = FixedMul(y, COS[theta]) + FixedMul(z, SIN[theta]);
<br/>
z = FixedMul(y, -SIN[theta]) + FixedMul(z, COS[theta]);
<br/>
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#22243 - ProblemBaby - Tue Jun 15, 2004 4:40 pm</h4>
    <div class="postbody"><span class="postbody">omg it should be minus of course!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#22310 - ProblemBaby - Thu Jun 17, 2004 12:38 pm</h4>
    <div class="postbody"><span class="postbody">Now Ive only two problems left!
<br/>
my sprite is 8x8x8 size in the world
<br/>
<br/>
In the cameratransformation should i do like this?? to later find the correct x1, y1 in screen coords?
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
x = (x_obj - 4) - x_cam; // 4 is the half of the size of the object in world
<br/>
y = (y_obj - 4) - y_cam; // 4 is the half of the size of the object in world
<br/>
z = (z_obj - 4) - z_cam; // 4 is the half of the size of the object in world
<br/>
<br/>
// here goes the rotation
<br/>
// and here the perspective transform
<br/>
// and screen transform
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Is this how it should be done? it doesnt feel correct=/
<br/>
<br/>
then how do I find the scalefactor??
<br/>
like this?
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
x1 = (x_obj - 4) - x_cam; // 4 is the half of the size of the object in world
<br/>
y1 = (y_obj - 4) - y_cam; // 4 is the half of the size of the object in world
<br/>
z1= (z_obj - 4) - z_cam; // 4 is the half of the size of the object in world
<br/>
<br/>
x2 = (x_obj + 4) - x_cam; // 4 is the half of the size of the object in world
<br/>
y2 = (y_obj + 4) - y_cam; // 4 is the half of the size of the object in world
<br/>
z2 = (z_obj + 4) - z_cam; // 4 is the half of the size of the object in world
<br/>
<br/>
// here goes the rotation
<br/>
// and here the perspective transform
<br/>
// and screen transform
<br/>
<br/>
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
x2-x1 = size in pixels, but that isn't true=/
<br/>
I know that I dont just can use X but how should i do?
<br/>
<br/>
and last which should i do first translation or rotation?
<br/>
<br/>
help would be great or a link to a tutorial that talks about billboarding
<br/>
(with software), cant find any=/</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#22369 - Cearn - Sat Jun 19, 2004 3:45 pm</h4>
    <div class="postbody"><span class="postbody">Remember that sprites aren't 3d objects. Almost everytime you have a sprite in a 3d world it will use one 3d coordinate, which corresponds to one screen coordinate, which is where the sprite will be placed. The whole sprite will use <span style="font-style: italic">one</span> scale, based on this transformation.
<br/>
The problem with this is that when you rotate, the sprite will seem to rotate with you in such a way that you're always facing it (see Doom for example, or any old 3d or mode 7 game). To be sure it seems to rotate around the right point, you'll have to define an anchor point on the sprite, which corresponds to `the' sprite's position in world space and the compensate for this anchor's position (as well the scaling) when you write the screen location to OAM.
<br/>
<br/>
I have this on code on my site (the mode7d demo) and had hoped to have a document explaining it all by the end of this week, but didn't quite make it, though you can see a draft <a class="postlink" href="http://user.chem.tue.nl/jakvijn/files/m7theory.zip" target="_blank">here</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#22380 - ProblemBaby - Sat Jun 19, 2004 7:58 pm</h4>
    <div class="postbody"><span class="postbody">Yeah I read it but I found out almost myself how should be done
<br/>
with some own touch though;D
<br/>
but it looks good at works well and thats the most important thing for the moment.
<br/>
<br/>
And since Ive a view that doesnt rotate the rotation problem 
<br/>
is no problem.
<br/>
<br/>
Thanks for all support!
<br/>
especially Keldon
<br/>
and Cearn for your tutorials</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#22389 - dagamer34 - Sun Jun 20, 2004 12:21 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>ProblemBaby wrote:</b></span></td> </tr> <tr> <td class="quote">Yeah I read it but I found out almost myself how should be done
<br/>
with some own touch though;D
<br/>
but it looks good at works well and thats the most important thing for the moment.
<br/>
<br/>
And since Ive a view that doesnt rotate the rotation problem 
<br/>
is no problem.
<br/>
<br/>
Thanks for all support!
<br/>
especially Keldon
<br/>
and Cearn for your tutorials</td> </tr></table><span class="postbody">
<br/>
<br/>
Feel like sharing the code? :)<br/>_________________<br/>Little kids and Playstation 2's don't mix. :(</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
