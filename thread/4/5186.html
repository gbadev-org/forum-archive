<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Why is this game so slow? - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>Coding > Why is this game so slow?</h2>
<div id="posts">
<div class="post">
    <h4>#37653 - philip - Mon Mar 14, 2005 8:29 pm</h4>
    <div class="postbody"><span class="postbody">Hi, 
<br/>
<br/>
I've written this simple little driving game where you go around picking up items and delivering them to somewhere else. Trouble is, it's much slower than I think it should be on real hardware. I've removed all the trig and floating point maths, but it still won't run at 60 frames a second. 
<br/>
<br/>
 You can find the code at: <a href="http://www.vertex.ukfsn.org/pickup/v12/main.c" target="_blank">http://www.vertex.ukfsn.org/pickup/v12/main.c</a>
<br/>
<br/>
 The support files can be found here: <a href="http://www.vertex.ukfsn.org/pickup/pickup_src.zip" target="_blank">http://www.vertex.ukfsn.org/pickup/pickup_src.zip</a> (The "main.c" above should be used instead of the one in this archive) 
<br/>
<br/>
 I think that maybe I'm not handing off between the mainloop and vertical blank interrupt correctly, or it could be I'm just too slow. Does HAM have a large overhead?
<br/>
<br/>
I've posted this previously on the HAM forum, and somebody suggested it seemed to be using a lot of divides. In fact, most of the divides involve only constant terms. I have confirmed these are being calculated at compile time and are present in the intermediate assembly code as pre-calculated literal terms. There is only one actual divide per frame, plus a lot of bit shifts.
<br/>
<br/>
If anybody could tell me what was wrong here, I'd be eternally grateful!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#37660 - tepples - Mon Mar 14, 2005 9:33 pm</h4>
    <div class="postbody"><span class="postbody">You seem to be running your program in an emulator. Have you made sure to turn off frameskip? If you are running your program in VisualBoyAdvance, does VBA indicate that it is running at 100 percent speed? How fast is your computer?<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#37671 - sajiimori - Mon Mar 14, 2005 11:57 pm</h4>
    <div class="postbody"><span class="postbody">In your collision function, you're using &amp;&amp; where you probably meant &amp;.  The result is that the conditions succeed on any nonzero tile values.
<br/>
<br/>
If it's still slow after fixing those bugs, the text drawing might take a long time (if it's variable width), and I don't know how much work ham_InitMapFragment and ham_InsertMapFragment are doing, but if it's a lot then that's something to consider because they're apparently done every frame if you're not driving fast.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#37754 - philip - Tue Mar 15, 2005 9:21 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>sajiimori wrote:</b></span></td> </tr> <tr> <td class="quote">In your collision function, you're using &amp;&amp; where you probably meant &amp;.  The result is that the conditions succeed on any nonzero tile values.
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Well spotted! The reason this bug got through is because I actually only use two types of tile, making the results identical. Unfortunately, this isn't the reason it's so slow, and nor are the text and map functions, which are only called infrequently (those map functions aren't called every frame; only when we reach a pickup/dropoff point)
<br/>
<br/>
So, using the first rule of stubborn trouble shooting, I've stripped the program down to it's simplest form. I've just left in the main loop which receives our control presses and drives us around, and wouldn't you know it, that's slow as well, but not all the time!
<br/>
<br/>
Turns out it is slow when: we drive straight up, we turn, or we are moving slowly, but just watch the frame rate pickup when you turn slightly off centre and reach a certain speed! (and then slow down again when you turn, or point straight up) I wondered if this could be a problem with the accuracy of my fixed point maths, rather than dropped frames, but if that were the case, it'd be broken on an emulator as well, which it isn't.
<br/>
<br/>
You can find it here: <a href="http://www.vertex.ukfsn.org/pickup/pickup_stripped/main.c" target="_blank">http://www.vertex.ukfsn.org/pickup/pickup_stripped/main.c</a>
<br/>
<br/>
and get the ROM here (you must run this on hardware, otherwise you can't see the problem): <a href="http://www.vertex.ukfsn.org/pickup/pickup_stripped/PICKUP.gba" target="_blank">http://www.vertex.ukfsn.org/pickup/pickup_stripped/PICKUP.gba</a>
<br/>
<br/>
So, if anybody likes a good trouble shooting mystery, please take a look and put me out of my misery!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#37759 - jma - Tue Mar 15, 2005 11:17 pm</h4>
    <div class="postbody"><span class="postbody">I'd put serious money down on this line right here:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">frameready = 1;</td> </tr></table><span class="postbody">
<br/>
<br/>
Seriously, unless your vblank occurs after that and before the beginning of your (very large) <span style="font-weight: bold">if</span>, it is going to be skipped. Your game isn't slow, you just aren't entering your <span style="font-weight: bold">if</span> very often. Put that line inside the <span style="font-weight: bold">if</span> and see what happens then. I think you'll be pleasantly surprised. :)
<br/>
<br/>
Jeff M.<br/>_________________<br/><a href="mailto:massung@gmail.com">massung@gmail.com</a>
<br/>
<a href="http://www.retrobyte.org" target="_blank">http://www.retrobyte.org</a></span><span class="gensmall"><br/><br/>Last edited by jma on Thu Mar 17, 2005 1:17 am; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#37812 - philip - Thu Mar 17, 2005 1:15 am</h4>
    <div class="postbody"><span class="postbody">That's it! Thanks Jeff! As I thought in the original post, I thought I'd probably done something stupid, because there's no way it should be so staggeringly slow with virtually no calculations.
<br/>
<br/>
It's now running like a dream. Check it and my other game out at:
<br/>
<a href="http://www.vertex.ukfsn.org" target="_blank">http://www.vertex.ukfsn.org</a>
<br/>
<br/>
Any feedback would be greatly appreciated</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
