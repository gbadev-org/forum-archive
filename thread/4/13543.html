<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>running code in DS' shared iwram - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>Coding > running code in DS' shared iwram</h2>
<div id="posts">
<div class="post">
    <h4>#132770 - Ant6n - Fri Jun 29, 2007 6:30 am</h4>
    <div class="postbody"><span class="postbody">I am trying to run code in shared iwram on the arm9 side. I started with the devkitpro arm7/arm9 template. My main is this:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#include &lt;nds/arm9/console.h&gt; //basic print funcionality
<br/>
<br/>
#include "asm.h"
<br/>
#include "dssystem.h"
<br/>
<br/>
#define SHARED ((vuint32*)0x03000000)
<br/>
typedef u32 testfunction(u32 in) __attribute__ ((long_call));
<br/>
<br/>
int main(void) {
<br/>
   videoSetMode(0);
<br/>
   videoSetModeSub(MODE_0_2D | DISPLAY_BG0_ACTIVE);
<br/>
   vramSetBankC(VRAM_C_SUB_BG);
<br/>
   SUB_BG0_CR = BG_MAP_BASE(31);
<br/>
   BG_PALETTE_SUB[255] = RGB15(31,31,31);
<br/>
   consoleInitDefault((u16*)SCREEN_BASE_BLOCK_SUB(31), (u16*)CHAR_BASE_BLOCK_SUB(0), 16);
<br/>
   
<br/>
   //set iwram to belong to DS
<br/>
   REG_WRAMCNT = 0;
<br/>
   
<br/>
   //copy the asm stuff
<br/>
        testfunction *ptest2 = (testfunction *)SHARED;
<br/>
   memcpy(test,SHARED,testlength/4);
<br/>
   
<br/>
   iprintf("\n\nshared wram register of arm9: %d\n",REG_WRAMCNT);
<br/>
   iprintf("location of 'test' function: %x\n",test);
<br/>
   iprintf("testlength %d\n",testlength);
<br/>
   iprintf("first byte of test/sharedram: %x / %x\n",((u32*)test)[0],SHARED[0]);
<br/>
   int n;
<br/>
   //n = ((*ptest2)(0x4000100));
<br/>
   iprintf("Test returned: %d\n",n);
<br/>
...etc
<br/>
</td> </tr></table><span class="postbody">
<br/>
and the function to run is this:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
   .SECTION    .ewram,"ax",%progbits
<br/>
   .ALIGN
<br/>
   .POOL
<br/>
<br/>
   .ALIGN
<br/>
   .GLOBAL     test
<br/>
   .GLOBAL      test_end
<br/>
<br/>
@test: u32 -&gt; u32; r0 holds 4000100h, returns time of execution in 33MHz cycles
<br/>
test:
<br/>
   @first set up timer
<br/>
   mov r1,r0
<br/>
   mov r2,#0         @timer0count = 0
<br/>
   strh r2,[r1]
<br/>
   mov r2,#(1&lt;&lt;7)      @timer0control = tmr-mode1 | timer-start
<br/>
   strh r2,[r1, +#2]
<br/>
   
<br/>
<br/>
   .rept 20
<br/>
   add r2,r4,r5
<br/>
   add r3,r6,r6
<br/>
   .endr
<br/>
   ldrh r0,[r1]      @read timer value
<br/>
   
<br/>
   bx lr
<br/>
test_end: nop
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I use this awkward way of doing things because the standard linkscript doesnt define a shared wram section, and i dont know how modify it appropriately.
<br/>
This works in nogba, albeit only if the function is small. If i use .rept 100, then the rom crashes. On real hardware this thing doesnt work at all (crashes before printing anything). I tried memcpy, dmacpy and swicopy, but none seem to work. If I remove the comments and actually run the testfunction in shared ram, the rom crashes, even if the copying worked.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#132847 - Ant6n - Sat Jun 30, 2007 4:14 am</h4>
    <div class="postbody"><span class="postbody">ok, i guess the above help request wasnt very well done. So I ask simple:
<br/>
how can one run code in shared wram?
<br/>
thx, anton</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#132858 - wintermute - Sat Jun 30, 2007 4:14 pm</h4>
    <div class="postbody"><span class="postbody">The latest linkscripts and default arm7 core reserve the switchable iwram for ARM7 exclusive use. Nintendo official code also does this, probably for similar reasons.
<br/>
<br/>
If you're looking for fast memory on the ARM9 then use the 32K itcm. You can do this by either naming the file .itcm.c/.itcm.cpp or using the ITCM_CODE macro in the libnds headers.
<br/>
<br/>
void myITCMfunc() ITCM_CODE;
<br/>
<br/>
void myITCMfunc() {
<br/>
<br/>
blah
<br/>
<br/>
}
<br/>
<br/>
you should separate itcm code into separate files *regardless* of which way you do it. The file naming option automatically switches to arm mode.<br/>_________________<br/><a class="postlink" href="http://www.devkitpro.org/" target="_blank">devkitPro - professional toolchains at amateur prices</a>
<br/>
<a class="postlink" href="http://wiki.devkitpro.org/index.php/IRC" target="_blank">devkitPro IRC support</a>
<br/>
<a class="postlink" href="http://davejmurphy.com/" target="_blank">Personal Blog</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#132859 - Ant6n - Sat Jun 30, 2007 4:46 pm</h4>
    <div class="postbody"><span class="postbody">I use itcm, but they way things are looking right now, my core might end up being being around 48 K - and this is already completely crunshed. I was thinking that i could put some stuff in the shared ram, because it appears to have 0 waitstates at a 33MHz bus speed, which would mean having half itcm speed compared to ewram, which gives almost 6 times itcm speed (assuming constant cache misses).</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
