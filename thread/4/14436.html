<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Raster effects doesn't work properly on hardware - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>Coding > Raster effects doesn't work properly on hardware</h2>
<div id="posts">
<div class="post">
    <h4>#144268 - Chano Marrano - Wed Oct 31, 2007 12:21 am</h4>
    <div class="postbody"><span class="postbody">Hi! I've been working on a raster effects system for the GBA. The raster effects are showing correctly on emulators such as VisualBoy, No$gba and the Advanced Debugger emulator included, but on a real GBA the screen seems a little garbled. Where's the problem?
<br/>
<br/>
Code for the background raster effect:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
void ATTR_FASTFUNC bgRippleAct(void)
<br/>
{
<br/>
    if(REG_VCOUNT &gt; 224 || REG_VCOUNT &lt; 159)
<br/>
    {
<br/>
        struct bgStruct *bgPtr = &amp;bg[0];
<br/>
        u32 counter = sis_generalCounter();
<br/>
        s32 line, offset;
<br/>
<br/>
        if(!REG_VCOUNT || REG_VCOUNT &gt; 225)
<br/>
            line = 1;
<br/>
        else
<br/>
            line = REG_VCOUNT;
<br/>
<br/>
        offset = swiDiv(SIN((line + counter) * speed), amplitude);
<br/>
<br/>
        M_BG0SCRLX_SET(bgPtr-&gt;x + offset);
<br/>
        M_BG0SCRLY_SET(bgPtr-&gt;y + offset);
<br/>
    }
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I've uploaded a little demo that shows the problem: look at the vertical line that gets garbled in the middle of the screen, over the last 's' of the word "Sessions":
<br/>
<a class="postlink" href="http://rapidshare.com/files/66369735/bad_rasters_gba_demo.zip.html" target="_blank">http://rapidshare.com/files/66369735/bad_rasters_gba_demo.zip.html</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#144272 - tepples - Wed Oct 31, 2007 1:32 am</h4>
    <div class="postbody"><span class="postbody">VBA and NO$GBA can use either a high-level-emulated BIOS or an authentic GBA BIOS dumped from your GBA using your flash equipment. The former doesn't require the user to own a GBA and flash equipment, but the latter acts more like a GBA. Does it work on VBA and NO$GBA even if you make a BIOS file and tell the emulator to use it? Do you know how to dump your GBA's BIOS? (For GBAMP use <a class="postlink" href="http://pinocchio.jk0.org/gbaforum/gbamp_bios_dumper.zip" target="_blank">this</a>.)
<br/>
<br/>
Also, emulators tend not to handle mid-scanline register writes or palette writes the way a GBA does. If you want to do a raster effect that changes the position of each scanline, use HDMA (<a class="postlink" href="http://nocash.emubase.de/gbatek.htm#gbadmatransfers" target="_blank">DMA</a> with start timing set to horizontal blank).<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#144298 - Chano Marrano - Wed Oct 31, 2007 8:33 am</h4>
    <div class="postbody"><span class="postbody">Thanks for your reply.
<br/>
<br/>
The emulators mentioned above keep showing the rasters correctly even if I assign them a real BIOS, so I'll try to use HDMA.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#144307 - kusma - Wed Oct 31, 2007 12:14 pm</h4>
    <div class="postbody"><span class="postbody">I seem to remember having similar issues if i did not finish updating the per-scanline registers during h-blank on real hardware. both vba and no$ seems to simply fetch these registers after h-blank, but the real hardware seemed to garble a couple of pixels before updating properly. This was a real pain to get working correctly on both emulators and on hardware without using the h-blank DMA, so I'd recommend using that.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#144331 - Chano Marrano - Wed Oct 31, 2007 5:50 pm</h4>
    <div class="postbody"><span class="postbody">Thanks for your advices, but using HDMA I reach to the same point: the effect works on emulators but not on hardware. I'll post the code associated:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
static void ATTR_FASTFUNC actBGRipple(void)
<br/>
{
<br/>
    u32 counter = sis_generalCounter();
<br/>
    struct bgStruct *bgPtr = &amp;bg[0];
<br/>
    u32 i;
<br/>
<br/>
    // Desactivate DMA:
<br/>
    REG_DM0CNT_H = 0;
<br/>
<br/>
    // Fill the table for next frame:
<br/>
    for(i = 0; i &lt; 160; i++)
<br/>
    {
<br/>
        u32 offset = swiDiv(SIN((i + counter) * speed), amplitude);
<br/>
<br/>
        regTable[i * 2] = bgPtr-&gt;x + offset;
<br/>
        regTable[(i * 2) + 1] = bgPtr-&gt;yo + offset;
<br/>
    }
<br/>
<br/>
    // Activate DMA:
<br/>
    REG_DM0CNT = 0;
<br/>
    REG_DM0SAD = (u32)(&amp;regTable);
<br/>
    REG_DM0DAD = (u32)(&amp;REG_BG0HOFS);
<br/>
    REG_DM0CNT = 2 | (DMA_ON);
<br/>
}
<br/>
<br/>
void ATTR_FASTFUNC intrHBLFunc(void)
<br/>
{
<br/>
    if(REG_VCOUNT == 1)
<br/>
    {
<br/>
        // Act DMA:
<br/>
        REG_DM0CNT = 0;
<br/>
        REG_DM0SAD = (u32)(&amp;regTable[1]);
<br/>
        REG_DM0DAD = (u32)(&amp;REG_BG0HOFS);
<br/>
        REG_DM0CNT = 2 | (DMA_ON) | (DMA_HBL) | (DMA_REPEAT) | (DMA_DST_RESET);
<br/>
    }
<br/>
}
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#144337 - Mighty Max - Wed Oct 31, 2007 7:26 pm</h4>
    <div class="postbody"><span class="postbody">Shouldn't an amplitude be multiplied to the base function (SIN here)?
<br/>
<br/>
If you intended this, is the table calculated correctly (i.e. swiDiv working as you expect it to work)?<br/>_________________<br/><a class="postlink" href="http://mightymax.org/gbamp_multiboot.html" target="_blank">GBAMP Multiboot</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#144343 - Chano Marrano - Wed Oct 31, 2007 8:20 pm</h4>
    <div class="postbody"><span class="postbody">Well, I did it (the HDMA version)! :D. It was just a little problem with the interrupt associated to the AAS sound system. Thanks for your attention.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
