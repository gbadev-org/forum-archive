<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Please help! - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>Coding > Please help!</h2>
<div id="posts">
<div class="post">
    <h4>#50390 - triton - Tue Aug 09, 2005 3:01 am</h4>
    <div class="postbody"><span class="postbody">Hi folks, I'm new to gba programming and when I finished what was available w/ gbaguy's new tutorials, I tried putting together a game myself.  I just wanted to see if i could incorporate a sprite, background and music together.  It compiled successfully but unfortunately it didn't run on VBA.  I checked the i/o reader and apparently the display contoller is set to forced blank.  I don't know why that is and hopes someone can figure things out from my code.  "main" , "palette" and "sprite" are all linked from C arrays.
<br/>
@beginning
<br/>
.arm
<br/>
.text
<br/>
.global main
<br/>
start:
<br/>
	ldr r10, =0x40000bc      @dma_1 for soundfifo
<br/>
	ldr r11, =0x40000c0     @dma 1 dest
<br/>
	ldr r12, =0x40000c4      @dma word count
<br/>
<br/>
	ldr r7, =0x40000d4        @dma3 for convenient use later
<br/>
	ldr r8, =0x40000d8
<br/>
	ldr r9, =0x40000dc
<br/>
<br/>
	ldr r0, =0x4000000
<br/>
	ldrh r1, =0x1400 @sprites and bg1 
<br/>
	strh r1, [r0]
<br/>
bg_setup:
<br/>
	ldr r0, =0x400000c
<br/>
	ldrh r1, =0x1480     @600a000 screnbase  6000000 char base block
<br/>
	strh r1, [r0]            @256 *256 text background
<br/>
SND:
<br/>
	ldr r1, =0x4000084	@enable all circuits
<br/>
	ldrh r0, =0x0080	
<br/>
	strh r0, [r1]
<br/>
snd_cnt:
<br/>
	ldr r0, =0x4000080
<br/>
	ldr r1, =0x0b040000	@snd_cnt_l + h fifo a, timer0/reset
<br/>
	str r1, [r0]                     @ disable snd channels 1-4
<br/>
snd_timer:
<br/>
	ldr r0, =0x4000100
<br/>
	ldrh r1, =0xfd06	@22050 hz
<br/>
	strh r1, [r0]
<br/>
	ldr r4, =0x4000102
<br/>
	ldrh r3, =0x0080
<br/>
snd_dma:
<br/>
	ldr r0, =main
<br/>
	str r0, [r10]
<br/>
	ldr r1, =0x40000a0
<br/>
	str r1, [r11]
<br/>
	ldr r1, =0xb2000000
<br/>
tim_dma:
<br/>
	str r1, [r12]
<br/>
	strh r3, [r4]
<br/>
<br/>
BG:
<br/>
bg_pal:
<br/>
	ldr r0, =bgpal
<br/>
	str r0, [r7]	@dma
<br/>
	ldr r0, =0x5000000
<br/>
	str r0, [r8]
<br/>
	ldr r0, =0x94000080	@128 words during vblank
<br/>
	str r0, [r9]
<br/>
bg_data:
<br/>
	ldr r0, =bg1
<br/>
	str r0, [r7]
<br/>
	ldr r0, =0x6000000
<br/>
	str r0, [r8]
<br/>
	ldr r0, =0x94002000	@vblank 8192 words/ tiledata
<br/>
bg_map:
<br/>
	ldr r0, =bgmap
<br/>
	str r0, [r7]
<br/>
	ldr r0, =0x600a000
<br/>
	str r0, [r8]
<br/>
	ldr r0, =0x94000200	@512 words on vblank bits 12, 13
<br/>
	str r0, [r9]
<br/>
<br/>
SPR:
<br/>
	ldr r0, =0x7000000
<br/>
	ldr r1, =0x200ac00a	@att 0 &amp; 1 10y + x
<br/>
	str r1, [r0], #4	@oam
<br/>
	ldrh r1, =0x0000
<br/>
	strh r1, [r0]
<br/>
.ltorg
<br/>
spr_pal:
<br/>
	ldr r0, =palette
<br/>
	str r0, [r7]
<br/>
	ldr r0, =0x5000200
<br/>
	str r0, [r8]
<br/>
	ldr r0, =0x94000080	@ 128 words
<br/>
	str r0, [r9]
<br/>
charmem:
<br/>
	ldr r0, =sprite
<br/>
	str r0, [r7]
<br/>
	ldr r0, =0x6010000
<br/>
	str r0, [r8]
<br/>
	ldr r0, =0x94000200	@512 words
<br/>
	str r0, [r9]
<br/>
inf:
<br/>
	b inf
<br/>
<br/>
.ltorg
<br/>
<br/>
bg1:
<br/>
	.incbin "bg1.bin"
<br/>
bgmap:
<br/>
	.incbin "bg1.map"
<br/>
bgpal:
<br/>
	.incbin "bg1.pal"
<br/>
@end of file</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#50397 - poslundc - Tue Aug 09, 2005 5:22 am</h4>
    <div class="postbody"><span class="postbody">First rule of debugging: refactor code that doesn't work into the smallest segment of code you can that does work.
<br/>
<br/>
Application of rule: don't try to throw three untested, unproven and disparate systems into the mix at once and expect to be able to debug it; you are asking for a world of hurt. First write code that displays a background. Get it working. Then write code that displays a sprite. Get it working. Then write code that combines those two, and get it working. Then write code that plays sound and get it working, then finally combine all three.
<br/>
<br/>
It's important to realize that a mistake in one of these systems can easily clobber the other two, and it's next to impossible to debug when you can't tell who's causing the problem.
<br/>
<br/>
Finally, consider coding in a higher level language (C/C++) instead of assembly. Assembly is useful for writing small, custom routines that need to be fast, but for general engine purposes it takes far too long and results in code that's infinitely harder to maintain. If you're doing it for academic purposes (ie. to learn how) then that's fine... but believe me, there will still be plenty of challenges awaiting you in C.
<br/>
<br/>
Good luck,
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#50439 - triton - Tue Aug 09, 2005 6:38 pm</h4>
    <div class="postbody"><span class="postbody">Gotcha!  But how much slower is C over assembly?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#50444 - poslundc - Tue Aug 09, 2005 7:54 pm</h4>
    <div class="postbody"><span class="postbody">C code is compiled into assembly code... so it depends on how good your compiler is. Compiled code is usually at least an order of magnitude slower than well-written assembly code, but the compiler can easily outperform you if you don't know what you're doing.
<br/>
<br/>
None of that really matters for the general case, though. At 16.78 million cycles per second, you are far better off prioritizing your development time over your execution time. Optimize only where you need to. If you write clean, efficient C code then you won't have to often.
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#51079 - LOst? - Tue Aug 16, 2005 5:10 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>triton wrote:</b></span></td> </tr> <tr> <td class="quote">Gotcha!  But how much slower is C over assembly?</td> </tr></table><span class="postbody">
<br/>
I can only give an example on the I386 platform. Doing something like this will result in the following assembler:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
a += 4;
<br/>
a -= 3;
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
move value from memory where <span style="font-weight: bold">a</span> is located into an empty register.
<br/>
add 4 to that register.
<br/>
move register back to memory where <span style="font-weight: bold">a</span> is located.
<br/>
<br/>
move value from memory where <span style="font-weight: bold">a</span> is located into an empty register.
<br/>
subtrack 4 to that register.
<br/>
move register back to memory where <span style="font-weight: bold">a</span> is located.
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I think the solution to skip as much memory to register moves can be avoided by doing all the calculations in one step:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
a = a + 4 - 3;
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
move value from memory where <span style="font-weight: bold">a</span> is located into an empty register.
<br/>
add 4 to that register.
<br/>
subtrack 4 to that register.
<br/>
move register back to memory where <span style="font-weight: bold">a</span> is located.
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Imagine having <span style="font-weight: bold">a</span> in a C++ class as private, and accessing it with methods. That's a lot of code that is stupid in the end result and slows down everything:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
class cA
<br/>
{
<br/>
private:
<br/>
 int a;
<br/>
<br/>
public:
<br/>
 void do_calculation (int add, int sub)
<br/>
 {
<br/>
   a += add;
<br/>
   a -= sub;
<br/>
 }
<br/>
};
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
-load a cA class into a register.
<br/>
-call offset where method <span style="font-weight: bold">do_calculation</span> is located from that register.
<br/>
initialize C++ function.
<br/>
load class onto the stack.
<br/>
<br/>
get a pointer to class cA + offset where <span style="font-weight: bold">a</span> is located in the stack and put it into an empty register.
<br/>
move the value from where that register is pointing to into yet another empty register.
<br/>
add the value from stack where <span style="font-weight: bold">add</span> is located to this register holding the value of <span style="font-weight: bold">a</span>.
<br/>
get a pointer to <span style="font-weight: bold">a</span> where it is located in the stack and put it into a new empty register.
<br/>
move the value with the sum of <span style="font-weight: bold">a</span> and <span style="font-weight: bold">add</span> into the location the new register is pointing at: (class cA + <span style="font-weight: bold">a</span> in stack).
<br/>
<br/>
get a pointer to class cA + offset where <span style="font-weight: bold">a</span> is located in the stack and put it into an empty register.
<br/>
move the value from where that register is pointing to into yet another empty register.
<br/>
subtrack the value from stack where <span style="font-weight: bold">sub</span> is located to this register holding the value of <span style="font-weight: bold">a</span>.
<br/>
get a pointer to <span style="font-weight: bold">a</span> where it is located in the stack and put it into a new empty register.
<br/>
move the value with the difference of <span style="font-weight: bold">a</span> and <span style="font-weight: bold">sub</span> into the location the new register is pointing at: (class cA + <span style="font-weight: bold">a</span> in stack).
<br/>
<br/>
unload class onto the stack.
<br/>
uninitialize C++ function.
<br/>
return to caller
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Makes you wanna forget all about the power of C++ classes and OOP and just undo all this crap.
<br/>
<br/>
I can do these steps in assembler much easier and faster, and I could even handle my own object in memory and point to it directly, and never change the pointers, and never unload the registers when I am about to use them twice, and skip the stack. So you see what you get by trusting a C++ compilator like MSVC++. I have no idea if GCC handles classes better. Also with a RISC CPU with more register, it must be a little bit faster to handle all this, but it makes me think.<br/>_________________<br/><span style="font-style: italic">Exceptions are fun</span></span><span class="gensmall"><br/><br/>Last edited by LOst? on Tue Aug 16, 2005 7:18 pm; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#51106 - FluBBa - Tue Aug 16, 2005 12:44 pm</h4>
    <div class="postbody"><span class="postbody">A small suggestion if you really want to code in ARM assembler.
<br/>
Use offsets &amp; defines when writing to the HW registers.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
 ldr r0, =0x400000c
<br/>
ldrh r1, =0x1480 @600a000 screnbase 6000000 char base block
<br/>
strh r1, [r0] @256 *256 text background
<br/>
</td> </tr></table><span class="postbody">
<br/>
Could easily be changed into:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
mov r0,#REG_BASE
<br/>
ldr r1,=0x1480 @This should probably also use defines
<br/>
strh r1,[r0,REG_BG2CNT]
<br/>
</td> </tr></table><span class="postbody">
<br/>
But seeing how your code looks and that it is run from ROM I think Thumb compiled C code will be faster.<br/>_________________<br/>I probably suck, my not is a programmer.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#51140 - DekuTree64 - Tue Aug 16, 2005 7:22 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>FluBBa wrote:</b></span></td> </tr> <tr> <td class="quote">Use offsets &amp; defines when writing to the HW registers.</td> </tr></table><span class="postbody">
<br/>
Yep, yep, this makes things much easier to understand. Just because it's not C doesn't mean you should write bad code with magic numbers all over.
<br/>
Also handy is named stack offsets, if you have more variables than you can fit in registers.
<br/>
<br/>
Sometimes I even name my registers if I'm planning to keep specific variables in them.<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#51164 - sajiimori - Tue Aug 16, 2005 10:12 pm</h4>
    <div class="postbody"><span class="postbody">Lost, check your compiler settings.  If you've enabled optimizations and the compiler doesn't optimize a simple inline method like the one you posted, then you might need to upgrade.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
