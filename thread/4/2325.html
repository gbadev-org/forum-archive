<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Problem with my dynamic tile manager... - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>Coding > Problem with my dynamic tile manager...</h2>
<div id="posts">
<div class="post">
    <h4>#12366 - rooter - Sun Nov 09, 2003 5:29 am</h4>
    <div class="postbody"><span class="postbody">Ok, I'm having some problems my dynamic tile management. Most of this code is taken off of booflys code... basically when i scroll around im getting some corruption... its all FINE at first, perfect, spectacular, but when i start scrolling around i get garbaged tiles and just some wholly black tiles... im using a 48x32 map with 1100 tiles
<br/>
<br/>
summary:
<br/>
works inititally just fine, tiles are read in even works perfectly on some small maps... when i scroll around a lot i get corruption and garbaged tiles... any ideas?
<br/>
<br/>
here's the code...
<br/>
<br/>
tileset.cpp
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#include "tileset.h"
<br/>
<br/>
CTileset::CTileset()
<br/>
{
<br/>
    stackPtr = -1;
<br/>
    for (u16 count=MAXVRAM-1;count&gt;0;count--)
<br/>
    {
<br/>
        used[count] = 0;
<br/>
        Push(count);
<br/>
    }
<br/>
    for (u16 a=0;a&lt;MAXTILES;a++)
<br/>
        mapUse[a] = -1;
<br/>
<br/>
    used[0] = 1;
<br/>
<br/>
    tiles = NULL;
<br/>
}
<br/>
<br/>
CTileset::~CTileset()
<br/>
{
<br/>
}
<br/>
<br/>
void CTileset::SetTileset(u8 *tileset)
<br/>
{
<br/>
    tiles = tileset;
<br/>
}
<br/>
<br/>
u16 CTileset::AddCharacter(u16 charNum)
<br/>
{
<br/>
    s16 memPlace = mapUse[charNum];
<br/>
<br/>
    if (memPlace &lt; 0)
<br/>
    {
<br/>
        memPlace = Pop();
<br/>
        if (memPlace &gt;= 0)
<br/>
        {
<br/>
            REG_DMA3SAD = ((u32)tiles + (charNum &lt;&lt; 6));
<br/>
            REG_DMA3DAD = (0x06004000 + (memPlace&lt;&lt; 6));
<br/>
            REG_DMA3CNT = 16 | DMA_32NOW;
<br/>
            mapUse[charNum] = memPlace;
<br/>
            rLUT[memPlace] = charNum;
<br/>
        }
<br/>
    }
<br/>
    if (memPlace &gt; 0)
<br/>
        used[memPlace]++;
<br/>
    return memPlace;
<br/>
}
<br/>
<br/>
void CTileset::RemoveCharacter(u16 charNum)
<br/>
{
<br/>
    if (charNum != 0)
<br/>
    {
<br/>
        used[charNum]--;
<br/>
        if (used[charNum] == 0)
<br/>
        {
<br/>
            mapUse[rLUT[charNum]] = -1;
<br/>
            Push(charNum);
<br/>
        }
<br/>
    }
<br/>
}
<br/>
<br/>
void CTileset::Push(u16 charNum)
<br/>
{
<br/>
    stackPtr++;
<br/>
    stack[stackPtr] = charNum;
<br/>
}
<br/>
<br/>
u16 CTileset::Pop()
<br/>
{
<br/>
    s16 pop = -1;
<br/>
<br/>
    if (stackPtr &gt;= 0)
<br/>
    {
<br/>
        pop = stack[stackPtr];
<br/>
        used[stackPtr] = 0;
<br/>
        stackPtr--;
<br/>
    }
<br/>
    return pop;
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
tileset.h
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#include "gba.h"
<br/>
<br/>
#define MAXTILES 8192
<br/>
#define MAXVRAM 750
<br/>
<br/>
class CTileset
<br/>
{
<br/>
    public:
<br/>
    CTileset();
<br/>
    ~CTileset();
<br/>
    
<br/>
    u16 AddCharacter(u16 charNum);
<br/>
    void SetTileset(u8 *tileset);
<br/>
    void RemoveCharacter(u16 charNum);
<br/>
    
<br/>
    private:
<br/>
    void Push(u16 charNum);
<br/>
    u16 Pop();
<br/>
    
<br/>
    s16 stack[MAXVRAM];
<br/>
    s16 stackPtr;
<br/>
    s16 used[MAXVRAM];
<br/>
    s16 rLUT[MAXVRAM];
<br/>
    int mapUse[MAXTILES];
<br/>
    u8 *tiles;
<br/>
};</td> </tr></table><span class="postbody">
<br/>
<br/>
layer.cpp
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void CLayer::Update(int x, int y, int width, int height)
<br/>
{
<br/>
    int tile = 0, newchar = 0;
<br/>
    for (int cX = 0; cX &lt; width; cX++)
<br/>
    {
<br/>
        for (int cY = 0; cY &lt; height; cY++)
<br/>
        {
<br/>
            if ((y==1) &amp;&amp; (x &gt; 1))
<br/>
            {
<br/>
                if ((cY+y+21) &lt; sY)
<br/>
                {
<br/>
                    tile = bg[(((cY+y)&amp;31) * 32) + ((cX + x)&amp;31)];
<br/>
                    tileset-&gt;RemoveCharacter(tile);
<br/>
                    newchar = data[((cY+y) * sX) + cX + x];
<br/>
                    tile = tileset-&gt;AddCharacter(newchar);
<br/>
                    bg[(((cY+y)&amp;31) * 32) + ((cX + x)&amp;31)] = tile;
<br/>
                }
<br/>
            }
<br/>
            else
<br/>
            {
<br/>
                tile = bg[(((cY+y)&amp;31) * 32) + ((cX + x)&amp;31)];
<br/>
                tileset-&gt;RemoveCharacter(tile);
<br/>
                tile = tileset-&gt;AddCharacter(data[((cY+y) * sX) + cX + x]);
<br/>
                bg[(((cY+y)&amp;31) * 32) + ((cX + x)&amp;31)] = tile;
<br/>
            }
<br/>
        }
<br/>
    }
<br/>
}</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#12368 - rooter - Sun Nov 09, 2003 7:24 am</h4>
    <div class="postbody"><span class="postbody">sort of fixed it, i added the reclaim function that was in boo's code but im still getting a few random garbage or misplaced tiles onscreen at a time, but not the HUGE black areas i was getting before</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#12434 - rooter - Thu Nov 13, 2003 2:02 am</h4>
    <div class="postbody"><span class="postbody">all fixed! thanks guys =P</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
