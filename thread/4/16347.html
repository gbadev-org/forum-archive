<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>3 sprites for the price of 1? - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>Coding > 3 sprites for the price of 1?</h2>
<div id="posts">
<div class="post">
    <h4>#165883 - strat - Sun Jan 11, 2009 11:00 am</h4>
    <div class="postbody"><span class="postbody">Is it possible to modify a sprite immediately after the last scanline it's drawn and place it on the next scanline?  The game I'm working on has the characters using three vertically arranged sprites.
<br/>
<br/>
Actually, I've been fumbling around with this.  Should this do anything?
<br/>
<br/>
(in the interrupt handler)
<br/>
<br/>
if (REG_IF &amp; IRQ_VBLANK) {
<br/>
<br/>
 REG_IF = IRQ_VBLANK;
<br/>
 REG_IFBIOS = IRQ_VBLANK;
<br/>
 scanline = 0;
<br/>
 sprite0.ycoord = 0;
<br/>
 update_oam();
<br/>
<br/>
}
<br/>
<br/>
if (REG_IF &amp; IRQ_HBLANK) {
<br/>
 REG_IF = IRQ_HBLANK;
<br/>
 scanline++;
<br/>
 if (scanline == 32)
<br/>
  sprite0.ycoord = 32;
<br/>
<br/>
 update_oam();
<br/>
<br/>
}</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#165890 - Dwedit - Sun Jan 11, 2009 5:02 pm</h4>
    <div class="postbody"><span class="postbody">You can do it as long as you set the "HBlank Interval Free" bit in REG_DISPCNT.  You will not be able to draw as many sprites on the scanline with that flag set, but you will be able to re-use sprites.
<br/>
<br/>
Also, try to use VCOUNT interrupts instead of HBLANK interrupts to compare scanlines to a specific number.<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#165894 - strat - Sun Jan 11, 2009 8:40 pm</h4>
    <div class="postbody"><span class="postbody">Using VCount now.  Any idea why the sprite would cut off as the screen moves around, and why resetting its position during vblank and writing to oam doesn't work?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#165899 - strat - Mon Jan 12, 2009 8:09 am</h4>
    <div class="postbody"><span class="postbody">hnn...here's what I've got now:
<br/>
<br/>
-one sprite changing position on two vcounts in one frame
<br/>
-on vblank, the sprite should reset but it doesn't show up at the top
<br/>
-however, scrolling to the edge of the map causes the situation to reverse.  Now the sprite will show up at the top but not where the vcount handler sets it</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#165905 - Miked0801 - Mon Jan 12, 2009 7:38 pm</h4>
    <div class="postbody"><span class="postbody">Sounds like you are running both fat VBlanks and Fat HBlanks.  If you're gonna be doing low level trickery like this, you need to be very, very concise with your code.  
<br/>
<br/>
From your 2nd bullet point, if your sprite isn't showing up at the top, you've either got a fat vblank so that the position isn't being set in time, you you a math error.
<br/>
<br/>
Scrolling to the edge means your system is probably working less hard to show the map therefore it has time to properly display the VBlank version, but the HBlank could be getting overrun by something else.  Try putting your HBlank sprites at least 1/2 way down the screen to make sure your VBlank code isn't clobbering it.
<br/>
<br/>
Another possibility is you have another interrupt running (or a very large DMA xfer) that is locking the CPU out from interrupts.
<br/>
<br/>
HBlank DMAs are probably a better way to modify sprite stuff per scanline - setup and modifiy a position table in VBlank and let it move your sprites around.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#165917 - strat - Tue Jan 13, 2009 12:58 am</h4>
    <div class="postbody"><span class="postbody">I realized the screenblock updating routine was using too many cycles, and that's what cut off the sprite resetting.  Putting the code in internal ram was enough for the moment.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#166595 - strat - Wed Feb 11, 2009 4:08 am</h4>
    <div class="postbody"><span class="postbody">I went back to working on this and decided to report something that has a really obvious work-around but still pretty quirky.
<br/>
<br/>
In the HBlank handler, setting the sprite's new pos 1 scanline above where it's to be displayed will display it at the new position and not cut it off at the last position.  This also works on no$.  However, it cuts off the sprite on VBA.  
<br/>
<br/>
Likewise, setting the sprite's new pos 2 scanlines above will display on GBA with no cutoff but on no$ there's a cutoff of one scanline.
<br/>
<br/>
Is it a quirk with the emulators or could it have something to do with the efficiency of the code?
<br/>
<br/>
In the meantime, #if is my friend here.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#166609 - Miked0801 - Wed Feb 11, 2009 8:02 pm</h4>
    <div class="postbody"><span class="postbody">If it works on target and not emulator, you've found an emulator bug :P</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#166612 - strat - Wed Feb 11, 2009 10:17 pm</h4>
    <div class="postbody"><span class="postbody">Surprised no one's found it before.
<br/>
<br/>
Although I still wonder if it's something on my end, because this would've had to show up in commercial games.</span><span class="gensmall"><br/><br/>Last edited by strat on Wed Feb 11, 2009 10:19 pm; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#166613 - Dwedit - Wed Feb 11, 2009 10:18 pm</h4>
    <div class="postbody"><span class="postbody">Not as surprised, few people do sprite multiplexing.<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#166643 - Miked0801 - Thu Feb 12, 2009 6:24 pm</h4>
    <div class="postbody"><span class="postbody">Yep - 3D hardware has so many advantages in most cases that there's little need to resort to hblank trickery (as much).</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#167042 - Ruben - Fri Feb 27, 2009 3:59 pm</h4>
    <div class="postbody"><span class="postbody">Slightly old post.. but thought I'd post this:
<br/>
<br/>
Yeah, for some reason, VBA is off by one scanline compared to No$... I'm not sure about hardware, but I would think it works like No$.
<br/>
<br/>
Like.. for waiting for my routines to reach the topmost scanline, I'd usually go "while(REG_VCOUNT != 227)" but that screws up on VBA, cos it seems to not write the <span style="font-style: italic">correct</span> scanline there cos, if I remember right, REG_VCOUNT is off by 1 scanline.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
