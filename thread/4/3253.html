<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>moving sprite changes color....weeeeeird - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>Coding > moving sprite changes color....weeeeeird</h2>
<div id="posts">
<div class="post">
    <h4>#19434 - CyberSlag5k - Tue Apr 20, 2004 2:18 am</h4>
    <div class="postbody"><span class="postbody">Ok, I have my sprites all up and working now. I can move my little soldier guy around the screen. The thing is, when any part of him goes higher than the top of the screen if he goes back down the entire sprite turns completely tan and if you do it again, he disappears (or turns black, not sure). If he goes up above the screen and keeps going up unitl he comes up through the bottom, everything is fine. Craziness. Here's code.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
//gba test
<br/>
//Mike Pateras
<br/>
<br/>
//main.cpp
<br/>
<br/>
#include"gba.h"
<br/>
#include"keypad.h"
<br/>
#include"palette.h"
<br/>
#include"FF.h"
<br/>
#include"soldier.h"
<br/>
#include "dispcnt.h"
<br/>
#include"sprite.h"
<br/>
<br/>
using namespace std;
<br/>
<br/>
typedef struct
<br/>
{
<br/>
   int posX, posY;
<br/>
   u16 spriteFrame[4];
<br/>
   int activeFrame;
<br/>
   u16 OAMSpriteNum;
<br/>
}Sprite;
<br/>
<br/>
Sprite soldier;
<br/>
<br/>
u16* videoBuffeer = ((u16*)0x6000000);
<br/>
u16* paletteMem = ((u16*)0x5000000);
<br/>
u16* OAM = ((u16*)0x7000000);
<br/>
<br/>
OAMEntry sprites[128];
<br/>
pRotData rotData = (pRotData)sprites;
<br/>
<br/>
void copyOAM()
<br/>
{
<br/>
   u16* temp;
<br/>
   temp = (u16*)sprites;
<br/>
   for(u16 i = 0; i &lt; 512; i++)
<br/>
      OAM[i] = temp[i];
<br/>
}
<br/>
<br/>
void initializeSprites()
<br/>
{
<br/>
   for(u16 i = 0; i &lt; 128; i++)
<br/>
   {
<br/>
      sprites[i].attribute0 = 160;
<br/>
      sprites[i].attribute1 = 240;
<br/>
   }
<br/>
}
<br/>
<br/>
void VSync()
<br/>
{
<br/>
   while((volatile u16)REG_VCOUNT != 160)
<br/>
   {
<br/>
   }
<br/>
}
<br/>
<br/>
void getInput()
<br/>
{
<br/>
   if(!(*KEYS &amp; KEY_LEFT))
<br/>
   {
<br/>
      soldier.posX -= 1;
<br/>
         if(soldier.posX &lt; 0)
<br/>
            soldier.posX += 512;
<br/>
   }
<br/>
   if(!(*KEYS &amp; KEY_DOWN))
<br/>
   {
<br/>
      soldier.posY += 1;
<br/>
<br/>
   }
<br/>
   if(!(*KEYS &amp; KEY_RIGHT))
<br/>
   {
<br/>
      soldier.posX += 1;
<br/>
   }
<br/>
   if(!(*KEYS &amp; KEY_UP))
<br/>
   {
<br/>
      soldier.posY -= 1;
<br/>
         if(soldier.posY &lt; 0)
<br/>
            soldier.posY += 256;
<br/>
   }
<br/>
}
<br/>
<br/>
void updateSprites(OAMEntry *spritePointer)
<br/>
{
<br/>
   spritePointer-&gt;attribute0 = COLOR_256 | SQUARE | soldier.posY;
<br/>
   spritePointer-&gt;attribute1 = SIZE_64 | soldier.posX;   
<br/>
<br/>
}
<br/>
<br/>
int main()
<br/>
{
<br/>
   soldier.posX = 20;
<br/>
   soldier.posY = 40;
<br/>
<br/>
   setMode(MODE_1 | OBJ_ENABLE | OBJ_MAP_1D);
<br/>
<br/>
   for(int i = 0; i &lt; 256; i++)
<br/>
   {
<br/>
      OBJPaletteMem[i] = palette[i];
<br/>
   }
<br/>
<br/>
   initializeSprites();
<br/>
<br/>
   sprites[0].attribute0 = COLOR_256 | SQUARE | soldier.posY;
<br/>
   sprites[0].attribute1 = SIZE_64 | soldier.posX;
<br/>
   sprites[0].attribute2 = 0;
<br/>
<br/>
   for(int i = 0; i &lt; 2048; i++)
<br/>
   {
<br/>
      OAMData[i] = obj0[i];
<br/>
   }
<br/>
   for(int i = 0; i &lt; 2048; i++)
<br/>
   {
<br/>
      OAMData[i + 2048] = obj1[i];
<br/>
   }
<br/>
   for(int i = 0; i &lt; 2048; i++)
<br/>
   {
<br/>
      OAMData[i + 4096] = obj2[i];
<br/>
   }
<br/>
   for(int i = 0; i &lt; 2048; i++)
<br/>
   {
<br/>
      OAMData[i + 6144] = obj3[i];
<br/>
   }
<br/>
<br/>
   soldier.OAMSpriteNum = 0;
<br/>
   soldier.activeFrame = 0;
<br/>
   soldier.spriteFrame[0] = 0;
<br/>
   soldier.spriteFrame[1] = 128;
<br/>
   soldier.spriteFrame[2] = 256;
<br/>
   soldier.spriteFrame[3] = 384;
<br/>
<br/>
   
<br/>
<br/>
<br/>
<br/>
   while(1)
<br/>
   {
<br/>
      getInput();
<br/>
      updateSprites(&amp;sprites[0]);
<br/>
      VSync();
<br/>
      copyOAM();
<br/>
   }
<br/>
<br/>
<br/>
<br/>
<br/>
   return 0;
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I can't really find anything wrong...maybe you guys can.
<br/>
<br/>
Also, if I'm going to enable mode 4, do I have to begin loading my sprite data starting at OAMData[512]? I'm still a little unclear on that. I've read and reread 3 different tutorials and am fairly sure that's what it means. Please correct me, though, if I'm wrong.
<br/>
<br/>
Thank you.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#19437 - CyberSlag5k - Tue Apr 20, 2004 2:29 am</h4>
    <div class="postbody"><span class="postbody">I've found my updateSprites function to be a little off. I've changed it to:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
void updateSprites(OAMEntry *spritePointer)
<br/>
{
<br/>
   spritePointer-&gt;attribute0 = spritePointer-&gt;attribute0 &amp; 0xFE00;
<br/>
   spritePointer-&gt;attribute0 = spritePointer-&gt;attribute0 | soldier.posY;
<br/>
<br/>
   spritePointer-&gt;attribute1 = spritePointer-&gt;attribute1 &amp; 0xFE00;
<br/>
   spritePointer-&gt;attribute1 = spritePointer-&gt;attribute1 | soldier.posX;   
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Still didn't take care of the problem though. In fact, it made it a little worse. Now if I come up from the bottom the sprite grows to twice it's size and disappears after a little bit. Very odd.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#19440 - CyberSlag5k - Tue Apr 20, 2004 2:53 am</h4>
    <div class="postbody"><span class="postbody">Here's a link if you'd like to download the .bin to see what's happening first hand. Probly the best way to descirbe it.
<br/>
<br/>
<a class="postlink" href="http://homepages.udayton.edu/~pateramj/main.bin" target="_blank">http://homepages.udayton.edu/~pateramj/main.bin</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#19441 - sajiimori - Tue Apr 20, 2004 3:15 am</h4>
    <div class="postbody"><span class="postbody">Sprites have 9 bits for the x attribute field and 8 bits for y.  When you leave those boundaries (such as going off the top or left of the screen), it overflows into other fields and messes up your sprite.  Before you OR the position into the attribute, clear the high bits by ANDing the x with 0x1FF and the y with 0xFF.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#19442 - CyberSlag5k - Tue Apr 20, 2004 3:30 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
   spritePointer-&gt;attribute0 = spritePointer-&gt;attribute0 &amp; 0xFF;
<br/>
   spritePointer-&gt;attribute0 = spritePointer-&gt;attribute0 | soldier.posY;
<br/>
<br/>
   spritePointer-&gt;attribute1 = spritePointer-&gt;attribute1 &amp; 0x1FF;
<br/>
   spritePointer-&gt;attribute1 = spritePointer-&gt;attribute1 | soldier.posX;   
<br/>
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Is that what you meant? I think I have mixed something up because my looks like a little grey striped box and moves in very odd ways.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#19446 - yaustar - Tue Apr 20, 2004 4:20 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void getInput()
<br/>
{
<br/>
   if(!(*KEYS &amp; KEY_LEFT))
<br/>
   {
<br/>
      soldier.posX -= 1;
<br/>
         if(soldier.posX &lt; 0)
<br/>
            soldier.posX += 512;
<br/>
   }
<br/>
   if(!(*KEYS &amp; KEY_DOWN))
<br/>
   {
<br/>
      soldier.posY += 1;
<br/>
<br/>
   }
<br/>
   if(!(*KEYS &amp; KEY_RIGHT))
<br/>
   {
<br/>
      soldier.posX += 1;
<br/>
   }
<br/>
   if(!(*KEYS &amp; KEY_UP))
<br/>
   {
<br/>
      soldier.posY -= 1;
<br/>
         if(soldier.posY &lt; 0)
<br/>
            soldier.posY += 256;
<br/>
   }
<br/>
} </td> </tr></table><span class="postbody">
<br/>
you are doing a check if the value falls below 0 which is good. But what about the upper limit? ;)<br/>_________________<br/>[<a class="postlink" href="http://parabellumgames.no-ip.org" target="_blank">Blog</a>] [<a class="postlink" href="http://yaustar.no-ip.org" target="_blank">Portfolio</a>]</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#19447 - CyberSlag5k - Tue Apr 20, 2004 4:47 am</h4>
    <div class="postbody"><span class="postbody">Ahh, good call. I guess I followed my tutorial a little blindly there. Lesson learned.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#19455 - Cearn - Tue Apr 20, 2004 10:07 am</h4>
    <div class="postbody"><span class="postbody">What sajimori was talking about was clearing the high bits of the x and y values, not of the attributes. This should work:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
   // clear y-field in attr0
<br/>
   spritePointer-&gt;attribute0 &amp;= ~0x00ff; 
<br/>
   // clear high-bits of soldier.Y and put it in attr0
<br/>
   spritePointer-&gt;attribute0 |= (soldier.posY &amp; 0x00ff);
<br/>
<br/>
   // ditto for x (only with 9 bits)
<br/>
   spritePointer-&gt;attribute1 &amp;= ~0x01ff; 
<br/>
   spritePointer-&gt;attribute1 |= (soldier.posX &amp; 0x01ff);  
<br/>
</td> </tr></table><span class="postbody">
<br/>
Can I suggest putting this in a function that does not rely on there being a soldier in the game? Something like <span style="font-style: italic">void SetObjPos(OAMEntry *obj, int x, int y)</span> or something.
<br/>
Btw, clearing the high bits of posX and posY automatically wraps around at the boundaries due to the 2s complement nature of signed integers, so you won't need those extra ifs in getInput() anymore. You could just use
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
void getInput() 
<br/>
{ 
<br/>
   if(!(*KEYS &amp; KEY_LEFT)) 
<br/>
      soldier.posX -= 1; 
<br/>
   else if(!(*KEYS &amp; KEY_RIGHT)) 
<br/>
      soldier.posX += 1; 
<br/>
   if(!(*KEYS &amp; KEY_DOWN)) 
<br/>
      soldier.posY += 1; 
<br/>
   else if(!(*KEYS &amp; KEY_UP)) 
<br/>
      soldier.posY -= 1;
<br/>
<br/>
  soldier.posX &amp;= 0x01ff;
<br/>
  soldier.posY &amp;= 0x00ff;
<br/>
} 
<br/>
</td> </tr></table><span class="postbody">
<br/>
Or you could let updateSprites take care of the wrapping. Note that I've also used "else if" for the left-right (and up-down) distinction. You shouldn't be able to do both at the same time, right? Also, if the changes are going to remain at 1, you may want to use the ++ and -- operators.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#19468 - CyberSlag5k - Tue Apr 20, 2004 4:51 pm</h4>
    <div class="postbody"><span class="postbody">Thanks Cearn and Sajiimori. That took care of the problem. One last thing though. The way it runs now I can move the sprite above the top boundary of the viewer and it'll continue as normal until it comes up from the bottom again. However, if I move it to the left boundary, it'll instantly zap to the other side of the screen instead of going partially offscreen.
<br/>
<br/>
Here's a link because that's kind of hard to explain:
<br/>
<br/>
<a class="postlink" href="http://homepages.udayton.edu/~pateramj/main.bin" target="_blank">http://homepages.udayton.edu/~pateramj/main.bin</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#19474 - Miked0801 - Tue Apr 20, 2004 6:23 pm</h4>
    <div class="postbody"><span class="postbody">You are mapping your position to an 8-bit number.  That means left/right it will wrap almost immediately (as the screen is 240 wide.)  Top/bottom is only 160 so it travels further.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
