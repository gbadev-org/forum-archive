<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Problems Switching Modes - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>Coding > Problems Switching Modes</h2>
<div id="posts">
<div class="post">
    <h4>#2385 - darkcloud - Sun Feb 02, 2003 8:53 pm</h4>
    <div class="postbody"><span class="postbody">In my game, I start out in Mode 4 to display images, stuff like that, then in my main game, i switch to Mode 2.  Switching from Mode 4 to 2 works, but then later I try to switch from Mode 2, back to Mode 4.  This is where I run into problems.  I tested the Mode 4 code by itself, without switching from Mode 2, and that worked.  But when I switch from Mode 2 to Mode 4 the screen is just black.  Any reasons to why this is?<br/>_________________<br/>Maybe in order to understand mankind, we have to look at the word itself: "Mankind". Basically, it's made up of two separate words - "mank" and "ind". What do these words mean ? It's a mystery, and that's why so is mankind.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#2391 - Maddox - Sun Feb 02, 2003 10:23 pm</h4>
    <div class="postbody"><span class="postbody">You are probably using some code that just writes the value of the mode into the register WITHOUT masking out the value that was there last time.  This will cause you to set the mode to 6 because you will accumulate that bit in the dispcnt register.  2 OR 4 is 6.  When the gba gets a mode &gt; 5 it turns black.<br/>_________________<br/>You probably suck.  I hope you're is not a game programmer.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#2393 - darkcloud - Sun Feb 02, 2003 11:15 pm</h4>
    <div class="postbody"><span class="postbody">Could there be anything else that could cause the problem?
<br/>
I don't think its the way I set REG_DISPCNT because I did some tests.
<br/>
I tried setting the mode to Mode 2, then switching to Mode 4, and that worked.  I also tried messing around with REG_DISPCNT and then setting the mode to Mode 4 and that worked.  This leads me to believe that it has something to do with my game code.
<br/>
Below is the code I use to change my modes:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
//define the bits that control the screen mode 0-5
<br/>
#define MODE_0   0x0
<br/>
#define MODE_1   0x1
<br/>
#define MODE_2   0x2
<br/>
#define MODE_3   0x3
<br/>
#define MODE_4   0x4
<br/>
#define MODE_5   0x5
<br/>
<br/>
//define the buffer which is used to set the active buffer
<br/>
//when using double buffering
<br/>
#define backbuffer    0x10
<br/>
<br/>
//This bit, when set allows OAM(Object Attribute Memory) to
<br/>
//be updated during a horizontal blank
<br/>
#define H_BLANK_OAM    0x20
<br/>
<br/>
//use these two defines to choose which mapping mode is used
<br/>
//for sprite graphics 2D or 1D
<br/>
#define OBJ_MAP_2D    0x0
<br/>
#define OBJ_MAP_1D    0x40
<br/>
<br/>
//Causes the screen to go white by using a forced blank
<br/>
#define FORCE_BLANK    0x80
<br/>
<br/>
//define the flags for enabling backgrounds and objects(sprites)
<br/>
#define BG0_ENABLE   0x100
<br/>
#define BG1_ENABLE   0x200
<br/>
#define BG2_ENABLE   0x400
<br/>
#define BG3_ENABLE   0x800
<br/>
#define OBJ_ENABLE   0x1000
<br/>
<br/>
//allows window displays (dont worry about these)
<br/>
#define WIN1_ENABLE   0x2000
<br/>
#define WIN2_ENABLE   0x4000
<br/>
#define WINOBJ_ENABLE   0x8000
<br/>
<br/>
<br/>
//Set the mode that you want to use, logical AND them together as below:
<br/>
//e.g. SetMode(MODE_2 | OBJ_ENABLE | OBJ_MAP_1D);
<br/>
#define SetMode(mode) REG_DISPCNT = (mode)
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Can you show me some code that guarentees REG_DISPCNT to be "reset"?<br/>_________________<br/>Maybe in order to understand mankind, we have to look at the word itself: "Mankind". Basically, it's made up of two separate words - "mank" and "ind". What do these words mean ? It's a mystery, and that's why so is mankind.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#2395 - Maddox - Mon Feb 03, 2003 12:56 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">//Set the mode that you want to use, logical AND them together as below: 
<br/>
//e.g. SetMode(MODE_2 | OBJ_ENABLE | OBJ_MAP_1D); 
<br/>
#define SetMode(mode) REG_DISPCNT = (mode) 
<br/>
 
<br/>
<br/>
<br/>
</td> </tr></table><span class="postbody"></span></td> </tr></table><span class="postbody">
<br/>
<br/>
This is silly but I will show patience.  When you use that SetMode macro, do you use all those nice manifest constants like BG2_ENABLE.  They need to be specified EVERY time you call that macro.  Otherwise you will be resetting those bits to zero, shutting off your bg layers.<br/>_________________<br/>You probably suck.  I hope you're is not a game programmer.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#2396 - darkcloud - Mon Feb 03, 2003 1:03 am</h4>
    <div class="postbody"><span class="postbody">Yes, I know that.
<br/>
So what else could cause the problem?
<br/>
I can't seem to find any plausible cause in my code.<br/>_________________<br/>Maybe in order to understand mankind, we have to look at the word itself: "Mankind". Basically, it's made up of two separate words - "mank" and "ind". What do these words mean ? It's a mystery, and that's why so is mankind.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#2397 - Dev - Mon Feb 03, 2003 1:30 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>darkcloud wrote:</b></span></td> </tr> <tr> <td class="quote">I can't seem to find any plausible cause in my code.</td> </tr></table><span class="postbody">
<br/>
The compiler may be doing odd optimization things...
<br/>
<br/>
Try this:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">typedef volatile unsigned short int vu16;
<br/>
#define SetMode(mode) *(vu16 *)REG_DISPCNT = (mode)</td> </tr></table><span class="postbody">
<br/>
<br/>
My guess is that whatever startup code you're using has left things in a state that works correctly by sheer coincidence.
<br/>
<br/>
Also, what Maddox is saying is that you don't appear to be enabling the background anywhere (Mode 4 uses BG2), so unless your display is entirely sprites, I'd expect a black screen too.
<br/>
<br/>
If that change above doesn't work, you'll need to post the actual code you're using and not just a tiny snippet of it.
<br/>
<br/>
<span style="font-style: italic">(I'm sure Maddox is rolling his eyes right now thinking "umm... yeah, he did post the actual code he's using!")</span>
<br/>
<br/>
Then again, perhaps your GBA isn't working properly... ;-)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#2401 - darkcloud - Mon Feb 03, 2003 2:04 am</h4>
    <div class="postbody"><span class="postbody">Sorry, I guess I didn't specify exactly what the code I posted was.  That isn't the code I'm using to set up the display, thats just the definitions of the SetMode macro and the defines to go with it.  
<br/>
<br/>
The change didn't work, actually it made the screen go black.  
<br/>
<br/>
I would post more of my code, I'm just not sure which parts are relevant.  
<br/>
But I will explain the basic set up of my code.
<br/>
Part 1-
<br/>
First theres an intro to the game in Mode 4 (SetMode(MODE_4 | BG2_ENABLE)).
<br/>
Part 2-
<br/>
Then theres the game and I switch to mode 2 by doing SetMode(MODE_2 | BG2_ENABLE | BG3_ENABLE | OBJ_MAP_1D | OBJ_ENABLE)
<br/>
Part 3-
<br/>
Then I go back to mode 4, SetMode(MODE_4 | BG2_ENABLE) and load my images and this is where the problem is.  
<br/>
<br/>
The way I tested to see if it was my SetMode macro causing the problem by only running the code in Part 3, but by adding a SetMode(MODE_2) before the SetMode(MODE_4 | BG2_ENABLE).  This works.  Its only when I run all the parts that I run into my problem.
<br/>
<br/>
I hope I explained it clearly, I think I'll search through my game code to find anything that might be related.<br/>_________________<br/>Maybe in order to understand mankind, we have to look at the word itself: "Mankind". Basically, it's made up of two separate words - "mank" and "ind". What do these words mean ? It's a mystery, and that's why so is mankind.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#2408 - Maddox - Mon Feb 03, 2003 7:19 am</h4>
    <div class="postbody"><span class="postbody">Yeah, make sure it's declared as volatile unsigned short *REG_DISPCNT.  Also, turn off ALL optimizations with -O0 (that's 'O' zero).<br/>_________________<br/>You probably suck.  I hope you're is not a game programmer.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#2430 - MrMr[iCE] - Mon Feb 03, 2003 9:24 pm</h4>
    <div class="postbody"><span class="postbody">Also make sure your enabling bg2 when you jump back to mode4. bitmap modes require that bg layer to be enabled.<br/>_________________<br/>Does the corpse have a familiar face?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#2433 - darkcloud - Mon Feb 03, 2003 9:53 pm</h4>
    <div class="postbody"><span class="postbody">Ok well I found the problem, and it was stupidly obvious.  It should have been one of the first things I should have checked for causing the problem.  I forgot to reset the BG scrolling registers!!!!!!!
<br/>
<br/>
Well, anyway thanks for all your help.<br/>_________________<br/>Maybe in order to understand mankind, we have to look at the word itself: "Mankind". Basically, it's made up of two separate words - "mank" and "ind". What do these words mean ? It's a mystery, and that's why so is mankind.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
