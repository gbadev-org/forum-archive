<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Mode 7 -> 3d sprite problem - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>Coding > Mode 7 -> 3d sprite problem</h2>
<div id="posts">
<div class="post">
    <h4>#35871 - mksoft_ - Fri Feb 11, 2005 7:12 pm</h4>
    <div class="postbody"><span class="postbody">Hello
<br/>
<br/>
I've done a mode 7 background, it works fine, no problem with that.
<br/>
Now i want to have 3d sprites, and i can't get this working, and i tried every tutorials on the web (which are great, but never give a working function without using extras .h or others libs...)
<br/>
<br/>
<br/>
I try to have a function like that
<br/>
<br/>
void ComputeSprite(x,y,z, *screenX, *screenY, *scale)
<br/>
{
<br/>
...
<br/>
}
<br/>
<br/>
<br/>
IN: 
<br/>
x,y,z are the 3d coord of the object
<br/>
<br/>
OUT:
<br/>
screenX, screenY are the 2d pos of the projected object
<br/>
and scale the scale value for the sprite
<br/>
<br/>
could you help me please?
<br/>
<br/>
thank you thanks you thanks you
<br/>
:)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#35889 - AnthC - Sat Feb 12, 2005 12:35 am</h4>
    <div class="postbody"><span class="postbody">You could express the translation for a world co-ordinate to screen co-ordinate then pump your 3d position through this..</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#35911 - mksoft_ - Sat Feb 12, 2005 11:02 am</h4>
    <div class="postbody"><span class="postbody"><span style="font-weight: bold">Ok, here it is the part  from the darkfader tutorial, some things i dont get:</span>
<br/>
<br/>
Sprites
<br/>
-------
<br/>
Now you want to have some sprites positioned at some 3D coordinate...
<br/>
This is done by transforming world coordinates to view coordinates and then project
<br/>
them on the screen.
<br/>
Subtract the camera coordinate from the world coordinate and then rotate with view matrix.
<br/>
<span style="font-weight: bold">-&gt; that's ok</span>
<br/>
Then you'll have to do an inverse transformation to get view space coordinates.
<br/>
<span style="font-weight: bold">-&gt; i do that, is it ok ?
<br/>
pp.x = VF8_MUL(ctab[(255-yaw)]&gt;&gt;16, (p.x-camPos.x)) - VF8_MUL(stab[(255-yaw)]&gt;&gt;16, (p.z-camPos.z));	
<br/>
pp.y = p.y;
<br/>
pp.z = VF8_MUL(stab[(255-yaw)]&gt;&gt;16, (p.x-camPos.x)) + VF8_MUL(ctab[(255-yaw)]&gt;&gt;16, (p.z-camPos.z));</span>
<br/>
<br/>
<br/>
<br/>
Then optionally negate the Z coordinate if this is somehow negative and you don't want this.
<br/>
Now you can check if it's behind you (Z &lt; 0) and ignore it :)
<br/>
<span style="font-weight: bold">-&gt; i don't get at all, i made it positive and check if it's negative ??</span>
<br/>
<br/>
Then you need to project it into the screen to get the right screen space coordinates.
<br/>
This is done with a projection matrix, but since this is nothing more than scaling things nicely,
<br/>
you only need to store 2 scale values according to the field-of-vision (FOV).
<br/>
<br/>
Define the x/y scaling for fast projection:
<br/>
	mproj_w = LCD_WIDTH/2 / tan(0.5 * FOV_horizontal)
<br/>
	mproj_h = LCD_HEIGHT/2 / tan(0.5 * FOV_vertical)
<br/>
<br/>
<span style="font-weight: bold">-&gt; what value should have FOV_horizontal and FOV_vertical ? It depends of what? </span>
<br/>
<br/>
Then... project!
<br/>
	screen_x = LCD_WIDTH/2 + in.x * mproj_w / in.z
<br/>
	screen_y = LCD_HEIGHT/2 - in.y * mproj_h / in.z
<br/>
<br/>
<span style="font-weight: bold">-&gt; ok for that</span>
<br/>
<br/>
After you have the screen coordinates, you have to shift the sprite a bit because unfortunately the rotation origin
<br/>
is at the center, but not the offset.
<br/>
Therefore you'll still need the Z coordinate. Shift by ?/z and set sprite scale to ?*z.
<br/>
<br/>
<span style="font-weight: bold">-&gt; what is '?'  ?  What is the exact formula ? </span>
<br/>
<br/>
<br/>
Thanks for your help i'm really stuck and i need to finish very soon
<br/>
pleeasse :)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#35935 - LOst? - Sun Feb 13, 2005 7:35 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Shift by ?/z and set sprite scale to ?*z.</td> </tr></table><span class="postbody">
<br/>
<br/>
Come on! Please! People listen up!
<br/>
This is not help! This is not a tutorial! If some of you like a tutorial with just an explaination of a value that is not showed off anywhere, then it's the same thing as having DATA in a CPP file and iclude it directly in another CPP file like this:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#include "data.cpp"</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#35938 - mksoft_ - Sun Feb 13, 2005 9:39 am</h4>
    <div class="postbody"><span class="postbody">...
<br/>
i'm sorry if i said something wrong, i didn't meant to.
<br/>
I'm just in trouble seeking for help...
<br/>
You don't have to help if you don't want...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#35963 - ecurtz - Sun Feb 13, 2005 6:19 pm</h4>
    <div class="postbody"><span class="postbody">If you aren't using "real" 3d elsewhere in your code (and it doesn't sound like you are) it is probably simpler to use raycasting techniques than 3d transforms for your sprites.
<br/>
<br/>
Think about the overhead view of your world. You can calculate the angle from your (camera) origin to the sprite using atan2. You can calculate the distance to the sprite using the Pythagorean theorem.
<br/>
<br/>
The x position on screen is then determined by the difference of which angle your camera is facing and which angle the sprite is. The y position is based on your mode 7 projection - you want it to be as far up as the floor pixel which is the same distance away, then you add an amount based on the z value scaled by the same amount your sprite is scaled down (also based on how far away it is / your mode 7 values.)</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
