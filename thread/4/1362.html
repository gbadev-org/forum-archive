<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Why I cannot use the 'malloc' function ? - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>Coding > Why I cannot use the 'malloc' function ?</h2>
<div id="posts">
<div class="post">
    <h4>#6821 - tangl_99 - Tue Jun 03, 2003 3:55 am</h4>
    <div class="postbody"><span class="postbody">Although the complier does not report errors,
<br/>
The 'malloc' does not work !
<br/>
<br/>
Help!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#6828 - Quirky - Tue Jun 03, 2003 7:47 am</h4>
    <div class="postbody"><span class="postbody">But does the linker report errors? And in what way doesn't it work? How much memory are you trying to allocate? Devkit Advance's malloc works "out the box" IME, you shouldn't have to do anything special.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#6842 - MojoJojo - Tue Jun 03, 2003 12:11 pm</h4>
    <div class="postbody"><span class="postbody">You're not mixing malloc and new are you? That always messes things up.
<br/>
<br/>
Remember that by default, the compiler will try and allocate everything in IWRAM (uh, Im not absolutely sure on this but I think that's right), and you only have 32k of that, so trying to allocate a big arrays won't work.
<br/>
<br/>
Without knowing anymore about your problem it's hard to know what could be going wrong, but I guess it's a pointer problem as opposed to a problem with malloc.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#6867 - Jason Wilkins - Tue Jun 03, 2003 8:31 pm</h4>
    <div class="postbody"><span class="postbody">The default new operator uses malloc and the default delete uses free.  It will not get messed up unless you delete something you malloc'ed or free something you new'ed.  Even then, it might work, except that constructors and destructors won't get called.
<br/>
<br/>
Ever since I got malloc working on DevKit Advance it has always malloc'ed out of -External- WRAM.  R5 does allow you to malloc out of iwram by defining __gba_iwram_heap, but ewram is the default.
<br/>
<br/>
The original poster is being way too vague, and he will not get any help unless he tells us what compiler he is using, enough code to know what he is doing, and the command line he is using to compile.<br/>_________________<br/><a href="http://devkitadv.sourceforge.net" target="_blank">http://devkitadv.sourceforge.net</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#6882 - tangl_99 - Wed Jun 04, 2003 4:23 am</h4>
    <div class="postbody"><span class="postbody">1.
<br/>
My complier is the Nintendo Official Compiler.
<br/>
It consis of a Cygnus and a Armelf-000512.
<br/>
<br/>
<br/>
<br/>
2.
<br/>
And the linker didn't report errors!
<br/>
<br/>
<br/>
<br/>
3.
<br/>
The makefile is this:
<br/>
<br/>
.SFILES    =   crt0.s
<br/>
.CFILES    =   main.c share.c title.c libsound.c
<br/>
.OFILES    =   $(.SFILES:.s=.o) $(.CFILES:.c=.o)
<br/>
<br/>
AGBINC	   =	$(AGBDIR)/include
<br/>
AGBLIB	   =	$(AGBDIR)/lib
<br/>
ASFLAGS    =          -I$(AGBINC)  -mthumb-interwork
<br/>
CFLAGS     =   -g -O0 -I$(AGBINC)  -mthumb-interwork \
<br/>
               -nostdlib #-DNDEBUG 
<br/>
LDFLAGS    +=  -Map $(MAPFILE) -nostartfiles \
<br/>
               -Ttext 0x08000000 -Tbss 0x03000000 \
<br/>
               -L$(AGBLIB)  -lm -lagbsyscall -lisagbprn
<br/>
<br/>
DEPENDFILE =   Makedepend 
<br/>
MAPFILE    =   game.map
<br/>
TARGET_ELF =   game.elf
<br/>
TARGET_BIN =   gamegcc.bin
<br/>
<br/>
<br/>
$(TARGET_BIN): $(TARGET_ELF)
<br/>
	objcopy -v -O binary $&lt; $@
<br/>
<br/>
$(TARGET_ELF): $(.OFILES) Makefile $(DEPENDFILE)
<br/>
	@echo &gt; $(MAPFILE)
<br/>
	$(CC) -g -o $@ $(.OFILES)  -Wl,$(LDFLAGS)
<br/>
<br/>
.PHONY: all clean depend
<br/>
<br/>
all:    clean depend $(TARGET_BIN)
<br/>
<br/>
clean:
<br/>
	-rm $(.OFILES) $(DEPENDFILE) $(MAPFILE) $(TARGET_ELF) $(TARGET_BIN)
<br/>
<br/>
depend:
<br/>
	$(CC) $(CFLAGS) -M $(.CFILES) &gt; $(DEPENDFILE)
<br/>
<br/>
$(DEPENDFILE): 
<br/>
	$(CC) $(CFLAGS) -M $(.CFILES) &gt; $(DEPENDFILE)
<br/>
<br/>
include Gasdepend
<br/>
include $(DEPENDFILE)
<br/>
<br/>
<br/>
<br/>
4.
<br/>
for example:
<br/>
u16 *pMem;
<br/>
pMem=malloc(100);
<br/>
<br/>
But in fact the value of pMem is 0.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#6889 - Quirky - Wed Jun 04, 2003 7:40 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tangl_99 wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
The makefile is this:
<br/>
<br/>
AGBINC	   =	$(AGBDIR)/include
<br/>
AGBLIB	   =	$(AGBDIR)/lib
<br/>
CFLAGS     =   -g -O0 -I$(AGBINC)  -mthumb-interwork \
<br/>
<span style="font-weight: bold">-nostdlib</span> #-DNDEBUG 
<br/>
LDFLAGS    +=  -Map $(MAPFILE) -nostartfiles \
<br/>
               -Ttext 0x08000000 -Tbss 0x03000000 \
<br/>
               -L$(AGBLIB)  -lm <span style="font-weight: bold">-lagbsyscall -lisagbprn</span>
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
OK, it looks to me like you aren't using the standard malloc in newlib, as you ditch the standard library and use libagbsyscall.a and libisagbprn.a which (I imagine) have some stubs or something to get round complaints about "undefined reference to malloc" without actually implementing it.
<br/>
<br/>
That would be my guess anyway.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#6897 - torne - Wed Jun 04, 2003 10:42 am</h4>
    <div class="postbody"><span class="postbody">He's using the real Nintendo development kit (illegal unless he has a licence from Nintendo) which has totally different libraries that don't even pretend to be compatible with libc and friends. =)
<br/>
<br/>
Nobody here is likely to help you, I'm afraid; most people haven't used the Nintendo devkit and those who have are likely to keep quiet about it. *grin*
<br/>
<br/>
I suggest you throw it away, and get Jason Wilkins' excellent DevKitAdvance instead, because if you release homebrew software with Nintendo libraries linked into it, their lawyers will be paying you a visit.
<br/>
<br/>
Torne</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#6913 - Jason Wilkins - Wed Jun 04, 2003 2:37 pm</h4>
    <div class="postbody"><span class="postbody">I find it really odd that Nintendo's libraries would have stubs for malloc which do nothing.  It would be better to just have the 'undefined symbol' errors.<br/>_________________<br/><a href="http://devkitadv.sourceforge.net" target="_blank">http://devkitadv.sourceforge.net</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#6916 - niltsair - Wed Jun 04, 2003 3:00 pm</h4>
    <div class="postbody"><span class="postbody">Unless they want to sniff out people without the proper licence, asking questions about it. ;-)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#6924 - Quirky - Wed Jun 04, 2003 4:00 pm</h4>
    <div class="postbody"><span class="postbody">I was just guessing, it might not be that. The closest I've got to an official Nintendo library was buying Wario Ware the other week ;-) It might be that without a decent link script __eheap_start is not defined, so malloc doesn't know where to allocate memory from and just returns 0.
<br/>
<br/>
Because Devkit Advance is so great and easy to use (JW's contribution to the GBA community cannot be understated), all this worked first time for me and I haven't really thought about it much :-)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#6929 - torne - Wed Jun 04, 2003 5:44 pm</h4>
    <div class="postbody"><span class="postbody">He is including the embedded version of the Red Hat GNUPro Toolkit C library, and I am pretty sure you need to do some amount of nontrivial setup to let it know where the heap base and limit are before you can call malloc. I don't remember the exact details. I don't have GNUPro installed and can't be bothered to do so to help someone who's using stolen tools and libraries, to be honest.
<br/>
<br/>
Throw the Nintendo dev kit away, it blows anyway, and use Jason's excellent DevKitAdvance, with better C library support *grin*
<br/>
<br/>
Torne</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#6956 - tangl_99 - Thu Jun 05, 2003 6:27 am</h4>
    <div class="postbody"><span class="postbody">Thanks for Torne's note.
<br/>
<br/>
The Nintendo's library is worth to study,but I won't release a game by it.It has the offical documents about the GBA.
<br/>
<br/>
I have used DevKitAdv for a long time.
<br/>
<br/>
But there is some other problems:
<br/>
How can I use interrupts in DevKitAdv ?
<br/>
<br/>
should I download the crt0.s with DevKitAdv?
<br/>
<br/>
I don't know how to use it.How to link it?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#6957 - Jason Wilkins - Thu Jun 05, 2003 6:35 am</h4>
    <div class="postbody"><span class="postbody">Of course you can use interrupts.
<br/>
<br/>
Rip the interrupt code out of Nintendo's examples or Jeff's crt0.s.  They are the same code.  Adapt it for your own project.  There is not need for the interrupt code to be in crt0.s.
<br/>
<br/>
Tommorow, I think I will do this myself and post in on the DKA website, because it is something I mean to include in beta 4, but you are the second person to ask about this.<br/>_________________<br/><a href="http://devkitadv.sourceforge.net" target="_blank">http://devkitadv.sourceforge.net</a></span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
