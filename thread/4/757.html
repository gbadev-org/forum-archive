<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>tile modes - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>Coding > tile modes</h2>
<div id="posts">
<div class="post">
    <h4>#3865 - Ninj4D4n - Tue Mar 11, 2003 3:38 am</h4>
    <div class="postbody"><span class="postbody">Hi all,
<br/>
I'm trying to work with multiple backgrounds and i'm running into some trouble.  To start i only wanted to load one map....Sometimes i can see the map and sometimes i get garbage, only changing the background used for the and display mode here's what i get
<br/>
<br/>
Mode0
<br/>
bg0: garbage
<br/>
bg1: garbage
<br/>
bg2: garbage
<br/>
bg3: garbage
<br/>
<br/>
Mode1
<br/>
bg0: garbage
<br/>
bg1: garbage
<br/>
bg2: OK
<br/>
<br/>
Mode2
<br/>
bg2: OK
<br/>
bg3: OK
<br/>
<br/>
Does anybody know what's going on here?  I think it has something to do with text vs rot backgrounds.  
<br/>
<br/>
I want to be able to use mode0 because i would like to eventually have 4 layers with transparency working.
<br/>
<br/>
--Ninj4D4n</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#3866 - jammin.won - Tue Mar 11, 2003 3:52 am</h4>
    <div class="postbody"><span class="postbody">it looks like all the working bg is with r/s ....so i guess if u've set the r/s bit in BG*CNT ...
<br/>
<br/>
and all r/s bg is with 256 colors only ... so dont forget this point...
<br/>
<br/>
btw i'm a newbie still dunno if the suggestion will work ... -______-<br/>_________________<br/><a href="http://www.pocketzone.org/bbs/usr/8/8_10_10.jpg">[Images not permitted - Click here to view it]</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#3867 - tepples - Tue Mar 11, 2003 6:17 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Ninj4D4n wrote:</b></span></td> </tr> <tr> <td class="quote">Sometimes i can see the map and sometimes i get garbage, only changing the background used for the and display mode here's what i get
<br/>
<br/>
(non-rot/scale bgs: garbage)
<br/>
(rot/scale bgs: ok)</td> </tr></table><span class="postbody">
<br/>
Are you making sure to turn on 256 color mode in the BG?CNT registers for the non-rot/scale backgrounds?
<br/>
<br/>
Are you making sure to write one tile per 16 bits (not per 8 bits) to the map, and to write only 32x32 tiles at a time? (Larger maps are created by replacing the map entries at the seam of the scroll.)<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#3877 - Ninj4D4n - Tue Mar 11, 2003 2:29 pm</h4>
    <div class="postbody"><span class="postbody">I think i've got all of that stuff set up right... here's some of my code
<br/>
<br/>
main file
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#include "gba.h"      //gba regisers
<br/>
#include "keypad.h"      //input register
<br/>
#include "screenmode.h"   //screen mode register
<br/>
#include "sprite.h"      //sprite definitions
<br/>
#include "bg.h"
<br/>
#include "trig.h"      //sin and cos tables
<br/>
#include "timers.h"
<br/>
<br/>
<br/>
//#include "intro2.h"
<br/>
#include "gfxh/tiles.h"
<br/>
#include "gfxh/tilespalette.h"
<br/>
#include "gfxh/Flash.c"
<br/>
<br/>
void GetInput(void);
<br/>
Bg mask;
<br/>
<br/>
int main()
<br/>
{
<br/>
   //setup for random number generator
<br/>
   REG_TM3CNT = TIME_FREQUENCY_1024 | TIME_ENABLE;
<br/>
   REG_TM3D = 0;
<br/>
<br/>
   SetMode(MODE_1 | OBJ_ENABLE | OBJ_MAP_1D); //set mode 1 and enable sprites and 1d mapping
<br/>
   InitializeSprites();
<br/>
<br/>
<br/>
<br/>
   mask.number = 2;
<br/>
   mask.charBaseBlock = 0;     //tiles in 3
<br/>
   mask.screenBaseBlock = 28;   //mask in 0 (above)
<br/>
   mask.colorMode = BG_COLOR_256;
<br/>
   mask.size = ROTBG_SIZE_256x256;
<br/>
   mask.mosaic = 0;
<br/>
   mask.x_scroll = 0;
<br/>
   mask.y_scroll = 0;
<br/>
<br/>
   EnableBackground(&amp;mask);
<br/>
<br/>
   u16 loop;
<br/>
   //load palette
<br/>
   for(loop = 0; loop &lt; 256; loop++)
<br/>
      BGPalette[loop] = tilesPalette[loop];
<br/>
<br/>
   //load tile set; charbase block 0
<br/>
   for(loop = 0; loop &lt; tiles_WIDTH * tiles_HEIGHT /2; loop++)
<br/>
      mask.tileData[loop] = tilesData[loop];
<br/>
<br/>
   //load maps
<br/>
   //mask in screen base block 28
<br/>
   u16* tempData = (u16*)Flash;  //16bit transfer
<br/>
   for(loop = 0; loop &lt; 32*32/2; loop++)
<br/>
      mask.mapData[loop] = tempData[loop];
<br/>
   ////////////////////////////////////////
<br/>
   //start the game loop
<br/>
   while(1)
<br/>
   {
<br/>
<br/>
   }
<br/>
   return 0;
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
bg.h
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#include "screenmode.h"
<br/>
#include "gba.h"
<br/>
#include "trig.h"
<br/>
<br/>
#ifndef BG_H
<br/>
#define BG_H
<br/>
<br/>
<br/>
///BGCNT defines ///
<br/>
#define BG_MOSAIC_ENABLE      0x40
<br/>
#define BG_COLOR_256         0x80
<br/>
#define BG_COLOR_16            0x0
<br/>
//macros to point to mememory
<br/>
#define CharBaseBlock(n)      (((n)*0x4000)+0x6000000)
<br/>
#define ScreenBaseBlock(n)      (((n)*0x800)+0x6000000)
<br/>
<br/>
#define CHAR_SHIFT            2
<br/>
#define SCREEN_SHIFT         8
<br/>
#define TEXTBG_SIZE_256x256      0x0
<br/>
#define TEXTBG_SIZE_256x512      0x8000
<br/>
#define TEXTBG_SIZE_512x256      0x4000
<br/>
#define TEXTBG_SIZE_512x512      0xC000
<br/>
<br/>
#define ROTBG_SIZE_128x128      0x0
<br/>
#define ROTBG_SIZE_256x256      0x4000
<br/>
#define ROTBG_SIZE_512x512      0x8000
<br/>
#define ROTBG_SIZE_1024x1024   0xC000
<br/>
<br/>
#define WRAPAROUND                0x1
<br/>
<br/>
u16* BGPalette     =(u16*)0x5000000;
<br/>
<br/>
//structure for a background
<br/>
typedef struct Bg
<br/>
{
<br/>
   u16* tileData;
<br/>
   u16* mapData;
<br/>
   u8 mosaic;
<br/>
   u8 colorMode;
<br/>
   u8 number;
<br/>
   u16 size;
<br/>
   u8 charBaseBlock;
<br/>
   u8 screenBaseBlock;
<br/>
   u8 wraparound;
<br/>
   s16 x_scroll,y_scroll;
<br/>
   s32 DX,DY;
<br/>
   s16 PA,PB,PC,PD;
<br/>
}Bg;
<br/>
<br/>
//turns on a background
<br/>
void EnableBackground(Bg* bg)
<br/>
{
<br/>
   u16 temp;
<br/>
<br/>
   bg-&gt;tileData = (u16*)CharBaseBlock(bg-&gt;charBaseBlock);
<br/>
   bg-&gt;mapData = (u16*)ScreenBaseBlock(bg-&gt;screenBaseBlock);
<br/>
   temp = bg-&gt;size | (bg-&gt;charBaseBlock&lt;&lt;CHAR_SHIFT) | (bg-&gt;screenBaseBlock&lt;&lt;SCREEN_SHIFT)
<br/>
      | bg-&gt;colorMode | bg-&gt;mosaic | bg-&gt;wraparound;
<br/>
<br/>
   switch(bg-&gt;number)
<br/>
   {
<br/>
   case 0:
<br/>
      {
<br/>
         REG_BG0CNT = temp;
<br/>
         REG_DISPCNT |= BG0_ENABLE;
<br/>
      }break;
<br/>
   case 1:
<br/>
      {
<br/>
         REG_BG1CNT = temp;
<br/>
         REG_DISPCNT |= BG1_ENABLE;
<br/>
      }break;
<br/>
   case 2:
<br/>
      {
<br/>
         REG_BG2CNT = temp;
<br/>
         REG_DISPCNT |= BG2_ENABLE;
<br/>
      }break;
<br/>
   case 3:
<br/>
      {
<br/>
         REG_BG3CNT = temp;
<br/>
         REG_DISPCNT |= BG3_ENABLE;
<br/>
      }break;
<br/>
<br/>
   default:break;
<br/>
<br/>
   }
<br/>
}
<br/>
<br/>
//clears the background registers
<br/>
void ClearBackgrounds(void)
<br/>
{
<br/>
   REG_BG0CNT = 0x0000;
<br/>
   REG_BG1CNT = 0x0000;
<br/>
   REG_BG2CNT = 0x0000;
<br/>
   REG_BG3CNT = 0x0000;
<br/>
   REG_DISPCNT = 0x0000;
<br/>
}
<br/>
<br/>
//update the background
<br/>
void UpdateBackground(Bg* bg)
<br/>
{
<br/>
   switch(bg-&gt;number)
<br/>
   {
<br/>
   case 0:
<br/>
      REG_BG0HOFS = bg-&gt;x_scroll;
<br/>
      REG_BG0VOFS = bg-&gt;y_scroll;
<br/>
      break;
<br/>
   case 1:
<br/>
      REG_BG1HOFS = bg-&gt;x_scroll;
<br/>
      REG_BG1VOFS = bg-&gt;y_scroll;
<br/>
      break;
<br/>
   case 2:
<br/>
      if(!(REG_DISPCNT &amp; MODE_0))//it is a rot background
<br/>
      {
<br/>
         REG_BG2X = bg-&gt;DX;
<br/>
         REG_BG2Y = bg-&gt;DY;
<br/>
<br/>
         REG_BG2PA = bg-&gt;PA;
<br/>
         REG_BG2PB = bg-&gt;PB;
<br/>
         REG_BG2PC = bg-&gt;PC;
<br/>
         REG_BG2PD = bg-&gt;PD;
<br/>
      }
<br/>
      else  //it is a text background
<br/>
      {
<br/>
         REG_BG2HOFS = bg-&gt;x_scroll;
<br/>
         REG_BG2VOFS = bg-&gt;y_scroll;
<br/>
      }
<br/>
      break;
<br/>
   case 3:
<br/>
      if(!(REG_DISPCNT &amp; MODE_0))//it is a rot background
<br/>
      {
<br/>
         REG_BG3X = bg-&gt;DX;
<br/>
         REG_BG3Y = bg-&gt;DY;
<br/>
<br/>
         REG_BG3PA = bg-&gt;PA;
<br/>
         REG_BG3PB = bg-&gt;PB;
<br/>
         REG_BG3PC = bg-&gt;PC;
<br/>
         REG_BG3PD = bg-&gt;PD;
<br/>
      }
<br/>
      else //it is a text background
<br/>
      {
<br/>
         REG_BG3HOFS = bg-&gt;x_scroll;
<br/>
         REG_BG3VOFS = bg-&gt;y_scroll;
<br/>
      }
<br/>
      break;
<br/>
   default: break;
<br/>
   }
<br/>
}
<br/>
<br/>
//rotate background
<br/>
void RotateBackground(Bg* bg, int angle,int center_x, int center_y, FIXED zoom)
<br/>
{
<br/>
<br/>
   center_y = (center_y * zoom)&gt;&gt;8;
<br/>
   center_x = (center_x * zoom)&gt;&gt;8;
<br/>
<br/>
   bg-&gt;DX = ((bg-&gt;x_scroll&lt;&lt;8)-center_y*SIN[angle]-center_x*COS[angle]);
<br/>
   bg-&gt;DY = ((bg-&gt;y_scroll&lt;&lt;8)-center_y*COS[angle]+center_x*SIN[angle]);
<br/>
<br/>
   bg-&gt;PA = (COS[angle]*zoom)&gt;&gt;8;  //cos&amp;sin are LUTs that are .8 fixed numbers
<br/>
   bg-&gt;PB = (SIN[angle]*zoom)&gt;&gt;8;  //zoom is also fixed
<br/>
   bg-&gt;PC = (-SIN[angle]*zoom)&gt;&gt;8;
<br/>
   bg-&gt;PD = (COS[angle]*zoom)&gt;&gt;8;
<br/>
}
<br/>
<br/>
#endif
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
<br/>
i don't know if that will help anyone tell me what's wrong
<br/>
<br/>
--Ninj4D4n</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#3890 - tepples - Tue Mar 11, 2003 9:46 pm</h4>
    <div class="postbody"><span class="postbody">"Jumbled" and "scrambled" don't help much. A screenshot would help more.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#3911 - Ninj4D4n - Wed Mar 12, 2003 7:00 pm</h4>
    <div class="postbody"><span class="postbody">By "garabge", i mean that the image does use tiles from my tileset, but that the tiles aren't the right image, and they're not in anysort of pattern related to the original image.
<br/>
<br/>
Now i know this has to do with the differences between text and rotational backgrounds.  So i guess my question is, how does the format of each differ? and how does the loading/setup of each differ?
<br/>
<br/>
--Ninj4D4n</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#3916 - pollier - Wed Mar 12, 2003 8:02 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Now i know this has to do with the differences between text and rotational backgrounds.  So i guess my question is, how does the format of each differ?</td> </tr></table><span class="postbody">
<br/>
<br/>
Rotation maps use 8-bit data (8 bits for tile index), while text maps use 16-bit (9 or 10 bits for tile index, plus flags like vertical and horizontal flipping) Trying to load rotation map data into the text maps will defintely produce garbage; either reconvert your map data to 16-bit, or maybe changing <span style="font-weight: bold">u16* tempData</span> to <span style="font-weight: bold">u8* tempData</span> might cut it.<br/>_________________<br/>(Works for me!)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#3919 - jenswa - Wed Mar 12, 2003 8:39 pm</h4>
    <div class="postbody"><span class="postbody">maybe if you changed ROTBG_SIZE_ into TEXTBG
<br/>
<br/>
you can only use 2 rot backgrounds as max and 4 text backgrounds.
<br/>
<br/>
in mode 0 there are no rot backgrounds, so that's
<br/>
probably why you get garbage,
<br/>
in mode 1 there is one rot background, bg2, that's
<br/>
why you can see bg2 and the others are garbage,
<br/>
in mode 2 there are two rot backgrounds bg2 and bg3
<br/>
and that's the reason why you see both of the backgrounds right,
<br/>
you're using rotational maps instead of textmaps.
<br/>
<br/>
so simply change it into text background or else i would
<br/>
say start over in keep in mind that you should use text backgrounds.
<br/>
but simply changing rot into text might work.
<br/>
<br/>
hope this helps a bit
<br/>
<br/>
JJ<br/>_________________<br/>It seems this wasn't lost after all.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#3922 - Ninj4D4n - Wed Mar 12, 2003 10:02 pm</h4>
    <div class="postbody"><span class="postbody">and we have a winner....
<br/>
Thanks polier.. that was the problem.  Thanks everyone for the help.
<br/>
<br/>
--Ninj4D4n</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
