<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Assigning values to system addresses through #define - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>Coding > Assigning values to system addresses through #define</h2>
<div id="posts">
<div class="post">
    <h4>#79492 - Natso - Fri Apr 14, 2006 12:42 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#define rcnt   ((volatile u16 *)0x00000134);
<br/>
<br/>
static u16 mplayinit(){
<br/>
<br/>
   rcnt=0;
<br/>
<br/>
   return 0;
<br/>
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
Ok, I feel really stupid cause I can't figure this out but I'll feel stupider if I stay up all night and don't ask, so...
<br/>
I'm trying to assign a new value to "rcnt". Coincidintally this is one of the addresses involved in multiplayer connections, but I don't think that will make a difference here.
<br/>
As you can see, rcnt is supposed to be a variable with a specific location(in my document it says it is located at "134h" and so I derived the location for the #define) however I have inexperience doing this and... well I have to clue as to what to do :D<br/>_________________<br/>I'm a bomb technitian. If you see me running, try to keep up ;)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#79496 - keldon - Fri Apr 14, 2006 1:02 am</h4>
    <div class="postbody"><span class="postbody">(a) that is the wrong address for RCNT
<br/>
(b) 
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#define   REG_BASE   0x04000000
<br/>
#define REG_RCNT      *(vu16*)(REG_BASE + 0x134)   // SIO Mode Select/General Purpose Data</td> </tr></table><span class="postbody">
<br/>
<br/>
vu16 is of type u16 volatile. This is defined in gba_sio.h.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#79497 - Cearn - Fri Apr 14, 2006 1:06 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Natso wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#define rcnt   ((volatile u16 *)0x00000134);</td> </tr></table><span class="postbody">
<br/>
</span></td> </tr></table><span class="postbody">This is a pointer to put a value into a pointer, you need to dereference it. Also, all IO registers are in the 0400:0000h range, 0x134 is just an offset in that range
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
// 0x04000134 is an address
<br/>
// ((volatile u16*)0x04000134) is a pointer
<br/>
// *((volatile u16*)0x04000134) is a dereferenced pointer
<br/>
#define REG_RCNT   *((volatile u16*)0x04000134)
<br/>
REG_RCNT= 0;
<br/>
</td> </tr></table><span class="postbody">
<br/>
Incidentally, there are a great number of sites with the full range of REG_x defines and all sorts of other neat stuff. You could save yourself a lot of typing by just grabbing some of that code.
<br/>
<br/>
<span style="font-size: 9px; line-height: normal">EDIT: because I lose all ability to spell after 2am</span></span><span class="gensmall"><br/><br/>Last edited by Cearn on Fri Apr 14, 2006 1:16 am; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#79500 - Natso - Fri Apr 14, 2006 1:13 am</h4>
    <div class="postbody"><span class="postbody">yeah, but I like to know exactly what the code is doing &amp; stuff like that. I will go and try that code now. thanks for the help btw<br/>_________________<br/>I'm a bomb technitian. If you see me running, try to keep up ;)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#79502 - Natso - Fri Apr 14, 2006 1:29 am</h4>
    <div class="postbody"><span class="postbody">#define rcnt   *((volatile u16*)0x04000134)
<br/>
rcnt= 0; 
<br/>
<br/>
<br/>
Ok for this, it says that there is a syntax error before the =. I assume this means that rcnt is the problem. Obviosly the code didn't work. Any clues?<br/>_________________<br/>I'm a bomb technitian. If you see me running, try to keep up ;)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#79504 - Cearn - Fri Apr 14, 2006 1:37 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Natso wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#define rcnt *((volatile u16*)0x04000134)
<br/>
rcnt= 0;</td> </tr></table><span class="postbody">Ok for this, it says that there is a syntax error before the =. I assume this means that rcnt is the problem. Obviously the code didn't work. Any clues?</span></td> </tr></table><span class="postbody">
<br/>
<br/>
The assignment should be done inside a function. 
<br/>
<br/>
If you're new to C, you might want to take a look at the tutorials gathered <a class="postlink" href="http://forum.gbadev.org/viewtopic.php?t=8353" target="_blank">here</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#79507 - Natso - Fri Apr 14, 2006 1:45 am</h4>
    <div class="postbody"><span class="postbody">Lol. the 2nd line was inside a perfectly legal function. Is there any other reason this line would not work?<br/>_________________<br/>I'm a bomb technitian. If you see me running, try to keep up ;)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#79511 - Cearn - Fri Apr 14, 2006 1:56 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Natso wrote:</b></span></td> </tr> <tr> <td class="quote">Lol. the 2nd line was inside a perfectly legal function. Is there any other reason this line would not work?</td> </tr></table><span class="postbody">Uhmmm, no?
<br/>
<br/>
Oh wait, are you sure you have a typedef or define for 'u16'?
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">typedef short u16;</td> </tr></table><span class="postbody">
<br/>
Other than that, I can't thing of anything. Just copy pasted to be sure, but it runs fine for me.
<br/>
<br/>
Try this:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
typedef short u16;
<br/>
<br/>
#define REG_RCNT (*(volatile u16*)0x04000134)
<br/>
<br/>
int main()
<br/>
{
<br/>
   REG_RCNT=0;
<br/>
<br/>
   return 0;
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
Doesn't do anything useful, but at the very least it should compile. If not, post the 'exact' error(s) you're getting.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#79516 - Cearn - Fri Apr 14, 2006 2:35 am</h4>
    <div class="postbody"><span class="postbody">NOTE: Crossposted. Twice. &gt;_&lt;
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Natso wrote:</b></span></td> </tr> <tr> <td class="quote">#define rcnt   *((volatile u16*)0x04000134)
<br/>
rcnt= 0; 
<br/>
<br/>
Ok for this, it says that there is a syntax error before the =. I assume this means that rcnt is the problem. Obviosly the code didn't work. Any clues?</td> </tr></table><span class="postbody">
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Me wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">// 0x04000134 is an address
<br/>
// ((volatile u16*)0x04000134) is a pointer
<br/>
// *((volatile u16*)0x04000134) is a dereferenced pointer
<br/>
#define REG_RCNT   *((volatile u16*)0x04000134)
<br/>
REG_RCNT= 0; </td> </tr></table><span class="postbody"></span></td> </tr></table><span class="postbody">
<br/>
:P
<br/>
<br/>
The whole thing with asterixes and pointers is just part of C syntax. The number 0400:0134 (easier to read notation for 0x04000134) is a memory address, indicating a certain range of bits in GBA memory. But an address in itself doesn't mean very much to C itself, for that you need <span style="font-style: italic">pointers</span>, indicated by a unary asterix. Strictly speaking, pointers are variables that contain an address. The ' type'  of a pointer tells the compiler how it's supposed to deal with that address. For example
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">// typedefs for u16 and u32 to shorten the code
<br/>
typedef unsigned short u16;
<br/>
typedef unsigned int u32;
<br/>
<br/>
u16 *p16= (u16*)0x06000000;
<br/>
u13 *p32= (u32*)0x06000000;</td> </tr></table><span class="postbody">
<br/>
p16 and p32 are both pointers to the address 0600:0000. However, p16 uses it in 16bit chunks (2 bytes at a time), while p32 uses it in 32bit chunks (4bytes). Both are completely legal. To make use of the contents of the address the pointer points to, you 'dereference' it by using either another asterix in front of it.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">*p16= 0x1234;     // dereferences p16; writes 0x1234 into address 0600:0000
<br/>
*p32= 0x12345678; // dereferences p32; writes 0x12345678 into address 0600:0000
<br/>
</td> </tr></table><span class="postbody">
<br/>
The reason you need the extra asterix is because simply assigning a value to the pointer changes the pointer itself, not the thing it points to. Or at least it would if it were legal to do that without an explicit cast, but it's the thought that counts.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">*p16= 0x1234;     // dereferences p16; writes 0x1234 into address 0600:0000
<br/>
p16= 0x1234; // p16 now points to address 0x1234
<br/>
</td> </tr></table><span class="postbody">
<br/>
Arrays have a lot in common. In fact, they can often be interchanged.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">*p16= 0x1234;     // dereferences p16; writes 0x1234 into address 0600:0000 (into 0600:0000 and 0600:0001, really)
<br/>
*p32= 0x12345678; // dereferences p32; writes 0x12345678 into address 0600:0000 (:0000, :0001, :0002 and :0003)
<br/>
// equivalent to:
<br/>
p16[0]= 0x1234;
<br/>
p32[0]= 0x12345678;
<br/>
<br/>
// writes 0x1234 into the first halfword [i]after[/i] 0600:0000. I.e., 0600:0002 (2 bytes because a halfword is 2 bytes long)
<br/>
p16[1]= 0x1234;
<br/>
// writes 0x12345678 into the first word [i]after[/i] 0600:0000. I.e., 0600:0004 (4 bytes because a word is 4 bytes long)
<br/>
p32[1]= 0x12345678;
<br/>
<br/>
// pointer/array equivalency encore: does the same as above
<br/>
// parentheses are required because of operator precedence
<br/>
*(p16+1)= 0x1234;
<br/>
*(p32+1)= 0x12345678;
<br/>
</td> </tr></table><span class="postbody">
<br/>
The number between brackets is an <span style="font-style: italic">offset</span> from the starting point of the pointer or array, in units of the pointer/array type. That's why the actual addresses of p16[1] and p32[1] is different. Think about it for a while and you'll see that this is a sensible thing to do. By the way, you can find the address using '&amp;'.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">&amp;p16[0]  // gives 0600:0000
<br/>
&amp;p16[1]  // gives 0600:0002
<br/>
&amp;p32[1]  // gives 0600:0004
<br/>
</td> </tr></table><span class="postbody">
<br/>
In these cases I've use an actual variable for the pointers, but that's not really necessary. The pointer cast itself is enough.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">*(u16*)0x06000000= 0x1234; // take a guess
<br/>
*(u32*)0x06000000= 0x12345678;
<br/>
</td> </tr></table><span class="postbody">
<br/>
Of course, magic numbers are considered evil, so we cover them up with #defines
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#define MEM_VRAM 0x06000000
<br/>
#define vid_mem ((u16*)MEM_VRAM)
<br/>
<br/>
vid_mem[0]= 0x1234;  // 0x1234 into 0600:0000
<br/>
vid_mem[1]= 0x5678;  // 0x5678 into 0600:0002
<br/>
</td> </tr></table><span class="postbody">
<br/>
Again, the outer pair of parentheses are required due to operator precedence.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#define MEM_VRAM 0x06000000
<br/>
#define vid_mem (u16*)MEM_VRAM
<br/>
<br/>
// this is (u16*)0x06000000[1], which is parsed as (u16*)(0x06000000[1])
<br/>
// numbers aren't arrays or pointers, so this fails
<br/>
vid_mem[1]= 0x5678;
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
<br/>
Back to the original #define
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#define rcnt *((volatile u16*)0x04000134) 
<br/>
<br/>
rcnt= 0;
<br/>
</td> </tr></table><span class="postbody">
<br/>
<span style="font-weight: bold">0x04000134</span> is an address. 
<br/>
<span style="font-weight: bold">(volatile u16*)0x04000134</span> casts it to a volatile u16 pointer. The volatile is necessary because the contents of this address can be modified by hardware, and you need to tell the compiler that.
<br/>
<span style="font-weight: bold">*(volatile u16*)0x04000134</span> dereferences the pointer so that it works as a variable. A halfword variable, because the pointer's type is u16.
<br/>
<br/>
Right. I hope this makes any kind of sense; I've slept about 4 hours of the last 66, so I'm starting to have trouble judging. I'll go over it again tomorrow if necessary.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#79532 - Natso - Fri Apr 14, 2006 4:11 am</h4>
    <div class="postbody"><span class="postbody">AAAAAAAAAAAGH I'm going totally crazy.
<br/>
My problem with my code was a ; in the #define(Yeah now i feel terribly stupid to have wasted hours on a ; ).
<br/>
<br/>
Regardless you have tought me much in that post, and I should be able to retype my code in a working manner. Thanks a bunch bunch bunch for you help in letting me sleep tonight(I wouldn't have slept a wink). In the meantime you need to break your 66hour spell and get some sleep too.
<br/>
<br/>
 - Zach<br/>_________________<br/>I'm a bomb technitian. If you see me running, try to keep up ;)</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
