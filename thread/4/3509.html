<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Problem calling function pointer from IWRAM - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>Coding > Problem calling function pointer from IWRAM</h2>
<div id="posts">
<div class="post">
    <h4>#21676 - mclysenk - Wed Jun 02, 2004 10:20 pm</h4>
    <div class="postbody"><span class="postbody">I have the following code:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
void (*p_func_ptr)();
<br/>
<br/>
void not_in_iwram()
<br/>
{
<br/>
     p_func_ptr();
<br/>
}
<br/>
<br/>
void __attribute__ ((section (".iwram"), long_call)) code_in_iwram()
<br/>
{
<br/>
     p_func_ptr();
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Both of these compile just fine, but when it comes time to link, I get the following error:
<br/>
<br/>
relocation truncated to fit: R_ARM_THM_PC22 _call_via_r2
<br/>
collect2: ld returned 1 exit status
<br/>
<br/>
The error only occurs in the IWRAM function and I can't figure out why.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#21678 - Miked0801 - Wed Jun 02, 2004 10:23 pm</h4>
    <div class="postbody"><span class="postbody">Are you compiling with interworking on?  That error usually means either no interworking or that the function pointer is beign access wrong and turned into a local jump even though it won't work as such.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#21679 - mclysenk - Wed Jun 02, 2004 10:35 pm</h4>
    <div class="postbody"><span class="postbody">I am compiling with the command:
<br/>
arm-elf-gcc -MMD -g -Wall -mcpu=arm7tdmi -mtune=arm7tdmi -mthumb -mthumb-interwork -o test.o -c test.c
<br/>
<br/>
and linking with the command
<br/>
ld -g -mthumb -mthumb-interwork -specs=gba.specs test.o -o test.elf</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#21680 - poslundc - Wed Jun 02, 2004 10:40 pm</h4>
    <div class="postbody"><span class="postbody">Can you compile with the -S flag and post the assembly output the compiler is generating? That may shed some light on the situation.
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#21681 - mclysenk - Wed Jun 02, 2004 11:03 pm</h4>
    <div class="postbody"><span class="postbody">Here is the generated assembly for both functions:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
   .align   2
<br/>
   .global   not_in_iwram
<br/>
   .code 16
<br/>
   .thumb_func
<br/>
   .type   not_in_iwram, %function
<br/>
not_in_iwram:
<br/>
.LFB2:
<br/>
   .file 1 "test.c"
<br/>
   .loc 1 4 0
<br/>
   push   {r7, lr}
<br/>
.LCFI0:
<br/>
   mov   r7, sp
<br/>
.LCFI1:
<br/>
   .loc 1 5 0
<br/>
   ldr   r3, .L2
<br/>
   ldr   r3, [r3]
<br/>
   bl   _call_via_r3
<br/>
   .loc 1 6 0
<br/>
   mov   sp, r7
<br/>
   @ sp needed for prologue
<br/>
   pop   {r7}
<br/>
   pop   {r0}
<br/>
   bx   r0
<br/>
.L3:
<br/>
   .align   2
<br/>
.L2:
<br/>
   .word   p_func_ptr
<br/>
</td> </tr></table><span class="postbody">
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
   .size   not_in_iwram, .-not_in_iwram
<br/>
   .section   .iwram,"ax",%progbits
<br/>
   .align   2
<br/>
   .global   code_in_iwram
<br/>
   .code 16
<br/>
   .thumb_func
<br/>
   .type   code_in_iwram, %function
<br/>
code_in_iwram:
<br/>
.LFB3:
<br/>
   .loc 1 9 0
<br/>
   push   {r7, lr}
<br/>
.LCFI2:
<br/>
   mov   r7, sp
<br/>
.LCFI3:
<br/>
   .loc 1 10 0
<br/>
   ldr   r3, .L5
<br/>
   ldr   r3, [r3]
<br/>
   bl   _call_via_r3
<br/>
   .loc 1 11 0
<br/>
   mov   sp, r7
<br/>
   @ sp needed for prologue
<br/>
   pop   {r7}
<br/>
   pop   {r0}
<br/>
   bx   r0
<br/>
.L6:
<br/>
   .align   2
<br/>
.L5:
<br/>
   .word   p_func_ptr
<br/>
</td> </tr></table><span class="postbody">
<br/>
Both seem to be using _call_via_r3 to call the function pointer, but for some odd reason, the linker does not like that when the function is in iwram.  Is there anyway to fix this?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#21687 - dagamer34 - Thu Jun 03, 2004 12:40 am</h4>
    <div class="postbody"><span class="postbody">The solution is on the <a href="http://www.devrs.com/gba" target="_blank">www.devrs.com/gba</a> webpage. I think you can't have your IWRAM function in the same file as your main function (only a guess). Try moving it to its own file and see what happens.<br/>_________________<br/>Little kids and Playstation 2's don't mix. :(</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#21712 - mclysenk - Thu Jun 03, 2004 1:24 pm</h4>
    <div class="postbody"><span class="postbody">I finally fixed it.  As it turns out, devrs' solution doesn't work either; the real problem was a bug in the linkscript for DevkitARM.  I fixed the problem by switching my project over to HAM and now everything compiles and links just fine.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#21718 - tepples - Thu Jun 03, 2004 6:44 pm</h4>
    <div class="postbody"><span class="postbody">Could you reduce the bug to a minimal test case and then PM wintermute about it?<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#21755 - mclysenk - Fri Jun 04, 2004 3:20 pm</h4>
    <div class="postbody"><span class="postbody">Actually, I determined the error occurs whenever you have two different functions, each with their own section,  in the same file.  For some odd reason, the linker gets messed up and only the ROM functions can be called.  I wish I there were some tutorials or documents about putting things in IWRAM, EWRAM or ROM.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#21766 - wintermute - Fri Jun 04, 2004 5:31 pm</h4>
    <div class="postbody"><span class="postbody">the link error occurs because the distance between iwram and rom is greater than the maximum branch offset allowed by the ARM chip. You don't get a compile error because the addresses are unknown until link time. 
<br/>
<br/>
the issue is related to interworking code which uses call_via_rx stubs in libgcc. Unfortunately the stubs are in rom so neither iwram nor ewram code can reach them.
<br/>
<br/>
I'm currently looking at a workaround for this for the next release.</span><span class="gensmall"><br/><br/>Last edited by wintermute on Fri Jun 04, 2004 5:59 pm; edited 1 time in total</span></div>    
</div>
<div class="post">
    <h4>#21769 - tepples - Fri Jun 04, 2004 5:42 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>wintermute wrote:</b></span></td> </tr> <tr> <td class="quote">You call call iwram functions from rom but not the other way round.</td> </tr></table><span class="postbody">
<br/>
Is there a specific reason that a function in IWRAM can't long_call a function in ROM?<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#21772 - wintermute - Fri Jun 04, 2004 6:01 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tepples wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>wintermute wrote:</b></span></td> </tr> <tr> <td class="quote">You call call iwram functions from rom but not the other way round.</td> </tr></table><span class="postbody">
<br/>
Is there a specific reason that a function in IWRAM can't long_call a function in ROM?</span></td> </tr></table><span class="postbody">
<br/>
<br/>
heh, got me mid edit :)
<br/>
<br/>
the functions gcc uses to perform this are in libgcc. Those functions go in the normal text segment</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#21774 - tepples - Fri Jun 04, 2004 6:25 pm</h4>
    <div class="postbody"><span class="postbody">I wonder why it even needs a stub and can't just inline the call_via_rx.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#21788 - wintermute - Sat Jun 05, 2004 12:10 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>mclysenk wrote:</b></span></td> </tr> <tr> <td class="quote">I finally fixed it.  As it turns out, devrs' solution doesn't work either; the real problem was a bug in the linkscript for DevkitARM.  I fixed the problem by switching my project over to HAM and now everything compiles and links just fine.</td> </tr></table><span class="postbody">
<br/>
<br/>
It's not a linkscript bug</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#21970 - pentagram - Thu Jun 10, 2004 12:06 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tepples wrote:</b></span></td> </tr> <tr> <td class="quote">Is there a specific reason that a function in IWRAM can't long_call a function in ROM?
<br/>
</td> </tr></table><span class="postbody">
<br/>
No there isn't, provided you declare the ROM function as long_call, in same manner as you declare long_call an IWRAM function being called from ROM.
<br/>
In fact, the long_call label is only needed when the caller and callee are placed in different sections, that is, an IWRAM function that is only called by another IWRAM function does not need to be declared as long_call.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#21971 - wintermute - Thu Jun 10, 2004 2:01 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>pentagram wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>tepples wrote:</b></span></td> </tr> <tr> <td class="quote">Is there a specific reason that a function in IWRAM can't long_call a function in ROM?
<br/>
</td> </tr></table><span class="postbody">
<br/>
No there isn't, provided you declare the ROM function as long_call, in same manner as you declare long_call an IWRAM function being called from ROM.
<br/>
In fact, the long_call label is only needed when the caller and callee are placed in different sections, that is, an IWRAM function that is only called by another IWRAM function does not need to be declared as long_call.</span></td> </tr></table><span class="postbody">
<br/>
<br/>
Yes there is.  long_call uses the _call_via_rx stubs in libgcc, those stubs are placed in ROM so IRWAM and EWRAM code can't use them.
<br/>
<br/>
As I said earlier I'm testing a patch to get around this problem.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#21992 - mclysenk - Thu Jun 10, 2004 10:09 pm</h4>
    <div class="postbody"><span class="postbody">Ok, thanks for clearing that up.  I was completely confused by the bug the first time I smacked into it.  
<br/>
<br/>
I really do like DevKitARM and it's minimal interface, and I can't wait until the patch is ready to use.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#22019 - pentagram - Fri Jun 11, 2004 9:40 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>wintermute wrote:</b></span></td> </tr> <tr> <td class="quote">Yes there is. long_call uses the _call_via_rx stubs in libgcc, those stubs are placed in ROM so IRWAM and EWRAM code can't use them. 
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Ok, I see. I'm not an expert in the gcc internals, and made my post based on my tests. All I can say is that I have code that makes calls from IWRAM to ROM and it works. I have checked the .map and assembler files to make sure that nothing gets inlined.
<br/>
I also have tested a forced long_call from IWRAM to IWRAM and it works too.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#22023 - wintermute - Fri Jun 11, 2004 2:29 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>pentagram wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>wintermute wrote:</b></span></td> </tr> <tr> <td class="quote">Yes there is. long_call uses the _call_via_rx stubs in libgcc, those stubs are placed in ROM so IRWAM and EWRAM code can't use them. 
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Ok, I see. I'm not an expert in the gcc internals, and made my post based on my tests. All I can say is that I have code that makes calls from IWRAM to ROM and it works. I have checked the .map and assembler files to make sure that nothing gets inlined.
<br/>
I also have tested a forced long_call from IWRAM to IWRAM and it works too.</span></td> </tr></table><span class="postbody">
<br/>
<br/>
you didn't make your tests with unadulterated FSF sources or with the toolchain the question was about therefore they are irrelevant.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#22035 - pentagram - Fri Jun 11, 2004 6:25 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>wintermute wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
you didn't make your tests with unadulterated FSF sources or with the toolchain the question was about therefore they are irrelevant.</td> </tr></table><span class="postbody">
<br/>
<br/>
Irrelevant? I'm not sure....
<br/>
Yes, my toolchain is different, it is DKA R5b3, based on gcc v3.2.2, and looking closer at the assembly output and comparing it with the code from mclysenk it turns that DKA's calling protocol is absolutely different and does not use the stubs. Are those stubs really necessary? Aren't they adding overhead to the call?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#22045 - wintermute - Sat Jun 12, 2004 3:24 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>pentagram wrote:</b></span></td> </tr> <tr> <td class="quote"><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>wintermute wrote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
you didn't make your tests with unadulterated FSF sources or with the toolchain the question was about therefore they are irrelevant.</td> </tr></table><span class="postbody">
<br/>
<br/>
Irrelevant? I'm not sure....
<br/>
Yes, my toolchain is different, it is DKA R5b3, based on gcc v3.2.2, and looking closer at the assembly output and comparing it with the code from mclysenk it turns that DKA's calling protocol is absolutely different and does not use the stubs. Are those stubs really necessary? Aren't they adding overhead to the call?</span></td> </tr></table><span class="postbody">
<br/>
<br/>
There's something missing in your 'tests' then - dka r5b3 has the same 'relocation truncated to fit' error - I've just tested it here. DKA's calling protocol is no different - there's actually an option which effectively inlines the call_via_rx stubs - you're using that option to get the code to work.
<br/>
<br/>
devkitARM_r6a now emits similar code.
<br/>
<br/>
The stubs actually *remove* overhead, requiring 2 extra instructions per function call without the stubs.
<br/>
<br/>
No they're not necessary but will reduce the size of the binary if they're within range.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
