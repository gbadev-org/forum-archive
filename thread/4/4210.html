<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>crt0.c - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>Coding > crt0.c</h2>
<div id="posts">
<div class="post">
    <h4>#27444 - sgeos - Wed Oct 13, 2004 2:43 am</h4>
    <div class="postbody"><span class="postbody">I noticed that my version of MSVC uses a crt0.c.  GBA apps typically use crt0.s.  I was wondering if it would be possible to write a crt0.c for the gba.  I know this is goofy.  It would need to call asm() to set up the stack and all, but I still think it would be kind of fun. =P
<br/>
<br/>
-Brendan</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#27445 - DekuTree64 - Wed Oct 13, 2004 3:17 am</h4>
    <div class="postbody"><span class="postbody">Sure it can be done, but you'll mostly be doing asm blocks anyway, for like the initial branch instruction (might be possible with a goto), and the header info, which you can't really tell it to stick specific bytes of data right there in the function. Certainly you could do the clearing of memory, loading of IWRAM functions, and an interrupt handler in C though (although I personally prefer to keep interrupts and Crt0 seperate anyway)<br/>_________________<br/>___________
<br/>
The best optimization is to do nothing at all.
<br/>
Therefore a fully optimized program doesn't exist.
<br/>
-Deku</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#27462 - poslundc - Wed Oct 13, 2004 2:00 pm</h4>
    <div class="postbody"><span class="postbody">Why would you rather have a C version if it's explicitly for the GBA anyway?
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#27464 - Abscissa - Wed Oct 13, 2004 2:53 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>poslundc wrote:</b></span></td> </tr> <tr> <td class="quote">Why would you rather have a C version if it's explicitly for the GBA anyway?</td> </tr></table><span class="postbody">
<br/>
<br/>
Novelty, perhaps?  The ability to say, "Holy shit, my crt0 is written in C, ha ha ha!"</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#27479 - sgeos - Wed Oct 13, 2004 9:29 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>poslundc wrote:</b></span></td> </tr> <tr> <td class="quote">Why would you rather have a C version if it's explicitly for the GBA anyway?</td> </tr></table><span class="postbody">
<br/>
For the experience of creating it.  The GBA really wants a crt0.s, but it would be interesting to try to at least structure the startup code in C and get it to run.
<br/>
<br/>
-Brendan</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#27480 - poslundc - Wed Oct 13, 2004 9:35 pm</h4>
    <div class="postbody"><span class="postbody">Well, the crt0.S I have at home (from DKA v3 or something) is very well-documented and the code isn't even that long, so I don't see any particular reason you couldn't port it to C, minus a few things that would have to be explicitly ASM.
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#27493 - sgeos - Thu Oct 14, 2004 2:07 am</h4>
    <div class="postbody"><span class="postbody">How would I get the compiler to use my crt0.c instead of the supplied crt0.s?  Replacing one with the other seems too easy.  Would gcc have to be recompiled?
<br/>
<br/>
-Brendan</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#27494 - sajiimori - Thu Oct 14, 2004 2:09 am</h4>
    <div class="postbody"><span class="postbody">GCC doesn't normally reassemble crt0.s on each build, so you can just overwrite your crt0.o if you want.  Usually if you're using your own crt0, you'll be using ld directly instead of the frontend anyway, and ld won't link in anything behind the scenes.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#27507 - MumblyJoe - Thu Oct 14, 2004 11:38 am</h4>
    <div class="postbody"><span class="postbody">Yeah, I figure it only wants crt0.o anyway, so .S/.s/.c/.c++ or whatever should be fine, just a matter of functionality and so forth, I doubt speed even matter seeing as its not exactly doing and time-consuming things. Actually I quite like the idea of having a crt0.c just because it could really help to show beginers how it all goes together.<br/>_________________<br/><a class="postlink" href="http://www.hungrydeveloper.com" target="_blank">www.hungrydeveloper.com</a>
<br/>
Version 2.0 now up - guaranteed at least 100% more pleasing!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#27523 - sgeos - Thu Oct 14, 2004 6:50 pm</h4>
    <div class="postbody"><span class="postbody"><a class="postlink" href="http://velvetfr.ath.cx/gba/tutorial/gba-tutorial1.html" target="_blank">This page</a> has a simple crt0.s.
<br/>
<br/>
The first line says:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">.section .text,"ax"</td> </tr></table><span class="postbody">
<br/>
Is this anything that crt0.c needs to worry about?
<br/>
<br/>
Next is:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">.arm</td> </tr></table><span class="postbody">
<br/>
Arm instruction set.  I noticed that there are four copies of crt0.o on my computer:
<br/>
(devkit)/<span style="font-weight: bold">arm-agb-elf/lib/</span>crt0.c
<br/>
(devkit)/<span style="font-weight: bold">arm-agb-elf/lib/interwork/</span>crt0.c
<br/>
(devkit)/<span style="font-weight: bold">arm-agb-elf/lib/thumb/</span>crt0.c
<br/>
(devkit)/<span style="font-weight: bold">arm-agb-elf/lib/thumb/interwork/</span>crt0.c
<br/>
<br/>
I know that the bios passes control to the user program in arm mode.  I know that the above directories have to do with compiling a user program in arm or thumb (with and with switching instruction sets).
<br/>
<br/>
I'm assuming that I have to compile crt0 using arm interworking and then place it all four locations?
<br/>
<br/>
Next:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">.align 4</td> </tr></table><span class="postbody">
<br/>
Do I need to worry about this?  I could put it at the top of my header ASM block.  gcc also has an __attribute__ ((aligned (X)));
<br/>
<br/>
Next:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">.extern main</td> </tr></table><span class="postbody">
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">extern int main(int argc, char **argv);</td> </tr></table><span class="postbody">
<br/>
OR
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">extern int main(void);</td> </tr></table><span class="postbody">
<br/>
<br/>
Next:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">    .global _start
<br/>
_start:
<br/>
</td> </tr></table><span class="postbody">
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void _start(void)
<br/>
{</td> </tr></table><span class="postbody">
<br/>
<br/>
Next:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">b    rom_start</td> </tr></table><span class="postbody">
<br/>
Maybe this could be done with a goto.  Otherwise it could be put at the top of the header block.
<br/>
<br/>
Next, the header block.  I think this wants to be an asm block.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">asm
<br/>
(
<br/>
   /* Nintendo Logo (156 bytes) */
<br/>
      ".byte 0,0,0,0,0,0,0,0,0,0\n"
<br/>
   /* ... */
<br/>
<br/>
   /* Game Title (12 bytes) */
<br/>
      ".ascii \"ABCDEFGHIJKL\"\n"
<br/>
<br/>
   /* Game Code (4 bytes) */
<br/>
      ".ascii \"1234\"\n"
<br/>
   /* ... */ :
<br/>
   /* No output */ :
<br/>
   /* No input */ :
<br/>
   /* No clobber */
<br/>
);</td> </tr></table><span class="postbody">
<br/>
Does this want to be volatile ASM block?  It doesn't want any input, output or clobber, does it?
<br/>
<br/>
Next, the user stack.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">mov r0, #0x1f
<br/>
msr cpsr, r0
<br/>
ldr sp, =0x3007ff0</td> </tr></table><span class="postbody">
<br/>
It's after the header, so we don't care if the compiler inserts anything.  I think this wants to be in some sort of _init_stack() setup subroutine.  The body of the routine needs to be in ASM.  Why is 0x1f being moved onto CPSR?  0x3007FF0 looks like the memory address where the stack starts.
<br/>
<br/>
Next it calls main.  The code from the above page is structured like this:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">main(0, NULL);
<br/>
while (1) {}</td> </tr></table><span class="postbody">
<br/>
<br/>
I'll actually onject to that structure.  I really think it should look something like this:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">while (1) {
<br/>
   _init_stack(/* ... */);
<br/>
   main(0, NULL);
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
The simple crt0 does not zero memory or any of that.  I suspect all of that wants to happen before main() is called and it wants to be in the above loop.
<br/>
<br/>
I think that the location of the header will be the hardest thing to ensure, followed by perhaps alignment and the instruction set stuff.  I don't see how anything that can easily be written in C would pose any sort of a problem at all.
<br/>
<br/>
-Brendan</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#27589 - MumblyJoe - Sat Oct 16, 2004 3:54 am</h4>
    <div class="postbody"><span class="postbody">I was playing with this general idea earlier today at home, I don't have my files with me but I got close I think. For the header data I just used inline asm outside of any functions and the asm it produced seemed to look good.<br/>_________________<br/><a class="postlink" href="http://www.hungrydeveloper.com" target="_blank">www.hungrydeveloper.com</a>
<br/>
Version 2.0 now up - guaranteed at least 100% more pleasing!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#27591 - sgeos - Sat Oct 16, 2004 5:22 am</h4>
    <div class="postbody"><span class="postbody">Free floating inline ASM compiles?  I never would have thought to try that.  If you get it to work, would it be too much for me to ask to see your code?
<br/>
<br/>
-Brendan</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#27596 - MumblyJoe - Sat Oct 16, 2004 9:58 am</h4>
    <div class="postbody"><span class="postbody">I can't remember exactly what it was but something like this:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
<br/>
extern void main(int argc, char* argv[]);
<br/>
<br/>
asm volatile(".byte 0");
<br/>
<br/>
....
<br/>
<br/>
void someshit()
<br/>
{
<br/>
    //llalalalala.
<br/>
}
<br/>
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
and so forth, it was just a rewrite of the DevKitArm gba_crt0.s, and I think it would be close to working, I will post it tomorow. I made it output asm (-S option) and the resulting .s file was close to what I was aiming for. Give it a shot, I will show you mine tomorow.<br/>_________________<br/><a class="postlink" href="http://www.hungrydeveloper.com" target="_blank">www.hungrydeveloper.com</a>
<br/>
Version 2.0 now up - guaranteed at least 100% more pleasing!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#27607 - sgeos - Sat Oct 16, 2004 10:26 pm</h4>
    <div class="postbody"><span class="postbody">I basically managed to convert the 'simple' crt0.s to c.  Two things are bothering me.
<br/>
<br/>
First, this function:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void _set_user_stack
<br/>
(
<br/>
   unsigned short   p_cpsr,
<br/>
   unsigned long   p_sp
<br/>
)
<br/>
{
<br/>
   asm volatile
<br/>
   (
<br/>
      "mov r0, %0\n"
<br/>
      "msr cpsr, r0\n"
<br/>
      "mov sp, %1\n"
<br/>
<br/>
      :  /* No output */
<br/>
      :  "r" (p_cpsr), "r" (p_sp)
<br/>
      :  "r0"
<br/>
   );
<br/>
}</td> </tr></table><span class="postbody">
<br/>
GCC insterts function call stuff before and after the asm block.  After the function returns it has had no effect.  Is there pseudo clean way to get this subrouting to work, or am I going to have inline it?  My goal is to be able to set the stack with macros:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#define _CPSR   0x1F
<br/>
#define _SP   0x03007FF0
<br/>
<br/>
_set_user_stack(_CPSR, _SP);</td> </tr></table><span class="postbody">
<br/>
<br/>
Second, the linker complained about __gccmain.  I had main() call a __gccmain(), but that seems like a real hack.  This is the first I've heard of __gccmain.  How is it supposed to fit in?
<br/>
<br/>
Using ld I did manage to compile a test program.  (The test program does not actually do anything.)
<br/>
<br/>
-Brendan</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
