<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Strange problem, game locks up. - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/static/pure-min.css" />
        <link rel="stylesheet" href="/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>Coding > Strange problem, game locks up.</h2>
<div id="posts">
<div class="post">
    <h4>#21841 - expos1994 - Mon Jun 07, 2004 3:53 pm</h4>
    <div class="postbody"><span class="postbody">Hello,
<br/>
<br/>
I am having a weird problem with my code.  It has held me up since yesterday afternoon.  What happens is I write some text to background 2 (mode 0).  Then I wait for the A or B button to be pressed.  Then I clear the background and write some more text to the same background.  Then again I wait for A or B.
<br/>
<br/>
After this happens, the code freezes.  If I swap around a few lines here and there I can get it to basically do a restart of main().  I have no idea why this is happening.  Logically it seems fine.  I have tried so many different things and have gotten some interesting results.  None are the ones I want however.  
<br/>
<br/>
If I take out the code that waits for button presses and the code that writes the background text, and just put some simple assignments in the procedure, it will run through it without problems.  So I'm guessing it is one of those things that is breaking my code.
<br/>
<br/>
Here's basically what I'm doing (I don't have the exact code since I'm at work.  But maybe you guys won't need it.  I can post it at another time.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
<br/>
void dolandmark()
<br/>
{
<br/>
            strcpy(message, "This is my message ... blah blah");
<br/>
            DrawWindow(message, 0,5,20);
<br/>
            waitforAB();
<br/>
            while(!(KEYS &amp; KEY_A); //I put this in to try and solve my problem.  It seems to help but it still freezes right below this.
<br/>
<br/>
            //I do a little bit here.  Some assignments
<br/>
<br/>
           strcpy(message, "The second message");
<br/>
           DrawWindow(message, 0,5,20);
<br/>
           waitforAB();
<br/>
           while(!(KEYS &amp; KEY_A);
<br/>
<br/>
}
<br/>
<br/>
//What I'm expecting now is that it would return to the calling function ... main(), but it freezes or in some cases restarts at the beginning of main.  In this state, it freezes.  This is very frustrating.  It is acting the same way on the hardware and VBA.
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
My waitforAB() basically is a loop that won't break; until A or B is pressed. And the while() I added under that is to wait until A (I'll add B later), is unpressed. 
<br/>
<br/>
I use this combination in other spots in my code... DrawWindow()/waitforAB(), and it has no problem.  It works fine.  But in this particular function, called from main.  It just won't allow it.  
<br/>
<br/>
Can anyone provide insight into this?  It's frustrating because it seems to have a mind of it's own, but I think I'm just not quite understanding something.  
<br/>
<br/>
Thanks for any help.  If you need more code, I'll post it.
<br/>
<br/>
--Chris</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#21842 - tepples - Mon Jun 07, 2004 4:11 pm</h4>
    <div class="postbody"><span class="postbody">You expect it to go back to main(). What are you doing in main() after that point? Remember that if main() returns, the init code will (not exactly predictably) freeze or reset the GBA.<br/>_________________<br/>-- Where is he?
<br/>
-- Who?
<br/>
-- You know, the human.
<br/>
-- I think he moved to Tilwick.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#21843 - poslundc - Mon Jun 07, 2004 4:12 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>expos1994 wrote:</b></span></td> </tr> <tr> <td class="quote">If I take out the code that waits for button presses and the code that writes the background text, and just put some simple assignments in the procedure, it will run through it without problems.  So I'm guessing it is one of those things that is breaking my code.</td> </tr></table><span class="postbody">
<br/>
<br/>
Well, then, post the code for those routines... :P
<br/>
<br/>
Also, post the main loop that calls dolandmark().
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#21844 - dagamer34 - Mon Jun 07, 2004 4:26 pm</h4>
    <div class="postbody"><span class="postbody">Yeah, I can see a couple of potential problems with your code.
<br/>
<br/>
Is KEYS defined as a volatile u16? If not, then the code will definitely hang when you check for a key press.
<br/>
<br/>
I don't think we can really help you until we see more code.<br/>_________________<br/>Little kids and Playstation 2's don't mix. :(</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#21846 - expos1994 - Mon Jun 07, 2004 4:49 pm</h4>
    <div class="postbody"><span class="postbody">Hey thanks for the replies so far.
<br/>
<br/>
Here's how KEYS is defined.  I think I got this from ThePernProject. Not sure it would have been awhile ago.  I don't see an volatile keyword:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
int* KEYS = (int*)0x04000130;
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Waiting for the keypress does 'appear' to work in other areas of my code.
<br/>
<br/>
I will definitly post more code when I get home.  The routine for DrawWindow() is a little lengthy and basically involves changing background tiles.  It always worked for me before, and it still does.  It displays the window, but it just crashes afterwards.
<br/>
<br/>
Sorry about not having the code.  I was hoping that you guys would take a look at what I was doing and say "Yeah dumba**, here's your problem, you can't do this..."  I've looked at it over and over, and can't figure out why it would go back to the top of main().  The call to the dolandmark() procedure is in a while(1) loop in main.  Any ideas on what I could do to cause my code to break out of that loop.
<br/>
<br/>
I'll post the code later... thanks for the replies so far.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#21847 - niltsair - Mon Jun 07, 2004 4:57 pm</h4>
    <div class="postbody"><span class="postbody">Declare keys as : <span style="font-weight: bold">volatile int* KEYS = (int*)0x04000130;</span> instead. 
<br/>
Do the same for all variables that are pointing to registers. It prevent the compiler from doing some 'optimisation' that don't consider that thoses values can changes outside of your code (interupts, hardware).
<br/>
<br/>
Also make sure your main() is included in a loop from which you can never exit.<br/>_________________<br/>-Inside every large program is a small program struggling to get out. (Hoare's Law of Large Programs)
<br/>
-The man who can smile when things go wrong has thought of someone he can blame it on. (Nixon's Theorem)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#21853 - expos1994 - Mon Jun 07, 2004 11:48 pm</h4>
    <div class="postbody"><span class="postbody">Hi, first of all thanks for all the help. 
<br/>
To my surprise, my code executes the same with volatile or not on the KEYS definition.  I changed it to volatile, because you make a good point.  And I will remember that with future problems.
<br/>
<br/>
An update on my problem:
<br/>
<br/>
Well I struggled for a looooong time on this.  Since yesterday afternoon.  I have finally discovered the cause.  The message I was passing in my sample code I posted was actually much larger.  I guessed on the size when I defined it.  As it turned out, my guess was a little short.  
<br/>
<br/>
I have no idea why (I'd like to know, but I don't want to spend the time trying to figure it out.), but when I changed the char message[60]; to char message[65], the code executed as expected.  And I'm very relieved.
<br/>
<br/>
Wow, what a mystery that was.  I figured it out by passing little strings.  They worked, so I knew it was a problem with the string I was passing.
<br/>
<br/>
Well anyways, thanks for the help.  If you know why that happened, let me know.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#21856 - Foxy - Tue Jun 08, 2004 1:19 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>niltsair wrote:</b></span></td> </tr> <tr> <td class="quote">Declare keys as : <span style="font-weight: bold">volatile int* KEYS = (int*)0x04000130;</span> instead.</td> </tr></table><span class="postbody">
<br/>
<br/>
Keys should be declared as volatile unsigned short *</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#21870 - johnny_north - Tue Jun 08, 2004 4:15 pm</h4>
    <div class="postbody"><span class="postbody">expos1994-
<br/>
<br/>
One answer to your question is to examine the largest string you're trying to copy into 
<br/>
<br/>
char message[60];
<br/>
<br/>
Obviously, if you write to memory off the end of this array you can expect undefined behavior. (If you're working with c style arrays don't forget to include the null character in your count of characters).
<br/>
<br/>
Less obvious is if your misusing memory somewhere else, expanding this array (even though you may or may not be using the extra 5 characters) may seem to correct the problem. 
<br/>
<br/>
Take my advice - even though you may not want to spend the time pin pointing the problem - as your code base grows, finding the bug will become harder. Best to figure it out now.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
