<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Understanding DMA Registers - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>Coding > Understanding DMA Registers</h2>
<div id="posts">
<div class="post">
    <h4>#34834 - kareemjg - Wed Jan 26, 2005 11:23 pm</h4>
    <div class="postbody"><span class="postbody">Okay.. I'm a little new to GBADEV so bare with me.  Basiclly what I am doing is buidling my own engine for learning puroses by studying the sources and incorprating what I learn into the code.  
<br/>
<br/>
My question is pertaining to putting text to the screen.  I can do it but I'm trying to get a better understand what I am emulating.  Studying one of the source programs  I see the following functions:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
void DMACopyCH0(void* source, void* dest, u32 WordCount, u32 mode) {
<br/>
    REG_DM0SAD = (u32)source;      //Tell the gba our source address
<br/>
    REG_DM0DAD = (u32)dest;        //Tell the gba where the data should get copied to
<br/>
    REG_DM0CNT = WordCount | mode; //Set the mode
<br/>
}
<br/>
<br/>
void DMACopyCH1(void* source, void* dest, u32 WordCount, u32 mode) {
<br/>
    REG_DM1SAD = (u32)source;
<br/>
    REG_DM1DAD = (u32)dest;
<br/>
    REG_DM1CNT = WordCount | mode;
<br/>
}
<br/>
<br/>
void DMACopyCH2(void* source, void* dest, u32 WordCount, u32 mode) {
<br/>
    REG_DM2SAD = (u32)source;
<br/>
    REG_DM2DAD = (u32)dest;
<br/>
    REG_DM2CNT = WordCount | mode;
<br/>
}
<br/>
<br/>
void DMACopyCH3(void* source, void* dest, u32 WordCount, u32 mode) 
<br/>
{
<br/>
    REG_DM3SAD = (u32)source;
<br/>
    REG_DM3DAD = (u32)dest;
<br/>
    REG_DM3CNT = WordCount | mode;
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Is this stating that the device has allocated four differnt  memory slots to hold indivdual font types? Or is my line of reasoning off.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#34839 - ScottLininger - Thu Jan 27, 2005 1:22 am</h4>
    <div class="postbody"><span class="postbody">DMA stands for Direct Memory Access. It's a method by which the gameboy hardware can shuffle large chunks of memory from one location to another. So if you want to copy a big block of graphics from ROM to the video ram, for example, DMA is a fast way to do it.
<br/>
<br/>
DMA registers control all of this stuff. You poke a few values into the registers, and BAM! The GB starts copying.
<br/>
<br/>
DMA has several "channels" that are numbered in order of priority. A DMA1 will be transferred before a DMA3. All that your posted code does is abstract the register access into some friendly functions. So it doesn't have anything specifically to do with fonts or text. It's just an alternate way to move memory around. We'd need to see the "context" of these function calls to help much with how it's contributing to a font engine.
<br/>
<br/>
By the way, the gameboy doesn't really natively support anything like fonts. Though the tile modes are sometimes referred to as "text modes," that's only really a good term if you take it in terms of the old DOS text video modes. When someone says "fonts" on the gameboy, they generally mean "tile sets." Granted, this is just a matter of semantics, but shifting your perspective to be more about pixels and less about fonts might help to make sense of the code you're looking at.
<br/>
<br/>
My favorite source for "low level" GB info is the <a class="postlink" href="http://www.cs.rit.edu/~tjh8300/CowBite/CowBiteSpec.htm" target="_blank">cowbite spec</a>, which goes over all of the registers in great detail. And if you haven't already, definitely read the FAQ under the beginner's forum.
<br/>
<br/>
Hope that helps! :)
<br/>
<br/>
-Scott</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#34844 - kareemjg - Thu Jan 27, 2005 1:53 am</h4>
    <div class="postbody"><span class="postbody">The source came from the website and can be found here: <a class="postlink" href="http://www.gbadev.org/download.phpsection=demos&amp;filename=textdma.zip" target="_blank">http://www.gbadev.org/download.phpsection=demos&amp;filename=textdma.zip</a>
<br/>
<br/>
DMA is still pretty new to me but I am understanding.  I understand about the fonts being generated from spliced images in much the same way as sprites.  What I was trying to understand is the function behind what the code author was doing when he defined the various DMACopyCH0 - CH3.  I understand the majority of the code but this is stumping me and I just cant seem to leave it until I figure it out.
<br/>
<br/>
On a side note what do the double carrots evaluate as. Example  </span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">REG_DISPCNT = (1&lt;&lt;8);</td> </tr></table><span class="postbody">.  
<br/>
<br/>
At this point I would usally make some snappy remark offering an excuse on my igornace but at this point I guess the only way to learn is by asking. :)
<br/>
<br/>
Thanks for help.
<br/>
<br/>
-kareem</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#34852 - LOst? - Thu Jan 27, 2005 4:35 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>kareemjg wrote:</b></span></td> </tr> <tr> <td class="quote">On a side note what do the double carrots evaluate as. Example  <table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">REG_DISPCNT = (1&lt;&lt;8);</td> </tr></table><span class="postbody">
<br/>
</span></td> </tr></table><span class="postbody">
<br/>
<br/>
&lt;&lt; means bitwise shift left.
<br/>
<br/>
Move bit 1 eight times to the left.
<br/>
This is done in binary.
<br/>
<br/>
I never use the constant (1 &lt;&lt; 8). I do the same as the compiler do writing it in hex:
<br/>
0x100
<br/>
<br/>
<br/>
To be a little bit more informative. If you have the binary value of 1 in a word, it looks like this:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
0000000000000001  binary value
<br/>
fedcba9876543210  bit order
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
And shifting this value by 1 (operator&lt;&lt; 1) will result in this value:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
0000000000000010  binary value
<br/>
fedcba9876543210  bit order
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
And shifting the original value by 8 (operator&lt;&lt; 8) will result in this value:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
0000000100000000  binary value
<br/>
fedcba9876543210  bit order
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Now to help you a little bit more. The operator | is called bitwise OR. It is used in this code:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
REG_DM3CNT = WordCount | mode;
<br/>
</td> </tr></table><span class="postbody">
<br/>
Let's say WordCount is 255 (hex 0xFF) and mode is 256 (hex 0x100), this is the values in binary:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
WordCount's value:
<br/>
0000000111111111  binary value
<br/>
fedcba9876543210  bit order
<br/>
</td> </tr></table><span class="postbody">
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
mode's value:
<br/>
0000001000000000  binary value
<br/>
fedcba9876543210  bit order
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
Now ORing the two values:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
ORing will combine the two values:
<br/>
    0000000111111111
<br/>
 OR 0000001000000000
<br/>
 -------------------
<br/>
    0000001111111111  Result
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#34853 - kareemjg - Thu Jan 27, 2005 5:21 am</h4>
    <div class="postbody"><span class="postbody">Thanks.  The information about the bit shifting was most helpful.  I knew about the hex coding but it was the first time I ran across it notated in that fashion.
<br/>
<br/>
-kareem</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#34872 - kareemjg - Thu Jan 27, 2005 4:52 pm</h4>
    <div class="postbody"><span class="postbody">Okay.. just want to make sure I'm understanding this right.  Here is a bit of code I'm studying.  I'm also refering to Cowbites Virtual Hardware Specs for the matchup.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">   
<br/>
   REG_DISPCNT = (1&lt;&lt;8);
<br/>
   REG_BG0CNT = 0x80 | (21 &lt;&lt; 8) | (0 &lt;&lt; 2);
<br/>
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
As Lost(r) point out I now understand (1&lt;&lt;8).  So when the the value was set in REG_DISPCNT is was setting up Background 0 as I have defined in my gba.h file as #define BG0_ENABLE 0x100 .
<br/>
<br/>
Okay the next step I know it is setting up the control for Backround O. (XREF the Cowbyte sheet now)
<br/>
<br/>
 so if we add up 0x80 | 21 &lt;&lt; 8 | 0 &lt;&lt; 2 it would eval as
<br/>
<br/>
0000 1000 0000
<br/>
0101 0000 0000
<br/>
0000 0000 0000
<br/>
-------------------
<br/>
0101 1000 0000
<br/>
<br/>
which would be 0x580; which would mean per the docs that
<br/>
<br/>
*        Starting address of character tile data
<br/>
          Address = 0x6000000 + S * 0x4000 (with s equaling 5)
<br/>
<br/>
*         also a front background with 3 priority
<br/>
<br/>
Did i read this right?  Here are the docs for ref below.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">
<br/>
Address: 0x4000008 - REG_BG0CNT 
<br/>
Address: 0x400000A - REG_BG1CNT 
<br/>
Address: 0x400000C - REG_BG2CNT 
<br/>
Address: 0x400000E - REG_BG3CNT 
<br/>
<br/>
These addresses set up the four background layers. The format is:
<br/>
<br/>
    ?               
<br/>
F E D C  B A 9 8  7 6 5 4  3 2 1 0 
<br/>
Z Z V M  M M M M  A C X X  S S P P 
<br/>
<br/>
0-1 (P) = Priority - 00 highest, 11 lowest
<br/>
          Priorities are ordered as follows:
<br/>
<br/>
          "Front"
<br/>
          1. Sprite with priority 0
<br/>
          2. BG with     priority 0
<br/>
<br/>
          3. Sprite with priority 1
<br/>
          4. BG with     priority 1
<br/>
<br/>
          5. Sprite with priority 2
<br/>
          6. BG with     priority 2
<br/>
<br/>
          7. Sprite with priority 3
<br/>
          8. BG with     priority 3
<br/>
<br/>
          9. Backdrop
<br/>
          "Back"
<br/>
<br/>
          When multiple backgrounds have the same priority, the order
<br/>
          from front to back is:  BG0, BG1, BG2, BG3.  Sprites of the same
<br/>
          priority are ordered similarly, with the first sprite in OAM
<br/>
          appearing in front.          
<br/>
<br/>
2-3 (S) = Starting address of character tile data
<br/>
          Address = 0x6000000 + S * 0x4000
<br/>
6   (C) = Mosiac effect - 1 on, 0 off
<br/>
<br/>
7   (A) = Color palette type -
<br/>
          1 - standard 256 color pallete
<br/>
          0 - each tile uses one of 16 different 16 color palettes (no effect on
<br/>
              rotates/scale backgrounds, which are always 256 color)
<br/>
<br/>
8-C (M) = Starting address of character tile map
<br/>
          Address = 0x6000000 + M * 0x800
<br/>
D   (V) = Screen Over. Used to determine whether rotational backgrounds get tiled
<br/>
          repeatedly at the edges or are displayed as a single "tile" with the area
<br/>
          outside transparent. This is forced to 0 (read only) for backgrounds 
<br/>
          0 and 1 (only).
<br/>
<br/>
E-F (Z) = Size of tile map
<br/>
          For "text" backgrounds: 
<br/>
          00 : 256x256 (32x32 tiles) 
<br/>
          01 : 512x256 (64x32 tiles) 
<br/>
          10 : 256x512 (32x64 tiles) 
<br/>
          11 : 512x512 (64x64 tiles) 
<br/>
<br/>
          For rotational backgrounds: 
<br/>
          00 : 128x128 (16x16 tiles) 
<br/>
          01 : 256x256 (32x32 tiles) 
<br/>
          10 : 512x512 (64x64 tiles)
<br/>
          11 : 1024x1024 (128x128 tiles
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
-kareem</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
