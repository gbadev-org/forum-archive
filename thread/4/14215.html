<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>WEIRD problems with big maps! - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>Coding > WEIRD problems with big maps!</h2>
<div id="posts">
<div class="post">
    <h4>#141424 - Ruben - Tue Sep 25, 2007 9:13 am</h4>
    <div class="postbody"><span class="postbody">OK. This is just freaky! When I started doing my 'big map' scrolling system, my logic's run out!!
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
void Draw2NewRows() {
<br/>
 int iX;
<br/>
 int SXO = (CameraX/8);
<br/>
 int SYO = ((CameraY/8)+30)*32;
<br/>
 int MXO = (CameraX/8);
<br/>
 int MYO = ((CameraY/8)+30)*MapSize;
<br/>
 for(iX=0;iX&lt;32;iX++) {
<br/>
  ScreenBaseBlock[SYO+SXO+iX] = baronMap[MYO+MXO+iX];
<br/>
  ScreenBaseBlock[SYO+SXO+iX+1] = baronMap[MYO+MXO+iX+1];
<br/>
  ScreenBaseBlock[SYO+SXO+iX+32] = baronMap[MYO+MXO+iX+MapSize];
<br/>
  ScreenBaseBlock[SYO+SXO+iX+32+1] = baronMap[MYO+MXO+iX+MapSize+1];
<br/>
 }
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
I'm pretty sure the logic behind that is fine but I can't figure out the rest! ARGH!! ...ahem... umm... CameraX and Y are 'int's that hold the scrolling information.. umm...'ScreenBaseBlock' is a pointer to the screen base block.. umm.... and 'baronMap' is a 'const u16' array of data. I'm REALLY stuck now!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#141427 - f33ldead - Tue Sep 25, 2007 10:20 am</h4>
    <div class="postbody"><span class="postbody">Have you seen <a class="postlink" href="http://forum.gbadev.org/viewtopic.php?t=14070" target="_blank">this thread</a>?<br/>_________________<br/>It's real, spooky action at distance!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#141432 - Ruben - Tue Sep 25, 2007 12:13 pm</h4>
    <div class="postbody"><span class="postbody">Yeah, I've read that topic from top to bottom but still... I don't really get what's wrong with my program... hmm...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#141434 - f33ldead - Tue Sep 25, 2007 12:59 pm</h4>
    <div class="postbody"><span class="postbody">Note the +30 you gave to SY0. It's probably not what you want.<br/>_________________<br/>It's real, spooky action at distance!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#141484 - Ruben - Wed Sep 26, 2007 4:11 am</h4>
    <div class="postbody"><span class="postbody">Hmm... probably... but even if I try +20 it still doesn't work on the Map Y Offset... hmm...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#141500 - f33ldead - Wed Sep 26, 2007 9:44 am</h4>
    <div class="postbody"><span class="postbody">I'm not sure what you intend to do, but if you add camera coordinates to the SBB index, you'll eventually go off bg.
<br/>
<br/>
If you just want to load two bottom strips for the map, this should do it:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#define SCREEN_HEIGHT 20
<br/>
#define BG_WIDTH      32
<br/>
#define MAP_WIDTH     whatever
<br/>
<br/>
for(iy=SCREEN_HEIGHT; iy&lt;SCREEN_HEIGHT+2; iy++) {
<br/>
        for(ix=0; ix&lt;BG_WIDTH; ix++) {
<br/>
                sbb[iy*BG_WIDTH + ix] = map[(iy+camy)*MAP_WIDTH + (ix+camx)];
<br/>
        }
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
where camy, camx, iy, ix are tile coordinates.
<br/>
However, when you scroll the map down, say using BGxVOFF, you'll eventually reach the bottom strip, i.e. then end of map. A way around this suggested to me way to load the relevant 32x20 portion of the map every time you scroll the map. To avoid some "missing tile effects" you'll need to load somewhat larger than 32x20, you have to load one extra strip from the direction you're scrolling -if that strip is available of course, ie you haven't reached the edge of the map.
<br/>
<br/>
It doesn't look like much of a burden to me. For now.<br/>_________________<br/>It's real, spooky action at distance!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#141502 - Ruben - Wed Sep 26, 2007 10:23 am</h4>
    <div class="postbody"><span class="postbody">OK. I'll try that.
<br/>
BTW: I am actually using mode 0 for this which is why I went with the 'greater than allowed' scrolling offsets which pretty much work well when scrolling horizontally.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#141503 - Ruben - Wed Sep 26, 2007 10:51 am</h4>
    <div class="postbody"><span class="postbody">OK. I ended up with this code:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code"> int iX, iY;
<br/>
 int MXO = (CameraX/8);
<br/>
 int MYO = (CameraY/8)+20;
<br/>
 int SXO = (CameraX/8);
<br/>
 int SYO = (CameraY/8)+20;
<br/>
 MXO %= MapSize;
<br/>
 MYO %= MapSize;
<br/>
 SXO %= 32;
<br/>
 SYO %= 32;
<br/>
 for(iX=0;iX&lt;32;iX++) {
<br/>
  for(iY=0;iY&lt;2;iY++) {
<br/>
   ScreenBaseBlock[(iY+SYO)*32+SXO+iX] = baronMap[(iY+MYO)*MapSize+MXO+iX];
<br/>
  }
<br/>
 }</td> </tr></table><span class="postbody">
<br/>
But that is STILL incorrect! It tends to mess up every now and then and usually data is a bit off by 32 tiles... I don't know what that could be... hmm...</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#141509 - Cearn - Wed Sep 26, 2007 2:37 pm</h4>
    <div class="postbody"><span class="postbody">it's the screenblock coordinates that need to stay within the [0,31] range, not the screenblock origins. The modulo goes inside the loop:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">u32 ix, iy;
<br/>
u32 sx0, sy0, mx0, my0;      // Camera positions in tile units
<br/>
u32 srcPitch;
<br/>
u16 *src= MapData, u16 *dst= Screenblock;
<br/>
<br/>
for(iy=0; iy&lt;2; iy++)
<br/>
   for(ix=0; ix&lt;32; ix++)
<br/>
      dst[(sy0+iy)%32*32 + (sx0+ix)%32] = src[(my0+iy)*srcPitch + mx0+ix];
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
In testing, it also helps to use data with which you can actually see what happens. For example, with a fairly open map, you wouldn't be able to see what parts would actually be updated by the routine. Tiles with different numbers would work well with that. Also fun: instead of copying from a map, just start with all 1's or something end then increment when the boundaries are refreshed. It'll look awful, but you can tell exactly what screen entries the routine is working on.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#141574 - Ruben - Thu Sep 27, 2007 4:24 am</h4>
    <div class="postbody"><span class="postbody">YAY!!!!!!!!!!! Thanks man!! I FINALLY got my test project running so now I can actually implement it in my 'real' game!! YAY!!!!!!!!!!!!!! ...ahem.... err.... thanks Cearn..... lol........</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#141578 - Ruben - Thu Sep 27, 2007 4:52 am</h4>
    <div class="postbody"><span class="postbody">BTW: Just to tell people what I ended up doing, I'll post my full 'big map' code here:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void DrawNewColumn() {
<br/>
 int iX, iY;
<br/>
 int MXO = (CameraX/8)+30;
<br/>
 int MYO = (CameraY/8)-CameraOY;
<br/>
 int SXO = (CameraX/8)+30;
<br/>
 int SYO = (CameraY/8)-CameraOY;
<br/>
 for(iX=0;iX&lt;2;iX++) {
<br/>
  for(iY=0;iY&lt;32;iY++) {
<br/>
   ScreenBaseBlock[(iY+SYO)%32*32+(SXO+iX)%32] = baronMap[(iY+MYO)%MapSize*MapSize+(MXO+iX)%MapSize];
<br/>
  }
<br/>
 }
<br/>
}
<br/>
<br/>
void DelNewColumn() {
<br/>
 int iX, iY;
<br/>
 int MXO = (CameraX/8)-2;
<br/>
 int MYO = (CameraY/8)-CameraOY;
<br/>
 int SXO = (CameraX/8)-2;
<br/>
 int SYO = (CameraY/8)-CameraOY;
<br/>
 for(iX=0;iX&lt;2;iX++) {
<br/>
  for(iY=0;iY&lt;32;iY++) {
<br/>
   ScreenBaseBlock[(iY+SYO)%32*32+(SXO+iX)%32] = baronMap[(iY+MYO)%MapSize*MapSize+(MXO+iX)%MapSize];
<br/>
  }
<br/>
 }
<br/>
}
<br/>
<br/>
void DrawNewRow() {
<br/>
 int iX, iY;
<br/>
 int MXO = (CameraX/8);
<br/>
 int MYO = (CameraY/8)+20-CameraOY;
<br/>
 int SXO = (CameraX/8);
<br/>
 int SYO = (CameraY/8)+20-CameraOY;
<br/>
 for(iX=0;iX&lt;32;iX++) {
<br/>
  for(iY=0;iY&lt;2;iY++) {
<br/>
   ScreenBaseBlock[(iY+SYO)%32*32+(SXO+iX)%32] = baronMap[(iY+MYO)%MapSize*MapSize+(MXO+iX)%MapSize];
<br/>
  }
<br/>
 }
<br/>
}
<br/>
<br/>
void DelNewRow() {
<br/>
 int iX, iY;
<br/>
 int MXO = (CameraX/8);
<br/>
 int MYO = (CameraY/8)-2-CameraOY;
<br/>
 int SXO = (CameraX/8);
<br/>
 int SYO = (CameraY/8)-2-CameraOY;
<br/>
 for(iX=0;iX&lt;32;iX++) {
<br/>
  for(iY=0;iY&lt;2;iY++) {
<br/>
   ScreenBaseBlock[(iY+SYO)%32*32+(SXO+iX)%32] = baronMap[(iY+MYO)%MapSize*MapSize+(MXO+iX)%MapSize];
<br/>
  }
<br/>
 }
<br/>
}</td> </tr></table><span class="postbody">
<br/>
Where 'CameraX' and Y is your scrolling offsets, 'CameraOY' is incase you start off say at an offset of 8 pixels from the original Y offset which I am using right now, which is then divided by 8. The rest is pretty much self-explanatory. These functions should be called IMMEDIATLY after a keystroke. Eg:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">if(KEY_PRESSED(KEY_RIGHT)) {
<br/>
 DrawNewColumn();
<br/>
 //the rest of your code
<br/>
}</td> </tr></table><span class="postbody">
<br/>
Etc, etc...</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
