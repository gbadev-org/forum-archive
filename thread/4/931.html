<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Help with blending - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>Coding > Help with blending</h2>
<div id="posts">
<div class="post">
    <h4>#4619 - recondite - Sat Apr 05, 2003 1:49 am</h4>
    <div class="postbody"><span class="postbody">I have been having alot of trouble getting two backgrounds to blend, background 0 onto background2
<br/>
<br/>
my goal is to have a "shadow" effect.  background 0 is just black and transparent.
<br/>
<br/>
this is the portion of my code that is doing the blending
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
setblend
<br/>
   @define REG_BLDCNT   0x4000050
<br/>
   @define REG_BLDAlPHA    0x4000052 ; alpha
<br/>
   @define REG_BLDY    0x4000054 ; darken lighten
<br/>
   
<br/>
   ldr r1,=REG_BLDCNT
<br/>
   ldr r2,=0x00010001000001
<br/>
   str r2,[r1]
<br/>
   
<br/>
   ldr r1,=REG_BLDAlPHA
<br/>
   ldr r2,=0x0100000000000
<br/>
   str r2,[r1]
<br/>
   
<br/>
   mov pc,lr
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
It doesn't seam to work for me.  I just get my pureblackshadows.
<br/>
Its driving me nuts i hope somebody can figure out what i am doing wrong
<br/>
<br/>
thanks
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
ps. my code in its entirity is below
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
; Joe and Aaron's rpg  jarg
<br/>
@include jarg.h
<br/>
<br/>
b init
<br/>
;data
<br/>
   ;tiledata       @incbin    viragetileset.raw
<br/>
   tiledata       @incbin    GreenHL.raw
<br/>
   palletedata @incbin    master.pal
<br/>
   map2data      @include   hallway.map
<br/>
   ;map0data      @incbin      shadraw.raw   
<br/>
   map0data      @include    hallwayshadow.map
<br/>
<br/>
<br/>
<br/>
start_wram_vars
<br/>
@textarea 0x03000000
<br/>
   bg2scrlx @DCD 0; bg scroll 
<br/>
   bg2scrly @DCD 0; bg scroll 
<br/>
   ;sp1x @DCD 0; sprite x
<br/>
   ;sp1y @DCD 0; sprite y
<br/>
@endarea
<br/>
end_wram_vars
<br/>
<br/>
init
<br/>
   bl setmode
<br/>
   bl copyvars
<br/>
   bl loadtiles
<br/>
   bl loadbgpal
<br/>
   bl loadmaps
<br/>
   bl setblend
<br/>
   ;bl makesprite
<br/>
   ;bl loadsprite
<br/>
   ;bl loadsppal
<br/>
<br/>
mainloop
<br/>
   bl waitforvsync
<br/>
   bl getkeys
<br/>
   bl draw
<br/>
   bl delay   ; slow it all down
<br/>
   ;bl delay
<br/>
   b mainloop
<br/>
<br/>
setmode
<br/>
   ldr r1,=REG_DISPCNT
<br/>
   ldr r2,=(MODE_0|BG2_ENABLE|BG0_ENABLE)
<br/>
   str r2,[r1]
<br/>
   ldr r1,=REG_BG2CNT
<br/>
   ldr r2,=(TEXTBG_SIZE_512x512|BG_COLOR_256|(15&lt;&lt;SCREEN_SHIFT))
<br/>
   str r2,[r1]
<br/>
   ldr r1,=REG_BG0CNT
<br/>
   ldr r2,=(TEXTBG_SIZE_512x512|BG_COLOR_256|(20&lt;&lt;SCREEN_SHIFT))
<br/>
   str r2,[r1]
<br/>
   mov pc,lr
<br/>
   
<br/>
setblend
<br/>
   ;blending is super gay, all i want is my fn shadows to be 50% transparent for christs sake
<br/>
   @define REG_BLDCNT   0x4000050
<br/>
   @define REG_BLDAlPHA    0x4000052 ; alpha
<br/>
   @define REG_BLDY    0x4000054 ; darken lighten
<br/>
   
<br/>
   ldr r1,=REG_BLDCNT
<br/>
   ldr r2,=0x00010001000001
<br/>
   str r2,[r1]
<br/>
   
<br/>
   ldr r1,=REG_BLDAlPHA
<br/>
   ldr r2,=0x0100000000000
<br/>
   str r2,[r1]
<br/>
   
<br/>
   mov pc,lr
<br/>
   
<br/>
copyvars  ; can posibly do this with dma 
<br/>
   mov r0,start_wram_vars
<br/>
   mov r1,end_wram_vars
<br/>
   mov r2,$03000000
<br/>
   romtowram_loop
<br/>
      ldr r3,[r0]+4!
<br/>
      str r3,[r2]+4!
<br/>
      cmp r0,r1
<br/>
      ble romtowram_loop
<br/>
   mov pc,lr
<br/>
   
<br/>
loadtiles
<br/>
   ldr r1,=REG_DMA3SAD
<br/>
   ldr r2,=tiledata
<br/>
   str r2,[r1]
<br/>
   ldr r1,=REG_DMA3DAD
<br/>
   LoadCharBlockAddr r2, 0
<br/>
   str r2,[r1]
<br/>
   ldr r1,=REG_DMA3CNT
<br/>
   ldr r2,=(8192|DMA_32NOW)
<br/>
   str r2,[r1]
<br/>
   mov pc,lr
<br/>
   
<br/>
loadbgpal
<br/>
   ldr r1,=REG_DMA3SAD
<br/>
   ldr r2,=palletedata
<br/>
   str r2,[r1]
<br/>
   ldr r1,=REG_DMA3DAD
<br/>
   ldr r2,=VPAL
<br/>
   str r2,[r1]
<br/>
   ldr r1,=REG_DMA3CNT
<br/>
   ldr r2,=(128|DMA_32NOW)
<br/>
   str r2,[r1]
<br/>
   mov pc,lr
<br/>
   
<br/>
loadmaps
<br/>
   ;bg2
<br/>
   ldr r1,=REG_DMA3SAD
<br/>
   ldr r2,=map2data
<br/>
   str r2,[r1]
<br/>
   ldr r1,=REG_DMA3DAD
<br/>
   LoadScreenBlockAddr r2, 15
<br/>
   str r2,[r1]
<br/>
   ldr r1,=REG_DMA3CNT
<br/>
   ldr r2,=(2048|DMA_32NOW)
<br/>
   str r2,[r1]
<br/>
   
<br/>
   ;bg0
<br/>
   ldr r1,=REG_DMA3SAD
<br/>
   ldr r2,=map0data
<br/>
   str r2,[r1]
<br/>
   ldr r1,=REG_DMA3DAD
<br/>
   LoadScreenBlockAddr r2, 20
<br/>
   str r2,[r1]
<br/>
   ldr r1,=REG_DMA3CNT
<br/>
   ldr r2,=(2048|DMA_32NOW)
<br/>
   str r2,[r1]
<br/>
   mov pc,lr
<br/>
<br/>
waitforvsync
<br/>
   ldr r7,=REG_DISPCNT
<br/>
   vsyncloop
<br/>
      ldrh r8,[r7,+$06]
<br/>
      cmp r8,160
<br/>
      blt vsyncloop
<br/>
   mov pc, lr
<br/>
   
<br/>
getkeys
<br/>
   ldr r1,=KEYS
<br/>
   ldr r2,[r1]
<br/>
   ands r1,r2,#KEY_UP
<br/>
   beq do_keyup
<br/>
   upret
<br/>
   ands r1,r2,#KEY_DOWN
<br/>
   beq do_keydown
<br/>
   downret
<br/>
   ands r1,r2,#KEY_LEFT
<br/>
   beq do_keyleft
<br/>
   leftret
<br/>
   ands r1,r2,#KEY_RIGHT
<br/>
   beq do_keyright
<br/>
   rightret
<br/>
   ands r1,r2,#KEY_A
<br/>
   beq do_keya
<br/>
   aret
<br/>
   ands r1,r2,#KEY_B
<br/>
   beq do_keyb
<br/>
   bret
<br/>
   mov pc,lr
<br/>
   
<br/>
do_keyup
<br/>
   mov r0,bg2scrly
<br/>
  ldr r1,[r0]
<br/>
   cmp r1,1 ; limit scrolling upper boundy
<br/>
   ble upret
<br/>
   sub r1,r1,1
<br/>
   str r1,[r0]
<br/>
   b upret
<br/>
      
<br/>
do_keydown
<br/>
   mov r0,bg2scrly
<br/>
  ldr r1,[r0]
<br/>
   cmp r1,352 ; lower boundy
<br/>
   bge downret
<br/>
   add r1,r1,1
<br/>
   str r1,[r0]
<br/>
   b downret
<br/>
   
<br/>
do_keyleft
<br/>
   mov r0,bg2scrlx
<br/>
  ldr r1,[r0]
<br/>
   cmp r1,1    ; keft boundy
<br/>
   ble leftret
<br/>
   sub r1,r1,1
<br/>
   str r1,[r0]
<br/>
   b leftret
<br/>
   
<br/>
do_keyright
<br/>
   mov r0,bg2scrlx
<br/>
  ldr r1,[r0]
<br/>
   cmp r1,272 ; right boundy
<br/>
   bge rightret
<br/>
   add r1,r1,1
<br/>
   str r1,[r0]
<br/>
   b rightret
<br/>
   
<br/>
do_keya
<br/>
   ; turn on shadows
<br/>
   ldr r1,=REG_DISPCNT
<br/>
   ldr r3,=(MODE_0|BG2_ENABLE|BG0_ENABLE)
<br/>
   str r3,[r1]
<br/>
   b aret
<br/>
   
<br/>
do_keyb
<br/>
   ; turn off shadows
<br/>
   ldr r1,=REG_DISPCNT
<br/>
   ldr r3,=(MODE_0|BG2_ENABLE)
<br/>
   str r3,[r1]
<br/>
   b bret
<br/>
   
<br/>
draw
<br/>
   mov r0,bg2scrlx
<br/>
   ldr r1,[r0]
<br/>
   mov r0,bg2scrly
<br/>
   ldr r2,[r0]
<br/>
   mov r2,r2 lsl 16
<br/>
   add r1,r1,r2
<br/>
   ldr r3,=REG_BG2HOFS
<br/>
   str r1,[r3]
<br/>
   ldr r3,=REG_BG0HOFS
<br/>
   str r1,[r3]
<br/>
   mov pc,lr
<br/>
   
<br/>
delay
<br/>
  ldr r0,=0
<br/>
   delay_loop
<br/>
      add r0,r0,1
<br/>
      cmp r0,1024
<br/>
      ble delay_loop
<br/>
   mov pc,lr
<br/>
</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#4622 - recondite - Sat Apr 05, 2003 5:04 am</h4>
    <div class="postbody"><span class="postbody">figured it out thanks to dovoto
<br/>
<br/>
<br/>
the code shoudl have been
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">   ldr r1,=0x4000050
<br/>
   ldr r2,=0x08080441
<br/>
   str r2,[r1]
<br/>
   mov pc,lr</td> </tr></table><span class="postbody">
<br/>
<br/>
was suposed to write both at the same time.  and 0xwhatever isn't binary stupid me its hex</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
