<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Breaking the emulators. - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. A new forum can be found <a href="https://forum.gbadev.net/" target="_blank">here</a>.</i><br />

        <h2>Coding > Breaking the emulators.</h2>
<div id="posts">
<div class="post">
    <h4>#7055 - Darkain - Sat Jun 07, 2003 10:54 am</h4>
    <div class="postbody"><span class="postbody">ok, so i spent most of the night trying to figure out how i broke the emulators, yet still got this stuff to work on hardware..
<br/>
<br/>
basically, what i was trying to ocomplish was this:
<br/>
i wanted to halt the CPU (put it into power saving mode), until an interupt occured.  i was trying to use both keyboard and vblank interupts at the same time.
<br/>
<br/>
so, in my IRQ handler, i first checked to see if it was vblank, and processed if needed.  then, i checked to see if keys where pressed, and processes as needed.  but... there was a problem.  the code for checking for key input was NEVER called when running on emulators (Mappy worked, but all others failed).  the code, however, worked on the actual GBA.
<br/>
<br/>
after hours of searching, and chatting w/ peoples on IRC, we finally solved the problem.  it turns out that the emulators will call the interupt for key input the exact same time it will call the vsync interupt.  this within itself wasnt a problem.
<br/>
<br/>
next, at the end of my vsenc code, i had it remove the vsync flag from REG_IF, as documented.  im not sure why of this, but apparently, it sets the entire value to 0, not just the flag.  therefor, on the very next line of code, where it checked to see if key input interupt occured, it would fail.
<br/>
<br/>
after find this out, i was then informed that apparently crt0 will set all of the REG_IF flags after an interupt for me.  so i removed ever call to setting one of its flags to erase it.
<br/>
<br/>
also, i learned that the emulators (except for mappy) call the key input irq at the same exact time it calls the vsync irq.  therefor, checking for == failes (tho i already wasnt), but at the same time, other problems may arise, and therefor extra checks need to be made.
<br/>
<br/>
the difference why it works on hardware is because the GBA will call the key input IRQ at the very moment a key is pressed, NOT check to see if there should be an IRQ when a vblank occures.
<br/>
<br/>
<br/>
so, all n all, this was an "interesting" learning experince for me, and i thought i would just share it with others, so they dont try to make the smae mistake w/ their irq handlers.
<br/>
<br/>
thanx to all the peeps online that helped out!  ya saved me on a huge headache!!! :)
<br/>
<br/>
(i still think this would be neato as an extra layer of copy-protection for commercial games, but if a company where to do that, i would ask em nicely to please donate $$$ to this site)<br/>_________________<br/>-=- Darkain Dragoon -=-
<br/>
<a class="postlink" href="http://www.darkain.com" target="_blank">http://www.darkain.com</a>
<br/>
<a class="postlink" href="http://ds.darkain.com/hack" target="_blank">DarkStar</a> for <a class="postlink" href="http://ds.darkain.com" target="_blank">Nintendo DS</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#7058 - Quirky - Sat Jun 07, 2003 1:26 pm</h4>
    <div class="postbody"><span class="postbody">I didn't fully understand all of that (I tend not to understand something like that until I actually attempt it myself and I haven't tried sleep mode yet...) but I'd guess the emulators can be patched to fix it if you understand the bug. Maybe you could email Forgotten with a GBA demo that breaks VBA?</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
