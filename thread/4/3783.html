<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Interrupts suddenly not working - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>Coding > Interrupts suddenly not working</h2>
<div id="posts">
<div class="post">
    <h4>#23995 - dagamer34 - Mon Jul 26, 2004 4:11 am</h4>
    <div class="postbody"><span class="postbody">Interrupts in my program suddenly don't work anymore and I don't know why! Here's what I do to set up an interrupt:
<br/>
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
#define INT_VBLANK        0x0001
<br/>
#define INT_HBLANK       0x0002   
<br/>
#define INT_VCOUNT       0x0004   
<br/>
#define INT_TIMER0       0x0008
<br/>
#define INT_TIMER1       0x0010
<br/>
#define INT_TIMER2       0x0020   
<br/>
#define INT_TIMER3       0x0040
<br/>
#define INT_SERIAL         0x0080
<br/>
#define INT_DMA0       0x0100
<br/>
#define INT_DMA1       0x0200
<br/>
#define INT_DMA2       0x0400
<br/>
#define INT_DMA3       0x0800
<br/>
#define INT_KEYBOARD      0x1000
<br/>
#define INT_CART       0x2000
<br/>
#define INT_ALL       0x4000
<br/>
<br/>
// Dummy interrupt prototypes omitted for space, otherwise they would go here 
<br/>
<br/>
/* Table of function pointers */
<br/>
fp* IntrTable[]  =
<br/>
{
<br/>
   (fp*)VBLANK,
<br/>
   (fp*)HBLANK,
<br/>
   (fp*)VCOUNT,
<br/>
   (fp*)TIMER0,
<br/>
   (fp*)TIMER1,
<br/>
   (fp*)TIMER2,
<br/>
   (fp*)TIMER3,
<br/>
   (fp*)SERIAL,
<br/>
   (fp*)DMA0,
<br/>
   (fp*)DMA1,
<br/>
   (fp*)DMA2,
<br/>
   (fp*)DMA3,
<br/>
   (fp*)KEYBOARD,
<br/>
   (fp*)CART
<br/>
};
<br/>
<br/>
// Enables interupt calls
<br/>
void EnableInterupts(u16 interupts)
<br/>
{
<br/>
   REG_IME = 0;  // Not a good idea to change interupt registers during an interupt 
<br/>
<br/>
   if(interupts | INT_VBLANK)
<br/>
      REG_DISPSTAT |= 0x8;
<br/>
<br/>
   if(interupts | INT_HBLANK)
<br/>
      REG_DISPSTAT |= 0x10;
<br/>
   
<br/>
   if(interupts | INT_VCOUNT)
<br/>
      REG_DISPSTAT |= BIT05;
<br/>
<br/>
   REG_IE |= interupts;
<br/>
<br/>
   REG_IME = 1;
<br/>
}
<br/>
<br/>
// Starts an interupt handler 
<br/>
void StartIntHandler (u16 intno, void* funcpt)
<br/>
{
<br/>
   switch (intno)
<br/>
   {
<br/>
   case INT_VBLANK:
<br/>
      {
<br/>
         IntrTable [0] = (fp*)funcpt;
<br/>
      }
<br/>
      break;
<br/>
   case INT_HBLANK:
<br/>
      {
<br/>
         IntrTable [1] = (fp*)funcpt;
<br/>
      }
<br/>
      break;
<br/>
   case INT_VCOUNT:
<br/>
      {
<br/>
         IntrTable [2] = (fp*)funcpt;
<br/>
      }
<br/>
      break;
<br/>
   case INT_TIMER0:
<br/>
      {
<br/>
         IntrTable [3] = (fp*)funcpt;
<br/>
      }
<br/>
      break;
<br/>
   case INT_TIMER1:
<br/>
      {
<br/>
         IntrTable [4] = (fp*)funcpt;
<br/>
      }
<br/>
      break;
<br/>
   case INT_TIMER2:
<br/>
      {
<br/>
         IntrTable [5] = (fp*)funcpt;
<br/>
      }
<br/>
      break;
<br/>
   case INT_TIMER3:
<br/>
      {
<br/>
         IntrTable [6] = (fp*)funcpt;
<br/>
      }
<br/>
      break;
<br/>
   case INT_SERIAL:
<br/>
      {
<br/>
         IntrTable [7] = (fp*)funcpt;
<br/>
      }
<br/>
      break;
<br/>
   case INT_DMA0:
<br/>
      {
<br/>
         IntrTable [8] = (fp*)funcpt;
<br/>
      }
<br/>
      break;
<br/>
   case INT_DMA1:
<br/>
      {
<br/>
         IntrTable [9] = (fp*)funcpt;
<br/>
      }
<br/>
      break;
<br/>
   case INT_DMA2:
<br/>
      {
<br/>
         IntrTable [10] = (fp*)funcpt;
<br/>
      }
<br/>
      break;
<br/>
   case INT_DMA3:
<br/>
      {
<br/>
         IntrTable [11] = (fp*)funcpt;
<br/>
      }
<br/>
      break;
<br/>
   case INT_KEYBOARD:
<br/>
      {
<br/>
         IntrTable [12] = (fp*)funcpt;
<br/>
      }
<br/>
      break;
<br/>
   case INT_CART:
<br/>
      {
<br/>
         IntrTable [13] = (fp*)funcpt;
<br/>
      }
<br/>
      break;
<br/>
   default:
<br/>
      break;
<br/>
   }
<br/>
}
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
And used like this:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
// User-defined functions
<br/>
void vbl ();
<br/>
<br/>
// Set up which function will be called on a certain interrupt
<br/>
StartIntHandler (INT_VBLANK, (void*)&amp;vbl);
<br/>
<br/>
// Enable interrupts
<br/>
EnableInterupts (INT_VBLANK);
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
I cut and pasted most of it, it's not all in one file or in the same exact order, but I do know that it has to do with the set-up of my interrupts. Anybody know what's wrong?<br/>_________________<br/>Little kids and Playstation 2's don't mix. :(</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#24008 - poslundc - Mon Jul 26, 2004 1:40 pm</h4>
    <div class="postbody"><span class="postbody">What did you change in your code to make them stop working?
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#24019 - dagamer34 - Mon Jul 26, 2004 7:27 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>poslundc wrote:</b></span></td> </tr> <tr> <td class="quote">What did you change in your code to make them stop working?
<br/>
<br/>
Dan.</td> </tr></table><span class="postbody">
<br/>
<br/>
If only I knew. I really am starting to question whether it is the code in the first place as I tried to rebuild an old project with interupts and it also failed to work properly.
<br/>
<br/>
The odd thing though is that if I use the ctr0.s provided with AAS, and set it to AAS_MultipleInterrupts, create an interrupt table and then set up interrupts that way, it suddenly works. But switching crt0.s with another unmodified one didn't help.
<br/>
<br/>
I compiled it with the HAM toolchain without the hamLibs and also with DevKitadvance and still no change. I'm going around in circles trying to fix this.<br/>_________________<br/>Little kids and Playstation 2's don't mix. :(</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#24023 - poslundc - Mon Jul 26, 2004 7:51 pm</h4>
    <div class="postbody"><span class="postbody">Well, stupid but necessary question: in the crt0.S you are using, is the interrupt support set to the correct value? I can't check at work, but IIRC you can't use multiple interrupts with a jump table in the standard devkit's crt0.S; you need to either switch to single interrupts or write your own interrupt handler.
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#24024 - dagamer34 - Mon Jul 26, 2004 7:53 pm</h4>
    <div class="postbody"><span class="postbody">The crt0.s that I am using supports multiple interrupts. I've used it plenty of times before with no problem.<br/>_________________<br/>Little kids and Playstation 2's don't mix. :(</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#24026 - poslundc - Mon Jul 26, 2004 8:05 pm</h4>
    <div class="postbody"><span class="postbody">OK, but the crt0.S I have doesn't use a jump table for multiple interrupts... it just branches to an interrupt handler you specify and code. It's the same as switching on "Fast Interrupt" support instead of using "Single Interrupts".
<br/>
<br/>
You might try seeing if your program works if you switch to single interrupts instead of multiple interrupts.
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#24030 - dagamer34 - Mon Jul 26, 2004 8:42 pm</h4>
    <div class="postbody"><span class="postbody">I managed to fix my problem only after doing a complete re-install of my environment. I now later find out that I had conflicting versions of my library, with old and new defintions of my .a file and headers. I wish I had known that sooner.<br/>_________________<br/>Little kids and Playstation 2's don't mix. :(</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
