<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Zooming in mode 1 or 2 - gbadev.org forum archive</title>
        <link rel="stylesheet" href="/forum-archive/static/pure-min.css" />
        <link rel="stylesheet" href="/forum-archive/static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        <i>This is a read-only mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. </i><br />

        <h2>Coding > Zooming in mode 1 or 2</h2>
<div id="posts">
<div class="post">
    <h4>#23278 - mymateo - Fri Jul 09, 2004 6:10 am</h4>
    <div class="postbody"><span class="postbody">I'm having some trouble.  "What's New?"  I should change my nick to Zombie 'cause I'm here picking brains just about every week with something new...
<br/>
<br/>
I want to use mode 1 to have 2 plain text backgrounds, and one rot/scale background.  I plan on adding a spell to my Marle demo, and for that I need a blue circle to shoot out from behind Marle.
<br/>
<br/>
I have somewhat of a handle on actually scaling the background, and I can move the background left/right and up/down.
<br/>
<br/>
What it does:  When I increase the scale/make the background bigger, it moves to the right and down.  Or rather, it LOOKS like it does.  What it's actually doing (I think) is the 0,0 point stays put and the rest stretches out.
<br/>
<br/>
What I want:  I want to pick a point at 32,32 (pixels) and have that the center that it stretches out from.
<br/>
<br/>
Brendan Sechter has made a rot/scale demo ("sg_rot_demo.zip" in the sources -&gt; GBA -&gt; C/C++ section) that scales in this fashion.  I have looked at the source, but I cannot for the life of me figure out how he manages it.  I think he does something in this function...
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">void swi_bg_affine_set(void *src, void *dest)
<br/>
{
<br/>
  asm volatile ("mov r0,%0\nmov r1,%1\nmov r2,#1\nswi 0x0E0000\n" :
<br/>
  /* No output */ :
<br/>
  "r" (src), "r" (dest) :
<br/>
  "r0", "r1", "r2", "memory");
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
... that moves his data around to scale the background and then move it so it looks like it scales out from the center.
<br/>
<br/>
But I really don't know, which is why I am asking for help again.  Thanks everyone!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#23282 - ampz - Fri Jul 09, 2004 9:49 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>mymateo wrote:</b></span></td> </tr> <tr> <td class="quote">What it does:  When I increase the scale/make the background bigger, it moves to the right and down.  Or rather, it LOOKS like it does.  What it's actually doing (I think) is the 0,0 point stays put and the rest stretches out.</td> </tr></table><span class="postbody">
<br/>
Yes, that's exactly what happens.
<br/>
If you want it to center on any other point (like 32,32) you have to compensate by moving the background.
<br/>
<br/>
I think this should keep it centered at (32,32).
<br/>
x=y=32-32*s   where s is the scale factor and x,y are the background coordinates.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#23283 - mymateo - Fri Jul 09, 2004 10:41 am</h4>
    <div class="postbody"><span class="postbody">I tried that, but the same thing happens.  The upper left corner stays exactly where it is, and the background just stretches out.  This is what the code looks like, with your suggestion:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">BG2_ZOOM = 1 + ((Marlex + Marley) / 40);
<br/>
REG_BG2X = REG_BG2Y = 32-32*BG2_ZOOM;
<br/>
REG_BG2PA = BG2_ZOOM &lt;&lt; 8;
<br/>
REG_BG2PB = 0;
<br/>
REG_BG2PC = 0;
<br/>
REG_BG2PD = BG2_ZOOM &lt;&lt; 8;
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
When my sprite moves around, the zoom changes (I did this so I don't have to recompile the source every time I wanted to test a different zoom factor).  Full size (BG2_ZOOM = 1) when the sprite is in the upper left, and small (BG2_ZOOM = 9) when it's in the bottom right.  The background (a circle) stays in the upper-left.
<br/>
<br/>
So no offense (because I don't think you knew what I wanted), but this isn't going to work.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#23287 - Cearn - Fri Jul 09, 2004 1:46 pm</h4>
    <div class="postbody"><span class="postbody">Always be very very careful when you're dealing with fixed point numbers. For one thing REG_BG2X and REG_BG2Y are both .8 fixed numbers; using a pure 32 doesn't move a pixel. Secondly, are BG2_ZOOM and marlex and marley  fixed point or not? If they're pure numbers, the calculation of BG2_ZOOM is likely to be wrong.
<br/>
Lastly, all the background offsets and affine parameters are <span style="font-weight: bold">write only</span>! Doing anything like
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
REG_BG2X = REG_BG2Y = foo;
<br/>
REG_BG2X += bar;
<br/>
</td> </tr></table><span class="postbody">
<br/>
will probably give unexpected results.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#23288 - sgeos - Fri Jul 09, 2004 1:46 pm</h4>
    <div class="postbody"><span class="postbody">First, find a copy of the <a class="postlink" href="http://pinocchio.jk0.org/gbatek/" target="_blank">GBATEK</a>.  It covers a lot of nifty stuff for the GBA.
<br/>
<br/>
I am calling a BIOS function, SWI 14 in particular.  BIOS functions can only be called using ASM, so that confusing function uses gcc's asm feature.  I suspect that you are more interested in how to use the function than you are in how it works.
<br/>
<br/>
There are two structs:</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">typedef struct tbgaffinesource
<br/>
{
<br/>
  s32 x;   //Original data's center X coordinate (8bit frac portion)
<br/>
  s32 y;   //Original data's center Y coordinate (8bit frac portion)
<br/>
  s16 tx;  //Display's center X coordinate
<br/>
  s16 ty;  //Display's center Y coordinate
<br/>
  s16 sx;  //Scaling ratio in X direction (8bit fractional portion)
<br/>
  s16 sy;  //Scaling ratio in Y direction (8bit fractional portion)
<br/>
  u16 r;   //Angle of rotation (8bit fract portion) Effect Range 0-FFFF
<br/>
} bgaffinesource;
<br/>
<br/>
typedef struct tbgaffinedest
<br/>
{
<br/>
  s16 pa;  //Difference in X coordinate along same line
<br/>
  s16 pb;  //Difference in X coordinate along next line
<br/>
  s16 pc;  //Difference in Y coordinate along same line
<br/>
  s16 pd;  //Difference in Y coordinate along next line
<br/>
  s32 x;   //Start X coordinate
<br/>
  s32 y;   //Start Y coordinate
<br/>
} bgaffinedest;</td> </tr></table><span class="postbody">
<br/>
These are more or less directly from the <a class="postlink" href="http://pinocchio.jk0.org/gbatek/#biosrotationscalingfunctions" target="_blank">GBATEK's section on <span style="font-weight: bold">SWI 14 (0Eh) - BgAffineSet</span></a>.
<br/>
<br/>
Declare your source and destination structs</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">bgaffinesource src_bga;
<br/>
bgaffinedest   dest_bga;</td> </tr></table><span class="postbody">
<br/>
Write all of your source info to the source struct:
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">src_bga.x  =    64 * 256;
<br/>
src_bga.y  =    64 * 256;
<br/>
src_bga.tx =   120;
<br/>
src_bga.ty =    80;
<br/>
src_bga.sx = 0x100;
<br/>
src_bga.sy = 0x100;</td> </tr></table><span class="postbody">
<br/>
Humans tend to think more along the lines of the source struct representation (bgaffinesource), but the GBA can't deal with that format.  The GBA's bios will take the info in the source struct and use that to calculate values the GBA can deal with.  These are put in the destination struct (bgaffinedest).
<br/>
<br/>
Pass the source and destination structs to swi_bg_affine_set():
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">swi_bg_affine_set(&amp;src_bga, &amp;dest_bga);</td> </tr></table><span class="postbody">
<br/>
Next, write the values from your destination struct to your BG rot/scale/control registers.
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">// !!!!!!!!!!!
<br/>
// ! Warning !  Bad code - do not program like this!
<br/>
// !!!!!!!!!!!
<br/>
<br/>
*(unsigned long *) 0x04000028 = dest_bga.x;  // BG2X
<br/>
*(unsigned long *) 0x0400002C = dest_bga.y;  // BG2Y
<br/>
<br/>
*(unsigned short *)0x04000020 = dest_bga.pa;  // BG2 Rotation/Scaling Parameter A (alias dx)
<br/>
*(unsigned short *)0x04000022 = dest_bga.pb;  // BG2 Rotation/Scaling Parameter B (alias dmx)
<br/>
*(unsigned short *)0x04000024 = dest_bga.pc;  // BG2 Rotation/Scaling Parameter C (alias dy)
<br/>
*(unsigned short *)0x04000026 = dest_bga.pd;  // BG2 Rotation/Scaling Parameter D (alias dmy)</td> </tr></table><span class="postbody">
<br/>
-Brendan
<br/>
<br/>
PS  How easy/hard to read did you find the code in that demo?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#23289 - poslundc - Fri Jul 09, 2004 2:13 pm</h4>
    <div class="postbody"><span class="postbody">Note that the BIOS routine is probably not the preferred option for practical game design, since it is much faster to do your own calculations as described earlier in the thread.
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#23294 - sgeos - Fri Jul 09, 2004 3:01 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>poslundc wrote:</b></span></td> </tr> <tr> <td class="quote">Note that the BIOS routine is probably not the preferred option for practical game design, since it is much faster to do your own calculations as described earlier in the thread.</td> </tr></table><span class="postbody">
<br/>
That depends on how you view practical.  The BIOS routine will burn more cycles, but if your bottleneck is programmer time and the BIOS function works, it is the fastest and most practical way to go.
<br/>
<br/>
-Brendan</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#23312 - mymateo - Fri Jul 09, 2004 7:30 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Secondly, are BG2_ZOOM and marlex and marley fixed point or not? If they're pure numbers, the calculation of BG2_ZOOM is likely to be wrong. </td> </tr></table><span class="postbody">
<br/>
<br/>
BG2_ZOOM, Marlex and Marley are all u16 numbers.  I just &lt;&lt; 8 when I need to put them into memory.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Quote:</b></span></td> </tr> <tr> <td class="quote">Lastly, all the background offsets and affine parameters are write only! Doing anything like 
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">Code: 
<br/>
<br/>
REG_BG2X = REG_BG2Y = foo; 
<br/>
REG_BG2X += bar; </td> </tr></table><span class="postbody">
<br/>
<br/>
will probably give unexpected results.</span></td> </tr></table><span class="postbody">
<br/>
<br/>
Then it's good I'm not.  I store everything I will need to write to the background registers in variables.
<br/>
<br/>
sgeos, I'm particularly interested in picking your brain.  In your scale/rot demo with the red and blue faces, you manage to get it to zoom from a specific point, yet I cannot find anything in the code that would offset the layer's X and Y co-ords compared to the zoom.  The only thing I see that might make any calculations is that funky BIOS call which I sill don't understand, especially since when I try to compile it I get an error that 917504 is too big of a number.  (It doesn't like the 0x0E0000 in there I guess....)
<br/>
<br/>
Without using ancient egyptian cryptic writings (BIOS stuff written in assembly - whew), could you give me a breakdown of the math that happens?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#23313 - mymateo - Fri Jul 09, 2004 7:45 pm</h4>
    <div class="postbody"><span class="postbody">Hold the phone...
<br/>
<br/>
sgeos, I gave implementing your code into mine one more time (out of sheer frustration of not being able to make any progress), and I think I may have it...
<br/>
<br/>
Sorry to bother everyone....
<br/>
<br/>
Still, I wouldn't mind knowing how that BIOS thingy works.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#23324 - sgeos - Fri Jul 09, 2004 10:16 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>mymateo wrote:</b></span></td> </tr> <tr> <td class="quote">Still, I wouldn't mind knowing how that BIOS thingy works.</td> </tr></table><span class="postbody">
<br/>
The GBA BIOS contains some routines that do nifty things.  Each routine has a number.  To execute a given routine, you need to use make a SWI call using assembly code.  These routines are more or less just functions.  I wouldn't worry about it unless you learn ASM or unless you feel using a particular BIOS function would be really nifty.
<br/>
<br/>
How does the BIOS function do the job?  I have never dumped or looked at the BIOS code.  I have no clue.  If anyone knows how SWI 0x0E actually calculates the rotation and scaling parameters I'd love to hear about it.
<br/>
<br/>
-Brendan</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#23330 - Cearn - Sat Jul 10, 2004 12:02 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>mymateo wrote:</b></span></td> </tr> <tr> <td class="quote">I tried that, but the same thing happens.  The upper left corner stays exactly where it is, and the background just stretches out.  This is what the code looks like, with your suggestion:
<br/>
<br/>
<table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">BG2_ZOOM = 1 + ((Marlex + Marley) / 40);
<br/>
REG_BG2X = REG_BG2Y = 32-32*BG2_ZOOM;
<br/>
REG_BG2PA = BG2_ZOOM &lt;&lt; 8;
<br/>
REG_BG2PB = 0;
<br/>
REG_BG2PC = 0;
<br/>
REG_BG2PD = BG2_ZOOM &lt;&lt; 8;
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
When my sprite moves around, the zoom changes (I did this so I don't have to recompile the source every time I wanted to test a different zoom factor).  Full size (BG2_ZOOM = 1) when the sprite is in the upper left, and small (BG2_ZOOM = 9) when it's in the bottom right.  The background (a circle) stays in the upper-left.
<br/>
</span></td> </tr></table><span class="postbody">
<br/>
Sorry, I should have paid better attention to this post. If BG2_ZOOM is in the range [1,9], then the coordinates you have for REG_BG2X and REG_BG2Y lie between [-256, 0]. Since these are .8 fixed point numbers, that means a one pixel offset at best. And I guess that's not what you're after. Try shifting the whole thing. 
<br/>
Also, since you're using integers for BG2_ZOOM, you will have jumps between its nine values, rather than a smooth scaling.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>mymateo wrote:</b></span></td> </tr> <tr> <td class="quote">Still, I wouldn't mind knowing how that BIOS thingy works.</td> </tr></table><span class="postbody">
<br/>
<br/>
While I'm not <span style="font-style: italic">exactly</span> sure what the BIOS routine does, it's likely to be something like this (sorry, I'm using my own names here):
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
typedef struct tagAFFSRC_EX
<br/>
{ 
<br/>
  s32 px, py;    // map origin (.8 fixed)
<br/>
  s16 qx, qy;    // screen origin (pure integer (?) )
<br/>
  s16 sx, sy;     // x and y scales (.8 fixed)
<br/>
  u16 alpha;
<br/>
} AFFSRC_EX;
<br/>
<br/>
typedef struct BGAFF_EX
<br/>
{
<br/>
  s16 pa, pb, pc, pd;   // affine matrix (.8 fixed)
<br/>
  s32 dx, dy;            // affine displacement (.8 fixed)
<br/>
} BGAFF_EX;
<br/>
<br/>
pa= sx*cos(alpha)&gt;&gt;8;       pb= -sx*sin(alpha)&gt;&gt;8;
<br/>
pc= sy*sin(alpha)&gt;&gt;8;       pd= sy*cos(alpha)&gt;&gt;8;
<br/>
dx= px - (pa*qx + pb*qy);
<br/>
dy= py - (pc*qx + pd*qy);
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
&lt;plug shamelessness="100%"&gt;
<br/>
If you want to know why these are the necessary steps, see <a class="postlink" href="http://user.chem.tue.nl/jakvijn/tonc/" target="_blank">Tonc</a>:<a class="postlink" href="http://user.chem.tue.nl/jakvijn/tonc/affine.htm" target="_blank">affine matrix</a> and <a class="postlink" href="http://user.chem.tue.nl/jakvijn/tonc/affbg.htm" target="_blank">affine backgrounds</a> (especially eq 4). For a little more about BIOS calls in general, <a class="postlink" href="http://user.chem.tue.nl/jakvijn/tonc/affine.htm" target="_blank">BIOS calls</a>
<br/>
&lt;/plug&gt;</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
