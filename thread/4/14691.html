<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>ARM/Thumb code selection - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>Coding > ARM/Thumb code selection</h2>
<div id="posts">
<div class="post">
    <h4>#147282 - bpoint - Mon Dec 17, 2007 10:55 pm</h4>
    <div class="postbody"><span class="postbody">Hello all,
<br/>
<br/>
Is it possible to select and use both ARM and Thumb in a single source file with gcc?  Googling turned up nothing promising, and considering the way the -m flag works, I presume the answer is "no".
<br/>
<br/>
It would be nice to be able to default to say, Thumb mode, by specifing -mthumb -mthumb-interwork, and then tag a specific function or functions with an __attribute__ that would allow those functions to be compiled as ARM code, while the rest is compiled into Thumb.
<br/>
<br/>
Is there anything like this, supported by gcc now?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#147387 - wintermute - Wed Dec 19, 2007 1:47 pm</h4>
    <div class="postbody"><span class="postbody">Nope, gcc also assumes that functions in the same translation unit can be reached with a standard branch so I doubt if it will ever be possible.<br/>_________________<br/><a class="postlink" href="http://www.devkitpro.org/" target="_blank">devkitPro - professional toolchains at amateur prices</a>
<br/>
<a class="postlink" href="http://wiki.devkitpro.org/index.php/IRC" target="_blank">devkitPro IRC support</a>
<br/>
<a class="postlink" href="http://davejmurphy.com/" target="_blank">Personal Blog</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#147428 - bpoint - Thu Dec 20, 2007 3:14 pm</h4>
    <div class="postbody"><span class="postbody">Urgh, oh well.  This makes it a bit difficult to manage source files for code that is shared across multiple platforms...
<br/>
<br/>
Thanks anyway!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#147435 - Dwedit - Thu Dec 20, 2007 6:17 pm</h4>
    <div class="postbody"><span class="postbody">Maybe you just need clever use of IFDEFS, and compile the file twice to two different output files.<br/>_________________<br/>"We are merely sprites that dance at the beck and call of our button pressing overlord."</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#147437 - Miked0801 - Thu Dec 20, 2007 7:04 pm</h4>
    <div class="postbody"><span class="postbody">Or just break the file into an ARM and Thumb equivilent.  Why is that so hard?</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#147443 - bpoint - Thu Dec 20, 2007 8:31 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Dwedit wrote:</b></span></td> </tr> <tr> <td class="quote">Maybe you just need clever use of IFDEFS, and compile the file twice to two different output files.</td> </tr></table><span class="postbody">
<br/>
<br/>
Hmm... that's not such a bad idea.  I could probably come up with some Makefile magic to have that happen.
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Miked0801 wrote:</b></span></td> </tr> <tr> <td class="quote">Or just break the file into an ARM and Thumb equivilent. Why is that so hard?</td> </tr></table><span class="postbody">
<br/>
<br/>
You missed the point about "multiple platforms".
<br/>
<br/>
Given that a single source file is typically a certain module of some sort (typically an entire class's implementation), splitting the source file between ARM and Thumb causes problems for other platforms, since the code is shared among all of them.  In other words, I'd have to compile both the standard .cpp and the .arm.cpp for all non-GBA platforms.  What if some other platform requires this kind of separation with a different CPU?  What do you do then?
<br/>
<br/>
Another option is to duplicate the actual function code between sources, but if you change something on one platform you can easily forget to change it on another, considering it's in a different source file.
<br/>
<br/>
I like Dwedit's idea of using #ifdefs though.  Thanks!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#147450 - Miked0801 - Thu Dec 20, 2007 10:53 pm</h4>
    <div class="postbody"><span class="postbody">You do what has always been done: Make it up as you go and pray that you aren't the one who has to maintain it later ;)</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#147452 - keldon - Thu Dec 20, 2007 11:01 pm</h4>
    <div class="postbody"><span class="postbody">If you want identical code in two files can't you use includes!</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#147472 - bpoint - Fri Dec 21, 2007 6:17 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Miked0801 wrote:</b></span></td> </tr> <tr> <td class="quote">You do what has always been done: Make it up as you go and pray that you aren't the one who has to maintain it later ;)</td> </tr></table><span class="postbody">
<br/>
<br/>
Considering adding GBA support was my idea, I'm probably going to have to be the one to maintain it... :)
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>keldon wrote:</b></span></td> </tr> <tr> <td class="quote">If you want identical code in two files can't you use includes!</td> </tr></table><span class="postbody">
<br/>
<br/>
Aside from the fact that #including .cpp files is a big no-no, doing this scatters the class's implementation across multiple source files, rather than just one, where it should be.  Again, code maintenance becomes difficult if done this way.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#147480 - keldon - Fri Dec 21, 2007 11:01 am</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>bpoint wrote:</b></span></td> </tr> <tr> <td class="quote">Aside from the fact that #including .cpp files is a big no-no, doing this scatters the class's implementation across multiple source files, rather than just one, where it should be.  Again, code maintenance becomes difficult if done this way.</td> </tr></table><span class="postbody">
<br/>
<br/>
I know not to include source files, I would never do that; but your task sounds like it would make sense - i.e. the exception to the rule. And when you think about it it doesn't quite scatter the classes implementation across multiple source files any more than writing multiple files would since the implementation is in one source file as opposed to two. 
<br/>
<br/>
Here's how I imagined it to work; you have the two "original" class implementations and declaration
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">// original_class_implementation.inc
<br/>
#ifdef ORIGINAL_CLASS
<br/>
<br/>
void ORIGINAL_CLASS::func ( void )
<br/>
{
<br/>
   OS_Printf ("called");
<br/>
} // func (void)
<br/>
<br/>
#endif</td> </tr></table><span class="postbody">
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">// original_class_declaration.inc
<br/>
/*
<br/>
class ORIGINAL_CLASS
<br/>
{
<br/>
*/
<br/>
   public:
<br/>
      void func ( void );
<br/>
/*
<br/>
};
<br/>
*/</td> </tr></table><span class="postbody">
<br/>
<br/>
... then you include them into the header and source file like so (note that this is not anything like typical amateur including source files because they don't know how to build) ... 
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">// arm_class.cpp
<br/>
#include "ARM_CLASS.h"
<br/>
<br/>
#define ORIGINAL_CLASS ARM_CLASS
<br/>
#include "original.cpp"
<br/>
#undef ORIGINAL_CLASS</td> </tr></table><span class="postbody">
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">// arm_class.h
<br/>
class ARM_CLASS
<br/>
{
<br/>
   #include "original.h"
<br/>
};</td> </tr></table><span class="postbody">
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">// thumb_class.cpp
<br/>
#include "thumb_class.h"
<br/>
<br/>
#define ORIGINAL_CLASS THUMB_CLASS
<br/>
#include "original.cpp"
<br/>
#undef ORIGINAL_CLASS</td> </tr></table><span class="postbody">
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">// thumb_class.h
<br/>
<br/>
class THUMB_CLASS
<br/>
{
<br/>
   #include "original.h"
<br/>
};</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#147531 - bpoint - Sat Dec 22, 2007 9:07 am</h4>
    <div class="postbody"><span class="postbody">Unless if I'm mistaken, your method would generate two different classes with identical code (although one would be compiled for ARM and one would be compiled for Thumb).
<br/>
<br/>
I want to have a single class implementation with most of the functions compiled as Thumb, and the few which are performance-intensive as ARM.  I'm not quite sure how your idea would work given what I want to do.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#147533 - keldon - Sat Dec 22, 2007 11:04 am</h4>
    <div class="postbody"><span class="postbody">Ahh, well if the compiler allows it you could forget my last post and maybe have ...
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">// arm_thumb_class.h
<br/>
#pragma once // (replace with ifdef)
<br/>
ARM_THUMB_CLASS
<br/>
{
<br/>
public:
<br/>
   void method (void);
<br/>
};</td> </tr></table><span class="postbody">
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">// arm_class.h
<br/>
#pragma once // (replace with ifdef)
<br/>
#include "arm_class.h"
<br/>
<br/>
void method ( ARM_THUMB_CLASS* this )
<br/>
{
<br/>
   // code
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">// arm_thumb_class.cpp
<br/>
#include "arm_thumb_class.h"
<br/>
#include "arm_class.h"
<br/>
<br/>
void ARM_THUMB_CLASS::method ( void )
<br/>
{
<br/>
   method (this);
<br/>
}</td> </tr></table><span class="postbody"></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#147808 - bpoint - Fri Dec 28, 2007 8:16 am</h4>
    <div class="postbody"><span class="postbody">That is a step in the right direction, but dropping back to C from C++ is, well, a bit unacceptable.  Once you remove yourself from the class, you no longer have access to any protected or private members, and you cannot call functions from the classes you have derived from.
<br/>
<br/>
After a bit of work though, I have been able to find an acceptable solution to this problem.  As Dwedit pointed out, compiling the file twice and using #ifdefs to create function-specific code guards works nicely.  With a bit of preprocessor magic, I have this in my master header:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#ifdef GBA
<br/>
 #if defined(__thumb__) || defined(__THUMBEL__)
<br/>
  #define BUILD_THUMB
<br/>
 #elif defined(__arm__) || defined(__ARMEL__)
<br/>
  #define BUILD_ARM
<br/>
 #endif
<br/>
#else
<br/>
 #define BUILD_ARM
<br/>
 #define BUILD_THUMB
<br/>
#endif
<br/>
<br/>
// default to disabling of functions
<br/>
#define FUNC_ARM(...)
<br/>
#define FUNC_THUMB(...)
<br/>
<br/>
#ifdef BUILD_ARM
<br/>
 // allow arm functions
<br/>
 #undef FUNC_ARM
<br/>
 #define FUNC_ARM(...)            __VA_ARGS__
<br/>
#endif
<br/>
<br/>
#ifdef BUILD_THUMB
<br/>
 // allow thumb functions
<br/>
 #undef FUNC_THUMB
<br/>
 #define FUNC_THUMB(...)         __VA_ARGS__
<br/>
#endif</td> </tr></table><span class="postbody">
<br/>
<br/>
And in my source, I can do:
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">FUNC_THUMB( void MyClass::thumbFunc(void)
<br/>
{
<br/>
} )
<br/>
<br/>
FUNC_ARM( void MyClass::armFunc(void)
<br/>
{
<br/>
} )
<br/>
</td> </tr></table><span class="postbody">
<br/>
<br/>
When the file is compiled using -mthumb, gcc internally defines __thumb__, so BUILD_THUMB is #defined.  This lets FUNC_THUMB() be #defined to just pass-through, while FUNC_ARM() is #defined to nothing (the function is removed).  Likewise when compiling with -marm, BUILD_ARM is #defined, so code inside FUNC_ARM() is compiled while FUNC_THUMB() is removed.
<br/>
<br/>
On platforms other than GBA (where GBA is not #defined), both BUILD_THUMB and BUILD_ARM are #defined, so all functions are included in the output.
<br/>
<br/>
The only downside to this is I cannot use #ifdefs within a FUNC_ARM() or FUNC_THUMB() code block, because Microsoft's compiler doesn't support it.  I was actually suprised to find that gcc compiled #ifdefs insde without a problem, though, so some of you out there who only use gcc might find this code snippet useful.</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
