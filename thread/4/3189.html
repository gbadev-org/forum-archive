<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Newbie requires help... - gbadev.org forum archive</title>
        <link rel="stylesheet" href="static/pure-min.css" />
        <link rel="stylesheet" href="static/main.css" />
    </head>
    <body>
        <h1>gbadev.org forum archive</h1>

        This is a mirror of the content originally found on forum.gbadev.org
        (now offline), salvaged from Wayback machine copies. <br />

        <h2>Coding > Newbie requires help...</h2>
<div id="posts">
<div class="post">
    <h4>#18873 - cheech - Wed Apr 07, 2004 4:48 pm</h4>
    <div class="postbody"><span class="postbody">Hi,
<br/>
<br/>
I'm just trying to code a simple fade to black, fade in from black.  The fade TO black works but the fadeIn doesn't.  Any ideas?
<br/>
<br/>
Here's the code...
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#include "gba.h"
<br/>
#include "screenmodes.h"
<br/>
#include "test.h"
<br/>
<br/>
u16* theVideoBuffer = (u16*)VideoBuffer;
<br/>
u16* theScreenPalette = (u16*)BGPaletteMem;
<br/>
u16* theBackBuffer = (u16*)BackBuffer;
<br/>
u32  frames = 0;
<br/>
<br/>
#define RGB(r,g,b)(r+(g&lt;&lt;5)+(b&lt;&lt;10));
<br/>
#define VCOUNT (*(volatile u16 *)0x04000006)
<br/>
<br/>
void WaitForVsync() {  
<br/>
  while(VCOUNT != 160) ; 
<br/>
  while(VCOUNT != 161) ; 
<br/>
  frames++;
<br/>
} 
<br/>
<br/>
void Flip() {
<br/>
   if (REG_DISPCNT &amp; BACKBUFFER) {
<br/>
      REG_DISPCNT &amp;= ~BACKBUFFER;
<br/>
      theVideoBuffer = theBackBuffer;
<br/>
   } else {
<br/>
      REG_DISPCNT |= BACKBUFFER;
<br/>
      theVideoBuffer = theBackBuffer;
<br/>
   }
<br/>
}
<br/>
<br/>
<br/>
void fadePaletteToBlack(void) {
<br/>
   u16 i, r, g, b, col;
<br/>
   for (i=0;i&lt;256;i++) {
<br/>
      col = theScreenPalette[i];
<br/>
      r = (col &amp; 0x000F);
<br/>
      g = (col &amp; 0x03E0) &gt;&gt; 5;
<br/>
      b = (col &amp; 0x7C00) &gt;&gt; 10;
<br/>
      if (r &gt; 0)
<br/>
         r--;
<br/>
      if (g &gt; 0)
<br/>
         g--;
<br/>
      if (b &gt; 0)
<br/>
         b--;
<br/>
      col = RGB(r, g, b);
<br/>
      theScreenPalette[i] = col;
<br/>
   }
<br/>
}
<br/>
<br/>
void blankPalette(void) {
<br/>
   u16 i;
<br/>
   for (i=0;i&lt;256;i++) {
<br/>
      theScreenPalette[i] = 0x00;
<br/>
   }
<br/>
}
<br/>
<br/>
void fadePaletteIn(void) {
<br/>
   u16 i, r, g, b, col;
<br/>
   for (i=0;i&lt;256;i++) {
<br/>
      col = theScreenPalette[i];
<br/>
      r = (col &amp; 0x000F);
<br/>
      g = (col &amp; 0x03E0) &gt;&gt; 5;
<br/>
      b = (col &amp; 0x7C00) &gt;&gt; 10;
<br/>
<br/>
      if (r &lt; (testPalette[i] &amp; 0x000F))
<br/>
         r++;
<br/>
      if (g &lt; ((testPalette[i] &amp; 0x03E0) &gt;&gt; 5))
<br/>
         g++;
<br/>
      if (b &lt; ((testPalette[i] &amp; 0x7C00) &gt;&gt; 10))
<br/>
         b++;
<br/>
      col = RGB(r, g, b);
<br/>
      theScreenPalette[i] = col;
<br/>
   }
<br/>
}
<br/>
<br/>
int main() {
<br/>
   SetMode(SCREENMODE4 | BG2ENABLE);
<br/>
   u16 i;
<br/>
<br/>
   for (i=0;i&lt;256;i++) {
<br/>
      theScreenPalette[i] = testPalette[i];
<br/>
   }
<br/>
   u16* tempData = (u16*)test;
<br/>
   u16 x, y;
<br/>
<br/>
   for (x=0;x&lt;240*160;x++)   {
<br/>
      theBackBuffer[x] = tempData[x];
<br/>
   }
<br/>
   while(1) {
<br/>
      WaitForVsync();
<br/>
      if (frames == 1) {
<br/>
         Flip();
<br/>
      }
<br/>
      if (frames &gt; 50) {
<br/>
         fadePaletteToBlack();
<br/>
         WaitForVsync();
<br/>
         WaitForVsync();
<br/>
      }
<br/>
      if (frames &gt; 2000) {
<br/>
         fadePaletteIn();
<br/>
         WaitForVsync();
<br/>
         WaitForVsync();
<br/>
      }
<br/>
   }
<br/>
   return 0;
<br/>
}</td> </tr></table><span class="postbody">
<br/>
<br/>
<br/>
Thanks in advance.
<br/>
Cheech.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#18876 - poslundc - Wed Apr 07, 2004 6:24 pm</h4>
    <div class="postbody"><span class="postbody">Three notes:
<br/>
<br/>
1. When masking for the red component of the colour, you need to use 0x001F, not 0x000F. This error would make your image lack saturation in the red channel when fading up.
<br/>
<br/>
2. The effect you're creating isn't really a fade in the strictest sense. You should use fixed-point math so that all components of all colours reach either zero (black) or their destination at exactly the same time.
<br/>
<br/>
3. How long did you wait for the fade up to begin? If you wait for the frames variable to reach 2000, it will be over 30 seconds before the fade up starts.
<br/>
<br/>
It would be much more helpful if you told us what actually happens (ie. what goes wrong) when you try the fade.
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#18886 - Lupin - Wed Apr 07, 2004 7:38 pm</h4>
    <div class="postbody"><span class="postbody">You can also check out the gba blending, it does a pretty good job on fading from/to black...
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">
<br/>
//This will kick the timer
<br/>
c=0;
<br/>
FadeOut = true;
<br/>
REG_BLDMOD = 0xD4;
<br/>
REG_TM1CNT = (TIMER_ENABLE | FREQUENCY_64 | TIMER_IRQ);
<br/>
<br/>
//Use this as timer interrupt handler
<br/>
void DoFade(void) {
<br/>
    if(FadeIn) {
<br/>
        REG_COLEY=c;
<br/>
        c--;
<br/>
            
<br/>
        if(c &lt;= 0) {
<br/>
            //Deactivate fade
<br/>
            FadeIn = false; FadeOut = false;
<br/>
            //Do something after the fade...
<br/>
            //???
<br/>
            REG_BLDMOD = BIT10 | 1&lt;&lt;6; //disable fade
<br/>
            DisableInterrupts(INT_TIMMER1); //disable timer
<br/>
        }
<br/>
    } else if(FadeOut) {
<br/>
        REG_COLEY=c;
<br/>
        c++;
<br/>
            
<br/>
        if(c &gt;= 17) {
<br/>
            //we finished fading out (now we can load or do other stuff)
<br/>
            FadeIn = true; FadeOut = false;
<br/>
        }
<br/>
    }
<br/>
    REG_TM1D = 32768;   //make timer faster :)
<br/>
}
<br/>
</td> </tr></table><span class="postbody"><br/>_________________<br/><a class="postlink" href="http://pokeme.shizzle.it/" target="_blank">Team Pokeme</a>
<br/>
<a class="postlink" href="http://lupin.shizzle.it/" target="_blank">My blog and PM ASM tutorials</a></span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#18923 - cheech - Thu Apr 08, 2004 10:17 am</h4>
    <div class="postbody"><span class="postbody">poslundc:
<br/>
<br/>
It just never seems to fade back in.  I've downed the frames too.  It seems as if the palette is fading to is all black or something?
<br/>
<br/>
lupin:
<br/>
<br/>
Thanks, but could you give me a complete example for this?  I can't figure out how this would fit into my existing code?
<br/>
<br/>
Thanks!
<br/>
Cheech.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#18937 - poslundc - Thu Apr 08, 2004 2:18 pm</h4>
    <div class="postbody"><span class="postbody">Well, now that I give your program a second look, anothe problem that stands out is that every frame will execute both fadePaletteToBlack() and fadePaletteIn(), so they will cancel each other out.
<br/>
<br/>
Because, you know, if frames &gt; 2000, frames is also &gt; 50.
<br/>
<br/>
You should do something about that.
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#18938 - MayFly - Thu Apr 08, 2004 2:20 pm</h4>
    <div class="postbody"><span class="postbody">Hi Cheech,
<br/>
<br/>
It's generally easier to use the gba?s hardware (as has been suggested before by setting up the appropriate registers correctly ? commonly? known as REG_BLMOD and REG_COLY) to implement to fade in/out effects.
<br/>
<br/>
You may want to check out this thread too as it touches on your query:
<br/>
<br/>
<a href="http://forum.gbadev.org/viewtopic.php?t=1654&amp;highlight=" target="_blank">http://forum.gbadev.org/viewtopic.php?t=1654&amp;highlight=</a>
<br/>
<br/>
At any rate here?s one way to do the Fade In effect:
<br/>
<br/>
/********************************************************************/
<br/>
/* The background fades from black, the delta parameter specifies   */
<br/>
/* how many frames the REG_COLY will stay at a constant value.      */
<br/>
void FadeIn( u16 delta )
<br/>
{
<br/>
	/* Setting the Reg for fading effect */
<br/>
	REG_BLDMOD = 0x1FDF;
<br/>
<br/>
	u16 loop;
<br/>
	u32 fade_out_frame_count = 0;
<br/>
<br/>
		/* The GBA has 16 levels of darkness/lightness */
<br/>
		for( loop = 17; loop &gt; 0; --loop )
<br/>
		{
<br/>
			fade_out_frame_count = global_frame_count + delta;
<br/>
<br/>
			REG_COLY = loop;
<br/>
<br/>
			while( fade_out_frame_count &gt; global_frame_count )
<br/>
			{
<br/>
			/* wait */
<br/>
			}
<br/>
<br/>
		}
<br/>
} /* End function FadeIn */
<br/>
<br/>
P.S.   Remember do not play with your palettes (at least when it comes to wanting to fade in/out an entire screen).</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#18943 - poslundc - Thu Apr 08, 2004 2:45 pm</h4>
    <div class="postbody"><span class="postbody"></span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>MayFly wrote:</b></span></td> </tr> <tr> <td class="quote">P.S.   Remember do not play with your palettes (at least when it comes to wanting to fade in/out an entire screen).</td> </tr></table><span class="postbody">
<br/>
<br/>
Why not? I do almost all of my fading in/out exclusively with palette effects. It also lets me do things that can't be done with hardware blending, like colour multiplication (so I can, for example, make a scene fade to black except for the red compenent for a really strong fire effect or what have you).
<br/>
<br/>
I say unless you don't have any other use for it, save the hardware effects register for cooler alpha-blending stuff.
<br/>
<br/>
Dan.</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#18946 - cheech - Thu Apr 08, 2004 4:17 pm</h4>
    <div class="postbody"><span class="postbody">Cheers everyone.  I've now (finally!) got it sorted using the REG_POSY as mentioned by MayFly.
<br/>
<br/>
Thanks again everyone!!!
<br/>
Cheech</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#18951 - MayFly - Thu Apr 08, 2004 4:47 pm</h4>
    <div class="postbody"><span class="postbody">Hi Dan,
<br/>
<br/>
Aye! Fair enough. I should clarify my previous post script statement.
<br/>
<br/>
If you only want to implement a UNIFORM fade in/out effect on an entire screen I recommend using the hardware to do it.
<br/>
<br/>
As you say, if you want to do something more complicated; playing with the palettes is the way to go.  
<br/>
<br/>
I guess it all depends on how one defines a fade in/out.
<br/>
<br/>
MayFly</span><span class="gensmall"></span></div>    
</div>
<div class="post">
    <h4>#18963 - yaustar - Thu Apr 08, 2004 7:34 pm</h4>
    <div class="postbody"><span class="postbody">I did a fade in / out effect on my intro, doing it by hardware is the easiest in my opionion. 
<br/>
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">for(int a = 0; a &lt; 480; a++) //fade to black
<br/>
        {
<br/>
            WAIT_VSYNC();
<br/>
            //if(!(*KEYS &amp; KEY_A))
<br/>
            //{break;}
<br/>
            //set the transperancy of the first layer
<br/>
            SET_BLENDING(BLEND_BG0, 0, DARKEN);
<br/>
            //source BG0, target backdrop, mode fade to black
<br/>
            REG_COLEY = a &gt;&gt; 4;
<br/>
        }
<br/>
<br/>
        for(int a = 480; a &gt; 0; a--) //fade to normal colour
<br/>
        {
<br/>
            WAIT_VSYNC();
<br/>
            //if(!(*KEYS &amp; KEY_A))
<br/>
            //{break;}
<br/>
            //set the transperancy of the first layer
<br/>
            SET_BLENDING(BLEND_BG0, 0, DARKEN);
<br/>
            //source BG0, target backdrop, mode fade to black
<br/>
            REG_COLEY = a &gt;&gt; 4;
<br/>
        }</td> </tr></table><span class="postbody">
<br/>
<br/>
And the header file
<br/>
</span><table align="center" border="0" cellpadding="3" cellspacing="1" width="90%"><tr> <td><span class="genmed"><b>Code:</b></span></td> </tr> <tr> <td class="code">#include "gba.h"
<br/>
<br/>
#define SOURCE_SHIFT(n) ((n) &lt;&lt; 0)
<br/>
#define TARGET_SHIFT(n) ((n) &lt;&lt; 8)
<br/>
<br/>
//REG_BLDMOD supplement header file by yaustar 02/10/2003
<br/>
<br/>
#define BLEND_BG0 0x1
<br/>
#define BLEND_BG1 0x2
<br/>
#define BLEND_BG2 0x4
<br/>
#define BLEND_BG3 0x8
<br/>
<br/>
#define BLEND_SPRITES 0x10
<br/>
#define BLEND_BACK 0x20
<br/>
<br/>
#define ALL_OFF 0x0
<br/>
#define ALPHA_BLEND 0x40
<br/>
#define LIGHTEN 0x80
<br/>
#define DARKEN 0xC0
<br/>
<br/>
#define SET_BLENDING(s,t,m) REG_BLDMOD = (SOURCE_SHIFT(s) | TARGET_SHIFT(t) | m)
<br/>
<br/>
//REG_COLEV supplement header file by yaustar 02/10/2003
<br/>
//eg of usage SET_BLENDING(BLEND_BG0, BLEND_BG1, ALPHA_BLEND);
<br/>
<br/>
#define SET_COEFF(s,t) REG_COLEV = (SOURCE_SHIFT(s) | TARGET_SHIFT(t))
<br/>
//s + t MUST equal to 16 or &lt;16 for a darkening effect or &gt;16 for a lighting effect
<br/>
<br/>
//key: s = source, t = target, m = mode</td> </tr></table><span class="postbody"><br/>_________________<br/>[<a class="postlink" href="http://parabellumgames.no-ip.org" target="_blank">Blog</a>] [<a class="postlink" href="http://yaustar.no-ip.org" target="_blank">Portfolio</a>]</span><span class="gensmall"></span></div>    
</div>
</div>

    </body>
</html>
